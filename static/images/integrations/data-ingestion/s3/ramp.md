# Observations


## Overview 


Ramp query performance is volatile. While pp9 ~ 600ms as requested we have significant variance. We focus on the max.

![query](./query.png)

No correlations with performance and query throughput.

![](./qps.png)

Some indication spikes are host related:

![](./host_specific.png)


Not clear this is caused by heavy queries reading more rows:

![](./selected.png)
![](./selected_v2.png)

Load from other users is present but i don't think its the cause here.

![](./users.png)


No obvious memory or cpu pressure

![](./cpu.png)

![](./memory.png)


CPU wait correlates better with perf spikes:

![](./cpu_wait.png)


and fetches from disk (not os cache) as we'd expect:

![](./disk_fetches.png)

Also correlates with IO wait.

Appear to be consistently reading from s3, with spikes aligned with when more reads are required.

![](./s3_reads.png)

No significant s3 read errors but clear spikes in s3 wait.

![](./s3_read_wait.png)


### Question is why are we visiting s3 soo much? can we reduce these trips to s3?


Our nodes are 64GiB AWS. With a ratio of 9.375 from Nvme to RAM this gives us approx. 600GB of NvME space per node.

This is reflected in the size of the FS cache on each node

```sql
DESCRIBE FILESYSTEM CACHE 's3diskWithCache'
FORMAT Vertical

Query id: a93ac58d-49be-47c6-8ba8-2f91dd58e25f

Row 1:
──────
max_size:                             599999999999
max_elements:                         10000000
max_file_segment_size:                33554432
is_initialized:                       1
boundary_alignment:                   4194304
cache_on_write_operations:            1
cache_hits_threshold:                 0
current_size:                         599988774686
current_elements:                     171921
path:                                 /mnt/clickhouse-cache/sharedS3DiskCache
background_download_threads:          5
background_download_queue_size_limit: 5000
enable_bypass_cache_with_threshold:   0
load_metadata_threads:                16
```

```sql

SELECT formatReadableSize(599988774686)

Query id: 71f7b4c6-6595-4a5b-942d-e99f6d5913e6

   ┌─formatReadableSize(599988774686)─┐
1. │ 558.78 GiB                       │
   └──────────────────────────────────┘

1 row in set. Elapsed: 0.002 sec.

```

UPDATE: pod restarts last night caused transitive errors and collapse of the fs cache. This aligns perfectly with performance spikes.

Logs suggested transitive connection issues between pods. 


```
2025.02.11 03:19:59.369254 [ 3939 ] {} <Error> InterserverIOHTTPHandler: Code: 221. DB::Exception: No interserver IO endpoint named SharedMergeTreePartsUpdate:/clickhouse/tables/2a9cc6d7-7b10-4a6b-9b63-85f6695d0e2e/default/virtual_parts/c-cobalt-nc-28-server-33zla33-0. (NO_SUCH_INTERSERVER_IO_ENDPOINT), Stack trace (when copying this message, always include the lines below):

0. DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000bdae484
1. DB::Exception::Exception(PreformattedMessage&&, int) @ 0x00000000079a71fc
2. DB::Exception::Exception<String const&>(int, FormatStringHelperImpl<std::type_identity<String const&>::type>, String const&) @ 0x00000000079c06b8
3. DB::InterserverIOHTTPHandler::handleRequest(DB::HTTPServerRequest&, DB::HTTPServerResponse&, StrongTypedef<unsigned long, ProfileEvents::EventTag> const&) @ 0x0000000011524094
4. DB::HTTPServerConnection::run() @ 0x00000000115a1efc
5. Poco::Net::TCPServerConnection::start() @ 0x0000000013e23098
6. Poco::Net::TCPServerDispatcher::run() @ 0x0000000013e23574
7. Poco::PooledThread::run() @ 0x0000000013de71d4
8. Poco::ThreadImpl::runnableEntry(void*) @ 0x0000000013de5610
9. ? @ 0x000000000007d5c8
10. ? @ 0x00000000000e5edc
 (version 24.10.1.11214 (official build))
```

We appeared to have a rolling restart which caused the fs cache, causing a spike at 03:00 11/02.


![s3_reads_smaller_period](./s3_reads_smaller_period.png)


Lets look at our queries:


```sql

with filtered_transactions AS (
        SELECT
            id,
            version
        FROM applied_ai.transaction_canonical_embeddings
        WHERE business_id = 148220
            AND id < 132054591
            AND round(cosineDistance(bfloat16_embedding_for_accounting_matching, [0.019281901, -0.089011796, -0.018873133, -0.01922208, 0.020438416, -0.032601766, -0.008788519, -0.07668892, -0.025144236, 0.0045213765, -0.0006215646, -0.015353737, -0.04446602, -0.1067982, -0.0030358525, -0.016590012, 0.14276981, -0.046818927, -0.039301578, -0.076130606, -0.03140537, 0.019162262, 0.0051744087, 0.036769208, 0.023429403, 0.008389721, 0.06568209, 0.037407286, -0.0059570507, -0.02949114, 0.047576644, 0.09004867, 0.07218251, -0.021495232, -0.0840667, 0.01952118, 0.05072715, -0.12051687, 0.02915216, -0.024526099, 0.086220205, 0.05387766, 0.013788453, -0.007951043, -0.021275893, 0.040458094, -0.07385746, 0.06735704, 0.008534285, -0.0014892627, 0.026978709, 0.123866774, 0.058065042, -0.09555209, -0.0052093035, 0.016360704, -0.049530756, -0.018344725, -0.011704732, 0.017836258, -0.00988023, 0.074455656, 0.011216204, -0.016021725, -0.047377247, -0.035592753, -0.08271078, 0.026320692, -0.035353474, 0.048613522, 0.037506986, 0.018484304, -0.011983891, 0.05670913, 0.0045463014, -0.04618085, -0.018404545, -0.10974931, -0.0696302, 0.13208202, -0.07170395, 0.037108187, -0.079321, -0.07684845, -0.026280813, -0.04689869, -0.06037807, 0.007587139, 0.09020819, -0.054834776, 0.059301317, 0.01932178, -0.040019415, 0.037447166, 0.022811266, -0.0034770232, -0.022432407, -0.015941964, -0.054595497, -0.03208333, -0.07313962, -0.06556245, 0.0016487819, 0.012881187, 0.056589488, -0.039959595, -0.013399625, -0.05072715, 0.040836953, -0.0064904434, -0.033279724, 0.014765509, 0.03148513, 0.124664366, -0.016031694, 0.015413557, 0.103767335, -0.017726587, 0.015772475, 0.010358787, -0.088214196, 0.025363576, -0.006301014, 0.005817471, -0.058065042, -0.0029909879, 0.0026844116, -0.026101353, -0.10273046, 0.049809914, 0.015034698, -0.018225085, 0.023130305, -0.042272627, 0.04382794, -0.07170395, -0.00013856686, 0.030049456, -0.04642013, -0.07808472, -0.06340894, -0.060098913, -0.020308807, -0.033399362, 0.07573181, -0.018364664, 0.023688624, -0.0040527885, -0.03668945, 0.025762374, -0.030627714, -0.011904132, -0.05830432, 0.04933136, -0.0009290756, -0.048414122, -0.07170395, 0.003786092, 0.11955975, 0.044346377, 0.065522574, -0.10839339, 0.027477207, -0.0781246, 0.004758163, 0.0076020937, 0.024984717, 0.067915365, -0.02685907, 0.15967886, 0.04087683, 0.047457006, 0.023568984, -0.048454, -0.017497279, 0.035114195, -0.04626061, -0.061973266, 0.025223996, -0.067317165, 0.096030645, 0.057666242, 0.0038484042, -0.009207257, -0.013230136, 0.07046767, 0.061335187, 0.03684897, 0.06476486, 0.0832691, 0.00076519436, -0.07617049, -0.00213731, -0.022372589, -0.045223735, 0.012681788, 0.047536764, 0.09172362, -0.003771137, 0.013279986, -0.017906047, -0.021136314, 0.002716814, -0.013688754, 0.00024301776, -0.07385746, 0.031425312, -0.008140472, 0.10288998, 0.0392617, -0.04849388, 0.070387915, -0.06835404, 0.060098913, -0.02414724, 0.014237101, 0.12490365, 0.015234098, 0.035193957, 0.020348687, 0.016729591, 0.012980887, 0.012781488, -0.0028863032, 0.008828399, -0.028573902, -0.045941573, -0.03156489, -0.016300883, -0.045941573, 0.007093626, 0.088612996, -0.006365819, -0.09284026, -0.02703853, -0.057945404, 0.03204345, -0.028155165, 0.03180417, 0.09738656, 0.038085245, 0.018494274, 0.07194322, -0.0049824873, -0.06787548, 0.021136314, 0.021594932, 0.04673917, -0.04179407, -0.07664905, -0.0038309568, 0.037845965, -0.02679925, -0.12689763, -0.02939144, -0.053319342, 0.07549253, -0.050806914, 0.04446602, 0.00855921, -0.06620053, 0.07046767, 0.062770866, -0.0025186609, 0.018554093, -0.018773433, -0.0243267, 0.0070288214, 0.06340894, -0.013389655, -0.024705559, -0.080198355, -0.05850372, -0.00732792, 0.005144499, 0.036290653, 0.005518372, 0.04334938, -0.04689869, 0.09347834, 0.003180417, 0.0031679545, -0.079001956, -0.03692873, -0.044625536, -0.04127563, -0.027217988, 0.016749531, 0.064326175, 0.047935564, -0.021375593, 0.0040802057, 0.09571161, 0.07549253, -0.013409595, 0.07884244, -0.067516565, -0.023848142, 0.011924071, 0.04171431, -0.030587835, -0.03652993, -0.09491401, -0.0537979, -0.06281074, 0.059101917, 0.019082502, 0.039341457, 0.11597057, 0.010877226, 0.027118288, 0.047377247, 0.054356217, 0.03924176, 0.0025074447, -0.0014917551, -0.029012581, 0.033100266, 0.102172144, -0.0171583, 0.064525574, -0.065044016, -0.014885149, 0.0642863, 0.005628042, -0.000511272, -0.04833436, -0.05842396, 0.096429445, 0.066998124, -0.024964778, 0.08099595, -0.0636881, -0.031166092, 0.008160411, -0.050128955, -0.015184248, -0.045782052, -0.011844312, 0.009142453, 0.0018456887, -0.055193692, -0.044386256, -0.056788888, -0.04195359, -0.054994296, -0.038105182, -0.06336906, 0.14109486, 0.032801166, 0.020458356, -0.012582089, -0.02209343, -0.0004555025, -0.00490522, -0.032741345, 0.027337627, -0.049490876, 0.04829448, -0.031624712, -0.054675255, -0.030587835, -0.03864356, -0.052402105, -0.04853376, 0.00966089, -0.040797073, 0.078882314, 0.08183342, 0.06073699, -0.009516326, -0.0012960947, -0.03393774, -0.036051374, -0.035014495, 0.05124559, 0.027178109, -0.009336866, 0.049849797, 0.01712839, 0.038204882, -0.0530003, 0.117805034, 0.01693896]),2) < 0.25
            AND round(cosineDistance(bfloat16_embedding_for_accounting_matching, [0.019281901, -0.089011796, -0.018873133, -0.01922208, 0.020438416, -0.032601766, -0.008788519, -0.07668892, -0.025144236, 0.0045213765, -0.0006215646, -0.015353737, -0.04446602, -0.1067982, -0.0030358525, -0.016590012, 0.14276981, -0.046818927, -0.039301578, -0.076130606, -0.03140537, 0.019162262, 0.0051744087, 0.036769208, 0.023429403, 0.008389721, 0.06568209, 0.037407286, -0.0059570507, -0.02949114, 0.047576644, 0.09004867, 0.07218251, -0.021495232, -0.0840667, 0.01952118, 0.05072715, -0.12051687, 0.02915216, -0.024526099, 0.086220205, 0.05387766, 0.013788453, -0.007951043, -0.021275893, 0.040458094, -0.07385746, 0.06735704, 0.008534285, -0.0014892627, 0.026978709, 0.123866774, 0.058065042, -0.09555209, -0.0052093035, 0.016360704, -0.049530756, -0.018344725, -0.011704732, 0.017836258, -0.00988023, 0.074455656, 0.011216204, -0.016021725, -0.047377247, -0.035592753, -0.08271078, 0.026320692, -0.035353474, 0.048613522, 0.037506986, 0.018484304, -0.011983891, 0.05670913, 0.0045463014, -0.04618085, -0.018404545, -0.10974931, -0.0696302, 0.13208202, -0.07170395, 0.037108187, -0.079321, -0.07684845, -0.026280813, -0.04689869, -0.06037807, 0.007587139, 0.09020819, -0.054834776, 0.059301317, 0.01932178, -0.040019415, 0.037447166, 0.022811266, -0.0034770232, -0.022432407, -0.015941964, -0.054595497, -0.03208333, -0.07313962, -0.06556245, 0.0016487819, 0.012881187, 0.056589488, -0.039959595, -0.013399625, -0.05072715, 0.040836953, -0.0064904434, -0.033279724, 0.014765509, 0.03148513, 0.124664366, -0.016031694, 0.015413557, 0.103767335, -0.017726587, 0.015772475, 0.010358787, -0.088214196, 0.025363576, -0.006301014, 0.005817471, -0.058065042, -0.0029909879, 0.0026844116, -0.026101353, -0.10273046, 0.049809914, 0.015034698, -0.018225085, 0.023130305, -0.042272627, 0.04382794, -0.07170395, -0.00013856686, 0.030049456, -0.04642013, -0.07808472, -0.06340894, -0.060098913, -0.020308807, -0.033399362, 0.07573181, -0.018364664, 0.023688624, -0.0040527885, -0.03668945, 0.025762374, -0.030627714, -0.011904132, -0.05830432, 0.04933136, -0.0009290756, -0.048414122, -0.07170395, 0.003786092, 0.11955975, 0.044346377, 0.065522574, -0.10839339, 0.027477207, -0.0781246, 0.004758163, 0.0076020937, 0.024984717, 0.067915365, -0.02685907, 0.15967886, 0.04087683, 0.047457006, 0.023568984, -0.048454, -0.017497279, 0.035114195, -0.04626061, -0.061973266, 0.025223996, -0.067317165, 0.096030645, 0.057666242, 0.0038484042, -0.009207257, -0.013230136, 0.07046767, 0.061335187, 0.03684897, 0.06476486, 0.0832691, 0.00076519436, -0.07617049, -0.00213731, -0.022372589, -0.045223735, 0.012681788, 0.047536764, 0.09172362, -0.003771137, 0.013279986, -0.017906047, -0.021136314, 0.002716814, -0.013688754, 0.00024301776, -0.07385746, 0.031425312, -0.008140472, 0.10288998, 0.0392617, -0.04849388, 0.070387915, -0.06835404, 0.060098913, -0.02414724, 0.014237101, 0.12490365, 0.015234098, 0.035193957, 0.020348687, 0.016729591, 0.012980887, 0.012781488, -0.0028863032, 0.008828399, -0.028573902, -0.045941573, -0.03156489, -0.016300883, -0.045941573, 0.007093626, 0.088612996, -0.006365819, -0.09284026, -0.02703853, -0.057945404, 0.03204345, -0.028155165, 0.03180417, 0.09738656, 0.038085245, 0.018494274, 0.07194322, -0.0049824873, -0.06787548, 0.021136314, 0.021594932, 0.04673917, -0.04179407, -0.07664905, -0.0038309568, 0.037845965, -0.02679925, -0.12689763, -0.02939144, -0.053319342, 0.07549253, -0.050806914, 0.04446602, 0.00855921, -0.06620053, 0.07046767, 0.062770866, -0.0025186609, 0.018554093, -0.018773433, -0.0243267, 0.0070288214, 0.06340894, -0.013389655, -0.024705559, -0.080198355, -0.05850372, -0.00732792, 0.005144499, 0.036290653, 0.005518372, 0.04334938, -0.04689869, 0.09347834, 0.003180417, 0.0031679545, -0.079001956, -0.03692873, -0.044625536, -0.04127563, -0.027217988, 0.016749531, 0.064326175, 0.047935564, -0.021375593, 0.0040802057, 0.09571161, 0.07549253, -0.013409595, 0.07884244, -0.067516565, -0.023848142, 0.011924071, 0.04171431, -0.030587835, -0.03652993, -0.09491401, -0.0537979, -0.06281074, 0.059101917, 0.019082502, 0.039341457, 0.11597057, 0.010877226, 0.027118288, 0.047377247, 0.054356217, 0.03924176, 0.0025074447, -0.0014917551, -0.029012581, 0.033100266, 0.102172144, -0.0171583, 0.064525574, -0.065044016, -0.014885149, 0.0642863, 0.005628042, -0.000511272, -0.04833436, -0.05842396, 0.096429445, 0.066998124, -0.024964778, 0.08099595, -0.0636881, -0.031166092, 0.008160411, -0.050128955, -0.015184248, -0.045782052, -0.011844312, 0.009142453, 0.0018456887, -0.055193692, -0.044386256, -0.056788888, -0.04195359, -0.054994296, -0.038105182, -0.06336906, 0.14109486, 0.032801166, 0.020458356, -0.012582089, -0.02209343, -0.0004555025, -0.00490522, -0.032741345, 0.027337627, -0.049490876, 0.04829448, -0.031624712, -0.054675255, -0.030587835, -0.03864356, -0.052402105, -0.04853376, 0.00966089, -0.040797073, 0.078882314, 0.08183342, 0.06073699, -0.009516326, -0.0012960947, -0.03393774, -0.036051374, -0.035014495, 0.05124559, 0.027178109, -0.009336866, 0.049849797, 0.01712839, 0.038204882, -0.0530003, 0.117805034, 0.01693896]),2) >= 0.0
            AND accounting_is_gl_tc_coded
            AND user_transaction_time BETWEEN now() - interval 16 months AND '2025-02-11 06:34:53'
            AND sync_ready_status = 1
        ORDER BY round(cosineDistance(bfloat16_embedding_for_accounting_matching, [0.019281901, -0.089011796, -0.018873133, -0.01922208, 0.020438416, -0.032601766, -0.008788519, -0.07668892, -0.025144236, 0.0045213765, -0.0006215646, -0.015353737, -0.04446602, -0.1067982, -0.0030358525, -0.016590012, 0.14276981, -0.046818927, -0.039301578, -0.076130606, -0.03140537, 0.019162262, 0.0051744087, 0.036769208, 0.023429403, 0.008389721, 0.06568209, 0.037407286, -0.0059570507, -0.02949114, 0.047576644, 0.09004867, 0.07218251, -0.021495232, -0.0840667, 0.01952118, 0.05072715, -0.12051687, 0.02915216, -0.024526099, 0.086220205, 0.05387766, 0.013788453, -0.007951043, -0.021275893, 0.040458094, -0.07385746, 0.06735704, 0.008534285, -0.0014892627, 0.026978709, 0.123866774, 0.058065042, -0.09555209, -0.0052093035, 0.016360704, -0.049530756, -0.018344725, -0.011704732, 0.017836258, -0.00988023, 0.074455656, 0.011216204, -0.016021725, -0.047377247, -0.035592753, -0.08271078, 0.026320692, -0.035353474, 0.048613522, 0.037506986, 0.018484304, -0.011983891, 0.05670913, 0.0045463014, -0.04618085, -0.018404545, -0.10974931, -0.0696302, 0.13208202, -0.07170395, 0.037108187, -0.079321, -0.07684845, -0.026280813, -0.04689869, -0.06037807, 0.007587139, 0.09020819, -0.054834776, 0.059301317, 0.01932178, -0.040019415, 0.037447166, 0.022811266, -0.0034770232, -0.022432407, -0.015941964, -0.054595497, -0.03208333, -0.07313962, -0.06556245, 0.0016487819, 0.012881187, 0.056589488, -0.039959595, -0.013399625, -0.05072715, 0.040836953, -0.0064904434, -0.033279724, 0.014765509, 0.03148513, 0.124664366, -0.016031694, 0.015413557, 0.103767335, -0.017726587, 0.015772475, 0.010358787, -0.088214196, 0.025363576, -0.006301014, 0.005817471, -0.058065042, -0.0029909879, 0.0026844116, -0.026101353, -0.10273046, 0.049809914, 0.015034698, -0.018225085, 0.023130305, -0.042272627, 0.04382794, -0.07170395, -0.00013856686, 0.030049456, -0.04642013, -0.07808472, -0.06340894, -0.060098913, -0.020308807, -0.033399362, 0.07573181, -0.018364664, 0.023688624, -0.0040527885, -0.03668945, 0.025762374, -0.030627714, -0.011904132, -0.05830432, 0.04933136, -0.0009290756, -0.048414122, -0.07170395, 0.003786092, 0.11955975, 0.044346377, 0.065522574, -0.10839339, 0.027477207, -0.0781246, 0.004758163, 0.0076020937, 0.024984717, 0.067915365, -0.02685907, 0.15967886, 0.04087683, 0.047457006, 0.023568984, -0.048454, -0.017497279, 0.035114195, -0.04626061, -0.061973266, 0.025223996, -0.067317165, 0.096030645, 0.057666242, 0.0038484042, -0.009207257, -0.013230136, 0.07046767, 0.061335187, 0.03684897, 0.06476486, 0.0832691, 0.00076519436, -0.07617049, -0.00213731, -0.022372589, -0.045223735, 0.012681788, 0.047536764, 0.09172362, -0.003771137, 0.013279986, -0.017906047, -0.021136314, 0.002716814, -0.013688754, 0.00024301776, -0.07385746, 0.031425312, -0.008140472, 0.10288998, 0.0392617, -0.04849388, 0.070387915, -0.06835404, 0.060098913, -0.02414724, 0.014237101, 0.12490365, 0.015234098, 0.035193957, 0.020348687, 0.016729591, 0.012980887, 0.012781488, -0.0028863032, 0.008828399, -0.028573902, -0.045941573, -0.03156489, -0.016300883, -0.045941573, 0.007093626, 0.088612996, -0.006365819, -0.09284026, -0.02703853, -0.057945404, 0.03204345, -0.028155165, 0.03180417, 0.09738656, 0.038085245, 0.018494274, 0.07194322, -0.0049824873, -0.06787548, 0.021136314, 0.021594932, 0.04673917, -0.04179407, -0.07664905, -0.0038309568, 0.037845965, -0.02679925, -0.12689763, -0.02939144, -0.053319342, 0.07549253, -0.050806914, 0.04446602, 0.00855921, -0.06620053, 0.07046767, 0.062770866, -0.0025186609, 0.018554093, -0.018773433, -0.0243267, 0.0070288214, 0.06340894, -0.013389655, -0.024705559, -0.080198355, -0.05850372, -0.00732792, 0.005144499, 0.036290653, 0.005518372, 0.04334938, -0.04689869, 0.09347834, 0.003180417, 0.0031679545, -0.079001956, -0.03692873, -0.044625536, -0.04127563, -0.027217988, 0.016749531, 0.064326175, 0.047935564, -0.021375593, 0.0040802057, 0.09571161, 0.07549253, -0.013409595, 0.07884244, -0.067516565, -0.023848142, 0.011924071, 0.04171431, -0.030587835, -0.03652993, -0.09491401, -0.0537979, -0.06281074, 0.059101917, 0.019082502, 0.039341457, 0.11597057, 0.010877226, 0.027118288, 0.047377247, 0.054356217, 0.03924176, 0.0025074447, -0.0014917551, -0.029012581, 0.033100266, 0.102172144, -0.0171583, 0.064525574, -0.065044016, -0.014885149, 0.0642863, 0.005628042, -0.000511272, -0.04833436, -0.05842396, 0.096429445, 0.066998124, -0.024964778, 0.08099595, -0.0636881, -0.031166092, 0.008160411, -0.050128955, -0.015184248, -0.045782052, -0.011844312, 0.009142453, 0.0018456887, -0.055193692, -0.044386256, -0.056788888, -0.04195359, -0.054994296, -0.038105182, -0.06336906, 0.14109486, 0.032801166, 0.020458356, -0.012582089, -0.02209343, -0.0004555025, -0.00490522, -0.032741345, 0.027337627, -0.049490876, 0.04829448, -0.031624712, -0.054675255, -0.030587835, -0.03864356, -0.052402105, -0.04853376, 0.00966089, -0.040797073, 0.078882314, 0.08183342, 0.06073699, -0.009516326, -0.0012960947, -0.03393774, -0.036051374, -0.035014495, 0.05124559, 0.027178109, -0.009336866, 0.049849797, 0.01712839, 0.038204882, -0.0530003, 0.117805034, 0.01693896]),2) ASC, user_transaction_time DESC
        LIMIT 180
    )
    SELECT
        merchant_name,
        id,
        accounting_tracking_category_selections,
        sync_ready_status,
        round(cosineDistance(bfloat16_embedding_for_accounting_matching, [0.019281901, -0.089011796, -0.018873133, -0.01922208, 0.020438416, -0.032601766, -0.008788519, -0.07668892, -0.025144236, 0.0045213765, -0.0006215646, -0.015353737, -0.04446602, -0.1067982, -0.0030358525, -0.016590012, 0.14276981, -0.046818927, -0.039301578, -0.076130606, -0.03140537, 0.019162262, 0.0051744087, 0.036769208, 0.023429403, 0.008389721, 0.06568209, 0.037407286, -0.0059570507, -0.02949114, 0.047576644, 0.09004867, 0.07218251, -0.021495232, -0.0840667, 0.01952118, 0.05072715, -0.12051687, 0.02915216, -0.024526099, 0.086220205, 0.05387766, 0.013788453, -0.007951043, -0.021275893, 0.040458094, -0.07385746, 0.06735704, 0.008534285, -0.0014892627, 0.026978709, 0.123866774, 0.058065042, -0.09555209, -0.0052093035, 0.016360704, -0.049530756, -0.018344725, -0.011704732, 0.017836258, -0.00988023, 0.074455656, 0.011216204, -0.016021725, -0.047377247, -0.035592753, -0.08271078, 0.026320692, -0.035353474, 0.048613522, 0.037506986, 0.018484304, -0.011983891, 0.05670913, 0.0045463014, -0.04618085, -0.018404545, -0.10974931, -0.0696302, 0.13208202, -0.07170395, 0.037108187, -0.079321, -0.07684845, -0.026280813, -0.04689869, -0.06037807, 0.007587139, 0.09020819, -0.054834776, 0.059301317, 0.01932178, -0.040019415, 0.037447166, 0.022811266, -0.0034770232, -0.022432407, -0.015941964, -0.054595497, -0.03208333, -0.07313962, -0.06556245, 0.0016487819, 0.012881187, 0.056589488, -0.039959595, -0.013399625, -0.05072715, 0.040836953, -0.0064904434, -0.033279724, 0.014765509, 0.03148513, 0.124664366, -0.016031694, 0.015413557, 0.103767335, -0.017726587, 0.015772475, 0.010358787, -0.088214196, 0.025363576, -0.006301014, 0.005817471, -0.058065042, -0.0029909879, 0.0026844116, -0.026101353, -0.10273046, 0.049809914, 0.015034698, -0.018225085, 0.023130305, -0.042272627, 0.04382794, -0.07170395, -0.00013856686, 0.030049456, -0.04642013, -0.07808472, -0.06340894, -0.060098913, -0.020308807, -0.033399362, 0.07573181, -0.018364664, 0.023688624, -0.0040527885, -0.03668945, 0.025762374, -0.030627714, -0.011904132, -0.05830432, 0.04933136, -0.0009290756, -0.048414122, -0.07170395, 0.003786092, 0.11955975, 0.044346377, 0.065522574, -0.10839339, 0.027477207, -0.0781246, 0.004758163, 0.0076020937, 0.024984717, 0.067915365, -0.02685907, 0.15967886, 0.04087683, 0.047457006, 0.023568984, -0.048454, -0.017497279, 0.035114195, -0.04626061, -0.061973266, 0.025223996, -0.067317165, 0.096030645, 0.057666242, 0.0038484042, -0.009207257, -0.013230136, 0.07046767, 0.061335187, 0.03684897, 0.06476486, 0.0832691, 0.00076519436, -0.07617049, -0.00213731, -0.022372589, -0.045223735, 0.012681788, 0.047536764, 0.09172362, -0.003771137, 0.013279986, -0.017906047, -0.021136314, 0.002716814, -0.013688754, 0.00024301776, -0.07385746, 0.031425312, -0.008140472, 0.10288998, 0.0392617, -0.04849388, 0.070387915, -0.06835404, 0.060098913, -0.02414724, 0.014237101, 0.12490365, 0.015234098, 0.035193957, 0.020348687, 0.016729591, 0.012980887, 0.012781488, -0.0028863032, 0.008828399, -0.028573902, -0.045941573, -0.03156489, -0.016300883, -0.045941573, 0.007093626, 0.088612996, -0.006365819, -0.09284026, -0.02703853, -0.057945404, 0.03204345, -0.028155165, 0.03180417, 0.09738656, 0.038085245, 0.018494274, 0.07194322, -0.0049824873, -0.06787548, 0.021136314, 0.021594932, 0.04673917, -0.04179407, -0.07664905, -0.0038309568, 0.037845965, -0.02679925, -0.12689763, -0.02939144, -0.053319342, 0.07549253, -0.050806914, 0.04446602, 0.00855921, -0.06620053, 0.07046767, 0.062770866, -0.0025186609, 0.018554093, -0.018773433, -0.0243267, 0.0070288214, 0.06340894, -0.013389655, -0.024705559, -0.080198355, -0.05850372, -0.00732792, 0.005144499, 0.036290653, 0.005518372, 0.04334938, -0.04689869, 0.09347834, 0.003180417, 0.0031679545, -0.079001956, -0.03692873, -0.044625536, -0.04127563, -0.027217988, 0.016749531, 0.064326175, 0.047935564, -0.021375593, 0.0040802057, 0.09571161, 0.07549253, -0.013409595, 0.07884244, -0.067516565, -0.023848142, 0.011924071, 0.04171431, -0.030587835, -0.03652993, -0.09491401, -0.0537979, -0.06281074, 0.059101917, 0.019082502, 0.039341457, 0.11597057, 0.010877226, 0.027118288, 0.047377247, 0.054356217, 0.03924176, 0.0025074447, -0.0014917551, -0.029012581, 0.033100266, 0.102172144, -0.0171583, 0.064525574, -0.065044016, -0.014885149, 0.0642863, 0.005628042, -0.000511272, -0.04833436, -0.05842396, 0.096429445, 0.066998124, -0.024964778, 0.08099595, -0.0636881, -0.031166092, 0.008160411, -0.050128955, -0.015184248, -0.045782052, -0.011844312, 0.009142453, 0.0018456887, -0.055193692, -0.044386256, -0.056788888, -0.04195359, -0.054994296, -0.038105182, -0.06336906, 0.14109486, 0.032801166, 0.020458356, -0.012582089, -0.02209343, -0.0004555025, -0.00490522, -0.032741345, 0.027337627, -0.049490876, 0.04829448, -0.031624712, -0.054675255, -0.030587835, -0.03864356, -0.052402105, -0.04853376, 0.00966089, -0.040797073, 0.078882314, 0.08183342, 0.06073699, -0.009516326, -0.0012960947, -0.03393774, -0.036051374, -0.035014495, 0.05124559, 0.027178109, -0.009336866, 0.049849797, 0.01712839, 0.038204882, -0.0530003, 0.117805034, 0.01693896]),2) AS score,
        version
    FROM applied_ai.transaction_canonical_embeddings
    WHERE business_id = 148220
        AND (id, version) IN (SELECT id, version FROM filtered_transactions)
        AND user_transaction_time BETWEEN now() - interval 16 months AND '2025-02-11 06:34:53'
    ORDER BY score ASC, user_transaction_time DESC
    SETTINGS merge_tree_min_rows_for_concurrent_read_for_remote_filesystem = 0, merge_tree_min_bytes_for_concurrent_read_for_remote_filesystem = 0

180 rows in set. Elapsed: 0.135 sec. Processed 67.14 thousand rows, 89.83 MB (496.69 thousand rows/s., 664.48 MB/s.)
180 rows in set. Elapsed: 0.082 sec. Processed 67.14 thousand rows, 89.83 MB (814.95 thousand rows/s., 1.09 GB/s.)
180 rows in set. Elapsed: 0.075 sec. Processed 67.14 thousand rows, 89.83 MB (892.41 thousand rows/s., 1.19 GB/s.)
180 rows in set. Elapsed: 0.076 sec. Processed 67.14 thousand rows, 89.83 MB (887.42 thousand rows/s., 1.19 GB/s.)
```


We can rewrite:

```sql
SELECT
    merchant_name,
    id,
    accounting_tracking_category_selections,
    sync_ready_status,
    round(cosineDistance(bfloat16_embedding_for_accounting_matching, [0.019281901, -0.089011796, -0.018873133, -0.01922208, 0.020438416, -0.032601766, -0.008788519, -0.07668892, -0.025144236, 0.0045213765, -0.0006215646, -0.015353737, -0.04446602, -0.1067982, -0.0030358525, -0.016590012, 0.14276981, -0.046818927, -0.039301578, -0.076130606, -0.03140537, 0.019162262, 0.0051744087, 0.036769208, 0.023429403, 0.008389721, 0.06568209, 0.037407286, -0.0059570507, -0.02949114, 0.047576644, 0.09004867, 0.07218251, -0.021495232, -0.0840667, 0.01952118, 0.05072715, -0.12051687, 0.02915216, -0.024526099, 0.086220205, 0.05387766, 0.013788453, -0.007951043, -0.021275893, 0.040458094, -0.07385746, 0.06735704, 0.008534285, -0.0014892627, 0.026978709, 0.123866774, 0.058065042, -0.09555209, -0.0052093035, 0.016360704, -0.049530756, -0.018344725, -0.011704732, 0.017836258, -0.00988023, 0.074455656, 0.011216204, -0.016021725, -0.047377247, -0.035592753, -0.08271078, 0.026320692, -0.035353474, 0.048613522, 0.037506986, 0.018484304, -0.011983891, 0.05670913, 0.0045463014, -0.04618085, -0.018404545, -0.10974931, -0.0696302, 0.13208202, -0.07170395, 0.037108187, -0.079321, -0.07684845, -0.026280813, -0.04689869, -0.06037807, 0.007587139, 0.09020819, -0.054834776, 0.059301317, 0.01932178, -0.040019415, 0.037447166, 0.022811266, -0.0034770232, -0.022432407, -0.015941964, -0.054595497, -0.03208333, -0.07313962, -0.06556245, 0.0016487819, 0.012881187, 0.056589488, -0.039959595, -0.013399625, -0.05072715, 0.040836953, -0.0064904434, -0.033279724, 0.014765509, 0.03148513, 0.124664366, -0.016031694, 0.015413557, 0.103767335, -0.017726587, 0.015772475, 0.010358787, -0.088214196, 0.025363576, -0.006301014, 0.005817471, -0.058065042, -0.0029909879, 0.0026844116, -0.026101353, -0.10273046, 0.049809914, 0.015034698, -0.018225085, 0.023130305, -0.042272627, 0.04382794, -0.07170395, -0.00013856686, 0.030049456, -0.04642013, -0.07808472, -0.06340894, -0.060098913, -0.020308807, -0.033399362, 0.07573181, -0.018364664, 0.023688624, -0.0040527885, -0.03668945, 0.025762374, -0.030627714, -0.011904132, -0.05830432, 0.04933136, -0.0009290756, -0.048414122, -0.07170395, 0.003786092, 0.11955975, 0.044346377, 0.065522574, -0.10839339, 0.027477207, -0.0781246, 0.004758163, 0.0076020937, 0.024984717, 0.067915365, -0.02685907, 0.15967886, 0.04087683, 0.047457006, 0.023568984, -0.048454, -0.017497279, 0.035114195, -0.04626061, -0.061973266, 0.025223996, -0.067317165, 0.096030645, 0.057666242, 0.0038484042, -0.009207257, -0.013230136, 0.07046767, 0.061335187, 0.03684897, 0.06476486, 0.0832691, 0.00076519436, -0.07617049, -0.00213731, -0.022372589, -0.045223735, 0.012681788, 0.047536764, 0.09172362, -0.003771137, 0.013279986, -0.017906047, -0.021136314, 0.002716814, -0.013688754, 0.00024301776, -0.07385746, 0.031425312, -0.008140472, 0.10288998, 0.0392617, -0.04849388, 0.070387915, -0.06835404, 0.060098913, -0.02414724, 0.014237101, 0.12490365, 0.015234098, 0.035193957, 0.020348687, 0.016729591, 0.012980887, 0.012781488, -0.0028863032, 0.008828399, -0.028573902, -0.045941573, -0.03156489, -0.016300883, -0.045941573, 0.007093626, 0.088612996, -0.006365819, -0.09284026, -0.02703853, -0.057945404, 0.03204345, -0.028155165, 0.03180417, 0.09738656, 0.038085245, 0.018494274, 0.07194322, -0.0049824873, -0.06787548, 0.021136314, 0.021594932, 0.04673917, -0.04179407, -0.07664905, -0.0038309568, 0.037845965, -0.02679925, -0.12689763, -0.02939144, -0.053319342, 0.07549253, -0.050806914, 0.04446602, 0.00855921, -0.06620053, 0.07046767, 0.062770866, -0.0025186609, 0.018554093, -0.018773433, -0.0243267, 0.0070288214, 0.06340894, -0.013389655, -0.024705559, -0.080198355, -0.05850372, -0.00732792, 0.005144499, 0.036290653, 0.005518372, 0.04334938, -0.04689869, 0.09347834, 0.003180417, 0.0031679545, -0.079001956, -0.03692873, -0.044625536, -0.04127563, -0.027217988, 0.016749531, 0.064326175, 0.047935564, -0.021375593, 0.0040802057, 0.09571161, 0.07549253, -0.013409595, 0.07884244, -0.067516565, -0.023848142, 0.011924071, 0.04171431, -0.030587835, -0.03652993, -0.09491401, -0.0537979, -0.06281074, 0.059101917, 0.019082502, 0.039341457, 0.11597057, 0.010877226, 0.027118288, 0.047377247, 0.054356217, 0.03924176, 0.0025074447, -0.0014917551, -0.029012581, 0.033100266, 0.102172144, -0.0171583, 0.064525574, -0.065044016, -0.014885149, 0.0642863, 0.005628042, -0.000511272, -0.04833436, -0.05842396, 0.096429445, 0.066998124, -0.024964778, 0.08099595, -0.0636881, -0.031166092, 0.008160411, -0.050128955, -0.015184248, -0.045782052, -0.011844312, 0.009142453, 0.0018456887, -0.055193692, -0.044386256, -0.056788888, -0.04195359, -0.054994296, -0.038105182, -0.06336906, 0.14109486, 0.032801166, 0.020458356, -0.012582089, -0.02209343, -0.0004555025, -0.00490522, -0.032741345, 0.027337627, -0.049490876, 0.04829448, -0.031624712, -0.054675255, -0.030587835, -0.03864356, -0.052402105, -0.04853376, 0.00966089, -0.040797073, 0.078882314, 0.08183342, 0.06073699, -0.009516326, -0.0012960947, -0.03393774, -0.036051374, -0.035014495, 0.05124559, 0.027178109, -0.009336866, 0.049849797, 0.01712839, 0.038204882, -0.0530003, 0.117805034, 0.01693896]),2) AS score, version
FROM applied_ai.transaction_canonical_embeddings
WHERE business_id = 148220 AND user_transaction_time BETWEEN now() - interval 16 months AND '2025-02-11 06:34:53' AND accounting_is_gl_tc_coded AND sync_ready_status = 1 AND id < 132054591 AND score >= 0.0 AND score < 0.25
ORDER BY score ASC, user_transaction_time DESC LIMIT 180
SETTINGS merge_tree_min_rows_for_concurrent_read_for_remote_filesystem = 0, merge_tree_min_bytes_for_concurrent_read_for_remote_filesystem = 0

180 rows in set. Elapsed: 0.041 sec. Processed 33.57 thousand rows, 60.27 MB (810.40 thousand rows/s., 1.45 GB/s.)
180 rows in set. Elapsed: 0.041 sec. Processed 33.57 thousand rows, 60.27 MB (810.40 thousand rows/s., 1.45 GB/s.)
180 rows in set. Elapsed: 0.041 sec. Processed 33.57 thousand rows, 60.27 MB (810.40 thousand rows/s., 1.45 GB/s.)

```

Lets focus on s3 reads now.


first what tables are being queried by metaflow user and their respective sizes

```sql
SELECT table, col, formatReadableSize(data_compressed_bytes) as data_compressed_bytes, formatReadableSize(data_uncompressed_bytes) as data_uncompressed_bytes FROM (
    SELECT
        arrayJoin(tables) AS table,
        arrayJoin(columns) AS col,
        count() AS c
    FROM clusterAllReplicas('default', system.query_log)
    WHERE (initial_user = 'metaflow') AND (event_time > (now() - toIntervalHour(6)))
    GROUP BY
        table,
        col
    ORDER BY c DESC
    LIMIT 100
) queried_cols 
INNER JOIN system.columns AS columns ON queried_cols.col = (columns.database || '.' || columns.table || '.' || columns.name)
FORMAT PrettyCompactMonoBlock

Query id: 9e2b8560-f310-4cbe-a9be-7999ae66be27

    ┌─table───────────────────────────────────────┬─col────────────────────────────────────────────────────────────────────────────────────┬─data_compressed_bytes─┬─data_uncompressed_bytes─┐
 1. │ applied_ai.transaction_canonical_embeddings │ applied_ai.transaction_canonical_embeddings.accounting_tracking_category_selections    │ 4.99 GiB              │ 184.45 GiB              │
 2. │ applied_ai.transaction_canonical_embeddings │ applied_ai.transaction_canonical_embeddings.business_id                                │ 4.66 MiB              │ 1.57 GiB                │
 3. │ applied_ai.transaction_canonical_embeddings │ applied_ai.transaction_canonical_embeddings.bfloat16_embedding_for_accounting_matching │ 254.05 GiB            │ 606.70 GiB              │
 4. │ applied_ai.transaction_canonical_embeddings │ applied_ai.transaction_canonical_embeddings.merchant_name                              │ 1.28 GiB              │ 4.69 GiB                │
 5. │ applied_ai.transaction_canonical_embeddings │ applied_ai.transaction_canonical_embeddings.id                                         │ 1.38 GiB              │ 1.57 GiB                │
 6. │ applied_ai.transaction_canonical_embeddings │ applied_ai.transaction_canonical_embeddings.sync_ready_status                          │ 38.55 MiB             │ 402.37 MiB              │
 7. │ applied_ai.transaction_canonical_embeddings │ applied_ai.transaction_canonical_embeddings.version                                    │ 1.07 GiB              │ 3.14 GiB                │
 8. │ applied_ai.transaction_canonical_embeddings │ applied_ai.transaction_canonical_embeddings.accounting_is_gl_tc_coded                  │ 34.11 MiB             │ 402.37 MiB              │
 9. │ applied_ai.transaction_canonical_embeddings │ applied_ai.transaction_canonical_embeddings.user_transaction_time                      │ 1.40 GiB              │ 3.14 GiB                │
10. │ applied_ai.prod_bill_pay_categorization     │ applied_ai.prod_bill_pay_categorization.tracking_category_option_remote_name           │ 12.60 MiB             │ 197.45 MiB              │
11. │ applied_ai.prod_bill_pay_categorization     │ applied_ai.prod_bill_pay_categorization.business_id                                    │ 89.34 KiB             │ 44.51 MiB               │
12. │ applied_ai.prod_bill_pay_categorization     │ applied_ai.prod_bill_pay_categorization.amount                                         │ 15.60 MiB             │ 22.25 MiB               │
13. │ applied_ai.prod_bill_pay_categorization     │ applied_ai.prod_bill_pay_categorization.accounting_provider_access_id                  │ 86.60 KiB             │ 44.51 MiB               │
14. │ applied_ai.prod_bill_pay_categorization     │ applied_ai.prod_bill_pay_categorization.tracking_category_id                           │ 90.16 KiB             │ 44.51 MiB               │
15. │ applied_ai.prod_bill_pay_categorization     │ applied_ai.prod_bill_pay_categorization.vector_field                                   │ 5.60 GiB              │ 8.39 GiB                │
16. │ applied_ai.prod_bill_pay_categorization     │ applied_ai.prod_bill_pay_categorization.non_gl_category_blob                           │ 36.72 MiB             │ 2.66 GiB                │
17. │ applied_ai.prod_bill_pay_categorization     │ applied_ai.prod_bill_pay_categorization.tracking_category_option_id                    │ 5.30 MiB              │ 44.51 MiB               │
18. │ applied_ai.prod_bill_pay_categorization     │ applied_ai.prod_bill_pay_categorization.bill_line_item_log_entry_id                    │ 14.14 MiB             │ 44.51 MiB               │
    └─────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────────────────────┴───────────────────────┴─────────────────────────┘

18 rows in set. Elapsed: 0.162 sec. Processed 1.15 million rows, 48.36 MB (7.08 million rows/s., 298.33 MB/s.)
Peak memory usage: 127.33 MiB.
```


```sql
SELECT formatReadableSize(sum(data_compressed_bytes))
FROM
(
    SELECT
        `table`,
        col,
        data_compressed_bytes,
        formatReadableSize(data_uncompressed_bytes) AS data_uncompressed_bytes
    FROM
    (
        SELECT
            arrayJoin(tables) AS `table`,
            arrayJoin(columns) AS col,
            count() AS c
        FROM clusterAllReplicas('default', system.query_log)
        WHERE (initial_user = 'metaflow') AND (event_time > (now() - toIntervalHour(6)))
        GROUP BY
            `table`,
            col
        ORDER BY c DESC
        LIMIT 100
    ) AS queried_cols
    INNER JOIN system.columns AS columns ON queried_cols.col = concat(columns.database, '.', columns.`table`, '.', columns.name)
)
FORMAT PrettyCompactMonoBlock

Query id: 20dd83aa-78b8-41d8-9880-ce9bbb18be91

   ┌─formatReadableSize(sum(data_compressed_bytes))─┐
1. │ 269.95 GiB                                     │
   └────────────────────────────────────────────────┘
```

This is significantly < than the 600GB per node. We'd expect no visits to s3....



But  other users where not querying system database

```sql

SELECT
    `table`,
    c,
    col,
    formatReadableSize(data_compressed_bytes) AS data_compressed_bytes,
    formatReadableSize(data_uncompressed_bytes) AS data_uncompressed_bytes
FROM
(
    SELECT
        arrayJoin(tables) AS `table`,
        arrayJoin(columns) AS col,
        count() AS c
    FROM clusterAllReplicas('default', system.query_log)
    WHERE (initial_user != 'metaflow') AND (NOT has(databases, 'system')) AND (event_time > (now() - toIntervalHour(6)))
    GROUP BY
        tables,
        col
    HAVING c > 1000
    ORDER BY c DESC
) AS queried_cols
INNER JOIN system.columns AS columns ON queried_cols.col = concat(columns.database, '.', columns.`table`, '.', columns.name)
LIMIT 100
FORMAT PrettyCompactMonoBlock

Query id: e445cc2d-46f9-4d6d-a804-c05a62c38a48

    ┌─table─────────────────────────────────────────────┬──────c─┬─col─────────────────────────────────────────────────────────────────────────────────┬─data_compressed_bytes─┬─data_uncompressed_bytes─┐
 1. │ applied_ai.transaction_canonical_receipt_matching │ 608032 │ applied_ai.transaction_canonical_receipt_matching.user_id                           │ 282.30 MiB            │ 1.03 GiB                │
 2. │ applied_ai.transaction_canonical_receipt_matching │ 608032 │ applied_ai.transaction_canonical_receipt_matching.id                                │ 925.30 MiB            │ 1.03 GiB                │
 3. │ applied_ai.transaction_canonical_receipt_matching │ 608032 │ applied_ai.transaction_canonical_receipt_matching.user_transaction_time             │ 924.38 MiB            │ 2.05 GiB                │
 4. │ applied_ai.transaction_canonical_receipt_matching │ 608032 │ applied_ai.transaction_canonical_receipt_matching.embedding                         │ 916.64 GiB            │ 1.03 TiB                │
 5. │ applied_ai.transaction_canonical_receipt_matching │ 607978 │ applied_ai.transaction_canonical_receipt_matching.business_id                       │ 2.45 MiB              │ 1.03 GiB                │
 6. │ applied_ai.transaction_canonical_receipt_matching │ 492990 │ applied_ai.transaction_canonical_receipt_matching.sk_category_name                  │ 341.68 MiB            │ 4.06 GiB                │
 7. │ applied_ai.transaction_canonical_receipt_matching │ 492990 │ applied_ai.transaction_canonical_receipt_matching.merchant_state                    │ 175.98 MiB            │ 749.56 MiB              │
 8. │ applied_ai.transaction_canonical_receipt_matching │ 492990 │ applied_ai.transaction_canonical_receipt_matching.card_acceptor                     │ 4.65 GiB              │ 40.18 GiB               │
 9. │ applied_ai.transaction_canonical_receipt_matching │ 492990 │ applied_ai.transaction_canonical_receipt_matching.currency_code                     │ 12.82 MiB             │ 267.03 MiB              │
10. │ applied_ai.transaction_canonical_receipt_matching │ 492990 │ applied_ai.transaction_canonical_receipt_matching.merchant_city                     │ 431.91 MiB            │ 2.47 GiB                │
11. │ applied_ai.transaction_canonical_receipt_matching │ 492990 │ applied_ai.transaction_canonical_receipt_matching.card_last_four                    │ 318.21 MiB            │ 1.28 GiB                │
12. │ applied_ai.transaction_canonical_receipt_matching │ 492990 │ applied_ai.transaction_canonical_receipt_matching.merchant_name                     │ 811.04 MiB            │ 3.07 GiB                │
13. │ applied_ai.transaction_canonical_receipt_matching │ 492990 │ applied_ai.transaction_canonical_receipt_matching.amount                            │ 729.34 MiB            │ 2.05 GiB                │
14. │ applied_ai.transaction_canonical_receipt_matching │ 492990 │ applied_ai.transaction_canonical_receipt_matching.merchant_domain                   │ 1.41 GiB              │ 8.03 GiB                │
15. │ applied_ai.transaction_canonical_receipt_matching │ 112154 │ applied_ai.transaction_canonical_receipt_matching.memo                              │ 1.34 GiB              │ 3.70 GiB                │
16. │ applied_ai.transaction_canonical_embeddings       │   6346 │ applied_ai.transaction_canonical_embeddings.id                                      │ 1.38 GiB              │ 1.57 GiB                │
17. │ applied_ai.transaction_canonical_embeddings       │   6346 │ applied_ai.transaction_canonical_embeddings.business_id                             │ 4.66 MiB              │ 1.57 GiB                │
18. │ applied_ai.transaction_canonical_embeddings       │   6346 │ applied_ai.transaction_canonical_embeddings.sync_ready_status                       │ 38.55 MiB             │ 402.37 MiB              │
19. │ applied_ai.transaction_canonical_embeddings       │   6334 │ applied_ai.transaction_canonical_embeddings.merchant_name                           │ 1.28 GiB              │ 4.69 GiB                │
20. │ applied_ai.transaction_canonical_embeddings       │   6334 │ applied_ai.transaction_canonical_embeddings.accounting_tracking_category_selections │ 4.99 GiB              │ 184.45 GiB              │
21. │ applied_ai.transaction_canonical_embeddings       │   6270 │ applied_ai.transaction_canonical_embeddings.embedding_for_accounting_matching       │ 510.63 GiB            │ 606.70 GiB              │
22. │ applied_ai.transaction_canonical_embeddings       │   6270 │ applied_ai.transaction_canonical_embeddings.original_amount                         │ 1.10 GiB              │ 3.14 GiB                │
23. │ applied_ai.transaction_canonical_embeddings       │   6270 │ applied_ai.transaction_canonical_embeddings.prompt_for_accounting_matching          │ 9.79 GiB              │ 93.92 GiB               │
    └───────────────────────────────────────────────────┴────────┴─────────────────────────────────────────────────────────────────────────────────────┴───────────────────────┴─────────────────────────┘

23 rows in set. Elapsed: 0.333 sec. Processed 1.16 million rows, 57.93 MB (3.47 million rows/s., 174.05 MB/s.)

```

given number of queries:

```
 4. │ applied_ai.transaction_canonical_receipt_matching │ 608032 │ applied_ai.transaction_canonical_receipt_matching.embedding                         │ 916.64 GiB            │ 1.03 TiB                │

```

ie likely biggest issue here.


## cache usage

```sql
SELECT 
    tables.name AS table, 
    stats.col, 
    formatReadableSize(stats.size) AS size, 
    stats.cache_hits 
FROM (
    SELECT
        splitByChar('/', local_path)[-1] AS col,
        splitByChar('/', local_path)[2] AS uuid,
        sum(size) AS size,
        sum(cache_hits) AS cache_hits
    FROM
    (
        SELECT
            cache_path,
            cache_hits,
            remote_path,
            local_path,
            file_segment_range_begin,
            file_segment_range_end,
            size,
            state
        FROM
        (
            SELECT
                arrayJoin(cache_paths) AS cache_path,
                local_path,
                remote_path
            FROM system.remote_data_paths
        ) AS data_paths
        INNER JOIN (
            SELECT * FROM system.filesystem_cache WHERE cache_name = 's3diskWithCache'
        ) AS caches ON data_paths.cache_path = caches.cache_path
    )
    GROUP BY uuid, col
    ORDER BY size DESC
    LIMIT 100
) AS stats 
INNER JOIN system.tables AS tables 
ON toString(stats.uuid) = toString(tables.uuid)
FORMAT PrettyCompactMonoBlock;


     ┌─table────────────────────────────────────────────────┬─col──────────────────────────────────────────────────┬─size───────┬─cache_hits─┐
  1. │ transaction_canonical_embeddings                     │ bfloat16_embedding_for_accounting_matching.bin       │ 212.31 GiB │    9964334 │ <- metaflow
  2. │ transaction_canonical_receipt_matching               │ embedding.bin                                        │ 185.01 GiB │    2047923 │ <- core
  3. │ transaction_canonical_embeddings                     │ prompt_for_accounting_matching.bin                   │ 6.44 GiB   │     188289 │
  4. │ transaction_canonical_embeddings                     │ accounting_tracking_category_selections.bin          │ 4.99 GiB   │    7154297 │
  5. │ transaction_canonical_receipt_matching               │ card_acceptor.bin                                    │ 3.47 GiB   │    1311551 │
  6. │ transaction_canonical_embeddings                     │ user_transaction_time.bin                            │ 1.40 GiB   │    8751731 │
  7. │ prod_bill_pay_categorization                         │ vector_field.bin                                     │ 1.40 GiB   │       8026 │
  8. │ transaction_canonical_embeddings                     │ id.bin                                               │ 1.38 GiB   │    9354872 │
  9. │ transaction_canonical_embeddings                     │ merchant_name.bin                                    │ 1.28 GiB   │    6666684 │
 10. │ transaction_canonical_receipt_matching               │ merchant_domain.bin                                  │ 1.21 GiB   │    1345934 │
 11. │ transaction_canonical_embeddings                     │ version.bin                                          │ 1.08 GiB   │    8842466 │
 12. │ transaction_canonical_embeddings                     │ original_amount.bin                                  │ 1.03 GiB   │     362223 │
 13. │ transaction_canonical_receipt_matching               │ user_transaction_time.bin                            │ 927.39 MiB │    5768209 │
 14. │ transaction_canonical_receipt_matching               │ id.bin                                               │ 819.95 MiB │    3404661 │
 15. │ transaction_canonical_receipt_matching               │ memo.bin                                             │ 803.61 MiB │    1936459 │
 16. │ transaction_canonical_receipt_matching               │ merchant_name.bin                                    │ 746.30 MiB │    1356715 │
 17. │ transaction_canonical_receipt_matching               │ version.bin                                          │ 722.66 MiB │    2682081 │
 18. │ transaction_canonical_receipt_matching               │ amount.bin                                           │ 667.78 MiB │    1354176 │
 19. │ reimbursement_embeddings                             │ embedding_for_accounting_matching.bin                │ 652.00 MiB │        124 │
 20. │ transaction_canonical_receipt_matching               │ data.bin                                             │ 503.50 MiB │      87432 │
 21. │ transaction_canonical_receipt_matching               │ merchant_city.bin                                    │ 417.51 MiB │    1357215 │
 22. │ prod_bill_pay_categorization                         │ data.bin                                             │ 336.00 MiB │     362972 │
 23. │ transaction_canonical_receipt_matching               │ sk_category_name.bin                                 │ 326.79 MiB │    1361955 │
 24. │ transaction_canonical_receipt_matching               │ card_last_four.bin                                   │ 319.30 MiB │    1355645 │
 25. │ transaction_canonical_embeddings                     │ user_id.bin                                          │ 285.30 MiB │      43618 │
 26. │ transaction_canonical_receipt_matching               │ user_id.bin                                          │ 283.55 MiB │    4763600 │
 27. │ reimbursement_embeddings                             │ data.bin                                             │ 220.00 MiB │       5420 │
 28. │ transaction_canonical_receipt_matching               │ data.packed                                          │ 188.36 MiB │      11488 │
 29. │ transaction_canonical_embeddings                     │ memo.bin                                             │ 188.00 MiB │         47 │
 30. │ transaction_canonical_receipt_matching               │ merchant_state.bin                                   │ 176.58 MiB │    1360855 │
 31. │ transaction_canonical_embeddings                     │ data.packed                                          │ 153.36 MiB │       2240 │
 32. │ reimbursement_embeddings                             │ data.packed                                          │ 152.86 MiB │       5209 │
 33. │ applied_ai.transaction_canonical.embeddings          │ data.packed                                          │ 150.46 MiB │        429 │
 34. │ transaction_canonical_merchant_merging               │ data.packed                                          │ 119.42 MiB │        431 │
 35. │ aggregated_payee_metrics                             │ data.bin                                             │ 106.33 MiB │          0 │
 36. │ transaction_canonical_embeddings                     │ data.bin                                             │ 98.12 MiB  │      21948 │
 37. │ transaction_canonical_merchant_merging_for_centroids │ data.packed                                          │ 97.60 MiB  │        376 │
 38. │ reimbursement_embeddings                             │ memo.bin                                             │ 92.30 MiB  │       5718 │
 39. │ applied_ai.transaction_canonical.receipt_matching    │ data.packed                                          │ 81.61 MiB  │        449 │
 40. │ enriched.spend_allocation.results                    │ data.packed                                          │ 73.22 MiB  │        459 │
 41. │ prod_bill_pay_categorization                         │ data.packed                                          │ 71.85 MiB  │     736875 │
 42. │ transaction_canonical_receipt_matching               │ embedding.size0.bin                                  │ 67.97 MiB  │    2652256 │
 43. │ realtime_search_index                                │ data.packed                                          │ 61.01 MiB  │        661 │
 44. │ search_index                                         │ data.packed                                          │ 56.06 MiB  │         48 │
 45. │ applied_ai.transaction_canonical.merchant_merging    │ data.packed                                          │ 53.67 MiB  │        379 │
 46. │ enriched_event_log                                   │ data.packed                                          │ 49.22 MiB  │        604 │
 47. │ prod_bill_pay_categorization                         │ non_gl_category_blob.bin                             │ 45.49 MiB  │      50158 │
 48. │ spend_allocation_spend_allocations                   │ data.packed                                          │ 40.58 MiB  │        842 │
 49. │ enriched.tracking_category_option.results            │ data.packed                                          │ 39.66 MiB  │        313 │
 50. │ developer.request.audit_log                          │ data.packed                                          │ 39.36 MiB  │        417 │
 51. │ transaction_canonical_embeddings                     │ sync_ready_status.bin                                │ 38.62 MiB  │    9889831 │
 52. │ enriched.event_log.results                           │ data.packed                                          │ 37.68 MiB  │        376 │
 53. │ reimbursement_embeddings                             │ id.bin                                               │ 37.13 MiB  │       7354 │
 54. │ transaction_canonical_embeddings                     │ accounting_is_gl_tc_coded.bin                        │ 34.17 MiB  │    7713472 │
 55. │ payee_payee                                          │ data.packed                                          │ 32.27 MiB  │        347 │
 56. │ developer.request.audit_log                          │ data.packed                                          │ 31.21 MiB  │        442 │
 57. │ applied_ai.reimbursement.embeddings                  │ data.packed                                          │ 23.33 MiB  │        215 │
 58. │ enriched.spend_event.results                         │ data.packed                                          │ 23.09 MiB  │        323 │
 59. │ enriched_payees                                      │ data.packed                                          │ 21.99 MiB  │        412 │
 60. │ enriched_tracking_category_options                   │ data.packed                                          │ 18.51 MiB  │        311 │
 61. │ prod_bill_pay_categorization                         │ amount.bin                                           │ 18.29 MiB  │      52460 │
 62. │ enriched_spend_allocations                           │ data.packed                                          │ 17.28 MiB  │        370 │
 63. │ enriched_spend_events                                │ data.packed                                          │ 16.36 MiB  │        301 │
 64. │ prod_bill_pay_categorization                         │ bill_line_item_log_entry_id.bin                      │ 16.17 MiB  │      51710 │
 65. │ reimbursement_embeddings                             │ transaction_date.bin                                 │ 16.15 MiB  │       7967 │
 66. │ prod_bill_pay_categorization                         │ tracking_category_option_remote_name.bin             │ 15.18 MiB  │      51715 │
 67. │ reimbursement_embeddings                             │ user_id.bin                                          │ 15.05 MiB  │       7794 │
 68. │ rds_core.spend_allocation.spend_allocations          │ data.packed                                          │ 14.55 MiB  │        670 │
 69. │ profile_users                                        │ data.packed                                          │ 13.84 MiB  │        173 │
 70. │ transaction_canonical_receipt_matching               │ currency_code.bin                                    │ 12.85 MiB  │    1351041 │
 71. │ transaction_review_action_embeddings                 │ data.packed                                          │ 8.29 MiB   │       5122 │
 72. │ enriched.payee.results                               │ data.packed                                          │ 8.09 MiB   │        215 │
 73. │ mcc_to_merchant_ids                                  │ data.packed                                          │ 6.33 MiB   │         14 │
 74. │ prod_bill_pay_categorization                         │ tracking_category_option_id.bin                      │ 6.17 MiB   │      51535 │
 75. │ merchant_transactions                                │ data.packed                                          │ 5.19 MiB   │         14 │
 76. │ transaction_canonical_embeddings                     │ business_id.bin                                      │ 4.59 MiB   │    9063063 │
 77. │ transaction_canonical_receipt_matching               │ business_id.bin                                      │ 2.44 MiB   │    4969249 │
 78. │ transaction_canonical_embeddings                     │ bfloat16_embedding_for_accounting_matching.size0.bin │ 2.39 MiB   │   10119172 │
 79. │ rds_core.payee.payee                                 │ data.packed                                          │ 2.33 MiB   │        175 │
 80. │ zendesk_ticket_embeddings                            │ data.packed                                          │ 2.21 MiB   │          7 │
 81. │ enriched_cards                                       │ data.packed                                          │ 2.18 MiB   │         14 │
 82. │ travel_trip                                          │ data.packed                                          │ 1.45 MiB   │         51 │
 83. │ enriched_itinerary                                   │ data.packed                                          │ 1.27 MiB   │         62 │
 84. │ rds_core.profile.users                               │ data.packed                                          │ 801.23 KiB │         98 │
 85. │ enriched.card.results                                │ data.packed                                          │ 391.56 KiB │         35 │
 86. │ enriched.itinerary.results                           │ data.packed                                          │ 244.65 KiB │         35 │
 87. │ reimbursement_embeddings                             │ business_id.bin                                      │ 234.51 KiB │       8235 │
 88. │ enriched_merchants                                   │ data.packed                                          │ 185.20 KiB │         21 │
 89. │ business_department                                  │ data.packed                                          │ 153.29 KiB │         14 │
 90. │ transaction_canonical_receipt_matching               │ deleted.sparse.idx.bin                               │ 145.38 KiB │    2668934 │
 91. │ prod_bill_pay_categorization                         │ tracking_category_id.bin                             │ 135.70 KiB │      51324 │
 92. │ prod_bill_pay_categorization                         │ accounting_provider_access_id.bin                    │ 131.22 KiB │      44157 │
 93. │ prod_bill_pay_categorization                         │ business_id.bin                                      │ 122.68 KiB │      44419 │
 94. │ transaction_canonical_embeddings                     │ deleted.sparse.idx.bin                               │ 96.02 KiB  │       4918 │
 95. │ reimbursement_embeddings                             │ embedding_for_accounting_matching.size0.bin          │ 75.30 KiB  │       8317 │
 96. │ transaction_canonical_embeddings                     │ primary.cidx                                         │ 51.16 KiB  │          0 │
 97. │ search_index                                         │ data.cmrk3                                           │ 39.77 KiB  │          5 │
 98. │ rds_core.travel.trip                                 │ data.packed                                          │ 38.77 KiB  │         35 │
 99. │ enriched.merchant.results                            │ data.packed                                          │ 36.78 KiB  │         33 │
100. │ prod_bill_pay_categorization                         │ vector_field.size0.bin                               │ 33.79 KiB  │      51478 │
     └─table────────────────────────────────────────────────┴─col──────────────────────────────────────────────────┴─size───────┴─cache_hits─┘

100 rows in set. Elapsed: 62.341 sec. Processed 1.05 million rows, 371.19 MB (16.91 thousand rows/s., 5.95 MB/s.)
Peak memory usage: 493.27 MiB.

```






What queries are using `applied_ai.transaction_canonical_receipt_matching.embedding`?


```sql
SELECT query, initial_user, query_duration_ms FROM clusterAllReplicas('default', system.query_log) WHERE has(columns, 'applied_ai.transaction_canonical_receipt_matching.embedding') AND query_duration_ms BETWEEN 4000 AND 5000 ORDER BY query_duration_ms DESC LIMIT 10 FORMAT Vertical

query:             /*celerytid='f1d9f27e-f0ac-41c1-911a-1eadcd74810e',codeowner='ramp/employee-experience'*/ SELECT applied_ai.transaction_canonical_receipt_matching.id, applied_ai.transaction_canonical_receipt_matching.merchant_name, applied_ai.transaction_canonical_receipt_matching.merchant_city, applied_ai.transaction_canonical_receipt_matching.merchant_state, applied_ai.transaction_canonical_receipt_matching.merchant_domain, applied_ai.transaction_canonical_receipt_matching.sk_category_name, applied_ai.transaction_canonical_receipt_matching.user_transaction_time, applied_ai.transaction_canonical_receipt_matching.amount AS original_amount, applied_ai.transaction_canonical_receipt_matching.currency_code AS original_currency_code, applied_ai.transaction_canonical_receipt_matching.card_last_four, applied_ai.transaction_canonical_receipt_matching.user_id, applied_ai.transaction_canonical_receipt_matching.card_acceptor, 1 - cosineDistance(applied_ai.transaction_canonical_receipt_matching.embedding, [0.05434788, 0.01735039, -0.0158382, 0.055848703, -0.023262713, 0.07172101, -0.01363245, 0.035155576, 0.03713393, 0.006594513, -0.028265446, -0.032290373, -0.04770789, 0.0004910354, -0.009027661, 0.044569813, -0.012438616, 0.02197792, -0.0017822239, 0.0019684052, 0.03188106, 0.018646553, 0.012677383, -0.04675282, -0.052801583, -0.014132723, 0.012370396, 0.048071723, -0.0154629955, -0.0043802345, -0.020488469, 0.08359113, -0.0060373903, 0.04620707, 0.035292014, 0.052255828, -0.03481448, 0.04236406, -0.017577788, 0.028470105, -0.070902385, 0.013530121, 0.006958348, -0.019396964, -0.0012769762, 0.010994645, 0.019999566, -0.018623814, 0.06285253, -0.00078594085, 0.025422985, -0.09068592, 0.018760253, -0.0033199962, 0.039066803, -0.02040888, 0.03026654, 0.027810652, -0.004110201, 0.028561063, 0.0074813613, -0.044205975, -0.00910725, -0.0514372, 0.019976826, 0.011563137, 0.052801583, -0.023694767, 0.008976497, -0.019396964, 0.013700669, 0.0046559535, 0.01674779, -0.010858206, -0.033677496, 0.0056565003, 0.018623814, -0.07435882, 0.065308414, 0.009220948, -0.005093693, -0.026150655, 0.018430527, -0.04600241, 0.008572867, 0.008186292, -0.0049117752, -0.0066399924, -0.031858318, -0.004013557, -0.016270256, 0.053438295, -0.06285253, -0.02269422, -0.031471744, 0.025491202, -0.025604902, 0.015303818, 0.058895823, -0.008299991, -0.016770529, -0.04607063, 0.0241723, -0.006367116, 0.01827135, 0.035974205, -0.0042381114, -0.01582683, -0.004331913, -0.022944357, -0.029857226, -0.0043916046, 0.01438286, 0.005767356, -0.02790161, 0.047480494, -0.01972669, -0.024376959, -0.042318583, 0.048844874, 0.061579105, -0.021739153, 0.050209258, 0.017520938, 0.01742998, -0.01584957, -0.007856566, 0.0028723083, -0.009959988, -0.019078609, -0.033791192, -0.030675855, -0.005591124, -0.004007872, 0.0018504431, -0.00454794, -0.025195587, 0.012495465, 0.016736418, 0.02187559, -0.015497105, -0.03094873, -0.0039908173, 0.009959988, 0.008203346, -0.033609275, 0.04386488, -0.029811746, -0.056439932, 0.018680664, -0.038475573, -0.036429, 0.025604902, -0.013154916, -0.039521597, -0.026628189, -0.050982405, -0.013848477, -0.0003826665, -0.04607063, 0.045229264, -0.020749975, 0.024376959, -0.03390489, 0.035905987, -0.041863788, 0.011699575, -0.020204224, 0.036747355, -0.032813385, -0.061624587, -0.047525972, -0.009982728, 0.043523785, 0.019135457, -0.016315734, 0.0071800603, -0.028879419, -0.023717506, -0.017782444, -0.016656829, 0.015519845, -0.01894217, 0.015281078, -0.005758829, 0.022898877, 0.01439423, -0.022637371, -0.012404506, -0.0017850664, -0.0013586971, 0.02565038, 0.005906637, -0.0073221833, -0.036883794, -0.019283265, -0.005520062, -0.00045657053, -0.045138303, -0.038157217, 0.0258323, 0.00072411733, 0.030084623, -0.030152842, 0.0048094466, 0.026946545, 0.029652568, 0.07276704, -0.0878662, 0.03777064, 0.00832273, 0.033063523, -0.037361328, -0.020124635, -0.02492271, 0.03429147, 0.03931694, -0.010477317, -0.032062978, 0.0076121143, -0.039976392, 0.0072198547, -0.0036440368, -0.0007496995, 0.01215437, -0.0023009733, 0.026992023, -0.010727453, 0.02721942, 0.021557234, 0.018794362, -0.00018014105, -0.06721855, -0.051118843, 0.013666559, -0.022478193, -0.02106833, 0.012222588, -0.051346242, 0.048662957, 0.045593098, -0.008385264, -0.0050880075, -0.031426266, 0.00043987107, 0.010778617, 0.020670386, -0.027060242, 0.03492818, 0.0071288957, -0.021443537, 0.050891448, 0.0029646882, 0.03406407, -0.015303818, 0.029834487, 0.012006561, 0.0088798525, 0.025945997, -0.0121316295, -0.08227223, -0.014769435, 0.036429, -0.013768888, 0.032131195, 0.011415329, 0.06721855, 0.03799804, 0.080589496, -0.007259649, 0.0128138205, -0.03783886, -0.019112717, 0.0041158856, -0.02040888, 0.05593966, 0.022262165, 0.06039664, 0.006793485, 0.011114028, 0.048208162, 0.012404506, 0.0022412816, -0.0029362638, 0.010835467, 0.021739153, 0.0088002635, 0.012370396, -0.03413229, -0.018430527, -0.016361214, -0.026741887, -0.0045223576, -0.065717734, -0.020192852, 0.0023009733, -0.0010303926, 0.057667878, -0.036883794, 0.008260196, 0.005557014, 0.030903252, 0.049572546, -0.053392813, -0.023217233, -0.028129008, 0.006412595, -0.014610257, -0.04315995, -0.009647317, -0.028879419, -0.008652456, 0.013507381, -0.02106833, 0.05593966, 0.046298027, -0.031153388, 0.011472179, 0.018635184, -0.02349011, 0.023694767, -0.015747242, 0.030061882, -0.00041819728, -0.046661865, -0.00047575714, 0.0437057, 0.011261837, -0.0007717286, 0.03181284, 0.00073477655, -0.013041218, 0.000709905, -0.008959441, 0.022364495, -0.030380238, -0.017168473, 0.008220402, -0.007197115, 0.029265992, 0.034473386, -0.049708985, 0.032676946, -0.017702855, -0.07344923, 0.035360232, -0.015451626, 0.026287092, -0.0020579428, 0.013382313, 0.025559422, 0.016975185, 0.0257186, -0.018680664, 0.013234505, 5.582774e-05, -0.011153823, 0.008004374, -0.033040784, 0.01890806, 0.019158198, -0.014041765, 0.0071459506, 0.01735039, 0.012745601, 0.004763967, -0.01899902, 0.017896144, -0.069538005, 0.015735872, -0.020636277, 0.04600241, -0.019556142, 0.018851211, 0.015531215, 0.023353672, -0.034405164, 0.05148268, -0.02649175, 0.008402319, 0.0023890897, -0.0095620435, 0.0117109455, -0.025923258, -0.04229584, -0.007776977, -0.018760253, -0.0144397095, 0.016270256, 0.015292448, 0.030039143, -0.014826284, 0.024354218, 0.028833939, -0.0051732818, 0.023558328, -0.0005599651, 0.014587517, 0.005900952, -0.008476223, -0.014291901, 0.060760476, 0.035246532, 0.03106243, 0.020784086, 0.00788499, 0.0061056092, 0.00064488366, -0.042659678, 0.009255058, -0.024831751, 0.02642353, -0.0025909045, 0.029334212, -0.0037008862, -0.0062534176, -0.008760469, -0.010795672, 0.0348827, 0.044046797, -0.0015704605, -0.01588368, -0.023785725, 0.0103749875, 0.0068446496, -0.0011988085, 0.03777064, -0.008112388, 0.021534495, -0.0035246534, -0.035337493, -0.009021976, -0.020954633, 0.043478306, -0.006884444, -0.034655303, -0.012233959, -0.035451192, 0.0038828037, -0.06908321, 0.016895596, 0.044456113, 0.017771075, -0.008726359, -0.050391175, 0.05680377, -0.035974205, -0.021398056, 0.02204614, 0.00025138026, 0.0020991585, 0.0014965564, -0.0028453048, 0.030925991, -0.04081776, -0.017668746, -0.008561497, 0.028129008, 0.01971532, -0.0073108133, -0.0048037614, 0.0042011593, 0.014974092, 0.017918883, -0.022250796, -0.0011149559, -0.059396096, -0.017862033, -0.009129989, 0.021045592, 0.030448457, -0.011301631, -0.021500386, 0.008777524, -0.01590642, 0.0053324597, 0.047889806, 0.0010595279, 0.022842027, -0.0063273213, -0.00788499, -0.035223793, 0.021159291, -0.016145186, -0.06330732, 0.0013117964, 0.014792174, -0.017339021, 0.04607063, 0.000839237, 0.054893635, -0.02801531, 0.049890902, -0.01965847, -0.018566964, -0.0009969937, 0.00909588, -0.015178749, -0.010414782, -0.06212486, 0.01576998, -0.033177223, -0.039930914, 0.032813385, 0.045138303, -0.056530893, -0.013825737, 0.0076746484, -0.043910358, 0.01056259, -0.06908321, -0.050891448, 0.016531762, -0.044478852, 0.019783538, 0.03470078, 0.0058725276, 0.011267521, 0.009334647, -0.038998585, 0.014553407, 0.007947525, -0.005386466, -0.053347334, 0.060896914, -0.04688926, -0.03706571, -0.04757145, -0.008516017, 0.02106833, -0.019135457, -0.019487923, -0.025400244, -0.0023748775, 0.042091183, -0.019226415, 0.051027887, -0.020727236, -0.019249156, -0.04318269, -0.052619666, -0.036883794, 0.019919977, 0.026787367, -0.040499404, 0.006742321, -0.0013032691, 0.03176736, -0.01135848, -0.022898877, -0.0027088667, -0.0050737956, 0.025945997, 0.018294089, -0.013143546, -0.008004374, 0.049708985, 0.040635843, -0.023740247, 0.042909812, -0.0076803337, -0.03094873, 0.023274083, -0.027856132, 0.0016941077, 0.042909812, 0.019885868, -0.017782444, -0.017498199, 0.030903252, -0.018964909, 0.030675855, 0.019453812, -0.052483227, 0.01588368, 0.024740793, 0.006884444, -0.041340772, 0.05748596, 0.026969284, -0.004431399, -0.038862146, -0.035132837, 0.017623266, 0.00940855, -0.00099273, 0.025513943, -0.030357499, -0.014223682, -0.013871217, 0.025172848, -0.026218874, 0.023228602, -0.03019832, -0.015679022, 0.05839555, -0.04168187, 0.023092166, -0.015394776, 0.014769435, -0.004388762, 0.03547393, 0.02489997, 0.012700122, -0.046525426, -0.019976826, 0.04027201, -0.022580521, 0.013200396, 0.019510662, 0.032995302, 0.07967991, 0.057031166, -0.01746409, 0.014632996, -0.026378052, -0.035337493, -0.0072880737, -0.030493937, 0.0038060572, -0.04839008, -0.044569813, -0.0031949277, -0.06471718, 0.024649834, -0.03335914, 0.016031489, 0.015303818, 0.021159291, 0.00079162576, 0.021159291, 0.007037937, 0.036656395, 0.042022966, -0.027037503, -0.011193617, 0.027105723, 0.0009962831, 0.02053395, 0.017248062, -0.021295728, 0.036883794, -0.0049032476, -0.013177656, 0.008624031, -0.013484642, -0.010323823, -0.009829235, -0.033086263, 0.009021976, 0.013507381, 0.048026245, -0.009971358, 0.001475238, -0.08049854, -0.0071516354, 0.0257186, -0.01663409, 0.010750193, 4.5701465e-05, -0.026400791, -0.019317375, 0.04925419, -0.0017509569, 0.021045592, 0.04213666, -0.035155576, -0.035337493, -0.018544225, -0.00033505526, -0.01827135, -0.008533073, -0.02644627, 0.033859413, 0.021670934, -0.058668423, 0.010835467, 0.017054774, -0.01026129, -0.0014610257, 0.013336834, 0.033199962, 0.0025837983, -0.01021581, -0.020374771, -0.014849024, 0.055302948, 0.07331279, -0.049345147, 0.00039830004, 0.025513943, 0.001195966, 0.014507928, 0.02503641, -0.0039197556, -0.02131847, -0.069310606, 0.05434788, 0.052756105, -0.03781612, 0.0032489346, 0.0008648192, 0.021329839, 0.017759705, 0.026082436, 0.048981313, 0.03788434, 0.024263259, 0.024627095, -0.022466823, -0.038248174, 0.01135848, 0.026082436, 0.014075874, 0.035860505, 0.0018987649, -0.016520392, -0.031426266, -0.05694021, -0.011074234, -0.01746409, 0.0040704063, -0.0021972235, -0.01095485, -0.031449005, -0.008908277, 0.06376212, 0.016247515, -0.043773923, 0.08159004, 0.0560761, -0.04984542, 0.02799257, -0.070220195, 0.02878846, 0.0257186, 0.03481448, -0.04081776, 0.05671281, 0.03879393, 0.0065376638, 0.03256325, -0.02724216, -0.04625255, 0.036087904, 0.0060999244, -0.037247628, -0.00682191, 0.011745055, 0.03879393, 0.006486499, -0.030789552, 0.04386488, 0.023205863, -0.016463542, 0.008504648, 0.055621304, -0.032858867, -0.016486282, -0.018362308, -0.02574134, 0.020670386, -0.032222155, -0.009726906, 0.00048073145, 0.011011699, 0.041886527, -0.019806279, -0.02349011, -0.03863475, -0.0007326447, 0.0042381114, -0.013461902, -0.02728764, -0.007487046, 0.01513327, -0.016656829, 0.016281625, -0.0009799389, 0.024149561, 0.04675282, -0.010323823, 0.06189746, 0.02053395, -0.019078609, 0.00077457103, 1.9819514e-05, -0.018055322, -0.059305135, -0.006577458, -0.045956932, 0.009124304, 0.0241723, -0.032404073, -0.037406806, 0.03106243, 0.010306769, 0.031198869, 0.076541826, -0.01514464, -0.026810106, 0.03554215, 0.016838748, -0.002600853, 0.028833939, 0.023421891, 0.005821363, 0.028333666, 0.0049458845, 0.048208162, -0.013552861, -0.042204883, -0.019829018, 0.002201487, -0.0121316295, -0.08427332, 0.011290261, -0.05448432, -0.03406407, -0.016929707, -0.044069536, 0.011426699, 0.033541057, 0.040067352, 0.009283482, 0.03458708, 0.0025980107, 0.0097723855, 0.0030528046, 0.0646717, 0.059941847, 0.044456113, -0.008720675, -0.046707343, 0.009778071, -0.034405164, 0.005093693, 0.048844874, 0.027014762, 0.0077826623, 0.0752684, 0.036019683, 0.04149995, 0.04090872, -0.01674779, -0.023421891, 0.07476813, -0.052756105, -0.03949886, -0.046707343, 0.03404133, -0.022091618, 0.011847383, 0.026264353, 0.047207616, 0.069992796, -0.047525972, -0.02045436, -0.07713306, 0.033836674, 0.044956386, -0.050436653, 0.017952994, 0.0062249927, 0.0051732818, -0.0362016, -0.059259657, -0.026719147, -0.010028208, 0.03843009, 0.003908386, -0.015508475, -0.039953653, 0.055621304, -0.032290373, 0.05443884, 0.043592002, -0.030448457, 9.770965e-05, 0.027833393, -0.02198929, -0.036429, -0.025059149, 0.026673667, 0.005059583, 0.008186292, 0.02117066, -0.0036070847, 0.014235052, 0.005827048, 0.011415329, -0.025900519, -0.014769435, -0.027583256, -0.053074457, 0.018726142, -0.0024573088, -0.07008375, 0.033427358, 0.024536137, -0.005986226, 0.03176736, -0.019874498, -0.0099543035, -0.01584957, -0.011602932, -0.008857113, -0.059396096, -0.033313658, -0.043614745, -0.00095862045, 0.025855038, 0.019192306, 0.024490656, -0.011199302, -0.032972563, -0.024831751, 0.026241614, -0.0019811962, 0.039294202, -0.008453484, -0.0037520505, -0.0134960115, -0.06994732, 0.030084623, 0.08882127, -0.029265992, -0.029857226, -0.022012029, 0.101782896, 0.047980767, -0.02430874, 0.059168696, -0.03429147, -0.023922164, -0.005139172, -0.0059578014, -0.019283265, -0.0022398604, 0.0062534176, -0.05366569, -0.021272989, 0.012654643, 0.013939436, -0.0084080035, -0.012484095, 0.027378598, -0.020272441, -0.04675282, -0.038498312, -0.05130076, 0.030402979, 0.036588177, -0.017702855, 0.04156817, 0.044296935, 0.019340115, -0.025195587, 0.058759384, 0.01020444, -0.008493278, 0.03858927, 0.027878871, 0.036861055, 0.09623441, 0.021045592, -0.016543131, 0.013461902, -0.017725596, -0.0409542, 0.035110097, -0.027469557, -0.008231771, -0.015451626, 0.0348827, -0.0015690393, 0.041227076, -0.040499404, -0.023672028, 0.009186839, -0.0257186, -0.06881033, 0.07390402, 0.03999913, 0.02492271, 0.01813491, -0.02724216, 0.036224343, 0.026787367, -0.029175034, 0.01596327, 0.047480494, 0.022421343, -0.07476813, 0.041977484, -0.0012314968, 0.044137757, -0.04600241, 0.01438286, 0.04149995, -0.027446818, 0.026355311, -0.030584896, -0.004891878, 0.0072141695, -0.012484095, 0.036883794, -0.023001205, 0.020806825, -0.01669094, -0.016224775, -0.07390402, 0.0061454037, 0.038157217, 0.027583256, -0.024263259, -0.006793485, 0.046843782, 0.07081142, 0.03165366, -0.0006491474, -0.014121354, -0.02951613, 0.025218327]) AS score
FROM applied_ai.transaction_canonical_receipt_matching
FINAL
WHERE applied_ai.transaction_canonical_receipt_matching.user_transaction_time >= '2023-11-05 00:00:00' AND applied_ai.transaction_canonical_receipt_matching.business_id IN (65707) AND applied_ai.transaction_canonical_receipt_matching.user_id IN (468210) ORDER BY score DESC
 LIMIT 32
initial_user:      core
query_duration_ms: 4951
```

Running this,

```sql
32 rows in set. Elapsed: 5.427 sec. Processed 221.39 thousand rows, 795.18 MB (40.80 thousand rows/s., 146.53 MB/s.)
32 rows in set. Elapsed: 0.610 sec. Processed 222.08 thousand rows, 795.19 MB (364.12 thousand rows/s., 1.30 GB/s.)
32 rows in set. Elapsed: 0.642 sec. Processed 222.32 thousand rows, 795.19 MB (346.11 thousand rows/s., 1.24 GB/s.)

EXPLAIN indexes=1 SELECT applied_ai.transaction_canonical_receipt_matching.id, applied_ai.transaction_canonical_receipt_matching.merchant_name, applied_ai.transaction_canonical_receipt_matching.merchant_city, applied_ai.transaction_canonical_receipt_matching.merchant_state, applied_ai.transaction_canonical_receipt_matching.merchant_domain, applied_ai.transaction_canonical_receipt_matching.sk_category_name, applied_ai.transaction_canonical_receipt_matching.user_transaction_time, applied_ai.transaction_canonical_receipt_matching.amount AS original_amount, applied_ai.transaction_canonical_receipt_matching.currency_code AS original_currency_code, applied_ai.transaction_canonical_receipt_matching.card_last_four, applied_ai.transaction_canonical_receipt_matching.user_id, applied_ai.transaction_canonical_receipt_matching.card_acceptor, 1 - cosineDistance(applied_ai.transaction_canonical_receipt_matching.embedding, [0.05434788, 0.01735039, -0.0158382, 0.055848703, -0.023262713, 0.07172101, -0.01363245, 0.035155576, 0.03713393, 0.006594513, -0.028265446, -0.032290373, -0.04770789, 0.0004910354, -0.009027661, 0.044569813, -0.012438616, 0.02197792, -0.0017822239, 0.0019684052, 0.03188106, 0.018646553, 0.012677383, -0.04675282, -0.052801583, -0.014132723, 0.012370396, 0.048071723, -0.0154629955, -0.0043802345, -0.020488469, 0.08359113, -0.0060373903, 0.04620707, 0.035292014, 0.052255828, -0.03481448, 0.04236406, -0.017577788, 0.028470105, -0.070902385, 0.013530121, 0.006958348, -0.019396964, -0.0012769762, 0.010994645, 0.019999566, -0.018623814, 0.06285253, -0.00078594085, 0.025422985, -0.09068592, 0.018760253, -0.0033199962, 0.039066803, -0.02040888, 0.03026654, 0.027810652, -0.004110201, 0.028561063, 0.0074813613, -0.044205975, -0.00910725, -0.0514372, 0.019976826, 0.011563137, 0.052801583, -0.023694767, 0.008976497, -0.019396964, 0.013700669, 0.0046559535, 0.01674779, -0.010858206, -0.033677496, 0.0056565003, 0.018623814, -0.07435882, 0.065308414, 0.009220948, -0.005093693, -0.026150655, 0.018430527, -0.04600241, 0.008572867, 0.008186292, -0.0049117752, -0.0066399924, -0.031858318, -0.004013557, -0.016270256, 0.053438295, -0.06285253, -0.02269422, -0.031471744, 0.025491202, -0.025604902, 0.015303818, 0.058895823, -0.008299991, -0.016770529, -0.04607063, 0.0241723, -0.006367116, 0.01827135, 0.035974205, -0.0042381114, -0.01582683, -0.004331913, -0.022944357, -0.029857226, -0.0043916046, 0.01438286, 0.005767356, -0.02790161, 0.047480494, -0.01972669, -0.024376959, -0.042318583, 0.048844874, 0.061579105, -0.021739153, 0.050209258, 0.017520938, 0.01742998, -0.01584957, -0.007856566, 0.0028723083, -0.009959988, -0.019078609, -0.033791192, -0.030675855, -0.005591124, -0.004007872, 0.0018504431, -0.00454794, -0.025195587, 0.012495465, 0.016736418, 0.02187559, -0.015497105, -0.03094873, -0.0039908173, 0.009959988, 0.008203346, -0.033609275, 0.04386488, -0.029811746, -0.056439932, 0.018680664, -0.038475573, -0.036429, 0.025604902, -0.013154916, -0.039521597, -0.026628189, -0.050982405, -0.013848477, -0.0003826665, -0.04607063, 0.045229264, -0.020749975, 0.024376959, -0.03390489, 0.035905987, -0.041863788, 0.011699575, -0.020204224, 0.036747355, -0.032813385, -0.061624587, -0.047525972, -0.009982728, 0.043523785, 0.019135457, -0.016315734, 0.0071800603, -0.028879419, -0.023717506, -0.017782444, -0.016656829, 0.015519845, -0.01894217, 0.015281078, -0.005758829, 0.022898877, 0.01439423, -0.022637371, -0.012404506, -0.0017850664, -0.0013586971, 0.02565038, 0.005906637, -0.0073221833, -0.036883794, -0.019283265, -0.005520062, -0.00045657053, -0.045138303, -0.038157217, 0.0258323, 0.00072411733, 0.030084623, -0.030152842, 0.0048094466, 0.026946545, 0.029652568, 0.07276704, -0.0878662, 0.03777064, 0.00832273, 0.033063523, -0.037361328, -0.020124635, -0.02492271, 0.03429147, 0.03931694, -0.010477317, -0.032062978, 0.0076121143, -0.039976392, 0.0072198547, -0.0036440368, -0.0007496995, 0.01215437, -0.0023009733, 0.026992023, -0.010727453, 0.02721942, 0.021557234, 0.018794362, -0.00018014105, -0.06721855, -0.051118843, 0.013666559, -0.022478193, -0.02106833, 0.012222588, -0.051346242, 0.048662957, 0.045593098, -0.008385264, -0.0050880075, -0.031426266, 0.00043987107, 0.010778617, 0.020670386, -0.027060242, 0.03492818, 0.0071288957, -0.021443537, 0.050891448, 0.0029646882, 0.03406407, -0.015303818, 0.029834487, 0.012006561, 0.0088798525, 0.025945997, -0.0121316295, -0.08227223, -0.014769435, 0.036429, -0.013768888, 0.032131195, 0.011415329, 0.06721855, 0.03799804, 0.080589496, -0.007259649, 0.0128138205, -0.03783886, -0.019112717, 0.0041158856, -0.02040888, 0.05593966, 0.022262165, 0.06039664, 0.006793485, 0.011114028, 0.048208162, 0.012404506, 0.0022412816, -0.0029362638, 0.010835467, 0.021739153, 0.0088002635, 0.012370396, -0.03413229, -0.018430527, -0.016361214, -0.026741887, -0.0045223576, -0.065717734, -0.020192852, 0.0023009733, -0.0010303926, 0.057667878, -0.036883794, 0.008260196, 0.005557014, 0.030903252, 0.049572546, -0.053392813, -0.023217233, -0.028129008, 0.006412595, -0.014610257, -0.04315995, -0.009647317, -0.028879419, -0.008652456, 0.013507381, -0.02106833, 0.05593966, 0.046298027, -0.031153388, 0.011472179, 0.018635184, -0.02349011, 0.023694767, -0.015747242, 0.030061882, -0.00041819728, -0.046661865, -0.00047575714, 0.0437057, 0.011261837, -0.0007717286, 0.03181284, 0.00073477655, -0.013041218, 0.000709905, -0.008959441, 0.022364495, -0.030380238, -0.017168473, 0.008220402, -0.007197115, 0.029265992, 0.034473386, -0.049708985, 0.032676946, -0.017702855, -0.07344923, 0.035360232, -0.015451626, 0.026287092, -0.0020579428, 0.013382313, 0.025559422, 0.016975185, 0.0257186, -0.018680664, 0.013234505, 5.582774e-05, -0.011153823, 0.008004374, -0.033040784, 0.01890806, 0.019158198, -0.014041765, 0.0071459506, 0.01735039, 0.012745601, 0.004763967, -0.01899902, 0.017896144, -0.069538005, 0.015735872, -0.020636277, 0.04600241, -0.019556142, 0.018851211, 0.015531215, 0.023353672, -0.034405164, 0.05148268, -0.02649175, 0.008402319, 0.0023890897, -0.0095620435, 0.0117109455, -0.025923258, -0.04229584, -0.007776977, -0.018760253, -0.0144397095, 0.016270256, 0.015292448, 0.030039143, -0.014826284, 0.024354218, 0.028833939, -0.0051732818, 0.023558328, -0.0005599651, 0.014587517, 0.005900952, -0.008476223, -0.014291901, 0.060760476, 0.035246532, 0.03106243, 0.020784086, 0.00788499, 0.0061056092, 0.00064488366, -0.042659678, 0.009255058, -0.024831751, 0.02642353, -0.0025909045, 0.029334212, -0.0037008862, -0.0062534176, -0.008760469, -0.010795672, 0.0348827, 0.044046797, -0.0015704605, -0.01588368, -0.023785725, 0.0103749875, 0.0068446496, -0.0011988085, 0.03777064, -0.008112388, 0.021534495, -0.0035246534, -0.035337493, -0.009021976, -0.020954633, 0.043478306, -0.006884444, -0.034655303, -0.012233959, -0.035451192, 0.0038828037, -0.06908321, 0.016895596, 0.044456113, 0.017771075, -0.008726359, -0.050391175, 0.05680377, -0.035974205, -0.021398056, 0.02204614, 0.00025138026, 0.0020991585, 0.0014965564, -0.0028453048, 0.030925991, -0.04081776, -0.017668746, -0.008561497, 0.028129008, 0.01971532, -0.0073108133, -0.0048037614, 0.0042011593, 0.014974092, 0.017918883, -0.022250796, -0.0011149559, -0.059396096, -0.017862033, -0.009129989, 0.021045592, 0.030448457, -0.011301631, -0.021500386, 0.008777524, -0.01590642, 0.0053324597, 0.047889806, 0.0010595279, 0.022842027, -0.0063273213, -0.00788499, -0.035223793, 0.021159291, -0.016145186, -0.06330732, 0.0013117964, 0.014792174, -0.017339021, 0.04607063, 0.000839237, 0.054893635, -0.02801531, 0.049890902, -0.01965847, -0.018566964, -0.0009969937, 0.00909588, -0.015178749, -0.010414782, -0.06212486, 0.01576998, -0.033177223, -0.039930914, 0.032813385, 0.045138303, -0.056530893, -0.013825737, 0.0076746484, -0.043910358, 0.01056259, -0.06908321, -0.050891448, 0.016531762, -0.044478852, 0.019783538, 0.03470078, 0.0058725276, 0.011267521, 0.009334647, -0.038998585, 0.014553407, 0.007947525, -0.005386466, -0.053347334, 0.060896914, -0.04688926, -0.03706571, -0.04757145, -0.008516017, 0.02106833, -0.019135457, -0.019487923, -0.025400244, -0.0023748775, 0.042091183, -0.019226415, 0.051027887, -0.020727236, -0.019249156, -0.04318269, -0.052619666, -0.036883794, 0.019919977, 0.026787367, -0.040499404, 0.006742321, -0.0013032691, 0.03176736, -0.01135848, -0.022898877, -0.0027088667, -0.0050737956, 0.025945997, 0.018294089, -0.013143546, -0.008004374, 0.049708985, 0.040635843, -0.023740247, 0.042909812, -0.0076803337, -0.03094873, 0.023274083, -0.027856132, 0.0016941077, 0.042909812, 0.019885868, -0.017782444, -0.017498199, 0.030903252, -0.018964909, 0.030675855, 0.019453812, -0.052483227, 0.01588368, 0.024740793, 0.006884444, -0.041340772, 0.05748596, 0.026969284, -0.004431399, -0.038862146, -0.035132837, 0.017623266, 0.00940855, -0.00099273, 0.025513943, -0.030357499, -0.014223682, -0.013871217, 0.025172848, -0.026218874, 0.023228602, -0.03019832, -0.015679022, 0.05839555, -0.04168187, 0.023092166, -0.015394776, 0.014769435, -0.004388762, 0.03547393, 0.02489997, 0.012700122, -0.046525426, -0.019976826, 0.04027201, -0.022580521, 0.013200396, 0.019510662, 0.032995302, 0.07967991, 0.057031166, -0.01746409, 0.014632996, -0.026378052, -0.035337493, -0.0072880737, -0.030493937, 0.0038060572, -0.04839008, -0.044569813, -0.0031949277, -0.06471718, 0.024649834, -0.03335914, 0.016031489, 0.015303818, 0.021159291, 0.00079162576, 0.021159291, 0.007037937, 0.036656395, 0.042022966, -0.027037503, -0.011193617, 0.027105723, 0.0009962831, 0.02053395, 0.017248062, -0.021295728, 0.036883794, -0.0049032476, -0.013177656, 0.008624031, -0.013484642, -0.010323823, -0.009829235, -0.033086263, 0.009021976, 0.013507381, 0.048026245, -0.009971358, 0.001475238, -0.08049854, -0.0071516354, 0.0257186, -0.01663409, 0.010750193, 4.5701465e-05, -0.026400791, -0.019317375, 0.04925419, -0.0017509569, 0.021045592, 0.04213666, -0.035155576, -0.035337493, -0.018544225, -0.00033505526, -0.01827135, -0.008533073, -0.02644627, 0.033859413, 0.021670934, -0.058668423, 0.010835467, 0.017054774, -0.01026129, -0.0014610257, 0.013336834, 0.033199962, 0.0025837983, -0.01021581, -0.020374771, -0.014849024, 0.055302948, 0.07331279, -0.049345147, 0.00039830004, 0.025513943, 0.001195966, 0.014507928, 0.02503641, -0.0039197556, -0.02131847, -0.069310606, 0.05434788, 0.052756105, -0.03781612, 0.0032489346, 0.0008648192, 0.021329839, 0.017759705, 0.026082436, 0.048981313, 0.03788434, 0.024263259, 0.024627095, -0.022466823, -0.038248174, 0.01135848, 0.026082436, 0.014075874, 0.035860505, 0.0018987649, -0.016520392, -0.031426266, -0.05694021, -0.011074234, -0.01746409, 0.0040704063, -0.0021972235, -0.01095485, -0.031449005, -0.008908277, 0.06376212, 0.016247515, -0.043773923, 0.08159004, 0.0560761, -0.04984542, 0.02799257, -0.070220195, 0.02878846, 0.0257186, 0.03481448, -0.04081776, 0.05671281, 0.03879393, 0.0065376638, 0.03256325, -0.02724216, -0.04625255, 0.036087904, 0.0060999244, -0.037247628, -0.00682191, 0.011745055, 0.03879393, 0.006486499, -0.030789552, 0.04386488, 0.023205863, -0.016463542, 0.008504648, 0.055621304, -0.032858867, -0.016486282, -0.018362308, -0.02574134, 0.020670386, -0.032222155, -0.009726906, 0.00048073145, 0.011011699, 0.041886527, -0.019806279, -0.02349011, -0.03863475, -0.0007326447, 0.0042381114, -0.013461902, -0.02728764, -0.007487046, 0.01513327, -0.016656829, 0.016281625, -0.0009799389, 0.024149561, 0.04675282, -0.010323823, 0.06189746, 0.02053395, -0.019078609, 0.00077457103, 1.9819514e-05, -0.018055322, -0.059305135, -0.006577458, -0.045956932, 0.009124304, 0.0241723, -0.032404073, -0.037406806, 0.03106243, 0.010306769, 0.031198869, 0.076541826, -0.01514464, -0.026810106, 0.03554215, 0.016838748, -0.002600853, 0.028833939, 0.023421891, 0.005821363, 0.028333666, 0.0049458845, 0.048208162, -0.013552861, -0.042204883, -0.019829018, 0.002201487, -0.0121316295, -0.08427332, 0.011290261, -0.05448432, -0.03406407, -0.016929707, -0.044069536, 0.011426699, 0.033541057, 0.040067352, 0.009283482, 0.03458708, 0.0025980107, 0.0097723855, 0.0030528046, 0.0646717, 0.059941847, 0.044456113, -0.008720675, -0.046707343, 0.009778071, -0.034405164, 0.005093693, 0.048844874, 0.027014762, 0.0077826623, 0.0752684, 0.036019683, 0.04149995, 0.04090872, -0.01674779, -0.023421891, 0.07476813, -0.052756105, -0.03949886, -0.046707343, 0.03404133, -0.022091618, 0.011847383, 0.026264353, 0.047207616, 0.069992796, -0.047525972, -0.02045436, -0.07713306, 0.033836674, 0.044956386, -0.050436653, 0.017952994, 0.0062249927, 0.0051732818, -0.0362016, -0.059259657, -0.026719147, -0.010028208, 0.03843009, 0.003908386, -0.015508475, -0.039953653, 0.055621304, -0.032290373, 0.05443884, 0.043592002, -0.030448457, 9.770965e-05, 0.027833393, -0.02198929, -0.036429, -0.025059149, 0.026673667, 0.005059583, 0.008186292, 0.02117066, -0.0036070847, 0.014235052, 0.005827048, 0.011415329, -0.025900519, -0.014769435, -0.027583256, -0.053074457, 0.018726142, -0.0024573088, -0.07008375, 0.033427358, 0.024536137, -0.005986226, 0.03176736, -0.019874498, -0.0099543035, -0.01584957, -0.011602932, -0.008857113, -0.059396096, -0.033313658, -0.043614745, -0.00095862045, 0.025855038, 0.019192306, 0.024490656, -0.011199302, -0.032972563, -0.024831751, 0.026241614, -0.0019811962, 0.039294202, -0.008453484, -0.0037520505, -0.0134960115, -0.06994732, 0.030084623, 0.08882127, -0.029265992, -0.029857226, -0.022012029, 0.101782896, 0.047980767, -0.02430874, 0.059168696, -0.03429147, -0.023922164, -0.005139172, -0.0059578014, -0.019283265, -0.0022398604, 0.0062534176, -0.05366569, -0.021272989, 0.012654643, 0.013939436, -0.0084080035, -0.012484095, 0.027378598, -0.020272441, -0.04675282, -0.038498312, -0.05130076, 0.030402979, 0.036588177, -0.017702855, 0.04156817, 0.044296935, 0.019340115, -0.025195587, 0.058759384, 0.01020444, -0.008493278, 0.03858927, 0.027878871, 0.036861055, 0.09623441, 0.021045592, -0.016543131, 0.013461902, -0.017725596, -0.0409542, 0.035110097, -0.027469557, -0.008231771, -0.015451626, 0.0348827, -0.0015690393, 0.041227076, -0.040499404, -0.023672028, 0.009186839, -0.0257186, -0.06881033, 0.07390402, 0.03999913, 0.02492271, 0.01813491, -0.02724216, 0.036224343, 0.026787367, -0.029175034, 0.01596327, 0.047480494, 0.022421343, -0.07476813, 0.041977484, -0.0012314968, 0.044137757, -0.04600241, 0.01438286, 0.04149995, -0.027446818, 0.026355311, -0.030584896, -0.004891878, 0.0072141695, -0.012484095, 0.036883794, -0.023001205, 0.020806825, -0.01669094, -0.016224775, -0.07390402, 0.0061454037, 0.038157217, 0.027583256, -0.024263259, -0.006793485, 0.046843782, 0.07081142, 0.03165366, -0.0006491474, -0.014121354, -0.02951613, 0.025218327]) AS score
FROM applied_ai.transaction_canonical_receipt_matching
FINAL
PREWHERE applied_ai.transaction_canonical_receipt_matching.user_transaction_time >= '2023-11-05 00:00:00' AND applied_ai.transaction_canonical_receipt_matching.business_id IN (65707) AND applied_ai.transaction_canonical_receipt_matching.user_id IN (468210)  ORDER BY score DESC
 LIMIT 32
```

```sql
SELECT
    splitByChar('/', local_path)[-1] AS col,
    splitByChar('/', local_path)[2] AS `table`,
    sum(size) AS size,
    sum(cache_hits) AS cache_hits
FROM
(
    SELECT
        cache_path,
        cache_hits,
        remote_path,
        local_path,
        file_segment_range_begin,
        file_segment_range_end,
        size,
        state
    FROM
    (
        SELECT
            arrayJoin(cache_paths) AS cache_path,
            local_path,
            remote_path
        FROM system.remote_data_paths
    ) AS data_paths
    INNER JOIN system.filesystem_cache AS caches ON data_paths.cache_path = caches.cache_path
)
GROUP BY
    `table`,
    col
ORDER BY size DESC
LIMIT 100
FORMAT PrettyCompactMonoBlock

```







Other things excluded:
 - inserts
 - merges






Run 1 (no changes): 

https://grafana.us-east-2.aws.clickhouse-prd.com/d/cectw0fb2xddse/ramp-advanced-dashboard-test-bed?orgId=1&from=2025-02-11T20:40:00.000Z&to=2025-02-11T22:25:00.000Z&timezone=utc&var-datasource=loghouse-production-aws-us-east-1&var-spokenName=magenta-qd-44&var-rounding=60&var-region=us-east-1&tab=queries


```

SELECT
    user,
    count() AS num_queries,
    countIf(query_duration_ms > 2000) AS `num>2s`,
    countIf(query_duration_ms > 3000) AS `num>3s`,
    avg(query_duration_ms) AS avg,
    quantile(0.9)(query_duration_ms) AS `90th`,
    quantile(0.99)(query_duration_ms) AS `99th`,
    max(query_duration_ms)
FROM clusterAllReplicas('default', system.query_log)
WHERE (initial_user IN ('core', 'metaflow')) AND ((event_time >= '2025-02-11 20:40:00') AND (event_time <= '2025-02-11 22:25:00')) AND (type = 'QueryFinish')
GROUP BY user
FORMAT PrettyCompactMonoBlock

   ┌─user─────┬─num_queries─┬─num>2s─┬─num>3s─┬────────────────avg─┬─90th─┬──────────────99th─┬─max(query_duration_ms)─┐
1. │ core     │       92879 │     28 │     19 │ 104.83999612398928 │  293 │ 626.2700000000004 │                  19258 │
2. │ metaflow │       55190 │      2 │      1 │  83.41449537959775 │  200 │ 601.3600000000006 │                   3304 │
   └──────────┴─────────────┴────────┴────────┴────────────────────┴──────┴───────────────────┴────────────────────────┘

2 rows in set. Elapsed: 0.043 sec. Processed 330.02 thousand rows, 4.93 MB (7.70 million rows/s., 114.91 MB/s.)
Peak memory usage: 64.96 MiB.
```

Run 2 (no fs-cache for core queries):

```
SELECT
    name,
    type,
    formatReadableSize(data_compressed_bytes),
    formatReadableSize(data_uncompressed_bytes)
FROM system.columns
WHERE `table` = 'transaction_canonical_embeddings'
ORDER BY data_compressed_bytes DESC

Query id: 66f910b5-5ba9-4225-aefb-bcca33dbd9de

    ┌─name───────────────────────────────────────┬─type─────────────────┬─formatReadableSize(data_compressed_bytes)─┬─formatReadableSize(data_uncompressed_bytes)─┐
 1. │ embedding_for_receipt_matching             │ Array(Float32)       │ 1.39 TiB                                  │ 1.57 TiB                                    │
 2. │ bfloat16_embedding_for_receipt_matching    │ Array(Float32)       │ 717.31 GiB                                │ 1.57 TiB                                    │
 3. │ embedding_for_accounting_matching          │ Array(Float32)       │ 510.42 GiB                                │ 606.47 GiB                                  │
 4. │ embedding_for_merchant_merging             │ Array(Float32)       │ 431.56 GiB                                │ 606.47 GiB                                  │
 5. │ bfloat16_embedding_for_accounting_matching │ Array(Float32)       │ 253.95 GiB                                │ 606.47 GiB                                  │ <- this one
 6. │ bfloat16_embedding_for_merchant_merging    │ Array(Float32)       │ 211.28 GiB                                │ 606.47 GiB                                  │
 7. │ prompt_for_accounting_matching             │ String               │ 9.79 GiB                                  │ 93.88 GiB                                   │
 8. │ prompt_for_receipt_matching                │ String               │ 9.09 GiB                                  │ 94.20 GiB                                   │
 9. │ prompt_for_merchant_merging                │ String               │ 8.60 GiB                                  │ 73.48 GiB                                   │
10. │ card_acceptor                              │ String               │ 8.12 GiB                                  │ 61.48 GiB                                   │
11. │ uuid                                       │ UUID                 │ 6.29 GiB                                  │ 6.28 GiB                                    │
12. │ accounting_tracking_category_selections    │ String               │ 4.99 GiB                                  │ 184.36 GiB                                  │
13. │ merchant_domain                            │ String               │ 2.25 GiB                                  │ 12.33 GiB                                   │
14. │ memo                                       │ String               │ 2.13 GiB                                  │ 5.66 GiB                                    │
15. │ user_transaction_time                      │ DateTime64(3, 'UTC') │ 1.40 GiB                                  │ 3.14 GiB                                    │
16. │ accounting_coding_id                       │ UInt32               │ 1.39 GiB                                  │ 1.57 GiB                                    │
17. │ id                                         │ UInt32               │ 1.38 GiB                                  │ 1.57 GiB                                    │
18. │ merchant_name                              │ String               │ 1.28 GiB                                  │ 4.69 GiB                                    │
19. │ original_amount                            │ Decimal(18, 4)       │ 1.10 GiB                                  │ 3.14 GiB                                    │
20. │ amount                                     │ Decimal(18, 4)       │ 1.08 GiB                                  │ 3.14 GiB                                    │
21. │ version                                    │ DateTime64(3, 'UTC') │ 1.07 GiB                                  │ 3.14 GiB                                    │
22. │ mcc_detailed                               │ String               │ 895.88 MiB                                │ 10.89 GiB                                   │
23. │ payee_id                                   │ UInt32               │ 845.17 MiB                                │ 1.57 GiB                                    │
24. │ spend_allocation_display_name              │ String               │ 796.80 MiB                                │ 6.97 GiB                                    │
25. │ merchant_city                              │ String               │ 681.96 MiB                                │ 3.78 GiB                                    │
26. │ merchant_id                                │ UInt32               │ 669.16 MiB                                │ 1.57 GiB                                    │
27. │ spend_allocation_id                        │ UInt32               │ 575.80 MiB                                │ 1.57 GiB                                    │
28. │ sk_category_name                           │ String               │ 529.57 MiB                                │ 6.22 GiB                                    │
29. │ card_last_four                             │ String               │ 499.29 MiB                                │ 1.96 GiB                                    │
30. │ mcc                                        │ String               │ 461.64 MiB                                │ 1.96 GiB                                    │
31. │ user_id                                    │ UInt32               │ 460.00 MiB                                │ 1.57 GiB                                    │
32. │ department_name                            │ String               │ 365.57 MiB                                │ 4.86 GiB                                    │
33. │ sk_category_id                             │ UInt32               │ 283.26 MiB                                │ 1.57 GiB                                    │
34. │ merchant_state                             │ String               │ 272.87 MiB                                │ 1.12 GiB                                    │
35. │ location_name                              │ String               │ 226.13 MiB                                │ 4.16 GiB                                    │
36. │ department_id                              │ UInt32               │ 223.28 MiB                                │ 1.57 GiB                                    │
37. │ location_id                                │ UInt32               │ 142.25 MiB                                │ 1.57 GiB                                    │
38. │ card_acceptor_name_signature               │ String               │ 60.52 MiB                                 │ 114.49 MiB                                  │
39. │ sync_ready_status                          │ Bool                 │ 38.54 MiB                                 │ 402.22 MiB                                  │
40. │ original_currency                          │ String               │ 31.52 MiB                                 │ 1.57 GiB                                    │
41. │ trip_name                                  │ String               │ 30.24 MiB                                 │ 308.53 MiB                                  │
42. │ trip_id                                    │ UInt32               │ 16.35 MiB                                 │ 47.52 MiB                                   │
43. │ business_id                                │ UInt32               │ 4.63 MiB                                  │ 1.57 GiB                                    │
44. │ currency                                   │ String               │ 3.74 MiB                                  │ 1.57 GiB                                    │
45. │ deleted                                    │ UInt8                │ 263.38 KiB                                │ 5.61 MiB                                    │
46. │ accounting_is_gl_tc_coded                  │ Bool                 │ 0.00 B                                    │ 0.00 B                                      │
    └────────────────────────────────────────────┴──────────────────────┴───────────────────────────────────────────┴─────────────────────────────────────────────┘


SELECT
    tables.name AS `table`,
    stats.col,
    formatReadableSize(stats.size) AS size,
    stats.cache_hits
FROM
(
    SELECT
        splitByChar('/', local_path)[-1] AS col,
        splitByChar('/', local_path)[2] AS uuid,
        sum(size) AS size,
        sum(cache_hits) AS cache_hits
    FROM
    (
        SELECT
            cache_path,
            cache_hits,
            remote_path,
            local_path,
            file_segment_range_begin,
            file_segment_range_end,
            size,
            state
        FROM
        (
            SELECT
                arrayJoin(cache_paths) AS cache_path,
                local_path,
                remote_path
            FROM system.remote_data_paths
        ) AS data_paths
        INNER JOIN
        (
            SELECT *
            FROM system.filesystem_cache
            WHERE cache_name = 's3diskWithCache'
        ) AS caches ON data_paths.cache_path = caches.cache_path
    )
    GROUP BY
        uuid,
        col
    ORDER BY size DESC
    LIMIT 100
) AS stats
INNER JOIN system.tables AS tables ON toString(stats.uuid) = toString(tables.uuid)
FORMAT PrettyCompactMonoBlock

Query id: f4dc770c-f381-4a5f-ac28-b98f74541782

    ┌─table────────────────────────────┬─col──────────────────────────────────────────────────┬─size───────┬─cache_hits─┐
 1. │ transaction_canonical_embeddings │ bfloat16_embedding_for_accounting_matching.bin       │ 253.95 GiB │     392806 │
 2. │ transaction_canonical_embeddings │ accounting_tracking_category_selections.bin          │ 4.99 GiB   │     318211 │
 3. │ prod_bill_pay_categorization     │ vector_field.bin                                     │ 3.19 GiB   │       3599 │
 4. │ prod_bill_pay_categorization     │ data.bin                                             │ 1.45 GiB   │     122238 │
 5. │ transaction_canonical_embeddings │ user_transaction_time.bin                            │ 1.40 GiB   │     252955 │
 6. │ transaction_canonical_embeddings │ id.bin                                               │ 1.38 GiB   │     248614 │
 7. │ transaction_canonical_embeddings │ merchant_name.bin                                    │ 1.28 GiB   │     247515 │
 8. │ transaction_canonical_embeddings │ version.bin                                          │ 1.07 GiB   │     246244 │
 9. │ transaction_canonical_embeddings │ sync_ready_status.bin                                │ 38.54 MiB  │     280877 │
10. │ prod_bill_pay_categorization     │ non_gl_category_blob.bin                             │ 36.72 MiB  │       3045 │
11. │ prod_bill_pay_categorization     │ data.packed                                          │ 33.59 MiB  │      58656 │
12. │ transaction_canonical_embeddings │ data.packed                                          │ 16.25 MiB  │      95699 │
13. │ prod_bill_pay_categorization     │ amount.bin                                           │ 15.60 MiB  │       3166 │
14. │ prod_bill_pay_categorization     │ bill_line_item_log_entry_id.bin                      │ 14.14 MiB  │       3072 │
15. │ prod_bill_pay_categorization     │ tracking_category_option_remote_name.bin             │ 12.60 MiB  │       3086 │
16. │ prod_bill_pay_categorization     │ tracking_category_option_id.bin                      │ 5.30 MiB   │       3027 │
17. │ transaction_canonical_embeddings │ business_id.bin                                      │ 4.63 MiB   │     222840 │
18. │ transaction_canonical_embeddings │ bfloat16_embedding_for_accounting_matching.size0.bin │ 2.38 MiB   │     309200 │
19. │ prod_bill_pay_categorization     │ tracking_category_id.bin                             │ 90.16 KiB  │       3019 │
20. │ prod_bill_pay_categorization     │ business_id.bin                                      │ 89.34 KiB  │       2689 │
21. │ prod_bill_pay_categorization     │ accounting_provider_access_id.bin                    │ 86.60 KiB  │       2651 │
22. │ prod_bill_pay_categorization     │ vector_field.size0.bin                               │ 28.61 KiB  │       3025 │
    └──────────────────────────────────┴──────────────────────────────────────────────────────┴────────────┴────────────┘

22 rows in set. Elapsed: 50.880 sec. Processed 289.79 thousand rows, 99.10 MB (5.70 thousand rows/s., 1.95 MB/s.)
Peak memory usage: 87.77 MiB.
```

now fully in cache

```sql
SELECT
    formatReadableSize(sum(ProfileEvents['ReadBufferFromS3Bytes'])),
    countIf((ProfileEvents['ReadBufferFromS3Bytes']) = 0) AS no_reads,
    countIf((ProfileEvents['ReadBufferFromS3Bytes']) > 0)
FROM system.query_log
WHERE (type = 'QueryFinish') AND (user = 'metaflow') AND (event_time > '2025-02-12 12:10:00')

Query id: 2f504eac-8af9-4120-86a6-4bf452f17281

   ┌─formatReadableSize(sum(arrayElement(ProfileEvents, 'ReadBufferFromS3Bytes')))─┬─no_reads─┬─countIf(greater(arrayElement(ProfileEvents, 'ReadBufferFromS3Bytes'), 0))─┐
1. │ 117.00 MiB                                                                    │      513 │                                                                        15 │
   └───────────────────────────────────────────────────────────────────────────────┴──────────┴───────────────────────────────────────────────────────────────────────────┘

1 row in set. Elapsed: 0.012 sec. Processed 8.98 thousand rows, 1.76 MB (735.87 thousand rows/s., 144.57 MB/s.)
Peak memory usage: 19.47 MiB.
```

some queries still over 1s, any correlations? read_rows?

```sql
SELECT
    intDiv(query_duration_ms, 100) * 100 AS duration_bucket_ms,
    count() AS num,
    round(avg(read_rows)) AS avg_read_rows,
    round(avg(ProfileEvents['ReadBufferFromS3Bytes'])) AS bytes_s3
FROM system.query_log
WHERE (event_time > '2025-02-12 12:10:00') AND (user = 'metaflow') AND (type = 'QueryFinish')
GROUP BY duration_bucket_ms
ORDER BY duration_bucket_ms ASC

Query id: dac70a2f-ce62-463f-858e-77f923343354

    ┌─duration_bucket_ms─┬──num─┬─avg_read_rows─┬─bytes_s3─┐
 1. │                  0 │ 2795 │         40768 │     3752 │
 2. │                100 │  807 │         57829 │   194903 │
 3. │                200 │  388 │         71484 │   351327 │
 4. │                300 │  140 │        113548 │   464369 │
 5. │                400 │   49 │        183940 │  1604963 │
 6. │                500 │   23 │        295246 │   775034 │
 7. │                600 │   15 │        620939 │   419430 │
 8. │                700 │    4 │        744808 │        0 │
 9. │                800 │    2 │        571640 │  7340032 │
10. │                900 │    5 │       1249905 │        0 │
11. │               1000 │    2 │       1453921 │        0 │
12. │               1100 │    3 │        865961 │ 11534336 │
13. │               1200 │    1 │       1643616 │        0 │
    └────────────────────┴──────┴───────────────┴──────────┘

13 rows in set. Elapsed: 0.037 sec. Processed 43.73 thousand rows, 12.67 MB (1.19 million rows/s., 345.27 MB/s.)
Peak memory usage: 39.99 MiB.
```

We're still getting s3 reads for metaflow queries. Lets fully populate the cache for all accessed columns.

Figurte out all used columns
```sql

SELECT
    arrayJoin(tables) AS tables,
    arrayMap(col -> (splitByChar('.', col)[3]), columns) AS columns,
    count() AS c
FROM system.query_log
WHERE (event_time > '2025-02-12 12:10:00') AND (user = 'metaflow') AND has(databases, 'applied_ai')
GROUP BY
    tables,
    columns
FORMAT PrettyCompactMonoBlock

Query id: 225e9539-867d-44b8-bc39-57eceaf020dc

   ┌─tables──────────────────────────────────────┬─columns──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┬────c─┐
1. │ applied_ai.transaction_canonical_embeddings │ ['accounting_is_gl_tc_coded','accounting_tracking_category_selections','bfloat16_embedding_for_accounting_matching','business_id','id','merchant_name','sync_ready_status','user_transaction_time','version']            │ 7172 │
2. │ applied_ai.prod_bill_pay_categorization     │ ['accounting_provider_access_id','amount','bill_line_item_log_entry_id','business_id','non_gl_category_blob','tracking_category_id','tracking_category_option_id','tracking_category_option_remote_name','vector_field'] │ 4062 │
3. │ applied_ai.transaction_canonical_embeddings │ ['accounting_tracking_category_selections','business_id']                                                                                                                                                                │  130 │
   └─────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴──────┘

3 rows in set. Elapsed: 0.022 sec. Processed 75.11 thousand rows, 2.80 MB (3.49 million rows/s., 129.96 MB/s.)
Peak memory usage: 62.66 MiB.
```


``sql
SELECT
    table,
    name,
    type,
    formatReadableSize(data_compressed_bytes),
    formatReadableSize(data_uncompressed_bytes)
FROM system.columns
WHERE ((`table` LIKE 'transaction_canonical_embeddings%') AND (name IN ['accounting_is_gl_tc_coded', 'accounting_tracking_category_selections', 'bfloat16_embedding_for_accounting_matching', 'business_id', 'id', 'merchant_name', 'sync_ready_status', 'user_transaction_time', 'version', 'accounting_tracking_category_selections', 'business_id'])) OR ((`table` = 'prod_bill_pay_categorization') AND (name IN ['accounting_provider_access_id', 'amount', 'bill_line_item_log_entry_id', 'business_id', 'non_gl_category_blob', 'tracking_category_id', 'tracking_category_option_id', 'tracking_category_option_remote_name', 'vector_field']))
ORDER BY table, data_compressed_bytes DESC

Query id: f36c53c8-fde7-4518-bdc1-882d36c49f27

    ┌─table────────────────────────────┬─name───────────────────────────────────────┬─type─────────────────┬─formatReadableSize(data_compressed_bytes)─┬─formatReadableSize(data_uncompressed_bytes)─┐
 1. │ prod_bill_pay_categorization     │ vector_field                               │ Array(Float32)       │ 5.60 GiB                                  │ 8.39 GiB                                    │
 2. │ prod_bill_pay_categorization     │ non_gl_category_blob                       │ String               │ 36.72 MiB                                 │ 2.66 GiB                                    │
 3. │ prod_bill_pay_categorization     │ amount                                     │ Float32              │ 15.60 MiB                                 │ 22.25 MiB                                   │
 4. │ prod_bill_pay_categorization     │ bill_line_item_log_entry_id                │ UInt64               │ 14.14 MiB                                 │ 44.51 MiB                                   │
 5. │ prod_bill_pay_categorization     │ tracking_category_option_remote_name       │ String               │ 12.60 MiB                                 │ 197.45 MiB                                  │
 6. │ prod_bill_pay_categorization     │ tracking_category_option_id                │ UInt64               │ 5.30 MiB                                  │ 44.51 MiB                                   │
 7. │ prod_bill_pay_categorization     │ tracking_category_id                       │ UInt64               │ 90.16 KiB                                 │ 44.51 MiB                                   │
 8. │ prod_bill_pay_categorization     │ business_id                                │ UInt64               │ 89.34 KiB                                 │ 44.51 MiB                                   │
 9. │ prod_bill_pay_categorization     │ accounting_provider_access_id              │ UInt64               │ 86.60 KiB                                 │ 44.51 MiB                                   │
10. │ transaction_canonical_embeddings │ bfloat16_embedding_for_accounting_matching │ Array(Float32)       │ 253.95 GiB                                │ 606.47 GiB                                  │
11. │ transaction_canonical_embeddings │ accounting_tracking_category_selections    │ String               │ 4.99 GiB                                  │ 184.36 GiB                                  │
12. │ transaction_canonical_embeddings │ user_transaction_time                      │ DateTime64(3, 'UTC') │ 1.40 GiB                                  │ 3.14 GiB                                    │
13. │ transaction_canonical_embeddings │ id                                         │ UInt32               │ 1.38 GiB                                  │ 1.57 GiB                                    │
14. │ transaction_canonical_embeddings │ merchant_name                              │ String               │ 1.28 GiB                                  │ 4.69 GiB                                    │
15. │ transaction_canonical_embeddings │ version                                    │ DateTime64(3, 'UTC') │ 1.07 GiB                                  │ 3.14 GiB                                    │
16. │ transaction_canonical_embeddings │ sync_ready_status                          │ Bool                 │ 38.54 MiB                                 │ 402.22 MiB                                  │
17. │ transaction_canonical_embeddings │ business_id                                │ UInt32               │ 4.63 MiB                                  │ 1.57 GiB                                    │
18. │ transaction_canonical_embeddings │ accounting_is_gl_tc_coded                  │ Bool                 │ 0.00 B                                    │ 0.00 B                                      │
    └──────────────────────────────────┴────────────────────────────────────────────┴──────────────────────┴───────────────────────────────────────────┴─────────────────────────────────────────────┘
18 rows in set. Elapsed: 0.003 sec.

```

Ensure cache population - on node

c-magenta-qd-44-server-04oe311-0 - 
c-magenta-qd-44-server-i14soiy-0 - 
c-magenta-qd-44-server-1lvhe31-0
```
SELECT
    vector_field,
    non_gl_category_blob,
    amount,
    bill_line_item_log_entry_id,
    tracking_category_option_remote_name,
    tracking_category_option_id,
    tracking_category_id,
    business_id,
    accounting_provider_access_id
FROM applied_ai.prod_bill_pay_categorization
FORMAT `Null`


SELECT
    bfloat16_embedding_for_accounting_matching,
    accounting_tracking_category_selections,
    user_transaction_time,
    id,
    merchant_name,
    version,
    sync_ready_status,
    business_id,
    accounting_is_gl_tc_coded
FROM applied_ai.transaction_canonical_embeddings
FORMAT `Null`
```


Check caches - on each node, check every column has been cached.

```sql

WITH
    target_columns AS (
        SELECT
            `table`,
            name,
            type,
            formatReadableSize(data_compressed_bytes) AS compressed_size,
            formatReadableSize(data_uncompressed_bytes) AS uncompressed_size
        FROM system.columns
        WHERE ((`table` = 'transaction_canonical_embeddings') AND (name IN ['accounting_is_gl_tc_coded', 'accounting_tracking_category_selections', 'bfloat16_embedding_for_accounting_matching', 'business_id', 'id', 'merchant_name', 'sync_ready_status', 'user_transaction_time', 'version', 'accounting_tracking_category_selections', 'business_id'])) OR ((`table` = 'prod_bill_pay_categorization') AND (name IN ['accounting_provider_access_id', 'amount', 'bill_line_item_log_entry_id', 'business_id', 'non_gl_category_blob', 'tracking_category_id', 'tracking_category_option_id', 'tracking_category_option_remote_name', 'vector_field']))
        ORDER BY
            `table` ASC,
            data_compressed_bytes DESC
    ),
    cached_columns AS (
        SELECT
            tables.name AS `table`,
            replaceOne(stats.col, '.bin', '') AS col,
            formatReadableSize(stats.size) AS cached_size,
            stats.cache_hits
        FROM
        (
            SELECT
                splitByChar('/', local_path)[-1] AS col,
                splitByChar('/', local_path)[2] AS uuid,
                sum(size) AS size,
                sum(cache_hits) AS cache_hits
            FROM
            (
                SELECT
                    cache_path,
                    cache_hits,
                    remote_path,
                    local_path,
                    file_segment_range_begin,
                    file_segment_range_end,
                    size,
                    state
                FROM
                (
                    SELECT
                        arrayJoin(cache_paths) AS cache_path,
                        local_path,
                        remote_path
                    FROM system.remote_data_paths
                ) AS data_paths
                INNER JOIN
                (
                    SELECT *
                    FROM system.filesystem_cache
                    WHERE cache_name = 's3diskWithCache'
                ) AS caches ON data_paths.cache_path = caches.cache_path
            )
            GROUP BY
                uuid,
                col
            ORDER BY size DESC
            LIMIT 100
        ) AS stats
        INNER JOIN system.tables AS tables ON toString(stats.uuid) = toString(tables.uuid)
    )
SELECT
    target_columns.`table`,
    target_columns.name AS column_name,
    target_columns.type,
    target_columns.compressed_size,
    target_columns.uncompressed_size,
    cached_columns.cached_size,
    cached_columns.cache_hits
FROM target_columns
INNER JOIN cached_columns ON (target_columns.`table` = cached_columns.`table`) AND (target_columns.name = cached_columns.col)
ORDER BY
    target_columns.`table` ASC,
    target_columns.compressed_size DESC


    ┌─table────────────────────────────┬─column_name────────────────────────────────┬─type─────────────────┬─compressed_size─┬─uncompressed_size─┬─cached_size─┬─cache_hits─┐
 1. │ prod_bill_pay_categorization     │ vector_field                               │ Array(Float32)       │ 5.60 GiB        │ 8.39 GiB          │ 5.60 GiB    │        295 │
 2. │ prod_bill_pay_categorization     │ tracking_category_option_id                │ UInt64               │ 5.30 MiB        │ 44.51 MiB         │ 5.30 MiB    │         97 │
 3. │ prod_bill_pay_categorization     │ non_gl_category_blob                       │ String               │ 36.72 MiB       │ 2.66 GiB          │ 36.72 MiB   │        107 │
 4. │ prod_bill_pay_categorization     │ amount                                     │ Float32              │ 15.60 MiB       │ 22.25 MiB         │ 15.60 MiB   │        102 │
 5. │ prod_bill_pay_categorization     │ bill_line_item_log_entry_id                │ UInt64               │ 14.14 MiB       │ 44.51 MiB         │ 14.14 MiB   │        103 │
 6. │ prod_bill_pay_categorization     │ tracking_category_option_remote_name       │ String               │ 12.60 MiB       │ 197.45 MiB        │ 12.60 MiB   │        102 │
 7. │ transaction_canonical_embeddings │ accounting_tracking_category_selections    │ String               │ 4.99 GiB        │ 184.36 GiB        │ 4.99 GiB    │      55321 │
 8. │ transaction_canonical_embeddings │ business_id                                │ UInt32               │ 4.63 MiB        │ 1.57 GiB          │ 4.63 MiB    │      50045 │
 9. │ transaction_canonical_embeddings │ sync_ready_status                          │ Bool                 │ 38.54 MiB       │ 402.22 MiB        │ 38.54 MiB   │      12900 │
10. │ transaction_canonical_embeddings │ bfloat16_embedding_for_accounting_matching │ Array(Float32)       │ 253.95 GiB      │ 606.47 GiB        │ 253.95 GiB  │      81232 │
11. │ transaction_canonical_embeddings │ user_transaction_time                      │ DateTime64(3, 'UTC') │ 1.40 GiB        │ 3.14 GiB          │ 1.40 GiB    │      54627 │
12. │ transaction_canonical_embeddings │ id                                         │ UInt32               │ 1.38 GiB        │ 1.57 GiB          │ 1.38 GiB    │      50307 │
13. │ transaction_canonical_embeddings │ merchant_name                              │ String               │ 1.28 GiB        │ 4.69 GiB          │ 1.28 GiB    │      54621 │
14. │ transaction_canonical_embeddings │ version                                    │ DateTime64(3, 'UTC') │ 1.07 GiB        │ 3.14 GiB          │ 1.07 GiB    │      54565 │
    └──────────────────────────────────┴────────────────────────────────────────────┴──────────────────────┴─────────────────┴───────────────────┴─────────────┴────────────┘


```

Missed coluimns are small!! checked each node.



Better but still spikes e.g.

```sql
    SELECT
        merchant_name,
        id,
        accounting_tracking_category_selections,
        sync_ready_status,
        round(cosineDistance(bfloat16_embedding_for_accounting_matching, [0.056100827, -0.02062262, -0.050260793, 0.07380343, -0.005762471, 0.029930174, 0.0032348314, -0.041829243, -0.086724505, 0.08862252, -0.0007796217, -0.0108770635, -0.038653724, -0.062853366, 0.06004285, 0.010010183, 0.055881824, -0.049129285, -0.02936442, -0.011524942, 0.042522747, -0.067488894, -0.06380237, 0.022794383, 0.0013493672, -0.08891452, 0.040186733, 0.07358443, -0.03241219, -0.022940384, -0.114537664, 0.06022535, 0.0012832106, -0.08971752, 0.016753597, 0.061721858, -0.014919462, 0.030313427, 0.019454613, 0.025258146, -0.03235744, 0.04463976, -0.04442076, -0.040296234, 0.030568928, 0.042376745, -0.009070302, 0.05369181, 0.03609871, -0.038653724, -0.028178165, -0.00471309, 0.042522747, -0.1204507, -0.0051830304, -0.01807673, 0.0030523303, -0.026134152, 0.09928058, 0.019673614, 0.06482438, 0.05307131, -0.081103474, 0.10022958, 0.02056787, 0.012848075, -0.17885104, 0.038982227, 0.060626853, -0.039894734, -0.014892086, 0.02943742, 0.00938968, -0.05679433, 0.009663431, -0.0127568245, -0.04832628, 0.040807236, 0.048837285, 0.0861405, 0.053947315, -0.068291895, -0.055699322, -0.052158803, 0.033160444, 0.055480324, -0.070883416, -0.0056894706, -0.039018728, 0.062853366, -0.09285654, 0.08431549, -0.03128068, 0.09344055, 0.019746615, 0.022995133, -0.05829084, -0.017574852, -0.0021341217, 0.030039676, 0.09037453, 0.14965087, -0.0062506613, 0.057670336, 0.015977968, -0.03644546, 0.01637947, 0.020476619, -0.010074059, -0.04285125, -0.08256348, 0.024345642, 0.054458316, 0.005840034, -0.050735295, 0.09460855, 0.040989738, -0.0076787323, 0.035697207, -0.05679433, 0.042449746, -0.08154147, 0.016698847, 0.07427793, -0.07059141, -0.023597388, 0.046610773, 7.92739e-05, -0.007459731, -0.024345642, -0.04285125, 0.06643039, 0.090082526, 0.051939804, -0.08869552, -0.049421288, -0.015010713, 0.045515765, -0.0053929063, -0.0036614276, -0.03748572, -0.017474476, 0.028196415, -0.043836754, 0.018660733, -0.007149479, -0.04314325, -0.038690224, -0.028324164, -0.1040256, 0.012820699, 0.0021124498, -0.053983815, 0.062232863, 0.05000529, 0.07048191, -0.030532427, -0.07099292, -0.04073424, -0.003857616, 0.07446043, -0.017182475, 0.020020366, 0.040186733, -0.010731063, -0.043946255, 0.007026291, 0.02237463, -0.0690219, -0.13256878, 0.006255224, 0.011826069, 0.023305386, 0.015612965, 0.089133516, 0.010283935, 0.0022744194, -0.03755872, -0.055954825, -0.054494817, 0.03097043, 0.06015235, -0.042303745, -0.021407375, -0.114683665, -0.060553852, -0.059239846, -0.08249048, 0.09365954, 0.016260844, 0.037084214, -0.0511003, -0.025495399, 0.029838923, 0.06044435, 0.055699322, -0.007122104, -0.006478788, 0.06683189, -0.020129867, 0.005329031, 0.01108694, -0.027849661, 0.06380237, -0.061137855, -0.008039172, 0.029090669, 0.04423826, -0.045187265, -0.009864182, -0.021735877, 0.07040891, 0.0035656146, -0.08336648, -0.01822273, 0.07340193, 0.03942023, 0.021078873, -0.07190542, -0.021389125, -0.013167452, -0.0061548483, -0.006309974, -0.1023466, 0.047632776, -0.034894202, -0.042011745, 0.015038088, 0.017145975, 0.0103386855, 0.06186786, -0.01538484, -0.022903884, 0.10183559, 0.006583726, -0.04263225, -0.035678957, 0.014910337, 0.0510638, 0.017127724, 0.10942764, 0.073146425, -0.11607067, 0.03266769, 0.04828978, -0.07128491, -0.01899836, -0.0016892755, -0.07570144, -0.0070582284, 0.0136510795, -0.02761241, -0.0150837125, -0.07227042, 0.004528308, 0.021297874, -0.0038781476, 0.01814973, 0.022027878, 0.14140183, 0.042084746, -0.035751957, -0.098623574, 0.11847969, -0.012683824, -0.002783141, -0.04325275, 0.04839928, 0.008490862, 0.012382697, 0.035751957, 0.0065016, 0.034164198, 0.016406845, -0.008600363, -0.04153724, -0.062159862, 0.03633596, 0.055918325, 0.039274227, 0.011853444, -0.09263754, -0.042230748, -0.042194247, -0.034200698, -0.04485876, 0.03949323, 0.06405787, 0.04285125, -0.02062262, 0.054567818, -0.01742885, -0.0257509, 0.014399334, 0.030459428, 0.012793325, -0.041865744, -0.040661238, -0.009284741, 0.08176047, -0.03905523, 0.059057344, -0.121107705, -0.15213288, -0.06420387, -0.045406263, -0.06372937, -0.016707972, -0.019199112, 0.062269364, -0.03755872, 0.0017291976, -0.008454362, 0.0037914596, 0.028397165, -0.014490584, 0.008039172, -0.0062506613, 0.021535125, -0.052195303, 0.06540838, 0.007614857, -0.0048545282, 0.08256348, -0.060772855, -0.014618335, 0.033361193, 0.01905311, 0.021188373, 0.022995133, -0.008007234, -0.01883411, -0.028853418, 0.09030153, 0.013304328, 0.07540944, 0.009845932, -0.028214665, -0.019819615, -0.047340777, 0.0021934346, 0.05354581, 0.026134152, -0.069788404, 0.10249259, -0.050479792, -0.07672345, -0.011689193, -0.010858813, -0.004660621, -0.054056816, -0.0348577, -0.00202234, 0.11161765, -0.015485215, -0.0037891783, 0.020695621, 0.057779837, 0.001997246, 0.045114264, 0.027794912, 0.0041633053, -0.018423483, 0.08416949, 0.04157374, 0.034948952, -0.044019256, 0.047012273, -0.0122184465, 0.057743337, 0.024820145, 0.0028789542, 0.0051237172, -0.008130422, -0.030386427, 0.06712389, -0.06679539, 0.001845542, 0.059349347, 0.01892536, -0.011351566, -0.11570568, -0.09504655, -0.031079931]),2) AS score,
        version
    FROM applied_ai.transaction_canonical_embeddings
    WHERE business_id = 36327
        AND id < 132413084
        AND score < 0.25
        AND score >= 0.0
        AND accounting_is_gl_tc_coded
        AND user_transaction_time BETWEEN now() - interval 16 months AND '2025-02-11 17:27:28'
        AND sync_ready_status = 1
    ORDER BY score ASC, user_transaction_time DESC
    LIMIT 180
    SETTINGS merge_tree_min_rows_for_concurrent_read_for_remote_filesystem = 0, merge_tree_min_bytes_for_concurrent_read_for_remote_filesystem = 0

180 rows in set. Elapsed: 1.035 sec. Processed 1.64 million rows, 5.39 GB (1.59 million rows/s., 5.20 GB/s.)
180 rows in set. Elapsed: 1.335 sec. Processed 1.64 million rows, 5.39 GB (1.23 million rows/s., 4.03 GB/s.)
180 rows in set. Elapsed: 1.106 sec. Processed 1.64 million rows, 5.39 GB (1.48 million rows/s., 4.87 GB/s.)
```






Establish:

1. benefit of bfloat16 type assumign current queries
2. assuming no core queries what does metaflow look like.

MAD

SELECT
    table,
    name,
    type,
    formatReadableSize(data_compressed_bytes),
    formatReadableSize(data_uncompressed_bytes)
FROM system.columns
WHERE ((`table` LIKE 'transaction_canonical_embeddings%') AND (name IN ['accounting_is_gl_tc_coded', 'accounting_tracking_category_selections', 'bfloat16_embedding_for_accounting_matching', 'business_id', 'id', 'merchant_name', 'sync_ready_status', 'user_transaction_time', 'version', 'accounting_tracking_category_selections', 'business_id'])) OR ((`table` = 'prod_bill_pay_categorization') AND (name IN ['accounting_provider_access_id', 'amount', 'bill_line_item_log_entry_id', 'business_id', 'non_gl_category_blob', 'tracking_category_id', 'tracking_category_option_id', 'tracking_category_option_remote_name', 'vector_field']))
ORDER BY name DESC





just bfloat16




SELECT
    bill_line_item_log_entry_id,
    accounting_provider_access_id,
    tracking_category_id
FROM
(
    SELECT
        cosineDistance([-0.05925672501325607, -0.007328613195568323, -0.03343433514237404, -0.028998976573348045, -0.03447398543357849, -0.025621898472309113, 0.050005991011857986, 0.09566589444875717, 0.023436451330780983, -0.07305347174406052, 0.04029015451669693, -0.0007856815354898572, 0.012327606789767742, 0.08239124715328217, -0.1047229990363121, -0.05405992269515991, -0.0004084142274223268, 0.045606475323438644, -0.06601358950138092, 0.02951762080192566, 0.024141903966665268, 0.07151874899864197, -0.0034442702308297157, 0.04186546802520752, -0.04248358681797981, 0.0649588331580162, 0.012840298935770988, -0.08486543595790863, 0.03920353949069977, -0.060652296990156174, 0.00026989090838469565, 0.05160212516784668, 0.08602891117334366, -0.047415267676115036, 0.039253395050764084, -0.004316887352615595, -0.025167500600218773, -0.004379072226583958, -0.013157941401004791, 0.06704174727201462, 0.07709573954343796, -0.039580173790454865, -0.0006171888089738786, 0.007883409969508648, -0.01381806842982769, -0.021925995126366615, -0.04331974312663078, -0.03656516596674919, 0.07129234075546265, 0.1265963613986969, -0.012714621610939503, -0.058627136051654816, -0.08719225972890854, 0.01449731644243002, 0.03005640208721161, -0.030547449365258217, -0.10461273044347763, -0.02568083442747593, -0.04114007204771042, -0.0015027716290205717, -0.06734662503004074, 0.04455189034342766, -0.06553271412849426, 0.03430608659982681, -0.04507528617978096, -0.007593076676130295, 0.004241414368152618, -0.04049547761678696, -0.009689479134976864, -0.016719600185751915, 0.009154926985502243, 0.013823608867824078, 0.045951925218105316, -0.05565803870558739, -0.045292288064956665, 0.040254734456539154, 0.07424329221248627, -0.10299849510192871, 0.09536787867546082, 0.03400926664471626, -0.0210637915879488, 0.06088612228631973, 0.0064942240715026855, 0.10828810185194016, 0.0024564622435718775, 0.04954240471124649, 0.06305491179227829, 0.07148591428995132, 0.08512204885482788, 0.036259859800338745, 0.0343850739300251, 0.051031578332185745, -0.046576984226703644, -0.04217178747057915, 0.011489220894873142, 0.06863085180521011, -0.0300701055675745, -0.03593190386891365, -0.06680131703615189, 0.030509086325764656, -0.011062277480959892, -0.00434111338108778, 0.021667739376425743, -0.02467278391122818, -0.07899359613656998, -0.05148470029234886, -0.004563509486615658, 0.025583745911717415, -0.028627285733819008, 0.056595329195261, 0.017307881265878677, -0.006355129648000002, -0.04676710441708565, -0.04690387472510338, -0.01925414614379406, 0.05741097033023834, 0.0028085000813007355, -0.08581392467021942, 0.037682294845581055, -0.048888612538576126, -0.0027585707139223814, -0.04264527186751366, -0.022575851529836655, 0.022581379860639572, -0.054180219769477844, 0.027330419048666954, 0.04708249494433403, 3.236131172367957e-33, -0.07603535056114197, -0.034321364015340805, -0.009620847180485725, 0.023024434223771095, -0.048128891736269, 0.07243219763040543, -0.008941244333982468, -0.017974765971302986, -0.06585477292537689, -0.03940068557858467, -0.09568580985069275, 0.07315364480018616, -0.05543482303619385, 0.0975019708275795, -0.0670018270611763, -0.08343655616044998, 0.042359355837106705, 0.036221135407686234, 0.06374023109674454, -0.0002374387695454061, -0.023069897666573524, 0.013086975552141666, -0.009474622085690498, 0.053041305392980576, 0.007230912335216999, 0.07120070606470108, -0.0427008792757988, -0.039107780903577805, 0.06914844363927841, 0.002285799477249384, 0.05523305758833885, -0.044677719473838806, 0.01856832206249237, 0.0024432565551251173, -0.06982340663671494, 0.03776310011744499, -0.0811968669295311, -0.06619849801063538, 0.010583090595901012, 0.05002850294113159, 0.08513128012418747, 0.09897500276565552, 0.026355409994721413, 0.0395045168697834, 0.009537463076412678, -0.03564343601465225, -0.07317307591438293, -0.012982161715626717, 0.012592700310051441, 0.029199868440628052, -0.016670143231749535, 0.09763220697641373, -0.022204678505659103, -0.04906356334686279, -0.0769428163766861, -0.00723216962069273, -0.047423724085092545, 0.07176321744918823, -0.0034935176372528076, 0.04260262846946716, -0.00956612266600132, 0.12153974920511246, 0.07505587488412857, 0.05162588134407997, 0.08933751285076141, -0.04406949132680893, -0.06321850419044495, -0.06410196423530579, -0.06474293768405914, 0.01962781511247158, -0.03301142528653145, 0.02559078298509121, 0.05539507046341896, -0.03398938849568367, 0.033576443791389465, -0.007522569969296455, 0.023638838902115822, 0.018648754805326462, 0.037484463304281235, -0.07305973768234253, -0.06667104363441467, -0.015286147594451904, -0.01769195683300495, 0.12775425612926483, -0.042207472026348114, -0.014265226200222969, 0.04010177031159401, 0.008473465219140053, -0.04671027511358261, 0.009503072127699852, -0.030188338831067085, -0.043236471712589264, -0.03958187252283096, -0.054755181074142456, -0.02913629077374935, -4.013422771087364e-33, -0.013074617832899094, -0.021920926868915558, 0.02857823856174946, 0.03864191100001335, 0.018067017197608948, 0.06181540712714195, 0.10235119611024857, -0.04167162626981735, 0.1070907786488533, 0.07514837384223938, 0.007868650369346142, 0.05439090356230736, -0.019555017352104187, 0.05998968333005905, -0.012676786631345749, 0.058405615389347076, -0.04672899842262268, 0.007605984341353178, -0.05440624803304672, -0.03378888592123985, -0.06930220872163773, 0.10522259026765823, 0.08941883593797684, 0.08612894266843796, 0.07614336162805557, -0.01993298903107643, 0.07398708909749985, -0.016613326966762543, -0.03737785667181015, -0.01658170484006405, -0.025078024715185165, 0.01978779025375843, -0.01724993623793125, 0.010440092533826828, -0.06949511915445328, 0.043404337018728256, 0.1306914985179901, -0.013794627971947193, -0.026412995532155037, -0.004485958721488714, -0.0020686218049377203, -0.004385516978800297, -0.034955449402332306, -0.01365027017891407, -0.03153702989220619, -0.037024371325969696, 0.05160164088010788, -0.030677856877446175, 0.09643755853176117, 0.00018141859618481249, -0.05546063557267189, 0.027189789339900017, -0.05804215371608734, 0.05753789469599724, -0.013539510779082775, 0.038080889731645584, 0.009965263307094574, 0.036829713732004166, -0.009800378233194351, -0.04210257902741432, -0.014432544820010662, 0.003636573441326618, -0.04177840054035187, -0.04678705707192421, 0.04986286535859108, 0.029684189707040787, 0.06830354034900665, -0.00532261049374938, -0.03337780386209488, -0.011145524680614471, 0.11070048809051514, 0.04680992290377617, 0.09148959070444107, -0.04443785548210144, -0.03001314215362072, -0.06290063261985779, 0.029339002445340157, -0.06322456151247025, 0.02400863915681839, -0.024253232404589653, 0.07701300084590912, -0.0639699175953865, -0.014111810363829136, 0.06424534320831299, 0.03317209333181381, -0.11087130755186081, 0.04896725341677666, 0.05474065989255905, -0.0012965456116944551, 0.06236421316862106, -0.05888132005929947, -0.026197895407676697, -0.07549843192100525, -0.02270105853676796, 0.03917825222015381, -2.7902945731739237e-8, 0.0017071000766009092, -0.034322649240493774, 0.008390805684030056, -0.018186641857028008, 0.06344696134328842, 0.07760246843099594, -0.031043868511915207, -0.030453786253929138, -0.04042268171906471, 0.055075906217098236, 0.059375256299972534, -0.03223508968949318, -0.04655458778142929, -0.04565078020095825, 0.0691893920302391, 0.04768836870789528, -0.0956111028790474, 0.04521994665265083, -0.035904958844184875, -0.12221125513315201, -0.09289229661226273, 0.06479572504758835, -0.0003427975461818278, -0.050116561353206635, -0.039751261472702026, -0.08214244246482849, 0.006908079143613577, 0.030504653230309486, 0.007356475573033094, -0.039532262831926346, 0.038786888122558594, 0.045378364622592926, 0.03561419993638992, -0.06678315252065659, 0.03214723616838455, -0.0032802207861095667, -0.018564099445939064, 0.08632314950227737, 0.039280347526073456, 0.04895761236548424, -0.0968606173992157, -0.07032699882984161, -0.004259353503584862, -0.03466533496975899, -0.009775021113455296, 0.020589102059602737, -0.061623621731996536, -0.06064121052622795, -0.023499585688114166, 0.008546222001314163, 0.00747707998380065, 0.03821723908185959, 0.02452176623046398, -0.06287506967782974, -0.1064760610461235, -0.007816134952008724, -0.02437313087284565, -0.10646505653858185, -0.050055522471666336, -0.05175933986902237, -0.0427057221531868, 0.01253465749323368, 0.05254722386598587, -0.0408957377076149], vector_field) AS score,
        accounting_provider_access_id,
        amount,
        bill_line_item_log_entry_id,
        business_id,
        non_gl_category_blob,
        tracking_category_id,
        tracking_category_option_id,
        tracking_category_option_remote_name
    FROM applied_ai.prod_bill_pay_categorization_v2
    WHERE business_id = 430340
    ORDER BY score ASC
    LIMIT 15
)


SELECT
        merchant_name,
        id,
        accounting_tracking_category_selections,
        sync_ready_status,
        round(cosineDistance(bfloat16_embedding_for_accounting_matching, [-0.045030937, -0.023564918, 0.046595573, -0.026656026, -0.016190149, -0.003580055, 0.039688285, -0.0048942524, 0.03915402, 0.022152932, 0.022133851, -0.05228168, 0.06708846, 0.043351818, -0.07166788, 0.041329242, -0.06941634, 0.035108868, 0.018184103, -0.099144384, 0.049343225, 0.049877487, -0.053731833, 0.015484155, -0.04613763, 0.022668116, 0.05827309, 0.0011365064, 0.067966186, -0.028316064, -0.047931235, -0.03075842, -0.0660581, 0.07788826, -0.057128232, -0.10677675, 0.081055686, -0.069378175, 0.0028502103, 0.022210175, 0.052396167, -0.015684504, -0.0048346245, 0.019710576, 0.016256932, 0.07930025, 0.054304257, -0.057166394, 0.0084814625, 0.037188686, 0.030911068, 0.03682615, 0.055716246, -0.062432725, 0.006463657, -0.005457139, -0.017373165, 0.064531624, 0.027362019, -0.05537279, 0.08365069, 0.009950693, -0.008142777, -0.0031030322, 0.06892023, 0.049114253, 0.059265293, -0.032475702, -0.016190149, 0.075026125, -0.005962783, -0.07735399, 0.07453002, 0.004297974, 0.042054318, 0.04671006, 0.076819725, -0.04720616, -0.013528362, -0.024442641, -0.084108636, 0.045145422, -0.014587353, -0.027705476, 0.02129429, 0.005376045, -0.014854485, 0.016695792, 0.051938225, -0.04548888, -0.031197282, -0.042893875, -0.027762718, -0.04823653, 0.02423275, -0.03392585, 0.006549521, 0.06548567, -0.09280953, -0.027762718, 0.04255042, -0.06521854, 0.05880735, -0.016333256, 0.011696596, 0.033391584, -0.07853701, 0.008982336, -0.087924816, -0.00800444, 0.032990888, 0.06441714, -0.08555878, 0.07128626, 0.07010325, -0.066172585, -0.13784046, 0.03409758, -0.021656828, -0.077239506, -0.059646912, 0.028277902, -0.033658717, 0.025434848, -0.016962925, -0.017897889, -0.06560016, 0.035795778, -0.0153887505, -0.00056616624, 0.024824258, -0.02799169, 0.015837152, -0.06533302, 0.03243754, 0.105631895, -0.039421152, 0.014825864, 0.060371988, 0.0856351, -0.048503663, -0.005595476, 0.051785577, 0.023087896, -0.030185994, -0.03178879, 0.036692582, 0.011439003, 0.02421367, -0.025186796, 0.07769745, 0.007536958, -0.008925093, 0.023965618, 0.06586729, -0.07552223, -0.03980277, 0.0076419027, 0.00093973463, -0.1037238, 0.002060738, -0.024347236, -0.022839844, 0.00926378, 0.010771171, -0.047511455, -0.08487187, -0.019729657, -0.01095244, -0.0015026213, -0.07868966, 0.03514703, 0.032761917, -0.030033346, 0.01453011, 0.08220054, -0.07647627, -0.028144337, 0.024786096, -0.005709961, 0.049343225, 0.05808228, -0.0016397653, 0.049801163, 1.6500138e-05, -0.023984699, 0.05598338, 0.04022255, -0.038848724, 0.013957683, 0.037150525, 0.03705512, 0.01918585, 0.085864075, -0.071553394, -0.06968347, -0.008448071, -0.015035754, -0.0014477638, -0.018460777, -0.032323055, -0.03564313, -0.019863224, 0.088917024, 0.036902472, 0.007961508, -0.029346433, -0.010341851, -0.07975819, -0.0142725175, 0.06823332, -0.08502452, -0.033372503, -0.059265293, 0.15325783, 0.02801077, 0.050030135, -0.0008341934, -0.01452057, 0.030262318, -0.017163275, 0.013976764, 0.012087754, -0.037627548, -0.011219572, 0.0985338, -0.013394796, 0.079071276, 0.02129429, 0.015169321, -0.006196524, -0.03900137, -0.0048346245, -0.04533623, 0.06582913, -0.07636178, -0.09120673, -0.048961606, 0.10257895, -0.046061307, -0.13097134, -0.073194355, -0.050182782, -0.0109810615, 0.008414679, 0.031044634, 0.09922071, -0.059341617, -0.056250513, -0.0252822, -0.070408545, -0.041367404, 0.0051900065, 0.0069406796, -0.019710576, -0.06666868, 0.04632844, -0.04739697, -0.016590849, -0.03432655, 0.055830732, 0.06063912, 0.112501025, -0.011963728, -0.033296183, 0.06884391, 0.03900137, 0.0153887505, -0.10792161, -0.047473293, 0.034383792, -0.080063485, -0.0040332265, 0.012860531, 0.054037124, -0.09097776, 0.015474615, -0.057013746, -0.02297341, 0.05014462, -0.011439003, -0.04152005, 0.053197566, 0.060944412, 0.14760989, 0.014062628, 0.02106532, -0.0775448, -0.009230388, -0.030185994, 0.04567969, -0.05014462, -0.0023123673, 0.019338498, 0.010332311, 0.08128466, 0.18088698, 0.07037038, -0.03554773, -0.073003545, -0.102197334, -0.028277902, -0.024194589, -0.008810609, -0.018813774, -0.016037501, 0.042245127, 0.053808156, -0.028545035, 0.014387003, 0.0131753655, -0.011744298, 0.059875883, -0.023412272, 0.009421198, -0.038276296, 0.07830804, 0.08716158, -0.025816467, 0.014425165, -0.060715444, 0.12929222, 0.053922642, -0.02652246, -0.06262353, 0.05602154, -0.06819516, -0.033639636, -0.034250226, -0.05670845, -0.023965618, -0.0040165307, 0.0015264725, 0.13509281, 0.016438201, 0.0048584756, -0.046442926, 0.04106211, -0.014243896, -0.075636715, 0.032971807, -0.032303974, 0.08815379, 0.035108868, -0.1386037, 0.014167572, -0.05182374, -0.013738252, 0.042703066, 0.04785491, -0.030643934, 0.0492669, 0.022801682, 0.027056724, 0.019939547, 0.0061869835, -0.053617347, -0.05350286, 0.027648233, -0.045030937, 0.030586692, -0.016829358, -0.024690693, 0.02335503, 0.014043547, -0.022572711, -0.018680207, 0.01181108, -0.09731262, -0.023946537, -0.020359326, 0.13967223, 0.03030048, -0.0072745956, 0.00025789038, 0.045756012, -0.063539416, 0.01158211, 0.00927332, 0.0025783074, -0.01307042, -0.0030243236, 0.03142625, -0.013709631]),2) AS score,
        version
    FROM applied_ai.transaction_canonical_embeddings_v2
    WHERE business_id = 94588
        AND id < 132402937
        AND score < 0.25
        AND score >= 0.0
        AND accounting_is_gl_tc_coded
        AND user_transaction_time BETWEEN now() - interval 16 months AND '2025-02-11 17:05:36'
        AND sync_ready_status = 1
    ORDER BY score ASC, user_transaction_time DESC
    LIMIT 180



1. final pressure? reducing? merge strategies, columns in different tables? different clusters? deduplicating xternal process.
2. partition?
3. 

25.1 


c-magenta-qd-44-server-1lvhe31-0
c-magenta-qd-44-server-04oe311-0
c-magenta-qd-44-server-i14soiy-0

21:10


ideas:

could hash `business_id` and replica aware routing, reduce node count

`cache_populated_by_fetch` and `ignore_cold_parts_seconds` (mark loads - marks prewarming)




1. apply no cache on core
2. cache prewarming settings - 

1. Guides for a story
2. reference in context of guides
3. Examples for functions , comprehensive on a single page.



SELECT
    vector_field,
    non_gl_category_blob,
    amount,
    bill_line_item_log_entry_id,
    tracking_category_option_remote_name,
    tracking_category_option_id,
    tracking_category_id,
    business_id,
    accounting_provider_access_id
FROM applied_ai.prod_bill_pay_categorization
FORMAT `Null`


SELECT
    bfloat16_embedding_for_accounting_matching,
    accounting_tracking_category_selections,
    user_transaction_time,
    id,
    merchant_name,
    version,
    sync_ready_status,
    business_id,
    accounting_is_gl_tc_coded
FROM applied_ai.transaction_canonical_embeddings
FORMAT `Null`

c-magenta-qd-44-server-28gf258-0
c-magenta-qd-44-server-i14soiy-0
c-magenta-qd-44-server-1lvhe31-0
WITH
    'applied_ai' AS db_name,
    'transaction_canonical_embeddings' AS table_name,
    (SELECT uuid FROM system.tables WHERE database = db_name and name = table_name) AS table_id,
    (SELECT min(event_time) FROM system.part_log WHERE table_uuid = table_id) AS start_time,
    (
        SELECT event_time
        FROM clusterAllReplicas(default, system.query_log)
        WHERE
            has(tables, db_name || '.' || table_name)
            AND length(tables) = 1
            AND is_initial_query
            AND query_kind = 'Insert'
            AND type = 'QueryFinish'
        ORDER BY event_time_microseconds DESC
        LIMIT 1
    ) AS insert_end_time
SELECT sum(CurrentMetric_Merge) AS merges
FROM clusterAllReplicas(default, system.metric_log)
WHERE event_time >= start_time AND event_time <= insert_end_time
SETTINGS skip_unavailable_shards = 1;




# Merges

## dev

```sql

SELECT count()
FROM applied_ai.transaction_canonical_embeddings_v2

Query id: 5c802f24-8b0b-4754-bfbb-40904b40309d

┌───count()─┐
│ 421760890 │
└───────────┘

1 row in set. Elapsed: 0.002 sec.


SELECT uniq(business_id, user_transaction_time, id)
FROM applied_ai.transaction_canonical_embeddings_v2

Query id: e6527e00-f91a-4891-b9ed-b26999847952

┌─uniq(business_id, user_transaction_time, id)─┐
│                                    131554964 │
└──────────────────────────────────────────────┘



SELECT formatReadableSize(sum(data_compressed_bytes))
FROM system.parts
WHERE (`table` = 'transaction_canonical_embeddings_v2') AND active

Query id: 20a14c33-2433-477e-b3c0-719cfbae83f7

┌─formatReadableSize(sum(data_compressed_bytes))─┐
│ 3.32 TiB                                       │
└────────────────────────────────────────────────┘

1 row in set. Elapsed: 0.003 sec.


SELECT
    name,
    modification_time,
    level,
    rows,
    formatReadableSize(data_compressed_bytes) AS compressed_bytes
FROM system.parts
WHERE (`table` = 'transaction_canonical_embeddings') AND active
ORDER BY data_compressed_bytes DESC

Query id: 034b1dde-f5c8-407a-b6f8-e598b43cfc70

┌─name──────────────┬───modification_time─┬─level─┬─────rows─┬─compressed_bytes─┐
│ all_2396_3262_4   │ 2025-02-12 22:17:59 │     4 │ 18917533 │ 147.74 GiB       │
│ all_18523_19302_4 │ 2025-02-13 00:38:43 │     4 │ 17019922 │ 139.69 GiB       │
│ all_8491_9155_4   │ 2025-02-13 00:32:04 │     4 │ 14545836 │ 118.68 GiB       │
│ all_5876_6540_4   │ 2025-02-13 03:22:05 │     4 │ 14572678 │ 117.68 GiB       │
│ all_13071_13733_4 │ 2025-02-13 03:43:15 │     4 │ 14521192 │ 117.48 GiB       │
│ all_9156_9803_4   │ 2025-02-13 00:55:14 │     4 │ 14170316 │ 117.00 GiB       │
│ all_9804_10465_4  │ 2025-02-13 01:40:05 │     4 │ 14445839 │ 116.77 GiB       │
│ all_16782_17430_4 │ 2025-02-13 01:18:05 │     4 │ 14218209 │ 115.97 GiB       │
│ all_7189_7839_4   │ 2025-02-12 23:45:59 │     4 │ 14232357 │ 115.95 GiB       │
│ all_4569_5218_4   │ 2025-02-13 00:33:11 │     4 │ 14207451 │ 115.74 GiB       │
│ all_3916_4568_4   │ 2025-02-12 23:45:52 │     4 │ 14303675 │ 115.70 GiB       │
│ all_15476_16133_4 │ 2025-02-13 00:14:15 │     4 │ 14267196 │ 115.60 GiB       │
│ all_17431_18080_4 │ 2025-02-13 01:39:41 │     4 │ 14202722 │ 115.32 GiB       │
│ all_1736_2395_4   │ 2025-02-15 06:06:48 │     4 │ 14382563 │ 115.21 GiB       │
│ all_11116_11767_4 │ 2025-02-13 02:21:21 │     4 │ 14307220 │ 115.17 GiB       │
│ all_16134_16781_4 │ 2025-02-13 00:38:45 │     4 │ 14170015 │ 114.90 GiB       │
│ all_5219_5875_4   │ 2025-02-13 01:19:13 │     4 │ 14319712 │ 114.70 GiB       │
│ all_7840_8490_4   │ 2025-02-13 00:07:23 │     4 │ 14196873 │ 114.67 GiB       │
│ all_10466_11115_4 │ 2025-02-13 02:00:13 │     4 │ 14239897 │ 114.47 GiB       │
│ all_11768_12420_4 │ 2025-02-13 02:42:46 │     4 │ 14274914 │ 114.36 GiB       │
│ all_14826_15475_4 │ 2025-02-12 23:52:34 │     4 │ 14229272 │ 114.25 GiB       │
│ all_1084_1735_4   │ 2025-02-13 05:07:13 │     4 │ 14247402 │ 114.03 GiB       │
│ all_435_1083_4    │ 2025-02-13 04:37:01 │     4 │ 14181554 │ 113.65 GiB       │
│ all_6541_7188_4   │ 2025-02-12 23:12:38 │     4 │ 14151267 │ 113.42 GiB       │
│ all_12421_13070_4 │ 2025-02-13 03:00:37 │     4 │ 14210170 │ 113.41 GiB       │
│ all_3263_3915_4   │ 2025-02-12 22:47:28 │     4 │ 14249016 │ 113.16 GiB       │
│ all_13734_14390_4 │ 2025-02-13 04:05:55 │     4 │ 14389852 │ 112.94 GiB       │
│ all_18300_18522_3 │ 2025-02-12 23:50:08 │     3 │  4873883 │ 38.95 GiB        │
│ all_14609_14825_3 │ 2025-02-12 23:11:40 │     3 │  4724107 │ 38.48 GiB        │
│ all_218_434_3     │ 2025-02-12 20:51:05 │     3 │  4730496 │ 38.46 GiB        │
│ all_0_217_3       │ 2025-02-12 20:48:42 │     3 │  4727388 │ 38.35 GiB        │
│ all_18081_18299_3 │ 2025-02-12 23:48:31 │     3 │  4778609 │ 38.23 GiB        │
│ all_14391_14608_3 │ 2025-02-12 23:09:41 │     3 │  4751754 │ 37.26 GiB        │
└───────────────────┴─────────────────────┴───────┴──────────┴──────────────────┘

33 rows in set. Elapsed: 0.003 sec.

```
## prod

```sql
SELECT count()
FROM applied_ai.transaction_canonical_embeddings

Query id: 870922cf-0db7-4ad6-82c3-36e0d6fd5161

   ┌───count()─┐
1. │ 424017464 │ -- 424.02 million
   └───────────┘

1 row in set. Elapsed: 0.002 sec.



SELECT uniq(business_id, user_transaction_time, id)
FROM applied_ai.transaction_canonical_embeddings

Query id: 004ef320-95f3-4d69-b9d1-d57befeb2fdc

   ┌─uniq(business_id, user_transaction_time, id)─┐
1. │                                    133633098 │ -- 133.63 million
   └──────────────────────────────────────────────┘

1 row in set. Elapsed: 1.249 sec. Processed 424.02 million rows, 6.78 GB (339.58 million rows/s., 5.43 GB/s.)
Peak memory usage: 239.01 MiB.




SELECT formatReadableSize(sum(data_compressed_bytes))
FROM system.parts
WHERE (`table` = 'transaction_canonical_embeddings') AND active

Query id: ecd15cd1-601f-4ff4-9ba1-e5981bcb3cce

   ┌─formatReadableSize(sum(data_compressed_bytes))─┐
1. │ 3.55 TiB                                       │
   └────────────────────────────────────────────────┘

1 row in set. Elapsed: 0.003 sec.


```
SELECT
    name,
    modification_time,
    level,
    rows,
    formatReadableSize(data_compressed_bytes) AS compressed_bytes
FROM system.parts
WHERE (`table` = 'transaction_canonical_embeddings') AND active
ORDER BY data_compressed_bytes DESC

Query id: 8ba7e344-2feb-440d-b63c-fd94b7091d23

    ┌─name───────────────────────────────┬───modification_time─┬─level─┬─────rows─┬─compressed_bytes─┐
 1. │ all_0_1792332_347_15813313         │ 2025-02-10 23:12:57 │   347 │ 93526176 │ 770.75 GiB       │
 2. │ all_13867948_13999295_19_15813313  │ 2025-02-10 23:11:35 │    19 │ 15782361 │ 138.05 GiB       │
 3. │ all_11319009_11362888_9_15813313   │ 2025-02-10 23:11:37 │     9 │ 16916434 │ 135.07 GiB       │
 4. │ all_14226649_14767501_341_15813313 │ 2025-02-10 23:11:35 │   341 │ 15312354 │ 134.85 GiB       │
 5. │ all_11025268_11292884_73_15813313  │ 2025-02-10 23:11:36 │    73 │ 15834138 │ 133.42 GiB       │
 6. │ all_10894577_11025267_50_15813313  │ 2025-02-10 23:11:35 │    50 │ 15247995 │ 129.42 GiB       │
 7. │ all_13740321_13795640_34_15813313  │ 2025-02-10 23:11:35 │    34 │ 14781783 │ 129.10 GiB       │
 8. │ all_14151784_14226648_18_15813313  │ 2025-02-10 23:11:34 │    18 │ 13463768 │ 118.49 GiB       │
 9. │ all_10849085_10894576_50_15813313  │ 2025-02-10 23:11:32 │    50 │ 12892522 │ 111.05 GiB       │
10. │ all_14052389_14119384_16_15813313  │ 2025-02-10 23:11:31 │    16 │ 11363371 │ 100.09 GiB       │
11. │ all_6203771_8428645_80_15813313    │ 2025-02-10 23:11:31 │    80 │ 10792655 │ 95.99 GiB        │
12. │ all_14767502_16361943_430_15813313 │ 2025-02-19 06:48:20 │   430 │ 10666791 │ 95.69 GiB        │
13. │ all_13643337_13677622_50_15813313  │ 2025-02-10 23:11:30 │    50 │ 10735748 │ 92.29 GiB        │
14. │ all_10735663_10783509_25_15813313  │ 2025-02-10 23:11:27 │    25 │  9602060 │ 84.63 GiB        │
15. │ all_13999296_14052388_13_15813313  │ 2025-02-10 23:11:29 │    13 │  9293221 │ 81.82 GiB        │
16. │ all_11292885_11319008_10_15813313  │ 2025-02-10 23:11:31 │    10 │  9815240 │ 78.70 GiB        │
17. │ all_12023727_13453521_110_15813313 │ 2025-02-10 23:11:27 │   110 │  8897375 │ 76.93 GiB        │
18. │ all_10674210_10735662_39_15813313  │ 2025-02-10 23:11:28 │    39 │  8211667 │ 71.92 GiB        │
19. │ all_13453522_13643336_73_15813313  │ 2025-02-10 23:11:27 │    73 │  8664752 │ 71.11 GiB        │
20. │ all_14119385_14151783_12_15813313  │ 2025-02-10 23:11:30 │    12 │  7638482 │ 67.53 GiB        │
21. │ all_10799949_10819694_9_15813313   │ 2025-02-10 23:11:26 │     9 │  7671439 │ 67.17 GiB        │
22. │ all_9891397_10674209_70_15813313   │ 2025-02-10 23:11:27 │    70 │  7391040 │ 65.74 GiB        │
23. │ all_13795641_13828938_16_15813313  │ 2025-02-10 23:11:27 │    16 │  7265840 │ 64.20 GiB        │
24. │ all_11362889_11391916_9_15813313   │ 2025-02-10 23:11:27 │     9 │  7692686 │ 63.27 GiB        │
25. │ all_5128862_6203770_70_15813313    │ 2025-02-10 23:11:27 │    70 │  7071424 │ 62.95 GiB        │
26. │ all_13828939_13867947_33_15813313  │ 2025-02-10 23:11:27 │    33 │  7046300 │ 62.24 GiB        │
27. │ all_10819695_10849084_88_15813313  │ 2025-02-10 23:11:25 │    88 │  6943770 │ 60.21 GiB        │
28. │ all_13711174_13740320_33_15813313  │ 2025-02-10 23:11:26 │    33 │  6798918 │ 59.38 GiB        │
29. │ all_11391917_12023726_153_15813313 │ 2025-02-10 23:11:25 │   153 │  6626268 │ 57.31 GiB        │
30. │ all_4021147_5128861_230_15813313   │ 2025-02-10 23:11:26 │   230 │  6306002 │ 55.86 GiB        │
31. │ all_2866351_4021146_228_15813313   │ 2025-02-10 23:11:26 │   228 │  6152039 │ 54.80 GiB        │
32. │ all_1792333_2866350_255_15813313   │ 2025-02-10 23:11:26 │   255 │  5836745 │ 51.47 GiB        │
33. │ all_9026001_9891396_82_15813313    │ 2025-02-10 23:11:26 │    82 │  5743377 │ 50.37 GiB        │
34. │ all_13677623_13711173_23_15813313  │ 2025-02-10 23:11:24 │    23 │  4948506 │ 43.55 GiB        │
35. │ all_8428646_9026000_68_15813313    │ 2025-02-10 23:11:24 │    68 │  4177165 │ 37.70 GiB        │
36. │ all_10790990_10799948_8_15813313   │ 2025-02-10 23:11:22 │     8 │  3780610 │ 33.72 GiB        │
37. │ all_10783510_10790989_9_15813313   │ 2025-02-10 23:11:21 │     9 │  2802139 │ 25.22 GiB        │
38. │ all_16361944_16368894_65           │ 2025-02-19 08:13:13 │    65 │   188318 │ 1.71 GiB         │
39. │ all_16368895_16377828_274          │ 2025-02-19 10:52:16 │   274 │    85137 │ 810.88 MiB       │
40. │ all_16377829_16379510_33           │ 2025-02-19 11:19:32 │    33 │    25070 │ 243.09 MiB       │
41. │ all_16379511_16381160_47           │ 2025-02-19 11:49:16 │    47 │    24037 │ 226.77 MiB       │
42. │ all_16381161_16381415_94           │ 2025-02-19 11:53:01 │    94 │      779 │ 7.56 MiB         │
43. │ all_16381417_16381417_0            │ 2025-02-19 11:53:02 │     0 │        3 │ 33.79 KiB        │
44. │ all_16381418_16381418_0            │ 2025-02-19 11:53:02 │     0 │        3 │ 33.75 KiB        │
45. │ all_16381416_16381416_0            │ 2025-02-19 11:53:01 │     0 │        2 │ 23.43 KiB        │
    └────────────────────────────────────┴─────────────────────┴───────┴──────────┴──────────────────┘

45 rows in set. Elapsed: 0.003 sec.



WITH
    'applied_ai' AS db_name,
    'transaction_canonical_embeddings' AS table_name,
    86400 AS interval_seconds,
    (SELECT uuid FROM system.tables WHERE database = db_name and name = table_name) AS table_id,
    (SELECT min(event_time) FROM merge('system', 'part_log*') WHERE table_uuid = table_id) AS start_time
SELECT
    toStartOfInterval(event_time, toIntervalSecond(interval_seconds)) AS t,
    dateDiff('second', toStartOfInterval(start_time, toIntervalSecond(interval_seconds)), t) AS seconds,
    max(value) as parts
FROM clusterAllReplicas(default, merge('system', 'asynchronous_metric_log*'))
WHERE event_time >= start_time
AND metric = 'MaxPartCountForPartition'
GROUP BY t
ORDER BY t DESC
SETTINGS skip_unavailable_shards = 1;


-- active parts over time
    ┌───────────────────t─┬─seconds─┬─parts─┐
 1. │ 2025-02-19 00:00:00 │ 2246400 │    61 │
 2. │ 2025-02-18 00:00:00 │ 2160000 │    59 │
 3. │ 2025-02-17 00:00:00 │ 2073600 │    58 │
 4. │ 2025-02-16 00:00:00 │ 1987200 │    61 │
 5. │ 2025-02-15 00:00:00 │ 1900800 │    59 │
 6. │ 2025-02-14 00:00:00 │ 1814400 │    60 │
 7. │ 2025-02-13 00:00:00 │ 1728000 │    59 │
 8. │ 2025-02-12 00:00:00 │ 1641600 │    59 │
 9. │ 2025-02-11 00:00:00 │ 1555200 │    59 │
10. │ 2025-02-10 00:00:00 │ 1468800 │    62 │
11. │ 2025-02-09 00:00:00 │ 1382400 │    61 │
12. │ 2025-02-08 00:00:00 │ 1296000 │    57 │
13. │ 2025-02-07 00:00:00 │ 1209600 │    63 │
14. │ 2025-02-06 00:00:00 │ 1123200 │    61 │
15. │ 2025-02-05 00:00:00 │ 1036800 │    59 │
16. │ 2025-02-04 00:00:00 │  950400 │    61 │
17. │ 2025-02-03 00:00:00 │  864000 │    59 │
18. │ 2025-02-02 00:00:00 │  777600 │    67 │
19. │ 2025-02-01 00:00:00 │  691200 │    66 │
20. │ 2025-01-31 00:00:00 │  604800 │    64 │
21. │ 2025-01-30 00:00:00 │  518400 │    57 │
22. │ 2025-01-29 00:00:00 │  432000 │    54 │
23. │ 2025-01-28 00:00:00 │  345600 │    62 │
24. │ 2025-01-27 00:00:00 │  259200 │    56 │
25. │ 2025-01-25 00:00:00 │   86400 │    53 │
26. │ 2025-01-24 00:00:00 │       0 │    54 │
    └─────────────────────┴─────────┴───────┘



WITH
    'applied_ai' AS db_name,
    'transaction_canonical_embeddings' AS table_name,
    86400 AS interval_seconds,
    (SELECT uuid FROM system.tables WHERE database = db_name and name = table_name) AS table_id,
    (SELECT min(event_time) FROM merge('system', 'part_log*') WHERE table_uuid = table_id) AS start_time,
    T1 AS (
        SELECT
            hostName() AS hostname,
            toStartOfInterval(event_time, toIntervalSecond(interval_seconds)) AS t,
            dateDiff('second', toStartOfInterval(start_time, toIntervalSecond(interval_seconds)), t) AS seconds,
            max(value) as parts
        FROM clusterAllReplicas(default, merge('system', 'asynchronous_metric_log*'))
        WHERE event_time >= start_time
        AND metric = 'MaxPartCountForPartition'
        GROUP BY t, hostname
        ORDER BY t DESC, hostname
        ),
    T2 AS (
        SELECT
            DENSE_RANK() OVER(ORDER BY hostname) AS host_id,
            t,
            seconds,
            parts
        FROM T1
        ORDER BY t DESC, host_id
        ),
    T3 AS (
        SELECT
            t,
            seconds,
            min(parts) as parts_min
        FROM T2
        GROUP BY t, seconds
        ORDER BY t DESC
    )
SELECT * FROM T3
SETTINGS skip_unavailable_shards = 1;

    ┌───────────────────t─┬─seconds─┬─parts_min─┐
 1. │ 2025-02-19 00:00:00 │ 2246400 │        61 │
 2. │ 2025-02-18 00:00:00 │ 2160000 │        58 │
 3. │ 2025-02-17 00:00:00 │ 2073600 │        58 │
 4. │ 2025-02-16 00:00:00 │ 1987200 │        61 │
 5. │ 2025-02-15 00:00:00 │ 1900800 │        58 │
 6. │ 2025-02-14 00:00:00 │ 1814400 │        60 │
 7. │ 2025-02-13 00:00:00 │ 1728000 │        58 │
 8. │ 2025-02-12 00:00:00 │ 1641600 │        58 │
 9. │ 2025-02-11 00:00:00 │ 1555200 │        59 │
10. │ 2025-02-10 00:00:00 │ 1468800 │        62 │
11. │ 2025-02-09 00:00:00 │ 1382400 │        60 │
12. │ 2025-02-08 00:00:00 │ 1296000 │        57 │
13. │ 2025-02-07 00:00:00 │ 1209600 │        63 │
14. │ 2025-02-06 00:00:00 │ 1123200 │        61 │
15. │ 2025-02-05 00:00:00 │ 1036800 │        59 │
16. │ 2025-02-04 00:00:00 │  950400 │        61 │
17. │ 2025-02-03 00:00:00 │  864000 │        59 │
18. │ 2025-02-02 00:00:00 │  777600 │        65 │
19. │ 2025-02-01 00:00:00 │  691200 │        66 │
20. │ 2025-01-31 00:00:00 │  604800 │        64 │
21. │ 2025-01-30 00:00:00 │  518400 │        57 │
22. │ 2025-01-29 00:00:00 │  432000 │        54 │
23. │ 2025-01-28 00:00:00 │  345600 │        62 │
24. │ 2025-01-27 00:00:00 │  259200 │        56 │
25. │ 2025-01-25 00:00:00 │   86400 │        53 │
26. │ 2025-01-24 00:00:00 │       0 │        54 │
    └─────────────────────┴─────────┴───────────┘



Duplicate by parts

SELECT
    uniqExact(business_id, user_transaction_time, id) AS uniq,
    count() AS c
FROM applied_ai.transaction_canonical_embeddings
WHERE _part = 'all_0_1792332_347_15813313'

Query id: 1df670d6-cbe8-41ba-a41b-d54b995a7604

   ┌─────uniq─┬────────c─┐
1. │ 93526176 │ 93526176 │
   └──────────┴──────────┘

1 row in set. Elapsed: 2.184 sec. Processed 93.53 million rows, 1.59 GB (42.82 million rows/s., 728.01 MB/s.)
Peak memory usage: 5.37 GiB.


so how many 


SELECT
    uniqExact(business_id, user_transaction_time, id) AS uniq,
    count() AS c
FROM applied_ai.transaction_canonical_embeddings

Query id: 5d8f3e6d-f5a7-4495-b696-2120aca149f7

   ┌──────uniq─┬─────────c─┐
1. │ 134316577 │ 424034503 │
   └───────────┴───────────┘

1 row in set. Elapsed: 10.178 sec. Processed 424.03 million rows, 6.78 GB (41.66 million rows/s., 666.58 MB/s.)
Peak memory usage: 17.17 GiB.


so 424034503-134316577=289717926 289.72m duplicates!

outside of this part?

SELECT
    uniqExact(business_id, user_transaction_time, id) AS uniq,
    count() AS c
FROM applied_ai.transaction_canonical_embeddings_v2

Query id: d7145689-0502-4f1c-9d64-c30a584b0afa

┌──────uniq─┬─────────c─┐
│ 132177074 │ 421760890 │
└───────────┴───────────┘

1 row in set. Elapsed: 8.019 sec. Processed 330.51 million rows, 5.62 GB (41.22 million rows/s., 700.66 MB/s.)
Peak memory usage: 17.16 GiB.




-- unique tows in large part
SELECT count()
FROM applied_ai.transaction_canonical_embeddings_v2
WHERE (_part = 'all_0_0_0_47') AND (cityHash64(business_id, user_transaction_time, id) NOT IN (
    SELECT cityHash64(business_id, user_transaction_time, id)
    FROM applied_ai.transaction_canonical_embeddings_v2
    WHERE _part != 'all_0_0_0_47'
))
┌─count()─┐
│       0 │
└─────────┘

1 row in set. Elapsed: 10.970 sec. Processed 421.76 million rows, 7.08 GB (38.45 million rows/s., 645.08 MB/s.)
Peak memory usage: 3.13 GiB.

-- what rows are in other parts that aren't in all_0_0_0_47
SELECT count(), uniqExact(business_id, user_transaction_time, id) AS uniq
FROM applied_ai.transaction_canonical_embeddings_v2
WHERE (_part != 'all_0_0_0_47') AND (cityHash64(business_id, user_transaction_time, id) NOT IN (
    SELECT cityHash64(business_id, user_transaction_time, id)
    FROM applied_ai.transaction_canonical_embeddings_v2
    WHERE _part = 'all_0_0_0_47'
))

┌───count()─┬─────uniq─┐
│ 132688447 │ 38650898 │
└───────────┴──────────┘

-- what rows are in other parts that are in all_0_0_0_47

SELECT count(), uniqExact(business_id, user_transaction_time, id) AS uniq
FROM applied_ai.transaction_canonical_embeddings_v2
WHERE (_part != 'all_0_0_0_47') AND (cityHash64(business_id, user_transaction_time, id) IN (
    SELECT cityHash64(business_id, user_transaction_time, id)
    FROM applied_ai.transaction_canonical_embeddings_v2
    WHERE _part = 'all_0_0_0_47'
))


┌───count()─┬─────uniq─┐
│ 195546267 │ 93526176 │
└───────────┴──────────┘


This massive part is basically redundant!


SELECT
    toStartOfMonth(user_transaction_time) AS month,
    count() AS c,
    uniqExact(business_id, user_transaction_time, id) AS uniq,
    round(c / uniq, 2) AS duplicate_ratio
FROM applied_ai.transaction_canonical_embeddings
GROUP BY month
ORDER BY month ASC

Query id: 586a408a-0cd1-4e13-af90-bc47cac4b89f

    ┌──────month─┬────────c─┬────uniq─┬─duplicate_ratio─┐
 1. │ 2019-05-01 │       27 │       9 │               3 │
 2. │ 2019-06-01 │      280 │      75 │            3.73 │
 3. │ 2019-07-01 │      470 │     130 │            3.62 │
 4. │ 2019-08-01 │      708 │     207 │            3.42 │
 5. │ 2019-09-01 │      997 │     300 │            3.32 │
 6. │ 2019-10-01 │     2970 │     949 │            3.13 │
 7. │ 2019-11-01 │     4792 │    1556 │            3.08 │
 8. │ 2019-12-01 │     6978 │    2263 │            3.08 │
 9. │ 2020-01-01 │    13059 │    4229 │            3.09 │
10. │ 2020-02-01 │    21591 │    7039 │            3.07 │
11. │ 2020-03-01 │    93220 │   30975 │            3.01 │
12. │ 2020-04-01 │    28047 │    9302 │            3.02 │
13. │ 2020-05-01 │    35231 │   11696 │            3.01 │
14. │ 2020-06-01 │    49060 │   16305 │            3.01 │
15. │ 2020-07-01 │    65679 │   21801 │            3.01 │
16. │ 2020-08-01 │    74474 │   24704 │            3.01 │
17. │ 2020-09-01 │    90826 │   30085 │            3.02 │
18. │ 2020-10-01 │   155001 │   51433 │            3.01 │
19. │ 2020-11-01 │   173227 │   57495 │            3.01 │
20. │ 2020-12-01 │   227333 │   75474 │            3.01 │
21. │ 2021-01-01 │   267430 │   88826 │            3.01 │
22. │ 2021-02-01 │   335621 │  111337 │            3.01 │
23. │ 2021-03-01 │   421917 │  139608 │            3.02 │
24. │ 2021-04-01 │   504536 │  166693 │            3.03 │
25. │ 2021-05-01 │   643042 │  210058 │            3.06 │
26. │ 2021-06-01 │   817487 │  270158 │            3.03 │
27. │ 2021-07-01 │  1068812 │  353645 │            3.02 │
28. │ 2021-08-01 │  1517899 │  502781 │            3.02 │
29. │ 2021-09-01 │  1611562 │  533290 │            3.02 │
30. │ 2021-10-01 │  1917105 │  634010 │            3.02 │
31. │ 2021-11-01 │  2273145 │  751618 │            3.02 │
32. │ 2021-12-01 │  2112081 │  697504 │            3.03 │
33. │ 2022-01-01 │  2117183 │  699189 │            3.03 │
34. │ 2022-02-01 │  2387239 │  788437 │            3.03 │
35. │ 2022-03-01 │  3073973 │ 1013356 │            3.03 │
36. │ 2022-04-01 │  3269810 │ 1077921 │            3.03 │
37. │ 2022-05-01 │  3719311 │ 1224100 │            3.04 │
38. │ 2022-06-01 │  3969845 │ 1306662 │            3.04 │
39. │ 2022-07-01 │  4486545 │ 1481988 │            3.03 │
40. │ 2022-08-01 │  5312273 │ 1753103 │            3.03 │
41. │ 2022-09-01 │  5551832 │ 1831192 │            3.03 │
42. │ 2022-10-01 │  5670809 │ 1869199 │            3.03 │
43. │ 2022-11-01 │  5514882 │ 1817629 │            3.03 │
44. │ 2022-12-01 │  5762495 │ 1899559 │            3.03 │
45. │ 2023-01-01 │  6851995 │ 2261124 │            3.03 │
46. │ 2023-02-01 │  6487110 │ 2137876 │            3.03 │
47. │ 2023-03-01 │  8078037 │ 2661640 │            3.03 │
48. │ 2023-04-01 │  7548691 │ 2487559 │            3.03 │
49. │ 2023-05-01 │  8446007 │ 2783600 │            3.03 │
50. │ 2023-06-01 │  8584985 │ 2825928 │            3.04 │
51. │ 2023-07-01 │  8494384 │ 2795613 │            3.04 │
52. │ 2023-08-01 │  9805506 │ 3227243 │            3.04 │
53. │ 2023-09-01 │ 10256441 │ 3374359 │            3.04 │
54. │ 2023-10-01 │ 11658863 │ 3832563 │            3.04 │
55. │ 2023-11-01 │ 11058448 │ 3629694 │            3.05 │
56. │ 2023-12-01 │ 11054560 │ 3631543 │            3.04 │
57. │ 2024-01-01 │ 12141842 │ 3983184 │            3.05 │
58. │ 2024-02-01 │ 12586613 │ 4124183 │            3.05 │
59. │ 2024-03-01 │ 13695748 │ 4483776 │            3.05 │
60. │ 2024-04-01 │ 14843538 │ 4849103 │            3.06 │
61. │ 2024-05-01 │ 16017592 │ 5226282 │            3.06 │
62. │ 2024-06-01 │ 16011397 │ 5190722 │            3.08 │
63. │ 2024-07-01 │ 17284121 │ 5303903 │            3.26 │
64. │ 2024-08-01 │ 23552417 │ 5793625 │            4.07 │
65. │ 2024-09-01 │ 25935244 │ 6397381 │            4.05 │
66. │ 2024-10-01 │ 26283590 │ 7164497 │            3.67 │
67. │ 2024-11-01 │ 26042274 │ 6384431 │            4.08 │
68. │ 2024-12-01 │ 22593348 │ 6456039 │             3.5 │
69. │ 2025-01-01 │ 18562446 │ 7212882 │            2.57 │
70. │ 2025-02-01 │  4795336 │ 4531667 │            1.06 │
    └──────month─┴────────c─┴────uniq─┴─duplicate_ratio─┘

70 rows in set. Elapsed: 48.186 sec. Processed 424.04 million rows, 6.78 GB (8.80 million rows/s., 140.80 MB/s.)
Peak memory usage: 28.12 GiB.



Without this part?

SELECT
    toStartOfMonth(user_transaction_time) AS month,
    count() AS c,
    uniqExact(business_id, user_transaction_time, id) AS uniq,
    round(c / uniq, 2) AS duplicate_ratio
FROM applied_ai.transaction_canonical_embeddings
WHERE _part != 'all_0_1792332_347_15813313'
GROUP BY month
ORDER BY month ASC

Query id: 6bbbd6e4-f02f-4776-8879-15edfa061845

    ┌──────month─┬────────c─┬────uniq─┬─duplicate_ratio─┐
 1. │ 2019-05-01 │       18 │       9 │               2 │
 2. │ 2019-06-01 │      205 │      75 │            2.73 │
 3. │ 2019-07-01 │      340 │     130 │            2.62 │
 4. │ 2019-08-01 │      501 │     207 │            2.42 │
 5. │ 2019-09-01 │      697 │     300 │            2.32 │
 6. │ 2019-10-01 │     2021 │     949 │            2.13 │
 7. │ 2019-11-01 │     3236 │    1556 │            2.08 │
 8. │ 2019-12-01 │     4715 │    2263 │            2.08 │
 9. │ 2020-01-01 │     8830 │    4229 │            2.09 │
10. │ 2020-02-01 │    14552 │    7039 │            2.07 │
11. │ 2020-03-01 │    62245 │   30975 │            2.01 │
12. │ 2020-04-01 │    18745 │    9302 │            2.02 │
13. │ 2020-05-01 │    23535 │   11696 │            2.01 │
14. │ 2020-06-01 │    32755 │   16305 │            2.01 │
15. │ 2020-07-01 │    43878 │   21801 │            2.01 │
16. │ 2020-08-01 │    49770 │   24704 │            2.01 │
17. │ 2020-09-01 │    60741 │   30085 │            2.02 │
18. │ 2020-10-01 │   103568 │   51433 │            2.01 │
19. │ 2020-11-01 │   115732 │   57495 │            2.01 │
20. │ 2020-12-01 │   151859 │   75474 │            2.01 │
21. │ 2021-01-01 │   178604 │   88826 │            2.01 │
22. │ 2021-02-01 │   224284 │  111337 │            2.01 │
23. │ 2021-03-01 │   282309 │  139608 │            2.02 │
24. │ 2021-04-01 │   337843 │  166693 │            2.03 │
25. │ 2021-05-01 │   432984 │  210058 │            2.06 │
26. │ 2021-06-01 │   547329 │  270158 │            2.03 │
27. │ 2021-07-01 │   715167 │  353645 │            2.02 │
28. │ 2021-08-01 │  1015118 │  502781 │            2.02 │
29. │ 2021-09-01 │  1078272 │  533290 │            2.02 │
30. │ 2021-10-01 │  1283095 │  634010 │            2.02 │
31. │ 2021-11-01 │  1521527 │  751618 │            2.02 │
32. │ 2021-12-01 │  1414577 │  697504 │            2.03 │
33. │ 2022-01-01 │  1417994 │  699189 │            2.03 │
34. │ 2022-02-01 │  1598802 │  788437 │            2.03 │
35. │ 2022-03-01 │  2060617 │ 1013356 │            2.03 │
36. │ 2022-04-01 │  2191889 │ 1077921 │            2.03 │
37. │ 2022-05-01 │  2495211 │ 1224100 │            2.04 │
38. │ 2022-06-01 │  2663183 │ 1306662 │            2.04 │
39. │ 2022-07-01 │  3004557 │ 1481988 │            2.03 │
40. │ 2022-08-01 │  3559170 │ 1753103 │            2.03 │
41. │ 2022-09-01 │  3720643 │ 1831192 │            2.03 │
42. │ 2022-10-01 │  3801610 │ 1869199 │            2.03 │
43. │ 2022-11-01 │  3697253 │ 1817629 │            2.03 │
44. │ 2022-12-01 │  3862936 │ 1899559 │            2.03 │
45. │ 2023-01-01 │  4590871 │ 2261124 │            2.03 │
46. │ 2023-02-01 │  4349235 │ 2137876 │            2.03 │
47. │ 2023-03-01 │  5416410 │ 2661640 │            2.03 │
48. │ 2023-04-01 │  5061133 │ 2487559 │            2.03 │
49. │ 2023-05-01 │  5662407 │ 2783600 │            2.03 │
50. │ 2023-06-01 │  5759058 │ 2825928 │            2.04 │
51. │ 2023-07-01 │  5698772 │ 2795613 │            2.04 │
52. │ 2023-08-01 │  6578263 │ 3227243 │            2.04 │
53. │ 2023-09-01 │  6882086 │ 3374359 │            2.04 │
54. │ 2023-10-01 │  7826305 │ 3832563 │            2.04 │
55. │ 2023-11-01 │  7428758 │ 3629694 │            2.05 │
56. │ 2023-12-01 │  7423023 │ 3631543 │            2.04 │
57. │ 2024-01-01 │  8158675 │ 3983184 │            2.05 │
58. │ 2024-02-01 │  8462477 │ 4124183 │            2.05 │
59. │ 2024-03-01 │  9211987 │ 4483776 │            2.05 │
60. │ 2024-04-01 │  9994448 │ 4849103 │            2.06 │
61. │ 2024-05-01 │ 10791355 │ 5226282 │            2.06 │
62. │ 2024-06-01 │ 10820745 │ 5190722 │            2.08 │
63. │ 2024-07-01 │ 11980610 │ 5303903 │            2.26 │
64. │ 2024-08-01 │ 20403388 │ 5793625 │            3.52 │
65. │ 2024-09-01 │ 25935250 │ 6397381 │            4.05 │
66. │ 2024-10-01 │ 26283590 │ 7164497 │            3.67 │
67. │ 2024-11-01 │ 26042274 │ 6384431 │            4.08 │
68. │ 2024-12-01 │ 22593368 │ 6456039 │             3.5 │
69. │ 2025-01-01 │ 18562580 │ 7212882 │            2.57 │
70. │ 2025-02-01 │  4796321 │ 4532008 │            1.06 │
    └──────month─┴────────c─┴────uniq─┴─duplicate_ratio─┘

70 rows in set. Elapsed: 37.172 sec. Processed 330.52 million rows, 5.62 GB (8.89 million rows/s., 151.15 MB/s.)
Peak memory usage: 24.76 GiB.

What changed on the 12th??

SELECT *
FROM clusterAllReplicas('all_groups.default', system, part_log)
WHERE (part_name = 'all_0_1792332_347_15813313') AND (table_uuid = '0cfd987c-6064-42f4-9a52-81087342a57b')
ORDER BY event_time ASC
FORMAT Vertical

Row 1:
──────
hostname:                c-caramel-ic-25-server-r3gpno6-0.c-caramel-ic-25-server-headless.ns-caramel-ic-25.svc.cluster.local
query_id:
event_type:              MutatePart
merge_reason:            NotAMerge
merge_algorithm:         Undecided
event_date:              2025-02-10
event_time:              2025-02-10 23:12:57
event_time_microseconds: 2025-02-10 23:12:57.249415
duration_ms:             100142
database:                applied_ai
table:                   transaction_canonical_embeddings
table_uuid:              0cfd987c-6064-42f4-9a52-81087342a57b
part_name:               all_0_1792332_347_15813313
partition_id:            all
partition:               tuple()
part_type:               Wide
part_storage_type:       Full
disk_name:               s3WithKeeperDisk
path_on_disk:            data/0cfd987c-6064-42f4-9a52-81087342a57b/all_0_1792332_347_15813313/
rows:                    93526176
size_in_bytes:           827615882428
merged_from:             ['all_0_1792332_347_3383084']
bytes_uncompressed:      1486814758426
read_rows:               93526176
read_bytes:              44817731662
peak_memory_usage:       19177090
error:                   0
exception:
ProfileEvents:           {'FileOpen':8,'ReadBufferFromFileDescriptorRead':107,'ReadBufferFromFileDescriptorReadBytes':14024704,'WriteBufferFromFileDescriptorWrite':18,'WriteBufferFromFileDescriptorWriteBytes':7448443,'ReadCompressedBytes':1059338677,'CompressedReadBufferBlocks':133856,'CompressedReadBufferBytes':44150986117,'OpenedFileCacheMisses':1,'IOBufferAllocs':18,'IOBufferAllocBytes':13274222,'FunctionExecute':565973,'CreatedReadBufferOrdinary':1,'DiskReadElapsedMicroseconds':9040,'DiskWriteElapsedMicroseconds':4607,'LocalThreadPoolJobs':1023,'ZooKeeperTransactions':19,'ZooKeeperList':1,'ZooKeeperRemove':1,'ZooKeeperExists':9,'ZooKeeperMulti':8,'MutationTotalParts':1,'MutatedRows':93526176,'MutatedUncompressedBytes':44817731662,'MutationTotalMilliseconds':100142,'MutationExecuteMilliseconds':99895,'MutationSomePartColumns':1,'ContextLock':40,'RWLockAcquiredReadLocks':1,'PartsLockHoldMicroseconds':183,'QueryProfilerRuns':95,'WriteBufferFromS3Bytes':7448443,'CachedReadBufferReadFromCacheHits':107,'CachedReadBufferReadFromCacheMicroseconds':9136,'CachedReadBufferReadFromCacheBytes':14024704,'CachedReadBufferCreateBufferMicroseconds':47,'CachedWriteBufferCacheWriteBytes':7448443,'CachedWriteBufferCacheWriteMicroseconds':6300,'FilesystemCacheEvictedBytes':2804600,'FilesystemCacheEvictedFileSegments':3,'FilesystemCacheEvictionTries':1,'FilesystemCacheReserveMicroseconds':1274,'FilesystemCacheEvictMicroseconds':496,'FilesystemCacheGetMicroseconds':13,'FileSegmentCompleteMicroseconds':75,'FileSegmentWriteMicroseconds':4843,'FileSegmentUseMicroseconds':1,'FileSegmentHolderCompleteMicroseconds':1,'FilesystemCacheHoldFileSegments':15,'FilesystemCacheUnusedHoldFileSegments':8,'RemoteFSPrefetches':1123,'RemoteFSPrefetchedReads':1123,'RemoteFSPrefetchedBytes':1059338677,'RemoteFSBuffers':1,'ThreadpoolReaderTaskMicroseconds':9696,'ThreadpoolReaderReadBytes':14024704,'ThreadpoolReaderSubmit':20519,'ThreadpoolReaderSubmitReadSynchronously':107,'ThreadpoolReaderSubmitReadSynchronouslyBytes':14024704,'ThreadpoolReaderSubmitReadSynchronouslyMicroseconds':9696,'ThreadpoolReaderSubmitLookupInCacheMicroseconds':1121,'FileSegmentWaitReadBufferMicroseconds':48,'AsynchronousRemoteReadWaitMicroseconds':508587,'MetadataFromKeeperCacheHit':809,'MetadataFromKeeperCacheMiss':8,'MetadataFromKeeperTransactionCommit':1,'MetadataFromKeeperOperations':6,'MetadataFromKeeperIndividualOperations':115,'LogTrace':28,'LogDebug':7,'LoggerElapsedNanoseconds':682028,'DiskConnectionsReset':1,'ConcurrencyControlSlotsGranted':1,'ConcurrencyControlSlotsAcquired':1}

1 row in set. Elapsed: 1.138 sec. Processed 952.02 million rows, 45.82 GB (836.68 million rows/s., 40.27 GB/s.)
Peak memory usage: 235.80 MiB.


SELECT *
FROM system.mutations
WHERE ((CAST(create_time, 'Date32') >= '2025-02-09') AND (CAST(create_time, 'Date32') <= '2025-02-11')) AND (`table` = 'transaction_canonical_embeddings')
FORMAT Vertical

Query id: d0e268d1-d5c2-4482-97d0-6522ceb7410c

Row 1:
──────
database:                    applied_ai
table:                       transaction_canonical_embeddings
mutation_id:                 0000000004
command:                     ADD COLUMN IF NOT EXISTS `accounting_is_gl_tc_coded` Boolean MATERIALIZED match(accounting_tracking_category_selections, '"type":\\s{0,2}"GL_ACCOUNT"') AND (accounting_tracking_category_selections NOT ILIKE '%"type": "GL_ACCOUNT"}, "tracking_category_option": {"id": null,%') AFTER accounting_coding_id
create_time:                 2025-02-10 22:29:09
block_numbers.partition_id:  []
block_numbers.number:        []
parts_to_do_names:           []
parts_to_do:                 0
is_done:                     1
is_killed:                   0
latest_failed_part:
latest_fail_time:            1970-01-01 00:00:00
latest_fail_reason:
latest_fail_error_code_name:

Row 2:
──────
database:                    applied_ai
table:                       transaction_canonical_embeddings
mutation_id:                 0000000005
command:                     MATERIALIZE COLUMN accounting_is_gl_tc_coded
create_time:                 2025-02-10 23:11:17
block_numbers.partition_id:  ['all']
block_numbers.number:        [15813313]
parts_to_do_names:           []
parts_to_do:                 0
is_done:                     1
is_killed:                   0
latest_failed_part:
latest_fail_time:            1970-01-01 00:00:00
latest_fail_reason:
latest_fail_error_code_name:

2 rows in set. Elapsed: 0.003 sec.

SELECT
    merge_reason,
    event_time,
    part_name,
    size_in_bytes,
    rows,
    event_type,
    merge_algorithm,
    merged_from
FROM clusterAllReplicas('all_groups.default', merge('system', 'part_log*'))
WHERE (part_name = 'all_0_1792332_347_3383084') AND (table_uuid = '0cfd987c-6064-42f4-9a52-81087342a57b')
ORDER BY event_time ASC
LIMIT 1
FORMAT Vertical

Query id: 511f8aad-04cd-4aaf-9a26-7e22359de1e7

Row 1:
──────
merge_reason:    NotAMerge
event_time:      2024-09-07 20:09:30
part_name:       all_0_1792332_347_3383084
size_in_bytes:   827608443929
rows:            0
event_type:      MutatePart
merge_algorithm: Undecided
merged_from:     ['all_0_1792332_347_3294761']

1 row in set. Elapsed: 5.092 sec. Processed 3.26 billion rows, 154.20 GB (639.89 million rows/s., 30.28 GB/s.)
Peak memory usage: 1.05 GiB.


and this part...

SELECT
    merge_reason,
    event_time,
    part_name,
    size_in_bytes,
    rows,
    event_type,
    merge_algorithm,
    merged_from
FROM clusterAllReplicas('all_groups.default', merge('system', 'part_log*'))
WHERE (part_name = 'all_0_1792332_347_3294761') AND (table_uuid = '0cfd987c-6064-42f4-9a52-81087342a57b')
ORDER BY event_time ASC
LIMIT 1
FORMAT Vertical

Query id: c159f062-6154-4ec0-ae45-d6070e888249

Row 1:
──────
merge_reason:    NotAMerge
event_time:      2024-09-07 16:08:07
part_name:       all_0_1792332_347_3294761
size_in_bytes:   1655139950652
rows:            93526176
event_type:      MutatePart
merge_algorithm: Undecided
merged_from:     ['all_0_1792332_347']

1 row in set. Elapsed: 4.948 sec. Processed 3.26 billion rows, 154.19 GB (658.45 million rows/s., 31.16 GB/s.)
Peak memory usage: 1.04 GiB.




SELECT
    table_uuid,
    merge_reason,
    event_time,
    part_name,
    size_in_bytes,
    rows,
    event_type,
    merge_algorithm,
    merged_from
FROM clusterAllReplicas('all_groups.default', merge('system', 'part_log*'))
WHERE (part_name = 'all_0_1792332_347') AND (table_uuid = '0cfd987c-6064-42f4-9a52-81087342a57b') AND (event_type NOT IN ('DownloadPart'))
ORDER BY event_time ASC
LIMIT 1
FORMAT Vertical

Query id: 67e5c8f9-17cc-4ec9-b108-01328abbec30

Row 1:
──────
table_uuid:      0cfd987c-6064-42f4-9a52-81087342a57b
merge_reason:    RegularMerge
event_time:      2024-08-18 04:45:08
part_name:       all_0_1792332_347
size_in_bytes:   827609191325
rows:            93526176
event_type:      MergeParts
merge_algorithm: Vertical
merged_from:     ['all_0_1181010_346','all_1181011_1550048_156','all_1550049_1553174_23','all_1553175_1555009_27','all_1555010_1556083_72','all_1556084_1592580_142','all_1592581_1607252_54','all_1607253_1688703_151','all_1688704_1727218_167','all_1727219_1728092_75','all_1728093_1750466_171','all_1750467_1789583_202','all_1789584_1791470_168','all_1791471_1792234_98','all_1792235_1792330_42','all_1792331_1792331_0','all_1792332_1792332_0']

1 row in set. Elapsed: 5.212 sec. Processed 3.26 billion rows, 157.45 GB (625.17 million rows/s., 30.21 GB/s.)
Peak memory usage: 1.13 GiB.


So untouched for 6 months



Lets check for difference betwen transaction date and version date

 SELECT toStartOfMonth(user_transaction_time) as month,
    CASE
        WHEN hours_since_first_insertion < 24 THEN '< Day'
        WHEN hours_since_first_insertion < 24 * 7 THEN '< Week'
        WHEN hours_since_first_insertion < 24 * 30 THEN '<Month'
        WHEN hours_since_first_insertion < 24 * 30 * 3 THEN '< 3 Month'
        WHEN hours_since_first_insertion < 24 * 30 * 6 THEN '< 6 Month'
        WHEN hours_since_first_insertion < 24 * 30 * 6 THEN '< Year'
        ELSE ' > Year'
    END AS time_since_first_insertion,
    COUNT(*) AS count
FROM (
    SELECT user_transaction_time,
        date_diff('hour', user_transaction_time, version) AS hours_since_first_insertion
    FROM applied_ai.transaction_canonical_embeddings_v2
)
GROUP BY time_since_first_insertion, month
ORDER BY month ASC , time_since_first_insertion ASC;

┌──────month─┬─time_since_first_insertion─┬────count─┐
│ 2019-05-01 │  > Year                    │       27 │
│ 2019-06-01 │  > Year                    │      280 │
│ 2019-07-01 │  > Year                    │      470 │
│ 2019-08-01 │  > Year                    │      708 │
│ 2019-09-01 │  > Year                    │      997 │
│ 2019-10-01 │  > Year                    │     2970 │
│ 2019-11-01 │  > Year                    │     4792 │
│ 2019-12-01 │  > Year                    │     6978 │
│ 2020-01-01 │  > Year                    │    13059 │
│ 2020-02-01 │  > Year                    │    21591 │
│ 2020-03-01 │  > Year                    │    93220 │
│ 2020-04-01 │  > Year                    │    28047 │
│ 2020-05-01 │  > Year                    │    35229 │
│ 2020-06-01 │  > Year                    │    49059 │
│ 2020-07-01 │  > Year                    │    65676 │
│ 2020-08-01 │  > Year                    │    74474 │
│ 2020-09-01 │  > Year                    │    90824 │
│ 2020-10-01 │  > Year                    │   155001 │
│ 2020-11-01 │  > Year                    │   173225 │
│ 2020-12-01 │  > Year                    │   227250 │
│ 2021-01-01 │  > Year                    │   267358 │
│ 2021-02-01 │  > Year                    │   335405 │
│ 2021-03-01 │  > Year                    │   420952 │
│ 2021-04-01 │  > Year                    │   503362 │
│ 2021-05-01 │  > Year                    │   641584 │
│ 2021-06-01 │  > Year                    │   816036 │
│ 2021-07-01 │  > Year                    │  1067272 │
│ 2021-08-01 │  > Year                    │  1515775 │
│ 2021-09-01 │  > Year                    │  1609021 │
│ 2021-10-01 │  > Year                    │  1913990 │
│ 2021-11-01 │  > Year                    │  2269576 │
│ 2021-12-01 │  > Year                    │  2108509 │
│ 2022-01-01 │  > Year                    │  2113871 │
│ 2022-02-01 │  > Year                    │  2384413 │
│ 2022-03-01 │  > Year                    │  3069933 │
│ 2022-04-01 │  > Year                    │  3264996 │
│ 2022-05-01 │  > Year                    │  3714559 │
│ 2022-06-01 │  > Year                    │  3965736 │
│ 2022-07-01 │  > Year                    │  4483501 │
│ 2022-08-01 │  > Year                    │  5308879 │
│ 2022-09-01 │  > Year                    │  5548435 │
│ 2022-10-01 │  > Year                    │  5667121 │
│ 2022-11-01 │  > Year                    │  5511533 │
│ 2022-12-01 │  > Year                    │  5758827 │
│ 2023-01-01 │  > Year                    │  6848326 │
│ 2023-02-01 │  > Year                    │  6483481 │
│ 2023-03-01 │  > Year                    │  8073319 │
│ 2023-04-01 │  > Year                    │  7544475 │
│ 2023-05-01 │  > Year                    │  8441464 │
│ 2023-06-01 │  > Year                    │  8579184 │
│ 2023-07-01 │  > Year                    │  8487996 │
│ 2023-08-01 │  > Year                    │  9797442 │
│ 2023-09-01 │  > Year                    │ 10247224 │
│ 2023-10-01 │  > Year                    │ 11648095 │
│ 2023-11-01 │  > Year                    │ 11048650 │
│ 2023-12-01 │  > Year                    │ 11044931 │
│ 2024-01-01 │  > Year                    │ 11796683 │
│ 2024-01-01 │ < 6 Month                  │   333497 │
│ 2024-02-01 │  > Year                    │  8454948 │
│ 2024-02-01 │ < 6 Month                  │  4120007 │
│ 2024-03-01 │  > Year                    │  9162108 │
│ 2024-03-01 │ < 6 Month                  │  4521415 │
│ 2024-04-01 │  > Year                    │  9876468 │
│ 2024-04-01 │ < 3 Month                  │   171098 │
│ 2024-04-01 │ < 6 Month                  │  4782511 │
│ 2024-05-01 │  > Year                    │ 10602816 │
│ 2024-05-01 │ < 3 Month                  │  5216664 │
│ 2024-05-01 │ < 6 Month                  │   183378 │
│ 2024-06-01 │  > Year                    │  8214809 │
│ 2024-06-01 │ < 3 Month                  │  5298113 │
│ 2024-06-01 │ < 6 Month                  │  2479486 │
│ 2024-07-01 │  > Year                    │  3785796 │
│ 2024-07-01 │ < 3 Month                  │  2819861 │
│ 2024-07-01 │ < 6 Month                  │  7084874 │
│ 2024-07-01 │ < Week                     │       13 │
│ 2024-07-01 │ <Month                     │  3572523 │
│ 2024-08-01 │  > Year                    │     4518 │
│ 2024-08-01 │ < 3 Month                  │  1116254 │
│ 2024-08-01 │ < 6 Month                  │ 11813110 │
│ 2024-08-01 │ < Day                      │  1846731 │
│ 2024-08-01 │ < Week                     │  2474208 │
│ 2024-08-01 │ <Month                     │  6274599 │
│ 2024-09-01 │ < 3 Month                  │  4434653 │
│ 2024-09-01 │ < 6 Month                  │  9482448 │
│ 2024-09-01 │ < Day                      │  2972119 │
│ 2024-09-01 │ < Week                     │  3291752 │
│ 2024-09-01 │ <Month                     │  5730334 │
│ 2024-10-01 │ < 3 Month                  │ 11312584 │
│ 2024-10-01 │ < 6 Month                  │  4577163 │
│ 2024-10-01 │ < Day                      │  2280642 │
│ 2024-10-01 │ < Week                     │  2434786 │
│ 2024-10-01 │ <Month                     │  5646422 │
│ 2024-11-01 │ < 3 Month                  │  9826211 │
│ 2024-11-01 │ < 6 Month                  │     9997 │
│ 2024-11-01 │ < Day                      │  3450727 │
│ 2024-11-01 │ < Week                     │  3452109 │
│ 2024-11-01 │ <Month                     │  9265762 │
│ 2024-12-01 │ < 3 Month                  │  6523188 │
│ 2024-12-01 │ < Day                      │  4864730 │
│ 2024-12-01 │ < Week                     │  3926614 │
│ 2024-12-01 │ <Month                     │  7221611 │
│ 2025-01-01 │ < 3 Month                  │   260814 │
│ 2025-01-01 │ < Day                      │  5190378 │
│ 2025-01-01 │ < Week                     │  4713058 │
│ 2025-01-01 │ <Month                     │  8376847 │
│ 2025-02-01 │ < Day                      │  1741204 │
│ 2025-02-01 │ < Week                     │  1181191 │
│ 2025-02-01 │ <Month                     │    37950 │
└────────────┴────────────────────────────┴──────────┘

SELECT
    multiIf(hours_since_first_insertion < 24, '< Day', hours_since_first_insertion < (24 * 7), '< Week', hours_since_first_insertion < (24 * 30), '<Month', hours_since_first_insertion < ((24 * 30) * 3), '< 3 Month', hours_since_first_insertion < ((24 * 30) * 6), '< 6 Month', hours_since_first_insertion < ((24 * 30) * 6), '< Year', ' > Year') AS max_time_between_initial_and_last_insert,
    COUNT(*) AS count
FROM
(
    SELECT
        cityHash64(business_id, user_transaction_time, id) AS hash,
        max(dateDiff('hour', user_transaction_time, version)) AS hours_since_first_insertion
    FROM applied_ai.transaction_canonical_embeddings_v2
    GROUP BY hash
)
GROUP BY max_time_between_initial_and_last_insert

Query id: c01fb21c-50f1-421d-8a12-6f59a5196fec

┌─max_time_between_initial_and_last_insert─┬───count─┐
│ < Week                                   │ 2309393 │
└──────────────────────────────────────────┴─────────┘
┌─max_time_between_initial_and_last_insert─┬───count─┐
│ <Month                                   │ 5970519 │
└──────────────────────────────────────────┴─────────┘
┌─max_time_between_initial_and_last_insert─┬────count─┐
│ < 3 Month                                │ 14761830 │
└──────────────────────────────────────────┴──────────┘
┌─max_time_between_initial_and_last_insert─┬────count─┐
│ < 6 Month                                │ 18244886 │
└──────────────────────────────────────────┴──────────┘
┌─max_time_between_initial_and_last_insert─┬───count─┐
│ < Day                                    │ 2074233 │
└──────────────────────────────────────────┴─────────┘
┌─max_time_between_initial_and_last_insert─┬────count─┐
│  > Year                                  │ 88816213 │
└──────────────────────────────────────────┴──────────┘

6 rows in set. Elapsed: 6.104 sec. Processed 421.76 million rows, 10.12 GB (69.10 million rows/s., 1.66 GB/s.)
Peak memory usage: 22.18 GiB.



CREATE TABLE applied_ai.transaction_canonical_embeddings
(
    `id` UInt32,
    `uuid` UUID,
    `business_id` UInt32,
    `department_id` UInt32,
    `department_name` String,
    `location_id` UInt32,
    `location_name` String,
    `merchant_id` UInt32,
    `payee_id` UInt32,
    `spend_allocation_id` UInt32,
    `spend_allocation_display_name` String,
    `trip_id` UInt32,
    `trip_name` String,
    `user_id` UInt32,
    `amount` Decimal(18, 4),
    `original_amount` Decimal(18, 4),
    `currency` String,
    `original_currency` String,
    `user_transaction_time` DateTime64(3, 'UTC'),
    `card_acceptor` String,
    `card_acceptor_name_signature` String,
    `card_last_four` String,
    `mcc` String,
    `mcc_detailed` String,
    `merchant_domain` String,
    `merchant_name` String,
    `merchant_city` String,
    `merchant_state` String,
    `sk_category_id` UInt32,
    `sk_category_name` String,
    `memo` String,
    `sync_ready_status` Bool,
    `accounting_coding_id` UInt32,
    `accounting_is_gl_tc_coded` Bool MATERIALIZED match(accounting_tracking_category_selections, '"type":\\s{0,2}"GL_ACCOUNT"') AND (accounting_tracking_category_selections NOT ILIKE '%"type": "GL_ACCOUNT"}, "tracking_category_option": {"id": null,%'),
    `accounting_tracking_category_selections` String,
    `bfloat16_embedding_for_accounting_matching` Array(Float32),
    `bfloat16_embedding_for_merchant_merging` Array(Float32),
    `bfloat16_embedding_for_receipt_matching` Array(Float32),
    `embedding_for_accounting_matching` Array(Float32),
    `embedding_for_merchant_merging` Array(Float32),
    `embedding_for_receipt_matching` Array(Float32),
    `prompt_for_accounting_matching` String,
    `prompt_for_merchant_merging` String,
    `prompt_for_receipt_matching` String,
    `version` DateTime64(3, 'UTC'),
    `deleted` UInt8
)
ENGINE = ReplacingMergeTree ORDER BY (business_id, user_transaction_time, id)
PARTITION BY 
    toYear(user_transaction_time) < 2024 ? toYear(user_transaction_time) : toYYYYMM(user_transaction_time)
SETTINGS index_granularity = 8192, cache_populated_by_fetch = 1, min_age_to_force_merge_seconds=600
```





SELECT
    `table`,
    name,
    type,
    formatReadableSize(data_compressed_bytes),
    formatReadableSize(data_uncompressed_bytes)
FROM system.columns
WHERE ((`table` LIKE 'transaction_canonical_embeddings') AND (name IN ['embedding', 'prompt_for_accounting_matching', 'accounting_is_gl_tc_coded', 'accounting_tracking_category_selections', 'bfloat16_embedding_for_accounting_matching', 'business_id', 'id', 'merchant_name', 'sync_ready_status', 'user_transaction_time', 'version', 'accounting_tracking_category_selections', 'business_id'])) OR ((`table` = 'prod_bill_pay_categorization') AND (name IN ['accounting_provider_access_id', 'amount', 'bill_line_item_log_entry_id', 'business_id', 'non_gl_category_blob', 'tracking_category_id', 'tracking_category_option_id', 'tracking_category_option_remote_name', 'vector_field'])) OR (`table` = 'transaction_canonical_receipt_matching')
ORDER BY
    `table` ASC,
    data_compressed_bytes DESC

Query id: a6073da6-aadd-4e6d-a1de-49395f6a68b6

┌─table──────────────────────────────────┬─name───────────────────────────────────────┬─type───────────────────┬─formatReadableSize(data_compressed_bytes)─┬─formatReadableSize(data_uncompressed_bytes)─┐
│ prod_bill_pay_categorization           │ vector_field                               │ Array(BFloat16)        │ 2.73 GiB                                  │ 5.17 GiB                                    │
│ prod_bill_pay_categorization           │ non_gl_category_blob                       │ String                 │ 45.90 MiB                                 │ 3.34 GiB                                    │
│ prod_bill_pay_categorization           │ amount                                     │ Float32                │ 18.89 MiB                                 │ 27.28 MiB                                   │
│ prod_bill_pay_categorization           │ bill_line_item_log_entry_id                │ UInt64                 │ 16.77 MiB                                 │ 54.55 MiB                                   │
│ prod_bill_pay_categorization           │ tracking_category_option_remote_name       │ String                 │ 14.61 MiB                                 │ 241.92 MiB                                  │
│ prod_bill_pay_categorization           │ tracking_category_option_id                │ UInt64                 │ 6.39 MiB                                  │ 54.55 MiB                                   │
│ prod_bill_pay_categorization           │ accounting_provider_access_id              │ UInt64                 │ 103.54 KiB                                │ 54.55 MiB                                   │
│ prod_bill_pay_categorization           │ tracking_category_id                       │ UInt64                 │ 101.86 KiB                                │ 54.55 MiB                                   │
│ prod_bill_pay_categorization           │ business_id                                │ UInt64                 │ 90.64 KiB                                 │ 54.55 MiB                                   │
│ transaction_canonical_embeddings       │ bfloat16_embedding_for_accounting_matching │ Array(Float32)         │ 125.45 GiB                                │ 303.17 GiB                                  │
│ transaction_canonical_embeddings       │ prompt_for_accounting_matching             │ String                 │ 4.76 GiB                                  │ 46.70 GiB                                   │
│ transaction_canonical_embeddings       │ accounting_tracking_category_selections    │ String                 │ 2.42 GiB                                  │ 93.13 GiB                                   │
│ transaction_canonical_embeddings       │ user_transaction_time                      │ DateTime64(3, 'UTC')   │ 707.65 MiB                                │ 1.57 GiB                                    │
│ transaction_canonical_embeddings       │ id                                         │ UInt32                 │ 689.96 MiB                                │ 804.26 MiB                                  │
│ transaction_canonical_embeddings       │ merchant_name                              │ String                 │ 636.52 MiB                                │ 2.33 GiB                                    │
│ transaction_canonical_embeddings       │ version                                    │ DateTime64(3, 'UTC')   │ 567.28 MiB                                │ 1.57 GiB                                    │
│ transaction_canonical_embeddings       │ sync_ready_status                          │ Bool                   │ 20.19 MiB                                 │ 201.07 MiB                                  │
│ transaction_canonical_embeddings       │ accounting_is_gl_tc_coded                  │ Bool                   │ 17.00 MiB                                 │ 201.07 MiB                                  │
│ transaction_canonical_embeddings       │ business_id                                │ UInt32                 │ 2.20 MiB                                  │ 804.26 MiB                                  │
│ transaction_canonical_receipt_matching │ embedding                                  │ Array(Float32)         │ 914.06 GiB                                │ 1.03 TiB                                    │
│ transaction_canonical_receipt_matching │ bfloat16_embedding                         │ Array(Float32)         │ 461.40 GiB                                │ 1.03 TiB                                    │
│ transaction_canonical_receipt_matching │ card_acceptor                              │ String                 │ 4.63 GiB                                  │ 40.07 GiB                                   │
│ transaction_canonical_receipt_matching │ merchant_domain                            │ String                 │ 1.41 GiB                                  │ 8.00 GiB                                    │
│ transaction_canonical_receipt_matching │ memo                                       │ String                 │ 1.34 GiB                                  │ 3.69 GiB                                    │
│ transaction_canonical_receipt_matching │ id                                         │ UInt32                 │ 922.99 MiB                                │ 1.02 GiB                                    │
│ transaction_canonical_receipt_matching │ user_transaction_time                      │ DateTime64(3, 'UTC')   │ 921.66 MiB                                │ 2.05 GiB                                    │
│ transaction_canonical_receipt_matching │ version                                    │ UInt64                 │ 818.30 MiB                                │ 2.05 GiB                                    │
│ transaction_canonical_receipt_matching │ merchant_name                              │ String                 │ 808.04 MiB                                │ 3.06 GiB                                    │
│ transaction_canonical_receipt_matching │ card_acceptor_name_signature               │ String                 │ 800.16 MiB                                │ 3.28 GiB                                    │
│ transaction_canonical_receipt_matching │ amount                                     │ Decimal(18, 4)         │ 727.13 MiB                                │ 2.05 GiB                                    │
│ transaction_canonical_receipt_matching │ merchant_city                              │ String                 │ 430.40 MiB                                │ 2.46 GiB                                    │
│ transaction_canonical_receipt_matching │ merchant_id                                │ UInt32                 │ 425.83 MiB                                │ 1.02 GiB                                    │
│ transaction_canonical_receipt_matching │ sk_category_name                           │ String                 │ 340.66 MiB                                │ 4.05 GiB                                    │
│ transaction_canonical_receipt_matching │ card_last_four                             │ String                 │ 317.12 MiB                                │ 1.28 GiB                                    │
│ transaction_canonical_receipt_matching │ mcc                                        │ String                 │ 296.90 MiB                                │ 1.28 GiB                                    │
│ transaction_canonical_receipt_matching │ user_id                                    │ UInt32                 │ 280.98 MiB                                │ 1.02 GiB                                    │
│ transaction_canonical_receipt_matching │ sk_category_id                             │ UInt32                 │ 182.59 MiB                                │ 1.02 GiB                                    │
│ transaction_canonical_receipt_matching │ merchant_state                             │ String                 │ 175.44 MiB                                │ 747.54 MiB                                  │
│ transaction_canonical_receipt_matching │ department_id                              │ UInt32                 │ 138.61 MiB                                │ 1.02 GiB                                    │
│ transaction_canonical_receipt_matching │ location_id                                │ UInt32                 │ 88.03 MiB                                 │ 1.02 GiB                                    │
│ transaction_canonical_receipt_matching │ currency_code                              │ LowCardinality(String) │ 12.77 MiB                                 │ 266.31 MiB                                  │
│ transaction_canonical_receipt_matching │ business_id                                │ UInt32                 │ 2.31 MiB                                  │ 1.02 GiB                                    │
│ transaction_canonical_receipt_matching │ deleted                                    │ UInt8                  │ 144.65 KiB                                │ 1.72 MiB                                    │
└────────────────────────────────────────┴────────────────────────────────────────────┴────────────────────────┴───────────────────────────────────────────┴─────────────────────────────────────────────┘

43 rows in set. Elapsed: 0.003 sec.

size halved?

after merges have started


Query id: e540ac2c-eb20-4603-ae76-cb4a64f816a4

↘ Progress: 213.30 million rows, 3.41 GB (24.43 million rows/s., 390.82 MB/s.) (3.5 CPU, 15.29 GB RAM)█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
┌──────month─┬────────c─┬────uniq─┬─duplicate_ratio─┐
│ 2019-05-01 │        9 │       9 │               1 │
│ 2019-06-01 │       75 │      75 │               1 │
│ 2019-07-01 │      130 │     130 │               1 │
│ 2019-08-01 │      207 │     207 │               1 │
│ 2019-09-01 │      300 │     300 │               1 │
│ 2019-10-01 │      949 │     949 │               1 │
│ 2019-11-01 │     1556 │    1556 │               1 │
│ 2019-12-01 │     2263 │    2263 │               1 │
│ 2020-01-01 │     4229 │    4229 │               1 │
│ 2020-02-01 │     7039 │    7039 │               1 │
│ 2020-03-01 │    30975 │   30975 │               1 │
│ 2020-04-01 │     9302 │    9302 │               1 │
│ 2020-05-01 │    11696 │   11696 │               1 │
│ 2020-06-01 │    16305 │   16305 │               1 │
│ 2020-07-01 │    21801 │   21801 │               1 │
│ 2020-08-01 │    24704 │   24704 │               1 │
│ 2020-09-01 │    30085 │   30085 │               1 │
│ 2020-10-01 │    51433 │   51433 │               1 │
│ 2020-11-01 │    57495 │   57495 │               1 │
│ 2020-12-01 │    75474 │   75474 │               1 │
│ 2021-01-01 │    88826 │   88826 │               1 │
│ 2021-02-01 │   111337 │  111337 │               1 │
│ 2021-03-01 │   139608 │  139608 │               1 │
│ 2021-04-01 │   166693 │  166693 │               1 │
│ 2021-05-01 │   210058 │  210058 │               1 │
│ 2021-06-01 │   270158 │  270158 │               1 │
│ 2021-07-01 │   353645 │  353645 │               1 │
│ 2021-08-01 │   502781 │  502781 │               1 │
│ 2021-09-01 │   533290 │  533290 │               1 │
│ 2021-10-01 │   634010 │  634010 │               1 │
│ 2021-11-01 │   751618 │  751618 │               1 │
│ 2021-12-01 │   697504 │  697504 │               1 │
│ 2022-01-01 │  1523650 │  699189 │            2.18 │
│ 2022-02-01 │  1841910 │  788437 │            2.34 │
│ 2022-03-01 │  2274752 │ 1013356 │            2.24 │
│ 2022-04-01 │  2415885 │ 1077921 │            2.24 │
│ 2022-05-01 │  2891050 │ 1224100 │            2.36 │
│ 2022-06-01 │  2689428 │ 1306662 │            2.06 │
│ 2022-07-01 │  2973662 │ 1481988 │            2.01 │
│ 2022-08-01 │  3330714 │ 1753103 │             1.9 │
│ 2022-09-01 │  4413774 │ 1831192 │            2.41 │
│ 2022-10-01 │  4123570 │ 1869199 │            2.21 │
│ 2022-11-01 │  3399401 │ 1817629 │            1.87 │
│ 2022-12-01 │  4267481 │ 1899559 │            2.25 │
│ 2023-01-01 │  6167985 │ 2261124 │            2.73 │
│ 2023-02-01 │  5757874 │ 2137876 │            2.69 │
│ 2023-03-01 │  7049690 │ 2661640 │            2.65 │
│ 2023-04-01 │  6747379 │ 2487559 │            2.71 │
│ 2023-05-01 │  7051701 │ 2783600 │            2.53 │
│ 2023-06-01 │  7256453 │ 2825928 │            2.57 │
│ 2023-07-01 │  7558852 │ 2795613 │             2.7 │
│ 2023-08-01 │  8634540 │ 3227243 │            2.68 │
│ 2023-09-01 │  9290978 │ 3374359 │            2.75 │
│ 2023-10-01 │ 10145785 │ 3832563 │            2.65 │
│ 2023-11-01 │  9686461 │ 3629694 │            2.67 │
│ 2023-12-01 │  9633924 │ 3631543 │            2.65 │
│ 2024-01-01 │  3984203 │ 3983184 │               1 │
│ 2024-02-01 │  4125120 │ 4124183 │               1 │
│ 2024-03-01 │  4485126 │ 4483776 │               1 │
│ 2024-04-01 │  4850239 │ 4849103 │               1 │
│ 2024-05-01 │  5226904 │ 5226282 │               1 │
│ 2024-06-01 │  5191232 │ 5190722 │               1 │
│ 2024-07-01 │  5305047 │ 5303903 │               1 │
│ 2024-08-01 │  5794515 │ 5793625 │               1 │
│ 2024-09-01 │  6398519 │ 6397382 │               1 │
│ 2024-10-01 │  7165222 │ 7164497 │               1 │
│ 2024-11-01 │  6384989 │ 6384426 │               1 │
│ 2024-12-01 │  6457914 │ 6456033 │               1 │
│ 2025-01-01 │  7214603 │ 7212866 │               1 │
│ 2025-02-01 │  4779482 │ 4756005 │               1 │
└────────────┴──────────┴─────────┴─────────────────┘



SELECT
    name,
    modification_time,
    level,
    rows,
    formatReadableSize(data_compressed_bytes) AS compressed_bytes
FROM system.parts
WHERE (`table` = 'transaction_canonical_embeddings') AND active
ORDER BY data_compressed_bytes DESC

Query id: d07a9d3d-b351-49d0-a29f-ab9ae719e312

┌─name────────────────────┬───modification_time─┬─level─┬─────rows─┬─compressed_bytes─┐
│ 2023_21131_28431_25     │ 2025-02-21 08:55:00 │    25 │ 16380858 │ 137.18 GiB       │
│ 2023_14002_18287_7      │ 2025-02-20 00:45:22 │     7 │ 15561874 │ 129.91 GiB       │
│ 2023_13_3636_7          │ 2025-02-19 21:01:36 │     7 │ 15488304 │ 129.26 GiB       │
│ 2022_13_10877_11        │ 2025-02-19 22:51:05 │    11 │ 14813757 │ 119.89 GiB       │
│ 2023_9689_14001_7       │ 2025-02-19 23:24:39 │     7 │ 14129063 │ 118.25 GiB       │
│ 2022_10878_20700_11     │ 2025-02-20 01:11:00 │    11 │ 14312229 │ 117.05 GiB       │
│ 2023_6198_9688_7        │ 2025-02-19 22:22:57 │     7 │ 12127192 │ 101.66 GiB       │
│ 2023_3637_6197_6        │ 2025-02-19 21:15:35 │     6 │ 10945345 │ 90.14 GiB        │
│ 2023_18288_21130_8      │ 2025-02-20 00:56:51 │     8 │ 10344885 │ 86.39 GiB        │
│ 202501_9_50934_132      │ 2025-02-21 14:58:03 │   132 │  7212866 │ 64.25 GiB        │
│ 202410_11_33472_54      │ 2025-02-21 14:37:56 │    54 │  7164497 │ 63.31 GiB        │
│ 2022_20701_26185_31     │ 2025-02-21 14:50:32 │    31 │  7019291 │ 58.31 GiB        │
│ 202412_13_37625_90      │ 2025-02-21 12:52:33 │    90 │  6456033 │ 57.24 GiB        │
│ 202409_12_31366_51      │ 2025-02-21 15:03:30 │    51 │  6397382 │ 56.87 GiB        │
│ 202411_11_34980_113     │ 2025-02-21 14:47:33 │   113 │  6384426 │ 56.79 GiB        │
│ 202408_13_30281_45      │ 2025-02-21 15:06:10 │    45 │  5793625 │ 51.37 GiB        │
│ 202407_13_29755_80      │ 2025-02-21 15:02:44 │    80 │  5303903 │ 47.41 GiB        │
│ 202405_13_28453_49      │ 2025-02-21 15:11:24 │    49 │  5226282 │ 45.84 GiB        │
│ 202406_13_29280_54      │ 2025-02-21 15:02:34 │    54 │  5190722 │ 45.42 GiB        │
│ 202502_0_114805_77      │ 2025-02-21 15:17:28 │    77 │  4749323 │ 43.25 GiB        │
│ 202404_12_27914_47      │ 2025-02-21 15:13:20 │    47 │  4849103 │ 42.50 GiB        │
│ 202403_13_27906_40      │ 2025-02-21 07:42:41 │    40 │  4483776 │ 39.27 GiB        │
│ 202402_13_27354_44      │ 2025-02-21 12:42:49 │    44 │  4124183 │ 36.10 GiB        │
│ 202401_13_27047_50      │ 2025-02-21 15:00:59 │    50 │  3983184 │ 34.25 GiB        │
│ 2021_13_17140_35        │ 2025-02-21 04:20:15 │    35 │  4459528 │ 33.63 GiB        │
│ 2020_2_2116_25          │ 2025-02-21 00:30:24 │    25 │   340538 │ 2.23 GiB         │
│ 202502_114806_116454_18 │ 2025-02-21 15:06:57 │    18 │    12741 │ 122.91 MiB       │
│ 202502_116782_117454_13 │ 2025-02-21 15:16:35 │    13 │     5433 │ 52.37 MiB        │
│ 2019_2_104_19           │ 2025-02-20 01:06:40 │    19 │     5489 │ 46.88 MiB        │
│ 202502_116455_116781_13 │ 2025-02-21 15:10:08 │    13 │     2565 │ 25.03 MiB        │
│ 202502_117455_117587_7  │ 2025-02-21 15:17:55 │     7 │     2363 │ 22.46 MiB        │
│ 2023_28504_28558_7      │ 2025-02-21 15:12:30 │     7 │     2277 │ 21.96 MiB        │
│ 202412_38197_38353_24   │ 2025-02-21 15:10:36 │    24 │      999 │ 9.61 MiB         │
│ 2023_28559_28564_2      │ 2025-02-21 15:12:36 │     2 │      976 │ 9.44 MiB         │
│ 202501_50935_52018_92   │ 2025-02-21 15:00:32 │    92 │      925 │ 8.82 MiB         │
│ 202412_38354_38466_20   │ 2025-02-21 15:16:55 │    20 │      799 │ 7.67 MiB         │
│ 2023_28565_28569_2      │ 2025-02-21 15:14:19 │     2 │      785 │ 7.58 MiB         │
│ 202501_52019_52674_67   │ 2025-02-21 15:13:02 │    67 │      747 │ 7.21 MiB         │
│ 202403_27908_27992_7    │ 2025-02-21 15:16:56 │     7 │      726 │ 6.96 MiB         │
│ 202404_27915_27968_6    │ 2025-02-21 15:12:37 │     6 │      715 │ 6.90 MiB         │
│ 202410_33473_33687_36   │ 2025-02-21 15:12:45 │    36 │      682 │ 6.61 MiB         │
│ 202409_31367_31476_16   │ 2025-02-21 15:12:36 │    16 │      638 │ 6.19 MiB         │
│ 202408_30282_30377_13   │ 2025-02-21 15:12:39 │    13 │      620 │ 6.04 MiB         │
│ 202407_29756_29824_8    │ 2025-02-21 15:12:38 │     8 │      624 │ 6.02 MiB         │
│ 202404_27969_28012_7    │ 2025-02-21 15:17:06 │     7 │      610 │ 5.84 MiB         │
│ 202405_28454_28520_7    │ 2025-02-21 15:12:50 │     7 │      598 │ 5.81 MiB         │
│ 202411_34981_35161_29   │ 2025-02-21 15:12:52 │    29 │      554 │ 5.38 MiB         │
│ 202501_52675_52845_32   │ 2025-02-21 15:17:02 │    32 │      546 │ 5.14 MiB         │
│ 202401_27048_27093_6    │ 2025-02-21 15:12:29 │     6 │      527 │ 5.09 MiB         │
│ 202409_31477_31492_4    │ 2025-02-21 15:16:38 │     4 │      497 │ 4.83 MiB         │
│ 202402_27355_27400_6    │ 2025-02-21 15:12:29 │     6 │      490 │ 4.78 MiB         │
│ 202410_33688_33740_10   │ 2025-02-21 15:17:06 │    10 │      457 │ 4.13 MiB         │
│ 202406_29281_29347_8    │ 2025-02-21 15:12:42 │     8 │      421 │ 4.07 MiB         │
│ 202407_29825_29830_2    │ 2025-02-21 15:12:45 │     2 │      402 │ 3.91 MiB         │
│ 202401_27094_27104_3    │ 2025-02-21 15:12:43 │     3 │      395 │ 3.85 MiB         │
│ 202402_27401_27412_3    │ 2025-02-21 15:12:43 │     3 │      369 │ 3.60 MiB         │
│ 202408_30378_30403_4    │ 2025-02-21 15:16:55 │     4 │      365 │ 3.52 MiB         │
│ 202411_35162_35202_9    │ 2025-02-21 15:16:59 │     9 │      392 │ 3.50 MiB         │
│ 202412_37626_38196_110  │ 2025-02-21 14:53:44 │   110 │      291 │ 2.84 MiB         │
│ 202407_29831_29868_8    │ 2025-02-21 15:17:02 │     8 │      294 │ 2.76 MiB         │
│ 202502_117588_117617_5  │ 2025-02-21 15:18:09 │     5 │      270 │ 2.68 MiB         │
│ 202405_28521_28568_10   │ 2025-02-21 15:17:09 │    10 │      255 │ 2.29 MiB         │
│ 202409_31493_31519_6    │ 2025-02-21 15:17:04 │     6 │      245 │ 2.22 MiB         │
│ 202412_38467_38498_10   │ 2025-02-21 15:17:57 │    10 │      223 │ 2.04 MiB         │
│ 202406_29348_29383_8    │ 2025-02-21 15:16:54 │     8 │      172 │ 1.66 MiB         │
│ 202501_52846_52931_17   │ 2025-02-21 15:18:11 │    17 │      154 │ 1.50 MiB         │
│ 202411_35203_35208_2    │ 2025-02-21 15:17:04 │     2 │      155 │ 1.39 MiB         │
│ 202408_30404_30414_3    │ 2025-02-21 15:17:04 │     3 │      148 │ 1.39 MiB         │
│ 202402_27413_27458_10   │ 2025-02-21 15:17:03 │    10 │      109 │ 1.06 MiB         │
│ 202406_29384_29394_3    │ 2025-02-21 15:17:02 │     3 │      109 │ 1.01 MiB         │
│ 202403_27993_28003_3    │ 2025-02-21 15:17:07 │     3 │      107 │ 1.00 MiB         │
│ 202401_27105_27130_6    │ 2025-02-21 15:16:41 │     6 │       95 │ 959.62 KiB       │
│ 202407_29869_29874_2    │ 2025-02-21 15:17:08 │     2 │       65 │ 610.23 KiB       │
│ 202502_117618_117623_2  │ 2025-02-21 15:18:12 │     2 │       58 │ 592.07 KiB       │
│ 2023_28432_28503_18     │ 2025-02-21 14:37:33 │    18 │       55 │ 418.32 KiB       │
│ 202411_35209_35209_1    │ 2025-02-21 15:17:06 │     1 │       30 │ 292.13 KiB       │
│ 202404_28013_28018_2    │ 2025-02-21 15:17:09 │     2 │       26 │ 260.72 KiB       │
│ 2023_28570_28605_8      │ 2025-02-21 15:16:40 │     8 │       23 │ 235.50 KiB       │
│ 202409_31520_31520_1    │ 2025-02-21 15:17:06 │     1 │       22 │ 215.35 KiB       │
│ 202408_30415_30415_1    │ 2025-02-21 15:17:05 │     1 │       18 │ 181.10 KiB       │
│ 202502_117625_117625_1  │ 2025-02-21 15:18:13 │     1 │       15 │ 157.82 KiB       │
│ 202502_117624_117624_1  │ 2025-02-21 15:18:13 │     1 │       15 │ 157.82 KiB       │
│ 202407_29875_29875_1    │ 2025-02-21 15:17:08 │     1 │       15 │ 146.78 KiB       │
│ 202406_29396_29396_1    │ 2025-02-21 15:17:05 │     1 │       12 │ 123.11 KiB       │
│ 202406_29395_29395_1    │ 2025-02-21 15:17:03 │     1 │       12 │ 123.11 KiB       │
│ 202407_29877_29877_1    │ 2025-02-21 15:17:09 │     1 │        8 │ 83.30 KiB        │
│ 202407_29876_29876_1    │ 2025-02-21 15:17:09 │     1 │        8 │ 83.30 KiB        │
│ 202403_28004_28004_1    │ 2025-02-21 15:17:08 │     1 │        5 │ 53.73 KiB        │
│ 2023_28606_28606_1      │ 2025-02-21 15:16:41 │     1 │        3 │ 33.79 KiB        │
│ 202412_38499_38503_2    │ 2025-02-21 15:18:07 │     2 │        3 │ 33.73 KiB        │
│ 202405_28569_28569_1    │ 2025-02-21 15:17:09 │     1 │        3 │ 31.34 KiB        │
│ 202410_33742_33742_1    │ 2025-02-21 15:17:07 │     1 │        2 │ 23.34 KiB        │
│ 202410_33741_33741_1    │ 2025-02-21 15:17:07 │     1 │        2 │ 23.34 KiB        │
│ 202402_27459_27459_1    │ 2025-02-21 15:17:04 │     1 │        2 │ 23.26 KiB        │
│ 202402_27460_27460_1    │ 2025-02-21 15:17:06 │     1 │        2 │ 23.26 KiB        │
│ 202409_31522_31522_1    │ 2025-02-21 15:17:08 │     1 │        2 │ 23.12 KiB        │
│ 202409_31521_31521_1    │ 2025-02-21 15:17:08 │     1 │        2 │ 23.12 KiB        │
│ 202501_52933_52933_1    │ 2025-02-21 15:18:13 │     1 │        1 │ 13.35 KiB        │
│ 202501_52934_52934_1    │ 2025-02-21 15:18:14 │     1 │        1 │ 13.35 KiB        │
│ 202501_52932_52932_1    │ 2025-02-21 15:18:11 │     1 │        1 │ 13.31 KiB        │
│ 202401_27132_27132_1    │ 2025-02-21 15:16:45 │     1 │        1 │ 13.12 KiB        │
│ 202401_27133_27133_1    │ 2025-02-21 15:16:46 │     1 │        1 │ 13.12 KiB        │
│ 2023_28607_28607_1      │ 2025-02-21 15:16:41 │     1 │        1 │ 13.11 KiB        │
│ 202403_28005_28005_1    │ 2025-02-21 15:17:08 │     1 │        1 │ 13.04 KiB        │
│ 202403_28006_28006_1    │ 2025-02-21 15:17:09 │     1 │        1 │ 13.04 KiB        │
│ 202406_29398_29398_1    │ 2025-02-21 15:17:09 │     1 │        1 │ 12.97 KiB        │
│ 202406_29397_29397_1    │ 2025-02-21 15:17:08 │     1 │        1 │ 12.97 KiB        │
│ 202401_27131_27131_1    │ 2025-02-21 15:16:41 │     1 │        1 │ 12.97 KiB        │
│ 202410_33744_33744_1    │ 2025-02-21 15:17:09 │     1 │        1 │ 12.94 KiB        │
│ 202410_33743_33743_1    │ 2025-02-21 15:17:09 │     1 │        1 │ 12.94 KiB        │
│ 202403_27907_27907_1    │ 2025-02-21 14:56:40 │     1 │        1 │ 12.73 KiB        │
└─────────────────────────┴─────────────────────┴───────┴──────────┴──────────────────┘

111 rows in set. Elapsed: 0.003 sec.



WITH
    'applied_ai' AS db_name,
    'transaction_canonical_embeddings' AS table_name,
    600 AS interval_seconds,
    (SELECT uuid FROM system.tables WHERE database = db_name and name = table_name) AS table_id,
    (now() - INTERVAL 15 Hours) AS start_time,
    T1 AS (
        SELECT
            hostName() AS hostname,
            toStartOfInterval(event_time, toIntervalSecond(interval_seconds)) AS t,
            dateDiff('second', toStartOfInterval(start_time, toIntervalSecond(interval_seconds)), t) AS seconds,
            max(value) as parts
        FROM clusterAllReplicas(default, merge('system', 'asynchronous_metric_log*'))
        WHERE event_time >= start_time
        AND metric = 'TotalPartsOfMergeTreeTables'
        GROUP BY t, hostname
        ORDER BY t DESC, hostname
        ),
    T2 AS (
        SELECT
            DENSE_RANK() OVER(ORDER BY hostname) AS host_id,
            t,
            seconds,
            parts
        FROM T1
        ORDER BY t DESC, host_id
        ),
    T3 AS (
        SELECT
            t,
            seconds,
            min(parts) as parts_min,
            max(parts) as parts_max
        FROM T2
        GROUP BY t, seconds
        ORDER BY t DESC
    )
SELECT * FROM T3
SETTINGS skip_unavailable_shards = 1;



WITH
    'applied_ai' AS db_name,
    'transaction_canonical_embeddings' AS table_name,
    600 AS interval_seconds, -- NEED TO CHANGE FILL STEP accordingly - see WITH FILL STEP below
    (SELECT uuid FROM system.tables WHERE database = db_name and name = table_name) AS table_id,
    (now() - INTERVAL 15 Hours) AS start_time,
    T1 AS (
        SELECT
            toStartOfInterval(event_time, toIntervalSecond(interval_seconds)) AS t,
            countIf(event_type != 'RemovePart') as add_events,
            countIf(event_type = 'RemovePart') as remove_events
        FROM
            system.part_log
        WHERE
            table_uuid = table_id
        GROUP BY
            t
        ORDER BY t ASC WITH FILL STEP (60)
    ),
    T2 AS (
        SELECT
            groupArray(t) AS t,
            groupArrayMovingSum(add_events) AS add_events,
            groupArrayMovingSum(remove_events) AS remove_events
        FROM T1
    ),
    T3 AS (
        SELECT
            t,
            arrayMap(e -> e.1 - e.2, arrayZip(add_events, remove_events)) as parts
        FROM T2
    )
SELECT
    t,
    dateDiff('second', toStartOfInterval(start_time, toIntervalSecond(interval_seconds)), t) AS seconds,
    parts
FROM T3
ARRAY JOIN
    t,
    parts
ORDER BY t DESC;



```sql
SELECT
    partition_id,
    count() AS num_parts,
    formatReadableSize(max(data_compressed_bytes)) AS max_part_size,
    formatReadableSize(sum(data_compressed_bytes)) AS total_compressed_bytes,
    countIf(data_compressed_bytes > 120000000000) AS `parts > 120GB`
FROM system.parts
WHERE (`table` = 'transaction_canonical_embeddings') AND active
GROUP BY partition_id
ORDER BY partition_id ASC

Query id: a2df194c-4ef7-43b9-8c83-2a9a72a658e6

┌─partition_id─┬─num_parts─┬─max_part_size─┬─total_compressed_bytes─┬─parts > 120GB─┐
│ 2019         │         1 │ 46.88 MiB     │ 46.88 MiB              │             0 │
│ 2020         │         1 │ 2.23 GiB      │ 2.23 GiB               │             0 │
│ 2021         │         1 │ 33.63 GiB     │ 33.63 GiB              │             0 │
│ 2022         │         4 │ 119.89 GiB    │ 295.25 GiB             │             2 │
│ 2023         │        11 │ 137.18 GiB    │ 792.82 GiB             │             4 │
│ 202401       │         4 │ 34.25 GiB     │ 34.25 GiB              │             0 │
│ 202402       │         7 │ 36.10 GiB     │ 36.10 GiB              │             0 │
│ 202403       │         5 │ 39.27 GiB     │ 39.27 GiB              │             0 │
│ 202404       │         5 │ 42.50 GiB     │ 42.51 GiB              │             0 │
│ 202405       │         3 │ 45.84 GiB     │ 45.84 GiB              │             0 │
│ 202406       │         6 │ 45.42 GiB     │ 45.42 GiB              │             0 │
│ 202407       │         6 │ 47.41 GiB     │ 47.42 GiB              │             0 │
│ 202408       │         5 │ 51.37 GiB     │ 51.37 GiB              │             0 │
│ 202409       │         7 │ 56.87 GiB     │ 56.88 GiB              │             0 │
│ 202410       │         5 │ 63.30 GiB     │ 63.32 GiB              │             0 │
│ 202411       │         5 │ 56.79 GiB     │ 56.80 GiB              │             0 │
│ 202412       │         4 │ 57.24 GiB     │ 57.25 GiB              │             0 │
│ 202501       │         6 │ 64.25 GiB     │ 64.29 GiB              │             0 │
│ 202502       │        15 │ 43.25 GiB     │ 43.79 GiB              │             0 │
└──────────────┴───────────┴───────────────┴────────────────────────┴───────────────┘

19 rows in set. Elapsed: 0.004 sec.
```

issue remains, parts get big and duplicates accumulate?





original (prod)
https://grafana.us-east-2.aws.clickhouse-prd.com/d/eebgzyow916gwd/ramp-advanced-dashboard?orgId=1&from=2025-02-11T16:40:00.000Z&to=2025-02-11T18:40:00.000Z&timezone=utc&var-datasource=loghouse-production-aws-us-east-1&var-spokenName=cobalt-nc-28&var-rounding=60&var-region=us-east-1

test (no changes)

https://grafana.us-east-2.aws.clickhouse-prd.com/d/cectw0fb2xddse/ramp-advanced-dashboard-test-bed?orgId=1&from=2025-02-11T20:40:00.000Z&to=2025-02-11T22:25:00.000Z&timezone=utc&var-datasource=loghouse-production-aws-us-east-1&var-spokenName=magenta-qd-44&var-rounding=60&var-region=us-east-1&tab=queries

no cache on core

https://grafana.us-east-2.aws.clickhouse-prd.com/d/cectw0fb2xddse/ramp-advanced-dashboard-test-bed?orgId=1&from=2025-02-12T17:45:00.000Z&to=2025-02-12T19:55:00.000Z&timezone=utc&var-datasource=loghouse-production-aws-us-east-1&var-spokenName=magenta-qd-44&var-rounding=60&var-region=us-east-1&tab=queries&showCategory=Override%202

bfloat16 no cache on core
https://grafana.us-east-2.aws.clickhouse-prd.com/d/cectw0fb2xddse/ramp-advanced-dashboard-test-bed?orgId=1&from=2025-02-13T12:05:00.000Z&to=2025-02-13T14:05:00.000Z&timezone=utc&var-datasource=loghouse-production-aws-us-east-1&var-spokenName=magenta-qd-44&var-rounding=60&var-region=us-east-1&tab=queries&showCategory=Override%202


bfloat16 - cold start on bfloat16

https://grafana.us-east-2.aws.clickhouse-prd.com/d/cectw0fb2xddse/ramp-advanced-dashboard-test-bed?orgId=1&from=2025-02-13T21:45:00.000Z&to=2025-02-13T23:15:00.000Z&timezone=utc&var-datasource=loghouse-production-aws-us-east-1&var-spokenName=magenta-qd-44&var-rounding=60&var-region=us-east-1&tab=queries&showCategory=Override%202


bfloat16 - no cache on core - warmed AND 2 nodes

https://grafana.us-east-2.aws.clickhouse-prd.com/d/cectw0fb2xddse/ramp-advanced-dashboard-test-bed?orgId=1&from=2025-02-18T19:40:00.000Z&to=2025-02-18T21:40:00.000Z&timezone=utc&var-datasource=loghouse-production-aws-us-east-1&var-spokenName=magenta-qd-44&var-rounding=60&var-region=us-east-1&tab=queries&showCategory=Override%202

no cache on core, 3 nodes, partionned, warmed and 3 nodes

https://grafana.us-east-2.aws.clickhouse-prd.com/d/cectw0fb2xddse/ramp-advanced-dashboard-test-bed?orgId=1&from=2025-02-20T15:00:00.000Z&to=2025-02-20T17:00:00.000Z&timezone=utc&var-datasource=loghouse-production-aws-us-east-1&var-spokenName=magenta-qd-44&var-rounding=60&var-region=us-east-1&tab=queries&showCategory=Override%202


cache on core , 3 nodes, partionned, warmed and 3 nodes

https://grafana.us-east-2.aws.clickhouse-prd.com/d/cectw0fb2xddse/ramp-advanced-dashboard-test-bed?orgId=1&from=2025-02-20T17:55:00.000Z&to=2025-02-20T19:55:00.000Z&timezone=utc&var-datasource=loghouse-production-aws-us-east-1&var-spokenName=magenta-qd-44&var-rounding=60&var-region=us-east-1&tab=queries&showCategory=Override%202



SELECT
    vector_field,
    non_gl_category_blob,
    amount,
    bill_line_item_log_entry_id,
    tracking_category_option_remote_name,
    tracking_category_option_id,
    tracking_category_id,
    business_id,
    accounting_provider_access_id
FROM applied_ai.prod_bill_pay_categorization
FORMAT `Null`


SELECT
    bfloat16_embedding_for_accounting_matching,
    accounting_tracking_category_selections,
    user_transaction_time,
    id,
    merchant_name,
    version,
    sync_ready_status,
    business_id,
    accounting_is_gl_tc_coded
FROM applied_ai.transaction_canonical_embeddings
FORMAT `Null`

c-magenta-qd-44-server-i14soiy-0
c-magenta-qd-44-server-28gf258-0
c-magenta-qd-44-server-1lvhe31-0


SELECT
    toStartOfMonth(user_transaction_time) AS month,
    count() AS c,
    uniqExact(business_id, user_transaction_time, id) AS uniq,
    round(c / uniq, 2) AS duplicate_ratio
FROM applied_ai.transaction_canonical_embeddings
GROUP BY month
ORDER BY month ASC




applied_ai.transaction_canonical_receipt_matching_mv -> applied_ai.transaction_canonical_receipt_matching
transaction_canonical_embeddings_mv -> applied_ai.transaction_canonical.embeddings


raw.applied_ai.transaction_canonical.merchant_merging
raw.applied_ai.transaction_canonical.merchant_merging


┌─database───┬─table────────────────────────────────────────────────┬─max(modification_time)─┐
│ raw        │ rds_core.payee.payee                                 │    2025-02-21 10:01:37 │
│ raw        │ enriched.location.results                            │    2025-02-21 12:49:02 │
│ raw        │ applied_ai.transaction_canonical.embeddings          │    2025-02-21 22:09:54 │
│ applied_ai │ transaction_canonical_merchant_merging_for_centroids │    2025-02-21 22:11:03 │
│ raw        │ applied_ai.reimbursement.embeddings                  │    2025-02-21 22:09:53 │
│ olap       │ enriched_cards                                       │    2025-02-21 10:49:18 │
│ applied_ai │ transaction_canonical_embeddings_partitioned         │    2025-02-21 12:26:21 │
│ raw        │ applied_ai.transaction_canonical.merchant_merging    │    2025-02-21 22:11:03 │
│ raw        │ enriched.tracking_category_option.results            │    2025-02-21 14:10:05 │
│ applied_ai │ transaction_canonical_embeddings                     │    2025-02-21 22:10:43 │
│ raw        │ applied_ai.transaction_review_action.embeddings      │    2025-02-21 22:02:01 │
│ applied_ai │ transaction_review_action_embeddings                 │    2025-02-21 22:02:01 │
│ raw        │ applied_ai.expense_policy_document.embeddings        │    2025-02-21 19:03:51 │
│ applied_ai │ reimbursement_embeddings                             │    2025-02-21 22:09:53 │
│ olap       │ payee_payee                                          │    2025-02-20 01:16:35 │
│ applied_ai │ expense_policy_document_embeddings                   │    2025-02-21 19:02:52 │
│ olap       │ enriched_spend_allocations                           │    2025-02-21 21:18:12 │
│ olap       │ developer.request.audit_log                          │    2025-02-20 10:00:13 │
│ olap       │ realtime_search_index                                │    2025-02-20 14:53:48 │
│ raw        │ applied_ai.transaction_canonical.receipt_matching    │    2025-02-21 22:10:29 │
│ raw        │ enriched.spend_event.results                         │    2025-02-21 00:25:16 │
│ olap       │ search_index                                         │    2025-02-20 22:19:29 │
│ applied_ai │ transaction_canonical_merchant_merging               │    2025-02-21 22:11:03 │
│ applied_ai │ transaction_canonical_receipt_matching               │    2025-02-21 22:10:29 │
└────────────┴──────────────────────────────────────────────────────┴────────────────────────┘

raw.`applied_ai.reimbursement.embeddings`
raw.`applied_ai.transaction_canonical.embeddings`
raw.applied_ai.transaction_canonical.receipt_matching
applied_ai.transaction_review_action.embeddings


CREATE TABLE `applied_ai.transaction_canonical.merchant_merging_v2` EMPTY AS `applied_ai.transaction_canonical.merchant_merging` ENGINE = Null


CREATE TABLE `developer.request.audit_log_v2` EMPTY AS `developer.request.audit_log` ENGINE = Null

CREATE TABLE `enriched.card.results_v2` EMPTY AS `enriched.card.results` ENGINE = Null
CREATE TABLE `enriched.department.results_v2` EMPTY AS `enriched.department.results` ENGINE = Null
CREATE TABLE `enriched.event_log.results_v2` EMPTY AS `enriched.event_log.results` ENGINE = Null
CREATE TABLE `enriched.itinerary.results_v2` EMPTY AS `enriched.itinerary.results` ENGINE = Null
CREATE TABLE `enriched.location.results_v2` EMPTY AS `enriched.location.results` ENGINE = Null
CREATE TABLE `enriched.merchant.ramp_ql.results_v2` EMPTY AS `enriched.merchant.ramp_ql.results` ENGINE = Null
CREATE TABLE `enriched.merchant.results_v2` EMPTY AS `enriched.merchant.results` ENGINE = Null
CREATE TABLE `enriched.payee.results_v2` EMPTY AS `enriched.payee.results` ENGINE = Null
CREATE TABLE `enriched.spend_allocation.ramp_ql.results_v2` EMPTY AS `enriched.spend_allocation.ramp_ql.results` ENGINE = Null
CREATE TABLE `enriched.spend_allocation.results_v2` EMPTY AS `enriched.spend_allocation.results` ENGINE = Null
CREATE TABLE `enriched.spend_event.ramp_ql.results_v2` EMPTY AS `enriched.spend_event.ramp_ql.results` ENGINE = Null
CREATE TABLE `enriched.spend_event.results_v2` EMPTY AS `enriched.spend_event.results` ENGINE = Null
CREATE TABLE `enriched.tracking_category_option.results_v2` EMPTY AS `enriched.tracking_category_option.results` ENGINE = Null
CREATE TABLE `rds_core.travel.trip_v2` EMPTY AS `rds_core.travel.trip` ENGINE = Null
CREATE TABLE `enriched.trip.ramp_ql.results_v2` EMPTY AS `enriched.trip.ramp_ql.results` ENGINE = Null
CREATE TABLE `enriched.user.ramp_ql.results_v2` EMPTY AS `enriched.user.ramp_ql.results` ENGINE = Null
CREATE TABLE `latency_test.transaction.transaction_canonical_v2` EMPTY AS `latency_test.transaction.transaction_canonical` ENGINE = Null
CREATE TABLE `rds_core.accounting.tracking_category_option_v2` EMPTY AS `rds_core.accounting.tracking_category_option` ENGINE = Null
CREATE TABLE `rds_core.payee.payee_v2` EMPTY AS `rds_core.payee.payee` ENGINE = Null
create table `compression_test.transaction.transaction_canonical_v2` EMPTY AS `compression_test.transaction.transaction_canonical` ENGINE = Null
CREATE TABLE `rds_core.profile.users_v2` EMPTY AS `rds_core.profile.users` ENGINE = Null
CREATE TABLE `rds_core.spend_allocation.spend_allocations_v2` EMPTY AS `rds_core.spend_allocation.spend_allocations` ENGINE = Null


EXCHANGE TABLES `developer.request.audit_log_v2` AND `developer.request.audit_log` 
EXCHANGE TABLES `enriched.card.results_v2` AND `enriched.card.results` 
EXCHANGE TABLES `enriched.department.results_v2` AND `enriched.department.results` 
EXCHANGE TABLES `enriched.event_log.results_v2` AND `enriched.event_log.results` 
EXCHANGE TABLES `enriched.itinerary.results_v2` AND `enriched.itinerary.results` 
EXCHANGE TABLES `enriched.location.results_v2` AND `enriched.location.results` 
EXCHANGE TABLES `enriched.merchant.ramp_ql.results_v2` AND `enriched.merchant.ramp_ql.results` 

EXCHANGE TABLES `enriched.merchant.results_v2` AND `enriched.merchant.results` 
EXCHANGE TABLES `enriched.payee.results_v2` AND `enriched.payee.results` 
EXCHANGE TABLES `enriched.spend_allocation.ramp_ql.results_v2` AND `enriched.spend_allocation.ramp_ql.results` 
EXCHANGE TABLES `enriched.spend_allocation.results_v2` AND `enriched.spend_allocation.results` 

EXCHANGE TABLES `enriched.spend_event.ramp_ql.results_v2` AND `enriched.spend_event.ramp_ql.results` 
EXCHANGE TABLES `enriched.spend_event.results_v2` AND `enriched.spend_event.results` 
EXCHANGE TABLES `enriched.tracking_category_option.results_v2` AND `enriched.tracking_category_option.results` 
EXCHANGE TABLES `rds_core.travel.trip_v2` AND `rds_core.travel.trip` 
EXCHANGE TABLES `enriched.trip.ramp_ql.results_v2` AND `enriched.trip.ramp_ql.results` 
EXCHANGE TABLES `enriched.user.ramp_ql.results_v2` AND `enriched.user.ramp_ql.results` 
EXCHANGE TABLES `latency_test.transaction.transaction_canonical_v2` AND `latency_test.transaction.transaction_canonical` 
EXCHANGE TABLES `rds_core.accounting.tracking_category_option_v2` AND `rds_core.accounting.tracking_category_option` 
EXCHANGE TABLES `rds_core.payee.payee_v2` AND `rds_core.payee.payee` 
EXCHANGE TABLES  `compression_test.transaction.transaction_canonical_v2` AND `compression_test.transaction.transaction_canonical` 
EXCHANGE TABLES `rds_core.profile.users_v2` AND `rds_core.profile.users` 
EXCHANGE TABLES `rds_core.spend_allocation.spend_allocations_v2` AND `rds_core.spend_allocation.spend_allocations` 








