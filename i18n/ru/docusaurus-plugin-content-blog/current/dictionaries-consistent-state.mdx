---
title: Почему я не вижу свои данные в словаре в ClickHouse Cloud?
description: Возможна ситуация, когда данные в словарях не отображаются сразу после их создания.
date: 2024-04-12
tags: ['Управление облаком', 'Моделирование данных']
keywords: ['Словари']
---

{frontMatter.description}

{/* усечено */}

## Словари в ClickHouse \{#dictionaries-in-clickhouse\}

Словари, создаваемые в ClickHouse Cloud, на этапе первоначального создания могут находиться в неконсистентном состоянии. Это означает, что сразу после создания вы можете не увидеть в словаре никаких данных. Однако после нескольких повторных попыток запрос на создание может попасть на другие реплики, и данные станут видны.

Иногда это происходит из-за того, что словарь был создан до того, как часть дошла до сервера. Например:

```
2024-01-25 13:38:25.615837 - Получена команда CREATE DICTIONARY
2024-01-25 13:38:25.626468 - Команда CREATE DICTIONARY выполнена
2024-01-25 13:38:25.733008 - Часть all_0_0_0 загружена
```

Как видно, часть данных поступила только после того, как словарь был создан. Это может стать более серьёзной проблемой, если вы используете `LIFETIME(MIN 0 MAX 0)`, потому что в этом случае словарь никогда не будет автоматически обновляться. В результате словарь останется пустым до тех пор, пока не будет выполнена команда `RELOAD DICTIONARIES`.

Решение этой проблемы — использовать запрос `SELECT` вместо указания исходной таблицы при создании словаря и включить настройку `select_sequential_consistency=1`.

Вместо указания исходной таблицы:

```sql
SOURCE(CLICKHOUSE(
    table 'test.temp_title_table_1706189903924'
    user default password 'PASSWORD'))
```

Выполните запрос `SELECT` с `select_sequential_consistency=1`:

```sql
SOURCE(CLICKHOUSE(QUERY
    'SELECT songTitle, mappedTitle
    FROM test.temp_title_table_1706189903924
    SETTINGS select_sequential_consistency=1' USER default PASSWORD ''))
```

## Почему возникает эта проблема? \{#why-does-this-issue-occur\}

Когда вы вставляете данные, а затем создаёте или перезагружаете словарь, DDL-запрос может попасть на реплику раньше, чем сами данные (или новые данные). В результате словари на разных репликах оказываются несогласованными, и в зависимости от того, какая реплика получит запрос, вы можете получить разные результаты.

Обратите внимание, что то же самое происходит, когда вы выполняете вставку и сразу после этого читаете из таблицы. Если вы читаете с реплики, которая ещё не получила реплицированные данные, вы не увидите только что вставленные данные. Когда вам нужна последовательная согласованность за счёт производительности (поэтому обычно не рекомендуется её использовать), вы можете включить `select_sequential_consistency`.

Случай со словарями немного сложнее, поскольку словари не используют настройки из самого запроса, а берут настройки с сервера. В результате при загрузке данных в словарь, даже если вы выполните `SET select_sequential_consistency=1`, данные могут загружаться несогласованно на разных репликах. Указание `select_sequential_consistency=1` в запросе-источнике словаря позволяет словарю соблюдать эту настройку, даже если она не включена глобально как серверная настройка.