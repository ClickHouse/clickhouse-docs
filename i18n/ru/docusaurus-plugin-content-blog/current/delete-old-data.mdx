---
title: Можно ли удалить старые записи из таблицы ClickHouse?
description: "Краткий ответ — «да». В ClickHouse есть несколько механизмов, которые позволяют освободить место на диске за счёт удаления старых данных. Каждый из них предназначен для своих сценариев использования."
date: 2022-10-19
tags: ['Удаление данных']
keywords: ['Удалить старые записи']
---

{frontMatter.description}

{/* усечение */}


## Краткий ответ — «да» \{#the-short-answer-is-yes\}

Краткий ответ — «да». В ClickHouse есть несколько механизмов, которые позволяют освобождать место на диске за счет удаления старых данных. Каждый из них предназначен для различных сценариев.

## TTL \{#ttl\}

ClickHouse позволяет автоматически удалять данные при выполнении определённого условия. Это условие настраивается как выражение на основе любых столбцов, обычно — как статическое смещение относительно столбца с временной меткой.

Ключевое преимущество этого подхода в том, что для него не требуется какая-либо внешняя система-триггер: как только TTL настроен, удаление данных автоматически выполняется в фоновом режиме.

:::note
TTL можно использовать не только для удаления данных в [/dev/null](https://en.wikipedia.org/wiki/Null_device), но и для их перемещения между различными системами хранения, например, с SSD на HDD.
:::

Подробнее о [настройке TTL](https://clickhouse.com/docs/engines/table-engines/mergetree-family/mergetree#table_engine-mergetree-ttl).

## DELETE FROM

[DELETE FROM](https://clickhouse.com/docs/sql-reference/statements/delete) позволяет выполнять стандартные запросы DELETE в ClickHouse. Строки, отобранные фильтрующим выражением, помечаются как удалённые и не попадают в будущие наборы результатов. Очистка строк выполняется асинхронно.

:::note
DELETE FROM находится в общем доступе, начиная с версии 23.3. В более старых версиях он является экспериментальной функцией и должен быть включён с помощью:

```
SET allow_experimental_lightweight_delete = true;
```

:::


## ALTER DELETE \{#alter-delete\}

ALTER DELETE удаляет строки с помощью асинхронных пакетных операций. В отличие от DELETE FROM, запросы, выполняемые после ALTER DELETE и до завершения пакетных операций, будут включать строки, предназначенные для удаления. Подробнее см. документацию по [ALTER DELETE](https://clickhouse.com/docs/sql-reference/statements/alter/delete).

`ALTER DELETE` можно использовать для гибкого удаления старых данных. Если вам нужно выполнять это регулярно, основным недостатком будет необходимость во внешней системе, которая будет отправлять запрос. Также следует учитывать влияние на производительность, поскольку мутации переписывают целые части данных, даже если нужно удалить всего одну строку.

Это наиболее распространённый подход для того, чтобы сделать вашу систему на базе ClickHouse совместимой с требованиями [GDPR](https://gdpr-info.eu).

Подробнее о [мутациях](https://clickhouse.com/docs/sql-reference/statements/alter/#alter-mutations).

## DROP PARTITION \{#drop-partition\}

`ALTER TABLE ... DROP PARTITION` предоставляет менее затратный способ удаления целого раздела. Этот подход не слишком гибкий и требует корректной схемы партиционирования, заданной при создании таблицы, но при этом покрывает большинство распространённых сценариев. Как и мутации, для регулярного использования его следует запускать из внешней системы.

Подробнее об [операциях с разделами](https://clickhouse.com/docs/sql-reference/statements/alter/partition/#alter_drop-partition).

## TRUNCATE \{#truncate\}

Удаление всех данных из таблицы — достаточно радикальный шаг, но в некоторых случаях это может быть именно тем, что вам нужно.

Подробнее об [операции TRUNCATE](https://clickhouse.com/docs/sql-reference/statements/truncate).