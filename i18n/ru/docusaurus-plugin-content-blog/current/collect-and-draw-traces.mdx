---
date: 2025-12-30
title: Как собирать и визуализировать трассировку запроса
tags: ['Инструменты и утилиты']
keywords: ['трассировка запроса', 'OTel', 'Grafana']
description: "В этом руководстве показано, как собирать и визуализировать трассировки запросов в самоуправляемом ClickHouse с использованием встроенных средств или Grafana. Это особенно полезно при работе со сложными запросами, когда требуется понять внутреннюю механику выполнения, выходящую за рамки информации, доступной через EXPLAIN."
---

import Image from '@theme/IdealImage';
import trace_visualizer from '@site/static/images/knowledgebase/trace-visualizer-example.png';
import trace_visualization_grafana from '@site/static/images/knowledgebase/trace-visualization-grafana.png';
import trace_visualization_diagram from '@site/static/images/knowledgebase/trace-visualization-diagram.png';

{frontMatter.description}

{{/* сокращено */}}

<br />

<br />

**Предварительные требования**:

* Знакомство с [конфигурационными файлами](/operations/configuration-files) ClickHouse
* Запущенный экземпляр [сервера ClickHouse](/install)
* (необязательно) Запущенный локальный [инстанс Grafana](https://grafana.com/docs/grafana/latest/fundamentals/getting-started/)

<VerticalStepper headerLevel="h2">
  ## Проверьте, что системная таблица `opentelemetry_span_log` включена \{#enable-system-table\}

  Если вы не вносили изменения в секцию `opentelemetry_span_log` файла `config.xml`, этот шаг можно пропустить.

  Откройте стандартный файл конфигурации ClickHouse `config.xml` и найдите следующий раздел:

  ```yaml
  <!--
      OpenTelemetry log contains OpenTelemetry trace spans.

      NOTE: this table does not use standard schema with event_date and event_time!
  -->
  <opentelemetry_span_log>
      <!--
          The default table creation code is insufficient, this <engine> spec
          is a workaround. There is no 'event_time' for this log, but two times,
          start and finish. It is sorted by finish time, to avoid inserting
          data too far away in the past (probably we can sometimes insert a span
          that is seconds earlier than the last span in the table, due to a race
          between several spans inserted in parallel). This gives the spans a
          global order that we can use to e.g. retry insertion into some external
          system.
      -->
      <engine>
          engine MergeTree
          partition by toYYYYMM(finish_date)
          order by (finish_date, finish_time_us, trace_id)
      </engine>
      <database>system</database>
      <table>opentelemetry_span_log</table>
      <flush_interval_milliseconds>7500</flush_interval_milliseconds>
      <max_size_rows>1048576</max_size_rows>
      <reserved_size_rows>8192</reserved_size_rows>
      <buffer_size_rows_flush_threshold>524288</buffer_size_rows_flush_threshold>
      <flush_on_crash>false</flush_on_crash>
  </opentelemetry_span_log>
  ```

  Убедитесь, что она не закомментирована, иначе вы не сможете увидеть `system.opentelemetry_span_log` на следующих шагах.
  Это также может быть причиной, если ваш сервер ClickHouse не использует конфигурационный файл по умолчанию.

  Проверьте логи сервера на наличие записей следующего вида:

  ```text
  Processing configuration file 'config.xml'.
  There is no file 'config.xml', will use embedded config.
  ```

  :::tip
  При стандартной установке этот файл расположен по пути `/etc/clickhouse-server/config.xml`
  :::

  ## Включить трассировку OpenTelemetry \{#enable-otel-tracing\}

  При запущенном сервере ClickHouse откройте клиент ClickHouse и включите сбор трассировок следующим запросом:

  ```bash
  SET opentelemetry_trace_processors=1;
  ```

  Теперь вы увидите системную таблицу `opentelemetry_span_log`, если выполните:

  ```sql
  SHOW TABLES IN system
  ```

  Далее выполните:

  ```
  SET opentelemetry_start_trace_probability=1;
  ```

  Это задаёт вероятность того, что ClickHouse запустит трассировку для выполняемых запросов, где
  `1` означает, что трассировка включена для всех выполняемых запросов.

  ## Получение ID запроса \{#obtain-query-id\}

  Выполните следующий тестовый запрос или запрос, трассировку которого вы хотите выполнить:

  ```sql
  SELECT pow(number, 2) FROM numbers(10E4);
  ```

  Скопируйте идентификатор запроса:

  ```sql
  :) SELECT pow(number, 2) FROM numbers(10E4);

  SELECT pow(number, 2)
  FROM numbers(100000.)

  --highlight-next-line
  Query id: a9241258-a0c4-4776-a00b-e6a1d9bec4a1
  ```

  ## Генерация файла трассировки \{#generate-trace-file\}

  Выполните следующий запрос, подставив идентификатор запроса, полученный на предыдущем шаге:

  ```sql
  WITH 'a9241258-a0c4-4776-a00b-e6a1d9bec4a1' AS my_query_id
  SELECT
      concat(substring(hostName(), length(hostName()), 1), leftPad(greatest(attribute['clickhouse.thread_id'], attribute['thread_number']), 5, '0')) AS group,
      operation_name,
      start_time_us,
      finish_time_us,
      sipHash64(operation_name) AS color,
      attribute
  FROM system.opentelemetry_span_log
  WHERE (trace_id IN (
      SELECT trace_id
      FROM system.opentelemetry_span_log
      WHERE (attribute['clickhouse.query_id']) = my_query_id
  )) AND (operation_name != 'query') AND (operation_name NOT LIKE 'Query%')
  ORDER BY
      hostName() ASC,
      group ASC,
      parent_span_id ASC,
      start_time_us ASC
  INTO OUTFILE 'trace.json'
  FORMAT JSON
  SETTINGS output_format_json_named_tuples_as_objects = 1
  ```

  Трассировка будет записана в файл `trace.json`.
  По умолчанию файл создается в текущем рабочем каталоге, из которого запущен инструмент clickhouse-client или clickhouse-local.

  ## Визуализация трассировки с использованием встроенных инструментов \{#visualize-trace-using-built-in-tooling\}

  Используйте размещённый визуализатор трассировок по адресу [https://trace-visualizer.clickhouse.com/](https://trace-visualizer.clickhouse.com/).
  Загрузите файл `trace.json` из предыдущего шага, чтобы визуализировать трассировку.

  <Image img={trace_visualizer} size="md" alt="Пример средства визуализации трассировок ClickHouse" />

  ## Визуализация трассировок с помощью Grafana \{#using-grafana\}

  Рекомендуется использовать Grafana для визуализации и анализа данных трассировки с помощью официального плагина ClickHouse.
  Плагин был расширен для визуализации трассировок с использованием панели Trace Panel.
  Это поддерживается как в виде визуализации, так и в виде компонента в разделе Explore.

  Следуйте инструкциям, описанным в [&quot;Using Grafana and ClickHouse for Observability&quot;](https://clickhouse.com/docs/observability/grafana),
  чтобы настроить Grafana с плагином ClickHouse.

  На вкладке Explore можно выполнить следующий запрос, заменив `trace_id` на ваш:

  ```sql
  SELECT
      toString(trace_id) AS traceID,
      toString(span_id) AS spanID,
      if(toString(parent_span_id)='0', '', toString(parent_span_id)) AS parentSpanID,
      'ClickHouse' AS serviceName,
      operation_name AS operationName,
      start_time_us/1000000 AS startTime,
      (finish_time_us - start_time_us)/1000 AS duration,
      arrayMap(key -> map('key', key, 'value', attribute[key]), mapKeys(attribute)) AS serviceTags
  FROM system.opentelemetry_span_log
  WHERE trace_id = '68a14b27-a61f-596d-3746-2b03d2530e42' ORDER BY startTime ASC
  ```

  Убедитесь, что для параметра `Query type` установлено значение `Traces`:

  <Image img={trace_visualization_grafana} size="md" alt="Визуализация трейсов ClickHouse в Grafana" />

  Нажмите &quot;Run Query&quot; и проверьте диаграмму трассировки:

  <Image img={trace_visualization_diagram} size="md" alt="Визуализация трассировок ClickHouse в Grafana" />
</VerticalStepper>