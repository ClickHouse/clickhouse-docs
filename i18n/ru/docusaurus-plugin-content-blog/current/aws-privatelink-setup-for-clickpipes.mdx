---
title: Настройка AWS PrivateLink для открытия доступа ClickPipes к приватной RDS
description: Шаги по настройке открытия доступа к приватной RDS для ClickPipes через AWS PrivateLink.
date: 2024-11-27
tags: ['Безопасность и аутентификация', 'Управление облаком']
keywords: ['AWS PrivateLink', 'Private RDS', 'ClickPipes']
---

{frontMatter.description}

{/* усечение */}

## Настройка AWS PrivateLink для предоставления доступа к приватной RDS для ClickPipes \{#aws-privatelink-setup-to-expose-private-rds-for-clickpipes\}

Шаги по настройке доступа к приватной RDS через AWS PrivateLink для ClickPipes с поддержкой межрегионального доступа.

:::info
Здесь используется AWS Endpoint Service, и такой вариант в основном подходит для межрегионального доступа. Если вам нужен доступ в том же регионе,
[создание VPC-ресурса](/integrations/clickpipes/aws-privatelink#vpc-resource)
рекомендуется вместо этого.
:::

## Создание приватного подключения \{#private-link-creation\}

Выполните следующие шаги, чтобы создать **VPC endpoint service** для вашего экземпляра RDS. Повторите эти шаги, если у вас несколько
экземпляров RDS, которым нужны endpoint services (ИЛИ если у вас разные порты listener для разных экземпляров):

1. Найдите свой VPC и [создайте NLB](https://docs.aws.amazon.com/elasticloadbalancing/latest/network/create-network-load-balancer.html)
   * Перейдите к целевому VPC и создайте Network Load Balancer (NLB). Обратите внимание, что NLB должен быть внутренним (private, internal), а не доступным из интернета (public).

2. Настройте target group

   * Target group должна указывать на IP-адрес и порт endpoint экземпляра RDS (обычно 5432 для PostgreSQL или 3306 для MySQL).

   :::note

   Если вы хотите автоматизировать процесс обновления target group новым IP-адресом endpoint RDS, вы можете использовать функции AWS Lambda или другие инструменты автоматизации.
   Один из Terraform-модулей, который можно использовать для этой цели, находится [здесь](https://github.com/MaterializeInc/terraform-aws-rds-privatelink).

   :::

   * **ВАЖНО**: Убедитесь, что endpoint экземпляра RDS, используемый в случае DB Cluster/Aurora, — это ТОЛЬКО WRITER Endpoint, а НЕ общий endpoint.
   * Убедитесь, что используется протокол TCP, чтобы избежать TLS-терминации на стороне NLB.

3. Задайте порт listener
   * Порт listener у балансировщика нагрузки должен совпадать с портом, используемым target group (обычно 5432 для PostgreSQL или 3306 для MySQL).

4. Создайте VPC endpoint service
   * В VPC создайте endpoint service, который указывает на NLB.
   * Включите принятие запросов на подключение от определённых аккаунтов.

5. Разрешите ClickPipes использовать endpoint service
   * Предоставьте аккаунту ClickPipes разрешение запрашивать этот endpoint service.
     * Настройте разрешённые principals, добавив следующий principal ID:
       ```
       arn:aws:iam::072088201116:root
       ```

6. Отключите «Enforce Security Group Inbound Rules on Private Link Traffic» на NLB (если к NLB привязана security group)
   * Перейдите в настройки NLB и отключите параметр «Enforce Security Group Inbound Rules on Private Link Traffic», если к NLB привязана security group.
   * Если вы используете Terraform, установите атрибут `enforce_security_group_inbound_rules_on_private_link_traffic` в значение `off` для NLB.
   * Эта настройка **обязательна**, чтобы разрешить трафик из VPC ClickPipes к NLB.

7. **Необязательно**: включите поддержку cross-region, если регион вашей базы данных отличается от региона ClickPipes
   * В консоли VPC в разделе `Endpoint Services` выберите ваш endpoint service.
   * Нажмите кнопку `Actions` и выберите `Modify supported Regions`.
   * Добавьте регионы, в которых вы хотите разрешить доступ к endpoint service; список регионов ClickPipes см. [здесь](/integrations/clickpipes#list-of-static-ips).

8. **Рекомендация для MySQL**
   * Если вы используете MySQL, рекомендуется установить `skip_name_resolve=1` как параметр в исходной базе данных.
     Из-за повторяющихся проверок работоспособности (health checks) со стороны NLB MySQL будет блокировать хосты NLB. Установка этого параметра полностью
     отключает поиск DNS-имён хостов, и поэтому хосты NLB никогда не блокируются. Если используется RDS, для этого потребуется перезагрузка экземпляра.

## Установление подключения \{#initiating-connection\}

Когда всё будет готово, вы можете воспользоваться руководством по [установлению подключения](/integrations/clickpipes/aws-privatelink#creating-clickpipe).

Как только в консоли в поле статуса отобразится значение `Ready`, переходите к следующему разделу, чтобы создать ClickPipe.

## Создание ClickPipes \{#creating-clickpipes\}

Используйте DNS-имя, полученное на предыдущем шаге, для [создания ClickPipe](/integrations/clickpipes/postgres).

## Динамическое обновление IP-адреса RDS endpoint \{#dynamically-updating-the-rds-endpoint-ip\}

Когда IP-адрес RDS endpoint меняется (в случае перезапусков, переключений при отказе (failover) или обновлений), необходимо обновить целевую группу NLB, указав
новый IP-адрес. Вы можете автоматизировать этот процесс с помощью функций AWS Lambda или других инструментов автоматизации.