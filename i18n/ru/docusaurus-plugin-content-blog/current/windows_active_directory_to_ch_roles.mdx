---
title: Сопоставление групп безопасности Windows Active Directory с ролями ClickHouse
description: "Пример сопоставления групп безопасности Windows Active Directory с ролями ClickHouse"
date: 2024-05-20
tags: ['Инструменты и утилиты']
keywords: ['Windows']
---

import Image from "@theme/IdealImage";
import ad_env from "@site/static/images/knowledgebase/windows-ad-ch-roles/AD_Env_and_UO_structure.png";
import ad_group from "@site/static/images/knowledgebase/windows-ad-ch-roles/AD_Group_clickhouse_ad_db1_users.png";
import ad_user from "@site/static/images/knowledgebase/windows-ad-ch-roles/AD_user_clickhouse_db1_user.png";
import ad_user_group from "@site/static/images/knowledgebase/windows-ad-ch-roles/AD_user_to_group.png";

{frontMatter.description}

{/* обрезать */}


## Пример

Этот пример показывает, как пользователям AD, принадлежащим к разным группам безопасности AD, можно предоставить доступ к ролям в ClickHouse. Также он демонстрирует, как пользователя можно добавить в несколько групп пользователей AD, чтобы он получил доступ, предоставляемый несколькими ролями.

В этой среде у нас есть следующее:

* Домен Windows Active Directory: `marsnet2.local`
* Кластер ClickHouse `cluster_1S_3R` с 3 узлами в конфигурации: 1 шард, 3 реплики
* 3 пользователя AD

| AD User                     | Описание                                               |
| --------------------------- | ------------------------------------------------------ |
| clickhouse&#95;ad&#95;admin | Пользователь-администратор ClickHouse                  |
| clickhouse&#95;db1&#95;user | Пользователь с доступом к db1.table1                   |
| clickhouse&#95;db2&#95;user | Пользователь с доступом к db2.table1                   |
| ch&#95;db1&#95;db2&#95;user | Пользователь с доступом и к db1.table1, и к db2.table1 |

* 3 группы безопасности AD

| AD Group                            | Описание                                         |
| ----------------------------------- | ------------------------------------------------ |
| clickhouse&#95;ad&#95;admins        | Группа администраторов ClickHouse                |
| clickhouse&#95;ad&#95;db1&#95;users | Группа для сопоставления с доступом к db1.table1 |
| clickhouse&#95;ad&#95;db2&#95;users | Группа для сопоставления с доступом к db2.table1 |

* Пример среды AD и структуры OU:

<Image img={ad_env} size="md" alt="Пример среды AD и структуры OU" />

* Пример конфигурации группы безопасности AD:

<Image img={ad_group} size="md" alt="Пример конфигурации группы безопасности AD" />

* Пример конфигурации пользователя AD:

<Image img={ad_user} size="md" alt="Пример конфигурации пользователя AD" />

1. В Windows AD Users and Groups добавьте каждого пользователя в соответствующие ему группы — они будут сопоставлены с ролями ClickHouse (пример в следующем шаге).

| AD Security Group           | ClickHouse Role                                                           |
| --------------------------- | ------------------------------------------------------------------------- |
| clickhouse&#95;ad&#95;admin | clickhouse&#95;ad&#95;admins                                              |
| clickhouse&#95;db1&#95;user | clickhouse&#95;ad&#95;db1&#95;users                                       |
| clickhouse&#95;db2&#95;user | clickhouse&#95;ad&#95;db2&#95;users                                       |
| ch&#95;db1&#95;db2&#95;user | clickhouse&#95;ad&#95;db1&#95;users и clickhouse&#95;ad&#95;db2&#95;users |

* Пример членства пользователя в группах:

<Image img={ad_user_group} size="md" alt="Пример членства пользователя в группах" />

2. В `config.xml` ClickHouse добавьте конфигурацию `ldap_servers` на каждый узел ClickHouse.

```
<ldap_servers>
	<marsnet2_ad>
		<host>marsdc1.marsnet2.local</host>
		<port>389</port>
		<bind_dn>{user_name}@marsnet2.local</bind_dn>
		<user_dn_detection>
			<base_dn>OU=Users,OU=ClickHouse,DC=marsnet2,DC=local</base_dn>
			<search_filter>(&amp;(objectClass=user)(sAMAccountName={user_name}))</search_filter>
		</user_dn_detection>
		<enable_tls>no</enable_tls>
	</marsnet2_ad>
</ldap_servers>
```

| xml tag                   | Описание                                                                                                                                                  | Пример значения                                     |
| ------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------- |
| ldap&#95;servers          | Тег, используемый для определения LDAP-серверов, которые будут использоваться в ClickHouse                                                                | NA                                                  |
| marsnet&#95;ad            | Этот тег произвольный и используется только как метка для идентификации сервера в секции `<user_directories>`                                             | NA                                                  |
| host                      | FQDN или IP-адрес сервера или домена Active Directory                                                                                                     | marsdc1.marsnet2.local                              |
| port                      | Порт Active Directory, обычно 389 для non-SSL или 636 для SSL                                                                                             | 389                                                 |
| bind&#95;dn               | Пользователь, который будет использоваться для установления bind к AD; это может быть отдельный пользователь, если обычным пользователям это не разрешено | `{user_name}@marsnet2.local`                        |
| user&#95;dn&#95;detection | Настройки того, как ClickHouse будет находить пользователей AD                                                                                            | NA                                                  |
| base&#95;dn               | Путь OU в AD, с которого начинается поиск пользователей                                                                                                   | OU=Users,OU=ClickHouse,DC=marsnet2,DC=local         |
| search&#95;filter         | LDAP-фильтр поиска для нахождения пользователя AD                                                                                                         | `(&(objectClass=user)(sAMAccountName={user_name}))` |

Обратитесь к документации для полного набора опций:
[https://clickhouse.com/docs/operations/external-authenticators/ldap#ldap-server-definition](https://clickhouse.com/docs/operations/external-authenticators/ldap#ldap-server-definition)

3. В `config.xml` ClickHouse добавьте конфигурацию `<user_directories>` с записями `<ldap>` на каждом узле ClickHouse.


```
<user_directories>
	<users_xml>
		<path>users.xml</path>
	</users_xml>
	<local_directory>
		<path>/var/lib/clickhouse/access/</path>
	</local_directory>
	<ldap>
		<server>marsnet2_ad</server>
		<role_mapping>
			<base_dn>OU=Groups,OU=ClickHouse,DC=marsnet2,DC=local</base_dn>
			<search_filter>(&amp;(objectClass=group)(member={user_dn}))</search_filter>
			<attribute>CN</attribute>
			<scope>subtree</scope>
			<prefix>clickhouse_</prefix>
		</role_mapping>
	</ldap>
</user_directories>
```

| xml tag              | Описание                                                                                                          | Пример значения                              |
| -------------------- | ----------------------------------------------------------------------------------------------------------------- | -------------------------------------------- |
| user&#95;directories | Определяет, какие аутентификаторы будут использоваться                                                            | NA                                           |
| ldap                 | Содержит настройки ldap-серверов, в данном случае AD, который будет использоваться                                | NA                                           |
| server               | Тег, который был определён в секции `<ldap_servers>`                                                              | marsnet2&#95;ad                              |
| role&#95;mapping     | Определение того, как аутентифицированные пользователи будут сопоставляться между группами AD и ролями ClickHouse | NA                                           |
| base&#95;dn          | Путь AD, с которого система начнёт поиск групп AD                                                                 | OU=Groups,OU=ClickHouse,DC=marsnet2,DC=local |
| search&#95;filter    | ldap-фильтр поиска для нахождения групп AD                                                                        | `(&(objectClass=group)(member={user_dn}))`   |
| attribute            | Какой атрибут AD должен использоваться для идентификации пользователя                                             | CN                                           |
| scope                | На каких уровнях в base DN система должна искать группы                                                           | subtree                                      |
| prefix               | Префикс для имён групп в AD; этот префикс будет удалён, чтобы найти соответствующие роли в ClickHouse             | clickhouse&#95;                              |

Обратитесь к документации для полного набора параметров:
[https://clickhouse.com/docs/operations/external-authenticators/ldap#ldap-external-user-directory](https://clickhouse.com/docs/operations/external-authenticators/ldap#ldap-external-user-directory)

**note:::**
Поскольку в примере группы безопасности AD имеют префикс — т.е. `clickhouse_ad_db1_users` — когда система их получит, префикс будет удалён, и система будет искать роль ClickHouse с именем `ad_db1_users`, чтобы сопоставить её с `clickhouse_ad_db1_users`.
**:::**

4. Создайте примерные базы данных.

```
create database db1 on cluster 'cluster_1S_3R';
create database db2 on cluster 'cluster_1S_3R';
```

5. Создайте таблицы‑примеры.

```
create table db1.table1 on cluster 'cluster_1S_3R'
(
  id Int32,
  column1 String
)
engine = MergeTree()
order by id;

create table db2.table1 on cluster 'cluster_1S_3R
(
  id Int32,
  column1 String
)
engine = MergeTree()
order by id;
```

6. Добавьте тестовые данные.

```
insert into db1.table1
values
(1, 'a');

insert into db2.table1
values
(2, 'b');
```

7. Создайте роли в ClickHouse.

```
create role ad_admins on cluster 'cluster_1S_3R';
create role ad_db1_users on cluster 'cluster_1S_3R';
create role ad_db2_users on cluster 'cluster_1S_3R';
```

8. Выдайте привилегии ролям.

```
GRANT SHOW, SELECT, INSERT, ALTER, CREATE, DROP, UNDROP TABLE, TRUNCATE, OPTIMIZE, BACKUP, KILL QUERY, KILL TRANSACTION, MOVE PARTITION BETWEEN SHARDS, ACCESS MANAGEMENT, SYSTEM, dictGet, displaySecretsInShowAndSelect, INTROSPECTION, SOURCES, CLUSTER ON *.* on cluster 'cluster_1S_3R' TO ad_admins WITH GRANT OPTION;

GRANT SELECT ON db1.table1 on cluster 'cluster_1S_3R' TO ad_db1_users;

GRANT SELECT ON db2.table1 on cluster 'cluster_1S_3R' TO ad_db2_users;
```

9. Проверьте доступ для пользователя db1 с ограниченными правами.
   Например:


```
root@chnode1:/etc/clickhouse-server# clickhouse-client --user clickhouse_db1_user --password MyPassword123  --secure --port 9440 --host chnode1.marsnet.local
Клиент ClickHouse версии 24.1.3.31 (официальная сборка).
Подключение к chnode1.marsnet.local:9440 от имени пользователя clickhouse_db1_user.
Подключено к серверу ClickHouse версии 24.1.3.


clickhouse :) select * from db1.table1;

SELECT *
FROM db1.table1

Query id: b04b92d6-5b8b-40a2-a92a-f06f15774930

┌─id─┬─column1─┐
│  1 │ a       │
└────┴─────────┘

Получена 1 строка. Прошло: 0.004 сек.

clickhouse :) select * from db2.table1;

SELECT *
FROM db2.table1

Query id: 7f7eaa44-7b47-4184-807a-6968a56057ad


Прошло: 0.115 сек.

Получено исключение от сервера (версия 24.1.3):
Код: 497. DB::Exception: Получено от chnode1.marsnet.local:9440. DB::Exception: clickhouse_db1_user: Недостаточно привилегий. Для выполнения этого запроса необходима привилегия SELECT(id, column1) ON db2.table1. (ACCESS_DENIED)
```

10. Проверьте доступ пользователя, который имеет доступ к обеим базам данных, db1 и db2.
    Например:

```
root@chnode1:/etc/clickhouse-server# clickhouse-client --user ch_db1_db2_user --password MyPassword123  --secure --port 9440 --host chnode1.marsnet.local
Клиент ClickHouse версии 24.1.3.31 (официальная сборка).
Подключение к chnode1.marsnet.local:9440 под пользователем ch_db1_db2_user.
Подключено к серверу ClickHouse версии 24.1.3.

clickhouse :) select * from db1.table1;

SELECT *
FROM db1.table1

Query id: 23084744-08c2-48bd-8635-a23438812026

┌─id─┬─column1─┐
│  1 │ a       │
└────┴─────────┘

1 строка в наборе. Затрачено: 0.005 сек.

clickhouse :) select * from db2.table1;

SELECT *
FROM db2.table1

Query id: f9954ec4-d8d9-4b5a-9f68-a7aa79a1bb4a

┌─id─┬─column1─┐
│  2 │ b       │
└────┴─────────┘

1 строка в наборе. Затрачено: 0.004 сек.
```

11. Проверьте доступ для пользователя Admin.
    Например:


```
root@chnode1:/etc/clickhouse-server# clickhouse-client --user clickhouse_ad_admin --password MyPassword123  --secure --port 9440 --host chnode1.marsnet.local
Клиент ClickHouse версии 24.1.3.31 (официальная сборка).
Подключение к chnode1.marsnet.local:9440 от имени пользователя clickhouse_ad_admin.
Подключено к серверу ClickHouse версии 24.1.3.

clickhouse :) create table db1.table2 on cluster 'cluster_1S_3R'
(
  id Int32,
  column1 String
)
engine = MergeTree()
order by id;

CREATE TABLE db1.table2 ON CLUSTER cluster_1S_3R
(
    `id` Int32,
    `column1` String
)
ENGINE = MergeTree
ORDER BY id

Query id: 6041fd32-4294-44bd-b442-3fdd41333e6f

┌─host──────────────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
│ chnode1.marsnet.local │ 9440 │      0 │       │                   2 │                2 │
└───────────────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘
┌─host──────────────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
│ chnode2.marsnet.local │ 9440 │      0 │       │                   1 │                1 │
└───────────────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘
┌─host──────────────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
│ chnode3.marsnet.local │ 9440 │      0 │       │                   0 │                0 │
└───────────────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘
```
