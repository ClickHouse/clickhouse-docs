---
title: Могу ли я использовать ClickHouse как хранилище ключ-значение?
description: "Краткий ответ — **«нет»**. Нагрузки формата ключ-значение — один из основных случаев, когда **НЕ** следует использовать ClickHouse."
date: 2021-09-01
tags: ['Концепции', 'Сценарии использования']
keywords: ['Хранилище ключ-значение']
---

{frontMatter.description}

{/* обрезать */}


## Короткий ответ — «нет» \{#the-short-answer-is-no\}

Короткий ответ — **«нет»**. Нагрузки типа key-value находятся среди главных примеров того, когда <span class="text-danger">**НЕ**</span> стоит использовать ClickHouse. В конце концов, это система [OLAP](https://clickhouse.com/docs/faq/general/olap), а для key-value-хранилищ существует множество отличных специализированных систем.

Тем не менее могут быть ситуации, когда всё же имеет смысл использовать ClickHouse для запросов, похожих на key-value. Обычно это низкобюджетные продукты, где основная нагрузка носит аналитический характер и хорошо ложится на ClickHouse, но существует дополнительный процесс, которому нужен key-value-паттерн с невысокой пропускной способностью запросов и без жёстких требований по задержке. Если бы у вас был неограниченный бюджет, вы бы развернули отдельную key-value базу данных для этой вторичной нагрузки, но в реальности появляется дополнительная стоимость сопровождения ещё одной системы хранения (мониторинг, бэкапы и т. п.), чего часто стараются избежать.

Если вы решите не следовать рекомендациям и выполнять key-value-подобные запросы в ClickHouse, учтите следующие рекомендации:

- Основная причина, по которой точечные запросы дороги в ClickHouse, — его разреженный первичный индекс в основном [семействе движков таблиц MergeTree](https://clickhouse.com/docs/engines/table-engines/mergetree-family/mergetree). Этот индекс не может указывать на каждую конкретную строку данных; вместо этого он указывает на каждую N-ю, и системе приходится сканировать от соседней N-й строки до искомой, читая по пути лишние данные. В key-value-сценарии может быть полезно уменьшить значение N с помощью настройки `index_granularity`.
- ClickHouse хранит каждый столбец в отдельном наборе файлов, поэтому для сборки одной полной строки ему нужно пройти по каждому из этих файлов. Их количество линейно растёт с числом столбцов, поэтому в key-value-сценарии имеет смысл избегать большого числа столбцов и поместить все данные в один столбец типа `String`, закодировав их в каком-либо формате сериализации, таком как JSON, Protobuf или любом другом подходящем.
- Существует альтернативный подход, использующий движок таблиц [Join](https://clickhouse.com/docs/engines/table-engines/special/join) вместо обычных таблиц `MergeTree` и функцию [joinGet](https://clickhouse.com/docs/sql-reference/functions/other-functions/#joinget) для извлечения данных. Он может обеспечить более высокую производительность запросов, но при этом возможны некоторые проблемы с удобством использования и надёжностью. Вот [пример использования](https://github.com/ClickHouse/ClickHouse/blob/master/tests/queries/0_stateless/00800_versatile_storage_join.sql#L49-L51).