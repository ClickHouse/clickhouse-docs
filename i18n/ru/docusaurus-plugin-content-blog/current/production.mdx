---
title: Какую версию ClickHouse использовать в продакшне?
description: "Прежде всего давайте обсудим, почему вообще возникает этот вопрос. Есть две ключевые причины..."
date: 2021-09-01
tags: ['Концепции', 'Производительность и оптимизации']
keywords: ['Версия для продакшна']
---

{frontMatter.description}

{/* обрезать */}


## Введение \{#introduction\}

Для начала давайте обсудим, почему вообще задают этот вопрос. 

Есть две ключевые причины:

1.  ClickHouse развивается очень высокими темпами, и обычно выходит более 10 стабильных релизов в год. В результате появляется широкий выбор релизов, и сделать такой выбор не так уж тривиально.
2.  Некоторые пользователи хотят избежать необходимости тратить время на то, чтобы разобраться, какая версия лучше всего подходит для их сценария, и просто следовать чьему-то совету.

Вторая причина более фундаментальна, поэтому начнём с неё, а затем вернёмся к вопросу, как ориентироваться в различных релизах ClickHouse.

## Какую версию ClickHouse вы рекомендуете? \{#which-clickhouse-version-do-you-recommend\}

Возникает соблазн нанять консультантов или довериться известным экспертам, чтобы переложить ответственность за продуктивную среду. Вы устанавливаете какую‑то конкретную версию ClickHouse, которую порекомендовал кто‑то другой; если с ней возникают проблемы — это как бы не ваша вина, а чья‑то еще. Такой ход мыслей — большая ловушка. Ни один внешний специалист не знает лучше вас, что происходит в продуктивной среде вашей компании.

Как же правильно выбрать, на какую версию ClickHouse обновляться? Или как выбрать свою первую версию ClickHouse? Прежде всего, вам нужно инвестировать в создание **реалистичной предпроизводственной среды**. В идеале это может быть полностью идентичная теневая копия продакшена, но это обычно дорого.

Вот несколько ключевых моментов, которые позволят получить приемлемую достоверность предпроизводственной среды при не слишком высоких затратах:

- Предпроизводственная среда должна выполнять набор запросов, максимально близкий к тем, которые вы планируете запускать в продакшене:
    - Не делайте ее только для чтения с каким‑то замороженным набором данных.
    - Не делайте ее только для записи, просто копируя данные без построения типичных отчетов.
    - Не очищайте ее полностью вместо того, чтобы применять миграции схемы.
- Используйте выборку реальных продуктивных данных и запросов. Постарайтесь выбрать выборку, которая по‑прежнему репрезентативна и позволяет `SELECT`‑запросам возвращать осмысленные результаты. Используйте маскирование, если ваши данные чувствительны и внутренние политики не позволяют им покидать продуктивную среду.
- Убедитесь, что предпроизводственная среда покрыта вашей системой мониторинга и оповещений так же, как и продуктивная.
- Если ваш продакшен развернут в нескольких дата‑центрах или регионах, сделайте то же самое для предпроизводственной среды.
- Если ваш продакшен использует сложные функции, такие как репликация, распределенные таблицы и каскадные материализованные представления, убедитесь, что они аналогично настроены и в предпроизводственной среде.
- Существует компромисс между использованием примерно такого же числа серверов или VM в предпроизводственной среде, как и в продакшене, но меньшего размера, и существенно меньшего их количества, но такого же размера. Первый вариант может выявить дополнительные проблемы, связанные с сетью, тогда как второй проще в управлении.

Вторая область для инвестиций — это **инфраструктура автоматизированного тестирования**. Не думайте, что если какой‑то запрос однажды успешно выполнился, он будет успешно выполняться всегда. Допустимо иметь модульные тесты, в которых ClickHouse замокан, но убедитесь, что в вашем продукте есть разумный набор автоматизированных тестов, которые запускаются против реального ClickHouse и проверяют, что все важные сценарии использования продолжают работать как ожидается.

Дополнительным шагом вперед может стать вклад этих автоматизированных тестов в [open-source инфраструктуру тестирования ClickHouse](https://github.com/ClickHouse/ClickHouse/tree/master/tests), которая постоянно используется в его повседневной разработке. Это, безусловно, потребует дополнительного времени и усилий, чтобы изучить, [как ее запускать](/development/tests), а затем как адаптировать ваши тесты к этой платформе, но это окупится тем, что релизы ClickHouse будут уже протестированы на них к моменту объявления стабильными, вместо того чтобы снова и снова тратить время на сообщение о проблеме постфактум и затем ждать, пока исправление будет реализовано, портировано в нужную ветку и выпущено. В некоторых компаниях такой вклад тестов в инфраструктуру их использования закреплен во внутренних политиках (в Google это называют [Beyonce's Rule](https://www.oreilly.com/library/view/software-engineering-at/9781492082781/ch01.html#policies_that_scale_well)).

Когда у вас есть предпроизводственная среда и инфраструктура тестирования, выбор лучшей версии становится довольно простым:

1.  Регулярно запускайте ваши автоматизированные тесты на новых релизах ClickHouse. Вы можете делать это даже для релизов ClickHouse, помеченных как `testing`, но переходить с ними к следующим шагам не рекомендуется.
2.  Разверните релиз ClickHouse, успешно прошедший тесты, в предпроизводственной среде и проверьте, что все процессы работают как ожидается.
3.  Сообщите о любых обнаруженных проблемах в [ClickHouse GitHub Issues](https://github.com/ClickHouse/ClickHouse/issues).
4.  Если серьезных проблем не было, можно считать безопасным начинать развертывание релиза ClickHouse в продуктивной среде. Инвестиции в автоматизацию поэтапных релизов, реализующую подход, подобный [canary releases](https://martinfowler.com/bliki/CanaryRelease.html) или [green-blue deployments](https://martinfowler.com/bliki/BlueGreenDeployment.html), могут еще больше снизить риск проблем в продакшене.

Как вы могли заметить, в описанном выше подходе нет ничего специфичного для ClickHouse — так поступают с любым элементом инфраструктуры, на который полагаются, если относятся к своей продуктивной среде всерьез.

## Как выбрать между релизами ClickHouse? \{#how-to-choose-between-clickhouse-releases\}

Если вы посмотрите на содержимое репозитория пакетов ClickHouse, вы увидите два типа пакетов:

1.  `stable`
2.  `lts` (long-term support — долгосрочная поддержка)

Вот несколько рекомендаций, как выбирать между ними:

- `stable` — это тип пакетов, который мы по умолчанию рекомендуем. Они выпускаются примерно раз в месяц (и, таким образом, обеспечивают относительно быстрое появление новых возможностей), а три последних стабильных релиза поддерживаются в части диагностики и бэкпортирования исправлений ошибок.
- `lts` выходят два раза в год и поддерживаются в течение года после их первоначального релиза. Вы можете предпочесть их `stable` в следующих случаях:
    - В вашей компании есть внутренние политики, которые не разрешают частые обновления или использование ПО без статуса LTS.
    - Вы используете ClickHouse во второстепенных продуктах, которые либо не требуют каких-либо сложных возможностей ClickHouse, либо не имеют достаточных ресурсов, чтобы поддерживать его в актуальном состоянии.

Многие команды, которые изначально считают, что `lts` — это правильный выбор, всё равно часто переходят на `stable` из‑за какой‑нибудь недавней функции, важной для их продукта.

:::warning
Ещё один момент, который нужно учитывать при обновлении ClickHouse: мы всегда внимательно следим за совместимостью между релизами, но иногда сохранять её полностью неразумно, и некоторые несущественные детали могут измениться. Поэтому обязательно проверьте [changelog](/whats-new/changelog) перед обновлением, чтобы увидеть, есть ли какие-либо заметки о изменениях, несовместимых с предыдущими версиями.
:::