---
title: Как подключиться к ClickHouse с помощью SSH-ключей
description: "Как подключиться к ClickHouse и ClickHouse Cloud с помощью SSH-ключей"
date: 2024-07-25
tags: ['Управление облаком', 'Безопасность и аутентификация']
keywords: ['Облако', 'SSH']
---

{frontMatter.description}

{/* сокращение */}

## Вопрос \{#question\}

Как подключиться к ClickHouse, используя аутентификацию по SSH-ключу?

:::note
В качестве примера здесь используется ClickHouse Cloud, но он также должен работать с ClickHouse с открытым исходным кодом.
:::

<iframe width="100%" height="315" src="https://www.youtube.com/embed/Rhe-kUyrFUE?si=JgcAusW1TcEyRqPr" title="Проигрыватель видео YouTube" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen />

## Ответ \{#answer\}

1. Используйте ssh-keygen для создания пары ключей. Пример:

```
➜  new ssh-keygen \
-t ed25519 \
> -f /Users/testuser/.ssh/ch_key
Генерация пары ключей ed25519 (открытого и закрытого).
Введите кодовую фразу (оставьте пустым, если не требуется):
Повторите ввод кодовой фразы:
Закрытый ключ сохранён в /Users/testuser/.ssh/ch_key
Открытый ключ сохранён в /Users/testuser/.ssh/ch_key.pub
.....
```

2. Используйте открытый ключ (ch&#95;key.pub в приведённом выше примере), чтобы создать пользователя (USER).

```sql
clickhouse-cloud :) CREATE USER abcuser IDENTIFIED WITH ssh_key BY KEY 'AAAABBBcdE1lZDI1NTE5AAAAIISdl4CrGM8mckXBUXLjL3ef9XwnycDWEvBPu3toB40m' TYPE 'ssh-ed25519';

CREATE USER abcuser IDENTIFIED WITH ssh_key BY KEY AAAABBBcdE1lZDI1NTE5AAAAIISdl4CrGM8mckXBUXLjL3ef9XwnycDWEvBPu3toB40m TYPE `ssh-ed25519`

Query id: 34c6aad6-5f88-4c80-af7a-7d37c91ba7d5

Ok.
```

3. Выполните `SHOW users`, чтобы подтвердить создание пользователя.

4. Назначьте пользователю роль `default_role` (необязательно).

```sql
clickhouse-cloud :) grant default_role to abcuser;

GRANT default_role TO abcuser

Query id: 4a054003-220a-4dea-8e8d-eb1f08ee7b10

Ok.

0 rows in set. Elapsed: 0.137 sec.
```

5. Теперь используйте закрытый ключ для аутентификации при обращении к сервису.

```sql
➜  new ./clickhouse client --host myhost.us-central1.gcp.clickhouse.cloud --secure --user abcuser --ssh-key-file '/Users/testuser/.ssh/ch_key'
Клиент ClickHouse версии 23.12.1.863 (официальная сборка).
Введите парольную фразу для закрытого ключа (оставьте пустым, если пароль не задан):
Подключение к myhost.us-central1.gcp.clickhouse.cloud:9440 от имени пользователя abcuser.
Подключено к серверу ClickHouse версии 23.9.2.

clickhouse-cloud :) select currentUser();

SELECT currentUser()

Query id: d4b6bb60-ef45-47d3-8740-db9f2941dcd2

┌─currentUser()─┐
│ abcuser       │
└───────────────┘

Получена 1 строка. Время выполнения: 0.001 сек.

clickhouse-cloud :)
```
