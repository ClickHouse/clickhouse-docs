---
title: Устранение ошибки «Too many parts» в ClickHouse
description: Узнайте, как устранить ошибку «Too many parts» в ClickHouse, оптимизировав скорость вставки, настроив параметры MergeTree и наладив эффективное управление партициями.
date: 2023-03-20
tags: ['Ошибки и исключения']
keywords: ['Too many parts']
---

{frontMatter.description}

{/* truncate */}

## DB::Exception: Слишком много частей (ошибка: 252). Объединения выполняются значительно медленнее, чем вставки \{#dbexception-too-many-parts-252-merges-are-processing-significantly-slower-than-inserts\}

Вы достигли порогового значения параметра `parts_to_throw_insert` в таблице MergeTree.

Вы можете отслеживать количество активных частей для конкретной таблицы с помощью:

```sql
select count(*) from system.parts where table = '<имя_таблицы>' and active == 1
```

Основное требование при вставке данных в ClickHouse: никогда не следует отправлять слишком много операторов `INSERT` в секунду. В идеале — один `INSERT` в секунду или раз в несколько секунд.

Вы можете вставлять 100K строк в секунду, но только одним большим пакетным оператором `INSERT`. Если вы отправляете сотни/тысячи операторов `INSERT` в секунду в таблицу *MergeTree, вы постоянно будете получать ошибки, и это нельзя исправить настройкой параметров.

Если вы не можете объединить большое количество вставок в один большой пакетный оператор `INSERT` на стороне клиента, тогда следует создать таблицу Buffer перед таблицей *MergeTree.

1. Каждая вставка создаёт папку в `/var/lib/clickhouse/.../table_name/`. Внутри этой папки по два файла на каждый столбец — один с данными (сжатыми), второй с индексом. Данные физически отсортированы по первичному ключу внутри этих файлов. Эти папки называются «**частями**» (parts).

2. ClickHouse объединяет эти мелкие части в более крупные в фоновом режиме. Он выбирает части для слияния по определённым правилам. После слияния двух (или более) частей создаётся одна более крупная часть, а старые части ставятся в очередь на удаление. Настройки, которые вы перечислили, позволяют тонко настраивать правила слияния частей. Цель процесса слияния — оставить по одной крупной части на каждый раздел (или несколько крупных частей на раздел, которые нецелесообразно сливать, потому что они слишком большие). Пожалуйста, также посмотрите этот [комментарий](https://github.com/yandex/ClickHouse/issues/1661#issuecomment-352739726).

3. Если вы создаёте новые части слишком быстро (например, выполняя много мелких вставок), и ClickHouse не успевает сливать их с нужной скоростью (то есть новые части появляются быстрее, чем ClickHouse может их объединять), вы получаете исключение «Merges are processing significantly slower than inserts». Вы можете попробовать увеличить лимит, но тогда можно столкнуться с проблемами файловой системы из‑за слишком большого количества файлов/каталогов (например, ограничение по inodes).

4. Если вы вставляете данные одновременно в большое количество разделов, проблема масштабируется пропорционально числу затронутых вставкой разделов.

5. Вы можете попытаться скорректировать поведение ClickHouse с помощью одной из перечисленных настроек или с помощью max&#95;insert&#95;block&#95;size / max&#95;block&#95;size / insert&#95;format&#95;max&#95;block&#95;size / max&#95;client&#95;network&#95;bandwidth. Но лучшее решение — просто вставлять данные с ожидаемой скоростью. Ожидаемая скорость: **одна вставка каждые 1–2 секунды, при этом каждая вставка содержит 10K–500K строк данных**.

6. Таким образом, правильное решение для устранения ошибки «Merges are processing significantly slower than inserts» — это подстроить количество вставок в секунду и число строк в каждой вставке. Используйте пакетную вставку, чтобы объединять мелкие вставки в одну крупную, если данные приходят построчно. Ограничивайте (throttle) очень большие вставки, если у вас слишком много данных для вставки за один раз. Не меняйте внутренние механизмы ClickHouse, если вы не очень хорошо понимаете, что именно делаете.

7. Если ваши данные приходят быстрее, чем 500K строк в секунду, скорее всего, вам нужны дополнительные серверы в кластере для обработки такого трафика, а не изменение настроек.

8. Скорость фоновых слияний обычно зависит от скорости хранилища, используемых настроек сжатия, варианта MergeTree (алгоритма слияния — plain merge/aggregating/summing/collapsing и т. д.) и используемого ключа сортировки.
