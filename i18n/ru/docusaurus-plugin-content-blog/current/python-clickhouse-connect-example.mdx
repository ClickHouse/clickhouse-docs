---
date: 2023-05-08
title: "Практический пример Python‑клиента для подключения к сервису ClickHouse Cloud"
description: "Узнайте, как подключиться к сервису ClickHouse Cloud с помощью Python, используя подробный пошаговый пример с драйвером clickhouse-connect."
tags: ['Клиенты для языков']
keywords: ['Python', 'ClickHouse Cloud']
---

{frontMatter.description}

{/* обрезка */}

Это пошаговый пример того, как начать использовать Python с сервисом ClickHouse Cloud.

:::note
Имейте в виду, что версии Python и зависимости библиотек постоянно меняются. Также убедитесь, что вы используете последние поддерживаемые версии как драйвера, так и Python-окружения при выполнении этого примера.

На момент написания этой статьи мы используем драйвер [clickhouse-connect](https://github.com/ClickHouse/clickhouse-connect) версии `0.5.23` и Python версии `3.11.2` соответственно.
:::


## Шаги

1. Проверьте текущую версию Python:

```
$  python -V
Python 3.11.2
```

2. Соберём проект в каталоге `ch-python`:

```
$ mkdir ch-python
$ cd ch-python
```

3. Создайте файл зависимостей `requirements.txt` со следующим содержимым:

```
clickhouse-connect==0.5.23
```

4. Создайте файл исходного кода на Python с именем `main.py`:

```py
import clickhouse_connect
import sys
import json

CLICKHOUSE_CLOUD_HOSTNAME = 'HOSTNAME.clickhouse.cloud'
CLICKHOUSE_CLOUD_USER = 'default'
CLICKHOUSE_CLOUD_PASSWORD = 'YOUR_SECRET_PASSWORD'

client = clickhouse_connect.get_client(
    host=CLICKHOUSE_CLOUD_HOSTNAME, port=8443, username=CLICKHOUSE_CLOUD_USER, password=CLICKHOUSE_CLOUD_PASSWORD)

print("подключено к " + CLICKHOUSE_CLOUD_HOSTNAME + "\n")
client.command(
    'CREATE TABLE IF NOT EXISTS new_table (key UInt32, value String, metric Float64) ENGINE MergeTree ORDER BY key')

print("таблица new_table создана или уже существует!\n")

row1 = [1000, 'Строковое значение 1000', 5.233]
row2 = [2000, 'Строковое значение 2000', -107.04]
data = [row1, row2]
client.insert('new_table', data, column_names=['key', 'value', 'metric'])

print("записано 2 строки в таблицу new_table\n")

QUERY = "SELECT max(key), avg(metric) FROM new_table"

result = client.query(QUERY)

sys.stdout.write("запрос: ["+QUERY + "] возвращает:\n\n")
print(result.result_rows)
```

5. Создайте виртуальное окружение:

```
chpython$ python -m venv venv
```

6. Активируйте виртуальное окружение:

```
chpython$ source venv/bin/activate
```

После активации окружения перед приглашением терминала должно появиться (venv); затем установите зависимости:

```
(venv) ➜  chpython$ pip install -r requirements.txt
Collecting certifi
  Using cached certifi-2023.5.7-py3-none-any.whl (156 kB)
Collecting urllib3>=1.26
  Using cached urllib3-2.0.2-py3-none-any.whl (123 kB)
Collecting pytz
  Using cached pytz-2023.3-py2.py3-none-any.whl (502 kB)
Collecting zstandard
  Using cached zstandard-0.21.0-cp311-cp311-macosx_11_0_arm64.whl (364 kB)
Collecting lz4
  Using cached lz4-4.3.2-cp311-cp311-macosx_11_0_arm64.whl (212 kB)
Installing collected packages: pytz, zstandard, urllib3, lz4, certifi, clickhouse-connect
Successfully installed certifi-2023.5.7 clickhouse-connect-0.5.23 lz4-4.3.2 pytz-2023.3 urllib3-2.0.2 zstandard-0.21.0
```

7. Запустите код!

```
(venv) chpython$ venv/bin/python main.py

подключено к HOSTNAME.clickhouse.cloud

таблица new_table создана или уже существует!

записано 2 строки в таблицу new_table

запрос: [SELECT max(key), avg(metric) FROM new_table] возвращает:

[(2000, -50.9035)]
```

:::tip
Если вы используете устаревшую версию Python (например, `3.9.6`), у вас может возникать ошибка `ImportError`, связанная с библиотекой `urllib3`.
В этом случае либо обновите вашу Python-среду до более новой версии, либо зафиксируйте версию `urllib3` на `1.26.15` в файле requirements.txt.
:::
