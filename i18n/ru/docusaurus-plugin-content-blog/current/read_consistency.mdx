---
date: 2024-02-14
title: "Как обеспечить согласованное чтение данных в ClickHouse?"
description: "Узнайте, как обеспечить согласованность данных при чтении из ClickHouse, независимо от того, подключены ли вы к одному и тому же узлу или к случайному узлу."
tags: ['Производительность и оптимизации']
keywords: ['Согласованность чтения']
---

{frontMatter.description}

{/* усечение */}

## Вопрос \{#question\}

Я записываю данные в ClickHouse Cloud, и при чтении мне необходимо быть уверенным, что я получаю самую актуальную и полностью записанную информацию.

## Ответ \{#answer\}

### Работа с одним и тем же узлом \{#talking-to-the-same-node\}

Если вы используете нативный протокол или сеанс для операций чтения/записи, то будете подключены к одной и той же реплике: в этом сценарии вы читаете непосредственно с того узла, на который записываете, и поэтому чтение всегда будет согласованным.

### Обращение к произвольному узлу \{#talking-to-a-random-node\}

Если вы не можете гарантировать, что обращаетесь к одному и тому же узлу (например, обращаетесь к узлу по HTTPS, а запросы перераспределяются балансировщиком нагрузки), вы можете:

A)

1. записать данные
2. подключиться к другой реплике
3. выполнить `SYSTEM SYNC REPLICA db.table_name LIGHTWEIGHT`
4. прочитать последние данные

См. справочник команд `SYSTEM` [по ссылке](https://clickhouse.com/docs/sql-reference/statements/system#sync-replica)

ИЛИ

B) читать данные в любой момент с гарантией последовательной согласованности

```sql
SELECT 
...
SETTINGS select_sequential_consistency = 1
```

Обратите внимание, что при использовании ClickHouse Cloud и его табличного движка [SharedMergeTree](https://clickhouse.com/docs/cloud/reference/shared-merge-tree) по умолчанию использование `insert_quorum_parallel` не требуется — все вставки в SharedMergeTree являются кворумными (так задумано).

Использование [`SYSTEM SYNC REPLICAS`](https://clickhouse.com/docs/sql-reference/statements/system#sync-replica) или [`select_sequential_consistency`](https://clickhouse.com/docs/operations/settings/settings#select_sequential_consistency) увеличит нагрузку на ClickHouse Keeper и может приводить к снижению производительности в зависимости от нагрузки на сервис.

Рекомендуемый подход — выполнять запись и чтение в рамках одной и той же сессии или через нативный протокол (sticky connection).
