---
title: Определение ресурсоёмких запросов по использованию памяти в ClickHouse
description: Узнайте, как использовать таблицу `system.query_log` для поиска запросов с наибольшим потреблением памяти в ClickHouse, с примерами для кластерных и одиночных установок.
date: 2023-06-07
tags: ['Производительность и оптимизации']
keywords: ['Ресурсоёмкие запросы', 'Использование памяти']
---

{frontMatter.description}

{/* обрезать */}


## Использование таблицы `system.query_log`

Следующий полезный запрос показывает, какие из выполненных вами запросов использовали наибольшее количество памяти.

Пара замечаний к этому запросу:

* результаты вычисляются за последний день (`now() - toIntervalDay(1))`), но вы можете легко изменить временной интервал
* предполагается, что у вас есть кластер с именем `default`, которое является именем вашего кластера в [ClickHouse Cloud](https://console.clickhouse.cloud). Замените `default` на имя вашего кластера
* если у вас нет кластера, см. запрос в конце этой статьи

```sql
SELECT
    count() as nb_query,
    user,
    query,
    sum(memory_usage) AS memory,
    normalized_query_hash
FROM
    clusterAllReplicas(default, system.query_log)
WHERE
    (event_time >= (now() - toIntervalDay(1)))
    AND query_kind = 'Select'
    AND type = 'QueryFinish'
    and user != 'monitoring-internal'
GROUP BY
    normalized_query_hash,
    query,
    user
ORDER BY
    memory DESC;
```

Ответ будет выглядеть так:

```response
┌─nb_query─┬─user────┬─query─────────────────────────────────────────────────────────┬───memory─┬─normalized_query_hash─┐
│       11 │ default │ select version()                                              │ 46178924 │   7202516440347714159 │
│        2 │ default │ SELECT * FROM "system"."table_functions" LIMIT 31 OFFSET 0    │  8391544 │  12830067173062987695 │
└──────────┴─────────┴───────────────────────────────────────────────────────────────┴──────────┴───────────────────────┘
```

:::note
Если у вас нет таблицы `system.query_log`, скорее всего, у вас не включено логирование запросов. Ознакомьтесь с подробным описанием [настройки `query_log`](https://clickhouse.com/docs/operations/server-configuration-parameters/settings#server_configuration_parameters-query-log), чтобы узнать, как её включить.
:::

Если у вас нет кластера, вы можете просто выполнять запросы напрямую к таблице `system.query_log`:

```sql
SELECT
    count() as nb_query,
    user,
    query,
    sum(memory_usage) AS memory,
    normalized_query_hash
FROM
    system.query_log
WHERE
    (event_time >= (now() - toIntervalDay(1)))
    AND query_kind = 'Select'
    AND type = 'QueryFinish'
    and user != 'monitoring-internal'
GROUP BY
    normalized_query_hash,
    query,
    user
ORDER BY
    memory DESC;
```
