---
title: Настройка привилегий CAP_IPC_LOCK и CAP_SYS_NICE в Docker
description: Узнайте, как устранить предупреждения Docker о привилегиях `CAP_IPC_LOCK` и `CAP_SYS_NICE` при запуске ClickHouse в контейнере.
date: 2023-06-07
tags: ['Ошибки и исключения']
keywords: ['Docker', 'CAP_IPC_LOCK', 'CAP_SYS_NICE']
---

{frontMatter.description}

{/* обрезка */}

## Вопрос \{#question\}

При запуске ClickHouse в Docker Docker сообщает, что в системе отсутствуют привилегии `CAP_IPC_LOCK` и `CAP_SYS_NICE`. Как это можно исправить?

Сообщения журнала об отсутствии привилегий `CAP_SYS_NICE` или `CAP_SYS_NICE` выглядят так:

```bash
docker run -d --name clickhouse-server \
    --ulimit nofile=262144:262144 \
    --network clickhouse-net \
    -p 8123:8123 -p 9000:9000 -p 9009:9009 -p 9363:9363 \
    clickhouse/clickhouse-server:23.2
```

```response
2023.04.19 08:04:10.022720 [ 1 ] {} <Information> Application: Похоже, процесс не имеет capability CAP_IPC_LOCK, бинарный mlock будет отключён. Это могло произойти из-за некорректной установки пакета ClickHouse. Вы можете устранить проблему вручную командой 'sudo setcap cap_ipc_lock=+ep /usr/bin/clickhouse'. Обратите внимание, что это не будет работать на файловых системах, смонтированных с опцией 'nosuid'.

2023.04.19 08:04:10.065860 [ 1 ] {} <Information> Application: Похоже, процесс не имеет capability CAP_SYS_NICE, настройка 'os_thread_priority' не будет иметь эффекта. Это могло произойти из-за некорректной установки пакета ClickHouse. Вы можете устранить проблему вручную командой 'sudo setcap cap_sys_nice=+ep /usr/bin/clickhouse'. Обратите внимание, что это не будет работать на файловых системах, смонтированных с опцией 'nosuid'.
```

## Ответ \{#answer\}

1. Добавьте два аргумента `--cap-add`, чтобы предоставить контейнеру привилегии `IPC_LOCK` и `SYS_NICE`:

```bash
docker run -d --name clickhouse-server \
   --cap-add=SYS_NICE \
   --cap-add=IPC_LOCK \
   --ulimit nofile=262144:262144 \
   --network clickhouse-net \
   -p 8123:8123 -p 9000:9000 -p 9009:9009 -p 9363:9363 \
   clickhouse/clickhouse-server:23.2
```

2. Проверьте, что эти capabilities доступны в контейнере с помощью следующей команды:

```bash
apt-get update > /dev/null && apt-get install -y libcap2-bin > /dev/null && capsh --print
```

Ответ будет похож на:

```response
debconf: настройка пакета откладывается, так как apt-utils не установлен
ПРЕДУПРЕЖДЕНИЕ: libcap требует обновления (cap=40 должна иметь имя).
Current: = cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_ipc_lock,cap_sys_chroot,cap_sys_nice,cap_mknod,cap_audit_write,cap_setfcap+ep
Bounding set =cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_ipc_lock,cap_sys_chroot,cap_sys_nice,cap_mknod,cap_audit_write,cap_setfcap
Ambient set =
Securebits: 00/0x0/1'b0
 secure-noroot: нет (разблокирован)
 secure-no-suid-fixup: нет (разблокирован)
 secure-keep-caps: нет (разблокирован)
 secure-no-ambient-raise: нет (разблокирован)
uid=0(root) euid=0(root)
gid=0(root)
groups=0(root)
Предполагаемый режим: НЕОПРЕДЕЛЁН (0)
```

3. Вручную задайте оба значения capabilities для ClickHouse

```bash
setcap "cap_ipc_lock=+ep cap_sys_nice=+ep" /usr/bin/clickhouse
```

4. Убедитесь, что capabilities применены.

```bash
getcap -v /usr/bin/clickhouse
```

Вы увидите следующее:

```response
/usr/bin/clickhouse = cap_ipc_lock,cap_sys_nice+ep
```

5. Перезапустите сервер ClickHouse — сообщения журнала больше не должны появляться.

<br />

Подробности см. в [статье о возможностях Linux](https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities).
