---
date: 2025-07-20
title: В чём разница между OPTIMIZE FINAL и FINAL?
tags: ['Основные концепции данных']
keywords: ['OPTIMIZE FINAL', 'FINAL']
description: 'Рассматривает различия между OPTIMIZE FINAL и FINAL, а также случаи, когда их следует использовать, а когда — нет.'
---

{frontMatter.description}

{/* truncate */}

# В чем разница между `OPTIMIZE FINAL` и `FINAL`? \{#what-is-the-difference-between-optimize-final-and-final\}

`OPTIMIZE FINAL` — это DDL-команда, которая физически и навсегда реорганизует
и оптимизирует данные на диске. Она физически объединяет части данных в таблицах `MergeTree`,
выполняя дедупликацию данных в процессе за счет удаления дублирующихся строк из хранилища.

`FINAL` — это модификатор **на время выполнения запроса**, который обеспечивает
результат без дубликатов, не изменяя структуру хранимых данных. Он работает,
выполняя логику слияния при чтении. Его действие временно и влияет только на результат текущего запроса.

Пользователям часто рекомендуют избегать использования `OPTIMIZE FINAL`, так как у него
существенные накладные расходы по производительности, однако эти два механизма не стоит путать.
Часто необходимо использовать `FINAL`, чтобы получать результаты без дубликатов, особенно при
использовании движков таблиц, таких как `ReplacingMergeTree`, которые могут содержать
дублирующиеся строки, еще не замененные в ходе фонового процесса слияния.

В таблице ниже приведены ключевые отличия:

|Аспект            |`OPTIMIZE FINAL`                            | `FINAL`                                            |
|------------------|--------------------------------------------|----------------------------------------------------|
|Type              | DDL-команда                                | Модификатор запроса                                |
|Effect            | Постоянная оптимизация хранилища           | Временная дедупликация на время выполнения запроса |
|Performance       | Высокая стоимость один раз, затем более быстрые запросы | Более низкая стоимость для одного запроса, но повторяется для каждого запроса |
|Data Modification | Да — физически изменяет хранилище          | Нет — операция только на чтение                    |
|Use Case          | Периодическое обслуживание/оптимизация     | Дедуплицированные запросы в реальном времени       |

## Когда использовать каждый вариант \{#when-to-use-each\}

Используйте `OPTIMIZE FINAL`, когда:

* Вы хотите надолго и существенно улучшить производительность запросов
* Вы можете позволить себе разовые затраты на оптимизацию
* Вы выполняете периодическое обслуживание таблиц
* Вы хотите физически очистить дублирующиеся данные

Используйте `FINAL`, когда:

* Вам немедленно нужны дедуплицированные результаты
* Вы не можете ждать или не хотите выполнять постоянную оптимизацию
* Вам лишь изредка нужны дедуплицированные данные
* Вы работаете с часто изменяющимися данными

Оба инструмента полезны, но они решают разные задачи в стратегии дедупликации ClickHouse.