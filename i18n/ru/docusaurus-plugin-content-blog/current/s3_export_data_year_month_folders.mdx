---
date: 2023-03-24
title: "Как выполнять запись с партиционированием по году и месяцу в S3?"
description: "Узнайте, как записывать данные с партиционированием по году и месяцу в бакет S3 в ClickHouse, используя произвольную структуру путей для организации данных."
tags: ['Экспорт данных', 'Нативные клиенты и интерфейсы']
keywords: ['S3', 'Запись с партиционированием']
---

{frontMatter.description}

{/* обрезать */}


## Как выполнять партиционированную запись по году и месяцу в S3 \{#learn-how-to-do-partitioned-writes-by-year-and-month-on-s3\}

Я хочу экспортировать данные так, чтобы путь в бакете S3 соответствовал следующей структуре:

- 2022
  - 1
  - 2
  - ...
  - 12
- 2021
  - 1
  - 2
  - ...
  - 12

и так далее...

## Ответ

Рассмотрим следующую таблицу ClickHouse:

```sql
CREATE TABLE sample_data (
    `name` String,
    `age` Int,
    `time` DateTime
) ENGINE = MergeTree
ORDER BY
    name
```

Добавьте 10 000 записей:

```sql
INSERT INTO
    sample_data
SELECT
    *
FROM
    generateRandom(
        'name String, age Int, time DateTime',
        10,
        10,
        10
    )
LIMIT
    10000;
```

Выполните эту команду, чтобы создать требуемую структуру в бакете S3 `my_bucket` (обратите внимание, что в этом примере файлы записываются в формате Parquet):

```sql
INSERT INTO
    FUNCTION s3(
        'https://s3-host:4321/my_bucket/{_partition_id}/file.parquet.gz',
        's3-access-key',
        's3-secret-access-key',
        Parquet,
        'name String, age Int, time DateTime'
    ) PARTITION BY concat(
        formatDateTime(time, '%Y'),
        '/',
        formatDateTime(time, '%m')
    )
SELECT
    name,
    age,
    time
FROM
    sample_data
Query id: 55adcf22-f6af-491e-b697-d09694bbcc56

Ok.

0 строк в наборе. Затрачено: 15.579 сек. Обработано 10.00 тысяч строк, 219.93 КБ (641.87 строк/с., 14.12 КБ/с.)
```
