---
title: Понимание типов частей и форматов хранения
description: 'Узнайте о различных типах частей (Wide и Compact) и форматах хранения (Full и Packed) в ClickHouse, а также о том, как они влияют на производительность.'
date: 2026-02-03
tags: ['Основные концепции данных']
keywords: ['компактные части', 'широкие части', 'полный формат хранения', 'упакованный формат хранения', 'типы частей', 'форматы хранения']
---

{frontMatter.description}

{/* сокращение */}

<br />

<br />

ClickHouse использует две независимые концепции организации данных внутри частей:

* **Типы частей** (Wide vs Compact): как данные столбцов размещаются внутри части
* **Форматы хранения** (Full vs Packed): как файлы части размещаются на диске

## Типы частей: Wide и Compact \{#part-types-wide-vs-compact\}

Типы частей определяют, как данные по столбцам организованы внутри части данных.

| Тип | Описание | Оптимально для |
|------|-------------|----------|
| **Wide** | Каждый столбец хранится в отдельном файле (или файлах), каждый со своим собственным [marks file](/concepts/glossary#mark-file) | Запросы, выбирающие подмножество столбцов |
| **Compact** | Все столбцы хранятся в одном файле с одним [marks file](/concepts/glossary#mark-file) | Производительность ингестии и запросы, которым нужны все столбцы |

### Когда используется каждый тип \{#when-each-type-is-used\}

Тип парта определяется следующими настройками таблицы:

* [`min_bytes_for_wide_part`](/operations/settings/merge-tree-settings#min_bytes_for_wide_part): Минимальное число байт в парте для использования формата Wide
* [`min_rows_for_wide_part`](/operations/settings/merge-tree-settings#min_rows_for_wide_part): Минимальное число строк в парте для использования формата Wide

Если объем данных в парте в байтах или количество строк меньше соответствующего значения настройки, парт сохраняется в формате `Compact`; в противном случае используется формат `Wide`.

### Соображения по производительности \{#performance-considerations\}

**Компактные части:**

* Лучшая производительность при ингестии
* Оптимальны, когда запросам нужны все столбцы
* Более эффективны для небольших частей

**Широкие части:**

* Более эффективны для запросов, выбирающих только подмножество столбцов
* Лучше подходят для больших наборов данных с выборочным доступом к столбцам

Слияния из компактного формата в широкий выполняются медленнее, чем слияния широких частей между собой, потому что ClickHouse использует алгоритмы [вертикального слияния](/merges#memory-optimized-merges) для преобразований компактный→широкий, тогда как для слияний компактный→компактный используются горизонтальные алгоритмы. Если вы хотите принудительно использовать широкий формат частей независимо от их размера, вы можете установить `min_bytes_for_wide_part=0`.

Это может быть полезно в следующих сценариях:

1. Когда у вас есть таблицы с большим количеством столбцов (например, более 600 столбцов) и выполняются крупные вставки — установка этого параметра в 0 может помочь с производительностью
2. Для оптимизации использования памяти системными таблицами, такими как `system.metric_log` и `system.text_log`, которые потребляют чрезмерный объём памяти во время слияний
3. При работе с таблицами с высоким объёмом вставок, когда вы хотите оптимизировать поведение хранения и слияний
4. Когда вам нужно единообразное поведение формата частей и вы не хотите накладных расходов на переходы форматов в зависимости от порогов размера

Стоит отметить, что хотя установка этого параметра в 0 может улучшить отдельные характеристики производительности, она может приводить к большему количеству GET‑запросов к хранилищу S3 из-за формата широких частей.

### Ограничения \{#limitations\}

Статистика размеров столбцов не рассчитывается для компактных частей, что может повлиять на мониторинг и оптимизацию. При выполнении запроса к `system.parts_columns` для компактных частей в столбцах `column_data_compressed_bytes` и `column_data_uncompressed_bytes` показывается значение `0`. Дополнительные сведения см. в разделе [&quot;Определение количества и размеров широких и компактных частей&quot;](/knowledgebase/count-parts-by-type).

## Форматы хранения: Full и Packed (ClickHouse Cloud) \{#storage-formats-full-vs-packed-clickhouse-cloud\}

Форматы хранения определяют, как файлы части физически хранятся на диске.

| Format | Description | Availability |
|--------|-------------|--------------|
| **Full** | Каждый файл хранится отдельно в каталоге части | Open source и Cloud |
| **Packed** | Все файлы объединены в один архивный файл | Только ClickHouse Cloud |

### Полный формат хранения \{#full-storage\}

В режиме полного формата хранения каждая часть представлена несколькими отдельными файлами, которые по отдельности хранятся на диске. Это вариант по умолчанию и единственный доступный в open-source-версии ClickHouse.

### Упакованное хранилище (только ClickHouse Cloud) \{#packed-storage-clickhouse-cloud-only\}

В упакованном хранилище все файлы части объединяются в один архив. Это значительно сокращает количество файловых операций, что особенно важно для удалённого хранилища вроде S3, где каждый запрос сопровождается задержкой и стоимостью.

**Преимущества упакованного хранилища:**

* Меньше вызовов API к S3/объектному хранилищу
* Сниженная нагрузка по метаданным на сервис координации
* Более низкие затраты на хранение (хранение в полном формате может быть значительно дороже)
* Лучшая производительность для небольших частей на удалённом хранилище

### Когда используется Packed storage \{#when-packed-storage-is-used\}

В ClickHouse Cloud часть использует Packed storage, если **любое** из этих условий выполняется:

* Нерасжатых байт &lt; [`min_bytes_for_full_part_storage`](/operations/settings/merge-tree-settings#min_bytes_for_full_part_storage)
* Количество строк &lt; [`min_rows_for_full_part_storage`](/operations/settings/merge-tree-settings#min_rows_for_full_part_storage)
* Уровень слияния &lt; [`min_level_for_full_part_storage`](/operations/settings/merge-tree-settings#min_level_for_full_part_storage)

:::note Открытый исходный код
Хотя настройки `min_bytes_for_full_part_storage`, `min_rows_for_full_part_storage` и `min_level_for_full_part_storage` определены в ClickHouse с открытым исходным кодом, они ни на что не влияют, поскольку реализация Packed storage доступна только в ClickHouse Cloud.
:::

Настройка `min_level_for_full_part_storage` может использоваться для оптимизации как производительности, так и затрат в средах ClickHouse Cloud, особенно для таблиц, в которые постоянно выполняются вставки.
Настройка доступна начиная с ClickHouse версии 25.10 и работает совместно с `min_level_for_wide_part`, обеспечивая комплексный контроль стратегий хранения частей.

Изменение её значения по умолчанию (0) можно рассматривать в следующих сценариях использования:

* Когда таблицы регулярно получают ингестию данных, начальные части будут быстро сливаться, поэтому изначальное хранение их в формате полной части неэффективно
* Установка этого параметра предотвращает дорогостоящие запросы S3 PUT во время вставок. Например, один анализ показал, что вставки, создающие полные части, в среднем выполняли 31,3 запроса PUT на одну вставку, тогда как вставки, создававшие только части в формате packed, выполняли в среднем лишь 2,22 запроса PUT на одну вставку
* Операции вставки становятся быстрее, особенно для таблиц с большим количеством столбцов, поскольку packed storage записывает все данные в один файл вместо создания отдельных файлов для каждого столбца.

Рекомендуемая конфигурация:

Установите `min_level_for_full_part_storage = 2` для облачных развертываний.
Это гарантирует, что:

* Части уровня 0 (начальные вставки) используют packed storage
* Части уровня 1 продолжают использовать packed storage
* Только части уровня 2 и выше используют полный формат хранения

:::tip
Избегайте этой настройки для таблиц, которые получают очень большие, но редкие записи, при которых выполняется недостаточно слияний, поскольку крупные начальные записи могут сразу выиграть от хранения в полном формате частей.
:::

## Комбинирование типов частей и форматов хранения \{#combining-part-types-and-storage-formats\}

Эти два понятия ортогональны, и вы можете использовать любую комбинацию в зависимости от того, используете ли вы ClickHouse Cloud или открытый вариант ClickHouse:

| Комбинация | Сценарий использования |
|-------------|------------------------|
| Wide + Full | Крупные части на локальном хранилище (по умолчанию в open source-версии) |
| Wide + Packed | Крупные части в облачном хранилище |
| Compact + Full | Небольшие части на локальном хранилище |
| Compact + Packed | Небольшие части в облачном хранилище |

## Запрос информации о частях \{#querying-part-information\}

Вы можете просмотреть тип и тип хранилища существующих частей с помощью таблицы [`system.parts`](/operations/system-tables/parts):

```sql
SELECT
    part_type,
    part_storage_type,
    max(level),
    count(),
    formatReadableSize(max(data_uncompressed_bytes)),
    formatReadableSize(min(data_uncompressed_bytes))
FROM system.parts
WHERE (database != 'system') AND active
GROUP BY
    1,
    2
ORDER BY
    1 ASC,
    2 ASC
```

Вы увидите примерно следующее:

```response
   ┌─part_type─┬─part_storage_type─┬─max(level)─┬─count()─┬─formatReadab⋯sed_bytes))─┬─formatReadab⋯sed_bytes))─┐
1. │ Compact   │ Full              │      12688 │    2456 │ 1023.87 MiB              │ 23.78 MiB                │
2. │ Compact   │ Packed            │      97383 │   13748 │ 127.77 MiB               │ 1.00 B                   │
3. │ Wide      │ Full              │       7642 │    2000 │ 1.38 TiB                 │ 30.18 MiB                │
4. │ Wide      │ Packed            │         10 │     187 │ 110.01 MiB               │ 1.30 KiB                 │
   └───────────┴───────────────────┴────────────┴─────────┴──────────────────────────┴──────────────────────────┘
```
