---
date: 2023-10-26
title: Можно ли использовать ClickHouse для векторного поиска?
description: Узнайте, как использовать ClickHouse для векторного поиска, включая хранение эмбеддингов и поиск с помощью метрик расстояния, таких как косинусное сходство.
tags: ['Сценарии использования', 'Концепции']
keywords: ['Векторный поиск']
---

{frontMatter.description}

{/* обрезка */}


## ClickHouse для векторного поиска! \{#clickhouse-for-vector-search\}

Да, ClickHouse умеет выполнять векторный поиск.

Основные преимущества использования ClickHouse для векторного поиска по сравнению с более специализированными векторными базами данных заключаются в следующем:

- Использование возможностей ClickHouse по фильтрации и полнотекстовому поиску для сужения набора данных перед выполнением поиска.
- Аналитика по вашим наборам данных.
- Выполнение `JOIN` с уже имеющимися данными.
- Отсутствие необходимости управлять ещё одной базой данных и усложнять инфраструктуру.

Ниже приведено краткое руководство по использованию ClickHouse для векторного поиска.

## 1. Create embeddings \{#1-create-embeddings\}

Ваши данные (документы, изображения или структурированные данные) должны быть преобразованы в _embeddings_ (векторные представления). Мы рекомендуем создавать embeddings с помощью [OpenAI Embeddings API](https://platform.openai.com/docs/api-reference/embeddings) или с использованием открытой Python‑библиотеки [SentenceTransformers](https://www.sbert.net/).

Embedding можно рассматривать как большой массив чисел с плавающей запятой, который представляет ваши данные. [Ознакомьтесь с этим руководством от OpenAI, чтобы узнать больше об embeddings](https://platform.openai.com/docs/guides/embeddings/what-are-embeddings).

## 2. Сохраните эмбеддинги

После того как вы сгенерировали эмбеддинги, их необходимо сохранить в ClickHouse. Каждый эмбеддинг должен храниться в отдельной строке и может включать метаданные для фильтрации, агрегирования или аналитики. Ниже приведён пример таблицы, которая может хранить изображения с подписями:

```sql
CREATE TABLE images
(
	`_file` LowCardinality(String),
	`caption` String,
	`image_embedding` Array(Float32)
)
ENGINE = MergeTree;
```


## 3. Поиск похожих эмбеддингов

Предположим, вы хотите найти в вашем наборе данных изображения собак. Вы можете использовать функцию расстояния, например `cosineDistance`, чтобы по эмбеддингу изображения собаки находить похожие изображения:

```sql
SELECT
    _file,
	caption,
	cosineDistance(
        -- Эмбеддинг вашего исходного изображения собаки
        [0.5736801028251648, 0.2516217529773712, ...,  -0.6825592517852783],
        image_embedding
    ) AS score
FROM images
ORDER BY score ASC
LIMIT 10
```

Этот запрос возвращает значения `_file` и `caption` для 10 изображений, которые с наибольшей вероятностью связаны с переданным вами изображением собаки.


## Дополнительные материалы \{#further-reading\}

Чтобы ознакомиться с более подробным руководством по векторному поиску с использованием ClickHouse, см.:

- [Точный и приближённый векторный поиск](https://clickhouse.com/docs/engines/table-engines/mergetree-family/annindexes)