---
title: Как вычислить долю пустых и нулевых значений в каждом столбце таблицы
description: Узнайте, как вычислить долю пустых или нулевых значений в каждом столбце таблицы ClickHouse для оптимизации сериализации разреженных столбцов.
date: 2023-05-18
tags: ['Производительность и оптимизация']
keywords: ['Доля пустых и нулевых значений', 'Расчет']
---

{frontMatter.description}

{/* усечь */}

## Как вычислить долю пустых/нулевых значений в каждом столбце таблицы \{#how-to-calculate-the-ratio-of-emptyzero-values-in-every-column-in-a-table\}

Если столбец разреженный (пустой или преимущественно содержит нули), ClickHouse может сохранять его в разреженном формате и автоматически оптимизировать вычисления — данные не требуют полной декомпрессии при выполнении запросов. Более того, если вы знаете, насколько разрежен столбец, вы можете задать долю таких значений с помощью настройки [`ratio_of_defaults_for_sparse_serialization`](https://clickhouse.com/docs/operations/settings/merge-tree-settings#ratio_of_defaults_for_sparse_serialization) для оптимизации сериализации.

Этот удобный запрос может выполняться довольно долго, но он анализирует каждую строку в вашей таблице и определяет долю значений, которые равны нулю (или значению по умолчанию) в каждом столбце указанной таблицы:

```sql
SELECT *
    APPLY x -> (x = defaultValueOfArgumentType(x)) APPLY avg APPLY x -> round(x, 3)
FROM table_name
FORMAT Vertical
```

Например, мы выполнили приведённый выше запрос над таблицей `sensors` из [набора данных с датчиков окружающей среды](https://clickhouse.com/docs/getting-started/example-datasets/environmental-sensors), которая содержит более 20 млрд строк и 19 столбцов:

```sql
SELECT *
    APPLY x -> (x = defaultValueOfArgumentType(x)) APPLY avg APPLY x -> round(x, 3)
FROM sensors
FORMAT Vertical
```

Вот ответ:

```response

Строка 1:
──────
round(avg(equals(sensor_id, defaultValueOfArgumentType(sensor_id))), 3):                 0
round(avg(equals(sensor_type, defaultValueOfArgumentType(sensor_type))), 3):             0.159
round(avg(equals(location, defaultValueOfArgumentType(location))), 3):                   0
round(avg(equals(lat, defaultValueOfArgumentType(lat))), 3):                             0.001
round(avg(equals(lon, defaultValueOfArgumentType(lon))), 3):                             0.001
round(avg(equals(timestamp, defaultValueOfArgumentType(timestamp))), 3):                 0
round(avg(equals(P1, defaultValueOfArgumentType(P1))), 3):                               0.474
round(avg(equals(P2, defaultValueOfArgumentType(P2))), 3):                               0.475
round(avg(equals(P0, defaultValueOfArgumentType(P0))), 3):                               0.995
round(avg(equals(durP1, defaultValueOfArgumentType(durP1))), 3):                         0.999
round(avg(equals(ratioP1, defaultValueOfArgumentType(ratioP1))), 3):                     0.999
round(avg(equals(durP2, defaultValueOfArgumentType(durP2))), 3):                         1
round(avg(equals(ratioP2, defaultValueOfArgumentType(ratioP2))), 3):                     1
round(avg(equals(pressure, defaultValueOfArgumentType(pressure))), 3):                   0.83
round(avg(equals(altitude, defaultValueOfArgumentType(altitude))), 3):                   1
round(avg(equals(pressure_sealevel, defaultValueOfArgumentType(pressure_sealevel))), 3): 1
round(avg(equals(temperature, defaultValueOfArgumentType(temperature))), 3):             0.532
round(avg(equals(humidity, defaultValueOfArgumentType(humidity))), 3):                   0.544

Получена 1 строка. Затрачено: 992.041 сек. Обработано 20.69 млрд строк, 1.39 ТБ (20.86 млн строк/сек., 1.40 ГБ/сек.)
```

Исходя из приведённых выше результатов:

* столбец `sensor_id` вовсе не разреженный: в каждой строке есть ненулевое значение
* столбец `sensor_type` разрежен лишь примерно в 15,9% строк
* столбец `P0` очень разреженный: 99,9% значений равны нулю
* столбец `pressure` довольно разреженный — 83%
* а у столбца `temperature` 53,2% значений отсутствуют или равны нулю

Как уже говорилось, этот запрос удобен для оценки разреженности столбцов в таблице ClickHouse!
