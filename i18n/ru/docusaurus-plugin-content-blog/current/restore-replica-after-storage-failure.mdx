---
date: 2025-11-19
title: Как восстановить реплику после сбоя хранилища
tags: ['Развертывание и масштабирование']
keywords: ['восстановление', 'реплика', 'сбой хранилища', 'база данных Atomic']
description: 'В этой статье объясняется, как восстановить данные при использовании реплицированных таблиц в базах данных Atomic в ClickHouse, если диски/хранилище на одной из реплик были потеряны или повреждены.'
---

{frontMatter.description}

{/* усечение */}

<br />

<br />

:::note
В этом руководстве предполагается, что параметр `<path>` в вашем файле config.xml задан как:

```text
<path>/var/lib/clickhouse/</path>
```

Если вы настроили другой путь к данным, замените все вхождения `/var/lib/clickhouse` в приведённых ниже командах фактическим значением параметра `<path>`.
:::

<VerticalStepper headerLevel="h2">
  ## Скопируйте конфигурацию доступа с исправной реплики

  Скопируйте содержимое папки `access`, которая содержит локальных пользователей, с исправной реплики:

  ```text
  /var/lib/clickhouse/access
  ```

  ## Создайте резервную копию каталога metadata с исправной реплики

  1. Перейдите в каталог данных ClickHouse:

  ```text
  cd /var/lib/clickhouse
  ```

  2. Создайте резервную копию каталога metadata (включая символьные ссылки). Каталог metadata содержит DDL для баз данных и таблиц.
     Каталоги баз данных содержат символьные ссылки на `/var/lib/clickhouse/store/..`, в котором находятся все DDL таблиц.

  ```bash
  { find metadata -type f; find metadata -type l; find metadata -type l | xargs readlink -f; } | tar -cPf backup.tar --files-from=-
  ```

  :::note
  Эта команда гарантирует, что как **файлы metadata**, так и структура символьных ссылок будут сохранены в резервной копии.
  :::

  ## Восстановите metadata на проблемной реплике

  1. Скопируйте сгенерированный файл `backup.tar` на проблемную реплику.
  2. Распакуйте его в каталог данных ClickHouse:

  ```text
  cd /var/lib/clickhouse/
  tar -xvPf backup.tar
  ```

  ## Создайте флаг принудительного восстановления

  Чтобы инициировать автоматическую синхронизацию данных с других реплик, создайте следующий флаг:

  ```text
  sudo -u clickhouse touch /var/lib/clickhouse/flags/force_restore_data
  ```

  ## Перезапустите проблемную реплику

  1. Перезапустите сервер ClickHouse на проблемном узле.
  2. Проверьте журналы сервера — вы должны увидеть, что части загружаются с исправных реплик:

  ```bash
  2025.11.02 00:00:04.047097 [ 682 ] {} <Debug> analytics.events_local (...) (Fetcher): Downloading files 23
  2025.11.02 00:00:04.055542 [ 682 ] {} <Debug> analytics.events_local (...) (Fetcher): Download of part 202511_0_0_0 onto disk disk2 finished.
  2025.11.02 00:00:04.101888 [ 687 ] {} <Debug> warehouse.customers_local (...) (Fetcher): Downloading part 2025_0_0_1 onto disk default.
  2025.11.02 00:00:04.102005 [ 687 ] {} <Debug> warehouse.customers_local (...) (Fetcher): Downloading files 11
  2025.11.02 00:00:04.102210 [ 690 ] {} <Debug> warehouse.customers_local (...) (Fetcher): Downloading part 2022_0_0_1 onto disk disk1.
  2025.11.02 00:00:04.102247 [ 688 ] {} <Debug> warehouse.customers_local (...) (Fetcher): Downloading part 2021_0_0_1 onto disk disk2.
  2025.11.02 00:00:04.102331 [ 690 ] {} <Debug> warehouse.customers_local (...) (Fetcher): Downloading files 11
  ```
</VerticalStepper>
