---
title: Как отфильтровать таблицу ClickHouse по столбцу-массиву?
description: "Статья из базы знаний о фильтрации таблицы ClickHouse по столбцу-массиву."
date: 2024-12-17
tags: ['Моделирование данных', 'Функции']
keywords: ['Фильтрация', 'Столбец-массив']
---

{frontMatter.description}

{/* усечение */}


## Введение \{#introduction\}

Фильтрация таблицы ClickHouse по столбцу-массиву — распространённая задача, и продукт предлагает множество [функций](/sql-reference/functions/array-functions) для работы со столбцами-массивами.

В этой статье мы сосредоточимся на фильтрации таблицы по столбцу-массиву, но в размещённом ниже видео также рассматривается множество других функций для работы с массивами:

<iframe width="560" height="315" src="https://www.youtube.com/embed/JKHAdCFtYDg?si=OqS3ry1LFrOlF8Iy" title="Видеопроигрыватель YouTube" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

## Пример

В качестве примера используем таблицу с двумя столбцами `tags_string` и `tags_int`, которые содержат массивы строк и целых чисел соответственно.

* Создайте тестовую базу данных и таблицу.

```sql
CREATE DATABASE db1;
```

* Создайте тестовую таблицу

```sql
CREATE TABLE db1.tags_table
(
    `id` UInt64,
    `tags_string` Array(String),
    `tags_int` Array(UInt64),
)
ENGINE = MergeTree
ORDER BY id;
```

* Вставьте в таблицу примерные данные.

```sql
INSERT INTO db1.tags_table VALUES (1, ['tag1', 'tag2', 'tag3'], [1, 2, 3]), (2, ['tag2', 'tag3', 'tag4'], [2, 3, 4]), (3, ['tag1', 'tag3', 'tag5'], [1, 3, 5]);
```

Отфильтруйте таблицу с помощью функции `has(arr, elem)`, чтобы получить строки, в которых массив `arr` содержит элемент `elem`.

Отфильтруйте таблицу, чтобы получить строки, в которых массив `tags_string` содержит элемент `tag1`.

```sql
SELECT * FROM db1.tags_table WHERE has(tags_string, 'tag1');
```

```text
┌─id─┬─tags_string────────────┬─tags_int─┐
│  1 │ ['tag1','tag2','tag3'] │ [1,2,3]  │
│  3 │ ['tag1','tag3','tag5'] │ [1,3,5]  │
└────┴────────────────────────┴──────────┘
```

Используйте функцию `hasAll(arr, elems)`, чтобы получить строки, в которых все элементы массива `elems` входят в массив `arr`.

Отфильтруйте таблицу так, чтобы получить строки, в которых все элементы массива `tags_string` входят в массив `['tag1', 'tag2']`.

```sql
SELECT * FROM db1.tags_table WHERE hasAll(tags_string, ['tag1', 'tag2']);
```

```text
┌─id─┬─tags_string────────────┬─tags_int─┐
│  1 │ ['tag1','tag2','tag3'] │ [1,2,3]  │
└────┴────────────────────────┴──────────┘
```

Используйте функцию `hasAny(arr, elems)`, чтобы получить строки, в которых хотя бы один элемент из массива `elems` присутствует в массиве `arr`.

Отфильтруйте таблицу так, чтобы получить строки, в которых хотя бы один элемент из массива `tags_string` присутствует в массиве `['tag1', 'tag2']`.

```sql
SELECT * FROM db1.tags_table WHERE hasAny(tags_string, ['tag1', 'tag2']);
```

```text
┌─id─┬─tags_string────────────┬─tags_int─┐
│  1 │ ['tag1','tag2','tag3'] │ [1,2,3]  │
│  2 │ ['tag2','tag3','tag4'] │ [2,3,4]  │
│  3 │ ['tag1','tag3','tag5'] │ [1,3,5]  │
└────┴────────────────────────┴──────────┘
```

Мы можем использовать лямбда-функцию для фильтрации таблицы с помощью функции `arrayExists(lambda, arr)`.

Отфильтруйте таблицу так, чтобы получить строки, в которых хотя бы один элемент массива `tags_int` больше 3.

```sql
SELECT * FROM db1.tags_table WHERE arrayExists(x -> x > 3, tags_int);
```

```text
┌─id─┬─tags_string────────────┬─tags_int─┐
│  2 │ ['tag2','tag3','tag4'] │ [2,3,4]  │
│  3 │ ['tag1','tag3','tag5'] │ [1,3,5]  │
└────┴────────────────────────┴──────────┘
```
