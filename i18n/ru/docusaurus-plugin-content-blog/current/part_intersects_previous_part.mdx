---
title: "DB::Exception: Part XXXXX intersects previous part YYYYY. It is a bug or a result of manual intervention in the ZooKeeper data."
date: 2023-05-02
description: "В этой статье объясняется, как устранить ошибку DB::Exception, связанную с пересечением частей в ClickHouse, которая часто возникает из‑за состояния гонки (race condition) или ручного вмешательства в данные ZooKeeper."
tags: ['Ошибки и исключения', 'Системные таблицы']
keywords: ['Пересечение частей', 'system.replicas']
---

{frontMatter.description}

{/* обрезать */}


## Почему это происходит

Когда возникает эта ошибка, таблица отображается как доступная только для чтения, а в сообщении об ошибке указываются пересекающиеся части.

Вы можете увидеть эту ошибку в логах или с помощью

```sql
SELECT *
FROM system.replicas
WHERE is_readonly = 1
```

Сообщение об ошибке выглядит следующим образом:

```
Код: 49. DB::Exception: Часть XXXXX пересекается с предыдущей частью YYYYY. Это баг или результат ручного вмешательства в данные ZooKeeper. (LOGICAL_ERROR) (версия 21.12.4.1 (официальная сборка))
```


## Причина ошибки \{#cause-of-the-error\}

Эта ошибка может возникать из-за состояния гонки между `mergeSelectingTask` и повторной инициализацией очереди.

## Решение

Выполните следующие запросы на всех репликах:

```sql
DETACH TABLE table_name;  -- Необходимо для DROP REPLICA

SYSTEM DROP REPLICA 'replica_name' FROM ZKPATH '/table_path_in_zk/'; -- Удалит все данные из /table_path_in_zk

ATTACH TABLE table_name;  -- Таблица будет в режиме только для чтения, поскольку метаданные в ZK отсутствуют
```

Далее выполните следующее на всех репликах:

```sql
SYSTEM RESTORE REPLICA table_name;  -- Отсоединит все партиции, пересоздаст метаданные в ZK (как для новой пустой таблицы), а затем присоединит все партиции обратно

SYSTEM SYNC REPLICA table_name; -- Ожидает синхронизации кусков данных между репликами. Также рекомендуется проверить `system.detached_parts` на всех репликах после завершения восстановления.
```

:::tip
Рекомендуется обновиться до последней версии ClickHouse.
:::


## Дополнительные ресурсы \{#additional-resources\}

Связанные pull request’ы и задачи в GitHub:

- [ClickHouse/ClickHouse#34096](https://github.com/ClickHouse/ClickHouse/pull/34096)
- [ClickHouse/ClickHouse#30651](https://github.com/ClickHouse/ClickHouse/pull/30651)
- [ClickHouse/ClickHouse#31060](https://github.com/ClickHouse/ClickHouse/pull/31060)
- [ClickHouse/ClickHouse#35863](https://github.com/ClickHouse/ClickHouse/issues/35863)

## Затронутые версии: \{#versions-affected\}

ClickHouse v 22.12 и более ранние версии