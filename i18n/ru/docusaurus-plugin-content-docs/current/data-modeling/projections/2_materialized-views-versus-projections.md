---
slug: /managing-data/materialized-views-versus-projections
sidebar_label: 'Материализованные представления vs проекции'
title: 'Материализованные представления vs проекции'
hide_title: false
description: 'Статья, сравнивающая материализованные представления и проекции в ClickHouse, включая их варианты использования, влияние на производительность и ограничения.'
doc_type: 'reference'
keywords: ['materialized views', 'projections', 'differences']
---

> Один из частых вопросов пользователей — когда использовать материализованные представления, а когда 
проекции. В этой статье мы рассмотрим ключевые различия между ними и объясним, почему в определённых сценариях 
может быть предпочтительнее выбрать один вариант, а не другой.



## Сводка ключевых различий {#key-differences}

В таблице ниже приведены ключевые различия между материализованными представлениями и проекциями по различным аспектам.

| Аспект                                                                           | Материализованные представления                                                                                                                                                                                                                                                                                                                                                        | Проекции                                                                                                                                                                                                                                                                                            |
| -------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Хранение и расположение данных                                                   | Сохраняют результаты в **отдельной, явно указанной целевой таблице**, действуя как триггеры вставки при добавлении данных в исходную таблицу.                                                                                                                                                                                                                                          | Создают оптимизированные структуры данных, которые физически **хранятся вместе с данными основной таблицы** и невидимы для пользователя.                                                                                                                                                            |
| Механизм обновления                                                              | Работают **синхронно** при выполнении `INSERT` в исходную таблицу (для инкрементных материализованных представлений). Примечание: также могут быть **запланированы** с использованием обновляемых материализованных представлений.                                                                                                                                                      | **Асинхронные** обновления в фоновом режиме при выполнении `INSERT` в основную таблицу.                                                                                                                                                                                                             |
| Взаимодействие с запросами                                                       | Работа с материализованными представлениями требует выполнения запросов **непосредственно к целевой таблице**, что означает необходимость знать о существовании материализованных представлений при написании запросов.                                                                                                                                                                  | **Автоматически выбираются** оптимизатором запросов ClickHouse и являются прозрачными в том смысле, что пользователю не нужно изменять запросы к таблице с проекцией для её использования. Начиная с версии 25.6 также возможна фильтрация по нескольким проекциям.                                 |
| Обработка `UPDATE` / `DELETE`                                                    | **Не реагируют автоматически** на операции `UPDATE` или `DELETE` в исходной таблице, поскольку материализованные представления не имеют информации об исходной таблице и действуют только как триггеры вставки _в_ исходную таблицу. Это может привести к устареванию данных между исходной и целевой таблицами и требует обходных решений или периодического полного обновления (через обновляемое материализованное представление). | По умолчанию **несовместимы с удалёнными строками** (особенно с лёгкими удалениями). Параметр `lightweight_mutation_projection_mode` (v24.7+) может обеспечить совместимость.                                                                                                                        |
| Поддержка `JOIN`                                                                 | Да. Обновляемые материализованные представления могут использоваться для сложной денормализации. Инкрементные материализованные представления срабатывают только при вставках в крайнюю левую таблицу.                                                                                                                                                                                  | Нет. Операции `JOIN` не поддерживаются в определениях проекций для фильтрации материализованных данных.                                                                                                                                                                                             |
| Условие `WHERE` в определении                                                    | Да. Условия `WHERE` могут быть включены для фильтрации данных перед материализацией.                                                                                                                                                                                                                                                                                                  | Нет. Условия `WHERE` не поддерживаются в определениях проекций для фильтрации материализованных данных.                                                                                                                                                                                             |
| Возможности цепочек                                                              | Да, целевая таблица одного материализованного представления может быть источником для другого материализованного представления, что позволяет создавать многоэтапные конвейеры.                                                                                                                                                                                                        | Нет. Проекции не могут быть объединены в цепочки.                                                                                                                                                                                                                                                   |
| Применимые движки таблиц                                                         | Могут использоваться с различными движками исходных таблиц, но целевые таблицы обычно относятся к семейству `MergeTree`.                                                                                                                                                                                                                                                              | **Доступны только** для движков таблиц семейства `MergeTree`.                                                                                                                                                                                                                                       |
| Обработка сбоев                                                                  | Сбой при вставке данных означает потерю данных в целевой таблице, что приводит к потенциальной несогласованности.                                                                                                                                                                                                                                                                      | Сбои обрабатываются **незаметно** в фоновом режиме. Запросы могут беспрепятственно работать со смешанными материализованными и нематериализованными частями.                                                                                                                                        |
| Операционные издержки                                                            | Требуют явного создания целевой таблицы и часто ручного заполнения. Управление согласованностью при операциях `UPDATE`/`DELETE` увеличивает сложность.                                                                                                                                                                                                                                 | Автоматически поддерживаются и синхронизируются, и в целом имеют меньшие операционные издержки.                                                                                                                                                                                                     |
| Совместимость с запросами `FINAL`                                                | В целом совместимы, но часто требуют `GROUP BY` в целевой таблице.                                                                                                                                                                                                                                                                                                                     | **Не работают** с запросами `FINAL`.                                                                                                                                                                                                                                                                |
| Ленивая материализация                                                           | Да.                                                                                                                                                                                                                                                                                                                                                                                    | Следите за проблемами совместимости проекций при использовании функций материализации. Возможно, потребуется установить `query_plan_optimize_lazy_materialization = false`                                                                                                                          |
| Параллельные реплики                                                             | Да.                                                                                                                                                                                                                                                                                                                                                                                    | Нет.                                                                                                                                                                                                                                                                                                |
| [`optimize_read_in_order`](/operations/settings/settings#optimize_read_in_order) | Да.                                                                                                                                                                                                                                                                                                                                                                                    | Да.                                                                                                                                                                                                                                                                                                 |
| Лёгкие обновления и удаления                                                     | Да.                                                                                                                                                                                                                                                                                                                                                                                    | Нет.                                                                                                                                                                                                                                                                                                |


## Сравнение материализованных представлений и проекций {#choose-between}

### Когда выбирать материализованные представления {#choosing-materialized-views}

Рекомендуется использовать материализованные представления в следующих случаях:

- Работа с **конвейерами данных реального времени и многоэтапными ETL-процессами:** когда необходимо выполнять сложные преобразования, агрегации или маршрутизацию данных по мере их поступления, потенциально через несколько этапов путём объединения представлений в цепочки.
- Требуется **сложная денормализация**: когда необходимо предварительно объединить данные из нескольких источников (таблиц, подзапросов или словарей) в единую таблицу, оптимизированную для запросов, особенно если допустимы периодические полные обновления с использованием обновляемых материализованных представлений.
- Требуется **явное управление схемой**: когда необходима отдельная целевая таблица с собственной схемой и движком для предварительно вычисленных результатов, что обеспечивает большую гибкость при моделировании данных.
- Требуется **фильтрация при загрузке**: когда необходимо фильтровать данные _до_ их материализации, уменьшая объём данных, записываемых в целевую таблицу.

### Когда следует избегать материализованных представлений {#avoid-materialized-views}

Рекомендуется отказаться от использования материализованных представлений в следующих случаях:

- **Исходные данные часто обновляются или удаляются**: без дополнительных стратегий обеспечения согласованности между исходной и целевой таблицами инкрементные материализованные представления могут устареть и стать несогласованными.
- **Предпочтительны простота и автоматическая оптимизация**: если необходимо избежать управления отдельными целевыми таблицами.

### Когда выбирать проекции {#choosing-projections}

Рекомендуется использовать проекции в следующих случаях:

- **Оптимизация запросов для одной таблицы**: когда основная цель — ускорить запросы к одной базовой таблице путём предоставления альтернативных порядков сортировки, оптимизации фильтров по столбцам, не входящим в первичный ключ, или предварительного вычисления агрегаций для одной таблицы.
- Требуется **прозрачность запросов**: когда запросы должны обращаться к исходной таблице без изменений, полагаясь на то, что ClickHouse выберет оптимальную структуру данных для конкретного запроса.

### Когда следует избегать проекций {#avoid-projections}

Рекомендуется отказаться от использования проекций в следующих случаях:

- **Требуются сложные преобразования данных или многоэтапные ETL-процессы**: проекции не поддерживают операции `JOIN` в своих определениях, не могут быть объединены для построения многошаговых конвейеров и не поддерживают некоторые возможности SQL, такие как оконные функции или сложные операторы `CASE`. Поэтому они не подходят для сложных преобразований данных.
- **Требуется явная фильтрация материализованных данных**: проекции не поддерживают условия `WHERE` в своём определении для фильтрации данных, которые материализуются в саму проекцию.
- **Используются движки таблиц, отличные от MergeTree**: проекции доступны исключительно для таблиц, использующих семейство движков `MergeTree`.
- Запросы с `FINAL` являются критичными: проекции не работают с запросами `FINAL`, которые иногда используются для дедупликации.
- Требуются [параллельные реплики](/deployment-guides/parallel-replicas), поскольку они не поддерживаются с проекциями.


## Резюме {#summary}

Материализованные представления и проекции — это мощные инструменты в вашем арсенале для
оптимизации запросов и преобразования данных. В целом мы рекомендуем не рассматривать
их использование как выбор «либо-либо». Напротив, они могут применяться взаимодополняюще,
чтобы извлечь максимум из ваших запросов. Таким образом, выбор между материализованными
представлениями и проекциями в ClickHouse зависит от вашего конкретного сценария использования и
шаблонов доступа.

Как правило, следует рассматривать использование материализованных представлений, когда
необходимо агрегировать данные из одной или нескольких исходных таблиц в целевую таблицу или
выполнять сложные преобразования в больших объёмах. Материализованные представления отлично подходят для переноса
работы ресурсоёмких агрегаций с момента выполнения запроса на момент вставки данных. Они являются
отличным выбором для ежедневных или ежемесячных сводок, дашбордов реального времени или агрегированных данных.

С другой стороны, следует использовать проекции, когда необходимо оптимизировать запросы,
которые фильтруют по столбцам, отличным от тех, которые используются в первичном
ключе таблицы, определяющем физический порядок данных на диске. Они особенно
полезны, когда уже невозможно изменить первичный ключ таблицы или когда
ваши шаблоны доступа более разнообразны, чем может обеспечить первичный ключ.
