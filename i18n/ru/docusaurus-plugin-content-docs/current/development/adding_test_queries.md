---
slug: /development/adding_test_queries
sidebar_label: Добавление тестовых запросов
sidebar_position: 63
title: Как добавить тестовые запросы в ClickHouse CI
description: Инструкции по добавлению тестового случая в непрерывную интеграцию ClickHouse
---

ClickHouse имеет сотни (или даже тысячи) функций. Каждое изменение проверяется сложным набором тестов, содержащих много тысяч тестовых случаев.

Основная функциональность хорошо протестирована, но некоторые крайние случаи и разные комбинации функций можно обнаружить с помощью ClickHouse CI.

Большинство ошибок/регрессий происходит в этой "серой зоне", где покрытие тестами оставляет желать лучшего.

И нам очень важно охватить большинство возможных сценариев и комбинаций функций, используемых в реальной жизни, с помощью тестов.

## Почему стоит добавлять тесты {#why-adding-tests}

Почему/когда вы должны добавить тестовый случай в код ClickHouse:
1) вы используете какие-то сложные сценарии / комбинации функций / у вас есть какой-то крайний случай, который, вероятно, не используется широко
2) вы замечаете, что определенное поведение изменяется между версиями без уведомлений в журнале изменений
3) вы просто хотите помочь улучшить качество ClickHouse и гарантировать, что функции, которые вы используете, не будут сломаны в будущих релизах
4) как только тест добавлен/принят, вы можете быть уверены, что крайний случай, который вы проверяете, никогда не будет случайно сломан.
5) вы станете частью великого сообщества с открытым исходным кодом
6) ваше имя будет видно в таблице `system.contributors`!
7) вы сделаете мир немного лучше :)

### Шаги для выполнения {#steps-to-do}

#### Предварительные требования {#prerequisite}

Я предполагаю, что вы используете какую-то машину на Linux (вы можете использовать docker / виртуальные машины на других ОС) и любой современный браузер / интернет-соединение, и у вас есть базовые навыки работы с Linux и SQL.

Не требуется никаких высокоспециализированных знаний (так что вам не нужно знать C++ или что-то о том, как работает ClickHouse CI).

#### Подготовка {#preparation}

1) [создать аккаунт на GitHub](https://github.com/join) (если у вас его еще нет)
2) [настроить git](https://docs.github.com/en/free-pro-team@latest/github/getting-started-with-github/set-up-git)
```bash

# для Ubuntu
sudo apt-get update
sudo apt-get install git

git config --global user.name "John Doe" # заполните своим именем
git config --global user.email "email@example.com" # заполните своим email

```
3) [создать форк проекта ClickHouse](https://docs.github.com/en/free-pro-team@latest/github/getting-started-with-github/fork-a-repo) - просто откройте [https://github.com/ClickHouse/ClickHouse](https://github.com/ClickHouse/ClickHouse) и нажмите кнопку форк в правом верхнем углу:
![форк репозитория](https://github-images.s3.amazonaws.com/help/bootcamp/Bootcamp-Fork.png)

4) клонируйте свой форк в какую-то папку на своем ПК, например, `~/workspace/ClickHouse`
```
mkdir ~/workspace && cd ~/workspace
git clone https://github.com/< вашеимянаGitHub>/ClickHouse
cd ClickHouse
git remote add upstream https://github.com/ClickHouse/ClickHouse
```

#### Новая ветка для теста {#new-branch-for-the-test}

1) создайте новую ветку из последнего мастера ClickHouse
```
cd ~/workspace/ClickHouse
git fetch upstream
git checkout -b name_for_a_branch_with_my_test upstream/master
```

#### Установить и запустить ClickHouse {#install--run-clickhouse}

1) установите `clickhouse-server` (следуйте [официальной документации](/getting-started/install))
2) установите тестовые конфигурации (это будет использовать имитацию Zookeeper и настроит некоторые параметры)
```
cd ~/workspace/ClickHouse/tests/config
sudo ./install.sh
```
3) запустите clickhouse-server
```
sudo systemctl restart clickhouse-server
```

#### Создание тестового файла {#creating-the-test-file}

1) найдите номер для вашего теста - найдите файл с наибольшим номером в `tests/queries/0_stateless/`

```sh
$ cd ~/workspace/ClickHouse
$ ls tests/queries/0_stateless/[0-9]*.reference | tail -n 1
tests/queries/0_stateless/01520_client_print_query_id.reference
```
В настоящее время последний номер для теста `01520`, так что мой тест будет иметь номер `01521`.

2) создайте SQL файл с следующим числом и именем функции, которую вы тестируете

```sh
touch tests/queries/0_stateless/01521_dummy_test.sql
```

3) отредактируйте SQL файл с использованием вашего любимого редактора (см. подсказку о создании тестов ниже)
```sh
vim tests/queries/0_stateless/01521_dummy_test.sql
```

4) запустите тест и запишите результат в файл ссылок:
```
clickhouse-client -nm < tests/queries/0_stateless/01521_dummy_test.sql | tee tests/queries/0_stateless/01521_dummy_test.reference
```

5) убедитесь, что все правильно, если вывод теста неверен (например, из-за ошибки), отредактируйте файл ссылок с помощью текстового редактора.

#### Как создать хороший тест {#how-to-create-a-good-test}

- Тест должен быть
	- минимальным - создавать только таблицы, относящиеся к тестируемой функциональности, удалять нерелевантные колонки и части запроса
	- быстрым - не должен занимать больше нескольких секунд (лучше подсекунд)
	- корректным - должен провалиться, если функция не работает
        - детерминированным
	- изолированным / статeless
		- не полагаться на какие-либо вещи окружения
		- не полагаться на тайминг, когда это возможно
- старайтесь охватывать крайние случаи (нули / Null / пустые наборы / выбрасывание исключений)
- чтобы проверить, что запрос возвращает ошибки, вы можете поставить специальный комментарий после запроса: `-- { serverError 60 }` или `-- { clientError 20 }`
- не переключайте базы данных (если это не необходимо)
- вы можете создать несколько реплик таблиц на одном узле, если это необходимо
- вы можете использовать одно из определений тестового кластера, когда это необходимо (см. system.clusters)
- используйте `number` / `numbers_mt` / `zeros` / `zeros_mt` и аналогичные для запросов / инициализации данных, когда это применимо
- очищайте созданные объекты после теста и перед тестом (DROP IF EXISTS) - на случай грязного состояния
- предпочитайте синхронный режим операций (мутации, слияния и т. д.)
- используйте другие SQL файлы в папке `0_stateless` в качестве примера
- убедитесь, что функциональность / комбинация функций, которую вы хотите протестировать, еще не охвачена существующими тестами

#### Правила именования тестов {#test-naming-rules}

Важно правильно называть тесты, чтобы можно было отключить некоторый подсет тестов в вызове clickhouse-test.

| Флаг тестирования | Что должно быть в имени теста | Когда флаг должен быть добавлен |
|---|---|---|---|
| `--[no-]zookeeper`| "zookeeper" или "replica" | Тест использует таблицы из семейства `ReplicatedMergeTree` |
| `--[no-]shard` | "shard" или "distributed" или "global"| Тест использует соединения с 127.0.0.2 или подобными |
| `--[no-]long` | "long" или "deadlock" или "race" | Тест выполняется дольше 60 секунд |

#### Коммит / пуш / создание PR. {#commit--push--create-pr}

1) закоммитьте и запушьте ваши изменения
```sh
cd ~/workspace/ClickHouse
git add tests/queries/0_stateless/01521_dummy_test.sql
git add tests/queries/0_stateless/01521_dummy_test.reference
git commit # используйте какое-нибудь хорошее сообщение для коммита, когда это возможно
git push origin HEAD
```
2) используйте ссылку, которая была показана во время пуша, чтобы создать PR в основном репозитории
3) измените заголовок и содержимое PR, в категории журнала изменений (оставьте одну) оставьте
`Улучшение/Тестирование/Упаковка`, заполните остальные поля, если хотите.
