---
slug: /best-practices/use-materialized-views
sidebar_position: 10
sidebar_label: 'Материализованные представления'
title: 'Материализованные представления'
description: 'Страница, посвящённая материализованным представлениям'
keywords: ['materialized views', 'medallion architecture']
show_related_blogs: true
doc_type: 'guide'
---

import Image from '@theme/IdealImage';
import incremental_materialized_view from '@site/static/images/bestpractices/incremental_materialized_view.gif';
import refreshable_materialized_view from '@site/static/images/bestpractices/refreshable_materialized_view.gif';

ClickHouse поддерживает два типа материализованных представлений: [**инкрементные**](/materialized-view/incremental-materialized-view) и [**обновляемые**](/materialized-view/refreshable-materialized-view). Хотя оба вида предназначены для ускорения запросов за счет предварительного вычисления и хранения результатов, они существенно различаются по способу и моменту выполнения базовых запросов, типам рабочих нагрузок, для которых они подходят, и способу обеспечения актуальности данных.

**Пользователям стоит рассматривать материализованные представления для конкретных шаблонов запросов, которые нужно ускорить, при условии, что ранее уже были применены лучшие практики по выбору [типов данных](/best-practices/select-data-types) и [оптимизации первичного ключа](/best-practices/choosing-a-primary-key).**

**Инкрементные материализованные представления** обновляются в режиме реального времени. По мере вставки новых данных в исходную таблицу ClickHouse автоматически применяет запрос материализованного представления к новому блоку данных и записывает результаты в отдельную целевую таблицу. Со временем ClickHouse объединяет эти частичные результаты, формируя целостное и актуальное представление. Такой подход очень эффективен, поскольку переносит вычислительные затраты на момент вставки и обрабатывает только новые данные. В результате `SELECT`-запросы к целевой таблице выполняются быстро и с низкими накладными расходами. Инкрементные представления поддерживают все агрегатные функции и хорошо масштабируются — вплоть до петабайт данных, — поскольку каждый запрос работает с небольшим, недавно вставленным подмножеством данных.

<Image img={incremental_materialized_view} size="lg" alt="Materialized Views" />

**Обновляемые материализованные представления**, напротив, обновляются по расписанию. Эти представления периодически полностью переисполняют свой запрос и перезаписывают результат в целевой таблице. Это похоже на материализованные представления в традиционных OLTP-базах данных, таких как Postgres.

<Image img={refreshable_materialized_view} size="lg" alt="Refreshable materialized view diagram" />

Выбор между инкрементными и обновляемыми материализованными представлениями в значительной степени зависит от характера запроса, частоты изменения данных и того, нужно ли, чтобы обновления представления отражали каждую строку по мере ее вставки, или же допустимо периодическое обновление. Понимание этих компромиссов является ключом к проектированию производительных и масштабируемых материализованных представлений в ClickHouse.


## Когда использовать инкрементные материализованные представления {#when-to-use-incremental-materialized-views}

Инкрементные материализованные представления, как правило, предпочтительнее, поскольку они автоматически обновляются в реальном времени при поступлении новых данных в исходные таблицы. Они поддерживают все агрегатные функции и особенно эффективны для агрегаций над одной таблицей. Благодаря инкрементному вычислению результатов во время вставки запросы выполняются над значительно меньшими подмножествами данных, что позволяет таким представлениям легко масштабироваться даже до петабайтов данных. В большинстве случаев они не оказывают заметного влияния на общую производительность кластера.

Используйте инкрементные материализованные представления, когда:

- Требуются результаты запросов в реальном времени, обновляемые при каждой вставке.
- Необходимо часто агрегировать или фильтровать большие объёмы данных.
- Запросы включают простые преобразования или агрегации над одной таблицей.

Примеры инкрементных материализованных представлений см. [здесь](/materialized-view/incremental-materialized-view).


## Когда использовать обновляемые материализованные представления {#when-to-use-refreshable-materialized-views}

Обновляемые материализованные представления выполняют запросы периодически, а не инкрементально, сохраняя результирующий набор данных для быстрого получения.

Они наиболее полезны, когда критична производительность запросов (например, задержка менее миллисекунды), а незначительно устаревшие результаты допустимы. Поскольку запрос выполняется полностью заново, обновляемые представления лучше всего подходят для запросов, которые либо вычисляются относительно быстро, либо могут вычисляться с большими интервалами (например, раз в час), таких как кэширование результатов «топ N» или справочных таблиц.

Частоту выполнения следует настраивать тщательно, чтобы избежать чрезмерной нагрузки на систему. Очень сложные запросы, потребляющие значительные ресурсы, следует планировать осторожно — они могут привести к снижению общей производительности кластера, влияя на кэши и потребляя ресурсы процессора и памяти. Запрос должен выполняться относительно быстро по сравнению с интервалом обновления, чтобы избежать перегрузки кластера. Например, не следует планировать обновление представления каждые 10 секунд, если сам запрос выполняется не менее 10 секунд.


## Резюме {#summary}

Итак, используйте обновляемые материализованные представления в следующих случаях:

- Вам необходимы кешированные результаты запросов с мгновенным доступом, и допустимы небольшие задержки в актуальности данных.
- Вам необходимо получить топ N записей из результата запроса.
- Размер результирующего набора не растет неограниченно со временем. В противном случае это приведет к снижению производительности целевого представления.
- Вы выполняете сложные соединения или денормализацию с участием нескольких таблиц, требующие обновления при изменении любой из исходных таблиц.
- Вы создаете пакетные рабочие процессы, задачи денормализации или зависимости представлений, аналогичные DAG в DBT.

Примеры обновляемых материализованных представлений см. [здесь](/materialized-view/refreshable-materialized-view).

### Режимы APPEND и REPLACE {#append-vs-replace-mode}

Обновляемые материализованные представления поддерживают два режима записи данных в целевую таблицу: `APPEND` и `REPLACE`. Эти режимы определяют способ записи результата запроса представления при его обновлении.

`REPLACE` — режим по умолчанию. При каждом обновлении представления предыдущее содержимое целевой таблицы полностью перезаписывается последним результатом запроса. Этот режим подходит для случаев, когда представление должно всегда отражать актуальное состояние, например при кешировании результирующего набора.

`APPEND`, напротив, позволяет добавлять новые строки в конец целевой таблицы вместо замены её содержимого. Это открывает дополнительные сценарии использования, такие как создание периодических снимков состояния. `APPEND` особенно полезен, когда каждое обновление представляет отдельный момент времени или когда требуется историческое накопление результатов.

Выбирайте режим `APPEND`, когда:

- Вы хотите сохранить историю предыдущих обновлений.
- Вы создаете периодические снимки состояния или отчеты.
- Вам необходимо инкрементально собирать обновленные результаты с течением времени.

Выбирайте режим `REPLACE`, когда:

- Вам необходим только самый последний результат.
- Устаревшие данные должны быть полностью удалены.
- Представление отражает текущее состояние или справочные данные.

Пример применения функциональности `APPEND` можно найти при построении [архитектуры Medallion](https://clickhouse.com/blog/building-a-medallion-architecture-for-bluesky-json-data-with-clickhouse).
