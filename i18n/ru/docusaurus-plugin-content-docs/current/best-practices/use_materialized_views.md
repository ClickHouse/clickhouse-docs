---
slug: /best-practices/use-materialized-views
sidebar_position: 10
sidebar_label: 'Используйте материализованные представления'
title: 'Используйте материализованные представления'
description: 'Страница, описывающая материализованные представления'
keywords: ['материализованные представления', 'медальонная архитектура']
show_related_blogs: true
doc_type: 'guide'
---

import Image from '@theme/IdealImage';
import incremental_materialized_view from '@site/static/images/bestpractices/incremental_materialized_view.gif';
import refreshable_materialized_view from '@site/static/images/bestpractices/refreshable_materialized_view.gif';

ClickHouse поддерживает два типа материализованных представлений: [**инкрементные**](/materialized-view/incremental-materialized-view) и [**обновляемые по расписанию**](/materialized-view/refreshable-materialized-view). Оба типа предназначены для ускорения запросов за счёт предварительного вычисления и сохранения результатов, но существенно различаются по тому, как и когда выполняются исходные запросы, для каких типов нагрузок они подходят и как обеспечивается актуальность данных.

**Пользователям следует рассматривать использование материализованных представлений для конкретных типов (паттернов) запросов, которые необходимо ускорить, при условии, что предварительно были применены лучшие практики [выбора типов данных](/best-practices/select-data-types) и [оптимизации первичного ключа](/best-practices/choosing-a-primary-key).**

**Инкрементные материализованные представления** обновляются в режиме реального времени. При вставке новых данных в исходную таблицу ClickHouse автоматически применяет запрос материализованного представления к новому блоку данных и записывает результаты в отдельную целевую таблицу. Со временем ClickHouse объединяет эти частичные результаты, формируя полное, актуальное представление. Такой подход чрезвычайно эффективен, поскольку переносит вычислительные затраты на момент вставки и обрабатывает только новые данные. В результате запросы `SELECT` к целевой таблице выполняются быстро и с малой нагрузкой. Инкрементные представления поддерживают все агрегатные функции и хорошо масштабируются — вплоть до петабайт данных — поскольку каждый запрос обрабатывает лишь небольшое, недавнее подмножество вставляемого набора данных.

<Image img={incremental_materialized_view} size="lg" alt="Материализованные представления" />

**Обновляемые по расписанию материализованные представления**, напротив, обновляются по графику. Эти представления периодически полностью повторно выполняют свой запрос и перезаписывают результат в целевой таблице. Это похоже на материализованные представления в традиционных OLTP-базах данных, таких как Postgres.

<Image img={refreshable_materialized_view} size="lg" alt="Схема обновляемого по расписанию материализованного представления" />

Выбор между инкрементными и обновляемыми по расписанию материализованными представлениями во многом зависит от характера запроса, частоты изменения данных и от того, должны ли обновления представления отражать каждую строку по мере её вставки или же допустимо периодическое обновление. Понимание этих компромиссов имеет ключевое значение для проектирования производительных и масштабируемых материализованных представлений в ClickHouse.


## Когда использовать инкрементные материализованные представления {#when-to-use-incremental-materialized-views}

Инкрементные материализованные представления обычно являются предпочтительным выбором, поскольку они автоматически обновляются в режиме реального времени при поступлении новых данных в исходные таблицы. Они поддерживают все агрегатные функции и особенно эффективны для агрегаций над одной таблицей. Благодаря инкрементному вычислению результатов во время вставки запросы выполняются на значительно меньших подмножествах данных, что позволяет этим представлениям без труда масштабироваться даже до петабайтов данных. В большинстве случаев они не оказывают заметного влияния на общую производительность кластера.

Используйте инкрементные материализованные представления, когда:

- Требуются результаты запросов в режиме реального времени, обновляемые при каждой вставке.
- Необходимо часто агрегировать или фильтровать большие объёмы данных.
- Запросы включают простые преобразования или агрегации над одной таблицей.

Примеры инкрементных материализованных представлений см. [здесь](/materialized-view/incremental-materialized-view).


## Когда использовать обновляемые материализованные представления {#when-to-use-refreshable-materialized-views}

Обновляемые материализованные представления выполняют свои запросы периодически, а не инкрементально, сохраняя набор результатов запроса для быстрого получения.

Они наиболее полезны, когда производительность запросов критична (например, требуется задержка менее миллисекунды), а слегка устаревшие результаты допустимы. Поскольку запрос выполняется полностью заново, обновляемые представления лучше всего подходят для запросов, которые либо вычисляются относительно быстро, либо могут вычисляться с редкими интервалами (например, ежечасно), таких как кэширование результатов «top N» или справочных таблиц.

Частоту выполнения следует тщательно настраивать, чтобы избежать чрезмерной нагрузки на систему. Чрезвычайно сложные запросы, потребляющие значительные ресурсы, следует планировать осторожно — они могут привести к снижению общей производительности кластера, влияя на кэши и потребляя ресурсы процессора и памяти. Запрос должен выполняться относительно быстро по сравнению с интервалом обновления, чтобы избежать перегрузки кластера. Например, не следует планировать обновление представления каждые 10 секунд, если сам запрос выполняется не менее 10 секунд.


## Резюме {#summary}

Итак, используйте обновляемые материализованные представления, когда:

- Вам необходимы кешированные результаты запросов, доступные мгновенно, и допустимы небольшие задержки в актуальности данных.
- Вам необходимо получить первые N записей из набора результатов запроса.
- Размер набора результатов не растет неограниченно со временем. В противном случае это приведет к снижению производительности целевого представления.
- Вы выполняете сложные объединения или денормализацию с участием нескольких таблиц, требующие обновления при изменении любой из исходных таблиц.
- Вы создаете пакетные рабочие процессы, задачи денормализации или зависимости представлений, аналогичные DAG в DBT.

Примеры обновляемых материализованных представлений см. [здесь](/materialized-view/refreshable-materialized-view).

### Режимы APPEND и REPLACE {#append-vs-replace-mode}

Обновляемые материализованные представления поддерживают два режима записи данных в целевую таблицу: `APPEND` и `REPLACE`. Эти режимы определяют, как записывается результат запроса представления при его обновлении.

`REPLACE` — это режим по умолчанию. При каждом обновлении представления предыдущее содержимое целевой таблицы полностью перезаписывается последним результатом запроса. Этот режим подходит для случаев, когда представление должно всегда отражать актуальное состояние, например, при кешировании набора результатов.

`APPEND`, напротив, позволяет добавлять новые строки в конец целевой таблицы вместо замены её содержимого. Это открывает дополнительные варианты использования, такие как создание периодических снимков состояния. `APPEND` особенно полезен, когда каждое обновление представляет отдельный момент времени или когда требуется историческое накопление результатов.

Выбирайте режим `APPEND`, когда:

- Вы хотите сохранить историю прошлых обновлений.
- Вы создаете периодические снимки состояния или отчеты.
- Вам необходимо инкрементально собирать обновленные результаты с течением времени.

Выбирайте режим `REPLACE`, когда:

- Вам необходим только самый последний результат.
- Устаревшие данные должны быть полностью удалены.
- Представление отражает текущее состояние или содержит справочные данные.

Пользователи могут найти применение функциональности `APPEND` при построении [архитектуры Medallion](https://clickhouse.com/blog/building-a-medallion-architecture-for-bluesky-json-data-with-clickhouse).
