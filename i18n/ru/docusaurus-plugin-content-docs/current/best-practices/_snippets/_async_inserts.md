import Image from "@theme/IdealImage"
import async_inserts from "@site/static/images/bestpractices/async_inserts.png"

Асинхронные вставки в ClickHouse предоставляют мощную альтернативу, когда пакетирование на стороне клиента невозможно. Это особенно ценно для задач мониторинга и наблюдаемости, где сотни или тысячи агентов непрерывно отправляют данные — логи, метрики, трассировки — часто небольшими порциями в режиме реального времени. Буферизация данных на стороне клиента в таких средах усложняет архитектуру, требуя централизованной очереди для формирования достаточно больших пакетов.

:::note
Отправка множества небольших пакетов в синхронном режиме не рекомендуется, так как это приводит к созданию большого количества партов. Это ухудшит производительность запросов и вызовет ошибки ["too many part"](/knowledgebase/exception-too-many-parts).
:::

Асинхронные вставки переносят ответственность за пакетирование с клиента на сервер, записывая входящие данные в буфер в памяти и затем сбрасывая их в хранилище на основе настраиваемых пороговых значений. Такой подход значительно снижает накладные расходы на создание партов, уменьшает нагрузку на CPU и обеспечивает эффективность приема данных даже при высокой конкурентности.

Основное поведение управляется через настройку [`async_insert`](/operations/settings/settings#async_insert).

<Image img={async_inserts} size='lg' alt='Async inserts' />

При включении (1) вставки буферизуются и записываются на диск только после выполнения одного из условий сброса:

(1) буфер достигает указанного размера (async_insert_max_data_size)
(2) истекает временной порог (async_insert_busy_timeout_ms) или
(3) накапливается максимальное количество запросов вставки (async_insert_max_query_number).

Этот процесс пакетирования прозрачен для клиентов и помогает ClickHouse эффективно объединять трафик вставок из нескольких источников. Однако до момента сброса данные недоступны для запросов. Важно отметить, что для каждой формы вставки и комбинации настроек существует несколько буферов, а в кластерах буферы поддерживаются на каждом узле — что обеспечивает детальный контроль в мультитенантных средах. Механика вставок в остальном идентична описанной для [синхронных вставок](/best-practices/selecting-an-insert-strategy#synchronous-inserts-by-default).

### Выбор режима возврата {#choosing-a-return-mode}

Поведение асинхронных вставок дополнительно настраивается с помощью параметра [`wait_for_async_insert`](/operations/settings/settings#wait_for_async_insert).

При установке значения 1 (по умолчанию) ClickHouse подтверждает вставку только после успешного сброса данных на диск. Это обеспечивает строгие гарантии сохранности данных и упрощает обработку ошибок: если что-то пойдет не так во время сброса, ошибка возвращается клиенту. Этот режим рекомендуется для большинства производственных сценариев, особенно когда сбои вставок должны надежно отслеживаться.

[Бенчмарки](https://clickhouse.com/blog/asynchronous-data-inserts-in-clickhouse) показывают, что режим хорошо масштабируется при высокой конкурентности — независимо от того, работает ли 200 или 500 клиентов — благодаря адаптивным вставкам и стабильному поведению создания партов.

Установка `wait_for_async_insert = 0` включает режим «отправил и забыл». В этом случае сервер подтверждает вставку сразу после буферизации данных, не дожидаясь их записи в хранилище.

Это обеспечивает вставки с минимальной задержкой и максимальную пропускную способность, что идеально подходит для высокоскоростных данных низкой критичности. Однако это сопряжено с компромиссами: нет гарантии, что данные будут сохранены, ошибки могут проявиться только во время сброса, и сложно отследить неудачные вставки. Используйте этот режим только если ваша рабочая нагрузка допускает потерю данных.

[Бенчмарки также демонстрируют](https://clickhouse.com/blog/asynchronous-data-inserts-in-clickhouse) существенное сокращение количества партов и снижение нагрузки на CPU при редких сбросах буфера (например, каждые 30 секунд), но риск незаметного сбоя остается.

Мы настоятельно рекомендуем использовать `async_insert=1,wait_for_async_insert=1` при использовании асинхронных вставок. Использование `wait_for_async_insert=0` очень рискованно, поскольку ваш клиент INSERT может не узнать о наличии ошибок, а также может вызвать потенциальную перегрузку, если клиент продолжает быстро записывать данные в ситуации, когда серверу ClickHouse необходимо замедлить запись и создать обратное давление для обеспечения надежности сервиса.

### Дедупликация и надежность {#deduplication-and-reliability}

По умолчанию ClickHouse выполняет автоматическую дедупликацию для синхронных вставок, что делает повторные попытки безопасными в сценариях сбоев. Однако для асинхронных вставок это отключено, если не включено явно (это не следует включать, если у вас есть зависимые материализованные представления — [см. issue](https://github.com/ClickHouse/ClickHouse/issues/66003)).

На практике, если дедупликация включена и повторяется та же вставка — например, из-за таймаута или обрыва сети — ClickHouse может безопасно игнорировать дубликат. Это помогает поддерживать идемпотентность и избегать двойной записи данных. Тем не менее, стоит отметить, что валидация вставки и разбор схемы происходят только во время сброса буфера — поэтому ошибки (например, несоответствие типов) проявятся только в этот момент.


### Включение асинхронных вставок {#enabling-asynchronous-inserts}

Асинхронные вставки можно включить для конкретного пользователя или для определённого запроса:

- Включение асинхронных вставок на уровне пользователя. В этом примере используется пользователь `default`; если вы создали другого пользователя, укажите его имя:
  ```sql
  ALTER USER default SETTINGS async_insert = 1
  ```
- Настройки асинхронных вставок можно указать с помощью секции SETTINGS в запросах INSERT:
  ```sql
  INSERT INTO YourTable SETTINGS async_insert=1, wait_for_async_insert=1 VALUES (...)
  ```
- Настройки асинхронных вставок также можно указать в качестве параметров подключения при использовании клиентских библиотек ClickHouse для языков программирования.

  Например, вот как это можно сделать в строке подключения JDBC при использовании драйвера ClickHouse Java JDBC для подключения к ClickHouse Cloud:

  ```bash
  "jdbc:ch://HOST.clickhouse.cloud:8443/?user=default&password=PASSWORD&ssl=true&custom_http_params=async_insert=1,wait_for_async_insert=1"
  ```
