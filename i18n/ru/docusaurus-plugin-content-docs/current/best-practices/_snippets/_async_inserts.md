import Image from "@theme/IdealImage"
import async_inserts from "@site/static/images/bestpractices/async_inserts.png"

Асинхронные вставки в ClickHouse представляют собой мощную альтернативу в случаях, когда пакетирование на стороне клиента невозможно. Это особенно ценно для задач мониторинга и наблюдаемости, где сотни или тысячи агентов непрерывно отправляют данные — логи, метрики, трассировки — часто небольшими порциями в режиме реального времени. Буферизация данных на стороне клиента в таких средах усложняет архитектуру, требуя централизованной очереди для формирования достаточно больших пакетов перед отправкой.

:::note
Отправка множества небольших пакетов в синхронном режиме не рекомендуется, так как это приводит к созданию большого количества частей данных. Это ухудшает производительность запросов и вызывает ошибки ["too many parts"](/knowledgebase/exception-too-many-parts).
:::

Асинхронные вставки переносят ответственность за пакетирование с клиента на сервер: входящие данные записываются в буфер в памяти, а затем сбрасываются в хранилище при достижении настраиваемых пороговых значений. Такой подход значительно снижает накладные расходы на создание частей, уменьшает нагрузку на процессор и обеспечивает эффективный прием данных даже при высоком уровне конкурентности.

Основное поведение управляется настройкой [`async_insert`](/operations/settings/settings#async_insert).

<Image img={async_inserts} size='lg' alt='Async inserts' />

При включении (значение 1) вставки буферизуются и записываются на диск только после выполнения одного из условий сброса:

(1) буфер достигает указанного размера (async_insert_max_data_size)
(2) истекает временной порог (async_insert_busy_timeout_ms) или
(3) накапливается максимальное количество запросов вставки (async_insert_max_query_number).

Процесс пакетирования прозрачен для клиентов и позволяет ClickHouse эффективно объединять трафик вставок из нескольких источников. Однако до выполнения сброса данные недоступны для запросов. Важно отметить, что для каждой структуры вставки и комбинации настроек существует несколько буферов, а в кластерах буферы поддерживаются на каждом узле — это обеспечивает детальный контроль в многопользовательских средах. В остальном механика вставок идентична описанной для [синхронных вставок](/best-practices/selecting-an-insert-strategy#synchronous-inserts-by-default).

### Выбор режима возврата {#choosing-a-return-mode}

Поведение асинхронных вставок дополнительно настраивается с помощью параметра [`wait_for_async_insert`](/operations/settings/settings#wait_for_async_insert).

При установке значения 1 (по умолчанию) ClickHouse подтверждает вставку только после успешного сброса данных на диск. Это обеспечивает строгие гарантии сохранности данных и упрощает обработку ошибок: если во время сброса возникает проблема, ошибка возвращается клиенту. Этот режим рекомендуется для большинства производственных сценариев, особенно когда необходимо надежно отслеживать сбои вставок.

[Тесты производительности](https://clickhouse.com/blog/asynchronous-data-inserts-in-clickhouse) показывают, что режим хорошо масштабируется при высокой конкурентности — независимо от того, работает 200 или 500 клиентов — благодаря адаптивным вставкам и стабильному поведению при создании частей.

Установка `wait_for_async_insert = 0` включает режим «отправил и забыл». В этом случае сервер подтверждает вставку сразу после буферизации данных, не дожидаясь их записи в хранилище.

Это обеспечивает вставки с минимальной задержкой и максимальную пропускную способность, что идеально подходит для высокоскоростных данных низкой критичности. Однако это связано с компромиссами: нет гарантии сохранения данных, ошибки могут проявиться только во время сброса, и сложно отследить неудачные вставки. Используйте этот режим только в том случае, если ваша рабочая нагрузка допускает потерю данных.

[Тесты производительности также демонстрируют](https://clickhouse.com/blog/asynchronous-data-inserts-in-clickhouse) существенное сокращение количества частей и снижение нагрузки на процессор при редких сбросах буфера (например, каждые 30 секунд), но риск незаметного сбоя сохраняется.

Мы настоятельно рекомендуем использовать `async_insert=1,wait_for_async_insert=1` при работе с асинхронными вставками. Использование `wait_for_async_insert=0` очень рискованно, поскольку клиент INSERT может не узнать о возникших ошибках, а также это может вызвать потенциальную перегрузку, если клиент продолжает быстро записывать данные в ситуации, когда серверу ClickHouse необходимо замедлить запись и создать обратное давление для обеспечения надежности сервиса.

### Дедупликация и надежность {#deduplication-and-reliability}

По умолчанию ClickHouse выполняет автоматическую дедупликацию для синхронных вставок, что делает повторные попытки безопасными в сценариях сбоев. Однако для асинхронных вставок дедупликация отключена, если не включена явно (не следует включать дедупликацию при наличии зависимых материализованных представлений — [см. проблему](https://github.com/ClickHouse/ClickHouse/issues/66003)).

На практике, если дедупликация включена и повторяется та же вставка — например, из-за тайм-аута или обрыва сети — ClickHouse может безопасно игнорировать дубликат. Это помогает поддерживать идемпотентность и избегать двойной записи данных. Тем не менее стоит отметить, что проверка вставки и разбор схемы происходят только во время сброса буфера — поэтому ошибки (такие как несоответствие типов) проявятся только в этот момент.


### Включение асинхронных вставок {#enabling-asynchronous-inserts}

Асинхронные вставки можно включить для конкретного пользователя или для отдельного запроса:

- Включение асинхронных вставок на уровне пользователя. В этом примере используется пользователь `default`; если вы создаёте другого пользователя, укажите его имя:
  ```sql
  ALTER USER default SETTINGS async_insert = 1
  ```
- Настройки асинхронных вставок можно указать с помощью секции SETTINGS в запросах INSERT:
  ```sql
  INSERT INTO YourTable SETTINGS async_insert=1, wait_for_async_insert=1 VALUES (...)
  ```
- Настройки асинхронных вставок также можно указать в качестве параметров подключения при использовании клиентских библиотек ClickHouse для языков программирования.

  Например, вот как это можно сделать в строке подключения JDBC при использовании драйвера ClickHouse Java JDBC для подключения к ClickHouse Cloud:

  ```bash
  "jdbc:ch://HOST.clickhouse.cloud:8443/?user=default&password=PASSWORD&ssl=true&custom_http_params=async_insert=1,wait_for_async_insert=1"
  ```
