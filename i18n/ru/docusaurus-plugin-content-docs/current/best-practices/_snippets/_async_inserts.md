import Image from '@theme/IdealImage';
import async_inserts from '@site/static/images/bestpractices/async_inserts.png';

Асинхронные вставки в ClickHouse предоставляют мощную альтернативу в случаях, когда пакетирование на стороне клиента невозможно. Это особенно ценно в нагрузках по наблюдаемости (observability), где сотни или тысячи агентов непрерывно отправляют данные — логи, метрики, трейсы — часто небольшими порциями в режиме реального времени. Буферизация данных на стороне клиента в таких средах повышает сложность и требует централизованной очереди, чтобы обеспечивать отправку достаточно крупных пакетов.

:::note
Отправка множества маленьких батчей в синхронном режиме не рекомендуется, поскольку приводит к созданию большого количества кусков (parts). Это ухудшит производительность запросов и приведёт к ошибкам [&quot;too many part&quot;](/knowledgebase/exception-too-many-parts).
:::

Асинхронные вставки переносят ответственность за пакетирование с клиента на сервер, записывая входящие данные в буфер в памяти, а затем сбрасывая их в хранилище при достижении настраиваемых порогов. Такой подход существенно снижает накладные расходы на создание кусков, уменьшает использование CPU и обеспечивает эффективную ингестию даже при высокой степени параллелизма.

Базовое поведение управляется настройкой [`async_insert`](/operations/settings/settings#async_insert).

<Image img={async_inserts} size="lg" alt="Асинхронные вставки" />

При значении 1 вставки буферизуются и записываются на диск только после выполнения одного из условий сброса:

(1) буфер достигает заданного размера (async&#95;insert&#95;max&#95;data&#95;size)
(2) истекает порог времени (async&#95;insert&#95;busy&#95;timeout&#95;ms) или
(3) накапливается максимальное число запросов вставки (async&#95;insert&#95;max&#95;query&#95;number).

Этот процесс пакетирования прозрачен для клиентов и помогает ClickHouse эффективно объединять трафик вставок из нескольких источников. Однако до момента сброса данные недоступны для запросов. Важно, что существует несколько буферов для каждой комбинации типа вставки (insert shape) и настроек, а в кластерах буферы поддерживаются на каждом узле — это обеспечивает тонкий контроль в многопользовательских средах. Механика вставок в остальном идентична описанной для [синхронных вставок](/best-practices/selecting-an-insert-strategy#synchronous-inserts-by-default).

### Выбор режима возврата \\{#choosing-a-return-mode\\}

Поведение асинхронных вставок дополнительно уточняется с помощью настройки [`wait_for_async_insert`](/operations/settings/settings#wait_for_async_insert).

При значении 1 (по умолчанию) ClickHouse подтверждает вставку только после того, как данные успешно сброшены на диск. Это обеспечивает сильные гарантии надёжного сохранения данных и упрощает обработку ошибок: если что-то идёт не так во время сброса, ошибка возвращается клиенту. Этот режим рекомендуется для большинства продукционных сценариев, особенно когда отказы вставок должны надёжно отслеживаться.

[Результаты бенчмарков](https://clickhouse.com/blog/asynchronous-data-inserts-in-clickhouse) показывают, что он хорошо масштабируется при высокой конкурентности — независимо от того, запускаете ли вы 200 или 500 клиентов — благодаря адаптивным вставкам и стабильному поведению по созданию кусков.

Установка `wait_for_async_insert = 0` включает режим &quot;fire-and-forget&quot;. В этом случае сервер подтверждает вставку сразу после буферизации данных, не дожидаясь их записи в хранилище.

Это обеспечивает вставки с ультранизкой задержкой и максимальную пропускную способность, что идеально для данных с высокой скоростью поступления и низкой критичностью. Однако это сопряжено с компромиссами: нет гарантии, что данные будут сохранены, ошибки могут проявиться только во время сброса, и сложно отследить неудачные вставки. Используйте этот режим только если ваша нагрузка допускает потерю данных.

[Бенчмарки также демонстрируют](https://clickhouse.com/blog/asynchronous-data-inserts-in-clickhouse) значительное сокращение числа кусков и снижение использования CPU при редких сбросах буфера (например, каждые 30 секунд), но риск «тихих» сбоев при этом сохраняется.

Мы настоятельно рекомендуем использовать `async_insert=1,wait_for_async_insert=1`, если вы применяете асинхронные вставки. Использование `wait_for_async_insert=0` очень рискованно, поскольку ваш клиент INSERT может не узнать о возникших ошибках, а также может привести к потенциальной перегрузке, если клиент продолжит быстро записывать данные в ситуации, когда сервер ClickHouse должен замедлить запись и создать некоторое обратное давление (backpressure), чтобы обеспечить надёжность сервиса.

### Дедупликация и надёжность \\{#deduplication-and-reliability\\}

По умолчанию ClickHouse выполняет автоматическую дедупликацию для синхронных вставок, что делает повторные попытки безопасными в случае сбоев. Однако для асинхронных вставок она отключена, если только не включена явно (её не следует включать, если у вас есть зависимые материализованные представления — [см. issue](https://github.com/ClickHouse/ClickHouse/issues/66003)).

На практике, если дедупликация включена и одна и та же вставка повторяется — например, из-за тайм-аута или обрыва сети — ClickHouse может безопасно проигнорировать дубликат. Это помогает сохранять идемпотентность и избегать повторной записи данных. Тем не менее стоит учитывать, что проверка вставок и разбор схемы выполняются только во время сброса буфера — поэтому ошибки (например, несоответствие типов) проявятся только в этот момент.

### Включение асинхронных вставок \\{#enabling-asynchronous-inserts\\}

Асинхронные вставки можно включить для конкретного пользователя или для определённого запроса:

- Включение асинхронных вставок на уровне пользователя. В этом примере используется пользователь `default`; если вы создадите другого пользователя, подставьте его имя:
  ```sql
  ALTER USER default SETTINGS async_insert = 1
  ```
- Вы можете задать параметры асинхронной вставки, используя предложение SETTINGS в запросах INSERT:
  ```sql
  INSERT INTO YourTable SETTINGS async_insert=1, wait_for_async_insert=1 VALUES (...)
  ```
- Вы также можете указать параметры асинхронной вставки как параметры подключения при использовании клиентской библиотеки ClickHouse для выбранного языка программирования.

  В качестве примера ниже показано, как это можно сделать в строке подключения JDBC при использовании ClickHouse Java JDBC-драйвера для подключения к ClickHouse Cloud:
  ```bash
  "jdbc:ch://HOST.clickhouse.cloud:8443/?user=default&password=PASSWORD&ssl=true&custom_http_params=async_insert=1,wait_for_async_insert=1"
  ```
