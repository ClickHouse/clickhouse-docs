---
slug: /use-cases/observability/clickstack/getting-started/remote-demo-data
title: 'Удаленный демонстрационный набор данных'
sidebar_position: 2
pagination_prev: null
pagination_next: null
description: 'Начало работы с ClickStack и удаленным демонстрационным набором данных'
doc_type: 'guide'
keywords: ['clickstack', 'пример данных', 'демонстрационный набор данных', 'логи', 'наблюдаемость']
---

import Image from '@theme/IdealImage';
import demo_connection from '@site/static/images/use-cases/observability/hyperdx-demo/demo_connection.png';
import edit_demo_connection from '@site/static/images/use-cases/observability/hyperdx-demo/edit_demo_connection.png';
import edit_demo_source from '@site/static/images/use-cases/observability/hyperdx-demo/edit_demo_source.png';
import step_2 from '@site/static/images/use-cases/observability/hyperdx-demo/step_2.png';
import step_3 from '@site/static/images/use-cases/observability/hyperdx-demo/step_3.png';
import step_4 from '@site/static/images/use-cases/observability/hyperdx-demo/step_4.png';
import step_5 from '@site/static/images/use-cases/observability/hyperdx-demo/step_5.png';
import step_6 from '@site/static/images/use-cases/observability/hyperdx-demo/step_6.png';
import step_7 from '@site/static/images/use-cases/observability/hyperdx-demo/step_7.png';
import step_8 from '@site/static/images/use-cases/observability/hyperdx-demo/step_8.png';
import step_9 from '@site/static/images/use-cases/observability/hyperdx-demo/step_9.png';
import step_10 from '@site/static/images/use-cases/observability/hyperdx-demo/step_10.png';
import step_11 from '@site/static/images/use-cases/observability/hyperdx-demo/step_11.png';
import step_12 from '@site/static/images/use-cases/observability/hyperdx-demo/step_12.png';
import step_13 from '@site/static/images/use-cases/observability/hyperdx-demo/step_13.png';
import step_14 from '@site/static/images/use-cases/observability/hyperdx-demo/step_14.png';
import step_15 from '@site/static/images/use-cases/observability/hyperdx-demo/step_15.png';
import step_16 from '@site/static/images/use-cases/observability/hyperdx-demo/step_16.png';
import step_17 from '@site/static/images/use-cases/observability/hyperdx-demo/step_17.png';
import step_18 from '@site/static/images/use-cases/observability/hyperdx-demo/step_18.png';
import step_19 from '@site/static/images/use-cases/observability/hyperdx-demo/step_19.png';
import step_20 from '@site/static/images/use-cases/observability/hyperdx-demo/step_20.png';
import step_21 from '@site/static/images/use-cases/observability/hyperdx-demo/step_21.png';
import step_22 from '@site/static/images/use-cases/observability/hyperdx-demo/step_22.png';
import step_23 from '@site/static/images/use-cases/observability/hyperdx-demo/step_23.png';
import step_24 from '@site/static/images/use-cases/observability/hyperdx-demo/step_24.png';
import demo_sources from '@site/static/images/use-cases/observability/hyperdx-demo//demo_sources.png';
import edit_connection from '@site/static/images/use-cases/observability/edit_connection.png';
import DemoArchitecture from '@site/docs/use-cases/observability/clickstack/example-datasets/_snippets/_demo.md';

**В этом руководстве предполагается, что вы развернули ClickStack, следуя [инструкциям для образа «всё в одном»](/use-cases/observability/clickstack/getting-started) или в [локальном режиме (Local Mode Only)](/use-cases/observability/clickstack/deployment/local-mode-only), и выполнили начальное создание пользователя. В качестве альтернативы вы можете пропустить всю локальную настройку и просто подключиться к нашей размещённой демо-версии ClickStack [play-clickstack.clickhouse.com](https://play-clickstack.clickhouse.com), которая использует этот набор данных.**

В этом руководстве используется пример набора данных, размещённый в общедоступном playground-е ClickHouse по адресу [sql.clickhouse.com](https://sql.clickhpouse.com), к которому вы можете подключиться из своего локального развертывания ClickStack.

:::warning Не поддерживается с HyperDX в ClickHouse Cloud
Подключение к удалённым базам данных не поддерживается, когда HyperDX развёрнут в ClickHouse Cloud. Соответственно, этот набор данных использовать нельзя.
:::


Он содержит примерно 40 часов данных, полученных из ClickHouse-версии официального демо OpenTelemetry (OTel). Данные каждую ночь воспроизводятся заново с временными метками, скорректированными под текущий временной интервал, что позволяет пользователям исследовать поведение системы с использованием интегрированных логов, трассировок и метрик HyperDX.

:::note Вариации данных
Поскольку набор данных каждую ночь воспроизводится с нуля, точные визуализации могут отличаться в зависимости от того, когда вы изучаете демо.
:::



## Демонстрационный сценарий {#demo-scenario}

В этой демонстрации мы рассматриваем инцидент на сайте интернет-магазина, торгующего телескопами и сопутствующими аксессуарами.

Служба поддержки сообщила, что пользователи сталкиваются с проблемами при завершении оплаты на этапе оформления заказа. Проблема была передана команде Site Reliability Engineering (SRE) для расследования.

С помощью HyperDX команда SRE проанализирует журналы, трассировки и метрики для диагностики и устранения проблемы, а затем изучит данные сеансов, чтобы подтвердить соответствие своих выводов фактическому поведению пользователей.


## Демонстрация OpenTelemetry {#otel-demo}

В этой демонстрации используется [форк, поддерживаемый ClickStack](https://github.com/ClickHouse/opentelemetry-demo), официальной демонстрации OpenTelemetry.

<DemoArchitecture />


## Шаги демонстрации {#demo-steps}

**Мы инструментировали эту демонстрацию с помощью [ClickStack SDKs](/use-cases/observability/clickstack/sdks), развернув сервисы в Kubernetes, из которых также были собраны метрики и логи.**

<VerticalStepper headerLevel="h3">

### Подключение к демонстрационному серверу {#connect-to-the-demo-server}

:::note Режим Local-Only
Этот шаг можно пропустить, если вы нажали `Connect to Demo Server` при развертывании в локальном режиме. При использовании этого режима источники будут иметь префикс `Demo_`, например `Demo_Logs`
:::

Перейдите в `Team Settings` и нажмите `Edit` для `Local Connection`:

<Image img={edit_connection} alt='Редактирование подключения' size='lg' />

Переименуйте подключение в `Demo` и заполните форму следующими данными подключения к демонстрационному серверу:

- `Connection Name`: `Demo`
- `Host`: `https://sql-clickhouse.clickhouse.com`
- `Username`: `otel_demo`
- `Password`: Оставьте пустым

<Image img={edit_demo_connection} alt='Редактирование демонстрационного подключения' size='lg' />

### Изменение источников {#modify-sources}

:::note Режим Local-Only
Этот шаг можно пропустить, если вы нажали `Connect to Demo Server` при развертывании в локальном режиме. При использовании этого режима источники будут иметь префикс `Demo_`, например `Demo_Logs`
:::

Прокрутите вверх до `Sources` и измените каждый из источников — `Logs`, `Traces`, `Metrics` и `Sessions` — для использования базы данных `otel_v2`.

<Image img={edit_demo_source} alt='Редактирование демонстрационного источника' size='lg' />

:::note
Возможно, потребуется перезагрузить страницу, чтобы убедиться, что полный список баз данных отображается в каждом источнике.
:::

### Настройка временного диапазона {#adjust-the-timeframe}

Настройте время для отображения всех данных за предыдущий `1 день`, используя селектор времени в правом верхнем углу.

<Image img={step_2} alt='Шаг 2' size='lg' />

Вы можете заметить небольшую разницу в количестве ошибок на обзорной гистограмме с небольшим увеличением красного цвета в нескольких последовательных столбцах.

:::note
Расположение столбцов будет различаться в зависимости от того, когда вы запрашиваете набор данных.
:::

### Фильтрация ошибок {#filter-to-errors}

Чтобы выделить случаи ошибок, используйте фильтр `SeverityText` и выберите `error` для отображения только записей уровня ошибок.

Ошибка должна стать более очевидной:

<Image img={step_3} alt='Шаг 3' size='lg' />

### Определение шаблонов ошибок {#identify-error-patterns}

С помощью функции кластеризации HyperDX вы можете автоматически идентифицировать ошибки и группировать их в значимые шаблоны. Это ускоряет анализ при работе с большими объемами логов и трассировок. Чтобы использовать эту функцию, выберите `Event Patterns` в меню `Analysis Mode` на левой панели.

Кластеры ошибок выявляют проблемы, связанные с неудачными платежами, включая именованный шаблон `Failed to place order`. Дополнительные кластеры также указывают на проблемы со списанием средств с карт и переполнением кэша.

<Image img={step_4} alt='Шаг 4' size='lg' />

Обратите внимание, что эти кластеры ошибок, вероятно, происходят из разных сервисов.

### Исследование шаблона ошибки {#explore-error-pattern}

Нажмите на наиболее очевидный кластер ошибок, который коррелирует с нашей зарегистрированной проблемой невозможности пользователей завершить платежи: `Failed to place order`.

Это отобразит список всех случаев этой ошибки, связанных с сервисом `frontend`:

<Image img={step_5} alt='Шаг 5' size='lg' />

Выберите любую из полученных ошибок. Метаданные логов будут показаны подробно. Просмотр разделов `Overview` и `Column Values` указывает на проблему со списанием средств с карт из-за кэша:

`failed to charge card: could not charge the card: rpc error: code = Unknown desc = Visa cache full: cannot add new item.`

<Image img={step_6} alt='Шаг 6' size='lg' />

### Исследование инфраструктуры {#explore-the-infrastructure}

Мы выявили ошибку, связанную с кэшем, которая, вероятно, вызывает сбои платежей. Нам все еще необходимо определить, откуда эта проблема возникает в нашей микросервисной архитектуре.

Учитывая проблему с кэшем, имеет смысл исследовать базовую инфраструктуру — возможно, у нас проблема с памятью в соответствующих подах? В ClickStack логи и метрики объединены и отображаются в контексте, что упрощает быстрое выявление первопричины.

Выберите вкладку `Infrastructure` для просмотра метрик, связанных с базовыми подами сервиса `frontend`, и расширьте временной диапазон до `1d`:

<Image img={step_7} alt='Шаг 7' size='lg' />


Проблема, по-видимому, не связана с инфраструктурой — никакие метрики существенно не изменились за рассматриваемый период: ни до, ни после ошибки. Закройте вкладку инфраструктуры.

### Исследование трассировки {#explore-a-trace}

В ClickStack трассировки также автоматически коррелируются с журналами и метриками. Давайте исследуем трассировку, связанную с выбранным журналом, чтобы определить ответственный за проблему сервис.

Выберите `Trace`, чтобы визуализировать связанную трассировку. Прокручивая последующее представление вниз, мы можем увидеть, как HyperDX визуализирует распределённую трассировку по микросервисам, соединяя спаны в каждом сервисе. Платёж явно задействует несколько микросервисов, включая те, которые выполняют оформление заказа и конвертацию валют.

<Image img={step_8} alt='Step 8' size='lg' />

Прокрутив представление до конца, мы можем увидеть, что сервис `payment` вызывает ошибку, которая затем распространяется обратно вверх по цепочке вызовов.

<Image img={step_9} alt='Step 9' size='lg' />

### Поиск трассировок {#searching-traces}

Мы установили, что пользователи не могут завершить покупки из-за проблемы с кешем в сервисе платежей. Давайте более подробно исследуем трассировки этого сервиса, чтобы узнать больше о первопричине.

Переключитесь на основное представление поиска, выбрав `Search`. Переключите источник данных на `Traces` и выберите представление `Results table`. **Убедитесь, что временной диапазон по-прежнему охватывает последний день.**

<Image img={step_10} alt='Step 10' size='lg' />

Это представление показывает все трассировки за последний день. Мы знаем, что проблема возникает в нашем сервисе платежей, поэтому примените фильтр `payment` к полю `ServiceName`.

<Image img={step_11} alt='Step 11' size='lg' />

Если мы применим кластеризацию событий к трассировкам, выбрав `Event Patterns`, мы сразу увидим нашу проблему с кешем в сервисе `payment`.

<Image img={step_12} alt='Step 12' size='lg' />

### Исследование инфраструктуры для трассировки {#explore-infrastructure-for-a-trace}

Переключитесь на представление результатов, нажав на `Results table`. Отфильтруйте ошибки, используя фильтр `StatusCode` со значением `Error`.

<Image img={step_13} alt='Step 13' size='lg' />

Выберите ошибку `Error: Visa cache full: cannot add new item.`, переключитесь на вкладку `Infrastructure` и расширьте временной диапазон до `1d`.

<Image img={step_14} alt='Step 14' size='lg' />

Коррелируя трассировки с метриками, мы видим, что потребление памяти и CPU в сервисе `payment` увеличилось, а затем упало до `0` (это можно объяснить перезапуском пода) — что указывает на то, что проблема с кешем вызвала проблемы с ресурсами. Можно ожидать, что это повлияло на время завершения платежей.

### Дельты событий для более быстрого решения проблемы {#event-deltas-for-faster-resolution}

Дельты событий помогают выявлять аномалии, связывая изменения производительности или частоты ошибок с конкретными подмножествами данных — что упрощает быстрое определение первопричины.

Хотя мы знаем, что сервис `payment` имеет проблему с кешем, вызывающую увеличение потребления ресурсов, мы ещё не полностью определили первопричину.

Вернитесь к представлению таблицы результатов и выберите временной период, содержащий ошибки, чтобы ограничить данные. Убедитесь, что вы выбрали несколько часов до и после ошибок, если возможно (проблема может всё ещё возникать):

<Image img={step_15} alt='Step 15' size='lg' />

Удалите фильтр ошибок и выберите `Event Deltas` из левого меню `Analysis Mode`.

<Image img={step_16} alt='Step 16' size='lg' />

Верхняя панель показывает распределение временных интервалов, где цвета указывают на плотность событий (количество спанов). Подмножество событий за пределами основной концентрации обычно заслуживает исследования.

Если мы выберем события с длительностью более `200ms` и применим фильтр `Filter by selection`, мы сможем ограничить наш анализ более медленными событиями:

<Image img={step_17} alt='Step 17' size='lg' />

При анализе подмножества данных мы видим, что большинство всплесков производительности связаны с транзакциями `visa`.

### Использование графиков для дополнительного контекста {#using-charts-for-more-context}

В ClickStack мы можем построить график любого числового значения из журналов, трассировок или метрик для получения дополнительного контекста.

Мы установили:

- Наша проблема связана с сервисом платежей
- Кеш заполнен
- Это вызвало увеличение потребления ресурсов
- Проблема препятствовала завершению платежей visa — или, по крайней мере, приводила к тому, что они выполнялись очень долго.

<br />

Выберите `Chart Explorer` из левого меню. Заполните следующие значения, чтобы построить график времени, затраченного на завершение платежей, по типу графика:


- `Data Source`: `Traces`
- `Metric`: `Maximum`
- `SQL Column`: `Duration`
- `Where`: `ServiceName: payment`
- `Timespan`: `Last 1 day`

<br />

Нажав `▶️`, вы увидите, как со временем снижалась производительность платежей.

<Image img={step_18} alt='Step 18' size='lg' />

Если установить `Group By` в `SpanAttributes['app.payment.card_type']` (просто введите `card` для автозаполнения), можно увидеть, как производительность сервиса для транзакций Visa снизилась по сравнению с Mastercard:

<Image img={step_19} alt='Step 19' size='lg' />

Обратите внимание, что после возникновения ошибки ответы возвращаются за `0s`.

### Изучение метрик для получения дополнительного контекста {#exploring-metrics-for-more-context}

Наконец, построим график размера кеша в виде метрики, чтобы увидеть, как он изменялся со временем и получить дополнительный контекст.

Заполните следующие значения:

- `Data Source`: `Metrics`
- `Metric`: `Maximum`
- `SQL Column`: `visa_validation_cache.size (gauge)` (just type `cache` for autocomplete)
- `Where`: `ServiceName: payment`
- `Group By`: `<empty>`

Мы видим, как размер кеша увеличивался в течение 4-5 часов (вероятно, после развертывания ПО), прежде чем достиг максимального размера `100,000`. Из `Sample Matched Events` видно, что наши ошибки коррелируют с достижением кешем этого лимита, после чего он фиксируется с размером `0`, а ответы также возвращаются за `0s`.

<Image img={step_20} alt='Step 20' size='lg' />

Подводя итог, изучив логи, трассировки и метрики, мы пришли к следующим выводам:

- Проблема связана с сервисом платежей
- Изменение в поведении сервиса, вероятно, из-за развертывания, привело к медленному увеличению кеша visa в течение 4-5 часов — до достижения максимального размера `100,000`.
- Это вызвало увеличение потребления ресурсов по мере роста кеша — вероятно, из-за неудачной реализации
- По мере роста кеша производительность платежей Visa снижалась
- При достижении максимального размера кеш отклонял платежи и сообщал о своем размере как `0`.

### Использование сессий {#using-sessions}

Сессии позволяют воспроизвести пользовательский опыт, предоставляя визуальное представление о том, как произошла ошибка с точки зрения пользователя. Хотя они обычно не используются для диагностики первопричин, они ценны для подтверждения проблем, сообщенных в службу поддержки, и могут служить отправной точкой для более глубокого исследования.

В HyperDX сессии связаны с трассировками и логами, обеспечивая полное представление об основной причине.

Например, если команда поддержки предоставляет адрес электронной почты пользователя, столкнувшегося с проблемой платежа `Braulio.Roberts23@hotmail.com` — часто эффективнее начать с его сессии, а не напрямую искать в логах или трассировках.

Перейдите на вкладку `Client Sessions` из левого меню, убедившись, что источник данных установлен на `Sessions`, а временной период — на `Last 1 day`:

<Image img={step_21} alt='Step 21' size='lg' />

Выполните поиск по `SpanAttributes.userEmail: Braulio`, чтобы найти сессию нашего клиента. При выборе сессии слева отобразятся события браузера и связанные спаны для сессии клиента, а справа — воспроизведенный пользовательский опыт в браузере:

<Image img={step_22} alt='Step 22' size='lg' />

### Воспроизведение сессий {#replaying-sessions}

Сессии можно воспроизвести, нажав кнопку ▶️. Переключение между `Highlighted` и `All Events` позволяет изменять степень детализации спанов, при этом первый вариант выделяет ключевые события и ошибки.

Если прокрутить вниз до конца спанов, можно увидеть ошибку `500`, связанную с `/api/checkout`. Нажатие кнопки ▶️ для этого конкретного спана перемещает воспроизведение к этой точке в сессии, позволяя подтвердить опыт клиента — платеж просто не работает, при этом ошибка не отображается.

<Image img={step_23} alt='Step 23' size='lg' />

Выбрав спан, мы можем подтвердить, что это было вызвано внутренней ошибкой. Нажав на вкладку `Trace` и прокрутив связанные спаны, мы можем подтвердить, что клиент действительно стал жертвой нашей проблемы с кешем.

<Image img={step_24} alt='Step 24' size='lg' />

</VerticalStepper>

Эта демонстрация рассматривает реальный инцидент с неудачными платежами в приложении электронной коммерции, показывая, как ClickStack помогает выявить первопричины через единые логи, трассировки, метрики и воспроизведение сессий — изучите наши [другие руководства по началу работы](/use-cases/observability/clickstack/sample-datasets), чтобы глубже погрузиться в конкретные функции.
