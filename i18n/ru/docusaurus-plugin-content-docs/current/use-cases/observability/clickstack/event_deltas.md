---
slug: /use-cases/observability/clickstack/event_deltas
title: 'Дельты событий в ClickStack'
sidebar_label: 'Дельты событий'
pagination_prev: null
pagination_next: null
description: 'Дельты событий в ClickStack'
doc_type: 'guide'
keywords: ['clickstack', 'event deltas', 'change tracking', 'logs', 'observability']
---

import Image from '@theme/IdealImage';
import event_deltas from '@site/static/images/use-cases/observability/hyperdx-demo/step_17.png';
import event_deltas_no_selected from '@site/static/images/use-cases/observability/event_deltas_no_selected.png';
import event_deltas_highlighted from '@site/static/images/use-cases/observability/event_deltas_highlighted.png';
import event_deltas_selected from '@site/static/images/use-cases/observability/event_deltas_selected.png';
import event_deltas_issue from '@site/static/images/use-cases/observability/event_deltas_issue.png';
import event_deltas_outliers from '@site/static/images/use-cases/observability/event_deltas_outliers.png';
import event_deltas_separation from '@site/static/images/use-cases/observability/event_deltas_separation.png';
import event_deltas_customization from '@site/static/images/use-cases/observability/event_deltas_customization.png';
import event_deltas_inappropriate from '@site/static/images/use-cases/observability/event_deltas_inappropriate.png';

Дельты событий (Event Deltas) в ClickStack — это функция, ориентированная на трейсы, которая автоматически анализирует их свойства, чтобы определить, что изменилось при деградации производительности. Сравнивая распределения задержек для нормальных и медленных трейсов в наборе данных, ClickStack подчёркивает атрибуты, которые сильнее всего коррелируют с этими различиями — будь то новая версия деплоя, конкретный endpoint или определённый идентификатор пользователя.

Вместо ручного анализа данных трейсов дельты событий автоматически выявляют ключевые свойства, определяющие различия в задержке между двумя подмножествами данных, что значительно упрощает диагностику регрессий и поиск первопричин. Эта функция позволяет визуализировать сырые трейсы и сразу видеть факторы, влияющие на изменения производительности, ускоряя реагирование на инциденты и снижая среднее время восстановления.

<Image img={event_deltas} alt="Дельты событий" size="lg" />


## Использование Event Deltas {#using-event-deltas}

Event Deltas доступны непосредственно через панель **Search** в ClickStack при выборе источника типа `Trace`.

В селекторе **Analysis Mode** в левом верхнем углу выберите **Event Deltas** (при выбранном источнике `Trace`), чтобы переключиться со стандартной таблицы результатов, отображающей спаны в виде строк.

<Image
  img={event_deltas_no_selected}
  alt='Event Deltas не выбран'
  size='lg'
/>

Это представление отображает распределение спанов во времени, показывая, как изменяется задержка в зависимости от объёма. Вертикальная ось представляет задержку, а цветовая индикация показывает плотность трассировок в данной точке, при этом более яркие жёлтые области соответствуют более высокой концентрации трассировок. С помощью этой визуализации пользователи могут быстро увидеть, как спаны распределены по задержке и количеству, что упрощает выявление изменений или аномалий в производительности.

<Image
  img={event_deltas_highlighted}
  alt='Event Deltas выделен'
  size='lg'
/>

Пользователи могут затем выбрать область визуализации — в идеале ту, где спаны имеют большую длительность и достаточную плотность, — после чего нажать **Filter by Selection**. Это определяет «выбросы» для анализа. Event Deltas затем идентифицирует столбцы и ключевые значения, наиболее связанные с этими спанами в подмножестве выбросов по сравнению с остальной частью набора данных. Фокусируясь на областях со значимыми выбросами, ClickStack выделяет уникальные значения, которые отличают это подмножество от общего корпуса данных, выявляя атрибуты, наиболее коррелирующие с наблюдаемыми различиями в производительности.

<Image img={event_deltas_selected} alt='Event Deltas выбран' size='lg' />

Для каждого столбца ClickStack идентифицирует значения, которые сильно смещены в сторону выбранного подмножества выбросов. Другими словами, когда значение появляется в столбце, если оно встречается преимущественно среди выбросов, а не в общем наборе данных (нормальных значениях), оно выделяется как значимое. Столбцы с наиболее сильным смещением перечисляются первыми, выявляя атрибуты, наиболее тесно связанные с аномальными спанами и отличающие их от базового поведения.

<Image img={event_deltas_outliers} alt='Выбросы Event Deltas' size='lg' />

Рассмотрим приведённый выше пример, где был выявлен столбец `SpanAttributes.app.payment.card_type`. Здесь анализ Event Deltas показывает, что `29%` нормальных значений используют MasterCard при `0%` среди выбросов, в то время как `100%` выбросов используют Visa по сравнению с `71%` нормальных значений. Это указывает на то, что тип карты Visa тесно связан с аномальными трассировками с более высокой задержкой, тогда как MasterCard встречается только в нормальном подмножестве.

<Image img={event_deltas_issue} alt='Проблема Event Deltas' size='lg' />

И наоборот, значения, исключительно связанные с нормальными значениями, также могут представлять интерес. В приведённом выше примере ошибка `Visa Cash Full` появляется исключительно в нормальных значениях и полностью отсутствует среди спанов-выбросов. Там, где это происходит, задержка всегда составляет менее примерно 50 миллисекунд, что указывает на то, что эта ошибка связана с низкими задержками.


## Как работают дельты событий {#how-event-deltas-work}

Дельты событий работают путем выполнения двух запросов: один для выбранной области аномальных значений и один для области нормальных значений. Каждый запрос ограничен соответствующей длительностью и временным окном. Затем анализируется выборка событий из обоих наборов результатов и определяются столбцы, в которых высокая концентрация значений преимущественно встречается в аномальных данных. Столбцы, для которых 100% значений встречается только в подмножестве аномальных данных, отображаются первыми, выделяя атрибуты, наиболее ответственные за наблюдаемые различия.


## Настройка графика {#customizing-the-graph}

Над графиком находятся элементы управления, которые позволяют настроить способ построения тепловой карты. При изменении этих полей тепловая карта обновляется в реальном времени, что позволяет визуализировать и сравнивать зависимости между любым измеряемым значением и его частотой с течением времени.

**Конфигурация по умолчанию**

По умолчанию для визуализации используются:

- **Ось Y**: `Duration` — отображает значения задержки по вертикали
- **Цвет (ось Z)**: `count()` — представляет количество запросов с течением времени (ось X)

Эта конфигурация показывает распределение задержки во времени, при этом интенсивность цвета указывает на количество событий, попадающих в каждый диапазон.

**Настройка параметров**

Вы можете изменить эти параметры для исследования различных аспектов ваших данных:

- **Value**: Определяет, что отображается на оси Y. Например, можно заменить `Duration` на такие метрики, как частота ошибок или размер ответа.
- **Count**: Определяет цветовое отображение. Вы можете переключиться с `count()` (количество событий в интервале) на другие агрегатные функции, такие как `avg()`, `sum()`, `p95()`, или даже на пользовательские выражения, например `countDistinct(field)`.

<Image
  img={event_deltas_customization}
  alt='Настройка дельт событий'
  size='lg'
/>


## Рекомендации {#recommendations}

Event Deltas работает наиболее эффективно при анализе конкретного сервиса. Задержки между различными сервисами могут существенно различаться, что затрудняет определение столбцов и значений, наиболее ответственных за аномальные значения. Перед включением Event Deltas отфильтруйте спаны до набора, в котором ожидается схожее распределение задержек. Для получения наиболее полезных результатов анализируйте наборы, где значительная вариация задержек является неожиданной, избегая случаев, где это является нормой (например, при работе с двумя разными сервисами).

При выборе области следует ориентироваться на подмножества с четким распределением более медленных и более быстрых длительностей, что позволяет четко изолировать спаны с высокой задержкой для анализа. Например, обратите внимание, что выбранная область ниже четко захватывает набор более медленных спанов для анализа.

<Image img={event_deltas_separation} alt='Разделение Event Deltas' size='lg' />

Напротив, следующий набор данных сложно проанализировать с помощью Event Deltas с практической пользой.

<Image
  img={event_deltas_inappropriate}
  alt='Event Deltas — плохое разделение'
  size='lg'
/>
