---
slug: /use-cases/observability/clickstack/event_deltas
title: 'Дельты событий в ClickStack'
sidebar_label: 'Дельты событий'
pagination_prev: null
pagination_next: null
description: 'Дельты событий в ClickStack'
doc_type: 'guide'
keywords: ['clickstack', 'дельты событий', 'отслеживание изменений', 'логи', 'наблюдаемость']
---

import Image from '@theme/IdealImage';
import event_deltas from '@site/static/images/use-cases/observability/hyperdx-demo/step_17.png';
import event_deltas_no_selected from '@site/static/images/use-cases/observability/event_deltas_no_selected.png';
import event_deltas_highlighted from '@site/static/images/use-cases/observability/event_deltas_highlighted.png';
import event_deltas_selected from '@site/static/images/use-cases/observability/event_deltas_selected.png';
import event_deltas_issue from '@site/static/images/use-cases/observability/event_deltas_issue.png';
import event_deltas_outliers from '@site/static/images/use-cases/observability/event_deltas_outliers.png';
import event_deltas_separation from '@site/static/images/use-cases/observability/event_deltas_separation.png';
import event_deltas_customization from '@site/static/images/use-cases/observability/event_deltas_customization.png';
import event_deltas_inappropriate from '@site/static/images/use-cases/observability/event_deltas_inappropriate.png';

Дельты событий (Event Deltas) в ClickStack — это функция, ориентированная на трейсы, которая автоматически анализирует их свойства, чтобы выяснить, что изменилось при деградации производительности. Сравнивая распределения задержек нормальных и медленных трейсов в выборке, ClickStack подсвечивает, какие атрибуты сильнее всего коррелируют с этой разницей — будь то новая версия развертывания, конкретный endpoint или определённый ID пользователя.

Вместо ручного перебора данных трейсов дельты событий выявляют ключевые свойства, которые определяют различия в задержке между двумя подмножествами данных, что значительно упрощает диагностику регрессий и определение первопричин. Эта функция позволяет визуализировать сырые трейсы и сразу видеть факторы, влияющие на изменения производительности, ускоряя реагирование на инциденты и сокращая среднее время до их решения.

<Image img={event_deltas} alt="Дельты событий" size="lg" />


## Использование Event Deltas {#using-event-deltas}

Event Deltas доступны напрямую через панель **Search** в ClickStack при выборе источника типа `Trace`.

В расположенном слева сверху переключателе **Analysis Mode** выберите **Event Deltas** (при выбранном источнике `Trace`), чтобы переключиться со стандартной таблицы результатов, в которой спаны отображаются строками.

<Image img={event_deltas_no_selected} alt="Event Deltas не выбраны" size="lg"/>

Это представление отображает распределение спанов по времени, показывая, как задержка изменяется вместе с объемом. Вертикальная ось показывает задержку, а окраска указывает плотность трейсов в заданной точке: более яркие желтые области соответствуют более высокой концентрации трейсов. С помощью этой визуализации пользователи могут быстро увидеть, как спаны распределены одновременно по задержке и количеству, что упрощает выявление сдвигов или аномалий в производительности.

<Image img={event_deltas_highlighted} alt="Event Deltas подсвечены" size="lg"/>

Затем пользователи могут выбрать область на визуализации — предпочтительно ту, где спаны имеют большую длительность и достаточную плотность, — и нажать **Filter by Selection**. Это обозначает «выбросы» для анализа. Затем Event Deltas определит столбцы и ключевые значения, которые сильнее всего связаны с этими спанами в подмножестве выбросов по сравнению с остальной частью набора данных. Фокусируясь на областях с существенными выбросами, ClickStack выделяет уникальные значения, которые отличают это подмножество от общей совокупности, выводя на поверхность атрибуты, наиболее коррелированные с наблюдаемыми отличиями в производительности.

<Image img={event_deltas_selected} alt="Event Deltas выбраны" size="lg"/>

Для каждого столбца ClickStack определяет значения, которые сильно смещены в сторону выбранного подмножества выбросов. Другими словами, если значение встречается в столбце и преобладающим образом появляется именно в выбросах, а не в общем наборе данных (inliers), оно выделяется как значимое. Столбцы с наибольшим смещением перечисляются первыми, выводя на поверхность атрибуты, которые сильнее всего связаны с аномальными спанами и отличают их от базового поведения.

<Image img={event_deltas_outliers} alt="Event Deltas выбросы" size="lg"/>

Рассмотрим приведенный выше пример, где был выделен столбец `SpanAttributes.app.payment.card_type`. Здесь анализ Event Deltas показывает, что `29%` inliers используют MasterCard, при этом среди выбросов их `0%`, тогда как `100%` выбросов используют Visa по сравнению с `71%` inliers. Это указывает на то, что тип карты Visa сильно связан с аномальными трейсами с большей задержкой, тогда как MasterCard появляется только в нормальном подмножестве.

<Image img={event_deltas_issue} alt="Проблема в Event Deltas" size="lg"/>

Наоборот, значения, связанные исключительно с inliers, тоже могут быть интересны. В приведенном выше примере ошибка `Visa Cash Full` появляется исключительно в inliers и полностью отсутствует в спанах-выбросах. Там, где она возникает, задержка всегда менее примерно 50 миллисекунд, что позволяет предположить, что эта ошибка связана с низкими задержками.



## Как работают Event Deltas {#how-event-deltas-work}

Event Deltas работают следующим образом: выполняются два запроса — один для выбранной области аномалий (outliers) и один для области нормальных значений (inliers). Каждый запрос ограничен соответствующей продолжительностью и временным окном. Затем анализируется выборка событий из обоих результирующих наборов, и определяются столбцы, в которых высокая концентрация значений встречается преимущественно среди аномалий. Столбцы, для которых 100% какого-либо значения встречается только в подмножестве аномалий, показываются первыми, выделяя атрибуты, в наибольшей степени определяющие наблюдаемые различия.



## Настройка графика {#customizing-the-graph}

Над графиком находятся элементы управления, которые позволяют настраивать способ построения тепловой карты. По мере изменения этих полей тепловая карта обновляется в реальном времени, что позволяет визуализировать и сравнивать взаимосвязь между любым измеряемым значением и частотой его появления во времени.

**Конфигурация по умолчанию**

По умолчанию визуализация использует:

- **Ось Y**: `Duration` — отображает значения задержки по вертикали
- **Цвет (ось Z)**: `count()` — отражает количество запросов во времени (ось X)

Такая конфигурация показывает распределение задержки во времени, где интенсивность цвета указывает, сколько событий попадает в каждый диапазон.

**Изменение параметров**

Вы можете изменять эти параметры, чтобы исследовать различные срезы ваших данных:

- **Value**: Определяет, что отображается по оси Y. Например, замените `Duration` на такие метрики, как уровень ошибок или размер ответа.
- **Count**: Определяет цветовое кодирование. Вы можете переключиться с `count()` (количество событий в каждом бакете) на другие агрегирующие функции, такие как `avg()`, `sum()`, `p95()` или даже пользовательские выражения, например `countDistinct(field)`.

<Image img={event_deltas_customization} alt="Настройка графика Event Deltas" size="lg"/>



## Рекомендации {#recommendations}

Event Deltas работают лучше всего, когда анализ сфокусирован на одном конкретном сервисе. Задержка между разными сервисами может сильно различаться, что затрудняет определение столбцов и значений, которые в наибольшей степени ответственны за выбросы. Перед включением Event Deltas отфильтруйте спаны до набора, для которого ожидается схожее распределение задержек. Наиболее полезные выводы дает анализ тех наборов, где значительная вариативность задержки является неожиданной, и следует избегать случаев, когда она является нормой (например, для двух разных сервисов).

При выборе области пользователям следует нацеливаться на подмножества, где четко различаются более медленные и более быстрые значения длительности, что позволяет аккуратно изолировать спаны с большей задержкой для анализа. Например, обратите внимание, что выбранная ниже область явно выделяет набор более медленных спанов для анализа.

<Image img={event_deltas_separation} alt="Разделение Event Deltas" size="lg"/>

Напротив, следующий набор данных сложно полезно проанализировать с помощью Event Deltas.

<Image img={event_deltas_inappropriate} alt="Плохое разделение Event Deltas" size="lg"/>
