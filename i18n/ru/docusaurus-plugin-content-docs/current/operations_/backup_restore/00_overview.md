---
description: 'Обзор резервного копирования и восстановления в ClickHouse'
sidebar_label: 'Обзор'
slug: /operations/backup/overview
title: 'Резервное копирование и восстановление в ClickHouse'
doc_type: 'reference'
---

import GenericSettings from '@site/docs/operations_/backup_restore/_snippets/_generic_settings.md';
import Syntax from '@site/docs/operations_/backup_restore/_snippets/_syntax.md';
import AzureSettings from '@site/docs/operations_/backup_restore/_snippets/_azure_settings.md';
import S3Settings from '@site/docs/operations_/backup_restore/_snippets/_s3_settings.md';

> В этом разделе в общих чертах рассматриваются вопросы резервного копирования и восстановления в ClickHouse. Более подробное описание каждого метода резервного копирования см. на страницах соответствующих методов в боковой панели.


## Введение {#introduction}

Хотя [репликация](/engines/table-engines/mergetree-family/replication) обеспечивает защиту от аппаратных сбоев, она не
защищает от человеческих ошибок: случайного удаления данных, удаления не той
таблицы или таблицы не на том кластере, а также программных ошибок, которые приводят к некорректной
обработке данных или их повреждению.

Во многих случаях подобные ошибки затрагивают все реплики. ClickHouse имеет встроенные
механизмы защиты для предотвращения некоторых типов ошибок, например, по [умолчанию](/operations/settings/settings#max_table_size_to_drop)
нельзя просто удалить таблицы с движком семейства `MergeTree`, содержащие более
50 ГБ данных. Однако эти механизмы защиты не охватывают все возможные случаи, и
проблемы всё ещё могут возникать.

Для эффективного предотвращения возможных человеческих ошибок следует тщательно подготовить
стратегию резервного копирования и восстановления данных **заранее**.

У каждой компании разные доступные ресурсы и бизнес-требования, поэтому
не существует универсального решения для резервного копирования и восстановления ClickHouse, которое подойдёт
для любой ситуации. То, что работает для одного гигабайта данных, скорее всего не подойдёт для десятков
петабайт данных. Существует множество возможных подходов со своими преимуществами
и недостатками, которые представлены в этом разделе документации. Рекомендуется
использовать несколько подходов вместо одного, чтобы компенсировать их различные
недостатки.

:::note
Имейте в виду, что если вы создали резервную копию чего-либо и никогда не пытались её восстановить,
велика вероятность, что восстановление не будет работать должным образом, когда оно вам действительно понадобится (или как минимум
займёт больше времени, чем может позволить бизнес). Поэтому какой бы подход к резервному копированию
вы ни выбрали, убедитесь, что процесс восстановления также автоматизирован, и регулярно
отрабатывайте его на резервном кластере ClickHouse.
:::

На следующих страницах подробно описаны различные методы резервного копирования и
восстановления, доступные в ClickHouse:

| Страница                                                            | Описание                                                           |
| ------------------------------------------------------------------- | ------------------------------------------------------------------ |
| [Резервное копирование/восстановление с использованием локального диска или S3-диска](./01_local_disk.md)    | Подробности резервного копирования/восстановления на локальный диск или S3-диск и с них |
| [Резервное копирование/восстановление с использованием S3-endpoint](./02_s3_endpoint.md)             | Подробности резервного копирования/восстановления на S3-endpoint и с него          |
| [Резервное копирование/восстановление с использованием AzureBlobStorage](./03_azure_blob_storage.md) | Подробности резервного копирования/восстановления на Azure Blob Storage и с него      |
| [Альтернативные методы](./04_alternative_methods.md)                  | Обсуждение альтернативных методов резервного копирования                      |

Резервные копии могут:

- быть [полными или инкрементными](#backup-types)
- быть [синхронными или асинхронными](#synchronous-vs-asynchronous)
- быть [параллельными или непараллельными](#concurrent-vs-non-concurrent)
- быть [сжатыми или несжатыми](#compressed-vs-uncompressed)
- использовать [именованные коллекции](#using-named-collections)
- быть защищены паролем
- создаваться для [системных таблиц, таблиц логов или таблиц управления доступом](#system-backups)


## Типы резервных копий {#backup-types}

Резервные копии могут быть полными или инкрементными. Полные резервные копии представляют собой полную копию данных, тогда как инкрементные резервные копии содержат только изменения данных с момента последнего полного резервного копирования.

Полные резервные копии имеют преимущество в виде простого, независимого (от других резервных копий) и надежного метода восстановления. Однако их создание может занимать много времени и требовать значительного дискового пространства. Инкрементные резервные копии, напротив, более эффективны как по времени, так и по использованию пространства, но для восстановления данных требуется наличие всех резервных копий.

В зависимости от ваших потребностей можно использовать:

- **Полные резервные копии** для небольших баз данных или критически важных данных.
- **Инкрементные резервные копии** для крупных баз данных или когда резервное копирование необходимо выполнять часто и с минимальными затратами.
- **Оба типа**, например, еженедельные полные резервные копии и ежедневные инкрементные резервные копии.


## Синхронные и асинхронные резервные копии {#synchronous-vs-asynchronous}

Команды `BACKUP` и `RESTORE` могут быть помечены как `ASYNC`. В этом случае
команда резервного копирования возвращает управление немедленно, а процесс резервного копирования выполняется в фоновом режиме.
Если команды не помечены как `ASYNC`, процесс резервного копирования является синхронным,
и команда блокируется до завершения резервного копирования.


## Параллельные и последовательные резервные копии {#concurrent-vs-non-concurrent}

По умолчанию ClickHouse позволяет выполнять параллельное создание резервных копий и восстановление. Это означает, что вы можете запускать несколько операций резервного копирования или восстановления одновременно. Однако существуют настройки на уровне сервера, которые позволяют отключить такое поведение. Если установить эти настройки в false, на кластере одновременно сможет выполняться только одна операция резервного копирования или восстановления. Это помогает избежать конкуренции за ресурсы и потенциальных конфликтов между операциями.

Чтобы запретить параллельное резервное копирование и восстановление, используйте следующие настройки:

```xml
<clickhouse>
    <backups>
        <allow_concurrent_backups>false</allow_concurrent_backups>
        <allow_concurrent_restores>false</allow_concurrent_restores>
    </backups>
</clickhouse>
```

Значение по умолчанию для обеих настроек — true, поэтому параллельное резервное копирование и восстановление разрешены. Когда эти настройки установлены в false, на кластере одновременно может выполняться только одна операция резервного копирования или восстановления.


## Сжатые и несжатые резервные копии {#compressed-vs-uncompressed}

Резервные копии ClickHouse поддерживают сжатие с помощью параметров `compression_method` и `compression_level`.

При создании резервной копии вы можете указать:

```sql
BACKUP TABLE test.table
  TO Disk('backups', 'filename.zip')
  SETTINGS compression_method='lzma', compression_level=3
```


## Использование именованных коллекций {#using-named-collections}

Именованные коллекции позволяют хранить пары ключ-значение (такие как учетные данные S3, конечные точки и настройки), которые можно повторно использовать в операциях резервного копирования и восстановления.
Они помогают:

- Скрывать учетные данные от пользователей без прав администратора
- Упрощать команды за счет централизованного хранения сложной конфигурации
- Обеспечивать согласованность между операциями
- Предотвращать раскрытие учетных данных в журналах запросов

Подробнее см. в разделе [«именованные коллекции»](/operations/named-collections).


## Резервное копирование системных таблиц, таблиц логов и управления доступом {#system-backups}

Системные таблицы также можно включать в процессы резервного копирования и восстановления, однако их включение зависит от конкретного сценария использования.

Системные таблицы, хранящие исторические данные, такие как таблицы с суффиксом `_log` (например,
`query_log`, `part_log`), можно резервировать и восстанавливать как любые другие таблицы.
Если ваш сценарий использования предполагает анализ исторических данных — например, использование `query_log`
для отслеживания производительности запросов или отладки проблем — рекомендуется включать эти
таблицы в стратегию резервного копирования. Однако если исторические данные из этих таблиц
не требуются, их можно исключить для экономии места в хранилище резервных копий.

Системные таблицы, связанные с управлением доступом, такие как users, roles, row_policies,
settings_profiles и quotas, обрабатываются особым образом при выполнении операций резервного копирования и восстановления.
Когда эти таблицы включаются в резервную копию, их содержимое экспортируется в специальный
файл `accessXX.txt`, который содержит эквивалентные SQL-инструкции для создания
и настройки сущностей управления доступом. При восстановлении процесс восстановления
интерпретирует эти файлы и повторно применяет SQL-команды для воссоздания пользователей,
ролей и других конфигураций. Эта функция гарантирует, что конфигурация управления доступом
кластера ClickHouse может быть зарезервирована и восстановлена как часть
общей настройки кластера.

Эта функциональность работает только для конфигураций, управляемых через SQL-команды
(называется ["Управление доступом и учетными записями на основе SQL"](/operations/access-rights#enabling-access-control)).
Конфигурации доступа, определенные в конфигурационных файлах сервера ClickHouse (например, `users.xml`),
не включаются в резервные копии и не могут быть восстановлены этим методом.


## Общий синтаксис {#syntax}

<Syntax />

### Сводка команд {#command-summary}

Каждая из перечисленных выше команд подробно описана ниже:

| **Команда**                                                            | **Описание**                                                                                                                                      |
| ---------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- | --- |
| `BACKUP`                                                               | Создает резервную копию указанных объектов                                                                                                                |
| `RESTORE`                                                              | Восстанавливает объекты из резервной копии                                                                                                                       |
| `[ASYNC]`                                                              | Выполняет операцию асинхронно (немедленно возвращает идентификатор для отслеживания)                                                              |
| `TABLE [db.]table_name [AS [db.]table_name_in_backup]`                 | Создает резервную копию/восстанавливает указанную таблицу (может быть переименована)                                                                                                  |
| `[PARTITION[S] partition_expr [,...]]`                                 | Создает резервную копию/восстанавливает только указанные партиции таблицы                                                                                                 |
| `DICTIONARY [db.]dictionary_name [AS [db.]name_in_backup]`             | Создает резервную копию/восстанавливает объект словаря                                                                                                                |
| `DATABASE database_name [AS database_name_in_backup]`                  | Создает резервную копию/восстанавливает всю базу данных (может быть переименована)                                                                                                |
| `TEMPORARY TABLE table_name [AS table_name_in_backup]`                 | Создает резервную копию/восстанавливает временную таблицу (может быть переименована)                                                                                                 |
| `VIEW view_name [AS view_name_in_backup]`                              | Создает резервную копию/восстанавливает представление (может быть переименовано)                                                                                                            |
| `[EXCEPT TABLES ...]`                                                  | Исключает указанные таблицы при создании резервной копии базы данных                                                                                                   |
| `ALL`                                                                  | Создает резервную копию/восстанавливает все (все базы данных, таблицы и т. д.). До версии 23.4 ClickHouse `ALL` применялся только к команде `RESTORE`. |
| `[EXCEPT {TABLES\|DATABASES}...]`                                      | Исключает указанные таблицы или базы данных при использовании `ALL`                                                                                                |
| `[ON CLUSTER 'cluster_name']`                                          | Выполняет резервное копирование/восстановление на кластере ClickHouse                                                                                               |
| `TO\|FROM`                                                             | Направление: `TO` для назначения резервной копии, `FROM` для источника восстановления                                                                                    |
| `File('<path>/<filename>')`                                            | Сохранение в/восстановление из локальной файловой системы                                                                                                              |
| `Disk('<disk_name>', '<path>/')`                                       | Сохранение на/восстановление с настроенного диска                                                                                                              |
| `S3('<S3 endpoint>/<path>', '<Access key ID>', '<Secret access key>')` | Сохранение в/восстановление из Amazon S3 или S3-совместимого хранилища                                                                                             |
| `[SETTINGS ...]`                                                       | Полный список настроек см. ниже                                                                                                              |     |

### Настройки {#settings}

**Общие настройки резервного копирования/восстановления**

<GenericSettings />

**Настройки для S3**

<S3Settings />

**Настройки для Azure**

<AzureSettings />


## Администрирование и устранение неполадок {#check-the-status-of-backups}

Команда резервного копирования возвращает `id` и `status`, при этом `id` можно использовать для
получения статуса резервной копии. Это особенно полезно для отслеживания прогресса длительных
асинхронных резервных копий `ASYNC`. В примере ниже показана ошибка, возникшая при попытке
перезаписать существующий файл резервной копии:

```sql
BACKUP TABLE helloworld.my_first_table TO Disk('backups', '1.zip') ASYNC
```

```response
┌─id───────────────────────────────────┬─status──────────┐
│ 7678b0b3-f519-4e6e-811f-5a0781a4eb52 │ CREATING_BACKUP │
└──────────────────────────────────────┴─────────────────┘

1 row in set. Elapsed: 0.001 sec.
```

```sql
SELECT
*
FROM system.backups
WHERE id='7678b0b3-f519-4e6e-811f-5a0781a4eb52'
FORMAT Vertical
```

```response
Row 1:
──────
id:                7678b0b3-f519-4e6e-811f-5a0781a4eb52
name:              Disk('backups', '1.zip')
#highlight-next-line
status:            BACKUP_FAILED
num_files:         0
uncompressed_size: 0
compressed_size:   0
#highlight-next-line
error:             Code: 598. DB::Exception: Backup Disk('backups', '1.zip') already exists. (BACKUP_ALREADY_EXISTS) (version 22.8.2.11 (official build))
start_time:        2022-08-30 09:21:46
end_time:          2022-08-30 09:21:46

1 row in set. Elapsed: 0.002 sec.
```

Помимо таблицы [`system.backups`](/operations/system-tables/backups), все операции резервного копирования и восстановления также отслеживаются в системной таблице журналов
[`system.backup_log`](/operations/system-tables/backup_log):

```sql
SELECT *
FROM system.backup_log
WHERE id = '7678b0b3-f519-4e6e-811f-5a0781a4eb52'
ORDER BY event_time_microseconds ASC
FORMAT Vertical
```

```response
Row 1:
──────
event_date:              2023-08-18
event_time_microseconds: 2023-08-18 11:13:43.097414
id:                      7678b0b3-f519-4e6e-811f-5a0781a4eb52
name:                    Disk('backups', '1.zip')
status:                  CREATING_BACKUP
error:
start_time:              2023-08-18 11:13:43
end_time:                1970-01-01 03:00:00
num_files:               0
total_size:              0
num_entries:             0
uncompressed_size:       0
compressed_size:         0
files_read:              0
bytes_read:              0

Row 2:
──────
event_date:              2023-08-18
event_time_microseconds: 2023-08-18 11:13:43.174782
id:                      7678b0b3-f519-4e6e-811f-5a0781a4eb52
name:                    Disk('backups', '1.zip')
status:                  BACKUP_FAILED
#highlight-next-line
error:                   Code: 598. DB::Exception: Backup Disk('backups', '1.zip') already exists. (BACKUP_ALREADY_EXISTS) (version 23.8.1.1)
start_time:              2023-08-18 11:13:43
end_time:                2023-08-18 11:13:43
num_files:               0
total_size:              0
num_entries:             0
uncompressed_size:       0
compressed_size:         0
files_read:              0
bytes_read:              0

2 rows in set. Elapsed: 0.075 sec.
```
