---
slug: /faq/operations/production
title: 'Какую версию ClickHouse использовать в продакшене?'
toc_hidden: true
toc_priority: 10
description: 'На этой странице приведены рекомендации по выбору версии ClickHouse для продакшена'
doc_type: 'guide'
keywords: ['production', 'deployment', 'versions', 'best practices', 'upgrade strategy']
---



# Какую версию ClickHouse использовать в production? {#which-clickhouse-version-to-use-in-production}

Прежде всего, давайте разберёмся, почему вообще возникает этот вопрос. Есть две основные причины:

1.  ClickHouse развивается очень быстро, и обычно выходит более 10 стабильных релизов в год. Это создаёт широкий выбор версий, среди которых определиться не так просто.
2.  Некоторые пользователи хотят избежать траты времени на определение того, какая версия лучше всего подходит для их задачи, и просто следовать чужим советам.

Вторая причина является более фундаментальной, поэтому мы начнём с неё, а затем вернёмся к вопросу выбора среди различных релизов ClickHouse.


## Какую версию ClickHouse вы рекомендуете? {#which-clickhouse-version-do-you-recommend}

Заманчиво нанять консультантов или довериться известным экспертам, чтобы снять с себя ответственность за production-окружение. Вы устанавливаете конкретную версию ClickHouse, которую кто-то рекомендовал; если возникнет проблема — это не ваша вина, а чья-то ещё. Такая логика — большая ловушка. Никто со стороны не знает лучше вас, что происходит в production-окружении вашей компании.

Как же правильно выбрать версию ClickHouse для обновления? Или как выбрать первую версию ClickHouse? Прежде всего, необходимо вложиться в создание **реалистичного pre-production окружения**. В идеальном мире это могла бы быть полностью идентичная теневая копия, но обычно это дорого.

Вот несколько ключевых моментов для достижения разумной точности в pre-production окружении без высоких затрат:

- Pre-production окружение должно выполнять набор запросов, максимально близкий к тому, который вы планируете выполнять в production:
  - Не делайте его доступным только для чтения с замороженными данными.
  - Не делайте его доступным только для записи с простым копированием данных без построения типичных отчётов.
  - Не очищайте его полностью вместо применения миграций схемы.
- Используйте выборку реальных production-данных и запросов. Постарайтесь выбрать выборку, которая остаётся репрезентативной и позволяет `SELECT`-запросам возвращать разумные результаты. Используйте обфускацию, если ваши данные конфиденциальны и внутренние политики не позволяют выносить их за пределы production-окружения.
- Убедитесь, что pre-production окружение охвачено вашим программным обеспечением для мониторинга и оповещений так же, как и production-окружение.
- Если ваш production распределён по нескольким дата-центрам или регионам, сделайте то же самое для pre-production.
- Если ваш production использует сложные функции, такие как репликация, распределённые таблицы и каскадные материализованные представления, убедитесь, что они настроены аналогично в pre-production.
- Существует компромисс между использованием примерно того же количества серверов или виртуальных машин в pre-production, что и в production, но меньшего размера, или гораздо меньшего их количества, но того же размера. Первый вариант может выявить дополнительные проблемы, связанные с сетью, в то время как второй проще в управлении.

Вторая область для инвестиций — **инфраструктура автоматизированного тестирования**. Не предполагайте, что если какой-то запрос успешно выполнился один раз, он будет делать это всегда. Допустимо иметь модульные тесты, где ClickHouse имитируется, но убедитесь, что ваш продукт имеет разумный набор автоматизированных тестов, которые выполняются на реальном ClickHouse и проверяют, что все важные сценарии использования по-прежнему работают как ожидается.

Дополнительным шагом вперёд может стать внесение этих автоматизированных тестов в [инфраструктуру тестирования ClickHouse с открытым исходным кодом](https://github.com/ClickHouse/ClickHouse/tree/master/tests), которая постоянно используется в его повседневной разработке. Это определённо потребует дополнительного времени и усилий, чтобы изучить [как её запускать](../../development/tests.md), а затем как адаптировать ваши тесты к этому фреймворку, но это окупится, гарантируя, что релизы ClickHouse уже протестированы на них, когда они объявляются стабильными, вместо того чтобы постоянно терять время на сообщение о проблеме постфактум, а затем ожидать реализации исправления, его портирования и выпуска. Некоторые компании даже имеют такой вклад тестов в инфраструктуру в качестве внутренней политики (называется [правилом Бейонсе](https://www.oreilly.com/library/view/software-engineering-at/9781492082781/ch01.html#policies_that_scale_well) в Google).

Когда у вас есть pre-production окружение и инфраструктура тестирования, выбор лучшей версии становится простым:

1.  Регулярно запускайте автоматизированные тесты на новых релизах ClickHouse. Вы можете делать это даже для релизов ClickHouse, помеченных как `testing`, но переходить к следующим шагам с ними не рекомендуется.
2.  Разверните релиз ClickHouse, прошедший тесты, в pre-production и проверьте, что все процессы работают как ожидается.
3.  Сообщайте о любых обнаруженных проблемах в [ClickHouse GitHub Issues](https://github.com/ClickHouse/ClickHouse/issues).
4.  Если серьёзных проблем не было, должно быть безопасно начать развёртывание релиза ClickHouse в production-окружении. Инвестиции в автоматизацию постепенного выпуска, реализующую подход, аналогичный [канареечным релизам](https://martinfowler.com/bliki/CanaryRelease.html) или [сине-зелёным развёртываниям](https://martinfowler.com/bliki/BlueGreenDeployment.html), могут дополнительно снизить риск проблем в production.

Как вы могли заметить, в описанном выше подходе нет ничего специфичного для ClickHouse — люди делают это для любого компонента инфраструктуры, на который они полагаются, если серьёзно относятся к своему production-окружению.


## Как выбрать между релизами ClickHouse? {#how-to-choose-between-clickhouse-releases}

Если вы посмотрите на содержимое репозитория пакетов ClickHouse, вы увидите два типа пакетов:

1.  `stable`
2.  `lts` (долгосрочная поддержка)

Вот несколько рекомендаций по выбору между ними:

- `stable` — это тип пакетов, который мы рекомендуем по умолчанию. Они выпускаются примерно раз в месяц (и, таким образом, предоставляют новые функции с разумной задержкой), и три последних стабильных релиза поддерживаются в части диагностики и бэкпортинга исправлений ошибок.
- `lts` выпускаются два раза в год и поддерживаются в течение года после первоначального выпуска. Вы можете предпочесть их вместо `stable` в следующих случаях:
  - В вашей компании есть внутренние политики, которые не позволяют часто обновляться или использовать программное обеспечение без LTS.
  - Вы используете ClickHouse во вспомогательных продуктах, которые либо не требуют сложных функций ClickHouse, либо не имеют достаточных ресурсов для поддержания его в актуальном состоянии.

Многие команды, которые изначально считают, что `lts` — это правильный выбор, часто всё равно переходят на `stable` из-за какой-либо новой функции, важной для их продукта.

:::tip  
Ещё один момент, который следует учитывать при обновлении ClickHouse: мы всегда следим за совместимостью между релизами, но иногда сохранять её нецелесообразно, и некоторые незначительные детали могут измениться. Поэтому обязательно проверьте [журнал изменений](/whats-new/changelog/index.md) перед обновлением, чтобы узнать, есть ли какие-либо примечания об обратно несовместимых изменениях.
:::
