---
slug: /faq/operations/production
title: 'Какую версию ClickHouse использовать в промышленной эксплуатации?'
toc_hidden: true
toc_priority: 10
description: 'На этой странице приведены рекомендации по выбору версии ClickHouse для использования в промышленной эксплуатации'
doc_type: 'guide'
keywords: ['продакшн', 'развертывание', 'версии', 'лучшие практики', 'стратегия обновления']
---



# Какую версию ClickHouse использовать в production? {#which-clickhouse-version-to-use-in-production}

Прежде всего, давайте разберёмся, почему вообще возникает этот вопрос. Есть две основные причины:

1.  ClickHouse разрабатывается очень активно, и обычно выходит более 10 стабильных релизов в год. Это создаёт широкий выбор версий, среди которых определиться не так просто.
2.  Некоторые пользователи хотят избежать траты времени на определение того, какая версия лучше всего подходит для их задачи, и просто следовать чужим рекомендациям.

Вторая причина является более фундаментальной, поэтому мы начнём с неё, а затем вернёмся к вопросу выбора среди различных релизов ClickHouse.


## Какую версию ClickHouse вы рекомендуете? {#which-clickhouse-version-do-you-recommend}

Заманчиво нанять консультантов или довериться известным экспертам, чтобы снять с себя ответственность за продакшн-среду. Вы устанавливаете конкретную версию ClickHouse, которую кто-то рекомендовал; если возникнет проблема — это не ваша вина, а чужая. Такая логика — большая ловушка. Никто со стороны не знает лучше вас, что происходит в продакшн-среде вашей компании.

Как же правильно выбрать версию ClickHouse для обновления? Или как выбрать первую версию ClickHouse? Прежде всего, необходимо инвестировать в создание **реалистичной препродакшн-среды**. В идеальном мире это могла бы быть полностью идентичная теневая копия, но обычно это дорого.

Вот несколько ключевых моментов для достижения разумной точности в препродакшн-среде без чрезмерных затрат:

- Препродакшн-среда должна выполнять набор запросов, максимально приближенный к тому, который вы планируете выполнять в продакшне:
  - Не делайте её доступной только для чтения с замороженными данными.
  - Не делайте её доступной только для записи с простым копированием данных без построения типичных отчётов.
  - Не очищайте её полностью вместо применения миграций схемы.
- Используйте образец реальных продакшн-данных и запросов. Постарайтесь выбрать репрезентативный образец, который позволяет запросам `SELECT` возвращать разумные результаты. Используйте обфускацию, если ваши данные конфиденциальны и внутренние политики не позволяют выносить их за пределы продакшн-среды.
- Убедитесь, что препродакшн-среда охвачена вашим ПО для мониторинга и оповещений так же, как и продакшн-среда.
- Если ваш продакшн распределён по нескольким дата-центрам или регионам, сделайте то же самое для препродакшн-среды.
- Если в вашем продакшне используются сложные функции, такие как репликация, распределённые таблицы и каскадные материализованные представления, убедитесь, что они настроены аналогичным образом в препродакшн-среде.
- Существует компромисс между использованием примерно такого же количества серверов или виртуальных машин в препродакшн-среде, как и в продакшне, но меньшего размера, или гораздо меньшего их количества, но того же размера. Первый вариант может выявить дополнительные проблемы, связанные с сетью, в то время как второй проще в управлении.

Вторая область для инвестиций — это **инфраструктура автоматизированного тестирования**. Не предполагайте, что если какой-то запрос успешно выполнился один раз, он будет выполняться так всегда. Допустимо иметь модульные тесты, в которых ClickHouse имитируется, но убедитесь, что ваш продукт имеет разумный набор автоматизированных тестов, которые выполняются на реальном ClickHouse и проверяют, что все важные сценарии использования по-прежнему работают как ожидается.

Дополнительным шагом вперёд может стать внесение этих автоматизированных тестов в [инфраструктуру тестирования ClickHouse с открытым исходным кодом](https://github.com/ClickHouse/ClickHouse/tree/master/tests), которая постоянно используется в его повседневной разработке. Это определённо потребует дополнительного времени и усилий, чтобы изучить, [как её запускать](../../development/tests.md), а затем адаптировать ваши тесты к этому фреймворку, но это окупится, гарантируя, что релизы ClickHouse уже протестированы на них к моменту объявления стабильными, вместо того чтобы постоянно терять время на сообщение о проблеме постфактум, а затем ожидать реализации исправления, его бэкпорта и выпуска. Некоторые компании даже имеют такой вклад тестов в инфраструктуру в качестве внутренней политики (называемой [правилом Бейонсе](https://www.oreilly.com/library/view/software-engineering-at/9781492082781/ch01.html#policies_that_scale_well) в Google).

Когда у вас есть препродакшн-среда и инфраструктура тестирования, выбор лучшей версии становится простым:

1.  Регулярно запускайте автоматизированные тесты для новых релизов ClickHouse. Вы можете делать это даже для релизов ClickHouse, помеченных как `testing`, но переходить к следующим шагам с ними не рекомендуется.
2.  Разверните релиз ClickHouse, прошедший тесты, в препродакшн-среде и проверьте, что все процессы работают как ожидается.
3.  Сообщайте о любых обнаруженных проблемах в [ClickHouse GitHub Issues](https://github.com/ClickHouse/ClickHouse/issues).
4.  Если серьёзных проблем не было, можно безопасно начинать развёртывание релиза ClickHouse в продакшн-среде. Инвестиции в автоматизацию постепенного выпуска, реализующую подход, аналогичный [канареечным релизам](https://martinfowler.com/bliki/CanaryRelease.html) или [сине-зелёным развёртываниям](https://martinfowler.com/bliki/BlueGreenDeployment.html), могут дополнительно снизить риск проблем в продакшне.

Как вы могли заметить, в описанном выше подходе нет ничего специфичного для ClickHouse — так поступают с любым компонентом инфраструктуры, на который полагаются, если серьёзно относятся к своей продакшн-среде.


## Как выбрать между релизами ClickHouse? {#how-to-choose-between-clickhouse-releases}

Если вы посмотрите на содержимое репозитория пакетов ClickHouse, вы увидите два типа пакетов:

1.  `stable`
2.  `lts` (долгосрочная поддержка)

Вот несколько рекомендаций по выбору между ними:

- `stable` — это тип пакета, который мы рекомендуем по умолчанию. Они выпускаются примерно раз в месяц (и, таким образом, предоставляют новые функции без значительной задержки), и три последних стабильных релиза поддерживаются в части диагностики и портирования исправлений ошибок.
- `lts` выпускаются два раза в год и поддерживаются в течение года после первоначального выпуска. Вы можете предпочесть их вместо `stable` в следующих случаях:
  - В вашей компании действуют внутренние политики, которые не допускают частых обновлений или использования программного обеспечения без долгосрочной поддержки.
  - Вы используете ClickHouse во вспомогательных продуктах, которые либо не требуют сложных функций ClickHouse, либо не имеют достаточных ресурсов для поддержания его в актуальном состоянии.

Многие команды, которые изначально считают, что `lts` — это правильный выбор, часто всё равно переходят на `stable` из-за какой-либо новой функции, важной для их продукта.

:::tip  
Ещё один момент, который следует учитывать при обновлении ClickHouse: мы всегда следим за совместимостью между релизами, но иногда её сохранение нецелесообразно, и некоторые незначительные детали могут измениться. Поэтому обязательно проверьте [журнал изменений](/whats-new/changelog/index.md) перед обновлением, чтобы узнать, есть ли какие-либо примечания об обратно несовместимых изменениях.
:::
