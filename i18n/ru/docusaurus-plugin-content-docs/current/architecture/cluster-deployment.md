---
slug: /architecture/cluster-deployment
sidebar_label: Развертывание кластера
sidebar_position: 100
title: Развертывание кластера
---

Этот учебник предполагает, что вы уже настроили [локальный сервер ClickHouse](../getting-started/install.md)

Пройдя этот учебник, вы научитесь настраивать простой кластер ClickHouse. Он будет небольшим, но отказоустойчивым и масштабируемым. Затем мы используем один из примерных наборов данных, чтобы заполнить его данными и выполнить несколько демонстрационных запросов.

## Развертывание кластера {#cluster-deployment}

Этот кластер ClickHouse будет однородным кластером. Вот шаги:

1.  Установите сервер ClickHouse на всех машинах кластера
2.  Настройте конфигурации кластера в конфигурационных файлах
3.  Создайте локальные таблицы на каждом экземпляре
4.  Создайте [распределенную таблицу](../engines/table-engines/special/distributed.md)

[Распределенная таблица](../engines/table-engines/special/distributed.md) — это своего рода "представление" локальных таблиц в кластере ClickHouse. Запрос SELECT из распределенной таблицы выполняется с использованием ресурсов всех шардов кластера. Вы можете указать конфигурации для нескольких кластеров и создать несколько распределенных таблиц, чтобы предоставить представления для различных кластеров.

Вот пример конфигурации для кластера с тремя шардом, с одной репликой каждый:

```xml
<remote_servers>
    <perftest_3shards_1replicas>
        <shard>
            <replica>
                <host>example-perftest01j.clickhouse.com</host>
                <port>9000</port>
            </replica>
        </shard>
        <shard>
            <replica>
                <host>example-perftest02j.clickhouse.com</host>
                <port>9000</port>
            </replica>
        </shard>
        <shard>
            <replica>
                <host>example-perftest03j.clickhouse.com</host>
                <port>9000</port>
            </replica>
        </shard>
    </perftest_3shards_1replicas>
</remote_servers>
```

Для дальнейшей демонстрации давайте создадим новую локальную таблицу с тем же запросом `CREATE TABLE`, который мы использовали для `hits_v1` в учебнике по развертыванию на одном узле, но с другим именем таблицы:

```sql
CREATE TABLE tutorial.hits_local (...) ENGINE = MergeTree() ...
```

Создание распределенной таблицы предоставляет представление о локальных таблицах кластера:

```sql
CREATE TABLE tutorial.hits_all AS tutorial.hits_local
ENGINE = Distributed(perftest_3shards_1replicas, tutorial, hits_local, rand());
```

Обычной практикой является создание аналогичных распределенных таблиц на всех машинах кластера. Это позволяет выполнять распределенные запросы на любой машине кластера. Также есть альтернативный вариант создания временной распределенной таблицы для данного запроса SELECT с использованием [remote](../sql-reference/table-functions/remote.md) функции таблицы.

Давайте выполните [INSERT SELECT](../sql-reference/statements/insert-into.md) в распределенную таблицу, чтобы распространить таблицу на несколько серверов.

```sql
INSERT INTO tutorial.hits_all SELECT * FROM tutorial.hits_v1;
```

Как вы могли ожидать, ресурсоемкие запросы выполняются в N раз быстрее, если они используют 3 сервера вместо одного.

В данном случае мы используем кластер с 3 шардом, и каждый шард содержит одну реплику.

Чтобы обеспечить устойчивость в производственной среде, мы рекомендуем, чтобы каждый шард содержал 2-3 реплики, распределенные между несколькими зонами доступности или дата-центрами (или хотя бы шкафа). Обратите внимание, что ClickHouse поддерживает неограниченное количество реплик.

Вот пример конфигурации для кластера из одного шард, содержащего три реплики:

```xml
<remote_servers>
    ...
    <perftest_1shards_3replicas>
        <shard>
            <replica>
                <host>example-perftest01j.clickhouse.com</host>
                <port>9000</port>
             </replica>
             <replica>
                <host>example-perftest02j.clickhouse.com</host>
                <port>9000</port>
             </replica>
             <replica>
                <host>example-perftest03j.clickhouse.com</host>
                <port>9000</port>
             </replica>
        </shard>
    </perftest_1shards_3replicas>
</remote_servers>
```

Для включения родной репликации требуется [ZooKeeper](http://zookeeper.apache.org/). ClickHouse заботится о целостности данных на всех репликах и автоматически выполняет процедуру восстановления после сбоя. Рекомендуется разворачивать кластер ZooKeeper на отдельных серверах (где не работают другие процессы, включая ClickHouse).

:::note Примечание
ZooKeeper не является строгим требованием: в некоторых простых случаях вы можете дублировать данные, записывая их во все реплики из кода вашего приложения. Этот подход **не** рекомендуется, так как в этом случае ClickHouse не сможет гарантировать целостность данных на всех репликах. Таким образом, это ложится на ответственность вашего приложения.
:::

Расположения ZooKeeper указываются в конфигурационном файле:

```xml
<zookeeper>
    <node>
        <host>zoo01.clickhouse.com</host>
        <port>2181</port>
    </node>
    <node>
        <host>zoo02.clickhouse.com</host>
        <port>2181</port>
    </node>
    <node>
        <host>zoo03.clickhouse.com</host>
        <port>2181</port>
    </node>
</zookeeper>
```

Также нам необходимо установить макросы для идентификации каждого шарда и реплики, которые используются при создании таблицы:

```xml
<macros>
    <shard>01</shard>
    <replica>01</replica>
</macros>
```

Если в момент создания реплицированной таблицы нет реплик, создается новая первая реплика. Если уже есть работающие реплики, новая реплика клонирует данные из существующих. У вас есть возможность сначала создать все реплицированные таблицы, а затем вставить в них данные. Еще один вариант — создать несколько реплик и добавить остальные после или во время вставки данных.

```sql
CREATE TABLE tutorial.hits_replica (...)
ENGINE = ReplicatedMergeTree(
    '/clickhouse_perftest/tables/{shard}/hits',
    '{replica}'
)
...
```

Здесь мы используем [ReplicatedMergeTree](../engines/table-engines/mergetree-family/replication.md) движок таблиц. В параметрах мы указываем путь ZooKeeper, содержащий идентификаторы шара и реплики.

```sql
INSERT INTO tutorial.hits_replica SELECT * FROM tutorial.hits_local;
```

Репликация работает в мульти-мастерном режиме. Данные могут быть загружены в любую реплику, и система затем автоматически синхронизирует их с другими экземплярами. Репликация асинхронная, поэтому в любой момент времени не все реплики могут содержать недавно вставленные данные. Как минимум одна реплика должна быть доступна, чтобы разрешить загрузку данных. Остальные синхронизируют данные и восстанавливают целостность, как только они снова станут активными. Обратите внимание, что этот подход допускает низкую вероятность потери недавно вставленных данных.
