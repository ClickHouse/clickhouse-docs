---
sidebar_label: 'Дополнительные настройки'
sidebar_position: 3
keywords: ['clickhouse', 'python', 'options', 'settings']
description: 'Дополнительные настройки для ClickHouse Connect'
slug: /integrations/language-clients/python/additional-options
title: 'Дополнительные настройки'
doc_type: 'reference'
---



# Дополнительные параметры {#additional-options}

ClickHouse Connect предоставляет ряд дополнительных параметров для продвинутых сценариев использования.


## Глобальные настройки {#global-settings}

Существует небольшое количество настроек, которые управляют поведением ClickHouse Connect на глобальном уровне. Доступ к ним осуществляется через пакет верхнего уровня `common`:

```python
from clickhouse_connect import common

common.set_setting('autogenerate_session_id', False)
common.get_setting('invalid_setting_action')
'drop'
```

:::note
Эти общие настройки `autogenerate_session_id`, `product_name` и `readonly` _всегда_ должны изменяться до создания клиента с помощью метода `clickhouse_connect.get_client`. Изменение этих настроек после создания клиента не влияет на поведение существующих клиентов.
:::

В настоящее время определены следующие глобальные настройки:

| Название настройки                  | По умолчанию | Варианты                | Описание                                                                                                                                                                                                                                                      |
| ----------------------------------- | ------- | ----------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| autogenerate_session_id             | True         | True, False             | Автоматически генерировать новый UUID(1) идентификатор сессии (если не предоставлен) для каждой клиентской сессии. Если идентификатор сессии не предоставлен (ни на уровне клиента, ни на уровне запроса), ClickHouse сгенерирует случайный внутренний идентификатор для каждого запроса. |
| dict_parameter_format               | 'json'       | 'json', 'map'           | Определяет, преобразуют ли параметризованные запросы словарь Python в синтаксис JSON или ClickHouse Map. Значение `json` следует использовать для вставок в столбцы JSON, `map` — для столбцов ClickHouse Map.                                                |
| invalid_setting_action              | 'error'      | 'drop', 'send', 'error' | Действие при предоставлении недопустимой настройки или настройки только для чтения (для клиентской сессии или запроса). При `drop` настройка будет проигнорирована, при `send` настройка будет отправлена в ClickHouse, при `error` будет вызвана клиентская ошибка ProgrammingError. |
| max_connection_age                  | 600          |                         | Максимальное количество секунд, в течение которых HTTP Keep Alive соединение будет оставаться открытым/использоваться повторно. Это предотвращает скопление соединений к одному узлу ClickHouse за балансировщиком нагрузки/прокси. По умолчанию 10 минут.    |
| product_name                        |              |                         | Строка, которая передается вместе с запросом в ClickHouse для отслеживания приложения, использующего ClickHouse Connect. Должна быть в формате &lt;product name&gt;/&lt;product version&gt;.                                                                  |
| readonly                            | 0            | 0, 1                    | Подразумеваемая настройка ClickHouse "read_only" для версий до 19.17. Может быть установлена в соответствии со значением "read_only" ClickHouse для обеспечения работы с очень старыми версиями ClickHouse.                                                   |
| send_os_user                        | True         | True, False             | Включать обнаруженного пользователя операционной системы в информацию о клиенте, отправляемую в ClickHouse (строка HTTP User-Agent).                                                                                                                          |
| send_integration_tags               | True         | True, False             | Включать используемые библиотеки интеграции/версии (например, Pandas/SQLAlchemy/и т. д.) в информацию о клиенте, отправляемую в ClickHouse (строка HTTP User-Agent).                                                                                          |
| use_protocol_version                | True         | True, False             | Использовать версию клиентского протокола. Это необходимо для столбцов `DateTime` с часовыми поясами, но не работает с текущей версией chproxy.                                                                                                               |
| max_error_size                      | 1024         |                         | Максимальное количество символов, которое будет возвращено в сообщениях об ошибках клиента. Используйте значение 0 для этой настройки, чтобы получить полное сообщение об ошибке ClickHouse. По умолчанию 1024 символа.                                       |
| http_buffer_size                    | 10MB         |                         | Размер (в байтах) буфера в памяти, используемого для потоковых HTTP-запросов.                                                                                                                                                                                 |
| preserve_pandas_datetime_resolution | False        | True, False             | Если True и используется pandas 2.x, сохраняет разрешение dtype datetime64/timedelta64 (например, 's', 'ms', 'us', 'ns'). Если False (или в pandas &lt;2.x), приводит к разрешению в наносекундах ('ns') для совместимости.                                  |


## Сжатие {#compression}

ClickHouse Connect поддерживает сжатие lz4, zstd, brotli и gzip как для результатов запросов, так и для вставки данных. Всегда учитывайте, что использование сжатия обычно представляет собой компромисс между пропускной способностью сети/скоростью передачи данных и нагрузкой на процессор (как на стороне клиента, так и на стороне сервера).

Для получения сжатых данных параметр сервера ClickHouse `enable_http_compression` должен быть установлен в 1, либо пользователь должен иметь разрешение на изменение этой настройки на уровне отдельного запроса.

Сжатие управляется параметром `compress` при вызове фабричного метода `clickhouse_connect.get_client`. По умолчанию `compress` установлен в `True`, что активирует настройки сжатия по умолчанию. Для запросов, выполняемых с помощью клиентских методов `query`, `query_np` и `query_df`, ClickHouse Connect добавит заголовок `Accept-Encoding` с кодировками `lz4`, `zstd`, `br` (brotli, если установлена библиотека brotli), `gzip` и `deflate` к запросам, выполняемым методом `query` (и косвенно `query_np` и `query_df`). (Для большинства запросов сервер ClickHouse вернёт данные, сжатые с помощью `zstd`.) Для вставок по умолчанию ClickHouse Connect будет сжимать блоки данных с использованием сжатия `lz4` и отправлять HTTP-заголовок `Content-Encoding: lz4`.

Параметр `compress` метода `get_client` также может быть установлен в конкретный метод сжатия: `lz4`, `zstd`, `br` или `gzip`. Этот метод будет использоваться как для вставок, так и для результатов запросов (если поддерживается сервером ClickHouse). Необходимые библиотеки сжатия `zstd` и `lz4` теперь устанавливаются по умолчанию вместе с ClickHouse Connect. Если указан `br`/brotli, библиотеку brotli необходимо установить отдельно.

Обратите внимание, что клиентские методы `raw*` не используют сжатие, указанное в конфигурации клиента.

Мы также не рекомендуем использовать сжатие `gzip`, поскольку оно значительно медленнее альтернативных методов как при сжатии, так и при распаковке данных.


## Поддержка HTTP-прокси {#http-proxy-support}

ClickHouse Connect обеспечивает базовую поддержку HTTP-прокси с использованием библиотеки `urllib3`. Библиотека распознает стандартные переменные окружения `HTTP_PROXY` и `HTTPS_PROXY`. Обратите внимание, что использование этих переменных окружения будет применяться ко всем клиентам, созданным с помощью метода `clickhouse_connect.get_client`. В качестве альтернативы для настройки конкретного клиента можно использовать аргументы `http_proxy` или `https_proxy` метода get_client. Подробную информацию о реализации поддержки HTTP-прокси см. в документации [urllib3](https://urllib3.readthedocs.io/en/stable/advanced-usage.html#http-and-https-proxies).

Для использования SOCKS-прокси можно передать `urllib3` `SOCKSProxyManager` в качестве аргумента `pool_mgr` методу `get_client`. Обратите внимание, что для этого потребуется установить библиотеку PySocks либо напрямую, либо с помощью опции `[socks]` для зависимости `urllib3`.


## «Старый» тип данных JSON {#old-json-data-type}

Экспериментальный тип данных `Object` (или `Object('json')`) является устаревшим и не должен использоваться в продуктивной среде. ClickHouse Connect продолжает предоставлять ограниченную поддержку этого типа данных для обеспечения обратной совместимости. Обратите внимание, что эта поддержка не распространяется на запросы, которые должны возвращать JSON-значения «верхнего уровня» или «родительские» значения в виде словарей или их эквивалентов — такие запросы приведут к возникновению исключения.


## «Новые» типы данных Variant/Dynamic/JSON (экспериментальная возможность) {#new-variantdynamicjson-datatypes-experimental-feature}

Начиная с версии 0.8.0, `clickhouse-connect` предоставляет экспериментальную поддержку новых (также экспериментальных) типов ClickHouse: Variant, Dynamic и JSON.

### Примечания по использованию {#usage-notes}

- Данные JSON можно вставлять либо в виде словаря Python, либо в виде JSON-строки, содержащей JSON-объект `{}`. Другие формы данных JSON не поддерживаются.
- Запросы, использующие подстолбцы/пути для этих типов, возвращают тип подстолбца.
- Дополнительные примечания по использованию см. в основной [документации](https://clickhouse.com/docs) ClickHouse.

### Известные ограничения {#known-limitations}

- Каждый из этих типов необходимо включить в настройках ClickHouse перед использованием.
- «Новый» тип JSON доступен начиная с версии ClickHouse 24.8.
- Из-за изменений внутреннего формата `clickhouse-connect` совместим с типами Variant только начиная с версии ClickHouse 24.7.
- Возвращаемые JSON-объекты будут содержать только количество элементов, равное `max_dynamic_paths` (по умолчанию 1024). Это будет исправлено в будущем релизе.
- Вставки в столбцы `Dynamic` всегда будут строковым представлением значения Python. Это будет исправлено в будущем релизе после устранения проблемы https://github.com/ClickHouse/ClickHouse/issues/70395.
- Реализация новых типов не оптимизирована в коде на C, поэтому производительность может быть несколько ниже, чем у более простых, устоявшихся типов данных.
