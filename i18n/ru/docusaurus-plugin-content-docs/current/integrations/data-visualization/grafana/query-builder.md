---
sidebar_label: 'Конструктор запросов'
sidebar_position: 2
slug: /integrations/grafana/query-builder
description: 'Использование конструктора запросов в плагине ClickHouse для Grafana'
title: 'Конструктор запросов'
doc_type: 'guide'
keywords: ['grafana', 'query builder', 'visualization', 'dashboards', 'plugin']
---

import Image from '@theme/IdealImage';
import demo_table_query from '@site/static/images/integrations/data-visualization/grafana/demo_table_query.png';
import demo_logs_query from '@site/static/images/integrations/data-visualization/grafana/demo_logs_query.png';
import demo_logs_query_fields from '@site/static/images/integrations/data-visualization/grafana/demo_logs_query_fields.png';
import demo_time_series_query from '@site/static/images/integrations/data-visualization/grafana/demo_time_series_query.png';
import demo_trace_query from '@site/static/images/integrations/data-visualization/grafana/demo_trace_query.png';
import demo_raw_sql_query from '@site/static/images/integrations/data-visualization/grafana/demo_raw_sql_query.png';
import trace_id_in_table from '@site/static/images/integrations/data-visualization/grafana/trace_id_in_table.png';
import trace_id_in_logs from '@site/static/images/integrations/data-visualization/grafana/trace_id_in_logs.png';
import demo_data_links from '@site/static/images/integrations/data-visualization/grafana/demo_data_links.png';
import ClickHouseSupportedBadge from '@theme/badges/ClickHouseSupported';


# Конструктор запросов

<ClickHouseSupportedBadge/>

Любой запрос может быть выполнен с помощью плагина ClickHouse.
Конструктор запросов — удобный инструмент для более простых запросов, но для сложных запросов вам потребуется использовать [SQL Editor](#sql-editor).

Все запросы в конструкторе запросов имеют [тип запроса](#query-types) и требуют выбора как минимум одного столбца.

Доступные типы запросов:
- [Table](#table): самый простой тип запроса для отображения данных в табличном формате. Хорошо подходит как универсальный вариант как для простых, так и для сложных запросов, содержащих агрегатные функции.
- [Logs](#logs): оптимизирован для построения запросов к логам. Лучше всего работает в режиме обзора (explore view) с [настроенными значениями по умолчанию](./config.md#logs).
- [Time Series](#time-series): лучше всего подходит для построения запросов по временным рядам. Позволяет выбрать специальный временной столбец и добавлять агрегатные функции.
- [Traces](#traces): оптимизирован для поиска и просмотра трассировок. Лучше всего работает в режиме обзора (explore view) с [настроенными значениями по умолчанию](./config.md#traces).
- [SQL Editor](#sql-editor): SQL Editor можно использовать, когда вам нужен полный контроль над запросом. В этом режиме можно выполнять любые SQL-запросы.



## Типы запросов {#query-types}

Настройка _Тип запроса_ изменяет компоновку конструктора запросов в соответствии с типом создаваемого запроса.
Тип запроса также определяет, какая панель используется при визуализации данных.

### Таблица {#table}

Наиболее гибким типом запроса является табличный запрос. Это универсальный вариант конструктора запросов, предназначенный для обработки как простых, так и агрегатных запросов.

| Поле         | Описание                                                                                                                                                                                     |
| ------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Builder Mode | Простые запросы исключают агрегаты и Group By, тогда как агрегатные запросы включают эти опции.                                                                                             |
| Columns      | Выбранные столбцы. В это поле можно вводить чистый SQL для использования функций и псевдонимов столбцов.                                                                                    |
| Aggregates   | Список [агрегатных функций](/sql-reference/aggregate-functions/index.md). Позволяет задавать пользовательские значения для функции и столбца. Отображается только в режиме Aggregate.       |
| Group By     | Список выражений [GROUP BY](/sql-reference/statements/select/group-by.md). Отображается только в режиме Aggregate.                                                                          |
| Order By     | Список выражений [ORDER BY](/sql-reference/statements/select/order-by.md).                                                                                                                  |
| Limit        | Добавляет оператор [LIMIT](/sql-reference/statements/select/limit.md) в конец запроса. Если установлено значение `0`, то он будет исключен. Некоторым визуализациям может потребоваться значение `0` для отображения всех данных. |
| Filters      | Список фильтров, применяемых в секции `WHERE`.                                                                                                                                               |

<Image
  size='md'
  img={demo_table_query}
  alt='Пример агрегатного табличного запроса'
  border
/>

Этот тип запроса отображает данные в виде таблицы.

### Логи {#logs}

Тип запроса для логов предлагает конструктор запросов, ориентированный на запросы к данным логов.
Значения по умолчанию можно настроить в [конфигурации логов](./config.md#logs) источника данных, чтобы конструктор запросов предварительно загружался с базой данных/таблицей и столбцами по умолчанию.
Также можно включить OpenTelemetry для автоматического выбора столбцов в соответствии с версией схемы.

Фильтры **Time** и **Level** добавляются по умолчанию вместе с Order By для столбца Time.
Эти фильтры привязаны к соответствующим полям и будут обновляться при изменении столбцов.
Фильтр **Level** по умолчанию исключен из SQL; изменение его с опции `IS ANYTHING` включит его.

Тип запроса для логов поддерживает [ссылки на данные](#data-links).

| Поле           | Описание                                                                                                                                                                                   |
| -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Use OTel       | Включает столбцы OpenTelemetry. Перезапишет выбранные столбцы для использования столбцов, определенных выбранной версией схемы OTel (отключает выбор столбцов).                            |
| Columns        | Дополнительные столбцы, добавляемые к строкам логов. В это поле можно вводить чистый SQL для использования функций и псевдонимов столбцов.                                                 |
| Time           | Основной столбец временной метки для лога. Будет отображать типы, похожие на время, но допускает пользовательские значения/функции.                                                        |
| Log Level      | Необязательно. _Уровень_ или _серьезность_ лога. Значения обычно выглядят как `INFO`, `error`, `Debug` и т. д.                                                                            |
| Message        | Содержимое сообщения лога.                                                                                                                                                                 |
| Order By       | Список выражений [ORDER BY](/sql-reference/statements/select/order-by.md).                                                                                                                |
| Limit          | Добавляет оператор [LIMIT](/sql-reference/statements/select/limit.md) в конец запроса. Если установлено значение `0`, то он будет исключен, но это не рекомендуется для больших наборов данных логов. |
| Filters        | Список фильтров, применяемых в секции `WHERE`.                                                                                                                                             |
| Message Filter | Текстовое поле для удобной фильтрации логов с использованием `LIKE %value%`. Исключается, когда поле ввода пустое.                                                                         |

<Image size='md' img={demo_logs_query} alt='Пример запроса логов OTel' border />

<br />
Этот тип запроса отображает данные на панели логов вместе с панелью гистограммы логов вверху.

Дополнительные столбцы, выбранные в запросе, можно просмотреть в развернутой строке лога:

<Image
  size='md'
  img={demo_logs_query_fields}
  alt='Пример дополнительных полей в запросе логов'
  border
/>

### Временные ряды {#time-series}

Тип запроса для временных рядов похож на [таблицу](#table), но с акцентом на данные временных рядов.

Оба представления в основном одинаковы, со следующими заметными различиями:

- Выделенное поле _Time_.
- В режиме Aggregate автоматически применяется макрос временного интервала вместе с Group By для поля Time.
- В режиме Aggregate поле «Columns» скрыто.
- Фильтр временного диапазона и Order By автоматически добавляются для поля **Time**.

:::important Отсутствуют данные в визуализации?
В некоторых случаях панель временных рядов может выглядеть обрезанной, поскольку лимит по умолчанию установлен на `1000`.

Попробуйте удалить секцию `LIMIT`, установив значение `0` (если ваш набор данных это позволяет).
:::


| Поле         | Описание                                                                                                                                                                                                                           |
| ------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Builder Mode | Простые запросы не включают агрегаты и группировку, тогда как агрегатные запросы включают эти опции.                                                                                                                              |
| Time         | Основной столбец времени для запроса. Отображает типы времени, но допускает пользовательские значения и функции.                                                                                                                  |
| Columns      | Выбранные столбцы. В это поле можно вводить SQL-код для использования функций и псевдонимов столбцов. Отображается только в простом режиме.                                                                                       |
| Aggregates   | Список [агрегатных функций](/sql-reference/aggregate-functions/index.md). Допускает пользовательские значения для функции и столбца. Отображается только в режиме агрегации.                                                      |
| Group By     | Список выражений [GROUP BY](/sql-reference/statements/select/group-by.md). Отображается только в режиме агрегации.                                                                                                                |
| Order By     | Список выражений [ORDER BY](/sql-reference/statements/select/order-by.md).                                                                                                                                                        |
| Limit        | Добавляет оператор [LIMIT](/sql-reference/statements/select/limit.md) в конец запроса. Если установлено значение `0`, оператор будет исключен; это рекомендуется для некоторых наборов данных временных рядов для отображения полной визуализации. |
| Filters      | Список фильтров, применяемых в предложении `WHERE`.                                                                                                                                                                               |

<Image
  size='md'
  img={demo_time_series_query}
  alt='Пример запроса временных рядов'
  border
/>

Этот тип запроса отображает данные на панели временных рядов.

### Трассировки {#traces}

Тип запроса трассировки предоставляет конструктор запросов для удобного поиска и просмотра трассировок.
Он предназначен для данных OpenTelemetry, но можно выбрать столбцы для отображения трассировок из другой схемы.
Значения по умолчанию можно настроить в [конфигурации трассировки](./config.md#traces) источника данных, чтобы конструктор запросов был предварительно загружен с базой данных, таблицей и столбцами по умолчанию. Если значения по умолчанию настроены, выбор столбцов будет свернут по умолчанию.
OpenTelemetry также можно включить для автоматического выбора столбцов в соответствии с версией схемы.

Фильтры по умолчанию добавляются для отображения только спанов верхнего уровня.
Также включена сортировка Order By для столбцов времени и длительности.
Эти фильтры привязаны к соответствующим полям и будут обновляться при изменении столбцов.
Фильтр **Service Name** по умолчанию исключен из SQL; изменение его с опции `IS ANYTHING` включит его.

Тип запроса трассировки поддерживает [ссылки на данные](#data-links).

| Поле                  | Описание                                                                                                                                                                                     |
| --------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Trace Mode            | Переключает запрос с поиска трассировки на поиск по идентификатору трассировки.                                                                                                             |
| Use OTel              | Включает столбцы OpenTelemetry. Перезаписывает выбранные столбцы для использования столбцов, определенных выбранной версией схемы OTel (отключает выбор столбцов).                          |
| Trace ID Column       | Идентификатор трассировки.                                                                                                                                                                   |
| Span ID Column        | Идентификатор спана.                                                                                                                                                                         |
| Parent Span ID Column | Идентификатор родительского спана. Обычно пуст для трассировок верхнего уровня.                                                                                                             |
| Service Name Column   | Имя сервиса.                                                                                                                                                                                 |
| Operation Name Column | Имя операции.                                                                                                                                                                                |
| Start Time Column     | Основной столбец времени для спана трассировки. Время начала спана.                                                                                                                          |
| Duration Time Column  | Длительность спана. По умолчанию Grafana ожидает, что это будет число с плавающей точкой в миллисекундах. Преобразование применяется автоматически через выпадающий список `Duration Unit`. |
| Duration Unit         | Единица времени, используемая для длительности. По умолчанию наносекунды. Выбранная единица будет преобразована в число с плавающей точкой в миллисекундах, как требуется Grafana.          |
| Tags Column           | Теги спана. Исключите это поле, если не используете схему на основе OTel, так как ожидается определенный тип столбца Map.                                                                   |
| Service Tags Column   | Теги сервиса. Исключите это поле, если не используете схему на основе OTel, так как ожидается определенный тип столбца Map.                                                                 |
| Order By              | Список выражений [ORDER BY](/sql-reference/statements/select/order-by.md).                                                                                                                  |
| Limit                 | Добавляет оператор [LIMIT](/sql-reference/statements/select/limit.md) в конец запроса. Если установлено значение `0`, оператор будет исключен, но это не рекомендуется для больших наборов данных трассировок. |
| Filters               | Список фильтров, применяемых в предложении `WHERE`.                                                                                                                                         |
| Trace ID              | Идентификатор трассировки для фильтрации. Используется только в режиме Trace ID и при открытии [ссылки на данные](#data-links) идентификатора трассировки.                                  |

<Image size='md' img={demo_trace_query} alt='Пример запроса трассировки OTel' border />

Этот тип запроса отображает данные в табличном представлении для режима поиска трассировок и на панели трассировки для режима идентификатора трассировки.


## SQL-редактор {#sql-editor}

Для запросов, которые слишком сложны для конструктора запросов, можно использовать SQL-редактор.
Он предоставляет полный контроль над запросом, позволяя писать и выполнять SQL-код ClickHouse напрямую.

SQL-редактор можно открыть, выбрав «SQL Editor» в верхней части редактора запросов.

В этом режиме по-прежнему можно использовать [макрофункции](#macros).

Вы можете переключаться между типами запросов, чтобы выбрать визуализацию, наиболее подходящую для вашего запроса.
Это переключение действует и в режиме просмотра дашборда, особенно при работе с данными временных рядов.

<Image size='md' img={demo_raw_sql_query} alt='Пример SQL-запроса' border />


## Ссылки на данные {#data-links}

[Ссылки на данные](https://grafana.com/docs/grafana/latest/panels-visualizations/configure-data-links) Grafana
можно использовать для создания ссылок на новые запросы.
Эта функция включена в плагине ClickHouse для связывания трассировки с логами и наоборот. Она работает лучше всего при настройке OpenTelemetry как для логов, так и для трассировок в [конфигурации источника данных](./config.md#opentelemetry)

<div
  style={{
    display: "flex",
    flexDirection: "column",
    alignItems: "center",
    justifyContent: "space-between",
    marginBottom: "15px"
  }}
>
  Пример ссылок на трассировки в таблице
  <Image size='sm' img={trace_id_in_table} alt='Trace links in table' border />
</div>

<div
  style={{
    display: "flex",
    flexDirection: "column",
    alignItems: "center",
    justifyContent: "space-between"
  }}
>
  Пример ссылок на трассировки в логах
  <Image size='md' img={trace_id_in_logs} alt='Trace links in logs' border />
</div>

### Как создать ссылку на данные {#how-to-make-a-data-link}

Вы можете создать ссылку на данные, выбрав в запросе столбец с именем `traceID`. Это имя не чувствительно к регистру и поддерживает добавление подчеркивания перед «ID». Например: `traceId`, `TraceId`, `TRACE_ID` и `tracE_iD` будут допустимыми вариантами.

Если OpenTelemetry включен в запросе [логов](#logs) или [трассировок](#traces), столбец с идентификатором трассировки будет добавлен автоматически.

При включении столбца с идентификатором трассировки к данным будут добавлены ссылки «**View Trace**» и «**View Logs**».

### Возможности связывания {#linking-abilities}

При наличии ссылок на данные вы можете открывать трассировки и логи, используя предоставленный идентификатор трассировки.

«**View Trace**» откроет разделенную панель с трассировкой, а «**View Logs**» откроет запрос логов, отфильтрованный по идентификатору трассировки.
Если ссылка открывается из дашборда, а не из режима исследования, она будет открыта в новой вкладке в режиме исследования.

Наличие настроенных значений по умолчанию для [логов](./config.md#logs) и [трассировок](./config.md#traces) требуется при переходе между типами запросов (от логов к трассировкам и от трассировок к логам). Значения по умолчанию не требуются при открытии ссылки того же типа запроса, поскольку запрос можно просто скопировать.

<div
  style={{
    display: "flex",
    flexDirection: "column",
    alignItems: "center",
    justifyContent: "space-between"
  }}
>
  Пример просмотра трассировки (правая панель) из запроса логов (левая панель)
  <Image
    size='md'
    img={demo_data_links}
    alt='Example of data links linking'
    border
  />
</div>


## Макросы {#macros}

Макросы — это простой способ добавить динамический SQL в запрос.
Перед отправкой запроса на сервер ClickHouse плагин раскрывает макрос и заменяет его полным выражением.

Запросы как из SQL Editor, так и из Query Builder могут использовать макросы.

### Использование макросов {#using-macros}

Макросы можно включать в любом месте запроса, при необходимости несколько раз.

Вот пример использования макроса `$__timeFilter`:

Ввод:

```sql
SELECT log_time, log_message
FROM logs
WHERE $__timeFilter(log_time)
```

Итоговый результат запроса:

```sql
SELECT log_time, log_message
FROM logs
WHERE log_time >= toDateTime(1415792726) AND log_time <= toDateTime(1447328726)
```

В этом примере временной диапазон дашборда Grafana применяется к столбцу `log_time`.

Плагин также поддерживает нотацию с использованием фигурных скобок `{}`. Используйте эту нотацию, когда запросы необходимы внутри [параметров](/sql-reference/syntax.md#defining-and-using-query-parameters).

### Список макросов {#list-of-macros}

Это список всех макросов, доступных в плагине:

| Макрос                                       | Описание                                                                                                                                                                            | Пример вывода                                                                                                     |
| -------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------- |
| `$__dateFilter(columnName)`                  | Заменяется фильтром временного диапазона для указанного столбца с использованием временного диапазона панели Grafana в виде [Date](/sql-reference/data-types/date.md).              | `columnName >= toDate('2022-10-21') AND columnName <= toDate('2022-10-23')`                                       |
| `$__timeFilter(columnName)`                  | Заменяется фильтром временного диапазона для указанного столбца с использованием временного диапазона панели Grafana в виде [DateTime](/sql-reference/data-types/datetime.md).      | `columnName >= toDateTime(1415792726) AND time <= toDateTime(1447328726)`                                         |
| `$__timeFilter_ms(columnName)`               | Заменяется фильтром временного диапазона для указанного столбца с использованием временного диапазона панели Grafana в виде [DateTime64](/sql-reference/data-types/datetime64.md).  | `columnName >= fromUnixTimestamp64Milli(1415792726123) AND columnName <= fromUnixTimestamp64Milli(1447328726456)` |
| `$__dateTimeFilter(dateColumn, timeColumn)`  | Сокращение, объединяющее `$__dateFilter()` и `$__timeFilter()` с использованием отдельных столбцов Date и DateTime. Псевдоним `$__dt()`                                            | `$__dateFilter(dateColumn) AND $__timeFilter(timeColumn)`                                                         |
| `$__fromTime`                                | Заменяется начальным временем диапазона панели Grafana, приведенным к типу [DateTime](/sql-reference/data-types/datetime.md).                                                       | `toDateTime(1415792726)`                                                                                          |
| `$__fromTime_ms`                             | Заменяется начальным временем диапазона панели, приведенным к типу [DateTime64](/sql-reference/data-types/datetime64.md).                                                           | `fromUnixTimestamp64Milli(1415792726123)`                                                                         |
| `$__toTime`                                  | Заменяется конечным временем диапазона панели Grafana, приведенным к типу [DateTime](/sql-reference/data-types/datetime.md).                                                        | `toDateTime(1447328726)`                                                                                          |
| `$__toTime_ms`                               | Заменяется конечным временем диапазона панели, приведенным к типу [DateTime64](/sql-reference/data-types/datetime64.md).                                                            | `fromUnixTimestamp64Milli(1447328726456)`                                                                         |
| `$__timeInterval(columnName)`                | Заменяется функцией, вычисляющей интервал на основе размера окна в секундах.                                                                                                       | `toStartOfInterval(toDateTime(columnName), INTERVAL 20 second)`                                                   |
| `$__timeInterval_ms(columnName)`             | Заменяется функцией, вычисляющей интервал на основе размера окна в миллисекундах.                                                                                                  | `toStartOfInterval(toDateTime64(columnName, 3), INTERVAL 20 millisecond)`                                         |
| `$__interval_s`                              | Заменяется интервалом дашборда в секундах.                                                                                                                                          | `20`                                                                                                              |
| `$__conditionalAll(condition, $templateVar)` | Заменяется первым параметром, когда переменная шаблона во втором параметре не выбирает все значения. Заменяется на 1=1, когда переменная шаблона выбирает все значения.            | `condition` или `1=1`                                                                                             |
