---
sidebar_label: 'Конструктор запросов'
sidebar_position: 2
slug: /integrations/grafana/query-builder
description: 'Использование конструктора запросов в плагине ClickHouse для Grafana'
title: 'Конструктор запросов'
doc_type: 'guide'
keywords: ['grafana', 'конструктор запросов', 'визуализация', 'дашборды', 'плагин']
integration:
  - support_level: 'core'
  - category: 'data_visualization'
---

import Image from '@theme/IdealImage';
import demo_table_query from '@site/static/images/integrations/data-visualization/grafana/demo_table_query.png';
import demo_logs_query from '@site/static/images/integrations/data-visualization/grafana/demo_logs_query.png';
import demo_logs_query_fields from '@site/static/images/integrations/data-visualization/grafana/demo_logs_query_fields.png';
import demo_time_series_query from '@site/static/images/integrations/data-visualization/grafana/demo_time_series_query.png';
import demo_trace_query from '@site/static/images/integrations/data-visualization/grafana/demo_trace_query.png';
import demo_raw_sql_query from '@site/static/images/integrations/data-visualization/grafana/demo_raw_sql_query.png';
import trace_id_in_table from '@site/static/images/integrations/data-visualization/grafana/trace_id_in_table.png';
import trace_id_in_logs from '@site/static/images/integrations/data-visualization/grafana/trace_id_in_logs.png';
import demo_data_links from '@site/static/images/integrations/data-visualization/grafana/demo_data_links.png';
import ClickHouseSupportedBadge from '@theme/badges/ClickHouseSupported';


# Конструктор запросов \{#query-builder\}

<ClickHouseSupportedBadge/>

Любой запрос может быть выполнен с помощью плагина ClickHouse.
Конструктор запросов — удобный инструмент для простых запросов, но для сложных запросов необходимо использовать [SQL Editor](#sql-editor).

Все запросы в конструкторе запросов имеют [тип запроса](#query-types) и требуют выбора как минимум одного столбца.

Доступные типы запросов:

- [Table](#table): самый простой тип запроса для отображения данных в табличном формате. Хорошо подходит как универсальный вариант как для простых, так и для сложных запросов, содержащих агрегатные функции.
- [Logs](#logs): оптимизирован для построения запросов к логам. Лучше всего работает в режиме обзора с [настроенными значениями по умолчанию](./config.md#logs).
- [Time Series](#time-series): лучше всего подходит для построения запросов временных рядов. Позволяет выбрать отдельный столбец с временем и добавлять агрегатные функции.
- [Traces](#traces): оптимизирован для поиска и просмотра трассировок. Лучше всего работает в режиме обзора с [настроенными значениями по умолчанию](./config.md#traces).
- [SQL Editor](#sql-editor): SQL Editor можно использовать, когда вам нужен полный контроль над запросом. В этом режиме может быть выполнен любой SQL-запрос.

## Типы запросов \{#query-types\}

Настройка *Query Type* изменяет компоновку конструктора запросов в соответствии с типом формируемого запроса.
Тип запроса также определяет, какая панель используется для визуализации данных.

### Таблица \{#table\}

Наиболее гибкий тип запроса — табличный запрос. Это универсальный вариант для других конструкторов запросов, предназначенный для обработки простых и агрегирующих запросов.

| Поле | Описание |
|----|----|
| Builder Mode  | Простые запросы исключают `Aggregates` и `Group By`, тогда как агрегирующие запросы включают эти опции.  |
| Columns | Выбранные столбцы. В это поле можно вводить произвольный SQL‑код (raw SQL), чтобы использовать функции и псевдонимы столбцов. |
| Aggregates | Список [aggregate functions](/sql-reference/aggregate-functions/index.md). Позволяет указывать произвольные значения для функции и столбца. Отображается только в режиме Aggregate. |
| Group By | Список выражений [GROUP BY](/sql-reference/statements/select/group-by.md). Отображается только в режиме Aggregate. |
| Order By | Список выражений [ORDER BY](/sql-reference/statements/select/order-by.md). |
| Limit | Добавляет оператор [LIMIT](/sql-reference/statements/select/limit.md) в конец запроса. Если установлено значение `0`, то он будет исключён. Некоторым визуализациям может потребоваться значение `0`, чтобы показать все данные. |
| Filters | Список фильтров, которые будут применены в предложении `WHERE`. |

<Image size="md" img={demo_table_query} alt="Пример агрегирующего табличного запроса" border />

Этот тип запроса отображает данные в виде таблицы.

### Логи \{#logs\}

Тип запроса для логов предоставляет конструктор запросов, ориентированный на выборку данных логов.
Значения по умолчанию можно настроить в [конфигурации логов](./config.md#logs) источника данных, чтобы конструктор запросов предварительно заполнялся базой данных/таблицей и столбцами по умолчанию.
OpenTelemetry также может быть включён для автоматического выбора столбцов в соответствии с версией схемы.

Фильтры **Time** и **Level** добавляются по умолчанию вместе с Order By для столбца Time.
Эти фильтры привязаны к соответствующим полям и будут обновляться при изменении столбцов.
Фильтр **Level** по умолчанию исключён из SQL; изменение его значения с опции `IS ANYTHING` включит его.

Тип запроса для логов поддерживает [data links](#data-links).

| Поле | Описание |
|----|----|
| Use OTel | Включает столбцы OpenTelemetry. Перезаписывает выбранные столбцы, чтобы использовать столбцы, определённые выбранной версией схемы OTel (отключает выбор столбцов). |
| Columns | Дополнительные столбцы, которые будут добавлены к строкам логов. В это поле можно вводить «сырой» SQL для использования функций и создания псевдонимов столбцов. |
| Time | Основной столбец метки времени для логов. Отображает типы, похожие на время, но допускает пользовательские значения/функции. |
| Log Level | Необязательно. *Уровень* или *критичность* лога. Значения обычно выглядят как `INFO`, `error`, `Debug` и т. п. |
| Message | Содержимое сообщения лога. |
| Order By | Список выражений [ORDER BY](/sql-reference/statements/select/order-by.md). |
| Limit | Добавляет команду [LIMIT](/sql-reference/statements/select/limit.md) в конец запроса. Если задано значение `0`, то она будет исключена, но это не рекомендуется для больших наборов логов. |
| Filters | Список фильтров, применяемых в выражении `WHERE`. |
| Message Filter | Текстовое поле для удобной фильтрации логов с помощью `LIKE %value%`. Исключается, если поле ввода пустое. |

<Image size="md" img={demo_logs_query} alt="Пример запроса логов OTel" border />

<br/>

Этот тип запроса отобразит данные в панели логов, а также панель с гистограммой логов в верхней части.

Дополнительные столбцы, выбранные в запросе, можно просматривать в раскрытой строке лога:

<Image size="md" img={demo_logs_query_fields} alt="Пример дополнительных полей в запросе логов" border />

### Временные ряды \{#time-series\}

Тип запроса «Временные ряды» похож на [табличный](#table), но с акцентом на данные временных рядов.

Два представления в основном одинаковы, за исключением следующих отличий:

- Отдельное поле *Time*.
- В режиме Aggregate автоматически применяется макрос временного интервала вместе с Group By для поля Time.
- В режиме Aggregate поле "Columns" скрыто.
- Для поля **Time** автоматически добавляются фильтр диапазона времени и ORDER BY.

:::important В вашей визуализации отсутствуют данные?
В некоторых случаях панель временных рядов может казаться обрезанной, потому что значение по умолчанию для лимита — `1000`.

Попробуйте убрать выражение `LIMIT`, установив его в `0` (если это допускается вашим датасетом).
:::

| Field | Description |
|----|----|
| Builder Mode  | Простые запросы исключают Aggregates и Group By, тогда как агрегированные запросы включают эти опции.  |
| Time | Основной временной столбец для запроса. Отображает типы, похожие на время, но допускает пользовательские значения/функции. |
| Columns | Выбранные столбцы. В это поле можно вводить «сырой» SQL, чтобы использовать функции и псевдонимы столбцов. Видно только в режиме Simple. |
| Aggregates | Список [агрегатных функций](/sql-reference/aggregate-functions/index.md). Позволяет задавать пользовательские значения для функции и столбца. Видно только в режиме Aggregate. |
| Group By | Список выражений [GROUP BY](/sql-reference/statements/select/group-by.md). Видно только в режиме Aggregate. |
| Order By | Список выражений [ORDER BY](/sql-reference/statements/select/order-by.md). |
| Limit | Добавляет команду [LIMIT](/sql-reference/statements/select/limit.md) в конец запроса. Если установлено значение `0`, она будет исключена; это рекомендуется для некоторых датасетов временных рядов, чтобы отображать полную визуализацию. |
| Filters | Список фильтров, применяемых в `WHERE`-выражении. |

<Image size="md" img={demo_time_series_query} alt="Пример запроса по временным рядам" border />

Этот тип запроса отображает данные с помощью панели временных рядов.

### Трейсы \{#traces\}

Тип запроса трейсов предоставляет конструктор запросов для удобного поиска и просмотра трейсов.
Он предназначен для данных OpenTelemetry, но можно выбирать столбцы, чтобы отображать трейсы из другой схемы.
Значения по умолчанию могут быть настроены в [конфигурации трейсов](./config.md#traces) источника данных, чтобы конструктор запросов предварительно загружался базой данных/таблицей и столбцами по умолчанию. Если значения по умолчанию заданы, блок выбора столбцов будет свернут по умолчанию.
OpenTelemetry также может быть включён для автоматического выбора столбцов в соответствии с версией схемы.

Фильтры по умолчанию добавляются с целью отображать только верхнеуровневые спаны.
Также добавляется сортировка (Order By) по столбцам Time и Duration Time.
Эти фильтры привязаны к соответствующим полям и будут обновляться при изменении столбцов.
Фильтр **Service Name** по умолчанию исключён из SQL; изменение его параметра с опции `IS ANYTHING` включит его.

Тип запроса трейсов поддерживает [data links](#data-links).

| Поле | Описание |
|----|----|
| Trace Mode | Меняет тип запроса с Trace Search на поиск по Trace ID. |
| Use OTel | Включает столбцы OpenTelemetry. Перезаписывает выбранные столбцы, чтобы использовать столбцы, определённые выбранной версией схемы OTel (отключает выбор столбцов). |
| Trace ID Column | ID трейса. |
| Span ID Column | ID спана. |
| Parent Span ID Column | ID родительского спана. Обычно пустой для верхнеуровневых трейсов. |
| Service Name Column | Имя сервиса. |
| Operation Name Column | Имя операции. |
| Start Time Column | Основной временной столбец для спана трейса. Время начала спана. |
| Duration Time Column | Длительность спана. По умолчанию Grafana ожидает значение типа float в миллисекундах. Преобразование автоматически применяется через выпадающий список `Duration Unit`. |
| Duration Unit | Единица времени, используемая для длительности. По умолчанию наносекунды. Выбранная единица будет конвертирована во float в миллисекундах, как того требует Grafana. |
| Tags Column | Теги спана. Исключите это поле, если вы не используете схему, основанную на OTel, так как ожидается конкретный тип столбца Map. |
| Service Tags Column | Теги сервиса. Исключите это поле, если вы не используете схему, основанную на OTel, так как ожидается конкретный тип столбца Map. |
| Order By | Список выражений [ORDER BY](/sql-reference/statements/select/order-by.md). |
| Limit | Добавляет команду [LIMIT](/sql-reference/statements/select/limit.md) в конец запроса. Если установлено значение `0`, то она будет исключена, но это не рекомендуется для крупных наборов данных трейсов. |
| Filters | Список фильтров, применяемых в секции `WHERE`. |
| Trace ID | Trace ID, по которому выполняется фильтрация. Используется только в режиме Trace ID и при открытии [data link](#data-links) по Trace ID. |

<Image size="md" img={demo_trace_query} alt="Пример OTel-запроса трейсов" border />

Этот тип запроса будет отображать данные в виде таблицы в режиме Trace Search и в виде панели трейсов в режиме Trace ID.

## Редактор SQL \{#sql-editor\}

Для запросов, которые слишком сложны для конструктора запросов, используйте редактор SQL.
Это даёт вам полный контроль над запросами, позволяя писать и выполнять обычный SQL ClickHouse.

Редактор SQL можно открыть, выбрав «SQL Editor» в верхней части редактора запросов.

[Макрофункции](#macros) по-прежнему можно использовать в этом режиме.

Вы можете переключаться между типами запросов, чтобы получить визуализацию, которая лучше всего соответствует вашему запросу.
Этот переключатель влияет на визуализацию и в режиме дашборда, особенно для данных временных рядов.

<Image size="md" img={demo_raw_sql_query} alt="Пример произвольного SQL-запроса" border />

## Ссылки на данные \{#data-links\}

В Grafana [ссылки на данные](https://grafana.com/docs/grafana/latest/panels-visualizations/configure-data-links)
можно использовать для перехода к новым запросам.
Эта функция реализована в плагине ClickHouse для связывания трассировки с логами и наоборот. Она работает лучше всего, когда OpenTelemetry настроен и для логов, и для трассировок в [конфигурации источника данных](./config.md#opentelemetry).

<div style={{display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'space-between', marginBottom: '15px' }}>
  Пример ссылок на трассировку в таблице
  <Image size="sm" img={trace_id_in_table} alt="Trace links in table" border />
</div>

<div style={{display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'space-between' }}>
  Пример ссылок на трассировку в логах
  <Image size="md" img={trace_id_in_logs} alt="Trace links in logs" border />
</div>

### Как создать ссылку на данные \{#how-to-make-a-data-link\}

Вы можете создать ссылку на данные, выбрав в запросе столбец с именем `traceID`. Это имя не зависит от регистра и допускает добавление символа подчёркивания перед «ID». Например: `traceId`, `TraceId`, `TRACE_ID` и `tracE_iD` — все являются допустимыми вариантами.

Если в [запросе логов](#logs) или [запросе трассировок](#traces) включён OpenTelemetry, столбец с идентификатором трассы (trace ID) будет добавлен автоматически.

При наличии столбца trace ID к данным будут добавлены ссылки «**View Trace**» и «**View Logs**».

### Возможности переходов \{#linking-abilities\}

При наличии ссылок на данные вы можете открывать трассировки и логи, используя указанный trace ID.

"**View Trace**" откроет разделённую панель с трассировкой, а "**View Logs**" — запрос по логам, отфильтрованный по trace ID.
Если перейти по ссылке с dashboard, а не из представления Explore, она будет открыта в новой вкладке в представлении Explore.

Наличие настроек по умолчанию как для [logs](./config.md#logs), так и для [traces](./config.md#traces) требуется при переходе между типами запросов (из логов в трассировки и из трассировок в логи). Настройки по умолчанию не требуются при открытии ссылки того же типа запроса, так как запрос можно просто скопировать.

<div style={{display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'space-between' }}>
  Пример просмотра трассировки (правая панель) из запроса по логам (левая панель)
  <Image size="md" img={demo_data_links} alt="Пример перехода по ссылкам на данные" border />
</div>

## Макросы \{#macros\}

Макросы — это простой способ добавить динамический SQL в ваш запрос.
Прежде чем запрос будет отправлен на сервер ClickHouse, плагин развернёт макрос и подставит вместо него полное выражение.

Запросы и из SQL Editor, и из Query Builder могут использовать макросы.

### Использование макросов \{#using-macros\}

Макросы можно использовать в любом месте запроса, при необходимости — несколько раз.

Вот пример использования макроса `$__timeFilter`:

Входные данные:

```sql
SELECT log_time, log_message
FROM logs
WHERE $__timeFilter(log_time)
```

Итоговый результат запроса:

```sql
SELECT log_time, log_message
FROM logs
WHERE log_time >= toDateTime(1415792726) AND log_time <= toDateTime(1447328726)
```

В этом примере диапазон времени на панели Grafana применяется к столбцу `log_time`.

Плагин также поддерживает запись с использованием фигурных скобок `{}`. Используйте её, когда необходимо использовать запросы внутри [параметров](/sql-reference/syntax.md#defining-and-using-query-parameters).


### Список макросов \{#list-of-macros\}

Ниже приведён список всех макросов, доступных в плагине:

| Macro                                        | Description                                                                                                                                                                         | Output example                                                                                                    |
| -------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------- |
| `$__dateFilter(columnName)`                  | Заменяется на фильтр по диапазону времени для указанного столбца с использованием диапазона времени панели Grafana как [Date](/sql-reference/data-types/date.md).                 | `columnName >= toDate('2022-10-21') AND columnName <= toDate('2022-10-23')`                                       |
| `$__timeFilter(columnName)`                  | Заменяется на фильтр по диапазону времени для указанного столбца с использованием диапазона времени панели Grafana как [DateTime](/sql-reference/data-types/datetime.md).         | `columnName >= toDateTime(1415792726) AND time <= toDateTime(1447328726)`                                         |
| `$__timeFilter_ms(columnName)`               | Заменяется на фильтр по диапазону времени для указанного столбца с использованием диапазона времени панели Grafana как [DateTime64](/sql-reference/data-types/datetime64.md).     | `columnName >= fromUnixTimestamp64Milli(1415792726123) AND columnName <= fromUnixTimestamp64Milli(1447328726456)` |
| `$__dateTimeFilter(dateColumn, timeColumn)`  | Сокращение, которое объединяет `$__dateFilter()` и `$__timeFilter()` с использованием раздельных столбцов Date и DateTime. Псевдоним — `$__dt()`.                                | `$__dateFilter(dateColumn) AND $__timeFilter(timeColumn)`                                                         |
| `$__fromTime`                                | Заменяется на начальное время диапазона панели Grafana, приведённое к типу [DateTime](/sql-reference/data-types/datetime.md).                                                     | `toDateTime(1415792726)`                                                                                          |
| `$__fromTime_ms`                             | Заменяется на начальное время диапазона панели, приведённое к типу [DateTime64](/sql-reference/data-types/datetime64.md).                                                         | `fromUnixTimestamp64Milli(1415792726123)`                                                                         |
| `$__toTime`                                  | Заменяется на конечное время диапазона панели Grafana, приведённое к типу [DateTime](/sql-reference/data-types/datetime.md).                                                      | `toDateTime(1447328726)`                                                                                          |
| `$__toTime_ms`                               | Заменяется на конечное время диапазона панели, приведённое к типу [DateTime64](/sql-reference/data-types/datetime64.md).                                                          | `fromUnixTimestamp64Milli(1447328726456)`                                                                         |
| `$__timeInterval(columnName)`                | Заменяется на функцию, вычисляющую интервал на основе размера окна в секундах.                                                                                                     | `toStartOfInterval(toDateTime(columnName), INTERVAL 20 second)`                                                   |
| `$__timeInterval_ms(columnName)`             | Заменяется на функцию, вычисляющую интервал на основе размера окна в миллисекундах.                                                                                                | `toStartOfInterval(toDateTime64(columnName, 3), INTERVAL 20 millisecond)`                                         |
| `$__interval_s`                              | Заменяется на интервал дашборда в секундах.                                                                                                                                         | `20`                                                                                                              |
| `$__conditionalAll(condition, $templateVar)` | Заменяется на первый параметр, когда переменная шаблона во втором параметре не выбирает все значения. Заменяется на выражение `1=1`, когда переменная шаблона выбирает все значения. | `condition` или `1=1`                                                                                             |