---
sidebar_label: 'Справочник'
description: 'Описание поддерживаемых форматов, семантики exactly-once, поддержки представлений, масштабирования, ограничений и аутентификации ClickPipes при работе с объектным хранилищем'
slug: /integrations/clickpipes/object-storage/reference
sidebar_position: 1
title: 'Справочник'
doc_type: 'reference'
integration:
  - support_level: 'core'
  - category: 'clickpipes'
keywords: ['clickpipes', 'объектное хранилище', 's3', 'загрузка данных', 'пакетная загрузка']
---

import S3svg from '@site/static/images/integrations/logos/amazon_s3_logo.svg';
import Gcssvg from '@site/static/images/integrations/logos/gcs.svg';
import DOsvg from '@site/static/images/integrations/logos/digitalocean.svg';
import ABSsvg from '@site/static/images/integrations/logos/azureblobstorage.svg';
import Image from '@theme/IdealImage';


## Поддерживаемые источники данных {#supported-data-sources}

| Название             | Логотип                                                                                         | Тип            | Статус | Описание                                                                  |
| -------------------- | ----------------------------------------------------------------------------------------------- | -------------- | ------ | ------------------------------------------------------------------------- |
| Amazon S3            | <S3svg class="image" alt="Amazon S3 logo" style={{width: '3rem', height: 'auto'}}/>             | Объектное хранилище | Стабильный | Настройте ClickPipes для приёма больших объёмов данных из объектного хранилища. |
| Google Cloud Storage | <Gcssvg class="image" alt="Google Cloud Storage logo" style={{width: '3rem', height: 'auto'}}/> | Объектное хранилище | Стабильный | Настройте ClickPipes для приёма больших объёмов данных из объектного хранилища. |
| DigitalOcean Spaces  | <DOsvg class="image" alt="Digital Ocean logo" style={{width: '3rem', height: 'auto'}}/>         | Объектное хранилище | Стабильный | Настройте ClickPipes для приёма больших объёмов данных из объектного хранилища. |
| Azure Blob Storage   | <ABSsvg class="image" alt="Azure Blob Storage logo" style={{width: '3rem', height: 'auto'}}/>   | Объектное хранилище | Стабильный | Настройте ClickPipes для приёма больших объёмов данных из объектного хранилища. |

В ClickPipes будут добавлены дополнительные коннекторы. Подробнее можно узнать, [связавшись с нами](https://clickhouse.com/company/contact?loc=clickpipes).


## Поддерживаемые форматы данных {#supported-data-formats}

Поддерживаются следующие форматы:

- [JSON](/interfaces/formats/JSON)
- [CSV](/interfaces/formats/CSV)
- [Parquet](/interfaces/formats/Parquet)
- [Avro](/interfaces/formats/Avro)


## Семантика exactly-once {#exactly-once-semantics}

При загрузке больших наборов данных могут возникать различные типы сбоев, которые могут привести к частичным вставкам или дублированию данных. ClickPipes для объектного хранилища устойчивы к сбоям вставки и обеспечивают семантику exactly-once. Это достигается за счет использования временных промежуточных таблиц (staging tables). Данные сначала вставляются в промежуточные таблицы. Если при вставке что-то пойдет не так, промежуточная таблица может быть очищена, и вставку можно повторить с чистого состояния. Только после успешного завершения вставки партиции из промежуточной таблицы переносятся в целевую таблицу. Чтобы узнать больше об этой стратегии, ознакомьтесь с [этой статьей в блоге](https://clickhouse.com/blog/supercharge-your-clickhouse-data-loads-part3).

### Поддержка представлений {#view-support}

Материализованные представления для целевой таблицы также поддерживаются. ClickPipes создает промежуточные таблицы не только для целевой таблицы, но и для всех зависимых материализованных представлений.

Мы не создаем промежуточные таблицы для нематериализованных представлений. Это означает, что если у вас есть целевая таблица с одним или несколькими последующими материализованными представлениями, эти материализованные представления не должны выбирать данные через представление из целевой таблицы. В противном случае вы можете обнаружить, что в материализованном представлении отсутствуют данные.


## Масштабирование {#scaling}

Масштабирование ClickPipes для Object Storage основывается на минимальном размере сервиса ClickHouse, который определяется [настроенными параметрами вертикального автомасштабирования](/manage/scaling#configuring-vertical-auto-scaling). Размер ClickPipe определяется в момент создания конвейера. Последующие изменения настроек сервиса ClickHouse не влияют на размер ClickPipe.

Для повышения пропускной способности при загрузке больших объемов данных рекомендуется масштабировать сервис ClickHouse до создания ClickPipe.


## Ограничения {#limitations}

- Любые изменения в целевой таблице, её материализованных представлениях (включая каскадные материализованные представления) или целевых таблицах материализованного представления могут привести к временным ошибкам, которые будут повторяться. Для достижения наилучших результатов рекомендуется остановить pipe, внести необходимые изменения, а затем перезапустить pipe, чтобы изменения вступили в силу и избежать ошибок.
- Существуют ограничения на типы поддерживаемых представлений. Для получения дополнительной информации ознакомьтесь с разделами [семантика exactly-once](#exactly-once-semantics) и [поддержка представлений](#view-support).
- Аутентификация на основе ролей недоступна для S3 ClickPipes в экземплярах ClickHouse Cloud, развёрнутых в GCP или Azure. Она поддерживается только для экземпляров ClickHouse Cloud в AWS.
- ClickPipes будет пытаться загружать только объекты размером 10 ГБ или меньше. Если размер файла превышает 10 ГБ, ошибка будет добавлена в специальную таблицу ошибок ClickPipes.
- Pipes Azure Blob Storage с непрерывной загрузкой из контейнеров, содержащих более 100 тысяч файлов, будут иметь задержку около 10–15 секунд при обнаружении новых файлов. Задержка увеличивается с ростом количества файлов.
- Object Storage ClickPipes **не использует** тот же синтаксис перечисления, что и [табличная функция S3](/sql-reference/table-functions/s3) или [табличная функция AzureBlobStorage](/sql-reference/table-functions/azureBlobStorage) для Azure.
  - `?` — заменяет любой одиночный символ
  - `*` — заменяет любое количество любых символов, кроме `/`, включая пустую строку
  - `**` — заменяет любое количество любых символов, включая `/`, включая пустую строку

:::note
Это допустимый путь (для S3):

https://datasets-documentation.s3.eu-west-3.amazonaws.com/http/**.ndjson.gz

Это недопустимый путь. `{N..M}` не поддерживается в ClickPipes.

https://datasets-documentation.s3.eu-west-3.amazonaws.com/http/{documents-01,documents-02}.ndjson.gz
:::


## Непрерывная загрузка данных {#continuous-ingest}

ClickPipes поддерживает непрерывную загрузку данных из S3, GCS, Azure Blob Storage и DigitalOcean Spaces. При включении этой функции ClickPipes непрерывно загружает данные из указанного пути и проверяет наличие новых файлов каждые 30 секунд. Однако новые файлы должны быть лексикографически больше последнего загруженного файла. Это означает, что их имена должны определять порядок загрузки. Например, файлы с именами `file1`, `file2`, `file3` и т. д. будут загружаться последовательно. Если добавить новый файл с именем `file0`, ClickPipes не загрузит его, так как оно не является лексикографически большим по сравнению с последним загруженным файлом.


## Отслеживание загруженных файлов {#tracking-ingested-files}

Чтобы отслеживать, какие файлы были загружены, включите [виртуальный столбец](/sql-reference/table-functions/s3#virtual-columns) `_file` в сопоставление полей. Виртуальный столбец `_file` содержит имя файла исходного объекта, что упрощает выполнение запросов и определение того, какие файлы были обработаны.


## Аутентификация {#authentication}

### S3 {#s3}

Поддерживаются как общедоступные, так и защищённые корзины S3.

Общедоступные корзины должны разрешать действия `s3:GetObject` и `s3:ListBucket` в своей политике.

Доступ к защищённым корзинам можно получить с помощью [учётных данных IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html) или [роли IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html).
Чтобы использовать роль IAM, необходимо создать её согласно инструкциям [в этом руководстве](/cloud/data-sources/secure-s3). После создания скопируйте ARN новой роли IAM и вставьте его в конфигурацию ClickPipe в поле «IAM ARN role».

### GCS {#gcs}

Как и в случае с S3, доступ к общедоступным корзинам не требует настройки, а для защищённых корзин можно использовать [ключи HMAC](https://cloud.google.com/storage/docs/authentication/managing-hmackeys) вместо учётных данных AWS IAM. Ознакомьтесь с руководством Google Cloud о том, [как настроить такие ключи](https://cloud.google.com/storage/docs/authentication/hmackeys).

Сервисные учётные записи для GCS не поддерживаются напрямую. При аутентификации с непубличными корзинами необходимо использовать учётные данные HMAC (IAM).
Разрешения сервисной учётной записи, связанные с учётными данными HMAC, должны включать `storage.objects.list` и `storage.objects.get`.

### DigitalOcean Spaces {#dospaces}

В настоящее время для DigitalOcean Spaces поддерживаются только защищённые корзины. Для доступа к корзине и её файлам требуются «Access Key» и «Secret Key». Ознакомьтесь с [этим руководством](https://docs.digitalocean.com/products/spaces/how-to/manage-access/) о том, как создать ключи доступа.

### Azure Blob Storage {#azureblobstorage}

В настоящее время для Azure Blob Storage поддерживаются только защищённые корзины. Аутентификация выполняется с помощью строки подключения, которая поддерживает ключи доступа и общие ключи. Для получения дополнительной информации ознакомьтесь с [этим руководством](https://learn.microsoft.com/en-us/azure/storage/common/storage-configure-connection-string).
