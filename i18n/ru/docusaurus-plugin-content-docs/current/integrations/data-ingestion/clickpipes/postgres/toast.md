---
title: 'Обработка столбцов TOAST'
description: 'Узнайте, как обрабатывать столбцы TOAST при репликации данных из PostgreSQL в ClickHouse.'
slug: /integrations/clickpipes/postgres/toast
doc_type: 'guide'
keywords: ['clickpipes', 'postgresql', 'cdc', 'data ingestion', 'real-time sync']
---

При репликации данных из PostgreSQL в ClickHouse важно понимать ограничения и особенности работы со столбцами TOAST (The Oversized-Attribute Storage Technique). В этом руководстве вы узнаете, как определять и корректно обрабатывать столбцы TOAST в процессе репликации.



## Что такое TOAST-столбцы в PostgreSQL? {#what-are-toast-columns-in-postgresql}

TOAST (The Oversized-Attribute Storage Technique) — это механизм PostgreSQL для обработки больших значений полей. Когда строка превышает максимальный размер (обычно 2 КБ, но это может варьироваться в зависимости от версии PostgreSQL и конкретных настроек), PostgreSQL автоматически перемещает большие значения полей в отдельную таблицу TOAST, сохраняя в основной таблице только указатель.

Важно отметить, что при захвате изменений данных (CDC) неизменённые TOAST-столбцы не включаются в поток репликации. Это может привести к неполной репликации данных, если не обрабатывается должным образом.

При начальной загрузке (snapshot) все значения столбцов, включая TOAST-столбцы, реплицируются корректно независимо от их размера. Ограничения, описанные в данном руководстве, в первую очередь влияют на процесс CDC после начальной загрузки.

Подробнее о TOAST и его реализации в PostgreSQL можно прочитать здесь: https://www.postgresql.org/docs/current/storage-toast.html


## Определение TOAST-столбцов в таблице {#identifying-toast-columns-in-a-table}

Чтобы определить, содержит ли таблица TOAST-столбцы, можно использовать следующий SQL-запрос:

```sql
SELECT a.attname, pg_catalog.format_type(a.atttypid, a.atttypmod) AS data_type
FROM pg_attribute a
JOIN pg_class c ON a.attrelid = c.oid
WHERE c.relname = 'your_table_name'
  AND a.attlen = -1
  AND a.attstorage != 'p'
  AND a.attnum > 0;
```

Этот запрос вернёт имена и типы данных столбцов, которые потенциально могут быть подвергнуты TOAST-обработке. Однако важно отметить, что данный запрос определяет только столбцы, подходящие для TOAST-хранения на основе их типа данных и атрибутов хранения. Чтобы определить, действительно ли эти столбцы содержат данные в формате TOAST, необходимо проверить, превышают ли значения в этих столбцах пороговый размер. Фактическая TOAST-обработка данных зависит от конкретного содержимого, хранящегося в этих столбцах.


## Обеспечение корректной обработки TOAST-столбцов {#ensuring-proper-handling-of-toast-columns}

Чтобы обеспечить корректную обработку TOAST-столбцов при репликации, необходимо установить для таблицы параметр `REPLICA IDENTITY` в значение `FULL`. Это указывает PostgreSQL включать в WAL полную старую версию строки для операций UPDATE и DELETE, обеспечивая доступность всех значений столбцов (включая TOAST-столбцы) для репликации.

Установить `REPLICA IDENTITY` в значение `FULL` можно с помощью следующей SQL-команды:

```sql
ALTER TABLE your_table_name REPLICA IDENTITY FULL;
```

Рекомендации по производительности при установке `REPLICA IDENTITY FULL` см. в [этой статье](https://xata.io/blog/replica-identity-full-performance).


## Поведение репликации при отсутствии REPLICA IDENTITY FULL {#replication-behavior-when-replica-identity-full-is-not-set}

Если для таблицы со столбцами TOAST не установлен параметр `REPLICA IDENTITY FULL`, при репликации в ClickHouse могут возникнуть следующие проблемы:

1. Для операций INSERT все столбцы (включая столбцы TOAST) будут реплицированы корректно.

2. Для операций UPDATE:
   - Если столбец TOAST не изменяется, его значение будет отображаться как NULL или пустое в ClickHouse.
   - Если столбец TOAST изменяется, он будет реплицирован корректно.

3. Для операций DELETE значения столбцов TOAST будут отображаться как NULL или пустые в ClickHouse.

Такое поведение может привести к несогласованности данных между источником PostgreSQL и целевой системой ClickHouse. Поэтому крайне важно установить `REPLICA IDENTITY FULL` для таблиц со столбцами TOAST, чтобы обеспечить точную и полную репликацию данных.


## Заключение {#conclusion}

Правильная обработка TOAST-столбцов необходима для обеспечения целостности данных при репликации из PostgreSQL в ClickHouse. Определив TOAST-столбцы и настроив соответствующий параметр `REPLICA IDENTITY`, вы сможете обеспечить точную и полную репликацию данных.
