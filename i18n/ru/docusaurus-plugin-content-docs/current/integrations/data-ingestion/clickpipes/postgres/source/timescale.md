---
sidebar_label: 'Timescale'
description: 'Настройка Postgres с расширением TimescaleDB в качестве источника данных для ClickPipes'
slug: /integrations/clickpipes/postgres/source/timescale
title: 'Руководство по настройке источника данных Postgres с TimescaleDB'
keywords: ['TimescaleDB']
doc_type: 'guide'
---

import BetaBadge from '@theme/badges/BetaBadge';


# Руководство по настройке источника данных Postgres с TimescaleDB

<BetaBadge/>



## Общие сведения {#background}

[TimescaleDB](https://github.com/timescale/timescaledb) — это расширение Postgres с открытым исходным кодом, разработанное компанией Timescale Inc,
которое призвано повысить производительность аналитических запросов без необходимости отказываться от Postgres.
Это достигается путём
создания «гипертаблиц» (hypertables), которые управляются расширением и поддерживают автоматическое разбиение на «фрагменты» (chunks).
Гипертаблицы также поддерживают прозрачное сжатие и гибридное строчно-колоночное хранилище (известное как «hypercore»), однако эти
функции требуют версии расширения с проприетарной лицензией.

Компания Timescale Inc также предлагает два управляемых сервиса для TimescaleDB:

- `Managed Service for Timescale`
- `Timescale Cloud`.

Существуют сторонние поставщики, предлагающие управляемые сервисы, которые позволяют использовать расширение TimescaleDB, но из-за
лицензионных ограничений эти поставщики поддерживают только версию расширения с открытым исходным кодом.

Гипертаблицы Timescale ведут себя иначе, чем обычные таблицы Postgres, в нескольких аспектах.
Это создаёт определённые сложности
в процессе их репликации, поэтому возможность репликации гипертаблиц Timescale следует рассматривать как
**наилучшую из возможных** (best effort).


## Поддерживаемые версии Postgres {#supported-postgres-versions}

ClickPipes поддерживает Postgres версии 12 и новее.


## Включение логической репликации {#enable-logical-replication}

Необходимые шаги зависят от способа развертывания вашего экземпляра Postgres с TimescaleDB.

- Если вы используете управляемый сервис и ваш провайдер указан в боковой панели, следуйте руководству для этого провайдера.
- Если вы развертываете TimescaleDB самостоятельно, следуйте общему руководству.

Для других управляемых сервисов создайте запрос в службу поддержки вашего провайдера для получения помощи по включению логической репликации, если она еще не включена.

:::info
Timescale Cloud не поддерживает включение логической репликации, которая необходима для Postgres pipes в режиме CDC.
В результате пользователи Timescale Cloud могут выполнить только однократную загрузку данных (`Initial Load Only`) с помощью Postgres ClickPipe.
:::


## Настройка {#configuration}

Гипертаблицы Timescale не хранят вставляемые в них данные. Вместо этого данные хранятся в нескольких соответствующих
таблицах-«чанках», которые находятся в схеме `_timescaledb_internal`. Для выполнения запросов к гипертаблицам это не
является проблемой. Однако при логической репликации изменения обнаруживаются не в гипертаблице, а в таблице-чанке.
Postgres ClickPipe содержит логику для автоматического переназначения изменений из таблиц-чанков в родительскую гипертаблицу,
но для этого требуются дополнительные шаги.

:::info
Если вы хотите выполнить только однократную загрузку данных (`Initial Load Only`), пропустите шаги начиная со второго.
:::

1. Создайте пользователя Postgres для пайпа и предоставьте ему права на `SELECT` для таблиц, которые вы хотите реплицировать.

```sql
  CREATE USER clickpipes_user PASSWORD 'clickpipes_password';
  GRANT USAGE ON SCHEMA "public" TO clickpipes_user;
  -- При необходимости вы можете ограничить эти GRANT только отдельными таблицами, а не всей схемой
  -- Но при добавлении новых таблиц в ClickPipe вам также потребуется добавить их пользователю.
  GRANT SELECT ON ALL TABLES IN SCHEMA "public" TO clickpipes_user;
  ALTER DEFAULT PRIVILEGES IN SCHEMA "public" GRANT SELECT ON TABLES TO clickpipes_user;
```

:::note
Обязательно замените `clickpipes_user` и `clickpipes_password` на желаемые имя пользователя и пароль.
:::

2. От имени суперпользователя/администратора Postgres создайте публикацию на исходном экземпляре, которая содержит таблицы и гипертаблицы,
   которые вы хотите реплицировать, и **также включает всю схему `_timescaledb_internal`**. При создании ClickPipe необходимо выбрать эту публикацию.

```sql
-- При добавлении новых таблиц в ClickPipe вам также потребуется вручную добавить их в публикацию.
  CREATE PUBLICATION clickpipes_publication FOR TABLE <...>, <...>, TABLES IN SCHEMA _timescaledb_internal;
```

:::tip
Мы не рекомендуем создавать публикацию `FOR ALL TABLES`, так как это приводит к увеличению трафика от Postgres к ClickPipes (отправке изменений для других таблиц, не входящих в пайп) и снижает общую эффективность.

Для публикаций, созданных вручную, добавьте все необходимые таблицы в публикацию перед добавлением их в пайп.
:::

:::info
Некоторые управляемые сервисы не предоставляют своим администраторам необходимые права для создания публикации для всей схемы.
Если это ваш случай, обратитесь в службу поддержки вашего провайдера. В качестве альтернативы вы можете пропустить этот и следующие
шаги и выполнить однократную загрузку данных.
:::

3. Предоставьте права на репликацию созданному ранее пользователю.

```sql
-- Предоставить права на репликацию пользователю
  ALTER USER clickpipes_user REPLICATION;
```

После выполнения этих шагов вы сможете приступить к [созданию ClickPipe](../index.md).


## Настройка сетевого доступа {#configure-network-access}

Если вы хотите ограничить трафик к вашему экземпляру Timescale, внесите в белый список [документированные статические NAT IP-адреса](../../index.md#list-of-static-ips).
Инструкции по выполнению этой операции различаются в зависимости от провайдера. Обратитесь к боковой панели, если ваш провайдер указан в списке, или обратитесь в его службу поддержки.
