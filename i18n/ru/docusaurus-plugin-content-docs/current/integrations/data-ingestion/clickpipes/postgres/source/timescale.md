---
sidebar_label: 'Timescale'
description: 'Настройка Postgres с расширением TimescaleDB в качестве источника для ClickPipes'
slug: /integrations/clickpipes/postgres/source/timescale
title: 'Руководство по настройке Postgres с TimescaleDB в качестве источника'
keywords: ['TimescaleDB']
doc_type: 'guide'
integration:
  - support_level: 'core'
  - category: 'clickpipes'
---

import BetaBadge from '@theme/badges/BetaBadge';

# Руководство по настройке источника данных Postgres с TimescaleDB {#postgres-with-timescaledb-source-setup-guide}

<BetaBadge/>

## Предпосылки {#background}

[TimescaleDB](https://github.com/timescale/timescaledb) — это расширение Postgres с открытым исходным кодом, разработанное компанией Timescale Inc,
которое нацелено на повышение производительности аналитических запросов без необходимости перехода с Postgres. 
Этого удаётся добиться за счёт создания «гипертаблиц» (hypertables), которые управляются расширением и поддерживают 
автоматическое разбиение на фрагменты («чанки», chunks). Гипертаблицы также поддерживают прозрачное сжатие и гибридное строчно-колоночное 
хранение (известное как «hypercore»), хотя для этих возможностей требуется версия расширения с проприетарной лицензией.

Компания Timescale Inc также предлагает два управляемых сервиса для TimescaleDB: 
- `Managed Service for Timescale`
- `Timescale Cloud`. 

Существуют сторонние поставщики управляемых сервисов, позволяющих использовать расширение TimescaleDB, но из-за условий 
лицензирования такие поставщики поддерживают только версию расширения с открытым исходным кодом.

Гипертаблицы Timescale в ряде аспектов ведут себя иначе, чем обычные таблицы Postgres. Это создаёт определённые сложности 
при их репликации, поэтому возможность репликации гипертаблиц Timescale следует рассматривать как 
**выполняемую по принципу «best effort»**.

## Поддерживаемые версии Postgres {#supported-postgres-versions}

ClickPipes поддерживает Postgres версии 12 и выше.

## Включение логической репликации {#enable-logical-replication}

Необходимые шаги зависят от того, как развернут ваш экземпляр Postgres с TimescaleDB. 

- Если вы используете управляемый сервис и ваш провайдер указан в боковой панели, следуйте руководству для этого провайдера.
- Если вы разворачиваете TimescaleDB самостоятельно, следуйте общему руководству. 

Для других управляемых сервисов создайте запрос в службу поддержки вашего провайдера, чтобы они помогли включить логическую репликацию, если
она еще не включена.

:::info
Timescale Cloud не поддерживает включение логической репликации, которая необходима для конвейеров Postgres (Postgres pipes) в режиме CDC.
Таким образом, пользователи Timescale Cloud могут выполнить только однократную загрузку своих данных (`Initial Load Only`) с помощью
Postgres ClickPipe.
:::

## Конфигурация {#configuration}

Hypertable в Timescale не хранят данные, вставляемые непосредственно в них. Вместо этого данные сохраняются в нескольких соответствующих таблицах‑фрагментах («chunk»), которые находятся в схеме `_timescaledb_internal`. Для выполнения запросов к hypertable это не является проблемой. Но при логической репликации, вместо того чтобы отслеживать изменения в hypertable, мы отслеживаем их в таблице chunk. Postgres ClickPipe содержит логику автоматического сопоставления изменений из таблиц chunk с родительской hypertable, но для этого требуются дополнительные шаги.

:::info
Если вы хотите выполнить только однократную загрузку ваших данных (`Initial Load Only`), пропустите шаги, начиная со второго.
:::

1. Создайте отдельного пользователя для ClickPipes:

   ```sql
   CREATE USER clickpipes_user PASSWORD 'some-password';
   ```

2. Предоставьте на уровне схемы доступ только для чтения пользователю, созданному на предыдущем шаге. В следующем примере показаны права для схемы `public`. Повторите эти команды для каждой схемы, содержащей таблицы, которые вы хотите реплицировать:

   ```sql
   GRANT USAGE ON SCHEMA "public" TO clickpipes_user;
   GRANT SELECT ON ALL TABLES IN SCHEMA "public" TO clickpipes_user;
   ALTER DEFAULT PRIVILEGES IN SCHEMA "public" GRANT SELECT ON TABLES TO clickpipes_user;
   ```

3. Предоставьте пользователю права на репликацию:

   ```sql
   GRANT rds_replication TO clickpipes_user;
   ```

4. Создайте [публикацию](https://www.postgresql.org/docs/current/logical-replication-publication.html) с таблицами, которые вы хотите реплицировать. Мы настоятельно рекомендуем включать в публикацию только необходимые таблицы, чтобы избежать лишних накладных расходов на производительность.

   :::warning
   Для любой таблицы, включённой в публикацию, должен быть определён **первичный ключ** *или* настроена **replica identity** со значением `FULL`. См. раздел [Postgres FAQs](../faq.md#how-should-i-scope-my-publications-when-setting-up-replication) для рекомендаций по определению области публикаций.
   :::

   * Чтобы создать публикацию для конкретных таблиц:

     ```sql
     CREATE PUBLICATION clickpipes FOR TABLE table_to_replicate, table_to_replicate2;
     ```

   * Чтобы создать публикацию для всех таблиц в конкретной схеме:

     ```sql
     CREATE PUBLICATION clickpipes FOR TABLES IN SCHEMA "public";
     ```

   Публикация `clickpipes` будет содержать набор событий изменений, сгенерированных из указанных таблиц, и позже будет использована для приёма потока репликации.

5. Предоставьте пользователю, созданному ранее, права на репликацию.

```sql
-- Give replication permission to the USER
  ALTER USER clickpipes_user REPLICATION;
```

После выполнения этих шагов вы сможете перейти к [созданию ClickPipe](../index.md).


## Настройте сетевой доступ {#configure-network-access}

Если вы хотите ограничить трафик к своему экземпляру Timescale, добавьте в список разрешённых адресов [задокументированные статические NAT IP-адреса](../../index.md#list-of-static-ips).
Инструкции по настройке зависят от провайдера: если ваш провайдер указан в боковой панели, воспользуйтесь соответствующим разделом, в противном случае обратитесь в его службу поддержки.