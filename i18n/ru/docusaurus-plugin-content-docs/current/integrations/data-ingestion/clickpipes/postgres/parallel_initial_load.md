---
title: 'Параллельный снимок в Postgres ClickPipe'
description: 'Документация, описывающая параллельный снимок в Postgres ClickPipe'
slug: /integrations/clickpipes/postgres/parallel_initial_load
sidebar_label: 'Как работает параллельный снимок'
doc_type: 'guide'
keywords: ['clickpipes', 'postgresql', 'cdc', 'data ingestion', 'real-time sync']
---

import snapshot_params from '@site/static/images/integrations/data-ingestion/clickpipes/postgres/snapshot_params.png'
import Image from '@theme/IdealImage';

В этом документе объясняется, как работает параллельная загрузка снимка/начальная загрузка в Postgres ClickPipe, а также описываются параметры снимка, которые можно использовать для её настройки.


## Обзор {#overview-pg-snapshot}

Начальная загрузка — это первая фаза CDC ClickPipe, во время которой ClickPipe синхронизирует исторические данные таблиц из исходной базы данных в ClickHouse перед запуском CDC. Часто разработчики выполняют это в однопоточном режиме — например, используя pg_dump или pg_restore, или применяя один поток для чтения из исходной базы данных и записи в ClickHouse.
Однако Postgres ClickPipe может распараллелить этот процесс, что значительно ускоряет начальную загрузку.

### Столбец CTID в Postgres {#ctid-pg-snapshot}

В Postgres каждая строка таблицы имеет уникальный идентификатор, называемый CTID. Это системный столбец, который по умолчанию не виден пользователям, но может использоваться для уникальной идентификации строк в таблице. CTID представляет собой комбинацию номера блока и смещения внутри блока, что обеспечивает эффективный доступ к строкам.

### Логическое разбиение на разделы {#logical-partitioning-pg-snapshot}

Postgres ClickPipe использует столбец CTID для логического разбиения исходных таблиц на разделы. Он получает разделы, сначала выполняя COUNT(\*) на исходной таблице, а затем запрос с оконной функцией для получения диапазонов CTID для каждого раздела. Это позволяет ClickPipe читать исходную таблицу параллельно, при этом каждый раздел обрабатывается отдельным потоком.

Рассмотрим следующие настройки:

<Image img={snapshot_params} alt='Параметры снимка' size='md' />

#### Количество строк на раздел снимка {#numrows-pg-snapshot}

Эта настройка определяет, сколько строк составляют один раздел. ClickPipe будет читать исходную таблицу фрагментами такого размера, и фрагменты обрабатываются параллельно в соответствии с заданным уровнем параллелизма начальной загрузки. Значение по умолчанию — 100 000 строк на раздел.

#### Параллелизм начальной загрузки {#parallelism-pg-snapshot}

Эта настройка определяет, сколько разделов обрабатывается параллельно. Значение по умолчанию — 4, что означает, что ClickPipe будет читать 4 раздела исходной таблицы параллельно. Это значение можно увеличить для ускорения начальной загрузки, но рекомендуется устанавливать разумное значение в зависимости от характеристик вашего исходного экземпляра, чтобы избежать перегрузки исходной базы данных. ClickPipe автоматически настроит количество разделов на основе размера исходной таблицы и количества строк на раздел.

#### Количество таблиц снимка, обрабатываемых параллельно {#tables-parallel-pg-snapshot}

Эта настройка не связана напрямую с параллельным снимком, но определяет, сколько таблиц обрабатывается параллельно во время начальной загрузки. Значение по умолчанию — 1. Обратите внимание, что это дополнительно к параллелизму разделов, поэтому если у вас 4 раздела и 2 таблицы, ClickPipe будет читать 8 разделов параллельно.

### Мониторинг параллельного снимка в Postgres {#monitoring-parallel-pg-snapshot}

Вы можете проанализировать **pg_stat_activity**, чтобы увидеть параллельный снимок в действии. ClickPipe создаст несколько подключений к исходной базе данных, каждое из которых читает разный раздел исходной таблицы. Если вы видите запросы **FETCH** с разными диапазонами CTID, это означает, что ClickPipe читает исходные таблицы. Здесь также можно увидеть запросы COUNT(\*) и запрос разбиения на разделы.

### Ограничения {#limitations-parallel-pg-snapshot}

- Параметры снимка нельзя изменить после создания канала. Если вы хотите их изменить, вам придется создать новый ClickPipe.
- При добавлении таблиц в существующий ClickPipe вы не можете изменить параметры снимка. ClickPipe будет использовать существующие параметры для новых таблиц.
- Столбец ключа раздела не должен содержать значения `NULL`, так как они пропускаются логикой разбиения на разделы.
