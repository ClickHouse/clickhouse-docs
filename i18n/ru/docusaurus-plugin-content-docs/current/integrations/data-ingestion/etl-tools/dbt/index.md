---
sidebar_label: 'Обзор'
slug: /integrations/dbt
sidebar_position: 1
description: 'Пользователи могут выполнять преобразование и моделирование своих данных в ClickHouse с помощью dbt'
title: 'Интеграция dbt и ClickHouse'
keywords: ['dbt', 'data transformation', 'analytics engineering', 'SQL modeling', 'ELT pipeline']
doc_type: 'guide'
integration:
  - support_level: 'core'
  - category: 'data_integration'
  - website: 'https://github.com/ClickHouse/dbt-clickhouse'
---

import TOCInline from '@theme/TOCInline';
import ClickHouseSupportedBadge from '@theme/badges/ClickHouseSupported';


# Интеграция dbt и ClickHouse {#integrate-dbt-clickhouse}

<ClickHouseSupportedBadge />


## Адаптер dbt-clickhouse {#dbt-clickhouse-adapter}

**dbt** (data build tool) позволяет инженерам-аналитикам преобразовывать данные в хранилищах, просто создавая SELECT-запросы. dbt материализует эти SELECT-запросы в объекты базы данных в виде таблиц и представлений, выполняя этап T (Transform) в процессе [Extract Load and Transform (ELT)](https://en.wikipedia.org/wiki/Extract,_load,_transform). Пользователи могут создавать модели, определяемые SELECT-запросом.

В dbt эти модели могут ссылаться друг на друга и выстраиваться в слои, что позволяет создавать концепции более высокого уровня. Шаблонный SQL-код, необходимый для связывания моделей, генерируется автоматически. Кроме того, dbt определяет зависимости между моделями и обеспечивает их создание в правильном порядке с использованием направленного ациклического графа (DAG).

dbt совместим с ClickHouse через [адаптер, поддерживаемый ClickHouse](https://github.com/ClickHouse/dbt-clickhouse).

<TOCInline toc={toc} maxHeadingLevel={2} />


## Поддерживаемые возможности {#supported-features}

Список поддерживаемых возможностей:

- [x] Материализация таблиц
- [x] Материализация представлений
- [x] Инкрементальная материализация
- [x] Инкрементальная материализация микропакетами
- [x] Материализация материализованных представлений (использует форму `TO` для MATERIALIZED VIEW, экспериментальная возможность)
- [x] Seeds (начальные данные)
- [x] Sources (источники)
- [x] Генерация документации
- [x] Тесты
- [x] Снимки
- [x] Большинство макросов dbt-utils (теперь включены в dbt-core)
- [x] Эфемерная материализация
- [x] Материализация распределённых таблиц (экспериментальная возможность)
- [x] Распределённая инкрементальная материализация (экспериментальная возможность)
- [x] Контракты
- [x] Специфичные для ClickHouse настройки столбцов (Codec, TTL...)
- [x] Специфичные для ClickHouse настройки таблиц (индексы, проекции...)

Поддерживаются все возможности до dbt-core 1.9 включительно. В ближайшее время мы добавим возможности, появившиеся в dbt-core 1.10.

Этот адаптер пока недоступен для использования в [dbt Cloud](https://docs.getdbt.com/docs/dbt-cloud/cloud-overview), но мы планируем сделать его доступным в ближайшее время. Обратитесь в службу поддержки для получения дополнительной информации.


## Концепции {#concepts}

dbt вводит концепцию модели. Модель определяется как SQL-выражение, потенциально объединяющее множество таблиц. Модель может быть «материализована» несколькими способами. Материализация представляет собой стратегию построения для SELECT-запроса модели. Код материализации — это шаблонный SQL-код, который оборачивает ваш SELECT-запрос в выражение для создания новой или обновления существующей связи.

dbt предоставляет 4 типа материализации:

- **view** (по умолчанию): модель создается как представление в базе данных.
- **table**: модель создается как таблица в базе данных.
- **ephemeral**: модель не создается непосредственно в базе данных, а вместо этого включается в зависимые модели как общее табличное выражение (CTE).
- **incremental**: модель изначально материализуется как таблица, а при последующих запусках dbt вставляет новые строки и обновляет измененные строки в таблице.

Дополнительный синтаксис и конструкции определяют, как эти модели должны обновляться при изменении базовых данных. dbt обычно рекомендует начинать с материализации view до тех пор, пока производительность не станет проблемой. Материализация table обеспечивает улучшение производительности запросов за счет сохранения результатов запроса модели в виде таблицы ценой увеличения объема хранилища. Инкрементальный подход развивает это дальше, позволяя фиксировать последующие обновления базовых данных в целевой таблице.

[Текущий адаптер](https://github.com/silentsokolov/dbt-clickhouse) для ClickHouse также поддерживает материализации **materialized view**, **dictionary**, **distributed table** и **distributed incremental**. Адаптер также поддерживает [snapshots](https://docs.getdbt.com/docs/building-a-dbt-project/snapshots#check-strategy) и [seeds](https://docs.getdbt.com/docs/building-a-dbt-project/seeds) dbt.

### Подробности о поддерживаемых материализациях {#details-about-supported-materializations}

| Тип                         | Поддержка  | Подробности                                                                                                                      |
| --------------------------- | ---------- | -------------------------------------------------------------------------------------------------------------------------------- |
| view materialization        | Да         | Создает [представление](https://clickhouse.com/docs/en/sql-reference/table-functions/view/).                                     |
| table materialization       | Да         | Создает [таблицу](https://clickhouse.com/docs/en/operations/system-tables/tables/). См. ниже список поддерживаемых движков.     |
| incremental materialization | Да         | Создает таблицу, если она не существует, а затем записывает в нее только обновления.                                             |
| ephemeral materialized      | Да         | Создает эфемерную материализацию/CTE. Эта модель является внутренней для dbt и не создает никаких объектов базы данных.          |

Следующие являются [экспериментальными функциями](https://clickhouse.com/docs/en/beta-and-experimental-features) в ClickHouse:

| Тип                                     | Поддержка         | Подробности                                                                                                                                                                                                                                     |
| --------------------------------------- | ----------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Materialized View materialization       | Да, экспериментальная | Создает [материализованное представление](https://clickhouse.com/docs/en/materialized-view).                                                                                                                                                    |
| Distributed table materialization       | Да, экспериментальная | Создает [распределенную таблицу](https://clickhouse.com/docs/en/engines/table-engines/special/distributed).                                                                                                                                     |
| Distributed incremental materialization | Да, экспериментальная | Инкрементальная модель, основанная на той же идее, что и распределенная таблица. Обратите внимание, что поддерживаются не все стратегии, посетите [эту страницу](https://github.com/ClickHouse/dbt-clickhouse?tab=readme-ov-file#distributed-incremental-materialization) для получения дополнительной информации. |
| Dictionary materialization              | Да, экспериментальная | Создает [словарь](https://clickhouse.com/docs/en/engines/table-engines/special/dictionary).                                                                                                                                                     |


## Настройка dbt и адаптера ClickHouse {#setup-of-dbt-and-the-clickhouse-adapter}

### Установка dbt-core и dbt-clickhouse {#install-dbt-core-and-dbt-clickhouse}

dbt предоставляет несколько вариантов установки интерфейса командной строки (CLI), которые подробно описаны [здесь](https://docs.getdbt.com/dbt-cli/install/overview). Рекомендуется использовать `pip` для установки как dbt, так и dbt-clickhouse.

```sh
pip install dbt-core dbt-clickhouse
```

### Предоставление dbt параметров подключения к экземпляру ClickHouse {#provide-dbt-with-the-connection-details-for-our-clickhouse-instance}

Настройте профиль `clickhouse-service` в файле `~/.dbt/profiles.yml` и укажите свойства schema, host, port, user и password. Полный список параметров конфигурации подключения доступен на странице [Возможности и конфигурации](/integrations/dbt/features-and-configurations):

```yaml
clickhouse-service:
  target: dev
  outputs:
    dev:
      type: clickhouse
      schema: [default] # База данных ClickHouse для моделей dbt

      # Необязательные параметры
      host: [localhost]
      port: [8123] # По умолчанию 8123, 8443, 9000, 9440 в зависимости от настроек secure и driver
      user: [default] # Пользователь для всех операций с базой данных
      password: [<empty string>] # Пароль пользователя
      secure: True # Использовать TLS (нативный протокол) или HTTPS (протокол http)
```

### Создание проекта dbt {#create-a-dbt-project}

Теперь вы можете использовать этот профиль в одном из существующих проектов или создать новый с помощью команды:

```sh
dbt init project_name
```

В директории `project_name` обновите файл `dbt_project.yml`, указав имя профиля для подключения к серверу ClickHouse.

```yaml
profile: "clickhouse-service"
```

### Проверка подключения {#test-connection}

Выполните команду `dbt debug` с помощью инструмента CLI, чтобы убедиться, что dbt может подключиться к ClickHouse. Убедитесь, что ответ содержит `Connection test: [OK connection ok]`, что указывает на успешное подключение.

Перейдите на [страницу руководств](/integrations/dbt/guides), чтобы узнать больше о том, как использовать dbt с ClickHouse.

### Тестирование и развертывание моделей (CI/CD) {#testing-and-deploying-your-models-ci-cd}

Существует множество способов тестирования и развертывания проекта dbt. dbt предлагает рекомендации по [рабочим процессам на основе лучших практик](https://docs.getdbt.com/best-practices/best-practice-workflows#pro-tips-for-workflows) и [заданиям CI](https://docs.getdbt.com/docs/deploy/ci-jobs). Мы рассмотрим несколько стратегий, но имейте в виду, что эти стратегии могут потребовать значительной адаптации под ваш конкретный сценарий использования.

#### CI/CD с простыми тестами данных и модульными тестами {#ci-with-simple-data-tests-and-unit-tests}

Один из простых способов запустить конвейер CI — развернуть кластер ClickHouse внутри задания и затем выполнить модели на нём. Вы можете загрузить демонстрационные данные в этот кластер перед запуском моделей. Можно просто использовать [seed](https://docs.getdbt.com/reference/commands/seed) для заполнения промежуточной среды подмножеством продуктивных данных.

После загрузки данных вы можете запустить [тесты данных](https://docs.getdbt.com/docs/build/data-tests) и [модульные тесты](https://docs.getdbt.com/docs/build/unit-tests).

Этап CD может быть таким же простым, как выполнение команды `dbt build` на продуктивном кластере ClickHouse.

#### Более полный этап CI/CD: использование актуальных данных, тестирование только затронутых моделей {#more-complete-ci-stage}

Одна из распространённых стратегий — использование заданий [Slim CI](https://docs.getdbt.com/best-practices/best-practice-workflows#run-only-modified-models-to-test-changes-slim-ci), при которых повторно развертываются только изменённые модели (и их восходящие и нисходящие зависимости). Этот подход использует артефакты продуктивных запусков (т. е. [манифест dbt](https://docs.getdbt.com/reference/artifacts/manifest-json)) для сокращения времени выполнения проекта и обеспечения отсутствия расхождений схемы между средами.

Чтобы поддерживать синхронизацию сред разработки и избежать выполнения моделей на устаревших развертываниях, вы можете использовать [clone](https://docs.getdbt.com/reference/commands/clone) или даже [defer](https://docs.getdbt.com/reference/node-selection/defer).


Мы рекомендуем использовать выделенный кластер или сервис ClickHouse для тестового окружения (то есть staging-окружения), чтобы избежать влияния на работу продуктивного окружения. Чтобы тестовое окружение было репрезентативным, важно использовать подмножество продуктивных данных, а также запускать dbt так, чтобы предотвратить рассинхронизацию схем между окружениями.

- Если вам не нужны свежие данные для тестирования, вы можете восстановить резервную копию продуктивных данных в staging-окружении.
- Если вам нужны свежие данные для тестирования, вы можете использовать комбинацию [`remoteSecure()` table function](/sql-reference/table-functions/remote) и обновляемых материализованных представлений для вставки данных с нужной частотой. Другой вариант — использовать объектное хранилище как промежуточный слой и периодически выгружать данные из продуктивного сервиса, а затем импортировать их в staging-окружение с помощью table functions для объектного хранилища или ClickPipes (для непрерывной загрузки).

Использование отдельного окружения для CI-тестирования также позволяет выполнять ручное тестирование без влияния на продуктивное окружение. Например, вы можете направить BI-инструмент на это окружение для тестирования.

Для деплоя (то есть шага CD) мы рекомендуем использовать артефакты из продуктивных деплоев, чтобы обновлять только те модели, которые изменились. Для этого требуется настроить объектное хранилище (например, S3) как промежуточное хранилище для артефактов dbt. После настройки вы можете запустить команду `dbt build --select state:modified+ --state path/to/last/deploy/state.json`, чтобы выборочно пересобрать минимальное количество моделей, необходимых с учётом изменений по сравнению с последним запуском в продуктивной среде.



## Устранение распространённых проблем {#troubleshooting-common-issues}

### Подключения {#troubleshooting-connections}

Если у вас возникают проблемы с подключением к ClickHouse из dbt, убедитесь, что выполнены следующие условия:

- Движок должен быть одним из [поддерживаемых движков](/integrations/dbt/features-and-configurations#supported-table-engines).
- У вас должны быть достаточные права доступа к базе данных.
- Если вы не используете движок таблиц по умолчанию для базы данных, необходимо указать движок таблицы в конфигурации вашей модели.

### Анализ длительных операций {#understanding-long-running-operations}

Некоторые операции могут выполняться дольше ожидаемого из-за специфики запросов ClickHouse. Чтобы получить больше информации о том, какие запросы выполняются дольше, увеличьте [уровень логирования](https://docs.getdbt.com/reference/global-configs/logs#log-level) до `debug` — это выведет время, затраченное на каждый запрос. Например, этого можно достичь, добавив `--log-level debug` к командам dbt.


## Ограничения {#limitations}

Текущий адаптер ClickHouse для dbt имеет ряд ограничений, о которых следует знать пользователям:

- Плагин использует синтаксис, требующий ClickHouse версии 25.3 или новее. Мы не тестируем более старые версии ClickHouse. Также в настоящее время мы не тестируем реплицируемые таблицы (Replicated tables).
- Различные запуски `dbt-adapter` могут конфликтовать при одновременном выполнении, поскольку внутренне они могут использовать одинаковые имена таблиц для одних и тех же операций. Подробнее см. issue [#420](https://github.com/ClickHouse/dbt-clickhouse/issues/420).
- В настоящее время адаптер материализует модели как таблицы с помощью [INSERT INTO SELECT](https://clickhouse.com/docs/sql-reference/statements/insert-into#inserting-the-results-of-select). Это фактически означает дублирование данных при повторном выполнении. Очень большие наборы данных (петабайты) могут приводить к чрезвычайно длительному времени выполнения, делая некоторые модели непрактичными. Для повышения производительности используйте материализованные представления ClickHouse, реализуя представление как `materialized: materialization_view`. Кроме того, стремитесь минимизировать количество строк, возвращаемых запросом, используя `GROUP BY` там, где это возможно. Предпочитайте модели, которые агрегируют данные, моделям, которые просто преобразуют их, сохраняя количество строк источника.
- Чтобы использовать распределенные таблицы (Distributed tables) для представления модели, пользователи должны вручную создать базовые реплицируемые таблицы на каждом узле. Распределенная таблица, в свою очередь, может быть создана поверх них. Адаптер не управляет созданием кластера.
- Когда dbt создает отношение (таблицу/представление) в базе данных, обычно оно создается как: `{{ database }}.{{ schema }}.{{ table/view id }}`. В ClickHouse отсутствует понятие схем. Поэтому адаптер использует `{{schema}}.{{ table/view id }}`, где `schema` — это база данных ClickHouse.
- Эфемерные модели/CTE не работают, если размещены перед `INSERT INTO` в операторе вставки ClickHouse, см. https://github.com/ClickHouse/ClickHouse/issues/30323. Это не должно влиять на большинство моделей, но следует соблюдать осторожность при размещении эфемерной модели в определениях моделей и других SQL-операторах. <!-- TODO review this limitation, looks like the issue was already closed and the fix was introduced in 24.10 -->


## Fivetran {#fivetran}

Коннектор `dbt-clickhouse` также доступен для использования в [преобразованиях Fivetran](https://fivetran.com/docs/transformations/dbt), что обеспечивает бесшовную интеграцию и возможности трансформации данных непосредственно на платформе Fivetran с помощью `dbt`.
