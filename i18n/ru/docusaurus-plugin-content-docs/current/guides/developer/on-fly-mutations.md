---
slug: /guides/developer/on-the-fly-mutations
sidebar_label: 'Мутации «на лету»'
title: 'Мутации «на лету»'
keywords: ['Мутации «на лету»']
description: 'Описание механизма мутаций «на лету»'
doc_type: 'guide'
---



## Мутации на лету {#on-the-fly-mutations}

Когда мутации на лету включены, обновлённые строки помечаются как обновлённые немедленно, и последующие запросы `SELECT` автоматически возвращают изменённые значения. Когда мутации на лету не включены, может потребоваться дождаться применения мутаций фоновым процессом, чтобы увидеть изменённые значения.

Мутации на лету можно включить для таблиц семейства `MergeTree`, установив настройку уровня запроса `apply_mutations_on_fly`.

```sql
SET apply_mutations_on_fly = 1;
```


## Пример {#example}

Создадим таблицу и выполним несколько мутаций:

```sql
CREATE TABLE test_on_fly_mutations (id UInt64, v String)
ENGINE = MergeTree ORDER BY id;

-- Отключаем фоновую материализацию мутаций для демонстрации
-- стандартного поведения при отключённых мутациях на лету
SYSTEM STOP MERGES test_on_fly_mutations;
SET mutations_sync = 0;

-- Вставляем несколько строк в новую таблицу
INSERT INTO test_on_fly_mutations VALUES (1, 'a'), (2, 'b'), (3, 'c');

-- Обновляем значения строк
ALTER TABLE test_on_fly_mutations UPDATE v = 'd' WHERE id = 1;
ALTER TABLE test_on_fly_mutations DELETE WHERE v = 'd';
ALTER TABLE test_on_fly_mutations UPDATE v = 'e' WHERE id = 2;
ALTER TABLE test_on_fly_mutations DELETE WHERE v = 'e';
```

Проверим результат обновлений с помощью запроса `SELECT`:

```sql
-- Явно отключаем мутации на лету
SET apply_mutations_on_fly = 0;

SELECT id, v FROM test_on_fly_mutations ORDER BY id;
```

Обратите внимание, что при запросе к таблице значения строк ещё не обновлены:

```response
┌─id─┬─v─┐
│  1 │ a │
│  2 │ b │
│  3 │ c │
└────┴───┘
```

Теперь посмотрим, что произойдёт при включении мутаций на лету:

```sql
-- Включаем мутации на лету
SET apply_mutations_on_fly = 1;

SELECT id, v FROM test_on_fly_mutations ORDER BY id;
```

Запрос `SELECT` теперь сразу возвращает правильный результат без ожидания применения мутаций:

```response
┌─id─┬─v─┐
│  3 │ c │
└────┴───┘
```


## Влияние на производительность {#performance-impact}

Когда включены мутации «на лету», мутации не материализуются немедленно, а применяются только во время выполнения запросов `SELECT`. Однако следует учитывать, что мутации по-прежнему материализуются асинхронно в фоновом режиме, что является ресурсоёмким процессом.

Если количество поступающих мутаций постоянно превышает количество мутаций, обрабатываемых в фоновом режиме за определённый временной интервал, очередь нематериализованных мутаций, которые необходимо применить, будет продолжать расти. Это приведёт к постепенному снижению производительности запросов `SELECT`.

Рекомендуется включать настройку `apply_mutations_on_fly` вместе с другими настройками уровня `MergeTree`, такими как `number_of_mutations_to_throw` и `number_of_mutations_to_delay`, чтобы ограничить неконтролируемый рост нематериализованных мутаций.


## Поддержка подзапросов и недетерминированных функций {#support-for-subqueries-and-non-deterministic-functions}

Мутации на лету имеют ограниченную поддержку подзапросов и недетерминированных функций. Поддерживаются только скалярные подзапросы с результатом разумного размера (управляется настройкой `mutations_max_literal_size_to_replace`). Поддерживаются только константные недетерминированные функции (например, функция `now()`).

Данное поведение управляется следующими настройками:

- `mutations_execute_nondeterministic_on_initiator` — если установлено значение true, недетерминированные функции выполняются на реплике-инициаторе и заменяются литералами в запросах `UPDATE` и `DELETE`. Значение по умолчанию: `false`.
- `mutations_execute_subqueries_on_initiator` — если установлено значение true, скалярные подзапросы выполняются на реплике-инициаторе и заменяются литералами в запросах `UPDATE` и `DELETE`. Значение по умолчанию: `false`.
- `mutations_max_literal_size_to_replace` — максимальный размер сериализованных литералов в байтах для замены в запросах `UPDATE` и `DELETE`. Значение по умолчанию: `16384` (16 КиБ).
