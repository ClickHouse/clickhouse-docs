---
sidebar_label: 'Просмотр и восстановление резервных копий'
sidebar_position: 0
slug: /cloud/manage/backups/overview
title: 'Обзор'
keywords: ['резервные копии', 'облачные резервные копии', 'восстановление']
description: 'Обзор резервных копий в ClickHouse Cloud'
doc_type: 'guide'
---

import CloudNotSupportedBadge from '@theme/badges/CloudNotSupportedBadge';
import ScalePlanFeatureBadge from '@theme/badges/ScalePlanFeatureBadge';
import Image from '@theme/IdealImage';
import backup_chain from '@site/static/images/cloud/manage/backup-chain.png';
import backup_status_list from '@site/static/images/cloud/manage/backup-status-list.png';
import backup_usage from '@site/static/images/cloud/manage/backup-usage.png';
import backup_restore from '@site/static/images/cloud/manage/backup-restore.png';
import backup_service_provisioning from '@site/static/images/cloud/manage/backup-service-provisioning.png';


# Просмотр и восстановление резервных копий {#review-and-restore-backups}

В этом руководстве рассматривается, как работают резервные копии в ClickHouse Cloud, какие параметры доступны для настройки резервного копирования вашего сервиса и как выполнить восстановление из резервной копии.



## Список статусов резервных копий {#backup-status-list}

Резервные копии вашего сервиса будут создаваться по заданному расписанию — будь то ежедневное расписание по умолчанию или [пользовательское расписание](/cloud/manage/backups/configurable-backups), выбранное вами. Все доступные резервные копии можно просмотреть на вкладке сервиса **Backups**. Здесь вы можете увидеть статус резервной копии, продолжительность её создания, а также размер. Вы также можете восстановить конкретную резервную копию, используя столбец **Actions**.

<Image img={backup_status_list} size="md" alt="List of backup statuses in ClickHouse Cloud" border/>



## Понимание стоимости резервного копирования {#understanding-backup-cost}

Согласно стандартной политике, ClickHouse Cloud предусматривает ежедневное создание резервной копии с периодом хранения 24 часа. Выбор расписания, предполагающего хранение большего объема данных или более частое создание резервных копий, может привести к дополнительным затратам на хранение резервных копий.

Чтобы оценить стоимость резервного копирования, вы можете просмотреть стоимость резервных копий по каждому сервису на странице использования (usage) (как показано ниже). После того как резервное копирование с настроенным расписанием проработает несколько дней, вы сможете оценить стоимость и на основе этого получить ориентировочную месячную стоимость резервного копирования.

<Image img={backup_usage} size="md" alt="График использования резервного копирования в ClickHouse Cloud" border/>

Оценка общей стоимости ваших резервных копий предполагает наличие расписания. Мы также работаем над обновлением нашего [калькулятора стоимости](https://clickhouse.com/pricing), чтобы вы могли получить оценку месячной стоимости до настройки расписания. Для оценки стоимости вам потребуется указать следующие параметры:
- Размер полных и инкрементальных резервных копий
- Желаемая частота создания резервных копий
- Желаемый период хранения
- Облачный провайдер и регион

:::note
Имейте в виду, что оценочная стоимость резервного копирования будет меняться по мере роста объема данных в сервисе.
:::



## Восстановление резервной копии {#restore-a-backup}

Резервные копии восстанавливаются в новый сервис ClickHouse Cloud, а не в существующий сервис, с которого была создана резервная копия.

После нажатия значка **Restore** резервной копии вы можете указать имя нового сервиса, который будет создан, а затем выполнить восстановление из этой резервной копии:

<Image img={backup_restore} size="md" alt="Восстановление резервной копии в ClickHouse Cloud" />

Новый сервис будет отображаться в списке сервисов со статусом `Provisioning` до тех пор, пока он не будет готов:

<Image img={backup_service_provisioning} size="md" alt="Создание сервиса в процессе" border/>



## Работа с восстановленным сервисом {#working-with-your-restored-service}

После восстановления резервной копии у вас будет два похожих сервиса: **исходный сервис**, который требовалось восстановить, и новый **восстановленный сервис**, восстановленный из резервной копии исходного сервиса.

После завершения восстановления из резервной копии следует выполнить одно из следующих действий:

* Использовать новый восстановленный сервис и удалить исходный сервис.
* Перенести данные из нового восстановленного сервиса обратно в исходный сервис и удалить новый восстановленный сервис.

### Использовать **новый восстановленный сервис** {#use-the-new-restored-service}

Чтобы использовать новый сервис, выполните следующие шаги:

1. Убедитесь, что в новом сервисе есть записи в IP Access List, необходимые для вашего сценария использования.
2. Убедитесь, что новый сервис содержит нужные вам данные.
3. Удалите исходный сервис.

### Миграция данных из **нового восстановленного сервиса** обратно в **исходный сервис** {#migrate-data-from-the-newly-restored-service-back-to-the-original-service}

Предположим, вы не можете работать с новым восстановленным сервисом по какой-либо причине, например, если у вас всё ещё есть пользователи или приложения, которые подключаются к существующему сервису. В этом случае вы можете перенести восстановленные данные обратно в исходный сервис. Миграцию можно выполнить, следуя этим шагам:

**Разрешить удалённый доступ к новому восстановленному сервису**

Новый сервис должен быть восстановлен из резервной копии с тем же IP Allow List, что и исходный сервис. Это требуется, поскольку подключения к другим сервисам ClickHouse Cloud не будут разрешены, если только вы не включили доступ из **Anywhere**. Измените allow list и временно разрешите доступ из **Anywhere**. Подробности смотрите в документации по [IP Access List](/cloud/security/setting-ip-filters).

**На новом восстановленном сервисе ClickHouse (система, где размещены восстановленные данные)**

:::note
Чтобы получить доступ к новому сервису, вам нужно будет сбросить пароль. Это можно сделать на вкладке **Settings** списка сервисов.
:::

Добавьте пользователя с доступом только на чтение, который может читать исходную таблицу (в этом примере `db.table`):

```sql
CREATE USER exporter
IDENTIFIED WITH SHA256_PASSWORD BY 'здесь-ваш-пароль'
SETTINGS readonly = 1;
```

```sql
GRANT SELECT ON db.table TO exporter;
```

Скопируйте определение таблицы:

```sql
SELECT create_table_query
FROM system.tables
WHERE database = 'db' AND table = 'table'
```

**На целевой системе ClickHouse Cloud (той, на которой находилась повреждённая таблица):**

Создайте целевую базу данных:

```sql
CREATE DATABASE db
```

Используя оператор `CREATE TABLE` из исходной таблицы, создайте таблицу в целевой базе:

:::tip
Измените `ENGINE` на `ReplicatedMergeTree` без каких-либо параметров при выполнении оператора `CREATE`. ClickHouse Cloud автоматически реплицирует таблицы и подставляет корректные параметры.
:::

```sql
CREATE TABLE db.table ...
ENGINE = ReplicatedMergeTree
ORDER BY ...
```

Используйте функцию `remoteSecure`, чтобы получить данные из только что восстановленного сервиса ClickHouse Cloud в исходный сервис:

```sql
INSERT INTO db.table
SELECT *
FROM remoteSecure('source-hostname', db, table, 'exporter', 'password-here')
```

После успешной записи данных в исходный сервис обязательно проверьте их в этом сервисе. После проверки данных удалите новый сервис.


## Восстановление удалённых таблиц {#undeleting-or-undropping-tables}

Команда `UNDROP` поддерживается в ClickHouse Cloud через [Shared Catalog](https://clickhouse.com/docs/cloud/reference/shared-catalog).

Чтобы предотвратить случайное удаление таблиц пользователями, вы можете использовать [операторы `GRANT`](/sql-reference/statements/grant), чтобы отозвать права на [команду `DROP TABLE`](/sql-reference/statements/drop#drop-table) для конкретного пользователя или роли.

:::note
Чтобы предотвратить случайное удаление данных, обратите внимание, что по умолчанию в ClickHouse Cloud невозможно удалить таблицы размером &gt;`1TB`.
Если вам необходимо удалить таблицы, превышающие этот порог, вы можете использовать настройку `max_table_size_to_drop` для этого:

```sql
DROP TABLE IF EXISTS table_to_drop
SYNC SETTINGS max_table_size_to_drop=2000000000000 -- увеличивает ограничение до 2 ТБ
```

:::

:::note
Устаревшие тарифные планы: для клиентов на таких планах стандартные ежедневные резервные копии с хранением в течение 24 часов включены в стоимость хранилища.
:::


## Настраиваемые резервные копии {#configurable-backups}

Если вы хотите задать другое расписание резервного копирования, чем используется по умолчанию, ознакомьтесь с разделом [Настраиваемые резервные копии](/cloud/manage/backups/configurable-backups).



## Экспорт резервных копий в собственный облачный аккаунт {#export-backups-to-your-own-cloud-account}

Инструкции для пользователей, которые хотят экспортировать резервные копии в собственный облачный аккаунт, см. [здесь](/cloud/manage/backups/export-backups-to-own-cloud-account).
