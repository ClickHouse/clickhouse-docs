---
sidebar_label: 'Просмотр и восстановление резервных копий'
sidebar_position: 0
slug: /cloud/manage/backups/overview
title: 'Обзор'
keywords: ['backups', 'cloud backups', 'restore']
description: 'Обзор резервного копирования в ClickHouse Cloud'
doc_type: 'guide'
---

import CloudNotSupportedBadge from '@theme/badges/CloudNotSupportedBadge';
import ScalePlanFeatureBadge from '@theme/badges/ScalePlanFeatureBadge';
import Image from '@theme/IdealImage';
import backup_chain from '@site/static/images/cloud/manage/backup-chain.png';
import backup_status_list from '@site/static/images/cloud/manage/backup-status-list.png';
import backup_usage from '@site/static/images/cloud/manage/backup-usage.png';
import backup_restore from '@site/static/images/cloud/manage/backup-restore.png';
import backup_service_provisioning from '@site/static/images/cloud/manage/backup-service-provisioning.png';


# Просмотр и восстановление резервных копий

В этом руководстве описано, как работают резервные копии в ClickHouse Cloud, какие у вас есть варианты настройки резервного копирования для сервиса и как выполнить восстановление из резервной копии.



## Список статусов резервных копий {#backup-status-list}

Резервное копирование вашего сервиса будет выполняться согласно установленному расписанию — будь то стандартное ежедневное расписание или [настраиваемое расписание](/cloud/manage/backups/configurable-backups), выбранное вами. Все доступные резервные копии можно просмотреть на вкладке **Backups** сервиса. Здесь отображается статус резервной копии, длительность операции и размер резервной копии. Вы также можете восстановить конкретную резервную копию через колонку **Actions**.

<Image
  img={backup_status_list}
  size='md'
  alt='Список статусов резервных копий в ClickHouse Cloud'
  border
/>


## Понимание стоимости резервного копирования {#understanding-backup-cost}

По умолчанию ClickHouse Cloud выполняет резервное копирование ежедневно с хранением в течение 24 часов. Выбор расписания, требующего хранения большего объема данных или более частого создания резервных копий, может привести к дополнительным расходам на хранение.

Чтобы понять стоимость резервного копирования, вы можете просмотреть стоимость для каждого сервиса на экране использования (как показано ниже). После того как резервные копии будут создаваться в течение нескольких дней по настроенному расписанию, вы сможете оценить стоимость и экстраполировать её для расчета ежемесячных затрат на резервное копирование.

<Image
  img={backup_usage}
  size='md'
  alt='График использования резервного копирования в ClickHouse Cloud'
  border
/>

Для оценки общей стоимости резервного копирования необходимо задать расписание. Мы также работаем над обновлением нашего [калькулятора цен](https://clickhouse.com/pricing), чтобы вы могли получить оценку ежемесячной стоимости перед настройкой расписания. Для оценки стоимости вам потребуется указать следующие параметры:

- Размер полных и инкрементных резервных копий
- Желаемая частота
- Желаемый срок хранения
- Облачный провайдер и регион

:::note
Имейте в виду, что расчетная стоимость резервного копирования будет изменяться по мере роста объема данных в сервисе.
:::


## Восстановление резервной копии {#restore-a-backup}

Резервные копии восстанавливаются в новый сервис ClickHouse Cloud, а не в существующий сервис, из которого была создана резервная копия.

После нажатия на иконку **Restore** вы можете указать имя нового сервиса, который будет создан, и затем восстановить резервную копию:

<Image
  img={backup_restore}
  size='md'
  alt='Восстановление резервной копии в ClickHouse Cloud'
/>

Новый сервис будет отображаться в списке сервисов со статусом `Provisioning`, пока не будет готов:

<Image
  img={backup_service_provisioning}
  size='md'
  alt='Выполняется подготовка сервиса'
  border
/>


## Работа с восстановленным сервисом {#working-with-your-restored-service}

После восстановления резервной копии у вас будет два похожих сервиса: **исходный сервис**, который требовал восстановления, и новый **восстановленный сервис**, созданный из резервной копии исходного.

После завершения восстановления резервной копии необходимо выполнить одно из следующих действий:

- Использовать новый восстановленный сервис и удалить исходный сервис.
- Перенести данные из нового восстановленного сервиса обратно в исходный сервис и удалить новый восстановленный сервис.

### Использование **нового восстановленного сервиса** {#use-the-new-restored-service}

Чтобы использовать новый сервис, выполните следующие шаги:

1. Убедитесь, что новый сервис имеет необходимые записи в списке IP-доступа для вашего сценария использования.
1. Убедитесь, что новый сервис содержит нужные вам данные.
1. Удалите исходный сервис.

### Перенос данных из **нового восстановленного сервиса** обратно в **исходный сервис** {#migrate-data-from-the-newly-restored-service-back-to-the-original-service}

Предположим, вы не можете работать с новым восстановленным сервисом по какой-либо причине, например, если у вас все еще есть пользователи или приложения, подключающиеся к существующему сервису. Вы можете решить перенести восстановленные данные в исходный сервис. Миграцию можно выполнить, следуя этим шагам:

**Разрешение удаленного доступа к новому восстановленному сервису**

Новый сервис должен быть восстановлен из резервной копии с тем же списком разрешенных IP-адресов, что и исходный сервис. Это необходимо, поскольку подключения к другим сервисам ClickHouse Cloud не будут разрешены, если вы не разрешили доступ **отовсюду**. Временно измените список разрешений и разрешите доступ **отовсюду**. Подробности см. в документации [Список IP-доступа](/cloud/security/setting-ip-filters).

**На новом восстановленном сервисе ClickHouse (система, содержащая восстановленные данные)**

:::note
Для доступа к новому сервису необходимо сбросить пароль. Это можно сделать на вкладке **Settings** в списке сервисов.
:::

Добавьте пользователя с правами только на чтение, который может читать исходную таблицу (в данном примере `db.table`):

```sql
CREATE USER exporter
IDENTIFIED WITH SHA256_PASSWORD BY 'password-here'
SETTINGS readonly = 1;
```

```sql
GRANT SELECT ON db.table TO exporter;
```

Скопируйте определение таблицы:

```sql
SELECT create_table_query
FROM system.tables
WHERE database = 'db' AND table = 'table'
```

**На целевой системе ClickHouse Cloud (той, в которой была поврежденная таблица):**

Создайте целевую базу данных:

```sql
CREATE DATABASE db
```

Используя инструкцию `CREATE TABLE` из источника, создайте целевую таблицу:

:::tip
При выполнении инструкции `CREATE` измените `ENGINE` на `ReplicatedMergeTree` без параметров. ClickHouse Cloud всегда реплицирует таблицы и предоставляет корректные параметры.
:::

```sql
CREATE TABLE db.table ...
ENGINE = ReplicatedMergeTree
ORDER BY ...
```

Используйте функцию `remoteSecure` для извлечения данных из нового восстановленного сервиса ClickHouse Cloud в исходный сервис:

```sql
INSERT INTO db.table
SELECT *
FROM remoteSecure('source-hostname', db, table, 'exporter', 'password-here')
```

После успешной вставки данных в исходный сервис обязательно проверьте данные в сервисе. Также следует удалить новый сервис после проверки данных.


## Восстановление удаленных таблиц {#undeleting-or-undropping-tables}

Команда `UNDROP` поддерживается в ClickHouse Cloud через [Shared Catalog](https://clickhouse.com/docs/cloud/reference/shared-catalog).

Чтобы предотвратить случайное удаление таблиц пользователями, можно использовать [операторы `GRANT`](/sql-reference/statements/grant) для отзыва разрешений на выполнение [команды `DROP TABLE`](/sql-reference/statements/drop#drop-table) для конкретного пользователя или роли.

:::note
Для предотвращения случайного удаления данных обратите внимание, что по умолчанию в ClickHouse Cloud невозможно удалить таблицы размером более `1TB`.
Если необходимо удалить таблицы, превышающие этот порог, используйте настройку `max_table_size_to_drop`:

```sql
DROP TABLE IF EXISTS table_to_drop
SYNC SETTINGS max_table_size_to_drop=2000000000000 -- увеличивает лимит до 2TB
```

:::

:::note
Устаревшие тарифные планы: для клиентов на устаревших тарифных планах ежедневные резервные копии по умолчанию, хранящиеся в течение 24 часов, включены в стоимость хранения.
:::


## Настраиваемые резервные копии {#configurable-backups}

Если вы хотите настроить расписание резервного копирования, отличающееся от стандартного, см. раздел [Настраиваемые резервные копии](/cloud/manage/backups/configurable-backups).


## Экспорт резервных копий в собственную облачную учетную запись {#export-backups-to-your-own-cloud-account}

Пользователи, желающие экспортировать резервные копии в собственную облачную учетную запись, могут ознакомиться с инструкцией [здесь](/cloud/manage/backups/export-backups-to-own-cloud-account).
