---
sidebar_label: 'Просмотр и восстановление резервных копий'
sidebar_position: 0
slug: /cloud/manage/backups/overview
title: 'Обзор'
keywords: ['резервные копии', 'облачные резервные копии', 'восстановление']
description: 'Обзор резервных копий в ClickHouse Cloud'
doc_type: 'guide'
---

import CloudNotSupportedBadge from '@theme/badges/CloudNotSupportedBadge';
import ScalePlanFeatureBadge from '@theme/badges/ScalePlanFeatureBadge';
import Image from '@theme/IdealImage';
import backup_chain from '@site/static/images/cloud/manage/backup-chain.png';
import backup_status_list from '@site/static/images/cloud/manage/backup-status-list.png';
import backup_usage from '@site/static/images/cloud/manage/backup-usage.png';
import backup_restore from '@site/static/images/cloud/manage/backup-restore.png';
import backup_service_provisioning from '@site/static/images/cloud/manage/backup-service-provisioning.png';


# Просмотр и восстановление резервных копий \{#review-and-restore-backups\}

В этом руководстве рассматривается, как работают резервные копии в ClickHouse Cloud, какие параметры резервного копирования вы можете настроить для своего сервиса и как выполнить восстановление из резервной копии.

**Предварительные требования**

- Вы прочитали раздел ["Как работают резервные копии в ClickHouse Cloud"](/cloud/features/backups#how-backups-work-in-clickhouse-cloud) (страница с обзором функции)

## Список статусов резервных копий \{#backup-status-list\}

Для вашего сервиса будут создаваться резервные копии в соответствии с заданным расписанием — будь то расписание по умолчанию (ежедневное) или [настроенное расписание](/cloud/manage/backups/configurable-backups), выбранное вами. Все доступные резервные копии можно просмотреть на вкладке сервиса **Backups**. Здесь вы можете увидеть статус резервной копии, продолжительность её создания, а также размер. Вы также можете восстановить конкретную резервную копию, используя столбец **Actions**.

<Image img={backup_status_list} size="md" alt="Список статусов резервных копий в ClickHouse Cloud" border/>

## Понимание стоимости резервного копирования \{#understanding-backup-cost\}

Согласно политике по умолчанию, ClickHouse Cloud выполняет резервное копирование каждый день с 24‑часовым сроком хранения. Выбор расписания, при котором требуется хранить больше данных или выполнять резервное копирование чаще, может привести к дополнительным расходам на хранение резервных копий.

Чтобы понять стоимость резервного копирования, вы можете просмотреть стоимость резервного копирования для каждого сервиса на странице использования (как показано ниже). Как только резервное копирование с настраиваемым расписанием проработает несколько дней, вы сможете оценить стоимость и спроецировать ее на ежемесячную стоимость резервного копирования.

<Image img={backup_usage} size="md" alt="График использования резервного копирования в ClickHouse Cloud" border/>

Оценка общей стоимости резервного копирования требует настройки расписания. Мы также работаем над обновлением нашего [калькулятора цен](https://clickhouse.com/pricing), чтобы вы могли получить оценку ежемесячной стоимости до настройки расписания. Чтобы оценить стоимость, вам нужно указать следующие данные:

- Размер полных и инкрементных резервных копий
- Желаемая частота
- Желаемый срок хранения
- Облачный провайдер и регион

:::note
Имейте в виду, что оценочная стоимость резервного копирования будет меняться по мере роста объема данных в сервисе.
:::

## Восстановление резервной копии \{#restore-a-backup\}

Резервные копии восстанавливаются в новый сервис ClickHouse Cloud, а не в существующий сервис, с которого была создана резервная копия.

После нажатия на значок **Restore** для резервной копии вы можете указать имя нового сервиса, который будет создан, и затем восстановить эту резервную копию:

<Image img={backup_restore} size="md" alt="Восстановление резервной копии в ClickHouse Cloud" />

Новый сервис будет отображаться в списке сервисов со статусом `Provisioning`, пока он не будет готов:

<Image img={backup_service_provisioning} size="md" alt="Подготовка сервиса (Provisioning)" border/>

## Работа с восстановленным сервисом \{#working-with-your-restored-service\}

После восстановления из резервной копии у вас будет два похожих сервиса: **исходный сервис**, который нужно было восстановить, и новый **восстановленный сервис**, созданный при восстановлении из резервной копии исходного.

После завершения восстановления из резервной копии выполните одно из следующих действий:

- Используйте новый восстановленный сервис и удалите исходный сервис.
- Перенесите данные из нового восстановленного сервиса обратно в исходный сервис и удалите новый восстановленный сервис.

### Используйте **новый восстановленный сервис** \{#use-the-new-restored-service\}

Чтобы использовать новый сервис, выполните следующие шаги:

1. Убедитесь, что в новом сервисе есть записи в списке IP-доступа (IP Access List), необходимые для вашего варианта использования.
1. Убедитесь, что новый сервис содержит необходимые вам данные.
1. Удалите исходный сервис.

### Перенос данных с **вновь восстановленного сервиса** обратно на **исходный сервис** \{#migrate-data-from-the-newly-restored-service-back-to-the-original-service\}

Предположим, вы не можете работать с вновь восстановленным сервисом по какой‑то причине, например, если у вас всё ещё есть пользователи или приложения, которые подключаются к существующему сервису. В этом случае вы можете решить перенести вновь восстановленные данные в исходный сервис. Миграцию можно выполнить по следующим шагам:

**Разрешите удалённый доступ к вновь восстановленному сервису**

Новый сервис должен быть восстановлен из резервной копии с тем же списком разрешённых IP‑адресов (IP Allow List), что и у исходного сервиса. Это необходимо, так как подключения не будут разрешены к другим сервисам ClickHouse Cloud, если только вы заранее не разрешили доступ отовсюду (**Anywhere**). Измените allow list и временно разрешите доступ из **Anywhere**. Подробности см. в документации по [IP Access List](/cloud/security/setting-ip-filters).

**На вновь восстановленном сервисе ClickHouse (система, на которой размещены восстановленные данные)**

:::note
Вам потребуется сбросить пароль для нового сервиса, чтобы получить к нему доступ. Это можно сделать на вкладке **Settings** в списке сервисов.
:::

Добавьте пользователя с правами только на чтение, который сможет читать исходную таблицу (в этом примере — `db.table`):

```sql
  CREATE USER exporter
  IDENTIFIED WITH SHA256_PASSWORD BY 'password-here'
  SETTINGS readonly = 1;
```

```sql
  GRANT SELECT ON db.table TO exporter;
```

Скопируйте определение таблицы:

```sql
  SELECT create_table_query
  FROM system.tables
  WHERE database = 'db' AND table = 'table'
```

**На целевой системе ClickHouse Cloud (той, где находилась повреждённая таблица):**

Создайте целевую базу данных:

```sql
  CREATE DATABASE db
```

Используя оператор `CREATE TABLE` из источника, создайте целевую таблицу:

:::tip
Измените `ENGINE` на `ReplicatedMergeTree` без каких-либо параметров при выполнении оператора `CREATE`. ClickHouse Cloud всегда реплицирует таблицы и подставляет корректные параметры.
:::

```sql
  CREATE TABLE db.table ...
  ENGINE = ReplicatedMergeTree
  ORDER BY ...
```

Используйте функцию `remoteSecure`, чтобы получить данные из недавно восстановленного сервиса ClickHouse Cloud в исходный сервис:

```sql
  INSERT INTO db.table
  SELECT *
  FROM remoteSecure('source-hostname', db, table, 'exporter', 'password-here')
```

После успешной загрузки данных в исходный сервис обязательно убедитесь, что данные в нём корректны. После проверки данных удалите новый сервис.


## Восстановление удалённых таблиц (UNDROP) \{#undeleting-or-undropping-tables\}

Команда `UNDROP` поддерживается в ClickHouse Cloud через [Shared Catalog](https://clickhouse.com/docs/cloud/reference/shared-catalog).

Чтобы предотвратить случайное удаление таблиц пользователями, вы можете использовать [команды `GRANT`](/sql-reference/statements/grant), чтобы отозвать права на [команду `DROP TABLE`](/sql-reference/statements/drop#drop-table) для конкретного пользователя или роли.

:::note
Чтобы предотвратить случайное удаление данных, обратите внимание, что по умолчанию в ClickHouse Cloud невозможно удалить таблицы размером &gt;`1TB`.
Если вам нужно удалять таблицы, превышающие этот порог, используйте настройку `max_table_size_to_drop`:

```sql
DROP TABLE IF EXISTS table_to_drop
SYNC SETTINGS max_table_size_to_drop=2000000000000 -- increases the limit to 2TB
```

:::

:::note
Устаревшие тарифные планы (Legacy): для клиентов на таких тарифах ежедневные резервные копии, создаваемые по умолчанию и хранящиеся в течение 24 часов, включены в стоимость хранения данных.
:::


## Длительность резервного копирования \{#backup-durations\}

Длительность операций резервного копирования и восстановления зависит от нескольких факторов, таких как размер базы данных, а также схема и количество таблиц в базе данных.
Инкрементные резервные копии, как правило, создаются значительно быстрее, чем полные, поскольку требуется сохранить меньший объём данных.
Восстановление из инкрементной резервной копии будет немного медленнее, чем восстановление из полной резервной копии, так как при восстановлении, как объяснялось выше, учитываются все инкрементные резервные копии и последняя полная резервная копия в цепочке.

В наших тестах мы наблюдали, что создание небольших резервных копий объёмом около 1 ТБ может занимать порядка 10–15 минут или дольше.
Резервное копирование объёмов менее 20 ТБ должно завершаться в пределах часа, а резервное копирование 50 ТБ данных — занимать примерно 2–3 часа.
При больших объёмах резервное копирование получает эффект экономии на масштабе, и мы видели, что резервные копии объёмом до 1 ПБ для некоторых внутренних сервисов выполнялись примерно за 10 часов.

:::note
Резервные копии во внешние бакеты могут создаваться медленнее, чем резервные копии в бакеты ClickHouse
:::

Длительность восстановления примерно соответствует длительности резервного копирования.

Мы рекомендуем провести тестирование на вашей собственной базе данных или на выборочных данных, чтобы получить более точные оценки, так как фактическая длительность зависит от ряда факторов, описанных выше.

## Настраиваемые резервные копии \{#configurable-backups\}

Если вы хотите настроить расписание резервного копирования, отличающееся от стандартного, ознакомьтесь с разделом [«Настраиваемые резервные копии»](/cloud/manage/backups/configurable-backups).

## Экспорт резервных копий в собственный облачный аккаунт \{#export-backups-to-your-own-cloud-account\}

Инструкции по экспорту резервных копий в собственный облачный аккаунт см. [здесь](/cloud/manage/backups/export-backups-to-own-cloud-account).