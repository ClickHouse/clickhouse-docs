---
sidebar_label: 'Настройка IP-фильтров'
slug: /cloud/security/setting-ip-filters
title: 'Настройка IP-фильтров'
description: 'На этой странице описано, как настроить IP-фильтры в ClickHouse Cloud для управления доступом к сервисам ClickHouse.'
doc_type: 'guide'
keywords: ['IP filters', 'IP access list']
---

import Image from '@theme/IdealImage';
import ip_filtering_after_provisioning from '@site/static/images/cloud/security/ip-filtering-after-provisioning.png';
import ip_filter_add_single_ip from '@site/static/images/cloud/security/ip-filter-add-single-ip.png';


## Настройка IP-фильтров {#setting-ip-filters}

Списки IP-доступа фильтруют трафик к сервисам ClickHouse или API-ключам, определяя, каким исходным адресам разрешено подключение. Эти списки настраиваются индивидуально для каждого сервиса и каждого API-ключа. Списки можно настроить как при создании сервиса или API-ключа, так и позже.

:::important
Если вы не создадите список IP-доступа для сервиса ClickHouse Cloud, то никакой трафик к сервису не будет разрешён. Если списки IP-доступа для сервисов ClickHouse установлены в режим `Allow from anywhere`, ваш сервис может периодически переводиться из неактивного состояния в активное интернет-краулерами и сканерами, которые ищут публичные IP-адреса, что может привести к незначительным непредвиденным расходам.
:::


## Подготовка {#prepare}

Прежде чем начать, соберите IP-адреса или диапазоны, которые необходимо добавить в список доступа. Учитывайте удалённых сотрудников, дежурные локации, VPN и т. д. Пользовательский интерфейс списка доступа по IP принимает отдельные адреса и нотацию CIDR.

Нотация бесклассовой междоменной маршрутизации (CIDR) позволяет указывать диапазоны IP-адресов меньше традиционных размеров масок подсетей класса A, B или C (8, 16 или 24). [ARIN](https://account.arin.net/public/cidrCalculator) и ряд других организаций предоставляют калькуляторы CIDR, если они вам необходимы. Для получения дополнительной информации о нотации CIDR обратитесь к RFC [Classless Inter-domain Routing (CIDR)](https://www.rfc-editor.org/rfc/rfc4632.html).


## Создание или изменение списка IP-доступа {#create-or-modify-an-ip-access-list}

:::note Применимо только к подключениям вне PrivateLink
Списки IP-доступа применяются только к подключениям из публичного интернета, вне [PrivateLink](/cloud/security/connectivity/private-networking).
Если вы хотите разрешить трафик только через PrivateLink, установите `DenyAll` в списке разрешённых IP.
:::

<details>
  <summary>Список IP-доступа для сервисов ClickHouse</summary>

При создании сервиса ClickHouse настройка по умолчанию для списка разрешённых IP — «Запретить отовсюду».

В списке сервисов ClickHouse Cloud выберите нужный сервис, затем перейдите в **Settings**. В разделе **Security** находится список IP-доступа. Нажмите кнопку Add IPs.

Откроется боковая панель с параметрами настройки:

- Разрешить входящий трафик из любого источника к сервису
- Разрешить доступ из определённых источников к сервису
- Запретить весь доступ к сервису

</details>
<details>
  <summary>Список IP-доступа для API-ключей</summary>

При создании API-ключа настройка по умолчанию для списка разрешённых IP — «Разрешить отовсюду».

В списке API-ключей нажмите на три точки рядом с нужным API-ключом в столбце **Actions** и выберите **Edit**. В нижней части экрана находится список IP-доступа и параметры настройки:

- Разрешить входящий трафик из любого источника к сервису
- Разрешить доступ из определённых источников к сервису
- Запретить весь доступ к сервису

</details>

На этом снимке экрана показан список доступа, разрешающий трафик из диапазона IP-адресов с описанием «NY Office range»:

<Image
  img={ip_filtering_after_provisioning}
  size='md'
  alt='Существующий список доступа в ClickHouse Cloud'
  border
/>

### Возможные действия {#possible-actions}

1. Чтобы добавить дополнительную запись, используйте **+ Add new IP**

В этом примере добавляется один IP-адрес с описанием `London server`:

<Image
  img={ip_filter_add_single_ip}
  size='md'
  alt='Добавление одного IP в список доступа в ClickHouse Cloud'
  border
/>

2. Удаление существующей записи

Нажатие на крестик (x) удаляет запись

3. Редактирование существующей записи

Непосредственное изменение записи

4. Переключение на разрешение доступа из **Anywhere**

Это не рекомендуется, но допускается. Мы рекомендуем предоставить публичный доступ к приложению, построенному на основе ClickHouse, и ограничить доступ к внутреннему сервису ClickHouse Cloud.

Чтобы применить внесённые изменения, необходимо нажать **Save**.


## Проверка {#verification}

После создания фильтра проверьте подключение к сервису из разрешённого диапазона и убедитесь, что подключения из неразрешённого диапазона блокируются. Для проверки можно использовать простую команду `curl`:

```bash title="Попытка отклонена вне списка разрешённых адресов"
curl https://<HOSTNAME>.clickhouse.cloud:8443
```

```response
curl: (35) error:02FFF036:system library:func(4095):Connection reset by peer
```

или

```response
curl: (35) LibreSSL SSL_connect: SSL_ERROR_SYSCALL in connection to HOSTNAME.clickhouse.cloud:8443
```

```bash title="Попытка разрешена из списка разрешённых адресов"
curl https://<HOSTNAME>.clickhouse.cloud:8443
```

```response
Ok.
```


## Ограничения {#limitations}

- В настоящее время списки IP-доступа поддерживают только IPv4
