---
sidebar_label: "Управление пользователями базы данных"
slug: /cloud/security/manage-database-users
title: "Управление пользователями базы данных"
description: "На этой странице описано, как администраторы могут добавлять пользователей базы данных, управлять назначениями и удалять пользователей базы данных"
doc_type: "guide"
keywords:
  [
    "пользователи базы данных",
    "управление доступом",
    "безопасность",
    "разрешения",
    "управление пользователями"
  ]
---

import Image from "@theme/IdealImage"
import user_grant_permissions_options from "@site/static/images/cloud/security/cloud-access-management/user_grant_permissions_options.png"

В этом руководстве описаны два способа управления пользователями базы данных: через SQL-консоль и непосредственно в базе данных.

### Аутентификация в SQL-консоли без пароля {#sql-console-passwordless-authentication}

Пользователи SQL-консоли создаются для каждой сессии и проходят аутентификацию с помощью сертификатов X.509, которые автоматически ротируются. Пользователь удаляется при завершении сессии. При формировании списков доступа для аудита перейдите на вкладку Settings для сервиса в консоли и обратите внимание на доступ к SQL-консоли в дополнение к пользователям базы данных, существующим в базе данных. Если настроены пользовательские роли, доступ пользователя указывается в роли, имя которой заканчивается именем пользователя.


## Пользователи и роли SQL-консоли {#sql-console-users-and-roles}

Базовые роли SQL-консоли могут быть назначены пользователям с разрешениями Service Read Only и Service Admin. Подробнее см. в разделе [Управление назначением ролей SQL-консоли](/cloud/guides/sql-console/manage-sql-console-role-assignments). В этом руководстве показано, как создать пользовательскую роль для пользователя SQL-консоли.

Чтобы создать пользовательскую роль для пользователя SQL-консоли и назначить ей общую роль, выполните следующие команды. Адрес электронной почты должен совпадать с адресом электронной почты пользователя в консоли.

<VerticalStepper headerLevel="h4">

#### Создание роли `database_developer` и предоставление разрешений {#create-role-grant-permissions}

Создайте роль `database_developer` и предоставьте разрешения `SHOW`, `CREATE`, `ALTER` и `DELETE`.

```sql
CREATE ROLE OR REPLACE database_developer;
GRANT SHOW ON * TO database_developer;
GRANT CREATE ON * TO database_developer;
GRANT ALTER ON * TO database_developer;
GRANT DELETE ON * TO database_developer;
```

#### Создание роли пользователя SQL-консоли {#create-sql-console-user-role}

Создайте роль для пользователя SQL-консоли my.user@domain.com и назначьте ей роль database_developer.

```sql
CREATE ROLE OR REPLACE `sql-console-role:my.user@domain.com`;
GRANT database_developer TO `sql-console-role:my.user@domain.com`;
```

#### Пользователю назначается новая роль при использовании SQL-консоли {#use-assigned-new-role}

Пользователю будет назначена роль, связанная с его адресом электронной почты, при каждом использовании SQL-консоли.

</VerticalStepper>


## Аутентификация в базе данных {#database-authentication}

### Идентификатор и пароль пользователя базы данных {#database-user-id--password}

Используйте метод SHA256_hash при [создании учетных записей пользователей](/sql-reference/statements/create/user.md) для обеспечения безопасности паролей. Пароли базы данных ClickHouse должны содержать минимум 12 символов и соответствовать требованиям сложности: заглавные буквы, строчные буквы, цифры и/или специальные символы.

:::tip Генерируйте пароли безопасно
Поскольку пользователи без прав администратора не могут самостоятельно установить свой пароль, попросите пользователя хешировать пароль с помощью генератора,
например [этого](https://tools.keycdn.com/sha256-online-generator), прежде чем передать его администратору для настройки учетной записи.
:::

```sql
CREATE USER userName IDENTIFIED WITH sha256_hash BY 'hash';
```

### Пользователь базы данных с аутентификацией через Secure Shell (SSH) {#database-ssh}

Чтобы настроить SSH-аутентификацию для пользователя базы данных ClickHouse Cloud:

1. Используйте ssh-keygen для создания пары ключей.
2. Используйте открытый ключ для создания пользователя.
3. Назначьте пользователю роли и/или права доступа.
4. Используйте закрытый ключ для аутентификации в сервисе.

Подробное руководство с примерами см. в разделе [Как подключиться к ClickHouse Cloud с использованием SSH-ключей](/knowledgebase/how-to-connect-to-ch-cloud-using-ssh-keys) в нашей базе знаний.


## Права доступа к базе данных {#database-permissions}

Настройте следующие параметры в сервисах и базах данных с помощью SQL-оператора [GRANT](/sql-reference/statements/grant).

| Роль    | Описание                                                                     |
| :------ | :--------------------------------------------------------------------------- |
| Default | Полный административный доступ к сервисам                                    |
| Custom  | Настраивается с помощью SQL-оператора [`GRANT`](/sql-reference/statements/grant) |

- Роли базы данных являются аддитивными. Это означает, что если пользователь является членом двух ролей, он получает максимальный доступ, предоставленный обеими ролями. Пользователи не теряют доступ при добавлении ролей.
- Роли базы данных могут быть предоставлены другим ролям, что приводит к иерархической структуре. Роли наследуют все разрешения ролей, членами которых они являются.
- Роли базы данных уникальны для каждого сервиса и могут применяться к нескольким базам данных в рамках одного сервиса.

На иллюстрации ниже показаны различные способы предоставления разрешений пользователю.

<Image
  img={user_grant_permissions_options}
  alt='Иллюстрация, показывающая различные способы предоставления разрешений пользователю'
  size='md'
  background='black'
/>

### Начальные настройки {#initial-settings}

В базах данных автоматически создается учетная запись `default`, которой при создании сервиса предоставляется роль default_role. Пользователю, создающему сервис, предоставляется автоматически сгенерированный случайный пароль, назначенный учетной записи `default` при создании сервиса. Пароль не отображается после начальной настройки, но может быть изменен позже любым пользователем с правами Service Admin в консоли. Эта учетная запись или учетная запись с привилегиями Service Admin в консоли может в любое время настроить дополнительных пользователей и роли базы данных.

:::note
Чтобы изменить пароль, назначенный учетной записи `default` в консоли, перейдите в меню Services слева, откройте сервис, перейдите на вкладку Settings и нажмите кнопку Reset password.
:::

Рекомендуется создать новую учетную запись пользователя, связанную с конкретным человеком, и предоставить пользователю роль default_role. Это необходимо для того, чтобы действия, выполняемые пользователями, идентифицировались по их идентификаторам, а учетная запись `default` резервировалась для экстренных ситуаций.

```sql
CREATE USER userID IDENTIFIED WITH sha256_hash by 'hashed_password';
GRANT default_role to userID;
```

Пользователи могут использовать генератор хэшей SHA256 или функцию кода, такую как `hashlib` в Python, для преобразования пароля длиной 12+ символов с соответствующей сложностью в строку SHA256, которую можно предоставить системному администратору в качестве пароля. Это гарантирует, что администратор не видит и не обрабатывает пароли в открытом виде.

### Списки доступа к базе данных для пользователей SQL-консоли {#database-access-listings-with-sql-console-users}

Следующий процесс можно использовать для создания полного списка доступа к SQL-консоли и базам данных в вашей организации.

<VerticalStepper headerLevel="h4">

#### Получение списка всех предоставленных прав базы данных {#get-a-list-of-all-database-grants}

Выполните следующие запросы, чтобы получить список всех предоставленных прав в базе данных.

```sql
SELECT grants.user_name,
grants.role_name,
users.name AS role_member,
grants.access_type,
grants.database,
grants.table
FROM system.grants LEFT OUTER JOIN system.role_grants ON grants.role_name = role_grants.granted_role_name
LEFT OUTER JOIN system.users ON role_grants.user_name = users.name

UNION ALL

SELECT grants.user_name,
grants.role_name,
role_grants.role_name AS role_member,
grants.access_type,
grants.database,
grants.table
FROM system.role_grants LEFT OUTER JOIN system.grants ON role_grants.granted_role_name = grants.role_name
WHERE role_grants.user_name is null;
```

#### Сопоставление списка прав с пользователями консоли, имеющими доступ к SQL-консоли {#associate-grant-list-to-console-users-with-access-to-sql-console}

Сопоставьте этот список с пользователями консоли, имеющими доступ к SQL-консоли.

a. Перейдите в консоль.

b. Выберите соответствующий сервис.

c. Выберите Settings слева.

d. Прокрутите до раздела SQL console access.

e. Нажмите на ссылку с количеством пользователей, имеющих доступ к базе данных `There are # users with access to this service.`, чтобы увидеть список пользователей.

</VerticalStepper>


## Пользователи хранилища {#warehouse-users}

Пользователи хранилища являются общими для всех сервисов в рамках одного хранилища. Подробнее см. раздел [управление доступом к хранилищу](/cloud/reference/warehouses#access-controls).
