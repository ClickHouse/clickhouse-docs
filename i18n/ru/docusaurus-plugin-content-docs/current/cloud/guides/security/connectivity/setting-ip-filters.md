---
'sidebar_label': 'Настройка фильтров IP'
'slug': '/cloud/security/setting-ip-filters'
'title': 'Настройка фильтров IP'
'description': 'Эта страница объясняет, как установить фильтры IP в ClickHouse Cloud
  для контроля доступа к услугам ClickHouse.'
'doc_type': 'guide'
---
import Image from '@theme/IdealImage';
import ip_filtering_after_provisioning from '@site/static/images/cloud/security/ip-filtering-after-provisioning.png';
import ip_filter_add_single_ip from '@site/static/images/cloud/security/ip-filter-add-single-ip.png';

## Установка IP-фильтров {#setting-ip-filters}

Списки доступа по IP фильтруют трафик к сервисам ClickHouse или API ключам, указывая, какие IP-адреса могут подключаться. Эти списки настраиваются для каждого сервиса и каждого API ключа. Списки могут быть настроены во время создания сервиса или API ключа, или позже.

:::important
Если вы пропустите создание списка доступа по IP для сервиса ClickHouse Cloud, то никакой трафик к сервису не будет разрешен. Если списки доступа по IP для сервисов ClickHouse настроены на `Allow from anywhere`, ваш сервис может периодически перемещаться из неактивного состояния в активное из-за интернет-роботов и сканеров, которые ищут общедоступные IP, что может привести к неожиданным расходам.
:::

## Подготовка {#prepare}

Перед тем как начать, соберите IP-адреса или диапазоны, которые должны быть добавлены в список доступа. Учитывайте удаленных сотрудников, места дежурства, VPN и т.д. Интерфейс списка доступа по IP принимает как индивидуальные адреса, так и нотацию CIDR.

Нотация классовой междоменной маршрутизации (CIDR) позволяет указывать диапазоны IP-адресов, меньшие, чем традиционные размеры маски подсети классов A, B или C (8, 6 или 24). [ARIN](https://account.arin.net/public/cidrCalculator) и несколько других организаций предлагают калькуляторы CIDR, если вам нужен такой инструмент, и если вы хотите получить более подробную информацию о нотации CIDR, ознакомьтесь с RFC [Classless Inter-domain Routing (CIDR)](https://www.rfc-editor.org/rfc/rfc4632.html).

## Создание или изменение списка доступа по IP {#create-or-modify-an-ip-access-list}

:::note Применимо только к подключениям вне PrivateLink
Списки доступа по IP применяются только к подключениям из публичного интернета, вне [PrivateLink](/cloud/security/private-link-overview).
Если вам нужен только трафик из PrivateLink, установите `DenyAll` в списке разрешенных IP.
:::

<details>
  <summary>Список доступа по IP для сервисов ClickHouse</summary>

  При создании сервиса ClickHouse настройка по умолчанию для списка разрешенных IP - 'Allow from nowhere.' 
  
  В списке сервисов ClickHouse Cloud выберите сервис, затем выберите **Настройки**.  В разделе **Безопасность** вы найдете список доступа по IP. Нажмите на кнопку Добавить IP.
  
  Появится боковая панель с параметрами для настройки:
  
- Разрешить входящий трафик из любой точки в сервис
- Разрешить доступ из конкретных мест в сервис
- Запретить весь доступ к сервису
  
</details>
<details>
  <summary>Список доступа по IP для API ключей</summary>

  При создании API ключа настройка по умолчанию для списка разрешенных IP - 'Allow from anywhere.'
  
  В списке API ключей нажмите на три точки рядом с API ключом в колонке **Действия** и выберите **Редактировать**. Внизу экрана вы найдете список доступа по IP и параметры для настройки:

- Разрешить входящий трафик из любой точки в сервис
- Разрешить доступ из конкретных мест в сервис
- Запретить весь доступ к сервису
  
</details>

Этот скриншот показывает список доступа, который позволяет трафик из диапазона IP-адресов, описанный как "NY Office range":
  
<Image img={ip_filtering_after_provisioning} size="md" alt="Существующий список доступа в ClickHouse Cloud" border/>

### Возможные действия {#possible-actions}

1. Чтобы добавить дополнительную запись, вы можете использовать **+ Добавить новый IP**

  В этом примере добавляется один IP-адрес с описанием `London server`:

<Image img={ip_filter_add_single_ip} size="md" alt="Добавление одиночного IP в список доступа в ClickHouse Cloud" border/>

2. Удалить существующую запись

  Нажатие на крестик (x) удаляет запись

3. Изменить существующую запись

  Прямое редактирование записи

4. Переключиться на разрешение доступа из **Anywhere**

  Это не рекомендуется, но это разрешено. Мы рекомендуем экспонировать приложение, построенное на базе ClickHouse, для публичного доступа и ограничить доступ к бэкенд-сервису ClickHouse Cloud.

Чтобы применить сделанные изменения, необходимо нажать **Сохранить**.

## Проверка {#verification}

Как только вы создадите свой фильтр, подтвердите подключение к сервису из разрешенного диапазона и убедитесь, что соединения из вне разрешенного диапазона отклоняются. Простой командой `curl` можно проверить:
```bash title="Attempt rejected from outside the allow list"
curl https://<HOSTNAME>.clickhouse.cloud:8443
```
```response
curl: (35) error:02FFF036:system library:func(4095):Connection reset by peer
```
или
```response
curl: (35) LibreSSL SSL_connect: SSL_ERROR_SYSCALL in connection to HOSTNAME.clickhouse.cloud:8443
```

```bash title="Attempt permitted from inside the allow list"
curl https://<HOSTNAME>.clickhouse.cloud:8443
```
```response
Ok.
```

## Ограничения {#limitations}

- В настоящее время списки доступа по IP поддерживают только IPv4