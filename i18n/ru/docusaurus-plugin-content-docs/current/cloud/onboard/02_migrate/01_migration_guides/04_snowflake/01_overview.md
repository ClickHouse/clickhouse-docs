---
sidebar_label: 'Обзор'
slug: /migrations/snowflake-overview
description: 'Миграция с Snowflake на ClickHouse'
keywords: ['Snowflake']
title: 'Переход с Snowflake на ClickHouse'
show_related_blogs: true
doc_type: 'guide'
---

import snowflake_architecture from '@site/static/images/cloud/onboard/discover/use_cases/snowflake_architecture.png';
import cloud_architecture from '@site/static/images/cloud/onboard/discover/use_cases/cloud_architecture.png';
import Image from '@theme/IdealImage';


# Миграция с Snowflake на ClickHouse

> Этот документ представляет собой введение в миграцию данных из Snowflake в ClickHouse.

Snowflake — это облачное хранилище данных, основное назначение которого — перенос
устаревших локальных (on-premise) хранилищ данных в облако. Оно хорошо
оптимизировано для выполнения долгих, ресурсоемких отчетов в масштабах больших объемов данных. По мере того как
наборы данных мигрируют в облако, владельцы данных начинают задумываться, как еще они могут
извлекать ценность из этих данных, включая использование этих наборов данных для работы
реальных (real-time) приложений для внутренних и внешних сценариев.
Когда это происходит, они часто понимают, что им нужна база данных, оптимизированная для
реальной (real-time) аналитики, такая как ClickHouse.



## Сравнение {#comparison}

В этом разделе мы сравним ключевые возможности ClickHouse и Snowflake.

### Сходства {#similarities}

Snowflake — это облачная платформа для хранения данных, которая предоставляет масштабируемое
и эффективное решение для хранения, обработки и анализа больших объемов
данных.
Как и ClickHouse, Snowflake не построен на основе существующих технологий, а использует
собственный движок SQL-запросов и специализированную архитектуру.

Архитектура Snowflake описывается как гибрид архитектуры с общим хранилищем (shared-storage/shared-disk)
и архитектуры без общих ресурсов (shared-nothing). Архитектура с общим хранилищем —
это архитектура, в которой данные доступны всем вычислительным узлам через объектные
хранилища, такие как S3. Архитектура без общих ресурсов — это архитектура, в которой каждый вычислительный узел
хранит часть всего набора данных локально для обработки запросов. Теоретически это
обеспечивает преимущества обеих моделей: простоту архитектуры с общим диском
и масштабируемость архитектуры без общих ресурсов.

Эта архитектура принципиально опирается на объектное хранилище как основной носитель данных,
которое масштабируется практически неограниченно при параллельном доступе, обеспечивая высокую
отказоустойчивость и гарантии масштабируемой пропускной способности.

Изображение ниже из [docs.snowflake.com](https://docs.snowflake.com/en/user-guide/intro-key-concepts)
демонстрирует эту архитектуру:

<Image img={snowflake_architecture} size='md' alt='Архитектура Snowflake' />

В свою очередь, как продукт с открытым исходным кодом и облачное решение, ClickHouse может быть развернут
как в архитектуре с общим диском, так и в архитектуре без общих ресурсов. Последняя типична для
самостоятельно управляемых развертываний. Хотя конфигурации без общих ресурсов позволяют легко масштабировать CPU и память,
они вносят классические проблемы управления данными и
накладные расходы на репликацию данных, особенно при изменении состава кластера.

По этой причине ClickHouse Cloud использует архитектуру с общим хранилищем, которая
концептуально похожа на Snowflake. Данные хранятся один раз в объектном хранилище
(единственная копия), таком как S3 или GCS, обеспечивая практически неограниченное хранилище с
надежными гарантиями избыточности. Каждый узел имеет доступ к этой единственной копии
данных, а также к собственным локальным SSD для целей кеширования. Узлы, в свою очередь, могут
масштабироваться для предоставления дополнительных ресурсов CPU и памяти по мере необходимости. Как и в Snowflake,
свойства масштабируемости S3 решают классическое ограничение архитектур с общим диском
(узкие места ввода-вывода диска и сети), гарантируя, что пропускная способность ввода-вывода,
доступная текущим узлам в кластере, не снижается при добавлении дополнительных узлов.

<Image img={cloud_architecture} size='md' alt='Архитектура ClickHouse Cloud' />

### Различия {#differences}

Помимо базовых форматов хранения и движков запросов, эти архитектуры
различаются в нескольких важных аспектах:

- Вычислительные ресурсы в Snowflake предоставляются через концепцию [хранилищ (warehouses)](https://docs.snowflake.com/en/user-guide/warehouses).
  Они состоят из нескольких узлов, каждый фиксированного размера. Хотя Snowflake
  не публикует конкретную архитектуру своих хранилищ, [общепринято считать](https://select.dev/posts/snowflake-warehouse-sizing),
  что каждый узел состоит из 8 vCPU, 16 ГиБ и 200 ГБ локального хранилища (для кеша).
  Количество узлов зависит от размера, например, x-small имеет один узел,
  small — 2, medium — 4, large — 8 и т. д. Эти хранилища независимы от данных
  и могут использоваться для запросов к любой базе данных, находящейся в объектном хранилище. В режиме простоя
  и при отсутствии нагрузки запросами хранилища приостанавливаются — возобновляя работу при получении запроса.
  Хотя затраты на хранение всегда отражаются в счетах, хранилища
  тарифицируются только в активном состоянии.

- ClickHouse Cloud использует аналогичный принцип узлов с локальным кеш-
  хранилищем. Вместо фиксированных размеров пользователи развертывают сервис с общим
  объемом вычислительных ресурсов и доступной оперативной памяти. Это, в свою очередь, прозрачно
  автоматически масштабируется (в пределах заданных ограничений) на основе нагрузки запросами — либо
  вертикально путем увеличения (или уменьшения) ресурсов для каждого узла, либо
  горизонтально путем увеличения/уменьшения общего количества узлов. Узлы ClickHouse
  Cloud в настоящее время имеют соотношение CPU к памяти 1:1, в отличие от 1:2 в Snowflake.
  Хотя более слабая связь возможна, сервисы в настоящее время связаны с
  данными, в отличие от хранилищ Snowflake. Узлы также приостанавливаются в режиме простоя и
  возобновляют работу при поступлении запросов. Пользователи также могут вручную изменять размер сервисов при
  необходимости.

- Кеш запросов ClickHouse Cloud в настоящее время специфичен для узла, в отличие от
  кеша Snowflake, который предоставляется на уровне сервиса независимо от
  хранилища. На основе бенчмарков кеш узлов ClickHouse Cloud превосходит
  кеш Snowflake по производительности.


- Snowflake и ClickHouse Cloud используют разные подходы к масштабированию для
  повышения параллелизма запросов. Snowflake решает эту задачу с помощью функции,
  известной как [мультикластерные хранилища](https://docs.snowflake.com/en/user-guide/warehouses-multicluster#benefits-of-multi-cluster-warehouses).
  Эта функция позволяет пользователям добавлять кластеры к хранилищу. Хотя это не улучшает
  задержку запросов, она обеспечивает дополнительную параллелизацию и
  позволяет обрабатывать больше одновременных запросов. ClickHouse достигает этого путём добавления памяти
  и процессорных ресурсов к сервису через вертикальное или горизонтальное масштабирование. В этой статье мы не исследуем
  возможности этих сервисов по масштабированию для более высокого параллелизма,
  сосредотачиваясь вместо этого на задержке, но признаём, что эту работу следует выполнить
  для полного сравнения. Тем не менее, мы ожидаем, что ClickHouse будет хорошо работать
  в любом тесте параллелизма, учитывая, что Snowflake явно ограничивает количество
  одновременных запросов для [хранилища до 8 по умолчанию](https://docs.snowflake.com/en/sql-reference/parameters#max-concurrency-level).
  Для сравнения, ClickHouse Cloud позволяет выполнять до 1000 запросов на
  узел.

- Возможность Snowflake переключать размер вычислительных ресурсов для набора данных в сочетании с быстрым
  временем возобновления работы хранилищ делает его отличным решением для ad hoc
  запросов. Для сценариев использования хранилищ данных и озёр данных это обеспечивает
  преимущество перед другими системами.

### Аналитика в реальном времени {#real-time-analytics}

На основе публичных данных [бенчмарков](https://benchmark.clickhouse.com/#system=+%E2%98%81w|%EF%B8%8Fr|C%20c|nfe&type=-&machine=-ca2|gl|6ax|6ale|3al&cluster_size=-&opensource=-&tuned=+n&metric=hot&queries=-)
ClickHouse превосходит Snowflake для приложений аналитики в реальном времени в следующих областях:

- **Задержка запросов**: запросы Snowflake имеют более высокую задержку даже
  при применении кластеризации к таблицам для оптимизации производительности. В наших
  тестах Snowflake требует более чем в два раза больше вычислительных ресурсов для достижения эквивалентной
  производительности ClickHouse на запросах, где применяется фильтр, являющийся частью
  ключа кластеризации Snowflake или первичного ключа ClickHouse. Хотя
  [постоянный кеш запросов](https://docs.snowflake.com/en/user-guide/querying-persisted-results) Snowflake
  компенсирует некоторые из этих проблем с задержкой, он неэффективен в случаях,
  когда критерии фильтрации более разнообразны. Эффективность кеша запросов
  может быть дополнительно снижена изменениями в базовых данных, при этом записи кеша
  становятся недействительными при изменении таблицы. Хотя это не относится к
  бенчмарку для нашего приложения, реальное развёртывание потребует вставки новых,
  более свежих данных. Обратите внимание, что кеш запросов ClickHouse является
  специфичным для узла и не обеспечивает [транзакционную согласованность](https://clickhouse.com/blog/introduction-to-the-clickhouse-query-cache-and-design),
  что делает его [более подходящим](https://clickhouse.com/blog/introduction-to-the-clickhouse-query-cache-and-design)
  для аналитики в реальном времени. Пользователи также имеют детальный контроль над его использованием
  с возможностью управления им [для каждого запроса](/operations/settings/settings#use_query_cache),
  его [точным размером](/operations/settings/settings#query_cache_max_size_in_bytes),
  тем, [кешируется ли запрос](/operations/settings/settings#enable_writes_to_query_cache)
  (ограничения по длительности или требуемому количеству выполнений), и используется ли он
  только [пассивно](https://clickhouse.com/blog/introduction-to-the-clickhouse-query-cache-and-design#using-logs-and-settings).

- **Более низкая стоимость**: хранилища Snowflake можно настроить на приостановку после
  периода отсутствия запросов. После приостановки плата не взимается.
  На практике эта проверка неактивности может [быть снижена только до 60 секунд](https://docs.snowflake.com/en/sql-reference/sql/alter-warehouse).
  Хранилища автоматически возобновят работу в течение нескольких секунд после получения запроса.
  Поскольку Snowflake взимает плату за ресурсы только когда хранилище
  используется, такое поведение подходит для рабочих нагрузок, которые часто простаивают, например,
  для ad hoc запросов.


  Однако многие рабочие нагрузки для аналитики в реальном времени требуют постоянной потоковой загрузки данных и частых запросов, которые не выигрывают от простоя (например, клиентские дашборды). Это означает, что хранилища данных часто должны находиться в полностью активном состоянии и генерировать расходы. Это сводит на нет как экономический эффект от простоя, так и любые преимущества по производительности, которые могут быть связаны со способностью Snowflake быстрее, чем альтернативы, возвращаться в отзывчивое состояние. Это требование постоянной активности, в сочетании с более низкой поминутной стоимостью активного состояния в ClickHouse Cloud, приводит к тому, что ClickHouse Cloud предлагает значительно более низкую совокупную стоимость для таких типов рабочих нагрузок.

* **Предсказуемое ценообразование функциональности:** Такие возможности, как материализованные представления и кластеризация (эквивалент `ORDER BY` в ClickHouse), необходимы для достижения наивысшего уровня производительности в сценариях аналитики в реальном времени. В Snowflake эти возможности приводят к дополнительным расходам, требуя не только более высокого уровня, что увеличивает стоимость за кредит в 1,5 раза, но и непредсказуемых фоновых затрат. Например, материализованные представления требуют фонового обслуживания, как и кластеризация, и эти затраты сложно предсказать до начала использования. В отличие от этого, в ClickHouse Cloud эти возможности не влекут дополнительных расходов, кроме дополнительного использования CPU и памяти во время вставки, что обычно несущественно вне сценариев с очень высокой нагрузкой на вставку. В рамках нашего бенчмарка мы наблюдали, что эти различия, вместе с более низкими задержками выполнения запросов и более высокой степенью сжатия, приводят к значительно более низким затратам при использовании ClickHouse.
