---
sidebar_label: 'Обзор'
slug: /migrations/snowflake-overview
description: 'Миграция с Snowflake на ClickHouse'
keywords: ['Snowflake']
title: 'Переход с Snowflake на ClickHouse'
show_related_blogs: true
doc_type: 'guide'
---

import snowflake_architecture from '@site/static/images/cloud/onboard/discover/use_cases/snowflake_architecture.png';
import cloud_architecture from '@site/static/images/cloud/onboard/discover/use_cases/cloud_architecture.png';
import Image from '@theme/IdealImage';


# Миграция с Snowflake на ClickHouse

> Этот документ является вводным руководством по миграции данных из Snowflake в ClickHouse.

Snowflake — это облачное хранилище данных, основная задача которого — перенос устаревших локальных
нагрузок хранилищ данных в облако. Оно хорошо оптимизировано для выполнения
масштабных длительных отчетов. По мере переноса наборов данных в облако владельцы данных начинают
задумываться о том, как еще они могут извлечь ценность из этих данных, в том числе используя
эти наборы данных для работы приложений в реальном времени для внутренних и внешних сценариев.
В этот момент они часто понимают, что им нужна база данных, оптимизированная для
аналитики в реальном времени, такая как ClickHouse.



## Сравнение {#comparison}

В этом разделе мы сравним ключевые возможности ClickHouse и Snowflake.

### Сходства {#similarities}

Snowflake — это облачная платформа для хранения данных, которая предоставляет масштабируемое
и эффективное решение для хранения, обработки и анализа больших объемов
данных.
Как и ClickHouse, Snowflake не построен на основе существующих технологий, а использует
собственный движок SQL-запросов и специализированную архитектуру.

Архитектура Snowflake описывается как гибрид архитектуры с общим хранилищем (shared-storage, shared-disk)
и архитектуры без общих ресурсов (shared-nothing). Архитектура с общим хранилищем —
это архитектура, в которой данные доступны всем вычислительным узлам через объектные
хранилища, такие как S3. Архитектура без общих ресурсов — это архитектура, в которой каждый вычислительный узел
хранит часть всего набора данных локально для обработки запросов. Теоретически это
обеспечивает преимущества обеих моделей: простоту архитектуры с общим диском
и масштабируемость архитектуры без общих ресурсов.

Эта архитектура принципиально опирается на объектное хранилище как основной носитель данных,
которое масштабируется практически бесконечно при параллельном доступе, обеспечивая высокую
отказоустойчивость и гарантии масштабируемой пропускной способности.

На изображении ниже из [docs.snowflake.com](https://docs.snowflake.com/en/user-guide/intro-key-concepts)
показана эта архитектура:

<Image img={snowflake_architecture} size='md' alt='Архитектура Snowflake' />

В свою очередь, как продукт с открытым исходным кодом и облачное решение, ClickHouse может быть развернут
как в архитектуре с общим диском, так и в архитектуре без общих ресурсов. Последняя типична для
самостоятельно управляемых развертываний. Хотя конфигурации без общих ресурсов позволяют легко масштабировать CPU и память,
они вносят классические проблемы управления данными и
накладные расходы на репликацию данных, особенно при изменении состава кластера.

По этой причине ClickHouse Cloud использует архитектуру с общим хранилищем, которая
концептуально похожа на Snowflake. Данные хранятся один раз в объектном хранилище
(единственная копия), таком как S3 или GCS, обеспечивая практически неограниченное хранилище с
надежными гарантиями избыточности. Каждый узел имеет доступ к этой единственной копии
данных, а также к собственным локальным SSD для целей кеширования. Узлы, в свою очередь, могут
масштабироваться для предоставления дополнительных ресурсов CPU и памяти по мере необходимости. Как и в Snowflake,
свойства масштабируемости S3 решают классическое ограничение архитектур с общим диском
(узкие места ввода-вывода диска и сети), гарантируя, что пропускная способность ввода-вывода,
доступная текущим узлам в кластере, не снижается при добавлении дополнительных узлов.

<Image img={cloud_architecture} size='md' alt='Архитектура ClickHouse Cloud' />

### Различия {#differences}

Помимо базовых форматов хранения и движков запросов, эти архитектуры
различаются в нескольких аспектах:

- Вычислительные ресурсы в Snowflake предоставляются через концепцию [хранилищ (warehouses)](https://docs.snowflake.com/en/user-guide/warehouses).
  Они состоят из нескольких узлов, каждый фиксированного размера. Хотя Snowflake
  не публикует конкретную архитектуру своих хранилищ, [общепринято считать](https://select.dev/posts/snowflake-warehouse-sizing),
  что каждый узел состоит из 8 виртуальных CPU, 16 ГиБ памяти и 200 ГБ локального хранилища (для кеша).
  Количество узлов зависит от размера, например, x-small имеет один узел,
  small — 2, medium — 4, large — 8 и т. д. Эти хранилища независимы от данных
  и могут использоваться для запросов к любой базе данных, находящейся в объектном хранилище. Когда хранилища простаивают
  и не подвергаются нагрузке запросами, они приостанавливаются и возобновляют работу при получении запроса.
  Хотя затраты на хранение всегда отражаются в счетах, хранилища
  тарифицируются только в активном состоянии.

- ClickHouse Cloud использует аналогичный принцип узлов с локальным кеш-
  хранилищем. Вместо фиксированных размеров пользователи развертывают сервис с общим
  объемом вычислительных ресурсов и доступной оперативной памяти. Это, в свою очередь, прозрачно
  автоматически масштабируется (в пределах заданных ограничений) на основе нагрузки запросами — либо
  вертикально путем увеличения (или уменьшения) ресурсов для каждого узла, либо
  горизонтально путем увеличения/уменьшения общего количества узлов. Узлы ClickHouse
  Cloud в настоящее время имеют соотношение CPU к памяти 1:1, в отличие от 1:2 у Snowflake.
  Хотя более слабая связь возможна, сервисы в настоящее время связаны с
  данными, в отличие от хранилищ Snowflake. Узлы также приостанавливаются при простое и
  возобновляют работу при поступлении запросов. Пользователи также могут вручную изменять размер сервисов при
  необходимости.

- Кеш запросов ClickHouse Cloud в настоящее время специфичен для узла, в отличие от
  кеша Snowflake, который реализован на уровне сервиса независимо от
  хранилища. Согласно результатам тестов производительности, узловой кеш ClickHouse Cloud превосходит
  кеш Snowflake.


- Snowflake и ClickHouse Cloud используют разные подходы к масштабированию для
  повышения параллелизма запросов. Snowflake решает эту задачу с помощью функции,
  известной как [мультикластерные хранилища](https://docs.snowflake.com/en/user-guide/warehouses-multicluster#benefits-of-multi-cluster-warehouses).
  Эта функция позволяет пользователям добавлять кластеры к хранилищу. Хотя это не улучшает
  задержку запросов, она обеспечивает дополнительную параллелизацию и
  позволяет обрабатывать больше одновременных запросов. ClickHouse достигает этого путём добавления памяти
  и процессорных ресурсов к сервису через вертикальное или горизонтальное масштабирование. В этой статье мы не исследуем
  возможности этих сервисов по масштабированию для более высокого параллелизма,
  сосредотачиваясь вместо этого на задержке, но признаём, что эту работу следует выполнить
  для полного сравнения. Тем не менее, мы ожидаем, что ClickHouse будет хорошо работать
  в любом тесте параллелизма, учитывая, что Snowflake явно ограничивает количество
  одновременных запросов для [хранилища до 8 по умолчанию](https://docs.snowflake.com/en/sql-reference/parameters#max-concurrency-level).
  Для сравнения, ClickHouse Cloud позволяет выполнять до 1000 запросов на
  узел.

- Возможность Snowflake переключать размер вычислительных ресурсов для набора данных в сочетании с быстрым
  временем возобновления работы хранилищ делает его отличным решением для ad hoc
  запросов. Для сценариев использования хранилищ данных и озёр данных это обеспечивает
  преимущество перед другими системами.

### Аналитика в реальном времени {#real-time-analytics}

На основе публичных данных [бенчмарков](https://benchmark.clickhouse.com/#system=+%E2%98%81w|%EF%B8%8Fr|C%20c|nfe&type=-&machine=-ca2|gl|6ax|6ale|3al&cluster_size=-&opensource=-&tuned=+n&metric=hot&queries=-),
ClickHouse превосходит Snowflake для приложений аналитики в реальном времени в следующих областях:

- **Задержка запросов**: Запросы Snowflake имеют более высокую задержку даже
  при применении кластеризации к таблицам для оптимизации производительности. В наших
  тестах Snowflake требует более чем в два раза больше вычислительных ресурсов для достижения эквивалентной
  производительности ClickHouse на запросах, где применяется фильтр, являющийся частью
  ключа кластеризации Snowflake или первичного ключа ClickHouse. Хотя
  [постоянный кеш запросов](https://docs.snowflake.com/en/user-guide/querying-persisted-results) Snowflake
  компенсирует некоторые из этих проблем с задержкой, он неэффективен в случаях,
  когда критерии фильтрации более разнообразны. Эффективность кеша запросов
  может быть дополнительно снижена изменениями в базовых данных, при этом записи кеша
  становятся недействительными при изменении таблицы. Хотя это не относится к
  бенчмарку для нашего приложения, реальное развёртывание потребует вставки новых,
  более свежих данных. Обратите внимание, что кеш запросов ClickHouse является
  специфичным для узла и не обеспечивает [транзакционную согласованность](https://clickhouse.com/blog/introduction-to-the-clickhouse-query-cache-and-design),
  что делает его [более подходящим](https://clickhouse.com/blog/introduction-to-the-clickhouse-query-cache-and-design)
  для аналитики в реальном времени. Пользователи также имеют детальный контроль над его использованием
  с возможностью управления им [для каждого запроса](/operations/settings/settings#use_query_cache),
  его [точным размером](/operations/settings/settings#query_cache_max_size_in_bytes),
  тем, [кешируется ли запрос](/operations/settings/settings#enable_writes_to_query_cache)
  (ограничения по длительности или требуемому количеству выполнений), и используется ли он
  только [пассивно](https://clickhouse.com/blog/introduction-to-the-clickhouse-query-cache-and-design#using-logs-and-settings).

- **Более низкая стоимость**: Хранилища Snowflake могут быть настроены на приостановку после
  периода неактивности запросов. После приостановки плата не взимается.
  На практике эта проверка неактивности может [быть снижена только до 60 секунд](https://docs.snowflake.com/en/sql-reference/sql/alter-warehouse).
  Хранилища автоматически возобновят работу в течение нескольких секунд после получения запроса.
  Поскольку Snowflake взимает плату за ресурсы только когда хранилище
  используется, такое поведение подходит для рабочих нагрузок, которые часто простаивают, например,
  для ad hoc запросов.


  Однако многие рабочие нагрузки аналитики в реальном времени требуют непрерывного приёма данных и частого выполнения запросов, что не позволяет использовать преимущества режима простоя (например, в случае клиентских дашбордов). Это означает, что хранилища данных часто должны быть полностью активными и постоянно начислять плату. Это сводит на нет экономическую выгоду от режима простоя, а также любое преимущество в производительности, которое может быть связано со способностью Snowflake быстрее альтернатив возобновлять работу в отзывчивом состоянии. Это требование активного состояния в сочетании с более низкой посекундной стоимостью активного состояния ClickHouse Cloud приводит к тому, что ClickHouse Cloud предлагает значительно более низкую общую стоимость для таких типов рабочих нагрузок.

* **Предсказуемое ценообразование функций:** Функции, такие как материализованные представления и кластеризация (эквивалент ORDER BY в ClickHouse), необходимы для достижения максимальной производительности в сценариях аналитики в реальном времени. Эти функции влекут за собой дополнительные расходы в Snowflake, требуя не только более высокого уровня подписки, который увеличивает стоимость за кредит в 1,5 раза, но и непредсказуемых фоновых затрат. Например, материализованные представления влекут за собой фоновые затраты на обслуживание, как и кластеризация, которые трудно предсказать заранее. В отличие от этого, эти функции не влекут за собой дополнительных затрат в ClickHouse Cloud, за исключением дополнительного использования CPU и памяти во время вставки данных, что обычно незначительно за пределами сценариев с высокой нагрузкой на вставку. Мы наблюдали в наших тестах, что эти различия, наряду с более низкими задержками запросов и более высоким сжатием, приводят к значительно более низким затратам при использовании ClickHouse.
