---
sidebar_position: 1
sidebar_label: Автоматическое масштабирование
slug: /manage/scaling
description: Настройка автоматического масштабирования в ClickHouse Cloud
keywords: [автоматическое масштабирование, авто масштабирование, масштабирование, горизонтальное, вертикальное, всплески]
---

import auto_scaling from '@site/static/images/cloud/manage/AutoScaling.png';
import scaling_patch_request from '@site/static/images/cloud/manage/scaling-patch-request.png';
import scaling_patch_response from '@site/static/images/cloud/manage/scaling-patch-response.png';
import scaling_configure from '@site/static/images/cloud/manage/scaling-configure.png';
import scaling_memory_allocation from '@site/static/images/cloud/manage/scaling-memory-allocation.png';
import ScalePlanFeatureBadge from '@theme/badges/ScalePlanFeatureBadge'


# Автоматическое масштабирование

Масштабирование — это возможность адаптировать доступные ресурсы для соответствия клиентским требованиям. Услуги уровней Scale и Enterprise (со стандартным профилем 1:4) могут быть масштабированы горизонтально с помощью вызова API программным образом или изменения настроек в интерфейсе для корректировки системных ресурсов. В качестве альтернативы, эти услуги могут быть **автоматически масштабированы** вертикально для удовлетворения требований приложений.

<ScalePlanFeatureBadge feature="Автоматическое вертикальное масштабирование"/>

## Как работает масштабирование в ClickHouse Cloud {#how-scaling-works-in-clickhouse-cloud}

В настоящее время ClickHouse Cloud поддерживает вертикальное автоматическое масштабирование и ручное горизонтальное масштабирование для услуг уровня Scale.

Для услуг уровня Enterprise масштабирование работает следующим образом:

- **Горизонтальное масштабирование**: Ручное горизонтальное масштабирование будет доступно для всех стандартных и пользовательских профилей на уровне enterprise.
- **Вертикальное масштабирование**:
  - Стандартные профили (1:4) будут поддерживать вертикальное автоматическое масштабирование.
  - Пользовательские профили не будут поддерживать вертикальное автоматическое масштабирование или ручное вертикальное масштабирование при запуске. Однако эти услуги могут быть вертикально масштабированы, связавшись с поддержкой.

:::note
Мы вводим новый механизм вертикального масштабирования для вычислительных реплик, который мы называем "Make Before Break" (MBB). Этот подход добавляет одну или несколько реплик нового размера перед удалением старых реплик, предотвращая любые потери мощности во время операций масштабирования. Устранение разрыва между удалением существующих реплик и добавлением новых создает более плавный и менее разрушительный процесс масштабирования. Это особенно полезно в сценариях увеличения масштаба, когда высокая загрузка ресурсов вызывает необходимость в дополнительной мощности, поскольку преждевременное удаление реплик только усугубит ограничения ресурсов.

Пожалуйста, обратите внимание, что в рамках этого изменения данные исторических системных таблиц будут сохраняться на срок до 30 дней в рамках событий масштабирования. Кроме того, любые данные системных таблиц старше 19 декабря 2024 года для услуг на AWS или GCP и старше 14 января 2025 года для услуг на Azure не будут сохранены в рамках перехода на новые организационные уровни.
:::

### Вертикальное автоматическое масштабирование {#vertical-auto-scaling}

<ScalePlanFeatureBadge feature="Автоматическое вертикальное масштабирование"/>

Услуги Scale и Enterprise поддерживают автоматическое масштабирование на основе использования CPU и памяти. Мы постоянно мониторим историческое использование услуги в течение окна анализа (за последние 30 часов), чтобы принимать решения о масштабировании. Если использование превышает или падает ниже определенных порогов, мы соответственно масштабируем услугу, чтобы соответствовать спросу.

Автоматическое масштабирование на основе CPU активируется, когда использование CPU пересекает верхний порог в диапазоне 50-75% (фактический порог зависит от размера кластера). В этот момент выделение CPU для кластера удваивается. Если использование CPU падает ниже половины верхнего порога (например, до 25% в случае верхнего порога 50%), выделение CPU уменьшается вдвое.

Автоматическое масштабирование на основе памяти масштабирует кластер до 125% от максимального использования памяти, или до 150%, если возникают ошибки OOM (недостаток памяти).

Выбирается **большее** из рекомендаций по CPU или памяти, и выделение CPU и памяти для услуги масштабируется по ступеням `1` CPU и `4 ГиБ` памяти.

### Настройка вертикального автоматического масштабирования {#configuring-vertical-auto-scaling}

Масштабирование услуг ClickHouse Cloud Scale или Enterprise может корректироваться членами организации с ролью **Admin**. Чтобы настроить вертикальное автоматическое масштабирование, перейдите на вкладку **Настройки** вашей услуги и отрегулируйте минимальное и максимальное значение памяти, а также настройки CPU, как показано ниже.

:::note
Услуги с одной репликой не могут быть масштабированы для всех уровней.
:::

<div class="eighty-percent">
<img src={auto_scaling}
    alt="Страница настроек масштабирования"
    class="image"
/>
</div>

Установите **Максимальное значение памяти** для ваших реплик на более высоком уровне, чем **Минимальное значение памяти**. Тогда услуга будет масштабироваться по мере необходимости в этих пределах. Эти настройки также доступны во время первоначального создания услуги. Каждой реплике в вашей услуге будет выделено одинаковое количество ресурсов памяти и CPU.

Вы также можете выбрать установку этих значений одинаковыми, по сути "зафиксировав" услугу на конкретной конфигурации. Это сразу заставит масштабироваться до желаемого размера, который вы выбрали.

Важно отметить, что это отключит любое автоматическое масштабирование на кластере, и ваша услуга не будет защищена от увеличения использования CPU или памяти сверх этих настроек.

:::note
Для услуг уровня Enterprise стандартные профили 1:4 будут поддерживать вертикальное автоматическое масштабирование.
Пользовательские профили не будут поддерживать вертикальное автоматическое масштабирование или ручное вертикальное масштабирование при запуске.
Однако эти услуги могут быть вертикально масштабированы, связавшись с поддержкой.
:::

## Ручное горизонтальное масштабирование {#manual-horizontal-scaling}

<ScalePlanFeatureBadge feature="Ручное горизонтальное масштабирование"/>

Вы можете использовать публичные API ClickHouse Cloud для масштабирования вашей услуги, обновив настройки масштабирования для услуги или изменив количество реплик из облачной консоли.

**Уровни Scale** и **Enterprise** поддерживают услуги с одной репликой. Однако служба в этих уровнях, которая начинается с нескольких реплик или масштабируется до нескольких реплик, может быть обратно масштабирована до минимум `2` реплик.

:::note
Услуги могут масштабироваться горизонтально до максимума 20 реплик. Если вам нужно больше реплик, пожалуйста, свяжитесь с нашей службой поддержки.
:::

### Горизонтальное масштабирование через API {#horizontal-scaling-via-api}

Чтобы горизонтально масштабировать кластер, отправьте запрос `PATCH` через API, чтобы изменить количество реплик. Скриншоты ниже показывают вызов API для масштабирования кластера с `3` репликами до `6` реплик и соответствующий ответ.

<img alt="Запрос PATCH на масштабирование"
    style={{width: '500px', marginLeft: 0}}
    src={scaling_patch_request} />

*Запрос `PATCH` для обновления `numReplicas`*

<img alt="Ответ PATCH на масштабирование"
    style={{width: '450px', marginLeft: 0}}
    src={scaling_patch_response} />

*Ответ на запрос `PATCH`*

Если вы отправите новый запрос на масштабирование или несколько запросов подряд, пока один уже выполняется, служба масштабирования проигнорирует промежуточные состояния и придет к окончательному количеству реплик.

### Горизонтальное масштабирование через UI {#horizontal-scaling-via-ui}

Чтобы масштабировать услугу горизонтально из интерфейса, вы можете отрегулировать количество реплик для услуги на странице **Настройки**.

<img alt="Настройки конфигурации масштабирования"
    style={{width: '500px', marginLeft: 0}}
    src={scaling_configure} />

*Настройки масштабирования услуги из консоли ClickHouse Cloud*

Как только услуга будет масштабирована, панель мониторинга метрик в консоли облака должна показать правильное распределение для услуги. Скриншот ниже показывает кластер, который масштабировался до общего объема памяти `96 ГиБ`, что соответствует `6` репликам, каждая с выделением `16 ГиБ` памяти.

<img alt="Выделение памяти при масштабировании"
    style={{width: '500px', marginLeft: 0}}
    src={scaling_memory_allocation} />

## Автоматическая бездействие {#automatic-idling}
На странице **Настройки** вы также можете выбрать, разрешать ли автоматическое бездействие вашей услуги, когда она неактивна, как показано на изображении выше (т.е. когда услуга не выполняет никаких запросов, отправленных пользователями). Автоматическое бездействие уменьшает стоимость вашей услуги, так как вам не начисляется плата за вычислительные ресурсы, когда услуга приостановлена.

:::note
В некоторых особых случаях, например, когда у услуги много частей, услуга не будет автоматически приостановлена.

Услуга может войти в бесконечное состояние, где она приостанавливает обновление [обновляемых материализованных представлений](/materialized-view/refreshable-materialized-view), потребление из [S3Queue](/engines/table-engines/integrations/s3queue) и планирование новых слияний. Существующие операции слияния завершатся до перехода услуги в состояние бездействия. Чтобы обеспечить непрерывную работу обновляемых материализованных представлений и потребления из S3Queue, отключите функциональность состояния бездействия.
:::

:::danger Когда не использовать автоматическое бездействие
Используйте автоматическое бездействие только если ваш случай использования может выдержать задержку перед ответом на запросы, потому что когда услуга приостановлена, подключения к услуге будут истекать. Автоматическое бездействие идеально подходит для услуг, которые используются редко и где задержка может быть принята. Это не рекомендуется для услуг, которые обеспечивают функции, часто используемые клиентами.
:::

## Обработка всплесков нагрузки {#handling-bursty-workloads}
Если у вас ожидается резкий рост нагрузки, вы можете использовать 
[ClickHouse Cloud API](/cloud/manage/api/services-api-reference.md) для предварительного масштабирования вашей услуги, чтобы справиться с всплеском, и уменьшить масштаб, как только спрос снизится. Чтобы понять текущее количество ядер CPU и использование памяти для каждой из ваших реплик, вы можете выполнить следующий запрос:

```sql
SELECT *
FROM clusterAllReplicas('default', view(
    SELECT
        hostname() AS server,
        anyIf(value, metric = 'CGroupMaxCPU') AS cpu_cores,
        formatReadableSize(anyIf(value, metric = 'CGroupMemoryTotal')) AS memory
    FROM system.asynchronous_metrics
))
ORDER BY server ASC
SETTINGS skip_unavailable_shards = 1
```
