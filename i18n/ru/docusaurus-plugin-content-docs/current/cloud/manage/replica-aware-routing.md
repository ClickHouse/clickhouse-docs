---
title: 'Маршрутизация с учетом реплик'
slug: /manage/replica-aware-routing
description: 'Как использовать маршрутизацию с учетом реплик для увеличения повторного использования кэша'
keywords: ['cloud', 'sticky endpoints', 'sticky', 'endpoints', 'sticky routing', 'routing', 'replica aware routing']
---


# Маршрутизация с учетом реплик (частный просмотр)

Маршрутизация с учетом реплик (также известная как "липкие сессии", "липкая маршрутизация" или "сессионная аффинность") использует [балансировку нагрузки по круговому хешу прокси-сервера Envoy](https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/load_balancers#ring-hash). Основная цель маршрутизации с учетом реплик - увеличить вероятность повторного использования кэша. Она не гарантирует изоляцию.

При включении маршрутизации с учетом реплик для службы мы разрешаем использование поддомена с подстановочным знаком на основе имени хоста службы. Для службы с именем хоста `abcxyz123.us-west-2.aws.clickhouse.cloud` вы можете использовать любое имя хоста, которое соответствует `*.sticky.abcxyz123.us-west-2.aws.clickhouse.cloud`, чтобы посетить службу:

| Примеры имен хостов |
|---|
| `aaa.sticky.abcxyz123.us-west-2.aws.clickhouse.cloud` |
| `000.sticky.abcxyz123.us-west-2.aws.clickhouse.cloud` |
| `clickhouse-is-the-best.sticky.abcxyz123.us-west-2.aws.clickhouse.cloud` |

Когда Envoy получает имя хоста, соответствующее такому шаблону, он вычисляет хеш маршрутизации на основе имени хоста и находит соответствующий сервер ClickHouse на кольцевом хеше на основе вычисленного хеша. Предполагая, что нетongoing изменений в службе (например, перезапуски серверов, горизонтальное масштабирование), Envoy всегда будет выбирать один и тот же сервер ClickHouse для подключения.

Обратите внимание, что оригинальное имя хоста по-прежнему будет использовать балансировку нагрузки `LEAST_CONNECTION`, которая является алгоритмом маршрутизации по умолчанию.

## Ограничения маршрутизации с учетом реплик {#limitations-of-replica-aware-routing}

### Маршрутизация с учетом реплик не гарантирует изоляцию {#replica-aware-routing-does-not-guarantee-isolation}

Любое нарушение работы службы, например, перезапуски серверов (по любым причинам, таким как обновление версии, сбой, вертикальное масштабирование и т.д.), масштабирование серверов вверх/вниз, приведет к нарушениям в кольце хеша маршрутизации. Это приведет к тому, что соединения с одним и тем же именем хоста будут направляться на другой сервер.

### Маршрутизация с учетом реплик не работает "из коробки" с частной ссылкой {#replica-aware-routing-does-not-work-out-of-the-box-with-private-link}

Клиентам необходимо вручную добавить запись DNS, чтобы сделать разрешение имен работоспособным для нового шаблона имени хоста. Это может привести к дисбалансу нагрузки на сервер, если клиенты используют это неправильно.

## Настройка маршрутизации с учетом реплик {#configuring-replica-aware-routing}

Чтобы включить маршрутизацию с учетом реплик, пожалуйста, свяжитесь с [нашей службой поддержки](https://clickhouse.com/support).
