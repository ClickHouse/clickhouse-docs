---
'title': 'Replica-aware Routing'
'slug': '/manage/replica-aware-routing'
'description': 'Как использовать Replica-aware routing для увеличения повторного использования
  кеша'
'keywords':
- 'cloud'
- 'sticky endpoints'
- 'sticky'
- 'endpoints'
- 'sticky routing'
- 'routing'
- 'replica aware routing'
'doc_type': 'guide'
---
import PrivatePreviewBadge from '@theme/badges/PrivatePreviewBadge';


# Маршрутизация с учетом реплик

<PrivatePreviewBadge/>

Маршрутизация с учетом реплик (также известная как липкие сессии, липкая маршрутизация или аффинность сессий) использует [балансировку нагрузки с кольцевым хешированием прокси Envoy](https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/load_balancers#ring-hash). Главная цель маршрутизации с учетом реплик — увеличить вероятность повторного использования кеша. Она не гарантирует изоляцию.

При включении маршрутизации с учетом реплик для сервиса мы разрешаем использование поддомена с подстановочным знаком поверх имени хоста сервиса. Для сервиса с именем хоста `abcxyz123.us-west-2.aws.clickhouse.cloud` вы можете использовать любое имя хоста, которое соответствует `*.sticky.abcxyz123.us-west-2.aws.clickhouse.cloud`, чтобы получить доступ к сервису:

| Примеры имен хостов |
|---|
| `aaa.sticky.abcxyz123.us-west-2.aws.clickhouse.cloud` |
| `000.sticky.abcxyz123.us-west-2.aws.clickhouse.cloud` |
| `clickhouse-is-the-best.sticky.abcxyz123.us-west-2.aws.clickhouse.cloud` |

Когда Envoy получает имя хоста, которое соответствует такому шаблону, он вычисляет хеш маршрутизации на основе имени хоста и находит соответствующий сервер ClickHouse на хеш-кольце на основе вычисленного хеша. При условии, что нет текущих изменений в сервисе (например, перезапуск серверов, увеличение/уменьшение масштабов), Envoy всегда будет выбирать один и тот же сервер ClickHouse для подключения.

Обратите внимание, что оригинальное имя хоста будет продолжать использовать балансировку нагрузки по принципу `LEAST_CONNECTION`, что является алгоритмом маршрутизации по умолчанию.

## Ограничения маршрутизации с учетом реплик {#limitations-of-replica-aware-routing}

### Маршрутизация с учетом реплик не гарантирует изоляцию {#replica-aware-routing-does-not-guarantee-isolation}

Любое нарушение работы сервиса, например, перезапуски подов серверов (по любой причине, такой как обновление версии, сбой, вертикальное масштабирование и т.д.), увеличение/уменьшение сервера, приведет к нарушению хеш-кольца маршрутизации. Это приведет к тому, что соединения с одним и тем же именем хоста будут направлены на другой под сервера.

### Маршрутизация с учетом реплик не работает из коробки с частной связью {#replica-aware-routing-does-not-work-out-of-the-box-with-private-link}

Клиентам нужно вручную добавить DNS-запись, чтобы разрешение имен работало для нового шаблона имени хоста. Это может вызвать дисбаланс в нагрузке на сервер, если клиенты используют это неправильно.

## Настройка маршрутизации с учетом реплик {#configuring-replica-aware-routing}

Чтобы включить маршрутизацию с учетом реплик, пожалуйста, свяжитесь с [нашей службой поддержки](https://clickhouse.com/support/program).