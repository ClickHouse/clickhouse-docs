---
sidebar_position: 1
sidebar_label: 'Автоматическое масштабирование'
slug: /manage/scaling
description: 'Настройка автоматического масштабирования в ClickHouse Cloud'
keywords: ['autoscaling', 'auto scaling', 'scaling', 'horizontal', 'vertical', 'bursts']
title: 'Автоматическое масштабирование'
doc_type: 'guide'
---

import Image from '@theme/IdealImage';
import auto_scaling from '@site/static/images/cloud/manage/AutoScaling.png';
import scaling_patch_request from '@site/static/images/cloud/manage/scaling-patch-request.png';
import scaling_patch_response from '@site/static/images/cloud/manage/scaling-patch-response.png';
import scaling_configure from '@site/static/images/cloud/manage/scaling-configure.png';
import scaling_memory_allocation from '@site/static/images/cloud/manage/scaling-memory-allocation.png';
import ScalePlanFeatureBadge from '@theme/badges/ScalePlanFeatureBadge'


# Автоматическое масштабирование

Масштабирование — это возможность изменять доступные ресурсы в соответствии с потребностями клиентов. Сервисы уровней Scale и Enterprise (со стандартным профилем 1:4) могут масштабироваться по горизонтали программно, вызывая API, или путём изменения настроек в пользовательском интерфейсе для корректировки системных ресурсов. Эти сервисы также могут **автоматически масштабироваться по вертикали** в соответствии с потребностями приложения.

<ScalePlanFeatureBadge feature="Automatic vertical scaling"/>

:::note
Уровни Scale и Enterprise поддерживают как одно-, так и многорепликовые сервисы, тогда как уровень Basic поддерживает только однорепликовые сервисы. Однорепликовые сервисы имеют фиксированный размер и не поддерживают вертикальное или горизонтальное масштабирование. Пользователи могут перейти на уровень Scale или Enterprise, чтобы масштабировать свои сервисы.
:::



## Как работает масштабирование в ClickHouse Cloud {#how-scaling-works-in-clickhouse-cloud}

В настоящее время ClickHouse Cloud поддерживает вертикальное автомасштабирование и ручное горизонтальное масштабирование для сервисов уровня Scale.

Для сервисов уровня Enterprise масштабирование работает следующим образом:

- **Горизонтальное масштабирование**: Ручное горизонтальное масштабирование доступно для всех стандартных и пользовательских профилей на уровне Enterprise.
- **Вертикальное масштабирование**:
  - Стандартные профили (1:4) поддерживают вертикальное автомасштабирование.
  - Пользовательские профили (`highMemory` и `highCPU`) не поддерживают вертикальное автомасштабирование или ручное вертикальное масштабирование. Однако эти сервисы можно масштабировать вертикально, обратившись в службу поддержки.

:::note
Масштабирование в ClickHouse Cloud выполняется по принципу, который мы называем ["Make Before Break" (MBB)](/cloud/features/mbb).
Этот подход предполагает добавление одной или нескольких реплик нового размера перед удалением старых реплик, что предотвращает потерю производительности во время операций масштабирования.
Устраняя разрыв между удалением существующих реплик и добавлением новых, MBB обеспечивает более плавный и менее разрушительный процесс масштабирования.
Это особенно полезно в сценариях увеличения масштаба, когда высокая загрузка ресурсов требует дополнительных мощностей, поскольку преждевременное удаление реплик только усугубит нехватку ресурсов.
В рамках этого подхода мы ожидаем до одного часа, чтобы дать возможность завершиться всем выполняющимся запросам на старых репликах перед их удалением.
Это обеспечивает баланс между необходимостью завершения существующих запросов и предотвращением чрезмерно долгого сохранения старых реплик.

Обратите внимание, что в рамках этого изменения:

1. Исторические данные системных таблиц сохраняются максимум в течение 30 дней в рамках событий масштабирования. Кроме того, любые данные системных таблиц старше 19 декабря 2024 года для сервисов на AWS или GCP и старше 14 января 2025 года для сервисов на Azure не будут сохранены в рамках миграции на новые уровни организации.
2. Для сервисов, использующих TDE (прозрачное шифрование данных), данные системных таблиц в настоящее время не сохраняются после операций MBB. Мы работаем над устранением этого ограничения.
   :::

### Вертикальное автомасштабирование {#vertical-auto-scaling}

<ScalePlanFeatureBadge feature='Automatic vertical scaling' />

Сервисы Scale и Enterprise поддерживают автомасштабирование на основе использования CPU и памяти. Мы постоянно отслеживаем историческое использование сервиса в окне наблюдения (охватывающем последние 30 часов) для принятия решений о масштабировании. Если использование превышает или опускается ниже определенных пороговых значений, мы соответствующим образом масштабируем сервис в соответствии с потребностями.

Для сервисов без MBB автомасштабирование на основе CPU активируется, когда использование CPU превышает верхний порог в диапазоне 50-75% (фактический порог зависит от размера кластера). В этот момент выделение CPU для кластера удваивается. Если использование CPU падает ниже половины верхнего порога (например, до 25% при верхнем пороге 50%), выделение CPU уменьшается вдвое.

Для сервисов, уже использующих подход масштабирования MBB, увеличение масштаба происходит при пороге CPU 75%, а уменьшение масштаба — при половине этого порога, то есть 37,5%.

Автомасштабирование на основе памяти масштабирует кластер до 125% от максимального использования памяти или до 150%, если возникают ошибки OOM (нехватка памяти).

Выбирается **большее** из значений рекомендаций по CPU или памяти, и CPU и память, выделенные сервису, масштабируются синхронными приращениями по `1` CPU и `4 ГиБ` памяти.

### Настройка вертикального автомасштабирования {#configuring-vertical-auto-scaling}

Масштабирование сервисов ClickHouse Cloud Scale или Enterprise может быть настроено членами организации с ролью **Admin**. Чтобы настроить вертикальное автомасштабирование, перейдите на вкладку **Settings** для вашего сервиса и настройте минимальную и максимальную память вместе с настройками CPU, как показано ниже.

:::note
Сервисы с одной репликой не могут быть масштабированы на всех уровнях.
:::

<Image img={auto_scaling} size='lg' alt='Страница настроек масштабирования' border />

Установите **Maximum memory** для ваших реплик на значение выше, чем **Minimum memory**. Сервис будет масштабироваться по мере необходимости в этих пределах. Эти настройки также доступны во время первоначального процесса создания сервиса. Каждой реплике в вашем сервисе будут выделены одинаковые ресурсы памяти и CPU.

Вы также можете установить эти значения одинаковыми, фактически «закрепив» сервис на определенной конфигурации. Это немедленно принудительно масштабирует сервис до выбранного вами размера.

Важно отметить, что это отключит любое автомасштабирование на кластере, и ваш сервис не будет защищен от увеличения использования CPU или памяти сверх этих настроек.

:::note
Для сервисов уровня Enterprise стандартные профили 1:4 поддерживают вертикальное автомасштабирование.
Пользовательские профили не поддерживают вертикальное автомасштабирование или ручное вертикальное масштабирование при запуске.
Однако эти сервисы можно масштабировать вертикально, обратившись в службу поддержки.
:::


## Ручное горизонтальное масштабирование {#manual-horizontal-scaling}

<ScalePlanFeatureBadge feature='Manual horizontal scaling' />

Вы можете использовать [публичные API](https://clickhouse.com/docs/cloud/manage/api/swagger#/paths/~1v1~1organizations~1:organizationId~1services~1:serviceId~1scaling/patch) ClickHouse Cloud для масштабирования сервиса путем обновления настроек масштабирования или изменения количества реплик через облачную консоль.

Тарифы **Scale** и **Enterprise** также поддерживают сервисы с одной репликой. Сервисы, которые были масштабированы, можно уменьшить до минимума в одну реплику. Обратите внимание, что сервисы с одной репликой имеют пониженную доступность и не рекомендуются для использования в production-окружении.

:::note
Сервисы могут масштабироваться горизонтально до максимум 20 реплик. Если вам требуется больше реплик, обратитесь в службу поддержки.
:::

### Горизонтальное масштабирование через API {#horizontal-scaling-via-api}

Для горизонтального масштабирования кластера выполните `PATCH`-запрос через API для изменения количества реплик. Скриншоты ниже показывают вызов API для масштабирования кластера с `3` реплик до `6` реплик и соответствующий ответ.

<Image
  img={scaling_patch_request}
  size='lg'
  alt='PATCH-запрос для масштабирования'
  border
/>

_`PATCH`-запрос для обновления `numReplicas`_

<Image
  img={scaling_patch_response}
  size='md'
  alt='Ответ на PATCH-запрос масштабирования'
  border
/>

_Ответ на `PATCH`-запрос_

Если вы отправите новый запрос на масштабирование или несколько последовательных запросов, пока один уже выполняется, сервис масштабирования проигнорирует промежуточные состояния и сойдется к итоговому количеству реплик.

### Горизонтальное масштабирование через UI {#horizontal-scaling-via-ui}

Для горизонтального масштабирования сервиса через UI вы можете изменить количество реплик для сервиса на странице **Settings**.

<Image
  img={scaling_configure}
  size='md'
  alt='Настройки конфигурации масштабирования'
  border
/>

_Настройки масштабирования сервиса в консоли ClickHouse Cloud_

После масштабирования сервиса панель метрик в облачной консоли должна показать корректное распределение ресурсов для сервиса. Скриншот ниже показывает кластер, масштабированный до общей памяти `96 GiB`, что составляет `6` реплик, каждая с выделением памяти `16 GiB`.

<Image
  img={scaling_memory_allocation}
  size='md'
  alt='Распределение памяти при масштабировании'
  border
/>


## Автоматический переход в режим простоя {#automatic-idling}

На странице **Settings** вы также можете выбрать, разрешить ли автоматический переход вашего сервиса в режим простоя при отсутствии активности, как показано на изображении выше (т. е. когда сервис не выполняет запросы, отправленные пользователями). Автоматический переход в режим простоя снижает стоимость вашего сервиса, поскольку вычислительные ресурсы не тарифицируются, когда сервис приостановлен.

:::note
В некоторых особых случаях, например, когда сервис имеет большое количество партов, он не будет автоматически переведен в режим простоя.

Сервис может перейти в режим простоя, при котором приостанавливается обновление [обновляемых материализованных представлений](/materialized-view/refreshable-materialized-view), потребление данных из [S3Queue](/engines/table-engines/integrations/s3queue) и планирование новых слияний. Существующие операции слияния будут завершены до перехода сервиса в режим простоя. Чтобы обеспечить непрерывную работу обновляемых материализованных представлений и потребление данных из S3Queue, отключите функцию режима простоя.
:::

:::danger Когда не следует использовать автоматический переход в режим простоя
Используйте автоматический переход в режим простоя только в том случае, если ваш сценарий использования допускает задержку перед ответом на запросы, поскольку при приостановке сервиса соединения с ним будут прерываться по таймауту. Автоматический переход в режим простоя идеально подходит для сервисов, которые используются нечасто и где задержка допустима. Он не рекомендуется для сервисов, обеспечивающих работу пользовательских функций, которые используются часто.
:::


## Обработка пиковых нагрузок {#handling-bursty-workloads}

Если вы ожидаете пиковую нагрузку, вы можете использовать
[ClickHouse Cloud API](/cloud/manage/api/api-overview) для
упреждающего масштабирования сервиса, чтобы справиться с пиковой нагрузкой, и уменьшить его масштаб после
снижения спроса.

Чтобы узнать текущее количество ядер CPU и объем используемой памяти для
каждой из ваших реплик, выполните следующий запрос:

```sql
SELECT *
FROM clusterAllReplicas('default', view(
    SELECT
        hostname() AS server,
        anyIf(value, metric = 'CGroupMaxCPU') AS cpu_cores,
        formatReadableSize(anyIf(value, metric = 'CGroupMemoryTotal')) AS memory
    FROM system.asynchronous_metrics
))
ORDER BY server ASC
SETTINGS skip_unavailable_shards = 1
```
