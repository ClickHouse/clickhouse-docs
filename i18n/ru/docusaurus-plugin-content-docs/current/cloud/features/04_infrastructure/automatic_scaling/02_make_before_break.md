---
sidebar_position: 1
sidebar_label: 'Make Before Break (MBB)'
slug: /cloud/features/mbb
description: 'Страница, описывающая операции Make Before Break (MBB) в ClickHouse Cloud'
keywords: ['Make Before Break', 'MBB', 'Scaling', 'ClickHouse Cloud']
title: 'Операции Make Before Break (MBB) в ClickHouse Cloud'
doc_type: 'guide'
---

import Image from '@theme/IdealImage';
import mbb_diagram from '@site/static/images/cloud/features/mbb/vertical_scaling.png';

ClickHouse Cloud выполняет обновления и масштабирование кластеров с использованием подхода **Make Before Break** (MBB).
В рамках этого подхода новые реплики добавляются в кластер до удаления из него старых.
Это отличается от подхода break-first, при котором старые реплики сначала удаляются, а затем добавляются новые.

Подход MBB имеет несколько преимуществ:

* Поскольку емкость добавляется в кластер до удаления, **суммарная емкость кластера не уменьшается**, в отличие от подхода break-first. Разумеется, в облачной среде по‑прежнему могут происходить незапланированные события, такие как сбои узлов или дисков и т. п.
* Этот подход особенно полезен в ситуациях, когда кластер находится под высокой нагрузкой, поскольку он **предотвращает перегрузку существующих реплик**, как это могло бы произойти при подходе break-first.
* Поскольку реплики можно быстро добавлять, не дожидаясь предварительного удаления других реплик, этот подход обеспечивает **более быстрое и отзывчивое** масштабирование.

На изображении ниже показано, как это может выглядеть для кластера с 3 репликами при вертикальном масштабировании сервиса:

<Image img={mbb_diagram} size="lg" alt="Пример диаграммы для кластера с 3 репликами, который вертикально масштабируется" />

В целом MBB обеспечивает более плавный и менее нарушающий работу процесс масштабирования и обновления по сравнению с ранее использовавшимся подходом break-first.

При использовании MBB есть несколько ключевых особенностей, о которых пользователям необходимо знать:

1. Операции MBB ожидают завершения текущих рабочих нагрузок на существующих репликах перед их остановкой.
   В настоящее время этот период составляет 1 час, что означает, что масштабирование или обновление могут ждать до одного часа завершения длительно выполняющегося запроса на реплике, прежде чем реплика будет удалена.
   Кроме того, если на реплике выполняется процесс резервного копирования, ему дают завершиться перед тем, как реплика будет остановлена.
2. Из‑за того, что перед остановкой реплики есть время ожидания, могут возникать ситуации, когда в кластере оказывается больше реплик, чем максимально задано для кластера.
   Например, у вас может быть сервис с 6 репликами, но при выполнении операции MBB в кластер могут быть добавлены еще 3 реплики, что приведет к общему числу 9 реплик, пока старые реплики все еще обслуживают запросы.
   Это означает, что в течение некоторого времени в кластере будет больше, чем требуемое число реплик.
   Кроме того, несколько операций MBB могут перекрываться, что приводит к накоплению реплик. Это может произойти, например, в сценариях, когда в кластер через API отправляется несколько запросов на вертикальное масштабирование.
   В ClickHouse Cloud предусмотрены проверки, ограничивающие число реплик, которое может накопиться в кластере.
3. При операциях MBB данные системных таблиц сохраняются в течение 30 дней. Это означает, что каждый раз, когда операция MBB выполняется в кластере, данные системных таблиц за 30 дней реплицируются со старых реплик на новые.

Если вы хотите подробнее узнать о механизме работы операций MBB, ознакомьтесь с этой [публикацией в блоге](https://clickhouse.com/blog/make-before-break-faster-scaling-mechanics-for-clickhouse-cloud) от команды инженеров ClickHouse.
