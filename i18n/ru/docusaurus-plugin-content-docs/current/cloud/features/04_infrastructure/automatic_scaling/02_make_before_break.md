---
sidebar_position: 1
sidebar_label: 'Переключение без простоя (Make Before Break, MBB)'
slug: /cloud/features/mbb
description: 'Страница, описывающая операции Make Before Break (MBB) в ClickHouse Cloud'
keywords: ['Make Before Break', 'MBB', 'Масштабирование', 'ClickHouse Cloud']
title: 'Операции Make Before Break (MBB) в ClickHouse Cloud'
doc_type: 'guide'
---

import Image from '@theme/IdealImage';
import mbb_diagram from '@site/static/images/cloud/features/mbb/vertical_scaling.png';

ClickHouse Cloud выполняет обновления и масштабирование кластеров, используя подход **Make Before Break** (MBB).
При таком подходе новые реплики добавляются в кластер до удаления из него старых реплик.
Это противоположно подходу break-first, при котором старые реплики сначала удаляются, а уже затем добавляются новые.

Подход MBB имеет несколько преимуществ:

* Поскольку емкость добавляется в кластер до удаления, **общая емкость кластера не уменьшается**, в отличие от подхода break-first. Разумеется, в облачной среде по-прежнему могут происходить незапланированные события, такие как сбои узлов, дисков и т. д.
* Этот подход особенно полезен в ситуациях, когда кластер находится под высокой нагрузкой, поскольку он **предотвращает перегрузку существующих реплик**, что могло бы произойти при использовании подхода break-first.
* Поскольку реплики можно добавлять быстро, без ожидания предварительного удаления старых реплик, этот подход обеспечивает **более быстрое и отзывчивое** масштабирование.

Изображение ниже показывает, как это может происходить для кластера с 3 репликами, где сервис масштабируется вертикально:

<Image img={mbb_diagram} size="lg" alt="Пример диаграммы для кластера с 3 репликами, который вертикально масштабируется" />

В целом, MBB обеспечивает более плавное масштабирование и обновление с меньшими перебоями по сравнению с ранее используемым подходом break-first.

При использовании MBB есть несколько ключевых особенностей, о которых пользователям необходимо знать:

1. Операции MBB ожидают завершения существующих рабочих нагрузок на текущих репликах до их остановки.
   В настоящее время этот период установлен в 1 час, что означает, что масштабирование или обновление могут ждать до одного часа завершения долго выполняющегося запроса на реплике, прежде чем реплика будет удалена.
   Кроме того, если на реплике выполняется процесс резервного копирования, ему дается возможность завершиться до того, как реплика будет остановлена.
2. Из-за того, что перед остановкой реплики есть время ожидания, могут возникать ситуации, когда в кластере оказывается больше реплик, чем максимальное количество, заданное для кластера.
   Например, у вас может быть сервис всего с 6 репликами, но при выполняющейся операции MBB в кластер могут быть добавлены еще 3 реплики, что приведет к общему количеству 9 реплик, в то время как старые реплики все еще обслуживают запросы.
   Это означает, что в течение некоторого времени кластер будет иметь больше, чем желаемое количество реплик.
   Кроме того, несколько операций MBB могут пересекаться между собой, что приводит к накоплению реплик. Это может происходить, например, в сценариях, когда через API в кластер отправляется несколько запросов на вертикальное масштабирование.
   В ClickHouse Cloud предусмотрены проверки, ограничивающие количество реплик, которое может накопить кластер.
3. При операциях MBB данные системных таблиц хранятся в течение 30 дней. Это означает, что каждый раз, когда в кластере выполняется операция MBB, данные системных таблиц за 30 дней реплицируются со старых реплик на новые.

Если вы хотите подробнее узнать о механизмах операций MBB, ознакомьтесь с этой [публикацией в блоге](https://clickhouse.com/blog/make-before-break-faster-scaling-mechanics-for-clickhouse-cloud) от инженерной команды ClickHouse.
