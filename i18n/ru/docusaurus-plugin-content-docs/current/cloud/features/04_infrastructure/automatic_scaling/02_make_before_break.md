---
sidebar_position: 1
sidebar_label: 'Make Before Break (MBB)'
slug: /cloud/features/mbb
description: 'Страница, описывающая операции Make Before Break (MBB) в ClickHouse Cloud'
keywords: ['Make Before Break', 'MBB', 'Scaling', 'ClickHouse Cloud']
title: 'Операции Make Before Break (MBB) в ClickHouse Cloud'
doc_type: 'guide'
---

import Image from '@theme/IdealImage';
import mbb_diagram from '@site/static/images/cloud/features/mbb/vertical_scaling.png';

ClickHouse Cloud выполняет обновления и масштабирование кластеров, используя подход **Make Before Break** (MBB).
В рамках этого подхода новые реплики добавляются в кластер до того, как из него будут удалены старые реплики.
В отличие от этого, при подходе break-first старые реплики сначала удаляются, а затем добавляются новые.

Подход MBB имеет несколько преимуществ:

* Поскольку емкость добавляется в кластер до удаления, **общая емкость кластера не уменьшается**, в отличие от подхода break-first. Разумеется, незапланированные события, такие как сбои узлов или дисков и т. п., по‑прежнему возможны в облачной среде.
* Этот подход особенно полезен в ситуациях, когда кластер работает под высокой нагрузкой, поскольку он **предотвращает перегрузку существующих реплик**, как это могло бы произойти при использовании подхода break-first.
* Поскольку реплики можно быстро добавлять, не дожидаясь предварительного удаления существующих, этот подход обеспечивает **более быстрое и отзывчивое** масштабирование.

На изображении ниже показано, как это может происходить для кластера с 3 репликами при вертикальном масштабировании сервиса:

<Image img={mbb_diagram} size="lg" alt="Пример схемы для кластера с 3 репликами, который вертикально масштабируется" />

В целом подход MBB обеспечивает более плавный и менее разрушительный процесс масштабирования и обновления по сравнению с ранее используемым подходом break-first.

При использовании MBB существуют некоторые ключевые особенности поведения, о которых пользователи должны знать:

1. Операции MBB ожидают завершения текущих рабочих нагрузок на существующих репликах перед их остановкой.
   В настоящее время этот период установлен в 1 час, что означает, что масштабирование или обновления могут ждать до одного часа завершения долго выполняющегося запроса на реплике, прежде чем реплика будет удалена.
   Кроме того, если на реплике запущен процесс резервного копирования, ему дают завершиться, прежде чем реплика будет остановлена.
2. Из‑за того, что перед завершением работы реплики предусмотрено время ожидания, возможны ситуации, когда кластер может временно иметь больше, чем максимальное количество реплик, заданное для кластера.
   Например, у вас может быть сервис с суммарно 6 репликами, но при выполняющейся операции MBB в кластер могут быть добавлены еще 3 реплики, что приведет к общему количеству 9 реплик, в то время как старые реплики все еще обрабатывают запросы.
   Это означает, что в течение некоторого периода времени кластер будет иметь больше, чем желаемое число реплик.
   Кроме того, несколько операций MBB могут пересекаться, что приводит к накоплению реплик. Это может происходить, например, в сценариях, когда через API в кластер отправляется несколько запросов на вертикальное масштабирование.
   В ClickHouse Cloud предусмотрены проверки, ограничивающие количество реплик, которое может накопить кластер.
3. При операциях MBB данные системных таблиц хранятся в течение 30 дней. Это означает, что при каждой операции MBB в кластере данные системных таблиц за 30 дней реплицируются со старых реплик на новые.

Если вы хотите узнать больше о механизмах операций MBB, ознакомьтесь с этой [публикацией в блоге](https://clickhouse.com/blog/make-before-break-faster-scaling-mechanics-for-clickhouse-cloud) от инженерной команды ClickHouse.
