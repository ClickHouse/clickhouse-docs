---
title: 'Хранилища данных'
slug: /cloud/reference/warehouses
keywords: ['compute separation', 'cloud', 'architecture', 'compute-compute', 'warehouse', 'warehouses', 'hydra']
description: 'Разделение вычислительных ресурсов в ClickHouse Cloud'
doc_type: 'reference'
---

import compute_1 from '@site/static/images/cloud/reference/compute-compute-1.png';
import compute_2 from '@site/static/images/cloud/reference/compute-compute-2.png';
import compute_3 from '@site/static/images/cloud/reference/compute-compute-3.png';
import compute_4 from '@site/static/images/cloud/reference/compute-compute-4.png';
import compute_5 from '@site/static/images/cloud/reference/compute-compute-5.png';
import compute_7 from '@site/static/images/cloud/reference/compute-compute-7.png';
import compute_8 from '@site/static/images/cloud/reference/compute-compute-8.png';
import Image from '@theme/IdealImage';


# Хранилища



## Что такое разделение вычислительных ресурсов? {#what-is-compute-compute-separation}

Разделение вычислительных ресурсов доступно для тарифов Scale и Enterprise.

Каждый сервис ClickHouse Cloud включает:

- Группу из двух или более узлов ClickHouse (или реплик) — это обязательное требование, но дочерние сервисы могут состоять из одной реплики.
- Конечную точку (или несколько конечных точек, созданных через консоль ClickHouse Cloud), которая представляет собой URL сервиса для подключения (например, `https://dv2fzne24g.us-east-1.aws.clickhouse.cloud:8443`).
- Папку объектного хранилища, где сервис хранит все данные и часть метаданных:

:::note
Дочерние одиночные сервисы могут масштабироваться вертикально, в отличие от одиночных родительских сервисов.
:::

<Image img={compute_1} size='md' alt='Текущий сервис в ClickHouse Cloud' />

<br />

_Рис. 1 — текущий сервис в ClickHouse Cloud_

Разделение вычислительных ресурсов позволяет создавать несколько групп вычислительных узлов, каждая из которых имеет собственную конечную точку и использует одну и ту же папку объектного хранилища, а значит, одни и те же таблицы, представления и т. д.

Каждая группа вычислительных узлов имеет собственную конечную точку, что позволяет выбирать, какой набор реплик использовать для ваших рабочих нагрузок. Для некоторых рабочих нагрузок достаточно одной реплики небольшого размера, тогда как другие могут требовать полной высокой доступности (HA) и сотен гигабайт памяти. Разделение вычислительных ресурсов также позволяет разделить операции чтения и записи, чтобы они не мешали друг другу:

<Image img={compute_2} size='md' alt='Разделение вычислительных ресурсов в ClickHouse Cloud' />

<br />

_Рис. 2 — разделение вычислительных ресурсов в ClickHouse Cloud_

Можно создавать дополнительные сервисы, которые используют те же данные, что и существующие сервисы, или создать совершенно новую конфигурацию с несколькими сервисами, использующими общие данные.


## Что такое хранилище? {#what-is-a-warehouse}

В ClickHouse Cloud _хранилище_ (warehouse) — это набор сервисов, которые используют общие данные.
Каждое хранилище имеет основной сервис (он создаётся первым) и дополнительные сервисы. Например, на скриншоте ниже показано хранилище "DWH Prod" с двумя сервисами:

- Основной сервис `DWH Prod`
- Дополнительный сервис `DWH Prod Subservice`

<Image
  img={compute_8}
  size='lg'
  alt='Пример хранилища с основным и дополнительными сервисами'
  background='white'
/>

<br />

_Рис. 3 — Пример хранилища_

Все сервисы в хранилище используют одинаковые:

- Регион (например, us-east1)
- Облачный провайдер (AWS, GCP или Azure)
- Версию базы данных ClickHouse

Вы можете сортировать сервисы по хранилищу, к которому они относятся.


## Управление доступом {#access-controls}

### Учетные данные базы данных {#database-credentials}

Поскольку все сервисы в хранилище используют один и тот же набор таблиц, они также используют общие механизмы управления доступом. Это означает, что все пользователи базы данных, созданные в Сервисе 1, смогут использовать Сервис 2 с теми же правами доступа (привилегиями на таблицы, представления и т. д.), и наоборот. Пользователи будут использовать разные конечные точки для каждого сервиса, но с одним и тем же именем пользователя и паролем. Другими словами, _пользователи являются общими для всех сервисов, работающих с одним и тем же хранилищем:_

<Image
  img={compute_3}
  size='md'
  alt='Доступ пользователей к сервисам, использующим общие данные'
/>

<br />

_Рис. 4 — пользователь Alice был создан в Сервисе 1, но она может использовать те же учетные данные для доступа ко всем сервисам, использующим общие данные_

### Управление сетевым доступом {#network-access-control}

Часто бывает полезно ограничить использование определенных сервисов другими приложениями или разовыми пользователями. Это можно сделать с помощью сетевых ограничений, аналогично тому, как это настраивается для обычных сервисов (перейдите в раздел **Settings** на вкладке сервиса в консоли ClickHouse Cloud).

Вы можете применить настройки фильтрации IP к каждому сервису отдельно, что позволяет контролировать, какое приложение может получить доступ к какому сервису. Это дает возможность ограничить доступ пользователей к определенным сервисам:

<Image img={compute_4} size='md' alt='Настройки управления сетевым доступом' />

<br />

_Рис. 5 — Alice ограничен доступ к Сервису 2 из-за сетевых настроек_

### Чтение и чтение-запись {#read-vs-read-write}

Иногда полезно ограничить доступ на запись к определенному сервису и разрешить запись только подмножеству сервисов в хранилище. Это можно сделать при создании второго и последующих сервисов (первый сервис всегда должен иметь доступ на чтение-запись):

<Image
  img={compute_5}
  size='lg'
  alt='Сервисы с доступом на чтение-запись и только на чтение в хранилище'
/>

<br />

_Рис. 6 — Сервисы с доступом на чтение-запись и только на чтение в хранилище_

:::note

1. Сервисы только для чтения в настоящее время разрешают операции управления пользователями (создание, удаление и т. д.). Это поведение может быть изменено в будущем.
2. В настоящее время обновляемые материализованные представления выполняются на всех сервисах в хранилище, включая сервисы только для чтения. Однако это поведение будет изменено в будущем, и они будут выполняться только на сервисах с доступом на чтение-запись.
   :::


## Масштабирование {#scaling}

Каждый сервис в хранилище можно настроить в соответствии с вашей рабочей нагрузкой по следующим параметрам:

- Количество узлов (реплик). Основной сервис (первый созданный сервис в хранилище) должен иметь не менее 2 узлов. Каждый дополнительный сервис может иметь 1 или более узлов.
- Размер узлов (реплик)
- Автоматическое масштабирование сервиса
- Переход сервиса в режим ожидания при неактивности (не применимо к первому сервису в группе — см. раздел **Ограничения**)


## Изменения в поведении {#changes-in-behavior}

После включения режима compute-compute для сервиса (при создании хотя бы одного вторичного сервиса) вызов функции `clusterAllReplicas()` с именем кластера `default` будет использовать только реплики сервиса, из которого выполнен вызов. Это означает, что если два сервиса подключены к одному набору данных и функция `clusterAllReplicas(default, system, processes)` вызывается из сервиса 1, будут показаны только процессы, запущенные на сервисе 1. При необходимости можно вызвать, например, `clusterAllReplicas('all_groups.default', system, processes)`, чтобы получить доступ ко всем репликам.


## Ограничения {#limitations}

1. **Основной сервис должен всегда работать и не может переводиться в режим простоя (это ограничение будет снято через некоторое время после GA).** Во время закрытого предварительного просмотра и некоторое время после GA основной сервис (обычно это существующий сервис, который вы хотите расширить, добавив другие сервисы) будет всегда работать, а настройка перехода в режим простоя будет отключена. Вы не сможете остановить или перевести в режим простоя основной сервис, если существует хотя бы один дополнительный сервис. После удаления всех дополнительных сервисов вы снова сможете остановить или перевести в режим простоя исходный сервис.

2. **Иногда рабочие нагрузки невозможно изолировать.** Хотя цель состоит в том, чтобы предоставить вам возможность изолировать рабочие нагрузки базы данных друг от друга, могут возникать пограничные случаи, когда одна рабочая нагрузка в одном сервисе будет влиять на другой сервис, использующий те же данные. Это довольно редкие ситуации, которые в основном связаны с OLTP-подобными рабочими нагрузками.

3. **Все сервисы с возможностью чтения и записи выполняют фоновые операции слияния.** При вставке данных в ClickHouse база данных сначала вставляет данные в промежуточные партиции, а затем выполняет слияния в фоновом режиме. Эти слияния могут потреблять память и ресурсы процессора. Когда два сервиса с возможностью чтения и записи используют одно и то же хранилище, они оба выполняют фоновые операции. Это означает, что может возникнуть ситуация, когда запрос `INSERT` выполняется в Сервисе 1, но операция слияния завершается Сервисом 2. Обратите внимание, что сервисы только для чтения не выполняют фоновые слияния и, следовательно, не расходуют свои ресурсы на эту операцию.

4. **Все сервисы с возможностью чтения и записи выполняют операции вставки движка таблиц S3Queue.** При создании таблицы S3Queue на сервисе с возможностью чтения и записи все остальные такие сервисы в хранилище могут выполнять чтение данных из S3 и запись данных в базу данных.

5. **Вставки в одном сервисе с возможностью чтения и записи могут препятствовать переходу другого такого сервиса в режим простоя, если режим простоя включён.** В результате второй сервис выполняет фоновые операции слияния для первого сервиса. Эти фоновые операции могут препятствовать переходу второго сервиса в спящий режим при простое. После завершения фоновых операций сервис будет переведён в режим простоя. Сервисы только для чтения не затрагиваются и будут переведены в режим простоя без задержки.

6. **Запросы CREATE/RENAME/DROP DATABASE по умолчанию могут быть заблокированы сервисами в режиме простоя или остановленными сервисами.** Эти запросы могут зависнуть. Чтобы обойти это, вы можете выполнять запросы управления базами данных с параметром `settings distributed_ddl_task_timeout=0` на уровне сессии или отдельного запроса. Например:

```sql
CREATE DATABASE db_test_ddl_single_query_setting
SETTINGS distributed_ddl_task_timeout=0
```

7. **В настоящее время существует мягкое ограничение в 5 сервисов на хранилище.** Свяжитесь со службой поддержки, если вам требуется более 5 сервисов в одном хранилище.


## Цены {#pricing}

Стоимость вычислительных ресурсов одинакова для всех сервисов в хранилище (первичных и вторичных). Хранилище оплачивается только один раз — оно включено в первый (исходный) сервис.

Воспользуйтесь калькулятором стоимости на странице [pricing](https://clickhouse.com/pricing), который поможет оценить затраты в зависимости от размера рабочей нагрузки и выбранного уровня.


## Резервные копии {#backups}

- Поскольку все сервисы в одном warehouse используют общее хранилище данных, резервные копии создаются только на основном (первичном) сервисе. Таким образом, в резервную копию включаются данные всех сервисов warehouse.
- При восстановлении резервной копии основного сервиса warehouse данные будут восстановлены в полностью новый сервис, не связанный с существующим warehouse. После завершения восстановления вы можете сразу добавить к нему дополнительные сервисы.


## Использование хранилищ {#using-warehouses}

### Создание хранилища {#creating-a-warehouse}

Чтобы создать хранилище, необходимо создать второй сервис, который будет совместно использовать данные с существующим сервисом. Это можно сделать, нажав на знак плюс рядом с любым из существующих сервисов:

<Image
  img={compute_7}
  size='md'
  alt='Создание нового сервиса в хранилище'
  border
  background='white'
/>

<br />

_Рис. 7 — Нажмите на знак плюс, чтобы создать новый сервис в хранилище_

На экране создания сервиса исходный сервис будет выбран в выпадающем списке в качестве источника данных для нового сервиса. После создания эти два сервиса образуют хранилище.

### Переименование хранилища {#renaming-a-warehouse}

Существует два способа переименовать хранилище:

- Можно выбрать «Сортировать по хранилищу» на странице сервисов в правом верхнем углу, а затем нажать на значок карандаша рядом с названием хранилища
- Можно нажать на название хранилища в любом из сервисов и переименовать хранилище там

### Удаление хранилища {#deleting-a-warehouse}

Удаление хранилища означает удаление всех вычислительных сервисов и данных (таблиц, представлений, пользователей и т. д.). Это действие невозможно отменить.
Удалить хранилище можно только путём удаления первого созданного сервиса. Для этого:

1. Удалите все сервисы, которые были созданы после первого сервиса;
2. Удалите первый сервис (предупреждение: все данные хранилища будут удалены на этом шаге).
