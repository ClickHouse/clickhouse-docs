---
slug: /cloud/data-resiliency
sidebar_label: 'Устойчивость данных'
title: 'Восстановление после аварий'
description: 'В этом руководстве приведён обзор восстановления после аварий.'
doc_type: 'reference'
keywords: ['ClickHouse Cloud', 'data resiliency', 'disaster recovery']
---

import Image from '@theme/IdealImage';
import restore_backup from '@site/static/images/cloud/guides/restore_backup.png';


# Устойчивость данных {#clickhouse-cloud-data-resiliency}

На этой странице представлены рекомендации по аварийному восстановлению для ClickHouse Cloud и руководство для клиентов по восстановлению после сбоев.
ClickHouse Cloud в настоящее время не поддерживает автоматическое переключение при отказе или автоматическую синхронизацию между географическими регионами.

:::tip
Клиентам рекомендуется периодически проводить тестирование восстановления из резервных копий, чтобы определить конкретное значение RTO для размера и конфигурации своего сервиса.
:::


## Определения {#definitions}

Для начала полезно рассмотреть некоторые определения.

**RPO (Recovery Point Objective, целевая точка восстановления)**: Максимально допустимая потеря данных, измеряемая во времени после сбойного события. Пример: RPO в 30 минут означает, что в случае сбоя база данных должна быть восстановлена до состояния не старше 30 минут. Это, разумеется, зависит от частоты создания резервных копий.

**RTO (Recovery Time Objective, целевое время восстановления)**: Максимально допустимое время простоя до возобновления нормальной работы после сбоя. Пример: RTO в 30 минут означает, что в случае сбоя команда должна восстановить данные и приложения и возобновить нормальную работу в течение 30 минут.

**Резервные копии и снимки базы данных**: Резервные копии обеспечивают надежное долгосрочное хранение с отдельной копией данных. Снимки не создают дополнительную копию данных, обычно выполняются быстрее и обеспечивают лучшие показатели RPO.


## Резервные копии баз данных {#database-backups}

Наличие резервной копии основного сервиса — это эффективный способ восстановления данных в случае его недоступности.
ClickHouse Cloud поддерживает следующие возможности резервного копирования.

1. **Резервные копии по умолчанию**

По умолчанию ClickHouse Cloud создаёт [резервную копию](/cloud/manage/backups) вашего сервиса каждые 24 часа.
Эти резервные копии хранятся в том же регионе, что и сервис, в хранилище CSP (поставщика облачных услуг) ClickHouse.
В случае повреждения данных в основном сервисе резервная копия может быть использована для восстановления в новый сервис.

2. **Внешние резервные копии (в собственном хранилище клиента)**

Клиенты уровня Enterprise могут [экспортировать резервные копии](/cloud/manage/backups/export-backups-to-own-cloud-account) в объектное хранилище в своей учётной записи — в том же регионе или в другом регионе.
Поддержка экспорта резервных копий между облачными провайдерами появится в ближайшее время.
Для межрегиональных и межоблачных резервных копий будут применяться соответствующие тарифы за передачу данных.

:::note
Эта функция в настоящее время недоступна для сервисов PCI/HIPAA
:::

3. **Настраиваемые резервные копии**

Клиенты могут [настроить резервное копирование](/cloud/manage/backups/configurable-backups) с более высокой частотой — до одного раза в 6 часов — для улучшения RPO.
Клиенты также могут настроить более длительный срок хранения.

Резервные копии, доступные в настоящее время для сервиса, перечислены на странице «Backups» в консоли ClickHouse Cloud.
В этом разделе также отображается статус успешного или неудачного выполнения для каждой резервной копии.


## Восстановление из резервной копии {#restoring-from-a-backup}

1. Резервные копии по умолчанию, хранящиеся в бакете ClickHouse Cloud, можно восстановить в новый сервис в том же регионе.
2. Внешние резервные копии (в объектном хранилище клиента) можно восстановить в новый сервис в том же или другом регионе.


## Рекомендации по продолжительности резервного копирования и восстановления {#backup-and-restore-duration-guidance}

Продолжительность резервного копирования и восстановления зависит от нескольких факторов, таких как размер базы данных, её схема и количество таблиц.

По результатам наших тестов резервное копирование небольших объёмов данных (~1 ТБ) занимает от 10 до 15 минут или больше.
Резервное копирование объёмов менее 20 ТБ обычно завершается в течение часа, а резервное копирование ~50 ТБ данных занимает 2–3 часа.
При больших объёмах достигается эффект масштаба, и мы наблюдали, что резервное копирование до 1 ПБ для некоторых внутренних сервисов завершается менее чем за 10 часов.

Рекомендуем провести тестирование на вашей собственной базе данных или тестовых данных для получения более точных оценок, поскольку фактическая продолжительность зависит от нескольких факторов, описанных выше.

Продолжительность восстановления сопоставима с продолжительностью резервного копирования для аналогичных объёмов.
Как упоминалось выше, рекомендуем провести тестирование на вашей собственной базе данных, чтобы понимать, сколько времени займёт восстановление из резервной копии.

:::note
В настоящее время НЕ поддерживается автоматическое переключение при отказе между двумя экземплярами ClickHouse Cloud независимо от того, находятся ли они в одном или разных регионах.
В настоящее время НЕ поддерживается автоматическая синхронизация данных между различными сервисами ClickHouse Cloud в одном или разных регионах, т. е. репликация Active-Active.
:::


## Процесс восстановления {#recovery-process}

В этом разделе описываются различные варианты восстановления и процесс, который следует выполнить в каждом случае.

### Повреждение данных основного сервиса {#primary-service-data-corruption}

В этом случае данные [можно восстановить](/cloud/manage/backups/overview#restore-a-backup) из резервной копии в другой сервис в том же регионе.
Резервная копия может иметь давность до 24 часов при использовании политики резервного копирования по умолчанию или до 6 часов (при использовании настраиваемых резервных копий с частотой 6 часов).

#### Шаги восстановления {#restoration-steps}

Чтобы восстановить данные из существующей резервной копии:

<VerticalStepper headerLevel="list">

1. Перейдите в раздел «Backups» консоли ClickHouse Cloud.
2. Нажмите на три точки в столбце «Actions» для конкретной резервной копии, из которой вы хотите восстановить данные.
3. Задайте новому сервису имя и выполните восстановление из этой резервной копии

<Image img={restore_backup} size='md' alt='Восстановление из резервной копии' />

</VerticalStepper>

### Недоступность основного региона {#primary-region-downtime}

Клиенты уровня Enterprise могут [экспортировать резервные копии](/cloud/manage/backups/export-backups-to-own-cloud-account) в собственное хранилище облачного провайдера.
Если вас беспокоят региональные сбои, мы рекомендуем экспортировать резервные копии в другой регион.
Имейте в виду, что будут применяться тарифы за межрегиональную передачу данных.

Если основной регион становится недоступным, резервную копию из другого региона можно восстановить в новый сервис в другом регионе.

После восстановления резервной копии в другой сервис необходимо убедиться, что все конфигурации DNS, балансировщика нагрузки или строк подключения обновлены и указывают на новый сервис.
Это может включать:

- Обновление переменных окружения или секретов
- Перезапуск служб приложений для установления новых соединений

:::note
Резервное копирование и восстановление во внешнее хранилище в настоящее время не поддерживается для сервисов, использующих [прозрачное шифрование данных (TDE)](/cloud/security/cmek#transparent-data-encryption-tde).
:::


## Дополнительные возможности {#additional-options}

Существует несколько дополнительных вариантов, которые стоит рассмотреть.

1. **Двойная запись в отдельные кластеры**

При использовании этого варианта можно настроить 2 отдельных кластера в разных регионах и выполнять двойную запись в оба кластера.
Этот вариант изначально связан с более высокими затратами, так как требует работы нескольких сервисов, но обеспечивает более высокую доступность в случае недоступности одного из регионов.

2. **Использование репликации облачного провайдера**

При использовании этого варианта применяется встроенная репликация объектного хранилища облачного провайдера для копирования данных.
Например, при использовании BYOB можно экспортировать резервную копию в бакет, принадлежащий вам в основном регионе, и реплицировать её в другой регион с помощью [межрегиональной репликации AWS](https://docs.aws.amazon.com/AmazonS3/latest/userguide/replication.html).
