---
slug: /changelogs/24.5
title: 'Журнал изменений v24.5 для Cloud'
description: 'Журнал изменений ускоренного релиза v24.5'
keywords: ['changelog', 'cloud']
sidebar_label: '24.5'
sidebar_position: 8
doc_type: 'changelog'
---



# Журнал изменений v24.5 для Cloud

Актуальные изменения в сервисах ClickHouse Cloud на основе релиза v24.5.



## Критические изменения {#breaking-changes}

- Изменено имя столбца с duration_ms на duration_microseconds в таблице system.zookeeper, чтобы отразить тот факт, что длительность измеряется с точностью до микросекунд. [#60774](https://github.com/ClickHouse/ClickHouse/pull/60774) (Duc Canh Le).

- Запрещена установка max_parallel_replicas в 0, так как это не имеет смысла. Установка этого значения в 0 может привести к неожиданным логическим ошибкам. Closes #60140. [#61201](https://github.com/ClickHouse/ClickHouse/pull/61201) (Kruglov Pavel).

- Удалена поддержка запроса INSERT WATCH (часть экспериментальной функции LIVE VIEW). [#62382](https://github.com/ClickHouse/ClickHouse/pull/62382) (Alexey Milovidov).

- Использование функций neighbor, runningAccumulate, runningDifferenceStartingWithFirstValue, runningDifference объявлено устаревшим (так как они подвержены ошибкам). Вместо них следует использовать оконные функции. Чтобы включить их обратно, установите allow_deprecated_error_prone_window_functions=1. [#63132](https://github.com/ClickHouse/ClickHouse/pull/63132) (Nikita Taranov).


## Обратно несовместимые изменения {#backward-incompatible-changes}

- В новой версии ClickHouse функции geoDistance, greatCircleDistance и greatCircleAngle будут использовать 64-битный тип данных с плавающей точкой двойной точности для внутренних вычислений и возвращаемого значения, если все аргументы имеют тип Float64. Это решает проблему #58476. В предыдущих версиях функция всегда использовала Float32. Вы можете вернуться к прежнему поведению, установив параметр geo_distance_returns_float64_on_float64_arguments в false или установив compatibility в значение 24.2 или более раннее. [#61848](https://github.com/ClickHouse/ClickHouse/pull/61848) (Alexey Milovidov).

- Запросы к system.columns будут выполняться быстрее при большом количестве столбцов, если для многих баз данных или таблиц не предоставлены права на SHOW TABLES. Обратите внимание, что в предыдущих версиях, если вы предоставляли права SHOW COLUMNS для отдельных столбцов без предоставления SHOW TABLES для соответствующих таблиц, таблица system.columns отображала эти столбцы, но в новой версии она будет полностью пропускать такую таблицу. Удалены трассировочные сообщения журнала «Access granted» и «Access denied», которые замедляли выполнение запросов. [#63439](https://github.com/ClickHouse/ClickHouse/pull/63439) (Alexey Milovidov).

- Исправлено аварийное завершение работы в функции largestTriangleThreeBuckets. Это изменяет поведение функции: теперь она игнорирует значения NaN в предоставленных рядах данных. Таким образом, результирующий набор может отличаться от результатов в предыдущих версиях. [#62646](https://github.com/ClickHouse/ClickHouse/pull/62646) (Raúl Marín).


## Новые возможности {#new-features}

- Новый анализатор включен по умолчанию для новых сервисов.

- Поддержка удаления нескольких таблиц одновременно, например `drop table a,b,c;`. [#58705](https://github.com/ClickHouse/ClickHouse/pull/58705) (zhongyuankai).

- Теперь можно обрабатывать CRLF в формате TSV с помощью настройки `input_format_tsv_crlf_end_of_line`. Закрывает #56257. [#59747](https://github.com/ClickHouse/ClickHouse/pull/59747) (Shaun Struwig).

- Движок таблиц теперь поддерживает выдачу привилегий, что не повлияет на поведение существующих пользователей. [#60117](https://github.com/ClickHouse/ClickHouse/pull/60117) (jsc0218).

- Добавлен формат Form для чтения/записи одной записи в формате `application/x-www-form-urlencoded`. [#60199](https://github.com/ClickHouse/ClickHouse/pull/60199) (Shaun Struwig).

- Добавлена возможность сжатия в `CROSS JOIN`. [#60459](https://github.com/ClickHouse/ClickHouse/pull/60459) (p1rattttt).

- Новая настройка `input_format_force_null_for_omitted_fields`, которая принудительно устанавливает значения `NULL` для пропущенных полей. [#60887](https://github.com/ClickHouse/ClickHouse/pull/60887) (Constantine Peresypkin).

- Поддержка соединений с условиями неравенства, включающими столбцы из обеих таблиц, например `t1.y < t2.y`. Для включения используйте `SET allow_experimental_join_condition = 1`. [#60920](https://github.com/ClickHouse/ClickHouse/pull/60920) (lgbo).

- Добавлена новая функция `getClientHTTPHeader`. Закрывает #54665. В соавторстве с @lingtaolf. [#61820](https://github.com/ClickHouse/ClickHouse/pull/61820) (Alexey Milovidov).

- Для удобства `SELECT * FROM numbers()` теперь работает так же, как `SELECT * FROM system.numbers` — без ограничения. [#61969](https://github.com/ClickHouse/ClickHouse/pull/61969) (YenchangChan).

- Теперь поддерживается изменение настроек таблиц Memory через `ALTER MODIFY SETTING`. Например: `ALTER TABLE memory MODIFY SETTING min_rows_to_keep = 100, max_rows_to_keep = 1000;`. [#62039](https://github.com/ClickHouse/ClickHouse/pull/62039) (zhongyuankai).

- Анализатор поддерживает рекурсивные CTE. [#62074](https://github.com/ClickHouse/ClickHouse/pull/62074) (Maksim Kita).

- Ранее хранилище S3 и табличная функция S3 не поддерживали выборку из архивных файлов. Реализовано решение, позволяющее перебирать файлы внутри архивов в S3. [#62259](https://github.com/ClickHouse/ClickHouse/pull/62259) (Daniil Ivanik).

- Поддержка функции `clamp`. [#62377](https://github.com/ClickHouse/ClickHouse/pull/62377) (skyoct).

- Добавлен выходной формат `npy`. [#62430](https://github.com/ClickHouse/ClickHouse/pull/62430) (豪肥肥).

- Анализатор поддерживает предложение `QUALIFY`. Закрывает #47819. [#62619](https://github.com/ClickHouse/ClickHouse/pull/62619) (Maksim Kita).

- Добавлен параметр запроса `role` в HTTP-интерфейс. Он работает аналогично `SET ROLE x`, применяя роль перед выполнением запроса. Это позволяет обойти ограничение HTTP-интерфейса, поскольку множественные запросы не разрешены, и невозможно отправить одновременно `SET ROLE x` и сам запрос. Таким образом можно установить несколько ролей, например `?role=x&role=y`, что будет эквивалентно `SET ROLE x, y`. [#62669](https://github.com/ClickHouse/ClickHouse/pull/62669) (Serge Klochkov).

- Добавлена команда `SYSTEM UNLOAD PRIMARY KEY`. [#62738](https://github.com/ClickHouse/ClickHouse/pull/62738) (Pablo Marcos).


* Добавлены SQL-функции `generateUUIDv7`, `generateUUIDv7ThreadMonotonic`, `generateUUIDv7NonMonotonic` (с разными компромиссами между монотонностью и производительностью) для генерации UUID версии 7, то есть UUID на основе временной метки со случайной компонентой. Также добавлена новая функция `UUIDToNum` для извлечения байт из UUID и новая функция `UUIDv7ToDateTime` для извлечения компоненты временной метки из UUID версии 7. [#62852](https://github.com/ClickHouse/ClickHouse/pull/62852) (Alexey Petrunyaka).

* `Raw` в качестве синонима для `TSVRaw`. [#63394](https://github.com/ClickHouse/ClickHouse/pull/63394) (Unalian).

* Добавлена возможность выполнять `CROSS JOIN` во временном файле, если размер превышает лимиты. [#63432](https://github.com/ClickHouse/ClickHouse/pull/63432) (p1rattttt).



## Улучшения производительности {#performance-improvements}

- Пропуск слияния вновь созданных блоков проекций во время INSERT-запросов. [#59405](https://github.com/ClickHouse/ClickHouse/pull/59405) (Nikita Taranov).

- Снижение накладных расходов мутаций для SELECT-запросов (v2). [#60856](https://github.com/ClickHouse/ClickHouse/pull/60856) (Azat Khuzhin).

- Улучшения проталкивания фильтров JOIN с использованием эквивалентных множеств. [#61216](https://github.com/ClickHouse/ClickHouse/pull/61216) (Maksim Kita).

- Добавлен новый проход анализатора для оптимизации одиночных значений в условиях IN. [#61564](https://github.com/ClickHouse/ClickHouse/pull/61564) (LiuNeng).

- Обработка строковых функций XXXUTF8 в режиме ASCII, если входные строки содержат только ASCII-символы. Вдохновлено apache/doris#29799. Общее ускорение в 1.07x~1.62x раз. Обратите внимание, что пиковое потребление памяти снижено в некоторых случаях. [#61632](https://github.com/ClickHouse/ClickHouse/pull/61632) (李扬).

- Быстрый кодировщик Parquet включен по умолчанию (output_format_parquet_use_custom_encoder). [#62088](https://github.com/ClickHouse/ClickHouse/pull/62088) (Michael Kolupaev).

- Улучшение JSONEachRowRowInputFormat за счет пропуска всех оставшихся полей после чтения всех обязательных полей. [#62210](https://github.com/ClickHouse/ClickHouse/pull/62210) (lgbo).

- Функции splitByChar и splitByRegexp значительно ускорены. [#62392](https://github.com/ClickHouse/ClickHouse/pull/62392) (李扬).

- Улучшение тривиальных INSERT SELECT из файлов в табличных функциях file/s3/hdfs/url/... Добавлена отдельная настройка max_parsing_threads для управления количеством потоков, используемых при параллельном парсинге. [#62404](https://github.com/ClickHouse/ClickHouse/pull/62404) (Kruglov Pavel).

- Поддержка параллельного буфера записи для AzureBlobStorage, управляемого настройкой azure_allow_parallel_part_upload. [#62534](https://github.com/ClickHouse/ClickHouse/pull/62534) (SmitaRKulkarni).

- Функции to_utc_timestamp и from_utc_timestamp теперь работают примерно в 2 раза быстрее. [#62583](https://github.com/ClickHouse/ClickHouse/pull/62583) (KevinyhZou).

- Функции parseDateTimeOrNull, parseDateTimeOrZero, parseDateTimeInJodaSyntaxOrNull и parseDateTimeInJodaSyntaxOrZero теперь работают значительно быстрее (в 10-1000 раз), когда входные данные содержат преимущественно не поддающиеся парсингу значения. [#62634](https://github.com/ClickHouse/ClickHouse/pull/62634) (LiuNeng).

- Изменено поведение HostResolver при сбое: теперь сохраняется только одна запись на IP-адрес. [#62652](https://github.com/ClickHouse/ClickHouse/pull/62652) (Anton Ivashkin).

- Добавлена новая настройка prefer_merge_sort_block_bytes для управления использованием памяти и ускорения сортировки в 2 раза при слиянии данных с большим количеством столбцов. [#62904](https://github.com/ClickHouse/ClickHouse/pull/62904) (LiuNeng).

- Оптимизация QueryPlan: преобразование OUTER JOIN в INNER JOIN, если фильтр после JOIN всегда отфильтровывает значения по умолчанию. Оптимизация управляется настройкой query_plan_convert_outer_join_to_inner_join, включена по умолчанию. [#62907](https://github.com/ClickHouse/ClickHouse/pull/62907) (Maksim Kita).

- Настройка optimize_rewrite_sum_if_to_count_if включена по умолчанию. [#62929](https://github.com/ClickHouse/ClickHouse/pull/62929) (Raúl Marín).

- Микрооптимизации для нового анализатора. [#63429](https://github.com/ClickHouse/ClickHouse/pull/63429) (Raúl Marín).

- Анализ индексов теперь работает при сравнении DateTime с DateTime64. Это закрывает #63441. [#63443](https://github.com/ClickHouse/ClickHouse/pull/63443) (Alexey Milovidov).

- Небольшое ускорение индексов типа set (примерно в 1.5 раза) за счет удаления мусора. [#64098](https://github.com/ClickHouse/ClickHouse/pull/64098) (Alexey Milovidov).


# Улучшения

* Удалена настройка `optimize_monotonous_functions_in_order_by`, так как она по сути стала no-op. [#63004](https://github.com/ClickHouse/ClickHouse/pull/63004) (Raúl Marín).

* Тип `Map` теперь может иметь в качестве ключей `Float32`, `Float64`, `Array(T)`, `Map(K,V)` и `Tuple(T1, T2, ...)`. Закрывает #54537. [#59318](https://github.com/ClickHouse/ClickHouse/pull/59318) (李扬).

* Добавлен асинхронный `WriteBuffer` для `AzureBlobStorage`, аналогично `S3`. [#59929](https://github.com/ClickHouse/ClickHouse/pull/59929) (SmitaRKulkarni).

* Добавлена поддержка многострочных строк с сохранением границ и изменением ширины столбцов. [#59940](https://github.com/ClickHouse/ClickHouse/pull/59940) (Volodyachan).

* Реализовано, чтобы `RabbitMQ` отправлял nack для повреждённых сообщений. Закрывает #45350. [#60312](https://github.com/ClickHouse/ClickHouse/pull/60312) (Kseniia Sumarokova).

* Добавлена настройка `first_day_of_week`, которая определяет, какой день недели считается первым для функций `toStartOfInterval(..., INTERVAL ... WEEK)`. Это позволяет обеспечить согласованность с функцией `toStartOfWeek`, где по умолчанию первым днём недели считается воскресенье. [#60598](https://github.com/ClickHouse/ClickHouse/pull/60598) (Jordi Villar).

* Добавлена постоянная виртуальная колонка `_block_offset`, которая хранит исходный номер строки в блоке, присвоенный при вставке. Постоянное хранение колонки `_block_offset` можно включить с помощью настройки `enable_block_offset_column`. Добавлена виртуальная колонка `_part_data_version`, которая содержит либо минимальный номер блока, либо версию мутации куска. Постоянная виртуальная колонка `_block_number` больше не считается экспериментальной. [#60676](https://github.com/ClickHouse/ClickHouse/pull/60676) (Anton Popov).

* Функции `date_diff` и `age` теперь вычисляют результат с наносекундной, а не микросекундной точностью. Они также поддерживают `nanosecond` (или `nanoseconds`, или `ns`) как возможное значение параметра единицы измерения. [#61409](https://github.com/ClickHouse/ClickHouse/pull/61409) (Austin Kothig).

* Теперь метки не загружаются для широких кусков во время слияний. [#61551](https://github.com/ClickHouse/ClickHouse/pull/61551) (Anton Popov).

* Настройка `output_format_pretty_row_numbers` теперь включена по умолчанию. Это лучше с точки зрения удобства использования. [#61791](https://github.com/ClickHouse/ClickHouse/pull/61791) (Alexey Milovidov).

* Индикатор прогресса будет работать для тривиальных запросов с `LIMIT` к `system.zeros`, `system.zeros_mt` (он уже работает для `system.numbers` и `system.numbers_mt`), а также для табличной функции `generateRandom`. В качестве бонуса, если общее количество записей больше лимита `max_rows_to_read`, исключение будет выброшено раньше. Это закрывает #58183. [#61823](https://github.com/ClickHouse/ClickHouse/pull/61823) (Alexey Milovidov).

* Добавлена команда `TRUNCATE ALL TABLES`. [#61862](https://github.com/ClickHouse/ClickHouse/pull/61862) (豪肥肥).

* Добавлена настройка `input_format_json_throw_on_bad_escape_sequence`; её отключение позволяет сохранять некорректные escape-последовательности во входных JSON-форматах. [#61889](https://github.com/ClickHouse/ClickHouse/pull/61889) (Kruglov Pavel).

* Исправлена грамматическая ошибка с "a" на "the" в предупреждающем сообщении. Существует только один движок `Atomic`, поэтому должно быть "to the new Atomic engine" вместо "to a new Atomic engine". [#61952](https://github.com/ClickHouse/ClickHouse/pull/61952) (shabroo).

* Исправлена логическая ошибка (`logical error`) при откате транзакции вставки с кворумом. [#61953](https://github.com/ClickHouse/ClickHouse/pull/61953) (Han Fei).

* Автоматически выводятся типы колонок `Nullable` из схемы Apache Arrow. [#61984](https://github.com/ClickHouse/ClickHouse/pull/61984) (Maksim Kita).

* Разрешено отменять параллельное слияние агрегатных состояний во время агрегации. Пример: `uniqExact`. [#61992](https://github.com/ClickHouse/ClickHouse/pull/61992) (Maksim Kita).

* Источник словаря с `INVALIDATE_QUERY` не перезагружается дважды при запуске. [#62050](https://github.com/ClickHouse/ClickHouse/pull/62050) (vdimir).



* OPTIMIZE FINAL для ReplicatedMergeTree теперь будет ждать завершения текущих активных слияний и затем повторно пытаться запланировать финальное слияние. Это приведёт его поведение в большее соответствие с обычным MergeTree. [#62067](https://github.com/ClickHouse/ClickHouse/pull/62067) (Nikita Taranov).

* При чтении данных из текстового файла Hive ранее использовалась первая строка файла для определения количества входных полей, и иногда количество полей в первой строке не совпадало с определением таблицы Hive. Например, таблица Hive определена с 3 столбцами, как test_tbl(a Int32, b Int32, c Int32), но первая строка текстового файла содержит только 2 поля. В этой ситуации количество входных полей изменяется на 2, и если следующая строка текстового файла содержит 3 поля, то третье поле не будет прочитано и для него будет установлено значение по умолчанию 0, что неверно. [#62086](https://github.com/ClickHouse/ClickHouse/pull/62086) (KevinyhZou).

* Подсветка синтаксиса при вводе в клиенте теперь будет работать на уровне синтаксического анализа (ранее она работала на уровне лексического анализа). [#62123](https://github.com/ClickHouse/ClickHouse/pull/62123) (Alexey Milovidov).

* Исправлена проблема, при которой при добавлении избыточного = 1 или = 0 после булевого выражения, связанного с первичным ключом, первичный индекс не использовался. Например, и `SELECT * FROM <table> WHERE <primary-key> IN (<value>) = 1`, и `SELECT * FROM <table> WHERE <primary-key> NOT IN (<value>) = 0` выполняли полный скан таблицы, хотя мог быть использован первичный индекс. [#62142](https://github.com/ClickHouse/ClickHouse/pull/62142) (josh-hildred).

* Добавлена настройка lightweight_deletes_sync (значение по умолчанию: 2 — синхронное ожидание всех реплик). Она похожа на настройку mutations_sync, но влияет только на поведение лёгких удалений. [#62195](https://github.com/ClickHouse/ClickHouse/pull/62195) (Anton Popov).

* Разделено трактование логических значений и целых чисел при разборе значений для пользовательских настроек: SET custom_a = true; SET custom_b = 1;. [#62206](https://github.com/ClickHouse/ClickHouse/pull/62206) (Vitaly Baranov).

* Добавлена поддержка доступа к S3 через AWS Private Link Interface endpoints. Закрывает #60021, #31074 и #53761. [#62208](https://github.com/ClickHouse/ClickHouse/pull/62208) (Arthur Passos).

* Клиент должен отправлять заголовок 'Keep-Alive: timeout=X' на сервер. Если клиент получает от сервера ответ с этим заголовком, он должен использовать значение, указанное сервером. Также клиенту лучше не использовать соединение, срок жизни которого почти истёк, чтобы избежать гонки при закрытии соединения. [#62249](https://github.com/ClickHouse/ClickHouse/pull/62249) (Sema Checherinda).

* Добавлены единицы измерения наносекунд, микросекунд и миллисекунд для date_trunc. [#62335](https://github.com/ClickHouse/ClickHouse/pull/62335) (Misz606).

* Кэш запросов больше не кэширует результаты запросов к системным таблицам (system.*, information_schema.*, INFORMATION_SCHEMA.*). [#62376](https://github.com/ClickHouse/ClickHouse/pull/62376) (Robert Schulze).

* Запрос MOVE PARTITION TO TABLE может быть отложен или может выбрасывать исключение TOO_MANY_PARTS, чтобы избежать превышения ограничений на количество частей. Применяются те же настройки и ограничения, что и для запроса INSERT (см. max_parts_in_total, parts_to_delay_insert, parts_to_throw_insert, inactive_parts_to_throw_insert, inactive_parts_to_delay_insert, max_avg_part_size_for_too_many_parts, min_delay_to_insert_ms и max_delay_to_insert). [#62420](https://github.com/ClickHouse/ClickHouse/pull/62420) (Sergei Trifonov).

* Функция transform теперь всегда возвращает первое совпадение. [#62518](https://github.com/ClickHouse/ClickHouse/pull/62518) (Raúl Marín).

* При выполнении RESTORE больше не вычисляются выражения DEFAULT для столбцов таблицы. [#62601](https://github.com/ClickHouse/ClickHouse/pull/62601) (Vitaly Baranov).

* Разрешён ключ квоты с иной схемой аутентификации в HTTP-запросах. [#62842](https://github.com/ClickHouse/ClickHouse/pull/62842) (Kseniia Sumarokova).



* Закрывать сессию, когда для пользователя достигнуто значение `valid_until`. [#63046](https://github.com/ClickHouse/ClickHouse/pull/63046) (Konstantin Bogdanov).
