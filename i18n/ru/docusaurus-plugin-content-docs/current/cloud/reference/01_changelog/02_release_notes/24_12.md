---
slug: /changelogs/24.12
title: 'Журнал изменений v24.12 для Cloud'
description: 'Оперативный журнал изменений для v24.12'
keywords: ['changelog', 'cloud']
sidebar_label: '24.12'
sidebar_position: 4
doc_type: 'changelog'
---

Основные изменения для сервисов ClickHouse Cloud на базе выпуска v24.12.



## Обратно несовместимые изменения {#backward-incompatible-changes}

- Функции `greatest` и `least` теперь игнорируют входные значения NULL, тогда как ранее они возвращали NULL, если один из аргументов был NULL. Например, `SELECT greatest(1, 2, NULL)` теперь возвращает 2. Это делает поведение совместимым с PostgreSQL. [#65519](https://github.com/ClickHouse/ClickHouse/pull/65519) ([kevinyhzou](https://github.com/KevinyhZou)).
- По умолчанию запрещено использование типов Variant/Dynamic в ORDER BY/GROUP BY/PARTITION BY/PRIMARY KEY, поскольку это может привести к неожиданным результатам. [#69731](https://github.com/ClickHouse/ClickHouse/pull/69731) ([Pavel Kruglov](https://github.com/Avogar)).
- Удалены системные таблицы `generate_series` и `generateSeries`. Они были добавлены по ошибке здесь: [#59390](https://github.com/ClickHouse/ClickHouse/issues/59390). [#71091](https://github.com/ClickHouse/ClickHouse/pull/71091) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Удален `StorageExternalDistributed`. Закрывает [#70600](https://github.com/ClickHouse/ClickHouse/issues/70600). [#71176](https://github.com/ClickHouse/ClickHouse/pull/71176) ([flynn](https://github.com/ucasfl)).
- Настройки из конфигурации сервера (users.xml) теперь также применяются на клиенте. Полезно для настроек формата, например `date_time_output_format`. [#71178](https://github.com/ClickHouse/ClickHouse/pull/71178) ([Michael Kolupaev](https://github.com/al13n321)).
- Исправлена возможная ошибка `No such file or directory` из-за неэкранированных специальных символов в файлах для подстолбцов JSON. [#71182](https://github.com/ClickHouse/ClickHouse/pull/71182) ([Pavel Kruglov](https://github.com/Avogar)).
- Движки таблиц Kafka, NATS и RabbitMQ теперь охватываются собственными правами доступа в иерархии `SOURCES`. Добавьте права доступа всем пользователям баз данных, отличным от пользователя по умолчанию, которые создают таблицы с этими типами движков. [#71250](https://github.com/ClickHouse/ClickHouse/pull/71250) ([Christoph Wurm](https://github.com/cwurm)).
- Выполняется проверка полного запроса мутации перед его выполнением (включая подзапросы). Это предотвращает случайное выполнение некорректного запроса и накопление мертвых мутаций, которые блокируют корректные мутации. [#71300](https://github.com/ClickHouse/ClickHouse/pull/71300) ([Christoph Wurm](https://github.com/cwurm)).
- Переименована настройка кэша файловой системы `skip_download_if_exceeds_query_cache` в `filesystem_cache_skip_download_if_exceeds_per_query_cache_write_limit`. [#71578](https://github.com/ClickHouse/ClickHouse/pull/71578) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Запрещено использование типов Dynamic/Variant в функциях min/max во избежание путаницы. [#71761](https://github.com/ClickHouse/ClickHouse/pull/71761) ([Pavel Kruglov](https://github.com/Avogar)).
- Удалена поддержка аргументов `Enum`, а также `UInt128` и `UInt256` в `deltaSumTimestamp`. Удалена поддержка `Int8`, `UInt8`, `Int16` и `UInt16` для второго аргумента ("timestamp") функции `deltaSumTimestamp`. [#71790](https://github.com/ClickHouse/ClickHouse/pull/71790) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлена валидация исходного запроса, когда ClickHouse используется в качестве источника для словаря. [#72548](https://github.com/ClickHouse/ClickHouse/pull/72548) ([Alexey Katsman](https://github.com/alexkats)).


## Новые возможности {#new-features}


* Реализована команда SYSTEM LOAD PRIMARY KEY для загрузки первичных индексов всех частей указанной таблицы или всех таблиц, если таблица не указана. Команда полезна для проведения бенчмарков и предотвращения дополнительной задержки во время выполнения запросов. [#66252](https://github.com/ClickHouse/ClickHouse/pull/66252) ([ZAWA&#95;ll](https://github.com/Zawa-ll)).
* Добавлен оператор `SYSTEM LOAD PRIMARY KEY` для загрузки первичных индексов всех частей указанной таблицы или всех таблиц, если таблица не указана. Это может быть полезно для бенчмаркинга и предотвращения дополнительных задержек при выполнении запросов. [#67733](https://github.com/ClickHouse/ClickHouse/pull/67733) ([ZAWA&#95;ll](https://github.com/Zawa-ll)).
* Добавлен запрос `CHECK GRANT`, позволяющий проверить, была ли текущему пользователю или роли выдана конкретная привилегия и существуют ли в памяти соответствующая таблица и/или столбец. [#68885](https://github.com/ClickHouse/ClickHouse/pull/68885) ([Unalian](https://github.com/Unalian)).
* Добавлен синтаксис SQL для описания управления нагрузкой и ресурсами. [https://clickhouse.com/docs/en/operations/workload-scheduling](https://clickhouse.com/docs/en/operations/workload-scheduling). [#69187](https://github.com/ClickHouse/ClickHouse/pull/69187) ([Sergei Trifonov](https://github.com/serxa)).
* Формат хранения данных [Iceberg](https://iceberg.apache.org/spec/#file-system-operations) предоставляет пользователю широкие возможности изменения схемы таблицы. В этом pull request реализовано чтение таблицы в формате Iceberg, в которой изменены порядок столбцов, имена столбцов и применены простые расширения типов данных. [#69445](https://github.com/ClickHouse/ClickHouse/pull/69445) ([Daniil Ivanik](https://github.com/divanik)).
* Разрешить каждому методу аутентификации иметь собственный срок действия и удалить поле срока действия из сущности пользователя. [#70090](https://github.com/ClickHouse/ClickHouse/pull/70090) ([Arthur Passos](https://github.com/arthurpassos)).
* Передавать внешние роли пользователей от инициатора запроса на другие узлы кластера. Полезно, когда доступ к внешнему аутентификатору (например, LDAP) есть только у инициатора. [#70332](https://github.com/ClickHouse/ClickHouse/pull/70332) ([Andrey Zvonov](https://github.com/zvonand)).
* Добавлена поддержка изменения типа столбца (`ALTER`) с `String` на `JSON`. Этот PR также переключает сериализацию типов `JSON` и `Dynamic` на новую версию V2. Старая версия V1 по‑прежнему может использоваться при включении настройки `merge_tree_use_v1_object_and_dynamic_serialization` (может применяться во время обновления, чтобы при необходимости можно было без проблем откатиться на предыдущую версию). [#70442](https://github.com/ClickHouse/ClickHouse/pull/70442) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена функция `toUnixTimestamp64Second`, которая преобразует `DateTime64` в значение `Int64` с фиксированной точностью до секунд, что позволяет возвращать отрицательное значение, если дата раньше 00:00:00 UTC четверга, 1 января 1970 года. [#70597](https://github.com/ClickHouse/ClickHouse/pull/70597) ([zhanglistar](https://github.com/zhanglistar)).
* Добавлена новая настройка `enforce_index_structure_match_on_partition_manipulation`, позволяющая выполнять операцию ATTACH, когда проекции и вторичные индексы исходной таблицы являются подмножеством проекций и вторичных индексов целевой таблицы. Закрывает [#70602](https://github.com/ClickHouse/ClickHouse/issues/70602). [#70603](https://github.com/ClickHouse/ClickHouse/pull/70603) ([zwy991114](https://github.com/zwy991114)).
* Вывод функции `cast` отличается от Apache Spark, из-за чего возникают расхождения в проекте Gluten, см. [https://github.com/apache/incubator-gluten/issues/7602](https://github.com/apache/incubator-gluten/issues/7602). Этот PR добавляет поддержку текстового формата вывода Spark, по умолчанию отключено. [#70957](https://github.com/ClickHouse/ClickHouse/pull/70957) ([zhanglistar](https://github.com/zhanglistar)).
* Добавлен новый тип заголовка для S3-эндпоинтов для аутентификации пользователей (`access_header`). Это позволяет задать заголовок доступа с наименьшим приоритетом, который будет переопределён значением `access_key_id` из любого другого источника (например, схемы таблицы или именованной коллекции). [#71011](https://github.com/ClickHouse/ClickHouse/pull/71011) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Первая реализация уровней настроек. [#71145](https://github.com/ClickHouse/ClickHouse/pull/71145) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлена поддержка предложения `STALENESS` в `ORDER BY` с оператором `FILL`. [#71151](https://github.com/ClickHouse/ClickHouse/pull/71151) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Реализован простой `CAST` из `Map`/`Tuple`/`Object` в новый `JSON` путём сериализации/десериализации в/из JSON-строки. [#71320](https://github.com/ClickHouse/ClickHouse/pull/71320) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлены псевдонимы `anyRespectNulls`, `firstValueRespectNulls` и `anyValueRespectNulls` для агрегатной функции `any`. Также добавлены псевдонимы `anyLastRespectNulls` и `lastValueRespectNulls` для агрегатной функции `anyLast`. Это позволяет использовать более естественный синтаксис в стиле camelCase без подчёркиваний вместо смешанного camelCase/underscore, например: `SELECT anyLastRespectNullsStateIf` вместо `anyLast_respect_nullsStateIf`. [#71403](https://github.com/ClickHouse/ClickHouse/pull/71403) ([Peter Nguyen](https://github.com/petern48)).
* Добавлен конфигурационный параметр `date_time_utc`, позволяющий выводить дату и время в JSON‑логах в формате UTC в соответствии с RFC 3339/ISO8601. [#71560](https://github.com/ClickHouse/ClickHouse/pull/71560) ([Ali](https://github.com/xogoodnow)).
* Добавлена возможность выбрать сторону соединения, которая будет выступать в роли внутренней (build) таблицы в плане запроса. Это контролируется параметром `query_plan_join_swap_table`, который можно установить в значение `auto`. В этом режиме ClickHouse будет пытаться выбрать таблицу с наименьшим количеством строк. [#71577](https://github.com/ClickHouse/ClickHouse/pull/71577) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Оптимизировано использование памяти для значений гранулярности индекса, если гранулярность для парта постоянна. Добавлена возможность всегда выбирать постоянную гранулярность для парта (настройка `use_const_adaptive_granularity`), что позволяет гарантировать её оптимизацию по использованию памяти. Это помогает при больших нагрузках (триллионы строк в общей системе хранения) избежать постоянного роста потребления памяти метаданными (значениями гранулярности индекса) партов данных. [#71786](https://github.com/ClickHouse/ClickHouse/pull/71786) ([Anton Popov](https://github.com/CurtizJ)).
* Реализован параметр `allowed_feature_tier` как глобальный переключатель, отключающий все экспериментальные и бета‑функции. [#71841](https://github.com/ClickHouse/ClickHouse/pull/71841) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлены табличные функции `iceberg[S3;HDFS;Azure]Cluster`, `deltaLakeCluster`, `hudiCluster`. [#72045](https://github.com/ClickHouse/ClickHouse/pull/72045) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Добавлен синтаксис `ALTER USER {ADD|MODIFY|DROP SETTING}`, `ALTER USER {ADD|DROP PROFILE}`, а также соответствующий синтаксис для `ALTER ROLE` и `ALTER PROFILE`. [#72050](https://github.com/ClickHouse/ClickHouse/pull/72050) ([pufit](https://github.com/pufit)).
* Добавлена функция `arrayPrAUC`, которая вычисляет AUC (Area Under the Curve, площадь под кривой) для кривой точности-полноты (Precision Recall). [#72073](https://github.com/ClickHouse/ClickHouse/pull/72073) ([Emmanuel](https://github.com/emmanuelsdias)).
* Добавлен кэш для первичного индекса таблиц `MergeTree` (может быть включён настройкой таблицы `use_primary_key_cache`). Если для первичного индекса включены ленивая загрузка и кэш, он будет загружаться в кэш по требованию (аналогично кэшу меток), а не постоянно находиться в памяти. Добавлен прогрев первичного индекса при вставках/слияниях/загрузках частей данных и при перезапусках таблицы (может быть включён настройкой `prewarm_primary_key_cache`). [#72102](https://github.com/ClickHouse/ClickHouse/pull/72102) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена функция indexOfAssumeSorted для массивов. Ускоряет поиск в случае массива, отсортированного в неубывающем порядке. [#72517](https://github.com/ClickHouse/ClickHouse/pull/72517) ([Eric Kurbanov](https://github.com/erickurbanov)).
* Позволяет использовать разделитель в качестве необязательного второго аргумента агрегатной функции `groupConcat`. [#72540](https://github.com/ClickHouse/ClickHouse/pull/72540) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Новая настройка `http_response_headers`, позволяющая настраивать HTTP-заголовки ответа. Например, вы можете указать браузеру отобразить изображение, хранящееся в базе данных. Это закрывает [#59620](https://github.com/ClickHouse/ClickHouse/issues/59620). [#72656](https://github.com/ClickHouse/ClickHouse/pull/72656) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена функция `fromUnixTimestamp64Second`, которая преобразует значение Unix-таймстампа типа Int64 в DateTime64. [#73146](https://github.com/ClickHouse/ClickHouse/pull/73146) ([Robert Schulze](https://github.com/rschu1ze)).





## Улучшения производительности {#performance-improvements}


* Добавлены две новые настройки `short_circuit_function_evaluation_for_nulls` и `short_circuit_function_evaluation_for_nulls_threshold`, которые позволяют выполнять функции над столбцами типа `Nullable` в режиме короткого замыкания, когда доля значений NULL в блоке данных превышает заданный порог. Это означает, что функция будет выполняться только для строк со значениями, отличными от NULL. Применяется только к функциям, которые возвращают значение NULL для строк, в которых хотя бы один аргумент имеет значение NULL. [#60129](https://github.com/ClickHouse/ClickHouse/pull/60129) ([李扬](https://github.com/taiyang-li)).
* Снижено потребление памяти при использовании команды `clickhouse disks remove --recursive` для дисков объектного хранилища. [#67323](https://github.com/ClickHouse/ClickHouse/pull/67323) ([Kirill](https://github.com/kirillgarbar)).
* Теперь столбцы входных блоков для `join_algorithm='parallel_hash'` не копируются при их распределении между потоками для параллельной обработки. [#67782](https://github.com/ClickHouse/ClickHouse/pull/67782) ([Nikita Taranov](https://github.com/nickitat)).
* Включена JIT-компиляция для большего количества выражений: `abs`/`bitCount`/`sign`/`modulo`/`pmod`/`isNull`/`isNotNull`/`assumeNotNull`/`to(U)Int*`/`toFloat*`, функции сравнения (`=`, `<`, `>`, `>=`, `<=`), логические функции (`and`, `or`). [#70598](https://github.com/ClickHouse/ClickHouse/pull/70598) ([李扬](https://github.com/taiyang-li)).
* Теперь алгоритм `parallel_hash` будет использоваться (если применимо), когда параметр `join_algorithm` имеет значение `default`. Две предыдущие альтернативы (`direct` и `hash`) по-прежнему рассматриваются, если `parallel_hash` не может быть использован. [#70788](https://github.com/ClickHouse/ClickHouse/pull/70788) ([Nikita Taranov](https://github.com/nickitat)).
* Оптимизирован алгоритм слияния `Replacing` для непересекающихся партиций. [#70977](https://github.com/ClickHouse/ClickHouse/pull/70977) ([Anton Popov](https://github.com/CurtizJ)).
* Не перечислять отсоединённые части с дисков readonly и write-once в метриках и system.detached&#95;parts. [#71086](https://github.com/ClickHouse/ClickHouse/pull/71086) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* По умолчанию не следует вычислять тяжёлые асинхронные метрики. Эта функция была добавлена в [#40332](https://github.com/ClickHouse/ClickHouse/issues/40332), но нежелательно иметь ресурсоёмкую фоновую задачу, которая требуется только одному клиенту. [#71087](https://github.com/ClickHouse/ClickHouse/pull/71087) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшена производительность и точность интервала сбора данных в журнале `system.query_metric_log` за счет уменьшения критической секции. [#71473](https://github.com/ClickHouse/ClickHouse/pull/71473) ([Pablo Marcos](https://github.com/pamarcos)).
* Добавлена опция извлечения общих подвыражений из условий `WHERE` и `ON` для уменьшения количества хеш-таблиц, используемых при выполнении JOIN-ов. Может быть включена с помощью `optimize_extract_common_expressions = 1`. [#71537](https://github.com/ClickHouse/ClickHouse/pull/71537) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Позволяет использовать индексы в запросах `SELECT` с `LowCardinality(String)`. [#71598](https://github.com/ClickHouse/ClickHouse/pull/71598) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Во время выполнения запроса с параллельными репликами и включённым локальным планом на рабочих узлах не выполняется анализ пропускающего индекса. Координатор выбирает диапазоны для чтения на рабочих узлах на основе анализа пропускающего индекса, выполненного на своей стороне (на инициаторе запроса). [#72109](https://github.com/ClickHouse/ClickHouse/pull/72109) ([Igor Nikonov](https://github.com/devcrafter)).
* Вернули оптимизацию для чтения подстолбцов одного столбца в Compact-частях из [https://github.com/ClickHouse/ClickHouse/pull/57631](https://github.com/ClickHouse/ClickHouse/pull/57631). Она была удалена по ошибке. [#72285](https://github.com/ClickHouse/ClickHouse/pull/72285) ([Pavel Kruglov](https://github.com/Avogar)).
* Ускорена сортировка столбцов `LowCardinality(String)` путем девиртуализации вызовов в компараторе. [#72337](https://github.com/ClickHouse/ClickHouse/pull/72337) ([Alexander Gololobov](https://github.com/davenger)).
* Оптимизированы функции argMin/argMax для некоторых простых типов данных. [#72350](https://github.com/ClickHouse/ClickHouse/pull/72350) ([alesapin](https://github.com/alesapin)).
* Оптимизировано использование разделяемых блокировок в трекере памяти для снижения конкуренции при блокировках. [#72375](https://github.com/ClickHouse/ClickHouse/pull/72375) ([Jiebin Sun](https://github.com/jiebinn)).
* Добавлена новая настройка `use_async_executor_for_materialized_views`. Включает асинхронное и потенциально многопоточное выполнение запросов материализованных представлений, что может ускорить обработку представлений при выполнении INSERT, но также приводит к большему потреблению памяти. [#72497](https://github.com/ClickHouse/ClickHouse/pull/72497) ([alesapin](https://github.com/alesapin)).
* Значения по умолчанию для настроек `max_size_to_preallocate_for_aggregation` и `max_size_to_preallocate_for_joins` были увеличены до `10^12`, поэтому оптимизация будет срабатывать чаще. [#72555](https://github.com/ClickHouse/ClickHouse/pull/72555) ([Nikita Taranov](https://github.com/nickitat)).
* Улучшена производительность десериализации состояний агрегатных функций (в типе данных `AggregateFunction` и в распределённых запросах). Незначительно улучшена производительность разбора формата `RowBinary`. [#72818](https://github.com/ClickHouse/ClickHouse/pull/72818) ([Anton Popov](https://github.com/CurtizJ)).





## Улучшение {#improvement}


* Функции высшего порядка с константными массивами и константными захваченными аргументами возвращают константы. [#58400](https://github.com/ClickHouse/ClickHouse/pull/58400) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Оптимизация чтения в отсортированном порядке за счёт генерации виртуальных строк, чтобы при сортировке слиянием считывалось меньше данных; особенно эффективно при наличии нескольких частей. [#62125](https://github.com/ClickHouse/ClickHouse/pull/62125) ([Shichao Jin](https://github.com/jsc0218)).
* Имена шагов плана запроса (`EXPLAIN PLAN json=1`) и имена процессоров конвейера (`EXPLAIN PIPELINE compact=0,graph=1`) теперь имеют уникальный идентификатор в виде суффикса. Это позволяет сопоставлять вывод профайлера процессоров и трассировки OpenTelemetry с выводом `EXPLAIN`. [#63518](https://github.com/ClickHouse/ClickHouse/pull/63518) ([qhsong](https://github.com/qhsong)).
* Добавлена опция проверки наличия объекта после записи в Azure Blob Storage, которая управляется параметром `check_objects_after_upload`. [#64847](https://github.com/ClickHouse/ClickHouse/pull/64847) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Исправлена ошибка use-after-dtor в HashTable::destroyElements. [#65279](https://github.com/ClickHouse/ClickHouse/pull/65279) ([cangyin](https://github.com/cangyin)).
* Использовать по умолчанию базу данных `Atomic` в `clickhouse-local`. Решены пункты 1 и 5 из [#50647](https://github.com/ClickHouse/ClickHouse/issues/50647). Закрывает [#44817](https://github.com/ClickHouse/ClickHouse/issues/44817). [#68024](https://github.com/ClickHouse/ClickHouse/pull/68024) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Буфер записи должен быть явно отменён или завершён. Исключения нарушают протокол HTTP, чтобы уведомить клиента об ошибке. [#68800](https://github.com/ClickHouse/ClickHouse/pull/68800) ([Sema Checherinda](https://github.com/CheSema)).
* Регистрировать хосты, на которых запущен DDLWorker, с помощью создания replica&#95;dir, и помечать реплики как активные в DDLWorker. [#69658](https://github.com/ClickHouse/ClickHouse/pull/69658) ([Tuan Pham Anh](https://github.com/tuanpach)).
* 1. Рефакторинг `DDLQueryStatusSource`: - Переименовать `DDLQueryStatusSource` в `DistributedQueryStatusSource` и сделать его базовым классом - Создать два подкласса `DDLOnClusterQueryStatusSource` и `ReplicatedDatabaseQueryStatusSource`, унаследованных от `DDLQueryStatusSource`, для запроса статуса DDL‑задач из `DDL On Cluster` и реплицируемых баз данных соответственно. 2. Реализовать возможность прекращать ожидание офлайн-хостов в `DDLOnClusterQueryStatusSource`. [#69660](https://github.com/ClickHouse/ClickHouse/pull/69660) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Добавлена новая логика отмены: `CancellationChecker` проверяет таймауты для каждого выполняющегося запроса и останавливает их по достижении таймаута. [#69880](https://github.com/ClickHouse/ClickHouse/pull/69880) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Удалена настройка `allow_experimental_join_condition`, по умолчанию разрешены условия соединения не по равенству. [#69910](https://github.com/ClickHouse/ClickHouse/pull/69910) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Настройка `parallel_replicas_local_plan` включена по умолчанию. Построение полноценного локального плана на инициаторе запроса повышает производительность параллельных реплик при меньшем потреблении ресурсов и предоставляет дополнительные возможности для оптимизации запросов. [#70171](https://github.com/ClickHouse/ClickHouse/pull/70171) ([Igor Nikonov](https://github.com/devcrafter)).
* Добавлена возможность задавать пользователя и пароль в http&#95;handlers (для `dynamic_query_handler`/`predefined_query_handler`). [#70725](https://github.com/ClickHouse/ClickHouse/pull/70725) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка `ALTER TABLE ... MODIFY/RESET SETTING ...` для отдельных настроек хранилища S3Queue. [#70811](https://github.com/ClickHouse/ClickHouse/pull/70811) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Не вызывайте API объектного хранилища при перечислении каталогов, так как это может быть экономически неэффективно. Вместо этого храните список имён файлов в памяти. Обратной стороной такого подхода будут увеличенное время начальной загрузки и дополнительный объём памяти, необходимый для хранения имён файлов. [#70823](https://github.com/ClickHouse/ClickHouse/pull/70823) ([Julia Kartseva](https://github.com/jkartseva)).
* Добавлен параметр `--threads` в `clickhouse-compressor`, позволяющий сжимать данные параллельно. [#70860](https://github.com/ClickHouse/ClickHouse/pull/70860) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Размер истории клиента Replxx сделан настраиваемым. [#71014](https://github.com/ClickHouse/ClickHouse/pull/71014) ([Jiří Kozlovský](https://github.com/jirislav)).
* Добавлена настройка `prewarm_mark_cache`, которая включает предварительную загрузку меток в кэш меток при вставках, слияниях, получении частей и при старте таблицы. [#71053](https://github.com/ClickHouse/ClickHouse/pull/71053) ([Anton Popov](https://github.com/CurtizJ)).
* Поддержка булевого типа для нативного ридера Parquet. [#71055](https://github.com/ClickHouse/ClickHouse/pull/71055) ([Arthur Passos](https://github.com/arthurpassos)).
* Расширен набор ошибок, при которых выполняются повторные попытки при взаимодействии с S3, например для ошибки «Malformed message». [#71088](https://github.com/ClickHouse/ClickHouse/pull/71088) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Понижен уровень логирования для некоторых сообщений, связанных с S3. [#71090](https://github.com/ClickHouse/ClickHouse/pull/71090) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка записи файлов HDFS с пробелами в именах. [#71105](https://github.com/ClickHouse/ClickHouse/pull/71105) ([exmy](https://github.com/exmy)).
* `system.session_log` вполне подходит. Это закрывает [#51760](https://github.com/ClickHouse/ClickHouse/issues/51760). [#71150](https://github.com/ClickHouse/ClickHouse/pull/71150) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлены операции RIGHT / FULL JOIN в запросах с параллельными репликами. Теперь RIGHT JOIN может выполняться с параллельными репликами (чтение правой таблицы распределено). FULL JOIN не может быть распараллелен между узлами и выполняется локально. [#71162](https://github.com/ClickHouse/ClickHouse/pull/71162) ([Igor Nikonov](https://github.com/devcrafter)).
* Добавлены настройки для ограничения количества реплицируемых таблиц, словарей и представлений. [#71179](https://github.com/ClickHouse/ClickHouse/pull/71179) ([Kirill](https://github.com/kirillgarbar)).
* Исправлена ошибка [#71227](https://github.com/ClickHouse/ClickHouse/issues/71227). [#71286](https://github.com/ClickHouse/ClickHouse/pull/71286) ([Arthur Passos](https://github.com/arthurpassos)).
* Автоматический вывод операций `GROUP BY`/`ORDER BY` на диск в зависимости от использования памяти сервером/пользователем. Управляется параметрами запроса `max_bytes_ratio_before_external_group_by`/`max_bytes_ratio_before_external_sort`. [#71406](https://github.com/ClickHouse/ClickHouse/pull/71406) ([Azat Khuzhin](https://github.com/azat)).
* Добавлены дашборды по каждому хосту `Overview (host)` и `Cloud overview (host)` в расширенный дашборд. [#71422](https://github.com/ClickHouse/ClickHouse/pull/71422) ([alesapin](https://github.com/alesapin)).
* Функция `translate` теперь поддерживает удаление символов, если в аргументе `from` больше символов, чем в аргументе `to`. Пример: `SELECT translate('clickhouse', 'clickhouse', 'CLICK')` теперь возвращает `CLICK`. [#71441](https://github.com/ClickHouse/ClickHouse/pull/71441) ([shuai.xu](https://github.com/shuai-xu)).
* Добавлены новые функции `parseDateTime64`, `parseDateTime64OrNull` и `parseDateTime64OrZero`. По сравнению с существующей функцией `parseDateTime` (и её вариантами) эти функции возвращают значение типа `DateTime64` вместо `DateTime`. [#71581](https://github.com/ClickHouse/ClickHouse/pull/71581) ([kevinyhzou](https://github.com/KevinyhZou)).
* Сокращён объём массива index&#95;granularity в памяти, чтобы уменьшить потребление памяти семейством движков таблиц MergeTree. [#71595](https://github.com/ClickHouse/ClickHouse/pull/71595) ([alesapin](https://github.com/alesapin)).
* Приложения командной строки будут подсвечивать синтаксис даже для запросов, содержащих несколько операторов. [#71622](https://github.com/ClickHouse/ClickHouse/pull/71622) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Приложения командной строки при возникновении ошибок будут возвращать ненулевые коды возврата. В предыдущих версиях приложение `disks` при ошибках возвращало ноль, а другие приложения возвращали ноль для ошибок 256 (`PARTITION_ALREADY_EXISTS`) и 512 (`SET_NON_GRANTED_ROLE`). [#71623](https://github.com/ClickHouse/ClickHouse/pull/71623) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Формат `Vertical` (который также можно активировать, завершив запрос `\G`) получил возможности форматов Pretty, такие, как: — подсветка групп тысяч в числах; — вывод удобочитаемой подсказки с числом. [#71630](https://github.com/ClickHouse/ClickHouse/pull/71630) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность отключать увеличение размера буфера памяти для кэша файловой системы с помощью настройки `filesystem_cache_prefer_bigger_buffer_size`. [#71640](https://github.com/ClickHouse/ClickHouse/pull/71640) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена отдельная настройка `background_download_max_file_segment_size` для максимального размера сегмента файла при фоновой загрузке в файловом кэше. [#71648](https://github.com/ClickHouse/ClickHouse/pull/71648) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Изменяет значение по умолчанию параметра `enable_http_compression` с 0 на 1. Закрывает [#71591](https://github.com/ClickHouse/ClickHouse/issues/71591). [#71774](https://github.com/ClickHouse/ClickHouse/pull/71774) ([Peter Nguyen](https://github.com/petern48)).
* Добавлена поддержка ALTER из Object в JSON. [#71784](https://github.com/ClickHouse/ClickHouse/pull/71784) ([Pavel Kruglov](https://github.com/Avogar)).
* Немного улучшен разбор типов JSON: если текущий блок для JSON-пути содержит значения нескольких типов, выполняется попытка выбрать наилучший тип, перебирая типы в специальном эвристическом порядке. [#71785](https://github.com/ClickHouse/ClickHouse/pull/71785) ([Pavel Kruglov](https://github.com/Avogar)).
* Ранее при чтении из `system.asynchronous_metrics` происходило ожидание завершения конкурентного обновления. Это могло занимать много времени при высокой нагрузке на систему. После этого изменения ранее собранные значения можно читать в любой момент. [#71798](https://github.com/ClickHouse/ClickHouse/pull/71798) ([Alexander Gololobov](https://github.com/davenger)).
* Параметр `polling_max_timeout_ms` установлен в 10 минут, `polling_backoff_ms` — в 30 секунд. [#71817](https://github.com/ClickHouse/ClickHouse/pull/71817) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Запросы вида &#39;SELECT - FROM t LIMIT 1&#39; ранее загружали индексы частей, хотя они не использовались. [#71866](https://github.com/ClickHouse/ClickHouse/pull/71866) ([Alexander Gololobov](https://github.com/davenger)).
* Allow&#95;reorder&#95;prewhere&#95;conditions по умолчанию включён для старых настроек совместимости. [#71867](https://github.com/ClickHouse/ClickHouse/pull/71867) ([Raúl Marín](https://github.com/Algunenano)).
* Не увеличивать счетчик `ILLEGAL_TYPE_OF_ARGUMENT` в таблице `system.errors` при использовании функции `bitmapTransform`, если типы аргументов корректны. [#71971](https://github.com/ClickHouse/ClickHouse/pull/71971) ([Dmitry Novik](https://github.com/novikd)).
* При получении данных напрямую из словаря с использованием хранилища Dictionary, табличной функции словаря или прямого запроса SELECT к самому словарю теперь достаточно иметь право `SELECT` или право `dictGet` для этого словаря. Это соответствует предыдущим попыткам предотвратить обход ACL: [https://github.com/ClickHouse/ClickHouse/pull/57362](https://github.com/ClickHouse/ClickHouse/pull/57362) и [https://github.com/ClickHouse/ClickHouse/pull/65359](https://github.com/ClickHouse/ClickHouse/pull/65359), а также делает вторую из них обратно совместимой. [#72051](https://github.com/ClickHouse/ClickHouse/pull/72051) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* На HTML-странице расширенного дашборда добавлен выпадающий список для выбора дашборда из таблицы `system.dashboards`. [#72081](https://github.com/ClickHouse/ClickHouse/pull/72081) ([Sergei Trifonov](https://github.com/serxa)).
* Учитывать параметр `prefer_locahost_replica` при построении плана выполнения для распределённого `INSERT ... SELECT`. [#72190](https://github.com/ClickHouse/ClickHouse/pull/72190) ([filimonov](https://github.com/filimonov)).
* Проблема [описана здесь](https://github.com/ClickHouse/ClickHouse/issues/72091). Azure Iceberg Writer создает метаданные Iceberg (а также manifest-файлы), которые нарушают спецификации. В этом PR я добавил попытку чтения метаданных формата Iceberg v1 ридером формата v2 (так как они записывают их именно так), а также добавил ошибку на случай, если они не создают соответствующие поля в manifest-файле. [#72277](https://github.com/ClickHouse/ClickHouse/pull/72277) ([Daniil Ivanik](https://github.com/divanik)).
* Типы JSON/Dynamic/Variant перенесены из разряда экспериментальных возможностей в бета-стадию. [#72294](https://github.com/ClickHouse/ClickHouse/pull/72294) ([Pavel Kruglov](https://github.com/Avogar)).
* Теперь разрешено использовать `CREATE MATERIALIZED VIEW` с `UNION [ALL]` в запросе. Поведение такое же, как для materialized view с `JOIN`: **только первая таблица в выражении `SELECT` будет служить триггером для вставки* — все остальные таблицы будут игнорироваться. [#72347](https://github.com/ClickHouse/ClickHouse/pull/72347) ([alesapin](https://github.com/alesapin)).
* Ускорена вставка в MergeTree в случае, когда во вставляемом пакете все строки имеют одинаковое значение ключа партиционирования. [#72348](https://github.com/ClickHouse/ClickHouse/pull/72348) ([alesapin](https://github.com/alesapin)).
* Добавлена новая метрика MergeTreeIndexGranularityInternalArraysTotalSize в system.metrics. Эта метрика нужна для поиска экземпляров с очень большими наборами данных, подверженных проблеме высокого расхода памяти. [#72490](https://github.com/ClickHouse/ClickHouse/pull/72490) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Теперь при использовании формата `Format Null` распознаются все написания слова `Null`. Ранее другие написания (например, `NULL`) не приводили к возникновению исключений, но при этом формат `Null` фактически не использовался в таких случаях. [#72658](https://github.com/ClickHouse/ClickHouse/pull/72658) ([Nikita Taranov](https://github.com/nickitat)).
* Разрешить неизвестные значения в множестве, которые отсутствуют в Enum. Исправлена ошибка [#72662](https://github.com/ClickHouse/ClickHouse/issues/72662). [#72686](https://github.com/ClickHouse/ClickHouse/pull/72686) ([zhanglistar](https://github.com/zhanglistar)).
* В system.tables добавлен total&#95;bytes&#95;with&#95;inactive для подсчёта общего объёма байт в неактивных частях. [#72690](https://github.com/ClickHouse/ClickHouse/pull/72690) ([Kai Zhu](https://github.com/nauu)).
* Добавлены настройки MergeTree (MergeTreeSettings) в system.settings&#95;changes. [#72694](https://github.com/ClickHouse/ClickHouse/pull/72694) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлена поддержка оператора строкового поиска (например, LIKE) для типа данных Enum, исправление [#72661](https://github.com/ClickHouse/ClickHouse/issues/72661). [#72732](https://github.com/ClickHouse/ClickHouse/pull/72732) ([zhanglistar](https://github.com/zhanglistar)).
* Добавлена поддержка типа JSON в функции notEmpty. [#72741](https://github.com/ClickHouse/ClickHouse/pull/72741) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена поддержка разбора ошибки GCS S3 `AuthenticationRequired`. [#72753](https://github.com/ClickHouse/ClickHouse/pull/72753) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена поддержка типа данных Dynamic в функциях ifNull и coalesce. [#72772](https://github.com/ClickHouse/ClickHouse/pull/72772) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлены события профилирования `JoinBuildTableRowCount/JoinProbeTableRowCount/JoinResultRowCount`. [#72842](https://github.com/ClickHouse/ClickHouse/pull/72842) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Добавлена поддержка типа Dynamic в функциях toFloat64/touInt32/и т. д. [#72989](https://github.com/ClickHouse/ClickHouse/pull/72989) ([Pavel Kruglov](https://github.com/Avogar)).





## Исправление ошибки (некорректное поведение, видимое пользователю в официальном стабильном релизе) {#bug-fix}


* Части, дедуплицированные во время выполнения запроса `ATTACH PART`, больше не остаются с префиксом `attaching_`. [#65636](https://github.com/ClickHouse/ClickHouse/pull/65636) ([Kirill](https://github.com/kirillgarbar)).
* Исправлена ошибка, из-за которой DateTime64 терял точность при использовании функции `IN`. [#67230](https://github.com/ClickHouse/ClickHouse/pull/67230) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена потенциальная логическая ошибка при использовании функций с `IGNORE/RESPECT NULLS` в `ORDER BY ... WITH FILL`, закрыт [#57609](https://github.com/ClickHouse/ClickHouse/issues/57609). [#68234](https://github.com/ClickHouse/ClickHouse/pull/68234) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлены редкие логические ошибки при асинхронных вставках в формате `Native` при достижении ограничения по памяти. [#68965](https://github.com/ClickHouse/ClickHouse/pull/68965) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен COMMENT в операторе CREATE TABLE для столбца EPHEMERAL. [#70458](https://github.com/ClickHouse/ClickHouse/pull/70458) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена логическая ошибка в функции `JSONExtract` при работе с типом `LowCardinality(Nullable)`. [#70549](https://github.com/ClickHouse/ClickHouse/pull/70549) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено поведение при слишком длинном имени таблицы. [#70810](https://github.com/ClickHouse/ClickHouse/pull/70810) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена возможность переопределять Content-Type с помощью пользовательских заголовков в движке URL. [#70859](https://github.com/ClickHouse/ClickHouse/pull/70859) ([Artem Iurin](https://github.com/ortyomka)).
* Исправлена логическая ошибка в `StorageS3Queue`: «Cannot create a persistent node in /processed since it already exists». [#70984](https://github.com/ClickHouse/ClickHouse/pull/70984) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка, из-за которой столбец &#95;row&#95;exists не учитывался в опции rebuild для lightweight delete проекций. [#71089](https://github.com/ClickHouse/ClickHouse/pull/71089) ([Shichao Jin](https://github.com/jsc0218)).
* Исправлено неверное значение в system.query&#95;metric&#95;log из-за непредвиденного условия гонки. [#71124](https://github.com/ClickHouse/ClickHouse/pull/71124) ([Pablo Marcos](https://github.com/pamarcos)).
* Исправлено несоответствие в названии агрегатной функции quantileExactWeightedInterpolated. Ошибка появилась в [https://github.com/ClickHouse/ClickHouse/pull/69619](https://github.com/ClickHouse/ClickHouse/pull/69619). cc @Algunenano. [#71168](https://github.com/ClickHouse/ClickHouse/pull/71168) ([李扬](https://github.com/taiyang-li)).
* Исправлено исключение bad&#95;weak&#95;ptr при сравнении функций с Dynamic. [#71183](https://github.com/ClickHouse/ClickHouse/pull/71183) ([Pavel Kruglov](https://github.com/Avogar)).
* Не удаляйте blob, если есть узлы, которые его используют в ReplicatedMergeTree с репликацией без копирования (zero-copy). [#71186](https://github.com/ClickHouse/ClickHouse/pull/71186) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено игнорирование настроек формата в формате Native при использовании протокола HTTP и асинхронных вставок. [#71193](https://github.com/ClickHouse/ClickHouse/pull/71193) ([Pavel Kruglov](https://github.com/Avogar)).
* Запросы SELECT с настройкой `use_query_cache = 1` больше не отклоняются, если имя системной таблицы указано в виде литерала, например, `SELECT - FROM users WHERE name = 'system.metrics' SETTINGS use_query_cache = true;` теперь выполняется. [#71254](https://github.com/ClickHouse/ClickHouse/pull/71254) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена ошибка роста потребления памяти при `enable_filesystem_cache=1`, если для диска в конфигурации хранилища не был настроен кеш. [#71261](https://github.com/ClickHouse/ClickHouse/pull/71261) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена потенциальная ошибка «Cannot read all data» при десериализации словаря LowCardinality из столбца Dynamic. [#71299](https://github.com/ClickHouse/ClickHouse/pull/71299) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена проблема неполной очистки параллельного выходного формата в клиенте. [#71304](https://github.com/ClickHouse/ClickHouse/pull/71304) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлено отсутствовавшее разэкранирование в именованных коллекциях. Без этого исправления clickhouse-server не может запуститься. [#71308](https://github.com/ClickHouse/ClickHouse/pull/71308) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Исправлены асинхронные вставки с пустыми блоками при использовании нативного протокола. [#71312](https://github.com/ClickHouse/ClickHouse/pull/71312) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено непоследовательное форматирование AST при выдаче неверных wildcard‑привилегий [#71309](https://github.com/ClickHouse/ClickHouse/issues/71309). [#71332](https://github.com/ClickHouse/ClickHouse/pull/71332) ([pufit](https://github.com/pufit)).
* Проверка подозрительных и экспериментальных типов в подсказках типов JSON. [#71369](https://github.com/ClickHouse/ClickHouse/pull/71369) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка «Invalid number of rows in Chunk with Variant column». [#71388](https://github.com/ClickHouse/ClickHouse/pull/71388) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено падение табличной функции `mongodb` при передаче некорректных аргументов (например, `NULL`). [#71426](https://github.com/ClickHouse/ClickHouse/pull/71426) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлена ошибка, приводившая к аварийному завершению работы при использовании optimize&#95;rewrite&#95;array&#95;exists&#95;to&#95;has. [#71432](https://github.com/ClickHouse/ClickHouse/pull/71432) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена ошибка NoSuchKey при откате транзакции, если не удаётся создать каталог для диска palin&#95;rewritable. [#71439](https://github.com/ClickHouse/ClickHouse/pull/71439) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлено использование настройки `max_insert_delayed_streams_for_parallel_write` во вставках. Ранее она работала некорректно, что могло приводить к высокому потреблению памяти при вставках, записывающих данные сразу в несколько партиций. [#71474](https://github.com/ClickHouse/ClickHouse/pull/71474) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена возможная ошибка `Argument for function must be constant` (старый анализатор) в случае, когда `arrayJoin` по-видимому может появиться в условии `WHERE`. Регрессия после [https://github.com/ClickHouse/ClickHouse/pull/65414](https://github.com/ClickHouse/ClickHouse/pull/65414). [#71476](https://github.com/ClickHouse/ClickHouse/pull/71476) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Предотвращён сбой в SortCursor при нулевом количестве столбцов (старый анализатор). [#71494](https://github.com/ClickHouse/ClickHouse/pull/71494) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена проблема выхода значения date32 за допустимый диапазон из-за неинициализированных данных ORC. Подробности см. в [https://github.com/apache/incubator-gluten/issues/7823](https://github.com/apache/incubator-gluten/issues/7823). [#71500](https://github.com/ClickHouse/ClickHouse/pull/71500) ([李扬](https://github.com/taiyang-li)).
* Исправлён расчёт размера столбца в широкой части для типов Dynamic и JSON. [#71526](https://github.com/ClickHouse/ClickHouse/pull/71526) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправление анализатора для случая, когда запрос внутри материализованного представления использует IN с CTE. Закрывает [#65598](https://github.com/ClickHouse/ClickHouse/issues/65598). [#71538](https://github.com/ClickHouse/ClickHouse/pull/71538) ([Maksim Kita](https://github.com/kitaisreal)).
* Возвращать 0 или символ по умолчанию вместо возникновения ошибки в функциях bitShift в случае выхода за границы. [#71580](https://github.com/ClickHouse/ClickHouse/pull/71580) ([Pablo Marcos](https://github.com/pamarcos)).
* Исправлено падение сервера при использовании материализованного представления с определёнными движками. [#71593](https://github.com/ClickHouse/ClickHouse/pull/71593) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Операция ARRAY JOIN с вложенной структурой данных, содержащей алиас константного массива, приводила к разыменованию нулевого указателя. Это закрывает [#71677](https://github.com/ClickHouse/ClickHouse/issues/71677). [#71678](https://github.com/ClickHouse/ClickHouse/pull/71678) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена LOGICAL&#95;ERROR, возникающая при выполнении ALTER с пустым кортежем. Это исправляет [#71647](https://github.com/ClickHouse/ClickHouse/issues/71647). [#71679](https://github.com/ClickHouse/ClickHouse/pull/71679) ([Amos Bird](https://github.com/amosbird)).
* Не преобразовывать константное множество в предикатах над колонками партиционирования в случае оператора NOT IN. [#71695](https://github.com/ClickHouse/ClickHouse/pull/71695) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлена операция `CAST` из `LowCardinality(Nullable)` в `Dynamic`. Ранее это могло приводить к ошибке `Bad cast from type DB::ColumnVector<int> to DB::ColumnNullable`. [#71742](https://github.com/ClickHouse/ClickHouse/pull/71742) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка возникновения исключения при использовании `toDayOfWeek` в условии `WHERE` с первичным ключом типа `DateTime64`. [#71849](https://github.com/ClickHouse/ClickHouse/pull/71849) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлено заполнение значений по умолчанию после разбора в разреженные столбцы. [#71854](https://github.com/ClickHouse/ClickHouse/pull/71854) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка функции GROUPING при использовании ALIAS в качестве входного выражения в распределённой таблице, закрыта задача [#68602](https://github.com/ClickHouse/ClickHouse/issues/68602). [#71855](https://github.com/ClickHouse/ClickHouse/pull/71855) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлены операторы SELECT с предложением `WITH TIES`, которые могли возвращать слишком мало строк. [#71886](https://github.com/ClickHouse/ClickHouse/pull/71886) ([wxybear](https://github.com/wxybear)).
* Исправлено исключение TOO&#95;LARGE&#95;ARRAY&#95;SIZE, возникавшее, когда при вычислении arrayWithConstant столбец ошибочно считался превышающим ограничение на размер массива. [#71894](https://github.com/ClickHouse/ClickHouse/pull/71894) ([Udi](https://github.com/udiz)).
* `clickhouse-benchmark` выводил некорректные метрики для запросов, выполнявшихся дольше одной секунды. [#71898](https://github.com/ClickHouse/ClickHouse/pull/71898) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена гонка данных между индикатором выполнения и таблицей прогресса в clickhouse-client. Эта проблема проявлялась при использовании FROM INFILE. Добавлен перехват нажатий клавиш во время запросов INSERT для переключения отображения таблицы прогресса. [#71901](https://github.com/ClickHouse/ClickHouse/pull/71901) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлена сериализация значений типа Dynamic в форматах Pretty JSON. [#71923](https://github.com/ClickHouse/ClickHouse/pull/71923) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен столбец rows&#95;processed в system.s3/azure&#95;queue&#95;log, некорректно работавший в 24.6. Закрывает [#69975](https://github.com/ClickHouse/ClickHouse/issues/69975). [#71946](https://github.com/ClickHouse/ClickHouse/pull/71946) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен случай, когда функции `s3`/`s3Cluster` могли возвращать неполный результат или выбрасывать исключение. Это происходило при использовании glob-шаблона в URI s3 (например, `pattern/*`), когда требовалось наличие пустого объекта с ключом `pattern/` (такие объекты автоматически создаются в консоли S3). Также значение по умолчанию для настройки `s3_skip_empty_files` изменено с `false` на `true`. [#71947](https://github.com/ClickHouse/ClickHouse/pull/71947) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена ошибка, приводившая к сбою подсветки синтаксиса в clickhouse-client. Закрывает [#71864](https://github.com/ClickHouse/ClickHouse/issues/71864). [#71949](https://github.com/ClickHouse/ClickHouse/pull/71949) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена ошибка `Illegal type` для таблиц `MergeTree` при использовании бинарной монотонной функции в `ORDER BY`, когда первый аргумент — константа. Исправляет [#71941](https://github.com/ClickHouse/ClickHouse/issues/71941). [#71966](https://github.com/ClickHouse/ClickHouse/pull/71966) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Теперь в EXPLAIN AST, используемом внутри подзапроса, допускаются только запросы SELECT. Другие типы запросов приводят к логической ошибке: &#39;Bad cast from type DB::ASTCreateQuery to DB::ASTSelectWithUnionQuery&#39; или `Inconsistent AST formatting`. [#71982](https://github.com/ClickHouse/ClickHouse/pull/71982) ([Pavel Kruglov](https://github.com/Avogar)).
* При вставке записи через `clickhouse-client` клиент считывает описания столбцов с сервера. Однако из‑за ошибки описания записывались в неправильном порядке; правильный порядок: [statistics, ttl, settings]. [#71991](https://github.com/ClickHouse/ClickHouse/pull/71991) ([Han Fei](https://github.com/hanfei1991)).
* Исправлено форматирование команд ALTER `MOVE PARTITION ... TO TABLE ...` при включённой настройке `format_alter_commands_with_parentheses`. [#72080](https://github.com/ClickHouse/ClickHouse/pull/72080) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Добавлено выводимое (автоматически определяемое) имя формата в запрос `CREATE` в движках File/S3/URL/HDFS/Azure. Ранее имя формата заново определялось при каждом перезапуске сервера, и если указанные файлы данных были удалены, это приводило к ошибкам при старте сервера. [#72108](https://github.com/ClickHouse/ClickHouse/pull/72108) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка, из-за которой `min_age_to_force_merge_on_partition_only` застревал, повторно пытаясь объединить один и тот же раздел, который уже был объединён в одну часть, и не объединял разделы с несколькими частями. [#72209](https://github.com/ClickHouse/ClickHouse/pull/72209) ([Christoph Wurm](https://github.com/cwurm)).
* Исправлена ошибка, приводившая в редких случаях к аварийному завершению работы `SimpleSquashingChunksTransform` при обработке разреженных столбцов. [#72226](https://github.com/ClickHouse/ClickHouse/pull/72226) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлена гонка данных в `GraceHashJoin`, из-за которой некоторые строки могли отсутствовать в результате операции JOIN. [#72233](https://github.com/ClickHouse/ClickHouse/pull/72233) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлены запросы `ALTER DELETE` с материализованным столбцом `_block_number` (если включена настройка `enable_block_number_column`). [#72261](https://github.com/ClickHouse/ClickHouse/pull/72261) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена гонка данных, возникавшая при одновременном вызове `ColumnDynamic::dumpStructure()`, например в конструкторе `ConcurrentHashJoin`. [#72278](https://github.com/ClickHouse/ClickHouse/pull/72278) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена возможная ошибка `LOGICAL_ERROR` при наличии дублирующихся столбцов в `ORDER BY ... WITH FILL`. [#72387](https://github.com/ClickHouse/ClickHouse/pull/72387) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлено несоответствие типов в ряде случаев после применения `optimize_functions_to_subcolumns`. [#72394](https://github.com/ClickHouse/ClickHouse/pull/72394) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка при разборе запросов вида `BACKUP DATABASE db EXCEPT TABLES db.table`. [#72429](https://github.com/ClickHouse/ClickHouse/pull/72429) ([Konstantин Bogdanov](https://github.com/thevar1able)).
* Запрещено создание пустого типа Variant. [#72454](https://github.com/ClickHouse/ClickHouse/pull/72454) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено некорректное форматирование `result_part_path` в `system.merges`. [#72567](https://github.com/ClickHouse/ClickHouse/pull/72567) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлен разбор glob-шаблона с одним элементом. [#72572](https://github.com/ClickHouse/ClickHouse/pull/72572) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлена генерация запросов для ведомого сервера в случае распределённого запроса с `ARRAY JOIN`. Устраняет проблему [#69276](https://github.com/ClickHouse/ClickHouse/issues/69276). [#72608](https://github.com/ClickHouse/ClickHouse/pull/72608) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена ошибка, из-за которой DateTime64 в DateTime64 не возвращал ничего. [#72640](https://github.com/ClickHouse/ClickHouse/pull/72640) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена ошибка «No such key» в режиме S3Queue Unordered при значении настройки `tracked_files_limit` меньше скорости появления файлов в S3. [#72738](https://github.com/ClickHouse/ClickHouse/pull/72738) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Удаление большого кэша меток может занять заметное время. Если при этом удерживать мьютекс контекста, это блокирует множество других операций, новые клиентские подключения также не могут быть установлены, пока мьютекс не будет освобождён. При этом удержание этого мьютекса на самом деле не требуется для синхронизации — достаточно иметь локальную ссылку на кэш через `shared_ptr`. [#72749](https://github.com/ClickHouse/ClickHouse/pull/72749) ([Alexander Gololobov](https://github.com/davenger)).
* Кэш PK сильно недооценивал свой размер на одном из тестовых инстансов. В частности, столбцы LowCardinality не учитывали размер словаря. Исправление — использовать column-&gt;allocatedBytes() вместе с дополнительной оценкой накладных расходов для размера элемента кэша. [#72750](https://github.com/ClickHouse/ClickHouse/pull/72750) ([Alexander Gololobov](https://github.com/davenger)).
* Исправлено возникновение исключения в RemoteQueryExecutor, когда пользователь отсутствует в локальной системе. [#72759](https://github.com/ClickHouse/ClickHouse/pull/72759) ([Andrey Zvonov](https://github.com/zvonand)).
* Исправлены мутации с материализованным столбцом `_block_number` (если включена настройка `enable_block_number_column`). [#72854](https://github.com/ClickHouse/ClickHouse/pull/72854) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено резервное копирование/восстановление с использованием обычного перезаписываемого диска при наличии пустых файлов в резервной копии. [#72858](https://github.com/ClickHouse/ClickHouse/pull/72858) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Корректная отмена вставок в DistributedAsyncInsertDirectoryQueue. [#72885](https://github.com/ClickHouse/ClickHouse/pull/72885) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено аварийное завершение при разборе некорректных данных в разрежённые столбцы (могло происходить при включённой настройке `enable_parsing_to_custom_serialization`). [#72891](https://github.com/ClickHouse/ClickHouse/pull/72891) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено потенциальное падение при восстановлении из резервной копии. [#72947](https://github.com/ClickHouse/ClickHouse/pull/72947) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка в методе JOIN `parallel_hash`, которая могла возникать при наличии в запросе сложного условия в `ON` с фильтрами неравенства. [#72993](https://github.com/ClickHouse/ClickHouse/pull/72993) ([Nikita Taranov](https://github.com/nickitat)).
* Используйте настройки формата по умолчанию при разборе JSON, чтобы избежать некорректной десериализации. [#73043](https://github.com/ClickHouse/ClickHouse/pull/73043) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка, приводившая к аварийному завершению транзакций при использовании неподдерживаемого хранилища. [#73045](https://github.com/ClickHouse/ClickHouse/pull/73045) ([Raúl Marín](https://github.com/Algunenano)).
* Проверяется наличие дублирующихся ключей JSON при разборе значений типа `Tuple`. Ранее это могло приводить к логической ошибке `Invalid number of rows in Chunk` при разборе. [#73082](https://github.com/ClickHouse/ClickHouse/pull/73082) ([Pavel Kruglov](https://github.com/Avogar)).
