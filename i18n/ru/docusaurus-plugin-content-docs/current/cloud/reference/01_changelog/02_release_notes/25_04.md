---
slug: /changelogs/25.4
title: 'Журнал изменений v25.4 для Cloud'
description: 'Журнал быстрых релизов для v25.4'
keywords: ['changelog', 'cloud']
sidebar_label: '25.4'
sidebar_position: 3
doc_type: 'changelog'
---



## Обратно несовместимые изменения {#backward-incompatible-changes}


* Формат вывода Parquet конвертирует столбцы типов Date и DateTime в типы даты и времени, поддерживаемые Parquet, вместо записи их в виде сырых чисел. DateTime становится DateTime64(3) (ранее: UInt32); установка параметра `output_format_parquet_datetime_as_uint32` возвращает прежнее поведение. Date становится Date32 (ранее: UInt16). [#70950](https://github.com/ClickHouse/ClickHouse/pull/70950) ([Michael Kolupaev](https://github.com/al13n321)).
* По умолчанию запретить использование сравнимых типов (таких как JSON/Object/AggregateFunction) в ORDER BY и в функциях сравнения `less/greater/equal/etc`. [#73276](https://github.com/ClickHouse/ClickHouse/pull/73276) ([Pavel Kruglov](https://github.com/Avogar)).
* `JSONEachRowWithProgress` будет записывать прогресс каждый раз, когда он обновляется. В предыдущих версиях прогресс отображался только после каждого блока результата, что делало его бесполезным. Изменён способ отображения прогресса: нулевые значения показываться не будут. Имейте в виду, что прогресс отправляется даже при частых обновлениях. Это может генерировать значительный объём трафика. Имейте в виду, что прогресс не сбрасывается, когда вывод сжат. Закрывает [#70800](https://github.com/ClickHouse/ClickHouse/issues/70800). [#73834](https://github.com/ClickHouse/ClickHouse/pull/73834) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Источник словаря `mysql` больше не выполняет запрос `SHOW TABLE STATUS`, поскольку он не даёт никакой полезной информации для таблиц InnoDB, как и для любых современных версий MySQL. Это закрывает [#72636](https://github.com/ClickHouse/ClickHouse/issues/72636). Это изменение обратно совместимо, но отнесено к этой категории, чтобы вы могли его заметить. [#73914](https://github.com/ClickHouse/ClickHouse/pull/73914) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Таблицы `Merge` будут унифицировать структуру исходных таблиц, используя объединение их столбцов и выводя общие типы. Это закрывает [#64864](https://github.com/ClickHouse/ClickHouse/issues/64864). Это закрывает [#35307](https://github.com/ClickHouse/ClickHouse/issues/35307). В некоторых случаях это изменение может быть обратно несовместимым. Один из примеров — когда между таблицами нет общего типа, но преобразование к типу первой таблицы всё ещё возможно, как в случае с UInt64 и Int64 или любым числовым типом и String. Если вы хотите вернуться к старому поведению, установите `merge_table_max_tables_to_look_for_schema_inference` в `1` или установите `compatibility` в `24.12` или более раннее значение. [#73956](https://github.com/ClickHouse/ClickHouse/pull/73956) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Запросы `CHECK TABLE` теперь требуют отдельного привилегии `CHECK`. В предыдущих версиях для выполнения этих запросов было достаточно привилегии `SHOW TABLES`. Однако запрос `CHECK TABLE` может быть ресурсоёмким, и обычные ограничения сложности для запросов `SELECT` к нему не применяются. Это создавало потенциальную возможность атаки типа DoS. [#74471](https://github.com/ClickHouse/ClickHouse/pull/74471) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Проверяется, что все столбцы в материализованном представлении соответствуют целевой таблице, если `allow_materialized_view_with_bad_select` имеет значение `false`. [#74481](https://github.com/ClickHouse/ClickHouse/pull/74481) ([Christoph Wurm](https://github.com/cwurm)).
* Функция `h3ToGeo()` теперь возвращает результаты в порядке `(lat, lon)` (это стандартный порядок для геометрических функций). Пользователи, которые хотят сохранить прежний порядок результатов `(lon, lat)`, могут установить настройку `h3togeo_lon_lat_result_order = true`. [#74719](https://github.com/ClickHouse/ClickHouse/pull/74719) ([Manish Gill](https://github.com/mgill25)).
* Добавлены форматы `JSONCompactEachRowWithProgress` и `JSONCompactStringsEachRowWithProgress`. Продолжение [#69989](https://github.com/ClickHouse/ClickHouse/issues/69989). Форматы `JSONCompactWithNames` и `JSONCompactWithNamesAndTypes` больше не выводят «totals» — по‑видимому, это была ошибка в реализации. [#75037](https://github.com/ClickHouse/ClickHouse/pull/75037) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Изменено значение по умолчанию настройки `format_alter_operations_with_parentheses` на true, чтобы сделать список команд ALTER однозначным (см. [https://github.com/ClickHouse/ClickHouse/pull/59532](https://github.com/ClickHouse/ClickHouse/pull/59532)). Это нарушает репликацию с кластерами версий до 24.3. Если вы обновляете кластер со старых версий, отключите этот параметр в конфигурации сервера или сначала обновитесь до 24.3. [#75302](https://github.com/ClickHouse/ClickHouse/pull/75302) ([Raúl Marín](https://github.com/Algunenano)).
* Запрещено выполнять `TRUNCATE DATABASE` для реплицированных баз данных. [#76651](https://github.com/ClickHouse/ClickHouse/pull/76651) ([Bharat Nallan](https://github.com/bharatnc)).
* Теперь использование parallel replicas по умолчанию отключено, когда analyzer выключен, независимо от настройки `compatibility`. По-прежнему можно изменить это поведение, явно установив `parallel_replicas_only_with_analyzer` в `false`. [#77115](https://github.com/ClickHouse/ClickHouse/pull/77115) ([Igor Nikonov](https://github.com/devcrafter)).
* Больше нельзя использовать `NaN` или `inf` в качестве значений с плавающей запятой для настроек. [#77546](https://github.com/ClickHouse/ClickHouse/pull/77546) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправляет случаи использования `dateTrunc` с отрицательными аргументами типа date/datetime. [#77622](https://github.com/ClickHouse/ClickHouse/pull/77622) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Устаревшая интеграция с MongoDB была удалена. Серверная настройка `use_legacy_mongodb_integration` признана устаревшей и теперь ни на что не влияет. [#77895](https://github.com/ClickHouse/ClickHouse/pull/77895) ([Robert Schulze](https://github.com/rschu1ze)).
* Улучшена проверка SummingMergeTree, чтобы пропускать агрегацию для столбцов, используемых в ключах партиционирования или сортировки. [#78022](https://github.com/ClickHouse/ClickHouse/pull/78022) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).





## Новые возможности {#new-features}


* Добавлен кэш в памяти для десериализованных гранул skipping-индексов. Это должно ускорить повторяющиеся запросы, использующие skipping-индексы. Размер нового кэша управляется настройками сервера `skipping_index_cache_size` и `skipping_index_cache_max_entries`. Первоначальной мотивацией для добавления кэша были индексы векторного сходства, которые теперь работают значительно быстрее. [#70102](https://github.com/ClickHouse/ClickHouse/pull/70102) ([Robert Schulze](https://github.com/rschu1ze)).
* Новая реализация Userspace Page Cache, позволяющая кэшировать данные в памяти процесса вместо использования кэша страниц операционной системы. Это полезно, когда данные хранятся на удалённой виртуальной файловой системе без локального файлового кэша. [#70509](https://github.com/ClickHouse/ClickHouse/pull/70509) ([Michael Kolupaev](https://github.com/al13n321)).
* Добавлена настройка для выполнения запросов к таблицам Iceberg на состояние на указанный момент времени. [#71072](https://github.com/ClickHouse/ClickHouse/pull/71072) ([Brett Hoerner](https://github.com/bretthoerner)).
* Реализовано отсечение партиций (partition pruning) для таблиц Iceberg при операциях партиционирования по временным трансформациям. [#72044](https://github.com/ClickHouse/ClickHouse/pull/72044) ([Daniil Ivanik](https://github.com/divanik)).
* Добавлена возможность по умолчанию создавать min-max (skipping) индексы для столбцов семейства MergeTree с помощью настроек `enable_minmax_index_for_all_numeric_columns` (для числовых столбцов) и `enable_minmax_index_for_all_string_columns` (для строковых столбцов). Пока обе настройки отключены, поэтому поведение ещё не изменилось. [#72090](https://github.com/ClickHouse/ClickHouse/pull/72090) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Добавлена агрегатная функция sequenceMatchEvents, которая возвращает временные метки событий, совпавших с самым длинным совпавшим шаблоном. [#72349](https://github.com/ClickHouse/ClickHouse/pull/72349) ([UnamedRus](https://github.com/UnamedRus)).
* Операторы `SELECT` и `VIEW` теперь поддерживают псевдонимы, например: `SELECT b FROM (SELECT number, number*2 FROM numbers(2)) AS x (a, b);`. Это позволяет выполнять запрос TPC-H 15 без изменений. [#72480](https://github.com/ClickHouse/ClickHouse/pull/72480) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена новая настройка `enable_adaptive_memory_spill_scheduler`, которая позволяет нескольким grace JOIN в одном запросе отслеживать их суммарное потребление памяти и адаптивно запускать выгрузку во внешнее хранилище, чтобы предотвратить MEMORY&#95;LIMIT&#95;EXCEEDED. [#72728](https://github.com/ClickHouse/ClickHouse/pull/72728) ([lgbo](https://github.com/lgbo-ustc)).
* Добавлена функция `arrayNormalizedGini`. [#72823](https://github.com/ClickHouse/ClickHouse/pull/72823) ([flynn](https://github.com/ucasfl)).
* Добавлена поддержка десятичных типов данных LowCardinality, исправлена проблема [#72256](https://github.com/ClickHouse/ClickHouse/issues/72256). [#72833](https://github.com/ClickHouse/ClickHouse/pull/72833) ([zhanglistar](https://github.com/zhanglistar)).
* Когда одновременно включены параметры `min_age_to_force_merge_seconds` и `min_age_to_force_merge_on_partition_only`, слияние кусков будет игнорировать ограничение на максимальный размер в байтах. [#73656](https://github.com/ClickHouse/ClickHouse/pull/73656) ([Kai Zhu](https://github.com/nauu)).
* Реализована поддержка чтения значений HALF&#95;FLOAT из Apache Arrow/Parquet/ORC (они читаются как Float32). Это закрывает [#72960](https://github.com/ClickHouse/ClickHouse/issues/72960). Имейте в виду, что число половинной точности IEEE-754 (half float) — это не то же самое, что BFloat16. Закрывает [#73835](https://github.com/ClickHouse/ClickHouse/issues/73835). [#73836](https://github.com/ClickHouse/ClickHouse/pull/73836) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Таблица `system.trace_log` будет содержать два новых столбца — `symbols` и `lines` с символизированным стек-трейсом. Это позволяет легко собирать и экспортировать информацию профилирования. Поведение управляется значением параметра конфигурации сервера `symbolize` в секции `trace_log` и по умолчанию включено. [#73896](https://github.com/ClickHouse/ClickHouse/pull/73896) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена новая функция `generateSerialID`, которую можно использовать для генерации автоинкрементных чисел в таблицах. Продолжение [#64310](https://github.com/ClickHouse/ClickHouse/issues/64310) от [kazalika](https://github.com/kazalika). Закрывает [#62485](https://github.com/ClickHouse/ClickHouse/issues/62485). [#73950](https://github.com/ClickHouse/ClickHouse/pull/73950) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен синтаксис `query1 PARALLEL WITH query2 PARALLEL WITH query3 ... PARALLEL WITH queryN`. Это означает, что подзапросы `{query1, query2, ... queryN}` могут (и по возможности должны) выполняться параллельно друг с другом. [#73983](https://github.com/ClickHouse/ClickHouse/pull/73983) ([Vitaly Baranov](https://github.com/vitlibar)).
* Теперь в Play UI есть индикатор прогресса во время выполнения запроса. Он позволяет отменять запросы и отображает общее количество записей, а также подробную информацию о скорости. Таблица может отображаться по мере поступления данных. Включите HTTP-сжатие. Отрисовка таблицы стала быстрее. Заголовок таблицы стал фиксированным. Теперь можно выделять ячейки и перемещаться по ним с помощью клавиш со стрелками. Исправлена проблема, из-за которой контур выделенной ячейки делал её меньше. Ячейки больше не расширяются при наведении курсора, а только при выборе. Момент остановки отрисовки входящих данных теперь определяется на стороне клиента, а не сервера. Для чисел добавлено разделение цифр на группы. Общий дизайн был обновлён и стал более выразительным. Выполняется проверка доступности сервера и корректности учётных данных, а также отображаются версия сервера и время его работы. Значок облака стал контурным для любого шрифта, в том числе в Safari. Большие целые числа внутри вложенных типов данных будут отображаться лучше. Значения inf/nan отображаются корректно. Типы данных отображаются при наведении курсора на заголовок столбца. [#74204](https://github.com/ClickHouse/ClickHouse/pull/74204) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность по умолчанию создавать min-max (skipping) индексы для столбцов семейства MergeTree с помощью настроек `add_minmax_index_for_numeric_columns` (для числовых столбцов) и `add_minmax_index_for_string_columns` (для строковых столбцов). Пока обе настройки отключены, поэтому изменения в поведении ещё нет. [#74266](https://github.com/ClickHouse/ClickHouse/pull/74266) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Добавлены поля `script_query_number` и `script_line_number` в `system.query_log`, в ClientInfo в нативном протоколе и в серверные логи. Это закрывает [#67542](https://github.com/ClickHouse/ClickHouse/issues/67542). Благодарность [pinsvin00](https://github.com/pinsvin00) за то, что раньше инициировал эту функциональность в [#68133](https://github.com/ClickHouse/ClickHouse/issues/68133). [#74477](https://github.com/ClickHouse/ClickHouse/pull/74477) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка оператора вычитания для DateTime64, что позволяет выполнять вычитание между значениями DateTime64, а также DateTime. [#74482](https://github.com/ClickHouse/ClickHouse/pull/74482) ([Li Yin](https://github.com/liyinsg)).
* Поддержка движка таблиц DeltaLake для AzureBlobStorage. Исправление [#68043](https://github.com/ClickHouse/ClickHouse/issues/68043). [#74541](https://github.com/ClickHouse/ClickHouse/pull/74541) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Добавлена настройка bind&#95;host для указания исходного IP-адреса подключений клиента clickhouse. [#74741](https://github.com/ClickHouse/ClickHouse/pull/74741) ([Todd Yocum](https://github.com/toddyocum)).
* Добавлена возможность применять незавершённые мутации (ещё не материализованные фоновым процессом) во время выполнения запросов `SELECT` сразу после их отправки. Это можно включить, установив `apply_mutations_on_fly`. [#74877](https://github.com/ClickHouse/ClickHouse/pull/74877) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены некоторые ранее неожиданные случаи, когда аргументы типа `datetime` у функции `toStartOfInterval` были отрицательными. Это сделано за счёт реализации новой функции toStartOfIntervalAllowNegative, которая делает по сути то же самое, но возвращает только Date32/DateTime64. [#74933](https://github.com/ClickHouse/ClickHouse/pull/74933) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена новая функция initialQueryStartTime. Она возвращает время начала выполнения текущего запроса. При распределённом запросе это значение одинаково на всех шардах. [#75087](https://github.com/ClickHouse/ClickHouse/pull/75087) ([Roman Lomonosov](https://github.com/lomik)).
* Добавлен столбец parametrized&#95;view&#95;parameters в system.tables. Закрывает [https://github.com/clickhouse/clickhouse/issues/66756](https://github.com/clickhouse/clickhouse/issues/66756). [#75112](https://github.com/ClickHouse/ClickHouse/pull/75112) ([NamNguyenHoai](https://github.com/NamHoaiNguyen)).
* Разрешено изменять комментарий базы данных. Закрывает [#73351](https://github.com/ClickHouse/ClickHouse/issues/73351) ### Запись в документации об изменениях, видимых пользователям. [#75622](https://github.com/ClickHouse/ClickHouse/pull/75622) ([NamNguyenHoai](https://github.com/NamHoaiNguyen)).
* Добавлена возможность выполнять ATTACH таблиц без уровня базы данных (без использования хака с UUID). [#75788](https://github.com/ClickHouse/ClickHouse/pull/75788) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена настройка сервера `concurrent_threads_scheduler`, которая определяет, как распределяются слоты CPU между параллельно выполняющимися запросами. Можно установить значение `round_robin` (предыдущее поведение) или `fair_round_robin`, чтобы устранить проблему несправедливого распределения CPU между INSERT и SELECT. [#75949](https://github.com/ClickHouse/ClickHouse/pull/75949) ([Sergei Trifonov](https://github.com/serxa)).
* Восстановлен кодек QPL, который был удалён в v24.10 из-за лицензионных вопросов. [#76021](https://github.com/ClickHouse/ClickHouse/pull/76021) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Добавлена функция `arraySymmetricDifference`. Она возвращает все элементы из нескольких массивов-аргументов, которые не присутствуют во всех аргументах одновременно. Пример: `SELECT arraySymmetricDifference([1, 2], [2, 3])` возвращает `[1, 3]`. (issue [#61673](https://github.com/ClickHouse/ClickHouse/issues/61673)). [#76231](https://github.com/ClickHouse/ClickHouse/pull/76231) ([Filipp Abapolov](https://github.com/pheepa)).
* Добавлена агрегатная функция `estimatecompressionratio` — см. [#70801](https://github.com/ClickHouse/ClickHouse/issues/70801). [#76661](https://github.com/ClickHouse/ClickHouse/pull/76661) ([Tariq Almawash](https://github.com/talmawash)).
* Профильные события `FilterTransformPassedRows` и `FilterTransformPassedBytes` показывают количество строк и байт, отфильтрованных во время выполнения запроса. [#76662](https://github.com/ClickHouse/ClickHouse/pull/76662) ([Onkar Deshpande](https://github.com/onkar)).
* Добавлена хеш-функция keccak256, широко используемая в блокчейн-реализациях, особенно в системах на основе EVM. [#76669](https://github.com/ClickHouse/ClickHouse/pull/76669) ([Arnaud Briche](https://github.com/arnaudbriche)).
* Scram SHA256 и обновление аутентификации по протоколу Postgres wire. [#76839](https://github.com/ClickHouse/ClickHouse/pull/76839) ([scanhex12](https://github.com/scanhex12)).
* Добавлена возможность задавать список заголовков, которые пересылаются из заголовков клиентского запроса во внешний HTTP-аутентификатор. [#77054](https://github.com/ClickHouse/ClickHouse/pull/77054) ([inv2004](https://github.com/inv2004)).
* Добавлена поддержка `IcebergMetadataFilesCache`, который хранит manifest-файлы/список и metadata.json в одном кэше. [#77156](https://github.com/ClickHouse/ClickHouse/pull/77156) ([Han Fei](https://github.com/hanfei1991)).
* Добавлены функции `arrayLevenshteinDistance`, `arrayLevenshteinDistanceWeighted` и `arraySimilarity`. [#77187](https://github.com/ClickHouse/ClickHouse/pull/77187) ([Mikhail F. Shiryaev](https://github.com/Felixoid)).
* Добавлены три новые функции: `icebergTruncate` в соответствии со спецификацией [https://iceberg.apache.org/spec/#truncate-transform-details](https://iceberg.apache.org/spec/#truncate-transform-details), `toYearNumSinceEpoch` и `toMonthNumSinceEpoch`. Добавлена поддержка преобразования `truncate` при отсечении партиций для движка `Iceberg`. [#77403](https://github.com/ClickHouse/ClickHouse/pull/77403) ([alesapin](https://github.com/alesapin)).
* Позволяет пользователю выполнять запрос к состоянию таблицы Iceberg в том виде, в каком она существовала в предыдущий момент времени. [#77439](https://github.com/ClickHouse/ClickHouse/pull/77439) ([Daniil Ivanik](https://github.com/divanik)).
* Добавлено планирование слотов CPU для рабочих нагрузок, подробности см. в разделе [https://clickhouse.com/docs/operations/workload-scheduling#cpu&#95;scheduling](https://clickhouse.com/docs/operations/workload-scheduling#cpu_scheduling). [#77595](https://github.com/ClickHouse/ClickHouse/pull/77595) ([Sergei Trifonov](https://github.com/serxa)).
* Функция `hasAll()` теперь может использовать полнотекстовые индексы пропуска tokenbf&#95;v1 и ngrambf&#95;v1. [#77662](https://github.com/ClickHouse/ClickHouse/pull/77662) ([UnamedRus](https://github.com/UnamedRus)).
* Тип данных `JSON` готов для использования в продакшене. См. [https://jsonbench.com/](https://jsonbench.com/). Типы данных `Dynamic` и `Varaint` также готовы для использования в продакшене. [#77785](https://github.com/ClickHouse/ClickHouse/pull/77785) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен кэш в памяти для десериализованных индексов векторного сходства. Это должно ускорить повторяющиеся запросы поиска приблизительных ближайших соседей (ANN). Размер нового кэша управляется настройками сервера `vector_similarity_index_cache_size` и `vector_similarity_index_cache_max_entries`. Эта возможность заменяет механизм кэширования пропускающего индекса из более ранних релизов. [#77905](https://github.com/ClickHouse/ClickHouse/pull/77905) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Добавлены функции sparseGrams и sparseGramsHashes, а также их версии для UTF‑8. Автор: [scanhex12](https://github.com/scanhex12). [#78176](https://github.com/ClickHouse/ClickHouse/pull/78176) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Добавлена функция `toInterval`. Эта функция принимает 2 аргумента (value и unit) и преобразует значение в соответствующий тип `Interval`. [#78723](https://github.com/ClickHouse/ClickHouse/pull/78723) ([Andrew Davis](https://github.com/pulpdrew)).





## Экспериментальные функции {#experimental-features}

- Добавлена возможность автоматической очистки при слиянии целых партиций после настраиваемого таймаута с помощью новой настройки `enable_replacing_merge_with_cleanup_for_min_age_to_force_merge`. [#76440](https://github.com/ClickHouse/ClickHouse/pull/76440) ([Christoph Wurm](https://github.com/cwurm)).
- Добавлена поддержка [Unity Catalog](https://www.databricks.com/product/unity-catalog) для таблиц DeltaLake на базе AWS S3 и локальной файловой системы. [#76988](https://github.com/ClickHouse/ClickHouse/pull/76988) ([alesapin](https://github.com/alesapin)).
- Добавлена экспериментальная интеграция с каталогом сервиса AWS Glue для таблиц Iceberg. [#77257](https://github.com/ClickHouse/ClickHouse/pull/77257) ([alesapin](https://github.com/alesapin)).


## Улучшения производительности {#performance-improvements}


* Оптимизируйте производительность с помощью «ленивых» проекций, чтобы избежать чтения неиспользуемых столбцов. [#55518](https://github.com/ClickHouse/ClickHouse/pull/55518) ([Xiaozhe Yu](https://github.com/wudidapaopao)).
* Начато сравнение строк в первую очередь по столбцам, где совпадение наименее вероятно. [#63780](https://github.com/ClickHouse/ClickHouse/pull/63780) ([UnamedRus](https://github.com/UnamedRus)).
* Оптимизирован формат ввода RowBinary. Исправляет [#63805](https://github.com/ClickHouse/ClickHouse/issues/63805). [#65059](https://github.com/ClickHouse/ClickHouse/pull/65059) ([Pavel Kruglov](https://github.com/Avogar)).
* Ускорена десериализация строк за счет некоторых низкоуровневых оптимизаций. [#65948](https://github.com/ClickHouse/ClickHouse/pull/65948) ([Nikita Taranov](https://github.com/nickitat)).
* Атрибут `preserve_most` применён в нескольких местах кода. [#67778](https://github.com/ClickHouse/ClickHouse/pull/67778) ([Nikita Taranov](https://github.com/nickitat)).
* Реализован кэш условий запроса для улучшения производительности запросов с повторяющимися предикатами. Диапазон части данных, не удовлетворяющей условию, запоминается как временный индекс в памяти. Последующие запросы будут использовать этот индекс. close [#67768](https://github.com/ClickHouse/ClickHouse/issues/67768) ### Запись в документации для изменений, заметных пользователям. [#69236](https://github.com/ClickHouse/ClickHouse/pull/69236) ([zhongyuankai](https://github.com/zhongyuankai)).
* Добавлена поддержка асинхронного предварительного чтения (async I/O prefetch) для `NativeORCBlockInputFormat`, что улучшает общую производительность за счёт скрытия задержок удалённого ввода-вывода. В моём тестовом примере ускорение достигало 1,47 раза. [#70534](https://github.com/ClickHouse/ClickHouse/pull/70534) ([李扬](https://github.com/taiyang-li)).
* Улучшена производительность grace hash join за счёт повторного перераспределения правой таблицы соединения по ключам (rerange). [#72237](https://github.com/ClickHouse/ClickHouse/pull/72237) ([kevinyhzou](https://github.com/KevinyhZou)).
* Повторно добавлена поддержка параметра `ttl_only_drop_parts` в `materialize ttl`; для перерасчета TTL читаются только необходимые столбцы, а части удаляются путем их замены на пустые. [#72751](https://github.com/ClickHouse/ClickHouse/pull/72751) ([Andrey Zvonov](https://github.com/zvonand)).
* Позволяет `arrayROCAUC` и `arrayAUCPR` вычислять частичную площадь под всей кривой, чтобы их вычисление можно было распараллелить на огромных наборах данных. [#72904](https://github.com/ClickHouse/ClickHouse/pull/72904) ([Emmanuel](https://github.com/emmanuelsdias)).
* Избегайте создания слишком большого числа неактивных потоков. [#72920](https://github.com/ClickHouse/ClickHouse/pull/72920) ([Guo Wangyang](https://github.com/guowangy)).
* Разбиение блоков левой таблицы по хэшу было убрано из фазы probe алгоритма JOIN `parallel_hash`. [#73089](https://github.com/ClickHouse/ClickHouse/pull/73089) ([Nikita Taranov](https://github.com/nickitat)).
* Не перечислять ключи blob-хранилища, если в табличной функции используется только раскрытие фигурных скобок. Закрывает [#73333](https://github.com/ClickHouse/ClickHouse/issues/73333). [#73518](https://github.com/ClickHouse/ClickHouse/pull/73518) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Заменены Int256 и UInt256 на встроенный тип clang i256 в арифметических вычислениях согласно тестам в [#70502](https://github.com/ClickHouse/ClickHouse/issues/70502). [#73658](https://github.com/ClickHouse/ClickHouse/pull/73658) ([李扬](https://github.com/taiyang-li)).
* Добавлен быстрый путь для функций, у которых все аргументы имеют числовые типы. Исправлены проблемы с производительностью в [https://github.com/ClickHouse/ClickHouse/pull/72258](https://github.com/ClickHouse/ClickHouse/pull/72258). [#73820](https://github.com/ClickHouse/ClickHouse/pull/73820) ([李扬](https://github.com/taiyang-li)).
* Не применять `maskedExecute` к столбцам, не являющимся функциями; улучшена производительность выполнения с коротким замыканием. [#73965](https://github.com/ClickHouse/ClickHouse/pull/73965) ([lgbo](https://github.com/lgbo-ustc)).
* Отключено определение заголовков для Kafka/NATS/RabbitMQ/FileLog для повышения производительности. [#74006](https://github.com/ClickHouse/ClickHouse/pull/74006) ([Azat Khuzhin](https://github.com/azat)).
* Используйте лог-обёртки как значения и не размещайте их в куче. [#74034](https://github.com/ClickHouse/ClickHouse/pull/74034) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Выполнять конвейер с более высокой степенью параллелизма после агрегации с `GROUPING SETS`. [#74082](https://github.com/ClickHouse/ClickHouse/pull/74082) ([Nikita Taranov](https://github.com/nickitat)).
* Уменьшена критическая секция в `MergeTreeReadPool`. [#74202](https://github.com/ClickHouse/ClickHouse/pull/74202) ([Guo Wangyang](https://github.com/guowangy)).
* Оптимизирована функция `indexHint`. Теперь столбцы, которые используются только в качестве аргументов функции `indexHint`, не читаются из таблицы. [#74314](https://github.com/ClickHouse/ClickHouse/pull/74314) ([Anton Popov](https://github.com/CurtizJ)).
* Улучшена производительность при использовании параллельных реплик. Десериализация пакетов на инициаторе запроса для пакетов, не относящихся к протоколу параллельных реплик, теперь всегда выполняется в потоке конвейера. Ранее она могла выполняться в потоке, отвечающем за планирование конвейера, что снижало отзывчивость инициатора и задерживало выполнение конвейера. [#74398](https://github.com/ClickHouse/ClickHouse/pull/74398) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлен расчёт размера в памяти для столбцов `LowCardinality`. [#74688](https://github.com/ClickHouse/ClickHouse/pull/74688) ([Nikita Taranov](https://github.com/nickitat)).
* Улучшена производительность чтения целого JSON-столбца в Wide-частях из S3. Это достигнуто за счёт добавления предварительной выборки для десериализации префиксов подстолбцов, кеша десериализованных префиксов и параллельной десериализации префиксов подстолбцов. Это ускоряет чтение JSON-столбца из S3 в 4 раза в запросах вида `SELECT data FROM table` и примерно в 10 раз в запросах вида `SELECT data FROM table LIMIT 10`. [#74827](https://github.com/ClickHouse/ClickHouse/pull/74827) ([Pavel Kruglov](https://github.com/Avogar)).
* Предварительно выделять память для асинхронных вставок, чтобы повысить производительность. [#74945](https://github.com/ClickHouse/ClickHouse/pull/74945) ([Ilya Golshtein](https://github.com/ilejn)).
* Исправлено двойное предварительное выделение памяти в `ConcurrentHashJoin` в случае, когда оптимизатор меняет стороны `JOIN` местами. [#75149](https://github.com/ClickHouse/ClickHouse/pull/75149) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена избыточная конкуренция в `parallel_hash`, когда `max_rows_in_join = max_bytes_in_join = 0`. [#75155](https://github.com/ClickHouse/ClickHouse/pull/75155) ([Nikita Taranov](https://github.com/nickitat)).
* Незначительное улучшение в некоторых сценариях `JOIN`: предварительно вычислять количество выходных строк и резервировать для них память. [#75376](https://github.com/ClickHouse/ClickHouse/pull/75376) ([Alexander Gololobov](https://github.com/davenger)).
* Файлы метаданных `plain_rewritable` имеют небольшой размер и не требуют большого буфера по умолчанию. Используйте буфер записи подходящего размера, соответствующий заданному пути, чтобы улучшить использование памяти при большом количестве активных кусков. ### Запись в документации для изменений, заметных пользователям. [#75758](https://github.com/ClickHouse/ClickHouse/pull/75758) ([Julia Kartseva](https://github.com/jkartseva)).
* В некоторых случаях (например, для пустого столбца-массива) части данных могут содержать пустые файлы. В таких случаях можно не записывать пустые блобы в ObjectStorage и сохранять только метаданные для этих файлов, если таблица размещена на диске с раздельными хранилищами метаданных и объектов. [#75860](https://github.com/ClickHouse/ClickHouse/pull/75860) ([Alexander Gololobov](https://github.com/davenger)).
* Было обнаружено, что управление конкурентным выполнением могло приводить к несправедливому распределению ресурсов CPU между INSERT и SELECT. Это происходило, когда все CPU‑слоты безусловно (без конкуренции) выделялись для INSERT с `max_threads` = 1, в то время как SELECT с большим значением `max_threads` страдали от низкой производительности из‑за использования только одного потока. [#75941](https://github.com/ClickHouse/ClickHouse/pull/75941) ([Sergei Trifonov](https://github.com/serxa)).
* Незначительная оптимизация в `wrapInNullable` для предотвращения лишнего выделения `null map`. [#76489](https://github.com/ClickHouse/ClickHouse/pull/76489) ([李扬](https://github.com/taiyang-li)).
* Улучшена производительность операций MIN/MAX для `Decimal32`/`Decimal64`/`DateTime64`. [#76570](https://github.com/ClickHouse/ClickHouse/pull/76570) ([李扬](https://github.com/taiyang-li)).
* Активно удаляйте данные из кэша при удалении парций. Не допускайте роста кэша до максимального размера, если объём данных меньше. [#76641](https://github.com/ClickHouse/ClickHouse/pull/76641) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Компиляция запросов (настройка `compile_expressions`) теперь учитывает тип машины. Это значительно ускоряет такие запросы. [#76753](https://github.com/ClickHouse/ClickHouse/pull/76753) ([Robert Schulze](https://github.com/rschu1ze)).
* Оптимизирована функция `arraySort`. [#76850](https://github.com/ClickHouse/ClickHouse/pull/76850) ([李扬](https://github.com/taiyang-li)).
* Ускорено построение результата JOIN за счёт девиртуализации вызовов `col->insertFrom()`. [#77350](https://github.com/ClickHouse/ClickHouse/pull/77350) ([Alexander Gololobov](https://github.com/davenger)).
* Объединены метки одной части и выполнена их разовая запись в кэш условий запроса, чтобы снизить затраты на блокировки. [#77377](https://github.com/ClickHouse/ClickHouse/pull/77377) ([zhongyuankai](https://github.com/zhongyuankai)).
* Оптимизирован `ORDER BY` по одному nullable- или low-cardinality-столбцу. [#77789](https://github.com/ClickHouse/ClickHouse/pull/77789) ([李扬](https://github.com/taiyang-li)).
* Отключайте `filesystem_cache_prefer_bigger_buffer_size`, когда кэш используется пассивно, например при слияниях. [#77898](https://github.com/ClickHouse/ClickHouse/pull/77898) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Реализована тривиальная оптимизация подсчёта для Iceberg. Теперь запросы с `count()` и без каких-либо фильтров должны выполняться быстрее. Закрывает [#77639](https://github.com/ClickHouse/ClickHouse/issues/77639). [#78090](https://github.com/ClickHouse/ClickHouse/pull/78090) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка отсечения данных Iceberg на основе значений `lower_bound` и `upper_bound` для столбцов. Исправляет [#77638](https://github.com/ClickHouse/ClickHouse/issues/77638). [#78242](https://github.com/ClickHouse/ClickHouse/pull/78242) ([alesapin](https://github.com/alesapin)).
* Оптимизировано потребление памяти для NativeReader. [#78442](https://github.com/ClickHouse/ClickHouse/pull/78442) ([Azat Khuzhin](https://github.com/azat)).
* Простая оптимизация: не переписывать `count(if())` в countIf, если требуется `CAST`. Закрывает [#78564](https://github.com/ClickHouse/ClickHouse/issues/78564). [#78565](https://github.com/ClickHouse/ClickHouse/pull/78565) ([李扬](https://github.com/taiyang-li)).





## Улучшения {#improvements}


* Уменьшает количество запросов к Keeper за счет отказа от использования одиночных запросов `get` в пользу `multiRead` в тех случаях, когда он доступен, поскольку при увеличении числа реплик одиночные `get` могли создавать значительную нагрузку на Keeper. [#56862](https://github.com/ClickHouse/ClickHouse/pull/56862) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена поддержка SSL-аутентификации с именованными коллекциями для MySQL. Закрывает [#59111](https://github.com/ClickHouse/ClickHouse/issues/59111). [#59452](https://github.com/ClickHouse/ClickHouse/pull/59452) ([Nikolay Degterinsky](https://github.com/evillique)).
* Улучшена производительность новой инфраструктуры анализатора за счёт хранения в `ConstantNode` значения типа `ColumnPtr` вместо `Field`. Связано с [#62245](https://github.com/ClickHouse/ClickHouse/issues/62245). [#63198](https://github.com/ClickHouse/ClickHouse/pull/63198) ([Dmitry Novik](https://github.com/novikd)).
* Отклонять запросы, когда сервер перегружен. Решение принимается на основе отношения времени ожидания (`OSCPUWaitMicroseconds`) к времени выполнения (`OSCPUVirtualTimeMicroseconds`). Запрос с некоторой вероятностью отбрасывается, когда это отношение находится между `min_os_cpu_wait_time_ratio_to_throw` и `max_os_cpu_wait_time_ratio_to_throw` (это настройки на уровне запроса). [#63206](https://github.com/ClickHouse/ClickHouse/pull/63206) ([Alexey Katsman](https://github.com/alexkats)).
* Освобождайте блоки как можно раньше, чтобы снизить потребление памяти. [#65647](https://github.com/ClickHouse/ClickHouse/pull/65647) ([lgbo](https://github.com/lgbo-ustc)).
* Для таблицы `processors_profile_log` теперь по умолчанию задан TTL 30 дней. [#66139](https://github.com/ClickHouse/ClickHouse/pull/66139) ([Ilya Yatsishin](https://github.com/qoega)).
* Добавлена возможность создавать индекс `bloom_filter` на столбцах с типом данных DateTime64. [#66416](https://github.com/ClickHouse/ClickHouse/pull/66416) ([Yutong Xiao](https://github.com/YutSean)).
* Добавлены бакеты задержек, которые используются для отслеживания времени до первого байта при чтении/записи и времени установления соединения для запросов к S3. Это позволит в дальнейшем использовать собранные данные для расчёта приблизительных перцентилей и адаптации таймаутов. [#69783](https://github.com/ClickHouse/ClickHouse/pull/69783) ([Alexey Katsman](https://github.com/alexkats)).
* Запросы, передаваемые в хранилище `Executable`, больше не ограничены однопоточным выполнением. [#70084](https://github.com/ClickHouse/ClickHouse/pull/70084) ([yawnt](https://github.com/yawnt)).
* В таблицу логов спанов OpenTelemetry добавлены HTTP-заголовки для улучшения трассируемости. [#70516](https://github.com/ClickHouse/ClickHouse/pull/70516) ([jonymohajanGmail](https://github.com/jonymohajanGmail)).
* Добавлена поддержка записи файлов ORC с использованием произвольного часового пояса, а не только часового пояса `GMT`. [#70615](https://github.com/ClickHouse/ClickHouse/pull/70615) ([kevinyhzou](https://github.com/KevinyhZou)).
* Заменены табличные функции на их альтернативы с суффиксом `-Cluster`, если включены параллельные реплики. Исправляет [#65024](https://github.com/ClickHouse/ClickHouse/issues/65024). [#70659](https://github.com/ClickHouse/ClickHouse/pull/70659) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Учитываются настройки планирования ввода-вывода при записи резервных копий между облаками. [#71093](https://github.com/ClickHouse/ClickHouse/pull/71093) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Фоново восстанавливать соединение с репликами словарей MySQL и Postgres, чтобы не задерживать запросы к соответствующим словарям. [#71101](https://github.com/ClickHouse/ClickHouse/pull/71101) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Добавлено имя алиаса метрики в system.asynchronous&#95;metrics. [#71164](https://github.com/ClickHouse/ClickHouse/pull/71164) ([megao](https://github.com/jetgm)).
* Обновление обновляемых материализованных представлений теперь отображается в `system.query_log`. [#71333](https://github.com/ClickHouse/ClickHouse/pull/71333) ([Michael Kolupaev](https://github.com/al13n321)).
* Оценивать bloom-фильтры и min/max-индексы Parquet совместно. Необходимо для корректной поддержки выражения `x = 3 or x > 5` при data = [1, 2, 4, 5]. [#71383](https://github.com/ClickHouse/ClickHouse/pull/71383) ([Arthur Passos](https://github.com/arthurpassos)).
* Улучшения интерактивных метрик. Исправлена проблема, из-за которой метрики от параллельных реплик отображались не полностью. Метрики отображаются в порядке их последнего обновления, затем лексикографически по имени. Устаревшие метрики не отображаются. [#71631](https://github.com/ClickHouse/ClickHouse/pull/71631) ([Julia Kartseva](https://github.com/jkartseva)).
* Исторически по какой‑то причине запрос `ALTER TABLE MOVE PARTITION TO TABLE` проверял права `SELECT` и `ALTER DELETE` вместо отдельного `ALTER_MOVE_PARTITION`. В этом PR используется именно этот тип доступа. Для совместимости это разрешение также будет неявно выдаваться, если выданы права `SELECT` и `ALTER DELETE`, но это поведение будет удалено в будущих релизах. Закрывает [#16403](https://github.com/ClickHouse/ClickHouse/issues/16403). [#71632](https://github.com/ClickHouse/ClickHouse/pull/71632) ([pufit](https://github.com/pufit)).
* Позволяет установить `use_hive_partitioning` по умолчанию. [#71636](https://github.com/ClickHouse/ClickHouse/pull/71636) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Вызывать исключение при попытке материализовать столбец в ключе сортировки вместо того, чтобы допускать нарушение порядка сортировки. Однако это не решает [#71777](https://github.com/ClickHouse/ClickHouse/issues/71777). [#71891](https://github.com/ClickHouse/ClickHouse/pull/71891) ([Peter Nguyen](https://github.com/petern48)).
* При включённом алгоритме hash join разрешён более общий алгоритм планирования объединения. [#71926](https://github.com/ClickHouse/ClickHouse/pull/71926) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Скрытие секретов в `EXPLAIN QUERY TREE`. [#72025](https://github.com/ClickHouse/ClickHouse/pull/72025) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Разрешено использовать настраиваемый диск для хранения файлов метаданных баз данных и таблиц. Имя диска можно задать через конфигурационный параметр `database_disk.disk`. [#72027](https://github.com/ClickHouse/ClickHouse/pull/72027) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Добавлена поддержка логических целочисленных типов Parquet в нативном считывателе. [#72105](https://github.com/ClickHouse/ClickHouse/pull/72105) ([Arthur Passos](https://github.com/arthurpassos)).
* Сделать формат вывода JSON по умолчанию удобочитаемым. Добавить новый параметр `output_format_json_pretty_print` для управления этим и включить его по умолчанию. [#72148](https://github.com/ClickHouse/ClickHouse/pull/72148) ([Pavel Kruglov](https://github.com/Avogar)).
* Интерактивно запрашивать учетные данные в браузере, если для пользователя по умолчанию требуется пароль. В предыдущих версиях сервер возвращал HTTP 403, теперь он возвращает HTTP 401. [#72198](https://github.com/ClickHouse/ClickHouse/pull/72198) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Этот PR переводит типы доступа `CREATE_USER`, `ALTER_USER`, `DROP_USER`, `CREATE_ROLE`, `ALTER_ROLE`, `DROP_ROLE` из глобальных в параметризованные. Это означает, что пользователи теперь могут более точно выдавать права на управление доступом: [#72246](https://github.com/ClickHouse/ClickHouse/pull/72246) ([pufit](https://github.com/pufit)).
* Разрешена адресация шардов по именам в конфигурации кластера. [#72276](https://github.com/ClickHouse/ClickHouse/pull/72276) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Добавлена поддержка `CAST` и `ALTER` между типами `JSON` с различными параметрами. [#72303](https://github.com/ClickHouse/ClickHouse/pull/72303) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлен столбец `latest_fail_error_code_name` в `system.mutations`. Этот столбец нужен для введения новой метрики по застрявшим мутациям и построения на её основе графиков ошибок, возникающих в ClickHouse Cloud, а также, при необходимости, для добавления нового, менее «шумного» алерта. [#72398](https://github.com/ClickHouse/ClickHouse/pull/72398) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Снижено количество выделений памяти при присоединении разделов. [#72583](https://github.com/ClickHouse/ClickHouse/pull/72583) ([Konstantin Morозов](https://github.com/k-morozov)).
* Лимит `max_bytes_before_external_sort` теперь зависит от общего потребления памяти запросом (ранее он соответствовал числу байт в блоке сортировки для одного потока сортировки, теперь он имеет то же значение, что и `max_bytes_before_external_group_by` — это общий лимит памяти для всего запроса для всех потоков). Также добавлена ещё одна настройка для управления размером блока на диске — `min_external_sort_block_bytes`. [#72598](https://github.com/ClickHouse/ClickHouse/pull/72598) ([Azat Khuzhin](https://github.com/azat)).
* Игнорировать ограничения по памяти в сборщике трассировок. [#72606](https://github.com/ClickHouse/ClickHouse/pull/72606) ([Azat Khuzhin](https://github.com/azat)).
* Реализована поддержка подстолбцов в ключе сортировки MergeTree и пропускающих индексах. [#72644](https://github.com/ClickHouse/ClickHouse/pull/72644) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлены параметры сервера `dictionaries_lazy_load` и `wait_dictionaries_load_at_startup` в `system.server_settings`. [#72664](https://github.com/ClickHouse/ClickHouse/pull/72664) ([Christoph Wurm](https://github.com/cwurm)).
* Добавлена настройка `max_backup_bandwidth` в список настроек, которые можно указывать в запросах `BACKUP`/`RESTORE`. [#72665](https://github.com/ClickHouse/ClickHouse/pull/72665) ([Christoph Wurm](https://github.com/cwurm)).
* Параллельные реплики использовали историческую информацию о доступности для улучшения выбора реплики, но не обновляли её счётчик ошибок, когда соединение было недоступно. В этом PR счётчик ошибок реплики обновляется при её недоступности. [#72666](https://github.com/ClickHouse/ClickHouse/pull/72666) ([zoomxi](https://github.com/zoomxi)).
* Снижен уровень логирования для появляющихся реплицированных кусков в движке ReplicatedMergeTree, чтобы уменьшить объём логов, генерируемых в реплицированном кластере. [#72876](https://github.com/ClickHouse/ClickHouse/pull/72876) ([mor-akamai](https://github.com/morkalfon)).
* Многие новые функции потребуют лучшей инкапсуляции кода (связанных с метаданными Iceberg частей) и более качественных абстракций. [#72941](https://github.com/ClickHouse/ClickHouse/pull/72941) ([Daniil Ivanik](https://github.com/divanik)).
* Добавлена поддержка операции сравнения на равенство для значений в JSON-столбце. [#72991](https://github.com/ClickHouse/ClickHouse/pull/72991) ([Pavel Kruglov](https://github.com/Avogar)).
* Улучшено форматирование идентификаторов с JSON-подстолбцами, чтобы избежать ненужных обратных кавычек. [#73085](https://github.com/ClickHouse/ClickHouse/pull/73085) ([Pavel Kruglov](https://github.com/Avogar)).
* Журналировать условия `PREWHERE` с уровнем `Test`. [#73116](https://github.com/ClickHouse/ClickHouse/pull/73116) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Поддержка `SETTINGS` с неявным `ENGINE` и совместным использованием настроек движка и запроса. [#73120](https://github.com/ClickHouse/ClickHouse/pull/73120) ([Raúl Marín](https://github.com/Algunenano)).
* Записывать парты с уровнем 1, если включён `optimize_on_insert`. Это позволяет применять ряд оптимизаций запросов с `FINAL` к недавно записанным партам. [#73132](https://github.com/ClickHouse/ClickHouse/pull/73132) ([Anton Popov](https://github.com/CurtizJ)).
* Для запроса вида `WHERE a<b AND b<c AND c<5` может генерировать новые условия сравнения (`a<5 AND b<5`), чтобы улучшить эффективность фильтрации. [#73164](https://github.com/ClickHouse/ClickHouse/pull/73164) ([Shichao Jin](https://github.com/jsc0218)).
* Улучшено выделение общих выражений в дизъюнкциях. Разрешено упрощение результирующего фильтрующего выражения, даже если нет общего подвыражения для всех дизъюнктов. Продолжение [#71537](https://github.com/ClickHouse/ClickHouse/issues/71537). [#73271](https://github.com/ClickHouse/ClickHouse/pull/73271) ([Dmitry Novik](https://github.com/novikd)).
* В хранилище `S3(Azure)Queue` появилась возможность задавать настройки для таблиц, которые были созданы без них. [#73283](https://github.com/ClickHouse/ClickHouse/pull/73283) ([Kseniia Sumarokova](https://github.com/kssenii)).
* clickhouse-client поддерживает Ctrl+D для завершения запроса. Можно использовать Ctrl+D вместо ввода точки с запятой и нажатия Enter. Кроме того, Ctrl+D работает как Enter в однострочном режиме. [#73293](https://github.com/ClickHouse/ClickHouse/pull/73293) ([Xiaozhe Yu](https://github.com/wudidapaopao)).
* Добавлена настройка `least_greatest_legacy_null_behavior` (по умолчанию `false`), которая определяет, должны ли функции `least` и `greatest` при наличии аргументов `NULL` безусловно возвращать `NULL` (если `true`) или игнорировать такие аргументы (если `false`). [#73344](https://github.com/ClickHouse/ClickHouse/pull/73344) ([Robert Schulze](https://github.com/rschu1ze)).
* Использовать множественные запросы Keeper в потоке очистки ObjectStorageQueueMetadata. [#73357](https://github.com/ClickHouse/ClickHouse/pull/73357) ([Antonio Andelic](https://github.com/antonio2368)).
* Новый драйвер MongoDB теперь используется по умолчанию. Пользователи, которые хотят продолжать использовать устаревший драйвер, могут установить серверный параметр `use_legacy_mongodb_integration` в значение true. [#73359](https://github.com/ClickHouse/ClickHouse/pull/73359) ([Robert Schulze](https://github.com/rschu1ze)).
* Когда ClickHouse работает в окружении cgroup, мы по‑прежнему собираем асинхронные метрики на уровне всей системы, связанные с нагрузкой, планированием процессов, памятью и т. д. Они могут давать полезные сигналы, когда ClickHouse является единственным процессом на хосте с высоким потреблением ресурсов. [#73369](https://github.com/ClickHouse/ClickHouse/pull/73369) ([Nikita Taranov](https://github.com/nickitat)).
* В хранилище S3Queue добавлена возможность переносить старые упорядоченные таблицы, созданные до версии 24.6, в новую структуру с шардами (buckets). [#73467](https://github.com/ClickHouse/ClickHouse/pull/73467) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена таблица `system.azure_queue`, аналогичная существующей `system.s3queue`. [#73477](https://github.com/ClickHouse/ClickHouse/pull/73477) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена регрессия, из-за которой при использовании локалей сортировки с модификаторами возникала ошибка. Например, теперь корректно работает запрос `SELECT arrayJoin(['kk 50', 'KK 01', ' KK 2', ' KK 3', 'kk 1', 'x9y99', 'x9y100']) item ORDER BY item ASC COLLATE 'tr-u-kn-true-ka-shifted`. [#73544](https://github.com/ClickHouse/ClickHouse/pull/73544) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка типа Nullable(JSON). [#73556](https://github.com/ClickHouse/ClickHouse/pull/73556) ([Pavel Kruglov](https://github.com/Avogar)).
* Функция `parseDateTime64` (и её варианты) теперь выдаёт корректные результаты для входных дат до 1970 года и после 2106 года. Пример: `SELECT parseDateTime64InJodaSyntax('2200-01-01 00:00:00.000', 'yyyy-MM-dd HH:mm:ss.SSS')`. [#73594](https://github.com/ClickHouse/ClickHouse/pull/73594) ([zhanglistar](https://github.com/zhanglistar)).
* Устранены некоторые проблемы удобства использования `clickhouse-disks`, на которые жаловались пользователи. Закрывает [#67136](https://github.com/ClickHouse/ClickHouse/issues/67136). [#73616](https://github.com/ClickHouse/ClickHouse/pull/73616) ([Daniil Ivanik](https://github.com/divanik)).
* Разрешено изменять настройки фиксации (commit) в `storage S3(Azure)Queue`. Настройки фиксации: `max_processed_files_before_commit`, `max_processed_rows_before_commit`, `max_processed_bytes_before_commit`, `max_processing_time_sec_before_commit`. [#73635](https://github.com/ClickHouse/ClickHouse/pull/73635) ([Kseniia Sumarokova](https://github.com/kssenii)).
* В хранилище S3(Azure)Queue добавлена агрегация прогресса обработки из разных источников для сравнения с настройками предела фиксации (commit limit). [#73641](https://github.com/ClickHouse/ClickHouse/pull/73641) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Поддержка базовых настроек в запросах `BACKUP`/`RESTORE`. [#73650](https://github.com/ClickHouse/ClickHouse/pull/73650) ([Vitaly Baranov](https://github.com/vitlibar)).
* Чтение параметра `output_format_compression_level` при выводе в Parquet. [#73651](https://github.com/ClickHouse/ClickHouse/pull/73651) ([Arthur Passos](https://github.com/arthurpassos)).
* Добавлено чтение arrow fixed&#95;size&#95;list как Array вместо рассмотрения его как неподдерживаемого типа. [#73654](https://github.com/ClickHouse/ClickHouse/pull/73654) ([Julian Meyers](https://github.com/J-Meyers)).
* В этом PR добавлены два движка резервного копирования: `Memory` (хранит резервные копии в рамках текущей пользовательской сессии) и `Null` (не хранит резервные копии). [#73690](https://github.com/ClickHouse/ClickHouse/pull/73690) ([Vitaly Baranov](https://github.com/vitlibar)).
* `concurrent_threads_soft_limit_num` и `concurrent_threads_soft_limit_num_ratio_to_cores` теперь можно изменять без перезапуска сервера. [#73713](https://github.com/ClickHouse/ClickHouse/pull/73713) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена поддержка расширенных числовых типов (`Decimal`, большие целые) в функциях `formatReadable`. [#73765](https://github.com/ClickHouse/ClickHouse/pull/73765) ([Raúl Marín](https://github.com/Algunenano)).
* Учтено регистронезависимое сопоставление имен столбцов для полей в столбцах типа `tuple`. Закрывает [https://github.com/apache/incubator-gluten/issues/8324](https://github.com/apache/incubator-gluten/issues/8324). [#73780](https://github.com/ClickHouse/ClickHouse/pull/73780) ([李扬](https://github.com/taiyang-li)).
* Добавлена поддержка TLS для протокола Postgres wire. [#73812](https://github.com/ClickHouse/ClickHouse/pull/73812) ([scanhex12](https://github.com/scanhex12)).
* По умолчанию разрешён тип `LowCardinality(UUID)`. На практике это оказалось удобным для клиентов ClickHouse Cloud. [#73826](https://github.com/ClickHouse/ClickHouse/pull/73826) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшено сообщение при установке. [#73827](https://github.com/ClickHouse/ClickHouse/pull/73827) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшено сообщение о сбросе пароля в ClickHouse Cloud. [#73831](https://github.com/ClickHouse/ClickHouse/pull/73831) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшено сообщение об ошибке для таблицы `File`, в которую нельзя дописывать данные в файл. [#73832](https://github.com/ClickHouse/ClickHouse/pull/73832) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Запрашивать подтверждение, когда пользователь по ошибке пытается вывести бинарный формат (такой как Native, Parquet, Avro) в терминал. Закрывает [#59524](https://github.com/ClickHouse/ClickHouse/issues/59524). [#73833](https://github.com/ClickHouse/ClickHouse/pull/73833) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Тип данных `BFloat16` готов к промышленному использованию. [#73840](https://github.com/ClickHouse/ClickHouse/pull/73840) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Подсвечивать конечные пробелы в форматах Pretty и Vertical в терминале для лучшей наглядности. Это контролируется настройкой `output_format_pretty_highlight_trailing_spaces`. Исходная реализация от [Braden Burns](https://github.com/bradenburns) из [#72996](https://github.com/ClickHouse/ClickHouse/issues/72996). Закрывает [#71590](https://github.com/ClickHouse/ClickHouse/issues/71590). [#73847](https://github.com/ClickHouse/ClickHouse/pull/73847) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* `clickhouse-client` и `clickhouse-local` теперь автоматически определяют формат сжатия stdin, когда он перенаправлен из файла. Это закрывает [#70865](https://github.com/ClickHouse/ClickHouse/issues/70865). [#73848](https://github.com/ClickHouse/ClickHouse/pull/73848) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* По умолчанию обрезать слишком длинные имена столбцов в pretty-форматах. Это регулируется настройками `output_format_pretty_max_column_name_width_cut_to` и `output_format_pretty_max_column_name_width_min_chars_to_cut`. Это продолжение работы [tanmaydatta](https://github.com/tanmaydatta) в [#66502](https://github.com/ClickHouse/ClickHouse/issues/66502). Это закрывает задачу [#65968](https://github.com/ClickHouse/ClickHouse/issues/65968). [#73851](https://github.com/ClickHouse/ClickHouse/pull/73851) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сделать форматы `Pretty` более наглядными: объединять блоки, если с момента вывода предыдущего блока прошло немного времени. Это управляется новыми настройками `output_format_pretty_squash_consecutive_ms` (50 мс по умолчанию) и `output_format_pretty_squash_max_wait_ms` (1000 мс по умолчанию). Продолжение [#49537](https://github.com/ClickHouse/ClickHouse/issues/49537). Закрывает [#49153](https://github.com/ClickHouse/ClickHouse/issues/49153). [#73852](https://github.com/ClickHouse/ClickHouse/pull/73852) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено сопоставление типов для SQLite (целочисленные типы в `int64`, числа с плавающей запятой в `float64`). [#73853](https://github.com/ClickHouse/ClickHouse/pull/73853) ([Joanna Hulboj](https://github.com/jh0x)).
* Добавлена метрика количества исходных кусков, которые в данный момент объединяются. Это закрывает [#70809](https://github.com/ClickHouse/ClickHouse/issues/70809). [#73868](https://github.com/ClickHouse/ClickHouse/pull/73868) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Подсвечивать столбцы в формате `Vertical`, если вывод идёт в терминал. Это можно отключить с помощью настройки `output_format_pretty_color`. [#73898](https://github.com/ClickHouse/ClickHouse/pull/73898) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшена совместимость с MySQL до уровня, при котором `mysqlsh` (функциональный CLI-клиент MySQL от Oracle) теперь может подключаться к ClickHouse. Это необходимо для упрощения тестирования. [#73912](https://github.com/ClickHouse/ClickHouse/pull/73912) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Если количество выводимых записей больше N = `output_format_pretty_max_rows`, вместо отображения только первых N строк мы обрежем выходную таблицу посередине, показывая N/2 первых строк и N/2 последних строк. Продолжение [#64200](https://github.com/ClickHouse/ClickHouse/issues/64200). Это закрывает [#59502](https://github.com/ClickHouse/ClickHouse/issues/59502). [#73929](https://github.com/ClickHouse/ClickHouse/pull/73929) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Функция `isIPv4String` возвращала true, если за корректным IPv4-адресом следовал нулевой байт, хотя в этом случае она должна возвращать false. Продолжение [#65387](https://github.com/ClickHouse/ClickHouse/issues/65387). [#73946](https://github.com/ClickHouse/ClickHouse/pull/73946) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сделать код ошибки в протоколе MySQL wire совместимым с MySQL. Продолжение [#56831](https://github.com/ClickHouse/ClickHouse/issues/56831). Закрывает [#50957](https://github.com/ClickHouse/ClickHouse/issues/50957). [#73948](https://github.com/ClickHouse/ClickHouse/pull/73948) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена настройка `validate_enum_literals_in_opearators` для проверки литералов `Enum` в операторах `IN`, `NOT IN` на соответствие типу `Enum` и генерации исключения, если литерал не является допустимым значением `Enum`. [#73985](https://github.com/ClickHouse/ClickHouse/pull/73985) ([Vladimir Cherkasov](https://github.com/vdimir)).
* В хранилище `S3(Azure)Queue` все файлы (в одной партии, определяемой настройками commit) фиксируются в одной транзакции Keeper. [#73991](https://github.com/ClickHouse/ClickHouse/pull/73991) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отключено определение заголовков для исполняемых UDF и словарей (могло приводить к ошибке Function &#39;X&#39;: wrong result, expected Y row(s), actual Y-1). [#73992](https://github.com/ClickHouse/ClickHouse/pull/73992) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена опция `distributed` для `EXPLAIN PLAN`. Теперь `EXPLAIN distributed=1 ... ` добавляет удалённый план к шагам `ReadFromParallelRemote*`. [#73994](https://github.com/ClickHouse/ClickHouse/pull/73994) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Использован корректный возвращаемый тип для not/xor с аргументами Dynamic. [#74013](https://github.com/ClickHouse/ClickHouse/pull/74013) ([Pavel Kruglov](https://github.com/Avogar)).
* Разрешено изменять настройку `add_implicit_sign_column_constraint_for_collapsing_engine` после создания таблицы. [#74014](https://github.com/ClickHouse/ClickHouse/pull/74014) ([Christoph Wurm](https://github.com/cwurm)).
* Поддержаны подстолбцы в запросе `SELECT` материализованного представления. [#74030](https://github.com/ClickHouse/ClickHouse/pull/74030) ([Pavel Kruglov](https://github.com/Avogar)).
* Форматы pretty могут отображать многострочные поля внутри ячейки таблицы, что повышает читаемость. Эта возможность включена по умолчанию и управляется настройкой `output_format_pretty_multiline_fields`. Продолжение работы [Volodyachan](https://github.com/Volodyachan) из [#64094](https://github.com/ClickHouse/ClickHouse/issues/64094). Это закрывает [#56912](https://github.com/ClickHouse/ClickHouse/issues/56912). [#74032](https://github.com/ClickHouse/ClickHouse/pull/74032) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка оптимизации `predicate-push-down` на уровне плана запроса для шага `MergingAggregated`. Это улучшает производительность некоторых запросов с новым анализатором. [#74073](https://github.com/ClickHouse/ClickHouse/pull/74073) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Теперь есть три простых способа задать пользовательскую строку приглашения (prompt) в `clickhouse-client`: 1. через параметр командной строки `--prompt`, 2. в файле конфигурации, с помощью настройки `<prompt>[...]</prompt>`, и 3. также в файле конфигурации, с помощью настроек для отдельных подключений `<connections_credentials><prompt>[...]</prompt></connection_credentials>`. [#74168](https://github.com/ClickHouse/ClickHouse/pull/74168) ([Christoph Wurm](https://github.com/cwurm)).
* Изменён код успешного ответа для `prometheus remote write` с 200/OK на 204/NoContent. [#74170](https://github.com/ClickHouse/ClickHouse/pull/74170) ([Michael Dempsey](https://github.com/bluestealth)).
* HTTP‑заголовки X-ClickHouse теперь доступны JavaScript в браузере. Это делает разработку приложений более удобной. [#74180](https://github.com/ClickHouse/ClickHouse/pull/74180) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Формат `JSONEachRowWithProgress` включает события с метаданными, а также totals и extremes. Он также включает `rows_before_limit_at_least` и `rows_before_aggregation`. Формат корректно выводит исключение, если оно возникает после частичных результатов. В данные о прогрессе теперь включается прошедшее время в наносекундах. В конце генерируется одно финальное событие прогресса. Прогресс во время выполнения запроса будет выводиться не чаще, чем это задано значением настройки `interactive_delay`. [#74181](https://github.com/ClickHouse/ClickHouse/pull/74181) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Значок песочных часов будет плавно вращаться в интерфейсе Play. [#74182](https://github.com/ClickHouse/ClickHouse/pull/74182) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Даже если HTTP‑ответ сжат, отправляйте пакеты сразу по мере их поступления. Это позволяет браузеру получать пакеты прогресса и сжатые данные. [#74201](https://github.com/ClickHouse/ClickHouse/pull/74201) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность перезагружать `max_remote_read_network_bandwidth_for_serve` и `max_remote_write_network_bandwidth_for_server` на лету, без перезапуска сервера. [#74206](https://github.com/ClickHouse/ClickHouse/pull/74206) ([Kai Zhu](https://github.com/nauu)).
* Автоматически определять безопасное соединение при подключении к порту 9440 в клиенте ClickHouse. [#74212](https://github.com/ClickHouse/ClickHouse/pull/74212) ([Christoph Wurm](https://github.com/cwurm)).
* Аутентифицировать пользователей для `http_handlers` только по имени пользователя (ранее требовалось также указывать пароль). [#74221](https://github.com/ClickHouse/ClickHouse/pull/74221) ([Azat Khuzhin](https://github.com/azat)).
* Поддержка альтернативных языков запросов PRQL и KQL отмечена как экспериментальная. Чтобы использовать их, включите настройки `allow_experimental_prql_dialect = 1` и `allow_experimental_kusto_dialect = 1`. [#74224](https://github.com/ClickHouse/ClickHouse/pull/74224) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка возврата типа `Enum` по умолчанию в большем числе агрегатных функций. [#74272](https://github.com/ClickHouse/ClickHouse/pull/74272) ([Raúl Marín](https://github.com/Algunenano)).
* В `OPTIMIZE TABLE` теперь можно указывать ключевое слово `FORCE` как альтернативу существующему ключевому слову `FINAL`. [#74342](https://github.com/ClickHouse/ClickHouse/pull/74342) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена настройка MergeTree `materialize_skip_indexes_on_merge`, которая отключает создание skip-индексов во время слияния. Это позволяет пользователям явно контролировать (через `ALTER TABLE [..] MATERIALIZE INDEX [...]`), когда создаются skip-индексы. Это может быть полезно, если построение skip-индексов затратное (например, для индексов векторного сходства). [#74401](https://github.com/ClickHouse/ClickHouse/pull/74401) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка подстолбцов в выражениях `DEFAULT` и `MATERIALIZED`. [#74403](https://github.com/ClickHouse/ClickHouse/pull/74403) ([Pavel Kruglov](https://github.com/Avogar)).
* Оптимизированы запросы Keeper в Storage(S3/Azure)Queue. [#74410](https://github.com/ClickHouse/ClickHouse/pull/74410) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена метрика IsServerShuttingDown, которая нужна для срабатывания оповещения, если завершение работы сервера занимает слишком много времени. [#74429](https://github.com/ClickHouse/ClickHouse/pull/74429) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* В EXPLAIN добавлены имена таблиц Iceberg. [#74485](https://github.com/ClickHouse/ClickHouse/pull/74485) ([alekseev-maksim](https://github.com/alekseev-maksim)).
* По умолчанию используется до `1000` параллельных реплик. [#74504](https://github.com/ClickHouse/ClickHouse/pull/74504) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Добавлено более информативное сообщение об ошибке при использовании RECURSIVE CTE со старым анализатором. [#74523](https://github.com/ClickHouse/ClickHouse/pull/74523) ([Raúl Marín](https://github.com/Algunenano)).
* Оптимизированы запросы к Keeper в Storage(S3/Azure)Queue. [#74538](https://github.com/ClickHouse/ClickHouse/pull/74538) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Улучшено повторное использование HTTP-сессий при чтении с диска S3 ([#72401](https://github.com/ClickHouse/ClickHouse/issues/72401)). [#74548](https://github.com/ClickHouse/ClickHouse/pull/74548) ([Julian Maicher](https://github.com/jmaicher)).
* Отображать расширенные сообщения об ошибках в `system.errors`. [#74574](https://github.com/ClickHouse/ClickHouse/pull/74574) ([Vitaly Baranov](https://github.com/vitlibar)).
* Включена логика экспоненциальной паузы для всех типов реплицируемых задач. Это позволит снизить загрузку CPU, потребление памяти и размер лог-файлов. Добавлены новые настройки `max_postpone_time_for_failed_replicated_fetches_ms`, `max_postpone_time_for_failed_replicated_merges_ms` и `max_postpone_time_for_failed_replicated_tasks_ms`, аналогичные `max_postpone_time_for_failed_mutations_ms`. [#74576](https://github.com/ClickHouse/ClickHouse/pull/74576) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Более точный учет настройки `max_joined_block_size_rows` для алгоритма JOIN `parallel_hash`. Помогает избежать повышенного потребления памяти по сравнению с алгоритмом `hash`. [#74630](https://github.com/ClickHouse/ClickHouse/pull/74630) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлена поддержка параметра конфигурации libhdfs3 `dfs.client.use.datanode.hostname`. [#74635](https://github.com/ClickHouse/ClickHouse/pull/74635) ([Mikhail Tiukavkin](https://github.com/freshertm)).
* Исправлена ошибка Invalid: Codec &#39;snappy&#39; doesn&#39;t support setting a compression level. [#74659](https://github.com/ClickHouse/ClickHouse/pull/74659) ([Arthur Passos](https://github.com/arthurpassos)).
* Разрешено использование пароля для взаимодействия клиента с clickhouse-keeper. Эта возможность не особо полезна, если для сервера и клиента задана корректная SSL‑конфигурация, но всё же может пригодиться в некоторых случаях. Длина пароля не может превышать 16 символов. Это не связано с моделью аутентификации Keeper. [#74673](https://github.com/ClickHouse/ClickHouse/pull/74673) ([alesapin](https://github.com/alesapin)).
* Добавлена возможность использовать пути blob для вычисления контрольных сумм при создании резервной копии. [#74729](https://github.com/ClickHouse/ClickHouse/pull/74729) ([Vitaly Baranov](https://github.com/vitlibar)).
* Используйте динамическое шардирование для JOIN, если ключ JOIN является префиксом PK для обеих частей. Эта оптимизация включается настройкой `query_plan_join_shard_by_pk_ranges` (по умолчанию отключена). [#74733](https://github.com/ClickHouse/ClickHouse/pull/74733) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлен код ошибки для средства перезагрузки конфигурации. [#74746](https://github.com/ClickHouse/ClickHouse/pull/74746) ([Garrett Thomas](https://github.com/garrettthomaskth)).
* Добавлена поддержка IPv6-адресов в табличных функциях и движках MySQL и PostgreSQL. [#74796](https://github.com/ClickHouse/ClickHouse/pull/74796) ([Mikhail Koviazin](https://github.com/mkmkme)).
* Параметры кодека Gorilla теперь всегда будут сохраняться в метаданных таблицы в файле .sql. Это закрывает: [#70072](https://github.com/ClickHouse/ClickHouse/issues/70072). [#74814](https://github.com/ClickHouse/ClickHouse/pull/74814) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Реализована оптимизация с коротким замыканием для `divideDecimal`. Исправляет [#74280](https://github.com/ClickHouse/ClickHouse/issues/74280). [#74843](https://github.com/ClickHouse/ClickHouse/pull/74843) ([Kevin Mingtarja](https://github.com/kevinmingtarja)).
* Улучшена производительность больших мультизапросов в Keeper. [#74849](https://github.com/ClickHouse/ClickHouse/pull/74849) ([Antonio Andelic](https://github.com/antonio2368)).
* Теперь пользователей можно задавать в стартовых скриптах. [#74894](https://github.com/ClickHouse/ClickHouse/pull/74894) ([pufit](https://github.com/pufit)).
* Параллельная загрузка партиций в `ALTER TABLE FETCH PARTITION` (размер пула потоков управляется настройкой `max_fetch_partition_thread_pool_size`). [#74978](https://github.com/ClickHouse/ClickHouse/pull/74978) ([Azat Khuzhin](https://github.com/azat)).
* В `system.query_cache` добавлен столбец идентификатора запроса (issue [#68205](https://github.com/ClickHouse/ClickHouse/issues/68205)). [#74982](https://github.com/ClickHouse/ClickHouse/pull/74982) ([NamNguyenHoai](https://github.com/NamHoaiNguyen)).
* Повторно включен протокол SSH. Исправлены некоторые критические уязвимости, из‑за чего больше невозможно использовать пользовательский pager или указывать `server-logs-file`. По умолчанию отключена возможность передавать клиентские опции через переменные окружения (по‑прежнему возможно через `ssh-server.enable_client_options_passing` в config.xml). Добавлена поддержка таблицы прогресса, отмены запросов, автодополнения, прогресса событий профилирования, stdin и опции `send_logs_level`. Исправляет: [#74340](https://github.com/ClickHouse/ClickHouse/issues/74340). [#74989](https://github.com/ClickHouse/ClickHouse/pull/74989) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлено форматирование исключений с использованием пользовательского формата, если они возникают во время интерпретации запроса. В предыдущих версиях исключения форматировались с использованием формата по умолчанию, а не формата, указанного в запросе. Исправлена [#55422](https://github.com/ClickHouse/ClickHouse/issues/55422). [#74994](https://github.com/ClickHouse/ClickHouse/pull/74994) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Реализованы улучшения парсинга (разбор идентификаторов последовательностей: добавлена возможность разбора идентификаторов последовательностей в файлах манифеста, и разбор метаданных Avro: переработан парсер метаданных Avro, чтобы его было легко расширять в будущем). [#75010](https://github.com/ClickHouse/ClickHouse/pull/75010) ([Daniil Ivanik](https://github.com/divanik)).
* Теперь можно отменять запросы `ALTER TABLE ... FREEZE ...` с помощью `KILL QUERY` и таймаута (`max_execution_time`). [#75016](https://github.com/ClickHouse/ClickHouse/pull/75016) ([Kirill](https://github.com/kirillgarbar)).
* Добавлена поддержка `groupUniqArrayArrayMap` в качестве `SimpleAggregateFunction`. [#75034](https://github.com/ClickHouse/ClickHouse/pull/75034) ([Miel Donkers](https://github.com/mdonkers)).
* Добавлена поддержка подготовленных выражений в протоколе взаимодействия PostgreSQL. [#75035](https://github.com/ClickHouse/ClickHouse/pull/75035) ([scanhex12](https://github.com/scanhex12)).
* Скрыты настройки учетных данных каталога в движке базы данных `Iceberg`. Закрывает [#74559](https://github.com/ClickHouse/ClickHouse/issues/74559). [#75080](https://github.com/ClickHouse/ClickHouse/pull/75080) ([Kseniia Sumarokova](https://github.com/kssenii)).
* В BuzzHouse добавлены несколько отсутствовавших ранее возможностей: операторы `ILIKE` и `REGEXP`, `<=>` и `IS NOT DISTINCT FROM`. [#75168](https://github.com/ClickHouse/ClickHouse/pull/75168) ([Pedro Ferreira](https://github.com/PedroTadim)).
* Настройка `min_chunk_bytes_for_parallel_parsing` больше не может быть равна нулю. Это исправляет проблему: [#71110](https://github.com/ClickHouse/ClickHouse/issues/71110). [#75239](https://github.com/ClickHouse/ClickHouse/pull/75239) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* `intExp2` / `intExp10`: Определено поведение для ранее неопределённых случаев: возвращать 0 для слишком малого аргумента, `18446744073709551615` для слишком большого аргумента, выбрасывать исключение, если аргумент — `nan`. [#75312](https://github.com/ClickHouse/ClickHouse/pull/75312) ([Vitaly Baranov](https://github.com/vitlibar)).
* Реализована нативная поддержка `s3.endpoint` из конфигурации каталога в `DatabaseIceberg`. Закрывает [#74558](https://github.com/ClickHouse/ClickHouse/issues/74558). [#75375](https://github.com/ClickHouse/ClickHouse/pull/75375) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Не завершать операцию без сообщения об ошибке, если у пользователя, выполняющего `SYSTEM DROP REPLICA`, недостаточно прав. [#75377](https://github.com/ClickHouse/ClickHouse/pull/75377) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлен `ProfileEvent`, считающий количество неудачных попыток сброса любого из системных логов. [#75466](https://github.com/ClickHouse/ClickHouse/pull/75466) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлены проверка и логирование при дешифровании и декомпрессии. [#75471](https://github.com/ClickHouse/ClickHouse/pull/75471) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена поддержка знака микро (U+00B5) в функции `parseTimeDelta`. Теперь и знак микро (U+00B5), и греческая буква мю (U+03BC) распознаются как корректные обозначения микросекунд, что приводит поведение ClickHouse в соответствие с реализацией Go ([см. time.go](https://github.com/golang/go/blob/ad7b46ee4ac1cee5095d64b01e8cf7fcda8bee5e/src/time/time.go#L983C19-L983C20) и [time/format.go](https://github.com/golang/go/blob/ad7b46ee4ac1cee5095d64b01e8cf7fcda8bee5e/src/time/format.go#L1608-L1609)). [#75472](https://github.com/ClickHouse/ClickHouse/pull/75472) ([Vitaly Orlov](https://github.com/orloffv)).
* Настройка сервера (`send_settings_to_client`) заменена на настройку клиента (`apply_settings_from_server`), которая определяет, должен ли клиентский код (например, разбор данных `INSERT` и форматирование вывода запроса) использовать настройки из серверного `users.xml` и пользовательского профиля. В противном случае используются только настройки, заданные в командной строке клиента, сессии и самом запросе. Обратите внимание, что это относится только к нативному клиенту (а не, например, к HTTP) и не применяется к большей части обработки запроса (которая выполняется на сервере). [#75478](https://github.com/ClickHouse/ClickHouse/pull/75478) ([Michael Kolupaev](https://github.com/al13n321)).
* Улучшение Keeper: отключено вычисление дайджеста при фиксации в оперативном хранилище для повышения производительности. Его можно включить с помощью настройки `keeper_server.digest_enabled_on_commit`. Дайджест по‑прежнему вычисляется при предварительной обработке запросов. [#75490](https://github.com/ClickHouse/ClickHouse/pull/75490) ([Antonio Andelic](https://github.com/antonio2368)).
* По возможности выполнять выталкивание условий фильтра из `JOIN ON`. [#75536](https://github.com/ClickHouse/ClickHouse/pull/75536) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Улучшены сообщения об ошибках синтаксиса. Ранее, если запрос был слишком большим, а токен, длина которого превышает лимит, представлял собой очень большой строковый литерал, сообщение о причине терялось где‑то посередине между двумя примерами этого очень длинного токена. Исправлена проблема, при которой запрос в UTF-8 некорректно обрезался в сообщении об ошибке. Исправлено чрезмерное экранирование фрагментов запроса. Закрывает [#75473](https://github.com/ClickHouse/ClickHouse/issues/75473). [#75561](https://github.com/ClickHouse/ClickHouse/pull/75561) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлены события профилирования в хранилище `S3(Azure)Queue`. [#75618](https://github.com/ClickHouse/ClickHouse/pull/75618) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отключена отправка настроек с сервера на клиент (`send_settings_to_client=false`) для обеспечения совместимости (позже эта возможность будет снова реализована как клиентская настройка для повышения удобства использования). [#75648](https://github.com/ClickHouse/ClickHouse/pull/75648) ([Michael Kolupaev](https://github.com/al13n321)).
* Добавлен конфиг `memory_worker_correct_memory_tracker`, который включает корректировку внутреннего трекера памяти на основе информации из другого источника, периодически считываемой в фоновом потоке. [#75714](https://github.com/ClickHouse/ClickHouse/pull/75714) ([Antonio Andelic](https://github.com/antonio2368)).
* Использование Analyzer в PrometheusRemoteReadProtocol. [#75729](https://github.com/ClickHouse/ClickHouse/pull/75729) ([Dmitry Novik](https://github.com/novikd)).
* У нас есть поддержка типов метрик gauge и counter. Однако этого недостаточно для некоторых метрик (например, времени ответа на запросы к keeper), поэтому необходима поддержка типа метрик histogram. Интерфейс во многом повторяет клиент Prometheus: вы просто вызываете `observe(value)`, чтобы увеличить счетчик в бакете, соответствующем значению. Метрики histogram доступны через system.histogram&#95;metrics. [#75736](https://github.com/ClickHouse/ClickHouse/pull/75736) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Добавлен столбец `normalized_query_hash` в `system.processes`. Примечание: хотя его можно легко вычислить на лету с помощью функции `normalizedQueryHash`, это необходимо для подготовки к последующим изменениям. [#75756](https://github.com/ClickHouse/ClickHouse/pull/75756) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Запрос к `system.tables` не вызовет исключение, даже если существует таблица `Merge`, созданная поверх базы данных, которая уже удалена. Удалён метод `getTotalRows` из таблиц `Hive`, так как мы не допускаем, чтобы он выполнял сложные операции. [#75772](https://github.com/ClickHouse/ClickHouse/pull/75772) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* В веб-интерфейсе теперь есть интерактивная навигация по базам данных. [#75777](https://github.com/ClickHouse/ClickHouse/pull/75777) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Позволяет комбинировать диски только для чтения и для чтения-записи в политике хранения (как несколько томов или несколько дисков). Это позволяет читать данные со всего тома, а вставки будут выполняться на доступный для записи диск (то есть использовать политику хранения Copy-on-Write). [#75862](https://github.com/ClickHouse/ClickHouse/pull/75862) ([Azat Khuzhin](https://github.com/azat)).
* Удалён `trace_id` из `ORDER BY` по умолчанию для `system.opentelemetry_span_log`. [#75907](https://github.com/ClickHouse/ClickHouse/pull/75907) ([Azat Khuzhin](https://github.com/azat)).
* Шифрование (XML-атрибут `encrypted_by`) теперь может применяться к любому конфигурационному файлу (config.xml, users.xml, вложенным файлам конфигурации). Ранее оно работало только для верхнего файла config.xml. [#75911](https://github.com/ClickHouse/ClickHouse/pull/75911) ([Mikhail Gorshkov](https://github.com/mgorshkov)).
* Сохранять значения start&#95;time/end&#95;time для резервных копий с точностью до микросекунд. [#75929](https://github.com/ClickHouse/ClickHouse/pull/75929) ([Aleksandr Musorin](https://github.com/AVMusorin)).
* Добавлена метрика `MemoryTrackingUncorrected`, показывающая значение внутреннего глобального трекера памяти без корректировки по RSS. [#75935](https://github.com/ClickHouse/ClickHouse/pull/75935) ([Antonio Andelic](https://github.com/antonio2368)).
* Лениво вычислять размеры столбцов и индексов в MergeTree. [#75938](https://github.com/ClickHouse/ClickHouse/pull/75938) ([Pavel Kruglov](https://github.com/Avogar)).
* Преобразование `JOIN` в подзапрос с `IN`, если выводимый столбец связан с левой таблицей, требует сначала шага по обеспечению уникальности, поэтому по умолчанию оно отключено до добавления этого шага позднее. [#75942](https://github.com/ClickHouse/ClickHouse/pull/75942) ([Shichao Jin](https://github.com/jsc0218)).
* Добавлена серверная настройка `throw_on_unknown_workload`, которая позволяет выбрать поведение при выполнении запроса с параметром `workload`, установленным в неизвестное значение: либо разрешить неограниченный доступ (по умолчанию), либо вызывать ошибку `RESOURCE_ACCESS_DENIED`. Это полезно для принудительного использования планировщика рабочих нагрузок всеми запросами. [#75999](https://github.com/ClickHouse/ClickHouse/pull/75999) ([Sergei Trifonov](https://github.com/serxa)).
* Обеспечить полную поддержку флагов функций Keeper в новом экспериментальном движке таблиц Kafka. [#76004](https://github.com/ClickHouse/ClickHouse/pull/76004) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Не переписывать подстолбцы на getSubcolumn в ARRAY JOIN без необходимости. [#76018](https://github.com/ClickHouse/ClickHouse/pull/76018) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлены ошибки повторной координации при загрузке таблиц. [#76020](https://github.com/ClickHouse/ClickHouse/pull/76020) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Улучшена таблица `system.warnings` и добавлены динамические сообщения-предупреждения, которые можно добавлять, обновлять или удалять. [#76029](https://github.com/ClickHouse/ClickHouse/pull/76029) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлена поддержка сброса отдельных журналов в SYSTEM FLUSH LOGS. [#76132](https://github.com/ClickHouse/ClickHouse/pull/76132) ([Raúl Marín](https://github.com/Algunenano)).
* Улучшена страница сервера `/binary`. Вместо кривой Мортон используется кривая Хильберта. В квадрате отображаются адреса в объёме 512 MB, что лучше заполняет пространство (в предыдущих версиях адреса заполняли только половину квадрата). Цвет адресов определяется в большей степени по имени библиотеки, чем по имени функции. Разрешена немного более дальняя прокрутка за пределы области. [#76192](https://github.com/ClickHouse/ClickHouse/pull/76192) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Этот PR делает невозможным выполнение запроса `ALTER USER user1 ADD PROFILES a, DROP ALL PROFILES`, поскольку все операции `DROP` должны идти первыми. [#76242](https://github.com/ClickHouse/ClickHouse/pull/76242) ([pufit](https://github.com/pufit)).
* Различные улучшения для SYNC REPLICA (более информативные сообщения об ошибках, улучшенные тесты, дополнительные проверки корректности). [#76307](https://github.com/ClickHouse/ClickHouse/pull/76307) ([Azat Khuzhin](https://github.com/azat)).
* Повторный запуск запросов ON CLUSTER при ошибке TOO&#95;MANY&#95;SIMULTANEOUS&#95;QUERIES. [#76352](https://github.com/ClickHouse/ClickHouse/pull/76352) ([Patrick Galbraith](https://github.com/CaptTofu)).
* Изменено значение параметра по умолчанию `output_format_pretty_max_rows` с 10000 на 1000. Считаю, так удобнее в использовании. [#76407](https://github.com/ClickHouse/ClickHouse/pull/76407) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Поддержка операции refresh в таблицах MergeTree только для чтения. [#76467](https://github.com/ClickHouse/ClickHouse/pull/76467) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Используется корректный резервный вариант, когда многокомпонентное копирование в S3 завершается с ошибкой `Access Denied` во время резервного копирования. Многокомпонентное копирование может приводить к ошибке `Access Denied`, когда резервное копирование выполняется между бакетами с разными учетными данными. [#76515](https://github.com/ClickHouse/ClickHouse/pull/76515) ([Antonio Andelic](https://github.com/antonio2368)).
* Более быстрое завершение работы серверов ClickHouse (устранена задержка в 2,5 секунды). [#76550](https://github.com/ClickHouse/ClickHouse/pull/76550) ([Azat Khuzhin](https://github.com/azat)).
* Добавлен столбец query&#95;id в system.errors. Связанный тикет [#75815](https://github.com/ClickHouse/ClickHouse/issues/75815). [#76581](https://github.com/ClickHouse/ClickHouse/pull/76581) ([Vladimir Baikov](https://github.com/bkvvldmr)).
* Библиотека librdkafka обновлена до версии 2.8.0, а последовательность завершения работы для таблиц Kafka улучшена, что уменьшило задержки при удалении таблиц и перезапуске сервера. `engine=Kafka` больше не выходит явно из consumer group при удалении таблицы. Вместо этого consumer остается в группе, пока не будет автоматически удалён после периода бездействия, определяемого параметром `session_timeout_ms` (по умолчанию: 45 секунд). [#76621](https://github.com/ClickHouse/ClickHouse/pull/76621) ([filimonov](https://github.com/filimonov)).
* Исправлена проверка настроек запросов S3. [#76658](https://github.com/ClickHouse/ClickHouse/pull/76658) ([Vitaly Baranov](https://github.com/vitlibar)).
* Избегайте избыточного выделения памяти в `readbufferfroms3` и других буферах удалённого чтения, уменьшите их потребление памяти вдвое. [#76692](https://github.com/ClickHouse/ClickHouse/pull/76692) ([Sema Checherinda](https://github.com/CheSema)).
* Добавлена поддержка типа JSON и чтения подколонок из представления (View). [#76903](https://github.com/ClickHouse/ClickHouse/pull/76903) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена поддержка преобразования UInt128 в IPv6. Это позволяет выполнять операцию `bitAnd` и арифметические операции с IPv6, а также преобразовывать результат обратно в IPv6. Закрывает [#76752](https://github.com/ClickHouse/ClickHouse/issues/76752). Это также позволяет результат операции `bitAnd` над IPv6 преобразовывать обратно в IPv6. См.: [https://github.com/ClickHouse/ClickHouse/pull/57707](https://github.com/ClickHouse/ClickHouse/pull/57707). [#76928](https://github.com/ClickHouse/ClickHouse/pull/76928) ([Muzammil Abdul Rehman](https://github.com/muzammilar)).
* Системные таблицы, такие как `server_settings` или `settings`, имеют столбец `default`, что удобно. Только в `merge_tree_settings` и `replicated_merge_tree_settings` этот столбец не доступен. [#76942](https://github.com/ClickHouse/ClickHouse/pull/76942) ([Diego Nieto](https://github.com/lesandie)).
* По умолчанию специальные значения Bool в текстовых форматах внутри типа Variant не парсятся. Это поведение можно включить с помощью настройки `allow_special_bool_values_inside_variant`. [#76974](https://github.com/ClickHouse/ClickHouse/pull/76974) ([Pavel Kruglov](https://github.com/Avogar)).
* Поддержка настройки времени ожидания низкоприоритетного запроса для каждой задачи на уровне сессии и сервера. [#77013](https://github.com/ClickHouse/ClickHouse/pull/77013) ([VicoWu](https://github.com/VicoWu)).
* Добавлен `ProfileEvents::QueryPreempted` с той же логикой, что и у `CurrentMetrics::QueryPreempted`. [#77015](https://github.com/ClickHouse/ClickHouse/pull/77015) ([VicoWu](https://github.com/VicoWu)).
* Ранее `database replicated` мог записывать в логи учетные данные, указанные в запросе. Это поведение исправлено. Исправление закрывает: [#77123](https://github.com/ClickHouse/ClickHouse/issues/77123). [#77133](https://github.com/ClickHouse/ClickHouse/pull/77133) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Обновлён zstd с 1.5.5 до 1.5.7, что даёт заметный [прирост производительности](https://github.com/facebook/zstd/releases/tag/v1.5.7). [#77137](https://github.com/ClickHouse/ClickHouse/pull/77137) ([Pradeep Chhetri](https://github.com/chhetripradeep)).
* Добавлена поддержка ALTER TABLE DROP PARTITION для диска plain&#95;rewritable. [#77138](https://github.com/ClickHouse/ClickHouse/pull/77138) ([Julia Kartseva](https://github.com/jkartseva)).
* Добавлена возможность случайной паузы до 500 мс, независимо от размеров частей, перед выполнением слияний/мутаций в случае репликации с нулевым копированием. [#77165](https://github.com/ClickHouse/ClickHouse/pull/77165) ([Alexey Katsman](https://github.com/alexkats)).
* Добавлена поддержка атомарного переименования при использовании `TRUNCATE` с `INTO OUTFILE`. Решает [#70323](https://github.com/ClickHouse/ClickHouse/issues/70323). [#77181](https://github.com/ClickHouse/ClickHouse/pull/77181) ([Onkar Deshpande](https://github.com/onkar)).
* Используйте FixedString для типов PostgreSQL CHARACTER, CHAR и BPCHAR. [#77304](https://github.com/ClickHouse/ClickHouse/pull/77304) ([Pablo Marcos](https://github.com/pamarcos)).
* Добавлена возможность явно указывать файл метаданных для чтения Iceberg с помощью настройки `iceberg_metadata_file_path` в хранилище/табличной функции. Исправляет [#47412](https://github.com/ClickHouse/ClickHouse/issues/47412). [#77318](https://github.com/ClickHouse/ClickHouse/pull/77318) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка использования удалённого диска баз данных для хранения файлов метаданных. [#77365](https://github.com/ClickHouse/ClickHouse/pull/77365) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Реализовано сравнение значений типа данных JSON. Теперь объекты JSON можно сравнивать аналогично типу `Map`. [#77397](https://github.com/ClickHouse/ClickHouse/pull/77397) ([Pavel Kruglov](https://github.com/Avogar)).
* Изменение отменено. [#77399](https://github.com/ClickHouse/ClickHouse/pull/77399) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Параметр резервного копирования/восстановления `allow_s3_native_copy` теперь поддерживает три возможных значения: - `False` — s3 native copy не будет использоваться; - `True` (старое значение по умолчанию) — ClickHouse сначала попытается использовать s3 native copy, а при неудаче перейдёт к подходу чтения и записи; - `'auto'` (новое значение по умолчанию) — ClickHouse сначала сравнит учётные данные источника и приёмника. Если они совпадают, ClickHouse попробует s3 native copy и затем при необходимости может перейти к подходу чтения и записи. Если они различаются, ClickHouse сразу перейдёт к подходу чтения и записи. [#77401](https://github.com/ClickHouse/ClickHouse/pull/77401) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена поддержка ALTER TABLE ... ATTACH|DETACH|MOVE|REPLACE PARTITION для диска plain&#95;rewritable. [#77406](https://github.com/ClickHouse/ClickHouse/pull/77406) ([Julia Kartseva](https://github.com/jkartseva)).
* Отменено изменение, пропускающее кэш индексов. [#77447](https://github.com/ClickHouse/ClickHouse/pull/77447) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Снижено потребление памяти при предварительной выборке JSON-столбца в широких партах. [#77640](https://github.com/ClickHouse/ClickHouse/pull/77640) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена поддержка использования AWS session token и учетных данных из переменных окружения в delta kernel для движка таблиц DeltaLake. [#77661](https://github.com/ClickHouse/ClickHouse/pull/77661) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Реализована поддержка параметров запроса в настройке `additional_table_filters`. После изменения следующий запрос будет успешно выполнен: [#77680](https://github.com/ClickHouse/ClickHouse/pull/77680) ([wxybear](https://github.com/wxybear)).
* Пользовательские функции (UDF) теперь можно помечать как детерминированные с помощью нового тега в их XML-определении. Кроме того, кеш запросов теперь проверяет, являются ли вызываемые в запросе UDF детерминированными. Если да, результат запроса кешируется. (Задача [#59988](https://github.com/ClickHouse/ClickHouse/issues/59988)). [#77769](https://github.com/ClickHouse/ClickHouse/pull/77769) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
* Добавлена проверка параметров движка таблиц Buffer. [#77840](https://github.com/ClickHouse/ClickHouse/pull/77840) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Добавлена настройка `enable_hdfs_pread` для включения или отключения `pread` в HDFS. [#77885](https://github.com/ClickHouse/ClickHouse/pull/77885) ([kevinyhzou](https://github.com/KevinyhZou)).
* Добавлены события профилирования для количества запросов на чтение и запись zookeeper &#39;multi&#39;. [#77888](https://github.com/ClickHouse/ClickHouse/pull/77888) ([JackyWoo](https://github.com/JackyWoo)).
* Разрешено создавать временную таблицу и вставлять в неё данные, когда включён параметр disable&#95;insertion&#95;and&#95;mutation. [#77901](https://github.com/ClickHouse/ClickHouse/pull/77901) ([Xu Jia](https://github.com/XuJia0210)).
* Уменьшено значение настройки max&#95;insert&#95;delayed&#95;streams&#95;for&#95;parallel&#95;write (до 100). [#77919](https://github.com/ClickHouse/ClickHouse/pull/77919) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена возможность настраивать количество столбцов, которые в ходе слияний могут сбрасываться параллельно, с помощью `max_merge_delayed_streams_for_parallel_write` (это должно примерно в 25 раз снизить потребление памяти при вертикальных слияниях в S3). [#77922](https://github.com/ClickHouse/ClickHouse/pull/77922) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен разбор года в синтаксисе joda, например &#39;yyy&#39;. [#77973](https://github.com/ClickHouse/ClickHouse/pull/77973) ([李扬](https://github.com/taiyang-li)).
* Присоединение кусков таблиц MergeTree теперь выполняется в порядке их блоков, что важно для специальных алгоритмов слияния, таких как ReplacingMergeTree. Это закрывает [#71009](https://github.com/ClickHouse/ClickHouse/issues/71009). [#77976](https://github.com/ClickHouse/ClickHouse/pull/77976) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Правила маскировки запросов теперь могут выбрасывать LOGICAL&#95;ERROR при срабатывании совпадения. Это помогает проверить, не утекает ли предопределённый пароль в логи. [#78094](https://github.com/ClickHouse/ClickHouse/pull/78094) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* В `information_schema.tables` добавлен столбец `index_length_column` для лучшей совместимости с MySQL. [#78119](https://github.com/ClickHouse/ClickHouse/pull/78119) ([Paweł Zakrzewski](https://github.com/KrzaQ)).
* Добавлены две новые метрики: `TotalMergeFailures` и `NonAbortedMergeFailures`. Они необходимы для обнаружения ситуаций, когда за короткий период происходит слишком много неудачных слияний. [#78150](https://github.com/ClickHouse/ClickHouse/pull/78150) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Исправлен некорректный разбор S3 URI, когда ключ не указан при использовании path-style. [#78185](https://github.com/ClickHouse/ClickHouse/pull/78185) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлены некорректные значения асинхронных метрик `BlockActiveTime`, `BlockDiscardTime`, `BlockWriteTime`, `BlockQueueTime` и `BlockReadTime` (до изменения 1 секунда ошибочно отображалась как 0.001). [#78211](https://github.com/ClickHouse/ClickHouse/pull/78211) ([filimonov](https://github.com/filimonov)).
* Добавлено соблюдение лимита `loading_retries` для ошибок при отправке данных в материализованное представление из StorageS3(Azure)Queue. Ранее такие ошибки повторно обрабатывались бесконечно. [#78313](https://github.com/ClickHouse/ClickHouse/pull/78313) ([Kseniia Sumarokova](https://github.com/kssenii)).
* В StorageDeltaLake с реализацией delta-kernel-rs улучшены производительность и индикатор прогресса. [#78368](https://github.com/ClickHouse/ClickHouse/pull/78368) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Индекс похожести векторов мог выделять основную память с избыточным запасом — до 2 раз больше необходимого. Это исправление перерабатывает стратегию выделения памяти, снижая её потребление и повышая эффективность кэша индекса похожести векторов. (issue [#78056](https://github.com/ClickHouse/ClickHouse/issues/78056)). [#78394](https://github.com/ClickHouse/ClickHouse/pull/78394) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Добавлена настройка `schema_type` для таблицы `system.metric_log`, определяющая тип схемы. Доступно три варианта: `wide` — текущая схема, каждая метрика/событие в отдельном столбце (наиболее эффективно при чтении отдельных столбцов), `transposed` — аналогично `system.asynchronous_metric_log`, метрики/события хранятся по строкам, и самый интересный вариант `transposed_with_wide_view` — создаётся базовая таблица со схемой `transposed`, а также добавляется представление со схемой `wide`, которое транслирует запросы в базовую таблицу. В `transposed_with_wide_view` субсекундное разрешение во представлении не поддерживается, `event_time_microseconds` — это лишь псевдоним для сохранения обратной совместимости. [#78412](https://github.com/ClickHouse/ClickHouse/pull/78412) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка `include`, `from_env`, `from_zk` для дисков в режиме выполнения. Закрывает [#78177](https://github.com/ClickHouse/ClickHouse/issues/78177). [#78470](https://github.com/ClickHouse/ClickHouse/pull/78470) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлено несколько удобных способов определения корневого файла metadata.json в табличной функции и движке Iceberg. Закрывает [#78455](https://github.com/ClickHouse/ClickHouse/issues/78455). [#78475](https://github.com/ClickHouse/ClickHouse/pull/78475) ([Daniil Ivanik](https://github.com/divanik)).
* Поддержка отсечения партиций в Delta Lake. [#78486](https://github.com/ClickHouse/ClickHouse/pull/78486) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка аутентификации по паролю в протоколе SSH в ClickHouse. [#78586](https://github.com/ClickHouse/ClickHouse/pull/78586) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлено динамическое предупреждение в таблицу `system.warnings` для долго выполняющихся мутаций. [#78658](https://github.com/ClickHouse/ClickHouse/pull/78658) ([Bharat Nallan](https://github.com/bharatnc)).
* Разрывать соединения, если ЦП сильно перегружен. Решение принимается на основе отношения времени ожидания (`OSCPUWaitMicroseconds`) к времени активности (`OSCPUVirtualTimeMicroseconds`). Запрос с некоторой вероятностью будет отброшен, если это отношение находится между `min_os_cpu_wait_time_ratio_to_drop_connection` и `max_os_cpu_wait_time_ratio_to_drop_connection`. [#78778](https://github.com/ClickHouse/ClickHouse/pull/78778) ([Alexey Katsman](https://github.com/alexkats)).
* Разрешены пустые значения при секционировании Hive. [#78816](https://github.com/ClickHouse/ClickHouse/pull/78816) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлено приведение типов в операторе `IN` для `BFloat16` (то есть `SELECT toBFloat16(1) IN [1, 2, 3];` теперь возвращает `1`). Закрывает [#78754](https://github.com/ClickHouse/ClickHouse/issues/78754). [#78839](https://github.com/ClickHouse/ClickHouse/pull/78839) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Не проверять части на других дисках в MergeTree, если установлен параметр disk=. [#78855](https://github.com/ClickHouse/ClickHouse/pull/78855) ([Azat Khuzhin](https://github.com/azat)).
* Приведены к каноническому виду типы данных в `used_data_type_families` в `system.query_log`. [#78972](https://github.com/ClickHouse/ClickHouse/pull/78972) ([Kseniia Sumarokova](https://github.com/kssenii)).





## Исправление ошибки (видимое пользователю некорректное поведение в официальном стабильном релизе) {#bug-fix}


* Исправлена ошибка, из-за которой нельзя было создать узел SEQUENTIAL с помощью keeper-client. [#64177](https://github.com/ClickHouse/ClickHouse/pull/64177) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлено разрешение идентификаторов из родительских областей видимости. Добавлена поддержка использования алиасов для выражений в предложении WITH. Исправляет [#58994](https://github.com/ClickHouse/ClickHouse/issues/58994). Исправляет [#62946](https://github.com/ClickHouse/ClickHouse/issues/62946). Исправляет [#63239](https://github.com/ClickHouse/ClickHouse/issues/63239). Исправляет [#65233](https://github.com/ClickHouse/ClickHouse/issues/65233). Исправляет [#71659](https://github.com/ClickHouse/ClickHouse/issues/71659). Исправляет [#71828](https://github.com/ClickHouse/ClickHouse/issues/71828). Исправляет [#68749](https://github.com/ClickHouse/ClickHouse/issues/68749). [#66143](https://github.com/ClickHouse/ClickHouse/pull/66143) ([Dmitry Novik](https://github.com/novikd)).
* Исправлен некорректный подсчёт символов в PositionImpl::vectorVector. [#71003](https://github.com/ClickHouse/ClickHouse/pull/71003) ([思维](https://github.com/heymind)).
* Исправлена монотонность функции `negate`. В предыдущих версиях запрос `select * from a where -x = -42;`, где `x` — первичный ключ, мог возвращать неверный результат. [#71440](https://github.com/ClickHouse/ClickHouse/pull/71440) ([Michael Kolupaev](https://github.com/al13n321)).
* Операции `RESTORE` для сущностей доступа требовали больше прав, чем было необходимо, из-за необработанных частичных отзывов привилегий. Этот PR исправляет проблему. Закрывает [#71853](https://github.com/ClickHouse/ClickHouse/issues/71853). [#71958](https://github.com/ClickHouse/ClickHouse/pull/71958) ([pufit](https://github.com/pufit)).
* Устраняет паузу после `ALTER TABLE REPLACE/MOVE PARTITION FROM/TO TABLE`. Получает корректные настройки для планирования фоновых задач. [#72024](https://github.com/ClickHouse/ClickHouse/pull/72024) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Исправлена обработка пустого кортежа в arrayIntersect. Это устраняет [#72578](https://github.com/ClickHouse/ClickHouse/issues/72578). [#72581](https://github.com/ClickHouse/ClickHouse/pull/72581) ([Amos Bird](https://github.com/amosbird)).
* Исправлена обработка пустых кортежей в некоторых форматах ввода и вывода (например, Parquet и Arrow). [#72616](https://github.com/ClickHouse/ClickHouse/pull/72616) ([Michael Kolupaev](https://github.com/al13n321)).
* Операторы GRANT SELECT/INSERT на уровне столбцов для баз данных/таблиц с использованием подстановочных шаблонов теперь вызывают ошибку. [#72646](https://github.com/ClickHouse/ClickHouse/pull/72646) ([Johann Gan](https://github.com/johanngan)).
* Исправлена ситуация, когда пользователь не может выполнить `REVOKE ALL ON *.*` из-за неявно выданных прав у целевого объекта доступа. [#72872](https://github.com/ClickHouse/ClickHouse/pull/72872) ([pufit](https://github.com/pufit)).
* Исправлено зависание при обработке отложенной партии для асинхронного распределённого INSERT (например, из-за `No such file or directory`). [#72939](https://github.com/ClickHouse/ClickHouse/pull/72939) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка токенов Azure SAS. [#72959](https://github.com/ClickHouse/ClickHouse/pull/72959) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено форматирование положительных часовых поясов в скалярной функции formatDateTime(). [#73091](https://github.com/ClickHouse/ClickHouse/pull/73091) ([ollidraese](https://github.com/ollidraese)).
* Исправлена корректная идентификация исходного порта при подключении через PROXYv1 и включённом параметре `auth_use_forwarded_address` — ранее ошибочно использовался порт прокси. Добавлена функция `currentQueryID()`. [#73095](https://github.com/ClickHouse/ClickHouse/pull/73095) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Протянуть настройки формата до `NativeWriter` в `TCPHandler`, чтобы такие параметры, как `output_format_native_write_json_as_string`, применялись корректно. [#73179](https://github.com/ClickHouse/ClickHouse/pull/73179) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено чтение подстолбцов под-объекта JSON с некорректным префиксом. [#73182](https://github.com/ClickHouse/ClickHouse/pull/73182) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка в StorageObjectStorageQueue. [#73274](https://github.com/ClickHouse/ClickHouse/pull/73274) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено редкое падение обновляемого материализованного представления при остановке сервера. [#73323](https://github.com/ClickHouse/ClickHouse/pull/73323) ([Michael Kolupaev](https://github.com/al13n321)).
* Заполнитель `%f` функции `formatDateTime` теперь всегда генерирует шесть знаков для долей секунды. Это делает поведение совместимым с функцией MySQL `DATE_FORMAT`. Предыдущее поведение можно восстановить с помощью настройки `formatdatetime_f_prints_scale_number_of_digits = 1`. [#73324](https://github.com/ClickHouse/ClickHouse/pull/73324) ([ollidraese](https://github.com/ollidraese)).
* Улучшено преобразование `DateTime` при анализе индексов за счёт принудительного использования насыщенного поведения для неявных преобразований `Date` в `DateTime`. Это устраняет возможные неточности анализа индексов, вызванные ограничениями диапазона `DateTime`. Исправляет [#73307](https://github.com/ClickHouse/ClickHouse/issues/73307). Также исправлено явное преобразование `toDateTime`, когда `date_time_overflow_behavior = 'ignore'`, что является значением по умолчанию. [#73326](https://github.com/ClickHouse/ClickHouse/pull/73326) ([Amos Bird](https://github.com/amosbird)).
* Исправлена фильтрация по столбцу `_etag` при чтении из хранилища `s3` и одноимённой табличной функции. [#73353](https://github.com/ClickHouse/ClickHouse/pull/73353) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка `Not-ready Set is passed as the second argument for function 'in'`, возникающая при использовании `IN (subquery)` в выражении `JOIN ON` со старым анализатором. [#73382](https://github.com/ClickHouse/ClickHouse/pull/73382) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена подготовка к `squashin` для Dynamic- и JSON-столбцов. Ранее в некоторых случаях новые типы могли помещаться в `shared variant`/`shared data`, даже если лимит на количество типов/путей ещё не был достигнут. [#73388](https://github.com/ClickHouse/ClickHouse/pull/73388) ([Pavel Kruglov](https://github.com/Avogar)).
* Проверка некорректных размеров при бинарном декодировании типов, чтобы избежать чрезмерных выделений памяти. [#73390](https://github.com/ClickHouse/ClickHouse/pull/73390) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена логическая ошибка при чтении из кластера с одной репликой при включённом режиме параллельных реплик. [#73403](https://github.com/ClickHouse/ClickHouse/pull/73403) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена `ObjectStorageQueue` при работе с `ZooKeeper` и старым `Keeper`. [#73420](https://github.com/ClickHouse/ClickHouse/pull/73420) ([Antonio Andelic](https://github.com/antonio2368)).
* Реализовано исправление, необходимое для включения партиционирования Hive по умолчанию. [#73479](https://github.com/ClickHouse/ClickHouse/pull/73479) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена гонка данных при создании индекса векторного сходства. [#73517](https://github.com/ClickHouse/ClickHouse/pull/73517) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправляет ошибку сегментации, когда источник словаря содержит функцию с некорректными данными. [#73535](https://github.com/ClickHouse/ClickHouse/pull/73535) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлены повторные попытки вставки при ошибке в `storage S3(Azure)Queue`. Закрывает [#70951](https://github.com/ClickHouse/ClickHouse/issues/70951). [#73546](https://github.com/ClickHouse/ClickHouse/pull/73546) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка в функции `tupleElement`, которая в некоторых случаях могла возникать для кортежей с элементами типа `LowCardinality` при включённой настройке `optimize_functions_to_subcolumns`. [#73548](https://github.com/ClickHouse/ClickHouse/pull/73548) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен разбор глоба enum, за которым следует диапазон. Исправляет [#73473](https://github.com/ClickHouse/ClickHouse/issues/73473). [#73569](https://github.com/ClickHouse/ClickHouse/pull/73569) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлена проблема, из-за которой parallel&#95;replicas&#95;for&#95;non&#95;replicated&#95;merge&#95;tree игнорировался в подзапросах для нереплицируемых таблиц. [#73584](https://github.com/ClickHouse/ClickHouse/pull/73584) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправление для `std::logical_error`, выбрасываемой, когда задачу невозможно запланировать. Ошибка обнаружена в стресс‑тестах. Пример трассировки стека: `2024.12.19 02:05:46.171833 [ 18190 ] {01f0daba-d3cc-4898-9e0e-c2c263306427} <Fatal> : Logical error: 'std::exception. Code: 1001, type: std::__1::future_error, e.what() = The associated promise has been destructed prior to the associated state becoming ready. (version 25.1.1.18724), Stack trace:.` [#73629](https://github.com/ClickHouse/ClickHouse/pull/73629) ([Alexander Gololobov](https://github.com/davenger)).
* Не интерпретировать запросы в `EXPLAIN SYNTAX`, чтобы избежать логических ошибок, связанных с некорректным этапом обработки распределённых запросов. Исправляет [#65205](https://github.com/ClickHouse/ClickHouse/issues/65205). [#73634](https://github.com/ClickHouse/ClickHouse/pull/73634) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена возможная несогласованность данных в Dynamic column. Устранена потенциальная логическая ошибка `Nested columns sizes are inconsistent with local_discriminators column size`. [#73644](https://github.com/ClickHouse/ClickHouse/pull/73644) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка `NOT_FOUND_COLUMN_IN_BLOCK` в запросах с `FINAL` и `SAMPLE`. Исправлен некорректный результат в запросах `SELECT` с `FINAL` из `CollapsingMergeTree` при включённых оптимизациях `FINAL`. [#73682](https://github.com/ClickHouse/ClickHouse/pull/73682) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка, приводившая к сбоям в LIMIT BY COLUMNS. [#73686](https://github.com/ClickHouse/ClickHouse/pull/73686) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена ошибка, из-за которой при принудительном использовании обычной проекции и полном совпадении запроса с определением проекции эта проекция не выбиралась, что приводило к возникновению ошибки. [#73700](https://github.com/ClickHouse/ClickHouse/pull/73700) ([Shichao Jin](https://github.com/jsc0218)).
* Исправлена десериализация структур Dynamic/Object. Это могло приводить к исключениям CANNOT&#95;READ&#95;ALL&#95;DATA. [#73767](https://github.com/ClickHouse/ClickHouse/pull/73767) ([Pavel Kruglov](https://github.com/Avogar)).
* Пропускать `metadata_version.txt` при восстановлении частей из резервной копии. [#73768](https://github.com/ClickHouse/ClickHouse/pull/73768) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена ошибка [#73737](https://github.com/ClickHouse/ClickHouse/issues/73737). [#73775](https://github.com/ClickHouse/ClickHouse/pull/73775) ([zhanglistar](https://github.com/zhanglistar)).
* Исправляет [#72078](https://github.com/ClickHouse/ClickHouse/issues/72078) (не работала поддержка S3 Express). [#73777](https://github.com/ClickHouse/ClickHouse/pull/73777) ([Sameer Tamsekar](https://github.com/stamsekar)).
* Разрешено объединение строк с некорректными значениями столбца `sign` в таблицах `CollapsingMergeTree`. [#73864](https://github.com/ClickHouse/ClickHouse/pull/73864) ([Christoph Wurm](https://github.com/cwurm)).
* Исправлена следующая ошибка: `Row 1: ────── hostname: c-test-wy-37-server-nlkyjyb-0.c-test-wy-37-server-headless.ns-test-wy-37.svc.cluster.local type: ExceptionWhileProcessing event_date: 2024-12-23 event_time: 2024-12-23 16:21:19 event_time_microseconds: 2024-12-23 16:21:19.824624 query_start_time: 2024-12-23 16:21:19 query_start_time_microseconds: 2024-12-23 16:21:19.747142 query_duration_ms: 77 read_rows: 1 read_bytes: 134 written_rows: 0 written_bytes: 0 result_rows: 0 result_bytes: 0 memory_usage: 7824 current_database: default query: CREATE DATABASE db0 formatted_query: normalized_query_hash: 7820917191074023511 -- 7.82 quintillion query_kind: Create databases: ['db0'] tables: [] columns: [] partitions: [] projections: [] views: [] exception_code: 170 exception: Code: 170. DB::Exception: Bad get: has Null, requested Int64: While executing DDLOnClusterQueryStatus. (BAD_GET) (version 25.1.1.19134 (official build)) stack_trace: 0. ./build_docker/./src/Common/Exception.cpp:107: DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000da5e53b 1. DB::Exception::Exception(PreformattedMessage&&, int) @ 0x00000000088aca4c 2. DB::Exception::Exception<std::basic_string_view<char, std::char_traits<char>>, std::basic_string_view<char, std::char_traits<char>>>(int, FormatStringHelperImpl<std::type_identity<std::basic_string_view<char, std::char_traits<char>>>::type, std::type_identity<std::basic_string_view<char, std::char_traits<char>>>::type>, std::basic_string_view<char, std::char_traits<char>>&&, std::basic_string_view<char, std::char_traits<char>>&&) @ 0x00000000088bae8b 3. auto& DB::Field::safeGet<long>() & @ 0x0000000008a3c748 4. ./src/Core/Field.h:484: DB::ColumnVector<long>::insert(DB::Field const&) @ 0x0000000012e44c0f 5. ./build_docker/./src/Interpreters/DDLOnClusterQueryStatusSource.cpp:53: DB::DDLOnClusterQueryStatusSource::generateChunkWithUnfinishedHosts() const @ 0x0000000012a40214 6. ./build_docker/./src/Interpreters/DDLOnClusterQueryStatusSource.cpp:104: DB::DDLOnClusterQueryStatusSource::handleTimeoutExceeded() @ 0x0000000012a41640 7. ./build_docker/./src/Interpreters/DDLOnClusterQueryStatusSource.cpp:109: DB::DDLOnClusterQueryStatusSource::stopWaitingOfflineHosts() @ 0x0000000012a41be9 8. ./build_docker/./src/Interpreters/DistributedQueryStatusSource.cpp:182: DB::DistributedQueryStatusSource::generate() @ 0x0000000011feb3bf 9. ./build_docker/./src/Processors/ISource.cpp:139: DB::ISource::tryGenerate() @ 0x0000000014148f5b 10. ./build_docker/./src/Processors/ISource.cpp:108: DB::ISource::work() @ 0x0000000014148c47 11. ./build_docker/./src/Processors/Executors/ExecutionThreadContext.cpp:49: DB::ExecutionThreadContext::executeTask() @ 0x0000000014164fc7 12. ./build_docker/./src/Processors/Executors/PipelineExecutor.cpp:290: DB::PipelineExecutor::executeStepImpl(unsigned long, std::atomic<bool>*) @ 0x00000000141577e5`. [#73876](https://github.com/ClickHouse/ClickHouse/pull/73876) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлена редкая ошибка сравнения типов `map()`, возникавшая из‑за возможности создать `Map` без явных имён (`keys`, `values`) для вложенного кортежа. [#73878](https://github.com/ClickHouse/ClickHouse/pull/73878) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Игнорировать оконные функции при обработке предложения GROUP BY ALL. Исправить [#73501](https://github.com/ClickHouse/ClickHouse/issues/73501). [#73916](https://github.com/ClickHouse/ClickHouse/pull/73916) ([Dmitry Novik](https://github.com/novikd)).
* Корректная передача настроек формата Native при клиент-серверном взаимодействии. [#73924](https://github.com/ClickHouse/ClickHouse/pull/73924) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено поведение неявных привилегий (раньше они работали как подстановочный шаблон). [#73932](https://github.com/ClickHouse/ClickHouse/pull/73932) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено повышенное потребление памяти при создании вложенных Maps. [#73982](https://github.com/ClickHouse/ClickHouse/pull/73982) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен парсинг вложенного JSON с пустыми ключами. [#73993](https://github.com/ClickHouse/ClickHouse/pull/73993) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправление: псевдоним мог не добавляться в проекцию, если на него ссылался другой псевдоним и он выбирался в обратном порядке. [#74033](https://github.com/ClickHouse/ClickHouse/pull/74033) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Диск, использующий формат метаданных plain&#95;rewritable, может совместно использоваться несколькими экземплярами сервера. Предполагается, что один экземпляр может читать объект метаданных, пока другой его изменяет. Ошибки вида «объект не найден» игнорируются во время инициализации plain&#95;rewritable с хранилищем Azure, аналогично поведению, реализованному для S3. [#74059](https://github.com/ClickHouse/ClickHouse/pull/74059) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлено поведение функций `any` и `anyLast` с типами `Enum` и пустой таблицей. [#74061](https://github.com/ClickHouse/ClickHouse/pull/74061) ([Joanna Hulboj](https://github.com/jh0x)).
* Исправлена ситуация, когда пользователь указывает именованные аргументы в движке таблиц Kafka. [#74064](https://github.com/ClickHouse/ClickHouse/pull/74064) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена смена настроек хранилища `S3Queue` с префиксом &quot;s3queue&#95;&quot; на без него и обратно. [#74075](https://github.com/ClickHouse/ClickHouse/pull/74075) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена настройка `allow_push_predicate_ast_for_distributed_subqueries`. Она включает основанный на AST push-down предикатов для распределённых запросов с анализатором. Это временное решение, которое мы используем до тех пор, пока не будет добавлена поддержка распределённых запросов с сериализацией плана запроса. Закрывает [#66878](https://github.com/ClickHouse/ClickHouse/issues/66878) [#69472](https://github.com/ClickHouse/ClickHouse/issues/69472) [#65638](https://github.com/ClickHouse/ClickHouse/issues/65638) [#68030](https://github.com/ClickHouse/ClickHouse/issues/68030) [#73718](https://github.com/ClickHouse/ClickHouse/issues/73718). [#74085](https://github.com/ClickHouse/ClickHouse/pull/74085) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена проблема, из-за которой после [#73095](https://github.com/ClickHouse/ClickHouse/issues/73095) в поле forwarded&#95;for мог присутствовать порт, что приводило к невозможности разрешить имя хоста, включающее порт. [#74116](https://github.com/ClickHouse/ClickHouse/pull/74116) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлено некорректное форматирование команды `ALTER TABLE (DROP STATISTICS ...) (DROP STATISTICS ...)`. [#74126](https://github.com/ClickHouse/ClickHouse/pull/74126) ([Han Fei](https://github.com/hanfei1991)).
* Исправление для задачи [#66112](https://github.com/ClickHouse/ClickHouse/issues/66112). [#74128](https://github.com/ClickHouse/ClickHouse/pull/74128) ([Anton Ivashkin](https://github.com/ianton-ru)).
* Больше нельзя использовать движок таблицы `Loop` в `CREATE TABLE`. Это сочетание ранее приводило к сбоям (segfault). [#74137](https://github.com/ClickHouse/ClickHouse/pull/74137) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена уязвимость, предотвращающая SQL‑инъекции в табличных функциях `postgresql` и `sqlite`. [#74144](https://github.com/ClickHouse/ClickHouse/pull/74144) ([Pablo Marcos](https://github.com/pamarcos)).
* Исправлен сбой при чтении подклонки из сжатой таблицы движка Memory. Исправляет [#74009](https://github.com/ClickHouse/ClickHouse/issues/74009). [#74161](https://github.com/ClickHouse/ClickHouse/pull/74161) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена бесконечная петля, возникавшая при запросах к system.detached&#95;tables. [#74190](https://github.com/ClickHouse/ClickHouse/pull/74190) ([Konstantin Morozov](https://github.com/k-morozov)).
* Исправлена логическая ошибка в `s3queue` при пометке файла как сбойного. [#74216](https://github.com/ClickHouse/ClickHouse/pull/74216) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Проверка неподдерживаемых типов для некоторых хранилищ. [#74218](https://github.com/ClickHouse/ClickHouse/pull/74218) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено падение при выполнении запроса `INSERT INTO SELECT` через интерфейс PostgreSQL на macOS (issue [#72938](https://github.com/ClickHouse/ClickHouse/issues/72938)). [#74231](https://github.com/ClickHouse/ClickHouse/pull/74231) ([Artem Yurov](https://github.com/ArtemYurov)).
* Исправлены параметры нативного копирования (`allow_s3_native_copy`/`allow_azure_native_copy`) для `RESTORE` из базового бэкапа. [#74286](https://github.com/ClickHouse/ClickHouse/pull/74286) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема, возникавшая, когда количество отсоединённых таблиц в базе данных было кратно значению max&#95;block&#95;size. [#74289](https://github.com/ClickHouse/ClickHouse/pull/74289) ([Konstantin Morozov](https://github.com/k-morozov)).
* Исправлено копирование через ObjectStorage (например, S3), когда учетные данные источника и приемника различаются. [#74331](https://github.com/ClickHouse/ClickHouse/pull/74331) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема с неинициализированной max&#95;log&#95;ptr в реплицируемой базе данных. [#74336](https://github.com/ClickHouse/ClickHouse/pull/74336) ([Konstantin Morozov](https://github.com/k-morozov)).
* Исправлено определение режима «use the Rewrite method in the JSON API» для нативного копирования в GCS. [#74338](https://github.com/ClickHouse/ClickHouse/pull/74338) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, вызывавшая сбой при вставке `interval` (issue [#74299](https://github.com/ClickHouse/ClickHouse/issues/74299)). [#74478](https://github.com/ClickHouse/ClickHouse/pull/74478) ([NamNguyenHoai](https://github.com/NamHoaiNguyen)).
* Исправлен некорректный анализ проекций при использовании `count(nullable)` в агрегатных проекциях. Это исправляет [#74495](https://github.com/ClickHouse/ClickHouse/issues/74495). В этот PR также добавлены дополнительные логи, связанные с анализом проекций, чтобы прояснить, почему проекция используется или нет. [#74498](https://github.com/ClickHouse/ClickHouse/pull/74498) ([Amos Bird](https://github.com/amosbird)).
* Исправлен некорректный расчет `BackgroundMergesAndMutationsPoolSize` (он был в 2 раза больше фактического значения). [#74509](https://github.com/ClickHouse/ClickHouse/pull/74509) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка утечки наблюдателей Keeper при включённом Cluster Discovery. [#74521](https://github.com/ClickHouse/ClickHouse/pull/74521) ([RinChanNOW](https://github.com/RinChanNOWWW)).
* Исправлено форматирование констант JSON. Ранее это могло приводить к синтаксическим ошибкам при отправке запроса на другой сервер. [#74533](https://github.com/ClickHouse/ClickHouse/pull/74533) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена проблема с выравниванием памяти, обнаруженная UBSan [#74512](https://github.com/ClickHouse/ClickHouse/issues/74512). [#74534](https://github.com/ClickHouse/ClickHouse/pull/74534) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлена конкурентная очистка KeeperMap при создании таблицы. [#74568](https://github.com/ClickHouse/ClickHouse/pull/74568) ([Antonio Andelic](https://github.com/antonio2368)).
* Не удалять неиспользуемые столбцы проекций в подзапросах при наличии `EXCEPT` или `INTERSECT`, чтобы сохранить корректный результат запроса. Исправляет [#73930](https://github.com/ClickHouse/ClickHouse/issues/73930). Исправляет [#66465](https://github.com/ClickHouse/ClickHouse/issues/66465). [#74577](https://github.com/ClickHouse/ClickHouse/pull/74577) ([Dmitry Novik](https://github.com/novikd)).
* Исправлен некорректный запрос `CREATE` при использовании константных выражений партиционирования с включёнными неявными проекциями. Это исправляет [#74596](https://github.com/ClickHouse/ClickHouse/issues/74596). [#74634](https://github.com/ClickHouse/ClickHouse/pull/74634) ([Amos Bird](https://github.com/amosbird)).
* Исправлена работа запросов `INSERT SELECT` между таблицами с колонками типа `Tuple` и включённой разрежённой сериализацией. [#74698](https://github.com/ClickHouse/ClickHouse/pull/74698) ([Anton Popov](https://github.com/CurtizJ)).
* Функция `right` работала некорректно при константном отрицательном сдвиге. [#74701](https://github.com/ClickHouse/ClickHouse/pull/74701) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлена проблема, из-за которой вставка gzip-сжатых данных иногда завершалась сбоем из-за некорректной декомпрессии на стороне клиента. [#74707](https://github.com/ClickHouse/ClickHouse/pull/74707) ([siyuan](https://github.com/linkwk7)).
* Избегайте оставлять соединение в некорректном состоянии после завершения INSERT с исключением. [#74740](https://github.com/ClickHouse/ClickHouse/pull/74740) ([Azat Khuzhin](https://github.com/azat)).
* Избегайте повторного использования соединений, которые были оставлены в промежуточном состоянии. [#74749](https://github.com/ClickHouse/ClickHouse/pull/74749) ([Azat Khuzhin](https://github.com/azat)).
* Частичный отзыв привилегий с использованием подстановочных шаблонов мог удалять больше прав, чем ожидалось. Закрывает [#74263](https://github.com/ClickHouse/ClickHouse/issues/74263). [#74751](https://github.com/ClickHouse/ClickHouse/pull/74751) ([pufit](https://github.com/pufit)).
* Исправлен сбой при разборе объявления типа JSON, когда имя типа указано не заглавными буквами. [#74784](https://github.com/ClickHouse/ClickHouse/pull/74784) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправление в Keeper: исправлено чтение записей журнала с диска. [#74785](https://github.com/ClickHouse/ClickHouse/pull/74785) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена проверка прав для SYSTEM REFRESH/START/STOP VIEW: теперь для выполнения запроса к конкретному представлению не требуется иметь это право на `*.*`, достаточно права только на это представление. [#74789](https://github.com/ClickHouse/ClickHouse/pull/74789) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Функция `hasColumnInTable` не учитывает столбцы-алиасы. Исправлена, чтобы также работать со столбцами-алиасами. [#74841](https://github.com/ClickHouse/ClickHouse/pull/74841) ([Bharat Nallan](https://github.com/bharatnc)).
* Keeper: исправлена ошибка `logical_error`, возникавшая при разрыве соединения до его установления. [#74844](https://github.com/ClickHouse/ClickHouse/pull/74844) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлено поведение, из-за которого сервер не мог запуститься, если существовала таблица с использованием `AzureBlobStorage`. Теперь таблицы загружаются без каких-либо запросов к Azure. [#74880](https://github.com/ClickHouse/ClickHouse/pull/74880) ([Alexey Katsman](https://github.com/alexkats)).
* Исправлены отсутствовавшие поля `used_privileges` и `missing_privileges` в `query_log` для операций BACKUP и RESTORE. [#74887](https://github.com/ClickHouse/ClickHouse/pull/74887) ([Alexey Katsman](https://github.com/alexkats)).
* Исправлена ошибка FILE&#95;DOESNT&#95;EXIST, возникавшая при слиянии кусков данных таблицы с пустым столбцом в Azure Blob Storage. [#74892](https://github.com/ClickHouse/ClickHouse/pull/74892) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлено имя столбца проекции при соединении временных таблиц, закрыт [#68872](https://github.com/ClickHouse/ClickHouse/issues/68872). [#74897](https://github.com/ClickHouse/ClickHouse/pull/74897) ([Vladimir Cherkasov](https://github.com/vdimir)).
* HDFS обновляет krb‑тикет при ошибке SASL во время запроса `hdfs select`. [#74930](https://github.com/ClickHouse/ClickHouse/pull/74930) ([inv2004](https://github.com/inv2004)).
* Исправлены запросы к базе данных Replicated в startup&#95;scripts. [#74942](https://github.com/ClickHouse/ClickHouse/pull/74942) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены проблемы с выражениями с псевдонимами типов в предложении JOIN ON при использовании null-устойчивого сравнения. [#74970](https://github.com/ClickHouse/ClickHouse/pull/74970) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Состояние парта переводится из deleting обратно в outdated, если операция удаления завершилась неудачно. [#74985](https://github.com/ClickHouse/ClickHouse/pull/74985) ([Sema Checherinda](https://github.com/CheSema)).
* В предыдущих версиях, когда использовался скалярный подзапрос, мы начинали записывать прогресс (накопленный при обработке подзапроса) во время инициализации формата данных, то есть до записи HTTP-заголовков. Это приводило к потере HTTP-заголовков, таких как X-ClickHouse-QueryId и X-ClickHouse-Format, а также Content-Type. [#74991](https://github.com/ClickHouse/ClickHouse/pull/74991) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлены запросы `CREATE TABLE AS...` при `database_replicated_allow_replicated_engine_arguments=0`. [#75000](https://github.com/ClickHouse/ClickHouse/pull/75000) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлена проблема, из-за которой соединение в клиенте оставалось в некорректном состоянии после исключений при INSERT. [#75030](https://github.com/ClickHouse/ClickHouse/pull/75030) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена аварийная остановка из-за необработанного исключения в репликации PSQL. [#75062](https://github.com/ClickHouse/ClickHouse/pull/75062) ([Azat Khuzhin](https://github.com/azat)).
* Sasl может привести к сбою любого RPC-вызова; это исправление позволяет повторить вызов, если срок действия krb5 ticket истёк. [#75063](https://github.com/ClickHouse/ClickHouse/pull/75063) ([inv2004](https://github.com/inv2004)).
* Исправлена работа индексов (первичных и вторичных) для столбцов `Array`, `Map` и `Nullable(..)` при включённой настройке `optimize_function_to_subcolumns`. Ранее индексы для этих столбцов могли игнорироваться. [#75081](https://github.com/ClickHouse/ClickHouse/pull/75081) ([Anton Popov](https://github.com/CurtizJ)).
* Отключите `flatten_nested` при создании материализованных представлений с внутренними таблицами, так как использовать такие расплющенные столбцы будет невозможно. [#75085](https://github.com/ClickHouse/ClickHouse/pull/75085) ([Christoph Wurm](https://github.com/cwurm)).
* Исправлена ошибка, из-за которой некоторые IPv6-адреса (такие как ::ffff:1.1.1.1) в поле forwarded&#95;for неправильно интерпретировались, что приводило к отключению клиента с исключением. [#75133](https://github.com/ClickHouse/ClickHouse/pull/75133) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена обработка nullsafe JOIN для допускающего NULL типа данных LowCardinality. Ранее JOIN ON с nullsafe‑сравнением, таким как `IS NOT DISTINCT FROM`, `<=>`, `a IS NULL AND b IS NULL OR a == b`, работал некорректно с колонками LowCardinality. [#75143](https://github.com/ClickHouse/ClickHouse/pull/75143) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлены запросы с неиспользуемой интерполяцией с помощью нового анализатора. [#75173](https://github.com/ClickHouse/ClickHouse/pull/75173) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлена ошибка, приводившая к сбою CTE при выполнении Insert. [#75188](https://github.com/ClickHouse/ClickHouse/pull/75188) ([Shichao Jin](https://github.com/jsc0218)).
* Исправление в Keeper: предотвращение записи в повреждённые журналы изменений при откате журналов. [#75197](https://github.com/ClickHouse/ClickHouse/pull/75197) ([Antonio Andelic](https://github.com/antonio2368)).
* Используйте `BFloat16` как супертайп там, где это уместно. Это закрывает: [#74404](https://github.com/ClickHouse/ClickHouse/issues/74404). [#75236](https://github.com/ClickHouse/ClickHouse/pull/75236) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлены неожиданные значения по умолчанию в результате `JOIN` при использовании `any_join_distinct_right_table_keys` и оператора `OR` в `JOIN ON`. [#75262](https://github.com/ClickHouse/ClickHouse/pull/75262) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Скрытие учетных данных движка таблиц azureblobstorage. [#75319](https://github.com/ClickHouse/ClickHouse/pull/75319) ([Garrett Thomas](https://github.com/garrettthomaskth)).
* Исправлено поведение, при котором ClickHouse мог ошибочно выполнять проталкивание фильтра (`filter pushdown`) во внешнюю базу данных, такую как PostgreSQL, MySQL или SQLite. Исправление закрывает: [#71423](https://github.com/ClickHouse/ClickHouse/issues/71423). [#75320](https://github.com/ClickHouse/ClickHouse/pull/75320) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена ошибка, приводившая к сбою в кеше схем Protobuf, который мог возникать при выводе в формате Protobuf и одновременном выполнении запроса `SYSTEM DROP FORMAT SCHEMA CACHE`. [#75357](https://github.com/ClickHouse/ClickHouse/pull/75357) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена возможная логическая ошибка или проблема с неинициализированной памятью при проталкивании фильтра из `HAVING` в режиме параллельных реплик. [#75363](https://github.com/ClickHouse/ClickHouse/pull/75363) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Скрытие конфиденциальной информации для табличных функций и движков таблиц `icebergS3` и `icebergAzure`. [#75378](https://github.com/ClickHouse/ClickHouse/pull/75378) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Функция `TRIM` с вычисляемыми пустыми символами для обрезки теперь обрабатывается корректно. Пример: `SELECT TRIM(LEADING concat('') FROM 'foo')` (Issue [#69922](https://github.com/ClickHouse/ClickHouse/issues/69922)). [#75399](https://github.com/ClickHouse/ClickHouse/pull/75399) ([Manish Gill](https://github.com/mgill25)).
* Исправлена гонка данных в IOutputFormat. [#75448](https://github.com/ClickHouse/ClickHouse/pull/75448) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена возможная ошибка `Elements ... and ... of Nested data structure ... (Array columns) have different array sizes` при использовании JSON-подстолбцов типа Array в `JOIN` по распределённым таблицам. [#75512](https://github.com/ClickHouse/ClickHouse/pull/75512) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен некорректный расчёт размера буфера результатов. Закрывает [#70031](https://github.com/ClickHouse/ClickHouse/issues/70031). [#75548](https://github.com/ClickHouse/ClickHouse/pull/75548) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлено взаимодействие между `allow_feature_tier` и настройкой совместимости для `mergetree`. [#75635](https://github.com/ClickHouse/ClickHouse/pull/75635) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено некорректное значение processed&#95;rows в system.s3queue&#95;log при повторной обработке файла. [#75666](https://github.com/ClickHouse/ClickHouse/pull/75666) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Соблюдать настройку `materialized_views_ignore_errors`, когда материализованное представление записывает в движок URL и возникает проблема с подключением. [#75679](https://github.com/ClickHouse/ClickHouse/pull/75679) ([Christoph Wurm](https://github.com/cwurm)).
* Исправлены редкие падения при чтении из таблицы `MergeTree` после нескольких асинхронных запросов `RENAME` (с `alter_sync = 0`) между столбцами с разными типами. [#75693](https://github.com/ClickHouse/ClickHouse/pull/75693) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка `Block structure mismatch in QueryPipeline stream` для некоторых запросов с `UNION ALL`. [#75715](https://github.com/ClickHouse/ClickHouse/pull/75715) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Перестраивает проекцию при `ALTER MODIFY` столбца её первичного ключа. Ранее это могло приводить к ошибкам `CANNOT_READ_ALL_DATA` при выполнении `SELECT` после `ALTER MODIFY` столбца, используемого в первичном ключе проекции. [#75720](https://github.com/ClickHouse/ClickHouse/pull/75720) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен некорректный результат `ARRAY JOIN` для скалярных подзапросов (с analyzer). [#75732](https://github.com/ClickHouse/ClickHouse/pull/75732) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка разыменования нулевого указателя в `DistinctSortedStreamTransform`. [#75734](https://github.com/ClickHouse/ClickHouse/pull/75734) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлено поведение параметра `allow_suspicious_ttl_expressions`. [#75771](https://github.com/ClickHouse/ClickHouse/pull/75771) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Исправлено чтение неинициализированной памяти в функции `translate`. Закрывает [#75592](https://github.com/ClickHouse/ClickHouse/issues/75592). [#75794](https://github.com/ClickHouse/ClickHouse/pull/75794) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Распространить настройки формата на JSON как форматирование строк в формате Native. [#75832](https://github.com/ClickHouse/ClickHouse/pull/75832) ([Pavel Kruglov](https://github.com/Avogar)).
* В истории изменений настроек зафиксировано включение параллельного hash по умолчанию в качестве алгоритма join в v24.12. Это означает, что ClickHouse продолжит выполнять join, используя непараллельный hash, если настроен уровень совместимости старше, чем v24.12. [#75870](https://github.com/ClickHouse/ClickHouse/pull/75870) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена ошибка, из-за которой таблицы с неявно добавленными min-max-индексами нельзя было скопировать в новую таблицу (issue [#75677](https://github.com/ClickHouse/ClickHouse/issues/75677)). [#75877](https://github.com/ClickHouse/ClickHouse/pull/75877) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* `clickhouse-library-bridge` позволяет открывать произвольные библиотеки из файловой системы, поэтому его безопасно запускать только в изолированной среде. Чтобы предотвратить уязвимость при запуске рядом с clickhouse-server, мы ограничим пути к библиотекам расположением, заданным в конфигурации. Эта уязвимость была обнаружена в рамках [программы вознаграждений за уязвимости ClickHouse](https://github.com/ClickHouse/ClickHouse/issues/38986) **Арсением Дугиным**. [#75954](https://github.com/ClickHouse/ClickHouse/pull/75954) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Мы использовали JSON-сериализацию для некоторой метаинформации, что оказалось ошибкой, потому что JSON не поддерживает бинарные данные внутри строковых литералов, включая нулевые байты. SQL-запросы могут содержать бинарные данные и некорректный UTF-8, поэтому мы должны поддерживать это и в наших файлах метаданных. В то же время форматы ClickHouse `JSONEachRow` и подобные обходят это ограничение, намеренно отклоняясь от стандарта JSON ради корректного обратимого преобразования бинарных данных. Мотивацию см. здесь: [https://github.com/ClickHouse/ClickHouse/pull/73668#issuecomment-2560501790](https://github.com/ClickHouse/ClickHouse/pull/73668#issuecomment-2560501790). Решение заключается в том, чтобы сделать библиотеку `Poco::JSON` согласованной с форматами JSON-сериализации в ClickHouse. Это закрывает [#73668](https://github.com/ClickHouse/ClickHouse/issues/73668). [#75963](https://github.com/ClickHouse/ClickHouse/pull/75963) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка `Part <...> does not contain in snapshot of previous virtual parts. (PART_IS_TEMPORARILY_LOCKED)` при выполнении операции DETACH PART. [#76039](https://github.com/ClickHouse/ClickHouse/pull/76039) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Исправлена проверка ограничений на фиксацию в хранилище `S3Queue`. [#76104](https://github.com/ClickHouse/ClickHouse/pull/76104) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено присоединение таблиц MergeTree с автоиндексами (`add_minmax_index_for_numeric_columns`/`add_minmax_index_for_string_columns`). [#76139](https://github.com/ClickHouse/ClickHouse/pull/76139) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема, из-за которой не выводились stack trace из родительских потоков задания (настройка `enable_job_stack_trace`). Также исправлена проблема, из-за которой настройка `enable_job_stack_trace` некорректно передавалась в потоки, в результате чего содержимое stack trace не всегда соответствовало этой настройке. [#76191](https://github.com/ClickHouse/ClickHouse/pull/76191) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена работа `reinterpretAs` с `FixedString` на архитектуре с порядком байт big-endian. [#76253](https://github.com/ClickHouse/ClickHouse/pull/76253) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены все виды ошибок, возникавших из‑за гонки между UUID и именами таблиц (например, это устраняет гонку между `RENAME` и `RESTART REPLICA`, когда при одновременном выполнении `RENAME` и `SYSTEM RESTART REPLICA` вы могли в итоге перезапустить неверную реплику и/или оставить одну из таблиц в состоянии `Table X is being restarted`). [#76308](https://github.com/ClickHouse/ClickHouse/pull/76308) ([Azat Khuzhin](https://github.com/azat)).
* Удалено выделение памяти в обработчике сигнала. [#76446](https://github.com/ClickHouse/ClickHouse/pull/76446) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена обработка динамического изменения размера файлового кэша при неожиданных ошибках во время вытеснения. [#76466](https://github.com/ClickHouse/ClickHouse/pull/76466) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена инициализация `used_flag` в параллельном хэше. Это могло приводить к аварийному завершению работы сервера. [#76580](https://github.com/ClickHouse/ClickHouse/pull/76580) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена логическая ошибка при вызове функции `defaultProfiles()` внутри проекции. [#76627](https://github.com/ClickHouse/ClickHouse/pull/76627) ([pufit](https://github.com/pufit)).
* Не запрашивать интерактивную базовую аутентификацию в браузере в веб-интерфейсе. Закрывает [#76319](https://github.com/ClickHouse/ClickHouse/issues/76319). [#76637](https://github.com/ClickHouse/ClickHouse/pull/76637) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка THERE&#95;IS&#95;NO&#95;COLUMN при выборе булевого литерала из распределённых таблиц. [#76656](https://github.com/ClickHouse/ClickHouse/pull/76656) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Подкаталог внутри директории таблицы теперь выбирается более продуманным образом. [#76681](https://github.com/ClickHouse/ClickHouse/pull/76681) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлена ошибка `Not found column in block`, возникавшая после изменения таблицы с подстолбцом в первичном ключе. После [https://github.com/ClickHouse/ClickHouse/pull/72644](https://github.com/ClickHouse/ClickHouse/pull/72644) требуется [https://github.com/ClickHouse/ClickHouse/pull/74403](https://github.com/ClickHouse/ClickHouse/pull/74403). [#76686](https://github.com/ClickHouse/ClickHouse/pull/76686) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлены тесты производительности для короткого замыкания при `NULL` и исправлены ошибки. [#76708](https://github.com/ClickHouse/ClickHouse/pull/76708) ([李扬](https://github.com/taiyang-li)).
* Сбрасывать выходные буферы записи перед их финализацией. Исправлена ошибка `LOGICAL_ERROR`, возникавшая при финализации некоторых выходных форматов, например `JSONEachRowWithProgressRowOutputFormat`. [#76726](https://github.com/ClickHouse/ClickHouse/pull/76726) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена поддержка бинарного UUID MongoDB ([#74452](https://github.com/ClickHouse/ClickHouse/issues/74452)) - Исправлен проталкивающий фильтр `WHERE` в MongoDB при использовании табличной функции ([#72210](https://github.com/ClickHouse/ClickHouse/issues/72210)) - Изменено сопоставление типов MongoDB – ClickHouse таким образом, что бинарный UUID MongoDB может быть разобран только в UUID ClickHouse. Это должно предотвратить неоднозначности и неожиданные эффекты в будущем. - Исправлено сопоставление OID с сохранением обратной совместимости. [#76762](https://github.com/ClickHouse/ClickHouse/pull/76762) ([Kirill Nikiforov](https://github.com/allmazz)).
* Исправлена обработка исключений при параллельной десериализации префиксов JSON‑подстолбцов. [#76809](https://github.com/ClickHouse/ClickHouse/pull/76809) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено поведение функции lgamma для отрицательных целых чисел. [#76840](https://github.com/ClickHouse/ClickHouse/pull/76840) ([Ilya Kataev](https://github.com/IlyaKataev)).
* Исправлен анализ обратного ключа для явно заданных первичных ключей. Аналогично [#76654](https://github.com/ClickHouse/ClickHouse/issues/76654). [#76846](https://github.com/ClickHouse/ClickHouse/pull/76846) ([Amos Bird](https://github.com/amosbird)).
* Исправлено красивое отображение значений Bool в формате JSON. [#76905](https://github.com/ClickHouse/ClickHouse/pull/76905) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена возможная аварийная остановка из‑за некорректного отката столбца JSON при ошибке во время асинхронных вставок. [#76908](https://github.com/ClickHouse/ClickHouse/pull/76908) ([Pavel Kruglov](https://github.com/Avogar)).
* Ранее `multi_if` мог возвращать столбцы разных типов на этапе планирования и при основном выполнении. Это приводило к коду с неопределённым поведением с точки зрения C++. [#76914](https://github.com/ClickHouse/ClickHouse/pull/76914) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена некорректная сериализация константных nullable-ключей в MergeTree. Это устраняет [#76939](https://github.com/ClickHouse/ClickHouse/issues/76939). [#76985](https://github.com/ClickHouse/ClickHouse/pull/76985) ([Amos Bird](https://github.com/amosbird)).
* Исправлена сортировка значений `BFloat16`. Закрыты [#75487](https://github.com/ClickHouse/ClickHouse/issues/75487) и [#75669](https://github.com/ClickHouse/ClickHouse/issues/75669). [#77000](https://github.com/ClickHouse/ClickHouse/pull/77000) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка в JSON с подстолбцом типа `Variant` путём добавления проверки, пропускающей эфемерные подстолбцы при проверке целостности части. [#72187](https://github.com/ClickHouse/ClickHouse/issues/72187). [#77034](https://github.com/ClickHouse/ClickHouse/pull/77034) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Исправлен сбой при разборе шаблона в формате Values при несоответствии типов. [#77071](https://github.com/ClickHouse/ClickHouse/pull/77071) ([Pavel Kruglov](https://github.com/Avogar)).
* Запрещено создавать таблицу EmbeddedRocksDB с подстолбцом в первичном ключе. Ранее такую таблицу можно было создать, но запросы `SELECT` завершались с ошибкой. [#77074](https://github.com/ClickHouse/ClickHouse/pull/77074) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено некорректное сравнение в распределённых запросах, возникающее из-за того, что проталкивание предикатов на удалённые узлы не учитывает типы литералов. [#77093](https://github.com/ClickHouse/ClickHouse/pull/77093) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлена ошибка, приводившая к сбою при создании таблицы Kafka при возникновении исключения. [#77121](https://github.com/ClickHouse/ClickHouse/pull/77121) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена поддержка нового формата JSON и подколнок в движках Kafka и RabbitMQ. [#77122](https://github.com/ClickHouse/ClickHouse/pull/77122) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена обработка раскрутки стека исключений на macOS. [#77126](https://github.com/ClickHouse/ClickHouse/pull/77126) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлено чтение подстолбца `null` в функции getSubcolumn. [#77163](https://github.com/ClickHouse/ClickHouse/pull/77163) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлены неработающие пропускающие индексы с выражениями, содержащими литералы, в анализаторе, а также удалены тривиальные приведения типов во время анализа индексов. [#77229](https://github.com/ClickHouse/ClickHouse/pull/77229) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена работа индекса фильтра Блума с `Array` и неподдерживаемыми функциями. [#77271](https://github.com/ClickHouse/ClickHouse/pull/77271) ([Pavel Kruglov](https://github.com/Avogar)).
* Ограничение на количество таблиц следует проверять только при исходном запросе CREATE. [#77274](https://github.com/ClickHouse/ClickHouse/pull/77274) ([Nikolay Degterinsky](https://github.com/evillique)).
* `SELECT toBFloat16(-0.0) == toBFloat16(0.0)` теперь корректно возвращает `true` (раньше возвращал `false`). Это делает поведение единообразным с `Float32` и `Float64`. [#77290](https://github.com/ClickHouse/ClickHouse/pull/77290) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Исправлено возможное некорректное обращение к неинициализированной переменной key&#95;index, которое могло приводить к сбоям в debug-сборках (это неинициализированное обращение не вызывало проблем в release-сборках, поскольку последующий код, скорее всего, выбрасывал ошибки). ### запись в документации для изменений, заметных пользователю. [#77305](https://github.com/ClickHouse/ClickHouse/pull/77305) ([wxybear](https://github.com/wxybear)).
* Откат изменений. [#77307](https://github.com/ClickHouse/ClickHouse/pull/77307) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено имя партиции со значением типа Bool. Оно было сломано в [https://github.com/ClickHouse/ClickHouse/pull/74533](https://github.com/ClickHouse/ClickHouse/pull/74533). [#77319](https://github.com/ClickHouse/ClickHouse/pull/77319) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено сравнение между кортежами с Nullable-элементами и строками. Например, до этого изменения сравнение между кортежем `(1, null)` и строкой `'(1,null)'` приводило к ошибке. Другой пример — сравнение между кортежем `(1, a)`, где `a` — столбец типа Nullable, и строкой `'(1, 2)'`. Это изменение устраняет эти проблемы. [#77323](https://github.com/ClickHouse/ClickHouse/pull/77323) ([Alexey Katsman](https://github.com/alexkats)).
* Исправлено аварийное завершение работы в ObjectStorageQueueSource. Ошибка была внесена в [https://github.com/ClickHouse/ClickHouse/pull/76358](https://github.com/ClickHouse/ClickHouse/pull/76358). [#77325](https://github.com/ClickHouse/ClickHouse/pull/77325) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка, из-за которой параметр запроса `close_session` не оказывал никакого действия, и именованные сессии закрывались только по истечении `session_timeout`. [#77336](https://github.com/ClickHouse/ClickHouse/pull/77336) ([Alexey Katsman](https://github.com/alexkats)).
* Исправлена работа `async_insert` с `input()`. [#77340](https://github.com/ClickHouse/ClickHouse/pull/77340) ([Azat Khuzhin](https://github.com/azat)).
* Исправление: `WITH FILL` мог завершаться с ошибкой `NOT_FOUND_COLUMN_IN_BLOCK`, когда планировщик удалял столбец сортировки. Аналогичная проблема была связана с неконсистентным DAG, вычисленным для выражения `INTERPOLATE`. [#77343](https://github.com/ClickHouse/ClickHouse/pull/77343) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Откат изменений. [#77390](https://github.com/ClickHouse/ClickHouse/pull/77390) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлено получение сообщений от сервера NATS без присоединённого MV. [#77392](https://github.com/ClickHouse/ClickHouse/pull/77392) ([Dmitry Novikov](https://github.com/dmitry-sles-novikov)).
* Исправлена логическая ошибка при чтении из пустого `FileLog` с помощью табличной функции `merge`, закрыта задача [#75575](https://github.com/ClickHouse/ClickHouse/issues/75575). [#77441](https://github.com/ClickHouse/ClickHouse/pull/77441) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлено несколько ошибок типа `LOGICAL_ERROR`, возникавших при установке псевдонима для некорректных узлов AST. [#77445](https://github.com/ClickHouse/ClickHouse/pull/77445) ([Raúl Marín](https://github.com/Algunenano)).
* В реализации кэша файловой системы исправлена обработка ошибок при записи сегмента файла. [#77471](https://github.com/ClickHouse/ClickHouse/pull/77471) ([Kseniia Sumarokova](https://github.com/kssenii)).
* DatabaseIceberg теперь использует корректный файл метаданных, предоставленный каталогом. Закрывает [#75187](https://github.com/ClickHouse/ClickHouse/issues/75187). [#77486](https://github.com/ClickHouse/ClickHouse/pull/77486) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Использовать настройки формата по умолчанию в динамической сериализации из shared variant. [#77572](https://github.com/ClickHouse/ClickHouse/pull/77572) ([Pavel Kruglov](https://github.com/Avogar)).
* Отменить изменение &#39;Avoid toAST() in execution of scalar subqueries&#39;. [#77584](https://github.com/ClickHouse/ClickHouse/pull/77584) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена проверка существования пути к данным таблицы на локальном диске. [#77608](https://github.com/ClickHouse/ClickHouse/pull/77608) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Кэш запросов теперь предполагает, что UDF являются недетерминированными. Соответственно, результаты запросов с UDF больше не кэшируются. Ранее пользователи могли определять недетерминированные UDF, результаты которых по ошибке кэшировались (issue [#77553](https://github.com/ClickHouse/ClickHouse/issues/77553)). [#77633](https://github.com/ClickHouse/ClickHouse/pull/77633) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
* Исправлена передача константных значений на удалённые серверы для некоторых типов. [#77634](https://github.com/ClickHouse/ClickHouse/pull/77634) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена работа system.filesystem&#95;cache&#95;log, который функционировал только при включённом параметре `enable_filesystem_cache_log`. [#77650](https://github.com/ClickHouse/ClickHouse/pull/77650) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена логическая ошибка при вызове функции `defaultRoles()` внутри проекции. Продолжение к [#76627](https://github.com/ClickHouse/ClickHouse/issues/76627). [#77667](https://github.com/ClickHouse/ClickHouse/pull/77667) ([pufit](https://github.com/pufit)).
* Исправлена ошибка из-за просроченного контекста в StorageS3(Azure)Queue. [#77720](https://github.com/ClickHouse/ClickHouse/pull/77720) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Вторые аргументы типа `Nullable` для функции `arrayResize` теперь не допускаются. Ранее при использовании `Nullable` в качестве второго аргумента могли возникать самые разные проблемы — от ошибок до неверных результатов. (issue [#48398](https://github.com/ClickHouse/ClickHouse/issues/48398)). [#77724](https://github.com/ClickHouse/ClickHouse/pull/77724) ([Manish Gill](https://github.com/mgill25)).
* Скрытие учетных данных в движках таблиц RabbitMQ, Nats, Redis и AzureQueue. [#77755](https://github.com/ClickHouse/ClickHouse/pull/77755) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено неопределённое поведение при сравнении `NaN` в `ArgMin`/`ArgMax`. [#77756](https://github.com/ClickHouse/ClickHouse/pull/77756) ([Raúl Marín](https://github.com/Algunenano)).
* Регулярно проверять, были ли отменены слияния и мутации, даже в случаях, когда операция не приводит к записи каких-либо блоков. [#77766](https://github.com/ClickHouse/ClickHouse/pull/77766) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Откат изменений. [#77843](https://github.com/ClickHouse/ClickHouse/pull/77843) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлено возможное падение при возникновении ошибки `NOT_FOUND_COLUMN_IN_BLOCK`. [#77854](https://github.com/ClickHouse/ClickHouse/pull/77854) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлена ошибка, приводившая к падению в `StorageSystemObjectStorageQueueSettings` при заполнении данных. [#77878](https://github.com/ClickHouse/ClickHouse/pull/77878) ([Bharat Nallan](https://github.com/bharatnc)).
* Отключен нечеткий поиск по истории в SSH-сервере (так как он требует skim). [#78002](https://github.com/ClickHouse/ClickHouse/pull/78002) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, из‑за которой запрос векторного поиска по неиндексированному столбцу возвращал некорректные результаты, если в таблице имелся другой векторный столбец с настроенным индексом векторного сходства. (Issue [#77978](https://github.com/ClickHouse/ClickHouse/issues/77978)). [#78069](https://github.com/ClickHouse/ClickHouse/pull/78069) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Исправлено сообщение `The requested output format {} is binary... Do you want to output it anyway? [y/N]`. [#78095](https://github.com/ClickHouse/ClickHouse/pull/78095) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка при использовании `toStartOfInterval` с нулевым аргументом origin. [#78096](https://github.com/ClickHouse/ClickHouse/pull/78096) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Запрещено указывать пустой параметр запроса `session_id` в HTTP-интерфейсе. [#78098](https://github.com/ClickHouse/ClickHouse/pull/78098) ([Alexey Katsman](https://github.com/alexkats)).
* Исправлена проблема с переопределением метаданных в Database Replicated, которая могла возникнуть из‑за выполнения запроса RENAME сразу после ALTER. [#78107](https://github.com/ClickHouse/ClickHouse/pull/78107) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена ошибка, приводившая к сбою в движке NATS. [#78108](https://github.com/ClickHouse/ClickHouse/pull/78108) ([Dmitry Novikov](https://github.com/dmitry-sles-novikov)).
* Не пытайтесь создавать `history_file` во встроенном клиенте для SSH. [#78112](https://github.com/ClickHouse/ClickHouse/pull/78112) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено отображение некорректной информации в system.detached&#95;tables после выполнения запросов RENAME DATABASE или DROP TABLE. [#78126](https://github.com/ClickHouse/ClickHouse/pull/78126) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена проверка на слишком большое количество таблиц в Database Replicated после [https://github.com/ClickHouse/ClickHouse/pull/77274](https://github.com/ClickHouse/ClickHouse/pull/77274). Кроме того, проверка теперь выполняется до создания хранилища, чтобы избежать создания неучтённых узлов в ZooKeeper в случае RMT или KeeperMap. [#78127](https://github.com/ClickHouse/ClickHouse/pull/78127) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена возможная авария из-за одновременной инициализации метаданных S3Queue. [#78131](https://github.com/ClickHouse/ClickHouse/pull/78131) ([Azat Khuzhin](https://github.com/azat)).
* Функции `groupArray*` теперь генерируют ошибку BAD&#95;ARGUMENTS для значения 0 типа Int в аргументе max&#95;size, как это уже делается для типа UInt, вместо попытки выполнить запрос с таким значением. [#78140](https://github.com/ClickHouse/ClickHouse/pull/78140) ([Eduard Karacharov](https://github.com/korowa)).
* Предотвращён сбой в `recoverLostReplica`, если локальная таблица была удалена до её отсоединения. [#78173](https://github.com/ClickHouse/ClickHouse/pull/78173) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлен столбец &quot;alterable&quot; в system.s3&#95;queue&#95;settings, который всегда возвращал `false`. [#78187](https://github.com/ClickHouse/ClickHouse/pull/78187) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Маскировать подпись доступа Azure, чтобы она не отображалась пользователю и в логах. [#78189](https://github.com/ClickHouse/ClickHouse/pull/78189) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено предварительное чтение подстримов с префиксами в Wide-частях. [#78205](https://github.com/ClickHouse/ClickHouse/pull/78205) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлены ошибки, приводившие к сбоям и некорректным результатам `mapFromArrays` в случае, когда массив ключей имеет тип `LowCardinality(Nullable)`. [#78240](https://github.com/ClickHouse/ClickHouse/pull/78240) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлены параметры аутентификации Delta Kernel. [#78255](https://github.com/ClickHouse/ClickHouse/pull/78255) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Не планировать задачу RefreshMV, если у реплики параметр `disable_insertion_and_mutation` равен true. Поскольку задача представляет собой вставку, она завершится с ошибкой, если `disable_insertion_and_mutation` равно true. [#78277](https://github.com/ClickHouse/ClickHouse/pull/78277) ([Xu Jia](https://github.com/XuJia0210)).
* Проверка доступа к базовым таблицам для движка Merge. [#78339](https://github.com/ClickHouse/ClickHouse/pull/78339) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Модификатор FINAL мог теряться для таблиц с движком `Distributed`. [#78428](https://github.com/ClickHouse/ClickHouse/pull/78428) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* `Bitmapmin` возвращает uint32&#95;max, когда битовая карта пуста (`uint64_max при размере входного типа ≥ 8 бит`), что соответствует поведению пустого `roaring_bitmap` при вызове `minimum()`. [#78444](https://github.com/ClickHouse/ClickHouse/pull/78444) ([wxybear](https://github.com/wxybear)).
* Отменено изменение «Применить атрибут preserve&#95;most в некоторых местах кода», так как оно может приводить к сбоям. [#78449](https://github.com/ClickHouse/ClickHouse/pull/78449) ([Azat Khuzhin](https://github.com/azat)).
* Используйте столбцы вставки для вывода схемы INFILE. [#78490](https://github.com/ClickHouse/ClickHouse/pull/78490) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Отключена параллельная обработка запроса сразу после чтения секции `FROM`, когда включен `distributed_aggregation_memory_efficient`, поскольку это может приводить к логической ошибке. Закрывает [#76934](https://github.com/ClickHouse/ClickHouse/issues/76934). [#78500](https://github.com/ClickHouse/ClickHouse/pull/78500) ([flynn](https://github.com/ucasfl)).
* Теперь всегда устанавливается как минимум один поток для чтения на случай, если после применения настройки `max_streams_to_max_threads_ratio` оказывается, что запланированных потоков нет. [#78505](https://github.com/ClickHouse/ClickHouse/pull/78505) ([Eduard Karacharov](https://github.com/korowa)).
* В хранилище S3Queue исправлена логическая ошибка «Cannot unregister: table uuid is not registered». Закрывает [#78285](https://github.com/ClickHouse/ClickHouse/issues/78285). [#78541](https://github.com/ClickHouse/ClickHouse/pull/78541) ([Kseniia Sumarokova](https://github.com/kssenii)).
* ClickHouse теперь умеет определять свой cgroup v2 на системах, где одновременно включены cgroups v1 и v2. [#78566](https://github.com/ClickHouse/ClickHouse/pull/78566) ([Grigory Korolev](https://github.com/gkorolev)).
* Функции таблиц кластера ObjectStorage завершались с ошибкой при использовании настроек на уровне таблицы. [#78587](https://github.com/ClickHouse/ClickHouse/pull/78587) ([Daniil Ivanik](https://github.com/divanik)).
* Расширенные проверки транзакций не поддерживаются ReplicatedMergeTree при выполнении `INSERT`. [#78633](https://github.com/ClickHouse/ClickHouse/pull/78633) ([Azat Khuzhin](https://github.com/azat)).
* Применять настройки запроса при прикреплении. [#78637](https://github.com/ClickHouse/ClickHouse/pull/78637) ([Raúl Marín](https://github.com/Algunenano)).
* Исправляет падение при указании некорректного пути в `iceberg_metadata_file_path`. [#78688](https://github.com/ClickHouse/ClickHouse/pull/78688) ([alesapin](https://github.com/alesapin)).
* В движке таблиц DeltaLake с реализацией на delta-kernel исправлен случай, когда схема чтения отличается от схемы таблицы и при этом есть колонки партиционирования, что приводило к ошибке «column not found». [#78690](https://github.com/ClickHouse/ClickHouse/pull/78690) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Это обновление исправляет ошибку, из-за которой новый именованный сеанс по ошибке завершался в запланированное время предыдущего сеанса, если оба сеанса имели одно и то же имя, а новый был создан до истечения тайм-аута старого. [#78698](https://github.com/ClickHouse/ClickHouse/pull/78698) ([Alexey Katsman](https://github.com/alexkats)).
* Не блокировать остановку таблицы во время выполнения CHECK TABLE. [#78782](https://github.com/ClickHouse/ClickHouse/pull/78782) ([Raúl Marín](https://github.com/Algunenano)).
* Исправление Keeper: скорректировано значение счетчика эфемерных узлов во всех случаях. [#78799](https://github.com/ClickHouse/ClickHouse/pull/78799) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено некорректное приведение типов в `StorageDistributed` при использовании табличных функций, отличных от `view()`. Исправляет [#78464](https://github.com/ClickHouse/ClickHouse/issues/78464). [#78828](https://github.com/ClickHouse/ClickHouse/pull/78828) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлено форматирование для `tupleElement(*, 1)`. Закрывает [#78639](https://github.com/ClickHouse/ClickHouse/issues/78639). [#78832](https://github.com/ClickHouse/ClickHouse/pull/78832) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Словари типа `ssd_cache` теперь отклоняют нулевые и отрицательные значения параметров `block_size` и `write_buffer_size` (issue [#78314](https://github.com/ClickHouse/ClickHouse/issues/78314)). [#78854](https://github.com/ClickHouse/ClickHouse/pull/78854) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Исправлена ошибка падения REFRESHABLE MV при выполнении ALTER после некорректного завершения работы. [#78858](https://github.com/ClickHouse/ClickHouse/pull/78858) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен разбор некорректных значений `DateTime` в формате CSV. [#78919](https://github.com/ClickHouse/ClickHouse/pull/78919) ([Pavel Kruglov](https://github.com/Avogar)).





## Улучшения сборки, тестирования и упаковки {#build-testing-packaging-improvement}


* Внутренняя зависимость LLVM обновлена с версии 16 до версии 18. [#66053](https://github.com/ClickHouse/ClickHouse/pull/66053) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Восстановлены удалённые интеграционные тесты для nats и исправлены ошибки. - исправлены некоторые состояния гонки в движке nats - устранена потеря данных при потоковой передаче в nats в случае потери соединения - исправлено зависание при получении последнего блока данных при завершении потоковой передачи из nats - параметр nats&#95;max&#95;reconnect объявлен устаревшим и больше не оказывает влияния, переподключение выполняется постоянно с таймаутом nats&#95;reconnect&#95;wait. [#69772](https://github.com/ClickHouse/ClickHouse/pull/69772) ([Dmitry Novikov](https://github.com/dmitry-sles-novikov)).
* Исправлена проблема, из-за которой не удавалось сгенерировать asm-файлы OpenSSL в директории contrib. [#72622](https://github.com/ClickHouse/ClickHouse/pull/72622) ([RinChanNOW](https://github.com/RinChanNOWWW)).
* Обеспечена стабильность теста 03210&#95;variant&#95;with&#95;aggregate&#95;function&#95;type. [#74012](https://github.com/ClickHouse/ClickHouse/pull/74012) ([Anton Ivashkin](https://github.com/ianton-ru)).
* Добавлена поддержка сборки HDFS как на Mac с ARM, так и на Mac с Intel. [#74244](https://github.com/ClickHouse/ClickHouse/pull/74244) ([Yan Xin](https://github.com/yxheartipp)).
* Универсальный скрипт установки теперь предлагает установить систему даже на macOS. [#74339](https://github.com/ClickHouse/ClickHouse/pull/74339) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена сборка при отключённом Kerberos. [#74771](https://github.com/ClickHouse/ClickHouse/pull/74771) ([flynn](https://github.com/ucasfl)).
* Обновлено встроенное LLVM до версии 19. [#75148](https://github.com/ClickHouse/ClickHouse/pull/75148) ([Konstantин Bogdanов](https://github.com/thevar1able)).
* *Потенциально ломающие изменения*: улучшения с ещё более строгими значениями по умолчанию. Текущие значения по умолчанию уже безопасны: пользователь должен явно указать опцию, чтобы опубликовать порты. Но если у пользователя `default` не задан пароль через переменную окружения `CLICKHOUSE_PASSWORD` и/или имя пользователя не изменено через переменную окружения `CLICKHOUSE_USER`, к нему должен быть доступ только с локальной системы как дополнительный уровень защиты. [#75259](https://github.com/ClickHouse/ClickHouse/pull/75259) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Для интеграционных тестов установлен часовой тайм-аут на один пакет параллельно выполняющихся тестов. По достижении этого тайм-аута `pytest` принудительно завершается, и часть логов может не сохраниться. Внутренний тайм-аут pytest установлен на 55 минут, чтобы успеть вывести результаты сессии и не спровоцировать внешний сигнал тайм-аута. Закрывает [#75532](https://github.com/ClickHouse/ClickHouse/issues/75532). [#75533](https://github.com/ClickHouse/ClickHouse/pull/75533) ([Ilya Yatsishin](https://github.com/qoega)).
* Все действия, связанные с clickhouse-server, вынесены в отдельную функцию и теперь выполняются только при запуске стандартного бинарного файла в `entrypoint.sh`. Давно откладывавшееся улучшение было предложено в [#50724](https://github.com/ClickHouse/ClickHouse/issues/50724). Добавлен переключатель `--users` к `clickhouse-extract-from-config` для получения значений из `users.xml`. [#75643](https://github.com/ClickHouse/ClickHouse/pull/75643) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Для стресс‑тестов, если сервер не завершил работу во время сбора stacktrace через gdb, добавлено дополнительное время ожидания, чтобы сделать диагностику `Possible deadlock on shutdown (see gdb.log)` менее «шумной». Дополнительная задержка будет добавляться только в случаях, когда тест завершился неуспешно. [#75668](https://github.com/ClickHouse/ClickHouse/pull/75668) ([Ilya Yatsishin](https://github.com/qoega)).
* Восстановлены удалённые интеграционные тесты для nats и исправлены ошибки. - исправлены некоторые гонки в движке nats - исправлена потеря данных при потоковой передаче в nats в случае потери соединения - исправлено зависание при получении последнего блока данных после завершения потоковой передачи из nats - nats&#95;max&#95;reconnect объявлен устаревшим и больше не оказывает эффекта, переподключение теперь выполняется постоянно с таймаутом nats&#95;reconnect&#95;wait. [#75850](https://github.com/ClickHouse/ClickHouse/pull/75850) ([Dmitry Novikov](https://github.com/dmitry-sles-novikov)).
* Включена поддержка ICU и gRPC при кросс-компиляции для Darwin. [#75922](https://github.com/ClickHouse/ClickHouse/pull/75922) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено расщепление вывода теста из-за `sleep` во время завершения группы процессов. [#76090](https://github.com/ClickHouse/ClickHouse/pull/76090) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Не собирайте логи `docker-compose` по завершении работы, так как сценарий часто принудительно завершается. Вместо этого собирайте их в фоновом режиме. [#76140](https://github.com/ClickHouse/ClickHouse/pull/76140) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Тесты для хранилища Kafka разделены на несколько файлов. Исправляет [#69452](https://github.com/ClickHouse/ClickHouse/issues/69452). [#76208](https://github.com/ClickHouse/ClickHouse/pull/76208) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* `clickhouse-odbc-bridge` и `clickhouse-library-bridge` перенесены в отдельный репозиторий [https://github.com/ClickHouse/odbc-bridge/](https://github.com/ClickHouse/odbc-bridge/). [#76225](https://github.com/ClickHouse/ClickHouse/pull/76225) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Из бинарного файла удалено около 20 МБ «мёртвого» кода. [#76226](https://github.com/ClickHouse/ClickHouse/pull/76226) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Минимально требуемая версия CMake повышена до 3.25 из‑за появления `block()`. [#76316](https://github.com/ClickHouse/ClickHouse/pull/76316) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Обновлена библиотека fmt до версии 11.1.3. [#76547](https://github.com/ClickHouse/ClickHouse/pull/76547) ([Raúl Marín](https://github.com/Algunenano)).
* Обновлён `lz4` до версии `1.10.0`. [#76571](https://github.com/ClickHouse/ClickHouse/pull/76571) ([Konstantin Bogdanов](https://github.com/thevar1able)).
* Обновлён `curl` до версии `8.12.1`. [#76572](https://github.com/ClickHouse/ClickHouse/pull/76572) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Обновлена `libcpuid` до версии `0.7.1`. [#76573](https://github.com/ClickHouse/ClickHouse/pull/76573) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Использовать машиночитаемый формат для парсинга результатов pytest. [#76910](https://github.com/ClickHouse/ClickHouse/pull/76910) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Исправлена кросс-компиляция Rust и добавлена возможность полностью отключить Rust. [#76921](https://github.com/ClickHouse/ClickHouse/pull/76921) ([Raúl Marín](https://github.com/Algunenano)).
* Для сборки проекта требуется Clang 19. [#76945](https://github.com/ClickHouse/ClickHouse/pull/76945) ([Raúl Marín](https://github.com/Algunenano)).
* Тест выполняется более 10 секунд в последовательном режиме. Это слишком долго для быстрых тестов. [#76948](https://github.com/ClickHouse/ClickHouse/pull/76948) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Обновлена версия `sccache` до `0.10.0`. [#77580](https://github.com/ClickHouse/ClickHouse/pull/77580) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Учитывать целевые фичи CPU в Rust и включить LTO во всех крейтах. [#78590](https://github.com/ClickHouse/ClickHouse/pull/78590) ([Raúl Marín](https://github.com/Algunenano)).
* Обновлён `minizip-ng` до версии `4.0.9`. [#78917](https://github.com/ClickHouse/ClickHouse/pull/78917) ([Konstantин Богданов](https://github.com/thevar1able)).
