---
slug: /changelogs/25.4
title: 'Журнал изменений v25.4 для Cloud'
description: 'Журнал изменений быстрого релиза v25.4'
keywords: ['changelog', 'cloud']
sidebar_label: '25.4'
sidebar_position: 3
doc_type: 'changelog'
---



## Обратно несовместимые изменения {#backward-incompatible-changes}


* Формат вывода Parquet преобразует столбцы типов Date и DateTime в типы даты и времени, поддерживаемые Parquet, вместо записи их как сырых чисел. DateTime преобразуется в DateTime64(3) (ранее: UInt32); установка `output_format_parquet_datetime_as_uint32` возвращает прежнее поведение. Date преобразуется в Date32 (ранее: UInt16). [#70950](https://github.com/ClickHouse/ClickHouse/pull/70950) ([Michael Kolupaev](https://github.com/al13n321)).
* По умолчанию запретить использование сравнимых типов (например, JSON/Object/AggregateFunction) в ORDER BY и в функциях сравнения `less/greater/equal/etc`. [#73276](https://github.com/ClickHouse/ClickHouse/pull/73276) ([Pavel Kruglov](https://github.com/Avogar)).
* `JSONEachRowWithProgress` будет записывать прогресс каждый раз, когда он обновляется. В предыдущих версиях прогресс показывался только после каждого блока результата, что делало его бесполезным. Изменён способ отображения прогресса: нулевые значения не отображаются. Имейте в виду, что прогресс отправляется, даже если он обновляется часто. Это может генерировать значительный объём трафика. Имейте в виду, что при сжатии вывода прогресс не сбрасывается (не форсируется запись в поток). Закрывает [#70800](https://github.com/ClickHouse/ClickHouse/issues/70800). [#73834](https://github.com/ClickHouse/ClickHouse/pull/73834) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Источник словаря `mysql` больше не выполняет запрос `SHOW TABLE STATUS`, поскольку он не даёт никакой пользы для таблиц InnoDB, как и для любых современных версий MySQL. Это закрывает [#72636](https://github.com/ClickHouse/ClickHouse/issues/72636). Это изменение обратно совместимо, но помещено в эту категорию, чтобы у вас была возможность его заметить. [#73914](https://github.com/ClickHouse/ClickHouse/pull/73914) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Таблицы `Merge` будут унифицировать структуру базовых таблиц, используя объединение их столбцов и выводя общие типы. Это закрывает [#64864](https://github.com/ClickHouse/ClickHouse/issues/64864). Это закрывает [#35307](https://github.com/ClickHouse/ClickHouse/issues/35307). В некоторых случаях это изменение может быть несовместимо с предыдущими версиями. Один из примеров — когда между таблицами нет общего типа, но преобразование к типу первой таблицы по-прежнему возможно, как в случае с UInt64 и Int64 или любым числовым типом и String. Если вы хотите вернуться к старому поведению, установите `merge_table_max_tables_to_look_for_schema_inference` в `1` или задайте `compatibility` как `24.12` или более раннюю версию. [#73956](https://github.com/ClickHouse/ClickHouse/pull/73956) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Запросы `CHECK TABLE` теперь требуют отдельного привилегии `CHECK`. В предыдущих версиях для выполнения этих запросов было достаточно привилегии `SHOW TABLES`. Однако запрос `CHECK TABLE` может быть ресурсоёмким, и обычные ограничения сложности запросов для `SELECT` к нему не применяются. Это создавало потенциальную возможность для DoS-атаки. [#74471](https://github.com/ClickHouse/ClickHouse/pull/74471) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Проверьте, что все столбцы в материализованном представлении соответствуют целевой таблице, если `allow_materialized_view_with_bad_select` имеет значение `false`. [#74481](https://github.com/ClickHouse/ClickHouse/pull/74481) ([Christoph Wurm](https://github.com/cwurm)).
* Функция `h3ToGeo()` теперь возвращает результаты в порядке `(lat, lon)` (стандартный порядок для геометрических функций). Пользователи, которые хотят сохранить прежний порядок результатов `(lon, lat)`, могут установить настройку `h3togeo_lon_lat_result_order = true`. [#74719](https://github.com/ClickHouse/ClickHouse/pull/74719) ([Manish Gill](https://github.com/mgill25)).
* Добавлены форматы `JSONCompactEachRowWithProgress` и `JSONCompactStringsEachRowWithProgress`. Продолжение [#69989](https://github.com/ClickHouse/ClickHouse/issues/69989). Форматы `JSONCompactWithNames` и `JSONCompactWithNamesAndTypes` больше не выводят &quot;totals&quot; — по-видимому, это было ошибкой в реализации. [#75037](https://github.com/ClickHouse/ClickHouse/pull/75037) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Измените значение по умолчанию настройки `format_alter_operations_with_parentheses` на true, чтобы сделать список команд ALTER однозначным (см. [https://github.com/ClickHouse/ClickHouse/pull/59532](https://github.com/ClickHouse/ClickHouse/pull/59532)). Это нарушает репликацию с кластерами версий до 24.3. Если вы обновляете кластер со старых версий, отключите эту настройку в конфигурации сервера или сначала обновитесь до 24.3. [#75302](https://github.com/ClickHouse/ClickHouse/pull/75302) ([Raúl Marín](https://github.com/Algunenano)).
* Запрещён `TRUNCATE DATABASE` для реплицируемых баз данных. [#76651](https://github.com/ClickHouse/ClickHouse/pull/76651) ([Bharat Nallan](https://github.com/bharatnc)).
* Отключать parallel replicas по умолчанию, когда analyzer выключен, независимо от настройки `compatibility`. При необходимости это поведение можно изменить, явно установив `parallel_replicas_only_with_analyzer` в `false`. [#77115](https://github.com/ClickHouse/ClickHouse/pull/77115) ([Igor Nikonov](https://github.com/devcrafter)).
* Больше нельзя использовать `NaN` или `inf` как значения с плавающей запятой для настроек. [#77546](https://github.com/ClickHouse/ClickHouse/pull/77546) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправляет случаи использования `dateTrunc` с отрицательными аргументами типа date/datetime. [#77622](https://github.com/ClickHouse/ClickHouse/pull/77622) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Устаревшая интеграция с MongoDB была удалена. Настройка сервера `use_legacy_mongodb_integration` признана устаревшей и теперь ни на что не влияет. [#77895](https://github.com/ClickHouse/ClickHouse/pull/77895) ([Robert Schulze](https://github.com/rschu1ze)).
* Улучшена проверка SummingMergeTree, позволяющая пропускать агрегацию для столбцов, используемых в ключах партиционирования или сортировки. [#78022](https://github.com/ClickHouse/ClickHouse/pull/78022) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).





## Новые возможности {#new-features}


* Добавлен кэш в памяти для десериализованных гранул пропускающих индексов. Это должно ускорить повторяющиеся запросы, использующие пропускающие индексы. Размер нового кэша задаётся серверными настройками `skipping_index_cache_size` и `skipping_index_cache_max_entries`. Исходной мотивацией для добавления кэша были индексы векторного сходства, которые теперь работают значительно быстрее. [#70102](https://github.com/ClickHouse/ClickHouse/pull/70102) ([Robert Schulze](https://github.com/rschu1ze)).
* Новая реализация Userspace Page Cache, которая позволяет кэшировать данные в памяти процесса вместо использования кэша страниц ОС. Это полезно, когда данные хранятся в удалённой виртуальной файловой системе без локального файлового кэша. [#70509](https://github.com/ClickHouse/ClickHouse/pull/70509) ([Michael Kolupaev](https://github.com/al13n321)).
* Добавлена настройка для выполнения запросов к таблицам Iceberg на состояние на определённый момент времени. [#71072](https://github.com/ClickHouse/ClickHouse/pull/71072) ([Brett Hoerner](https://github.com/bretthoerner)).
* Реализована обрезка разделов (partition pruning) для таблиц Iceberg при операциях разбиения по времени (time-related transform partition operations) в Iceberg. [#72044](https://github.com/ClickHouse/ClickHouse/pull/72044) ([Daniil Ivanik](https://github.com/divanik)).
* Добавлена возможность по умолчанию создавать min-max (skipping) индексы для столбцов в таблицах MergeTree с помощью настроек `enable_minmax_index_for_all_numeric_columns` (для числовых столбцов) и `enable_minmax_index_for_all_string_columns` (для строковых столбцов). Пока обе настройки отключены, поэтому поведение ещё не изменилось. [#72090](https://github.com/ClickHouse/ClickHouse/pull/72090) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Добавлена агрегатная функция sequenceMatchEvents, которая возвращает временные метки событий для самой длинной последовательности, соответствующей шаблону. [#72349](https://github.com/ClickHouse/ClickHouse/pull/72349) ([UnamedRus](https://github.com/UnamedRus)).
* Операторы `SELECT` и `VIEW` теперь поддерживают псевдонимы, например `SELECT b FROM (SELECT number, number*2 FROM numbers(2)) AS x (a, b);`. Это позволяет выполнять запрос TPC-H 15 без изменений. [#72480](https://github.com/ClickHouse/ClickHouse/pull/72480) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена новая настройка `enable_adaptive_memory_spill_scheduler`, которая позволяет нескольким операций grace JOIN в одном запросе отслеживать их суммарное потребление памяти и адаптивно инициировать сброс данных во внешнее хранилище, чтобы предотвратить MEMORY&#95;LIMIT&#95;EXCEEDED. [#72728](https://github.com/ClickHouse/ClickHouse/pull/72728) ([lgbo](https://github.com/lgbo-ustc)).
* Добавлена функция `arrayNormalizedGini`. [#72823](https://github.com/ClickHouse/ClickHouse/pull/72823) ([flynn](https://github.com/ucasfl)).
* Реализована поддержка десятичных типов данных с низкой кардинальностью, исправлена [#72256](https://github.com/ClickHouse/ClickHouse/issues/72256). [#72833](https://github.com/ClickHouse/ClickHouse/pull/72833) ([zhanglistar](https://github.com/zhanglistar)).
* Когда одновременно включены `min_age_to_force_merge_seconds` и `min_age_to_force_merge_on_partition_only`, при слиянии кусков будет игнорироваться ограничение на максимальный размер в байтах. [#73656](https://github.com/ClickHouse/ClickHouse/pull/73656) ([Kai Zhu](https://github.com/nauu)).
* Добавлена поддержка чтения значений HALF&#95;FLOAT из Apache Arrow/Parquet/ORC (они читаются в Float32). Это закрывает [#72960](https://github.com/ClickHouse/ClickHouse/issues/72960). Имейте в виду, что формат half float IEEE-754 — это не то же самое, что BFloat16. Закрывает [#73835](https://github.com/ClickHouse/ClickHouse/issues/73835). [#73836](https://github.com/ClickHouse/ClickHouse/pull/73836) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Таблица `system.trace_log` будет содержать два новых столбца — `symbols` и `lines` — с символизированным стек-трейсом. Это позволяет легко собирать и экспортировать информацию профилирования. Поведение определяется конфигурационным параметром сервера `symbolize` в секции `trace_log` и по умолчанию включено. [#73896](https://github.com/ClickHouse/ClickHouse/pull/73896) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена новая функция `generateSerialID`, которую можно использовать для генерации автоинкрементных чисел в таблицах. Продолжение [#64310](https://github.com/ClickHouse/ClickHouse/issues/64310) от [kazalika](https://github.com/kazalika). Закрывает [#62485](https://github.com/ClickHouse/ClickHouse/issues/62485). [#73950](https://github.com/ClickHouse/ClickHouse/pull/73950) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен синтаксис `query1 PARALLEL WITH query2 PARALLEL WITH query3 ... PARALLEL WITH queryN`. Это означает, что подзапросы `{query1, query2, ... queryN}` могут (и желательно, чтобы так было) выполняться параллельно друг с другом. [#73983](https://github.com/ClickHouse/ClickHouse/pull/73983) ([Vitaly Baranov](https://github.com/vitlibar)).
* Теперь в Play UI есть индикатор прогресса во время выполнения запроса. Он позволяет отменять запросы, отображает общее количество записей и расширенную информацию о скорости. Таблица может отображаться по мере поступления данных. Включено HTTP‑сжатие. Отрисовка таблицы стала быстрее. Заголовок таблицы стал фиксированным (sticky). Добавлена возможность выделения ячеек и навигации по ним с помощью клавиш со стрелками. Исправлена проблема, при которой контур выделенной ячейки делал её меньше. Ячейки больше не расширяются при наведении курсора, а только при выборе. Момент остановки отрисовки входящих данных теперь определяется на стороне клиента, а не сервера. Добавлена подсветка разрядных групп в числах. Общий дизайн был обновлён и стал более выразительным. Выполняется проверка доступности сервера и корректности учётных данных, а также отображаются версия сервера и время его работы (uptime). Значок облака теперь контурный во всех шрифтах, даже в Safari. Большие целые числа во вложенных типах данных будут отображаться лучше. Значения inf/nan будут отображаться корректно. Типы данных будут показываться при наведении курсора на заголовок столбца. [#74204](https://github.com/ClickHouse/ClickHouse/pull/74204) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность по умолчанию создавать min-max (skipping) индексы для столбцов, управляемых MergeTree, с помощью настроек `add_minmax_index_for_numeric_columns` (для числовых столбцов) и `add_minmax_index_for_string_columns` (для строковых столбцов). Пока обе настройки отключены, поэтому поведение ещё не изменилось. [#74266](https://github.com/ClickHouse/ClickHouse/pull/74266) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Добавлены поля `script_query_number` и `script_line_number` в `system.query_log`, в ClientInfo в нативном протоколе и в серверные логи. Это закрывает [#67542](https://github.com/ClickHouse/ClickHouse/issues/67542). Благодарность [pinsvin00](https://github.com/pinsvin00) за то, что он ранее инициировал разработку этой функциональности в [#68133](https://github.com/ClickHouse/ClickHouse/issues/68133). [#74477](https://github.com/ClickHouse/ClickHouse/pull/74477) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка оператора вычитания для `DateTime64`, что позволяет выполнять вычитание между значениями `DateTime64`, а также `DateTime`. [#74482](https://github.com/ClickHouse/ClickHouse/pull/74482) ([Li Yin](https://github.com/liyinsg)).
* Добавлена поддержка движка таблиц DeltaLake для AzureBlobStorage. Исправление [#68043](https://github.com/ClickHouse/ClickHouse/issues/68043). [#74541](https://github.com/ClickHouse/ClickHouse/pull/74541) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Добавлена настройка bind&#95;host для задания исходного IP-адреса для подключений клиента clickhouse. [#74741](https://github.com/ClickHouse/ClickHouse/pull/74741) ([Todd Yocum](https://github.com/toddyocum)).
* Добавлена возможность применять незавершённые (ещё не материализованные фоновым процессом) мутации при выполнении запросов `SELECT` сразу после их отправки. Это можно включить с помощью настройки `apply_mutations_on_fly`. [#74877](https://github.com/ClickHouse/ClickHouse/pull/74877) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены некоторые ранее неожиданные случаи, когда аргументы типа дата/время функции `toStartOfInterval` были отрицательными. Для этого реализована новая функция toStartOfIntervalAllowNegative, которая делает практически то же самое, но возвращает только Date32/DateTime64. [#74933](https://github.com/ClickHouse/ClickHouse/pull/74933) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена новая функция initialQueryStartTime. Она возвращает время начала выполнения текущего запроса. Значение одинаково на всех шардах при выполнении распределённого запроса. [#75087](https://github.com/ClickHouse/ClickHouse/pull/75087) ([Roman Lomonosov](https://github.com/lomik)).
* Добавлен столбец `parametrized_view_parameters` в `system.tables`. Закрывает [https://github.com/clickhouse/clickhouse/issues/66756](https://github.com/clickhouse/clickhouse/issues/66756). [#75112](https://github.com/ClickHouse/ClickHouse/pull/75112) ([NamNguyenHoai](https://github.com/NamHoaiNguyen)).
* Разрешено изменять комментарий базы данных. Закрывает [#73351](https://github.com/ClickHouse/ClickHouse/issues/73351) ### Запись в документации об изменениях, видимых пользователям. [#75622](https://github.com/ClickHouse/ClickHouse/pull/75622) ([NamNguyenHoai](https://github.com/NamHoaiNguyen)).
* Добавлена возможность выполнять ATTACH таблиц без слоя базы данных (избегает хака с UUID). [#75788](https://github.com/ClickHouse/ClickHouse/pull/75788) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена серверная настройка `concurrent_threads_scheduler`, которая определяет, как слоты CPU распределяются между одновременно выполняющимися запросами. Может быть установлена в значение `round_robin` (предыдущее поведение) или `fair_round_robin`, чтобы устранить проблему несправедливого распределения CPU между INSERT и SELECT. [#75949](https://github.com/ClickHouse/ClickHouse/pull/75949) ([Sergei Trifonov](https://github.com/serxa)).
* Восстановлен кодек QPL, удалённый в v24.10 из-за лицензионных ограничений. [#76021](https://github.com/ClickHouse/ClickHouse/pull/76021) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Добавлена функция `arraySymmetricDifference`. Она возвращает все элементы из нескольких аргументов-массивов, которые не присутствуют одновременно во всех аргументах. Пример: `SELECT arraySymmetricDifference([1, 2], [2, 3])` возвращает `[1, 3]`. (issue [#61673](https://github.com/ClickHouse/ClickHouse/issues/61673)). [#76231](https://github.com/ClickHouse/ClickHouse/pull/76231) ([Filipp Abapolov](https://github.com/pheepa)).
* Добавлена агрегатная функция `estimatecompressionratio` — см. [#70801](https://github.com/ClickHouse/ClickHouse/issues/70801). [#76661](https://github.com/ClickHouse/ClickHouse/pull/76661) ([Tariq Almawash](https://github.com/talmawash)).
* Профильные события `FilterTransformPassedRows` и `FilterTransformPassedBytes` покажут количество строк и байт, отфильтрованных во время выполнения запроса. [#76662](https://github.com/ClickHouse/ClickHouse/pull/76662) ([Onkar Deshpande](https://github.com/onkar)).
* Добавлена хеш-функция keccak256, широко используемая в реализациях блокчейна, особенно в системах на базе EVM. [#76669](https://github.com/ClickHouse/ClickHouse/pull/76669) ([Arnaud Briche](https://github.com/arnaudbriche)).
* Scram SHA256 и обновление аутентификации по протоколу PostgreSQL wire. [#76839](https://github.com/ClickHouse/ClickHouse/pull/76839) ([scanhex12](https://github.com/scanhex12)).
* Эта функциональность добавляет возможность задать список заголовков, которые передаются из заголовков клиентского запроса во внешний HTTP-аутентификатор. [#77054](https://github.com/ClickHouse/ClickHouse/pull/77054) ([inv2004](https://github.com/inv2004)).
* Добавлена поддержка `IcebergMetadataFilesCache`, который хранит manifest-файлы/списки и metadata.json в одном кэше. [#77156](https://github.com/ClickHouse/ClickHouse/pull/77156) ([Han Fei](https://github.com/hanfei1991)).
* Добавлены функции `arrayLevenshteinDistance`, `arrayLevenshteinDistanceWeighted` и `arraySimilarity`. [#77187](https://github.com/ClickHouse/ClickHouse/pull/77187) ([Mikhail F. Shiryaev](https://github.com/Felixoid)).
* Добавлены три новые функции: `icebergTruncate` в соответствии со спецификацией [https://iceberg.apache.org/spec/#truncate-transform-details](https://iceberg.apache.org/spec/#truncate-transform-details), `toYearNumSinceEpoch` и `toMonthNumSinceEpoch`. Добавлена поддержка преобразования `truncate` при отсечении партиций для движка `Iceberg`. [#77403](https://github.com/ClickHouse/ClickHouse/pull/77403) ([alesapin](https://github.com/alesapin)).
* Позволяет пользователю выполнять запрос к состоянию таблицы Iceberg в том виде, в каком она существовала в предыдущий момент времени. [#77439](https://github.com/ClickHouse/ClickHouse/pull/77439) ([Daniil Ivanik](https://github.com/divanik)).
* Добавлено планирование CPU-слотов для рабочих нагрузок, подробности см. в [https://clickhouse.com/docs/operations/workload-scheduling#cpu&#95;scheduling](https://clickhouse.com/docs/operations/workload-scheduling#cpu_scheduling). [#77595](https://github.com/ClickHouse/ClickHouse/pull/77595) ([Sergei Trifonov](https://github.com/serxa)).
* Функция `hasAll()` теперь может использовать полнотекстовые индексы пропуска tokenbf&#95;v1 и ngrambf&#95;v1. [#77662](https://github.com/ClickHouse/ClickHouse/pull/77662) ([UnamedRus](https://github.com/UnamedRus)).
* Тип данных `JSON` готов к использованию в продакшене. См. [https://jsonbench.com/](https://jsonbench.com/). Типы данных `Dynamic` и `Varaint` также готовы к использованию в продакшене. [#77785](https://github.com/ClickHouse/ClickHouse/pull/77785) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен кэш в памяти для десериализованных индексов векторного сходства. Это должно ускорить повторяющиеся запросы приблизительного поиска ближайших соседей (ANN). Размер нового кэша определяется серверными настройками `vector_similarity_index_cache_size` и `vector_similarity_index_cache_max_entries`. Эта функция заменяет механизм кэширования пропускающих индексов из более ранних релизов. [#77905](https://github.com/ClickHouse/ClickHouse/pull/77905) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Добавлены функции sparseGrams и sparseGramsHashes, а также их версии для UTF-8. Автор: [scanhex12](https://github.com/scanhex12). [#78176](https://github.com/ClickHouse/ClickHouse/pull/78176) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Добавлена функция `toInterval`. Она принимает два аргумента (значение и единицу измерения) и преобразует значение в конкретный тип `Interval`. [#78723](https://github.com/ClickHouse/ClickHouse/pull/78723) ([Andrew Davis](https://github.com/pulpdrew)).





## Экспериментальные функции {#experimental-features}

- Добавлена возможность автоматической очистки при слиянии целых партиций по истечении настраиваемого таймаута с помощью новой настройки `enable_replacing_merge_with_cleanup_for_min_age_to_force_merge`. [#76440](https://github.com/ClickHouse/ClickHouse/pull/76440) ([Christoph Wurm](https://github.com/cwurm)).
- Добавлена поддержка [Unity Catalog](https://www.databricks.com/product/unity-catalog) для таблиц DeltaLake на базе AWS S3 и локальной файловой системы. [#76988](https://github.com/ClickHouse/ClickHouse/pull/76988) ([alesapin](https://github.com/alesapin)).
- Добавлена экспериментальная интеграция с каталогом сервиса AWS Glue для таблиц Iceberg. [#77257](https://github.com/ClickHouse/ClickHouse/pull/77257) ([alesapin](https://github.com/alesapin)).


## Улучшения производительности {#performance-improvements}


* Оптимизируйте производительность с помощью ленивых проекций, чтобы избежать чтения неиспользуемых столбцов. [#55518](https://github.com/ClickHouse/ClickHouse/pull/55518) ([Xiaozhe Yu](https://github.com/wudidapaopao)).
* Сравнение строк теперь начинается с столбцов, которые с наибольшей вероятностью отличаются. [#63780](https://github.com/ClickHouse/ClickHouse/pull/63780) ([UnamedRus](https://github.com/UnamedRus)).
* Оптимизирован формат ввода RowBinary. Исправляет [#63805](https://github.com/ClickHouse/ClickHouse/issues/63805). [#65059](https://github.com/ClickHouse/ClickHouse/pull/65059) ([Pavel Kruglov](https://github.com/Avogar)).
* Ускорена десериализация строк за счёт некоторых низкоуровневых оптимизаций. [#65948](https://github.com/ClickHouse/ClickHouse/pull/65948) ([Nikita Taranov](https://github.com/nickitat)).
* Атрибут `preserve_most` применён в некоторых местах кода. [#67778](https://github.com/ClickHouse/ClickHouse/pull/67778) ([Nikita Taranov](https://github.com/nickitat)).
* Реализован кэш условий запроса для повышения производительности запросов с повторяющимися условиями. Диапазон части данных, не удовлетворяющих условию, запоминается как временный индекс в памяти. Последующие запросы будут использовать этот индекс. close [#67768](https://github.com/ClickHouse/ClickHouse/issues/67768) ### Запись в документации для изменений, заметных пользователям. [#69236](https://github.com/ClickHouse/ClickHouse/pull/69236) ([zhongyuankai](https://github.com/zhongyuankai)).
* Реализована поддержка асинхронного предварительного чтения (prefetch) ввода-вывода для `NativeORCBlockInputFormat`, что повышает общую производительность за счёт сокрытия задержек удалённого ввода-вывода. В моём тестовом примере ускорение достигало 1,47 раза. [#70534](https://github.com/ClickHouse/ClickHouse/pull/70534) ([李扬](https://github.com/taiyang-li)).
* Улучшена производительность grace hash join за счёт повторного перераспределения правой таблицы соединения по ключам. [#72237](https://github.com/ClickHouse/ClickHouse/pull/72237) ([kevinyhzou](https://github.com/KevinyhZou)).
* Повторно добавлено уважение к настройке `ttl_only_drop_parts` в `materialize ttl`; читаются только необходимые столбцы для пересчёта TTL, а части удаляются путём замены их на пустые. [#72751](https://github.com/ClickHouse/ClickHouse/pull/72751) ([Andrey Zvonov](https://github.com/zvonand)).
* Разрешить `arrayROCAUC` и `arrayAUCPR` вычислять частичную площадь под всей кривой, чтобы их расчёт можно было распараллелить на огромных наборах данных. [#72904](https://github.com/ClickHouse/ClickHouse/pull/72904) ([Emmanuel](https://github.com/emmanuelsdias)).
* Избегайте создания слишком большого числа простаивающих потоков. [#72920](https://github.com/ClickHouse/ClickHouse/pull/72920) ([Guo Wangyang](https://github.com/guowangy)).
* Разбиение блоков левой таблицы по хэшу было исключено из фазы probe алгоритма JOIN `parallel_hash`. [#73089](https://github.com/ClickHouse/ClickHouse/pull/73089) ([Nikita Taranov](https://github.com/nickitat)).
* Не перечислять ключи blob-хранилища, если в табличной функции используется только расширение через фигурные скобки. Закрывает [#73333](https://github.com/ClickHouse/ClickHouse/issues/73333). [#73518](https://github.com/ClickHouse/ClickHouse/pull/73518) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Заменили Int256 и UInt256 на встроенный тип clang i256 в арифметических вычислениях в соответствии с тестами в [#70502](https://github.com/ClickHouse/ClickHouse/issues/70502). [#73658](https://github.com/ClickHouse/ClickHouse/pull/73658) ([李扬](https://github.com/taiyang-li)).
* Добавлен быстрый путь для функций, у которых все типы аргументов числовые. Исправлены проблемы с производительностью в [https://github.com/ClickHouse/ClickHouse/pull/72258](https://github.com/ClickHouse/ClickHouse/pull/72258). [#73820](https://github.com/ClickHouse/ClickHouse/pull/73820) ([李扬](https://github.com/taiyang-li)).
* Не применять `maskedExecute` к нефункциональным столбцам, улучшена производительность вычислений с коротким замыканием. [#73965](https://github.com/ClickHouse/ClickHouse/pull/73965) ([lgbo](https://github.com/lgbo-ustc)).
* Отключено распознавание заголовков для Kafka/NATS/RabbitMQ/FileLog для повышения производительности. [#74006](https://github.com/ClickHouse/ClickHouse/pull/74006) ([Azat Khuzhin](https://github.com/azat)).
* Используйте обёртки для логов по значению и не размещайте их в куче. [#74034](https://github.com/ClickHouse/ClickHouse/pull/74034) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Выполнение конвейера с более высокой степенью параллелизма после агрегации с `GROUPING SETS`. [#74082](https://github.com/ClickHouse/ClickHouse/pull/74082) ([Nikita Taranov](https://github.com/nickitat)).
* Сокращён размер критической секции в `MergeTreeReadPool`. [#74202](https://github.com/ClickHouse/ClickHouse/pull/74202) ([Guo Wangyang](https://github.com/guowangy)).
* Оптимизирована функция `indexHint`. Теперь столбцы, которые используются только в качестве аргументов функции `indexHint`, не читаются из таблицы. [#74314](https://github.com/ClickHouse/ClickHouse/pull/74314) ([Anton Popov](https://github.com/CurtizJ)).
* Улучшена производительность параллельных реплик. Десериализация пакетов на инициаторе запроса для пакетов, не относящихся к протоколу параллельных реплик, теперь всегда выполняется в потоке конвейера. Ранее она могла выполняться в потоке, отвечающем за планирование конвейера, что снижало отзывчивость инициатора и задерживало выполнение конвейера. [#74398](https://github.com/ClickHouse/ClickHouse/pull/74398) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлен расчёт размера в памяти для столбцов `LowCardinality`. [#74688](https://github.com/ClickHouse/ClickHouse/pull/74688) ([Nikita Taranov](https://github.com/nickitat)).
* Улучшена производительность чтения целого JSON-столбца в Wide-частях из S3. Это достигнуто за счёт добавления предварительной выборки для десериализации префиксов подстолбцов, кеширования десериализованных префиксов и параллельной десериализации префиксов подстолбцов. Это ускоряет чтение JSON-столбца из S3 в 4 раза в запросах вида `SELECT data FROM table` и примерно в 10 раз в запросах вида `SELECT data FROM table LIMIT 10`. [#74827](https://github.com/ClickHouse/ClickHouse/pull/74827) ([Pavel Kruglov](https://github.com/Avogar)).
* Предварительное выделение памяти для асинхронных вставок с целью улучшения производительности. [#74945](https://github.com/ClickHouse/ClickHouse/pull/74945) ([Ilya Golshtein](https://github.com/ilejn)).
* Исправлено двойное предварительное выделение памяти в `ConcurrentHashJoin` в случае, когда оптимизатор меняет стороны `JOIN` местами. [#75149](https://github.com/ClickHouse/ClickHouse/pull/75149) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлено избыточное соревнование потоков в `parallel_hash`, возникавшее при `max_rows_in_join = max_bytes_in_join = 0`. [#75155](https://github.com/ClickHouse/ClickHouse/pull/75155) ([Nikita Taranov](https://github.com/nickitat)).
* Незначительное улучшение в некоторых сценариях `JOIN`: предварительный подсчёт количества выходных строк и резервирование памяти под них. [#75376](https://github.com/ClickHouse/ClickHouse/pull/75376) ([Alexander Gololobov](https://github.com/davenger)).
* Файлы метаданных `plain_rewritable` небольшие и не требуют большого буфера по умолчанию. Используйте буфер записи подходящего размера, соответствующий заданному пути, что улучшает использование памяти при большом количестве активных частей. ### Запись в документации об изменениях, заметных пользователям. [#75758](https://github.com/ClickHouse/ClickHouse/pull/75758) ([Julia Kartseva](https://github.com/jkartseva)).
* В некоторых случаях (например, столбец с пустым массивом) части данных могут содержать пустые файлы. Мы можем не записывать пустые блобы в ObjectStorage и сохранять только метаданные для таких файлов, когда таблица размещена на диске с раздельными хранилищами метаданных и объектов. [#75860](https://github.com/ClickHouse/ClickHouse/pull/75860) ([Alexander Gololobov](https://github.com/davenger)).
* Было обнаружено, что управление параллелизмом может приводить к несправедливому распределению ресурсов CPU между INSERT и SELECT. Когда все слоты CPU безусловно (без конкуренции) выделяются под INSERT с `max_threads` = 1, запросы SELECT с высоким значением `max_threads` страдают от низкой производительности, так как используют только один поток. [#75941](https://github.com/ClickHouse/ClickHouse/pull/75941) ([Sergei Trifonov](https://github.com/serxa)).
* Незначительная оптимизация в `wrapInNullable` для избежания лишнего выделения `null map`. [#76489](https://github.com/ClickHouse/ClickHouse/pull/76489) ([李扬](https://github.com/taiyang-li)).
* Улучшена производительность min/max для Decimal32/Decimal64/DateTime64. [#76570](https://github.com/ClickHouse/ClickHouse/pull/76570) ([李扬](https://github.com/taiyang-li)).
* Активно удалять данные из кеша при удалении кусков. Не позволять кешу расти до максимального размера, если объем данных меньше. [#76641](https://github.com/ClickHouse/ClickHouse/pull/76641) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Компиляция запросов (настройка `compile_expressions`) теперь учитывает тип машины. Это значительно ускоряет выполнение таких запросов. [#76753](https://github.com/ClickHouse/ClickHouse/pull/76753) ([Robert Schulze](https://github.com/rschu1ze)).
* Оптимизирован arraySort. [#76850](https://github.com/ClickHouse/ClickHouse/pull/76850) ([李扬](https://github.com/taiyang-li)).
* Ускорена сборка результата `JOIN` за счёт девиртуализации вызовов `col->insertFrom()`. [#77350](https://github.com/ClickHouse/ClickHouse/pull/77350) ([Alexander Gololobov](https://github.com/davenger)).
* Объединены метки одной части и выполняется их единоразовая запись в кэш условий запроса, чтобы снизить затраты на блокировки. [#77377](https://github.com/ClickHouse/ClickHouse/pull/77377) ([zhongyuankai](https://github.com/zhongyuankai)).
* Оптимизирован `ORDER BY` по одиночным nullable- или low-cardinality-столбцам. [#77789](https://github.com/ClickHouse/ClickHouse/pull/77789) ([李扬](https://github.com/taiyang-li)).
* Отключайте `filesystem_cache_prefer_bigger_buffer_size`, когда кэш используется пассивно, например при слияниях. [#77898](https://github.com/ClickHouse/ClickHouse/pull/77898) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Реализована тривиальная оптимизация подсчёта для Iceberg. Теперь запросы с `count()` и без каких-либо фильтров должны выполняться быстрее. Закрывает [#77639](https://github.com/ClickHouse/ClickHouse/issues/77639). [#78090](https://github.com/ClickHouse/ClickHouse/pull/78090) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка отсечения данных (data pruning) для Iceberg на основе значений `lower_bound` и `upper_bound` для столбцов. Исправляет [#77638](https://github.com/ClickHouse/ClickHouse/issues/77638). [#78242](https://github.com/ClickHouse/ClickHouse/pull/78242) ([alesapin](https://github.com/alesapin)).
* Оптимизировано использование памяти в NativeReader. [#78442](https://github.com/ClickHouse/ClickHouse/pull/78442) ([Azat Khuzhin](https://github.com/azat)).
* Тривиальная оптимизация: не переписывать `count(if())` в `countIf`, если требуется `CAST`. Закрывает [#78564](https://github.com/ClickHouse/ClickHouse/issues/78564). [#78565](https://github.com/ClickHouse/ClickHouse/pull/78565) ([李扬](https://github.com/taiyang-li)).





## Улучшения {#improvements}


* Снижено количество запросов к Keeper за счёт отказа от одиночных запросов `get` в тех местах, где доступен `multiRead`, так как при увеличении числа реплик они могли создавать значительную нагрузку на Keeper. [#56862](https://github.com/ClickHouse/ClickHouse/pull/56862) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена поддержка SSL-аутентификации с именованными наборами настроек для MySQL. Закрывает [#59111](https://github.com/ClickHouse/ClickHouse/issues/59111). [#59452](https://github.com/ClickHouse/ClickHouse/pull/59452) ([Nikolay Degterinsky](https://github.com/evillique)).
* Улучшена производительность новой инфраструктуры анализатора за счёт хранения `ColumnPtr` вместо `Field` в `ConstantNode`. Связано с [#62245](https://github.com/ClickHouse/ClickHouse/issues/62245). [#63198](https://github.com/ClickHouse/ClickHouse/pull/63198) ([Dmitry Novik](https://github.com/novikd)).
* Отклонять запросы, когда сервер перегружен. Решение принимается на основе отношения времени ожидания (`OSCPUWaitMicroseconds`) к времени работы (`OSCPUVirtualTimeMicroseconds`). Запрос с некоторой вероятностью отбрасывается, когда это отношение находится в диапазоне между `min_os_cpu_wait_time_ratio_to_throw` и `max_os_cpu_wait_time_ratio_to_throw` (это настройки на уровне запроса). [#63206](https://github.com/ClickHouse/ClickHouse/pull/63206) ([Alexey Katsman](https://github.com/alexkats)).
* Освобождение блоков на более раннем этапе для снижения потребления памяти. [#65647](https://github.com/ClickHouse/ClickHouse/pull/65647) ([lgbo](https://github.com/lgbo-ustc)).
* Таблица `processors_profile_log` теперь по умолчанию настроена с TTL 30 дней. [#66139](https://github.com/ClickHouse/ClickHouse/pull/66139) ([Ilya Yatsishin](https://github.com/qoega)).
* Разрешено создавать индекс `bloom_filter` на столбцах с типом данных DateTime64. [#66416](https://github.com/ClickHouse/ClickHouse/pull/66416) ([Yutong Xiao](https://github.com/YutSean)).
* Добавить интервалы задержек и использовать их для отслеживания времени до чтения/записи первого байта и времени установления соединения для запросов к S3. Таким образом, в дальнейшем мы сможем использовать собранные данные для вычисления приблизительных перцентилей и настройки таймаутов. [#69783](https://github.com/ClickHouse/ClickHouse/pull/69783) ([Alexey Katsman](https://github.com/alexkats)).
* Запросы, передаваемые в хранилище `Executable`, больше не ограничены выполнением в одном потоке. [#70084](https://github.com/ClickHouse/ClickHouse/pull/70084) ([yawnt](https://github.com/yawnt)).
* В таблицу журналов спанов OpenTelemetry добавлены HTTP-заголовки для улучшения трассировки. [#70516](https://github.com/ClickHouse/ClickHouse/pull/70516) ([jonymohajanGmail](https://github.com/jonymohajanGmail)).
* Добавлена поддержка записи файлов ORC с использованием произвольного часового пояса, а не только часового пояса `GMT`. [#70615](https://github.com/ClickHouse/ClickHouse/pull/70615) ([kevinyhzou](https://github.com/KevinyhZou)).
* Заменены табличные функции на их варианты `-Cluster`, если включены параллельные реплики. Исправляет [#65024](https://github.com/ClickHouse/ClickHouse/issues/65024). [#70659](https://github.com/ClickHouse/ClickHouse/pull/70659) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Учитывать настройки планирования ввода-вывода при записи резервных копий между облаками. [#71093](https://github.com/ClickHouse/ClickHouse/pull/71093) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Повторно устанавливать соединение с репликами словарей MySQL и Postgres в фоновом режиме, чтобы это не задерживало обработку запросов к соответствующим словарям. [#71101](https://github.com/ClickHouse/ClickHouse/pull/71101) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Добавлено имя алиаса метрики в `system.asynchronous_metrics`. [#71164](https://github.com/ClickHouse/ClickHouse/pull/71164) ([megao](https://github.com/jetgm)).
* Обновления перезагружаемых материализованных представлений теперь отображаются в `system.query_log`. [#71333](https://github.com/ClickHouse/ClickHouse/pull/71333) ([Michael Kolupaev](https://github.com/al13n321)).
* Оценивать bloom-фильтры и min/max-индексы Parquet совместно. Это необходимо для корректной поддержки выражения `x = 3 or x > 5` при data = [1, 2, 4, 5]. [#71383](https://github.com/ClickHouse/ClickHouse/pull/71383) ([Arthur Passos](https://github.com/arthurpassos)).
* Улучшения интерактивных метрик. Исправлена проблема, из-за которой метрики от параллельных реплик отображались не полностью. Метрики отображаются в порядке их последнего обновления, затем лексикографически по имени. Устаревшие метрики не отображаются. [#71631](https://github.com/ClickHouse/ClickHouse/pull/71631) ([Julia Kartseva](https://github.com/jkartseva)).
* Исторически по какой-то причине запрос `ALTER TABLE MOVE PARTITION TO TABLE` проверял права `SELECT` и `ALTER DELETE` вместо отдельного права `ALTER_MOVE_PARTITION`. В этом PR начинает использоваться именно этот тип доступа. Для совместимости это право также будет неявно предоставляться, если выданы `SELECT` и `ALTER DELETE`, но это поведение будет удалено в будущих релизах. Закрывает [#16403](https://github.com/ClickHouse/ClickHouse/issues/16403). [#71632](https://github.com/ClickHouse/ClickHouse/pull/71632) ([pufit](https://github.com/pufit)).
* Позволяет включить `use_hive_partitioning` по умолчанию. [#71636](https://github.com/ClickHouse/ClickHouse/pull/71636) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Выбрасывать исключение при попытке материализовать столбец в ключе сортировки вместо того, чтобы допускать нарушение порядка сортировки. Тем не менее, это не решает [#71777](https://github.com/ClickHouse/ClickHouse/issues/71777). [#71891](https://github.com/ClickHouse/ClickHouse/pull/71891) ([Peter Nguyen](https://github.com/petern48)).
* Разрешён более общий алгоритм планирования `JOIN` при включённом алгоритме хешированного соединения. [#71926](https://github.com/ClickHouse/ClickHouse/pull/71926) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Скрытие секретов в `EXPLAIN QUERY TREE`. [#72025](https://github.com/ClickHouse/ClickHouse/pull/72025) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Добавлена возможность использовать настраиваемый диск для хранения файлов метаданных баз данных и таблиц. Имя диска может быть задано через конфигурационный параметр `database_disk.disk`. [#72027](https://github.com/ClickHouse/ClickHouse/pull/72027) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Добавлена поддержка логических целочисленных типов Parquet в нативном считывателе. [#72105](https://github.com/ClickHouse/ClickHouse/pull/72105) ([Arthur Passos](https://github.com/arthurpassos)).
* Формат вывода JSON теперь по умолчанию выводится в «красивом» виде. Добавлена новая настройка `output_format_json_pretty_print` для управления этим поведением, она включена по умолчанию. [#72148](https://github.com/ClickHouse/ClickHouse/pull/72148) ([Pavel Kruglov](https://github.com/Avogar)).
* Интерактивно запрашивать учетные данные в браузере, если для пользователя по умолчанию требуется пароль. В предыдущих версиях сервер возвращал HTTP 403, теперь он возвращает HTTP 401. [#72198](https://github.com/ClickHouse/ClickHouse/pull/72198) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Этот PR переводит типы доступа `CREATE_USER`, `ALTER_USER`, `DROP_USER`, `CREATE_ROLE`, `ALTER_ROLE`, `DROP_ROLE` из глобальных в параметризованные. Это означает, что пользователи теперь могут более точно выдавать права на управление доступом: [#72246](https://github.com/ClickHouse/ClickHouse/pull/72246) ([pufit](https://github.com/pufit)).
* Добавлена поддержка указания шардов по именам в конфигурации кластера. [#72276](https://github.com/ClickHouse/ClickHouse/pull/72276) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Добавлена поддержка `CAST` и `ALTER` между типами `JSON` с разными параметрами. [#72303](https://github.com/ClickHouse/ClickHouse/pull/72303) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлен столбец `latest_fail_error_code_name` в `system.mutations`. Этот столбец нужен, чтобы ввести новую метрику для «застрявших» мутаций и использовать её для построения графиков ошибок, возникающих в облаке, а также, при необходимости, добавить новое, менее шумное оповещение. [#72398](https://github.com/ClickHouse/ClickHouse/pull/72398) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Снижено количество выделений памяти при присоединении партиций. [#72583](https://github.com/ClickHouse/ClickHouse/pull/72583) ([Konstantin Morозов](https://github.com/k-morozov)).
* Сделан лимит `max_bytes_before_external_sort` зависящим от общего потребления памяти запросом (ранее он задавал число байт в блоке сортировки для одного потока сортировки, теперь он имеет то же значение, что и `max_bytes_before_external_group_by` — это общий лимит памяти для всего запроса для всех потоков). Также добавлена ещё одна настройка для управления размером блока на диске — `min_external_sort_block_bytes`. [#72598](https://github.com/ClickHouse/ClickHouse/pull/72598) ([Azat Khuzhin](https://github.com/azat)).
* Игнорировать ограничения по памяти в сборщике трассировок. [#72606](https://github.com/ClickHouse/ClickHouse/pull/72606) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка подстолбцов в ключе сортировки и пропускающих индексах MergeTree. [#72644](https://github.com/ClickHouse/ClickHouse/pull/72644) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлены серверные настройки `dictionaries_lazy_load` и `wait_dictionaries_load_at_startup` в `system.server_settings`. [#72664](https://github.com/ClickHouse/ClickHouse/pull/72664) ([Christoph Wurm](https://github.com/cwurm)).
* Добавлена настройка `max_backup_bandwidth` в список настроек, которые могут быть указаны в запросах `BACKUP`/`RESTORE`. [#72665](https://github.com/ClickHouse/ClickHouse/pull/72665) ([Christoph Wurm](https://github.com/cwurm)).
* Параллельные реплики использовали историческую информацию о доступности реплик для улучшения выбора, но не увеличивали счётчик ошибок реплики, когда соединение было недоступно. В этом PR счётчик ошибок реплики обновляется при её недоступности. [#72666](https://github.com/ClickHouse/ClickHouse/pull/72666) ([zoomxi](https://github.com/zoomxi)).
* Понижен уровень логирования для появляющихся реплицированных частей в движке ReplicatedMergeTree, чтобы сократить объем логов, генерируемых в реплицированном кластере. [#72876](https://github.com/ClickHouse/ClickHouse/pull/72876) ([mor-akamai](https://github.com/morkalfon)).
* Многие новые функции потребуют лучшей инкапсуляции кода (в части, относящейся к метаданным Iceberg) и более качественных абстракций. [#72941](https://github.com/ClickHouse/ClickHouse/pull/72941) ([Daniil Ivanik](https://github.com/divanik)).
* Реализована поддержка сравнения на равенство для значений столбца JSON. [#72991](https://github.com/ClickHouse/ClickHouse/pull/72991) ([Pavel Kruglov](https://github.com/Avogar)).
* Улучшено форматирование идентификаторов с подколонками JSON, чтобы избежать лишних обратных кавычек. [#73085](https://github.com/ClickHouse/ClickHouse/pull/73085) ([Pavel Kruglov](https://github.com/Avogar)).
* Записывать условия `PREWHERE` с уровнем `Test` в лог. [#73116](https://github.com/ClickHouse/ClickHouse/pull/73116) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Поддержка `SETTINGS` с неявным `ENGINE` и совместного использования настроек движка и настроек запроса. [#73120](https://github.com/ClickHouse/ClickHouse/pull/73120) ([Raúl Marín](https://github.com/Algunenano)).
* Записывать части с уровнем 1, если включён `optimize_on_insert`. Это позволяет применять ряд оптимизаций запросов с `FINAL` к только что записанным частям. [#73132](https://github.com/ClickHouse/ClickHouse/pull/73132) ([Anton Popov](https://github.com/CurtizJ)).
* Для запроса вида `WHERE a<b AND b<c AND c<5` могут генерироваться новые условия сравнения (`a<5 AND b<5`) для улучшения эффективности фильтрации. [#73164](https://github.com/ClickHouse/ClickHouse/pull/73164) ([Shichao Jin](https://github.com/jsc0218)).
* Улучшено извлечение общих выражений в дизъюнкциях. Добавлена возможность упрощать результирующее фильтрующее выражение, даже если нет общего подвыражения для всех дизъюнктов. Продолжение [#71537](https://github.com/ClickHouse/ClickHouse/issues/71537). [#73271](https://github.com/ClickHouse/ClickHouse/pull/73271) ([Dmitry Novik](https://github.com/novikd)).
* В хранилище `S3(Azure)Queue` добавлена возможность указывать настройки для таблиц, созданных без них. [#73283](https://github.com/ClickHouse/ClickHouse/pull/73283) ([Kseniia Sumarokova](https://github.com/kssenii)).
* clickhouse-client поддерживает сочетание клавиш Ctrl+D для завершения запроса. Разрешает использовать Ctrl+D вместо ввода точки с запятой и нажатия Enter. Дополнительно делает так, что Ctrl+D работает как Enter в однострочном режиме. [#73293](https://github.com/ClickHouse/ClickHouse/pull/73293) ([Xiaozhe Yu](https://github.com/wudidapaopao)).
* Добавлена настройка `least_greatest_legacy_null_behavior` (по умолчанию: `false`), которая определяет, должны ли функции `least` и `greatest` при наличии аргументов `NULL` безусловно возвращать `NULL` (если `true`) или игнорировать такие аргументы (если `false`). [#73344](https://github.com/ClickHouse/ClickHouse/pull/73344) ([Robert Schulze](https://github.com/rschu1ze)).
* Использовать пакетные запросы Keeper в потоке очистки ObjectStorageQueueMetadata. [#73357](https://github.com/ClickHouse/ClickHouse/pull/73357) ([Antonio Andelic](https://github.com/antonio2368)).
* Новый драйвер MongoDB теперь используется по умолчанию. Пользователи, которые хотят продолжать использовать устаревший драйвер, могут установить серверный параметр `use_legacy_mongodb_integration` в значение `true`. [#73359](https://github.com/ClickHouse/ClickHouse/pull/73359) ([Robert Schulze](https://github.com/rschu1ze)).
* Когда ClickHouse работает в cgroup, мы по-прежнему собираем системные асинхронные метрики на уровне всей системы, связанные с нагрузкой, планированием процессов, памятью и т. д. Они могут давать полезные сигналы, когда ClickHouse — единственный процесс на хосте с высоким потреблением ресурсов. [#73369](https://github.com/ClickHouse/ClickHouse/pull/73369) ([Nikita Taranov](https://github.com/nickitat)).
* В хранилище S3Queue добавлена возможность переноса старых упорядоченных таблиц, созданных до 24.6, в новую структуру с бакетами. [#73467](https://github.com/ClickHouse/ClickHouse/pull/73467) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена таблица `system.azure_queue`, аналогичная существующей `system.s3queue`. [#73477](https://github.com/ClickHouse/ClickHouse/pull/73477) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена регрессия, из-за которой использование локалей сортировки с модификаторами вызывало ошибку. Например, запрос `SELECT arrayJoin(['kk 50', 'KK 01', ' KK 2', ' KK 3', 'kk 1', 'x9y99', 'x9y100']) item ORDER BY item ASC COLLATE 'tr-u-kn-true-ka-shifted` теперь выполняется без ошибок. [#73544](https://github.com/ClickHouse/ClickHouse/pull/73544) ([Robert Schulze](https://github.com/rschu1ze)).
* Поддержка типа Nullable(JSON). [#73556](https://github.com/ClickHouse/ClickHouse/pull/73556) ([Pavel Kruglov](https://github.com/Avogar)).
* Функция `parseDateTime64` (и её варианты) теперь корректно обрабатывает входные даты до 1970 года и после 2106 года. Пример: `SELECT parseDateTime64InJodaSyntax('2200-01-01 00:00:00.000', 'yyyy-MM-dd HH:mm:ss.SSS')`. [#73594](https://github.com/ClickHouse/ClickHouse/pull/73594) ([zhanglistar](https://github.com/zhanglistar)).
* Устранены некоторые проблемы удобства использования `clickhouse-disks`, на которые указывали пользователи. Закрывает [#67136](https://github.com/ClickHouse/ClickHouse/issues/67136). [#73616](https://github.com/ClickHouse/ClickHouse/pull/73616) ([Daniil Ivanik](https://github.com/divanik)).
* Добавлена возможность изменять настройки фиксации (commit) в хранилище S3(Azure)Queue. (Настройки фиксации: max&#95;processed&#95;files&#95;before&#95;commit, max&#95;processed&#95;rows&#95;before&#95;commit, max&#95;processed&#95;bytes&#95;before&#95;commit, max&#95;processing&#95;time&#95;sec&#95;before&#95;commit). [#73635](https://github.com/ClickHouse/ClickHouse/pull/73635) ([Kseniia Sumarokova](https://github.com/kssenii)).
* В хранилище S3(Azure)Queue агрегируется прогресс чтения из источников для сравнения с настройками лимита коммитов. [#73641](https://github.com/ClickHouse/ClickHouse/pull/73641) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Поддержка базовых настроек в запросах `BACKUP`/`RESTORE`. [#73650](https://github.com/ClickHouse/ClickHouse/pull/73650) ([Vitaly Baranov](https://github.com/vitlibar)).
* Читать `output_format_compression_level` при выводе в Parquet. [#73651](https://github.com/ClickHouse/ClickHouse/pull/73651) ([Arthur Passos](https://github.com/arthurpassos)).
* Добавлено чтение Arrow fixed&#95;size&#95;list как Array вместо обработки этого типа как неподдерживаемого. [#73654](https://github.com/ClickHouse/ClickHouse/pull/73654) ([Julian Meyers](https://github.com/J-Meyers)).
* Этот PR добавляет два движка резервного копирования: `Memory` (хранит резервные копии в рамках текущей пользовательской сессии) и `Null` (не сохраняет резервные копии): [#73690](https://github.com/ClickHouse/ClickHouse/pull/73690) ([Vitaly Baranov](https://github.com/vitlibar)).
* `concurrent_threads_soft_limit_num` и `concurrent_threads_soft_limit_num_ratio_to_cores` теперь можно изменять без перезапуска сервера. [#73713](https://github.com/ClickHouse/ClickHouse/pull/73713) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена поддержка расширенных числовых типов (`Decimal`, большие целые числа) в функциях семейства `formatReadable`. [#73765](https://github.com/ClickHouse/ClickHouse/pull/73765) ([Raúl Marín](https://github.com/Algunenano)).
* Соблюдать регистронезависимое сопоставление имен столбцов для полей в столбцах типа `tuple`. Закрывает [https://github.com/apache/incubator-gluten/issues/8324](https://github.com/apache/incubator-gluten/issues/8324). [#73780](https://github.com/ClickHouse/ClickHouse/pull/73780) ([李扬](https://github.com/taiyang-li)).
* Добавлена поддержка TLS для протокола PostgreSQL wire. [#73812](https://github.com/ClickHouse/ClickHouse/pull/73812) ([scanhex12](https://github.com/scanhex12)).
* Разрешить `LowCardinality(UUID)` по умолчанию. Это показало свою практичность среди клиентов ClickHouse Cloud. [#73826](https://github.com/ClickHouse/ClickHouse/pull/73826) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшено сообщение, отображаемое во время установки. [#73827](https://github.com/ClickHouse/ClickHouse/pull/73827) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшено сообщение о сбросе пароля в ClickHouse Cloud. [#73831](https://github.com/ClickHouse/ClickHouse/pull/73831) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшено сообщение об ошибке для таблицы `File`, которая не поддерживает добавление данных в файл. [#73832](https://github.com/ClickHouse/ClickHouse/pull/73832) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Запрашивать подтверждение, когда пользователь по ошибке пытается вывести двоичный формат (например, Native, Parquet, Avro) в терминал. Закрывает [#59524](https://github.com/ClickHouse/ClickHouse/issues/59524). [#73833](https://github.com/ClickHouse/ClickHouse/pull/73833) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Тип данных `BFloat16` готов для промышленной эксплуатации. [#73840](https://github.com/ClickHouse/ClickHouse/pull/73840) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Подсвечивать завершающие пробелы в форматах Pretty и Vertical в терминале для лучшей наглядности. Это регулируется настройкой `output_format_pretty_highlight_trailing_spaces`. Изначальная реализация — от [Braden Burns](https://github.com/bradenburns), [#72996](https://github.com/ClickHouse/ClickHouse/issues/72996). Закрывает [#71590](https://github.com/ClickHouse/ClickHouse/issues/71590). [#73847](https://github.com/ClickHouse/ClickHouse/pull/73847) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* `clickhouse-client` и `clickhouse-local` теперь автоматически определяют тип сжатия stdin при его перенаправлении из файла. Это закрывает [#70865](https://github.com/ClickHouse/ClickHouse/issues/70865). [#73848](https://github.com/ClickHouse/ClickHouse/pull/73848) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* По умолчанию сокращать слишком длинные имена столбцов в pretty-форматах. Это контролируется настройками `output_format_pretty_max_column_name_width_cut_to` и `output_format_pretty_max_column_name_width_min_chars_to_cut`. Это продолжение работы [tanmaydatta](https://github.com/tanmaydatta) в [#66502](https://github.com/ClickHouse/ClickHouse/issues/66502). Это закрывает [#65968](https://github.com/ClickHouse/ClickHouse/issues/65968). [#73851](https://github.com/ClickHouse/ClickHouse/pull/73851) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сделать форматы `Pretty` более наглядными: объединять блоки, если с момента вывода предыдущего блока прошло немного времени. Это управляется новыми настройками `output_format_pretty_squash_consecutive_ms` (по умолчанию 50 мс) и `output_format_pretty_squash_max_wait_ms` (по умолчанию 1000 мс). Продолжение [#49537](https://github.com/ClickHouse/ClickHouse/issues/49537). Закрывает [#49153](https://github.com/ClickHouse/ClickHouse/issues/49153). [#73852](https://github.com/ClickHouse/ClickHouse/pull/73852) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено сопоставление типов для SQLite (целочисленные типы — в `int64`, числа с плавающей запятой — в `float64`). [#73853](https://github.com/ClickHouse/ClickHouse/pull/73853) ([Joanna Hulboj](https://github.com/jh0x)).
* Добавлена метрика по количеству исходных частей, которые в данный момент сливаются. Это закрывает [#70809](https://github.com/ClickHouse/ClickHouse/issues/70809). [#73868](https://github.com/ClickHouse/ClickHouse/pull/73868) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Подсвечивать столбцы в формате `Vertical`, если вывод направляется в терминал. Это можно отключить с помощью настройки `output_format_pretty_color`. [#73898](https://github.com/ClickHouse/ClickHouse/pull/73898) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Совместимость с MySQL улучшена до уровня, при котором `mysqlsh` (функциональная CLI-оболочка MySQL от Oracle) может подключаться к ClickHouse. Это необходимо для упрощения тестирования. [#73912](https://github.com/ClickHouse/ClickHouse/pull/73912) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Если количество выводимых записей больше N = `output_format_pretty_max_rows`, вместо отображения только первых N строк мы будем обрезать выходную таблицу посередине, показывая первые N/2 строк и последние N/2 строк. Продолжение [#64200](https://github.com/ClickHouse/ClickHouse/issues/64200). Это закрывает [#59502](https://github.com/ClickHouse/ClickHouse/issues/59502). [#73929](https://github.com/ClickHouse/ClickHouse/pull/73929) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Функция `isIPv4String` возвращала true, если за корректным IPv4-адресом следовал нулевой байт, хотя в этом случае должна была возвращать false. Продолжение [#65387](https://github.com/ClickHouse/ClickHouse/issues/65387). [#73946](https://github.com/ClickHouse/ClickHouse/pull/73946) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сделать код ошибки в протоколе MySQL wire совместимым с MySQL. Продолжение [#56831](https://github.com/ClickHouse/ClickHouse/issues/56831). Закрывает [#50957](https://github.com/ClickHouse/ClickHouse/issues/50957). [#73948](https://github.com/ClickHouse/ClickHouse/pull/73948) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена настройка `validate_enum_literals_in_opearators` для проверки литералов `Enum` в операторах `IN` и `NOT IN` на соответствие типу `Enum` и выброса исключения, если литерал не является допустимым значением `Enum`. [#73985](https://github.com/ClickHouse/ClickHouse/pull/73985) ([Vladimir Cherkasov](https://github.com/vdimir)).
* В хранилище `S3(Azure)Queue` зафиксировать все файлы (в одном батче, определяемом настройками фиксации) в одной транзакции Keeper. [#73991](https://github.com/ClickHouse/ClickHouse/pull/73991) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отключено определение заголовков для исполняемых UDF и словарей (это могло приводить к ошибке Function &#39;X&#39;: wrong result, expected Y row(s), actual Y-1). [#73992](https://github.com/ClickHouse/ClickHouse/pull/73992) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена опция `distributed` для `EXPLAIN PLAN`. Теперь `EXPLAIN distributed=1 ...` добавляет удалённый план к шагам `ReadFromParallelRemote*`. [#73994](https://github.com/ClickHouse/ClickHouse/pull/73994) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Используется корректный тип возвращаемого значения для not/xor с аргументами типа Dynamic. [#74013](https://github.com/ClickHouse/ClickHouse/pull/74013) ([Pavel Kruglov](https://github.com/Avogar)).
* Разрешено изменять настройку `add_implicit_sign_column_constraint_for_collapsing_engine` после создания таблицы. [#74014](https://github.com/ClickHouse/ClickHouse/pull/74014) ([Christoph Wurm](https://github.com/cwurm)).
* Поддержка подстолбцов в запросе SELECT материализованного представления. [#74030](https://github.com/ClickHouse/ClickHouse/pull/74030) ([Pavel Kruglov](https://github.com/Avogar)).
* Форматы семейства Pretty могут отображать многострочные поля внутри ячейки таблицы, что повышает читаемость. Эта возможность включена по умолчанию и управляется настройкой `output_format_pretty_multiline_fields`. Продолжение работы [Volodyachan](https://github.com/Volodyachan) в [#64094](https://github.com/ClickHouse/ClickHouse/issues/64094). Это закрывает [#56912](https://github.com/ClickHouse/ClickHouse/issues/56912). [#74032](https://github.com/ClickHouse/ClickHouse/pull/74032) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка оптимизации `predicate-push-down` на уровне плана запроса для шага `MergingAggregated`. Это повышает производительность некоторых запросов с новым анализатором. [#74073](https://github.com/ClickHouse/ClickHouse/pull/74073) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Теперь есть три простых способа задать пользовательское приглашение в `clickhouse-client`: 1) через параметр командной строки `--prompt`, 2) в конфигурационном файле, через настройку `<prompt>[...]</prompt>`, и 3) также в конфигурационном файле, через настройки для отдельных подключений `<connections_credentials><prompt>[...]</prompt></connections_credentials>`. [#74168](https://github.com/ClickHouse/ClickHouse/pull/74168) ([Christoph Wurm](https://github.com/cwurm)).
* Изменён код успешного ответа prometheus remote write с 200/OK на 204/NoContent. [#74170](https://github.com/ClickHouse/ClickHouse/pull/74170) ([Michael Dempsey](https://github.com/bluestealth)).
* Добавлена возможность передавать HTTP-заголовки X-ClickHouse в JavaScript в браузере. Это делает разработку приложений более удобной. [#74180](https://github.com/ClickHouse/ClickHouse/pull/74180) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Формат `JSONEachRowWithProgress` будет включать события с метаданными, а также totals и extremes. Он также включает `rows_before_limit_at_least` и `rows_before_aggregation`. Формат корректно выводит исключение, если оно возникает после частичных результатов. Теперь прогресс включает прошедшие наносекунды. В конце отправляется одно финальное событие прогресса. Прогресс во время выполнения запроса будет выводиться не чаще, чем это задано значением настройки `interactive_delay`. [#74181](https://github.com/ClickHouse/ClickHouse/pull/74181) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Анимация песочных часов в интерфейсе Play стала более плавной. [#74182](https://github.com/ClickHouse/ClickHouse/pull/74182) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Даже если HTTP-ответ сжат, отправляйте пакеты сразу по мере их поступления. Это позволяет браузеру получать пакеты прогресса и сжатые данные. [#74201](https://github.com/ClickHouse/ClickHouse/pull/74201) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность динамически изменять `max_remote_read_network_bandwidth_for_serve` и `max_remote_write_network_bandwidth_for_server` без перезапуска сервера. [#74206](https://github.com/ClickHouse/ClickHouse/pull/74206) ([Kai Zhu](https://github.com/nauu)).
* Автоматическое определение защищённого соединения при подключении к порту 9440 в ClickHouse Client. [#74212](https://github.com/ClickHouse/ClickHouse/pull/74212) ([Christoph Wurm](https://github.com/cwurm)).
* Аутентифицировать пользователей по одному только имени пользователя для `http_handlers` (ранее требовалось, чтобы пользователь также указывал пароль). [#74221](https://github.com/ClickHouse/ClickHouse/pull/74221) ([Azat Khuzhin](https://github.com/azat)).
* Поддержка альтернативных языков запросов PRQL и KQL помечена как экспериментальная. Чтобы использовать их, задайте настройки `allow_experimental_prql_dialect = 1` и `allow_experimental_kusto_dialect = 1`. [#74224](https://github.com/ClickHouse/ClickHouse/pull/74224) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка возврата типа `Enum` по умолчанию в большем числе агрегатных функций. [#74272](https://github.com/ClickHouse/ClickHouse/pull/74272) ([Raúl Marín](https://github.com/Algunenano)).
* В `OPTIMIZE TABLE` теперь можно указывать ключевое слово `FORCE` в качестве альтернативы существующему ключевому слову `FINAL`. [#74342](https://github.com/ClickHouse/ClickHouse/pull/74342) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена настройка MergeTree `materialize_skip_indexes_on_merge`, которая отключает создание пропускающих индексов во время слияния. Это позволяет пользователям явно контролировать (через `ALTER TABLE [..] MATERIALIZE INDEX [...]`), когда создаются пропускающие индексы. Это может быть полезно, если построение пропускающих индексов дорого обходится (например, индексов по векторному сходству). [#74401](https://github.com/ClickHouse/ClickHouse/pull/74401) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка подстолбцов в выражениях DEFAULT и MATERIALIZED. [#74403](https://github.com/ClickHouse/ClickHouse/pull/74403) ([Pavel Kruglov](https://github.com/Avogar)).
* Оптимизированы запросы Keeper в Storage(S3/Azure)Queue. [#74410](https://github.com/ClickHouse/ClickHouse/pull/74410) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена метрика IsServerShuttingDown, необходимая для срабатывания предупреждения, когда завершение работы сервера занимает слишком много времени. [#74429](https://github.com/ClickHouse/ClickHouse/pull/74429) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* В EXPLAIN добавлен вывод имен таблиц Iceberg. [#74485](https://github.com/ClickHouse/ClickHouse/pull/74485) ([alekseev-maksim](https://github.com/alekseev-maksim)).
* По умолчанию использовать не более `1000` параллельных реплик. [#74504](https://github.com/ClickHouse/ClickHouse/pull/74504) ([Konstantin Bogданov](https://github.com/thevar1able)).
* Улучшено сообщение об ошибке при использовании RECURSIVE CTE со старым анализатором. [#74523](https://github.com/ClickHouse/ClickHouse/pull/74523) ([Raúl Marín](https://github.com/Algunenano)).
* Оптимизировать запросы к Keeper в Storage(S3/Azure)Queue. [#74538](https://github.com/ClickHouse/ClickHouse/pull/74538) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Улучшено повторное использование HTTP-сессий при чтении с диска s3 ([#72401](https://github.com/ClickHouse/ClickHouse/issues/72401)). [#74548](https://github.com/ClickHouse/ClickHouse/pull/74548) ([Julian Maicher](https://github.com/jmaicher)).
* Отображать расширенные сообщения об ошибках в `system.errors`. [#74574](https://github.com/ClickHouse/ClickHouse/pull/74574) ([Vitaly Baranov](https://github.com/vitlibar)).
* Включена логика backoff для всех типов реплицируемых задач. Это позволит снизить использование CPU, потребление памяти и размер файлов журнала. Добавлены новые настройки `max_postpone_time_for_failed_replicated_fetches_ms`, `max_postpone_time_for_failed_replicated_merges_ms` и `max_postpone_time_for_failed_replicated_tasks_ms`, аналогичные `max_postpone_time_for_failed_mutations_ms`. [#74576](https://github.com/ClickHouse/ClickHouse/pull/74576) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Более точная обработка настройки `max_joined_block_size_rows` для алгоритма JOIN `parallel_hash`. Помогает избежать повышенного потребления памяти по сравнению с алгоритмом `hash`. [#74630](https://github.com/ClickHouse/ClickHouse/pull/74630) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлена поддержка опции конфигурации libhdfs3 `dfs.client.use.datanode.hostname`. [#74635](https://github.com/ClickHouse/ClickHouse/pull/74635) ([Mikhail Tiukavkin](https://github.com/freshertm)).
* Исправлено: кодек &#39;snappy&#39; не поддерживает установку уровня сжатия. [#74659](https://github.com/ClickHouse/ClickHouse/pull/74659) ([Arthur Passos](https://github.com/arthurpassos)).
* Разрешено использование пароля для взаимодействия клиента с clickhouse-keeper. Эта возможность не очень полезна, если вы настроили корректную SSL-конфигурацию для сервера и клиента, но всё же может оказаться полезной в некоторых случаях. Пароль не может быть длиннее 16 символов. Это не связано с моделью аутентификации Keeper. [#74673](https://github.com/ClickHouse/ClickHouse/pull/74673) ([alesapin](https://github.com/alesapin)).
* Разрешено использовать пути к BLOB-объектам для вычисления контрольных сумм при создании резервной копии. [#74729](https://github.com/ClickHouse/ClickHouse/pull/74729) ([Vitaly Baranov](https://github.com/vitlibar)).
* Используйте динамический шардинг для JOIN, если ключ JOIN является префиксом первичного ключа (PK) для обеих частей. Эта оптимизация включается настройкой `query_plan_join_shard_by_pk_ranges` (по умолчанию отключена). [#74733](https://github.com/ClickHouse/ClickHouse/pull/74733) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлен код ошибки для перезагрузчика конфигурации. [#74746](https://github.com/ClickHouse/ClickHouse/pull/74746) ([Garrett Thomas](https://github.com/garrettthomaskth)).
* Добавлена поддержка адресов IPv6 в табличных функциях и движках MySQL и PostgreSQL. [#74796](https://github.com/ClickHouse/ClickHouse/pull/74796) ([Mikhail Koviazin](https://github.com/mkmkme)).
* Параметры кодека Gorilla теперь всегда будут сохраняться в метаданных таблицы в файле .sql. Это закрывает задачу: [#70072](https://github.com/ClickHouse/ClickHouse/issues/70072). [#74814](https://github.com/ClickHouse/ClickHouse/pull/74814) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Реализована оптимизация с коротким замыканием для `divideDecimal`. Исправлена проблема [#74280](https://github.com/ClickHouse/ClickHouse/issues/74280). [#74843](https://github.com/ClickHouse/ClickHouse/pull/74843) ([Kevin Mingtarja](https://github.com/kevinmingtarja)).
* Улучшена производительность крупных мультизапросных операций в Keeper. [#74849](https://github.com/ClickHouse/ClickHouse/pull/74849) ([Antonio Andelic](https://github.com/antonio2368)).
* Теперь пользователей можно задавать в скриптах запуска. [#74894](https://github.com/ClickHouse/ClickHouse/pull/74894) ([pufit](https://github.com/pufit)).
* Параллельная загрузка партиций в `ALTER TABLE FETCH PARTITION` (размер пула потоков задаётся параметром `max_fetch_partition_thread_pool_size`). [#74978](https://github.com/ClickHouse/ClickHouse/pull/74978) ([Azat Khuzhin](https://github.com/azat)).
* Добавлен столбец идентификатора запроса в `system.query_cache` (issue [#68205](https://github.com/ClickHouse/ClickHouse/issues/68205)). [#74982](https://github.com/ClickHouse/ClickHouse/pull/74982) ([NamNguyenHoai](https://github.com/NamHoaiNguyen)).
* Повторно включён протокол SSH. Исправлены критические уязвимости, поэтому больше нельзя использовать пользовательский `pager` или указывать `server-logs-file`. По умолчанию отключена возможность передавать опции клиента через переменные окружения (это по‑прежнему возможно с помощью `ssh-server.enable_client_options_passing` в config.xml). Добавлена поддержка таблицы прогресса, отмены запросов, автодополнения, прогресса событий профилирования, stdin и опции `send_logs_level`. Закрывает: [#74340](https://github.com/ClickHouse/ClickHouse/issues/74340). [#74989](https://github.com/ClickHouse/ClickHouse/pull/74989) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлено форматирование исключений с использованием заданного пользователем формата, если они возникают во время интерпретации запроса. В предыдущих версиях исключения форматировались с использованием формата по умолчанию, а не формата, указанного в запросе. Это закрывает [#55422](https://github.com/ClickHouse/ClickHouse/issues/55422). [#74994](https://github.com/ClickHouse/ClickHouse/pull/74994) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Реализованы улучшения парсинга (парсинг идентификаторов последовательностей: добавлена возможность разбора идентификаторов последовательностей в manifest-файлах и парсинг метаданных Avro: переработан парсер метаданных Avro так, чтобы его было легко расширять для будущих доработок). [#75010](https://github.com/ClickHouse/ClickHouse/pull/75010) ([Daniil Ivanik](https://github.com/divanik)).
* Теперь можно отменять запросы `ALTER TABLE ... FREEZE ...` с помощью `KILL QUERY` и по таймауту (`max_execution_time`). [#75016](https://github.com/ClickHouse/ClickHouse/pull/75016) ([Kirill](https://github.com/kirillgarbar)).
* Добавлена поддержка `groupUniqArrayArrayMap` в качестве `SimpleAggregateFunction`. [#75034](https://github.com/ClickHouse/ClickHouse/pull/75034) ([Miel Donkers](https://github.com/mdonkers)).
* Добавлена поддержка подготовленных выражений в сетевом протоколе Postgres. [#75035](https://github.com/ClickHouse/ClickHouse/pull/75035) ([scanhex12](https://github.com/scanhex12)).
* Скрыты настройки учетных данных каталога в движке базы данных `Iceberg`. Исправляет [#74559](https://github.com/ClickHouse/ClickHouse/issues/74559). [#75080](https://github.com/ClickHouse/ClickHouse/pull/75080) ([Kseniia Sumarokova](https://github.com/kssenii)).
* В BuzzHouse добавлено несколько недостающих возможностей: операторы `ILIKE` и `REGEXP`, `<=>` и `IS NOT DISTINCT FROM`. [#75168](https://github.com/ClickHouse/ClickHouse/pull/75168) ([Pedro Ferreira](https://github.com/PedroTadim)).
* Настройка `min_chunk_bytes_for_parallel_parsing` больше не может иметь нулевое значение. Это исправляет: [#71110](https://github.com/ClickHouse/ClickHouse/issues/71110). [#75239](https://github.com/ClickHouse/ClickHouse/pull/75239) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* `intExp2` / `intExp10`: Определено поведение для ранее неопределённых случаев: возвращать 0 для слишком малого аргумента, `18446744073709551615` для слишком большого аргумента, выбрасывать исключение, если `nan`. [#75312](https://github.com/ClickHouse/ClickHouse/pull/75312) ([Vitaly Baranov](https://github.com/vitlibar)).
* Реализована нативная поддержка `s3.endpoint` из конфигурации каталога в `DatabaseIceberg`. Закрывает [#74558](https://github.com/ClickHouse/ClickHouse/issues/74558). [#75375](https://github.com/ClickHouse/ClickHouse/pull/75375) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Не завершать операцию без сообщения об ошибке, если у пользователя, выполняющего `SYSTEM DROP REPLICA`, недостаточно прав. [#75377](https://github.com/ClickHouse/ClickHouse/pull/75377) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлен `ProfileEvent` для подсчёта числа неудачных попыток сброса каких-либо системных логов. [#75466](https://github.com/ClickHouse/ClickHouse/pull/75466) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлены проверка и логирование при расшифровке и распаковке. [#75471](https://github.com/ClickHouse/ClickHouse/pull/75471) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена поддержка символа «micro» (U+00B5) в функции `parseTimeDelta`. Теперь и знак «micro» (U+00B5), и греческая буква мю (U+03BC) распознаются как допустимые обозначения микросекунд, что делает поведение ClickHouse согласованным с реализацией Go ([см. time.go](https://github.com/golang/go/blob/ad7b46ee4ac1cee5095d64b01e8cf7fcda8bee5e/src/time/time.go#L983C19-L983C20) и [time/format.go](https://github.com/golang/go/blob/ad7b46ee4ac1cee5095d64b01e8cf7fcda8bee5e/src/time/format.go#L1608-L1609)). [#75472](https://github.com/ClickHouse/ClickHouse/pull/75472) ([Vitaly Orlov](https://github.com/orloffv)).
* Серверная настройка (`send_settings_to_client`) заменена на клиентскую (`apply_settings_from_server`), которая определяет, должен ли клиентский код (например, разбор данных `INSERT` и форматирование вывода запроса) использовать настройки из `users.xml` сервера и профиля пользователя. В противном случае используются только настройки, заданные в командной строке клиента, сессии и самом запросе. Обратите внимание, что это относится только к нативному клиенту (а не, например, к HTTP) и не распространяется на основную часть обработки запроса (которая выполняется на сервере). [#75478](https://github.com/ClickHouse/ClickHouse/pull/75478) ([Michael Kolupaev](https://github.com/al13n321)).
* Улучшение Keeper: для повышения производительности отключено вычисление дайджеста при фиксации в хранилище в памяти. Его можно включить с помощью настройки `keeper_server.digest_enabled_on_commit`. Дайджест по-прежнему вычисляется при предварительной обработке запросов. [#75490](https://github.com/ClickHouse/ClickHouse/pull/75490) ([Antonio Andelic](https://github.com/antonio2368)).
* Выполнен pushdown фильтрующего выражения из JOIN ON, когда это возможно. [#75536](https://github.com/ClickHouse/ClickHouse/pull/75536) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Более информативные сообщения об ошибках синтаксиса. Ранее, если запрос был слишком большим и токен, длина которого превышала лимит, представлял собой очень большой строковый литерал, сообщение о причине терялось между двумя примерами этого очень длинного токена. Исправлена проблема, при которой запрос в UTF-8 некорректно обрезался в сообщении об ошибке. Исправлено избыточное заключение фрагментов запроса в кавычки. Закрывает [#75473](https://github.com/ClickHouse/ClickHouse/issues/75473). [#75561](https://github.com/ClickHouse/ClickHouse/pull/75561) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлены события профилирования в хранилище `S3(Azure)Queue`. [#75618](https://github.com/ClickHouse/ClickHouse/pull/75618) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отключена отправка настроек с сервера на клиент (`send_settings_to_client=false`) для обеспечения совместимости (эта возможность позже будет реализована заново как настройка клиента для повышения удобства использования). [#75648](https://github.com/ClickHouse/ClickHouse/pull/75648) ([Michael Kolupaev](https://github.com/al13n321)).
* Добавлена настройка `memory_worker_correct_memory_tracker` для включения корректировки внутреннего счетчика памяти с использованием информации из другого источника, периодически считываемой в фоновом потоке. [#75714](https://github.com/ClickHouse/ClickHouse/pull/75714) ([Antonio Andelic](https://github.com/antonio2368)).
* Использование Analyzer в PrometheusRemoteReadProtocol. [#75729](https://github.com/ClickHouse/ClickHouse/pull/75729) ([Dmitry Novik](https://github.com/novikd)).
* Поддерживаются типы метрик gauge и counter. Однако этого недостаточно для некоторых метрик (например, времени ответа запросов к keeper), поэтому нужна поддержка типа метрик histogram. Интерфейс во многом повторяет клиент Prometheus: вы просто вызываете `observe(value)`, чтобы увеличить счетчик в бакете, соответствующем значению. Метрики histogram доступны через system.histogram&#95;metrics. [#75736](https://github.com/ClickHouse/ClickHouse/pull/75736) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Добавлен столбец `normalized_query_hash` в `system.processes`. Примечание: хотя его можно легко вычислить «на лету» с помощью функции `normalizedQueryHash`, это необходимо для подготовки к последующим изменениям. [#75756](https://github.com/ClickHouse/ClickHouse/pull/75756) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Запрос к `system.tables` не будет выдавать исключение, даже если существует таблица `Merge`, созданная поверх базы данных, которая уже удалена. Метод `getTotalRows` удалён из таблиц `Hive`, поскольку мы не допускаем выполнения им сложных операций. [#75772](https://github.com/ClickHouse/ClickHouse/pull/75772) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* В веб-интерфейсе теперь доступна интерактивная навигация по базам данных. [#75777](https://github.com/ClickHouse/ClickHouse/pull/75777) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Позволяет комбинировать диски только для чтения и диски для чтения и записи в политике хранения (как несколько томов или несколько дисков). Это позволяет читать данные со всего тома, при этом операции вставки будут выполняться на записываемый диск (т.е. политика хранения Copy-on-Write). [#75862](https://github.com/ClickHouse/ClickHouse/pull/75862) ([Azat Khuzhin](https://github.com/azat)).
* Удалён `trace_id` из сортировки по умолчанию (`ORDER BY`) для `system.opentelemetry_span_log`. [#75907](https://github.com/ClickHouse/ClickHouse/pull/75907) ([Azat Khuzhin](https://github.com/azat)).
* Шифрование (XML-атрибут `encrypted_by`) теперь может применяться к любому конфигурационному файлу (config.xml, users.xml, вложенным конфигурационным файлам). Ранее оно работало только для верхнего уровня, файла config.xml. [#75911](https://github.com/ClickHouse/ClickHouse/pull/75911) ([Mikhail Gorshkov](https://github.com/mgorshkov)).
* Хранение полей start&#95;time/end&#95;time для резервных копий с точностью до микросекунд. [#75929](https://github.com/ClickHouse/ClickHouse/pull/75929) ([Aleksandr Musorin](https://github.com/AVMusorin)).
* Добавлена метрика `MemoryTrackingUncorrected`, показывающая значение внутреннего глобального трекера памяти, которое не корректируется по RSS. [#75935](https://github.com/ClickHouse/ClickHouse/pull/75935) ([Antonio Andelic](https://github.com/antonio2368)).
* Вычислять размеры столбцов и индексов лениво в MergeTree. [#75938](https://github.com/ClickHouse/ClickHouse/pull/75938) ([Pavel Kruglov](https://github.com/Avogar)).
* Преобразовать `JOIN` в подзапрос с `IN`, если выходной столбец связан с левой таблицей; сначала требуется шаг для обеспечения уникальности, поэтому по умолчанию отключено, пока этот шаг не будет добавлен позже. [#75942](https://github.com/ClickHouse/ClickHouse/pull/75942) ([Shichao Jin](https://github.com/jsc0218)).
* Добавлена настройка сервера `throw_on_unknown_workload`, которая позволяет выбрать поведение при выполнении запроса с настройкой `workload`, имеющей неизвестное значение: либо разрешить неограниченный доступ (по умолчанию), либо выдать ошибку `RESOURCE_ACCESS_DENIED`. Это полезно, чтобы принудительно заставить все запросы использовать планировщик нагрузок. [#75999](https://github.com/ClickHouse/ClickHouse/pull/75999) ([Sergei Trifonov](https://github.com/serxa)).
* Заставить новый экспериментальный движок таблиц Kafka полностью учитывать фичефлаги Keeper. [#76004](https://github.com/ClickHouse/ClickHouse/pull/76004) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Не переписывайте подстолбцы на getSubcolumn в ARRAY JOIN без необходимости. [#76018](https://github.com/ClickHouse/ClickHouse/pull/76018) ([Pavel Kruglov](https://github.com/Avogar)).
* Повторные попытки при ошибках координации при загрузке таблиц. [#76020](https://github.com/ClickHouse/ClickHouse/pull/76020) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Улучшена таблица `system.warnings` и добавлены динамические предупреждения, которые можно добавлять, обновлять или удалять. [#76029](https://github.com/ClickHouse/ClickHouse/pull/76029) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлена поддержка сброса отдельных журналов в SYSTEM FLUSH LOGS. [#76132](https://github.com/ClickHouse/ClickHouse/pull/76132) ([Raúl Marín](https://github.com/Algunenano)).
* Улучшена страница сервера `/binary`. Вместо кривой Мортон используется кривая Гильберта. В квадрате отображаются адреса в объёме 512 МБ, что лучше заполняет его (в предыдущих версиях адреса занимали только половину квадрата). Цвет адресов определяется преимущественно по имени библиотеки, а не по имени функции. Разрешена прокрутка немного дальше за пределы области. [#76192](https://github.com/ClickHouse/ClickHouse/pull/76192) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Этот PR делает невозможным выполнение запроса `ALTER USER user1 ADD PROFILES a, DROP ALL PROFILES`, поскольку все операции `DROP` должны идти первыми. [#76242](https://github.com/ClickHouse/ClickHouse/pull/76242) ([pufit](https://github.com/pufit)).
* Различные улучшения для `SYNC REPLICA` (более информативные сообщения об ошибках, улучшенные тесты, дополнительные проверки корректности). [#76307](https://github.com/ClickHouse/ClickHouse/pull/76307) ([Azat Khuzhin](https://github.com/azat)).
* Повторная попытка выполнения запросов с ON CLUSTER в случае TOO&#95;MANY&#95;SIMULTANEOUS&#95;QUERIES. [#76352](https://github.com/ClickHouse/ClickHouse/pull/76352) ([Patrick Galbraith](https://github.com/CaptTofu)).
* Изменено значение по умолчанию `output_format_pretty_max_rows` с 10000 на 1000. Считаю, что так удобнее в использовании. [#76407](https://github.com/ClickHouse/ClickHouse/pull/76407) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Поддержка `REFRESH` в таблицах MergeTree в режиме только для чтения. [#76467](https://github.com/ClickHouse/ClickHouse/pull/76467) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Используется корректный резервный механизм, когда multipart‑копирование в S3 завершается с ошибкой во время резервного копирования из-за Access Denied. Multipart‑копирование может приводить к ошибке Access Denied, когда резервное копирование выполняется между бакетами с разными учетными данными. [#76515](https://github.com/ClickHouse/ClickHouse/pull/76515) ([Antonio Andelic](https://github.com/antonio2368)).
* Более быстрое завершение работы серверов ClickHouse (убрана задержка в 2,5 секунды). [#76550](https://github.com/ClickHouse/ClickHouse/pull/76550) ([Azat Khuzhin](https://github.com/azat)).
* Добавлено поле query&#95;id в system.errors. Связанный тикет: [#75815](https://github.com/ClickHouse/ClickHouse/issues/75815). [#76581](https://github.com/ClickHouse/ClickHouse/pull/76581) ([Vladimir Baikov](https://github.com/bkvvldmr)).
* Обновлена `librdkafka` до версии 2.8.0 и улучшена последовательность завершения работы таблиц Kafka, что сократило задержки при удалении таблиц и перезапуске сервера. `engine=Kafka` больше не выполняет явный выход из consumer group при удалении таблицы. Вместо этого consumer остается в группе до тех пор, пока не будет автоматически удалён после периода неактивности, равного `session_timeout_ms` (по умолчанию: 45 секунд). [#76621](https://github.com/ClickHouse/ClickHouse/pull/76621) ([filimonov](https://github.com/filimonov)).
* Исправлена проверка настроек запросов S3. [#76658](https://github.com/ClickHouse/ClickHouse/pull/76658) ([Vitaly Baranov](https://github.com/vitlibar)).
* Избегать избыточного выделения памяти в `readbufferfroms3` и других буферах удалённого чтения, сократить их потребление памяти вдвое. [#76692](https://github.com/ClickHouse/ClickHouse/pull/76692) ([Sema Checherinda](https://github.com/CheSema)).
* Добавлена поддержка типа JSON и чтения его подстолбцов из View. [#76903](https://github.com/ClickHouse/ClickHouse/pull/76903) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена поддержка преобразования `UInt128` в `IPv6`. Это позволяет выполнять операцию `bitAnd` и арифметические операции для `IPv6`, а также преобразовывать значения обратно в `IPv6`. Закрывает [#76752](https://github.com/ClickHouse/ClickHouse/issues/76752). Также позволяет преобразовывать результат операции `bitAnd` над `IPv6` обратно в `IPv6`. См.: [https://github.com/ClickHouse/ClickHouse/pull/57707](https://github.com/ClickHouse/ClickHouse/pull/57707). [#76928](https://github.com/ClickHouse/ClickHouse/pull/76928) ([Muzammил Abdul Rehman](https://github.com/muzammilar)).
* Системные таблицы, такие как `server_settings` или `settings`, имеют столбец `default`, что удобно. Только в `merge_tree_settings` и `replicated_merge_tree_settings` этот столбец не активирован. [#76942](https://github.com/ClickHouse/ClickHouse/pull/76942) ([Diego Nieto](https://github.com/lesandie)).
* По умолчанию не парсить специальные значения типа Bool в текстовых форматах внутри типа Variant. Это можно включить с помощью настройки `allow_special_bool_values_inside_variant`. [#76974](https://github.com/ClickHouse/ClickHouse/pull/76974) ([Pavel Kruglov](https://github.com/Avogar)).
* Поддержка настройки времени ожидания для задач низкоприоритетных запросов на уровне сессии и сервера. [#77013](https://github.com/ClickHouse/ClickHouse/pull/77013) ([VicoWu](https://github.com/VicoWu)).
* Добавлен `ProfileEvents::QueryPreempted` с той же логикой, что и у `CurrentMetrics::QueryPreempted`. [#77015](https://github.com/ClickHouse/ClickHouse/pull/77015) ([VicoWu](https://github.com/VicoWu)).
* Ранее `database replicated` мог выводить в логи учетные данные, указанные в запросе. Это поведение исправлено. Исправлено в рамках: [#77123](https://github.com/ClickHouse/ClickHouse/issues/77123). [#77133](https://github.com/ClickHouse/ClickHouse/pull/77133) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Обновлена версия zstd с 1.5.5 до 1.5.7, которая даёт [существенный прирост производительности](https://github.com/facebook/zstd/releases/tag/v1.5.7). [#77137](https://github.com/ClickHouse/ClickHouse/pull/77137) ([Pradeep Chhetri](https://github.com/chhetripradeep)).
* Разрешен `ALTER TABLE DROP PARTITION` для диска `plain_rewritable`. [#77138](https://github.com/ClickHouse/ClickHouse/pull/77138) ([Julia Kartseva](https://github.com/jkartseva)).
* Добавлена возможность случайной задержки до 500 мс, независимо от размеров парций, перед выполнением слияний/мутаций в случае репликации с нулевым копированием. [#77165](https://github.com/ClickHouse/ClickHouse/pull/77165) ([Alexey Katsman](https://github.com/alexkats)).
* Добавлена поддержка атомарного переименования при использовании `TRUNCATE` с `INTO OUTFILE`. Решает [#70323](https://github.com/ClickHouse/ClickHouse/issues/70323). [#77181](https://github.com/ClickHouse/ClickHouse/pull/77181) ([Onkar Deshpande](https://github.com/onkar)).
* Используйте FixedString для типов PostgreSQL CHARACTER, CHAR и BPCHAR. [#77304](https://github.com/ClickHouse/ClickHouse/pull/77304) ([Pablo Marcos](https://github.com/pamarcos)).
* Добавлена возможность явно указывать файл метаданных для чтения Iceberg с помощью настройки `iceberg_metadata_file_path` для хранилища/табличной функции. Исправляет [#47412](https://github.com/ClickHouse/ClickHouse/issues/47412). [#77318](https://github.com/ClickHouse/ClickHouse/pull/77318) ([alesapin](https://github.com/alesapin)).
* Поддерживается использование удалённого диска базой данных для хранения файлов метаданных. [#77365](https://github.com/ClickHouse/ClickHouse/pull/77365) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Реализовано сравнение значений типа данных JSON. Теперь объекты JSON можно сравнивать аналогично типу `Map`. [#77397](https://github.com/ClickHouse/ClickHouse/pull/77397) ([Pavel Kruglov](https://github.com/Avogar)).
* Откат изменений. [#77399](https://github.com/ClickHouse/ClickHouse/pull/77399) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Параметр резервного копирования/восстановления `allow_s3_native_copy` теперь поддерживает три возможных значения: - `False` — s3 native copy не используется; - `True` (старое значение по умолчанию) — ClickHouse сначала попытается использовать s3 native copy, и, если это не удастся, перейдёт к подходу чтения и записи; - `'auto'` (новое значение по умолчанию) — ClickHouse сначала сравнит учётные данные источника и назначения. Если они совпадают, ClickHouse попытается использовать s3 native copy и затем при необходимости перейдёт к подходу чтения и записи. Если они различаются, ClickHouse сразу перейдёт к подходу чтения и записи. [#77401](https://github.com/ClickHouse/ClickHouse/pull/77401) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена поддержка ALTER TABLE ... ATTACH|DETACH|MOVE|REPLACE PARTITION для диска plain&#95;rewritable. [#77406](https://github.com/ClickHouse/ClickHouse/pull/77406) ([Julia Kartseva](https://github.com/jkartseva)).
* Отмена пропуска кэша индекса. [#77447](https://github.com/ClickHouse/ClickHouse/pull/77447) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Снижено потребление памяти при предвыборке JSON-столбца в Wide-частях. [#77640](https://github.com/ClickHouse/ClickHouse/pull/77640) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена поддержка использования AWS session token и учетных данных из переменных окружения в delta kernel для движка таблиц DeltaLake. [#77661](https://github.com/ClickHouse/ClickHouse/pull/77661) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка параметров запроса в настройке `additional_table_filters`. После этого изменения следующий запрос будет успешно выполнен:. [#77680](https://github.com/ClickHouse/ClickHouse/pull/77680) ([wxybear](https://github.com/wxybear)).
* Пользовательские функции (UDF) теперь могут помечаться как детерминированные с помощью нового тега в их XML-определении. Кроме того, кэш запросов теперь проверяет, являются ли вызываемые в запросе UDF детерминированными. Если да, результат запроса кэшируется. (Issue [#59988](https://github.com/ClickHouse/ClickHouse/issues/59988)). [#77769](https://github.com/ClickHouse/ClickHouse/pull/77769) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
* Добавлена проверка параметров движка таблицы Buffer. [#77840](https://github.com/ClickHouse/ClickHouse/pull/77840) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Добавлена настройка `enable_hdfs_pread` для включения или отключения `hdfs_pread`. [#77885](https://github.com/ClickHouse/ClickHouse/pull/77885) ([kevinyhzou](https://github.com/KevinyhZou)).
* Добавлены профильные события для количества запросов zookeeper &#39;multi&#39; на чтение и запись. [#77888](https://github.com/ClickHouse/ClickHouse/pull/77888) ([JackyWoo](https://github.com/JackyWoo)).
* Разрешено создавать временные таблицы и вставлять в них данные, когда включён `disable_insertion_and_mutation`. [#77901](https://github.com/ClickHouse/ClickHouse/pull/77901) ([Xu Jia](https://github.com/XuJia0210)).
* Уменьшено значение настройки max&#95;insert&#95;delayed&#95;streams&#95;for&#95;parallel&#95;write (до 100). [#77919](https://github.com/ClickHouse/ClickHouse/pull/77919) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена возможность настраивать количество столбцов, которые операции слияния могут сбрасывать параллельно с помощью настройки `max_merge_delayed_streams_for_parallel_write` (это должно примерно в 25 раз снизить потребление памяти при вертикальных слияниях в S3). [#77922](https://github.com/ClickHouse/ClickHouse/pull/77922) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено разбор значения года в синтаксисе joda, например &#39;yyy&#39;. [#77973](https://github.com/ClickHouse/ClickHouse/pull/77973) ([李扬](https://github.com/taiyang-li)).
* Присоединение частей таблиц MergeTree теперь будет выполняться в порядке их блоков, что важно для специальных алгоритмов слияния, таких как ReplacingMergeTree. Это закрывает [#71009](https://github.com/ClickHouse/ClickHouse/issues/71009). [#77976](https://github.com/ClickHouse/ClickHouse/pull/77976) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Правила маскировки запросов теперь могут генерировать `LOGICAL_ERROR` в случае совпадения. Это поможет проверить, не утечёт ли заранее заданный пароль где-либо в логах. [#78094](https://github.com/ClickHouse/ClickHouse/pull/78094) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлен столбец `index_length_column` в `information_schema.tables` для улучшения совместимости с MySQL. [#78119](https://github.com/ClickHouse/ClickHouse/pull/78119) ([Paweł Zakrzewski](https://github.com/KrzaQ)).
* Добавлены две новые метрики: `TotalMergeFailures` и `NonAbortedMergeFailures`. Эти метрики необходимы для выявления ситуаций, когда слишком много слияний завершается с ошибкой за короткий промежуток времени. [#78150](https://github.com/ClickHouse/ClickHouse/pull/78150) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Исправлен некорректный парсинг S3 URI, когда ключ не указан в режиме path-style. [#78185](https://github.com/ClickHouse/ClickHouse/pull/78185) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлены некорректные значения асинхронных метрик `BlockActiveTime`, `BlockDiscardTime`, `BlockWriteTime`, `BlockQueueTime` и `BlockReadTime` (до изменения 1 секунда ошибочно отображалась как 0.001). [#78211](https://github.com/ClickHouse/ClickHouse/pull/78211) ([filimonov](https://github.com/filimonov)).
* Ограничение `loading_retries` теперь учитывается для ошибок при отправке данных в материализованное представление из StorageS3(Azure)Queue. Ранее такие ошибки повторялись бесконечно. [#78313](https://github.com/ClickHouse/ClickHouse/pull/78313) ([Kseniia Sumarokova](https://github.com/kssenii)).
* В StorageDeltaLake с реализацией delta-kernel-rs улучшены производительность и индикатор выполнения. [#78368](https://github.com/ClickHouse/ClickHouse/pull/78368) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Индекс векторного сходства мог выделять оперативную память с избыточным запасом — до 2 раз больше необходимого. В этом исправлении переработана стратегия выделения памяти, что снизило её потребление и повысило эффективность кэша индекса векторного сходства. (issue [#78056](https://github.com/ClickHouse/ClickHouse/issues/78056)). [#78394](https://github.com/ClickHouse/ClickHouse/pull/78394) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Введена настройка `schema_type` для таблицы `system.metric_log`, определяющая тип схемы. Доступно три варианта: `wide` — текущая схема, каждая метрика/событие в отдельном столбце (наиболее эффективна при чтении отдельных столбцов); `transposed` — аналогично `system.asynchronous_metric_log`, метрики/события хранятся по строкам; и наиболее интересный вариант `transposed_with_wide_view` — создаётся базовая таблица со схемой `transposed`, а также представление со схемой `wide`, которое транслирует запросы к базовой таблице. В режиме `transposed_with_wide_view` субсекундное разрешение во представлении не поддерживается, `event_time_microseconds` — это лишь псевдоним для обратной совместимости. [#78412](https://github.com/ClickHouse/ClickHouse/pull/78412) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка `include`, `from_env`, `from_zk` для дисков в runtime. Закрывает [#78177](https://github.com/ClickHouse/ClickHouse/issues/78177). [#78470](https://github.com/ClickHouse/ClickHouse/pull/78470) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлено несколько удобных способов определения корневого файла metadata.json в табличной функции и движке Iceberg. Закрывает [#78455](https://github.com/ClickHouse/ClickHouse/issues/78455). [#78475](https://github.com/ClickHouse/ClickHouse/pull/78475) ([Daniil Ivanik](https://github.com/divanik)).
* Реализована поддержка отсечения партиций (partition pruning) в Delta Lake. [#78486](https://github.com/ClickHouse/ClickHouse/pull/78486) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Поддержка аутентификации по паролю в протоколе SSH в ClickHouse. [#78586](https://github.com/ClickHouse/ClickHouse/pull/78586) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлено динамическое предупреждение в таблицу `system.warnings` для долго выполняющихся мутаций. [#78658](https://github.com/ClickHouse/ClickHouse/pull/78658) ([Bharat Nallan](https://github.com/bharatnc)).
* Разрывать соединения, если ЦП сильно перегружен. Решение принимается на основе отношения времени ожидания (`OSCPUWaitMicroseconds`) к времени занятости (`OSCPUVirtualTimeMicroseconds`). Запрос с некоторой вероятностью будет отброшен, когда это отношение находится между `min_os_cpu_wait_time_ratio_to_drop_connection` и `max_os_cpu_wait_time_ratio_to_drop_connection`. [#78778](https://github.com/ClickHouse/ClickHouse/pull/78778) ([Alexey Katsman](https://github.com/alexkats)).
* Разрешены пустые значения при секционировании Hive. [#78816](https://github.com/ClickHouse/ClickHouse/pull/78816) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлено приведение типов в операторе `IN` для `BFloat16` (то есть `SELECT toBFloat16(1) IN [1, 2, 3];` теперь возвращает `1`). Закрывает [#78754](https://github.com/ClickHouse/ClickHouse/issues/78754). [#78839](https://github.com/ClickHouse/ClickHouse/pull/78839) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Не проверять части на других дисках в MergeTree, если задан параметр disk=. [#78855](https://github.com/ClickHouse/ClickHouse/pull/78855) ([Azat Khuzhin](https://github.com/azat)).
* Типы данных в `used_data_type_families` в `system.query_log` приведены к каноническому виду. [#78972](https://github.com/ClickHouse/ClickHouse/pull/78972) ([Kseniia Sumarokova](https://github.com/kssenii)).





## Исправление ошибки (видимое пользователю неправильное поведение в официальном стабильном релизе) {#bug-fix}


* Исправлена ошибка, из-за которой было невозможно создать SEQUENTIAL-узел с помощью keeper-client. [#64177](https://github.com/ClickHouse/ClickHouse/pull/64177) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлено разрешение идентификаторов из родительских областей. Разрешено использование псевдонимов для выражений в предложении WITH. Исправляет [#58994](https://github.com/ClickHouse/ClickHouse/issues/58994). Исправляет [#62946](https://github.com/ClickHouse/ClickHouse/issues/62946). Исправляет [#63239](https://github.com/ClickHouse/ClickHouse/issues/63239). Исправляет [#65233](https://github.com/ClickHouse/ClickHouse/issues/65233). Исправляет [#71659](https://github.com/ClickHouse/ClickHouse/issues/71659). Исправляет [#71828](https://github.com/ClickHouse/ClickHouse/issues/71828). Исправляет [#68749](https://github.com/ClickHouse/ClickHouse/issues/68749). [#66143](https://github.com/ClickHouse/ClickHouse/pull/66143) ([Dmitry Novik](https://github.com/novikd)).
* Исправлен некорректный подсчёт количества символов в PositionImpl::vectorVector. [#71003](https://github.com/ClickHouse/ClickHouse/pull/71003) ([思维](https://github.com/heymind)).
* Исправлена монотонность функции `negate`. В предыдущих версиях запрос `select * from a where -x = -42;`, где `x` — первичный ключ, мог возвращать некорректный результат. [#71440](https://github.com/ClickHouse/ClickHouse/pull/71440) ([Michael Kolupaev](https://github.com/al13n321)).
* Операции `RESTORE` для сущностей доступа требовали больше прав, чем было необходимо, из‑за необработанных частичных отзывов прав. Этот PR исправляет проблему. Закрывает [#71853](https://github.com/ClickHouse/ClickHouse/issues/71853). [#71958](https://github.com/ClickHouse/ClickHouse/pull/71958) ([pufit](https://github.com/pufit)).
* Избегает паузы после `ALTER TABLE REPLACE/MOVE PARTITION FROM/TO TABLE`. Получает корректные настройки для планирования фоновых задач. [#72024](https://github.com/ClickHouse/ClickHouse/pull/72024) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Исправлена обработка пустого кортежа в arrayIntersect. Это исправляет [#72578](https://github.com/ClickHouse/ClickHouse/issues/72578). [#72581](https://github.com/ClickHouse/ClickHouse/pull/72581) ([Amos Bird](https://github.com/amosbird)).
* Исправлена обработка пустых кортежей (`tuple`) в некоторых форматах ввода и вывода (например, Parquet, Arrow). [#72616](https://github.com/ClickHouse/ClickHouse/pull/72616) ([Michael Kolupaev](https://github.com/al13n321)).
* Операторы GRANT SELECT/INSERT на уровне столбцов, применяемые к базам данных/таблицам с подстановочными символами, теперь вызывают ошибку. [#72646](https://github.com/ClickHouse/ClickHouse/pull/72646) ([Johann Gan](https://github.com/johanngan)).
* Исправлена ситуация, когда пользователь не может выполнить `REVOKE ALL ON *.*` из-за неявно выданных прав в целевой сущности доступа. [#72872](https://github.com/ClickHouse/ClickHouse/pull/72872) ([pufit](https://github.com/pufit)).
* Исправлено зависание при обработке ожидающей партии для асинхронного распределённого INSERT (например, из-за ошибки `No such file or directory`). [#72939](https://github.com/ClickHouse/ClickHouse/pull/72939) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка токенов Azure SAS. [#72959](https://github.com/ClickHouse/ClickHouse/pull/72959) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено форматирование положительных часовых поясов в скалярной функции formatDateTime. [#73091](https://github.com/ClickHouse/ClickHouse/pull/73091) ([ollidraese](https://github.com/ollidraese)).
* Исправлена работа корректного отражения исходного порта при подключении через PROXYv1 и установленном `auth_use_forwarded_address` — ранее некорректно использовался порт прокси. Добавлена функция `currentQueryID()`. [#73095](https://github.com/ClickHouse/ClickHouse/pull/73095) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Пробрасывать настройки формата в `NativeWriter` из `TCPHandler`, чтобы такие параметры, как `output_format_native_write_json_as_string`, применялись корректно. [#73179](https://github.com/ClickHouse/ClickHouse/pull/73179) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено чтение подстолбцов подобъектов JSON с некорректным префиксом. [#73182](https://github.com/ClickHouse/ClickHouse/pull/73182) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено аварийное завершение работы в StorageObjectStorageQueue. [#73274](https://github.com/ClickHouse/ClickHouse/pull/73274) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен редкий сбой в обновляемом материализованном представлении при остановке сервера. [#73323](https://github.com/ClickHouse/ClickHouse/pull/73323) ([Michael Kolupaev](https://github.com/al13n321)).
* Заполнитель `%f` функции `formatDateTime` теперь всегда генерирует шесть цифр для долей секунды. Это делает поведение совместимым с функцией MySQL `DATE_FORMAT`. Предыдущее поведение можно восстановить с помощью настройки `formatdatetime_f_prints_scale_number_of_digits = 1`. [#73324](https://github.com/ClickHouse/ClickHouse/pull/73324) ([ollidraese](https://github.com/ollidraese)).
* Улучшено преобразование `DateTime` при анализе индексов за счет принудительного насыщенного поведения для неявных преобразований `Date` в `DateTime`. Это устраняет потенциальные неточности анализа индексов, вызванные ограничениями диапазона `DateTime`. Исправляет [#73307](https://github.com/ClickHouse/ClickHouse/issues/73307). Также исправлено явное преобразование `toDateTime`, когда `date_time_overflow_behavior = 'ignore'`, что является значением по умолчанию. [#73326](https://github.com/ClickHouse/ClickHouse/pull/73326) ([Amos Bird](https://github.com/amosbird)).
* Исправлена фильтрация по столбцу `_etag` при чтении из хранилища `s3` и одноимённой табличной функции. [#73353](https://github.com/ClickHouse/ClickHouse/pull/73353) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка `Not-ready Set is passed as the second argument for function 'in'`, возникающая при использовании `IN (subquery)` в выражении `JOIN ON` со старым анализатором. [#73382](https://github.com/ClickHouse/ClickHouse/pull/73382) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена подготовка к объединению (squashing) для динамических и JSON-столбцов. Ранее в некоторых случаях новые типы могли добавляться в shared variant/shared data, даже если лимит на количество типов/путей не был достигнут. [#73388](https://github.com/ClickHouse/ClickHouse/pull/73388) ([Pavel Kruglov](https://github.com/Avogar)).
* Проверка некорректных размеров при двоичном декодировании типов, чтобы избежать чрезмерных выделений памяти. [#73390](https://github.com/ClickHouse/ClickHouse/pull/73390) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена логическая ошибка при чтении из кластера с одной репликой при включённом режиме параллельных реплик. [#73403](https://github.com/ClickHouse/ClickHouse/pull/73403) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена работа ObjectStorageQueue с ZooKeeper и старой версией Keeper. [#73420](https://github.com/ClickHouse/ClickHouse/pull/73420) ([Antonio Andelic](https://github.com/antonio2368)).
* Реализовано исправление, необходимое для включения разбиения Hive по умолчанию. [#73479](https://github.com/ClickHouse/ClickHouse/pull/73479) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена гонка данных при создании индекса векторного подобия. [#73517](https://github.com/ClickHouse/ClickHouse/pull/73517) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправляет сегфолт, возникающий, когда источник словаря содержит функцию с некорректными данными. [#73535](https://github.com/ClickHouse/ClickHouse/pull/73535) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлены повторные попытки при неудачной вставке в хранилище `S3(Azure)Queue`. Закрывает [#70951](https://github.com/ClickHouse/ClickHouse/issues/70951). [#73546](https://github.com/ClickHouse/ClickHouse/pull/73546) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка в функции `tupleElement`, которая могла возникать в некоторых случаях для кортежей с элементами типа `LowCardinality` при включённой настройке `optimize_functions_to_subcolumns`. [#73548](https://github.com/ClickHouse/ClickHouse/pull/73548) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен разбор glob-шаблона для enum, за которым следует диапазон. Исправляет [#73473](https://github.com/ClickHouse/ClickHouse/issues/73473). [#73569](https://github.com/ClickHouse/ClickHouse/pull/73569) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлено игнорирование parallel&#95;replicas&#95;for&#95;non&#95;replicated&#95;merge&#95;tree в подзапросах для нереплицированных таблиц. [#73584](https://github.com/ClickHouse/ClickHouse/pull/73584) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправление `std::logical_error`, возникающей при невозможности запланировать задачу. Обнаружено в стресс‑тестах. Пример трассировки стека: `2024.12.19 02:05:46.171833 [ 18190 ] {01f0daba-d3cc-4898-9e0e-c2c263306427} <Fatal> : Logical error: 'std::exception. Code: 1001, type: std::__1::future_error, e.what() = The associated promise has been destructed prior to the associated state becoming ready. (version 25.1.1.18724), Stack trace:.` [#73629](https://github.com/ClickHouse/ClickHouse/pull/73629) ([Alexander Gololobov](https://github.com/davenger)).
* Не интерпретировать запросы в `EXPLAIN SYNTAX`, чтобы избежать логических ошибок, связанных с некорректным этапом обработки распределённых запросов. Исправление [#65205](https://github.com/ClickHouse/ClickHouse/issues/65205). [#73634](https://github.com/ClickHouse/ClickHouse/pull/73634) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена возможная несогласованность данных в Dynamic column. Устранена потенциальная логическая ошибка `Nested columns sizes are inconsistent with local_discriminators column size`. [#73644](https://github.com/ClickHouse/ClickHouse/pull/73644) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка `NOT_FOUND_COLUMN_IN_BLOCK` в запросах с `FINAL` и `SAMPLE`. Исправлен некорректный результат в запросах `SELECT` с `FINAL` из `CollapsingMergeTree` и включены оптимизации `FINAL`. [#73682](https://github.com/ClickHouse/ClickHouse/pull/73682) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка в `LIMIT BY COLUMNS`. [#73686](https://github.com/ClickHouse/ClickHouse/pull/73686) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена ошибка, при которой при принудительном использовании обычной проекции и полном совпадении запроса с определением проекции сама проекция не выбиралась, что приводило к ошибке. [#73700](https://github.com/ClickHouse/ClickHouse/pull/73700) ([Shichao Jin](https://github.com/jsc0218)).
* Исправлена десериализация структур Dynamic/Object. Это могло приводить к исключениям CANNOT&#95;READ&#95;ALL&#95;DATA. [#73767](https://github.com/ClickHouse/ClickHouse/pull/73767) ([Pavel Kruglov](https://github.com/Avogar)).
* Пропускать `metadata_version.txt` при восстановлении частей из резервной копии. [#73768](https://github.com/ClickHouse/ClickHouse/pull/73768) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена ошибка [#73737](https://github.com/ClickHouse/ClickHouse/issues/73737). [#73775](https://github.com/ClickHouse/ClickHouse/pull/73775) ([zhanglistar](https://github.com/zhanglistar)).
* Исправляет [#72078](https://github.com/ClickHouse/ClickHouse/issues/72078) (поддержка S3 Express не работала). [#73777](https://github.com/ClickHouse/ClickHouse/pull/73777) ([Sameer Tamsekar](https://github.com/stamsekar)).
* Разрешено объединение строк с некорректными значениями столбца `sign` в таблицах `CollapsingMergeTree`. [#73864](https://github.com/ClickHouse/ClickHouse/pull/73864) ([Christoph Wurm](https://github.com/cwurm)).
* Исправлена следующая ошибка: `Row 1: ────── hostname: c-test-wy-37-server-nlkyjyb-0.c-test-wy-37-server-headless.ns-test-wy-37.svc.cluster.local type: ExceptionWhileProcessing event_date: 2024-12-23 event_time: 2024-12-23 16:21:19 event_time_microseconds: 2024-12-23 16:21:19.824624 query_start_time: 2024-12-23 16:21:19 query_start_time_microseconds: 2024-12-23 16:21:19.747142 query_duration_ms: 77 read_rows: 1 read_bytes: 134 written_rows: 0 written_bytes: 0 result_rows: 0 result_bytes: 0 memory_usage: 7824 current_database: default query: CREATE DATABASE db0 formatted_query: normalized_query_hash: 7820917191074023511 -- 7.82 quintillion query_kind: Create databases: ['db0'] tables: [] columns: [] partitions: [] projections: [] views: [] exception_code: 170 exception: Code: 170. DB::Exception: Bad get: has Null, requested Int64: While executing DDLOnClusterQueryStatus. (BAD_GET) (version 25.1.1.19134 (official build)) stack_trace: 0. ./build_docker/./src/Common/Exception.cpp:107: DB::Exception::Exception(DB::Exception::MessageMasked&&, int, bool) @ 0x000000000da5e53b 1. DB::Exception::Exception(PreformattedMessage&&, int) @ 0x00000000088aca4c 2. DB::Exception::Exception<std::basic_string_view<char, std::char_traits<char>>, std::basic_string_view<char, std::char_traits<char>>>(int, FormatStringHelperImpl<std::type_identity<std::basic_string_view<char, std::char_traits<char>>>::type, std::type_identity<std::basic_string_view<char, std::char_traits<char>>>::type>, std::basic_string_view<char, std::char_traits<char>>&&, std::basic_string_view<char, std::char_traits<char>>&&) @ 0x00000000088bae8b 3. auto& DB::Field::safeGet<long>() & @ 0x0000000008a3c748 4. ./src/Core/Field.h:484: DB::ColumnVector<long>::insert(DB::Field const&) @ 0x0000000012e44c0f 5. ./build_docker/./src/Interpreters/DDLOnClusterQueryStatusSource.cpp:53: DB::DDLOnClusterQueryStatusSource::generateChunkWithUnfinishedHosts() const @ 0x0000000012a40214 6. ./build_docker/./src/Interpreters/DDLOnClusterQueryStatusSource.cpp:104: DB::DDLOnClusterQueryStatusSource::handleTimeoutExceeded() @ 0x0000000012a41640 7. ./build_docker/./src/Interpreters/DDLOnClusterQueryStatusSource.cpp:109: DB::DDLOnClusterQueryStatusSource::stopWaitingOfflineHosts() @ 0x0000000012a41be9 8. ./build_docker/./src/Interpreters/DistributedQueryStatusSource.cpp:182: DB::DistributedQueryStatusSource::generate() @ 0x0000000011feb3bf 9. ./build_docker/./src/Processors/ISource.cpp:139: DB::ISource::tryGenerate() @ 0x0000000014148f5b 10. ./build_docker/./src/Processors/ISource.cpp:108: DB::ISource::work() @ 0x0000000014148c47 11. ./build_docker/./src/Processors/Executors/ExecutionThreadContext.cpp:49: DB::ExecutionThreadContext::executeTask() @ 0x0000000014164fc7 12. ./build_docker/./src/Processors/Executors/PipelineExecutor.cpp:290: DB::PipelineExecutor::executeStepImpl(unsigned long, std::atomic<bool>*) @ 0x00000000141577e5`. [#73876](https://github.com/ClickHouse/ClickHouse/pull/73876) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлена периодически возникающая невозможность сравнения типов `map()` из-за возможности создать `Map` без явного именования (`keys`, `values`) его вложенного кортежа. [#73878](https://github.com/ClickHouse/ClickHouse/pull/73878) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Игнорировать оконные функции при разборе предложения GROUP BY ALL. Исправляет [#73501](https://github.com/ClickHouse/ClickHouse/issues/73501). [#73916](https://github.com/ClickHouse/ClickHouse/pull/73916) ([Dmitry Novik](https://github.com/novikd)).
* Корректно передавать настройки формата Native при взаимодействии клиент-сервер. [#73924](https://github.com/ClickHouse/ClickHouse/pull/73924) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлены неявные привилегии (ранее действовали как подстановочный шаблон). [#73932](https://github.com/ClickHouse/ClickHouse/pull/73932) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено повышенное потребление памяти при создании вложенных типов данных Map. [#73982](https://github.com/ClickHouse/ClickHouse/pull/73982) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен парсинг вложенного JSON с пустыми ключами. [#73993](https://github.com/ClickHouse/ClickHouse/pull/73993) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправление: псевдоним мог не добавляться в проекцию, если на него ссылался другой псевдоним и он выбирался в обратном порядке. [#74033](https://github.com/ClickHouse/ClickHouse/pull/74033) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Диск, использующий метаданные plain&#95;rewritable, может совместно использоваться несколькими экземплярами сервера. Предполагается, что один экземпляр будет читать объект метаданных, пока другой его изменяет. Ошибки «Object not found» игнорируются во время инициализации plain&#95;rewritable с хранилищем Azure, аналогично поведению, реализованному для S3. [#74059](https://github.com/ClickHouse/ClickHouse/pull/74059) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлено поведение функций `any` и `anyLast` с типами `Enum` и пустой таблицей. [#74061](https://github.com/ClickHouse/ClickHouse/pull/74061) ([Joanna Hulboj](https://github.com/jh0x)).
* Исправляет проблему, возникающую при указании пользователем именованных аргументов в движке таблиц Kafka. [#74064](https://github.com/ClickHouse/ClickHouse/pull/74064) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлено изменение настроек хранилища `S3Queue` с префиксом &quot;s3queue&#95;&quot; на вариант без него и наоборот. [#74075](https://github.com/ClickHouse/ClickHouse/pull/74075) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена настройка `allow_push_predicate_ast_for_distributed_subqueries`. Она включает основанный на AST push-down предикатов для распределённых запросов с анализатором. Это временное решение, которое используется до появления поддержки распределённых запросов с сериализацией плана запроса. Исправляет [#66878](https://github.com/ClickHouse/ClickHouse/issues/66878) [#69472](https://github.com/ClickHouse/ClickHouse/issues/69472) [#65638](https://github.com/ClickHouse/ClickHouse/issues/65638) [#68030](https://github.com/ClickHouse/ClickHouse/issues/68030) [#73718](https://github.com/ClickHouse/ClickHouse/issues/73718). [#74085](https://github.com/ClickHouse/ClickHouse/pull/74085) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправляет проблему, из-за которой после [#73095](https://github.com/ClickHouse/ClickHouse/issues/73095) порт может присутствовать в поле forwarded&#95;for, что приводит к невозможности разрешить имя хоста с указанным портом. [#74116](https://github.com/ClickHouse/ClickHouse/pull/74116) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлено некорректное форматирование запроса `ALTER TABLE (DROP STATISTICS ...) (DROP STATISTICS ...)`. [#74126](https://github.com/ClickHouse/ClickHouse/pull/74126) ([Han Fei](https://github.com/hanfei1991)).
* Исправление для задачи [#66112](https://github.com/ClickHouse/ClickHouse/issues/66112). [#74128](https://github.com/ClickHouse/ClickHouse/pull/74128) ([Anton Ivashkin](https://github.com/ianton-ru)).
* Больше нельзя использовать `Loop` как движок таблицы в `CREATE TABLE`. Ранее такая комбинация приводила к сегфолтам. [#74137](https://github.com/ClickHouse/ClickHouse/pull/74137) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена уязвимость, предотвращающая SQL‑инъекции в табличных функциях `postgresql` и `sqlite`. [#74144](https://github.com/ClickHouse/ClickHouse/pull/74144) ([Pablo Marcos](https://github.com/pamarcos)).
* Исправлено падение при чтении подстолбца из сжатой таблицы движка Memory. Исправляет [#74009](https://github.com/ClickHouse/ClickHouse/issues/74009). [#74161](https://github.com/ClickHouse/ClickHouse/pull/74161) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлен бесконечный цикл, возникавший при запросах к system.detached&#95;tables. [#74190](https://github.com/ClickHouse/ClickHouse/pull/74190) ([Konstantin Morозов](https://github.com/k-morozov)).
* Исправлена логическая ошибка в `s3queue` при пометке файла как неуспешно обработанного. [#74216](https://github.com/ClickHouse/ClickHouse/pull/74216) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Проверка неподдерживаемых типов для некоторых хранилищ. [#74218](https://github.com/ClickHouse/ClickHouse/pull/74218) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен сбой при выполнении запроса `INSERT INTO SELECT` через интерфейс PostgreSQL на macOS (проблема [#72938](https://github.com/ClickHouse/ClickHouse/issues/72938)). [#74231](https://github.com/ClickHouse/ClickHouse/pull/74231) ([Artem Yurov](https://github.com/ArtemYurov)).
* Исправлены настройки нативного копирования (`allow_s3_native_copy`/`allow_azure_native_copy`) для `RESTORE` из базовой резервной копии. [#74286](https://github.com/ClickHouse/ClickHouse/pull/74286) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема, возникавшая, когда количество отсоединённых таблиц в базе данных было кратно `max_block_size`. [#74289](https://github.com/ClickHouse/ClickHouse/pull/74289) ([Konstantin Morozov](https://github.com/k-morozov)).
* Исправлено копирование через ObjectStorage (например, S3), когда учетные данные источника и назначения отличаются. [#74331](https://github.com/ClickHouse/ClickHouse/pull/74331) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема с неинициализированным значением `max_log_ptr` в реплицируемой базе данных. [#74336](https://github.com/ClickHouse/ClickHouse/pull/74336) ([Konstantin Morozov](https://github.com/k-morozov)).
* Исправлено определение параметра «use the Rewrite method in the JSON API» для нативного копирования в GCS. [#74338](https://github.com/ClickHouse/ClickHouse/pull/74338) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен сбой при вставке значения типа `INTERVAL` (issue [#74299](https://github.com/ClickHouse/ClickHouse/issues/74299)). [#74478](https://github.com/ClickHouse/ClickHouse/pull/74478) ([NamNguyenHoai](https://github.com/NamHoaiNguyen)).
* Исправлен некорректный анализ проекций при использовании `count(nullable)` в агрегатных проекциях. Это исправляет [#74495](https://github.com/ClickHouse/ClickHouse/issues/74495). Этот PR также добавляет дополнительные логи, связанные с анализом проекций, чтобы прояснить, почему проекция используется или не используется. [#74498](https://github.com/ClickHouse/ClickHouse/pull/74498) ([Amos Bird](https://github.com/amosbird)).
* Исправлен некорректный расчёт `BackgroundMergesAndMutationsPoolSize` (он был в 2 раза больше фактического значения). [#74509](https://github.com/ClickHouse/ClickHouse/pull/74509) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка, приводившая к утечке `keeper watches` при включении Cluster Discovery. [#74521](https://github.com/ClickHouse/ClickHouse/pull/74521) ([RinChanNOW](https://github.com/RinChanNOWWW)).
* Исправлено форматирование константных JSON-литералов. Ранее это могло приводить к синтаксическим ошибкам при отправке запроса на другой сервер. [#74533](https://github.com/ClickHouse/ClickHouse/pull/74533) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена проблема с выравниванием памяти, обнаруженная UBSan [#74512](https://github.com/ClickHouse/ClickHouse/issues/74512). [#74534](https://github.com/ClickHouse/ClickHouse/pull/74534) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлена конкурентная очистка KeeperMap во время создания таблицы. [#74568](https://github.com/ClickHouse/ClickHouse/pull/74568) ([Antonio Andelic](https://github.com/antonio2368)).
* Не удаляйте неиспользуемые столбцы проекции в подзапросах при наличии `EXCEPT` или `INTERSECT`, чтобы сохранить корректный результат запроса. Исправлено в [#73930](https://github.com/ClickHouse/ClickHouse/issues/73930). Исправлено в [#66465](https://github.com/ClickHouse/ClickHouse/issues/66465). [#74577](https://github.com/ClickHouse/ClickHouse/pull/74577) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена ошибка в запросе `CREATE` при использовании константных выражений секции `PARTITION` с включёнными неявными проекциями. Это исправляет [#74596](https://github.com/ClickHouse/ClickHouse/issues/74596). [#74634](https://github.com/ClickHouse/ClickHouse/pull/74634) ([Amos Bird](https://github.com/amosbird)).
* Исправлена работа запросов `INSERT SELECT` между таблицами с колонками типа `Tuple` при включённой разрежённой сериализации. [#74698](https://github.com/ClickHouse/ClickHouse/pull/74698) ([Anton Popov](https://github.com/CurtizJ)).
* Функция `right` некорректно работала при константном отрицательном смещении. [#74701](https://github.com/ClickHouse/ClickHouse/pull/74701) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлена проблема, из-за которой вставка данных в формате gzip иногда завершалась неудачно из-за некорректной декомпрессии на стороне клиента. [#74707](https://github.com/ClickHouse/ClickHouse/pull/74707) ([siyuan](https://github.com/linkwk7)).
* Не оставлять соединение в некорректном состоянии после завершения `INSERT` с исключением. [#74740](https://github.com/ClickHouse/ClickHouse/pull/74740) ([Azat Khuzhin](https://github.com/azat)).
* Избегайте повторного использования соединений, оставленных в промежуточном состоянии. [#74749](https://github.com/ClickHouse/ClickHouse/pull/74749) ([Azat Khuzhin](https://github.com/azat)).
* Частичное отозвание привилегий с использованием шаблонов (wildcard grants) могло снимать больше привилегий, чем ожидалось. Закрывает [#74263](https://github.com/ClickHouse/ClickHouse/issues/74263). [#74751](https://github.com/ClickHouse/ClickHouse/pull/74751) ([pufit](https://github.com/pufit)).
* Исправлен сбой при разборе объявления типа JSON, если имя типа указано не прописными буквами. [#74784](https://github.com/ClickHouse/ClickHouse/pull/74784) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправление в Keeper: устранена ошибка чтения записей журнала с диска. [#74785](https://github.com/ClickHouse/ClickHouse/pull/74785) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена проверка прав для SYSTEM REFRESH/START/STOP VIEW: теперь для выполнения запроса для конкретного представления не требуется иметь это право на `*.*`, достаточно права только на это представление. [#74789](https://github.com/ClickHouse/ClickHouse/pull/74789) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Функция `hasColumnInTable` не учитывает столбцы-алиасы. Исправлена, чтобы также работать со столбцами-алиасами. [#74841](https://github.com/ClickHouse/ClickHouse/pull/74841) ([Bharat Nallan](https://github.com/bharatnc)).
* Keeper: исправлена ошибка `LOGICAL_ERROR`, возникавшая при разрыве соединения до его установления. [#74844](https://github.com/ClickHouse/ClickHouse/pull/74844) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлено поведение, из‑за которого сервер не мог запуститься при наличии таблицы, использующей `AzureBlobStorage`. Таблицы теперь загружаются без каких‑либо обращений к Azure. [#74880](https://github.com/ClickHouse/ClickHouse/pull/74880) ([Alexey Katsman](https://github.com/alexkats)).
* Исправлена проблема с отсутствующими полями `used_privileges` и `missing_privileges` в `query_log` для операций BACKUP и RESTORE. [#74887](https://github.com/ClickHouse/ClickHouse/pull/74887) ([Alexey Katsman](https://github.com/alexkats)).
* Исправлена ошибка FILE&#95;DOESNT&#95;EXIST, возникающая при слиянии частей данных для таблицы с пустым столбцом в Azure Blob Storage. [#74892](https://github.com/ClickHouse/ClickHouse/pull/74892) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлено имя столбца проекции при объединении с временными таблицами, закрыто [#68872](https://github.com/ClickHouse/ClickHouse/issues/68872). [#74897](https://github.com/ClickHouse/ClickHouse/pull/74897) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Обновление krb ticket в HDFS при ошибке sasl во время запроса hdfs select. [#74930](https://github.com/ClickHouse/ClickHouse/pull/74930) ([inv2004](https://github.com/inv2004)).
* Исправлены запросы к базе данных Replicated в `startup_scripts`. [#74942](https://github.com/ClickHouse/ClickHouse/pull/74942) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены проблемы с выражениями с псевдонимами типов в предложении JOIN ON при использовании null-safe сравнения. [#74970](https://github.com/ClickHouse/ClickHouse/pull/74970) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Состояние части теперь возвращается из deleting обратно в outdated, если операция remove завершилась неудачно. [#74985](https://github.com/ClickHouse/ClickHouse/pull/74985) ([Sema Checherinda](https://github.com/CheSema)).
* В предыдущих версиях при наличии скалярного подзапроса мы начинали отправлять данные о прогрессе (накопленные при обработке подзапроса) во время инициализации формата данных, то есть до отправки HTTP-заголовков. Это приводило к потере HTTP-заголовков, таких как X-ClickHouse-QueryId и X-ClickHouse-Format, а также Content-Type. [#74991](https://github.com/ClickHouse/ClickHouse/pull/74991) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлены запросы `CREATE TABLE AS...` при `database_replicated_allow_replicated_engine_arguments=0`. [#75000](https://github.com/ClickHouse/ClickHouse/pull/75000) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлено оставление соединения клиентом в некорректном состоянии после исключений при INSERT. [#75030](https://github.com/ClickHouse/ClickHouse/pull/75030) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена аварийная остановка из-за необработанного исключения в репликации PSQL. [#75062](https://github.com/ClickHouse/ClickHouse/pull/75062) ([Azat Khuzhin](https://github.com/azat)).
* Sasl может завершить неудачей любой RPC‑вызов; это исправление позволяет повторить вызов, если срок действия krb5‑тикета истёк. [#75063](https://github.com/ClickHouse/ClickHouse/pull/75063) ([inv2004](https://github.com/inv2004)).
* Исправлено использование индексов (первичных и вторичных) для столбцов типов `Array`, `Map` и `Nullable(..)` при включённой настройке `optimize_function_to_subcolumns`. Ранее индексы для этих столбцов могли игнорироваться. [#75081](https://github.com/ClickHouse/ClickHouse/pull/75081) ([Anton Popov](https://github.com/CurtizJ)).
* Отключайте `flatten_nested` при создании материализованных представлений с внутренними таблицами, так как использовать такие «сплющенные» столбцы будет невозможно. [#75085](https://github.com/ClickHouse/ClickHouse/pull/75085) ([Christoph Wurm](https://github.com/cwurm)).
* Исправлена некорректная интерпретация некоторых IPv6-адресов (таких как ::ffff:1.1.1.1) в поле forwarded&#95;for, приводившая к разрыву соединения с клиентом с выбросом исключения. [#75133](https://github.com/ClickHouse/ClickHouse/pull/75133) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена обработка null-safe JOIN для допускающего значения NULL типа данных LowCardinality. Ранее JOIN ON с null-safe-сравнением, таким как `IS NOT DISTINCT FROM`, `<=>`, `a IS NULL AND b IS NULL OR a == b`, некорректно работал с колонками LowCardinality. [#75143](https://github.com/ClickHouse/ClickHouse/pull/75143) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлены запросы с неиспользуемой интерполяцией с помощью нового анализатора. [#75173](https://github.com/ClickHouse/ClickHouse/pull/75173) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлена ошибка, приводившая к сбою CTE с INSERT. [#75188](https://github.com/ClickHouse/ClickHouse/pull/75188) ([Shichao Jin](https://github.com/jsc0218)).
* Исправление в Keeper: предотвращена запись в повреждённые журналы изменений при откате журналов. [#75197](https://github.com/ClickHouse/ClickHouse/pull/75197) ([Antonio Andelic](https://github.com/antonio2368)).
* Использовать `BFloat16` как супертип там, где это целесообразно. Исправляет: [#74404](https://github.com/ClickHouse/ClickHouse/issues/74404). [#75236](https://github.com/ClickHouse/ClickHouse/pull/75236) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлены неожиданные значения по умолчанию в результате `JOIN` при использовании `any_join_distinct_right_table_keys` и оператора `OR` в `JOIN ON`. [#75262](https://github.com/ClickHouse/ClickHouse/pull/75262) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Скрытие учетных данных движка таблиц azureblobstorage. [#75319](https://github.com/ClickHouse/ClickHouse/pull/75319) ([Garrett Thomas](https://github.com/garrettthomaskth)).
* Исправлено поведение, при котором ClickHouse мог ошибочно выполнять проталкивание фильтра (filter pushdown) во внешнюю базу данных, такую как PostgreSQL, MySQL или SQLite. Исправление закрывает: [#71423](https://github.com/ClickHouse/ClickHouse/issues/71423). [#75320](https://github.com/ClickHouse/ClickHouse/pull/75320) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлено падение в кэше схем Protobuf, которое могло происходить при выводе в формате Protobuf и параллельном выполнении запроса `SYSTEM DROP FORMAT SCHEMA CACHE`. [#75357](https://github.com/ClickHouse/ClickHouse/pull/75357) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена возможная логическая ошибка или проблема с неинициализированной памятью при проталкивании фильтра из `HAVING` в режиме параллельных реплик. [#75363](https://github.com/ClickHouse/ClickHouse/pull/75363) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Скрытие конфиденциальной информации для табличных функций и движков таблиц `icebergS3` и `icebergAzure`. [#75378](https://github.com/ClickHouse/ClickHouse/pull/75378) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Функция `TRIM` с вычисляемыми пустыми символами для обрезки теперь обрабатывается корректно. Пример: `SELECT TRIM(LEADING concat('') FROM 'foo')` (Issue [#69922](https://github.com/ClickHouse/ClickHouse/issues/69922)). [#75399](https://github.com/ClickHouse/ClickHouse/pull/75399) ([Manish Gill](https://github.com/mgill25)).
* Исправлена гонка данных в IOutputFormat. [#75448](https://github.com/ClickHouse/ClickHouse/pull/75448) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена возможная ошибка `Elements ... and ... of Nested data structure ... (Array columns) have different array sizes` при использовании подстолбцов JSON с типом `Array` в `JOIN` по распределённым таблицам. [#75512](https://github.com/ClickHouse/ClickHouse/pull/75512) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен некорректный расчет размера буфера результата. Закрывает [#70031](https://github.com/ClickHouse/ClickHouse/issues/70031). [#75548](https://github.com/ClickHouse/ClickHouse/pull/75548) ([Konstantин Bogdanov](https://github.com/thevar1able)).
* Исправлено взаимодействие между allow&#95;feature&#95;tier и настройкой compatibility&#95;mergetree. [#75635](https://github.com/ClickHouse/ClickHouse/pull/75635) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено некорректное значение processed&#95;rows в system.s3queue&#95;log при повторной обработке файла. [#75666](https://github.com/ClickHouse/ClickHouse/pull/75666) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Учитывать `materialized_views_ignore_errors`, когда материализованное представление записывает в движок URL и возникает проблема с подключением. [#75679](https://github.com/ClickHouse/ClickHouse/pull/75679) ([Christoph Wurm](https://github.com/cwurm)).
* Исправлены редкие сбои при чтении из таблицы `MergeTree` после нескольких асинхронных запросов `RENAME` (с `alter_sync = 0`), переименовывавших столбцы с разными типами. [#75693](https://github.com/ClickHouse/ClickHouse/pull/75693) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка `Block structure mismatch in QueryPipeline stream` при выполнении некоторых запросов с `UNION ALL`. [#75715](https://github.com/ClickHouse/ClickHouse/pull/75715) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* При изменении столбца первичного ключа проекции с помощью `ALTER MODIFY` она теперь перестраивается. Ранее это могло приводить к ошибкам `CANNOT_READ_ALL_DATA` при выполнении `SELECT` после `ALTER MODIFY` столбца, используемого в первичном ключе проекции. [#75720](https://github.com/ClickHouse/ClickHouse/pull/75720) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен некорректный результат `ARRAY JOIN` для скалярных подзапросов (с анализатором). [#75732](https://github.com/ClickHouse/ClickHouse/pull/75732) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка разыменования нулевого указателя в `DistinctSortedStreamTransform`. [#75734](https://github.com/ClickHouse/ClickHouse/pull/75734) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлено поведение параметра `allow_suspicious_ttl_expressions`. [#75771](https://github.com/ClickHouse/ClickHouse/pull/75771) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Исправлено чтение неинициализированной памяти в функции `translate`. Это исправление закрывает [#75592](https://github.com/ClickHouse/ClickHouse/issues/75592). [#75794](https://github.com/ClickHouse/ClickHouse/pull/75794) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Распространять настройки формата на JSON при форматировании строк в формате Native. [#75832](https://github.com/ClickHouse/ClickHouse/pull/75832) ([Pavel Kruglov](https://github.com/Avogar)).
* Зафиксировано включение алгоритма соединения parallel hash по умолчанию в версии v24.12 в журнале изменений настроек. Это означает, что ClickHouse будет продолжать выполнять соединения, используя непараллельный hash, если настроен уровень совместимости ниже v24.12. [#75870](https://github.com/ClickHouse/ClickHouse/pull/75870) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена ошибка, из-за которой таблицы с неявно добавленными min-max-индексами нельзя было скопировать в новую таблицу (issue [#75677](https://github.com/ClickHouse/ClickHouse/issues/75677)). [#75877](https://github.com/ClickHouse/ClickHouse/pull/75877) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* `clickhouse-library-bridge` позволяет открывать произвольные библиотеки из файловой системы, поэтому его безопасно запускать только в изолированной среде. Чтобы предотвратить уязвимость при запуске рядом с clickhouse-server, мы ограничим пути к библиотекам расположением, указанным в конфигурации. Эта уязвимость была обнаружена в рамках [ClickHouse Bug Bounty Program](https://github.com/ClickHouse/ClickHouse/issues/38986) **Арсением Дугиным**. [#75954](https://github.com/ClickHouse/ClickHouse/pull/75954) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Так получилось, что мы использовали сериализацию в JSON для части метаданных, что было ошибкой, потому что JSON не поддерживает бинарные данные внутри строковых литералов, включая нулевые байты. SQL‑запросы могут содержать бинарные данные и некорректный UTF‑8, поэтому мы должны поддерживать это и в наших файлах метаданных. В то же время форматы ClickHouse `JSONEachRow` и подобные обходят это ограничение, отклоняясь от стандарта JSON ради идеального обратимого преобразования бинарных данных. Обоснование см. здесь: [https://github.com/ClickHouse/ClickHouse/pull/73668#issuecomment-2560501790](https://github.com/ClickHouse/ClickHouse/pull/73668#issuecomment-2560501790). Решение заключается в том, чтобы сделать библиотеку `Poco::JSON` согласованной с форматом сериализации JSON в ClickHouse. Это закрывает [#73668](https://github.com/ClickHouse/ClickHouse/issues/73668). [#75963](https://github.com/ClickHouse/ClickHouse/pull/75963) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка `Part <...> does not contain in snapshot of previous virtual parts. (PART_IS_TEMPORARILY_LOCKED)` при выполнении DETACH PART. [#76039](https://github.com/ClickHouse/ClickHouse/pull/76039) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Исправлена проверка ограничений на фиксацию в хранилище `S3Queue`. [#76104](https://github.com/ClickHouse/ClickHouse/pull/76104) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено присоединение таблиц MergeTree с автоиндексами (`add_minmax_index_for_numeric_columns`/`add_minmax_index_for_string_columns`). [#76139](https://github.com/ClickHouse/ClickHouse/pull/76139) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема, из-за которой не выводились stack trace&#39;ы из родительских потоков job&#39;а (настройка `enable_job_stack_trace`). Исправлена проблема, при которой настройка `enable_job_stack_trace` некорректно распространялась на потоки, в результате чего содержимое stack trace&#39;ов не всегда соответствовало этому значению. [#76191](https://github.com/ClickHouse/ClickHouse/pull/76191) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена работа `reinterpretAs` с `FixedString` на архитектуре big-endian. [#76253](https://github.com/ClickHouse/ClickHouse/pull/76253) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены всевозможные ошибки, вызванные гонкой между UUID и именами таблиц (например, это устраняет гонку между `RENAME` и `RESTART REPLICA`: в случае одновременного выполнения `RENAME` и `SYSTEM RESTART REPLICA` вы могли в итоге перезапустить неправильную реплику и/или оставить одну из таблиц в состоянии `Table X is being restarted`). [#76308](https://github.com/ClickHouse/ClickHouse/pull/76308) ([Azat Khuzhin](https://github.com/azat)).
* Убрано выделение памяти из обработчика сигнала. [#76446](https://github.com/ClickHouse/ClickHouse/pull/76446) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена обработка неожиданных ошибок при вытеснении при динамическом изменении размера файлового кэша. [#76466](https://github.com/ClickHouse/ClickHouse/pull/76466) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена инициализация `used_flag` в параллельном хеше. Это могло привести к сбою сервера. [#76580](https://github.com/ClickHouse/ClickHouse/pull/76580) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена логическая ошибка при вызове функции `defaultProfiles()` внутри проекции. [#76627](https://github.com/ClickHouse/ClickHouse/pull/76627) ([pufit](https://github.com/pufit)).
* Не запрашивать интерактивную базовую аутентификацию в браузере в Web UI. Закрывает [#76319](https://github.com/ClickHouse/ClickHouse/issues/76319). [#76637](https://github.com/ClickHouse/ClickHouse/pull/76637) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено исключение THERE&#95;IS&#95;NO&#95;COLUMN при выборе булевого литерала из распределённых таблиц. [#76656](https://github.com/ClickHouse/ClickHouse/pull/76656) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Подкаталог внутри каталога таблицы теперь выбирается более продуманным образом. [#76681](https://github.com/ClickHouse/ClickHouse/pull/76681) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлена ошибка `Not found column in block`, возникавшая после изменения таблицы с подстолбцом в первичном ключе. После [https://github.com/ClickHouse/ClickHouse/pull/72644](https://github.com/ClickHouse/ClickHouse/pull/72644) требуется [https://github.com/ClickHouse/ClickHouse/pull/74403](https://github.com/ClickHouse/ClickHouse/pull/74403). [#76686](https://github.com/ClickHouse/ClickHouse/pull/76686) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлены тесты производительности для короткого замыкания при `NULL` и исправлены ошибки. [#76708](https://github.com/ClickHouse/ClickHouse/pull/76708) ([李扬](https://github.com/taiyang-li)).
* Сбрасывать выходные буферы записи перед их финализацией. Исправлена ошибка `LOGICAL_ERROR`, возникавшая при финализации некоторых форматов вывода, например `JSONEachRowWithProgressRowOutputFormat`. [#76726](https://github.com/ClickHouse/ClickHouse/pull/76726) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена поддержка двоичного UUID MongoDB ([#74452](https://github.com/ClickHouse/ClickHouse/issues/74452)) - Исправлена проталкивание фильтра `WHERE` в MongoDB при использовании табличной функции ([#72210](https://github.com/ClickHouse/ClickHouse/issues/72210)) - Изменено сопоставление типов MongoDB–ClickHouse таким образом, что двоичный UUID MongoDB может быть разобран только в UUID ClickHouse. Это должно избежать неоднозначностей и неожиданных эффектов в будущем. - Исправлено сопоставление OID с сохранением обратной совместимости. [#76762](https://github.com/ClickHouse/ClickHouse/pull/76762) ([Kirill Nikiforov](https://github.com/allmazz)).
* Исправлена обработка исключений при параллельной десериализации префиксов JSON-подстолбцов. [#76809](https://github.com/ClickHouse/ClickHouse/pull/76809) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено поведение функции lgamma для отрицательных целых чисел. [#76840](https://github.com/ClickHouse/ClickHouse/pull/76840) ([Ilya Kataev](https://github.com/IlyaKataev)).
* Исправлен анализ обратного ключа для явно заданных первичных ключей. Аналогично [#76654](https://github.com/ClickHouse/ClickHouse/issues/76654). [#76846](https://github.com/ClickHouse/ClickHouse/pull/76846) ([Amos Bird](https://github.com/amosbird)).
* Исправлено красивое форматирование значений Bool в формате JSON. [#76905](https://github.com/ClickHouse/ClickHouse/pull/76905) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен возможный сбой из-за некорректного отката JSON-столбца при ошибке во время асинхронных вставок. [#76908](https://github.com/ClickHouse/ClickHouse/pull/76908) ([Pavel Kruglov](https://github.com/Avogar)).
* Ранее `multi_if` мог возвращать столбцы разных типов на этапах планирования и основного выполнения. Это приводило к возникновению кода с неопределённым поведением с точки зрения C++. [#76914](https://github.com/ClickHouse/ClickHouse/pull/76914) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена некорректная сериализация константных nullable-ключей в MergeTree. Это решает проблему [#76939](https://github.com/ClickHouse/ClickHouse/issues/76939). [#76985](https://github.com/ClickHouse/ClickHouse/pull/76985) ([Amos Bird](https://github.com/amosbird)).
* Исправлена сортировка значений `BFloat16`. Исправление закрывает [#75487](https://github.com/ClickHouse/ClickHouse/issues/75487). Исправление закрывает [#75669](https://github.com/ClickHouse/ClickHouse/issues/75669). [#77000](https://github.com/ClickHouse/ClickHouse/pull/77000) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка в JSON с подстолбцом типа `variant` путем добавления проверки, пропускающей эфемерные подстолбцы при проверке согласованности парта. [#72187](https://github.com/ClickHouse/ClickHouse/issues/72187). [#77034](https://github.com/ClickHouse/ClickHouse/pull/77034) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Исправлена ошибка, приводившая к сбою при разборе шаблонов в формате Values при несоответствии типов. [#77071](https://github.com/ClickHouse/ClickHouse/pull/77071) ([Pavel Kruglov](https://github.com/Avogar)).
* Запрещено создавать таблицу EmbeddedRocksDB с подконтрольным столбцом в первичном ключе. Ранее такую таблицу можно было создать, но запросы `SELECT` завершались с ошибкой. [#77074](https://github.com/ClickHouse/ClickHouse/pull/77074) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено некорректное сравнение в распределённых запросах, возникавшее из‑за того, что проталкивание предикатов на удалённые узлы не учитывало типы литералов. [#77093](https://github.com/ClickHouse/ClickHouse/pull/77093) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлено падение при создании таблицы Kafka при возникновении исключения. [#77121](https://github.com/ClickHouse/ClickHouse/pull/77121) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена поддержка нового JSON и подколнок в движках Kafka и RabbitMQ. [#77122](https://github.com/ClickHouse/ClickHouse/pull/77122) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена обработка развёртывания стека исключений в macOS. [#77126](https://github.com/ClickHouse/ClickHouse/pull/77126) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлено чтение подстолбца `null` в функции getSubcolumn. [#77163](https://github.com/ClickHouse/ClickHouse/pull/77163) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлены неработающие пропускающие индексы с выражениями с литералами в анализаторе и удалены тривиальные приведения типов во время анализа индексов. [#77229](https://github.com/ClickHouse/ClickHouse/pull/77229) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена работа индекса bloom filter с `Array` и неподдерживаемыми функциями. [#77271](https://github.com/ClickHouse/ClickHouse/pull/77271) ([Pavel Kruglov](https://github.com/Avogar)).
* Ограничение на количество таблиц следует проверять только во время исходного запроса CREATE. [#77274](https://github.com/ClickHouse/ClickHouse/pull/77274) ([Nikolay Degterinsky](https://github.com/evillique)).
* `SELECT toBFloat16(-0.0) == toBFloat16(0.0)` теперь корректно возвращает `true` (ранее возвращалось `false`). Это делает поведение согласованным с `Float32` и `Float64`. [#77290](https://github.com/ClickHouse/ClickHouse/pull/77290) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Исправлена возможная некорректная ссылка на неинициализированную переменную key&#95;index, которая может приводить к сбою в отладочных сборках (эта неинициализированная ссылка не вызывает проблем в релизных сборках, потому что последующий код, скорее всего, выбросит ошибки). ### Запись в документации для изменений, заметных пользователям. [#77305](https://github.com/ClickHouse/ClickHouse/pull/77305) ([wxybear](https://github.com/wxybear)).
* Изменения отменены. [#77307](https://github.com/ClickHouse/ClickHouse/pull/77307) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено формирование имени партиции для значений типа Bool. Ошибка была внесена в [https://github.com/ClickHouse/ClickHouse/pull/74533](https://github.com/ClickHouse/ClickHouse/pull/74533). [#77319](https://github.com/ClickHouse/ClickHouse/pull/77319) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено сравнение между кортежами с nullable-элементами и строками. Например, до изменения сравнение между кортежем `(1, null)` и строкой `'(1,null)'` приводило к ошибке. Другой пример — сравнение между кортежем `(1, a)`, где `a` — столбец типа Nullable, и строкой `'(1, 2)'`. Это изменение устраняет эти проблемы. [#77323](https://github.com/ClickHouse/ClickHouse/pull/77323) ([Alexey Katsman](https://github.com/alexkats)).
* Исправлен сбой в ObjectStorageQueueSource. Он был внесён в [https://github.com/ClickHouse/ClickHouse/pull/76358](https://github.com/ClickHouse/ClickHouse/pull/76358). [#77325](https://github.com/ClickHouse/ClickHouse/pull/77325) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка, из-за которой параметр запроса `close_session` не оказывал никакого эффекта, и именованные сессии закрывались только после истечения `session_timeout`. [#77336](https://github.com/ClickHouse/ClickHouse/pull/77336) ([Alexey Katsman](https://github.com/alexkats)).
* Исправлена работа `async_insert` с `input()`. [#77340](https://github.com/ClickHouse/ClickHouse/pull/77340) ([Azat Khuzhin](https://github.com/azat)).
* Исправление: `WITH FILL` мог завершаться с ошибкой `NOT_FOUND_COLUMN_IN_BLOCK`, когда планировщик удалял столбец сортировки. Аналогичная проблема была связана с неконсистентным DAG, вычисляемым для выражения `INTERPOLATE`. [#77343](https://github.com/ClickHouse/ClickHouse/pull/77343) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Откат изменений. [#77390](https://github.com/ClickHouse/ClickHouse/pull/77390) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлен приём сообщений от сервера NATS без прикреплённого MV. [#77392](https://github.com/ClickHouse/ClickHouse/pull/77392) ([Dmitry Novikov](https://github.com/dmitry-sles-novikov)).
* Исправлена логическая ошибка при чтении из пустого `FileLog` с помощью табличной функции `merge`, закрыт [#75575](https://github.com/ClickHouse/ClickHouse/issues/75575). [#77441](https://github.com/ClickHouse/ClickHouse/pull/77441) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлено несколько ошибок `LOGICAL_ERROR`, возникавших при установке псевдонима для некорректных узлов AST. [#77445](https://github.com/ClickHouse/ClickHouse/pull/77445) ([Raúl Marín](https://github.com/Algunenano)).
* В реализации кеша файловой системы исправлена обработка ошибок при записи файлового сегмента. [#77471](https://github.com/ClickHouse/ClickHouse/pull/77471) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено: DatabaseIceberg теперь использует корректный файл метаданных, предоставляемый каталогом. Закрывает [#75187](https://github.com/ClickHouse/ClickHouse/issues/75187). [#77486](https://github.com/ClickHouse/ClickHouse/pull/77486) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Использовать настройки формата по умолчанию в динамической сериализации из shared variant. [#77572](https://github.com/ClickHouse/ClickHouse/pull/77572) ([Pavel Kruglov](https://github.com/Avogar)).
* Откат изменения &#39;Avoid toAST() in execution of scalar subqueries&#39;. [#77584](https://github.com/ClickHouse/ClickHouse/pull/77584) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена проверка существования пути к данным таблицы на локальном диске. [#77608](https://github.com/ClickHouse/ClickHouse/pull/77608) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Кэш запросов теперь предполагает, что UDF являются недетерминированными. Соответственно, результаты запросов с UDF больше не кэшируются. Ранее пользователи могли определять недетерминированные UDF, результаты которых ошибочно кэшировались (issue [#77553](https://github.com/ClickHouse/ClickHouse/issues/77553)). [#77633](https://github.com/ClickHouse/ClickHouse/pull/77633) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
* Исправлена отправка константных значений на удалённые серверы для некоторых типов. [#77634](https://github.com/ClickHouse/ClickHouse/pull/77634) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена работа system.filesystem&#95;cache&#95;log, который ранее функционировал только при включённой настройке `enable_filesystem_cache_log`. [#77650](https://github.com/ClickHouse/ClickHouse/pull/77650) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена логическая ошибка при вызове функции `defaultRoles()` внутри проекции. Продолжение задачи [#76627](https://github.com/ClickHouse/ClickHouse/issues/76627). [#77667](https://github.com/ClickHouse/ClickHouse/pull/77667) ([pufit](https://github.com/pufit)).
* Исправлен сбой из‑за просроченного контекста в StorageS3(Azure)Queue. [#77720](https://github.com/ClickHouse/ClickHouse/pull/77720) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Вторые аргументы типа `Nullable` для функции `arrayResize` теперь не допускаются. Ранее при использовании `Nullable` в качестве второго аргумента могли возникать как ошибки, так и некорректные результаты. (issue [#48398](https://github.com/ClickHouse/ClickHouse/issues/48398)). [#77724](https://github.com/ClickHouse/ClickHouse/pull/77724) ([Manish Gill](https://github.com/mgill25)).
* Скрытие учетных данных в движках таблиц RabbitMQ, Nats, Redis, AzureQueue. [#77755](https://github.com/ClickHouse/ClickHouse/pull/77755) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено неопределённое поведение при сравнении значений NaN в ArgMin/ArgMax. [#77756](https://github.com/ClickHouse/ClickHouse/pull/77756) ([Raúl Marín](https://github.com/Algunenano)).
* Регулярно проверять, были ли слияния и мутации отменены, даже в случае, когда операция не порождает блоков для записи. [#77766](https://github.com/ClickHouse/ClickHouse/pull/77766) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Откат изменений. [#77843](https://github.com/ClickHouse/ClickHouse/pull/77843) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлена возможная аварийная остановка при возникновении ошибки `NOT_FOUND_COLUMN_IN_BLOCK`. [#77854](https://github.com/ClickHouse/ClickHouse/pull/77854) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлена ошибка, приводившая к сбою в `StorageSystemObjectStorageQueueSettings` при заполнении данных. [#77878](https://github.com/ClickHouse/ClickHouse/pull/77878) ([Bharat Nallan](https://github.com/bharatnc)).
* Отключен нечеткий поиск по истории в SSH-сервере (так как для него требуется skim). [#78002](https://github.com/ClickHouse/ClickHouse/pull/78002) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, из-за которой запрос векторного поиска по неиндексированному столбцу возвращал некорректные результаты, если в таблице был другой векторный столбец с настроенным индексом векторного сходства. (Issue [#77978](https://github.com/ClickHouse/ClickHouse/issues/77978)). [#78069](https://github.com/ClickHouse/ClickHouse/pull/78069) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Исправлена подсказка `The requested output format {} is binary... Do you want to output it anyway? [y/N]`. [#78095](https://github.com/ClickHouse/ClickHouse/pull/78095) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка в функции `toStartOfInterval` при нулевом аргументе origin. [#78096](https://github.com/ClickHouse/ClickHouse/pull/78096) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Запрещено указывать пустой параметр запроса `session_id` в HTTP-интерфейсе. [#78098](https://github.com/ClickHouse/ClickHouse/pull/78098) ([Alexey Katsman](https://github.com/alexkats)).
* Исправлена ошибка переопределения метаданных в Database Replicated, которая могла возникать при выполнении запроса RENAME сразу после запроса ALTER. [#78107](https://github.com/ClickHouse/ClickHouse/pull/78107) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлено падение в движке NATS. [#78108](https://github.com/ClickHouse/ClickHouse/pull/78108) ([Dmitry Novikov](https://github.com/dmitry-sles-novikov)).
* Не пытайтесь создавать `history_file` во встроенном клиенте для SSH. [#78112](https://github.com/ClickHouse/ClickHouse/pull/78112) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено некорректное отображение информации в `system.detached_tables` после выполнения запросов `RENAME DATABASE` или `DROP TABLE`. [#78126](https://github.com/ClickHouse/ClickHouse/pull/78126) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена проверка на слишком большое количество таблиц в Database Replicated после [https://github.com/ClickHouse/ClickHouse/pull/77274](https://github.com/ClickHouse/ClickHouse/pull/77274). Также проверка теперь выполняется до создания хранилища, чтобы избежать появления неучтённых узлов в ZooKeeper в случае RMT или KeeperMap. [#78127](https://github.com/ClickHouse/ClickHouse/pull/78127) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена возможная авария из-за одновременной инициализации метаданных `S3Queue`. [#78131](https://github.com/ClickHouse/ClickHouse/pull/78131) ([Azat Khuzhin](https://github.com/azat)).
* Функции `groupArray*` теперь выдают ошибку BAD&#95;ARGUMENTS для значения аргумента max&#95;size, равного 0 и имеющего тип Int (как уже было реализовано для типа UInt), вместо попытки выполнить запрос с ним. [#78140](https://github.com/ClickHouse/ClickHouse/pull/78140) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлен сбой в `recoverLostReplica`, возникавший, если локальная таблица удалялась до её отсоединения. [#78173](https://github.com/ClickHouse/ClickHouse/pull/78173) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено поведение столбца `alterable` в `system.s3_queue_settings`, который всегда возвращал `false`. [#78187](https://github.com/ClickHouse/ClickHouse/pull/78187) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Скрыта подпись доступа Azure, чтобы она не отображалась пользователю и в логах. [#78189](https://github.com/ClickHouse/ClickHouse/pull/78189) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена предварительная выборка подстримов с префиксами в Wide-частях. [#78205](https://github.com/ClickHouse/ClickHouse/pull/78205) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлены падения сервера / некорректные результаты функции `mapFromArrays` в случае типа массива ключей `LowCardinality(Nullable)`. [#78240](https://github.com/ClickHouse/ClickHouse/pull/78240) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлены параметры аутентификации ядра Delta. [#78255](https://github.com/ClickHouse/ClickHouse/pull/78255) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Не планировать задачу RefreshMV, если у реплики параметр `disable_insertion_and_mutation` установлен в true. Поскольку задача выполняет вставку, она завершится с ошибкой, если `disable_insertion_and_mutation` установлен в true. [#78277](https://github.com/ClickHouse/ClickHouse/pull/78277) ([Xu Jia](https://github.com/XuJia0210)).
* Проверена корректность прав доступа к базовым таблицам для движка Merge. [#78339](https://github.com/ClickHouse/ClickHouse/pull/78339) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Модификатор FINAL мог теряться для таблицы с движком `Distributed`. [#78428](https://github.com/ClickHouse/ClickHouse/pull/78428) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* `Bitmapmin` возвращает uint32&#95;max, когда bitmap пуст (`uint64_max`, если входной тип ≥ 8 бит), что соответствует поведению пустого `roaring_bitmap` при вызове `minimum()`. [#78444](https://github.com/ClickHouse/ClickHouse/pull/78444) ([wxybear](https://github.com/wxybear)).
* Отмена изменения «Apply preserve&#95;most attribute at some places in code», так как оно может приводить к сбоям. [#78449](https://github.com/ClickHouse/ClickHouse/pull/78449) ([Azat Khuzhin](https://github.com/azat)).
* Использовать вставочные столбцы для вывода схемы при использовании INFILE. [#78490](https://github.com/ClickHouse/ClickHouse/pull/78490) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Отключена параллельная обработка запроса непосредственно после чтения секции `FROM`, когда включён `distributed_aggregation_memory_efficient`, так как это могло приводить к логической ошибке. Закрывает [#76934](https://github.com/ClickHouse/ClickHouse/issues/76934). [#78500](https://github.com/ClickHouse/ClickHouse/pull/78500) ([flynn](https://github.com/ucasfl)).
* Установлен как минимум один поток для чтения на случай, если после применения настройки `max_streams_to_max_threads_ratio` не остается ни одного запланированного потока. [#78505](https://github.com/ClickHouse/ClickHouse/pull/78505) ([Eduard Karacharov](https://github.com/korowa)).
* В хранилище S3Queue исправлена логическая ошибка «Cannot unregister: table uuid is not registered». Закрывает [#78285](https://github.com/ClickHouse/ClickHouse/issues/78285). [#78541](https://github.com/ClickHouse/ClickHouse/pull/78541) ([Kseniia Sumarokova](https://github.com/kssenii)).
* ClickHouse теперь может определять свою cgroup v2 на системах, где одновременно включены cgroups v1 и v2. [#78566](https://github.com/ClickHouse/ClickHouse/pull/78566) ([Grigory Korolev](https://github.com/gkorolev)).
* Табличные функции ObjectStorage cluster завершались с ошибкой при использовании с табличными настройками. [#78587](https://github.com/ClickHouse/ClickHouse/pull/78587) ([Daniil Ivanik](https://github.com/divanik)).
* Более строгие проверки транзакций не поддерживаются ReplicatedMergeTree при `INSERT`. [#78633](https://github.com/ClickHouse/ClickHouse/pull/78633) ([Azat Khuzhin](https://github.com/azat)).
* Применять настройки запроса при прикреплении. [#78637](https://github.com/ClickHouse/ClickHouse/pull/78637) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено падение при указании некорректного пути в `iceberg_metadata_file_path`. [#78688](https://github.com/ClickHouse/ClickHouse/pull/78688) ([alesapin](https://github.com/alesapin)).
* В движке таблиц `DeltaLake` с реализацией на `delta-kernel` исправлена ситуация, когда схема чтения отличается от схемы таблицы и при этом используются столбцы партиционирования, что приводило к ошибке «column not found». [#78690](https://github.com/ClickHouse/ClickHouse/pull/78690) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Это обновление исправляет ошибку, из-за которой новый именованный сеанс непреднамеренно завершался в запланированное время предыдущего, если оба сеанса имели одно и то же имя, а новый был создан до истечения тайм-аута старого. [#78698](https://github.com/ClickHouse/ClickHouse/pull/78698) ([Alexey Katsman](https://github.com/alexkats)).
* Не блокировать остановку таблицы во время выполнения CHECK TABLE. [#78782](https://github.com/ClickHouse/ClickHouse/pull/78782) ([Raúl Marín](https://github.com/Algunenano)).
* Исправление Keeper: во всех случаях скорректирован счетчик эфемерных узлов. [#78799](https://github.com/ClickHouse/ClickHouse/pull/78799) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено некорректное приведение типов в `StorageDistributed` при использовании табличных функций, отличных от `view()`. Закрывает [#78464](https://github.com/ClickHouse/ClickHouse/issues/78464). [#78828](https://github.com/ClickHouse/ClickHouse/pull/78828) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлено форматирование для `tupleElement(*, 1)`. Закрывает [#78639](https://github.com/ClickHouse/ClickHouse/issues/78639). [#78832](https://github.com/ClickHouse/ClickHouse/pull/78832) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Словари типа `ssd_cache` теперь отклоняют нулевые или отрицательные значения параметров `block_size` и `write_buffer_size` (issue [#78314](https://github.com/ClickHouse/ClickHouse/issues/78314)). [#78854](https://github.com/ClickHouse/ClickHouse/pull/78854) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Исправлено падение REFRESHABLE MV при выполнении ALTER после некорректного завершения работы. [#78858](https://github.com/ClickHouse/ClickHouse/pull/78858) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен парсинг некорректных значений типа DateTime в формате CSV. [#78919](https://github.com/ClickHouse/ClickHouse/pull/78919) ([Pavel Kruglov](https://github.com/Avogar)).





## Улучшения сборки/тестирования/упаковки {#build-testing-packaging-improvement}


* Внутренняя зависимость LLVM обновлена с версии 16 до 18. [#66053](https://github.com/ClickHouse/ClickHouse/pull/66053) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Восстановлены удалённые интеграционные тесты nats и исправлены ошибки. - исправлены некоторые состояния гонки в движке nats - исправлена потеря данных при потоковой передаче данных в nats в случае потери соединения - исправлено зависание при получении последнего фрагмента данных после завершения потоковой передачи из nats - nats&#95;max&#95;reconnect устарел и больше не оказывает эффекта, переподключение выполняется постоянно с таймаутом nats&#95;reconnect&#95;wait. [#69772](https://github.com/ClickHouse/ClickHouse/pull/69772) ([Dmitry Novikov](https://github.com/dmitry-sles-novikov)).
* Исправлена проблема, из-за которой не удавалось сгенерировать asm-файлы OpenSSL в директории contrib. [#72622](https://github.com/ClickHouse/ClickHouse/pull/72622) ([RinChanNOW](https://github.com/RinChanNOWWW)).
* Исправлена стабильность теста 03210&#95;variant&#95;with&#95;aggregate&#95;function&#95;type. [#74012](https://github.com/ClickHouse/ClickHouse/pull/74012) ([Anton Ivashkin](https://github.com/ianton-ru)).
* Добавлена поддержка сборки HDFS как на Mac с ARM, так и на Mac с Intel. [#74244](https://github.com/ClickHouse/ClickHouse/pull/74244) ([Yan Xin](https://github.com/yxheartipp)).
* Универсальный скрипт установки теперь предлагает установку и на macOS. [#74339](https://github.com/ClickHouse/ClickHouse/pull/74339) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена сборка при отключённом Kerberos. [#74771](https://github.com/ClickHouse/ClickHouse/pull/74771) ([flynn](https://github.com/ucasfl)).
* Обновлён встроенный LLVM до версии 19. [#75148](https://github.com/ClickHouse/ClickHouse/pull/75148) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* *Потенциально ломающее изменение*: улучшение, задающее ещё более строгие значения по умолчанию. Текущие значения по умолчанию уже безопасны. Пользователь должен явно указать опцию для публикации портов. Но когда у пользователя `default` не задан пароль через переменную окружения `CLICKHOUSE_PASSWORD` и/или имя пользователя не изменено через переменную окружения `CLICKHOUSE_USER`, доступ к нему должен предоставляться только с локальной системы как дополнительный уровень защиты. [#75259](https://github.com/ClickHouse/ClickHouse/pull/75259) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Для интеграционных тестов установлен часовой таймаут на один пакет параллельно выполняемых тестов. Когда этот таймаут истекает, `pytest` принудительно завершается, и часть логов может не успеть записаться. Внутренний таймаут pytest установлен на 55 минут, чтобы успеть вывести результаты сессии и не спровоцировать внешний таймаут. Закрывает [#75532](https://github.com/ClickHouse/ClickHouse/issues/75532). [#75533](https://github.com/ClickHouse/ClickHouse/pull/75533) ([Ilya Yatsishin](https://github.com/qoega)).
* Сделать все действия, связанные с `clickhouse-server`, функцией и выполнять их только при запуске стандартного бинарного файла в `entrypoint.sh`. Давно откладываемое улучшение было предложено в [#50724](https://github.com/ClickHouse/ClickHouse/issues/50724). Добавлен переключатель `--users` в `clickhouse-extract-from-config` для получения значений из `users.xml`. [#75643](https://github.com/ClickHouse/ClickHouse/pull/75643) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Для стресс-тестов, если сервер не завершил работу, пока мы собирали stacktrace с помощью gdb, добавлено дополнительное время ожидания, чтобы сделать обнаружение `Possible deadlock on shutdown (see gdb.log)` менее шумным. Дополнительная задержка будет добавляться только в случаях, когда тест завершился неуспешно. [#75668](https://github.com/ClickHouse/ClickHouse/pull/75668) ([Ilya Yatsishin](https://github.com/qoega)).
* Восстановлены удалённые интеграционные тесты nats и исправлены ошибки. - исправлены некоторые состояния гонки в движке nats - исправлена потеря данных при потоковой передаче в nats в случае потери соединения - исправлено зависание при получении последнего чанка данных после завершения потоковой передачи из nats - `nats_max_reconnect` устарел и больше не оказывает эффекта, переподключение выполняется постоянно с таймаутом `nats_reconnect_wait`. [#75850](https://github.com/ClickHouse/ClickHouse/pull/75850) ([Dmitry Novikov](https://github.com/dmitry-sles-novikov)).
* Включена поддержка ICU и GRPC при кросс-компиляции для Darwin. [#75922](https://github.com/ClickHouse/ClickHouse/pull/75922) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлен разрыв вывода теста из‑за `sleep` во время завершения группы процессов. [#76090](https://github.com/ClickHouse/ClickHouse/pull/76090) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Не собирайте логи `docker-compose` по завершении работы, так как скрипт часто принудительно завершается. Вместо этого собирайте их в фоновом режиме. [#76140](https://github.com/ClickHouse/ClickHouse/pull/76140) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Тесты для хранилища Kafka разбиты на несколько файлов. Исправляет [#69452](https://github.com/ClickHouse/ClickHouse/issues/69452). [#76208](https://github.com/ClickHouse/ClickHouse/pull/76208) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* `clickhouse-odbc-bridge` и `clickhouse-library-bridge` перенесены в отдельный репозиторий: [https://github.com/ClickHouse/odbc-bridge/](https://github.com/ClickHouse/odbc-bridge/). [#76225](https://github.com/ClickHouse/ClickHouse/pull/76225) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Удалено около 20 МБ неиспользуемого кода из бинарника. [#76226](https://github.com/ClickHouse/ClickHouse/pull/76226) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Повышена минимально требуемая версия CMake до 3.25 из-за добавления `block()`. [#76316](https://github.com/ClickHouse/ClickHouse/pull/76316) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Обновлён `fmt` до версии 11.1.3. [#76547](https://github.com/ClickHouse/ClickHouse/pull/76547) ([Raúl Marín](https://github.com/Algunenano)).
* Обновлена версия `lz4` до `1.10.0`. [#76571](https://github.com/ClickHouse/ClickHouse/pull/76571) ([Konstantin Bogdanов](https://github.com/thevar1able)).
* Обновили `curl` до `8.12.1`. [#76572](https://github.com/ClickHouse/ClickHouse/pull/76572) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Обновлена `libcpuid` до версии `0.7.1`. [#76573](https://github.com/ClickHouse/ClickHouse/pull/76573) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Использовать машиночитаемый формат для разбора результатов pytest. [#76910](https://github.com/ClickHouse/ClickHouse/pull/76910) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Исправлена кросс-компиляция Rust и добавлена возможность полностью отключать Rust. [#76921](https://github.com/ClickHouse/ClickHouse/pull/76921) ([Raúl Marín](https://github.com/Algunenano)).
* Для сборки проекта требуется Clang 19. [#76945](https://github.com/ClickHouse/ClickHouse/pull/76945) ([Raúl Marín](https://github.com/Algunenano)).
* Тест выполняется более 10 секунд в последовательном режиме. Это слишком долго для быстрых тестов. [#76948](https://github.com/ClickHouse/ClickHouse/pull/76948) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Обновлена версия `sccache` до `0.10.0`. [#77580](https://github.com/ClickHouse/ClickHouse/pull/77580) ([Konstantin Bogdanов](https://github.com/thevar1able)).
* Учитывать целевые функции CPU в Rust и включить LTO во всех крейтах. [#78590](https://github.com/ClickHouse/ClickHouse/pull/78590) ([Raúl Marín](https://github.com/Algunenano)).
* Обновлена версия `minizip-ng` до `4.0.9`. [#78917](https://github.com/ClickHouse/ClickHouse/pull/78917) ([Konstantin Bogdanov](https://github.com/thevar1able)).
