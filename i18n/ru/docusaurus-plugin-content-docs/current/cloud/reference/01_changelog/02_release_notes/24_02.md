---
slug: /whats-new/changelog/24.2-fast-release
title: 'Журнал изменений v24.2'
description: 'Журнал изменений быстрого релиза v24.2'
keywords: ['журнал изменений']
sidebar_label: '24.2'
sidebar_position: 10
doc_type: 'changelog'
---

### Тег релиза ClickHouse: 24.2.2.15987 \{#clickhouse-release-tag-242215987\}

#### Обратно несовместимое изменение \{#backward-incompatible-change\}

* Теперь выполняется проверка подозрительных/экспериментальных типов во вложенных типах. Ранее такие типы (кроме JSON) не проверялись во вложенных типах, таких как Array/Tuple/Map. [#59385](https://github.com/ClickHouse/ClickHouse/pull/59385) ([Kruglov Pavel](https://github.com/Avogar)).
* Оператор сортировки `ORDER BY ALL` (введённый в v23.12) заменён на `ORDER BY *`. Предыдущий синтаксис слишком часто приводил к ошибкам в таблицах со столбцом `all`. [#59450](https://github.com/ClickHouse/ClickHouse/pull/59450) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена проверка корректности числа потоков и размеров блоков. [#60138](https://github.com/ClickHouse/ClickHouse/pull/60138) ([Raúl Marín](https://github.com/Algunenano)).
* Отклонять входящие `INSERT`-запросы в случае, когда настройки уровня запроса `async_insert` и `deduplicate_blocks_in_dependent_materialized_views` включены одновременно. Это поведение контролируется настройкой `throw_if_deduplication_in_dependent_materialized_views_enabled_with_async_insert` и по умолчанию включено. Это продолжение [https://github.com/ClickHouse/ClickHouse/pull/59699](https://github.com/ClickHouse/ClickHouse/pull/59699), необходимое для разблокировки [https://github.com/ClickHouse/ClickHouse/pull/59915](https://github.com/ClickHouse/ClickHouse/pull/59915). [#60888](https://github.com/ClickHouse/ClickHouse/pull/60888) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Утилита `clickhouse-copier` перенесена в отдельный репозиторий на GitHub: [https://github.com/ClickHouse/copier](https://github.com/ClickHouse/copier). Она больше не включена в дистрибутив, но по-прежнему доступна для отдельной загрузки. Это закрывает: [#60734](https://github.com/ClickHouse/ClickHouse/issues/60734) Это закрывает: [#60540](https://github.com/ClickHouse/ClickHouse/issues/60540) Это закрывает: [#60250](https://github.com/ClickHouse/ClickHouse/issues/60250) Это закрывает: [#52917](https://github.com/ClickHouse/ClickHouse/issues/52917) Это закрывает: [#51140](https://github.com/ClickHouse/ClickHouse/issues/51140) Это закрывает: [#47517](https://github.com/ClickHouse/ClickHouse/issues/47517) Это закрывает: [#47189](https://github.com/ClickHouse/ClickHouse/issues/47189) Это закрывает: [#46598](https://github.com/ClickHouse/ClickHouse/issues/46598) Это закрывает: [#40257](https://github.com/ClickHouse/ClickHouse/issues/40257) Это закрывает: [#36504](https://github.com/ClickHouse/ClickHouse/issues/36504) Это закрывает: [#35485](https://github.com/ClickHouse/ClickHouse/issues/35485) Это закрывает: [#33702](https://github.com/ClickHouse/ClickHouse/issues/33702) Это закрывает: [#26702](https://github.com/ClickHouse/ClickHouse/issues/26702) ### Запись в документации об изменениях, видимых пользователю. [#61058](https://github.com/ClickHouse/ClickHouse/pull/61058) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Для повышения совместимости с MySQL функция `locate` по умолчанию теперь принимает аргументы в порядке `(needle, haystack[, start_pos])`. Предыдущее поведение `(haystack, needle, [, start_pos])` можно восстановить, установив `function_locate_has_mysql_compatible_argument_order = 0`. [#61092](https://github.com/ClickHouse/ClickHouse/pull/61092) ([Robert Schulze](https://github.com/rschu1ze)).
* Устаревшие части данных в памяти были помечены как устаревшие, начиная с версии 23.5, и перестали поддерживаться, начиная с версии 23.10. Теперь оставшийся код удалён. Продолжение [#55186](https://github.com/ClickHouse/ClickHouse/issues/55186) и [#45409](https://github.com/ClickHouse/ClickHouse/issues/45409). Маловероятно, что вы использовали части данных в памяти, поскольку они были доступны только до версии 23.5 и только при ручном включении через указание соответствующих SETTINGS для таблицы MergeTree. Чтобы проверить, есть ли у вас части данных в памяти, выполните следующий запрос: `SELECT part_type, count() FROM system.parts GROUP BY part_type ORDER BY part_type`. Чтобы отключить использование частей данных в памяти, выполните: `ALTER TABLE ... MODIFY SETTING min_bytes_for_compact_part = DEFAULT, min_rows_for_compact_part = DEFAULT`. Перед обновлением со старых релизов ClickHouse сначала убедитесь, что у вас нет частей данных в памяти. Если такие части есть, сначала отключите их, затем дождитесь, пока не останется частей данных в памяти, и продолжайте обновление. [#61127](https://github.com/ClickHouse/ClickHouse/pull/61127) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* По умолчанию запретить использование `SimpleAggregateFunction` в `ORDER BY` таблиц `MergeTree` (аналогично `AggregateFunction`; запрет связан с тем, что такие значения не сравнимы). Для разрешения используйте `allow_suspicious_primary_key`. [#61399](https://github.com/ClickHouse/ClickHouse/pull/61399) ([Azat Khuzhin](https://github.com/azat)).
* ClickHouse допускает произвольные двоичные данные в типе данных String, который обычно содержит данные в UTF-8. Строки в Parquet/ORC/Arrow поддерживают только UTF-8. Поэтому вы можете выбрать, какой тип данных Arrow использовать для типа данных ClickHouse String — String или Binary. Это контролируется настройками `output_format_parquet_string_as_string`, `output_format_orc_string_as_string`, `output_format_arrow_string_as_string`. Хотя Binary был бы более корректным и совместимым вариантом, использование по умолчанию String в большинстве случаев будет соответствовать ожиданиям пользователей. Parquet/ORC/Arrow поддерживают множество методов сжатия, включая lz4 и zstd. ClickHouse поддерживает каждый из этих методов сжатия. Некоторые менее совершенные инструменты не поддерживают более быстрый метод сжатия `lz4`, поэтому по умолчанию мы используем `zstd`. Это контролируется настройками `output_format_parquet_compression_method`, `output_format_orc_compression_method` и `output_format_arrow_compression_method`. Мы изменили значение по умолчанию на `zstd` для Parquet и ORC, но не для Arrow (он предназначен для низкоуровневых сценариев использования). [#61817](https://github.com/ClickHouse/ClickHouse/pull/61817) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправление уязвимости в materialized view, которая позволяла пользователю вставлять данные в таблицу без необходимых на это грантов. Теперь дополнительно проверяется, что у пользователя есть права на вставку не только в materialized view, но и во все лежащие в её основе таблицы. Это означает, что некоторые запросы, которые работали ранее, теперь могут завершаться ошибкой «Not enough privileges». Для решения этой проблемы в этом релизе представлен новый механизм SQL security для представлений [https://clickhouse.com/docs/sql-reference/statements/create/view#sql&#95;security](/sql-reference/statements/create/view#sql_security). [#54901](https://github.com/ClickHouse/ClickHouse/pull/54901) ([pufit](https://github.com/pufit))

#### Новая функция \{#new-feature\}

* Режим topk/topkweighed, возвращающий количество значений и оценку ошибки. [#54508](https://github.com/ClickHouse/ClickHouse/pull/54508) ([UnamedRus](https://github.com/UnamedRus)).
* Добавлен новый синтаксис, который позволяет указать пользователя-определителя (definer) в view/materialized view. Это позволяет выполнять операции SELECT/INSERT из представлений без явных привилегий на базовые таблицы. [#54901](https://github.com/ClickHouse/ClickHouse/pull/54901) ([pufit](https://github.com/pufit)).
* Реализовано автоматическое преобразование таблиц семейства MergeTree различных типов в реплицируемый движок. Создайте пустой файл `convert_to_replicated` в каталоге данных таблицы (`/clickhouse/store/xxx/xxxyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy/`), и эта таблица будет автоматически преобразована при следующем запуске сервера. [#57798](https://github.com/ClickHouse/ClickHouse/pull/57798) ([Kirill](https://github.com/kirillgarbar)).
* Добавлена табличная функция `mergeTreeIndex`. Она представляет собой содержимое файлов индекса и меток таблиц `MergeTree`. Может использоваться для интроспекции. Синтаксис: `mergeTreeIndex(database, table, [with_marks = true])`, где `database.table` — существующая таблица с движком `MergeTree`. [#58140](https://github.com/ClickHouse/ClickHouse/pull/58140) ([Anton Popov](https://github.com/CurtizJ)).
* Пытаться автоматически определять формат файла при выводе схемы, если он неизвестен, для движков `file/s3/hdfs/url/azureBlobStorage`. Закрывает [#50576](https://github.com/ClickHouse/ClickHouse/issues/50576). [#59092](https://github.com/ClickHouse/ClickHouse/pull/59092) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена табличная функция generate&#95;series. Эта функция генерирует таблицу с арифметической прогрессией из натуральных чисел. [#59390](https://github.com/ClickHouse/ClickHouse/pull/59390) ([divanik](https://github.com/divanik)).
* Добавлен запрос `ALTER TABLE table FORGET PARTITION partition`, который удаляет узлы ZooKeeper, соответствующие пустой партиции. [#59507](https://github.com/ClickHouse/ClickHouse/pull/59507) ([Sergei Trifonov](https://github.com/serxa)).
* Поддержка чтения и записи резервных копий в виде tar-архивов. [#59535](https://github.com/ClickHouse/ClickHouse/pull/59535) ([josh-hildred](https://github.com/josh-hildred)).
* Добавлена новая агрегатная функция &#39;groupArrayIntersect&#39;. Продолжение: [#49862](https://github.com/ClickHouse/ClickHouse/issues/49862). [#59598](https://github.com/ClickHouse/ClickHouse/pull/59598) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Реализована таблица system.dns&#95;cache, которая может быть полезна для диагностики проблем с DNS. [#59856](https://github.com/ClickHouse/ClickHouse/pull/59856) ([Kirill Nikiforov](https://github.com/allmazz)).
* Добавлена поддержка бакетов S3Express. [#59965](https://github.com/ClickHouse/ClickHouse/pull/59965) ([Nikita Taranov](https://github.com/nickitat)).
* Кодек `LZ4HC` теперь принимает новый уровень 2, который быстрее, чем предыдущий минимальный уровень 3, ценой более низкой степени сжатия. В предыдущих версиях `LZ4HC(2)` и ниже были эквивалентны `LZ4HC(3)`. Автор: [Cyan4973](https://github.com/Cyan4973). [#60090](https://github.com/ClickHouse/ClickHouse/pull/60090) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена таблица system.dns&#95;cache, которая может быть полезна для отладки проблем с DNS. Добавлена новая настройка сервера dns&#95;cache&#95;max&#95;size. [#60257](https://github.com/ClickHouse/ClickHouse/pull/60257) ([Kirill Nikiforov](https://github.com/allmazz)).
* Добавлена функция `toMillisecond`, которая возвращает миллисекундную составляющую для значений типов `DateTime` или `DateTime64`. [#60281](https://github.com/ClickHouse/ClickHouse/pull/60281) ([Shaun Struwig](https://github.com/Blargian)).
* Добавлена поддержка однопараметрического варианта табличной функции merge: `merge(['db_name', ] 'tables_regexp')`. [#60372](https://github.com/ClickHouse/ClickHouse/pull/60372) ([豪肥肥](https://github.com/HowePa)).
* Все имена форматов теперь нечувствительны к регистру, например Tsv, TSV, tsv или даже rowbinary. [#60420](https://github.com/ClickHouse/ClickHouse/pull/60420) ([豪肥肥](https://github.com/HowePa)).
* Добавлен новый синтаксис, который позволяет указать пользователя-определителя (definer user) для view/materialized view. Это позволяет выполнять операции SELECT и INSERT из представлений без явной выдачи прав на базовые таблицы. [#60439](https://github.com/ClickHouse/ClickHouse/pull/60439) ([pufit](https://github.com/pufit)).
* Добавлены четыре свойства к `StorageMemory` (движок памяти): `min_bytes_to_keep, max_bytes_to_keep, min_rows_to_keep` и `max_rows_to_keep` — добавлены тесты, отражающие изменения — обновлена документация `memory.md` — в `MemorySink` добавлено свойство таблицы `context`, чтобы обеспечить доступ к границам параметров таблицы. [#60612](https://github.com/ClickHouse/ClickHouse/pull/60612) ([Jake Bamrah](https://github.com/JakeBamrah)).
* Добавлена функция `toMillisecond`, которая возвращает значение миллисекунд для значений типа `DateTime` или `DateTime64`. [#60649](https://github.com/ClickHouse/ClickHouse/pull/60649) ([Robert Schulze](https://github.com/rschu1ze)).
* Отдельные лимиты на количество ожидающих и выполняющихся запросов. Добавлена новая настройка сервера `max_waiting_queries`, которая ограничивает количество запросов, ожидающих из‑за `async_load_databases`. Существующие лимиты на количество выполняющихся запросов теперь не учитывают ожидающие запросы. [#61053](https://github.com/ClickHouse/ClickHouse/pull/61053) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена поддержка `ATTACH PARTITION ALL`. [#61107](https://github.com/ClickHouse/ClickHouse/pull/61107) ([Kirill Nikiforov](https://github.com/allmazz)).

#### Повышение производительности \{#performance-improvement\}

* Удаляет агрегаторы min/max/any/anyLast по ключам GROUP BY в секции SELECT. [#52230](https://github.com/ClickHouse/ClickHouse/pull/52230) ([JackyWoo](https://github.com/JackyWoo)).
* Улучшена производительность метода сериализованной агрегации при работе с несколькими [Nullable] столбцами. Это обобщённая версия [#51399](https://github.com/ClickHouse/ClickHouse/issues/51399), которая не нарушает целостность абстракции. [#55809](https://github.com/ClickHouse/ClickHouse/pull/55809) ([Amos Bird](https://github.com/amosbird)).
* Ленивая генерация результата JOIN для повышения производительности соединений типа ALL. [#58278](https://github.com/ClickHouse/ClickHouse/pull/58278) ([LiuNeng](https://github.com/liuneng1994)).
* Улучшены агрегатные функции ArgMin / ArgMax / any / anyLast / anyHeavy, а также запросы `ORDER BY {u8/u16/u32/u64/i8/i16/u32/i64) LIMIT 1`. [#58640](https://github.com/ClickHouse/ClickHouse/pull/58640) ([Raúl Marín](https://github.com/Algunenano)).
* Оптимизирована производительность условных операций sum/avg для типов bigint и big decimal за счёт сокращения промахов предсказания ветвлений. [#59504](https://github.com/ClickHouse/ClickHouse/pull/59504) ([李扬](https://github.com/taiyang-li)).
* Улучшена производительность запросов SELECT при наличии активных мутаций. [#59531](https://github.com/ClickHouse/ClickHouse/pull/59531) ([Azat Khuzhin](https://github.com/azat)).
* Тривиальная оптимизация фильтрации по столбцу. Избегайте фильтрации по столбцам, базовый тип данных которых не является числовым, при использовании `result_size_hint = -1`. В некоторых случаях пиковое потребление памяти может быть снижено до 44% от исходного. [#59698](https://github.com/ClickHouse/ClickHouse/pull/59698) ([李扬](https://github.com/taiyang-li)).
* Первичный ключ будет занимать меньше памяти. [#60049](https://github.com/ClickHouse/ClickHouse/pull/60049) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Оптимизировано использование памяти для первичного ключа и некоторых других операций. [#60050](https://github.com/ClickHouse/ClickHouse/pull/60050) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Первичные ключи таблиц будут загружаться в память по требованию при первом обращении. Это контролируется новой настройкой MergeTree `primary_key_lazy_load`, которая по умолчанию включена. Это даёт несколько преимуществ: - первичный ключ не будет загружаться для таблиц, которые не используются; - если памяти недостаточно, исключение будет выброшено при первом использовании, а не при запуске сервера. Это даёт несколько недостатков: - задержка на загрузку первичного ключа будет возникать при выполнении первого запроса, а не до принятия подключений; теоретически это может привести к проблеме «лавинообразной нагрузки». Это закрывает [#11188](https://github.com/ClickHouse/ClickHouse/issues/11188). [#60093](https://github.com/ClickHouse/ClickHouse/pull/60093) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Векторизованная функция `dotProduct`, предназначенная для векторного поиска. [#60202](https://github.com/ClickHouse/ClickHouse/pull/60202) ([Robert Schulze](https://github.com/rschu1ze)).
* Если первичный ключ таблицы содержит в основном бесполезные столбцы, их не нужно держать в памяти. Это управляется новым параметром `primary_key_ratio_of_unique_prefix_values_to_skip_suffix_columns` со значением `0.9` по умолчанию, что означает: для составного первичного ключа, если столбец меняет своё значение как минимум в 0.9 доли всех случаев, следующие за ним столбцы не будут загружаться в память. [#60255](https://github.com/ClickHouse/ClickHouse/pull/60255) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Выполнять функцию multiIf в столбцовом режиме, если базовый тип result&#95;type — числовой. [#60384](https://github.com/ClickHouse/ClickHouse/pull/60384) ([李扬](https://github.com/taiyang-li)).
* Как показано на рис. 1, замена &quot;&amp;&amp;&quot; на &quot;&amp;&quot; позволяет сгенерировать SIMD-код. ![изображение](https://github.com/ClickHouse/ClickHouse/assets/26588299/a5a72ac4-6dc6-4d52-835a-4f512e55f0b9) Рис. 1. Код, скомпилированный из &#39;&amp;&amp;&#39; (слева) и &#39;&amp;&#39; (справа). [#60498](https://github.com/ClickHouse/ClickHouse/pull/60498) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
* Мьютексы стали работать почти в 2 раза быстрее (ранее они были медленнее из-за ThreadFuzzer). [#60823](https://github.com/ClickHouse/ClickHouse/pull/60823) ([Azat Khuzhin](https://github.com/azat)).
* Перенести операцию освобождения соединений с этапа prepare на этап work и выполнять освобождение нескольких соединений параллельно. [#60845](https://github.com/ClickHouse/ClickHouse/pull/60845) ([lizhuoyu5](https://github.com/lzydmxy)).
* Оптимизирован метод insertManyFrom для Nullable-числовых и Nullable-строковых типов. [#60846](https://github.com/ClickHouse/ClickHouse/pull/60846) ([李扬](https://github.com/taiyang-li)).
* Оптимизирована функция `dotProduct` для исключения ненужных и дорогостоящих операций копирования памяти. [#60928](https://github.com/ClickHouse/ClickHouse/pull/60928) ([Robert Schulze](https://github.com/rschu1ze)).
* Операции с файловым кэшем станут менее подвержены конкуренции за блокировки. [#61066](https://github.com/ClickHouse/ClickHouse/pull/61066) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Оптимизировать ColumnString::replicate и не допустить, чтобы memcpySmallAllowReadWriteOverflow15Impl была оптимизирована до встроенной memcpy. Закрыть [#61074](https://github.com/ClickHouse/ClickHouse/issues/61074). ColumnString::replicate стал работать в 2,46 раза быстрее на x86-64. [#61075](https://github.com/ClickHouse/ClickHouse/pull/61075) ([李扬](https://github.com/taiyang-li)).
* Вывод 256-битных целых чисел стал в 30 раз быстрее. [#61100](https://github.com/ClickHouse/ClickHouse/pull/61100) ([Raúl Marín](https://github.com/Algunenano)).
* Если запрос с синтаксической ошибкой содержал matcher `COLUMNS` с регулярным выражением, то регулярное выражение компилировалось заново при каждом откате парсера (backtracking), вместо однократной компиляции. Это была фундаментальная ошибка. Скомпилированный regexp помещался в AST. Но буква A в AST означает «abstract», то есть он не должен содержать тяжеловесных объектов. Части AST могут создаваться и уничтожаться в процессе парсинга, включая большое количество откатов. Это приводит к замедлению на стороне парсинга и, как следствие, позволяет осуществлять DoS от пользователя только с правами на чтение. Но основная проблема в том, что это мешает прогрессу фаззеров. [#61543](https://github.com/ClickHouse/ClickHouse/pull/61543) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### Улучшение \{#improvement\}

* При выполнении запроса MODIFY COLUMN для materialized views проверяйте структуру внутренней таблицы, чтобы убедиться, что все столбцы присутствуют. [#47427](https://github.com/ClickHouse/ClickHouse/pull/47427) ([sunny](https://github.com/sunny19930321)).
* Добавлена таблица `system.keywords`, которая содержит все ключевые слова, известные парсеру. В основном предназначена для улучшения фаззинга и подсветки синтаксиса. [#51808](https://github.com/ClickHouse/ClickHouse/pull/51808) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлена поддержка параметризованных представлений в анализаторе, чтобы не анализировать оператор `CREATE PARAMETERIZED VIEW`. Отрефакторена существующая логика параметризованных представлений, чтобы не анализировать оператор `CREATE PARAMETERIZED VIEW`. [#54211](https://github.com/ClickHouse/ClickHouse/pull/54211) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Движок базы данных Ordinary помечен как устаревший. Вы получите предупреждение в clickhouse-client, если на вашем сервере он используется. Это закрывает [#52229](https://github.com/ClickHouse/ClickHouse/issues/52229). [#56942](https://github.com/ClickHouse/ClickHouse/pull/56942) ([shabroo](https://github.com/shabroo)).
* Все блокировки zero-copy, связанные с таблицей, должны быть сняты при удалении таблицы. Каталог, содержащий эти блокировки, также должен быть удалён. [#57575](https://github.com/ClickHouse/ClickHouse/pull/57575) ([Sema Checherinda](https://github.com/CheSema)).
* Добавлена поддержка укороченного вычисления для функции `dictGetOrDefault`. Закрывает [#52098](https://github.com/ClickHouse/ClickHouse/issues/52098). [#57767](https://github.com/ClickHouse/ClickHouse/pull/57767) ([jsc0218](https://github.com/jsc0218)).
* Добавлена возможность объявлять enum в структуре внешней таблицы. [#57857](https://github.com/ClickHouse/ClickHouse/pull/57857) ([Duc Canh Le](https://github.com/canhld94)).
* Выполнение `ALTER COLUMN MATERIALIZE` для столбца с выражением `DEFAULT` или `MATERIALIZED` теперь записывает корректные значения: значение по умолчанию для существующих частей, использующих значение по умолчанию, или значение, отличающееся от значения по умолчанию, для существующих частей с таким значением. Ранее значение по умолчанию записывалось для всех существующих частей. [#58023](https://github.com/ClickHouse/ClickHouse/pull/58023) ([Duc Canh Le](https://github.com/canhld94)).
* Включён механизм бэкоффа (например, экспоненциального), что позволит снизить загрузку CPU, потребление памяти и размер файлов журналов. [#58036](https://github.com/ClickHouse/ClickHouse/pull/58036) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Учитывать строки, помеченные легковесным удалением, при выборе частей для слияния. [#58223](https://github.com/ClickHouse/ClickHouse/pull/58223) ([Zhuo Qiu](https://github.com/jewelzqiu)).
* Добавлена возможность задавать `volume_priority` в `storage_configuration`. [#58533](https://github.com/ClickHouse/ClickHouse/pull/58533) ([Andrey Zvonov](https://github.com/zvonand)).
* Добавлена поддержка типа Date32 для кодека T64. [#58738](https://github.com/ClickHouse/ClickHouse/pull/58738) ([Hongbin Ma](https://github.com/binmahone)).
* Этот PR делает HTTP/HTTPS‑соединения повторно используемыми для всех сценариев, даже если сервер отвечает кодом 3xx или 4xx. [#58845](https://github.com/ClickHouse/ClickHouse/pull/58845) ([Sema Checherinda](https://github.com/CheSema)).
* Добавлены комментарии к столбцам в большем числе системных таблиц. Продолжение [https://github.com/ClickHouse/ClickHouse/pull/58356](https://github.com/ClickHouse/ClickHouse/pull/58356). [#59016](https://github.com/ClickHouse/ClickHouse/pull/59016) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Теперь можно использовать виртуальные столбцы в PREWHERE. Это особенно полезно для неконстантных виртуальных столбцов, таких как `_part_offset`. [#59033](https://github.com/ClickHouse/ClickHouse/pull/59033) ([Amos Bird](https://github.com/amosbird)).
* Настройки для движка таблицы Distributed теперь могут быть указаны в конфигурационном файле сервера (аналогично настройкам MergeTree), например: `<distributed> <flush_on_detach>false</flush_on_detach> </distributed>`. [#59291](https://github.com/ClickHouse/ClickHouse/pull/59291) ([Azat Khuzhin](https://github.com/azat)).
* Улучшение Keeper: кеширование в оперативной памяти только определённого объёма логов, контролируемого параметрами `latest_logs_cache_size_threshold` и `commit_logs_cache_size_threshold`. [#59460](https://github.com/ClickHouse/ClickHouse/pull/59460) ([Antonio Andelic](https://github.com/antonio2368)).
* Теперь вместо фиксированного ключа объектное хранилище генерирует ключ для определения возможности удаления объектов. [#59495](https://github.com/ClickHouse/ClickHouse/pull/59495) ([Sema Checherinda](https://github.com/CheSema)).
* По умолчанию не определять тип `Float` для чисел в экспоненциальной нотации. Добавлена настройка `input_format_try_infer_exponent_floats`, которая позволяет восстановить прежнее поведение (по умолчанию отключена). Закрывает [#59476](https://github.com/ClickHouse/ClickHouse/issues/59476). [#59500](https://github.com/ClickHouse/ClickHouse/pull/59500) ([Kruglov Pavel](https://github.com/Avogar)).
* Позволяет окружать операции ALTER круглыми скобками. Генерацией скобок можно управлять с помощью настройки `format_alter_operations_with_parentheses`. По умолчанию в отформатированных запросах скобки выводятся, так как в некоторых местах мы храним отформатированные операции ALTER как метаданные (например, для мутаций). Новый синтаксис делает более понятными некоторые запросы, где операции ALTER заканчиваются списком. Например, `ALTER TABLE x MODIFY TTL date GROUP BY a, b, DROP COLUMN c` не может быть корректно разобран старым синтаксисом. В новом синтаксисе запрос `ALTER TABLE x (MODIFY TTL date GROUP BY a, b), (DROP COLUMN c)` однозначен. Старые версии не могут интерпретировать новый синтаксис, поэтому его использование может вызвать проблемы, если новые и старые версии ClickHouse смешаны в одном кластере. [#59532](https://github.com/ClickHouse/ClickHouse/pull/59532) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Обновлена версия Intel QPL (используется кодеком `DEFLATE_QPL`) с v1.3.1 до v1.4.0. Также исправлена ошибка в механизме таймаута опроса: мы наблюдали, что в некоторых случаях таймаут работает некорректно — если он срабатывает, IAA и CPU могут обрабатывать буфер одновременно. На данный момент лучше убедиться, что статус кодека IAA не QPL&#95;STS&#95;BEING&#95;PROCESSED, а затем переключаться на программный (SW) кодек. [#59551](https://github.com/ClickHouse/ClickHouse/pull/59551) ([jasperzhu](https://github.com/jinjunzh)).
* Добавлена поддержка позиционного чтения (pread) в libhdfs3. Если вы хотите вызвать позиционное чтение в libhdfs3, используйте функцию hdfsPread в hdfs.h следующим образом: `tSize hdfsPread(hdfsFS fs, hdfsFile file, void * buffer, tSize length, tOffset position);`. [#59624](https://github.com/ClickHouse/ClickHouse/pull/59624) ([M1eyu](https://github.com/M1eyu2018)).
* Добавлена проверка переполнения стека в парсерах, даже если пользователь некорректно настроил `max_parser_depth`, установив слишком большое значение. Это закрывает [#59622](https://github.com/ClickHouse/ClickHouse/issues/59622). [#59697](https://github.com/ClickHouse/ClickHouse/pull/59697) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Унифицировано поведение именованных коллекций, создаваемых через XML и SQL, в хранилище Kafka. [#59710](https://github.com/ClickHouse/ClickHouse/pull/59710) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Разрешить использование uuid в replica&#95;path, если он явно указан в CREATE TABLE. [#59908](https://github.com/ClickHouse/ClickHouse/pull/59908) ([Azat Khuzhin](https://github.com/azat)).
* Добавлен столбец `metadata_version` для таблиц ReplicatedMergeTree в системную таблицу `system.tables`. [#59942](https://github.com/ClickHouse/ClickHouse/pull/59942) ([Maksim Kita](https://github.com/kitaisreal)).
* Улучшение Keeper: добавлены повторные попытки выполнения при сбоях операций, связанных с диском Disk. [#59980](https://github.com/ClickHouse/ClickHouse/pull/59980) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлен новый параметр конфигурации `backups.remove_backup_files_after_failure`: `<clickhouse> <backups> <remove_backup_files_after_failure>true</remove_backup_files_after_failure> </backups> </clickhouse>`. [#60002](https://github.com/ClickHouse/ClickHouse/pull/60002) ([Vitaly Baranov](https://github.com/vitlibar)).
* Используйте несколько потоков для чтения метаданных таблиц из резервной копии при выполнении команды RESTORE. [#60040](https://github.com/ClickHouse/ClickHouse/pull/60040) ([Vitaly Baranov](https://github.com/vitlibar)).
* Теперь, если в `StorageBuffer` больше одного сегмента (`num_layers` &gt; 1), фоновый сброс будет выполняться одновременно для всех сегментов в нескольких потоках. [#60111](https://github.com/ClickHouse/ClickHouse/pull/60111) ([alesapin](https://github.com/alesapin)).
* Добавлена возможность указывать пользователей для отдельных настроек S3 в конфигурации с использованием ключа `user`. [#60144](https://github.com/ClickHouse/ClickHouse/pull/60144) ([Antonio Andelic](https://github.com/antonio2368)).
* Резервный механизм копирования S3‑файла через GCP изменён: теперь при возврате GCP ошибки `Internal Error` с HTTP‑кодом `GATEWAY_TIMEOUT` выполняется копирование в буфер. [#60164](https://github.com/ClickHouse/ClickHouse/pull/60164) ([Maksim Kita](https://github.com/kitaisreal)).
* Разрешено использовать &quot;local&quot; как тип объектного хранилища вместо &quot;local&#95;blob&#95;storage&quot;. [#60165](https://github.com/ClickHouse/ClickHouse/pull/60165) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Реализован оператор сравнения для значений `Variant` и корректная вставка значений типа `Field` в столбец `Variant`. По умолчанию запрещено создавать тип `Variant` со схожими вариантами (можно при включённой настройке `allow_suspicious_variant_types`). Закрывает [#59996](https://github.com/ClickHouse/ClickHouse/issues/59996). Закрывает [#59850](https://github.com/ClickHouse/ClickHouse/issues/59850). [#60198](https://github.com/ClickHouse/ClickHouse/pull/60198) ([Kruglov Pavel](https://github.com/Avogar)).
* Улучшено общее удобство использования виртуальных столбцов. Теперь разрешено использовать виртуальные столбцы в `PREWHERE` (это имеет смысл для неконстантных виртуальных столбцов, таких как `_part_offset`). Теперь встроенная документация доступна для виртуальных столбцов в виде комментария к столбцу в запросе `DESCRIBE` при включённой настройке `describe_include_virtual_columns`. [#60205](https://github.com/ClickHouse/ClickHouse/pull/60205) ([Anton Popov](https://github.com/CurtizJ)).
* Укороченное вычисление для функции `ULIDStringToDateTime`. [#60211](https://github.com/ClickHouse/ClickHouse/pull/60211) ([Juan Madurga](https://github.com/jlmadurga)).
* Добавлен столбец `query_id` в таблицы `system.backups` и `system.backup_log`. В столбец `error` добавлена трассировка стека ошибки. [#60220](https://github.com/ClickHouse/ClickHouse/pull/60220) ([Maksim Kita](https://github.com/kitaisreal)).
* Параллельный сброс ожидающих INSERT-блоков движка Distributed при `DETACH`/выключении сервера и `SYSTEM FLUSH DISTRIBUTED` (параллелизм будет работать только если для таблицы настроена политика хранения с несколькими дисками, как и для всего в движке Distributed сейчас). [#60225](https://github.com/ClickHouse/ClickHouse/pull/60225) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена некорректная настройка фильтра в `joinRightColumnsSwitchNullability`, см. [#59625](https://github.com/ClickHouse/ClickHouse/issues/59625). [#60259](https://github.com/ClickHouse/ClickHouse/pull/60259) ([lgbo](https://github.com/lgbo-ustc)).
* Добавлена настройка, принудительно включающая read-through-кэш при слияниях. [#60308](https://github.com/ClickHouse/ClickHouse/pull/60308) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Issue [#57598](https://github.com/ClickHouse/ClickHouse/issues/57598) описывает иное поведение при работе с транзакциями. Выполненные COMMIT/ROLLBACK при отсутствии активной транзакции приводят к ошибке, в отличие от поведения MySQL. [#60338](https://github.com/ClickHouse/ClickHouse/pull/60338) ([PapaToemmsn](https://github.com/PapaToemmsn)).
* Добавлен режим `none_only_active` для настройки `distributed_ddl_output_mode`. [#60340](https://github.com/ClickHouse/ClickHouse/pull/60340) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Подключения через порт MySQL теперь автоматически выполняются с настройкой `prefer_column_name_to_alias = 1` для поддержки QuickSight «из коробки». Кроме того, настройки `mysql_map_string_to_text_in_show_columns` и `mysql_map_fixed_string_to_text_in_show_columns` теперь включены по умолчанию и, как и вышеуказанная настройка, действуют только для MySQL-подключений. Это повышает совместимость с большим количеством BI-инструментов. [#60365](https://github.com/ClickHouse/ClickHouse/pull/60365) ([Robert Schulze](https://github.com/rschu1ze)).
* Когда формат вывода — Pretty и блок состоит из одного числового значения, которое превышает один миллион, в правой части таблицы будет напечатано удобочитаемое число. Например: `┌──────count()─┐ │ 233765663884 │ -- 233.77 billion └──────────────┘`. [#60379](https://github.com/ClickHouse/ClickHouse/pull/60379) ([rogeryk](https://github.com/rogeryk)).
* Добавлена возможность настраивать обработчики перенаправлений HTTP для clickhouse-server. Например, можно сделать так, чтобы `/` перенаправлял на Play UI. [#60390](https://github.com/ClickHouse/ClickHouse/pull/60390) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Расширенная панель мониторинга получила немного улучшенную цветовую схему для многолинейных графиков. [#60391](https://github.com/ClickHouse/ClickHouse/pull/60391) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено состояние гонки в JavaScript-коде, приводившее к наложению друг на друга дублирующихся графиков. [#60392](https://github.com/ClickHouse/ClickHouse/pull/60392) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Выполняется проверка переполнения стека в парсерах даже в том случае, если пользователь неправильно настроил параметр `max_parser_depth`, установив чрезмерно большое значение. Это закрывает [#59622](https://github.com/ClickHouse/ClickHouse/issues/59622). [#60434](https://github.com/ClickHouse/ClickHouse/pull/60434) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Функция `substring` получила новый псевдоним `byteSlice`. [#60494](https://github.com/ClickHouse/ClickHouse/pull/60494) ([Robert Schulze](https://github.com/rschu1ze)).
* Переименована настройка сервера `dns_cache_max_size` в `dns_cache_max_entries` для большей ясности. [#60500](https://github.com/ClickHouse/ClickHouse/pull/60500) ([Kirill Nikiforov](https://github.com/allmazz)).
* `SHOW INDEX | INDEXES | INDICES | KEYS` больше не сортирует по столбцам первичного ключа (что было неинтуитивно). [#60514](https://github.com/ClickHouse/ClickHouse/pull/60514) ([Robert Schulze](https://github.com/rschu1ze)).
* Улучшение Keeper: прерывать запуск при обнаружении некорректного снимка состояния, чтобы предотвратить потерю данных. [#60537](https://github.com/ClickHouse/ClickHouse/pull/60537) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлено разделение диапазонов чтения MergeTree на пересекающиеся и непересекающиеся для инъекции сбоев (fault injection) с использованием настройки `merge_tree_read_split_ranges_into_intersecting_and_non_intersecting_fault_probability`. [#60548](https://github.com/ClickHouse/ClickHouse/pull/60548) ([Maksim Kita](https://github.com/kitaisreal)).
* В расширенном дашборде элементы управления теперь всегда остаются видимыми при прокрутке. Это позволяет добавлять новый график, не прокручивая страницу вверх. [#60692](https://github.com/ClickHouse/ClickHouse/pull/60692) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Типы String и Enum можно использовать в одних и тех же контекстах, например в массивах, запросах UNION, условных выражениях. Это закрывает [#60726](https://github.com/ClickHouse/ClickHouse/issues/60726). [#60727](https://github.com/ClickHouse/ClickHouse/pull/60727) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Обновлён пакет tzdata до версии 2024a. [#60768](https://github.com/ClickHouse/ClickHouse/pull/60768) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлена поддержка файлов в базе данных Filesystem, не имеющих расширения формата. [#60795](https://github.com/ClickHouse/ClickHouse/pull/60795) ([Kruglov Pavel](https://github.com/Avogar)).
* Улучшение Keeper: поддержка `leadership_expiry_ms` в настройках Keeper. [#60806](https://github.com/ClickHouse/ClickHouse/pull/60806) ([Brokenice0415](https://github.com/Brokenice0415)).
* Всегда интерпретировать числа в экспоненциальной форме в форматах JSON независимо от настройки `input_format_try_infer_exponent_floats`. Добавлена настройка `input_format_json_use_string_type_for_ambiguous_paths_in_named_tuples_inference_from_objects`, которая позволяет использовать тип String для неоднозначных путей вместо генерации исключения при выводе типов именованных Tuples из объектов JSON. [#60808](https://github.com/ClickHouse/ClickHouse/pull/60808) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен флаг для SMJ, позволяющий трактовать NULL как наибольшее/наименьшее значение, чтобы поведение было совместимым с другими SQL‑системами, такими как Apache Spark. [#60896](https://github.com/ClickHouse/ClickHouse/pull/60896) ([loudongfeng](https://github.com/loudongfeng)).
* Версия ClickHouse была добавлена в метки Docker. Закрывает [#54224](https://github.com/ClickHouse/ClickHouse/issues/54224). [#60949](https://github.com/ClickHouse/ClickHouse/pull/60949) ([Nikolay Monkov](https://github.com/nikmonkov)).
* Добавлена настройка `parallel_replicas_allow_in_with_subquery = 1`, которая позволяет использовать подзапросы в операторе IN при работе с параллельными репликами. [#60950](https://github.com/ClickHouse/ClickHouse/pull/60950) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* DNSResolver перемешивает набор разрешённых IP-адресов. [#60965](https://github.com/ClickHouse/ClickHouse/pull/60965) ([Sema Checherinda](https://github.com/CheSema)).
* Добавлена поддержка определения формата вывода по расширению файла в `clickhouse-client` и `clickhouse-local`. [#61036](https://github.com/ClickHouse/ClickHouse/pull/61036) ([豪肥肥](https://github.com/HowePa)).
* Периодически проверять изменение лимита памяти. [#61049](https://github.com/ClickHouse/ClickHouse/pull/61049) ([Han Fei](https://github.com/hanfei1991)).
* Включено по умолчанию профилирование процессоров (время выполнения, объем входящих и исходящих данных для сортировки, агрегации и т. д.). [#61096](https://github.com/ClickHouse/ClickHouse/pull/61096) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена функция `toUInt128OrZero`, которая была пропущена по ошибке (ошибка связана с [https://github.com/ClickHouse/ClickHouse/pull/945](https://github.com/ClickHouse/ClickHouse/pull/945)). Псевдонимы совместимости `FROM_UNIXTIME` и `DATE_FORMAT` (они не являются родными для ClickHouse и существуют только для совместимости с MySQL) сделаны регистронезависимыми, как и положено псевдонимам для SQL-совместимости. [#61114](https://github.com/ClickHouse/ClickHouse/pull/61114) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшены проверки доступа, позволяющие отзывать права, которыми владелец операции не обладает, в случае, если у целевого пользователя также отсутствуют права на их отзыв. Пример: ```sql GRANT SELECT ON *.* TO user1; REVOKE SELECT ON system.* FROM user1;. [#61115](https://github.com/ClickHouse/ClickHouse/pull/61115) ([pufit](https://github.com/pufit)).
* Исправить ошибку в предыдущей оптимизации: [https://github.com/ClickHouse/ClickHouse/pull/59698](https://github.com/ClickHouse/ClickHouse/pull/59698): удалить `break`, чтобы гарантировать, что первый отфильтрованный столбец имеет минимальный размер cc @jsc0218. [#61145](https://github.com/ClickHouse/ClickHouse/pull/61145) ([李扬](https://github.com/taiyang-li)).
* Исправлена функция `has()` при работе со столбцом типа `Nullable` (исправляет [#60214](https://github.com/ClickHouse/ClickHouse/issues/60214)). [#61249](https://github.com/ClickHouse/ClickHouse/pull/61249) ([Mikhail Koviazin](https://github.com/mkmkme)).
* Теперь в подстановках конфигурации для поддеревьев вида `<include from_zk="/path" merge="true">` можно указывать атрибут `merge="true"`. Если этот атрибут указан, ClickHouse будет объединять поддерево с существующей конфигурацией, в противном случае используется поведение по умолчанию: новое содержимое просто добавляется к конфигурации. [#61299](https://github.com/ClickHouse/ClickHouse/pull/61299) ([alesapin](https://github.com/alesapin)).
* Добавлены асинхронные метрики для отображений виртуальной памяти: VMMaxMapCount и VMNumMaps. Закрывает [#60662](https://github.com/ClickHouse/ClickHouse/issues/60662). [#61354](https://github.com/ClickHouse/ClickHouse/pull/61354) ([Tuan Pham Anh](https://github.com/tuanpavn)).
* Настройка `temporary_files_codec` теперь используется во всех местах, где создаются временные данные, например при сортировке с использованием внешней памяти и внешнем GROUP BY. Ранее она работала только в алгоритме JOIN `partial_merge`. [#61456](https://github.com/ClickHouse/ClickHouse/pull/61456) ([Maksim Kita](https://github.com/kitaisreal)).
* Удалена дублирующая проверка `containing_part.empty()`: она уже выполняется здесь: [https://github.com/ClickHouse/ClickHouse/blob/1296dac3c7e47670872c15e3f5e58f869e0bd2f2/src/Storages/MergeTree/MergeTreeData.cpp#L6141](https://github.com/ClickHouse/ClickHouse/blob/1296dac3c7e47670872c15e3f5e58f869e0bd2f2/src/Storages/MergeTree/MergeTreeData.cpp#L6141). [#61467](https://github.com/ClickHouse/ClickHouse/pull/61467) ([William Schoeffel](https://github.com/wiledusc)).
* Добавлена новая настройка `max_parser_backtracks`, которая позволяет ограничивать сложность разбора запросов. [#61502](https://github.com/ClickHouse/ClickHouse/pull/61502) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Меньше конкуренции потоков при динамическом изменении размера кэша файловой системы. [#61524](https://github.com/ClickHouse/ClickHouse/pull/61524) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Запрещено использование сегментированного режима очереди StorageS3, поскольку он будет переработан. [#61537](https://github.com/ClickHouse/ClickHouse/pull/61537) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена опечатка: `use_leagcy_max_level` заменено на `use_legacy_max_level`. [#61545](https://github.com/ClickHouse/ClickHouse/pull/61545) ([William Schoeffel](https://github.com/wiledusc)).
* Удалены некоторые дублирующиеся записи в blob&#95;storage&#95;log. [#61622](https://github.com/ClickHouse/ClickHouse/pull/61622) ([YenchangChan](https://github.com/YenchangChan)).
* Добавлена функция `current_user` как псевдоним для совместимости с MySQL. [#61770](https://github.com/ClickHouse/ClickHouse/pull/61770) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Используйте управляемое удостоверение для операций ввода-вывода резервных копий при работе с Azure Blob Storage. Добавьте настройку, чтобы ClickHouse не пытался создать несуществующий контейнер, что требует прав на уровне учетной записи хранения. [#61785](https://github.com/ClickHouse/ClickHouse/pull/61785) ([Daniel Pozo Escalona](https://github.com/danipozo)).
* В предыдущей версии некоторые числа в форматах Pretty были недостаточно «красивыми». [#61794](https://github.com/ClickHouse/ClickHouse/pull/61794) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Длинное значение в форматах Pretty не будет усечено, если оно является единственным значением в результирующем наборе, например, в результате запроса `SHOW CREATE TABLE`. [#61795](https://github.com/ClickHouse/ClickHouse/pull/61795) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Как и `clickhouse-local`, `clickhouse-client` принимает опцию `--output-format` как синоним опции `--format`. Это закрывает [#59848](https://github.com/ClickHouse/ClickHouse/issues/59848). [#61797](https://github.com/ClickHouse/ClickHouse/pull/61797) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Если stdout является терминалом и формат вывода не задан, `clickhouse-client` и подобные инструменты по умолчанию будут использовать `PrettyCompact`, аналогично интерактивному режиму. `clickhouse-client` и `clickhouse-local` будут единообразно обрабатывать аргументы командной строки для форматов ввода и вывода. Это закрывает [#61272](https://github.com/ClickHouse/ClickHouse/issues/61272). [#61800](https://github.com/ClickHouse/ClickHouse/pull/61800) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Подчеркивание групп цифр в форматах Pretty для улучшения читаемости. Это поведение управляется новой настройкой `output_format_pretty_highlight_digit_groups`. [#61802](https://github.com/ClickHouse/ClickHouse/pull/61802) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### Исправление ошибки (некорректное поведение, заметное пользователю, в официальном стабильном релизе) \{#bug-fix-user-visible-misbehavior-in-an-official-stable-release\}

* Исправлена ошибка в функции `intDiv` для аргументов типа Decimal [#59243](https://github.com/ClickHouse/ClickHouse/pull/59243) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена ошибка kql, обнаруженная wingfuzz [#59626](https://github.com/ClickHouse/ClickHouse/pull/59626) ([Yong Wang](https://github.com/kashwy)).
* Исправлена ошибка «Read beyond last offset» для AsynchronousBoundedReadBuffer [#59630](https://github.com/ClickHouse/ClickHouse/pull/59630) ([Vitaly Baranov](https://github.com/vitlibar)).
* rabbitmq: исправлена проблема, при которой сообщения не были ни подтверждены (acked), ни отклонены (nacked) [#59775](https://github.com/ClickHouse/ClickHouse/pull/59775) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено выполнение функций для `const` и `LowCardinality` при использовании `GROUP BY const` в аналайзере [#59986](https://github.com/ClickHouse/ClickHouse/pull/59986) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено преобразование масштаба для DateTime64 [#60004](https://github.com/ClickHouse/ClickHouse/pull/60004) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена операция INSERT в SQLite с одинарной кавычкой (путём экранирования одинарных кавычек удвоением кавычки вместо обратной косой черты) [#60015](https://github.com/ClickHouse/ClickHouse/pull/60015) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена оптимизация `optimize_uniq_to_count`, которая удаляла псевдоним столбца [#60026](https://github.com/ClickHouse/ClickHouse/pull/60026) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена настройка `finished_mutations_to_keep=0` для MergeTree (так как в документации указано, что 0 означает «сохранять всё») [#60031](https://github.com/ClickHouse/ClickHouse/pull/60031) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено возможное возникновение исключения в таблице s3queue при её удалении [#60036](https://github.com/ClickHouse/ClickHouse/pull/60036) ([Kseniia Sumarokova](https://github.com/kssenii)).
* PartsSplitter: некорректные диапазоны для одной и той же части [#60041](https://github.com/ClickHouse/ClickHouse/pull/60041) ([Maksim Kita](https://github.com/kitaisreal)).
* Использовать max&#95;query&#95;size из контекста в DDLLogEntry вместо жёстко закодированного значения 4096 [#60083](https://github.com/ClickHouse/ClickHouse/pull/60083) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено непоследовательное форматирование запросов [#60095](https://github.com/ClickHouse/ClickHouse/pull/60095) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено непоследовательное форматирование `EXPLAIN` в подзапросах [#60102](https://github.com/ClickHouse/ClickHouse/pull/60102) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлен сбой функции cosineDistance при работе с Nullable [#60150](https://github.com/ClickHouse/ClickHouse/pull/60150) ([Raúl Marín](https://github.com/Algunenano)).
* Разрешено приводить булевы значения в строковом представлении к булевому типу [#60160](https://github.com/ClickHouse/ClickHouse/pull/60160) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлен system.s3queue&#95;log [#60166](https://github.com/ClickHouse/ClickHouse/pull/60166) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена arrayReduce при использовании имени агрегатной функции типа Nullable [#60188](https://github.com/ClickHouse/ClickHouse/pull/60188) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено выполнение операций при предварительной фильтрации (PK, отсечение партиций) [#60196](https://github.com/ClickHouse/ClickHouse/pull/60196) ([Azat Khuzhin](https://github.com/azat)).
* Скрытие конфиденциальной информации в s3queue [#60233](https://github.com/ClickHouse/ClickHouse/pull/60233) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Откат изменения «Заменить `ORDER BY ALL` на `ORDER BY *`» [#60248](https://github.com/ClickHouse/ClickHouse/pull/60248) ([Robert Schulze](https://github.com/rschu1ze)).
* Azure Blob Storage : исправлены проблемы с endpoint-адресом и префиксом [#60251](https://github.com/ClickHouse/ClickHouse/pull/60251) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлены коды HTTP-исключений. [#60252](https://github.com/ClickHouse/ClickHouse/pull/60252) ([Austin Kothig](https://github.com/kothiga)).
* исправлена ошибка в кэше LRUResource (кэш Hive) [#60262](https://github.com/ClickHouse/ClickHouse/pull/60262) ([shanfengp](https://github.com/Aed-p)).
* s3queue: исправлена ошибка (также исправлен нестабильный тест test&#95;storage&#95;s3&#95;queue/test.py::test&#95;shards&#95;distributed) [#60282](https://github.com/ClickHouse/ClickHouse/pull/60282) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено использование неинициализированного значения и некорректный результат в хеш-функциях для IPv6 [#60359](https://github.com/ClickHouse/ClickHouse/pull/60359) ([Kruglov Pavel](https://github.com/Avogar)).
* Принудительно выполнять повторный анализ при изменении параллельных реплик [#60362](https://github.com/ClickHouse/ClickHouse/pull/60362) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено использование типа метаданных plain с новым параметром конфигурации дисков [#60396](https://github.com/ClickHouse/ClickHouse/pull/60396) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Запрещена установка max&#95;parallel&#95;replicas в 0, так как это не имеет смысла [#60430](https://github.com/ClickHouse/ClickHouse/pull/60430) ([Kruglov Pavel](https://github.com/Avogar)).
* Попытка исправить логическую ошибку «Cannot capture column because it has incompatible type» в mapContainsKeyLike [#60451](https://github.com/ClickHouse/ClickHouse/pull/60451) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена работа OptimizeDateOrDateTimeConverterWithPreimageVisitor с аргументами со значением NULL [#60453](https://github.com/ClickHouse/ClickHouse/pull/60453) ([Raúl Marín](https://github.com/Algunenano)).
* Избегать вычисления скалярных подзапросов для CREATE TABLE. [#60464](https://github.com/ClickHouse/ClickHouse/pull/60464) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Объединение с [#59674](https://github.com/ClickHouse/ClickHouse/issues/59674). [#60470](https://github.com/ClickHouse/ClickHouse/pull/60470) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена проверка ключей в s3Cluster [#60477](https://github.com/ClickHouse/ClickHouse/pull/60477) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена взаимоблокировка, возникавшая при параллельном разборе, когда из-за ошибок пропускалось много строк [#60516](https://github.com/ClickHouse/ClickHouse/pull/60516) ([Kruglov Pavel](https://github.com/Avogar)).
* Fix&#95;max&#95;query&#95;size&#95;for&#95;kql&#95;compound&#95;operator: [#60534](https://github.com/ClickHouse/ClickHouse/pull/60534) ([Yong Wang](https://github.com/kashwy)).
* Исправление Keeper: добавлены тайм-ауты при ожидании журналов коммитов [#60544](https://github.com/ClickHouse/ClickHouse/pull/60544) ([Antonio Andelic](https://github.com/antonio2368)).
* Снижено количество строк, считываемых из `system.numbers` [#60546](https://github.com/ClickHouse/ClickHouse/pull/60546) ([JackyWoo](https://github.com/JackyWoo)).
* Не выводить числовые подсказки для типов даты [#60577](https://github.com/ClickHouse/ClickHouse/pull/60577) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено чтение из MergeTree при использовании недетерминированных функций в фильтре [#60586](https://github.com/ClickHouse/ClickHouse/pull/60586) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена логическая ошибка, возникавшая при неверном типе значения настройки совместимости [#60596](https://github.com/ClickHouse/ClickHouse/pull/60596) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлены неконсистентные состояния агрегатных функций в смешанных кластерах x86-64/ARM [#60610](https://github.com/ClickHouse/ClickHouse/pull/60610) ([Harry Lee](https://github.com/HarryLeeIBM)).
* fix(prql): Надёжный обработчик паники [#60615](https://github.com/ClickHouse/ClickHouse/pull/60615) ([Maximilian Roos](https://github.com/max-sixty)).
* Исправлена работа `intDiv` для аргументов типов Decimal и Date [#60672](https://github.com/ClickHouse/ClickHouse/pull/60672) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправление: разворачивать CTE в запросе ALTER MODIFY [#60682](https://github.com/ClickHouse/ClickHouse/pull/60682) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена таблица system.parts для движков баз данных, отличных от Atomic/Ordinary (например, Memory) [#60689](https://github.com/ClickHouse/ClickHouse/pull/60689) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка «Invalid storage definition in metadata file» для параметризованных представлений [#60708](https://github.com/ClickHouse/ClickHouse/pull/60708) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено переполнение буфера в кодеке CompressionCodecMultiple [#60731](https://github.com/ClickHouse/ClickHouse/pull/60731) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Удалён мусор из SQL/JSON [#60738](https://github.com/ClickHouse/ClickHouse/pull/60738) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Удалена некорректная проверка sanitize в агрегатной функции quantileGK [#60740](https://github.com/ClickHouse/ClickHouse/pull/60740) ([李扬](https://github.com/taiyang-li)).
* Исправлена ошибка insert-select + insert&#95;deduplication&#95;token путём установки параметра streams в 1 [#60745](https://github.com/ClickHouse/ClickHouse/pull/60745) ([Jordi Villar](https://github.com/jrdi)).
* Предотвращена возможность установки пользовательских заголовков метаданных для неподдерживаемых операций многокомпонентной (multipart) загрузки [#60748](https://github.com/ClickHouse/ClickHouse/pull/60748) ([Francisco J. Jurado Moreno](https://github.com/Beetelbrox)).
* Исправлена функция toStartOfInterval [#60763](https://github.com/ClickHouse/ClickHouse/pull/60763) ([Andrey Zvonov](https://github.com/zvonand)).
* Исправлен сбой в arrayEnumerateRanked [#60764](https://github.com/ClickHouse/ClickHouse/pull/60764) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено падение при использовании input() в INSERT SELECT JOIN [#60765](https://github.com/ClickHouse/ClickHouse/pull/60765) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен сбой при отличающемся значении параметра allow&#95;experimental&#95;analyzer в подзапросах [#60770](https://github.com/ClickHouse/ClickHouse/pull/60770) ([Dmitry Novik](https://github.com/novikd)).
* Удалена рекурсия при чтении из S3 [#60849](https://github.com/ClickHouse/ClickHouse/pull/60849) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено возможное зависание при ошибке в HashedDictionaryParallelLoader [#60926](https://github.com/ClickHouse/ClickHouse/pull/60926) ([vdimir](https://github.com/vdimir)).
* Исправлен асинхронный RESTORE для реплицируемой базы данных [#60934](https://github.com/ClickHouse/ClickHouse/pull/60934) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена взаимоблокировка при асинхронных вставках в таблицы типа `Log` через нативный протокол [#61055](https://github.com/ClickHouse/ClickHouse/pull/61055) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено ленивое вычисление аргумента по умолчанию в dictGetOrDefault для RangeHashedDictionary [#61196](https://github.com/ClickHouse/ClickHouse/pull/61196) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлены несколько ошибок в groupArraySorted [#61203](https://github.com/ClickHouse/ClickHouse/pull/61203) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена проблема с перенастройкой Keeper для отдельного бинарного файла [#61233](https://github.com/ClickHouse/ClickHouse/pull/61233) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено использование session&#95;token в движке S3 [#61234](https://github.com/ClickHouse/ClickHouse/pull/61234) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен возможный некорректный результат агрегатной функции `uniqExact` [#61257](https://github.com/ClickHouse/ClickHouse/pull/61257) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены ошибки в команде SHOW DATABASE [#61269](https://github.com/ClickHouse/ClickHouse/pull/61269) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена логическая ошибка в хранилище RabbitMQ при работе с MATERIALIZED столбцами [#61320](https://github.com/ClickHouse/ClickHouse/pull/61320) ([vdimir](https://github.com/vdimir)).
* Исправлен оператор CREATE OR REPLACE DICTIONARY [#61356](https://github.com/ClickHouse/ClickHouse/pull/61356) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен запрос ATTACH с внешним модификатором ON CLUSTER [#61365](https://github.com/ClickHouse/ClickHouse/pull/61365) ([Nikolay Degterinsky](https://github.com/evillique)).
* исправлена проблема с разбиением DAG действий [#61458](https://github.com/ClickHouse/ClickHouse/pull/61458) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено поведение при завершении неудавшейся операции RESTORE [#61466](https://github.com/ClickHouse/ClickHouse/pull/61466) ([Vitaly Baranov](https://github.com/vitlibar)).
* Параметр async&#95;insert&#95;use&#95;adaptive&#95;busy&#95;timeout теперь корректно отключается с помощью настроек совместимости [#61468](https://github.com/ClickHouse/ClickHouse/pull/61468) ([Raúl Marín](https://github.com/Algunenano)).
* Разрешена постановка задач в очередь пула восстановления [#61475](https://github.com/ClickHouse/ClickHouse/pull/61475) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена ошибка при чтении system.parts по UUID (issue 61220). [#61479](https://github.com/ClickHouse/ClickHouse/pull/61479) ([Dan Wu](https://github.com/wudanzy)).
* Исправлен сбой в WINDOW VIEW [#61526](https://github.com/ClickHouse/ClickHouse/pull/61526) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена работа функции `repeat` с ненативными целыми типами [#61527](https://github.com/ClickHouse/ClickHouse/pull/61527) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлен аргумент `-s` клиента [#61530](https://github.com/ClickHouse/ClickHouse/pull/61530) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Исправлена ошибка, вызывавшая падение arrayPartialReverseSort [#61539](https://github.com/ClickHouse/ClickHouse/pull/61539) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлен поиск в строке с константной позицией [#61547](https://github.com/ClickHouse/ClickHouse/pull/61547) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка, из-за которой функция addDays вызывала сбой при использовании с типом DateTime64 [#61561](https://github.com/ClickHouse/ClickHouse/pull/61561) ([Shuai li](https://github.com/loneylee)).
* Исправлен `system.part_log` для асинхронных вставок с дедупликацией [#61620](https://github.com/ClickHouse/ClickHouse/pull/61620) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлен non-ready Set для system.parts. [#61666](https://github.com/ClickHouse/ClickHouse/pull/61666) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).