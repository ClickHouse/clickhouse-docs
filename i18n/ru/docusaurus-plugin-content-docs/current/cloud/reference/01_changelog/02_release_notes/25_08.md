---
slug: /changelogs/25.8
title: 'Журнал изменений v25.8 для Cloud'
description: 'Журнал изменений для быстрого релиза v25.8'
keywords: ['changelog', 'cloud']
sidebar_label: '25.8'
sidebar_position: 1
doc_type: 'changelog'
---



## Обратно несовместимые изменения {#backward-incompatible-changes}

### Изменения в JSON и форматах данных {#json-and-data-format-changes}

- По умолчанию отключено заключение 64-битных целых чисел в кавычки в форматах JSON. [#74079](https://github.com/ClickHouse/ClickHouse/pull/74079) ([Pavel Kruglov](https://github.com/Avogar)).
- Для массивов значений с различными типами в JSON выводится тип `Array(Dynamic)` вместо безымянного `Tuple`. Чтобы использовать прежнее поведение, отключите настройку [`input_format_json_infer_array_of_dynamic_from_array_of_different_types`](/operations/settings/formats#input_format_json_infer_array_of_dynamic_from_array_of_different_types). [#80859](https://github.com/ClickHouse/ClickHouse/pull/80859) ([Pavel Kruglov](https://github.com/Avogar)).
- По умолчанию значения типа `Enum` записываются как `BYTE_ARRAY` с логическим типом `ENUM` в выходном формате Parquet. [#84169](https://github.com/ClickHouse/ClickHouse/pull/84169) ([Pavel Kruglov](https://github.com/Avogar)).

### Хранение и партиционирование {#storage-and-partitioning}

- Добавлена поддержка записи в стиле партиций Hive и переработана реализация чтения (столбцы партиций Hive больше не являются виртуальными). [#76802](https://github.com/ClickHouse/ClickHouse/pull/76802) ([Arthur Passos](https://github.com/arthurpassos)).
- По умолчанию включена настройка MergeTree [`write_marks_for_substreams_in_compact_parts`](/operations/settings/merge-tree-settings#write_marks_for_substreams_in_compact_parts). Это значительно улучшает производительность чтения подстолбцов из вновь созданных Compact-частей. Серверы версии ниже 25.5 не смогут читать новые Compact-части. [#84171](https://github.com/ClickHouse/ClickHouse/pull/84171) ([Pavel Kruglov](https://github.com/Avogar)).
- Запрещены операции `RENAME COLUMN` и `DROP COLUMN` для явно указанных столбцов суммирования в SummingMergeTree. Закрывает [#81836](https://github.com/ClickHouse/ClickHouse/issues/81836). [#82821](https://github.com/ClickHouse/ClickHouse/pull/82821) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Улучшения функций {#function-enhancements}

- Добавлен новый аргумент `unexpected_quoting_character_strategy` в функцию [`extractKeyValuePairs`](/sql-reference/functions/tuple-map-functions#extractkeyvaluepairs), который управляет поведением при неожиданном обнаружении символа `quoting_character`. Подробности см. в документации по [`extractKeyValuePairs`](/sql-reference/functions/tuple-map-functions#extractkeyvaluepairs). [#80657](https://github.com/ClickHouse/ClickHouse/pull/80657) ([Arthur Passos](https://github.com/arthurpassos)).
- Ранее функция [`countMatches`](/sql-reference/functions/string-search-functions#countMatches) прекращала подсчет при первом пустом совпадении, даже если шаблон его допускает. Для решения этой проблемы `countMatches` теперь продолжает выполнение, сдвигаясь на один символ при возникновении пустого совпадения. Пользователи, желающие сохранить прежнее поведение, могут включить настройку `count_matches_stop_at_empty_match`. [#81676](https://github.com/ClickHouse/ClickHouse/pull/81676) ([Elmi Ahmadov](https://github.com/ahmadov)).

### Улучшения типов данных {#data-type-improvements}

- Улучшена точность преобразования из `Decimal` в `Float32`. Реализовано преобразование из `Decimal` в `BFloat16`. Закрывает [#82660](https://github.com/ClickHouse/ClickHouse/issues/82660). [#82823](https://github.com/ClickHouse/ClickHouse/pull/82823) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Производительность и управление ресурсами {#performance-and-resource-management}


- Ранее запросы `BACKUP`, слияния и мутации не использовали общесерверные ограничители пропускной способности для локального (`max_local_read_bandwidth_for_server` и `max_local_write_bandwidth_for_server`) и удалённого (`max_remote_read_network_bandwidth_for_server` и `max_remote_write_network_bandwidth_for_server`) трафика, вместо этого они ограничивались только выделенными настройками сервера (`max_backup_bandwidth_for_server`, `max_mutations_bandwidth_for_server` и `max_merges_bandwidth_for_server`). Теперь они используют оба типа ограничителей одновременно. [#81753](https://github.com/ClickHouse/ClickHouse/pull/81753) ([Sergei Trifonov](https://github.com/serxa)).
- Добавлена новая настройка [`cluster_function_process_archive_on_multiple_nodes`](/operations/settings/settings#cluster_function_process_archive_on_multiple_nodes), которая повышает производительность обработки архивов в кластерных функциях при установке значения true (по умолчанию). Следует установить значение `false` для обеспечения совместимости и предотвращения ошибок при обновлении до версии 25.7+ в случае использования кластерных функций с архивами в более ранних версиях. [#82355](https://github.com/ClickHouse/ClickHouse/pull/82355) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Предыдущее значение по умолчанию для [`concurrent_threads_scheduler`](/operations/server-configuration-parameters/settings#concurrent_threads_scheduler) было `round_robin`, что оказалось несправедливым при наличии большого количества однопоточных запросов (например, `INSERT`). Данное изменение делает более безопасную альтернативу `fair_round_robin` планировщиком по умолчанию. [#84747](https://github.com/ClickHouse/ClickHouse/pull/84747) ([Sergei Trifonov](https://github.com/serxa)).
- Ленивая материализация включена только при использовании анализатора, чтобы избежать проблем при работе без анализатора (например, при использовании `indexHint()` в условиях). [#83791](https://github.com/ClickHouse/ClickHouse/pull/83791) ([Igor Nikonov](https://github.com/devcrafter)).

### Схема и синтаксис SQL {#schema-and-sql-syntax}

- Запрещено создание таблицы без столбцов, допускающих вставку данных. [#81835](https://github.com/ClickHouse/ClickHouse/pull/81835) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
- Требуется использование обратных кавычек вокруг идентификаторов с точками в выражениях по умолчанию, чтобы предотвратить их интерпретацию как составных идентификаторов. [#83162](https://github.com/ClickHouse/ClickHouse/pull/83162) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
- Добавлена поддержка синтаксиса heredoc в стиле PostgreSQL: `$tag$ содержимое строки... $tag$`, также известного как строковые литералы в долларовых кавычках. В предыдущих версиях было меньше ограничений на теги: они могли содержать произвольные символы, включая знаки пунктуации и пробелы. Это вносило неоднозначность при разборе идентификаторов, которые также могут начинаться с символа доллара. В то же время PostgreSQL разрешает только буквенно-цифровые символы для тегов. Для решения этой проблемы теперь теги heredoc ограничены только буквенно-цифровыми символами. Закрывает [#84731](https://github.com/ClickHouse/ClickHouse/issues/84731). [#84846](https://github.com/ClickHouse/ClickHouse/pull/84846) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Безопасность и права доступа {#security-and-permissions}

- `SYSTEM RESTART REPLICAS` будет перезапускать реплики только в тех базах данных, где у вас есть разрешение на выполнение `SHOW TABLES`. Ранее запрос приводил к активации таблиц в базе данных Lazy даже без доступа к этой базе данных, в то время как эти таблицы одновременно удалялись. [#83321](https://github.com/ClickHouse/ClickHouse/pull/83321) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Функции `azureBlobStorage`, `deltaLakeAzure` и `icebergAzure` были обновлены для корректной проверки разрешений `AZURE`. Все кластерные варианты функций (функции `-Cluster`) теперь проверяют разрешения в соответствии с их некластерными аналогами. Кроме того, функции `icebergLocal` и `deltaLakeLocal` теперь выполняют проверки разрешений `FILE`. [#84938](https://github.com/ClickHouse/ClickHouse/pull/84938) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov


## Новые возможности {#new-feature}

### Типы данных {#data-types}

- Добавлены новые типы данных: [`Time`](/sql-reference/data-types/time) `([H]HH:MM:SS)` и [`Time64`](/sql-reference/data-types/time64) `([H]HH:MM:SS[.fractional])`, а также базовые функции приведения типов и функции для взаимодействия с другими типами данных. Добавлены настройки для обеспечения совместимости с устаревшей функцией `ToTime`. [#81217](https://github.com/ClickHouse/ClickHouse/pull/81217) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).

### Функции {#functions}


* Добавлен [`NumericIndexedVector`](/sql-reference/functions/numeric-indexed-vector-functions) — новая векторная структура данных на основе bit-sliced-сжатия roaring-bitmap, а также более 20 функций для построения, анализа и покомпонентной арифметики. Может уменьшать объём хранения и ускорять `JOIN`, фильтры и агрегации на разреженных данных. Реализует [#70582](https://github.com/ClickHouse/ClickHouse/issues/70582) и основан на статье [&quot;Large-Scale Metric Computation in Online Controlled Experiment Platform&quot;](https://arxiv.org/abs/2405.08411) T. Xiong и Y. Wang, представленной на конференции VLDB 2024. [#74193](https://github.com/ClickHouse/ClickHouse/pull/74193) ([FriendLey](https://github.com/FriendLey)).
* Добавлены финансовые функции: [`financialInternalRateOfReturnExtended`](/sql-reference/functions/financial-functions#financialInternalRateOfReturnExtended) (`XIRR`), [`financialInternalRateOfReturn`](/sql-reference/functions/financial-functions#financialInternalRateOfReturn) (`IRR`), [`financialNetPresentValueExtended`](/sql-reference/functions/financial-functions#financialNetPresentValueExtended) (`XNPV`), [`financialNetPresentValue`](/sql-reference/functions/financial-functions#financialNetPresentValue) (`NPV`). [#81599](https://github.com/ClickHouse/ClickHouse/pull/81599) ([Joanna Hulboj](https://github.com/jh0x)).
* Добавлены геопространственные функции [`polygonIntersectsCartesian`](/sql-reference/functions/geo/polygons#polygonsintersectcartesian) и [`polygonIntersectsSpherical`](/sql-reference/functions/geo/polygons#polygonsintersectspherical) для проверки, пересекаются ли два полигона. [#81882](https://github.com/ClickHouse/ClickHouse/pull/81882) ([Paul Lamb](https://github.com/plamb)).
* Добавлена поддержка оконных функций [`lag`](/sql-reference/window-functions/lag) и [`lead`](/sql-reference/window-functions/lead). Закрывает [#9887](https://github.com/ClickHouse/ClickHouse/issues/9887). [#82108](https://github.com/ClickHouse/ClickHouse/pull/82108) ([Dmitry Novik](https://github.com/novikd)).
* Добавлены функции [`colorSRGBToOkLCH`](/sql-reference/functions/other-functions#colorSRGBToOKLCH) и [`colorOkLCHToSRGB`](/sql-reference/functions/other-functions#colorOKLCHToSRGB) для преобразования цветов между цветовыми пространствами sRGB и OkLCH. [#83679](https://github.com/ClickHouse/ClickHouse/pull/83679) ([Fgrtue](https://github.com/Fgrtue)).
* Теперь пользователи могут выполнять поиск по JSON-ключам без учета регистра с помощью [`JSONExtractCaseInsensitive`](/sql-reference/functions/json-functions#JSONExtractCaseInsensitive) (и других вариантов `JSONExtract`). [#83770](https://github.com/ClickHouse/ClickHouse/pull/83770) ([Alistair Evans](https://github.com/alistairjevans)).
* Добавлена новая функция [`nowInBlock64`](/sql-reference/functions/date-time-functions#nowInBlock64). [#84178](https://github.com/ClickHouse/ClickHouse/pull/84178) ([Halersson Paris](https://github.com/halersson)).
* Добавлена функция [`dateTimeToUUIDv7`](/sql-reference/functions/uuid-functions#dateTimeToUUIDv7) для преобразования значения `DateTime` в UUIDv7. Пример использования: `SELECT dateTimeToUUIDv7(toDateTime('2025-08-15 18:57:56'))` возвращает `0198af18-8320-7a7d-abd3-358db23b9d5c`. [#84319](https://github.com/ClickHouse/ClickHouse/pull/84319) ([samradovich](https://github.com/samradovich)).
* Добавлены агрегатные функции [`timeSeriesDerivToGrid`](/sql-reference/aggregate-functions/reference/timeSeriesDerivToGrid) и [`timeSeriesPredictLinearToGrid`](/sql-reference/aggregate-functions/reference/timeSeriesPredictLinearToGrid) для ресэмплинга данных по временной сетке, задаваемой начальной меткой времени, конечной меткой времени и шагом; соответственно вычисляют функции `deriv` и `predict_linear` в стиле PromQL. [#84328](https://github.com/ClickHouse/ClickHouse/pull/84328) ([Stephen Chi](https://github.com/stephchi0)).
* Добавлены функции [`timeSeriesRange`](/sql-reference/functions/time-series-functions#timeSeriesRange) и [`timeSeriesFromGrid`](/sql-reference/functions/time-series-functions#timeSeriesFromGrid). [#85435](https://github.com/ClickHouse/ClickHouse/pull/85435) ([Vitaly Baranov](https://github.com/vitlibar)).

### Системные таблицы {#system-tables}

- Добавлена таблица [`system.dead_letter_queue`](/operations/system-tables/dead_letter_queue) для хранения ошибочных входящих сообщений от движков типа Kafka. [#68873](https://github.com/ClickHouse/ClickHouse/pull/68873) ([Ilya Golshtein](https://github.com/ilejn)).
- Добавлена системная таблица [`system.zookeeper_connection_log`](/operations/system-tables/zookeeper_connection_log) для хранения исторической информации о соединениях с ZooKeeper. [#79494](https://github.com/ClickHouse/ClickHouse/pull/79494) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Добавлена новая системная таблица [`system.codecs`](/operations/system-tables/codecs) для получения информации о доступных кодеках. (issue [#81525](https://github.com/ClickHouse/ClickHouse/issues/81525)). [#81600](https://github.com/ClickHouse/ClickHouse/pull/81600) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
- Добавлена таблица `system.completions`. Closes [#81889](https://github.com/ClickHouse/ClickHouse/issues/81889). [#83833](https://github.com/ClickHouse/ClickHouse/pull/83833) ([|2ustam](https://github.com/RuS2m)).

### Iceberg и DeltaLake {#iceberg-and-deltalake}

- Поддержка сложных типов данных при эволюции схемы Iceberg. [#73714](https://github.com/ClickHouse/ClickHouse/pull/73714) ([scanhex12](https://github.com/scanhex12)).
- Реализована запись в Iceberg для запросов `insert`. [#82692](https://github.com/ClickHouse/ClickHouse/pull/82692) ([scanhex12](https://github.com/scanhex12)).
- Поддержка позиционных удалений для движка таблиц Iceberg. [#83094](https://github.com/ClickHouse/ClickHouse/pull/83094) ([Daniil Ivanik](https://github.com/divanik)).
- Чтение файлов данных Iceberg по идентификаторам полей. Closes [#83065](https://github.com/ClickHouse/ClickHouse/issues/83065). [#83653](https://github.com/ClickHouse/ClickHouse/pull/83653) ([scanhex12](https://github.com/scanhex12)).
- Запись в Iceberg при создании таблиц. Closes [#83927](https://github.com/ClickHouse/ClickHouse/issues/83927). [#83983](https://github.com/ClickHouse/ClickHouse/pull/83983) ([scanhex12](https://github.com/scanhex12)).
- Запись для каталогов Glue. [#84136](https://github.com/ClickHouse/ClickHouse/pull/84136) ([scanhex12](https://github.com/scanhex12)).
- Запись для каталогов Iceberg REST. [#84684](https://github.com/ClickHouse/ClickHouse/pull/84684) ([scanhex12](https://github.com/scanhex12)).
- Объединение всех файлов позиционных удалений Iceberg в файлы данных. Это уменьшит количество и размеры файлов Parquet в хранилище Iceberg. Синтаксис: `OPTIMIZE TABLE table_name`. [#85250](https://github.com/ClickHouse/ClickHouse/pull/85250) ([scanhex12](https://github.com/scanhex12)).
- Поддержка `DROP TABLE` для Iceberg (удаление из каталогов REST/Glue и удаление метаданных таблицы). [#85395](https://github.com/ClickHouse/ClickHouse/pull/85395) ([scanhex12](https://github.com/scanhex12)).
- Поддержка мутаций `ALTER DELETE` для Iceberg в формате merge-on-read. [#85549](https://github.com/ClickHouse/ClickHouse/pull/85549) ([scanhex12](https://github.com/scanhex12)).
- Поддержка записи в DeltaLake. Closes [#79603](https://github.com/ClickHouse/ClickHouse/issues/79603). [#85564](https://github.com/ClickHouse/ClickHouse/pull/85564) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Запись дополнительной статистики Iceberg (размеры столбцов, нижние и верхние границы) в метаданные (записи манифеста) для отсечения по минимальным и максимальным значениям. [#85746](https://github.com/ClickHouse/ClickHouse/pull/85746) ([scanhex12](https://github.com/scanhex12)).
- Поддержка добавления, удаления и изменения столбцов в Iceberg для простых типов данных. [#85769](https://github.com/ClickHouse/ClickHouse/pull/85769) ([scanhex12](https://github.com/scanhex12)).


### MergeTree и хранение данных {#mergetree-and-storage}

- Все таблицы теперь поддерживают виртуальный столбец `_table`, а не только таблицы типа Merge. [#63665](https://github.com/ClickHouse/ClickHouse/pull/63665) ([Xiaozhe Yu](https://github.com/wudidapaopao)).
- Добавлен кодек сжатия SZ3 с потерями, но с ограниченной погрешностью, для столбцов типа `Float32` и `Float64`. [#67161](https://github.com/ClickHouse/ClickHouse/pull/67161) ([scanhex12](https://github.com/scanhex12)).
- Добавлена поддержка облегчённых обновлений для таблиц семейства `MergeTree`. Облегчённые обновления можно использовать с помощью нового синтаксиса: `UPDATE <table> SET col1 = val1, col2 = val2, ... WHERE <condition>`. Добавлена реализация облегчённых удалений через облегчённые обновления, которую можно включить, установив `lightweight_delete_mode = 'lightweight_update'`. [#82004](https://github.com/ClickHouse/ClickHouse/pull/82004) ([Anton Popov](https://github.com/CurtizJ)).
- Поддержка виртуального столбца `_part_granule_offset` в таблицах семейства MergeTree. Этот столбец указывает индекс гранулы/метки (начиная с нуля), к которой принадлежит каждая строка в пределах её части данных. Это решает проблему [#79572](https://github.com/ClickHouse/ClickHouse/issues/79572). [#82341](https://github.com/ClickHouse/ClickHouse/pull/82341) ([Amos Bird](https://github.com/amosbird)).

### Поддержка протоколов и клиентов {#protocol-and-client-support}

- Реализована поддержка протокола [ArrowFlight RPC](https://arrow.apache.org/docs/format/Flight.html) путём добавления движка таблиц [`arrowflight`](/engines/table-engines/integrations/arrowflight). [#74184](https://github.com/ClickHouse/ClickHouse/pull/74184) ([zakr600](https://github.com/zakr600)).
- Добавлена поддержка команды `COPY` протокола PostgreSQL. [#74344](https://github.com/ClickHouse/ClickHouse/pull/74344) ([scanhex12](https://github.com/scanhex12)).
- Поддержка клиента C# для протокола mysql. Это закрывает [#83992](https://github.com/ClickHouse/ClickHouse/issues/83992). [#84397](https://github.com/ClickHouse/ClickHouse/pull/84397) ([scanhex12](https://github.com/scanhex12)).
- Принудительное использование защищённого соединения для `mysql_port` и `postgresql_port`. [#82962](https://github.com/ClickHouse/ClickHouse/pull/82962) ([Shaohua Wang](https://github.com/tiandiwonder)).

### Возможности SQL и запросов {#sql-and-query-features}

- Поддержка `DESCRIBE SELECT` в дополнение к `DESCRIBE (SELECT ...)`. [#82947](https://github.com/ClickHouse/ClickHouse/pull/82947) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Поддержка записи `USE DATABASE {name}`. [#81307](https://github.com/ClickHouse/ClickHouse/pull/81307) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Реализовано чтение из проекций для параллельных реплик. Добавлена новая настройка [`parallel_replicas_support_projection`](/operations/settings/settings#parallel_replicas_support_projection) для управления включением поддержки проекций. Для упрощения реализации поддержка проекций включена только при активной настройке `parallel_replicas_local_plan`. [#82807](https://github.com/ClickHouse/ClickHouse/pull/82807) ([zoomxi](https://github.com/zoomxi)).

### Форматы {#formats}

- Добавлена настройка [`format_schema_source`](/operations/settings/formats#format_schema_source), которая определяет источник `format_schema`. [#80874](https://github.com/ClickHouse/ClickHouse/pull/80874) ([Tuan Pham Anh](https://github.com/tuanpach)).
- Добавлен новый выходной формат `Hash`. Он вычисляет единственное хеш-значение для всех столбцов и строк результата. Это полезно для вычисления «отпечатка» результата, например, в случаях, когда передача данных является узким местом. Пример: `SELECT arrayJoin(['abc', 'def']), 42 FORMAT Hash` возвращает `e5f9e676db098fdb9530d2059d8c23ef`. [#84607](https://github.com/ClickHouse/ClickHouse/pull/84607) ([Robert Schulze](https://github.com/rschu1ze)).


### Конфигурация сервера и управление рабочими нагрузками {#server-configuration-and-workload-management}

- Серверная настройка [`cpu_slot_preemption`](/operations/server-configuration-parameters/settings#cpu_slot_preemption) включает вытесняющее планирование CPU для рабочих нагрузок и обеспечивает справедливое распределение процессорного времени между нагрузками по принципу max-min. Добавлены новые настройки рабочих нагрузок для регулирования использования CPU: `max_cpus`, `max_cpu_share` и `max_burst_cpu_seconds`. [#80879](https://github.com/ClickHouse/ClickHouse/pull/80879) ([Sergei Trifonov](https://github.com/serxa)).
- Теперь поддерживается настройка рабочей нагрузки [`max_waiting_queries`](/operations/server-configuration-parameters/settings#max_waiting_queries). Она позволяет ограничить размер очереди запросов. При достижении лимита все последующие запросы будут завершены с ошибкой `SERVER_OVERLOADED`. [#81250](https://github.com/ClickHouse/ClickHouse/pull/81250) ([Oleg Doronin](https://github.com/dorooleg)).
- Разрыв TCP-соединения после заданного количества запросов или по истечении временного порога. Решает проблему [#68000](https://github.com/ClickHouse/ClickHouse/issues/68000). [#81472](https://github.com/ClickHouse/ClickHouse/pull/81472) ([Kenny Sun](https://github.com/hwabis)).

### Облачное хранилище {#cloud-storage}

- Добавлен параметр `extra_credentials` в `AzureBlobStorage` для аутентификации с использованием `client_id` и `tenant_id`. [#84235](https://github.com/ClickHouse/ClickHouse/pull/84235) ([Pablo Marcos](https://github.com/pamarcos)).

### Keeper {#keeper}

- Добавлена возможность настройки произвольных watches в Multi-запросах Keeper. [#84964](https://github.com/ClickHouse/ClickHouse/pull/84964) ([Mikhail Artemenko](https://github.com/Michicosun)).
- Поддержка частично агрегированных метрик. [#85328](https://github.com/ClickHouse/ClickHouse/pull/85328) ([Mikhail Artemenko](https://github.com/Michicosun)).


## Экспериментальные функции {#experimental-features}

### Движки таблиц и табличные функции {#table-engines-and-table-functions}

- Добавлены движок таблиц и табличная функция Ytsaurus. [#77606](https://github.com/ClickHouse/ClickHouse/pull/77606) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).

### Улучшения текстовых индексов {#text-index-improvements}

- Добавлены функции `searchAny` и `searchAll` — универсальные инструменты для поиска по текстовым индексам. [#80641](https://github.com/ClickHouse/ClickHouse/pull/80641) ([Elmi Ahmadov](https://github.com/ahmadov)).
- Текстовый индекс теперь поддерживает токенизатор `string`. [#81752](https://github.com/ClickHouse/ClickHouse/pull/81752) ([Elmi Ahmadov](https://github.com/ahmadov)).
- Изменено значение гранулярности индекса по умолчанию для индексов `text` на 64. Это улучшает ожидаемую производительность среднего тестового запроса во внутренних бенчмарках. [#82162](https://github.com/ClickHouse/ClickHouse/pull/82162) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
- 256-битная битовая карта хранит исходящие метки состояния упорядоченными, но исходящие состояния сохраняются на диск в порядке их появления в хеш-таблице. Поэтому метка может указывать на неправильное следующее состояние при чтении с диска. [#82783](https://github.com/ClickHouse/ClickHouse/pull/82783) ([Elmi Ahmadov](https://github.com/ahmadov)).
- В настоящее время дерево FST сохраняется на диск без сжатия. Это может привести к снижению производительности или увеличению нагрузки на подсистему ввода-вывода как при записи, так и при чтении данных с диска. [#83093](https://github.com/ClickHouse/ClickHouse/pull/83093) ([Elmi Ahmadov](https://github.com/ahmadov)).

### Обновления статуса зрелости функций {#feature-maturity-updates}

- Каталог переведён в статус бета-версии. [#85848](https://github.com/ClickHouse/ClickHouse/pull/85848) ([Melvyn Peignon](https://github.com/melvynator)).
- Лёгкие обновления переведены из экспериментального статуса в бета-версию. [#85952](https://github.com/ClickHouse/ClickHouse/pull/85952) ([Anton Popov](https://github.com/CurtizJ)).


## Улучшения производительности {#performance-improvements}

### Выполнение запросов и агрегация {#query-execution-and-aggregation}

- Тривиальная оптимизация для комбинатора агрегатных функций `-If`. [#78454](https://github.com/ClickHouse/ClickHouse/pull/78454) ([李扬](https://github.com/taiyang-li)).
- Добавлена новая логика (управляется настройкой [`enable_producing_buckets_out_of_order_in_aggregation`](/operations/settings/settings#enable_producing_buckets_out_of_order_in_aggregation), включена по умолчанию), которая позволяет отправлять некоторые сегменты не по порядку во время памяти-эффективной агрегации. Когда слияние некоторых сегментов агрегации занимает значительно больше времени, чем других, это улучшает производительность, позволяя инициатору тем временем объединять сегменты с более высокими идентификаторами. Недостатком является потенциально более высокое потребление памяти (не должно быть значительным). [#80179](https://github.com/ClickHouse/ClickHouse/pull/80179) ([Nikita Taranov](https://github.com/nickitat)).
- Конвейер после шага `TOTALS` теперь многопоточный. [#80331](https://github.com/ClickHouse/ClickHouse/pull/80331) ([UnamedRus](https://github.com/UnamedRus)).
- Когда запрос агрегации содержит только одну функцию `COUNT()` для столбца `NOT NULL`, логика агрегации полностью встраивается во время зондирования хеш-таблицы. Это позволяет избежать выделения и поддержки состояния агрегации, значительно снижая потребление памяти и нагрузку на процессор. Это частично решает проблему [#81982](https://github.com/ClickHouse/ClickHouse/issues/81982). [#82104](https://github.com/ClickHouse/ClickHouse/pull/82104) ([Amos Bird](https://github.com/amosbird)).
- Вычисление сериализованного ключа по столбцам при группировке по нескольким строковым или числовым столбцам. [#83884](https://github.com/ClickHouse/ClickHouse/pull/83884) ([李扬](https://github.com/taiyang-li)).
- Реализован метод `addManyDefaults` для комбинаторов `-If`. [#83870](https://github.com/ClickHouse/ClickHouse/pull/83870) ([Raúl Marín](https://github.com/Algunenano)).

### Оптимизации JOIN {#join-optimizations}


- Добавлена новая настройка [`min_joined_block_size_rows`](/operations/settings/settings#min_joined_block_size_rows) (аналог `min_joined_block_size_bytes`; по умолчанию 65409) для управления минимальным размером блока (в строках) для входных и выходных блоков JOIN (если алгоритм соединения это поддерживает). Маленькие блоки будут объединяться. [#81886](https://github.com/ClickHouse/ClickHouse/pull/81886) ([Nikita Taranov](https://github.com/nickitat)).
- Производительность `HashJoin` оптимизирована за счёт удаления дополнительного цикла по хеш-таблицам в типичном случае с одним ключевым столбцом, также устранены проверки `null_map` и `join_mask`, когда они всегда `true`/`false`. [#82308](https://github.com/ClickHouse/ClickHouse/pull/82308) ([Nikita Taranov](https://github.com/nickitat)).
- Оптимизации для `null_map` и `JoinMask` из [#82308](https://github.com/ClickHouse/ClickHouse/issues/82308) применены к случаю JOIN с несколькими дизъюнктами. Также оптимизирована структура данных `KnownRowsHolder`. [#83041](https://github.com/ClickHouse/ClickHouse/pull/83041) ([Nikita Taranov](https://github.com/nickitat)).
- Для флагов соединения используется обычный `std::vector<std::atomic_bool>`, чтобы избежать вычисления хеша при каждом обращении к флагам. [#83043](https://github.com/ClickHouse/ClickHouse/pull/83043) ([Nikita Taranov](https://github.com/nickitat)).
- Обработка `max_joined_block_rows` вынесена за пределы основного цикла хеш-JOIN. Немного улучшена производительность для ALL JOIN. [#83216](https://github.com/ClickHouse/ClickHouse/pull/83216) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Не выполняется предварительное выделение памяти для результирующих столбцов, когда `HashJoin` использует режим вывода `lazy`. Это неоптимально, особенно когда количество совпадений невелико. Более того, точное количество совпадений известно после завершения соединения, поэтому можно выделить память более точно. [#83304](https://github.com/ClickHouse/ClickHouse/pull/83304) ([Nikita Taranov](https://github.com/nickitat)).
- Все `LEFT/INNER` JOIN будут автоматически преобразованы в `RightAny`, если правая сторона функционально определяется столбцами ключа соединения (все строки имеют уникальные значения ключа соединения). [#84010](https://github.com/ClickHouse/ClickHouse/pull/84010) ([Nikita Taranov](https://github.com/nickitat)).
- Улучшена производительность применения патч-частей в режиме `Join`. [#85040](https://github.com/ClickHouse/ClickHouse/pull/85040) ([Anton Popov](https://github.com/CurtizJ)).

### Улучшения распределённых запросов {#distributed-query-improvements}


- Добавлена возможность переноса (де)компрессии и (де)сериализации блоков в потоки конвейера вместо единственного потока, связанного с сетевым соединением. Управляется настройкой `enable_parallel_blocks_marshalling`. Это должно ускорить распределённые запросы, передающие значительные объёмы данных между инициатором и удалёнными узлами. [#78694](https://github.com/ClickHouse/ClickHouse/pull/78694) ([Nikita Taranov](https://github.com/nickitat)).
- Параллельный распределённый `INSERT SELECT` включён по умолчанию в режиме, где `INSERT SELECT` выполняется на каждом шарде независимо, см. настройку `parallel_distributed_insert_select`. [#80425](https://github.com/ClickHouse/ClickHouse/pull/80425) ([Igor Nikonov](https://github.com/devcrafter)).
- Сжатие логов и событий профилирования в нативном протоколе. На кластерах со 100+ репликами несжатые события профилирования занимают 1..10 МБ/сек, и индикатор прогресса работает медленно при медленных интернет-соединениях. Это закрывает [#82533](https://github.com/ClickHouse/ClickHouse/issues/82533). [#82535](https://github.com/ClickHouse/ClickHouse/pull/82535) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Параллельный распределённый `INSERT SELECT` включён по умолчанию в режиме, где INSERT SELECT выполняется на каждом шарде независимо, см. настройку `parallel_distributed_insert_select`. [#83040](https://github.com/ClickHouse/ClickHouse/pull/83040) ([Igor Nikonov](https://github.com/devcrafter)).
- Исправлен расчёт минимального размера задачи для параллельных реплик. [#84752](https://github.com/ClickHouse/ClickHouse/pull/84752) ([Nikita Taranov](https://github.com/nickitat)).

### Улучшения индексов {#index-improvements}

- Запросы векторного поиска с использованием индекса векторного сходства завершаются с меньшей задержкой благодаря сокращению операций чтения из хранилища и снижению использования CPU. [#79103](https://github.com/ClickHouse/ClickHouse/pull/79103) ([Shankar Iyer](https://github.com/shankar-iyer)).
- Учёт `merge_tree_min_{rows,bytes}_for_seek` в `filterPartsByQueryConditionCache` для согласования с другими методами фильтрации по индексам. [#80312](https://github.com/ClickHouse/ClickHouse/pull/80312) ([李扬](https://github.com/taiyang-li)).
- Обработка min-max индексов с более высокой гранулярностью в первую очередь. Закрывает [#75381](https://github.com/ClickHouse/ClickHouse/issues/75381). [#83798](https://github.com/ClickHouse/ClickHouse/pull/83798) ([Maruth Goyal](https://github.com/maruthgoyal)).
- Индекс bloom filter теперь используется для условий вида `has([c1, c2, ...], column)`, где `column` не является типом `Array`. Это улучшает производительность таких запросов, делая их столь же эффективными, как оператор `IN`. [#83945](https://github.com/ClickHouse/ClickHouse/pull/83945) ([Doron David](https://github.com/dorki)).
- Обработка индексов в порядке возрастания размера файла. Итоговый порядок индексов отдаёт приоритет minmax и векторным индексам (из-за простоты и селективности соответственно), а затем небольшим индексам. Среди minmax/векторных индексов также предпочтение отдаётся меньшим индексам. [#84094](https://github.com/ClickHouse/ClickHouse/pull/84094) ([Maruth Goyal](https://github.com/maruthgoyal)).
- Ранее данные текстового индекса разделялись на несколько сегментов (размер каждого сегмента по умолчанию составлял 256 МиБ). Это могло снизить потребление памяти при построении текстового индекса, однако увеличивало требования к дисковому пространству и время отклика запросов. [#84590](https://github.com/ClickHouse/ClickHouse/pull/84590) ([Elmi Ahmadov](https://github.com/ahmadov)).

### Оптимизации подзапросов {#subquery-optimizations}


- Оптимизирован генерируемый план для коррелированных подзапросов путем удаления избыточных операций `JOIN` с использованием классов эквивалентности. Если для всех коррелированных столбцов существуют эквивалентные выражения, `CROSS JOIN` не создается при включенной настройке `query_plan_correlated_subqueries_use_substitution`. [#82435](https://github.com/ClickHouse/ClickHouse/pull/82435) ([Dmitry Novik](https://github.com/novikd)).
- Чтение только необходимых столбцов в коррелированном подзапросе, когда он является аргументом функции `EXISTS`. [#82443](https://github.com/ClickHouse/ClickHouse/pull/82443) ([Dmitry Novik](https://github.com/novikd)).

### Улучшения Azure Blob Storage {#azure-blob-storage-improvements}

- Движок таблиц [`azureBlobStorage`](/engines/table-engines/integrations/azureBlobStorage) теперь кэширует и повторно использует токены аутентификации управляемых удостоверений, когда это возможно, чтобы избежать троттлинга. [#79860](https://github.com/ClickHouse/ClickHouse/pull/79860) ([Nick Blakely](https://github.com/niblak)).
- Замена HTTP-клиента curl на HTTP-клиент poco для Azure Blob Storage. Введены множественные настройки для этих клиентов, которые дублируют настройки из S3. Введены агрессивные таймауты подключения как для Azure, так и для S3. Улучшена интроспекция событий профилирования и метрик Azure. Новый клиент включен по умолчанию и обеспечивает значительно меньшие задержки для холодных запросов к Azure Blob Storage. Старый клиент `Curl` можно вернуть, установив `azure_sdk_use_native_client=false`. [#83294](https://github.com/ClickHouse/ClickHouse/pull/83294) ([alesapin](https://github.com/alesapin)).

### Улучшения движков хранения {#storage-engine-improvements}

- Исправлена фильтрация по ключу для хранилищ Redis и KeeperMap. [#81833](https://github.com/ClickHouse/ClickHouse/pull/81833) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
- `ATTACH PARTITION` больше не приводит к сбросу всех кэшей. [#82377](https://github.com/ClickHouse/ClickHouse/pull/82377) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Устранено удержание блокировки при создании снимка данных хранилища для снижения конкуренции за блокировки при высокой параллельной нагрузке. [#83510](https://github.com/ClickHouse/ClickHouse/pull/83510) ([Duc Canh Le](https://github.com/canhld94)).
- Удаление временных частей может занять некоторое время (особенно с S3), и в настоящее время это выполняется при удержании глобальной блокировки в `MergeTreeBackgroundExecutor`. Когда необходимо перезапустить все таблицы из-за потери соединения и мы ожидаем завершения фоновых задач, таблицы могут застрять в режиме только для чтения на час. Однако похоже, что эта блокировка не нужна для вызова `cancel`. [#84311](https://github.com/ClickHouse/ClickHouse/pull/84311) ([Alexander Tokmakov](https://github.com/tavplubix)).

### Улучшения форматов {#format-improvements}

- Новая реализация читателя parquet. Она в целом быстрее и поддерживает проталкивание фильтров на уровне страниц и `PREWHERE`. В настоящее время экспериментальная. Используйте настройку `input_format_parquet_use_native_reader_v3` для включения. [#82789](https://github.com/ClickHouse/ClickHouse/pull/82789) ([Michael Kolupaev](https://github.com/al13n321)).
- Улучшена производительность входного формата ProtobufSingle за счет повторного использования сериализатора при отсутствии ошибок парсинга. [#83613](https://github.com/ClickHouse/ClickHouse/pull/83613) ([Eduard Karacharov](https://github.com/korowa)).

### Оптимизации типов данных и сериализации {#data-type-and-serialization-optimizations}

- Значительно улучшена производительность чтения подстолбцов `JSON` из общих данных в MergeTree путем реализации новых сериализаций для общих данных `JSON` в MergeTree. [#83777](https://github.com/ClickHouse/ClickHouse/pull/83777) ([Pavel Kruglov](https://github.com/Avogar)).
- Оптимизирована десериализация строк путем упрощения кода. Закрывает [#38564](https://github.com/ClickHouse/ClickHouse/issues/38564). [#84561](https://github.com/ClickHouse/ClickHouse/pull/84561) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Улучшения конвейера и выполнения {#pipeline-and-execution-improvements}


- Минимизировано копирование памяти в заголовках портов при построении конвейера. Оригинальный [PR](https://github.com/ClickHouse/ClickHouse/pull/70105) от [heymind](https://github.com/heymind). [#83381](https://github.com/ClickHouse/ClickHouse/pull/83381) ([Raúl Marín](https://github.com/Algunenano)).
- Улучшена производительность построения конвейера. [#83631](https://github.com/ClickHouse/ClickHouse/pull/83631) ([Raúl Marín](https://github.com/Algunenano)).
- Оптимизирован MergeTreeReadersChain::getSampleBlock. [#83875](https://github.com/ClickHouse/ClickHouse/pull/83875) ([Raúl Marín](https://github.com/Algunenano)).
- Оптимизирована материализация констант в случаях, когда материализация выполняется только для возврата одной строки. [#85071](https://github.com/ClickHouse/ClickHouse/pull/85071) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Оптимизации памяти и ресурсов {#memory-and-resource-optimizations}

- Настроены некоторые параметры конфигурации jemalloc для улучшения производительности. [#81807](https://github.com/ClickHouse/ClickHouse/pull/81807) ([Antonio Andelic](https://github.com/antonio2368)).
- Добавлено выравнивание в счетчике ProfileEvents для уменьшения ложного разделения кэша. [#82697](https://github.com/ClickHouse/ClickHouse/pull/82697) ([Jiebin Sun](https://github.com/jiebinn)).
- Сокращено количество ненужных вызовов memcpy в CompressedReadBufferBase::readCompressedData. [#83986](https://github.com/ClickHouse/ClickHouse/pull/83986) ([Raúl Marín](https://github.com/Algunenano)).

### Планирование и анализ запросов {#query-planning-and-analysis}

- Ускорена работа QueryTreeHash. [#82617](https://github.com/ClickHouse/ClickHouse/pull/82617) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).

### Улучшения логирования {#logging-improvements}

- Внедрено асинхронное логирование. [#82516](https://github.com/ClickHouse/ClickHouse/pull/82516) ([Raúl Marín](https://github.com/Algunenano)).

### Оптимизации функций {#function-optimizations}

- Оптимизирована функция `largestTriangleThreeBuckets` путем удаления временных данных. [#84479](https://github.com/ClickHouse/ClickHouse/pull/84479) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Оптимизирована и упрощена реализация многих функций обработки строк. Исправлена некорректная документация для нескольких функций. Примечание: результат работы функции `byteSize` для столбцов типа String и сложных типов, содержащих столбцы String, изменился с 9 байт на пустую строку на 8 байт на пустую строку, что является ожидаемым поведением. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Улучшения Keeper {#keeper-improvements}

- Улучшена работа Keeper при начальной загрузке с rocksdb. [#83390](https://github.com/ClickHouse/ClickHouse/pull/83390) ([Antonio Andelic](https://github.com/antonio2368)).

### Улучшения Data Lake {#data-lake-improvements}

- Улучшена параллельная обработка файлов с бэкендом delta-kernel-rs. [#85642](https://github.com/ClickHouse/ClickHouse/pull/85642) ([Azat Khuzhin](https://github.com/azat)).


## Улучшения {#improvements}

### Управление доступом и безопасность {#access-control-and-security}

- Введены два новых типа доступа: `READ` и `WRITE` для источников данных, при этом все предыдущие типы доступа, связанные с источниками, объявлены устаревшими. Ранее: `GRANT S3 ON *.* TO user`, теперь: `GRANT READ, WRITE ON S3 TO user`. Это также позволяет разделять права `READ` и `WRITE` для источников, например: `GRANT READ ON * TO user`, `GRANT WRITE ON S3 TO user`. Функция управляется настройкой `access_control_improvements.enable_read_write_grants` и по умолчанию отключена. [#73659](https://github.com/ClickHouse/ClickHouse/pull/73659) ([pufit](https://github.com/pufit)).
- Добавлена поддержка параметров в запросах `CREATE USER` для имен пользователей. [#81387](https://github.com/ClickHouse/ClickHouse/pull/81387) ([Diskein](https://github.com/Diskein)).
- Исключение конфиденциальных данных из дампов ядра. Добавлены два аллокатора: совместимый с библиотекой AWS `AwsNodumpMemoryManager` и совместимый с STL `JemallocNodumpSTLAllocator`. Оба являются обертками аллокатора Jemalloc. Они используют extent hooks Jemalloc и madvise для пометки страниц памяти как «не выгружать». Используются для учетных данных S3, учетных данных пользователей и некоторых данных запросов. [#82441](https://github.com/ClickHouse/ClickHouse/pull/82441) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Представления, созданные эфемерными пользователями, теперь хранят копию реального пользователя и больше не становятся недействительными после удаления эфемерного пользователя. [#84763](https://github.com/ClickHouse/ClickHouse/pull/84763) ([pufit](https://github.com/pufit)).
- Сопоставление forward_headers внешней аутентификации выполняется без учета регистра. [#84737](https://github.com/ClickHouse/ClickHouse/pull/84737) ([ingodwerust](https://github.com/ingodwerust)).
- Добавлен столбец `parameter` в `system.grants` для определения типа источника для `GRANT READ/WRITE` и движка таблицы для `GRANT TABLE ENGINE`. [#85643](https://github.com/ClickHouse/ClickHouse/pull/85643) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).

### Резервное копирование и восстановление {#backup-and-restore}

- Добавлена поддержка резервного копирования для баз данных PostgreSQL, MySQL и DataLake. Резервная копия такой базы данных сохраняет только определение, но не данные. [#79982](https://github.com/ClickHouse/ClickHouse/pull/79982) ([Nikolay Degterinsky](https://github.com/evillique)).
- Все сообщения журнала для записи файлов резервных копий переведены на уровень TRACE. [#82907](https://github.com/ClickHouse/ClickHouse/pull/82907) ([Hans Krutzer](https://github.com/hkrutzer)).
- Введены настройки [`backup_restore_s3_retry_initial_backoff_ms`](/operations/settings/settings#backup_restore_s3_retry_initial_backoff_ms), [`backup_restore_s3_retry_max_backoff_ms`](/operations/settings/settings#backup_restore_s3_retry_max_backoff_ms), [`backup_restore_s3_retry_jitter_factor`](/operations/settings/settings#backup_restore_s3_retry_jitter_factor) для настройки стратегии задержки повторных попыток S3, используемой при операциях резервного копирования и восстановления. [#84421](https://github.com/ClickHouse/ClickHouse/pull/84421) ([Julia Kartseva](https://github.com/jkartseva)).
- Введена новая настройка [`backup_slow_all_threads_after_retryable_s3_error`](/operations/settings/settings#backup_slow_all_threads_after_retryable_s3_error) для снижения нагрузки на S3 во время массовых повторных попыток, вызванных ошибками типа `SlowDown`, путем замедления всех потоков после обнаружения одной повторяемой ошибки. [#84854](https://github.com/ClickHouse/ClickHouse/pull/84854) ([Julia Kartseva](https://github.com/jkartseva)).

### Целостность и проверка данных {#data-integrity-and-validation}


- Проверка согласованности файла checksum.txt части непосредственно перед её фиксацией. [#76625](https://github.com/ClickHouse/ClickHouse/pull/76625) ([Sema Checherinda](https://github.com/CheSema)).
- Запрет на запуск ALTER-мутации `RENAME COLUMN`, если она переименовывает столбец, который в данный момент затронут незавершённой мутацией данных. [#81823](https://github.com/ClickHouse/ClickHouse/pull/81823) ([Mikhail Artemenko](https://github.com/Michicosun)).
- Теперь снимок мутаций строится на основе снимка видимых частей. Счётчики мутаций, используемые в снимке, также пересчитываются на основе включённых мутаций. [#82945](https://github.com/ClickHouse/ClickHouse/pull/82945) ([Mikhail Artemenko](https://github.com/Michicosun)).
- Добавлена возможность разбора префикса и суффикса части, а также проверки покрытия для неконстантных столбцов. [#83377](https://github.com/ClickHouse/ClickHouse/pull/83377) ([Mikhail Artemenko](https://github.com/Michicosun)).

### Движок таблиц Iceberg {#iceberg-table-engine}

- Поддержка позиционных удалений для движка таблиц Iceberg. [#80237](https://github.com/ClickHouse/ClickHouse/pull/80237) ([YanghongZhong](https://github.com/yahoNanJing)).
- Теперь ClickHouse поддерживает сжатые файлы `metadata.json` для Iceberg. Исправляет [#70874](https://github.com/ClickHouse/ClickHouse/issues/70874). [#81451](https://github.com/ClickHouse/ClickHouse/pull/81451) ([alesapin](https://github.com/alesapin)).
- Исправлено чтение Iceberg по идентификаторам полей для сложных типов. [#84821](https://github.com/ClickHouse/ClickHouse/pull/84821) ([scanhex12](https://github.com/scanhex12)).
- Поддержка записи Iceberg для чтения из pyiceberg. [#84466](https://github.com/ClickHouse/ClickHouse/pull/84466) ([scanhex12](https://github.com/scanhex12)).
- Добавлена версия снимка для движков таблиц озёр данных. [#84659](https://github.com/ClickHouse/ClickHouse/pull/84659) ([Pete Hampton](https://github.com/pjhampton)).
- Поддержка записи файла version-hint для Iceberg. Закрывает [#85097](https://github.com/ClickHouse/ClickHouse/issues/85097). [#85130](https://github.com/ClickHouse/ClickHouse/pull/85130) ([scanhex12](https://github.com/scanhex12)).
- Поддержка сжатого файла `.metadata.json` через настройку [`iceberg_metadata_compression_method`](/operations/settings/settings#iceberg_metadata_compression_method). Поддерживаются все методы сжатия ClickHouse. Закрывает [#84895](https://github.com/ClickHouse/ClickHouse/issues/84895). [#85196](https://github.com/ClickHouse/ClickHouse/pull/85196) ([scanhex12](https://github.com/scanhex12)).
- Оптимизировано использование памяти для файлов позиционных удалений Iceberg. Вместо загрузки всех данных файлов удаления в память, в оперативной памяти хранится только текущая группа строк из файлов удаления Parquet. Это значительно снижает потребление памяти при работе с большими файлами позиционных удалений. [#85329](https://github.com/ClickHouse/ClickHouse/pull/85329) ([scanhex12](https://github.com/scanhex12)).
- Разрешена асинхронная итерация объектов из таблицы Iceberg без явного сохранения объектов для каждого файла данных. [#85369](https://github.com/ClickHouse/ClickHouse/pull/85369) ([Daniil Ivanik](https://github.com/divanik)).
- Поддержка удалений по равенству Iceberg. [#85843](https://github.com/ClickHouse/ClickHouse/pull/85843) ([Han Fei](https://github.com/hanfei1991)).

### Движок таблиц DeltaLake {#deltalake-table-engine}


- Улучшен движок таблиц `DeltaLake`: delta-kernel-rs имеет API `ExpressionVisitor`, который реализован в этом PR и применяется для преобразования выражений столбцов партиций (он заменит старый устаревший способ в delta-kernel-rs, который использовался ранее в нашем коде). В будущем этот `ExpressionVisitor` также позволит реализовать отсечение на основе статистики и некоторые проприетарные функции delta-lake. Кроме того, цель этого изменения — поддержать отсечение партиций в движке таблиц `DeltaLakeCluster` (результат разобранного выражения — ActionsDAG — будет сериализован и отправлен от инициатора вместе с путём к данным, поскольку такая информация, необходимая для отсечения, доступна только как метаинформация при перечислении файлов данных, что выполняется только инициатором, но должна применяться к данным на каждом сервере чтения). [#81136](https://github.com/ClickHouse/ClickHouse/pull/81136) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Исправлено отсечение партиций с кластерными функциями data lake. [#82131](https://github.com/ClickHouse/ClickHouse/pull/82131) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Исправлено чтение партиционированных данных в табличной функции DeltaLakeCluster. В этом PR увеличена версия протокола кластерных функций, что позволяет отправлять дополнительную информацию от инициатора к репликам. Эта дополнительная информация содержит выражение преобразования delta-kernel, которое необходимо для разбора столбцов партиций (и некоторых других данных в будущем, таких как генерируемые столбцы и т. д.). [#82132](https://github.com/ClickHouse/ClickHouse/pull/82132) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Теперь база данных Datalake выбрасывает более понятное исключение. Исправляет [#81211](https://github.com/ClickHouse/ClickHouse/issues/81211). [#82304](https://github.com/ClickHouse/ClickHouse/pull/82304) ([alesapin](https://github.com/alesapin)).
- Реализована внутренняя фильтрация `delta-kernel-rs` (отсечение на основе статистики и партиций) в хранилище `DeltaLake`. [#84006](https://github.com/ClickHouse/ClickHouse/pull/84006) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлена настройка [`delta_lake_enable_expression_visitor_logging`](/operations/settings/settings#delta_lake_enable_expression_visitor_logging) для отключения логов expression visitor, так как они могут быть слишком подробными даже для тестового уровня логирования при отладке. [#84315](https://github.com/ClickHouse/ClickHouse/pull/84315) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлена настройка [`delta_lake_snapshot_version`](/operations/settings/settings#delta_lake_snapshot_version) для чтения конкретной версии снимка в движке таблиц `DeltaLake`. [#85295](https://github.com/ClickHouse/ClickHouse/pull/85295) ([Kseniia Sumarokova](https://github.com/kssenii)).

### Интеграция с data lake {#data-lake-integration}

- Ускорено перечисление таблиц в каталогах данных за счёт асинхронных запросов. [#81084](https://github.com/ClickHouse/ClickHouse/pull/81084) ([alesapin](https://github.com/alesapin)).
- Добавлена поддержка `TimestampTZ` в каталоге Glue. Это закрывает [#81654](https://github.com/ClickHouse/ClickHouse/issues/81654). [#83132](https://github.com/ClickHouse/ClickHouse/pull/83132) ([scanhex12](https://github.com/scanhex12)).
- Разделён FormatParserGroup на две независимые структуры: первая отвечает за общие вычислительные ресурсы и ресурсы ввода-вывода, вторая отвечает за общие ресурсы фильтрации (filter ActionDag, KeyCondition). Это сделано для более гибкого совместного использования этих структур разными потоками. [#83997](https://github.com/ClickHouse/ClickHouse/pull/83997) ([Daniil Ivanik](https://github.com/divanik)).
- Добавлен отсутствующий параметр `partition_columns_in_data_file` в конфигурацию azure. [#85373](https://github.com/ClickHouse/ClickHouse/pull/85373) ([Arthur Passos](https://github.com/arthurpassos)).
- Добавлен флаг show_data_lake_catalogs_in_system_tables для управления добавлением таблиц data lake в system.tables, решает [#85384](https://github.com/ClickHouse/ClickHouse/issues/85384). [#85411](https://github.com/ClickHouse/ClickHouse/pull/85411) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).

### S3 и объектное хранилище {#s3-and-object-storage}


- Реализованы методы `moveFile` и `replaceFile` в `s3_plain_rewritable` для поддержки его в качестве диска базы данных. [#79424](https://github.com/ClickHouse/ClickHouse/pull/79424) ([Tuan Pham Anh](https://github.com/tuanpach)).
- Запросы на чтение и запись S3 теперь регулируются на уровне HTTP-сокета (вместо целых S3-запросов), чтобы избежать проблем с ограничением пропускной способности `max_remote_read_network_bandwidth_for_server` и `max_remote_write_network_bandwidth_for_server`. [#81837](https://github.com/ClickHouse/ClickHouse/pull/81837) ([Sergei Trifonov](https://github.com/serxa)).
- Добавлена случайная задержка (jitter) в механизм повторных попыток S3 при включенной конфигурации `s3_slow_all_threads_after_network_error`. [#81849](https://github.com/ClickHouse/ClickHouse/pull/81849) ([zoomxi](https://github.com/zoomxi)).
- Реализована аутентификация AWS S3 с явно указанной IAM-ролью. Реализован OAuth для GCS. Эти функции ранее были доступны только в ClickHouse Cloud и теперь открыты в open-source. Синхронизированы некоторые интерфейсы, такие как сериализация параметров подключения для объектных хранилищ. [#84011](https://github.com/ClickHouse/ClickHouse/pull/84011) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Разрешено использование любой политики хранения (например, объектного хранилища, такого как S3) для внешней агрегации и сортировки. [#84734](https://github.com/ClickHouse/ClickHouse/pull/84734) ([Azat Khuzhin](https://github.com/azat)).
- Все удаляемые объекты собираются для выполнения единой операции удаления в объектном хранилище. [#85316](https://github.com/ClickHouse/ClickHouse/pull/85316) ([Mikhail Artemenko](https://github.com/Michicosun)).

### Движок таблиц S3Queue {#s3queue-table-engine}

- Макросы, такие как `{uuid}`, теперь могут использоваться в настройке `keeper_path` движка таблиц S3Queue. [#82463](https://github.com/ClickHouse/ClickHouse/pull/82463) ([Nikolay Degterinsky](https://github.com/evillique)).
- Добавлена новая серверная настройка `s3queue_disable_streaming`, которая отключает потоковую передачу в таблицах с движком S3Queue. Эта настройка может быть изменена без перезапуска сервера. [#82515](https://github.com/ClickHouse/ClickHouse/pull/82515) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлены столбцы `commit_time` и `commit_id` в `system.s3queue_log`. [#83016](https://github.com/ClickHouse/ClickHouse/pull/83016) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлены логи для процесса завершения работы s3queue. [#83163](https://github.com/ClickHouse/ClickHouse/pull/83163) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Потоковая передача S3(Azure/etc)Queue теперь завершается до завершения работы любых таблиц при остановке сервера. [#83530](https://github.com/ClickHouse/ClickHouse/pull/83530) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Поддержка изменения настроек вставки материализованных представлений на уровне таблицы `S3Queue`. Добавлены новые настройки уровня `S3Queue`: `min_insert_block_size_rows_for_materialized_views` и `min_insert_block_size_bytes_for_materialized_views`. По умолчанию используются настройки уровня профиля, а настройки уровня `S3Queue` переопределяют их. [#83971](https://github.com/ClickHouse/ClickHouse/pull/83971) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Исправление упорядоченного режима S3Queue: более ранний выход при вызове завершения работы. [#84463](https://github.com/ClickHouse/ClickHouse/pull/84463) ([Kseniia Sumarokova](https://github.com/kssenii)).

### Интеграция с Kafka {#kafka-integration}


- Ручной подсчет обработанных сообщений для устранения зависимости от ранее зафиксированного смещения в StorageKafka2. [#81662](https://github.com/ClickHouse/ClickHouse/pull/81662) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Интеграция `StorageKafka2` с [`system.kafka_consumers`](/operations/system-tables/kafka_consumers). [#82652](https://github.com/ClickHouse/ClickHouse/pull/82652) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).

### Улучшения ClickHouse Keeper {#clickhouse-keeper-improvements}

- Улучшение Keeper: перемещение файлов журнала изменений между дисками в фоновом потоке. Ранее перемещение журнала изменений на другой диск блокировало работу Keeper до завершения операции. Это приводило к снижению производительности при длительных операциях перемещения (например, на диск S3). [#82485](https://github.com/ClickHouse/ClickHouse/pull/82485) ([Antonio Andelic](https://github.com/antonio2368)).
- Улучшение Keeper: добавлен новый параметр конфигурации `keeper_server.cleanup_old_and_ignore_new_acl`. При включении у всех узлов будут очищены списки ACL, а ACL для новых запросов будут игнорироваться. Если цель — полностью удалить ACL из узлов, важно оставить параметр включенным до создания нового снимка. [#82496](https://github.com/ClickHouse/ClickHouse/pull/82496) ([Antonio Andelic](https://github.com/antonio2368)).
- Улучшение Keeper: поддержка специфических разрешений для ACL world:anyone. [#82755](https://github.com/ClickHouse/ClickHouse/pull/82755) ([Antonio Andelic](https://github.com/antonio2368)).
- Добавлена поддержка указания дополнительных ACL Keeper для путей в конфигурации. Для добавления дополнительного ACL для конкретного пути его необходимо определить в конфигурации в разделе `zookeeper.path_acls`. [#82898](https://github.com/ClickHouse/ClickHouse/pull/82898) ([Antonio Andelic](https://github.com/antonio2368)).
- Добавлено событие ProfileEvent при отклонении Keeper операции записи из-за мягкого ограничения памяти. [#82963](https://github.com/ClickHouse/ClickHouse/pull/82963) ([Xander Garbett](https://github.com/Garbett1)).
- По умолчанию включены флаги функций `create_if_not_exists`, `check_not_exists`, `remove_recursive` в Keeper, которые активируют новые типы запросов. [#83488](https://github.com/ClickHouse/ClickHouse/pull/83488) ([Antonio Andelic](https://github.com/antonio2368)).
- Добавлена поддержка применения дополнительных ACL к конкретным узлам Keeper с использованием параметра конфигурации `apply_to_children`. [#84137](https://github.com/ClickHouse/ClickHouse/pull/84137) ([Antonio Andelic](https://github.com/antonio2368)).
- Добавлена команда `get_acl` в KeeperClient. [#84641](https://github.com/ClickHouse/ClickHouse/pull/84641) ([Antonio Andelic](https://github.com/antonio2368)).
- Добавлена четырехбуквенная команда (4LW) в Keeper — `lgrq` — для переключения логирования полученных запросов. [#84719](https://github.com/ClickHouse/ClickHouse/pull/84719) ([Antonio Andelic](https://github.com/antonio2368)).
- Снижена конкуренция за блокировку хранилища в Keeper. [#84732](https://github.com/ClickHouse/ClickHouse/pull/84732) ([Antonio Andelic](https://github.com/antonio2368)).
- Инструмент `encrypt_decrypt` теперь поддерживает зашифрованные соединения с ZooKeeper. [#84764](https://github.com/ClickHouse/ClickHouse/pull/84764) ([Roman Vasin](https://github.com/rvasin)).
- Ограничение размера кеша записей журнала Keeper по количеству записей с использованием параметров `keeper_server.coordination_settings.latest_logs_cache_entry_count_threshold` и `keeper_server.coordination_settings.commit_logs_cache_entry_count_threshold`. [#84877](https://github.com/ClickHouse/ClickHouse/pull/84877) ([Antonio Andelic](https://github.com/antonio2368)).

### Типы JSON и Dynamic {#json-and-dynamic-types}


- Добавлен файл `columns_substreams.txt` в Wide-части для отслеживания всех подпотоков, хранящихся в части. Это помогает отслеживать динамические потоки в типах JSON и Dynamic и избегать чтения образцов этих столбцов для получения списка динамических потоков (например, для вычисления размеров столбцов). Теперь все динамические потоки также отражаются в `system.parts_columns`. [#81091](https://github.com/ClickHouse/ClickHouse/pull/81091) ([Pavel Kruglov](https://github.com/Avogar)).
- Разрешено использование `ALTER UPDATE` для столбцов типов JSON и Dynamic. [#82419](https://github.com/ClickHouse/ClickHouse/pull/82419) ([Pavel Kruglov](https://github.com/Avogar)).
- Пользователи теперь могут использовать типы `Time` и `Time64` внутри типа JSON. [#83784](https://github.com/ClickHouse/ClickHouse/pull/83784) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Добавлена настройка `json_type_escape_dots_in_keys` для экранирования точек в ключах JSON при парсинге типа JSON. Настройка по умолчанию отключена. [#84207](https://github.com/ClickHouse/ClickHouse/pull/84207) ([Pavel Kruglov](https://github.com/Avogar)).

### Форматы Parquet и ORC {#parquet-and-orc-formats}

- Введены настройки для установки размера блока сжатия ORC, значение по умолчанию обновлено с 64 КБ до 256 КБ для согласованности со Spark и Hive. [#80602](https://github.com/ClickHouse/ClickHouse/pull/80602) ([李扬](https://github.com/taiyang-li)).
- Добавлена поддержка записи перечислений Parquet в виде массива байтов в соответствии со [спецификацией](https://github.com/apache/parquet-format/blob/master/LogicalTypes.md#enum). Дополнительная информация будет добавлена позже. [#81090](https://github.com/ClickHouse/ClickHouse/pull/81090) ([Arthur Passos](https://github.com/arthurpassos)).
- Добавлена поддержка записи GeoParquet в качестве выходного формата. [#81784](https://github.com/ClickHouse/ClickHouse/pull/81784) ([scanhex12](https://github.com/scanhex12)).

### Распределённые запросы и параллельные реплики {#distributed-queries-and-parallel-replicas}

- Введена новая настройка `enable_add_distinct_to_in_subqueries`. При включении ClickHouse автоматически добавляет DISTINCT к подзапросам в условиях IN для распределённых запросов. Это может значительно уменьшить размер временных таблиц, передаваемых между шардами, и повысить эффективность использования сети. Примечание: это компромисс — хотя объём передачи по сети уменьшается, на каждом узле требуется дополнительная работа по слиянию (дедупликации). Включайте эту настройку, когда передача по сети является узким местом, а затраты на слияние приемлемы. [#81908](https://github.com/ClickHouse/ClickHouse/pull/81908) ([fhw12345](https://github.com/fhw12345)).
- Добавлена поддержка табличных функций `remote()` с параллельными репликами, если кластер указан в аргументе `address_expression`. Также исправлена проблема [#73295](https://github.com/ClickHouse/ClickHouse/issues/73295). [#82904](https://github.com/ClickHouse/ClickHouse/pull/82904) ([Igor Nikonov](https://github.com/devcrafter)).
- Соединения (JOIN) с параллельными репликами теперь используют логический шаг соединения. В случае возникновения проблем с запросами JOIN при использовании параллельных реплик попробуйте выполнить `SET query_plan_use_new_logical_join_step=0` и сообщите о проблеме. [#83801](https://github.com/ClickHouse/ClickHouse/pull/83801) ([Vladimir Cherkasov](https://github.com/vdimir)).

### Настройки и конфигурация {#settings-and-configuration}


- Настройка `allow_experimental_join_condition` помечена как устаревшая. [#80566](https://github.com/ClickHouse/ClickHouse/pull/80566) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Общий и пользовательские сетевые ограничители теперь не сбрасываются, что гарантирует соблюдение лимитов `max_network_bandwidth_for_all_users` и `max_network_bandwidth_for_user`. [#81729](https://github.com/ClickHouse/ClickHouse/pull/81729) ([Sergei Trifonov](https://github.com/serxa)).
- Добавлена настройка `optimize_rewrite_regexp_functions` (включена по умолчанию), которая позволяет оптимизатору переписывать определённые вызовы `replaceRegexpAll`, `replaceRegexpOne` и `extract` в более простые и эффективные формы при обнаружении специфических шаблонов регулярных выражений (issue [#81981](https://github.com/ClickHouse/ClickHouse/issues/81981)). [#81992](https://github.com/ClickHouse/ClickHouse/pull/81992) ([Amos Bird](https://github.com/amosbird)).
- Настройка очереди TCP-серверов (64 по умолчанию) на основе параметра listen_backlog (4096 по умолчанию). [#82045](https://github.com/ClickHouse/ClickHouse/pull/82045) ([Azat Khuzhin](https://github.com/azat)).
- Добавлена возможность перезагрузки настроек `max_local_read_bandwidth_for_server` и `max_local_write_bandwidth_for_server` на лету без перезапуска сервера. [#82083](https://github.com/ClickHouse/ClickHouse/pull/82083) ([Kai Zhu](https://github.com/nauu)).
- Добавлена настройка `enable_vector_similarity_index`, которую необходимо включить для использования индекса векторного сходства. Существующая настройка `allow_experimental_vector_similarity_index` теперь устарела, но по-прежнему работает на случай, если кому-то это необходимо. [#83459](https://github.com/ClickHouse/ClickHouse/pull/83459) ([Robert Schulze](https://github.com/rschu1ze)).
- Добавлена настройка [`max_joined_block_size_bytes`](/operations/settings/settings#max_joined_block_size_bytes) в дополнение к `max_joined_block_size_rows` для ограничения использования памяти операциями JOIN с тяжёлыми столбцами. [#83869](https://github.com/ClickHouse/ClickHouse/pull/83869) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Исправлена совместимость для настройки cluster_function_process_archive_on_multiple_nodes. [#83968](https://github.com/ClickHouse/ClickHouse/pull/83968) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Поддержка коррелированных подзапросов включена по умолчанию. [#85107](https://github.com/ClickHouse/ClickHouse/pull/85107) ([Dmitry Novik](https://github.com/novikd)).
- Добавлены настройки `database_replicated`, определяющие значения по умолчанию для DatabaseReplicatedSettings. Если настройка отсутствует в запросе создания реплицируемой базы данных, используется значение из этой настройки. [#85127](https://github.com/ClickHouse/ClickHouse/pull/85127) ([Tuan Pham Anh](https://github.com/tuanpach)).
- Разрешены аргументы в формате ключ-значение в движке таблиц/функции `s3` или `s3Cluster`, например: `s3('url', CSV, structure = 'a Int32', compression_method = 'gzip')`. [#85134](https://github.com/ClickHouse/ClickHouse/pull/85134) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Некоррелированные подзапросы `EXISTS` теперь выполняются как скалярные подзапросы. Это позволяет использовать кеш скалярных подзапросов и свёртку констант, что полезно для индексов. Для совместимости добавлена новая настройка `execute_exists_as_scalar_subquery=1`. [#85481](https://github.com/ClickHouse/ClickHouse/pull/85481) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Поддержка разрешения большего числа случаев для составных идентификаторов. В частности, это улучшает совместимость `ARRAY JOIN` со старым анализатором. Добавлена новая настройка `analyzer_compatibility_allow_compound_identifiers_in_unflatten_nested` для сохранения прежнего поведения. [#85492](https://github.com/ClickHouse/ClickHouse/pull/85492) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).

### Системные таблицы и наблюдаемость {#system-tables-and-observability}


- Добавлены метрики нагрузки в асинхронные метрики ClickHouse. [#80779](https://github.com/ClickHouse/ClickHouse/pull/80779) ([Xander Garbett](https://github.com/Garbett1)).
- Добавлены метрики `MarkCacheEvictedBytes`, `MarkCacheEvictedMarks`, `MarkCacheEvictedFiles` для отслеживания вытеснений из кеша меток. (issue [#60989](https://github.com/ClickHouse/ClickHouse/issues/60989)). [#80799](https://github.com/ClickHouse/ClickHouse/pull/80799) ([Shivji Kumar Jha](https://github.com/shiv4289)).
- Таблица `system.formats` теперь содержит расширенную информацию о форматах, такую как тип содержимого HTTP, возможности автоматического определения схемы и т. д. [#81505](https://github.com/ClickHouse/ClickHouse/pull/81505) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлена поддержка очистки всех предупреждений из таблицы `system.warnings` с помощью `TRUNCATE TABLE system.warnings`. [#82087](https://github.com/ClickHouse/ClickHouse/pull/82087) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Добавлен список лицензий rust-крейтов в `system.licenses`. [#82440](https://github.com/ClickHouse/ClickHouse/pull/82440) ([Raúl Marín](https://github.com/Algunenano)).
- Добавлена оценка сложных КНФ/ДНФ, например `(a < 1 and a > 0) or b = 3`, по статистике. [#82663](https://github.com/ClickHouse/ClickHouse/pull/82663) ([Han Fei](https://github.com/hanfei1991)).
- В некоторых случаях необходимо иметь несколько измерений для метрик. Например, подсчет неудачных слияний или мутаций по кодам ошибок вместо использования единого счетчика. [#83030](https://github.com/ClickHouse/ClickHouse/pull/83030) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Добавлены метрики ресурсов процесса (такие как `UserTimeMicroseconds`, `SystemTimeMicroseconds`, `RealTimeMicroseconds`) в события профилирования part_log для записей `MergeParts`. [#83460](https://github.com/ClickHouse/ClickHouse/pull/83460) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Метрики уровня Cgroup и общесистемные метрики теперь выводятся совместно. Метрики уровня Cgroup имеют имена `CGroup<Metric>`, а метрики уровня ОС (собираемые из procfs) имеют имена `OS<Metric>`. [#84317](https://github.com/ClickHouse/ClickHouse/pull/84317) ([Nikita Taranov](https://github.com/nickitat)).
- Добавлены многомерные метрики для мониторинга размера параллельных ограниченных очередей с метками по типу очереди и идентификатору экземпляра для улучшенной наблюдаемости. [#84675](https://github.com/ClickHouse/ClickHouse/pull/84675) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Таблица [`system.columns`](/operations/system-tables/columns) теперь предоставляет `column` в качестве псевдонима для существующего столбца `name`. [#84695](https://github.com/ClickHouse/ClickHouse/pull/84695) ([Yunchi Pang](https://github.com/yunchipang)).
- Добавлен столбец строки формата в `system.errors`. Этот столбец необходим для группировки по типу ошибки в правилах оповещения. [#84776](https://github.com/ClickHouse/ClickHouse/pull/84776) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Сделаны настраиваемыми лимиты для асинхронного журнала и добавлена интроспекция. [#85105](https://github.com/ClickHouse/ClickHouse/pull/85105) ([Raúl Marín](https://github.com/Algunenano)).
- Добавлено игнорирование `UNKNOWN_DATABASE` при получении размеров столбцов таблиц для system.columns. [#85632](https://github.com/ClickHouse/ClickHouse/pull/85632) ([Azat Khuzhin](https://github.com/azat)).

### Движки баз данных {#database-engines}

### Системные и внутренние улучшения {#system-and-internal-improvements}


- Исправлено подключение баз данных с удалёнными дисками только для чтения путём ручного добавления UUID таблиц в DatabaseCatalog. [#82670](https://github.com/ClickHouse/ClickHouse/pull/82670) ([Tuan Pham Anh](https://github.com/tuanpach)).
- Улучшена обработка DDL-задач при `distributed_ddl_output_mode='*_only_active'` за счёт отказа от ожидания новых или восстановленных реплик с отставанием репликации, превышающим `max_replication_lag_to_enqueue`. Это помогает избежать ошибок `DDL task is not finished on some hosts`, когда новая реплика становится активной после инициализации или восстановления, но накопила большой журнал репликации. Также реализован запрос `SYSTEM SYNC DATABASE REPLICA STRICT`, который ожидает, пока журнал репликации не уменьшится до значения ниже `max_replication_lag_to_enqueue`. [#83302](https://github.com/ClickHouse/ClickHouse/pull/83302) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Изменён порядок завершения работы SystemLogs: теперь он происходит после обычных таблиц (и перед системными таблицами, а не перед обычными таблицами). [#83134](https://github.com/ClickHouse/ClickHouse/pull/83134) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлена серверная настройка `logs_to_keep` для реплицируемых баз данных, позволяющая задать значение по умолчанию параметра `logs_to_keep` для реплицируемых баз данных. Меньшие значения уменьшают количество узлов ZooKeeper (особенно полезно при большом количестве баз данных), в то время как большие значения позволяют отстающим репликам догнать систему после длительных периодов простоя. [#84183](https://github.com/ClickHouse/ClickHouse/pull/84183) ([Alexey Khatskevich](https://github.com/Khatskevich)).
- Изменено значение по умолчанию настройки реплицируемой базы данных `max_retries_before_automatic_recovery` на 10, что обеспечивает более быстрое восстановление в некоторых случаях. [#84369](https://github.com/ClickHouse/ClickHouse/pull/84369) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Оптимизированы DDL-операции для обновляемых материализованных представлений без режима добавления в реплицируемых базах данных за счёт пропуска создания и переименования старых временных таблиц. [#84858](https://github.com/ClickHouse/ClickHouse/pull/84858) ([Tuan Pham Anh](https://github.com/tuanpach)).

### Репликация и синхронизация {#replication-and-synchronization}

### Системные и внутренние улучшения {#systemandinternalimprovements}

- Улучшена команда `SYSTEM RESTART REPLICA`: теперь она повторяет попытки создания таблицы при возникновении проблем с подключением к ZooKeeper, предотвращая потерю таблиц. [#82616](https://github.com/ClickHouse/ClickHouse/pull/82616) ([Nikolay Degterinsky](https://github.com/evillique)).
- Добавлена проверка UUID в `ReplicatedMergeTree::executeMetadataAlter` для предотвращения некорректных определений таблиц при обмене таблицами между получением StorageID и вызовом `IDatabase::alterTable`. [#82666](https://github.com/ClickHouse/ClickHouse/pull/82666) ([Nikolay Degterinsky](https://github.com/evillique)).
- Удалена экспериментальная логика `send_metadata`, связанная с экспериментальной репликацией без копирования. Этот код никогда не использовался, не поддерживался и, вероятно, был неработоспособен; тесты для проверки его функциональности отсутствовали. [#82508](https://github.com/ClickHouse/ClickHouse/pull/82508) ([alesapin](https://github.com/alesapin)).
- Добавлена поддержка раскрытия макросов в `remote_fs_zero_copy_zookeeper_path`. [#85437](https://github.com/ClickHouse/ClickHouse/pull/85437) ([Mikhail Koviazin](https://github.com/mkmkme)).

### Функции и выражения {#functions-and-expressions}


* Функция `addressToSymbol` и таблица `system.symbols` будут использовать смещения в файле вместо адресов виртуальной памяти. [#81896](https://github.com/ClickHouse/ClickHouse/pull/81896) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сохранять имена элементов при выводе супертитов для именованных кортежей. [#81345](https://github.com/ClickHouse/ClickHouse/pull/81345) ([lgbo](https://github.com/lgbo-ustc)).
* Разрешено смешивать разные правила сравнения строк для одного и того же столбца в разных окнах. [#82877](https://github.com/ClickHouse/ClickHouse/pull/82877) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Добавлена функция для записи типов в формат WKB. [#82935](https://github.com/ClickHouse/ClickHouse/pull/82935) ([scanhex12](https://github.com/scanhex12)).
* Добавлена возможность парсить `Time` и `Time64` в форматах MM:SS, M:SS, SS или S. [#83299](https://github.com/ClickHouse/ClickHouse/pull/83299) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Функция `reinterpret()` теперь поддерживает преобразование в `Array(T)`, где `T` — тип данных фиксированного размера (issue [#82621](https://github.com/ClickHouse/ClickHouse/issues/82621)). [#83399](https://github.com/ClickHouse/ClickHouse/pull/83399) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Исправлены функции `structureToProtobufSchema` и `structureToCapnProtoSchema`, чтобы правильно добавлять нулевой завершающий байт вместо символа перевода строки, что предотвращает отсутствие переводов строк в выводе и потенциальные переполнения буфера в функциях, зависящих от нулевого байта (таких как `logTrace`, `demangle`, `extractURLParameter`, `toStringCutToZero` и `encrypt`/`decrypt`). Закрывает [#85062](https://github.com/ClickHouse/ClickHouse/issues/85062). [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена схема словаря `regexp_tree`, чтобы поддерживать обработку строк, содержащих нулевые байты. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена функция `formatRowNoNewline`, которая ошибочно обрезала последний символ выходных данных при вызове с форматом `Values` или любым форматом без символа новой строки в конце строк. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка безопасной работы с исключениями в функции `stem`, которая в редких случаях могла приводить к утечкам памяти. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена функция `initcap` для аргументов типа `FixedString`, чтобы она корректно распознавала начало слов в начале строк в случаях, когда предыдущая строка в блоке заканчивалась на символьный (буквенно-цифровой) знак. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена уязвимость в формате Apache `ORC`, которая могла привести к утечке неинициализированной памяти. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Изменено поведение `replaceRegexpAll` и его псевдонима `REGEXP_REPLACE`, чтобы разрешить пустые совпадения в конце строк даже в тех случаях, когда предыдущее совпадение охватывало всю строку (например, `^a*|a*$` или `^|.*`), что согласуется с семантикой JavaScript, Perl, Python, PHP и Ruby, но отличается от PostgreSQL. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Оптимизирована и упрощена реализация множества функций для работы со строками. Исправлена некорректная документация для нескольких функций. Примечание: вывод функции `byteSize` для столбцов типа String и составных типов, содержащих столбцы типа String, изменился с 9 байт за пустую строку на 8 байт за пустую строку, что соответствует ожидаемому поведению. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Разрешен нулевой шаг в функциях `timeSeries*ToGrid()`. Это часть № 3 из [https://github.com/ClickHouse/ClickHouse/pull/75036](https://github.com/ClickHouse/ClickHouse/pull/75036). [#85390](https://github.com/ClickHouse/ClickHouse/pull/85390) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена поддержка вложенных массивов для функции `nested`. [#85719](https://github.com/ClickHouse/ClickHouse/pull/85719) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).

### Улучшения MergeTree {#mergetree-improvements}

- Более гранулярное отключение индексов пропуска, зависящих от столбцов, обновляемых на лету или через патч-части. Теперь индексы пропуска не используются только в частях, затронутых мутациями на лету или патч-частями; ранее эти индексы отключались для всех частей. [#84241](https://github.com/ClickHouse/ClickHouse/pull/84241) ([Anton Popov](https://github.com/CurtizJ)).
- Добавлена настройка MergeTree `search_orphaned_parts_drives` для ограничения области поиска частей, например, по дискам с локальными метаданными. [#84710](https://github.com/ClickHouse/ClickHouse/pull/84710) ([Ilya Golshtein](https://github.com/ilejn)).
- Добавлена недостающая поддержка `read_in_order_use_virtual_row` для `WHERE`. Это позволяет пропускать чтение большего количества частей для запросов с фильтрами, которые не были полностью перенесены в `PREWHERE`. [#84835](https://github.com/ClickHouse/ClickHouse/pull/84835) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Исправлено использование «компактной» сериализации дискриминаторов Variant в MergeTree. Ранее она не использовалась в некоторых случаях, когда могла быть применена. [#84141](https://github.com/ClickHouse/ClickHouse/pull/84141) ([Pavel Kruglov](https://github.com/Avogar)).
- Добавлено ограничение (настройка таблицы [`max_uncompressed_bytes_in_patches`](/operations/settings/merge-tree-settings#max_uncompressed_bytes_in_patches)) на общий объем несжатых байтов в патч-частях. Это предотвращает значительное замедление запросов `SELECT` после легковесных обновлений и предотвращает возможное злоупотребление легковесными обновлениями. [#85641](https://github.com/ClickHouse/ClickHouse/pull/85641) ([Anton Popov](https://github.com/CurtizJ)).

### Кэш и управление памятью {#cache-and-memory-management}

- Исправлена логическая ошибка в кэше файловой системы: «Having zero bytes but range is not finished». [#81868](https://github.com/ClickHouse/ClickHouse/pull/81868) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлено рандеву-хеширование для улучшения локальности кэша. [#82511](https://github.com/ClickHouse/ClickHouse/pull/82511) ([Anton Ivashkin](https://github.com/ianton-ru)).
- Рефакторинг функции динамического изменения размера кэша файловой системы. Добавлено больше логов для интроспекции. [#82556](https://github.com/ClickHouse/ClickHouse/pull/82556) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Снижены накладные расходы на отслеживание памяти запросов для исполняемых пользовательских функций. [#83929](https://github.com/ClickHouse/ClickHouse/pull/83929) ([Eduard Karacharov](https://github.com/korowa)).
- Все выделения памяти, выполняемые внешними библиотеками, теперь видны трекеру памяти ClickHouse и учитываются корректно. Это может привести к «увеличению» отчетного использования памяти для определенных запросов или к сбоям с ошибкой `MEMORY_LIMIT_EXCEEDED`. [#84082](https://github.com/ClickHouse/ClickHouse/pull/84082) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Выделяется минимальный объем памяти, необходимый для encrypted_buffer для зашифрованных именованных коллекций. [#84432](https://github.com/ClickHouse/ClickHouse/pull/84432) ([Pablo Marcos](https://github.com/pamarcos)).

### Индекс векторного сходства {#vector-similarity-index}

- Предотвращено использование пользователем `nan` и `inf` с `NumericIndexedVector`. Исправляет [#82239](https://github.com/ClickHouse/ClickHouse/issues/82239) и немного больше. [#82681](https://github.com/ClickHouse/ClickHouse/pull/82681) ([Raufs Dunamalijevs](https://github.com/rienath)).
- Индекс векторного сходства теперь поддерживает бинарную квантизацию. Бинарная квантизация значительно снижает потребление памяти и ускоряет процесс построения векторного индекса (за счет более быстрого вычисления расстояний). Также существующая настройка `vector_search_postfilter_multiplier` была признана устаревшей и заменена более общей настройкой: `vector_search_index_fetch_multiplier`. [#85024](https://github.com/ClickHouse/ClickHouse/pull/85024) ([Shankar Iyer](https://github.com/shankar-iyer)).
- Приближенный векторный поиск с индексами векторного сходства теперь находится в статусе GA. [#85888](https://github.com/ClickHouse/ClickHouse/pull/85888) ([Robert Schulze](https://github.com/rschu1ze)).


### Обработка ошибок и сообщения {#error-handling-and-messages}

- Заголовок Connection теперь отправляется в конце заголовков, когда известно, что соединение должно быть сохранено. [#81951](https://github.com/ClickHouse/ClickHouse/pull/81951) ([Sema Checherinda](https://github.com/CheSema)).
- В предыдущих версиях умножение состояния агрегатной функции с IPv4 приводило к логической ошибке вместо правильного кода ошибки. Закрывает [#82817](https://github.com/ClickHouse/ClickHouse/issues/82817). [#82818](https://github.com/ClickHouse/ClickHouse/pull/82818) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Улучшена обработка ошибок в `AsynchronousMetrics`. Если директория `/sys/block` существует, но недоступна, сервер запустится без мониторинга блочных устройств. Закрывает [#79229](https://github.com/ClickHouse/ClickHouse/issues/79229). [#83115](https://github.com/ClickHouse/ClickHouse/pull/83115) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Была исправлена некорректная проверка зависимостей для `INSERT` с материализованными представлениями, содержащими некорректные запросы select. Пользователь мог получить неинформативное исключение `std::exception` вместо понятной ошибки с четким объяснением. Теперь это исправлено. Исправляет: [#82889](https://github.com/ClickHouse/ClickHouse/issues/82889). [#83190](https://github.com/ClickHouse/ClickHouse/pull/83190) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Теперь в сообщениях об исключениях не выводятся очень длинные описания действий выражений. Закрывает [#83164](https://github.com/ClickHouse/ClickHouse/issues/83164). [#83350](https://github.com/ClickHouse/ClickHouse/pull/83350) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Когда хранилище завершает работу, `getStatus` выбрасывает исключение `ErrorCodes::ABORTED`. Ранее это приводило к сбою запроса select. Теперь исключения `ErrorCodes::ABORTED` перехватываются и намеренно игнорируются. [#83435](https://github.com/ClickHouse/ClickHouse/pull/83435) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Сообщения об исключениях для определенных ситуаций при загрузке и добавлении проекций стали более читаемыми. [#83728](https://github.com/ClickHouse/ClickHouse/pull/83728) ([Robert Schulze](https://github.com/rschu1ze)).
- Добавлена проверка отмены соединения перед проверкой EOF для предотвращения чтения из закрытого соединения. Исправляет [#83893](https://github.com/ClickHouse/ClickHouse/issues/83893). [#84227](https://github.com/ClickHouse/ClickHouse/pull/84227) ([Raufs Dunamalijevs](https://github.com/rienath)).
- Улучшена обработка завершения работы сервера для клиентских соединений путем упрощения внутренних проверок. [#84312](https://github.com/ClickHouse/ClickHouse/pull/84312) ([Raufs Dunamalijevs](https://github.com/rienath)).
- Низкоуровневые ошибки при выполнении UDF теперь завершаются с кодом ошибки `UDF_EXECUTION_FAILED`, тогда как ранее могли возвращаться различные коды ошибок. [#84547](https://github.com/ClickHouse/ClickHouse/pull/84547) ([Xu Jia](https://github.com/XuJia0210)).

### Улучшения форматирования SQL {#sql-formatting-improvements}


- Исправлено неконсистентное форматирование `CREATE DICTIONARY`. Закрывает [#82105](https://github.com/ClickHouse/ClickHouse/issues/82105). [#82829](https://github.com/ClickHouse/ClickHouse/pull/82829) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Исправлено неконсистентное форматирование `TTL` при наличии функции `materialize`. Закрывает [#82828](https://github.com/ClickHouse/ClickHouse/issues/82828). [#82831](https://github.com/ClickHouse/ClickHouse/pull/82831) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Исправлено неконсистентное форматирование `EXPLAIN AST` в подзапросе при наличии опций вывода, таких как INTO OUTFILE. Закрывает [#82826](https://github.com/ClickHouse/ClickHouse/issues/82826). [#82840](https://github.com/ClickHouse/ClickHouse/pull/82840) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Исправлено неконсистентное форматирование выражений в скобках с алиасами в контексте, где алиасы не допускаются. Закрывает [#82836](https://github.com/ClickHouse/ClickHouse/issues/82836). Закрывает [#82837](https://github.com/ClickHouse/ClickHouse/issues/82837). [#82867](https://github.com/ClickHouse/ClickHouse/pull/82867) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Исправлено форматирование CREATE USER с параметрами запроса (например, `CREATE USER {username:Identifier} IDENTIFIED WITH no_password`). [#84376](https://github.com/ClickHouse/ClickHouse/pull/84376) ([Azat Khuzhin](https://github.com/azat)).
- Исправлен парсинг завершающей запятой в столбцах запроса CREATE DICTIONARY после столбца с параметрами, например, Decimal(8). Закрывает [#85586](https://github.com/ClickHouse/ClickHouse/issues/85586). [#85653](https://github.com/ClickHouse/ClickHouse/pull/85653) ([Nikolay Degterinsky](https://github.com/evillique)).

### Внешние интеграции {#external-integrations}

- Унифицированы имена параметров в ODBC и JDBC при использовании именованных коллекций. [#83410](https://github.com/ClickHouse/ClickHouse/pull/83410) ([Andrey Zvonov](https://github.com/zvonand)).
- MongoDB: Неявный парсинг строк в числовые типы. Ранее, если строковое значение получалось из источника MongoDB для числового столбца в таблице ClickHouse, выбрасывалось исключение. Теперь движок автоматически пытается распарсить числовое значение из строки. Закрывает [#81167](https://github.com/ClickHouse/ClickHouse/issues/81167). [#84069](https://github.com/ClickHouse/ClickHouse/pull/84069) ([Kirill Nikiforov](https://github.com/allmazz)).
- Разрешено использование `simdjson` на неподдерживаемых архитектурах (ранее приводило к ошибкам `CANNOT_ALLOCATE_MEMORY`). [#84966](https://github.com/ClickHouse/ClickHouse/pull/84966) ([Azat Khuzhin](https://github.com/azat)).

### Прочие улучшения {#miscellaneous-improvements}


- Добавлен движок таблиц и табличная функция Ytsaurus. [#77606](https://github.com/ClickHouse/ClickHouse/pull/77606) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Улучшен метод HashJoin::needUsedFlagsForPerRightTableRow, теперь возвращает false для перекрёстного соединения. [#82379](https://github.com/ClickHouse/ClickHouse/pull/82379) ([lgbo](https://github.com/lgbo-ustc)).
- Разрешена запись/чтение столбцов типа map как массива кортежей. [#82408](https://github.com/ClickHouse/ClickHouse/pull/82408) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Данный PR был отменён. [#82884](https://github.com/ClickHouse/ClickHouse/pull/82884) ([Mithun p](https://github.com/mithunputhusseri)).
- Асинхронные логи: ограничено максимальное количество записей, удерживаемых в очереди. [#83214](https://github.com/ClickHouse/ClickHouse/pull/83214) ([Raúl Marín](https://github.com/Algunenano)).
- Включена поддержка типов Date/Date32 в виде целых чисел во входных форматах JSON. [#83597](https://github.com/ClickHouse/ClickHouse/pull/83597) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Улучшена поддержка индексов bloom filter (обычных, ngram и token) для использования в случаях, когда первый аргумент является константным массивом (множеством), а второй — индексируемым столбцом (подмножеством), что обеспечивает более эффективное выполнение запросов. [#84700](https://github.com/ClickHouse/ClickHouse/pull/84700) ([Doron David](https://github.com/dorki)).
- Разрешено приведение типов значений множества при проталкивании фильтров `IN` / `GLOBAL IN` по первичным ключам хранилищ KeyValue (например, EmbeddedRocksDB, KeeperMap). [#84515](https://github.com/ClickHouse/ClickHouse/pull/84515) ([Eduard Karacharov](https://github.com/korowa)).
- Устранены полные сканирования в случаях, когда анализ индекса приводит к пустым диапазонам при чтении параллельными репликами. [#84971](https://github.com/ClickHouse/ClickHouse/pull/84971) ([Eduard Karacharov](https://github.com/korowa)).
- Исправлен ряд проблем, которые могут возникать при попытке запуска интеграционных тестов на локальном хосте. [#82135](https://github.com/ClickHouse/ClickHouse/pull/82135) ([Oleg Doronin](https://github.com/dorooleg)).
- Включён параметр trace_log.symbolize по умолчанию для старых развёртываний. [#85456](https://github.com/ClickHouse/ClickHouse/pull/85456) ([Azat Khuzhin](https://github.com/azat)).

#### Исправления ошибок (видимые пользователю некорректные поведения в официальном стабильном релизе) {#bug-fixes}

### Оптимизации производительности {#performance-optimizations}

- Исправлена деградация производительности в SummingMergeTree, которая была внесена в версии 25.5 в https://github.com/ClickHouse/ClickHouse/pull/79051. [#82130](https://github.com/ClickHouse/ClickHouse/pull/82130) ([Pavel Kruglov](https://github.com/Avogar)).
- Исправлена деградация производительности при включённом анализаторе, когда вторичные запросы всегда читают все столбцы из VIEW. Исправляет [#81718](https://github.com/ClickHouse/ClickHouse/issues/81718). [#83036](https://github.com/ClickHouse/ClickHouse/pull/83036) ([Dmitry Novik](https://github.com/novikd)).
- Отключена проверка циклических зависимостей при создании таблицы без зависимостей. Это исправляет деградацию производительности в сценариях создания тысяч таблиц, которая была внесена в https://github.com/ClickHouse/ClickHouse/pull/65405. [#83077](https://github.com/ClickHouse/ClickHouse/pull/83077) ([Pavel Kruglov](https://github.com/Avogar)).
- Обеспечено выполнение оконных агрегатов `DISTINCT` за линейное время и исправлена ошибка в `sumDistinct`. Закрывает [#79792](https://github.com/ClickHouse/ClickHouse/issues/79792). Закрывает [#52253](https://github.com/ClickHouse/ClickHouse/issues/52253). [#79859](https://github.com/ClickHouse/ClickHouse/pull/79859) ([Nihal Z. Miaji](https://github.com/nihalzp)).

### Исправления выполнения запросов {#query-execution-fixes}


* Для запросов с комбинацией `ORDER BY ... LIMIT BY ... LIMIT N`, когда `ORDER BY` выполняется в режиме `PartialSorting`, счётчик `rows_before_limit_at_least` теперь отражает количество строк, обработанных оператором `LIMIT`, вместо количества строк, обработанных преобразованием сортировки. [#78999](https://github.com/ClickHouse/ClickHouse/pull/78999) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлена логическая ошибка с оператором `<=>` и хранилищем Join: теперь запрос возвращает корректный код ошибки. [#80165](https://github.com/ClickHouse/ClickHouse/pull/80165) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлен сбой в функции `loop` при использовании с семейством функций `remote`. Гарантировано соблюдение ограничения LIMIT в `loop(remote(...))`. [#80299](https://github.com/ClickHouse/ClickHouse/pull/80299) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлено некорректное поведение функций `to_utc_timestamp` и `from_utc_timestamp` при обработке дат до Unix-эпохи (1970-01-01) и после максимально допустимой даты (2106-02-07 06:28:15). Теперь эти функции корректно ограничивают значения началом эпохи и максимально допустимой датой соответственно. [#80498](https://github.com/ClickHouse/ClickHouse/pull/80498) ([Surya Kant Ranjan](https://github.com/iit2009046)).
* Исправлено выполнение `IN` с `transform_null_in=1`, когда левый аргумент содержит null, а результат подзапроса — не Nullable. [#81584](https://github.com/ClickHouse/ClickHouse/pull/81584) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена проблема, из‑за которой необходимые столбцы не считывались при обработке скалярного коррелированного подзапроса. Исправляет [#81716](https://github.com/ClickHouse/ClickHouse/issues/81716). [#81805](https://github.com/ClickHouse/ClickHouse/pull/81805) ([Dmitry Novik](https://github.com/novikd)).
* Исправлен анализ фильтра, когда в запросе используется только константный столбец с псевдонимом. Исправляет [#79448](https://github.com/ClickHouse/ClickHouse/issues/79448). [#82037](https://github.com/ClickHouse/ClickHouse/pull/82037) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена ошибка `Not found column` для запросов с `arrayJoin` в условии `WHERE` при использовании `IndexSet`. [#82113](https://github.com/ClickHouse/ClickHouse/pull/82113) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено исключение `TOO_DEEP_SUBQUERIES`, возникавшее, когда определение CTE ссылалось на другое табличное выражение с тем же именем. [#83413](https://github.com/ClickHouse/ClickHouse/pull/83413) ([Dmitry Novik](https://github.com/novikd)).
* Исправлен некорректный результат запросов с предложением `WHERE ... IN (<subquery>)` при включённом кэше условий запроса (настройка `use_query_condition_cache`). [#83445](https://github.com/ClickHouse/ClickHouse/pull/83445) ([LB7666](https://github.com/acking-you)).
* `INSERT SELECT` с `UNION ALL` мог привести к разыменованию нулевого указателя в редком граничном случае. Это закрывает [#83618](https://github.com/ClickHouse/ClickHouse/issues/83618). [#83643](https://github.com/ClickHouse/ClickHouse/pull/83643) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка `LOGICAL_ERROR`, возникавшая при анализе выражений политик на уровне строк для коррелированных столбцов. [#82618](https://github.com/ClickHouse/ClickHouse/pull/82618) ([Dmitry Novik](https://github.com/novikd)).
* Исправлены неверные результаты при использовании кэша условий запроса вместе с рекурсивными CTE (issue [#81506](https://github.com/ClickHouse/ClickHouse/issues/81506)). [#84026](https://github.com/ClickHouse/ClickHouse/pull/84026) ([zhongyuankai](https://github.com/zhongyuankai)).
* Исправлен бесконечный рекурсивный анализ некорректных определений `WINDOW`. Исправление для [#83131](https://github.com/ClickHouse/ClickHouse/issues/83131). [#84242](https://github.com/ClickHouse/ClickHouse/pull/84242) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена проблема с `Not-ready Set` для `IN (subquery)` в настройке `additional_table_filters expression`. [#85210](https://github.com/ClickHouse/ClickHouse/pull/85210) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена логическая ошибка с дублирующимися подзапросами при включённом `optimize_syntax_fuse_functions`, закрыт [#75511](https://github.com/ClickHouse/ClickHouse/issues/75511). [#83300](https://github.com/ClickHouse/ClickHouse/pull/83300) ([Vladimir Cherkasov](https://github.com/vdimir)).

### Исправления Iceberg и DataLake {#iceberg-and-datalake-fixes}

- Исправлено разрешение метаданных при запросе таблиц Iceberg через REST-каталог. ... [#80562](https://github.com/ClickHouse/ClickHouse/pull/80562) ([Saurabh Kumar Ojha](https://github.com/saurabhojha)).
- Исправлены состояния гонки в Iceberg. [#82088](https://github.com/ClickHouse/ClickHouse/pull/82088) ([Azat Khuzhin](https://github.com/azat)).
- Исправлена ошибка "Context has expired" для Iceberg. [#82146](https://github.com/ClickHouse/ClickHouse/pull/82146) ([Azat Khuzhin](https://github.com/azat)).
- Теперь ClickHouse может читать таблицы Iceberg из каталога Glue после эволюции схемы. Исправляет [#81272](https://github.com/ClickHouse/ClickHouse/issues/81272). [#82301](https://github.com/ClickHouse/ClickHouse/pull/82301) ([alesapin](https://github.com/alesapin)).
- Исправлены состояния гонки в Iceberg. [#82841](https://github.com/ClickHouse/ClickHouse/pull/82841) ([Azat Khuzhin](https://github.com/azat)).
- Отключена обрезка файлов на основе границ для элементов массивов Iceberg и значений map Iceberg, включая все их вложенные подполя. [#83520](https://github.com/ClickHouse/ClickHouse/pull/83520) ([Daniil Ivanik](https://github.com/divanik)).
- Исправлена запись Iceberg для сложных типов. [#85330](https://github.com/ClickHouse/ClickHouse/pull/85330) ([scanhex12](https://github.com/scanhex12)).
- Запись нижних и верхних границ не поддерживается для сложных типов. [#85332](https://github.com/ClickHouse/ClickHouse/pull/85332) ([scanhex12](https://github.com/scanhex12)).
- Исправлена допустимость NULL для полей в Iceberg. [#85977](https://github.com/ClickHouse/ClickHouse/pull/85977) ([scanhex12](https://github.com/scanhex12)).
- Больше не создаются пустые файлы удаления Iceberg. [#86061](https://github.com/ClickHouse/ClickHouse/pull/86061) ([scanhex12](https://github.com/scanhex12)).
- Обновлена временная метка метаданных при записи Iceberg. [#85711](https://github.com/ClickHouse/ClickHouse/pull/85711) ([scanhex12](https://github.com/scanhex12)).
- Spark не может читать файлы позиционного удаления. [#85762](https://github.com/ClickHouse/ClickHouse/pull/85762) ([scanhex12](https://github.com/scanhex12)).
- Прекращено получение схемы из файлов манифеста, вместо этого релевантные схемы сохраняются для каждого снимка независимо. Релевантная схема для каждого файла данных выводится из соответствующего снимка. Предыдущее поведение нарушало спецификацию Iceberg для записей файлов манифеста со статусом existing. [#84588](https://github.com/ClickHouse/ClickHouse/pull/84588) ([Daniil Ivanik](https://github.com/divanik)).
- Теперь Iceberg не пытается кэшировать релевантную версию снимка между запросами SELECT и всегда пытается разрешить снимок корректно. Предыдущая попытка кэширования снимка Iceberg приводила к проблемам при использовании таблицы Iceberg с путешествием во времени. [#85038](https://github.com/ClickHouse/ClickHouse/pull/85038) ([Daniil Ivanik](https://github.com/divanik)).
- Исправлено разрешение метаданных при запросе таблиц Iceberg через REST-каталог. ... [#85531](https://github.com/ClickHouse/ClickHouse/pull/85531) ([Saurabh Kumar Ojha](https://github.com/saurabhojha)).
- Исправлено маскирование секретов в табличных функциях icebergS3Cluster и icebergAzureCluster. [#85658](https://github.com/ClickHouse/ClickHouse/pull/85658) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).

### Исправления DeltaLake {#deltalake-fixes}


- Исправлена оптимизация удаления столбцов (column pruning) с delta-kernel в хранилище `DeltaLake`. Закрывает [#84543](https://github.com/ClickHouse/ClickHouse/issues/84543). [#84745](https://github.com/ClickHouse/ClickHouse/pull/84745) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Обновление учётных данных в delta-kernel для хранилища DeltaLake. [#84751](https://github.com/ClickHouse/ClickHouse/pull/84751) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Исправлена ошибка сегментации в реализации delta-kernel. [#85160](https://github.com/ClickHouse/ClickHouse/pull/85160) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Исправлено состояние гонки в реализации delta-kernel движка `DeltaLake`. [#85221](https://github.com/ClickHouse/ClickHouse/pull/85221) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Исправлено чтение партиционированных данных с отключённым delta-kernel в движке `DeltaLake`. Было сломано в версии 25.7 (https://github.com/ClickHouse/ClickHouse/pull/81136). [#85223](https://github.com/ClickHouse/ClickHouse/pull/85223) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Изменено значение `allow_experimental_delta_kernel_rs` на `false` для версий до 25.5 для обеспечения совместимости. [#84587](https://github.com/ClickHouse/ClickHouse/pull/84587) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Исправлено чтение количества записей из кеша для delta lake. [#85704](https://github.com/ClickHouse/ClickHouse/pull/85704) ([Kseniia Sumarokova](https://github.com/kssenii)).

### Исправления TTL и MergeTree {#ttl-and-mergetree-fixes}

- Пересчёт индекса min-max при удалении строк с помощью TTL для обеспечения корректности алгоритмов, зависящих от него, таких как `minmax_count_projection`. Решает проблему [#77091](https://github.com/ClickHouse/ClickHouse/issues/77091). [#77166](https://github.com/ClickHouse/ClickHouse/pull/77166) ([Amos Bird](https://github.com/amosbird)).
- Исправлен некорректный пересчёт TTL в TTL GROUP BY при обновлении TTL. [#81222](https://github.com/ClickHouse/ClickHouse/pull/81222) ([Evgeniy Ulasik](https://github.com/H0uston)).
- Исправлена ошибка "Context has expired" во время слияний при использовании словаря в выражении TTL. [#81690](https://github.com/ClickHouse/ClickHouse/pull/81690) ([Azat Khuzhin](https://github.com/azat)).
- Исправлена ошибка LOGICAL_ERROR и последующий сбой при использовании одного и того же столбца в TTL для GROUP BY и SET. [#82054](https://github.com/ClickHouse/ClickHouse/pull/82054) ([Pablo Marcos](https://github.com/pamarcos)).
- MergeTree теперь не выполняет никаких операций, связанных с TTL, если все TTL удалены из таблицы. [#84441](https://github.com/ClickHouse/ClickHouse/pull/84441) ([alesapin](https://github.com/alesapin)).
- Исправлена проблема, когда `ALTER MODIFY ORDER BY` не проверял столбцы TTL в ключах сортировки. Столбцы TTL теперь корректно отклоняются при использовании в выражениях `ORDER BY` во время операций `ALTER`, предотвращая возможное повреждение таблицы. [#84536](https://github.com/ClickHouse/ClickHouse/pull/84536) ([xiaohuanlin](https://github.com/xiaohuanlin)).

### Исправления проекций {#projection-fixes}


- Исправлена логическая ошибка при материализации проекции, когда тип столбца изменялся на Nullable. [#80741](https://github.com/ClickHouse/ClickHouse/pull/80741) ([Pavel Kruglov](https://github.com/Avogar)).
- Исправлено некорректное использование метаданных родительской таблицы в табличной функции `mergeTreeProjection` при `enable_shared_storage_snapshot_in_query = 1`. Относится к [#82634](https://github.com/ClickHouse/ClickHouse/issues/82634). [#82638](https://github.com/ClickHouse/ClickHouse/pull/82638) ([Amos Bird](https://github.com/amosbird)).
- Исправлено редкое падение ClickHouse, когда таблица имеет проекцию, установлен параметр `lightweight_mutation_projection_mode = 'rebuild'` и пользователь выполняет лёгкое удаление, которое удаляет ВСЕ строки из любого блока таблицы. [#84158](https://github.com/ClickHouse/ClickHouse/pull/84158) ([alesapin](https://github.com/alesapin)).
- Исправлено резервное копирование кусков данных с повреждёнными проекциями. [#85362](https://github.com/ClickHouse/ClickHouse/pull/85362) ([Antonio Andelic](https://github.com/antonio2368)).
- Запрещено использование столбца `_part_offset` в проекциях до его стабилизации. [#85372](https://github.com/ClickHouse/ClickHouse/pull/85372) ([Sema Checherinda](https://github.com/CheSema)).

### Исправления параллельных реплик {#parallel-replicas-fixes}

- Для некоторых запросов, выполняемых с параллельными репликами, оптимизация упорядоченного чтения могла применяться на инициаторе, но не на удалённых узлах. Это приводило к использованию различных режимов чтения координатором параллельных реплик (на инициаторе) и удалёнными узлами, что является логической ошибкой. [#80652](https://github.com/ClickHouse/ClickHouse/pull/80652) ([Igor Nikonov](https://github.com/devcrafter)).
- Отключены параллельные реплики, когда подзапрос содержит `FINAL` [#81401](https://github.com/ClickHouse/ClickHouse/issues/81401). [#83455](https://github.com/ClickHouse/ClickHouse/pull/83455) ([zoomxi](https://github.com/zoomxi)).
- Исправлена ошибка `LOGICAL_ERROR` для запросов с параллельными репликами и несколькими INNER-соединениями, за которыми следует RIGHT-соединение. Параллельные реплики не используются для таких запросов. [#84299](https://github.com/ClickHouse/ClickHouse/pull/84299) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Запросы с параллельными репликами, использующие оптимизацию чтения в обратном порядке, могут выдавать некорректный результат. [#85406](https://github.com/ClickHouse/ClickHouse/pull/85406) ([Igor Nikonov](https://github.com/devcrafter)).

### Аутентификация и безопасность {#authentication-and-security}


- Исправлено скрытие значений именованных коллекций в логах/query_log. Закрывает [#82405](https://github.com/ClickHouse/ClickHouse/issues/82405). [#82510](https://github.com/ClickHouse/ClickHouse/pull/82510) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Установка соли для данных аутентификации при парсинге из AST с типом SCRAM_SHA256_PASSWORD. [#82888](https://github.com/ClickHouse/ClickHouse/pull/82888) ([Tuan Pham Anh](https://github.com/tuanpach)).
- Маскировка данных аутентификации реестра схем Avro для скрытия от пользователя и в логах. [#83713](https://github.com/ClickHouse/ClickHouse/pull/83713) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Исправлено некорректное поведение, когда выполнение `REVOKE S3 ON system.*` отзывает разрешения S3 для `*.*`. Исправляет [#83417](https://github.com/ClickHouse/ClickHouse/issues/83417). [#83420](https://github.com/ClickHouse/ClickHouse/pull/83420) ([pufit](https://github.com/pufit)).
- Исправлено падение сервера, когда пользователь, созданный с `no_password`, пытается войти после изменения настройки сервера `allow_no_password` на 0. [#84426](https://github.com/ClickHouse/ClickHouse/pull/84426) ([Shankar Iyer](https://github.com/shankar-iyer)).
- Улучшено сообщение об ошибке при попытке создать пользователя с идентификацией через JWT. [#85072](https://github.com/ClickHouse/ClickHouse/pull/85072) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Маскировка учетных данных для `deltaLakeAzure`, `deltaLakeCluster`, `icebergS3Cluster` и `icebergAzureCluster`. [#85889](https://github.com/ClickHouse/ClickHouse/pull/85889) ([Julian Maicher](https://github.com/jmaicher)).
- Исправлена ошибка, внесенная в [#79963](https://github.com/ClickHouse/ClickHouse/pull/79963). При вставке в материализованное представление с definer проверка разрешений должна использовать права definer. Исправляет [#79951](https://github.com/ClickHouse/ClickHouse/issues/79951). [#83502](https://github.com/ClickHouse/ClickHouse/pull/83502) ([pufit](https://github.com/pufit)).

### Исправления резервного копирования и восстановления {#backup-and-restore-fixes}

- Исправлено резервное копирование пустой таблицы `Memory`, которое приводило к сбою восстановления с ошибкой `BACKUP_ENTRY_NOT_FOUND`. [#82791](https://github.com/ClickHouse/ClickHouse/pull/82791) ([Julia Kartseva](https://github.com/jkartseva)).
- Исправлено вводящее в заблуждение сообщение об ошибке при восстановлении резервной копии на диск только для чтения. [#83051](https://github.com/ClickHouse/ClickHouse/pull/83051) ([Julia Kartseva](https://github.com/jkartseva)).
- Исправлен запуск избыточных внутренних резервных копий после проблем с подключением. [#84755](https://github.com/ClickHouse/ClickHouse/pull/84755) ([Vitaly Baranov](https://github.com/vitlibar)).

### Оконные и агрегатные функции {#window-and-aggregate-functions}

- Исправлено возможное падение в `Aggregator` в случае исключения во время слияния. [#81450](https://github.com/ClickHouse/ClickHouse/pull/81450) ([Nikita Taranov](https://github.com/nickitat)).
- Исправлено возможное падение в `Aggregator` в случае исключения во время слияния. [#82022](https://github.com/ClickHouse/ClickHouse/pull/82022) ([Nikita Taranov](https://github.com/nickitat)).
- Исправлена ошибка копирования-вставки в arraySimilarity, запрещающая использование весов UInt32 и Int32. Обновлены тесты и документация. [#82103](https://github.com/ClickHouse/ClickHouse/pull/82103) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Исправлено переполнение в функциях `numericIndexedVectorPointwiseAdd`, `numericIndexedVectorPointwiseSubtract`, `numericIndexedVectorPointwiseMultiply`, `numericIndexedVectorPointwiseDivide`, которое происходило при применении их к большим числам. [#82165](https://github.com/ClickHouse/ClickHouse/pull/82165) ([Raufs Dunamalijevs](https://github.com/rienath)).

### Исправления Parquet и форматов файлов {#parquet-and-file-format-fixes}


- Исправлено некорректное применение bloom-фильтра Parquet к условию вида `WHERE function(key) IN (...)` как к `WHERE key IN (...)`. [#81255](https://github.com/ClickHouse/ClickHouse/pull/81255) ([Michael Kolupaev](https://github.com/al13n321)).
- Исправлен вывод некорректной статистики (min/max) для типов Decimal при записи в формат Parquet. [#83754](https://github.com/ClickHouse/ClickHouse/pull/83754) ([Michael Kolupaev](https://github.com/al13n321)).
- Исправлена десериализация `groupArraySample`/`groupArrayLast` в случае пустых элементов (десериализация могла пропускать часть бинарных данных при пустом входе, что могло приводить к повреждению данных при чтении и ошибке UNKNOWN_PACKET_FROM_SERVER в TCP-протоколе). Это не затрагивает числовые типы и типы даты и времени. [#82763](https://github.com/ClickHouse/ClickHouse/pull/82763) ([Pedro Ferreira](https://github.com/PedroTadim)).
- Исправлена запись JSON-путей со значениями NULL в формате RowBinary. [#83923](https://github.com/ClickHouse/ClickHouse/pull/83923) ([Pavel Kruglov](https://github.com/Avogar)).

### Исправления JOIN {#join-fixes}

- Исправлена модификация фильтра для запросов с выражением JOIN с таблицей, использующей движок `Merge`. Исправляет [#82092](https://github.com/ClickHouse/ClickHouse/issues/82092). [#82950](https://github.com/ClickHouse/ClickHouse/pull/82950) ([Dmitry Novik](https://github.com/novikd)).
- Исправлено падение при соединении хранилища ключ-значение с ключом, приведённым к другому типу. [#82497](https://github.com/ClickHouse/ClickHouse/pull/82497) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
- Исправлена логическая ошибка при разрешении шаблона в запросе с несколькими JOIN, закрывает [#81969](https://github.com/ClickHouse/ClickHouse/issues/81969). [#82421](https://github.com/ClickHouse/ClickHouse/pull/82421) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Исправлено слияние фильтра в условие JOIN в случаях, когда операнды равенства имеют разные типы или ссылаются на константы. Исправляет [#83432](https://github.com/ClickHouse/ClickHouse/issues/83432). [#84145](https://github.com/ClickHouse/ClickHouse/pull/84145) ([Dmitry Novik](https://github.com/novikd)).
- Исправлена логическая ошибка `Expected single dictionary argument for function` при выполнении JOIN по условию неравенства, когда одна из колонок имеет тип `LowCardinality`, а другая является константой. Закрывает [#81779](https://github.com/ClickHouse/ClickHouse/issues/81779). [#84019](https://github.com/ClickHouse/ClickHouse/pull/84019) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Исправления реплицируемых баз данных {#replicated-database-fixes}


- Исправлена функция markReplicasActive в DDLWorker и DatabaseReplicatedDDLWorker. [#81395](https://github.com/ClickHouse/ClickHouse/pull/81395) ([Tuan Pham Anh](https://github.com/tuanpach)).
- Исправлена функция `DatabaseReplicated::getClusterImpl`. Если первый элемент (или элементы) `hosts` имеет `id == DROPPED_MARK` и отсутствуют другие элементы для того же шарда, первый элемент `shards` будет пустым вектором, что приводит к исключению `std::out_of_range`. [#82093](https://github.com/ClickHouse/ClickHouse/pull/82093) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Добавлено отслеживание количества задач асинхронной загрузки таблиц. Если есть выполняющиеся задачи, `tail_ptr` в `TransactionLog::removeOldEntries` не обновляется. [#82824](https://github.com/ClickHouse/ClickHouse/pull/82824) ([Tuan Pham Anh](https://github.com/tuanpach)).
- Исправлена проблема, при которой, если таблица MergeTree создана с параметром `add_minmax_index_for_numeric_columns=1` или `add_minmax_index_for_string_columns=1`, индекс позже материализуется во время операции ALTER, что препятствует корректной инициализации реплицируемой базы данных на новой реплике. [#83751](https://github.com/ClickHouse/ClickHouse/pull/83751) ([Nikolay Degterinsky](https://github.com/evillique)).
- Исправлено создание материализованного представления на новой реплике реплицируемой базы данных, если DEFINER удалён. [#85327](https://github.com/ClickHouse/ClickHouse/pull/85327) ([Nikolay Degterinsky](https://github.com/evillique)).
- Исправлено восстановление реплицируемых баз данных в случаях, когда перемещение файла метаданных занимает длительное время. [#85177](https://github.com/ClickHouse/ClickHouse/pull/85177) ([Tuan Pham Anh](https://github.com/tuanpach)).
- Принудительное восстановление реплицируемой базы данных после восстановления метаданных базы данных в Keeper. [#85960](https://github.com/ClickHouse/ClickHouse/pull/85960) ([Tuan Pham Anh](https://github.com/tuanpach)).
- Исправлена ошибка при восстановлении реплицируемой базы данных: если имя таблицы содержит символ `%`, таблица могла быть пересоздана с другим именем во время восстановления. [#85987](https://github.com/ClickHouse/ClickHouse/pull/85987) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Теперь DDL worker очищает устаревшие хосты из набора реплик. Это уменьшит объём хранимых метаданных в ZooKeeper. [#88154](https://github.com/ClickHouse/ClickHouse/pull/88154) ([alesapin](https://github.com/alesapin)).

### Исправления лёгких обновлений {#lightweight-updates-fixes}

- Исправлены лёгкие обновления для таблиц с движками `ReplacingMergeTree` и `CollapsingMergeTree`. [#84851](https://github.com/ClickHouse/ClickHouse/pull/84851) ([Anton Popov](https://github.com/CurtizJ)).
- Исправлена логическая ошибка в лёгких обновлениях, которые обновляют все столбцы в таблице. [#84380](https://github.com/ClickHouse/ClickHouse/pull/84380) ([Anton Popov](https://github.com/CurtizJ)).
- Исправлены лёгкие обновления для таблиц с движком `ReplicatedMergeTree`, созданных на серверах с версией ниже 25.7. [#84933](https://github.com/ClickHouse/ClickHouse/pull/84933) ([Anton Popov](https://github.com/CurtizJ)).
- Исправлены лёгкие обновления для таблиц с нереплицируемым движком `MergeTree` после выполнения запроса `ALTER TABLE ... REPLACE PARTITION`. [#84941](https://github.com/ClickHouse/ClickHouse/pull/84941) ([Anton Popov](https://github.com/CurtizJ)).
- Исправлена очистка патч-кусков в `ReplicatedMergeTree`. Ранее результат лёгкого обновления мог временно не отображаться на реплике до тех пор, пока объединённый или мутированный кусок, материализующий патч-куски, не будет загружен с другой реплики. [#85121](https://github.com/ClickHouse/ClickHouse/pull/85121) ([Anton Popov](https://github.com/CurtizJ)).

### Исправления S3 и объектного хранилища {#s3-and-object-storage-fixes}


- Исправлена валидация аргументов табличной функции S3 при маскировании секретов, предотвращающая возможную ошибку `LOGICAL_ERROR`, закрывает [#80620](https://github.com/ClickHouse/ClickHouse/issues/80620). [#82056](https://github.com/ClickHouse/ClickHouse/pull/82056) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Исправлена возможная взаимоблокировка для удалённых запросов при нехватке памяти на сервере. [#82160](https://github.com/ClickHouse/ClickHouse/pull/82160) ([Kirill](https://github.com/kirillgarbar)).
- Добавлено истечение срока действия токена AWS ECS для возможности его перезагрузки. [#82422](https://github.com/ClickHouse/ClickHouse/pull/82422) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Исправлено отключение выравнивания границ для кешированного буфера во внешних движках таблиц. Было сломано в https://github.com/ClickHouse/ClickHouse/pull/81868. [#82493](https://github.com/ClickHouse/ClickHouse/pull/82493) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Исправлен параметр `no_sign_request` для клиента S3. Он может использоваться для явного отказа от подписывания запросов S3. Также может быть определён для конкретных конечных точек с помощью настроек на основе конечных точек. [#83379](https://github.com/ClickHouse/ClickHouse/pull/83379) ([Antonio Andelic](https://github.com/antonio2368)).
- Пропуск недоступных узлов при выполнении INSERT SELECT из s3Cluster() в реплицируемый MergeTree. [#83676](https://github.com/ClickHouse/ClickHouse/pull/83676) ([Igor Nikonov](https://github.com/devcrafter)).
- Исправлено условие досрочного возврата для замедления частоты запросов S3: для включения поведения замедления при приостановке всех потоков из-за повторяемой ошибки теперь требуется истинность либо s3_slow_all_threads_after_network_error, либо backup_slow_all_threads_after_retryable_s3_error, вместо требования истинности обоих параметров. [#85505](https://github.com/ClickHouse/ClickHouse/pull/85505) ([Julia Kartseva](https://github.com/jkartseva)).
- Исправлена логическая ошибка при чтении из функций объектного хранилища через распределённую таблицу или удалённую табличную функцию. Исправляет: [#84658](https://github.com/ClickHouse/ClickHouse/issues/84658), исправляет [#85173](https://github.com/ClickHouse/ClickHouse/issues/85173), исправляет [#52022](https://github.com/ClickHouse/ClickHouse/issues/52022). [#85359](https://github.com/ClickHouse/ClickHouse/pull/85359) ([alesapin](https://github.com/alesapin)).
- Исправлена логическая ошибка S3Queue «Таблица уже зарегистрирована». Закрывает [#84433](https://github.com/ClickHouse/ClickHouse/issues/84433). Сломано после https://github.com/ClickHouse/ClickHouse/pull/83530. [#84677](https://github.com/ClickHouse/ClickHouse/pull/84677) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Исправлена проблема с большими значениями настроек, приводящая к поломке таблиц S3Queue и перезапуску реплик. [#86074](https://github.com/ClickHouse/ClickHouse/pull/86074) ([Nikolay Degterinsky](https://github.com/evillique)).

### Исправления типов Dynamic и Variant {#dynamicandvarianttypefixes}

- Исправлен откат столбца Dynamic при ошибке парсинга. [#82169](https://github.com/ClickHouse/ClickHouse/pull/82169) ([Pavel Kruglov](https://github.com/Avogar)).
- Исправлено возможное падение типа Variant в UNION. [#83295](https://github.com/ClickHouse/ClickHouse/pull/83295) ([Pavel Kruglov](https://github.com/Avogar)).
- Исправлено чтение столбца Variant с ленивой материализацией. [#84400](https://github.com/ClickHouse/ClickHouse/pull/84400) ([Pavel Kruglov](https://github.com/Avogar)).
- Отключена валидация экспериментальных/подозрительных типов при выполнении выражений default/materialize во время чтения из существующей таблицы. [#81618](https://github.com/ClickHouse/ClickHouse/pull/81618) ([Pavel Kruglov](https://github.com/Avogar)).

### Исправления Keeper {#keeper-fixes}


- Исправление Keeper: корректное обновление общего количества наблюдателей при удалении эфемерных узлов при закрытии сессии. [#83583](https://github.com/ClickHouse/ClickHouse/pull/83583) ([Antonio Andelic](https://github.com/antonio2368)).
- Исправлена запись в журнал изменений Keeper в неправильном порядке. Ранее могли происходить незавершённые записи в журнал изменений, но откат мог вызвать одновременное изменение целевого файла. Это приводило к несогласованности журналов и возможной потере данных. [#84434](https://github.com/ClickHouse/ClickHouse/pull/84434) ([Antonio Andelic](https://github.com/antonio2368)).
- Исправлены утечки памяти для Keeper с хранилищем RocksDB (итераторы не уничтожались). [#84523](https://github.com/ClickHouse/ClickHouse/pull/84523) ([Azat Khuzhin](https://github.com/azat)).
- Исправлена проблема, при которой настройка Keeper `rotate_log_storage_interval = 0` вызывала аварийное завершение работы ClickHouse (проблема [#83975](https://github.com/ClickHouse/ClickHouse/issues/83975)). [#84637](https://github.com/ClickHouse/ClickHouse/pull/84637) ([George Larionov](https://github.com/george-larionov)).
- Исправлен подсчёт общего количества наблюдателей, возвращаемого Keeper. [#84890](https://github.com/ClickHouse/ClickHouse/pull/84890) ([Antonio Andelic](https://github.com/antonio2368)).
- Блокировка 'mutex' при получении zookeeper из 'view' в RefreshTask. [#84699](https://github.com/ClickHouse/ClickHouse/pull/84699) ([Tuan Pham Anh](https://github.com/tuanpach)).

### Исправления индексации {#indexing-fixes}

- Исправлен избыточный пропуск гранул при фильтрации по токен/ngram индексам с регулярным выражением, содержащим альтернативу и нелитеральную первую альтернативу. [#79373](https://github.com/ClickHouse/ClickHouse/pull/79373) ([Eduard Karacharov](https://github.com/korowa)).
- Реализация настройки `use_skip_indexes_if_final_exact_mode` (введена в версии 25.6) могла не выбрать соответствующий диапазон кандидатов в зависимости от настроек движка `MergeTree` / распределения данных. Теперь это исправлено. [#82667](https://github.com/ClickHouse/ClickHouse/pull/82667) ([Shankar Iyer](https://github.com/shankar-iyer)).
- Оптимизация настройки `use_skip_indexes_if_final_exact_mode` (введена в версии 25.6) могла не выбрать соответствующий диапазон кандидатов в зависимости от настроек движка `MergeTree` / распределения данных. Теперь это исправлено. [#82879](https://github.com/ClickHouse/ClickHouse/pull/82879) ([Shankar Iyer](https://github.com/shankar-iyer)).
- Ранее индексы `set` не учитывали столбцы `Nullable` при проверке прохождения гранул через фильтр (проблема [#75485](https://github.com/ClickHouse/ClickHouse/issues/75485)). [#84305](https://github.com/ClickHouse/ClickHouse/pull/84305) ([Elmi Ahmadov](https://github.com/ahmadov)).
- Сравнение со значением nan не использовало корректные диапазоны при вычислении индекса `MinMax`. [#84386](https://github.com/ClickHouse/ClickHouse/pull/84386) ([Elmi Ahmadov](https://github.com/ahmadov)).
- Токенизаторы `ngram` и `no_op` больше не вызывают сбой (экспериментального) текстового индекса при пустых входных токенах. [#84849](https://github.com/ClickHouse/ClickHouse/pull/84849) ([Robert Schulze](https://github.com/rschu1ze)).

### Исправления материализованных представлений {#materialized-view-fixes}


- Исправлена ошибка в зависимостях таблиц, из-за которой материализованные представления пропускали запросы INSERT. [#82222](https://github.com/ClickHouse/ClickHouse/pull/82222) ([Nikolay Degterinsky](https://github.com/evillique)).
- После https://github.com/ClickHouse/ClickHouse/pull/79963 использование подстолбцов в материализованных представлениях перестало работать, и пользователь мог получить ошибку `Not found column X in block`. Это поведение исправлено. Исправляет: [#82784](https://github.com/ClickHouse/ClickHouse/issues/82784). [#83221](https://github.com/ClickHouse/ClickHouse/pull/83221) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Исправлена ошибка illegal_type_of_argument в материализованных представлениях при различных типах данных. [#85135](https://github.com/ClickHouse/ClickHouse/pull/85135) ([Sema Checherinda](https://github.com/CheSema)).

### Исправления Azure и облачного хранилища {#azure-and-cloud-storage-fixes}

- В AzureBlobStorage при нативном копировании выполняется сравнение методов аутентификации. Если при этом возникает исключение, код был обновлен для переключения на чтение и копирование (т.е. ненативное копирование). [#82693](https://github.com/ClickHouse/ClickHouse/pull/82693) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
- Исправлена двойная очистка памяти в `AzureIteratorAsync`. [#85064](https://github.com/ClickHouse/ClickHouse/pull/85064) ([Nikita Taranov](https://github.com/nickitat)).

### Исправления сбоев и стабильности {#crash-and-stability-fixes}

- Исправлен возможный сбой при логировании во время завершения сессии, поскольку user_id иногда может быть пустым. [#82513](https://github.com/ClickHouse/ClickHouse/pull/82513) ([Bharat Nallan](https://github.com/bharatnc)).
- Исправлен сбой в клиенте из-за соединения, оставшегося в отключенном состоянии после неудачного `INSERT`. [#83253](https://github.com/ClickHouse/ClickHouse/pull/83253) ([Azat Khuzhin](https://github.com/azat)).
- Исправлен сбой при вычислении размера блока с пустыми столбцами. [#83271](https://github.com/ClickHouse/ClickHouse/pull/83271) ([Raúl Marín](https://github.com/Algunenano)).
- Исправлен сбой, который может произойти для запроса с настройкой 'max_threads=1' при выполнении под нагрузкой с включенным планированием CPU. [#83387](https://github.com/ClickHouse/ClickHouse/pull/83387) ([Fan Ziqi](https://github.com/f2quantum)).
- Ошибка `zoutofmemory` теперь обрабатывается как аппаратная ошибка, иначе будет выброшена логическая ошибка. См. https://github.com/clickhouse/clickhouse-core-incidents/issues/877. [#84420](https://github.com/ClickHouse/ClickHouse/pull/84420) ([Han Fei](https://github.com/hanfei1991)).
- Исправлено возможное аварийное завершение (из-за присоединения потоков из задачи) и, предположительно, зависания (в модульных тестах) во время остановки `BackgroundSchedulePool`. [#83769](https://github.com/ClickHouse/ClickHouse/pull/83769) ([Azat Khuzhin](https://github.com/azat)).
- Исправлена взаимоблокировка, вызванная фоновым потоком проверки отмены. [#84203](https://github.com/ClickHouse/ClickHouse/pull/84203) ([Antonio Andelic](https://github.com/antonio2368)).
- Исправлена взаимоблокировка при остановке из-за рекурсивной блокировки контекста во время очистки library bridge. [#83824](https://github.com/ClickHouse/ClickHouse/pull/83824) ([Azat Khuzhin](https://github.com/azat)).
- Исправлен сбой в клиенте из-за соединения, оставшегося в отключенном состоянии после неудачного `INSERT`. [#83842](https://github.com/ClickHouse/ClickHouse/pull/83842) ([Azat Khuzhin](https://github.com/azat)).
- Исправлено возможное неопределенное поведение (сбои) в случае `MEMORY_LIMIT_EXCEEDED` во время десериализации String. [#85440](https://github.com/ClickHouse/ClickHouse/pull/85440) ([Azat Khuzhin](https://github.com/azat)).
- Исправлен редкий сбой в асинхронных вставках, которые изменяют настройки `log_comment` или `insert_deduplication_token`. [#85540](https://github.com/ClickHouse/ClickHouse/pull/85540) ([Anton Popov](https://github.com/CurtizJ)).

### Исправления Glue и каталога {#glue-and-catalog-fixes}


- Исправлена ошибка в интеграции с Glue Catalog. Теперь ClickHouse может читать таблицы с вложенными типами данных, где некоторые подстолбцы содержат десятичные числа, например: `map<string, decimal(9, 2)>`. Исправляет [#81301](https://github.com/ClickHouse/ClickHouse/issues/81301). [#82114](https://github.com/ClickHouse/ClickHouse/pull/82114) ([alesapin](https://github.com/alesapin)).
- ClickHouse теперь читает таблицы из Glue Catalog, где тип таблицы указан в нижнем регистре. [#84316](https://github.com/ClickHouse/ClickHouse/pull/84316) ([alesapin](https://github.com/alesapin)).
- Unity Catalog теперь игнорирует схемы с нестандартными типами данных в случае таблиц, не являющихся Delta-таблицами. Исправляет [#85699](https://github.com/ClickHouse/ClickHouse/issues/85699). [#85950](https://github.com/ClickHouse/ClickHouse/pull/85950) ([alesapin](https://github.com/alesapin)).

### Исправления функций {#function-fixes}

- Функции `trim{Left,Right,Both}` теперь поддерживают входные строки типа `FixedString(N)`. Например, `SELECT trimBoth(toFixedString('abc', 3), 'ac')` теперь работает. [#82691](https://github.com/ClickHouse/ClickHouse/pull/82691) ([Robert Schulze](https://github.com/rschu1ze)).
- Функция `trim`, вызванная с полностью константными входными данными, теперь возвращает константную выходную строку. (Ошибка [#78796](https://github.com/ClickHouse/ClickHouse/issues/78796)). [#82900](https://github.com/ClickHouse/ClickHouse/pull/82900) ([Robert Schulze](https://github.com/rschu1ze)).
- Исправлен некорректный вывод функции `formatDateTime`, когда форматтер `%f` используется вместе с форматтерами переменной длины (например, `%M`). [#83020](https://github.com/ClickHouse/ClickHouse/pull/83020) ([Robert Schulze](https://github.com/rschu1ze)).
- Исправлена ошибка для аргументов `NULL` в функции `CASE`. [#82436](https://github.com/ClickHouse/ClickHouse/pull/82436) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Исправлено использование несвязанных частей общего словаря в функции `lowCardinalityKeys`. [#83118](https://github.com/ClickHouse/ClickHouse/pull/83118) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Исправлены функции `colorSRGBToOKLCH`/`colorOKLCHToSRGB` для смешанных константных и неконстантных аргументов. [#83906](https://github.com/ClickHouse/ClickHouse/pull/83906) ([Azat Khuzhin](https://github.com/azat)).
- Исправлено некорректное создание пустых кортежей в функции `array()`. Это исправляет [#84202](https://github.com/ClickHouse/ClickHouse/issues/84202). [#84297](https://github.com/ClickHouse/ClickHouse/pull/84297) ([Amos Bird](https://github.com/amosbird)).
- Исправлена ошибка, вызывавшая некорректное кодирование и декодирование Bech32. Ошибка не была обнаружена изначально из-за того, что онлайн-реализация алгоритма, использовавшаяся для тестирования, имела ту же проблему. [#84257](https://github.com/ClickHouse/ClickHouse/pull/84257) ([George Larionov](https://github.com/george-larionov)).

### Исправления распределённых запросов {#distributed-query-fixes}


- Параллельный распределённый `INSERT SELECT` с `LIMIT` был разрешён, что некорректно и приводит к дублированию данных в целевой таблице. [#84477](https://github.com/ClickHouse/ClickHouse/pull/84477) ([Igor Nikonov](https://github.com/devcrafter)).
- Не пытаться заменять табличные функции на их кластерные альтернативы при наличии `JOIN` или подзапроса. [#84335](https://github.com/ClickHouse/ClickHouse/pull/84335) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Добавлена проверка использования коррелированного подзапроса в распределённом контексте для предотвращения сбоя. Исправляет [#82205](https://github.com/ClickHouse/ClickHouse/issues/82205). [#85030](https://github.com/ClickHouse/ClickHouse/pull/85030) ([Dmitry Novik](https://github.com/novikd)).
- Использование `distributed_depth` в качестве индикатора функции `*Cluster` было некорректным и могло привести к дублированию данных; вместо этого используется `client_info.collaborate_with_initiator`. [#85734](https://github.com/ClickHouse/ClickHouse/pull/85734) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Поддержка глобальных констант из выражения `WITH` для параллельного распределённого `INSERT SELECT` с целевой таблицей `Distributed`. Ранее запрос мог выдавать ошибку `Unknown expression identifier`. [#85811](https://github.com/ClickHouse/ClickHouse/pull/85811) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Исправлена логическая ошибка при попытке выполнить `CREATE ... AS (SELECT * FROM s3Cluster(...))` с `DatabaseReplicated`. [#85904](https://github.com/ClickHouse/ClickHouse/pull/85904) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Добавлены проверки для sharding_key при выполнении ALTER таблицы Distributed. Ранее некорректный ALTER мог нарушить определение таблицы и работу сервера после перезапуска. [#86015](https://github.com/ClickHouse/ClickHouse/pull/86015) ([Nikolay Degterinsky](https://github.com/evillique)).

### Исправления метрик и мониторинга {#metrics-and-monitoring-fixes}

- Исправлена валидация настроек асинхронных метрик `asynchronous_metrics_update_period_s` и `asynchronous_heavy_metrics_update_period_s`. [#82310](https://github.com/ClickHouse/ClickHouse/pull/82310) ([Bharat Nallan](https://github.com/bharatnc)).
- Исправлены метрики `IndexUncompressedCacheBytes`/`IndexUncompressedCacheCells`/`IndexMarkCacheBytes`/`IndexMarkCacheFiles` (ранее они включались в метрику без префикса `Cache`). [#83730](https://github.com/ClickHouse/ClickHouse/pull/83730) ([Azat Khuzhin](https://github.com/azat)).
- Исправлена ошибка `LOGICAL_ERROR` в QueryMetricLog: Mutex не может быть `NULL`. [#82979](https://github.com/ClickHouse/ClickHouse/pull/82979) ([Pablo Marcos](https://github.com/pamarcos)).
- Исправлены некорректные метрики KafkaAssignedPartitions и KafkaConsumersWithAssignment. [#85494](https://github.com/ClickHouse/ClickHouse/pull/85494) ([Ilya Golshtein](https://github.com/ilejn)).
- Исправлена заниженная статистика обработанных байтов при использовании `PREWHERE` (явного или автоматического). [#85495](https://github.com/ClickHouse/ClickHouse/pull/85495) ([Michael Kolupaev](https://github.com/al13n321)).
- Исправлено расхождение отслеживания памяти из фонового пула планирования и исполнителя. [#84946](https://github.com/ClickHouse/ClickHouse/pull/84946) ([Azat Khuzhin](https://github.com/azat)).

### Исправления типов данных и преобразований {#data-type-and-conversion-fixes}


- Исправлены случаи, когда парсинг Time мог вызывать проблемы msan. Исправляет: [#82477](https://github.com/ClickHouse/ClickHouse/issues/82477). [#82514](https://github.com/ClickHouse/ClickHouse/pull/82514) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Исправлена сортировка значений NaN в типе `LowCardinality(Float32|Float64|BFloat16)`. [#83786](https://github.com/ClickHouse/ClickHouse/pull/83786) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
- Исправлено переполнение больших значений (\>2106-02-07) при приведении из `Date` в `DateTime64`. [#83982](https://github.com/ClickHouse/ClickHouse/pull/83982) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Исправлена проблема с неявным чтением отрицательных значений Time в таблицу и устранена неясность в документации. [#83091](https://github.com/ClickHouse/ClickHouse/pull/83091) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Кодек `DoubleDelta` теперь может применяться только к столбцам числовых типов. В частности, столбцы `FixedString` больше не могут сжиматься с использованием `DoubleDelta`. (исправляет [#80220](https://github.com/ClickHouse/ClickHouse/issues/80220)). [#84383](https://github.com/ClickHouse/ClickHouse/pull/84383) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
- Исправлена потеря точности в `JSONExtract` при преобразовании чисел JSON в типы Decimal. Теперь числовые значения JSON сохраняют точное десятичное представление, избегая ошибок округления с плавающей точкой. [#85665](https://github.com/ClickHouse/ClickHouse/pull/85665) ([ssive7b](https://github.com/ssive7b)).

### Управление памятью и ресурсами {#memory-and-resource-management}

- Исправлен некорректный учёт памяти для `max_untracked_memory`. [#83607](https://github.com/ClickHouse/ClickHouse/pull/83607) ([Azat Khuzhin](https://github.com/azat)).
- Счётчики `async_read_counters` больше не разделяются между запросами. [#83423](https://github.com/ClickHouse/ClickHouse/pull/83423) ([Azat Khuzhin](https://github.com/azat)).
- Исправлены возможные ошибки неинициализированного файлового кеша при его использовании в качестве временного хранилища данных. [#83539](https://github.com/ClickHouse/ClickHouse/pull/83539) ([Bharat Nallan](https://github.com/bharatnc)).
- Параметр `filesystem_prefetches_limit` теперь применяется всегда (не только из `MergeTreePrefetchedReadPool`). [#83999](https://github.com/ClickHouse/ClickHouse/pull/83999) ([Azat Khuzhin](https://github.com/azat)).

### Исправления конфигурации и настроек {#configuration-and-settings-fixes}


- При передаче настроек через URI учитывается последнее значение. [#82137](https://github.com/ClickHouse/ClickHouse/pull/82137) ([Sema Checherinda](https://github.com/CheSema)).
- Исправлены состояния гонки данных в клиенте (за счёт отказа от использования глобального контекста) и переопределения `session_timezone` (ранее, если `session_timezone` был установлен, например, в `users.xml`/параметрах клиента в непустое значение, а в контексте запроса — в пустое, то использовалось значение из `users.xml`, что было неверно; теперь контекст запроса всегда имеет приоритет над глобальным контекстом). [#82444](https://github.com/ClickHouse/ClickHouse/pull/82444) ([Azat Khuzhin](https://github.com/azat)).
- Запрещена установка `threadpool_writer_pool_size` в ноль для предотвращения зависания операций сервера. [#82532](https://github.com/ClickHouse/ClickHouse/pull/82532) ([Bharat Nallan](https://github.com/bharatnc)).
- Устранено незначительное целочисленное переполнение в конфигурации настройки `role_cache_expiration_time_seconds` (issue [#83374](https://github.com/ClickHouse/ClickHouse/issues/83374)). [#83461](https://github.com/ClickHouse/ClickHouse/pull/83461) ([wushap](https://github.com/wushap)).
- Запрещено нулевое значение для max_insert_block_size, так как оно может вызвать логическую ошибку. [#83688](https://github.com/ClickHouse/ClickHouse/pull/83688) ([Bharat Nallan](https://github.com/bharatnc)).
- Исправлен бесконечный цикл в `estimateCompressionRatio()` при block_size_bytes=0. [#83704](https://github.com/ClickHouse/ClickHouse/pull/83704) ([Azat Khuzhin](https://github.com/azat)).
- Параметры вроде `date_time_input_format` игнорировались при использовании http с multipart. [#85570](https://github.com/ClickHouse/ClickHouse/pull/85570) ([Sema Checherinda](https://github.com/CheSema)).

### Исправления MongoDB {#mongodb-fixes}

- Ранее определения табличного движка `MongoDB` могли включать компонент пути в аргументе `host:port`, который молча игнорировался. Интеграция mongodb отказывалась загружать такие таблицы. С этим исправлением _мы разрешаем загрузку таких таблиц и игнорируем компонент пути_, если движок `MongoDB` имеет пять аргументов, используя имя базы данных из аргументов. _Примечание:_ Исправление не применяется для вновь создаваемых таблиц или запросов с табличной функцией `mongo`, а также для источников словарей и именованных коллекций. [#81942](https://github.com/ClickHouse/ClickHouse/pull/81942) ([Vladimir Cherkasov](https://github.com/vdimir)).

### Прочие исправления {#miscellaneous-fixes}


* В предыдущих версиях сервер возвращал избыточный контент для запросов к `/js`. Это закрывает [#61890](https://github.com/ClickHouse/ClickHouse/issues/61890). [#81895](https://github.com/ClickHouse/ClickHouse/pull/81895) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена функция `InterpreterInsertQuery::extendQueryLogElemImpl`, чтобы при необходимости добавлять обратные кавычки к именам баз данных и таблиц (например, когда имена содержат специальные символы, такие как `-`). [#81528](https://github.com/ClickHouse/ClickHouse/pull/81528) ([Ilia Shvyrialkin](https://github.com/Harzu)).
* Исправлена возможная гонка данных между потоком подсказок и основным потоком клиента. [#82233](https://github.com/ClickHouse/ClickHouse/pull/82233) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена безопасность работы с исключениями при переписывании union/intersect/except&#95;default&#95;mode. Закрывает [#82664](https://github.com/ClickHouse/ClickHouse/issues/82664). [#82820](https://github.com/ClickHouse/ClickHouse/pull/82820) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* При использовании реализации Database без кэширования метаданные соответствующей таблицы удаляются после возврата столбцов и аннулирования ссылки. [#82939](https://github.com/ClickHouse/ClickHouse/pull/82939) ([buyval01](https://github.com/buyval01)).
* Вызов onprogress в JSONEachRowWithProgress синхронизирован с завершением обработки. [#83879](https://github.com/ClickHouse/ClickHouse/pull/83879) ([Sema Checherinda](https://github.com/CheSema)).
* Исправлена редкая ошибка, из-за которой запрос `MATERIALIZE COLUMN` мог приводить к появлению неожиданных файлов в `checksums.txt` и в итоге к отсоединённым партициям данных. [#84007](https://github.com/ClickHouse/ClickHouse/pull/84007) ([alesapin](https://github.com/alesapin)).
* Корректная обработка исключений при периодическом обновлении частей. [#84083](https://github.com/ClickHouse/ClickHouse/pull/84083) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена генерация имён столбцов для булевых литералов: теперь используются «true»/«false» вместо «1»/«0», что предотвращает конфликты имён столбцов между булевыми и целочисленными литералами в запросах. [#84945](https://github.com/ClickHouse/ClickHouse/pull/84945) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Исправлены потенциальные проблемы с некорректной сортировкой в движке таблиц Merge. [#85025](https://github.com/ClickHouse/ClickHouse/pull/85025) ([Xiaozhe Yu](https://github.com/wudidapaopao)).
* Реализованы недостающие API для DiskEncrypted. [#85028](https://github.com/ClickHouse/ClickHouse/pull/85028) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена настройка обратной совместимости, позволяющая новому анализатору ссылаться на внешний псевдоним в предложении `WITH` в случае конфликтов имён. Исправляет [#82700](https://github.com/ClickHouse/ClickHouse/issues/82700). [#83797](https://github.com/ClickHouse/ClickHouse/pull/83797) ([Dmitry Novik](https://github.com/novikd)).
* Разрешено ссылаться на любые таблицы в аргументе `view(...)` табличной функции `remote` при включённом анализаторе. Исправляет [#78717](https://github.com/ClickHouse/ClickHouse/issues/78717). Исправляет [#79377](https://github.com/ClickHouse/ClickHouse/issues/79377). [#83844](https://github.com/ClickHouse/ClickHouse/pull/83844) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена запись с добавлением (в `MergeTree`, используемом для экспериментальных транзакций) для типов метаданных `plain_rewritable`/`plain`, которые ранее просто игнорировались. [#83695](https://github.com/ClickHouse/ClickHouse/pull/83695) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлено использование логера в `IAccessStorage`. [#84365](https://github.com/ClickHouse/ClickHouse/pull/84365) ([Konstantin Bogdanов](https://github.com/thevar1able)).
* Исправлено отсечение файлов по виртуальному столбцу в дата-лейках. [#84520](https://github.com/ClickHouse/ClickHouse/pull/84520) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проблема, из-за которой запрос к отложенному удалённому источнику мог приводить к выходу за границы вектора. [#84820](https://github.com/ClickHouse/ClickHouse/pull/84820) ([George Larionov](https://github.com/george-larionov)).
* Правильно сохранять все настройки в метаданных таблицы для движка object queue. [#84860](https://github.com/ClickHouse/ClickHouse/pull/84860) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка `CORRUPTED_DATA` при использовании ленивых столбцов с внешней сортировкой. [#84738](https://github.com/ClickHouse/ClickHouse/pull/84738) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Убраны лишние вызовы `getStatus()` во время выполнения запросов `SYSTEM DROP REPLICA`. Исправлен случай, когда таблица удаляется в фоновом режиме и выбрасывается исключение `Shutdown for storage is called`. [#85220](https://github.com/ClickHouse/ClickHouse/pull/85220) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлены недостающие проверки длины имени таблицы в запросах `CREATE OR REPLACE` и `RENAME`. [#85326](https://github.com/ClickHouse/ClickHouse/pull/85326) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлены сбой и повреждение данных во время `ALTER UPDATE` для JSON. [#85383](https://github.com/ClickHouse/ClickHouse/pull/85383) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка сегментации в coalescing merge tree для длинных строк. Закрывает [#84582](https://github.com/ClickHouse/ClickHouse/issues/84582). [#85709](https://github.com/ClickHouse/ClickHouse/pull/85709) ([scanhex12](https://github.com/scanhex12)).
* Исправлен `send_logs_source_regexp` (после рефакторинга асинхронного логирования в [#85105](https://github.com/ClickHouse/ClickHouse/issues/85105)). [#85797](https://github.com/ClickHouse/ClickHouse/pull/85797) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена возможная неконсистентность словарей с `update_field` при ошибках `MEMORY_LIMIT_EXCEEDED`. [#85807](https://github.com/ClickHouse/ClickHouse/pull/85807) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены HTTP-запросы, выполняемые табличной функцией `url()`, чтобы корректно указывать номер порта в заголовке Host при обращении к нестандартным портам. Это устраняет ошибки аутентификации при использовании предварительно подписанных URL с S3-совместимыми сервисами, такими как MinIO, работающими на нестандартных портах, что часто встречается в средах разработки. (Исправляет [#85898](https://github.com/ClickHouse/ClickHouse/issues/85898)). [#85921](https://github.com/ClickHouse/ClickHouse/pull/85921) ([Tom Quist](https://github.com/tomquist)).
