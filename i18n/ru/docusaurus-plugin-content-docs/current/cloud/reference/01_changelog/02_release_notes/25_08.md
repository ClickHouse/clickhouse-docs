---
slug: /changelogs/25.8
title: 'Журнал изменений v25.8 для Cloud'
description: 'Журнал изменений быстрого релиза v25.8'
keywords: ['журнал изменений', 'Cloud']
sidebar_label: '25.8'
sidebar_position: 1
doc_type: 'changelog'
---

## Изменения, нарушающие обратную совместимость \{#backward-incompatible-changes\}

### Изменения JSON и форматов данных \{#json-and-data-format-changes\}

* По умолчанию отключено заключение 64-битных целых чисел в кавычки в JSON-форматах. [#74079](https://github.com/ClickHouse/ClickHouse/pull/74079) ([Pavel Kruglov](https://github.com/Avogar)).
* Для массивов значений разных типов в JSON теперь выводится `Array(Dynamic)` вместо безымянного `Tuple`. Чтобы использовать прежнее поведение, отключите настройку [`input_format_json_infer_array_of_dynamic_from_array_of_different_types`](/operations/settings/formats#input_format_json_infer_array_of_dynamic_from_array_of_different_types). [#80859](https://github.com/ClickHouse/ClickHouse/pull/80859) ([Pavel Kruglov](https://github.com/Avogar)).
* Значения типа `Enum` теперь по умолчанию записываются как `BYTE_ARRAY` с логическим типом `ENUM` в выходном формате Parquet. [#84169](https://github.com/ClickHouse/ClickHouse/pull/84169) ([Pavel Kruglov](https://github.com/Avogar)).

### Хранение и секционирование \{#storage-and-partitioning\}

* Добавлена поддержка записей с секционированием в стиле Hive и переработана реализация чтения (столбцы секций Hive больше не являются виртуальными). [#76802](https://github.com/ClickHouse/ClickHouse/pull/76802) ([Arthur Passos](https://github.com/arthurpassos)).
* Настройка MergeTree [`write_marks_for_substreams_in_compact_parts`](/operations/settings/merge-tree-settings#write_marks_for_substreams_in_compact_parts) теперь по умолчанию включена. Это значительно улучшает производительность чтения подстолбцов из вновь создаваемых Compact‑частей. Серверы с версией ниже 25.5 не смогут читать новые Compact‑части. [#84171](https://github.com/ClickHouse/ClickHouse/pull/84171) ([Pavel Kruglov](https://github.com/Avogar)).
* Запрещены операции `RENAME COLUMN` или `DROP COLUMN`, которые затрагивают явно указанные столбцы для суммирования в SummingMergeTree. Закрывает [#81836](https://github.com/ClickHouse/ClickHouse/issues/81836). [#82821](https://github.com/ClickHouse/ClickHouse/pull/82821) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Улучшения функций \{#function-enhancements\}

* В функцию [`extractKeyValuePairs`](/sql-reference/functions/tuple-map-functions#extractkeyvaluepairs) добавлен новый аргумент `unexpected_quoting_character_strategy`, который определяет, что происходит, когда символ `quoting_character` неожиданно встречается. Подробности см. в документации по [`extractKeyValuePairs`](/sql-reference/functions/tuple-map-functions#extractkeyvaluepairs). [#80657](https://github.com/ClickHouse/ClickHouse/pull/80657) ([Arthur Passos](https://github.com/arthurpassos)).
* Ранее функция [`countMatches`](/sql-reference/functions/string-search-functions#countMatches) прекращала подсчёт при первом пустом совпадении, даже если шаблон его допускает. Чтобы устранить эту проблему, `countMatches` теперь продолжает выполнение, продвигаясь на один символ при возникновении пустого совпадения. Пользователи, которые хотят сохранить старое поведение, могут включить настройку `count_matches_stop_at_empty_match`. [#81676](https://github.com/ClickHouse/ClickHouse/pull/81676) ([Elmi Ahmadov](https://github.com/ahmadov)).

### Улучшения работы с типами данных \{#data-type-improvements\}

* Повышена точность преобразования из `Decimal` в `Float32`. Реализовано преобразование из `Decimal` в `BFloat16`. Закрывает [#82660](https://github.com/ClickHouse/ClickHouse/issues/82660). [#82823](https://github.com/ClickHouse/ClickHouse/pull/82823) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Управление производительностью и ресурсами \{#performance-and-resource-management\}

* Ранее запросы `BACKUP`, слияния и мутации не использовали серверные ограничители пропускной способности для локального (`max_local_read_bandwidth_for_server` и `max_local_write_bandwidth_for_server`) и удалённого (`max_remote_read_network_bandwidth_for_server` и `max_remote_write_network_bandwidth_for_server`) трафика и ограничивались только специализированными настройками сервера (`max_backup_bandwidth_for_server`, `max_mutations_bandwidth_for_server` и `max_merges_bandwidth_for_server`). Теперь они одновременно используют оба типа ограничителей. [#81753](https://github.com/ClickHouse/ClickHouse/pull/81753) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена новая настройка [`cluster_function_process_archive_on_multiple_nodes`](/operations/settings/settings#cluster_function_process_archive_on_multiple_nodes), которая повышает производительность обработки архивов в кластерных функциях при значении `true` (значение по умолчанию). Для совместимости и во избежание ошибок при обновлении до версии 25.7+ настройку следует установить в `false`, если используются кластерные функции с архивами в более ранних версиях. [#82355](https://github.com/ClickHouse/ClickHouse/pull/82355) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Предыдущее значение по умолчанию для [`concurrent_threads_scheduler`](/operations/server-configuration-parameters/settings#concurrent_threads_scheduler) было `round_robin`, что оказалось несправедливым при большом числе однопоточных запросов (например, `INSERT`). В результате в качестве значения по умолчанию используется более безопасный планировщик `fair_round_robin`. [#84747](https://github.com/ClickHouse/ClickHouse/pull/84747) ([Sergei Trifonov](https://github.com/serxa)).
* Ленивая материализация включена только при использовании анализатора запросов, чтобы избежать поддержки этого режима без анализатора, при котором возможны некоторые проблемы (например, при использовании `indexHint()` в условиях). [#83791](https://github.com/ClickHouse/ClickHouse/pull/83791) ([Igor Nikonov](https://github.com/devcrafter)).

### Схема и синтаксис SQL \{#schema-and-sql-syntax\}

* Запрещено создавать таблицу без столбцов, в которые можно вставлять данные. [#81835](https://github.com/ClickHouse/ClickHouse/pull/81835) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Требуется использовать обратные кавычки вокруг идентификаторов с точками в выражениях по умолчанию, чтобы они не разбирались как составные идентификаторы. [#83162](https://github.com/ClickHouse/ClickHouse/pull/83162) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Добавлена поддержка heredoc-синтаксиса в стиле PostgreSQL: `$tag$ string contents... $tag$`, также известного как строковые литералы с разделителями — символом доллара (dollar-quoted). В предыдущих версиях ограничения на теги были менее строгими: они могли содержать произвольные символы, включая знаки пунктуации и пробелы. Это приводило к неоднозначности при разборе с идентификаторами, которые также могут начинаться с символа доллара. При этом PostgreSQL разрешает использовать в тегах только символы слова (word characters). Для решения проблемы мы теперь ограничиваем теги heredoc так, чтобы они содержали только символы слова. Закрывает [#84731](https://github.com/ClickHouse/ClickHouse/issues/84731). [#84846](https://github.com/ClickHouse/ClickHouse/pull/84846) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Безопасность и права доступа \{#security-and-permissions\}

* `SYSTEM RESTART REPLICAS` теперь перезапускает реплики только в тех базах данных, где у вас есть право на выполнение `SHOW TABLES`. Ранее этот запрос приводил к пробуждению таблиц в базе данных Lazy даже без доступа к этой базе, в то время как эти таблицы одновременно удалялись. [#83321](https://github.com/ClickHouse/ClickHouse/pull/83321) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Функции `azureBlobStorage`, `deltaLakeAzure` и `icebergAzure` были обновлены для корректной проверки прав `AZURE`. Все кластерные варианты функций (функции `-Cluster`) теперь проверяют права по аналогии с соответствующими некластерными вариантами. Чтобы избежать ошибок прав доступа, убедитесь, что у пользователей, вызывающих функции `-Cluster`, есть соответствующие привилегии (например, `GRANT S3 ON *.* TO user`). Кроме того, функции `icebergLocal` и `deltaLakeLocal` теперь выполняют проверки прав `FILE`. [#84938](https://github.com/ClickHouse/ClickHouse/pull/84938) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov

## Новые возможности \{#new-feature\}

### Типы данных \{#data-types\}

* Добавлены новые типы данных: [`Time`](/sql-reference/data-types/time) `([H]HH:MM:SS)` и [`Time64`](/sql-reference/data-types/time64) `([H]HH:MM:SS[.fractional])`, а также несколько базовых функций приведения типов и взаимодействия с другими типами данных. Добавлены настройки для совместимости с устаревшей функцией `ToTime`. [#81217](https://github.com/ClickHouse/ClickHouse/pull/81217) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).

### Функции \{#functions\}

* Добавлена [`NumericIndexedVector`](/sql-reference/functions/numeric-indexed-vector-functions) — новая векторная структура данных, использующая bit-sliced roaring-bitmap-сжатие, а также более 20 функций для построения, анализа и покомпонентной арифметики. Может уменьшить объём хранимых данных и ускорить `JOIN`, фильтрацию и агрегации на разреженных данных. Реализует [#70582](https://github.com/ClickHouse/ClickHouse/issues/70582) и идеи статьи [&quot;Large-Scale Metric Computation in Online Controlled Experiment Platform&quot;](https://arxiv.org/abs/2405.08411) T. Xiong и Y. Wang, VLDB 2024. [#74193](https://github.com/ClickHouse/ClickHouse/pull/74193) ([FriendLey](https://github.com/FriendLey)).
* Добавлены финансовые функции: [`financialInternalRateOfReturnExtended`](/sql-reference/functions/financial-functions#financialInternalRateOfReturnExtended) (`XIRR`), [`financialInternalRateOfReturn`](/sql-reference/functions/financial-functions#financialInternalRateOfReturn) (`IRR`), [`financialNetPresentValueExtended`](/sql-reference/functions/financial-functions#financialNetPresentValueExtended) (`XNPV`), [`financialNetPresentValue`](/sql-reference/functions/financial-functions#financialNetPresentValue) (`NPV`). [#81599](https://github.com/ClickHouse/ClickHouse/pull/81599) ([Joanna Hulboj](https://github.com/jh0x)).
* Добавлены геопространственные функции [`polygonIntersectsCartesian`](/sql-reference/functions/geo/polygons#polygonsintersectcartesian) и [`polygonIntersectsSpherical`](/sql-reference/functions/geo/polygons#polygonsintersectspherical) для проверки, пересекаются ли два полигона. [#81882](https://github.com/ClickHouse/ClickHouse/pull/81882) ([Paul Lamb](https://github.com/plamb)).
* Добавлена поддержка оконных функций [`lag`](/sql-reference/window-functions/lag) и [`lead`](/sql-reference/window-functions/lead). Закрывает [#9887](https://github.com/ClickHouse/ClickHouse/issues/9887). [#82108](https://github.com/ClickHouse/ClickHouse/pull/82108) ([Dmitry Novik](https://github.com/novikd)).
* Добавлены функции [`colorSRGBToOkLCH`](/sql-reference/functions/other-functions#colorSRGBToOKLCH) и [`colorOkLCHToSRGB`](/sql-reference/functions/other-functions#colorOKLCHToSRGB) для преобразования цветов между пространствами sRGB и OkLCH. [#83679](https://github.com/ClickHouse/ClickHouse/pull/83679) ([Fgrtue](https://github.com/Fgrtue)).
* Теперь пользователи могут выполнять поиск по JSON-ключам без учета регистра с помощью [`JSONExtractCaseInsensitive`](/sql-reference/functions/json-functions#JSONExtractCaseInsensitive) (и других вариантов `JSONExtract`). [#83770](https://github.com/ClickHouse/ClickHouse/pull/83770) ([Alistair Evans](https://github.com/alistairjevans)).
* Добавлена функция [`nowInBlock64`](/sql-reference/functions/date-time-functions#nowInBlock64). [#84178](https://github.com/ClickHouse/ClickHouse/pull/84178) ([Halersson Paris](https://github.com/halersson)).
* Добавлена функция [`dateTimeToUUIDv7`](/sql-reference/functions/uuid-functions#dateTimeToUUIDv7) для преобразования значения типа DateTime в UUIDv7. Пример использования: `SELECT dateTimeToUUIDv7(toDateTime('2025-08-15 18:57:56'))` возвращает `0198af18-8320-7a7d-abd3-358db23b9d5c`. [#84319](https://github.com/ClickHouse/ClickHouse/pull/84319) ([samradovich](https://github.com/samradovich)).
* Добавлены агрегатные функции [`timeSeriesDerivToGrid`](/sql-reference/aggregate-functions/reference/timeSeriesDerivToGrid) и [`timeSeriesPredictLinearToGrid`](/sql-reference/aggregate-functions/reference/timeSeriesPredictLinearToGrid) для ресемплинга данных на временную сетку, задаваемую указанными начальной и конечной метками времени и шагом; соответственно вычисляют PromQL-подобные `deriv` и `predict_linear`. [#84328](https://github.com/ClickHouse/ClickHouse/pull/84328) ([Stephen Chi](https://github.com/stephchi0)).
* Добавлены функции [`timeSeriesRange`](/sql-reference/functions/time-series-functions#timeSeriesRange) и [`timeSeriesFromGrid`](/sql-reference/functions/time-series-functions#timeSeriesFromGrid). [#85435](https://github.com/ClickHouse/ClickHouse/pull/85435) ([Vitaly Baranov](https://github.com/vitlibar)).

### Системные таблицы \{#system-tables\}

* Добавлена таблица [`system.dead_letter_queue`](/operations/system-tables/dead_letter_queue) для хранения ошибочных входящих сообщений из движков, таких как Kafka. [#68873](https://github.com/ClickHouse/ClickHouse/pull/68873) ([Ilya Golshtein](https://github.com/ilejn)).
* Добавлена системная таблица [`system.zookeeper_connection_log`](/operations/system-tables/zookeeper_connection_log) для хранения истории подключений к ZooKeeper. [#79494](https://github.com/ClickHouse/ClickHouse/pull/79494) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Добавлена новая системная таблица [`system.codecs`](/operations/system-tables/codecs) для просмотра доступных кодеков. (задача [#81525](https://github.com/ClickHouse/ClickHouse/issues/81525)). [#81600](https://github.com/ClickHouse/ClickHouse/pull/81600) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
* Добавлена системная таблица `system.completions`. Закрывает задачу [#81889](https://github.com/ClickHouse/ClickHouse/issues/81889). [#83833](https://github.com/ClickHouse/ClickHouse/pull/83833) ([|2ustam](https://github.com/RuS2m)).

### Iceberg и DeltaLake \{#iceberg-and-deltalake\}

* Поддержка сложных типов в эволюции схемы Iceberg. [#73714](https://github.com/ClickHouse/ClickHouse/pull/73714) ([scanhex12](https://github.com/scanhex12)).
* Поддержка записи в Iceberg для запросов `insert`. [#82692](https://github.com/ClickHouse/ClickHouse/pull/82692) ([scanhex12](https://github.com/scanhex12)).
* Поддержка позиционных удалений для движка таблиц Iceberg. [#83094](https://github.com/ClickHouse/ClickHouse/pull/83094) ([Daniil Ivanik](https://github.com/divanik)).
* Чтение файлов данных Iceberg по идентификаторам полей. Закрывает [#83065](https://github.com/ClickHouse/ClickHouse/issues/83065). [#83653](https://github.com/ClickHouse/ClickHouse/pull/83653) ([scanhex12](https://github.com/scanhex12)).
* Поддержка записи в Iceberg при создании. Закрывает [#83927](https://github.com/ClickHouse/ClickHouse/issues/83927). [#83983](https://github.com/ClickHouse/ClickHouse/pull/83983) ([scanhex12](https://github.com/scanhex12)).
* Поддержка записи для каталогов Glue. [#84136](https://github.com/ClickHouse/ClickHouse/pull/84136) ([scanhex12](https://github.com/scanhex12)).
* Поддержка записи для каталогов Iceberg REST. [#84684](https://github.com/ClickHouse/ClickHouse/pull/84684) ([scanhex12](https://github.com/scanhex12)).
* Объединение всех файлов позиционных удалений Iceberg в файлы данных. Это уменьшит количество и размер файлов Parquet в хранилище Iceberg. Синтаксис: `OPTIMIZE TABLE table_name`. [#85250](https://github.com/ClickHouse/ClickHouse/pull/85250) ([scanhex12](https://github.com/scanhex12)).
* Поддержка `DROP TABLE` для Iceberg (удаление из REST/Glue каталогов и удаление метаданных о таблице). [#85395](https://github.com/ClickHouse/ClickHouse/pull/85395) ([scanhex12](https://github.com/scanhex12)).
* Поддержка мутаций `ALTER DELETE` для Iceberg в формате merge-on-read. [#85549](https://github.com/ClickHouse/ClickHouse/pull/85549) ([scanhex12](https://github.com/scanhex12)).
* Поддержка записи в DeltaLake. Закрывает [#79603](https://github.com/ClickHouse/ClickHouse/issues/79603). [#85564](https://github.com/ClickHouse/ClickHouse/pull/85564) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Запись дополнительной статистики Iceberg (размеры столбцов, нижние и верхние границы) в метаданные (записях манифеста) для min-max-фильтрации. [#85746](https://github.com/ClickHouse/ClickHouse/pull/85746) ([scanhex12](https://github.com/scanhex12)).
* Поддержка добавления, удаления и изменения столбцов в Iceberg для простых типов. [#85769](https://github.com/ClickHouse/ClickHouse/pull/85769) ([scanhex12](https://github.com/scanhex12)).

### MergeTree и хранилище \{#mergetree-and-storage\}

* Все таблицы теперь поддерживают виртуальный столбец `_table`, а не только таблицы типа Merge. [#63665](https://github.com/ClickHouse/ClickHouse/pull/63665) ([Xiaozhe Yu](https://github.com/wudidapaopao)).
* Добавлен SZ3 как кодек сжатия с потерями, но с ограничённой погрешностью, для столбцов типов `Float32` и `Float64`. [#67161](https://github.com/ClickHouse/ClickHouse/pull/67161) ([scanhex12](https://github.com/scanhex12)).
* Добавлена поддержка облегчённых обновлений для таблиц семейства `MergeTree`. Облегчённые обновления могут использоваться с новым синтаксисом: `UPDATE <table> SET col1 = val1, col2 = val2, ... WHERE <condition>`. Добавлена реализация облегчённых удалений через облегчённые обновления, которую можно включить, установив `lightweight_delete_mode = 'lightweight_update'`. [#82004](https://github.com/ClickHouse/ClickHouse/pull/82004) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена поддержка виртуального столбца `_part_granule_offset` в таблицах семейства `MergeTree`. Этот столбец указывает индекс (с нуля) гранулы/метки, к которой принадлежит каждая строка в пределах своей части данных. Это устраняет проблему [#79572](https://github.com/ClickHouse/ClickHouse/issues/79572). [#82341](https://github.com/ClickHouse/ClickHouse/pull/82341) ([Amos Bird](https://github.com/amosbird)).

### Поддержка протоколов и клиентов \{#protocol-and-client-support\}

* Реализована поддержка протокола [ArrowFlight RPC](https://arrow.apache.org/docs/format/Flight.html) путём добавления движка таблицы [`arrowflight`](/engines/table-engines/integrations/arrowflight). [#74184](https://github.com/ClickHouse/ClickHouse/pull/74184) ([zakr600](https://github.com/zakr600)).
* Добавлена поддержка команды протокола PostgreSQL `COPY`. [#74344](https://github.com/ClickHouse/ClickHouse/pull/74344) ([scanhex12](https://github.com/scanhex12)).
* Добавлена поддержка клиента C# для протокола MySQL. Это закрывает [#83992](https://github.com/ClickHouse/ClickHouse/issues/83992). [#84397](https://github.com/ClickHouse/ClickHouse/pull/84397) ([scanhex12](https://github.com/scanhex12)).
* Принудительно используется защищённое соединение для `mysql_port` и `postgresql_port`. [#82962](https://github.com/ClickHouse/ClickHouse/pull/82962) ([Shaohua Wang](https://github.com/tiandiwonder)).

### Возможности SQL и запросов \{#sql-and-query-features\}

* Добавлена поддержка `DESCRIBE SELECT` в дополнение к `DESCRIBE (SELECT ...)`. [#82947](https://github.com/ClickHouse/ClickHouse/pull/82947) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена поддержка конструкции `USE DATABASE {name}`. [#81307](https://github.com/ClickHouse/ClickHouse/pull/81307) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Реализовано чтение из проекций для параллельных реплик. Добавлена новая настройка [`parallel_replicas_support_projection`](/operations/settings/settings#parallel_replicas_support_projection) для управления тем, включена ли поддержка проекций. Для упрощения реализации поддержка проекций включена только тогда, когда активен `parallel_replicas_local_plan`. [#82807](https://github.com/ClickHouse/ClickHouse/pull/82807) ([zoomxi](https://github.com/zoomxi)).

### Форматы \{#formats\}

* Добавлена настройка [`format_schema_source`](/operations/settings/formats#format_schema_source), которая определяет источник `format_schema`. [#80874](https://github.com/ClickHouse/ClickHouse/pull/80874) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Добавлен новый формат вывода `Hash`. Он вычисляет одно хеш-значение для всех столбцов и строк результата. Это полезно для вычисления «отпечатка» результата, например, в сценариях, когда узким местом является передача данных. Пример: `SELECT arrayJoin(['abc', 'def']), 42 FORMAT Hash` возвращает `e5f9e676db098fdb9530d2059d8c23ef`. [#84607](https://github.com/ClickHouse/ClickHouse/pull/84607) ([Robert Schulze](https://github.com/rschu1ze)).

### Конфигурация сервера и управление нагрузкой \{#server-configuration-and-workload-management\}

* Настройка сервера [`cpu_slot_preemption`](/operations/server-configuration-parameters/settings#cpu_slot_preemption) включает вытесняющее планирование CPU для рабочих нагрузок и обеспечивает max-min-справедливое распределение процессорного времени между ними. Добавлены новые настройки нагрузки для ограничения использования CPU: `max_cpus`, `max_cpu_share` и `max_burst_cpu_seconds`. [#80879](https://github.com/ClickHouse/ClickHouse/pull/80879) ([Sergei Trifonov](https://github.com/serxa)).
* Теперь поддерживается настройка нагрузки [`max_waiting_queries`](/operations/server-configuration-parameters/settings#max_waiting_queries). Её можно использовать для ограничения размера очереди запросов. При достижении лимита все последующие запросы будут завершаться с ошибкой `SERVER_OVERLOADED`. [#81250](https://github.com/ClickHouse/ClickHouse/pull/81250) ([Oleg Doronin](https://github.com/dorooleg)).
* Разрыв TCP-соединения после заданного количества запросов или по достижении заданного порога времени. Решает проблему [#68000](https://github.com/ClickHouse/ClickHouse/issues/68000). [#81472](https://github.com/ClickHouse/ClickHouse/pull/81472) ([Kenny Sun](https://github.com/hwabis)).

### Облачное хранилище \{#cloud-storage\}

* Добавлена поддержка `extra_credentials` в `AzureBlobStorage` для аутентификации по `client_id` и `tenant_id`. [#84235](https://github.com/ClickHouse/ClickHouse/pull/84235) ([Pablo Marcos](https://github.com/pamarcos)).

### Keeper \{#keeper\}

* Добавлена возможность настраивать произвольные наблюдения (watches) в запросах Keeper Multi. [#84964](https://github.com/ClickHouse/ClickHouse/pull/84964) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Добавлена поддержка частично агрегированных метрик. [#85328](https://github.com/ClickHouse/ClickHouse/pull/85328) ([Mikhail Artemenko](https://github.com/Michicosun)).

## Экспериментальные возможности \{#experimental-features\}

### Движки таблиц и табличные функции \{#table-engines-and-table-functions\}

* Добавлены движок таблицы Ytsaurus и табличная функция. [#77606](https://github.com/ClickHouse/ClickHouse/pull/77606) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).

### Улучшения текстового индекса \{#text-index-improvements\}

* Добавлены функции `searchAny` и `searchAll`, которые являются универсальными инструментами для поиска по текстовым индексам. [#80641](https://github.com/ClickHouse/ClickHouse/pull/80641) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Текстовый индекс теперь поддерживает токенизатор `string`. [#81752](https://github.com/ClickHouse/ClickHouse/pull/81752) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Значение параметра гранулярности индекса по умолчанию для индексов `text` изменено на 64. Это улучшает ожидаемую производительность среднего тестового запроса во внутренних бенчмарках. [#82162](https://github.com/ClickHouse/ClickHouse/pull/82162) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
* 256-битный bitmap хранит исходящие метки состояния в упорядоченном виде, но исходящие состояния записываются на диск в том порядке, в котором они появляются в хеш-таблице. Поэтому при чтении с диска метка может указывать на неверное следующее состояние. [#82783](https://github.com/ClickHouse/ClickHouse/pull/82783) ([Elmi Ahmadov](https://github.com/ahmadov)).
* В настоящее время дерево FST сохраняется на диск несжатым. Это может приводить к снижению производительности или повышенному потреблению пропускной способности ввода-вывода как при записи, так и при чтении с диска. [#83093](https://github.com/ClickHouse/ClickHouse/pull/83093) ([Elmi Ahmadov](https://github.com/ahmadov)).

### Обновления статуса зрелости функциональности \{#feature-maturity-updates\}

* Каталог переведён на стадию beta. [#85848](https://github.com/ClickHouse/ClickHouse/pull/85848) ([Melvyn Peignon](https://github.com/melvynator)).
* Легковесные обновления переведены из экспериментальной стадии в beta. [#85952](https://github.com/ClickHouse/ClickHouse/pull/85952) ([Anton Popov](https://github.com/CurtizJ)).

## Улучшение производительности \{#performance-improvements\}

### Выполнение запросов и агрегация \{#query-execution-and-aggregation\}

* Тривиальная оптимизация для комбинатора агрегатной функции `-If`. [#78454](https://github.com/ClickHouse/ClickHouse/pull/78454) ([李扬](https://github.com/taiyang-li)).
* Добавлена новая логика (управляется настройкой [`enable_producing_buckets_out_of_order_in_aggregation`](/operations/settings/settings#enable_producing_buckets_out_of_order_in_aggregation), по умолчанию включена), которая позволяет отправлять некоторые бакеты в неупорядоченном виде при агрегации с экономным использованием памяти. Когда слияние некоторых бакетов агрегации занимает значительно больше времени, чем других, это повышает производительность, позволяя инициирующему узлу параллельно сливать бакеты с более высокими идентификаторами. Обратная сторона — потенциально большее использование памяти (не должно быть значительным). [#80179](https://github.com/ClickHouse/ClickHouse/pull/80179) ([Nikita Taranov](https://github.com/nickitat)).
* Конвейер после шага `TOTALS` сделан многопоточным. [#80331](https://github.com/ClickHouse/ClickHouse/pull/80331) ([UnamedRus](https://github.com/UnamedRus)).
* Когда запрос агрегации содержит только единственную функцию `COUNT()` по столбцу `NOT NULL`, логика агрегации полностью встраивается во время поиска в хеш-таблице. Это позволяет избежать выделения и ведения какого-либо состояния агрегации, что значительно снижает потребление памяти и накладные расходы по CPU. Частично решает [#81982](https://github.com/ClickHouse/ClickHouse/issues/81982). [#82104](https://github.com/ClickHouse/ClickHouse/pull/82104) ([Amos Bird](https://github.com/amosbird)).
* Сериализованный ключ вычисляется поколоночно при группировке по нескольким строковым или числовым столбцам. [#83884](https://github.com/ClickHouse/ClickHouse/pull/83884) ([李扬](https://github.com/taiyang-li)).
* Реализован `addManyDefaults` для комбинаторов `-If`. [#83870](https://github.com/ClickHouse/ClickHouse/pull/83870) ([Raúl Marín](https://github.com/Algunenano)).

### Оптимизации JOIN \{#join-optimizations\}

* Добавлена новая настройка [`min_joined_block_size_rows`](/operations/settings/settings#min_joined_block_size_rows) (аналогична `min_joined_block_size_bytes`; по умолчанию 65409) для управления минимальным размером блока (в строках) для входных и выходных блоков JOIN (если алгоритм JOIN это поддерживает). Мелкие блоки будут объединяться. [#81886](https://github.com/ClickHouse/ClickHouse/pull/81886) ([Nikita Taranov](https://github.com/nickitat)).
* Производительность `HashJoin` оптимизирована за счёт удаления дополнительного цикла по хэш-таблицам в типичном случае одного столбца ключа, а также исключены проверки `null_map` и `join_mask`, когда они всегда `true`/`false`. [#82308](https://github.com/ClickHouse/ClickHouse/pull/82308) ([Nikita Taranov](https://github.com/nickitat)).
* Оптимизации для `null_map` и `JoinMask` из [#82308](https://github.com/ClickHouse/ClickHouse/issues/82308) были применены к случаю JOIN с несколькими дизъюнктами в условии. Также была оптимизирована структура данных `KnownRowsHolder`. [#83041](https://github.com/ClickHouse/ClickHouse/pull/83041) ([Nikita Taranov](https://github.com/nickitat)).
* Для флагов JOIN используется обычный `std::vector<std::atomic_bool>`, чтобы избежать вычисления хэша при каждом доступе к флагам. [#83043](https://github.com/ClickHouse/ClickHouse/pull/83043) ([Nikita Taranov](https://github.com/nickitat)).
* Обработка `max_joined_block_rows` вынесена за основной цикл хэш-JOIN. Незначительно улучшена производительность для ALL JOIN. [#83216](https://github.com/ClickHouse/ClickHouse/pull/83216) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Предварительное выделение памяти для результирующих столбцов больше не выполняется заранее, когда `HashJoin` использует режим `lazy` для вывода. Это неоптимально, особенно когда число совпадений невелико. Кроме того, после выполнения JOIN мы знаем точное количество совпадений и можем выполнить предварительное выделение более точно. [#83304](https://github.com/ClickHouse/ClickHouse/pull/83304) ([Nikita Taranov](https://github.com/nickitat)).
* Все операции `LEFT/INNER` JOIN будут автоматически преобразованы в `RightAny`, если правая сторона функционально определяется столбцами ключа JOIN (все строки имеют уникальные значения ключа JOIN). [#84010](https://github.com/ClickHouse/ClickHouse/pull/84010) ([Nikita Taranov](https://github.com/nickitat)).
* Улучшена производительность применения patch parts в режиме `Join`. [#85040](https://github.com/ClickHouse/ClickHouse/pull/85040) ([Anton Popov](https://github.com/CurtizJ)).

### Улучшения распределённых запросов \{#distributed-query-improvements\}

* Добавлен параметр, позволяющий вынести обработку (де)компрессии и (де)сериализации блоков в потоки конвейера вместо одного потока, связанного с сетевым соединением. Управляется настройкой `enable_parallel_blocks_marshalling`. Это должно ускорить распределённые запросы, которые передают значительные объёмы данных между инициатором и удалёнными узлами. [#78694](https://github.com/ClickHouse/ClickHouse/pull/78694) ([Nikita Taranov](https://github.com/nickitat)).
* Параллельный распределённый `INSERT SELECT` по умолчанию включён в режиме, когда `INSERT SELECT` выполняется на каждом шарде независимо, см. настройку `parallel_distributed_insert_select`. [#80425](https://github.com/ClickHouse/ClickHouse/pull/80425) ([Igor Nikonov](https://github.com/devcrafter)).
* Включено сжатие логов и профилирующих событий в нативном протоколе. В кластерах со 100+ репликами несжатые профилирующие события занимают 1–10 МБ/с, а индикатор прогресса медленно обновляется при медленных интернет-соединениях. Это закрывает [#82533](https://github.com/ClickHouse/ClickHouse/issues/82533). [#82535](https://github.com/ClickHouse/ClickHouse/pull/82535) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Параллельный распределённый `INSERT SELECT` по умолчанию включён в режиме, когда INSERT SELECT выполняется на каждом шарде независимо, см. настройку `parallel_distributed_insert_select`. [#83040](https://github.com/ClickHouse/ClickHouse/pull/83040) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлен расчёт минимального размера задачи для параллельных реплик. [#84752](https://github.com/ClickHouse/ClickHouse/pull/84752) ([Nikita Taranov](https://github.com/nickitat)).

### Улучшения индексов \{#index-improvements\}

* Запросы векторного поиска с использованием индекса векторного сходства теперь выполняются с меньшей задержкой за счет сокращения количества обращений к хранилищу и снижения загрузки CPU. [#79103](https://github.com/ClickHouse/ClickHouse/pull/79103) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Параметр `merge_tree_min_{rows,bytes}_for_seek` теперь учитывается в `filterPartsByQueryConditionCache`, чтобы привести его поведение в соответствие с другими методами фильтрации по индексам. [#80312](https://github.com/ClickHouse/ClickHouse/pull/80312) ([李扬](https://github.com/taiyang-li)).
* Сначала обрабатываются minmax-индексы с более высокой гранулярностью. Закрывает [#75381](https://github.com/ClickHouse/ClickHouse/issues/75381). [#83798](https://github.com/ClickHouse/ClickHouse/pull/83798) ([Maruth Goyal](https://github.com/maruthgoyal)).
* Индекс bloom-фильтра теперь используется для условий вида `has([c1, c2, ...], column)`, где `column` не имеет тип данных `Array`. Это повышает производительность таких запросов, делая их столь же эффективными, как оператор `IN`. [#83945](https://github.com/ClickHouse/ClickHouse/pull/83945) ([Doron David](https://github.com/dorki)).
* Индексы обрабатываются в порядке возрастания размера файла. Итоговый порядок индексов отдает приоритет minmax- и векторным индексам (из-за простоты и селективности соответственно), а затем — небольшим индексам. Среди minmax- и векторных индексов также отдается предпочтение более компактным индексам. [#84094](https://github.com/ClickHouse/ClickHouse/pull/84094) ([Maruth Goyal](https://github.com/maruthgoyal)).
* Ранее данные текстового индекса разделялись на несколько сегментов (по умолчанию размер каждого сегмента составлял 256 MiB). Это могло снизить потребление памяти при построении текстового индекса, но при этом увеличивало занимаемое на диске пространство и время ответа на запрос. [#84590](https://github.com/ClickHouse/ClickHouse/pull/84590) ([Elmi Ahmadov](https://github.com/ahmadov)).

### Оптимизации подзапросов \{#subquery-optimizations\}

* Оптимизирован сгенерированный план для коррелированных подзапросов за счёт удаления избыточных операций `JOIN` с использованием классов эквивалентности. Если существуют эквивалентные выражения для всех коррелированных столбцов, `CROSS JOIN` не создаётся, когда включена настройка `query_plan_correlated_subqueries_use_substitution`. [#82435](https://github.com/ClickHouse/ClickHouse/pull/82435) ([Dmitry Novik](https://github.com/novikd)).
* В коррелированном подзапросе читаются только необходимые столбцы, когда он используется в качестве аргумента функции `EXISTS`. [#82443](https://github.com/ClickHouse/ClickHouse/pull/82443) ([Dmitry Novik](https://github.com/novikd)).

### Улучшения Azure Blob Storage \{#azure-blob-storage-improvements\}

* Движок таблиц [`azureBlobStorage`](/engines/table-engines/integrations/azureBlobStorage) теперь кэширует и повторно использует токены аутентификации управляемого удостоверения, когда это возможно, чтобы избежать ограничения по частоте запросов. [#79860](https://github.com/ClickHouse/ClickHouse/pull/79860) ([Nick Blakely](https://github.com/niblak)).
* Заменён HTTP‑клиент curl на HTTP‑клиент poco для Azure Blob Storage. Добавлено несколько настроек для этих клиентов, которые повторяют настройки из S3. Введены агрессивные тайм-ауты установления соединения как для Azure, так и для S3. Улучшены возможности анализа событий и метрик профиля Azure. Новый клиент включён по умолчанию и обеспечивает значительно меньшие задержки для «холодных» запросов при работе с Azure Blob Storage. Старый клиент `Curl` можно вернуть, установив `azure_sdk_use_native_client=false`. [#83294](https://github.com/ClickHouse/ClickHouse/pull/83294) ([alesapin](https://github.com/alesapin)).

### Улучшения движка хранения \{#storage-engine-improvements\}

* Исправлена фильтрация по ключу для хранилищ Redis и KeeperMap. [#81833](https://github.com/ClickHouse/ClickHouse/pull/81833) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* `ATTACH PARTITION` больше не приводит к сбросу всех кэшей. [#82377](https://github.com/ClickHouse/ClickHouse/pull/82377) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исключено удержание блокировки во время создания данных снимка хранилища, чтобы уменьшить конкуренцию за блокировки при высокой параллельной нагрузке. [#83510](https://github.com/ClickHouse/ClickHouse/pull/83510) ([Duc Canh Le](https://github.com/canhld94)).
* Удаление временных частей может занимать продолжительное время (особенно с S3), и сейчас это делается при удержании глобальной блокировки в `MergeTreeBackgroundExecutor`. Когда требуется перезапустить все таблицы из‑за потери соединения и мы ждём завершения фоновых задач, таблицы могут застрять в режиме read-only на час. Но, по-видимому, эта блокировка не нужна для вызова `cancel`. [#84311](https://github.com/ClickHouse/ClickHouse/pull/84311) ([Alexander Tokmakov](https://github.com/tavplubix)).

### Улучшения форматов \{#format-improvements\}

* Новая реализация ридера формата Parquet. В целом работает быстрее и поддерживает фильтрацию на уровне страниц (page-level filter pushdown) и `PREWHERE`. Пока экспериментальная. Используйте настройку `input_format_parquet_use_native_reader_v3` для включения. [#82789](https://github.com/ClickHouse/ClickHouse/pull/82789) ([Michael Kolupaev](https://github.com/al13n321)).
* Повышена производительность входного формата ProtobufSingle за счет повторного использования сериализатора при отсутствии ошибок разбора. [#83613](https://github.com/ClickHouse/ClickHouse/pull/83613) ([Eduard Karacharov](https://github.com/korowa)).

### Оптимизации типов данных и сериализации \{#data-type-and-serialization-optimizations\}

* Существенно повышена производительность чтения подстолбцов `JSON` из общих данных в MergeTree за счёт реализации новых форматов сериализации для общих данных `JSON` в MergeTree. [#83777](https://github.com/ClickHouse/ClickHouse/pull/83777) ([Pavel Kruglov](https://github.com/Avogar)).
* Оптимизирована десериализация строк за счёт упрощения кода. Закрывает [#38564](https://github.com/ClickHouse/ClickHouse/issues/38564). [#84561](https://github.com/ClickHouse/ClickHouse/pull/84561) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Улучшения конвейера и выполнения \{#pipeline-and-execution-improvements\}

* Минимизировать копирование памяти в заголовках портов конвейера при его построении. Исходный [PR](https://github.com/ClickHouse/ClickHouse/pull/70105) от [heymind](https://github.com/heymind). [#83381](https://github.com/ClickHouse/ClickHouse/pull/83381) ([Raúl Marín](https://github.com/Algunenano)).
* Повысить производительность построения конвейера. [#83631](https://github.com/ClickHouse/ClickHouse/pull/83631) ([Raúl Marín](https://github.com/Algunenano)).
* Оптимизировать MergeTreeReadersChain::getSampleBlock. [#83875](https://github.com/ClickHouse/ClickHouse/pull/83875) ([Raúl Марин](https://github.com/Algunenano)).
* Оптимизировать материализацию констант в случаях, когда она выполняется только для возврата единственной строки. [#85071](https://github.com/ClickHouse/ClickHouse/pull/85071) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Оптимизация памяти и ресурсов \{#memory-and-resource-optimizations\}

* Настроить некоторые параметры jemalloc для улучшения производительности. [#81807](https://github.com/ClickHouse/ClickHouse/pull/81807) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавить выравнивание в счётчике ProfileEvents, чтобы уменьшить ложное разделение кэша (false sharing). [#82697](https://github.com/ClickHouse/ClickHouse/pull/82697) ([Jiebin Sun](https://github.com/jiebinn)).
* Сократить количество ненужных вызовов memcpy в CompressedReadBufferBase::readCompressedData. [#83986](https://github.com/ClickHouse/ClickHouse/pull/83986) ([Raúl Marín](https://github.com/Algunenano)).

### Планирование и анализ запросов \{#query-planning-and-analysis\}

* Ускорена работа QueryTreeHash. [#82617](https://github.com/ClickHouse/ClickHouse/pull/82617) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).

### Улучшения логирования \{#logging-improvements\}

* Добавлено асинхронное логирование. [#82516](https://github.com/ClickHouse/ClickHouse/pull/82516) ([Raúl Marín](https://github.com/Algunenano)).

### Оптимизации функций \{#function-optimizations\}

* Оптимизирована функция `largestTriangleThreeBuckets` путем удаления временных данных. [#84479](https://github.com/ClickHouse/ClickHouse/pull/84479) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Оптимизирована и упрощена реализация многих функций обработки строк. Исправлена некорректная документация для нескольких функций. Примечание: вывод функции `byteSize` для столбцов типа String и составных типов, содержащих столбцы типа String, изменился с 9 байт на пустую строку до 8 байт на пустую строку, что является ожидаемым поведением. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Улучшения Keeper \{#keeper-improvements\}

* Улучшена работа Keeper при начальной загрузке данных в RocksDB. [#83390](https://github.com/ClickHouse/ClickHouse/pull/83390) ([Antonio Andelic](https://github.com/antonio2368)).

### Улучшения в data lake \{#data-lake-improvements\}

* Улучшена параллельная обработка файлов с использованием бекенда delta-kernel-rs. [#85642](https://github.com/ClickHouse/ClickHouse/pull/85642) ([Azat Khuzhin](https://github.com/azat)).

## Улучшения \{#improvements\}

### Контроль доступа и безопасность \{#access-control-and-security\}

* Добавлены два новых типа доступа: `READ` и `WRITE` для источников, при этом все предыдущие типы доступа, связанные с источниками, помечены как устаревшие. Ранее: `GRANT S3 ON *.* TO user`, теперь: `GRANT READ, WRITE ON S3 TO user`. Это также позволяет разделять права `READ` и `WRITE` для источников, например: `GRANT READ ON * TO user`, `GRANT WRITE ON S3 TO user`. Функциональность управляется настройкой `access_control_improvements.enable_read_write_grants` и по умолчанию отключена. [#73659](https://github.com/ClickHouse/ClickHouse/pull/73659) ([pufit](https://github.com/pufit)).
* Разрешено использовать параметры в запросах `CREATE USER` для имён пользователей. [#81387](https://github.com/ClickHouse/ClickHouse/pull/81387) ([Diskein](https://github.com/Diskein)).
* Конфиденциальные данные исключены из дампов ядра. Добавлены два аллокатора: совместимый с библиотекой AWS `AwsNodumpMemoryManager` и совместимый со STL `JemallocNodumpSTLAllocator`. Оба являются обёртками над аллокатором Jemalloc. Они используют хуки extent и madvise Jemalloc, чтобы пометить страницы памяти как "don't dump". Используются для учётных данных S3, учётных данных пользователей и некоторых данных запросов. [#82441](https://github.com/ClickHouse/ClickHouse/pull/82441) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Представления, созданные эфемерными пользователями, теперь будут сохранять копию реального пользователя и больше не будут становиться недействительными после удаления эфемерного пользователя. [#84763](https://github.com/ClickHouse/ClickHouse/pull/84763) ([pufit](https://github.com/pufit)).
* Сопоставление `forward_headers` для внешней аутентификации теперь выполняется без учёта регистра. [#84737](https://github.com/ClickHouse/ClickHouse/pull/84737) ([ingodwerust](https://github.com/ingodwerust)).
* Добавлен столбец `parameter` в `system.grants` для определения типа источника для `GRANT READ/WRITE` и движка таблицы для `GRANT TABLE ENGINE`. [#85643](https://github.com/ClickHouse/ClickHouse/pull/85643) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).

### Резервное копирование и восстановление \{#backup-and-restore\}

* Разрешено выполнять резервное копирование баз данных PostgreSQL, MySQL и DataLake. При создании резервной копии такой базы данных сохраняется только её схема (определение), но не содержащиеся в ней данные. [#79982](https://github.com/ClickHouse/ClickHouse/pull/79982) ([Nikolay Degterinsky](https://github.com/evillique)).
* Установлен уровень TRACE для всех сообщений журнала при записи файлов резервных копий. [#82907](https://github.com/ClickHouse/ClickHouse/pull/82907) ([Hans Krutzer](https://github.com/hkrutzer)).
* Добавлены настройки [`backup_restore_s3_retry_initial_backoff_ms`](/operations/settings/settings#backup_restore_s3_retry_initial_backoff_ms), [`backup_restore_s3_retry_max_backoff_ms`](/operations/settings/settings#backup_restore_s3_retry_max_backoff_ms), [`backup_restore_s3_retry_jitter_factor`](/operations/settings/settings#backup_restore_s3_retry_jitter_factor) для настройки стратегии backoff при повторных попытках работы с S3, используемой во время операций резервного копирования и восстановления. [#84421](https://github.com/ClickHouse/ClickHouse/pull/84421) ([Julia Kartseva](https://github.com/jkartseva)).
* Добавлена новая настройка [`backup_slow_all_threads_after_retryable_s3_error`](/operations/settings/settings#backup_slow_all_threads_after_retryable_s3_error) для снижения нагрузки на S3 во время «штормов» повторных попыток, вызванных ошибками, такими как `SlowDown`, за счёт замедления работы всех потоков после обнаружения одной ошибки, допускающей повторную попытку. [#84854](https://github.com/ClickHouse/ClickHouse/pull/84854) ([Julia Kartseva](https://github.com/jkartseva)).

### Целостность данных и валидация \{#data-integrity-and-validation\}

* Проверять, что у парта есть корректный файл checksum.txt непосредственно перед его коммитом. [#76625](https://github.com/ClickHouse/ClickHouse/pull/76625) ([Sema Checherinda](https://github.com/CheSema)).
* Запретить запуск мутации `RENAME COLUMN`, если она переименовывает столбец, который в данный момент затронут незавершённой мутацией данных. [#81823](https://github.com/ClickHouse/ClickHouse/pull/81823) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Теперь снимок мутаций будет строиться из снимка видимых партов. Счётчики мутаций, используемые в снимке, также будут пересчитываться на основе включённых мутаций. [#82945](https://github.com/ClickHouse/ClickHouse/pull/82945) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Добавлена возможность разбирать префикс и суффикс парта, а также проверять покрытие для неконстантных столбцов. [#83377](https://github.com/ClickHouse/ClickHouse/pull/83377) ([Mikhail Artemenko](https://github.com/Michicosun)).

### Движок таблиц Iceberg \{#iceberg-table-engine\}

* Поддержка позиционных удалений для движка таблиц Iceberg. [#80237](https://github.com/ClickHouse/ClickHouse/pull/80237) ([YanghongZhong](https://github.com/yahoNanJing)).
* Теперь ClickHouse поддерживает сжатые файлы `metadata.json` для Iceberg. Исправляет [#70874](https://github.com/ClickHouse/ClickHouse/issues/70874). [#81451](https://github.com/ClickHouse/ClickHouse/pull/81451) ([alesapin](https://github.com/alesapin)).
* Исправлено чтение Iceberg по идентификаторам полей для сложных типов. [#84821](https://github.com/ClickHouse/ClickHouse/pull/84821) ([scanhex12](https://github.com/scanhex12)).
* Поддержка записи в Iceberg в формате, совместимом с pyiceberg. [#84466](https://github.com/ClickHouse/ClickHouse/pull/84466) ([scanhex12](https://github.com/scanhex12)).
* Добавлена версия snapshot для движков таблиц озера данных. [#84659](https://github.com/ClickHouse/ClickHouse/pull/84659) ([Pete Hampton](https://github.com/pjhampton)).
* Поддержка записи файла `version-hint` в Iceberg. Закрывает [#85097](https://github.com/ClickHouse/ClickHouse/issues/85097). [#85130](https://github.com/ClickHouse/ClickHouse/pull/85130) ([scanhex12](https://github.com/scanhex12)).
* Поддержка сжатого файла `.metadata.json` через настройку [`iceberg_metadata_compression_method`](/operations/settings/settings#iceberg_metadata_compression_method). Поддерживаются все методы сжатия ClickHouse. Закрывает [#84895](https://github.com/ClickHouse/ClickHouse/issues/84895). [#85196](https://github.com/ClickHouse/ClickHouse/pull/85196) ([scanhex12](https://github.com/scanhex12)).
* Оптимизировано использование памяти для файлов позиционных удалений (positional delete) в Iceberg. Вместо загрузки всех данных delete-файла в память в RAM удерживается только текущая группа строк (row group) из Parquet delete-файлов. Это значительно снижает потребление памяти при работе с крупными файлами позиционных удалений. [#85329](https://github.com/ClickHouse/ClickHouse/pull/85329) ([scanhex12](https://github.com/scanhex12)).
* Добавлена поддержка асинхронной итерации по объектам из таблицы Iceberg без явного хранения объектов для каждого файла данных. [#85369](https://github.com/ClickHouse/ClickHouse/pull/85369) ([Daniil Ivanik](https://github.com/divanik)).
* Поддержка удалений по равенству значений (equality deletes) в Iceberg. [#85843](https://github.com/ClickHouse/ClickHouse/pull/85843) ([Han Fei](https://github.com/hanfei1991)).

### Движок таблиц DeltaLake \{#deltalake-table-engine\}

* Улучшен движок таблиц `DeltaLake`: в delta-kernel-rs есть API `ExpressionVisitor`, который реализован в этом PR и применяется к преобразованию выражений по колонкам партиционирования (он заменит старый устаревший механизм в delta-kernel-rs, который ранее использовался в нашем коде). В будущем этот `ExpressionVisitor` также позволит реализовать отсечение на основе статистики и некоторые проприетарные возможности Delta Lake. Дополнительно цель этого изменения — поддержать отсечение партиций в движке таблиц `DeltaLakeCluster` (результат разобранного выражения — ActionsDAG — будет сериализован и отправлен инициатором вместе с путём к данным, поскольку такого рода информация, необходимая для отсечения, доступна только как метаинформация при листинге файлов данных, который выполняется только инициатором, но при этом должна применяться к данным на каждом сервере-чтеце). [#81136](https://github.com/ClickHouse/ClickHouse/pull/81136) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено отсечение партиций в кластерных функциях для data lake. [#82131](https://github.com/ClickHouse/ClickHouse/pull/82131) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено чтение партиционированных данных в табличной функции DeltaLakeCluster. В этом PR увеличена версия протокола кластерных функций, что позволяет отправлять дополнительную информацию от инициатора на реплики. Эта дополнительная информация содержит выражение преобразования delta-kernel, которое необходимо для разбора колонок партиционирования (и для другого функционала в будущем, например, сгенерированных колонок и т. д.). [#82132](https://github.com/ClickHouse/ClickHouse/pull/82132) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Теперь база данных `Datalake` выбрасывает более понятное исключение. Исправляет [#81211](https://github.com/ClickHouse/ClickHouse/issues/81211). [#82304](https://github.com/ClickHouse/ClickHouse/pull/82304) ([alesapin](https://github.com/alesapin)).
* Реализована внутренняя фильтрация `delta-kernel-rs` (по статистике и с отсечением партиций) в хранилище `DeltaLake`. [#84006](https://github.com/ClickHouse/ClickHouse/pull/84006) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена настройка [`delta_lake_enable_expression_visitor_logging`](/operations/settings/settings#delta_lake_enable_expression_visitor_logging) для отключения логов ExpressionVisitor, так как они могут быть слишком многословными даже для тестового уровня логирования при отладке. [#84315](https://github.com/ClickHouse/ClickHouse/pull/84315) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена настройка [`delta_lake_snapshot_version`](/operations/settings/settings#delta_lake_snapshot_version), позволяющая читать конкретную версию снапшота в движке таблиц `DeltaLake`. [#85295](https://github.com/ClickHouse/ClickHouse/pull/85295) ([Kseniia Sumarokova](https://github.com/kssenii)).

### Интеграция с data lake \{#data-lake-integration\}

* Ускорено перечисление таблиц в каталогах за счёт асинхронных запросов. [#81084](https://github.com/ClickHouse/ClickHouse/pull/81084) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка `TimestampTZ` в каталоге Glue. Закрывает [#81654](https://github.com/ClickHouse/ClickHouse/issues/81654). [#83132](https://github.com/ClickHouse/ClickHouse/pull/83132) ([scanhex12](https://github.com/scanhex12)).
* Разделён `FormatParserGroup` на две независимые структуры: первая отвечает за общие вычислительные и I/O‑ресурсы, вторая — за общие ресурсы фильтра (filter `ActionDag`, `KeyCondition`). Это сделано для более гибкого совместного использования этих структур разными потоками. [#83997](https://github.com/ClickHouse/ClickHouse/pull/83997) ([Daniil Ivanik](https://github.com/divanik)).
* Добавлен отсутствующий параметр `partition_columns_in_data_file` в конфигурацию Azure. [#85373](https://github.com/ClickHouse/ClickHouse/pull/85373) ([Arthur Passos](https://github.com/arthurpassos)).
* Добавлен флаг `show_data_lake_catalogs_in_system_tables` для управления добавлением таблиц data lake в `system.tables`, что решает проблему [#85384](https://github.com/ClickHouse/ClickHouse/issues/85384). [#85411](https://github.com/ClickHouse/ClickHouse/pull/85411) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).

### S3 и объектное хранилище \{#s3-and-object-storage\}

* Реализованы методы `moveFile` и `replaceFile` в `s3_plain_rewritable`, чтобы использовать его в качестве диска базы данных. [#79424](https://github.com/ClickHouse/ClickHouse/pull/79424) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Запросы чтения и записи в S3 теперь ограничиваются по скорости на уровне HTTP-сокета (вместо целых запросов к S3), чтобы избежать проблем с ограничением `max_remote_read_network_bandwidth_for_server` и `max_remote_write_network_bandwidth_for_server`. [#81837](https://github.com/ClickHouse/ClickHouse/pull/81837) ([Sergei Trifonov](https://github.com/serxa)).
* Этот PR добавляет джиттер к механизму повторных попыток для S3 при включённой конфигурации `s3_slow_all_threads_after_network_error`. [#81849](https://github.com/ClickHouse/ClickHouse/pull/81849) ([zoomxi](https://github.com/zoomxi)).
* Реализована аутентификация AWS S3 с явно указанной ролью IAM. Реализован OAuth для GCS. Ранее эти возможности были доступны только в ClickHouse Cloud, а теперь открыты с открытым исходным кодом. Синхронизированы некоторые интерфейсы, такие как сериализация параметров подключения для объектных хранилищ. [#84011](https://github.com/ClickHouse/ClickHouse/pull/84011) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Разрешено использовать любую политику хранения (то есть объектное хранилище, такое как S3) для внешней агрегации и сортировки. [#84734](https://github.com/ClickHouse/ClickHouse/pull/84734) ([Azat Khuzhin](https://github.com/azat)).
* Все удалённые объекты собираются вместе, чтобы выполнить одну операцию удаления в объектном хранилище. [#85316](https://github.com/ClickHouse/ClickHouse/pull/85316) ([Mikhail Artemenko](https://github.com/Michicosun)).

### Движок таблиц S3Queue \{#s3queue-table-engine\}

* Макросы вроде `{uuid}` теперь можно использовать в настройке `keeper_path` для движка таблиц S3Queue. [#82463](https://github.com/ClickHouse/ClickHouse/pull/82463) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена новая серверная настройка `s3queue_disable_streaming`, которая отключает стриминг в таблицах с движком S3Queue. Эту настройку можно изменять без перезапуска сервера. [#82515](https://github.com/ClickHouse/ClickHouse/pull/82515) ([Kseniia Sumarokova](https://github.com/kssenii)).
* В `system.s3queue_log` добавлены столбцы `commit_time`, `commit_id`. [#83016](https://github.com/ClickHouse/ClickHouse/pull/83016) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлены логи для процесса остановки S3Queue. [#83163](https://github.com/ClickHouse/ClickHouse/pull/83163) ([Kseniia Sumarokova](https://github.com/kssenii)).
* При завершении работы сервера стриминг S3(Azure/etc)Queue теперь останавливается до остановки любых таблиц. [#83530](https://github.com/ClickHouse/ClickHouse/pull/83530) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Поддерживается изменение настроек вставки для материализованных представлений на уровне таблицы `S3Queue`. Добавлены новые настройки уровня `S3Queue`: `min_insert_block_size_rows_for_materialized_views` и `min_insert_block_size_bytes_for_materialized_views`. По умолчанию используются настройки уровня профиля, а настройки уровня `S3Queue` их переопределяют. [#83971](https://github.com/ClickHouse/ClickHouse/pull/83971) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен упорядоченный режим S3Queue: выполнение завершается раньше, если была инициирована остановка. [#84463](https://github.com/ClickHouse/ClickHouse/pull/84463) ([Kseniia Sumarokova](https://github.com/kssenii)).

### Интеграция с Kafka \{#kafka-integration\}

* Подсчитывайте потреблённые сообщения вручную, чтобы не зависеть от ранее зафиксированного смещения (offset) в StorageKafka2. [#81662](https://github.com/ClickHouse/ClickHouse/pull/81662) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Интегрируйте `StorageKafka2` в [`system.kafka_consumers`](/operations/system-tables/kafka_consumers). [#82652](https://github.com/ClickHouse/ClickHouse/pull/82652) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).

### Улучшения ClickHouse Keeper \{#clickhouse-keeper-improvements\}

* Улучшение Keeper: перенос файлов журнала изменений (changelog) между дисками в фоновом потоке. Ранее перенос журнала изменений на другой диск глобально блокировал Keeper до завершения операции. Это приводило к деградации производительности, если перенос занимал много времени (например, на диск S3). [#82485](https://github.com/ClickHouse/ClickHouse/pull/82485) ([Antonio Andelic](https://github.com/antonio2368)).
* Улучшение Keeper: добавлен новый параметр конфигурации `keeper_server.cleanup_old_and_ignore_new_acl`. Если он включён, все узлы будут очищены от своих ACL, а ACL для новых запросов будет игнорироваться. Если цель — полностью удалить ACL с узлов, важно оставить этот параметр включённым до тех пор, пока не будет создан новый snapshot. [#82496](https://github.com/ClickHouse/ClickHouse/pull/82496) ([Antonio Andelic](https://github.com/antonio2368)).
* Улучшение Keeper: поддержка отдельных прав доступа для ACL `world:anyone`. [#82755](https://github.com/ClickHouse/ClickHouse/pull/82755) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена поддержка указания дополнительных ACL Keeper для путей в конфигурации. Если нужно добавить дополнительный ACL для конкретного пути, его можно определить в конфигурации в `zookeeper.path_acls`. [#82898](https://github.com/ClickHouse/ClickHouse/pull/82898) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлен `ProfileEvent`, когда Keeper отклоняет запись из-за мягкого лимита памяти (soft memory limit). [#82963](https://github.com/ClickHouse/ClickHouse/pull/82963) ([Xander Garbett](https://github.com/Garbett1)).
* В Keeper по умолчанию включены функциональные флаги `create_if_not_exists`, `check_not_exists`, `remove_recursive`, которые открывают доступ к новым типам запросов. [#83488](https://github.com/ClickHouse/ClickHouse/pull/83488) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена поддержка применения дополнительных ACL к отдельным узлам Keeper с использованием параметра конфигурации `apply_to_children`. [#84137](https://github.com/ClickHouse/ClickHouse/pull/84137) ([Antonio Andelic](https://github.com/antonio2368)).
* В KeeperClient добавлена команда `get_acl`. [#84641](https://github.com/ClickHouse/ClickHouse/pull/84641) ([Antonio Andelic](https://github.com/antonio2368)).
* В Keeper добавлена 4LW-команда `lgrq` для переключения логирования полученных запросов. [#84719](https://github.com/ClickHouse/ClickHouse/pull/84719) ([Antonio Andelic](https://github.com/antonio2368)).
* Уменьшено соревнование потоков за блокировку хранилища в Keeper. [#84732](https://github.com/ClickHouse/ClickHouse/pull/84732) ([Antonio Andelic](https://github.com/antonio2368)).
* Инструмент `encrypt_decrypt` теперь поддерживает зашифрованные подключения к ZooKeeper. [#84764](https://github.com/ClickHouse/ClickHouse/pull/84764) ([Roman Vasin](https://github.com/rvasin)).
* Ограничен размер кэша записей журнала Keeper по количеству записей с помощью настроек `keeper_server.coordination_settings.latest_logs_cache_entry_count_threshold` и `keeper_server.coordination_settings.commit_logs_cache_entry_count_threshold`. [#84877](https://github.com/ClickHouse/ClickHouse/pull/84877) ([Antonio Andelic](https://github.com/antonio2368)).

### JSON and Dynamic types \{#json-and-dynamic-types\}

* Добавлен файл `columns_substreams.txt` в Wide-часть для отслеживания всех подпотоков, хранящихся в части. Это помогает отслеживать динамические потоки в типах JSON и Dynamic и тем самым избежать необходимости чтения выборки этих столбцов для получения списка динамических потоков (например, для вычисления размеров столбцов). Также теперь все динамические потоки отображаются в `system.parts_columns`. [#81091](https://github.com/ClickHouse/ClickHouse/pull/81091) ([Pavel Kruglov](https://github.com/Avogar)).
* Разрешён `ALTER UPDATE` в столбцах типов JSON и Dynamic. [#82419](https://github.com/ClickHouse/ClickHouse/pull/82419) ([Pavel Kruglov](https://github.com/Avogar)).
* Пользователи теперь могут использовать типы `Time` и `Time64` внутри типа JSON. [#83784](https://github.com/ClickHouse/ClickHouse/pull/83784) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена настройка `json_type_escape_dots_in_keys` для экранирования точек в ключах JSON при разборе JSON-типа. По умолчанию настройка отключена. [#84207](https://github.com/ClickHouse/ClickHouse/pull/84207) ([Pavel Kruglov](https://github.com/Avogar)).

### Форматы Parquet и ORC \{#parquet-and-orc-formats\}

* Добавлены настройки для задания размера блока сжатия в ORC и обновлено его значение по умолчанию с 64KB до 256KB для соответствия настройкам Spark и Hive. [#80602](https://github.com/ClickHouse/ClickHouse/pull/80602) ([李扬](https://github.com/taiyang-li)).
* Добавлена поддержка записи типов enum в формате Parquet в виде массива байт, как того требует [спецификация](https://github.com/apache/parquet-format/blob/master/LogicalTypes.md#enum). Дополнительная информация будет добавлена позже. [#81090](https://github.com/ClickHouse/ClickHouse/pull/81090) ([Arthur Passos](https://github.com/arthurpassos)).
* Добавлена поддержка записи GeoParquet в качестве формата вывода. [#81784](https://github.com/ClickHouse/ClickHouse/pull/81784) ([scanhex12](https://github.com/scanhex12)).

### Распределённые запросы и параллельные реплики \{#distributed-queries-and-parallel-replicas\}

* Добавлена новая настройка `enable_add_distinct_to_in_subqueries`. При её включении ClickHouse будет автоматически добавлять `DISTINCT` к подзапросам в операторах `IN` для распределённых запросов. Это может значительно уменьшить размер временных таблиц, передаваемых между шардами, и повысить эффективность использования сети. Примечание: это компромисс — хотя объём передаваемых данных по сети сокращается, на каждом узле требуется дополнительная работа по слиянию (удалению дубликатов). Включайте эту настройку, когда узким местом является сеть и стоимость слияния приемлема. [#81908](https://github.com/ClickHouse/ClickHouse/pull/81908) ([fhw12345](https://github.com/fhw12345)).
* Добавлена поддержка табличных функций `remote-()` с параллельными репликами, если кластер передан в аргументе `address_expression`. Также исправлена проблема [#73295](https://github.com/ClickHouse/ClickHouse/issues/73295). [#82904](https://github.com/ClickHouse/ClickHouse/pull/82904) ([Igor Nikonov](https://github.com/devcrafter)).
* Соединения с параллельными репликами теперь используют логический шаг JOIN. В случае любых проблем с JOIN-запросами, использующими параллельные реплики, попробуйте выполнить `SET query_plan_use_new_logical_join_step=0` и сообщите о проблеме. [#83801](https://github.com/ClickHouse/ClickHouse/pull/83801) ([Vladimir Cherkasov](https://github.com/vdimir)).

### Настройки и конфигурация \{#settings-and-configuration\}

* Настройка `allow_experimental_join_condition` помечена как устаревшая. [#80566](https://github.com/ClickHouse/ClickHouse/pull/80566) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Общие и пользовательские ограничители сетевой пропускной способности больше не сбрасываются, что гарантирует, что лимиты `max_network_bandwidth_for_all_users` и `max_network_bandwidth_for_all_users` никогда не превышаются. [#81729](https://github.com/ClickHouse/ClickHouse/pull/81729) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена настройка `optimize_rewrite_regexp_functions` (включена по умолчанию), которая позволяет оптимизатору переписывать некоторые вызовы `replaceRegexpAll`, `replaceRegexpOne` и `extract` в более простые и эффективные формы при обнаружении определённых шаблонов регулярных выражений (issue [#81981](https://github.com/ClickHouse/ClickHouse/issues/81981)). [#81992](https://github.com/ClickHouse/ClickHouse/pull/81992) ([Amos Bird](https://github.com/amosbird)).
* Очередь TCP‑серверов (64 по умолчанию) настроена в зависимости от параметра listen_backlog (4096 по умолчанию). [#82045](https://github.com/ClickHouse/ClickHouse/pull/82045) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена возможность перезагружать `max_local_read_bandwidth_for_server` и `max_local_write_bandwidth_for_server` «на лету» без перезапуска сервера. [#82083](https://github.com/ClickHouse/ClickHouse/pull/82083) ([Kai Zhu](https://github.com/nauu)).
* Добавлена настройка `enable_vector_similarity_index`, которую необходимо включить для использования индекса векторного сходства. Существующая настройка `allow_experimental_vector_similarity_index` теперь устарела. Она по‑прежнему поддерживается на случай, если кому‑то она нужна. [#83459](https://github.com/ClickHouse/ClickHouse/pull/83459) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлен параметр [`max_joined_block_size_bytes`](/operations/settings/settings#max_joined_block_size_bytes) в дополнение к `max_joined_block_size_rows` для ограничения потребления памяти JOIN‑ами с «тяжёлыми» столбцами. [#83869](https://github.com/ClickHouse/ClickHouse/pull/83869) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена совместимость для cluster_function_process_archive_on_multiple_nodes. [#83968](https://github.com/ClickHouse/ClickHouse/pull/83968) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Поддержка коррелированных подзапросов включена по умолчанию. [#85107](https://github.com/ClickHouse/ClickHouse/pull/85107) ([Dmitry Novik](https://github.com/novikd)).
* Добавлены настройки `database_replicated`, задающие значения по умолчанию для DatabaseReplicatedSettings. Если соответствующая настройка отсутствует в запросе создания реплицируемой базы данных, используется значение из этой группы настроек. [#85127](https://github.com/ClickHouse/ClickHouse/pull/85127) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Разрешены аргументы вида «ключ–значение» в движке/функции таблицы `s3` или `s3Cluster`, например: `s3('url', CSV, structure = 'a Int32', compression_method = 'gzip')`. [#85134](https://github.com/ClickHouse/ClickHouse/pull/85134) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Некоррелированные `EXISTS` выполняются как скалярный подзапрос. Это позволяет использовать кэш скалярного подзапроса и выполнять константное свёртывание результата, что полезно для индексов. Для совместимости добавлена новая настройка `execute_exists_as_scalar_subquery=1`. [#85481](https://github.com/ClickHouse/ClickHouse/pull/85481) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлена поддержка большего числа случаев разрешения составных идентификаторов. В частности, это улучшает совместимость `ARRAY JOIN` со старым анализатором. Добавлена новая настройка `analyzer_compatibility_allow_compound_identifiers_in_unflatten_nested` для сохранения старого поведения. [#85492](https://github.com/ClickHouse/ClickHouse/pull/85492) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).

### Системные таблицы и наблюдаемость \{#system-tables-and-observability\}

* Добавлены метрики нагрузки в асинхронные метрики ClickHouse. [#80779](https://github.com/ClickHouse/ClickHouse/pull/80779) ([Xander Garbett](https://github.com/Garbett1)).
* Добавлены метрики `MarkCacheEvictedBytes`, `MarkCacheEvictedMarks`, `MarkCacheEvictedFiles` для отслеживания вытеснений из кэша меток (issue [#60989](https://github.com/ClickHouse/ClickHouse/issues/60989)). [#80799](https://github.com/ClickHouse/ClickHouse/pull/80799) ([Shivji Kumar Jha](https://github.com/shiv4289)).
* Таблица `system.formats` теперь содержит расширенную информацию о форматах, такую как тип содержимого HTTP, возможности автоматического вывода схемы и т. д. [#81505](https://github.com/ClickHouse/ClickHouse/pull/81505) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка очистки всех предупреждений из таблицы `system.warnings` с помощью `TRUNCATE TABLE system.warnings`. [#82087](https://github.com/ClickHouse/ClickHouse/pull/82087) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Добавлен список лицензий crate'ов на Rust в `system.licenses`. [#82440](https://github.com/ClickHouse/ClickHouse/pull/82440) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлена оценка сложных выражений в CNF/DNF, например `(a < 1 and a > 0) or b = 3`, по статистике. [#82663](https://github.com/ClickHouse/ClickHouse/pull/82663) ([Han Fei](https://github.com/hanfei1991)).
* В некоторых случаях нам нужны многомерные метрики. Например, подсчёт неудачных merge-операций или мутаций по кодам ошибок вместо одного счётчика. [#83030](https://github.com/ClickHouse/ClickHouse/pull/83030) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Добавлены метрики использования ресурсов процесса (такие как `UserTimeMicroseconds`, `SystemTimeMicroseconds`, `RealTimeMicroseconds`) в события профилирования part_log для записей `MergeParts`. [#83460](https://github.com/ClickHouse/ClickHouse/pull/83460) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Метрики на уровне cgroup и системные метрики теперь передаются вместе. Метрики на уровне cgroup имеют имена вида `CGroup<Metric>`, а метрики уровня ОС (собираемые из procfs) имеют имена вида `OS<Metric>`. [#84317](https://github.com/ClickHouse/ClickHouse/pull/84317) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлены многомерные метрики для мониторинга размера конкурентных очередей с ограниченной ёмкостью, помеченных типом очереди и ID экземпляра для лучшей наблюдаемости. [#84675](https://github.com/ClickHouse/ClickHouse/pull/84675) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Таблица [`system.columns`](/operations/system-tables/columns) теперь предоставляет `column` как псевдоним для существующего столбца `name`. [#84695](https://github.com/ClickHouse/ClickHouse/pull/84695) ([Yunchi Pang](https://github.com/yunchipang)).
* В `system.errors` добавлен столбец с форматной строкой. Этот столбец нужен для группировки по одному и тому же типу ошибки в правилах оповещений. [#84776](https://github.com/ClickHouse/ClickHouse/pull/84776) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Сделаны настраиваемыми лимиты для Async Log и добавлены средства интроспекции. [#85105](https://github.com/ClickHouse/ClickHouse/pull/85105) ([Raúl Marín](https://github.com/Algunenano)).
* Теперь `UNKNOWN_DATABASE` игнорируется при получении размеров столбцов таблиц для `system.columns`. [#85632](https://github.com/ClickHouse/ClickHouse/pull/85632) ([Azat Khuzhin](https://github.com/azat)).

### Движки баз данных \{#database-engines\}

### Системные и внутренние улучшения \{#system-and-internal-improvements\}

* Исправлено присоединение баз данных на удалённых дисках только для чтения путём ручного добавления UUID таблиц в `DatabaseCatalog`. [#82670](https://github.com/ClickHouse/ClickHouse/pull/82670) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Улучшена обработка DDL‑заданий при `distributed_ddl_output_mode='*_only_active'` за счёт отказа от ожидания новых или восстановленных реплик, у которых отставание репликации превышает `max_replication_lag_to_enqueue`. Это помогает избежать ошибок `DDL task is not finished on some hosts`, когда новая реплика становится активной после инициализации или восстановления, но успевает накопить большой журнал репликации. Также реализован запрос `SYSTEM SYNC DATABASE REPLICA STRICT`, который ожидает, пока журнал репликации не станет меньше `max_replication_lag_to_enqueue`. [#83302](https://github.com/ClickHouse/ClickHouse/pull/83302) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Изменён порядок завершения работы `SystemLogs` так, чтобы она выполнялась после обычных таблиц (и перед системными таблицами, вместо выполнения до обычных таблиц). [#83134](https://github.com/ClickHouse/ClickHouse/pull/83134) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлен серверный параметр `logs_to_keep` для настроек реплицируемых баз данных, позволяющий задавать значение по умолчанию параметра `logs_to_keep` для реплицируемых баз. Меньшие значения уменьшают количество узлов ZooKeeper (особенно полезно, когда много баз данных), а большие значения позволяют отсутствующим репликам догонять после более продолжительных простоев. [#84183](https://github.com/ClickHouse/ClickHouse/pull/84183) ([Alexey Khatskevich](https://github.com/Khatskevich)).
* Значение по умолчанию настройки реплицируемых баз данных `max_retries_before_automatic_recovery` изменено на 10, что ускоряет восстановление в некоторых случаях. [#84369](https://github.com/ClickHouse/ClickHouse/pull/84369) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Оптимизированы не‑append DDL‑операции обновляемых материализованных представлений (Refreshable Materialized View) в реплицируемых базах данных за счёт пропуска создания и переименования старых временных таблиц. [#84858](https://github.com/ClickHouse/ClickHouse/pull/84858) ([Tuan Pham Anh](https://github.com/tuanpach)).

### Репликация и синхронизация \{#replication-and-synchronization\}

### SystemAndInternalImprovements \{#systemandinternalimprovements\}

* Улучшена команда `SYSTEM RESTART REPLICA`: добавлены повторные попытки создания таблицы при проблемах с подключением к ZooKeeper, что позволяет избежать потери таблиц. [#82616](https://github.com/ClickHouse/ClickHouse/pull/82616) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена проверка UUID в `ReplicatedMergeTree::executeMetadataAlter`, чтобы предотвратить некорректные определения таблиц, если таблицы были заменены между получением `StorageID` и вызовом `IDatabase::alterTable`. [#82666](https://github.com/ClickHouse/ClickHouse/pull/82666) ([Nikolay Degterinsky](https://github.com/evillique)).
* Удалена экспериментальная логика `send_metadata`, связанная с экспериментальной репликацией без копирования данных (zero-copy). Этот код никогда не использовался, не поддерживался и, вероятно, был неисправен; при этом не было тестов, подтверждающих его работоспособность. [#82508](https://github.com/ClickHouse/ClickHouse/pull/82508) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка макроподстановки в `remote_fs_zero_copy_zookeeper_path`. [#85437](https://github.com/ClickHouse/ClickHouse/pull/85437) ([Mikhail Koviazin](https://github.com/mkmkme)).

### Функции и выражения \{#functions-and-expressions\}

* Функция `addressToSymbol` и таблица `system.symbols` будут использовать смещения в файле вместо адресов в виртуальной памяти. [#81896](https://github.com/ClickHouse/ClickHouse/pull/81896) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Старайтесь сохранять имена элементов при выведении супертипов для именованных кортежей. [#81345](https://github.com/ClickHouse/ClickHouse/pull/81345) ([lgbo](https://github.com/lgbo-ustc)).
* Разрешено смешивать разные правила сравнения строк (collations) для одного и того же столбца в разных окнах. [#82877](https://github.com/ClickHouse/ClickHouse/pull/82877) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Добавлена функция для записи типов в формат WKB. [#82935](https://github.com/ClickHouse/ClickHouse/pull/82935) ([scanhex12](https://github.com/scanhex12)).
* Добавлена возможность интерпретировать `Time` и `Time64` в форматах MM:SS, M:SS, SS или S. [#83299](https://github.com/ClickHouse/ClickHouse/pull/83299) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Функция `reinterpret()` теперь поддерживает преобразование в `Array(T)`, где `T` — тип данных фиксированного размера (задача [#82621](https://github.com/ClickHouse/ClickHouse/issues/82621)). [#83399](https://github.com/ClickHouse/ClickHouse/pull/83399) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Исправлены функции `structureToProtobufSchema` и `structureToCapnProtoSchema`, чтобы корректно добавлять нулевой байт-терминатор вместо символа новой строки, что предотвращает пропуск переводов строки в выводе и потенциальные переполнения буфера в функциях, которые зависят от нулевого байта (таких как `logTrace`, `demangle`, `extractURLParameter`, `toStringCutToZero` и `encrypt`/`decrypt`). Закрывает [#85062](https://github.com/ClickHouse/ClickHouse/issues/85062). [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена структура словаря `regexp_tree` для поддержки обработки строк, содержащих нулевые байты. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена функция `formatRowNoNewline`, которая неправильно обрезала последний символ вывода при использовании формата `Values` или любого формата без символа новой строки в конце строк. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка в exception safety функции `stem`, которая в редких случаях могла приводить к утечкам памяти. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена функция `initcap` для аргументов типа `FixedString`, чтобы корректно распознавать начало слов в начале строк, если предыдущая строка в блоке заканчивалась буквенно-цифровым символом. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена уязвимость безопасности в формате Apache `ORC`, которая могла приводить к раскрытию неинициализированной памяти. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Изменено поведение `replaceRegexpAll` и его алиаса `REGEXP_REPLACE`, чтобы разрешить пустые совпадения в конце строк, даже если предыдущее совпадение охватывало всю строку целиком (например, `^a*|a*$` или `^|.*`), что согласуется с семантикой JavaScript, Perl, Python, PHP и Ruby, но отличается от PostgreSQL. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Оптимизирована и упрощена реализация целого ряда функций обработки строк. Исправлена неверная документация для нескольких функций. Примечание: результат `byteSize` для столбцов типа String и сложных типов, содержащих столбцы типа String, изменился с 9 байт за пустую строку на 8 байт за пустую строку, что и является ожидаемым поведением. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Разрешено значение шага 0 в функциях `timeSeries*ToGrid()`. Это часть `#3` из [https://github.com/ClickHouse/ClickHouse/pull/75036](https://github.com/ClickHouse/ClickHouse/pull/75036). [#85390](https://github.com/ClickHouse/ClickHouse/pull/85390) ([Vitaly Baranov](https://github.com/vitlibar)).
* Реализована поддержка внутренних массивов в функции `nested`. [#85719](https://github.com/ClickHouse/ClickHouse/pull/85719) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).

### Улучшения MergeTree \{#mergetree-improvements\}

* Более точечное отключение пропускающих индексов, которые зависят от столбцов, обновляемых «на лету» или с помощью patch-частей. Теперь пропускающие индексы не используются только в тех частях, которые затронуты мутациями «on-the-fly» или patch-частями; ранее эти индексы отключались для всех частей. [#84241](https://github.com/ClickHouse/ClickHouse/pull/84241) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена настройка MergeTree `search_orphaned_parts_drives` для ограничения области поиска частей, например, по дискам с локальными метаданными. [#84710](https://github.com/ClickHouse/ClickHouse/pull/84710) ([Ilya Golshtein](https://github.com/ilejn)).
* Добавлена недостающая поддержка `read_in_order_use_virtual_row` для `WHERE`. Это позволяет пропускать чтение большего числа частей для запросов с фильтрами, которые не были полностью перенесены в `PREWHERE`. [#84835](https://github.com/ClickHouse/ClickHouse/pull/84835) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено использование сериализации дискриминаторов Variant в формате «compact» в MergeTree. Ранее она не применялась в некоторых случаях, когда могла бы быть использована. [#84141](https://github.com/ClickHouse/ClickHouse/pull/84141) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлено ограничение (настройка таблицы [`max_uncompressed_bytes_in_patches`](/operations/settings/merge-tree-settings#max_uncompressed_bytes_in_patches)) на суммарное количество несжатых байт в patch-частях. Это предотвращает значительные замедления `SELECT`‑запросов после легковесных обновлений и предотвращает возможное некорректное использование легковесных обновлений. [#85641](https://github.com/ClickHouse/ClickHouse/pull/85641) ([Anton Popov](https://github.com/CurtizJ)).

### Управление кэшем и памятью \{#cache-and-memory-management\}

* Исправлена логическая ошибка в файловом кэше: «Having zero bytes but range is not finished». [#81868](https://github.com/ClickHouse/ClickHouse/pull/81868) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлено хеширование rendezvous для улучшения локальности кэша. [#82511](https://github.com/ClickHouse/ClickHouse/pull/82511) ([Anton Ivashkin](https://github.com/ianton-ru)).
* Рефакторинг механизма динамического изменения размера файлового кэша. Добавлено больше записей в журнал для анализа. [#82556](https://github.com/ClickHouse/ClickHouse/pull/82556) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Снижены накладные расходы на отслеживание потребления памяти запросами для исполняемых пользовательских функций. [#83929](https://github.com/ClickHouse/ClickHouse/pull/83929) ([Eduard Karacharov](https://github.com/korowa)).
* Все выделения памяти, выполняемые внешними библиотеками, теперь видны трекеру памяти ClickHouse и корректно учитываются. Это может привести к «увеличенному» отображаемому объему используемой памяти для некоторых запросов или к ошибкам `MEMORY_LIMIT_EXCEEDED`. [#84082](https://github.com/ClickHouse/ClickHouse/pull/84082) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Выделяется минимальный объем памяти, необходимый для `encrypted_buffer` для зашифрованных именованных коллекций. [#84432](https://github.com/ClickHouse/ClickHouse/pull/84432) ([Pablo Marcos](https://github.com/pamarcos)).

### Индекс сходства векторов \{#vector-similarity-index\}

* Предотвращено использование пользователями значений `nan` и `inf` с `NumericIndexedVector`. Исправляет проблему [#82239](https://github.com/ClickHouse/ClickHouse/issues/82239) и ещё несколько связанных моментов. [#82681](https://github.com/ClickHouse/ClickHouse/pull/82681) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Индекс сходства векторов теперь поддерживает бинарную квантизацию. Бинарная квантизация существенно снижает потребление памяти и ускоряет построение векторного индекса (за счёт более быстрого вычисления расстояний). Также существующая настройка `vector_search_postfilter_multiplier` была признана устаревшей и заменена более общей настройкой: `vector_search_index_fetch_multiplier`. [#85024](https://github.com/ClickHouse/ClickHouse/pull/85024) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Приближённый поиск по векторам с использованием индексов сходства векторов теперь имеет статус GA. [#85888](https://github.com/ClickHouse/ClickHouse/pull/85888) ([Robert Schulze](https://github.com/rschu1ze)).

### Обработка ошибок и сообщения \{#error-handling-and-messages\}

* Заголовок Connection отправляется в конце заголовков, когда уже известно, должно ли поддерживаться соединение. [#81951](https://github.com/ClickHouse/ClickHouse/pull/81951) ([Sema Checherinda](https://github.com/CheSema)).
* В предыдущих версиях умножение состояния агрегатной функции на IPv4 вызывало логическую ошибку вместо корректного кода ошибки. Закрывает [#82817](https://github.com/ClickHouse/ClickHouse/issues/82817). [#82818](https://github.com/ClickHouse/ClickHouse/pull/82818) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшена обработка ошибок в `AsynchronousMetrics`. Если каталог `/sys/block` существует, но недоступен, сервер запустится без мониторинга блочных устройств. Закрывает [#79229](https://github.com/ClickHouse/ClickHouse/issues/79229). [#83115](https://github.com/ClickHouse/ClickHouse/pull/83115) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Была некорректная проверка зависимостей для `INSERT` с материализованными представлениями с некорректными запросами `SELECT`, из-за чего пользователь мог получать малопонятное исключение `std::exception` вместо информативной ошибки с понятным пояснением. Теперь это исправлено. Исправляет: [#82889](https://github.com/ClickHouse/ClickHouse/issues/82889). [#83190](https://github.com/ClickHouse/ClickHouse/pull/83190) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Не выводить очень длинные описания действий выражений в сообщениях об исключениях. Закрывает [#83164](https://github.com/ClickHouse/ClickHouse/issues/83164). [#83350](https://github.com/ClickHouse/ClickHouse/pull/83350) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* При остановке хранилища `getStatus` теперь генерирует исключение `ErrorCodes::ABORTED`. Ранее это приводило к ошибке выполнения запроса SELECT. Теперь мы перехватываем исключения `ErrorCodes::ABORTED` и намеренно их игнорируем. [#83435](https://github.com/ClickHouse/ClickHouse/pull/83435) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Сообщения об исключениях при загрузке и добавлении проекций в некоторых ситуациях стали более читаемыми. [#83728](https://github.com/ClickHouse/ClickHouse/pull/83728) ([Robert Schulze](https://github.com/rschu1ze)).
* Проверять, отменено ли соединение, до проверки EOF, чтобы предотвратить чтение из закрытого соединения. Исправляет [#83893](https://github.com/ClickHouse/ClickHouse/issues/83893). [#84227](https://github.com/ClickHouse/ClickHouse/pull/84227) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Улучшена обработка остановки сервера для клиентских подключений за счёт упрощения внутренних проверок. [#84312](https://github.com/ClickHouse/ClickHouse/pull/84312) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Низкоуровневые ошибки во время выполнения UDF теперь приводят к сбою с кодом ошибки `UDF_EXECUTION_FAILED`, тогда как раньше могли возвращаться разные коды ошибок. [#84547](https://github.com/ClickHouse/ClickHouse/pull/84547) ([Xu Jia](https://github.com/XuJia0210)).

### Улучшения форматирования SQL \{#sql-formatting-improvements\}

* Исправлено несогласованное форматирование `CREATE DICTIONARY`. Закрывает [#82105](https://github.com/ClickHouse/ClickHouse/issues/82105). [#82829](https://github.com/ClickHouse/ClickHouse/pull/82829) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено несогласованное форматирование `TTL`, когда он содержит функцию `materialize`. Закрывает [#82828](https://github.com/ClickHouse/ClickHouse/issues/82828). [#82831](https://github.com/ClickHouse/ClickHouse/pull/82831) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено несогласованное форматирование `EXPLAIN AST` во вложенном запросе, когда он содержит опции вывода, такие как INTO OUTFILE. Закрывает [#82826](https://github.com/ClickHouse/ClickHouse/issues/82826). [#82840](https://github.com/ClickHouse/ClickHouse/pull/82840) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено несогласованное форматирование выражений в скобках с псевдонимами в контексте, где псевдонимы не разрешены. Закрывает [#82836](https://github.com/ClickHouse/ClickHouse/issues/82836). Закрывает [#82837](https://github.com/ClickHouse/ClickHouse/issues/82837). [#82867](https://github.com/ClickHouse/ClickHouse/pull/82867) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено форматирование `CREATE USER` с параметрами запроса (то есть `CREATE USER {username:Identifier} IDENTIFIED WITH no_password`). [#84376](https://github.com/ClickHouse/ClickHouse/pull/84376) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен разбор завершающей запятой в списке столбцов запроса `CREATE DICTIONARY` после столбца с параметрами, например, `Decimal(8)`. Закрывает [#85586](https://github.com/ClickHouse/ClickHouse/issues/85586). [#85653](https://github.com/ClickHouse/ClickHouse/pull/85653) ([Nikolay Degterinsky](https://github.com/evillique)).

### Внешние интеграции \{#external-integrations\}

* Унифицированы имена параметров в ODBC и JDBC при использовании именованных коллекций. [#83410](https://github.com/ClickHouse/ClickHouse/pull/83410) ([Andrey Zvonov](https://github.com/zvonand)).
* MongoDB: неявное преобразование строк в числовые типы. Ранее, если строковое значение приходило из источника MongoDB для числового столбца в таблице ClickHouse, выбрасывалось исключение. Теперь движок пытается автоматически распарсить числовое значение из строки. Закрывает [#81167](https://github.com/ClickHouse/ClickHouse/issues/81167). [#84069](https://github.com/ClickHouse/ClickHouse/pull/84069) ([Kirill Nikiforov](https://github.com/allmazz)).
* Разрешено использование `simdjson` на неподдерживаемых архитектурах (ранее это приводило к ошибкам `CANNOT_ALLOCATE_MEMORY`). [#84966](https://github.com/ClickHouse/ClickHouse/pull/84966) ([Azat Khuzhin](https://github.com/azat)).

### Прочие улучшения \{#miscellaneous-improvements\}

* Добавлен движок таблицы Ytsaurus и табличная функция. [#77606](https://github.com/ClickHouse/ClickHouse/pull/77606) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Улучшен `HashJoin::needUsedFlagsForPerRightTableRow`, теперь возвращает `false` для `CROSS JOIN`. [#82379](https://github.com/ClickHouse/ClickHouse/pull/82379) ([lgbo](https://github.com/lgbo-ustc)).
* Разрешена запись и чтение столбцов типа `map` как массива кортежей. [#82408](https://github.com/ClickHouse/ClickHouse/pull/82408) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Этот PR был откатан. [#82884](https://github.com/ClickHouse/ClickHouse/pull/82884) ([Mithun p](https://github.com/mithunputhusseri)).
* Асинхронные логи: ограничено максимальное число записей, удерживаемых в очереди. [#83214](https://github.com/ClickHouse/ClickHouse/pull/83214) ([Raúl Marín](https://github.com/Algunenano)).
* Включена поддержка `Date`/`Date32` как целых чисел во входных форматах JSON. [#83597](https://github.com/ClickHouse/ClickHouse/pull/83597) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Улучшена поддержка индексов блум‑фильтра (обычных, `ngram` и `token`) для использования в случаях, когда первым аргументом является константный массив (множество), а вторым — индексируемый столбец (подмножество), что обеспечивает более эффективное выполнение запросов. [#84700](https://github.com/ClickHouse/ClickHouse/pull/84700) ([Doron David](https://github.com/dorki)).
* Разрешено приведение типов значений множеств при проталкивании фильтров `IN` / `GLOBAL IN` по первичным ключам хранилища `KeyValue` (например, `EmbeddedRocksDB`, `KeeperMap`). [#84515](https://github.com/ClickHouse/ClickHouse/pull/84515) ([Eduard Karacharov](https://github.com/korowa)).
* Исключены полные сканирования в случаях, когда анализ индекса приводит к пустым диапазонам при чтении параллельными репликами. [#84971](https://github.com/ClickHouse/ClickHouse/pull/84971) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлен ряд проблем, которые могли возникать при попытке запустить интеграционные тесты на локальной машине. [#82135](https://github.com/ClickHouse/ClickHouse/pull/82135) ([Oleg Doronin](https://github.com/dorooleg)).
* По умолчанию включена опция `trace_log.symbolize` для старых развертываний. [#85456](https://github.com/ClickHouse/ClickHouse/pull/85456) ([Azat Khuzhin](https://github.com/azat)).

#### Исправления ошибок (некорректное поведение, заметное пользователю, в официальном стабильном релизе) \{#bug-fixes\}

### Оптимизации производительности \{#performance-optimizations\}

* Исправлена деградация производительности в SummingMergeTree, которая появилась в версии 25.5 в результате изменений из https://github.com/ClickHouse/ClickHouse/pull/79051. [#82130](https://github.com/ClickHouse/ClickHouse/pull/82130) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена деградация производительности при включённом analyzer, когда вторичные запросы всегда читают все столбцы из представлений (VIEW). Исправляет [#81718](https://github.com/ClickHouse/ClickHouse/issues/81718). [#83036](https://github.com/ClickHouse/ClickHouse/pull/83036) ([Dmitry Novik](https://github.com/novikd)).
* Не выполнять проверку на циклические зависимости при создании таблицы без зависимостей. Это исправляет деградацию производительности сценариев с созданием тысяч таблиц, которая появилась в результате изменений из https://github.com/ClickHouse/ClickHouse/pull/65405. [#83077](https://github.com/ClickHouse/ClickHouse/pull/83077) ([Pavel Kruglov](https://github.com/Avogar)).
* Обеспечить выполнение оконных агрегатных функций `DISTINCT` за линейное время и исправить ошибку в `sumDistinct`. Закрывает [#79792](https://github.com/ClickHouse/ClickHouse/issues/79792). Закрывает [#52253](https://github.com/ClickHouse/ClickHouse/issues/52253). [#79859](https://github.com/ClickHouse/ClickHouse/pull/79859) ([Nihal Z. Miaji](https://github.com/nihalzp)).

### Исправления в выполнении запросов \{#query-execution-fixes\}

* Для запросов с комбинацией `ORDER BY ... LIMIT BY ... LIMIT N`, когда ORDER BY выполняется в режиме PartialSorting, счетчик `rows_before_limit_at_least` теперь отражает количество строк, обработанных оператором LIMIT, вместо количества строк, обработанных этапом сортировки. [#78999](https://github.com/ClickHouse/ClickHouse/pull/78999) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлена логическая ошибка при использовании оператора `<=>` с хранилищем Join, теперь запрос возвращает корректный код ошибки. [#80165](https://github.com/ClickHouse/ClickHouse/pull/80165) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлен сбой в функции `loop` при использовании с семейством функций `remote`. Обеспечено соблюдение оператора LIMIT в `loop(remote(...))`. [#80299](https://github.com/ClickHouse/ClickHouse/pull/80299) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлено некорректное поведение функций `to_utc_timestamp` и `from_utc_timestamp` при обработке дат до эпохи Unix (1970-01-01) и после максимальной даты (2106-02-07 06:28:15). Теперь эти функции корректно ограничивают значения началом эпохи и максимальной датой соответственно. [#80498](https://github.com/ClickHouse/ClickHouse/pull/80498) ([Surya Kant Ranjan](https://github.com/iit2009046)).
* Исправлено выполнение `IN` при `transform_null_in=1` с `NULL` в левом аргументе и результатом подзапроса, не допускающим `NULL`. [#81584](https://github.com/ClickHouse/ClickHouse/pull/81584) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена проблема, при которой требуемые столбцы не считывались при обработке скалярных коррелированных подзапросов. Исправляет [#81716](https://github.com/ClickHouse/ClickHouse/issues/81716). [#81805](https://github.com/ClickHouse/ClickHouse/pull/81805) ([Dmitry Novik](https://github.com/novikd)).
* Исправлен анализ фильтра для запроса, в котором используется только столбец с константным псевдонимом. Исправляет [#79448](https://github.com/ClickHouse/ClickHouse/issues/79448). [#82037](https://github.com/ClickHouse/ClickHouse/pull/82037) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена ошибка `Not found column` для запросов с `arrayJoin` в условии `WHERE` в сочетании с `IndexSet`. [#82113](https://github.com/ClickHouse/ClickHouse/pull/82113) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, приводившая к возникновению исключения `TOO_DEEP_SUBQUERIES`, когда определение CTE ссылается на другое табличное выражение с тем же именем. [#83413](https://github.com/ClickHouse/ClickHouse/pull/83413) ([Dmitry Novik](https://github.com/novikd)).
* Исправлен некорректный результат выполнения запросов с предложением `WHERE ... IN (<subquery>)` при включённом кэше условий запроса (настройка `use_query_condition_cache`). [#83445](https://github.com/ClickHouse/ClickHouse/pull/83445) ([LB7666](https://github.com/acking-you)).
* `INSERT SELECT` с `UNION ALL` могло приводить к разыменованию нулевого указателя в пограничном случае. Это исправляет [#83618](https://github.com/ClickHouse/ClickHouse/issues/83618). [#83643](https://github.com/ClickHouse/ClickHouse/pull/83643) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка `LOGICAL_ERROR`, возникавшая при анализе выражения политики строк для коррелированных столбцов. [#82618](https://github.com/ClickHouse/ClickHouse/pull/82618) ([Dmitry Novik](https://github.com/novikd)).
* Исправлены ошибочные результаты при использовании кэша условий запроса совместно с рекурсивными CTE (issue [#81506](https://github.com/ClickHouse/ClickHouse/issues/81506)). [#84026](https://github.com/ClickHouse/ClickHouse/pull/84026) ([zhongyuankai](https://github.com/zhongyuankai)).
* Исправлен бесконечный рекурсивный анализ некорректных определений `WINDOW`. Устраняет [#83131](https://github.com/ClickHouse/ClickHouse/issues/83131). [#84242](https://github.com/ClickHouse/ClickHouse/pull/84242) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена проблема с `Not-ready Set` при использовании `IN (subquery)` в параметре `additional_table_filters expression`. [#85210](https://github.com/ClickHouse/ClickHouse/pull/85210) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена логическая ошибка, приводившая к дублированию подзапросов при включённом `optimize_syntax_fuse_functions`, закрыт [#75511](https://github.com/ClickHouse/ClickHouse/issues/75511). [#83300](https://github.com/ClickHouse/ClickHouse/pull/83300) ([Vladimir Cherkasov](https://github.com/vdimir)).

### Исправления в Iceberg и DataLake \{#iceberg-and-datalake-fixes\}

* Исправлено определение метаданных при выполнении запросов к таблицам iceberg через REST‑каталог. ... [#80562](https://github.com/ClickHouse/ClickHouse/pull/80562) ([Saurabh Kumar Ojha](https://github.com/saurabhojha)).
* Исправлены гонки данных в Iceberg. [#82088](https://github.com/ClickHouse/ClickHouse/pull/82088) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка «Context has expired» для Iceberg. [#82146](https://github.com/ClickHouse/ClickHouse/pull/82146) ([Azat Khuzhin](https://github.com/azat)).
* Теперь ClickHouse может читать таблицы iceberg из каталога Glue после эволюции схемы. Исправляет [#81272](https://github.com/ClickHouse/ClickHouse/issues/81272). [#82301](https://github.com/ClickHouse/ClickHouse/pull/82301) ([alesapin](https://github.com/alesapin)).
* Исправлены гонки данных в Iceberg. [#82841](https://github.com/ClickHouse/ClickHouse/pull/82841) ([Azat Khuzhin](https://github.com/azat)).
* Отключена обрезка файлов, основанная на границах, для элементов массивов iceberg и значений карт iceberg, включая все их вложенные подполя. [#83520](https://github.com/ClickHouse/ClickHouse/pull/83520) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлена запись в iceberg для сложных типов. [#85330](https://github.com/ClickHouse/ClickHouse/pull/85330) ([scanhex12](https://github.com/scanhex12)).
* Запись нижних и верхних границ не поддерживается для сложных типов. [#85332](https://github.com/ClickHouse/ClickHouse/pull/85332) ([scanhex12](https://github.com/scanhex12)).
* Исправлена null‑допустимость полей в iceberg. [#85977](https://github.com/ClickHouse/ClickHouse/pull/85977) ([scanhex12](https://github.com/scanhex12)).
* Больше не создаётся пустой файл удаления iceberg. [#86061](https://github.com/ClickHouse/ClickHouse/pull/86061) ([scanhex12](https://github.com/scanhex12)).
* Обновляется метка времени метаданных при записях в iceberg. [#85711](https://github.com/ClickHouse/ClickHouse/pull/85711) ([scanhex12](https://github.com/scanhex12)).
* Spark не может читать файлы позиционного удаления (position delete). [#85762](https://github.com/ClickHouse/ClickHouse/pull/85762) ([scanhex12](https://github.com/scanhex12)).
* Схема больше не берётся из manifest‑файлов, вместо этого соответствующие схемы для каждого snapshot хранятся независимо. Актуальная схема для каждого файла данных теперь выводится из соответствующего snapshot. Предыдущее поведение нарушало спецификацию Iceberg для записей manifest‑файлов с существующим статусом. [#84588](https://github.com/ClickHouse/ClickHouse/pull/84588) ([Daniil Ivanik](https://github.com/divanik)).
* Теперь Iceberg не пытается кэшировать актуальную версию snapshot между запросами `SELECT` и каждый раз заново определяет соответствующий snapshot. Предыдущая попытка кэшировать snapshot iceberg приводила к проблемам при использовании таблицы Iceberg с функциональностью time travel. [#85038](https://github.com/ClickHouse/ClickHouse/pull/85038) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлено определение метаданных при выполнении запросов к таблицам iceberg через REST‑каталог. ... [#85531](https://github.com/ClickHouse/ClickHouse/pull/85531) ([Saurabh Kumar Ojha](https://github.com/saurabhojha)).
* Исправлено маскирование секретов в табличных функциях icebergS3Cluster и icebergAzureCluster. [#85658](https://github.com/ClickHouse/ClickHouse/pull/85658) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).

### Исправления DeltaLake \{#deltalake-fixes\}

* Исправлено отбрасывание столбцов (column pruning) с использованием delta-kernel в хранилище `DeltaLake`. Закрывает [#84543](https://github.com/ClickHouse/ClickHouse/issues/84543). [#84745](https://github.com/ClickHouse/ClickHouse/pull/84745) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Обновлены учетные данные в delta-kernel в хранилище `DeltaLake`. [#84751](https://github.com/ClickHouse/ClickHouse/pull/84751) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен segfault в реализации delta-kernel. [#85160](https://github.com/ClickHouse/ClickHouse/pull/85160) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено состояние гонки (race) в реализации delta-kernel движка `DeltaLake`. [#85221](https://github.com/ClickHouse/ClickHouse/pull/85221) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено чтение секционированных данных при отключенном delta-kernel в движке `DeltaLake`. Некорректное поведение появилось в 25.7 (https://github.com/ClickHouse/ClickHouse/pull/81136). [#85223](https://github.com/ClickHouse/ClickHouse/pull/85223) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Для версий до 25.5 значение `allow_experimental_delta_kernel_rs` изменено на `false` для обеспечения совместимости. [#84587](https://github.com/ClickHouse/ClickHouse/pull/84587) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправено чтение значения COUNT из кэша для DeltaLake. [#85704](https://github.com/ClickHouse/ClickHouse/pull/85704) ([Kseniia Sumarokova](https://github.com/kssenii)).

### Исправления TTL и MergeTree \{#ttl-and-mergetree-fixes\}

* Пересчитывать min-max-индекс при уменьшении числа строк по TTL, чтобы обеспечить корректность алгоритмов, использующих его, например `minmax_count_projection`. Это исправляет [#77091](https://github.com/ClickHouse/ClickHouse/issues/77091). [#77166](https://github.com/ClickHouse/ClickHouse/pull/77166) ([Amos Bird](https://github.com/amosbird)).
* Исправить некорректный пересчёт TTL в TTL GROUP BY при обновлении TTL. [#81222](https://github.com/ClickHouse/ClickHouse/pull/81222) ([Evgeniy Ulasik](https://github.com/H0uston)).
* Исправить ошибку «Context has expired» во время слияний, когда словарь используется в TTL-выражении. [#81690](https://github.com/ClickHouse/ClickHouse/pull/81690) ([Azat Khuzhin](https://github.com/azat)).
* Исправить LOGICAL_ERROR и последующее падение при использовании одного и того же столбца в TTL для GROUP BY и SET. [#82054](https://github.com/ClickHouse/ClickHouse/pull/82054) ([Pablo Marcos](https://github.com/pamarcos)).
* MergeTree теперь не выполняет никаких действий, связанных с TTL, если все TTL удалены из таблицы. [#84441](https://github.com/ClickHouse/ClickHouse/pull/84441) ([alesapin](https://github.com/alesapin)).
* Исправить проблему, при которой `ALTER MODIFY ORDER BY` не проверял TTL-столбцы в ключах сортировки. TTL-столбцы теперь корректно отклоняются при использовании в выражениях `ORDER BY` во время операций `ALTER`, что предотвращает возможное повреждение таблиц. [#84536](https://github.com/ClickHouse/ClickHouse/pull/84536) ([xiaohuanlin](https://github.com/xiaohuanlin)).

### Исправления проекций \{#projection-fixes\}

* Исправлена логическая ошибка при материализации проекции, когда тип столбца был изменён на Nullable. [#80741](https://github.com/ClickHouse/ClickHouse/pull/80741) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено некорректное использование метаданных родителя в табличной функции `mergeTreeProjection`, когда `enable_shared_storage_snapshot_in_query = 1`. Связано с [#82634](https://github.com/ClickHouse/ClickHouse/issues/82634). [#82638](https://github.com/ClickHouse/ClickHouse/pull/82638) ([Amos Bird](https://github.com/amosbird)).
* Исправлен редкий сбой ClickHouse, когда у таблицы есть проекция, `lightweight_mutation_projection_mode = 'rebuild'`, и пользователь выполняет lightweight delete, который удаляет ВСЕ строки из любого блока таблицы. [#84158](https://github.com/ClickHouse/ClickHouse/pull/84158) ([alesapin](https://github.com/alesapin)).
* Исправлено резервное копирование частей с повреждёнными проекциями. [#85362](https://github.com/ClickHouse/ClickHouse/pull/85362) ([Antonio Andelic](https://github.com/antonio2368)).
* Запрещено использование столбца `_part_offset` в проекциях в релизах до его стабилизации. [#85372](https://github.com/ClickHouse/ClickHouse/pull/85372) ([Sema Checherinda](https://github.com/CheSema)).

### Исправления для параллельных реплик \{#parallel-replicas-fixes\}

* Для некоторых запросов, выполняемых с параллельными репликами, оптимизация чтения по порядку (reading in order) могла применяться на инициаторе, но не на удалённых узлах. Это приводило к использованию различных режимов чтения координатором параллельных реплик (на инициаторе) и на удалённых узлах, что является логической ошибкой. [#80652](https://github.com/ClickHouse/ClickHouse/pull/80652) ([Igor Nikonov](https://github.com/devcrafter)).
* Отключать параллельные реплики, если подзапрос содержит `FINAL` [#81401](https://github.com/ClickHouse/ClickHouse/issues/81401). [#83455](https://github.com/ClickHouse/ClickHouse/pull/83455) ([zoomxi](https://github.com/zoomxi)).
* Исправить `LOGICAL_ERROR` для запросов с параллельными репликами и несколькими соединениями INNER, после которых следует соединение RIGHT. Не использовать параллельные реплики для таких запросов. [#84299](https://github.com/ClickHouse/ClickHouse/pull/84299) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Запросы с параллельными репликами, которые используют оптимизацию чтения в обратном порядке (reading reverse in order), могут приводить к некорректным результатам. [#85406](https://github.com/ClickHouse/ClickHouse/pull/85406) ([Igor Nikonov](https://github.com/devcrafter)).

### Аутентификация и безопасность \{#authentication-and-security\}

* Исправлена проблема с сокрытием значений именованных коллекций в `logs/query_log`. Закрывает [#82405](https://github.com/ClickHouse/ClickHouse/issues/82405). [#82510](https://github.com/ClickHouse/ClickHouse/pull/82510) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Установлена соль для данных аутентификации при разборе AST для типа SCRAM_SHA256_PASSWORD. [#82888](https://github.com/ClickHouse/ClickHouse/pull/82888) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Маскирование данных аутентификации для Avro schema registry, чтобы они не были видны пользователю или в логах. [#83713](https://github.com/ClickHouse/ClickHouse/pull/83713) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлено некорректное поведение, когда выполнение `REVOKE S3 ON system.*` отзывает права S3 для `*.*`. Исправляет [#83417](https://github.com/ClickHouse/ClickHouse/issues/83417). [#83420](https://github.com/ClickHouse/ClickHouse/pull/83420) ([pufit](https://github.com/pufit)).
* Исправлен сбой сервера, когда пользователь, созданный с `no_password`, пытается войти после того, как настройка сервера `allow_no_password` была изменена на 0. [#84426](https://github.com/ClickHouse/ClickHouse/pull/84426) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Улучшено сообщение об ошибке при попытке создать пользователя, идентифицируемого по JWT. [#85072](https://github.com/ClickHouse/ClickHouse/pull/85072) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Замаскированы учетные данные для `deltaLakeAzure`, `deltaLakeCluster`, `icebergS3Cluster` и `icebergAzureCluster`. [#85889](https://github.com/ClickHouse/ClickHouse/pull/85889) ([Julian Maicher](https://github.com/jmaicher)).
* Исправлена ошибка, допущенная в [#79963](https://github.com/ClickHouse/ClickHouse/pull/79963). При вставке в материализованное представление с `definer` проверка прав должна использовать привилегии пользователя-определителя (`definer`). Исправляет [#79951](https://github.com/ClickHouse/ClickHouse/issues/79951). [#83502](https://github.com/ClickHouse/ClickHouse/pull/83502) ([pufit](https://github.com/pufit)).

### Исправления резервного копирования и восстановления \{#backup-and-restore-fixes\}

* Исправлено создание резервной копии пустой таблицы `Memory`, из-за которого восстановление резервной копии завершалось с ошибкой `BACKUP_ENTRY_NOT_FOUND`. [#82791](https://github.com/ClickHouse/ClickHouse/pull/82791) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлено вводящее в заблуждение сообщение об ошибке при восстановлении резервной копии на диск только для чтения. [#83051](https://github.com/ClickHouse/ClickHouse/pull/83051) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлен запуск лишних внутренних операций резервного копирования после возникновения проблем с подключением. [#84755](https://github.com/ClickHouse/ClickHouse/pull/84755) ([Vitaly Baranov](https://github.com/vitlibar)).

### Оконные и агрегатные функции \{#window-and-aggregate-functions\}

* Исправлен возможный сбой в `Aggregator` в случае исключения во время слияния. [#81450](https://github.com/ClickHouse/ClickHouse/pull/81450) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлен возможный сбой в `Aggregator` в случае исключения во время слияния. [#82022](https://github.com/ClickHouse/ClickHouse/pull/82022) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена ошибка копирования и вставки в arraySimilarity, которая запрещала использование весов типов UInt32 и Int32. Обновлены тесты и документация. [#82103](https://github.com/ClickHouse/ClickHouse/pull/82103) ([Mikhail F. Shiryaev](https://github.com/Felixoid)).
* Исправлено переполнение в функциях `numericIndexedVectorPointwiseAdd`, `numericIndexedVectorPointwiseSubtract`, `numericIndexedVectorPointwiseMultiply`, `numericIndexedVectorPointwiseDivide`, которое происходило при их применении к большим числам. [#82165](https://github.com/ClickHouse/ClickHouse/pull/82165) ([Raufs Dunamalijevs](https://github.com/rienath)).

### Исправления Parquet и форматов файлов \{#parquet-and-file-format-fixes\}

* Исправлено некорректное применение bloom-фильтра Parquet для условия вида `WHERE function(key) IN (...)` так, как будто это `WHERE key IN (...)`. [#81255](https://github.com/ClickHouse/ClickHouse/pull/81255) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена некорректная запись статистики (min/max) для типов Decimal в writer'е Parquet. [#83754](https://github.com/ClickHouse/ClickHouse/pull/83754) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена десериализация `groupArraySample`/`groupArrayLast` в случае пустых элементов (десериализация могла пропустить часть бинарных данных, если входные данные были пустыми, что могло привести к повреждению данных при чтении и ошибке UNKNOWN_PACKET_FROM_SERVER в протоколе TCP). Это не затрагивает числовые типы и типы даты и времени. [#82763](https://github.com/ClickHouse/ClickHouse/pull/82763) ([Pedro Ferreira](https://github.com/PedroTadim)).
* Исправлена запись JSON-путей со значениями NULL в формате RowBinary. [#83923](https://github.com/ClickHouse/ClickHouse/pull/83923) ([Pavel Kruglov](https://github.com/Avogar)).

### Исправления JOIN \{#join-fixes\}

* Исправлена модификация фильтра для запросов с выражением JOIN с таблицей с движком `Merge`. Исправляет [#82092](https://github.com/ClickHouse/ClickHouse/issues/82092). [#82950](https://github.com/ClickHouse/ClickHouse/pull/82950) ([Dmitry Novik](https://github.com/novikd)).
* Исправлен сбой при JOIN с key-value-хранилищем, если ключ приведён к другому типу. [#82497](https://github.com/ClickHouse/ClickHouse/pull/82497) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлена логическая ошибка при разрешении matcher в запросе с несколькими JOIN, закрывает [#81969](https://github.com/ClickHouse/ClickHouse/issues/81969). [#82421](https://github.com/ClickHouse/ClickHouse/pull/82421) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлено встраивание фильтра в условие JOIN в случаях, когда операнды равенства имеют разные типы или ссылаются на константы. Исправляет [#83432](https://github.com/ClickHouse/ClickHouse/issues/83432). [#84145](https://github.com/ClickHouse/ClickHouse/pull/84145) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена логическая ошибка `Expected single dictionary argument for function` при выполнении JOIN по условию неравенства, когда один из столбцов имеет тип `LowCardinality`, а другой является константой. Закрывает [#81779](https://github.com/ClickHouse/ClickHouse/issues/81779). [#84019](https://github.com/ClickHouse/ClickHouse/pull/84019) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Исправления в реплицируемых базах данных \{#replicated-database-fixes\}

* Исправлен `markReplicasActive` в `DDLWorker` и `DatabaseReplicatedDDLWorker`. [#81395](https://github.com/ClickHouse/ClickHouse/pull/81395) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлен `DatabaseReplicated::getClusterImpl`. Если первый элемент (или элементы) `hosts` имеет `id == DROPPED_MARK` и нет других элементов для того же шарда, первый элемент `shards` будет пустым вектором, что приводит к `std::out_of_range`. [#82093](https://github.com/ClickHouse/ClickHouse/pull/82093) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Реализован учет количества задач по асинхронной загрузке таблиц. Если есть выполняющиеся задачи, `tail_ptr` в `TransactionLog::removeOldEntries` не обновляется. [#82824](https://github.com/ClickHouse/ClickHouse/pull/82824) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлена проблема, при которой, если таблица MergeTree создается с `add_minmax_index_for_numeric_columns=1` или `add_minmax_index_for_string_columns=1`, индекс позднее материализуется во время операции ALTER и препятствует корректной инициализации реплицируемой базы данных на новой реплике. [#83751](https://github.com/ClickHouse/ClickHouse/pull/83751) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлено создание RMV на новой реплике реплицируемой базы данных, если `DEFINER` был удален. [#85327](https://github.com/ClickHouse/ClickHouse/pull/85327) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлено восстановление реплицируемых баз данных в случае, когда перемещение файла метаданных занимает много времени. [#85177](https://github.com/ClickHouse/ClickHouse/pull/85177) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Реализовано принудительное восстановление базы данных Replicated после восстановления метаданных базы данных в Keeper. [#85960](https://github.com/ClickHouse/ClickHouse/pull/85960) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлена ошибка при восстановлении базы данных Replicated: если имя таблицы содержит символ `%`, во время восстановления таблица могла быть пересоздана с другим именем. [#85987](https://github.com/ClickHouse/ClickHouse/pull/85987) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Теперь DDL worker очищает набор реплик от устаревших хостов. Это уменьшит объем хранимых метаданных в ZooKeeper. [#88154](https://github.com/ClickHouse/ClickHouse/pull/88154) ([alesapin](https://github.com/alesapin)).

### Исправления для легковесных обновлений \{#lightweight-updates-fixes\}

* Исправлены легковесные обновления для таблиц с движками `ReplacingMergeTree` и `CollapsingMergeTree`. [#84851](https://github.com/ClickHouse/ClickHouse/pull/84851) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена логическая ошибка в легковесных обновлениях, которые изменяют все столбцы в таблице. [#84380](https://github.com/ClickHouse/ClickHouse/pull/84380) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены легковесные обновления для таблиц с движком `ReplicatedMergeTree`, созданных на серверах с версией ниже 25.7. [#84933](https://github.com/ClickHouse/ClickHouse/pull/84933) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены легковесные обновления для таблиц с нереплицированным движком `MergeTree` после выполнения запроса `ALTER TABLE ... REPLACE PARTITION`. [#84941](https://github.com/ClickHouse/ClickHouse/pull/84941) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена очистка патч-частей в `ReplicatedMergeTree`. Ранее результат легковесного обновления мог временно не отображаться на реплике до тех пор, пока объединённая или модифицированная часть, материализующая патч-части, не была загружена с другой реплики. [#85121](https://github.com/ClickHouse/ClickHouse/pull/85121) ([Anton Popov](https://github.com/CurtizJ)).

### Исправления для S3 и объектного хранилища \{#s3-and-object-storage-fixes\}

* Исправлена проверка аргументов функции таблицы S3 при маскировании секретов, предотвращающая возможную ошибку `LOGICAL_ERROR`, закрыт [#80620](https://github.com/ClickHouse/ClickHouse/issues/80620). [#82056](https://github.com/ClickHouse/ClickHouse/pull/82056) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлена возможная взаимоблокировка для удалённых запросов, когда сервер находится под нагрузкой по памяти. [#82160](https://github.com/ClickHouse/ClickHouse/pull/82160) ([Kirill](https://github.com/kirillgarbar)).
* Добавлен срок действия для токена AWS ECS, чтобы его можно было обновлять. [#82422](https://github.com/ClickHouse/ClickHouse/pull/82422) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлено отключение выравнивания по границе для кешированного буфера во внешних движках таблиц. Поведение было нарушено в https://github.com/ClickHouse/ClickHouse/pull/81868. [#82493](https://github.com/ClickHouse/ClickHouse/pull/82493) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен `no_sign_request` для клиента S3. Его можно использовать для явного отключения подписи запросов к S3. Он также может быть задан для отдельных endpoint'ов с помощью настроек по endpoint'ам. [#83379](https://github.com/ClickHouse/ClickHouse/pull/83379) ([Antonio Andelic](https://github.com/antonio2368)).
* Теперь недоступные узлы пропускаются при выполнении INSERT SELECT из s3Cluster() в реплицируемый MergeTree. [#83676](https://github.com/ClickHouse/ClickHouse/pull/83676) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлено условие раннего выхода для замедления частоты запросов к S3: теперь для включения замедления, когда все потоки приостановлены из-за повторяемой ошибки, достаточно, чтобы было истинно либо s3_slow_all_threads_after_network_error, либо backup_slow_all_threads_after_retryable_s3_error, вместо требования истинности обоих. [#85505](https://github.com/ClickHouse/ClickHouse/pull/85505) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлена логическая ошибка при чтении из функций объектного хранилища через Distributed-таблицу или удалённую табличную функцию. Исправляет: [#84658](https://github.com/ClickHouse/ClickHouse/issues/84658), исправляет [#85173](https://github.com/ClickHouse/ClickHouse/issues/85173), исправляет [#52022](https://github.com/ClickHouse/ClickHouse/issues/52022). [#85359](https://github.com/ClickHouse/ClickHouse/pull/85359) ([alesapin](https://github.com/alesapin)).
* Исправлена логическая ошибка в S3Queue «Table is already registered». Закрывает [#84433](https://github.com/ClickHouse/ClickHouse/issues/84433). Ошибка появилась после https://github.com/ClickHouse/ClickHouse/pull/83530. [#84677](https://github.com/ClickHouse/ClickHouse/pull/84677) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено влияние больших значений настроек, которые приводили к некорректной работе таблиц S3Queue и сбоям при перезапуске реплики. [#86074](https://github.com/ClickHouse/ClickHouse/pull/86074) ([Nikolay Degterinsky](https://github.com/evillique)).

### Исправления для типов Dynamic и Variant \{#dynamicandvarianttypefixes\}

* Исправлен откат столбца типа Dynamic при ошибке разбора. [#82169](https://github.com/ClickHouse/ClickHouse/pull/82169) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено возможное аварийное завершение при использовании типа Variant в UNION. [#83295](https://github.com/ClickHouse/ClickHouse/pull/83295) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено чтение столбца типа Variant с ленивой материализацией. [#84400](https://github.com/ClickHouse/ClickHouse/pull/84400) ([Pavel Kruglov](https://github.com/Avogar)).
* Отключена проверка экспериментальных/подозрительных типов при выполнении выражений DEFAULT/MATERIALIZE при чтении из существующей таблицы. [#81618](https://github.com/ClickHouse/ClickHouse/pull/81618) ([Pavel Kruglov](https://github.com/Avogar)).

### Исправления Keeper \{#keeper-fixes\}

* Исправление в Keeper: корректно обновляется общее количество наблюдений (watch count) при удалении эфемерных узлов при закрытии сессии. [#83583](https://github.com/ClickHouse/ClickHouse/pull/83583) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена запись в журнал изменений Keeper (changelog) в неверном порядке. Ранее могли существовать незавершённые записи в changelog, но откат (rollback) мог вызывать конкурентное изменение целевого файла. Это приводило к неконсистентным логам и возможной потере данных. [#84434](https://github.com/ClickHouse/ClickHouse/pull/84434) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлены утечки ресурсов для Keeper с хранилищем на RocksDB (итераторы не уничтожались). [#84523](https://github.com/ClickHouse/ClickHouse/pull/84523) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема, при которой настройка Keeper `rotate_log_storage_interval = 0` могла приводить к сбою ClickHouse. (issue [#83975](https://github.com/ClickHouse/ClickHouse/issues/83975)). [#84637](https://github.com/ClickHouse/ClickHouse/pull/84637) ([George Larionov](https://github.com/george-larionov)).
* Исправлен общий счётчик наблюдений (watches), возвращаемый Keeper. [#84890](https://github.com/ClickHouse/ClickHouse/pull/84890) ([Antonio Andelic](https://github.com/antonio2368)).
* Теперь `mutex` блокируется при получении zookeeper из `view` в RefreshTask. [#84699](https://github.com/ClickHouse/ClickHouse/pull/84699) ([Tuan Pham Anh](https://github.com/tuanpach)).

### Исправления индексации \{#indexing-fixes\}

* Исправлено избыточное пропускание гранул при фильтрации по token/ngram-индексам с регулярным выражением, которое содержит альтернативы и нелитеральную первую альтернативу. [#79373](https://github.com/ClickHouse/ClickHouse/pull/79373) ([Eduard Karacharov](https://github.com/korowa)).
* Реализация настройки `use_skip_indexes_if_final_exact_mode` (введённой в 25.6) могла не выбрать релевантный диапазон-кандидат в зависимости от настроек движка `MergeTree` и распределения данных. Это было исправлено. [#82667](https://github.com/ClickHouse/ClickHouse/pull/82667) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Оптимизация настройки `use_skip_indexes_if_final_exact_mode` (введённой в 25.6) могла не выбрать релевантный диапазон-кандидат в зависимости от настроек движка `MergeTree` и распределения данных. Это было исправлено. [#82879](https://github.com/ClickHouse/ClickHouse/pull/82879) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Ранее индексы `set` не учитывали колонки `Nullable` при проверке, прошли ли гранулы фильтр (проблема [#75485](https://github.com/ClickHouse/ClickHouse/issues/75485)). [#84305](https://github.com/ClickHouse/ClickHouse/pull/84305) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Сравнение со значением `NaN` использовало некорректные диапазоны во время оценки индекса `MinMax`. [#84386](https://github.com/ClickHouse/ClickHouse/pull/84386) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Токенизаторы `ngram` и `no_op` больше не приводят к аварийному завершению работы (экспериментального) текстового индекса при пустых входных токенах. [#84849](https://github.com/ClickHouse/ClickHouse/pull/84849) ([Robert Schulze](https://github.com/rschu1ze)).

### Исправления материализованных представлений \{#materialized-view-fixes\}

* Исправлена ошибка в зависимостях таблиц, из-за которой материализованные представления пропускали запросы INSERT. [#82222](https://github.com/ClickHouse/ClickHouse/pull/82222) ([Nikolay Degterinsky](https://github.com/evillique)).
* После https://github.com/ClickHouse/ClickHouse/pull/79963 использование подстолбцов в материализованных представлениях перестало работать корректно, и пользователь мог получать ошибку `Not found column X in block`. Это поведение исправлено. Исправляет: [#82784](https://github.com/ClickHouse/ClickHouse/issues/82784). [#83221](https://github.com/ClickHouse/ClickHouse/pull/83221) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена ошибка illegal_type_of_argument в материализованных представлениях, если типы отличаются. [#85135](https://github.com/ClickHouse/ClickHouse/pull/85135) ([Sema Checherinda](https://github.com/CheSema)).

### Исправления для Azure и облачных хранилищ \{#azure-and-cloud-storage-fixes\}

* В `AzureBlobStorage` для нативного копирования мы сравниваем методы аутентификации, и если при этом возникает исключение, мы обновили код так, чтобы выполнять откат к чтению и копированию (т.е. к ненативному копированию). [#82693](https://github.com/ClickHouse/ClickHouse/pull/82693) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Исправлено двойное освобождение памяти в `AzureIteratorAsync`. [#85064](https://github.com/ClickHouse/ClickHouse/pull/85064) ([Nikita Taranov](https://github.com/nickitat)).

### Исправления сбоев и проблем со стабильностью \{#crash-and-stability-fixes\}

* Исправлен возможный сбой при логировании во время завершения сессии, когда `user_id` может быть пустым. [#82513](https://github.com/ClickHouse/ClickHouse/pull/82513) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлен сбой в клиенте из‑за соединения, оставленного в состоянии `disconnected` после некорректного `INSERT`. [#83253](https://github.com/ClickHouse/ClickHouse/pull/83253) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен сбой при вычислении размера блока с пустыми столбцами. [#83271](https://github.com/ClickHouse/ClickHouse/pull/83271) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлен сбой, который мог возникать для запроса с настройкой `max_threads=1` при выполнении под нагрузкой с включённым планировщиком CPU. [#83387](https://github.com/ClickHouse/ClickHouse/pull/83387) ([Fan Ziqi](https://github.com/f2quantum)).
* Ошибка `zoutofmemory` теперь считается аппаратной, в противном случае будет выбрасываться логическая ошибка. См. https://github.com/clickhouse/clickhouse-core-incidents/issues/877. [#84420](https://github.com/ClickHouse/ClickHouse/pull/84420) ([Han Fei](https://github.com/hanfei1991)).
* Исправлено возможное аварийное завершение (из‑за присоединения потоков из задачи) и, надеемся, зависания (в модульных тестах) во время завершения работы `BackgroundSchedulePool`. [#83769](https://github.com/ClickHouse/ClickHouse/pull/83769) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена взаимная блокировка, вызванная фоновым потоком проверки отмены. [#84203](https://github.com/ClickHouse/ClickHouse/pull/84203) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена взаимная блокировка при завершении работы из‑за рекурсивной блокировки контекста во время очистки библиотечного моста. [#83824](https://github.com/ClickHouse/ClickHouse/pull/83824) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен сбой в клиенте из‑за соединения, оставленного в состоянии `disconnected` после некорректного `INSERT`. [#83842](https://github.com/ClickHouse/ClickHouse/pull/83842) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено возможное неопределённое поведение (вплоть до сбоев) в случае `MEMORY_LIMIT_EXCEEDED` при десериализации `String`. [#85440](https://github.com/ClickHouse/ClickHouse/pull/85440) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен редкий сбой в асинхронных вставках, которые изменяют настройки `log_comment` или `insert_deduplication_token`. [#85540](https://github.com/ClickHouse/ClickHouse/pull/85540) ([Anton Popov](https://github.com/CurtizJ)).

### Исправления для Glue и каталогов \{#glue-and-catalog-fixes\}

* Исправлена ошибка в интеграции с Glue Catalog. Теперь ClickHouse может читать таблицы с вложенными типами данных, где некоторые из подколонок содержат значения типа Decimal, например: `map<string, decimal(9, 2)>`. Исправляет [#81301](https://github.com/ClickHouse/ClickHouse/issues/81301). [#82114](https://github.com/ClickHouse/ClickHouse/pull/82114) ([alesapin](https://github.com/alesapin)).
* ClickHouse теперь читает таблицы из Glue Catalog, где тип таблицы указан в нижнем регистре. [#84316](https://github.com/ClickHouse/ClickHouse/pull/84316) ([alesapin](https://github.com/alesapin)).
* Unity Catalog теперь игнорирует схемы с некорректными типами данных для таблиц, не являющихся Delta. Исправляет [#85699](https://github.com/ClickHouse/ClickHouse/issues/85699). [#85950](https://github.com/ClickHouse/ClickHouse/pull/85950) ([alesapin](https://github.com/alesapin)).

### Исправления функций \{#function-fixes\}

* Функции `trim{Left,Right,Both}` теперь поддерживают входные строки типа `FixedString(N)`. Например, теперь работает запрос `SELECT trimBoth(toFixedString('abc', 3), 'ac')`. [#82691](https://github.com/ClickHouse/ClickHouse/pull/82691) ([Robert Schulze](https://github.com/rschu1ze)).
* Если функция `trim` вызывается со всеми константными аргументами, она теперь возвращает константную выходную строку. (Ошибка [#78796](https://github.com/ClickHouse/ClickHouse/issues/78796)). [#82900](https://github.com/ClickHouse/ClickHouse/pull/82900) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлен некорректный результат функции `formatDateTime`, когда спецификатор `%f` используется совместно со спецификаторами переменной длины (например, `%M`). [#83020](https://github.com/ClickHouse/ClickHouse/pull/83020) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена ошибка для аргументов `NULL` в функции `CASE`. [#82436](https://github.com/ClickHouse/ClickHouse/pull/82436) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Функция `lowCardinalityKeys` больше не использует несвязанные части общего словаря. [#83118](https://github.com/ClickHouse/ClickHouse/pull/83118) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлены функции colorSRGBToOKLCH/colorOKLCHToSRGB для сочетания константных и неконстантных аргументов. [#83906](https://github.com/ClickHouse/ClickHouse/pull/83906) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено некорректное построение пустых кортежей в функции `array()`. Это исправляет проблему [#84202](https://github.com/ClickHouse/ClickHouse/issues/84202). [#84297](https://github.com/ClickHouse/ClickHouse/pull/84297) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка, приводившая к некорректному кодированию и декодированию Bech32. Ошибка изначально не была выявлена, поскольку онлайн-реализация алгоритма, использованная для тестирования, содержала ту же проблему. [#84257](https://github.com/ClickHouse/ClickHouse/pull/84257) ([George Larionov](https://github.com/george-larionov)).

### Исправления распределённых запросов \{#distributed-query-fixes\}

* Параллельный распределённый `INSERT SELECT` с `LIMIT` был разрешён, что было некорректно и приводило к дублированию данных в целевой таблице. [#84477](https://github.com/ClickHouse/ClickHouse/pull/84477) ([Igor Nikonov](https://github.com/devcrafter)).
* Не подставлять табличные функции их кластерными альтернативами при наличии оператора `JOIN` или подзапроса. [#84335](https://github.com/ClickHouse/ClickHouse/pull/84335) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Добавлена проверка использования коррелированного подзапроса в распределённом контексте, чтобы избежать сбоя. Исправляет [#82205](https://github.com/ClickHouse/ClickHouse/issues/82205). [#85030](https://github.com/ClickHouse/ClickHouse/pull/85030) ([Dmitry Novik](https://github.com/novikd)).
* Использование `distributed_depth` как индикатора функции `*Cluster` было некорректным и могло приводить к дублированию данных; вместо этого используется `client_info.collaborate_with_initiator`. [#85734](https://github.com/ClickHouse/ClickHouse/pull/85734) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Добавлена поддержка глобальных констант из выражения `WITH` для параллельного распределённого `INSERT SELECT` с целевой таблицей `Distributed`. Ранее запрос мог завершаться ошибкой `Unknown expression identifier`. [#85811](https://github.com/ClickHouse/ClickHouse/pull/85811) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена логическая ошибка при попытке выполнить `CREATE ... AS (SELECT * FROM s3Cluster(...))` с `DatabaseReplicated`. [#85904](https://github.com/ClickHouse/ClickHouse/pull/85904) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Добавлены проверки ключа шардирования `sharding_key` при выполнении операции ALTER таблицы типа Distributed. Ранее некорректный ALTER мог приводить к повреждению определения таблицы и требовать перезапуска сервера. [#86015](https://github.com/ClickHouse/ClickHouse/pull/86015) ([Nikolay Degterinsky](https://github.com/evillique)).

### Исправления метрик и мониторинга \{#metrics-and-monitoring-fixes\}

* Исправлена проверка настроек асинхронных метрик `asynchronous_metrics_update_period_s` и `asynchronous_heavy_metrics_update_period_s`. [#82310](https://github.com/ClickHouse/ClickHouse/pull/82310) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлены метрики `IndexUncompressedCacheBytes`/`IndexUncompressedCacheCells`/`IndexMarkCacheBytes`/`IndexMarkCacheFiles` (ранее они учитывались в метрике без префикса `Cache`). [#83730](https://github.com/ClickHouse/ClickHouse/pull/83730) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка `LOGICAL_ERROR` в QueryMetricLog: Mutex не может быть `NULL`. [#82979](https://github.com/ClickHouse/ClickHouse/pull/82979) ([Pablo Marcos](https://github.com/pamarcos)).
* Исправлены некорректные значения метрик KafkaAssignedPartitions и KafkaConsumersWithAssignment. [#85494](https://github.com/ClickHouse/ClickHouse/pull/85494) ([Ilya Golshtein](https://github.com/ilejn)).
* Исправлена недооценка статистики по обработанным байтам, когда используется `PREWHERE` (явно или автоматически). [#85495](https://github.com/ClickHouse/ClickHouse/pull/85495) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлен дрейф учёта памяти в планировщике фоновых задач и исполнителе. [#84946](https://github.com/ClickHouse/ClickHouse/pull/84946) ([Azat Khuzhin](https://github.com/azat)).

### Исправления типов данных и преобразований \{#data-type-and-conversion-fixes\}

* Исправлены случаи, когда парсинг значения типа Time мог вызывать проблемы с MSan. Это исправляет [#82477](https://github.com/ClickHouse/ClickHouse/issues/82477). [#82514](https://github.com/ClickHouse/ClickHouse/pull/82514) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена сортировка значений NaN в типе `LowCardinality(Float32|Float64|BFloat16)`. [#83786](https://github.com/ClickHouse/ClickHouse/pull/83786) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлено переполнение больших значений (\>2106-02-07) при приведении типа из `Date` к `DateTime64`. [#83982](https://github.com/ClickHouse/ClickHouse/pull/83982) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена проблема с неявным чтением отрицательных значений Time в таблицу и сделана документация менее запутанной. [#83091](https://github.com/ClickHouse/ClickHouse/pull/83091) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Кодек `DoubleDelta` теперь может применяться только к столбцам числового типа. В частности, столбцы `FixedString` больше не могут сжиматься с помощью `DoubleDelta` (исправляет [#80220](https://github.com/ClickHouse/ClickHouse/issues/80220)). [#84383](https://github.com/ClickHouse/ClickHouse/pull/84383) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
* Исправлена потеря точности в `JSONExtract` при преобразовании чисел JSON в типы Decimal. Теперь числовые значения JSON сохраняют своё точное десятичное представление, избегая ошибок округления с плавающей запятой. [#85665](https://github.com/ClickHouse/ClickHouse/pull/85665) ([ssive7b](https://github.com/ssive7b)).

### Управление памятью и ресурсами \{#memory-and-resource-management\}

* Исправлено некорректное использование памяти, связанное с `max_untracked_memory`. [#83607](https://github.com/ClickHouse/ClickHouse/pull/83607) ([Azat Khuzhin](https://github.com/azat)).
* Исключено совместное использование `async_read_counters` между запросами. [#83423](https://github.com/ClickHouse/ClickHouse/pull/83423) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены возможные ошибки «file cache not initialized» при использовании файлового кэша как временного хранилища данных. [#83539](https://github.com/ClickHouse/ClickHouse/pull/83539) ([Bharat Nallan](https://github.com/bharatnc)).
* Ограничение `filesystem_prefetches_limit` теперь всегда применяется (не только из `MergeTreePrefetchedReadPool`). [#83999](https://github.com/ClickHouse/ClickHouse/pull/83999) ([Azat Khuzhin](https://github.com/azat)).

### Исправления конфигурации и настроек \{#configuration-and-settings-fixes\}

* При передаче настроек через URI учитывается только последнее значение. [#82137](https://github.com/ClickHouse/ClickHouse/pull/82137) ([Sema Checherinda](https://github.com/CheSema)).
* Исправлены гонки данных в клиенте (за счёт отказа от использования глобального контекста) и переопределения `session_timezone` (ранее, если `session_timezone` был установлен, например, в `users.xml`/опциях клиента в непустое значение, а в контексте запроса — в пустое, то использовалось значение из `users.xml`, что неверно; теперь контекст запроса всегда имеет приоритет над глобальным контекстом). [#82444](https://github.com/ClickHouse/ClickHouse/pull/82444) ([Azat Khuzhin](https://github.com/azat)).
* Запрещено устанавливать `threadpool_writer_pool_size` в ноль, чтобы избежать зависаний серверных операций. [#82532](https://github.com/ClickHouse/ClickHouse/pull/82532) ([Bharat Nallan](https://github.com/bharatnc)).
* Устранено незначительное переполнение целого при конфигурировании настройки `role_cache_expiration_time_seconds` (проблема [#83374](https://github.com/ClickHouse/ClickHouse/issues/83374)). [#83461](https://github.com/ClickHouse/ClickHouse/pull/83461) ([wushap](https://github.com/wushap)).
* Запрещено нулевое значение для `max_insert_block_size`, так как оно могло приводить к логической ошибке. [#83688](https://github.com/ClickHouse/ClickHouse/pull/83688) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлен бесконечный цикл в `estimateCompressionRatio()` при `block_size_bytes=0`. [#83704](https://github.com/ClickHouse/ClickHouse/pull/83704) ([Azat Khuzhin](https://github.com/azat)).
* Параметры вроде `date_time_input_format` просто игнорировались при использовании HTTP multipart. [#85570](https://github.com/ClickHouse/ClickHouse/pull/85570) ([Sema Checherinda](https://github.com/CheSema)).

### Исправления MongoDB \{#mongodb-fixes\}

* Ранее определения движка таблицы `MongoDB` могли включать компонент пути в аргументе `host:port`, который незаметно игнорировался. Интеграция с MongoDB отказывалась загружать такие таблицы. С данным исправлением *теперь можно загружать такие таблицы, при этом компонент пути игнорируется*, если движок `MongoDB` имеет пять аргументов, а имя базы данных берётся из аргументов. *Примечание:* Исправление не применяется к вновь создаваемым таблицам или запросам с табличной функцией `mongo`, а также к источникам словарей и именованным коллекциям. [#81942](https://github.com/ClickHouse/ClickHouse/pull/81942) ([Vladimir Cherkasov](https://github.com/vdimir)).

### Прочие исправления \{#miscellaneous-fixes\}

* В предыдущих версиях сервер возвращал лишний контент в ответ на запросы к `/js`. Это закрывает [#61890](https://github.com/ClickHouse/ClickHouse/issues/61890). [#81895](https://github.com/ClickHouse/ClickHouse/pull/81895) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлен метод `InterpreterInsertQuery::extendQueryLogElemImpl`, чтобы при необходимости добавлялись обратные кавычки вокруг имён баз данных и таблиц (например, когда имена содержат специальные символы, такие как `-`). [#81528](https://github.com/ClickHouse/ClickHouse/pull/81528) ([Ilia Shvyrialkin](https://github.com/Harzu)).
* Исправлена возможная гонка данных между потоком подсказок и основным потоком клиента. [#82233](https://github.com/ClickHouse/ClickHouse/pull/82233) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена безопасность при возникновении исключений в переписывании union/intersect/except&#95;default&#95;mode. Закрывает [#82664](https://github.com/ClickHouse/ClickHouse/issues/82664). [#82820](https://github.com/ClickHouse/ClickHouse/pull/82820) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* При использовании некеширующей реализации Database метаданные соответствующей таблицы удаляются после возврата столбцов и аннулирования ссылки. [#82939](https://github.com/ClickHouse/ClickHouse/pull/82939) ([buyval01](https://github.com/buyval01)).
* Вызов onprogress в JSONEachRowWithProgress теперь синхронизирован с финализацией. [#83879](https://github.com/ClickHouse/ClickHouse/pull/83879) ([Sema Checherinda](https://github.com/CheSema)).
* Исправлена редкая ошибка, из-за которой запрос `MATERIALIZE COLUMN` мог приводить к появлению неожиданных файлов в `checksums.txt` и в итоге — к отсоединению частей данных. [#84007](https://github.com/ClickHouse/ClickHouse/pull/84007) ([alesapin](https://github.com/alesapin)).
* Обеспечена корректная обработка исключений при периодическом обновлении частей. [#84083](https://github.com/ClickHouse/ClickHouse/pull/84083) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена генерация имен столбцов для булевых литералов: теперь используются &quot;true&quot;/&quot;false&quot; вместо &quot;1&quot;/&quot;0&quot;, что предотвращает конфликты имен столбцов между булевыми и целочисленными литералами в запросах. [#84945](https://github.com/ClickHouse/ClickHouse/pull/84945) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Исправлены потенциальные проблемы с некорректной сортировкой в движке таблиц Merge. [#85025](https://github.com/ClickHouse/ClickHouse/pull/85025) ([Xiaozhe Yu](https://github.com/wudidapaopao)).
* Реализованы недостающие API для DiskEncrypted. [#85028](https://github.com/ClickHouse/ClickHouse/pull/85028) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена настройка обратной совместимости, позволяющая новому анализатору в случае конфликта имён ссылаться на внешний псевдоним в секции `WITH`. Исправляет [#82700](https://github.com/ClickHouse/ClickHouse/issues/82700). [#83797](https://github.com/ClickHouse/ClickHouse/pull/83797) ([Dmitry Novik](https://github.com/novikd)).
* Разрешена возможность ссылаться на любую таблицу в аргументе `view(...)` табличной функции `remote` при включённом анализаторе. Исправлены [#78717](https://github.com/ClickHouse/ClickHouse/issues/78717) и [#79377](https://github.com/ClickHouse/ClickHouse/issues/79377). [#83844](https://github.com/ClickHouse/ClickHouse/pull/83844) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена работа записи с добавлением (в MergeTree, используемом для экспериментальных транзакций) для типов метаданных `plain_rewritable`/`plain`, которые ранее просто игнорировались. [#83695](https://github.com/ClickHouse/ClickHouse/pull/83695) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлено использование логгера в `IAccessStorage`. [#84365](https://github.com/ClickHouse/ClickHouse/pull/84365) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлено отсечение файлов по виртуальному столбцу в озёрах данных. [#84520](https://github.com/ClickHouse/ClickHouse/pull/84520) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проблема, из-за которой при выполнении запроса к удалённому источнику с задержкой мог происходить выход за границы вектора. [#84820](https://github.com/ClickHouse/ClickHouse/pull/84820) ([George Larionov](https://github.com/george-larionov)).
* Корректно сохранять все настройки в метаданных таблицы движка очереди объектов. [#84860](https://github.com/ClickHouse/ClickHouse/pull/84860) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка `CORRUPTED_DATA`, возникающая при использовании ленивых столбцов с внешней сортировкой. [#84738](https://github.com/ClickHouse/ClickHouse/pull/84738) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Убраны лишние вызовы `getStatus()` при выполнении запросов `SYSTEM DROP REPLICA`. Исправлена ситуация, когда таблица удаляется в фоновом режиме и выбрасывается исключение `Shutdown for storage is called`. [#85220](https://github.com/ClickHouse/ClickHouse/pull/85220) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлены пропущенные проверки длины имени таблицы в запросах `CREATE OR REPLACE` и `RENAME`. [#85326](https://github.com/ClickHouse/ClickHouse/pull/85326) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлено падение и повреждение данных при выполнении `ALTER UPDATE` для JSON. [#85383](https://github.com/ClickHouse/ClickHouse/pull/85383) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка сегментации в CoalescingMergeTree при работе с длинными строками. Закрывает [#84582](https://github.com/ClickHouse/ClickHouse/issues/84582). [#85709](https://github.com/ClickHouse/ClickHouse/pull/85709) ([scanhex12](https://github.com/scanhex12)).
* Исправлено регулярное выражение send&#95;logs&#95;source&#95;regexp (после рефакторинга асинхронного логирования в [#85105](https://github.com/ClickHouse/ClickHouse/issues/85105)). [#85797](https://github.com/ClickHouse/ClickHouse/pull/85797) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена возможная неконсистентность в словарях с `update_field` при ошибках `MEMORY_LIMIT_EXCEEDED`. [#85807](https://github.com/ClickHouse/ClickHouse/pull/85807) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены HTTP-запросы, выполняемые табличной функцией `url()`, так, чтобы корректно включать номера портов в заголовок Host при обращении к нестандартным портам. Это устраняет сбои аутентификации при использовании предварительно подписанных URL-адресов с S3-совместимыми сервисами, такими как MinIO, работающими на нестандартных портах, что часто встречается в средах разработки. (Исправляет [#85898](https://github.com/ClickHouse/ClickHouse/issues/85898)). [#85921](https://github.com/ClickHouse/ClickHouse/pull/85921) ([Tom Quist](https://github.com/tomquist)).