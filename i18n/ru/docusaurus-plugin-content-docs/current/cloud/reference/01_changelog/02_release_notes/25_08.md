---
slug: /changelogs/25.8
title: 'Список изменений v25.8 для Cloud'
description: 'Краткий список изменений v25.8'
keywords: ['changelog', 'cloud']
sidebar_label: '25.8'
sidebar_position: 2
doc_type: 'changelog'
---

## Изменения, нарушающие обратную совместимость {#backward-incompatible-changes}

### Изменения JSON и форматов данных {#json-and-data-format-changes}

* По умолчанию отключено заключение 64-битных целых чисел в кавычки в форматах JSON. [#74079](https://github.com/ClickHouse/ClickHouse/pull/74079) ([Pavel Kruglov](https://github.com/Avogar)).
* В JSON для массивов значений с разными типами теперь выводится `Array(Dynamic)` вместо безымянного `Tuple`. Чтобы использовать прежнее поведение, отключите настройку [`input_format_json_infer_array_of_dynamic_from_array_of_different_types`](/operations/settings/formats#input_format_json_infer_array_of_dynamic_from_array_of_different_types). [#80859](https://github.com/ClickHouse/ClickHouse/pull/80859) ([Pavel Kruglov](https://github.com/Avogar)).
* По умолчанию значения типа `Enum` записываются как `BYTE_ARRAY` с логическим типом `ENUM` в формате вывода Parquet. [#84169](https://github.com/ClickHouse/ClickHouse/pull/84169) ([Pavel Kruglov](https://github.com/Avogar)).

### Хранение и партиционирование {#storage-and-partitioning}

* Добавлена поддержка записи в стиле партиционирования Hive и переработана реализация чтения (столбцы партиционирования Hive больше не являются виртуальными). [#76802](https://github.com/ClickHouse/ClickHouse/pull/76802) ([Arthur Passos](https://github.com/arthurpassos)).
* Настройка MergeTree [`write_marks_for_substreams_in_compact_parts`](/operations/settings/merge-tree-settings#write_marks_for_substreams_in_compact_parts) теперь включена по умолчанию. Это существенно улучшает производительность чтения подстолбцов из недавно созданных Compact-частей. Серверы с версией ниже 25.5 не смогут читать новые Compact-части. [#84171](https://github.com/ClickHouse/ClickHouse/pull/84171) ([Pavel Kruglov](https://github.com/Avogar)).
* Запрещены операции `RENAME COLUMN` или `DROP COLUMN`, которые затрагивают явно указанные столбцы для суммирования в SummingMergeTree. Закрывает [#81836](https://github.com/ClickHouse/ClickHouse/issues/81836). [#82821](https://github.com/ClickHouse/ClickHouse/pull/82821) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Улучшения функций {#function-enhancements}

* Добавлен новый аргумент `unexpected_quoting_character_strategy` в функцию [`extractKeyValuePairs`](/sql-reference/functions/tuple-map-functions#extractKeyValuePairs) [`extractKeyValuePairs`](/sql-reference/functions/tuple-map-functions#extractkeyvaluepairs), который определяет поведение при неожиданном обнаружении `quoting_character`. Для получения дополнительных сведений см. документацию по [`extractKeyValuePairs`](/sql-reference/functions/tuple-map-functions#extractKeyValuePairs) [`extractKeyValuePairs`](/sql-reference/functions/tuple-map-functions#extractkeyvaluepairs). [#80657](https://github.com/ClickHouse/ClickHouse/pull/80657) ([Arthur Passos](https://github.com/arthurpassos)).
* Ранее функция [`countMatches`](/sql-reference/functions/string-search-functions#countMatches) прекращала подсчет при первом пустом совпадении, даже если шаблон его допускает. Чтобы устранить эту проблему, `countMatches` теперь продолжает выполнение, сдвигаясь вперед на один символ при возникновении пустого совпадения. Пользователи, которые хотят сохранить старое поведение, могут включить настройку `count_matches_stop_at_empty_match`. [#81676](https://github.com/ClickHouse/ClickHouse/pull/81676) ([Elmi Ahmadov](https://github.com/ahmadov)).

### Улучшения типов данных {#data-type-improvements}

* Повышена точность преобразования из `Decimal` в `Float32`. Реализовано преобразование из `Decimal` в `BFloat16`. Закрывает [#82660](https://github.com/ClickHouse/ClickHouse/issues/82660). [#82823](https://github.com/ClickHouse/ClickHouse/pull/82823) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Управление производительностью и ресурсами {#performance-and-resource-management}

* Ранее запросы `BACKUP`, слияния и мутации не использовали общесерверные троттлеры локального (`max_local_read_bandwidth_for_server` и `max_local_write_bandwidth_for_server`) и удалённого (`max_remote_read_network_bandwidth_for_server` и `max_remote_write_network_bandwidth_for_server`) трафика, а ограничивались только специализированными серверными настройками (`max_backup_bandwidth_for_server`, `max_mutations_bandwidth_for_server` и `max_merges_bandwidth_for_server`). Теперь они используют оба типа троттлеров одновременно. [#81753](https://github.com/ClickHouse/ClickHouse/pull/81753) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена новая настройка [`cluster_function_process_archive_on_multiple_nodes`](/operations/settings/settings#cluster_function_process_archive_on_multiple_nodes), которая повышает производительность обработки архивов в кластерных функциях при значении `true` (по умолчанию). Для совместимости и во избежание ошибок при обновлении до версии 25.7+ следует установить значение `false`, если вы используете кластерные функции с архивами на более ранних версиях. [#82355](https://github.com/ClickHouse/ClickHouse/pull/82355) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Предыдущее значение по умолчанию для [`concurrent_threads_scheduler`](/operations/server-configuration-parameters/settings#concurrent_threads_scheduler) было `round_robin`, что оказалось несправедливым при большом количестве однопоточных запросов (например, `INSERT`). В результате по умолчанию используется более безопасный планировщик `fair_round_robin`. [#84747](https://github.com/ClickHouse/ClickHouse/pull/84747) ([Sergei Trifonov](https://github.com/serxa)).
* Отложенная материализация включена только при использовании анализатора, чтобы избежать поддержки режима без анализатора, в котором возможны некоторые проблемы (например, при использовании `indexHint()` в условиях). [#83791](https://github.com/ClickHouse/ClickHouse/pull/83791) ([Igor Nikonov](https://github.com/devcrafter)).

### Схема и синтаксис SQL {#schema-and-sql-syntax}

* Запрещено создание таблицы без столбцов, в которые можно вставлять данные. [#81835](https://github.com/ClickHouse/ClickHouse/pull/81835) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Теперь требуются обратные кавычки вокруг идентификаторов с точками в выражениях по умолчанию, чтобы предотвратить их разбор как составных идентификаторов. [#83162](https://github.com/ClickHouse/ClickHouse/pull/83162) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Добавлена поддержка синтаксиса heredoc в стиле PostgreSQL: `$tag$ string contents... $tag$`, также известного как строковые литералы в долларовых кавычках. В предыдущих версиях на теги накладывалось меньше ограничений: они могли содержать произвольные символы, включая знаки препинания и пробелы. Это приводит к неоднозначности при разборе с идентификаторами, которые также могут начинаться с символа доллара. При этом PostgreSQL допускает для тегов только буквенно-цифровые символы и подчёркивание. Для решения проблемы мы теперь ограничиваем теги heredoc теми же символами. Закрывает [#84731](https://github.com/ClickHouse/ClickHouse/issues/84731). [#84846](https://github.com/ClickHouse/ClickHouse/pull/84846) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Безопасность и права доступа {#security-and-permissions}

* `SYSTEM RESTART REPLICAS` будет перезапускать реплики только в базах данных, где у вас есть права на выполнение `SHOW TABLES`. Ранее этот запрос приводил к «пробуждению» таблиц в базе данных Lazy даже без доступа к этой базе, в то время как эти таблицы одновременно удалялись. [#83321](https://github.com/ClickHouse/ClickHouse/pull/83321) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Функции `azureBlobStorage`, `deltaLakeAzure` и `icebergAzure` были обновлены для корректной проверки прав `AZURE`. Все кластерные варианты функций (функции `-Cluster`) теперь проверяют права относительно соответствующих некластерных аналогов. Во избежание ошибок с правами доступа убедитесь, что пользователи, вызывающие функции `-Cluster`, имеют соответствующие привилегии (например, `GRANT S3 ON *.* TO user`). Кроме того, функции `icebergLocal` и `deltaLakeLocal` теперь также выполняют проверки прав `FILE`. [#84938](https://github.com/ClickHouse/ClickHouse/pull/84938) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov

## Новые возможности {#new-feature}

### Типы данных {#data-types}

* Добавлены новые типы данных: [`Time`](/sql-reference/data-types/time) `([H]HH:MM:SS)` и [`Time64`](/sql-reference/data-types/time64) `([H]HH:MM:SS[.fractional])`, а также несколько базовых функций приведения типов и функций для взаимодействия с другими типами данных. Добавлены настройки для совместимости с устаревшей функцией `ToTime`. [#81217](https://github.com/ClickHouse/ClickHouse/pull/81217) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).

### Функции {#functions}

* Добавлена [`NumericIndexedVector`](/sql-reference/functions/numeric-indexed-vector-functions) — новая векторная структура данных, использующая сжатие на основе bit-sliced roaring bitmap, а также более 20 функций для построения, анализа и покомпонентной арифметики. Может уменьшить объём хранимых данных и ускорить `JOIN`, фильтрацию и агрегации на разреженных данных. Реализует [#70582](https://github.com/ClickHouse/ClickHouse/issues/70582) и идеи статьи [&quot;Large-Scale Metric Computation in Online Controlled Experiment Platform&quot;](https://arxiv.org/abs/2405.08411) T. Xiong и Y. Wang, VLDB 2024. [#74193](https://github.com/ClickHouse/ClickHouse/pull/74193) ([FriendLey](https://github.com/FriendLey)).
* Добавлены финансовые функции: [`financialInternalRateOfReturnExtended`](/sql-reference/functions/financial-functions#financialInternalRateOfReturnExtended) (`XIRR`), [`financialInternalRateOfReturn`](/sql-reference/functions/financial-functions#financialInternalRateOfReturn) (`IRR`), [`financialNetPresentValueExtended`](/sql-reference/functions/financial-functions#financialNetPresentValueExtended) (`XNPV`), [`financialNetPresentValue`](/sql-reference/functions/financial-functions#financialNetPresentValue) (`NPV`). [#81599](https://github.com/ClickHouse/ClickHouse/pull/81599) ([Joanna Hulboj](https://github.com/jh0x)).
* Добавлены геопространственные функции [`polygonIntersectsCartesian`](/sql-reference/functions/geo/polygons#polygonsintersectcartesian) и [`polygonIntersectsSpherical`](/sql-reference/functions/geo/polygons#polygonsintersectspherical) для проверки, пересекаются ли два полигона. [#81882](https://github.com/ClickHouse/ClickHouse/pull/81882) ([Paul Lamb](https://github.com/plamb)).
* Добавлена поддержка оконных функций [`lag`](/sql-reference/window-functions/lag) и [`lead`](/sql-reference/window-functions/lead). Закрывает [#9887](https://github.com/ClickHouse/ClickHouse/issues/9887). [#82108](https://github.com/ClickHouse/ClickHouse/pull/82108) ([Dmitry Novik](https://github.com/novikd)).
* Добавлены функции [`colorSRGBToOkLCH`](/sql-reference/functions/other-functions#colorSRGBToOKLCH) и [`colorOkLCHToSRGB`](/sql-reference/functions/other-functions#colorOKLCHToSRGB) для преобразования цветов между пространствами sRGB и OkLCH. [#83679](https://github.com/ClickHouse/ClickHouse/pull/83679) ([Fgrtue](https://github.com/Fgrtue)).
* Теперь пользователи могут выполнять поиск по JSON-ключам без учета регистра с помощью [`JSONExtractCaseInsensitive`](/sql-reference/functions/json-functions#JSONExtractCaseInsensitive) (и других вариантов `JSONExtract`). [#83770](https://github.com/ClickHouse/ClickHouse/pull/83770) ([Alistair Evans](https://github.com/alistairjevans)).
* Добавлена функция [`nowInBlock64`](/sql-reference/functions/date-time-functions#nowInBlock64). [#84178](https://github.com/ClickHouse/ClickHouse/pull/84178) ([Halersson Paris](https://github.com/halersson)).
* Добавлена функция [`dateTimeToUUIDv7`](/sql-reference/functions/uuid-functions#dateTimeToUUIDv7) для преобразования значения типа DateTime в UUIDv7. Пример использования: `SELECT dateTimeToUUIDv7(toDateTime('2025-08-15 18:57:56'))` возвращает `0198af18-8320-7a7d-abd3-358db23b9d5c`. [#84319](https://github.com/ClickHouse/ClickHouse/pull/84319) ([samradovich](https://github.com/samradovich)).
* Добавьте агрегатные функции [`timeSeriesDerivToGrid`](/sql-reference/aggregate-functions/reference/timeSeriesDerivToGrid) и [`timeSeriesPredictLinearToGrid`](/sql-reference/aggregate-functions/reference/timeSeriesPredictLinearToGrid) для ресемплинга данных на временную сетку, задаваемую указанными начальной и конечной метками времени и шагом; соответственно вычисляют PromQL-подобные `deriv` и `predict_linear`. [#84328](https://github.com/ClickHouse/ClickHouse/pull/84328) ([Stephen Chi](https://github.com/stephchi0)).
* Добавлены функции [`timeSeriesRange`](/sql-reference/functions/time-series-functions#timeSeriesRange) и [`timeSeriesFromGrid`](/sql-reference/functions/time-series-functions#timeSeriesFromGrid). [#85435](https://github.com/ClickHouse/ClickHouse/pull/85435) ([Vitaly Baranov](https://github.com/vitlibar)).

### Системные таблицы {#system-tables}

* Добавлена таблица [`system.dead_letter_queue`](/operations/system-tables/dead_letter_queue) для сохранения ошибочных входящих сообщений из движков вроде Kafka. [#68873](https://github.com/ClickHouse/ClickHouse/pull/68873) ([Ilya Golshtein](https://github.com/ilejn)).
* Добавлена системная таблица [`system.zookeeper_connection_log`](/operations/system-tables/zookeeper_connection_log) для хранения истории подключений к ZooKeeper. [#79494](https://github.com/ClickHouse/ClickHouse/pull/79494) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Добавлена новая системная таблица [`system.codecs`](/operations/system-tables/codecs) для получения информации о доступных кодеках (issue [#81525](https://github.com/ClickHouse/ClickHouse/issues/81525)). [#81600](https://github.com/ClickHouse/ClickHouse/pull/81600) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
* Представлена таблица `system.completions`. Закрывает [#81889](https://github.com/ClickHouse/ClickHouse/issues/81889). [#83833](https://github.com/ClickHouse/ClickHouse/pull/83833) ([|2ustam](https://github.com/RuS2m)).

### Iceberg и DeltaLake {#iceberg-and-deltalake}

* Поддержка сложных типов в эволюции схемы Iceberg. [#73714](https://github.com/ClickHouse/ClickHouse/pull/73714) ([scanhex12](https://github.com/scanhex12)).
* Добавлена поддержка записи в Iceberg для запросов `insert`. [#82692](https://github.com/ClickHouse/ClickHouse/pull/82692) ([scanhex12](https://github.com/scanhex12)).
* Поддержка позиционных удалений для движка таблиц Iceberg. [#83094](https://github.com/ClickHouse/ClickHouse/pull/83094) ([Daniil Ivanik](https://github.com/divanik)).
* Чтение файлов данных Iceberg по идентификаторам полей. Закрывает [#83065](https://github.com/ClickHouse/ClickHouse/issues/83065). [#83653](https://github.com/ClickHouse/ClickHouse/pull/83653) ([scanhex12](https://github.com/scanhex12)).
* Поддержка записи в Iceberg при `create`. Закрывает [#83927](https://github.com/ClickHouse/ClickHouse/issues/83927). [#83983](https://github.com/ClickHouse/ClickHouse/pull/83983) ([scanhex12](https://github.com/scanhex12)).
* Поддержка записи для каталогов Glue. [#84136](https://github.com/ClickHouse/ClickHouse/pull/84136) ([scanhex12](https://github.com/scanhex12)).
* Поддержка записи для каталогов Iceberg REST. [#84684](https://github.com/ClickHouse/ClickHouse/pull/84684) ([scanhex12](https://github.com/scanhex12)).
* Объединение всех файлов позиционных удалений Iceberg в файлы данных. Это уменьшит количество и размер файлов Parquet в хранилище Iceberg. Синтаксис: `OPTIMIZE TABLE table_name`. [#85250](https://github.com/ClickHouse/ClickHouse/pull/85250) ([scanhex12](https://github.com/scanhex12)).
* Поддержка `DROP TABLE` для Iceberg (удаление из REST/Glue-каталогов и удаление метаданных о таблице). [#85395](https://github.com/ClickHouse/ClickHouse/pull/85395) ([scanhex12](https://github.com/scanhex12)).
* Поддержка мутаций `ALTER DELETE` для Iceberg в формате merge-on-read. [#85549](https://github.com/ClickHouse/ClickHouse/pull/85549) ([scanhex12](https://github.com/scanhex12)).
* Поддержка записи в DeltaLake. Закрывает [#79603](https://github.com/ClickHouse/ClickHouse/issues/79603). [#85564](https://github.com/ClickHouse/ClickHouse/pull/85564) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Запись дополнительной статистики Iceberg (размеры столбцов, нижние и верхние границы) в метаданные (записи манифеста) для min-max-фильтрации. [#85746](https://github.com/ClickHouse/ClickHouse/pull/85746) ([scanhex12](https://github.com/scanhex12)).
* Поддержка добавления/удаления/изменения столбцов в Iceberg для простых типов. [#85769](https://github.com/ClickHouse/ClickHouse/pull/85769) ([scanhex12](https://github.com/scanhex12)).

### MergeTree и хранилище {#mergetree-and-storage}

* Все таблицы теперь поддерживают виртуальный столбец `_table`, а не только таблицы типа Merge. [#63665](https://github.com/ClickHouse/ClickHouse/pull/63665) ([Xiaozhe Yu](https://github.com/wudidapaopao)).
* Добавлен SZ3 как кодек сжатия с потерями, но с ограниченной погрешностью, для столбцов типа `Float32` и `Float64`. [#67161](https://github.com/ClickHouse/ClickHouse/pull/67161) ([scanhex12](https://github.com/scanhex12)).
* Добавлена поддержка легковесных обновлений для таблиц семейства `MergeTree`. Легковесные обновления могут использоваться с новым синтаксисом: `UPDATE <table> SET col1 = val1, col2 = val2, ... WHERE <condition>`. Добавлена реализация легковесных удалений через легковесные обновления, которые можно включить установкой `lightweight_delete_mode = 'lightweight_update'`. [#82004](https://github.com/ClickHouse/ClickHouse/pull/82004) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена поддержка виртуального столбца `_part_granule_offset` в таблицах семейства MergeTree. Этот столбец указывает индекс (начиная с нуля) гранулы/метки, к которой принадлежит каждая строка в пределах своей части данных. Это решает задачу [#79572](https://github.com/ClickHouse/ClickHouse/issues/79572). [#82341](https://github.com/ClickHouse/ClickHouse/pull/82341) ([Amos Bird](https://github.com/amosbird)).

### Поддержка протоколов и клиентов {#protocol-and-client-support}

* Реализована поддержка протокола [ArrowFlight RPC](https://arrow.apache.org/docs/format/Flight.html) путём добавления табличного движка [`arrowflight`](/engines/table-engines/integrations/arrowflight). [#74184](https://github.com/ClickHouse/ClickHouse/pull/74184) ([zakr600](https://github.com/zakr600)).
* Добавлена поддержка команды `COPY` протокола PostgreSQL. [#74344](https://github.com/ClickHouse/ClickHouse/pull/74344) ([scanhex12](https://github.com/scanhex12)).
* Добавлена поддержка C#‑клиента для протокола MySQL. Закрывает задачу [#83992](https://github.com/ClickHouse/ClickHouse/issues/83992). [#84397](https://github.com/ClickHouse/ClickHouse/pull/84397) ([scanhex12](https://github.com/scanhex12)).
* Защищённое соединение теперь принудительно используется для `mysql_port` и `postgresql_port`. [#82962](https://github.com/ClickHouse/ClickHouse/pull/82962) ([Shaohua Wang](https://github.com/tiandiwonder)).

### SQL и возможности запросов {#sql-and-query-features}

* Добавлена поддержка `DESCRIBE SELECT` в дополнение к `DESCRIBE (SELECT ...)`. [#82947](https://github.com/ClickHouse/ClickHouse/pull/82947) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена поддержка использования `USE DATABASE {name}`. [#81307](https://github.com/ClickHouse/ClickHouse/pull/81307) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Реализовано чтение из проекций для параллельных реплик. Добавлена новая настройка [`parallel_replicas_support_projection`](/operations/settings/settings#parallel_replicas_support_projection) для управления включением поддержки проекций. Для упрощения реализации поддержка проекций включена только при активной настройке `parallel_replicas_local_plan`. [#82807](https://github.com/ClickHouse/ClickHouse/pull/82807) ([zoomxi](https://github.com/zoomxi)).

### Форматы {#formats}

* Добавлена настройка [`format_schema_source`](/operations/settings/formats#format_schema_source), которая определяет источник `format_schema`. [#80874](https://github.com/ClickHouse/ClickHouse/pull/80874) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Добавлен новый формат вывода `Hash`. Он вычисляет одно хэш-значение для всех столбцов и строк результата. Это полезно для вычисления «отпечатка» результата, например, в сценариях, когда узким местом является передача данных. Пример: `SELECT arrayJoin(['abc', 'def']), 42 FORMAT Hash` возвращает `e5f9e676db098fdb9530d2059d8c23ef`. [#84607](https://github.com/ClickHouse/ClickHouse/pull/84607) ([Robert Schulze](https://github.com/rschu1ze)).

### Конфигурация сервера и управление рабочими нагрузками {#server-configuration-and-workload-management}

* Настройка сервера [`cpu_slot_preemption`](/operations/server-configuration-parameters/settings#cpu_slot_preemption) включает преэмптивное планирование CPU для рабочих нагрузок и обеспечивает справедливое по принципу max-min распределение процессорного времени между ними. Добавлены новые настройки рабочей нагрузки для ограничения использования CPU: `max_cpus`, `max_cpu_share` и `max_burst_cpu_seconds`. [#80879](https://github.com/ClickHouse/ClickHouse/pull/80879) ([Sergei Trifonov](https://github.com/serxa)).
* Теперь поддерживается настройка рабочей нагрузки [`max_waiting_queries`](/operations/server-configuration-parameters/settings#max_waiting_queries). Её можно использовать для ограничения размера очереди запросов. Если лимит достигнут, все последующие запросы будут завершены с ошибкой `SERVER_OVERLOADED`. [#81250](https://github.com/ClickHouse/ClickHouse/pull/81250) ([Oleg Doronin](https://github.com/dorooleg)).
* Теперь TCP-соединение разрывается после заданного количества запросов или по достижении порогового значения времени. Закрывает задачу [#68000](https://github.com/ClickHouse/ClickHouse/issues/68000). [#81472](https://github.com/ClickHouse/ClickHouse/pull/81472) ([Kenny Sun](https://github.com/hwabis)).

### Облачное хранилище {#cloud-storage}

* Добавлен параметр `extra_credentials` в `AzureBlobStorage` для аутентификации по `client_id` и `tenant_id`. [#84235](https://github.com/ClickHouse/ClickHouse/pull/84235) ([Pablo Marcos](https://github.com/pamarcos)).

### Keeper {#keeper}

* Добавлена возможность настраивать произвольные наблюдения (watches) в Keeper Multi-запросах. [#84964](https://github.com/ClickHouse/ClickHouse/pull/84964) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Добавлена поддержка частично агрегированных метрик. [#85328](https://github.com/ClickHouse/ClickHouse/pull/85328) ([Mikhail Artemenko](https://github.com/Michicosun)).

## Экспериментальные функции {#experimental-features}

### Движки таблиц и табличные функции {#table-engines-and-table-functions}

* Добавлены табличный движок и табличная функция Ytsaurus. [#77606](https://github.com/ClickHouse/ClickHouse/pull/77606) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).

### Улучшения текстового индекса {#text-index-improvements}

* Добавлены функции `searchAny` и `searchAll`, которые являются универсальными инструментами для поиска по текстовым индексам. [#80641](https://github.com/ClickHouse/ClickHouse/pull/80641) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Текстовый индекс теперь поддерживает токенизатор `string`. [#81752](https://github.com/ClickHouse/ClickHouse/pull/81752) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Изменено значение гранулярности индекса по умолчанию для текстовых индексов (`text`) на 64. Это улучшает ожидаемую производительность среднестатистического тестового запроса во внутренних бенчмарках. [#82162](https://github.com/ClickHouse/ClickHouse/pull/82162) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
* 256-битовая битовая карта хранит исходящие метки состояния в упорядоченном виде, но исходящие состояния записываются на диск в том порядке, в котором они появляются в хеш-таблице. Поэтому при чтении с диска метка может указывать на неверное следующее состояние. [#82783](https://github.com/ClickHouse/ClickHouse/pull/82783) ([Elmi Ahmadov](https://github.com/ahmadov)).
* В настоящее время дерево FST записывается на диск без сжатия. Это может приводить к низкой производительности или повышенным требованиям к пропускной способности ввода-вывода как при записи, так и при чтении с диска. [#83093](https://github.com/ClickHouse/ClickHouse/pull/83093) ([Elmi Ahmadov](https://github.com/ahmadov)).

### Обновления статуса зрелости функций {#feature-maturity-updates}

* Каталог переведен в стадию beta. [#85848](https://github.com/ClickHouse/ClickHouse/pull/85848) ([Melvyn Peignon](https://github.com/melvynator)).
* Легковесные обновления переведены из экспериментальной в стадию beta. [#85952](https://github.com/ClickHouse/ClickHouse/pull/85952) ([Anton Popov](https://github.com/CurtizJ)).

## Повышение производительности {#performance-improvements}

### Выполнение запросов и агрегация {#query-execution-and-aggregation}

* Тривиальная оптимизация для комбинатора агрегатной функции `-If`. [#78454](https://github.com/ClickHouse/ClickHouse/pull/78454) ([李扬](https://github.com/taiyang-li)).
* Добавлена новая логика (управляется настройкой [`enable_producing_buckets_out_of_order_in_aggregation`](/operations/settings/settings#enable_producing_buckets_out_of_order_in_aggregation), по умолчанию включена), которая позволяет отправлять часть бакетов в непорядке во время агрегации, оптимизированной по потреблению памяти. Когда слияние некоторых бакетов агрегации занимает существенно больше времени, чем других, это повышает производительность, так как инициатор может тем временем сливать бакеты с более высокими идентификаторами. Обратная сторона — потенциально более высокое потребление памяти (не должно быть значительным). [#80179](https://github.com/ClickHouse/ClickHouse/pull/80179) ([Nikita Taranov](https://github.com/nickitat)).
* Конвейер после шага `TOTALS` сделан многопоточным. [#80331](https://github.com/ClickHouse/ClickHouse/pull/80331) ([UnamedRus](https://github.com/UnamedRus)).
* Когда запрос агрегации содержит только одну функцию `COUNT()` по столбцу `NOT NULL`, логика агрегации полностью инлайняется на этапе пробинга хеш-таблицы. Это позволяет избежать выделения и поддержания какого-либо состояния агрегации, что значительно снижает использование памяти и накладные расходы по CPU. Частично решает [#81982](https://github.com/ClickHouse/ClickHouse/issues/81982). [#82104](https://github.com/ClickHouse/ClickHouse/pull/82104) ([Amos Bird](https://github.com/amosbird)).
* Вычислять сериализованный ключ столбцово при группировке по нескольким строковым или числовым столбцам. [#83884](https://github.com/ClickHouse/ClickHouse/pull/83884) ([李扬](https://github.com/taiyang-li)).
* Реализован `addManyDefaults` для комбинаторов `-If`. [#83870](https://github.com/ClickHouse/ClickHouse/pull/83870) ([Raúl Marín](https://github.com/Algunenano)).

### Оптимизации JOIN {#join-optimizations}

* Добавлена новая настройка [`min_joined_block_size_rows`](/operations/settings/settings#min_joined_block_size_rows) (аналогична `min_joined_block_size_bytes`; по умолчанию 65409) для управления минимальным размером блока (в строках) для входных и выходных блоков JOIN (если алгоритм JOIN это поддерживает). Маленькие блоки будут объединяться. [#81886](https://github.com/ClickHouse/ClickHouse/pull/81886) ([Nikita Taranov](https://github.com/nickitat)).
* Оптимизирована производительность `HashJoin` за счёт удаления дополнительного цикла по хеш-таблицам в типичном случае единственного ключевого столбца; также проверки `null_map` и `join_mask` устраняются, когда они всегда `true`/`false`. [#82308](https://github.com/ClickHouse/ClickHouse/pull/82308) ([Nikita Taranov](https://github.com/nickitat)).
* Оптимизации для `null_map` и `JoinMask` из [#82308](https://github.com/ClickHouse/ClickHouse/issues/82308) были применены к случаю JOIN с несколькими дизъюнктами. Кроме того, была оптимизирована структура данных `KnownRowsHolder`. [#83041](https://github.com/ClickHouse/ClickHouse/pull/83041) ([Nikita Taranov](https://github.com/nickitat)).
* Для флагов JOIN используется простой `std::vector<std::atomic_bool>`, чтобы избежать вычисления хеша при каждом обращении к флагам. [#83043](https://github.com/ClickHouse/ClickHouse/pull/83043) ([Nikita Taranov](https://github.com/nickitat)).
* Обработка `max_joined_block_rows` перенесена за пределы основного цикла `HashJoin`. Небольшой прирост производительности для ALL JOIN. [#83216](https://github.com/ClickHouse/ClickHouse/pull/83216) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Память для результирующих столбцов больше не предварительно выделяется, когда `HashJoin` использует режим ленивого (`lazy`) вывода. Это неоптимально, особенно когда число совпадений невелико. Более того, после завершения JOIN мы знаем точное количество совпадений и можем выполнить более точное предварительное выделение. [#83304](https://github.com/ClickHouse/ClickHouse/pull/83304) ([Nikita Taranov](https://github.com/nickitat)).
* Все `LEFT/INNER` JOIN будут автоматически преобразованы в `RightAny`, если правая сторона функционально определяется столбцами ключа JOIN (все строки имеют уникальные значения ключа JOIN). [#84010](https://github.com/ClickHouse/ClickHouse/pull/84010) ([Nikita Taranov](https://github.com/nickitat)).
* Улучшена производительность применения частей-патчей (patch parts) в режиме `Join`. [#85040](https://github.com/ClickHouse/ClickHouse/pull/85040) ([Anton Popov](https://github.com/CurtizJ)).

### Улучшения распределённых запросов {#distributed-query-improvements}

* Добавлена опция вынесения (де)сжатия и (де)сериализации блоков в конвейерные потоки (pipeline threads) вместо единственного потока, связанного с сетевым соединением. Управляется настройкой `enable_parallel_blocks_marshalling`. Это должно ускорить распределённые запросы, которые передают значительные объёмы данных между инициатором и удалёнными узлами. [#78694](https://github.com/ClickHouse/ClickHouse/pull/78694) ([Nikita Taranov](https://github.com/nickitat)).
* Параллельный распределённый `INSERT SELECT` по умолчанию включён в режиме, при котором `INSERT SELECT` выполняется на каждом сегменте независимо, см. настройку `parallel_distributed_insert_select`. [#80425](https://github.com/ClickHouse/ClickHouse/pull/80425) ([Igor Nikonov](https://github.com/devcrafter)).
* Реализовано сжатие логов и событий профилирования в нативном протоколе. В кластерах со 100+ репликами несжатые события профилирования дают поток 1..10 МБ/с, и индикатор прогресса работает медленно при медленных интернет-соединениях. Это закрывает [#82533](https://github.com/ClickHouse/ClickHouse/issues/82533). [#82535](https://github.com/ClickHouse/ClickHouse/pull/82535) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Параллельный распределённый `INSERT SELECT` по умолчанию включён в режиме, при котором INSERT SELECT выполняется на каждом сегменте независимо, см. настройку `parallel_distributed_insert_select`. [#83040](https://github.com/ClickHouse/ClickHouse/pull/83040) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлен расчёт минимального размера задачи для параллельных реплик. [#84752](https://github.com/ClickHouse/ClickHouse/pull/84752) ([Nikita Taranov](https://github.com/nickitat)).

### Улучшения индексов {#index-improvements}

* Запросы векторного поиска с использованием индекса векторного сходства теперь выполняются с меньшей задержкой за счёт уменьшения числа обращений к хранилищу и снижения использования CPU. [#79103](https://github.com/ClickHouse/ClickHouse/pull/79103) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Параметр `merge_tree_min_{rows,bytes}_for_seek` теперь учитывается в `filterPartsByQueryConditionCache`, чтобы привести его в соответствие с другими методами, фильтрующими по индексам. [#80312](https://github.com/ClickHouse/ClickHouse/pull/80312) ([李扬](https://github.com/taiyang-li)).
* Сначала обрабатываются min-max индексы с более высокой гранулярностью. Закрывает [#75381](https://github.com/ClickHouse/ClickHouse/issues/75381). [#83798](https://github.com/ClickHouse/ClickHouse/pull/83798) ([Maruth Goyal](https://github.com/maruthgoyal)).
* Индекс Bloom-фильтра теперь используется для условий вида `has([c1, c2, ...], column)`, где `column` не имеет тип Array. Это повышает производительность таких запросов, делая их столь же эффективными, как оператор `IN`. [#83945](https://github.com/ClickHouse/ClickHouse/pull/83945) ([Doron David](https://github.com/dorki)).
* Индексы обрабатываются в порядке увеличения размера файла. Итоговый порядок индексов отдаёт приоритет min-max и векторным индексам (из-за простоты и избирательности соответственно), а затем — небольшим индексам. Среди min-max и векторных индексов также предпочитаются более компактные индексы. [#84094](https://github.com/ClickHouse/ClickHouse/pull/84094) ([Maruth Goyal](https://github.com/maruthgoyal)).
* Ранее данные текстового индекса разделялись на несколько сегментов (размер каждого сегмента по умолчанию составлял 256 MiB). Хотя это могло уменьшить потребление памяти при построении текстового индекса, оно увеличивало требования к дисковому пространству и время ответа на запрос. [#84590](https://github.com/ClickHouse/ClickHouse/pull/84590) ([Elmi Ahmadov](https://github.com/ahmadov)).

### Оптимизации подзапросов {#subquery-optimizations}

* Оптимизировать план выполнения, генерируемый для коррелированных подзапросов, удаляя избыточные операции `JOIN` с использованием классов эквивалентности. Если существуют эквивалентные выражения для всех коррелированных столбцов, операция `CROSS JOIN` не создаётся, если включена настройка `query_plan_correlated_subqueries_use_substitution`. [#82435](https://github.com/ClickHouse/ClickHouse/pull/82435) ([Dmitry Novik](https://github.com/novikd)).
* Считывать только необходимые столбцы в коррелированном подзапросе, когда он используется в качестве аргумента функции `EXISTS`. [#82443](https://github.com/ClickHouse/ClickHouse/pull/82443) ([Dmitry Novik](https://github.com/novikd)).

### Улучшения Azure Blob Storage {#azure-blob-storage-improvements}

* Движок таблицы [`azureBlobStorage`](/engines/table-engines/integrations/azureBlobStorage) теперь кэширует и повторно использует токены аутентификации управляемой учётной записи (managed identity), когда это возможно, чтобы избежать ограничения частоты запросов. [#79860](https://github.com/ClickHouse/ClickHouse/pull/79860) ([Nick Blakely](https://github.com/niblak)).
* HTTP‑клиент `curl` заменён на HTTP‑клиент `poco` для Azure Blob Storage. Добавлено несколько настроек для этих клиентов, аналогичных настройкам для S3. Введены агрессивные тайм-ауты установления соединения как для Azure, так и для S3. Улучшены возможности анализа событий и метрик профиля Azure. Новый клиент включён по умолчанию и обеспечивает значительно меньшие задержки для холодных запросов при работе с Azure Blob Storage. К старому клиенту `Curl` можно вернуться, установив `azure_sdk_use_native_client=false`. [#83294](https://github.com/ClickHouse/ClickHouse/pull/83294) ([alesapin](https://github.com/alesapin)).

### Улучшения движка хранения {#storage-engine-improvements}

* Исправлена фильтрация по ключу для хранилищ Redis и KeeperMap. [#81833](https://github.com/ClickHouse/ClickHouse/pull/81833) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* `ATTACH PARTITION` больше не приводит к сбросу всех кэшей. [#82377](https://github.com/ClickHouse/ClickHouse/pull/82377) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исключено удержание блокировки во время создания снимка данных хранилища, чтобы уменьшить конкуренцию за блокировки при высокой параллельной нагрузке. [#83510](https://github.com/ClickHouse/ClickHouse/pull/83510) ([Duc Canh Le](https://github.com/canhld94)).
* Удаление временных частей может занимать продолжительное время (особенно при использовании S3), и сейчас оно выполняется при удержании глобальной блокировки в `MergeTreeBackgroundExecutor`. Когда нужно перезапустить все таблицы из‑за потери соединения и мы ждём завершения фоновых задач, таблицы могут застревать в режиме только для чтения на срок до часа. Однако, по‑видимому, эта блокировка не нужна для вызова `cancel`. [#84311](https://github.com/ClickHouse/ClickHouse/pull/84311) ([Alexander Tokmakov](https://github.com/tavplubix)).

### Улучшения форматов {#format-improvements}

* Новая реализация ридера Parquet. В целом работает быстрее и поддерживает проталкивание фильтров на уровне страниц и `PREWHERE`. Пока носит экспериментальный характер. Используйте настройку `input_format_parquet_use_native_reader_v3` для включения. [#82789](https://github.com/ClickHouse/ClickHouse/pull/82789) ([Michael Kolupaev](https://github.com/al13n321)).
* Повышена производительность входного формата ProtobufSingle за счёт повторного использования сериализатора при отсутствии ошибок разбора. [#83613](https://github.com/ClickHouse/ClickHouse/pull/83613) ([Eduard Karacharov](https://github.com/korowa)).

### Оптимизации типов данных и сериализации {#data-type-and-serialization-optimizations}

* Существенно улучшена производительность чтения подстолбцов `JSON` из общих данных (shared data) в MergeTree за счёт реализации новых вариантов сериализации для общих данных `JSON` в MergeTree. [#83777](https://github.com/ClickHouse/ClickHouse/pull/83777) ([Pavel Kruglov](https://github.com/Avogar)).
* Оптимизирована десериализация строк за счёт упрощения кода. Закрывает [#38564](https://github.com/ClickHouse/ClickHouse/issues/38564). [#84561](https://github.com/ClickHouse/ClickHouse/pull/84561) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Улучшения конвейера и выполнения {#pipeline-and-execution-improvements}

* Минимизировать копирование памяти в заголовках портов при построении конвейера. Исходный [PR](https://github.com/ClickHouse/ClickHouse/pull/70105) от [heymind](https://github.com/heymind). [#83381](https://github.com/ClickHouse/ClickHouse/pull/83381) ([Raúl Marín](https://github.com/Algunenano)).
* Улучшить производительность построения конвейера. [#83631](https://github.com/ClickHouse/ClickHouse/pull/83631) ([Raúl Marín](https://github.com/Algunenano)).
* Оптимизировать MergeTreeReadersChain::getSampleBlock. [#83875](https://github.com/ClickHouse/ClickHouse/pull/83875) ([Raúl Marín](https://github.com/Algunenano)).
* Оптимизировать материализацию констант в случаях, когда мы материализуем их только для возврата одной строки. [#85071](https://github.com/ClickHouse/ClickHouse/pull/85071) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Оптимизация памяти и ресурсов {#memory-and-resource-optimizations}

* Скорректированы некоторые параметры jemalloc для улучшения производительности. [#81807](https://github.com/ClickHouse/ClickHouse/pull/81807) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлено выравнивание в Counter в ProfileEvents для уменьшения ложного совместного использования (false sharing). [#82697](https://github.com/ClickHouse/ClickHouse/pull/82697) ([Jiebin Sun](https://github.com/jiebinn)).
* Сокращено число избыточных вызовов memcpy в CompressedReadBufferBase::readCompressedData. [#83986](https://github.com/ClickHouse/ClickHouse/pull/83986) ([Raúl Marín](https://github.com/Algunenano)).

### Планирование и анализ запросов {#query-planning-and-analysis}

* Ускорена работа `QueryTreeHash`. [#82617](https://github.com/ClickHouse/ClickHouse/pull/82617) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).

### Улучшения логирования {#logging-improvements}

* Добавлено асинхронное логирование. [#82516](https://github.com/ClickHouse/ClickHouse/pull/82516) ([Raúl Marín](https://github.com/Algunenano)).

### Оптимизации функций {#function-optimizations}

* Оптимизирована функция `largestTriangleThreeBuckets` путём удаления временных данных. [#84479](https://github.com/ClickHouse/ClickHouse/pull/84479) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Оптимизирована и упрощена реализация многих функций обработки строк. Исправлена некорректная документация для ряда функций. Примечание: вывод функции `byteSize` для столбцов типа String и сложных типов, содержащих столбцы String, изменился с 9 байт за пустую строку на 8 байт за пустую строку, что является ожидаемым поведением. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Улучшения Keeper {#keeper-improvements}

* Улучшен процесс начальной загрузки RocksDB в Keeper. [#83390](https://github.com/ClickHouse/ClickHouse/pull/83390) ([Antonio Andelic](https://github.com/antonio2368)).

### Улучшения озера данных {#data-lake-improvements}

* Улучшена параллельная обработка файлов с использованием бэкенда `delta-kernel-rs`. [#85642](https://github.com/ClickHouse/ClickHouse/pull/85642) ([Azat Khuzhin](https://github.com/azat)).

## Улучшения {#improvements}

### Контроль доступа и безопасность {#access-control-and-security}

* Добавлены два новых типа доступа к источникам: `READ` и `WRITE`, а все предыдущие типы доступа, связанные с источниками, объявлены устаревшими. Раньше: `GRANT S3 ON *.* TO user`, теперь: `GRANT READ, WRITE ON S3 TO user`. Это также позволяет разделять права `READ` и `WRITE` для источников, например: `GRANT READ ON * TO user`, `GRANT WRITE ON S3 TO user`. Функциональность управляется настройкой `access_control_improvements.enable_read_write_grants` и по умолчанию отключена. [#73659](https://github.com/ClickHouse/ClickHouse/pull/73659) ([pufit](https://github.com/pufit)).
* Разрешено использовать параметры в запросах `CREATE USER` для имен пользователей. [#81387](https://github.com/ClickHouse/ClickHouse/pull/81387) ([Diskein](https://github.com/Diskein)).
* Конфиденциальные данные исключены из core dump-ов. Добавлены два аллокатора: совместимый с библиотекой AWS `AwsNodumpMemoryManager` и совместимый со STL `JemallocNodumpSTLAllocator`. Оба являются обёртками над аллокатором Jemalloc. Они используют extent hooks Jemalloc и вызов `madvise` для пометки страниц памяти как "don't dump". Используются для учётных данных S3, учётных данных пользователей и некоторых данных запросов. [#82441](https://github.com/ClickHouse/ClickHouse/pull/82441) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Представления, созданные эфемерными пользователями, теперь будут хранить копию реального пользователя и больше не будут становиться недействительными после удаления эфемерного пользователя. [#84763](https://github.com/ClickHouse/ClickHouse/pull/84763) ([pufit](https://github.com/pufit)).
* Сопоставление `forward_headers` для внешней аутентификации теперь выполняется без учёта регистра. [#84737](https://github.com/ClickHouse/ClickHouse/pull/84737) ([ingodwerust](https://github.com/ingodwerust)).
* В `system.grants` добавлен столбец `parameter` для определения типа источника для `GRANT READ/WRITE` и движка таблицы для `GRANT TABLE ENGINE`. [#85643](https://github.com/ClickHouse/ClickHouse/pull/85643) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).

### Резервное копирование и восстановление {#backup-and-restore}

* Разрешить резервное копирование баз данных PostgreSQL, MySQL и DataLake. Резервная копия такой базы данных будет сохранять только определение, но не содержащиеся в ней данные. [#79982](https://github.com/ClickHouse/ClickHouse/pull/79982) ([Nikolay Degterinsky](https://github.com/evillique)).
* Установить уровень TRACE для всех сообщений журнала при записи файлов резервных копий. [#82907](https://github.com/ClickHouse/ClickHouse/pull/82907) ([Hans Krutzer](https://github.com/hkrutzer)).
* Добавить настройки [`backup_restore_s3_retry_initial_backoff_ms`](/operations/settings/settings#backup_restore_s3_retry_initial_backoff_ms), [`backup_restore_s3_retry_max_backoff_ms`](/operations/settings/settings#backup_restore_s3_retry_max_backoff_ms), [`backup_restore_s3_retry_jitter_factor`](/operations/settings/settings#backup_restore_s3_retry_jitter_factor) для настройки стратегии backoff при повторных попытках доступа к S3, используемой во время операций резервного копирования и восстановления. [#84421](https://github.com/ClickHouse/ClickHouse/pull/84421) ([Julia Kartseva](https://github.com/jkartseva)).
* Добавить новую настройку [`backup_slow_all_threads_after_retryable_s3_error`](/operations/settings/settings#backup_slow_all_threads_after_retryable_s3_error) для снижения нагрузки на S3 во время штормов повторных попыток, вызванных ошибками, такими как `SlowDown`, за счет замедления всех потоков после возникновения первой такой повторяемой ошибки. [#84854](https://github.com/ClickHouse/ClickHouse/pull/84854) ([Julia Kartseva](https://github.com/jkartseva)).

### Целостность данных и валидация {#data-integrity-and-validation}

* Проверять, что у части есть корректный файл checksum.txt непосредственно перед её коммитом. [#76625](https://github.com/ClickHouse/ClickHouse/pull/76625) ([Sema Checherinda](https://github.com/CheSema)).
* Запретить запуск мутации `RENAME COLUMN`, если она будет переименовывать столбец, на который сейчас влияет незавершённая мутация данных. [#81823](https://github.com/ClickHouse/ClickHouse/pull/81823) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Теперь снимок мутаций будет строиться на основе снимка видимых частей. Счётчики мутаций, используемые в снимке, также будут пересчитываться по включённым мутациям. [#82945](https://github.com/ClickHouse/ClickHouse/pull/82945) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Добавить возможность разбирать префикс и суффикс части, а также проверять покрытие для неконстантных столбцов. [#83377](https://github.com/ClickHouse/ClickHouse/pull/83377) ([Mikhail Artemenko](https://github.com/Michicosun)).

### Табличный движок Iceberg {#iceberg-table-engine}

* Добавлена поддержка позиционных удалений для табличного движка Iceberg. [#80237](https://github.com/ClickHouse/ClickHouse/pull/80237) ([YanghongZhong](https://github.com/yahoNanJing)).
* Теперь ClickHouse поддерживает сжатые файлы `metadata.json` в Iceberg. Исправляет [#70874](https://github.com/ClickHouse/ClickHouse/issues/70874). [#81451](https://github.com/ClickHouse/ClickHouse/pull/81451) ([alesapin](https://github.com/alesapin)).
* Исправлено чтение Iceberg по ID полей для сложных типов. [#84821](https://github.com/ClickHouse/ClickHouse/pull/84821) ([scanhex12](https://github.com/scanhex12)).
* Добавлена поддержка записи в формате Iceberg, совместимой с pyiceberg. [#84466](https://github.com/ClickHouse/ClickHouse/pull/84466) ([scanhex12](https://github.com/scanhex12)).
* Добавлено хранение версии snapshot для табличных движков озер данных. [#84659](https://github.com/ClickHouse/ClickHouse/pull/84659) ([Pete Hampton](https://github.com/pjhampton)).
* Добавлена поддержка записи файла version-hint для Iceberg. Закрывает [#85097](https://github.com/ClickHouse/ClickHouse/issues/85097). [#85130](https://github.com/ClickHouse/ClickHouse/pull/85130) ([scanhex12](https://github.com/scanhex12)).
* Добавлена поддержка сжатого файла `.metadata.json` через настройку [`iceberg_metadata_compression_method`](/operations/settings/settings#iceberg_metadata_compression_method). Поддерживаются все методы сжатия ClickHouse. Закрывает [#84895](https://github.com/ClickHouse/ClickHouse/issues/84895). [#85196](https://github.com/ClickHouse/ClickHouse/pull/85196) ([scanhex12](https://github.com/scanhex12)).
* Оптимизировано использование памяти для файлов позиционных удалений Iceberg. Вместо загрузки всех данных файла удалений в память в ОЗУ хранится только текущая группа строк из Parquet-файлов удалений. Это значительно снижает потребление памяти при работе с крупными файлами позиционных удалений. [#85329](https://github.com/ClickHouse/ClickHouse/pull/85329) ([scanhex12](https://github.com/scanhex12)).
* Добавлена возможность асинхронной итерации по объектам таблицы Iceberg без явного хранения объектов для каждого файла данных. [#85369](https://github.com/ClickHouse/ClickHouse/pull/85369) ([Daniil Ivanik](https://github.com/divanik)).
* Добавлена поддержка удалений по равенству (equality deletes) в Iceberg. [#85843](https://github.com/ClickHouse/ClickHouse/pull/85843) ([Han Fei](https://github.com/hanfei1991)).

### Движок таблиц DeltaLake {#deltalake-table-engine}

* Улучшен движок таблиц `DeltaLake`: в delta-kernel-rs появился API `ExpressionVisitor`, который реализован в этом PR и применяется для преобразования выражений над столбцами партиций (он заменит старый устаревший способ в delta-kernel-rs, который ранее использовался в нашем коде). В будущем этот `ExpressionVisitor` также позволит реализовать отсечение по статистике и некоторые проприетарные функции delta-lake. Дополнительно, цель этого изменения — поддержать отсечение партиций в движке таблиц `DeltaLakeCluster` (результат разобранного выражения — ActionsDAG — будет сериализован и отправлен с инициатора вместе с путём к данным, поскольку такого рода информация, необходимая для отсечения, доступна только как метаинформация при получении списка файлов с данными, которое выполняется только инициатором, но должна применяться к данным на каждом сервере, выполняющем чтение). [#81136](https://github.com/ClickHouse/ClickHouse/pull/81136) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено отсечение партиций в функциях кластера озера данных. [#82131](https://github.com/ClickHouse/ClickHouse/pull/82131) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено чтение партиционированных данных в табличной функции DeltaLakeCluster. В этом PR увеличена версия протокола кластерных функций, что позволяет передавать дополнительную информацию от инициатора к репликам. Эта дополнительная информация содержит выражение преобразования delta-kernel, которое необходимо для разбора столбцов партиций (и некоторых других вещей в будущем, например, сгенерированных столбцов и т.д.). [#82132](https://github.com/ClickHouse/ClickHouse/pull/82132) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Теперь база данных Datalake выбрасывает более удобное исключение. Исправляет [#81211](https://github.com/ClickHouse/ClickHouse/issues/81211). [#82304](https://github.com/ClickHouse/ClickHouse/pull/82304) ([alesapin](https://github.com/alesapin)).
* Реализована внутренняя фильтрация `delta-kernel-rs` (статистика и отсечение партиций) в хранилище `DeltaLake`. [#84006](https://github.com/ClickHouse/ClickHouse/pull/84006) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена настройка [`delta_lake_enable_expression_visitor_logging`](/operations/settings/settings#delta_lake_enable_expression_visitor_logging) для отключения логов `ExpressionVisitor`, так как они могут быть слишком подробными даже для тестового уровня логирования при отладке. [#84315](https://github.com/ClickHouse/ClickHouse/pull/84315) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена настройка [`delta_lake_snapshot_version`](/operations/settings/settings#delta_lake_snapshot_version), позволяющая читать конкретную версию снимка в движке таблиц `DeltaLake`. [#85295](https://github.com/ClickHouse/ClickHouse/pull/85295) ([Kseniia Sumarokova](https://github.com/kssenii)).

### Интеграция с озером данных {#data-lake-integration}

* Ускорено получение списка таблиц в каталогах данных за счёт асинхронных запросов. [#81084](https://github.com/ClickHouse/ClickHouse/pull/81084) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка `TimestampTZ` в каталоге Glue. Закрывает [#81654](https://github.com/ClickHouse/ClickHouse/issues/81654). [#83132](https://github.com/ClickHouse/ClickHouse/pull/83132) ([scanhex12](https://github.com/scanhex12)).
* Разделён `FormatParserGroup` на две независимые структуры: первая отвечает за общие вычислительные и I/O‑ресурсы, вторая — за общие ресурсы фильтрации (filter `ActionDag`, `KeyCondition`). Это сделано для более гибкого совместного использования этих структур разными потоками. [#83997](https://github.com/ClickHouse/ClickHouse/pull/83997) ([Daniil Ivanik](https://github.com/divanik)).
* Добавлен отсутствующий `partition_columns_in_data_file` в конфигурацию Azure. [#85373](https://github.com/ClickHouse/ClickHouse/pull/85373) ([Arthur Passos](https://github.com/arthurpassos)).
* Добавлен флаг `show_data_lake_catalogs_in_system_tables` для управления добавлением таблиц озера данных в `system.tables`, что устраняет [#85384](https://github.com/ClickHouse/ClickHouse/issues/85384). [#85411](https://github.com/ClickHouse/ClickHouse/pull/85411) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).

### S3 и объектное хранилище {#s3-and-object-storage}

* Реализованы методы `moveFile` и `replaceFile` в `s3_plain_rewritable`, чтобы его можно было использовать в качестве диска базы данных. [#79424](https://github.com/ClickHouse/ClickHouse/pull/79424) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Запросы чтения и записи в S3 теперь ограничиваются на уровне HTTP-сокета (вместо всего запроса к S3), чтобы избежать проблем с ограничениями `max_remote_read_network_bandwidth_for_server` и `max_remote_write_network_bandwidth_for_server`. [#81837](https://github.com/ClickHouse/ClickHouse/pull/81837) ([Sergei Trifonov](https://github.com/serxa)).
* В этом PR к механизму повторных попыток S3 добавлен джиттер при включённой конфигурации `s3_slow_all_threads_after_network_error`. [#81849](https://github.com/ClickHouse/ClickHouse/pull/81849) ([zoomxi](https://github.com/zoomxi)).
* Реализована аутентификация AWS S3 с явным указанием роли IAM. Реализован OAuth для GCS. Ранее эти возможности были доступны только в ClickHouse Cloud, а теперь открыты в виде open source. Синхронизированы некоторые интерфейсы, такие как сериализация параметров подключения для объектных хранилищ. [#84011](https://github.com/ClickHouse/ClickHouse/pull/84011) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Разрешено использовать любую политику хранения (то есть объектное хранилище, такое как S3) для внешней агрегации/сортировки. [#84734](https://github.com/ClickHouse/ClickHouse/pull/84734) ([Azat Khuzhin](https://github.com/azat)).
* Все удаляемые объекты агрегируются для выполнения одной операции удаления в объектном хранилище. [#85316](https://github.com/ClickHouse/ClickHouse/pull/85316) ([Mikhail Artemenko](https://github.com/Michicosun)).

### Движок таблицы S3Queue {#s3queue-table-engine}

* Макросы вроде `{uuid}` теперь могут использоваться в настройке `keeper_path` движка таблицы S3Queue. [#82463](https://github.com/ClickHouse/ClickHouse/pull/82463) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена новая серверная настройка `s3queue_disable_streaming`, которая отключает потоковую обработку в таблицах с движком S3Queue. Эту настройку можно менять без перезапуска сервера. [#82515](https://github.com/ClickHouse/ClickHouse/pull/82515) ([Kseniia Sumarokova](https://github.com/kssenii)).
* В `system.s3queue_log` добавлены столбцы `commit_time`, `commit_id`. [#83016](https://github.com/ClickHouse/ClickHouse/pull/83016) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлены сообщения журнала для процесса остановки s3queue. [#83163](https://github.com/ClickHouse/ClickHouse/pull/83163) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Потоковая обработка S3(Azure/etc)Queue теперь останавливается до остановки любых таблиц при завершении работы сервера. [#83530](https://github.com/ClickHouse/ClickHouse/pull/83530) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Поддерживается изменение настроек вставки в материализованные представления на уровне таблицы `S3Queue`. Добавлены новые настройки уровня `S3Queue`: `min_insert_block_size_rows_for_materialized_views` и `min_insert_block_size_bytes_for_materialized_views`. По умолчанию используются настройки уровня профиля, а настройки уровня `S3Queue` их переопределяют. [#83971](https://github.com/ClickHouse/ClickHouse/pull/83971) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен режим упорядоченной обработки S3Queue: более раннее завершение, если была запрошена остановка. [#84463](https://github.com/ClickHouse/ClickHouse/pull/84463) ([Kseniia Sumarokova](https://github.com/kssenii)).

### Интеграция с Kafka {#kafka-integration}

* Подсчитывайте потреблённые сообщения вручную, чтобы не зависеть от ранее зафиксированного смещения в StorageKafka2. [#81662](https://github.com/ClickHouse/ClickHouse/pull/81662) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Интегрируйте `StorageKafka2` с [`system.kafka_consumers`](/operations/system-tables/kafka_consumers). [#82652](https://github.com/ClickHouse/ClickHouse/pull/82652) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).

### Улучшения ClickHouse Keeper {#clickhouse-keeper-improvements}

* Улучшение Keeper: перенос файлов журнала изменений между дисками в фоновом потоке. Ранее перенос журнала изменений на другой диск глобально блокировал Keeper до завершения операции. Это приводило к снижению производительности, если перенос занимал много времени (например, на диск S3). [#82485](https://github.com/ClickHouse/ClickHouse/pull/82485) ([Antonio Andelic](https://github.com/antonio2368)).
* Улучшение Keeper: добавлена новая настройка `keeper_server.cleanup_old_and_ignore_new_acl`. Если она включена, на всех узлах ACL будут очищены, а ACL для новых запросов будут игнорироваться. Если цель — полностью удалить ACL с узлов, важно оставить эту настройку включённой до создания нового снимка состояния (snapshot). [#82496](https://github.com/ClickHouse/ClickHouse/pull/82496) ([Antonio Andelic](https://github.com/antonio2368)).
* Улучшение Keeper: поддержка отдельных прав доступа для ACL `world:anyone`. [#82755](https://github.com/ClickHouse/ClickHouse/pull/82755) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена поддержка указания дополнительных ACL Keeper для путей в конфиге. Если нужно добавить дополнительные ACL для конкретного пути, определите их в конфиге в секции `zookeeper.path_acls`. [#82898](https://github.com/ClickHouse/ClickHouse/pull/82898) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлен ProfileEvent в случае, когда Keeper отклоняет запись из-за мягкого ограничения по памяти. [#82963](https://github.com/ClickHouse/ClickHouse/pull/82963) ([Xander Garbett](https://github.com/Garbett1)).
* В Keeper по умолчанию включены feature-флаги `create_if_not_exists`, `check_not_exists`, `remove_recursive`, которые включают новые типы запросов. [#83488](https://github.com/ClickHouse/ClickHouse/pull/83488) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена поддержка применения дополнительных ACL к отдельным узлам Keeper с помощью настройки `apply_to_children`. [#84137](https://github.com/ClickHouse/ClickHouse/pull/84137) ([Antonio Andelic](https://github.com/antonio2368)).
* В KeeperClient добавлена команда `get_acl`. [#84641](https://github.com/ClickHouse/ClickHouse/pull/84641) ([Antonio Andelic](https://github.com/antonio2368)).
* В Keeper добавлена 4LW-команда `lgrq` для переключения логирования полученных запросов. [#84719](https://github.com/ClickHouse/ClickHouse/pull/84719) ([Antonio Andelic](https://github.com/antonio2368)).
* Снижена конкуренция за блокировку хранилища в Keeper. [#84732](https://github.com/ClickHouse/ClickHouse/pull/84732) ([Antonio Andelic](https://github.com/antonio2368)).
* Инструмент `encrypt_decrypt` теперь поддерживает зашифрованные соединения с ZooKeeper. [#84764](https://github.com/ClickHouse/ClickHouse/pull/84764) ([Roman Vasin](https://github.com/rvasin)).
* Размер кэша записей журнала Keeper теперь ограничен по количеству записей с помощью настроек `keeper_server.coordination_settings.latest_logs_cache_entry_count_threshold` и `keeper_server.coordination_settings.commit_logs_cache_entry_count_threshold`. [#84877](https://github.com/ClickHouse/ClickHouse/pull/84877) ([Antonio Andelic](https://github.com/antonio2368)).

### Типы JSON и Dynamic {#json-and-dynamic-types}

* Добавлен файл `columns_substreams.txt` в часть формата Wide для отслеживания всех подпотоков, хранящихся в части. Это помогает отслеживать динамические потоки в типах JSON и Dynamic и таким образом избегать чтения образца данных этих столбцов для получения списка динамических потоков (например, для вычисления размеров столбцов). Также теперь все динамические потоки отражены в `system.parts_columns`. [#81091](https://github.com/ClickHouse/ClickHouse/pull/81091) ([Pavel Kruglov](https://github.com/Avogar)).
* Разрешён `ALTER UPDATE` в столбцах JSON и Dynamic. [#82419](https://github.com/ClickHouse/ClickHouse/pull/82419) ([Pavel Kruglov](https://github.com/Avogar)).
* Пользователи теперь могут использовать типы `Time` и `Time64` внутри типа JSON. [#83784](https://github.com/ClickHouse/ClickHouse/pull/83784) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена настройка `json_type_escape_dots_in_keys` для экранирования точек в ключах JSON при разборе типа JSON. По умолчанию настройка отключена. [#84207](https://github.com/ClickHouse/ClickHouse/pull/84207) ([Pavel Kruglov](https://github.com/Avogar)).

### Форматы Parquet и ORC {#parquet-and-orc-formats}

* Добавлены настройки для задания размера блока сжатия ORC и изменено значение по умолчанию с 64KB на 256KB для соответствия Spark и Hive. [#80602](https://github.com/ClickHouse/ClickHouse/pull/80602) ([李扬](https://github.com/taiyang-li)).
* Добавлена поддержка записи перечислений Parquet в виде массива байтов, как предписывает [спецификация](https://github.com/apache/parquet-format/blob/master/LogicalTypes.md#enum). Дополнительная информация будет добавлена позже. [#81090](https://github.com/ClickHouse/ClickHouse/pull/81090) ([Arthur Passos](https://github.com/arthurpassos)).
* Добавлена поддержка записи GeoParquet в качестве выходного формата. [#81784](https://github.com/ClickHouse/ClickHouse/pull/81784) ([scanhex12](https://github.com/scanhex12)).

### Распределённые запросы и параллельные реплики {#distributed-queries-and-parallel-replicas}

* Добавлена новая настройка enable_add_distinct_to_in_subqueries. Когда она включена, ClickHouse автоматически добавляет DISTINCT к подзапросам в выражениях IN для распределённых запросов. Это может значительно сократить размер временных таблиц, передаваемых между сегментами, и повысить эффективность использования сети. Примечание: это компромисс — хотя сетевой трафик уменьшается, на каждом узле требуется дополнительная работа по слиянию (удалению дублей). Включайте эту настройку, когда узким местом является передача по сети и стоимость слияния приемлема. [#81908](https://github.com/ClickHouse/ClickHouse/pull/81908) ([fhw12345](https://github.com/fhw12345)).
* Добавлена поддержка табличных функций `remote-()` с параллельными репликами, если кластер указан в аргументе `address_expression`. Также исправлена проблема [#73295](https://github.com/ClickHouse/ClickHouse/issues/73295). [#82904](https://github.com/ClickHouse/ClickHouse/pull/82904) ([Igor Nikonov](https://github.com/devcrafter)).
* Операции JOIN с параллельными репликами теперь используют логический шаг JOIN. В случае проблем с запросами JOIN, использующими параллельные реплики, попробуйте выполнить `SET query_plan_use_new_logical_join_step=0` и сообщите об ошибке. [#83801](https://github.com/ClickHouse/ClickHouse/pull/83801) ([Vladimir Cherkasov](https://github.com/vdimir)).

### Настройки и конфигурация {#settings-and-configuration}

* Настройка `allow_experimental_join_condition` помечена как устаревшая. [#80566](https://github.com/ClickHouse/ClickHouse/pull/80566) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Общие и пользовательские ограничители сетевой пропускной способности больше не сбрасываются, что гарантирует, что ограничения `max_network_bandwidth_for_all_users` и `max_network_bandwidth_for_all_users` никогда не превышаются. [#81729](https://github.com/ClickHouse/ClickHouse/pull/81729) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена настройка `optimize_rewrite_regexp_functions` (включена по умолчанию), которая позволяет оптимизатору переписывать некоторые вызовы `replaceRegexpAll`, `replaceRegexpOne` и `extract` в более простые и эффективные формы при обнаружении определённых шаблонов регулярных выражений. (issue [#81981](https://github.com/ClickHouse/ClickHouse/issues/81981)). [#81992](https://github.com/ClickHouse/ClickHouse/pull/81992) ([Amos Bird](https://github.com/amosbird)).
* Настроено значение очереди TCP‑серверов (64 по умолчанию) на основе listen_backlog (4096 по умолчанию). [#82045](https://github.com/ClickHouse/ClickHouse/pull/82045) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена возможность перезагружать `max_local_read_bandwidth_for_server` и `max_local_write_bandwidth_for_server` на лету без перезапуска сервера. [#82083](https://github.com/ClickHouse/ClickHouse/pull/82083) ([Kai Zhu](https://github.com/nauu)).
* Добавлена настройка `enable_vector_similarity_index`, которую необходимо включить для использования индекса векторного сходства. Существующая настройка `allow_experimental_vector_similarity_index` теперь устарела. Она всё ещё работает на случай, если кому‑то она нужна. [#83459](https://github.com/ClickHouse/ClickHouse/pull/83459) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлен [`max_joined_block_size_bytes`](/operations/settings/settings#max_joined_block_size_bytes) в дополнение к `max_joined_block_size_rows` для ограничения использования памяти JOIN‑ами с «тяжёлыми» столбцами. [#83869](https://github.com/ClickHouse/ClickHouse/pull/83869) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена совместимость для cluster_function_process_archive_on_multiple_nodes. [#83968](https://github.com/ClickHouse/ClickHouse/pull/83968) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Поддержка коррелированных подзапросов включена по умолчанию. [#85107](https://github.com/ClickHouse/ClickHouse/pull/85107) ([Dmitry Novik](https://github.com/novikd)).
* Добавлены настройки `database_replicated`, задающие значения по умолчанию для DatabaseReplicatedSettings. Если настройка отсутствует в запросе создания реплицируемой БД (Replicated DB), используется значение из этой настройки. [#85127](https://github.com/ClickHouse/ClickHouse/pull/85127) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Разрешены аргументы в формате ключ‑значение в движке/функции таблицы `s3` или `s3Cluster`, например `s3('url', CSV, structure = 'a Int32', compression_method = 'gzip')`. [#85134](https://github.com/ClickHouse/ClickHouse/pull/85134) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Некоррелированные `EXISTS` выполняются как скалярный подзапрос. Это позволяет использовать кэш скалярных подзапросов и выполнять константное свёртывание результата, что полезно для индексов. Для совместимости добавлена новая настройка `execute_exists_as_scalar_subquery=1`. [#85481](https://github.com/ClickHouse/ClickHouse/pull/85481) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлена поддержка обработки большего числа случаев для составных идентификаторов. В частности, это улучшает совместимость `ARRAY JOIN` со старым анализатором. Введена новая настройка `analyzer_compatibility_allow_compound_identifiers_in_unflatten_nested` для сохранения старого поведения. [#85492](https://github.com/ClickHouse/ClickHouse/pull/85492) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).

### Системные таблицы и обсервабилити {#system-tables-and-observability}

* Добавлены метрики нагрузки в асинхронные метрики ClickHouse. [#80779](https://github.com/ClickHouse/ClickHouse/pull/80779) ([Xander Garbett](https://github.com/Garbett1)).
* Добавлены метрики `MarkCacheEvictedBytes`, `MarkCacheEvictedMarks`, `MarkCacheEvictedFiles` для отслеживания удалений из кеша меток (mark cache). (issue [#60989](https://github.com/ClickHouse/ClickHouse/issues/60989)). [#80799](https://github.com/ClickHouse/ClickHouse/pull/80799) ([Shivji Kumar Jha](https://github.com/shiv4289)).
* Таблица `system.formats` теперь содержит расширенную информацию о форматах, такую как тип содержимого HTTP (Content-Type), возможности автоматического вывода схемы (schema inference) и т. д. [#81505](https://github.com/ClickHouse/ClickHouse/pull/81505) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка очистки всех предупреждений из таблицы `system.warnings` с помощью `TRUNCATE TABLE system.warnings`. [#82087](https://github.com/ClickHouse/ClickHouse/pull/82087) ([Vladimir Cherkasov](https://github.com/vdimir)).
* В `system.licenses` теперь перечисляются лицензии Rust-crate'ов. [#82440](https://github.com/ClickHouse/ClickHouse/pull/82440) ([Raúl Marín](https://github.com/Algunenano)).
* Сложные выражения в КНФ/ДНФ, например `(a < 1 and a > 0) or b = 3`, теперь оцениваются по статистике. [#82663](https://github.com/ClickHouse/ClickHouse/pull/82663) ([Han Fei](https://github.com/hanfei1991)).
* В некоторых случаях нам нужны многомерные метрики. Например, подсчёт неудачных слияний или мутаций по кодам ошибок, а не одним счётчиком. [#83030](https://github.com/ClickHouse/ClickHouse/pull/83030) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Добавлены метрики ресурсов процесса (такие как `UserTimeMicroseconds`, `SystemTimeMicroseconds`, `RealTimeMicroseconds`) в события профиля part_log для записей `MergeParts`. [#83460](https://github.com/ClickHouse/ClickHouse/pull/83460) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Теперь метрики на уровне cgroup и системные метрики сообщаются вместе. Метрики уровня cgroup имеют имена вида `CGroup<Metric>`, а метрики уровня ОС (собираемые из procfs) имеют имена вида `OS<Metric>`. [#84317](https://github.com/ClickHouse/ClickHouse/pull/84317) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлены многомерные (dimensional) метрики для мониторинга размера параллельных ограниченных очередей, помеченных типом очереди и ID экземпляра для улучшения обсервабилити. [#84675](https://github.com/ClickHouse/ClickHouse/pull/84675) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Таблица [`system.columns`](/operations/system-tables/columns) теперь предоставляет `column` в качестве синонима для существующего столбца `name`. [#84695](https://github.com/ClickHouse/ClickHouse/pull/84695) ([Yunchi Pang](https://github.com/yunchipang)).
* В `system.errors` добавлен строковый столбец шаблона формата (format string column). Этот столбец нужен для группировки по одному типу ошибки в правилах оповещений. [#84776](https://github.com/ClickHouse/ClickHouse/pull/84776) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Сделаны настраиваемыми лимиты для Async Log и добавлена возможность интроспекции. [#85105](https://github.com/ClickHouse/ClickHouse/pull/85105) ([Raúl Marín](https://github.com/Algunenano)).
* При получении размеров столбцов таблиц для system.columns теперь игнорируется `UNKNOWN_DATABASE`. [#85632](https://github.com/ClickHouse/ClickHouse/pull/85632) ([Azat Khuzhin](https://github.com/azat)).

### Движки баз данных {#database-engines}

### Системные и внутренние улучшения {#system-and-internal-improvements}

* Исправлено подключение баз данных с удалёнными дисками только для чтения путём ручного добавления UUID таблиц в DatabaseCatalog. [#82670](https://github.com/ClickHouse/ClickHouse/pull/82670) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Улучшена обработка задач DDL при `distributed_ddl_output_mode='*_only_active'` за счёт отказа от ожидания новых или восстановленных реплик, у которых лаг репликации превышает `max_replication_lag_to_enqueue`. Это помогает избежать ошибок `DDL task is not finished on some hosts`, когда новая реплика становится активной после инициализации или восстановления, но накопила большой лог репликации. Также реализован запрос `SYSTEM SYNC DATABASE REPLICA STRICT`, который ожидает, пока лог репликации не станет меньше `max_replication_lag_to_enqueue`. [#83302](https://github.com/ClickHouse/ClickHouse/pull/83302) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Изменён порядок завершения работы SystemLogs так, чтобы он происходил после обычных таблиц (и перед системными таблицами, вместо завершения до обычных таблиц). [#83134](https://github.com/ClickHouse/ClickHouse/pull/83134) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена серверная настройка `logs_to_keep` для реплицируемых баз данных, позволяющая задавать значение по умолчанию параметра `logs_to_keep` для таких баз. Меньшие значения уменьшают количество узлов ZooKeeper (особенно полезно при большом числе баз данных), а большие позволяют отсутствующим репликам догонять после более длительных периодов простоя. [#84183](https://github.com/ClickHouse/ClickHouse/pull/84183) ([Alexey Khatskevich](https://github.com/Khatskevich)).
* Изменено значение по умолчанию настройки реплицируемой базы данных Replicated `max_retries_before_automatic_recovery` на 10, что в некоторых случаях обеспечивает более быстрое восстановление. [#84369](https://github.com/ClickHouse/ClickHouse/pull/84369) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Оптимизированы DDL-операции refreshable materialized view в реплицируемых базах данных для не-append-сценариев за счёт пропуска создания и переименования старых временных таблиц. [#84858](https://github.com/ClickHouse/ClickHouse/pull/84858) ([Tuan Pham Anh](https://github.com/tuanpach)).

### Репликация и синхронизация {#replication-and-synchronization}

### SystemAndInternalImprovements {#systemandinternalimprovements}

* Улучшена команда `SYSTEM RESTART REPLICA`, чтобы повторять попытку создания таблиц при проблемах с подключением к ZooKeeper и не допускать, чтобы таблицы «терялись». [#82616](https://github.com/ClickHouse/ClickHouse/pull/82616) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена проверка UUID в `ReplicatedMergeTree::executeMetadataAlter` для предотвращения некорректных определений таблиц при обмене таблицами между получением `StorageID` и вызовом `IDatabase::alterTable`. [#82666](https://github.com/ClickHouse/ClickHouse/pull/82666) ([Nikolay Degterinsky](https://github.com/evillique)).
* Удалена экспериментальная логика `send_metadata`, связанная с экспериментальной репликацией без копирования (zero-copy). Этот код никогда не использовался, не поддерживался и, вероятно, был некорректным, а также не имел тестов для проверки его работоспособности. [#82508](https://github.com/ClickHouse/ClickHouse/pull/82508) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка подстановки макросов в `remote_fs_zero_copy_zookeeper_path`. [#85437](https://github.com/ClickHouse/ClickHouse/pull/85437) ([Mikhail Koviazin](https://github.com/mkmkme)).

### Функции и выражения {#functions-and-expressions}

* Функция `addressToSymbol` и таблица `system.symbols` будут использовать смещения в файле вместо адресов в виртуальной памяти. [#81896](https://github.com/ClickHouse/ClickHouse/pull/81896) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Старайтесь сохранять имена элементов при выведении супертипов для именованных кортежей. [#81345](https://github.com/ClickHouse/ClickHouse/pull/81345) ([lgbo](https://github.com/lgbo-ustc)).
* Разрешено смешивать разные правила сравнения строк (collations) для одного и того же столбца в разных окнах. [#82877](https://github.com/ClickHouse/ClickHouse/pull/82877) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Добавлена функция для записи типов в формат WKB. [#82935](https://github.com/ClickHouse/ClickHouse/pull/82935) ([scanhex12](https://github.com/scanhex12)).
* Добавлена возможность интерпретировать `Time` и `Time64` в форматах MM:SS, M:SS, SS или S. [#83299](https://github.com/ClickHouse/ClickHouse/pull/83299) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Функция `reinterpret()` теперь поддерживает преобразование в `Array(T)`, где `T` — тип данных фиксированного размера (задача [#82621](https://github.com/ClickHouse/ClickHouse/issues/82621)). [#83399](https://github.com/ClickHouse/ClickHouse/pull/83399) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Исправлены функции `structureToProtobufSchema` и `structureToCapnProtoSchema`, чтобы корректно добавлять нулевой байт-терминатор вместо символа новой строки, что предотвращает пропуск переводов строки в выводе и потенциальные переполнения буфера в функциях, которые зависят от нулевого байта (таких как `logTrace`, `demangle`, `extractURLParameter`, `toStringCutToZero` и `encrypt`/`decrypt`). Закрывает [#85062](https://github.com/ClickHouse/ClickHouse/issues/85062). [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена структура словаря `regexp_tree` для поддержки обработки строк, содержащих нулевые байты. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена функция `formatRowNoNewline`, которая неправильно обрезала последний символ вывода при использовании формата `Values` или любого формата без символа новой строки в конце строк. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка в exception safety функции `stem`, которая в редких случаях могла приводить к утечкам памяти. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена функция `initcap` для аргументов типа `FixedString`, чтобы корректно распознавать начало слов в начале строк, если предыдущая строка в блоке заканчивалась буквенно-цифровым символом. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена уязвимость безопасности в формате Apache `ORC`, которая могла приводить к раскрытию неинициализированной памяти. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Изменено поведение `replaceRegexpAll` и его алиаса `REGEXP_REPLACE`, чтобы разрешить пустые совпадения в конце строк, даже если предыдущее совпадение охватывало всю строку целиком (например, `^a*|a*$` или `^|.*`), что согласуется с семантикой JavaScript, Perl, Python, PHP и Ruby, но отличается от PostgreSQL. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Оптимизирована и упрощена реализация целого ряда функций обработки строк. Исправлена неверная документация для нескольких функций. Примечание: результат `byteSize` для столбцов типа String и сложных типов, содержащих столбцы типа String, изменился с 9 байт за пустую строку на 8 байт за пустую строку, что и является ожидаемым поведением. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Разрешено значение шага 0 в функциях `timeSeries*ToGrid()`. Это часть `#3` из [https://github.com/ClickHouse/ClickHouse/pull/75036](https://github.com/ClickHouse/ClickHouse/pull/75036). [#85390](https://github.com/ClickHouse/ClickHouse/pull/85390) ([Vitaly Baranov](https://github.com/vitlibar)).
* Реализована поддержка внутренних массивов в функции `nested`. [#85719](https://github.com/ClickHouse/ClickHouse/pull/85719) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).

### Улучшения MergeTree {#mergetree-improvements}

* Более тонкое управление отключением пропускающих индексов, которые зависят от столбцов, обновляемых «на лету» или с помощью patch parts. Теперь пропускающие индексы не используются только в частях, затронутых мутациями «на лету» или patch parts; ранее эти индексы отключались для всех частей. [#84241](https://github.com/ClickHouse/ClickHouse/pull/84241) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена настройка MergeTree `search_orphaned_parts_drives` для ограничения области поиска частей, например по дискам с локальными метаданными. [#84710](https://github.com/ClickHouse/ClickHouse/pull/84710) ([Ilya Golshtein](https://github.com/ilejn)).
* Добавлена недостающая поддержка `read_in_order_use_virtual_row` для `WHERE`. Это позволяет пропускать чтение большего числа частей для запросов с фильтрами, которые не были полностью протолкнуты в `PREWHERE`. [#84835](https://github.com/ClickHouse/ClickHouse/pull/84835) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено использование сериализации дискриминаторов Variant в compact-формате в MergeTree. Ранее она не использовалась в некоторых случаях, когда могла бы использоваться. [#84141](https://github.com/ClickHouse/ClickHouse/pull/84141) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлено ограничение (настройка таблицы [`max_uncompressed_bytes_in_patches`](/operations/settings/merge-tree-settings#max_uncompressed_bytes_in_patches)) на общее количество несжатых байт в patch parts. Оно предотвращает существенное замедление запросов `SELECT` после легковесных обновлений и возможное неправильное использование легковесных обновлений. [#85641](https://github.com/ClickHouse/ClickHouse/pull/85641) ([Anton Popov](https://github.com/CurtizJ)).

### Кэш и управление памятью {#cache-and-memory-management}

* Исправлена логическая ошибка в кэше файловой системы: «Having zero bytes but range is not finished». [#81868](https://github.com/ClickHouse/ClickHouse/pull/81868) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлено rendezvous-хеширование для улучшения локальности кэша. [#82511](https://github.com/ClickHouse/ClickHouse/pull/82511) ([Anton Ivashkin](https://github.com/ianton-ru)).
* Проведен рефакторинг механизма динамического изменения размера кэша файловой системы. Добавлено больше логов для анализа работы. [#82556](https://github.com/ClickHouse/ClickHouse/pull/82556) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Снижены накладные расходы на отслеживание использования памяти запросом для исполняемых пользовательских функций (UDF). [#83929](https://github.com/ClickHouse/ClickHouse/pull/83929) ([Eduard Karacharov](https://github.com/korowa)).
* Все выделения памяти, выполняемые внешними библиотеками, теперь видны трекеру памяти ClickHouse и корректно учитываются. Это может привести к «увеличенному» отображаемому использованию памяти для некоторых запросов или к ошибкам с `MEMORY_LIMIT_EXCEEDED`. [#84082](https://github.com/ClickHouse/ClickHouse/pull/84082) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Выделяется минимальный объём памяти, необходимый для `encrypted_buffer` в зашифрованных именованных коллекциях. [#84432](https://github.com/ClickHouse/ClickHouse/pull/84432) ([Pablo Marcos](https://github.com/pamarcos)).

### Индекс сходства векторов {#vector-similarity-index}

* Запрещено использовать значения `nan` и `inf` с `NumericIndexedVector`. Это исправляет [#82239](https://github.com/ClickHouse/ClickHouse/issues/82239) и ряд сопутствующих проблем. [#82681](https://github.com/ClickHouse/ClickHouse/pull/82681) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Индекс сходства векторов теперь поддерживает бинарную квантизацию. Бинарная квантизация существенно снижает потребление памяти и ускоряет процесс построения векторного индекса (за счёт более быстрого вычисления расстояния). Также существующая настройка `vector_search_postfilter_multiplier` признана устаревшей и заменена более общей настройкой: `vector_search_index_fetch_multiplier`. [#85024](https://github.com/ClickHouse/ClickHouse/pull/85024) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Приближённый поиск по векторам с использованием индексов сходства векторов теперь имеет статус GA. [#85888](https://github.com/ClickHouse/ClickHouse/pull/85888) ([Robert Schulze](https://github.com/rschu1ze)).

### Обработка ошибок и сообщения {#error-handling-and-messages}

* Заголовок Connection отправляется в конце заголовков, когда уже известно, должно ли быть сохранено соединение. [#81951](https://github.com/ClickHouse/ClickHouse/pull/81951) ([Sema Checherinda](https://github.com/CheSema)).
* В предыдущих версиях умножение состояния агрегатной функции на IPv4 приводило к логической ошибке вместо корректного кода ошибки. Закрывает [#82817](https://github.com/ClickHouse/ClickHouse/issues/82817). [#82818](https://github.com/ClickHouse/ClickHouse/pull/82818) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшена обработка ошибок в `AsynchronousMetrics`. Если каталог `/sys/block` существует, но недоступен, сервер будет запускаться без мониторинга блочных устройств. Закрывает [#79229](https://github.com/ClickHouse/ClickHouse/issues/79229). [#83115](https://github.com/ClickHouse/ClickHouse/pull/83115) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Была некорректная проверка зависимостей для `INSERT` с materialized views, которые содержат некорректные `SELECT`-запросы, и пользователь мог получить непонятное исключение `std::exception` вместо осмысленной ошибки с понятным объяснением. Теперь это исправлено. Исправляет: [#82889](https://github.com/ClickHouse/ClickHouse/issues/82889). [#83190](https://github.com/ClickHouse/ClickHouse/pull/83190) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Не выводить очень длинные описания операций выражений в сообщениях об исключениях. Закрывает [#83164](https://github.com/ClickHouse/ClickHouse/issues/83164). [#83350](https://github.com/ClickHouse/ClickHouse/pull/83350) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* При завершении работы хранилища `getStatus` генерирует исключение `ErrorCodes::ABORTED`. Ранее это приводило к ошибке запроса `SELECT`. Теперь мы перехватываем исключения `ErrorCodes::ABORTED` и намеренно их игнорируем. [#83435](https://github.com/ClickHouse/ClickHouse/pull/83435) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Сообщения об исключениях для некоторых ситуаций при загрузке и добавлении PROJECTION сделаны более читаемыми. [#83728](https://github.com/ClickHouse/ClickHouse/pull/83728) ([Robert Schulze](https://github.com/rschu1ze)).
* Теперь перед проверкой EOF выполняется проверка, отменено ли соединение, чтобы предотвратить чтение из закрытого соединения. Исправляет [#83893](https://github.com/ClickHouse/ClickHouse/issues/83893). [#84227](https://github.com/ClickHouse/ClickHouse/pull/84227) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Улучшена обработка завершения работы сервера для клиентских соединений за счёт упрощения внутренних проверок. [#84312](https://github.com/ClickHouse/ClickHouse/pull/84312) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Низкоуровневые ошибки во время выполнения UDF теперь приводят к ошибке с кодом `UDF_EXECUTION_FAILED`, тогда как ранее могли возвращаться разные коды ошибок. [#84547](https://github.com/ClickHouse/ClickHouse/pull/84547) ([Xu Jia](https://github.com/XuJia0210)).

### Улучшения форматирования SQL {#sql-formatting-improvements}

* Исправлено непоследовательное форматирование `CREATE DICTIONARY`. Закрывает [#82105](https://github.com/ClickHouse/ClickHouse/issues/82105). [#82829](https://github.com/ClickHouse/ClickHouse/pull/82829) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено непоследовательное форматирование `TTL`, когда он содержит функцию `materialize`. Закрывает [#82828](https://github.com/ClickHouse/ClickHouse/issues/82828). [#82831](https://github.com/ClickHouse/ClickHouse/pull/82831) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено непоследовательное форматирование `EXPLAIN AST` в подзапросе, когда он содержит параметры вывода, такие как INTO OUTFILE. Закрывает [#82826](https://github.com/ClickHouse/ClickHouse/issues/82826). [#82840](https://github.com/ClickHouse/ClickHouse/pull/82840) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено непоследовательное форматирование заключённых в скобки выражений с алиасами в контексте, где алиасы не допускаются. Закрывает [#82836](https://github.com/ClickHouse/ClickHouse/issues/82836). Закрывает [#82837](https://github.com/ClickHouse/ClickHouse/issues/82837). [#82867](https://github.com/ClickHouse/ClickHouse/pull/82867) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено форматирование `CREATE USER` с параметрами запроса (то есть `CREATE USER {username:Identifier} IDENTIFIED WITH no_password`). [#84376](https://github.com/ClickHouse/ClickHouse/pull/84376) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен разбор завершающей запятой в столбцах запроса `CREATE DICTIONARY` после столбца с параметрами, например, Decimal(8). Закрывает [#85586](https://github.com/ClickHouse/ClickHouse/issues/85586). [#85653](https://github.com/ClickHouse/ClickHouse/pull/85653) ([Nikolay Degterinsky](https://github.com/evillique)).

### Внешние интеграции {#external-integrations}

* Унифицированы имена параметров в ODBC и JDBC при использовании именованных коллекций. [#83410](https://github.com/ClickHouse/ClickHouse/pull/83410) ([Andrey Zvonov](https://github.com/zvonand)).
* MongoDB: добавлен неявный разбор строк в числовые типы. Ранее, если строковое значение поступало из источника MongoDB для числового столбца таблицы ClickHouse, возникало исключение. Теперь движок пытается автоматически преобразовать строку в числовое значение. Закрывает [#81167](https://github.com/ClickHouse/ClickHouse/issues/81167). [#84069](https://github.com/ClickHouse/ClickHouse/pull/84069) ([Kirill Nikiforov](https://github.com/allmazz)).
* Разрешено использование `simdjson` на неподдерживаемых архитектурах (ранее это приводило к ошибкам `CANNOT_ALLOCATE_MEMORY`). [#84966](https://github.com/ClickHouse/ClickHouse/pull/84966) ([Azat Khuzhin](https://github.com/azat)).

### Прочие улучшения {#miscellaneous-improvements}

* Добавлен движок таблицы Ytsaurus и соответствующая табличная функция. [#77606](https://github.com/ClickHouse/ClickHouse/pull/77606) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Улучшена функция HashJoin::needUsedFlagsForPerRightTableRow, теперь возвращает false для cross join. [#82379](https://github.com/ClickHouse/ClickHouse/pull/82379) ([lgbo](https://github.com/lgbo-ustc)).
* Разрешена запись/чтение столбцов map как массива кортежей. [#82408](https://github.com/ClickHouse/ClickHouse/pull/82408) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Этот PR был откатан. [#82884](https://github.com/ClickHouse/ClickHouse/pull/82884) ([Mithun p](https://github.com/mithunputhusseri)).
* Асинхронные логи: ограничено максимальное количество записей, удерживаемых в очереди. [#83214](https://github.com/ClickHouse/ClickHouse/pull/83214) ([Raúl Marín](https://github.com/Algunenano)).
* Включена поддержка Date/Date32 как целых чисел во входных форматах JSON. [#83597](https://github.com/ClickHouse/ClickHouse/pull/83597) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Улучшена поддержка индексов Bloom filter (обычных, ngram и token), чтобы они использовались в случаях, когда первый аргумент — константный массив (множество), а второй — индексируемый столбец (подмножество), что обеспечивает более эффективное выполнение запросов. [#84700](https://github.com/ClickHouse/ClickHouse/pull/84700) ([Doron David](https://github.com/dorki)).
* Разрешено приведение типов значений множеств при проталкивании фильтров `IN` / `GLOBAL IN` к первичным ключам хранилищ KeyValue (например, EmbeddedRocksDB, KeeperMap). [#84515](https://github.com/ClickHouse/ClickHouse/pull/84515) ([Eduard Karacharov](https://github.com/korowa)).
* Исключены полные сканы для случаев, когда анализ индекса даёт пустые диапазоны при параллельном чтении реплик. [#84971](https://github.com/ClickHouse/ClickHouse/pull/84971) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлен ряд проблем, которые могут возникать при попытке запускать интеграционные тесты на локальном хосте. [#82135](https://github.com/ClickHouse/ClickHouse/pull/82135) ([Oleg Doronin](https://github.com/dorooleg)).
* Параметр trace_log.symbolize по умолчанию включён для старых развертываний. [#85456](https://github.com/ClickHouse/ClickHouse/pull/85456) ([Azat Khuzhin](https://github.com/azat)).

#### Исправления ошибок (ошибки, приводящие к заметному для пользователя некорректному поведению в официальном стабильном релизе) {#bug-fixes}

### Оптимизации производительности {#performance-optimizations}

* Исправлена деградация производительности в SummingMergeTree, которая появилась в 25.5 в результате изменений из https://github.com/ClickHouse/ClickHouse/pull/79051. [#82130](https://github.com/ClickHouse/ClickHouse/pull/82130) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена деградация производительности с включённым analyzer, когда вторичные запросы всегда читают все столбцы из VIEW. Исправляет [#81718](https://github.com/ClickHouse/ClickHouse/issues/81718). [#83036](https://github.com/ClickHouse/ClickHouse/pull/83036) ([Dmitry Novik](https://github.com/novikd)).
* Отключена проверка циклических зависимостей при создании таблицы без зависимостей. Это устраняет деградацию производительности сценариев с созданием тысяч таблиц, которая появилась в результате изменений из https://github.com/ClickHouse/ClickHouse/pull/65405. [#83077](https://github.com/ClickHouse/ClickHouse/pull/83077) ([Pavel Kruglov](https://github.com/Avogar)).
* Обеспечено выполнение оконных агрегатов `DISTINCT` за линейное время и исправлена ошибка в `sumDistinct`. Закрывает [#79792](https://github.com/ClickHouse/ClickHouse/issues/79792). Закрывает [#52253](https://github.com/ClickHouse/ClickHouse/issues/52253). [#79859](https://github.com/ClickHouse/ClickHouse/pull/79859) ([Nihal Z. Miaji](https://github.com/nihalzp)).

### Исправления в выполнении запросов {#query-execution-fixes}

* Для запросов с комбинацией `ORDER BY ... LIMIT BY ... LIMIT N`, когда ORDER BY выполняется в режиме PartialSorting, счетчик `rows_before_limit_at_least` теперь отражает количество строк, обработанных оператором LIMIT, вместо количества строк, обработанных этапом сортировки. [#78999](https://github.com/ClickHouse/ClickHouse/pull/78999) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлена логическая ошибка при использовании оператора `<=>` с хранилищем Join, теперь запрос возвращает корректный код ошибки. [#80165](https://github.com/ClickHouse/ClickHouse/pull/80165) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлен сбой в функции `loop` при использовании с семейством функций `remote`. Обеспечено соблюдение оператора LIMIT в `loop(remote(...))`. [#80299](https://github.com/ClickHouse/ClickHouse/pull/80299) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлено некорректное поведение функций `to_utc_timestamp` и `from_utc_timestamp` при обработке дат до эпохи Unix (1970-01-01) и после максимальной даты (2106-02-07 06:28:15). Теперь эти функции корректно ограничивают значения началом эпохи и максимальной датой соответственно. [#80498](https://github.com/ClickHouse/ClickHouse/pull/80498) ([Surya Kant Ranjan](https://github.com/iit2009046)).
* Исправлено выполнение `IN` при `transform_null_in=1` с `NULL` в левом аргументе и результатом подзапроса, не допускающим `NULL`. [#81584](https://github.com/ClickHouse/ClickHouse/pull/81584) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена проблема, при которой требуемые столбцы не считывались при обработке скалярных коррелированных подзапросов. Исправляет [#81716](https://github.com/ClickHouse/ClickHouse/issues/81716). [#81805](https://github.com/ClickHouse/ClickHouse/pull/81805) ([Dmitry Novik](https://github.com/novikd)).
* Исправлен анализ фильтра для запроса, в котором используется только столбец с константным псевдонимом. Исправляет [#79448](https://github.com/ClickHouse/ClickHouse/issues/79448). [#82037](https://github.com/ClickHouse/ClickHouse/pull/82037) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена ошибка `Not found column` для запросов с `arrayJoin` в условии `WHERE` в сочетании с `IndexSet`. [#82113](https://github.com/ClickHouse/ClickHouse/pull/82113) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, приводившая к возникновению исключения `TOO_DEEP_SUBQUERIES`, когда определение CTE ссылается на другое табличное выражение с тем же именем. [#83413](https://github.com/ClickHouse/ClickHouse/pull/83413) ([Dmitry Novik](https://github.com/novikd)).
* Исправлен некорректный результат выполнения запросов с предложением `WHERE ... IN (<subquery>)` при включённом кэше условий запроса (настройка `use_query_condition_cache`). [#83445](https://github.com/ClickHouse/ClickHouse/pull/83445) ([LB7666](https://github.com/acking-you)).
* `INSERT SELECT` с `UNION ALL` могло приводить к разыменованию нулевого указателя в пограничном случае. Это исправляет [#83618](https://github.com/ClickHouse/ClickHouse/issues/83618). [#83643](https://github.com/ClickHouse/ClickHouse/pull/83643) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка `LOGICAL_ERROR`, возникавшая при анализе выражения политики строк для коррелированных столбцов. [#82618](https://github.com/ClickHouse/ClickHouse/pull/82618) ([Dmitry Novik](https://github.com/novikd)).
* Исправлены ошибочные результаты при использовании кэша условий запроса совместно с рекурсивными CTE (issue [#81506](https://github.com/ClickHouse/ClickHouse/issues/81506)). [#84026](https://github.com/ClickHouse/ClickHouse/pull/84026) ([zhongyuankai](https://github.com/zhongyuankai)).
* Исправлен бесконечный рекурсивный анализ некорректных определений `WINDOW`. Устраняет [#83131](https://github.com/ClickHouse/ClickHouse/issues/83131). [#84242](https://github.com/ClickHouse/ClickHouse/pull/84242) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена проблема с `Not-ready Set` при использовании `IN (subquery)` в параметре `additional_table_filters expression`. [#85210](https://github.com/ClickHouse/ClickHouse/pull/85210) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена логическая ошибка, приводившая к дублированию подзапросов при включённом `optimize_syntax_fuse_functions`, закрыт [#75511](https://github.com/ClickHouse/ClickHouse/issues/75511). [#83300](https://github.com/ClickHouse/ClickHouse/pull/83300) ([Vladimir Cherkasov](https://github.com/vdimir)).

### Исправления в Iceberg и DataLake {#iceberg-and-datalake-fixes}

* Исправлено разрешение метаданных при выполнении запросов к таблицам Iceberg через REST-каталог. ... [#80562](https://github.com/ClickHouse/ClickHouse/pull/80562) ([Saurabh Kumar Ojha](https://github.com/saurabhojha)).
* Исправлены гонки данных в Iceberg. [#82088](https://github.com/ClickHouse/ClickHouse/pull/82088) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка «Context has expired» для Iceberg. [#82146](https://github.com/ClickHouse/ClickHouse/pull/82146) ([Azat Khuzhin](https://github.com/azat)).
* Теперь ClickHouse может читать таблицы Iceberg из каталога Glue после эволюции схемы. Исправляет [#81272](https://github.com/ClickHouse/ClickHouse/issues/81272). [#82301](https://github.com/ClickHouse/ClickHouse/pull/82301) ([alesapin](https://github.com/alesapin)).
* Исправлены гонки данных в Iceberg. [#82841](https://github.com/ClickHouse/ClickHouse/pull/82841) ([Azat Khuzhin](https://github.com/azat)).
* Отключено отсечение файлов на основе границ для элементов массивов Iceberg и значений карт Iceberg, включая все их вложенные подполе. [#83520](https://github.com/ClickHouse/ClickHouse/pull/83520) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлена запись в Iceberg для сложных типов. [#85330](https://github.com/ClickHouse/ClickHouse/pull/85330) ([scanhex12](https://github.com/scanhex12)).
* Запись нижних и верхних границ не поддерживается для сложных типов. [#85332](https://github.com/ClickHouse/ClickHouse/pull/85332) ([scanhex12](https://github.com/scanhex12)).
* Исправлена поддержка NULL для полей в Iceberg. [#85977](https://github.com/ClickHouse/ClickHouse/pull/85977) ([scanhex12](https://github.com/scanhex12)).
* Больше не создаётся пустой файл удаления Iceberg. [#86061](https://github.com/ClickHouse/ClickHouse/pull/86061) ([scanhex12](https://github.com/scanhex12)).
* Обновляется временная метка метаданных при записях в Iceberg. [#85711](https://github.com/ClickHouse/ClickHouse/pull/85711) ([scanhex12](https://github.com/scanhex12)).
* Spark не может читать файлы `position delete`. [#85762](https://github.com/ClickHouse/ClickHouse/pull/85762) ([scanhex12](https://github.com/scanhex12)).
* Схема больше не берётся из manifest-файлов; вместо этого соответствующие схемы для каждого snapshot теперь хранятся независимо. Соответствующая схема для каждого data-файла выводится из его snapshot. Предыдущее поведение нарушало спецификацию Iceberg для записей manifest-файлов со статусом existing. [#84588](https://github.com/ClickHouse/ClickHouse/pull/84588) ([Daniil Ivanik](https://github.com/divanik)).
* Теперь Iceberg не пытается кэшировать актуальную версию snapshot между `SELECT`-запросами и каждый раз заново определяет snapshot. Более ранняя попытка кэширования snapshot Iceberg приводила к проблемам при использовании таблицы Iceberg с возможностью «time travel». [#85038](https://github.com/ClickHouse/ClickHouse/pull/85038) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлено разрешение метаданных при выполнении запросов к таблицам Iceberg через REST-каталог. ... [#85531](https://github.com/ClickHouse/ClickHouse/pull/85531) ([Saurabh Kumar Ojha](https://github.com/saurabhojha)).
* Исправлено маскирование секретов в табличных функциях icebergS3Cluster и icebergAzureCluster. [#85658](https://github.com/ClickHouse/ClickHouse/pull/85658) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).

### Исправления DeltaLake {#deltalake-fixes}

* Исправлено отсечение неиспользуемых столбцов (column pruning) с использованием delta-kernel в хранилище `DeltaLake`. Закрывает [#84543](https://github.com/ClickHouse/ClickHouse/issues/84543). [#84745](https://github.com/ClickHouse/ClickHouse/pull/84745) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено обновление учетных данных (credentials) в delta-kernel в хранилище DeltaLake. [#84751](https://github.com/ClickHouse/ClickHouse/pull/84751) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка сегментирования (segfault) в реализации delta-kernel. [#85160](https://github.com/ClickHouse/ClickHouse/pull/85160) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено состояние гонки (race condition) в реализации delta-kernel движка `DeltaLake`. [#85221](https://github.com/ClickHouse/ClickHouse/pull/85221) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено чтение партиционированных данных при отключенном delta-kernel в движке `DeltaLake`. Функциональность была нарушена в 25.7 (https://github.com/ClickHouse/ClickHouse/pull/81136). [#85223](https://github.com/ClickHouse/ClickHouse/pull/85223) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Для совместимости значение `allow_experimental_delta_kernel_rs` до версии 25.5 изменено на `false`. [#84587](https://github.com/ClickHouse/ClickHouse/pull/84587) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено чтение значения COUNT из кэша для DeltaLake. [#85704](https://github.com/ClickHouse/ClickHouse/pull/85704) ([Kseniia Sumarokova](https://github.com/kssenii)).

### Исправления TTL и MergeTree {#ttl-and-mergetree-fixes}

* Повторно вычисляется индекс min-max при уменьшении числа строк с помощью TTL, чтобы гарантировать корректность алгоритмов, которые на нём зависят, таких как `minmax_count_projection`. Исправляет [#77091](https://github.com/ClickHouse/ClickHouse/issues/77091). [#77166](https://github.com/ClickHouse/ClickHouse/pull/77166) ([Amos Bird](https://github.com/amosbird)).
* Исправлен некорректный пересчёт TTL в TTL GROUP BY при обновлении TTL. [#81222](https://github.com/ClickHouse/ClickHouse/pull/81222) ([Evgeniy Ulasik](https://github.com/H0uston)).
* Исправлена ошибка «Context has expired» во время слияний, когда словарь используется в выражении TTL. [#81690](https://github.com/ClickHouse/ClickHouse/pull/81690) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен LOGICAL_ERROR и последующее аварийное завершение работы при использовании одного и того же столбца в TTL для GROUP BY и SET. [#82054](https://github.com/ClickHouse/ClickHouse/pull/82054) ([Pablo Marcos](https://github.com/pamarcos)).
* MergeTree теперь не выполняет действий, связанных с TTL, если все TTL удалены из таблицы. [#84441](https://github.com/ClickHouse/ClickHouse/pull/84441) ([alesapin](https://github.com/alesapin)).
* Исправлено отсутствие проверки столбцов TTL в ключах сортировки при `ALTER MODIFY ORDER BY`. Столбцы TTL теперь корректно отклоняются при использовании в предложениях `ORDER BY` во время операций `ALTER`, что предотвращает возможную порчу таблицы. [#84536](https://github.com/ClickHouse/ClickHouse/pull/84536) ([xiaohuanlin](https://github.com/xiaohuanlin)).

### Исправления проекций {#projection-fixes}

* Исправлена логическая ошибка при материализации проекции, возникавшая при изменении типа столбца на Nullable. [#80741](https://github.com/ClickHouse/ClickHouse/pull/80741) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено некорректное использование метаданных родительской таблицы в табличной функции `mergeTreeProjection` при `enable_shared_storage_snapshot_in_query = 1`. Это относится к [#82634](https://github.com/ClickHouse/ClickHouse/issues/82634). [#82638](https://github.com/ClickHouse/ClickHouse/pull/82638) ([Amos Bird](https://github.com/amosbird)).
* Исправлен редкий сбой ClickHouse, который происходил, когда таблица содержала проекцию, был установлен `lightweight_mutation_projection_mode = 'rebuild'`, и пользователь выполнял легковесное удаление, удаляющее ВСЕ строки из любого блока в таблице. [#84158](https://github.com/ClickHouse/ClickHouse/pull/84158) ([alesapin](https://github.com/alesapin)).
* Исправлено резервное копирование частей с повреждёнными проекциями. [#85362](https://github.com/ClickHouse/ClickHouse/pull/85362) ([Antonio Andelic](https://github.com/antonio2368)).
* В релизах до стабилизации запрещено использование столбца `_part_offset` в проекциях. [#85372](https://github.com/ClickHouse/ClickHouse/pull/85372) ([Sema Checherinda](https://github.com/CheSema)).

### Исправления для параллельных реплик {#parallel-replicas-fixes}

* Для некоторых запросов, выполняемых с параллельными репликами, оптимизация чтения в заданном порядке могла применяться на инициаторе, но не на удалённых узлах. Это приводило к использованию разных режимов чтения координатором параллельных реплик (на инициаторе) и на удалённых узлах, что является логической ошибкой. [#80652](https://github.com/ClickHouse/ClickHouse/pull/80652) ([Igor Nikonov](https://github.com/devcrafter)).
* Параллельные реплики отключаются, если подзапрос содержит `FINAL` по задаче [#81401](https://github.com/ClickHouse/ClickHouse/issues/81401). [#83455](https://github.com/ClickHouse/ClickHouse/pull/83455) ([zoomxi](https://github.com/zoomxi)).
* Исправлена ошибка `LOGICAL_ERROR` для запросов с параллельными репликами и несколькими соединениями INNER, за которыми следует RIGHT JOIN. Для таких запросов параллельные реплики не используются. [#84299](https://github.com/ClickHouse/ClickHouse/pull/84299) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Запросы с параллельными репликами, которые используют оптимизацию чтения в обратном порядке, могли давать некорректный результат. [#85406](https://github.com/ClickHouse/ClickHouse/pull/85406) ([Igor Nikonov](https://github.com/devcrafter)).

### Аутентификация и безопасность {#authentication-and-security}

* Исправлено сокрытие значений именованных коллекций в журналах/query_log. Исправляет [#82405](https://github.com/ClickHouse/ClickHouse/issues/82405). [#82510](https://github.com/ClickHouse/ClickHouse/pull/82510) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Установлена соль для данных аутентификации при разборе из AST с типом SCRAM_SHA256_PASSWORD. [#82888](https://github.com/ClickHouse/ClickHouse/pull/82888) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Детали аутентификации в Avro schema registry теперь маскируются и не видны ни пользователю, ни в журналах. [#83713](https://github.com/ClickHouse/ClickHouse/pull/83713) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлено некорректное поведение, когда выполнение `REVOKE S3 ON system.*` отзывает права S3 для `*.*`. Это исправляет [#83417](https://github.com/ClickHouse/ClickHouse/issues/83417). [#83420](https://github.com/ClickHouse/ClickHouse/pull/83420) ([pufit](https://github.com/pufit)).
* Исправлен сбой сервера, когда пользователь, созданный с `no_password`, пытается войти после изменения серверной настройки `allow_no_password` на 0. [#84426](https://github.com/ClickHouse/ClickHouse/pull/84426) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Улучшено сообщение об ошибке при попытке создания пользователя, идентифицируемого по JWT. [#85072](https://github.com/ClickHouse/ClickHouse/pull/85072) ([Константин Богданов](https://github.com/thevar1able)).
* Добавлено маскирование учетных данных для `deltaLakeAzure`, `deltaLakeCluster`, `icebergS3Cluster` и `icebergAzureCluster`. [#85889](https://github.com/ClickHouse/ClickHouse/pull/85889) ([Julian Maicher](https://github.com/jmaicher)).
* Исправлена ошибка, допущенная в [#79963](https://github.com/ClickHouse/ClickHouse/pull/79963). При вставке в materialized view с definer'ом проверка прав должна использовать привилегии определяющего пользователя. Исправляет [#79951](https://github.com/ClickHouse/ClickHouse/issues/79951). [#83502](https://github.com/ClickHouse/ClickHouse/pull/83502) ([pufit](https://github.com/pufit)).

### Исправления резервного копирования и восстановления {#backup-and-restore-fixes}

* Исправлена проблема с резервным копированием пустой таблицы `Memory`, из-за которой восстановление из резервной копии завершалось с ошибкой `BACKUP_ENTRY_NOT_FOUND`. [#82791](https://github.com/ClickHouse/ClickHouse/pull/82791) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлено вводящее в заблуждение сообщение об ошибке при восстановлении резервной копии на диске, доступном только для чтения. [#83051](https://github.com/ClickHouse/ClickHouse/pull/83051) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлен запуск избыточных внутренних резервных копий после сбоев подключения. [#84755](https://github.com/ClickHouse/ClickHouse/pull/84755) ([Vitaly Baranov](https://github.com/vitlibar)).

### Оконные и агрегатные функции {#window-and-aggregate-functions}

* Исправлен возможный сбой в `Aggregator` в случае возникновения исключения во время слияния. [#81450](https://github.com/ClickHouse/ClickHouse/pull/81450) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлен возможный сбой в `Aggregator` в случае возникновения исключения во время слияния. [#82022](https://github.com/ClickHouse/ClickHouse/pull/82022) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена ошибка копирования и вставки в `arraySimilarity`, из-за которой были запрещены веса типов UInt32 и Int32. Обновлены тесты и документация. [#82103](https://github.com/ClickHouse/ClickHouse/pull/82103) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Исправлено переполнение в функциях `numericIndexedVectorPointwiseAdd`, `numericIndexedVectorPointwiseSubtract`, `numericIndexedVectorPointwiseMultiply`, `numericIndexedVectorPointwiseDivide`, которое возникало при их применении к большим числам. [#82165](https://github.com/ClickHouse/ClickHouse/pull/82165) ([Raufs Dunamalijevs](https://github.com/rienath)).

### Исправления для Parquet и форматов файлов {#parquet-and-file-format-fixes}

* Исправлена ошибка в Bloom-фильтре Parquet, при которой условие вида `WHERE function(key) IN (...)` ошибочно применялось как `WHERE key IN (...)`. [#81255](https://github.com/ClickHouse/ClickHouse/pull/81255) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена ошибка в модуле записи Parquet, приводившая к сохранению некорректной статистики (min/max) для типов Decimal. [#83754](https://github.com/ClickHouse/ClickHouse/pull/83754) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена десериализация `groupArraySample`/`groupArrayLast` в случае пустых элементов (десериализация могла пропускать часть бинарных данных, если вход был пустым, что могло приводить к повреждению при чтении данных и UNKNOWN_PACKET_FROM_SERVER в протоколе TCP). Это не затрагивает числовые типы и типы даты/времени. [#82763](https://github.com/ClickHouse/ClickHouse/pull/82763) ([Pedro Ferreira](https://github.com/PedroTadim)).
* Исправлена запись JSON-путей со значениями NULL в формате RowBinary. [#83923](https://github.com/ClickHouse/ClickHouse/pull/83923) ([Pavel Kruglov](https://github.com/Avogar)).

### Исправления JOIN {#join-fixes}

* Исправлена модификация фильтра для запросов с выражением JOIN с таблицей на движке `Merge`. Исправляет [#82092](https://github.com/ClickHouse/ClickHouse/issues/82092). [#82950](https://github.com/ClickHouse/ClickHouse/pull/82950) ([Dmitry Novik](https://github.com/novikd)).
* Исправлен сбой при JOIN с key-value-хранилищем, если ключ приведён к другому типу. [#82497](https://github.com/ClickHouse/ClickHouse/pull/82497) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлена логическая ошибка при разрешении matcher в запросе с несколькими JOIN, закрывает [#81969](https://github.com/ClickHouse/ClickHouse/issues/81969). [#82421](https://github.com/ClickHouse/ClickHouse/pull/82421) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлено встраивание фильтра в условие JOIN в случаях, когда операнды равенства имеют разные типы или ссылаются на константы. Исправляет [#83432](https://github.com/ClickHouse/ClickHouse/issues/83432). [#84145](https://github.com/ClickHouse/ClickHouse/pull/84145) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена логическая ошибка `Expected single dictionary argument for function` при выполнении JOIN по условию неравенства, когда один из столбцов имеет тип `LowCardinality`, а другой является константой. Закрывает [#81779](https://github.com/ClickHouse/ClickHouse/issues/81779). [#84019](https://github.com/ClickHouse/ClickHouse/pull/84019) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Исправления для реплицируемых баз данных {#replicated-database-fixes}

* Исправлена функция `markReplicasActive` в `DDLWorker` и `DatabaseReplicatedDDLWorker`. [#81395](https://github.com/ClickHouse/ClickHouse/pull/81395) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлен `DatabaseReplicated::getClusterImpl`. Если первый элемент (или элементы) в `hosts` имеет `id == DROPPED_MARK` и нет других элементов для того же сегмента, первый элемент в `shards` будет пустым вектором, что приводит к `std::out_of_range`. [#82093](https://github.com/ClickHouse/ClickHouse/pull/82093) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Добавлено отслеживание количества задач асинхронной загрузки таблиц. Если выполняются какие-либо задачи, `tail_ptr` в `TransactionLog::removeOldEntries` не обновляется. [#82824](https://github.com/ClickHouse/ClickHouse/pull/82824) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлена проблема, при которой, если таблица MergeTree создаётся с `add_minmax_index_for_numeric_columns=1` или `add_minmax_index_for_string_columns=1`, индекс позже материализуется во время операции `ALTER` и мешает корректной инициализации реплицируемой базы данных на новой реплике. [#83751](https://github.com/ClickHouse/ClickHouse/pull/83751) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлено создание RMV на новой реплике реплицируемой базы данных, если `DEFINER` был удалён. [#85327](https://github.com/ClickHouse/ClickHouse/pull/85327) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлено восстановление реплицируемых баз данных, когда перемещение файла метаданных занимает много времени. [#85177](https://github.com/ClickHouse/ClickHouse/pull/85177) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Реализовано принудительное восстановление реплицируемой базы данных после восстановления метаданных базы в Keeper. [#85960](https://github.com/ClickHouse/ClickHouse/pull/85960) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлена ошибка при восстановлении базы данных `Replicated`: если имя таблицы содержит символ `%`, во время восстановления таблица могла быть пересоздана с другим именем. [#85987](https://github.com/ClickHouse/ClickHouse/pull/85987) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Теперь `DDLWorker` удаляет устаревшие хосты из набора реплик. Это уменьшит объём хранимых метаданных в ZooKeeper. [#88154](https://github.com/ClickHouse/ClickHouse/pull/88154) ([alesapin](https://github.com/alesapin)).

### Исправления для легковесных обновлений {#lightweight-updates-fixes}

* Исправлены легковесные обновления для таблиц с движками `ReplacingMergeTree` и `CollapsingMergeTree`. [#84851](https://github.com/ClickHouse/ClickHouse/pull/84851) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена логическая ошибка в легковесных обновлениях, которые обновляют все столбцы в таблице. [#84380](https://github.com/ClickHouse/ClickHouse/pull/84380) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены легковесные обновления для таблиц с движком `ReplicatedMergeTree`, созданных на серверах версии ниже 25.7. [#84933](https://github.com/ClickHouse/ClickHouse/pull/84933) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены легковесные обновления для таблиц с нереплицируемым движком `MergeTree` после выполнения запроса `ALTER TABLE ... REPLACE PARTITION`. [#84941](https://github.com/ClickHouse/ClickHouse/pull/84941) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена очистка частей-патчей в `ReplicatedMergeTree`. Ранее результат легковесного обновления мог временно не отображаться на реплике до тех пор, пока слитая или мутировавшая часть, в которой материализованы части-патчи, не будет загружена с другой реплики. [#85121](https://github.com/ClickHouse/ClickHouse/pull/85121) ([Anton Popov](https://github.com/CurtizJ)).

### Исправления для S3 и объектного хранилища {#s3-and-object-storage-fixes}

* Исправлена проверка аргументов табличной функции S3 при маскировании секретов, предотвращающая возможную ошибку `LOGICAL_ERROR`, что позволяет закрыть [#80620](https://github.com/ClickHouse/ClickHouse/issues/80620). [#82056](https://github.com/ClickHouse/ClickHouse/pull/82056) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлена возможная взаимоблокировка при удалённых запросах, когда сервер испытывает дефицит памяти. [#82160](https://github.com/ClickHouse/ClickHouse/pull/82160) ([Kirill](https://github.com/kirillgarbar)).
* Для токена AWS ECS добавлен срок действия, чтобы его можно было обновлять. [#82422](https://github.com/ClickHouse/ClickHouse/pull/82422) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлено отключение выравнивания по границе для кэшированного буфера во внешних табличных движках. Поведение было нарушено в https://github.com/ClickHouse/ClickHouse/pull/81868. [#82493](https://github.com/ClickHouse/ClickHouse/pull/82493) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен `no_sign_request` для клиента S3. Этот параметр можно использовать, чтобы явно отключить подпись запросов к S3. Его также можно задавать для конкретных endpoint'ов с использованием настроек на основе endpoint'ов. [#83379](https://github.com/ClickHouse/ClickHouse/pull/83379) ([Antonio Andelic](https://github.com/antonio2368)).
* Теперь пропускаются недоступные узлы при выполнении INSERT SELECT из s3Cluster() в реплицированный MergeTree. [#83676](https://github.com/ClickHouse/ClickHouse/pull/83676) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлено условие раннего выхода для замедления скорости запросов к S3: теперь для включения поведения замедления, когда все потоки приостановлены из-за повторяемой ошибки, требуется, чтобы было истинно хотя бы одно из s3_slow_all_threads_after_network_error или backup_slow_all_threads_after_retryable_s3_error вместо требования истинности обоих. [#85505](https://github.com/ClickHouse/ClickHouse/pull/85505) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлена логическая ошибка при чтении из функций объектного хранилища через Distributed-таблицу или табличную функцию remote(). Исправляет: [#84658](https://github.com/ClickHouse/ClickHouse/issues/84658), исправляет [#85173](https://github.com/ClickHouse/ClickHouse/issues/85173), исправляет [#52022](https://github.com/ClickHouse/ClickHouse/issues/52022). [#85359](https://github.com/ClickHouse/ClickHouse/pull/85359) ([alesapin](https://github.com/alesapin)).
* Исправлена логическая ошибка в S3Queue «Table is already registered». Закрывает [#84433](https://github.com/ClickHouse/ClickHouse/issues/84433). Проблема появилась после https://github.com/ClickHouse/ClickHouse/pull/83530. [#84677](https://github.com/ClickHouse/ClickHouse/pull/84677) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено влияние больших значений настроек, из-за которых ломались таблицы S3Queue и перезапуск реплики. [#86074](https://github.com/ClickHouse/ClickHouse/pull/86074) ([Nikolay Degterinsky](https://github.com/evillique)).

### DynamicAndVariantTypeFixes {#dynamicandvarianttypefixes}

* Исправлен откат столбца Dynamic при ошибке разбора. [#82169](https://github.com/ClickHouse/ClickHouse/pull/82169) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено возможное аварийное завершение для типа Variant в UNION. [#83295](https://github.com/ClickHouse/ClickHouse/pull/83295) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено чтение столбца Variant с ленивой материализацией. [#84400](https://github.com/ClickHouse/ClickHouse/pull/84400) ([Pavel Kruglov](https://github.com/Avogar)).
* Отключена проверка экспериментальных/подозрительных типов при выполнении выражений DEFAULT/MATERIALIZE при чтении из существующей таблицы. [#81618](https://github.com/ClickHouse/ClickHouse/pull/81618) ([Pavel Kruglov](https://github.com/Avogar)).

### Исправления в Keeper {#keeper-fixes}

* Исправлено: корректное обновление общего счётчика наблюдений при удалении эфемерных узлов при закрытии сессии. [#83583](https://github.com/ClickHouse/ClickHouse/pull/83583) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлены внеочередные записи в changelog Keeper. Ранее могли выполняться незавершённые записи в changelog, а откат мог приводить к конкурентному изменению файла назначения. Это приводило к неконсистентным логам и возможной потере данных. [#84434](https://github.com/ClickHouse/ClickHouse/pull/84434) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлены утечки для Keeper с хранилищем на RocksDB (итераторы не уничтожались). [#84523](https://github.com/ClickHouse/ClickHouse/pull/84523) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема, при которой настройка Keeper `rotate_log_storage_interval = 0` приводила к сбою ClickHouse (issue [#83975](https://github.com/ClickHouse/ClickHouse/issues/83975)). [#84637](https://github.com/ClickHouse/ClickHouse/pull/84637) ([George Larionov](https://github.com/george-larionov)).
* Исправлен общий счётчик наблюдений, возвращаемый Keeper. [#84890](https://github.com/ClickHouse/ClickHouse/pull/84890) ([Antonio Andelic](https://github.com/antonio2368)).
* Теперь `mutex` блокируется при получении `zookeeper` из `view` в RefreshTask. [#84699](https://github.com/ClickHouse/ClickHouse/pull/84699) ([Tuan Pham Anh](https://github.com/tuanpach)).

### Исправления индексации {#indexing-fixes}

* Исправлено избыточное пропускание гранул при фильтрации по token/ngram-индексам с регулярным выражением, содержащим альтернативы и нелитеральную первую альтернативу. [#79373](https://github.com/ClickHouse/ClickHouse/pull/79373) ([Eduard Karacharov](https://github.com/korowa)).
* Реализация настройки `use_skip_indexes_if_final_exact_mode` (введена в 25.6) могла не выбрать подходящий кандидатный диапазон в зависимости от настроек движка `MergeTree` и распределения данных. Это исправлено. [#82667](https://github.com/ClickHouse/ClickHouse/pull/82667) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Оптимизация настройки `use_skip_indexes_if_final_exact_mode` (введена в 25.6) могла не выбрать подходящий кандидатный диапазон в зависимости от настроек движка `MergeTree` и распределения данных. Это исправлено. [#82879](https://github.com/ClickHouse/ClickHouse/pull/82879) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Ранее индексы `set` не учитывали столбцы типа `Nullable` при проверке, проходят ли гранулы фильтр (проблема [#75485](https://github.com/ClickHouse/ClickHouse/issues/75485)). [#84305](https://github.com/ClickHouse/ClickHouse/pull/84305) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Сравнение со значением NaN использовало некорректные диапазоны при вычислении индекса `MinMax`. [#84386](https://github.com/ClickHouse/ClickHouse/pull/84386) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Токенайзеры `ngram` и `no_op` больше не приводят к падению (экспериментального) текстового индекса при пустых входных токенах. [#84849](https://github.com/ClickHouse/ClickHouse/pull/84849) ([Robert Schulze](https://github.com/rschu1ze)).

### Исправления materialized view {#materialized-view-fixes}

* Исправлена ошибка в зависимостях таблиц, из-за которой materialized view пропускали запросы INSERT. [#82222](https://github.com/ClickHouse/ClickHouse/pull/82222) ([Nikolay Degterinsky](https://github.com/evillique)).
* После https://github.com/ClickHouse/ClickHouse/pull/79963 использование подстолбцов в materialized view было нарушено, и пользователь мог получать ошибку `Not found column X in block`. Это поведение исправлено. Исправлено в: [#82784](https://github.com/ClickHouse/ClickHouse/issues/82784). [#83221](https://github.com/ClickHouse/ClickHouse/pull/83221) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена ошибка illegal_type_of_argument в materialized view, возникавшая при различии типов. [#85135](https://github.com/ClickHouse/ClickHouse/pull/85135) ([Sema Checherinda](https://github.com/CheSema)).

### Исправления для Azure и облачных хранилищ {#azure-and-cloud-storage-fixes}

* В AzureBlobStorage при нативном копировании (native copy) мы сравниваем методы аутентификации; если при этом возникает исключение, код обновлён так, чтобы выполнялся откат к чтению и копированию (т.е. к не нативному копированию, non-native copy). [#82693](https://github.com/ClickHouse/ClickHouse/pull/82693) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Исправлено двойное освобождение памяти в `AzureIteratorAsync`. [#85064](https://github.com/ClickHouse/ClickHouse/pull/85064) ([Nikita Taranov](https://github.com/nickitat)).

### Исправления сбоев и улучшения стабильности {#crash-and-stability-fixes}

* Исправлен возможный сбой при логировании во время завершения сессии, поскольку поле `user_id` иногда может быть пустым. [#82513](https://github.com/ClickHouse/ClickHouse/pull/82513) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлен сбой в клиенте из-за соединения, оставшегося в состоянии отключения после некорректного `INSERT`. [#83253](https://github.com/ClickHouse/ClickHouse/pull/83253) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен сбой при вычислении размера блока с пустыми столбцами. [#83271](https://github.com/ClickHouse/ClickHouse/pull/83271) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлен сбой, который мог возникать для запроса с настройкой `max_threads=1` при выполнении под нагрузкой с включённым планированием по CPU. [#83387](https://github.com/ClickHouse/ClickHouse/pull/83387) ([Fan Ziqi](https://github.com/f2quantum)).
* Сделано так, что `zoutofmemory` считается аппаратной ошибкой, в противном случае будет выбрасываться логическая ошибка. См. https://github.com/clickhouse/clickhouse-core-incidents/issues/877. [#84420](https://github.com/ClickHouse/ClickHouse/pull/84420) ([Han Fei](https://github.com/hanfei1991)).
* Исправлено возможное аварийное завершение (из‑за ожидания завершения потоков из задачи) и, надеемся, зависания (в модульных тестах) при остановке `BackgroundSchedulePool`. [#83769](https://github.com/ClickHouse/ClickHouse/pull/83769) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена взаимоблокировка, вызванная фоновым потоком проверки отмены. [#84203](https://github.com/ClickHouse/ClickHouse/pull/84203) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена взаимоблокировка при завершении работы из‑за рекурсивной блокировки контекста во время очистки library bridge. [#83824](https://github.com/ClickHouse/ClickHouse/pull/83824) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен сбой в клиенте из-за соединения, оставшегося в состоянии отключения после некорректного `INSERT`. [#83842](https://github.com/ClickHouse/ClickHouse/pull/83842) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено возможное UB (undefined behavior, приводящее к сбоям) в случае `MEMORY_LIMIT_EXCEEDED` во время десериализации String. [#85440](https://github.com/ClickHouse/ClickHouse/pull/85440) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен редкий сбой в асинхронных вставках, которые изменяют настройки `log_comment` или `insert_deduplication_token`. [#85540](https://github.com/ClickHouse/ClickHouse/pull/85540) ([Anton Popov](https://github.com/CurtizJ)).

### Исправления для Glue и каталогов {#glue-and-catalog-fixes}

* Исправлена ошибка в интеграции с Glue Catalog. Теперь ClickHouse может читать таблицы с вложенными типами данных, где некоторые подстолбцы содержат значения DECIMAL, например: `map<string, decimal(9, 2)>`. Исправляет [#81301](https://github.com/ClickHouse/ClickHouse/issues/81301). [#82114](https://github.com/ClickHouse/ClickHouse/pull/82114) ([alesapin](https://github.com/alesapin)).
* ClickHouse теперь читает таблицы из Glue Catalog, где тип таблицы указан строчными буквами. [#84316](https://github.com/ClickHouse/ClickHouse/pull/84316) ([alesapin](https://github.com/alesapin)).
* Unity Catalog теперь игнорирует схемы с нестандартными типами данных для таблиц, не являющихся Delta-таблицами. Исправляет [#85699](https://github.com/ClickHouse/ClickHouse/issues/85699). [#85950](https://github.com/ClickHouse/ClickHouse/pull/85950) ([alesapin](https://github.com/alesapin)).

### Исправления функций {#function-fixes}

* Функции `trim{Left,Right,Both}` теперь поддерживают входные строки типа `FixedString(N)`. Например, `SELECT trimBoth(toFixedString('abc', 3), 'ac')` теперь работает. [#82691](https://github.com/ClickHouse/ClickHouse/pull/82691) ([Robert Schulze](https://github.com/rschu1ze)).
* Функция `trim`, вызываемая со всеми константными аргументами, теперь возвращает константную выходную строку. (Ошибка [#78796](https://github.com/ClickHouse/ClickHouse/issues/78796)). [#82900](https://github.com/ClickHouse/ClickHouse/pull/82900) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлен некорректный вывод функции `formatDateTime` при использовании спецификатора формата `%f` вместе со спецификаторами переменной длины (например, `%M`). [#83020](https://github.com/ClickHouse/ClickHouse/pull/83020) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена ошибка обработки аргументов `NULL` в функции `CASE`. [#82436](https://github.com/ClickHouse/ClickHouse/pull/82436) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исключено использование несвязанных частей общего словаря в функции `lowCardinalityKeys`. [#83118](https://github.com/ClickHouse/ClickHouse/pull/83118) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлены функции `colorSRGBToOKLCH` / `colorOKLCHToSRGB` для сочетания константных и неконстантных аргументов. [#83906](https://github.com/ClickHouse/ClickHouse/pull/83906) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено некорректное построение пустых кортежей в функции `array()`. Это исправляет [#84202](https://github.com/ClickHouse/ClickHouse/issues/84202). [#84297](https://github.com/ClickHouse/ClickHouse/pull/84297) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка, приводившая к некорректному кодированию и декодированию Bech32. Изначально ошибка не была обнаружена, поскольку онлайн-реализация алгоритма, использованная для тестирования, имела ту же проблему. [#84257](https://github.com/ClickHouse/ClickHouse/pull/84257) ([George Larionov](https://github.com/george-larionov)).

### Исправления для распределённых запросов {#distributed-query-fixes}

* Параллельный распределённый `INSERT SELECT` с `LIMIT` был разрешён, что некорректно и приводило к дублированию данных в целевой таблице. [#84477](https://github.com/ClickHouse/ClickHouse/pull/84477) ([Igor Nikonov](https://github.com/devcrafter)).
* Больше не выполняется подстановка табличных функций их кластерными аналогами при наличии `JOIN` или подзапроса. [#84335](https://github.com/ClickHouse/ClickHouse/pull/84335) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Добавлена проверка на использование коррелированного подзапроса в распределённом контексте для предотвращения аварийного завершения. Исправляет [#82205](https://github.com/ClickHouse/ClickHouse/issues/82205). [#85030](https://github.com/ClickHouse/ClickHouse/pull/85030) ([Dmitry Novik](https://github.com/novikd)).
* Использование `distributed_depth` в качестве индикатора функции `*Cluster` было некорректным и могло приводить к дублированию данных; вместо этого используется `client_info.collaborate_with_initiator`. [#85734](https://github.com/ClickHouse/ClickHouse/pull/85734) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Добавлена поддержка глобальных констант из оператора `WITH` для параллельного распределённого `INSERT SELECT` с целевой таблицей `Distributed`. Ранее запрос мог приводить к ошибке `Unknown expression identifier`. [#85811](https://github.com/ClickHouse/ClickHouse/pull/85811) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена логическая ошибка при попытке выполнить `CREATE ... AS (SELECT * FROM s3Cluster(...))` с `DatabaseReplicated`. [#85904](https://github.com/ClickHouse/ClickHouse/pull/85904) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Добавлены проверки `sharding_key` при выполнении `ALTER` для distributed таблицы. Ранее некорректный `ALTER` мог повредить определение таблицы и сделать невозможным перезапуск сервера. [#86015](https://github.com/ClickHouse/ClickHouse/pull/86015) ([Nikolay Degterinsky](https://github.com/evillique)).

### Исправления метрик и мониторинга {#metrics-and-monitoring-fixes}

* Исправлена валидация настроек асинхронных метрик `asynchronous_metrics_update_period_s` и `asynchronous_heavy_metrics_update_period_s`. [#82310](https://github.com/ClickHouse/ClickHouse/pull/82310) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлены метрики `IndexUncompressedCacheBytes`/`IndexUncompressedCacheCells`/`IndexMarkCacheBytes`/`IndexMarkCacheFiles` (ранее они учитывались в метрике без префикса `Cache`). [#83730](https://github.com/ClickHouse/ClickHouse/pull/83730) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен `LOGICAL_ERROR` в QueryMetricLog: мьютекс не может быть `NULL`. [#82979](https://github.com/ClickHouse/ClickHouse/pull/82979) ([Pablo Marcos](https://github.com/pamarcos)).
* Исправлены некорректные метрики `KafkaAssignedPartitions` и `KafkaConsumersWithAssignment`. [#85494](https://github.com/ClickHouse/ClickHouse/pull/85494) ([Ilya Golshtein](https://github.com/ilejn)).
* Исправлено занижение статистики по обработанным байтам при использовании `PREWHERE` (явного или автоматического). [#85495](https://github.com/ClickHouse/ClickHouse/pull/85495) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлено расхождение учёта памяти из пула фоновых задач планировщика и исполнителя. [#84946](https://github.com/ClickHouse/ClickHouse/pull/84946) ([Azat Khuzhin](https://github.com/azat)).

### Исправления типов данных и преобразований {#data-type-and-conversion-fixes}

* Исправлены случаи, когда парсинг Time мог приводить к проблемам MSan. Исправляет: [#82477](https://github.com/ClickHouse/ClickHouse/issues/82477). [#82514](https://github.com/ClickHouse/ClickHouse/pull/82514) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена сортировка значений NaN в типе `LowCardinality(Float32|Float64|BFloat16)`. [#83786](https://github.com/ClickHouse/ClickHouse/pull/83786) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлено переполнение больших значений (\>2106-02-07) при приведении типа из `Date` к типу `DateTime64`. [#83982](https://github.com/ClickHouse/ClickHouse/pull/83982) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена проблема с неявным чтением отрицательных значений Time в таблицу и уточнена документация. [#83091](https://github.com/ClickHouse/ClickHouse/pull/83091) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Кодек `DoubleDelta` теперь может быть применён только к столбцам числового типа. В частности, столбцы типа `FixedString` больше не могут сжиматься с помощью `DoubleDelta`. (исправляет [#80220](https://github.com/ClickHouse/ClickHouse/issues/80220)). [#84383](https://github.com/ClickHouse/ClickHouse/pull/84383) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
* Исправлена потеря точности в `JSONExtract` при преобразовании чисел JSON в типы Decimal. Теперь числовые значения JSON сохраняют своё точное десятичное представление, что позволяет избежать ошибок округления при вычислениях с плавающей запятой. [#85665](https://github.com/ClickHouse/ClickHouse/pull/85665) ([ssive7b](https://github.com/ssive7b)).

### Управление памятью и ресурсами {#memory-and-resource-management}

* Исправлена некорректная работа с памятью вокруг `max_untracked_memory`. [#83607](https://github.com/ClickHouse/ClickHouse/pull/83607) ([Azat Khuzhin](https://github.com/azat)).
* Не использовать общие `async_read_counters` для разных запросов. [#83423](https://github.com/ClickHouse/ClickHouse/pull/83423) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены возможные ошибки «file cache not initialized», возникавшие при использовании кэша файлов как временного хранилища данных. [#83539](https://github.com/ClickHouse/ClickHouse/pull/83539) ([Bharat Nallan](https://github.com/bharatnc)).
* Всегда применять `filesystem_prefetches_limit` (не только из `MergeTreePrefetchedReadPool`). [#83999](https://github.com/ClickHouse/ClickHouse/pull/83999) ([Azat Khuzhin](https://github.com/azat)).

### Исправления конфигурации и настроек {#configuration-and-settings-fixes}

* При передаче настроек через URI учитывается последнее значение. [#82137](https://github.com/ClickHouse/ClickHouse/pull/82137) ([Sema Checherinda](https://github.com/CheSema)).
* Исправлены гонки данных в клиенте (за счёт отказа от использования глобального контекста) и переопределения `session_timezone` (ранее в случае, когда `session_timezone` был установлен, например, в `users.xml`/опциях клиента в непустое значение, а в контексте запроса — в пустое, использовалось значение из `users.xml`, что некорректно; теперь контекст запроса всегда имеет приоритет над глобальным контекстом). [#82444](https://github.com/ClickHouse/ClickHouse/pull/82444) ([Azat Khuzhin](https://github.com/azat)).
* Запрещено устанавливать `threadpool_writer_pool_size` в ноль, чтобы избежать зависаний серверных операций. [#82532](https://github.com/ClickHouse/ClickHouse/pull/82532) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлено незначительное переполнение целого числа в конфигурации настройки `role_cache_expiration_time_seconds` (проблема [#83374](https://github.com/ClickHouse/ClickHouse/issues/83374)). [#83461](https://github.com/ClickHouse/ClickHouse/pull/83461) ([wushap](https://github.com/wushap)).
* Запрещено нулевое значение для `max_insert_block_size`, так как оно могло вызывать логическую ошибку. [#83688](https://github.com/ClickHouse/ClickHouse/pull/83688) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлен бесконечный цикл в `estimateCompressionRatio()` при `block_size_bytes=0`. [#83704](https://github.com/ClickHouse/ClickHouse/pull/83704) ([Azat Khuzhin](https://github.com/azat)).
* Параметры вроде `date_time_input_format` ранее просто игнорировались при использовании HTTP с multipart-запросами. [#85570](https://github.com/ClickHouse/ClickHouse/pull/85570) ([Sema Checherinda](https://github.com/CheSema)).

### Исправления MongoDB {#mongodb-fixes}

* Ранее определения движка таблиц `MongoDB` могли включать компонент пути в аргументе `host:port`, который просто игнорировался. Интеграция с MongoDB отказывалась загружать такие таблицы. С этим исправлением *допускается загрузка таких таблиц с игнорированием компонента пути*, если у движка `MongoDB` пять аргументов, при этом используется имя базы данных из аргументов. *Примечание:* Исправление не применяется к новым таблицам или запросам с табличной функцией `mongo`, а также к источникам словарей и именованным коллекциям. [#81942](https://github.com/ClickHouse/ClickHouse/pull/81942) ([Vladimir Cherkasov](https://github.com/vdimir)).

### Разные исправления {#miscellaneous-fixes}

* В предыдущих версиях сервер возвращал лишний контент в ответ на запросы к `/js`. Это закрывает [#61890](https://github.com/ClickHouse/ClickHouse/issues/61890). [#81895](https://github.com/ClickHouse/ClickHouse/pull/81895) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлен метод `InterpreterInsertQuery::extendQueryLogElemImpl`, чтобы при необходимости добавлялись обратные кавычки вокруг имён баз данных и таблиц (например, когда имена содержат специальные символы, такие как `-`). [#81528](https://github.com/ClickHouse/ClickHouse/pull/81528) ([Ilia Shvyrialkin](https://github.com/Harzu)).
* Исправлена возможная гонка данных между потоком подсказок и основным потоком клиента. [#82233](https://github.com/ClickHouse/ClickHouse/pull/82233) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена безопасность при возникновении исключений в переписывании union/intersect/except&#95;default&#95;mode. Закрывает [#82664](https://github.com/ClickHouse/ClickHouse/issues/82664). [#82820](https://github.com/ClickHouse/ClickHouse/pull/82820) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* При использовании некеширующей реализации Database метаданные соответствующей таблицы удаляются после возврата столбцов и аннулирования ссылки. [#82939](https://github.com/ClickHouse/ClickHouse/pull/82939) ([buyval01](https://github.com/buyval01)).
* Вызов onprogress в JSONEachRowWithProgress теперь синхронизирован с финализацией. [#83879](https://github.com/ClickHouse/ClickHouse/pull/83879) ([Sema Checherinda](https://github.com/CheSema)).
* Исправлена редкая ошибка, из-за которой запрос `MATERIALIZE COLUMN` мог приводить к появлению неожиданных файлов в `checksums.txt` и в итоге — к отсоединению частей данных. [#84007](https://github.com/ClickHouse/ClickHouse/pull/84007) ([alesapin](https://github.com/alesapin)).
* Обеспечена корректная обработка исключений при периодическом обновлении частей. [#84083](https://github.com/ClickHouse/ClickHouse/pull/84083) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена генерация имен столбцов для булевых литералов: теперь используются &quot;true&quot;/&quot;false&quot; вместо &quot;1&quot;/&quot;0&quot;, что предотвращает конфликты имен столбцов между булевыми и целочисленными литералами в запросах. [#84945](https://github.com/ClickHouse/ClickHouse/pull/84945) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Исправлены потенциальные проблемы с некорректной сортировкой в движке таблиц Merge. [#85025](https://github.com/ClickHouse/ClickHouse/pull/85025) ([Xiaozhe Yu](https://github.com/wudidapaopao)).
* Реализованы недостающие API для DiskEncrypted. [#85028](https://github.com/ClickHouse/ClickHouse/pull/85028) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена настройка обратной совместимости, позволяющая новому анализатору в случае конфликта имён ссылаться на внешний псевдоним в секции `WITH`. Исправляет [#82700](https://github.com/ClickHouse/ClickHouse/issues/82700). [#83797](https://github.com/ClickHouse/ClickHouse/pull/83797) ([Dmitry Novik](https://github.com/novikd)).
* Разрешена возможность ссылаться на любую таблицу в аргументе `view(...)` табличной функции `remote` при включённом анализаторе. Исправлены [#78717](https://github.com/ClickHouse/ClickHouse/issues/78717) и [#79377](https://github.com/ClickHouse/ClickHouse/issues/79377). [#83844](https://github.com/ClickHouse/ClickHouse/pull/83844) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена работа записи с добавлением (в MergeTree, используемом для экспериментальных транзакций) для типов метаданных `plain_rewritable`/`plain`, которые ранее просто игнорировались. [#83695](https://github.com/ClickHouse/ClickHouse/pull/83695) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлено использование логгера в `IAccessStorage`. [#84365](https://github.com/ClickHouse/ClickHouse/pull/84365) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлено отсечение файлов по виртуальному столбцу в озёрах данных. [#84520](https://github.com/ClickHouse/ClickHouse/pull/84520) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проблема, из-за которой при выполнении запроса к удалённому источнику с задержкой мог происходить выход за границы вектора. [#84820](https://github.com/ClickHouse/ClickHouse/pull/84820) ([George Larionov](https://github.com/george-larionov)).
* Корректно сохранять все настройки в метаданных таблицы движка очереди объектов. [#84860](https://github.com/ClickHouse/ClickHouse/pull/84860) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка `CORRUPTED_DATA`, возникающая при использовании ленивых столбцов с внешней сортировкой. [#84738](https://github.com/ClickHouse/ClickHouse/pull/84738) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Убраны лишние вызовы `getStatus()` при выполнении запросов `SYSTEM DROP REPLICA`. Исправлена ситуация, когда таблица удаляется в фоновом режиме и выбрасывается исключение `Shutdown for storage is called`. [#85220](https://github.com/ClickHouse/ClickHouse/pull/85220) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлены пропущенные проверки длины имени таблицы в запросах `CREATE OR REPLACE` и `RENAME`. [#85326](https://github.com/ClickHouse/ClickHouse/pull/85326) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлено падение и повреждение данных при выполнении `ALTER UPDATE` для JSON. [#85383](https://github.com/ClickHouse/ClickHouse/pull/85383) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка сегментации в CoalescingMergeTree при работе с длинными строками. Закрывает [#84582](https://github.com/ClickHouse/ClickHouse/issues/84582). [#85709](https://github.com/ClickHouse/ClickHouse/pull/85709) ([scanhex12](https://github.com/scanhex12)).
* Исправлено регулярное выражение send&#95;logs&#95;source&#95;regexp (после рефакторинга асинхронного логирования в [#85105](https://github.com/ClickHouse/ClickHouse/issues/85105)). [#85797](https://github.com/ClickHouse/ClickHouse/pull/85797) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена возможная неконсистентность в словарях с `update_field` при ошибках `MEMORY_LIMIT_EXCEEDED`. [#85807](https://github.com/ClickHouse/ClickHouse/pull/85807) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены HTTP-запросы, выполняемые табличной функцией `url()`, так, чтобы корректно включать номера портов в заголовок Host при обращении к нестандартным портам. Это устраняет сбои аутентификации при использовании предварительно подписанных URL-адресов с S3-совместимыми сервисами, такими как MinIO, работающими на нестандартных портах, что часто встречается в средах разработки. (Исправляет [#85898](https://github.com/ClickHouse/ClickHouse/issues/85898)). [#85921](https://github.com/ClickHouse/ClickHouse/pull/85921) ([Tom Quist](https://github.com/tomquist)).