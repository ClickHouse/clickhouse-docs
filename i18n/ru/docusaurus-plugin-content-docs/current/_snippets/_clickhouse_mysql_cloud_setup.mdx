import mysql_1 from '@site/static/images/_snippets/mysql1.png';
import mysql_2 from '@site/static/images/_snippets/mysql2.png';
import mysql_3 from '@site/static/images/_snippets/mysql3.png';
import mysql_4 from '@site/static/images/_snippets/mysql4.png';
import mysql_5 from '@site/static/images/_snippets/mysql5.png';
import Image from '@theme/IdealImage';
import {VerticalStepper} from "@clickhouse/click-ui/bundled";

<VerticalStepper headerLevel="h4">
  #### Выберите `Connect your app` \{#select-connect-your-app\}

  После создания сервиса ClickHouse Cloud на экране `Connect your app` выберите MySQL из выпадающего списка.

  <Image size="lg" img={mysql_1} alt="Экран учетных данных ClickHouse Cloud с выпадающим списком выбора интерфейса MySQL" border />

  #### Включите интерфейс MySQL \{#enable-mysql-interface\}

  Переключите тумблер, чтобы включить интерфейс MySQL для данного сервиса.
  Это откроет порт `3306` для этого сервиса и отобразит экран подключения MySQL с вашим уникальным именем пользователя MySQL.

  <Image size="lg" img={mysql_2} alt="Экран ClickHouse Cloud с тумблером включения интерфейса MySQL и параметрами подключения" border />

  Или, чтобы включить интерфейс MySQL для уже существующего сервиса:

  #### Выберите `Connect` \{#select-connect\}

  Убедитесь, что ваш сервис находится в состоянии `Running`, затем выберите сервис, для которого вы хотите включить интерфейс MySQL.
  Выберите `Connect` в левом меню:

  <Image size="lg" img={mysql_3} alt="Экран подключения сервиса ClickHouse Cloud с выделенной опцией Connect" border />

  #### Выберите `MySQL` \{#choose-mysql\}

  Выберите `MySQL` из выпадающего списка `Connect With`.

  <Image size="md" img={mysql_4} alt="Экран подключения ClickHouse Cloud с выбранным вариантом MySQL" border />

  #### Включите интерфейс MySQL \{#enable-mysql-interface\}

  Переключите тумблер, чтобы включить интерфейс MySQL для данного сервиса.
  Это откроет порт `3306` для этого сервиса и отобразит экран подключения MySQL с вашим уникальным именем пользователя MySQL.
</VerticalStepper>

<Image size="md" img={mysql_5} alt="Экран подключения ClickHouse Cloud с включенным интерфейсом MySQL и параметрами подключения" border />

## Создание readonly-пользователя MySQL в ClickHouse Cloud \{#creating-multiple-mysql-users-in-clickhouse-cloud\}

ClickHouse Cloud автоматически создает пользователя `mysql4<subdomain>`, который использует тот же пароль, что и пользователь по умолчанию.
Часть `<subdomain>` соответствует первой части имени хоста вашего кластера ClickHouse Cloud.

Такой формат имени пользователя необходим для совместимости с инструментами, которые устанавливают защищенные соединения, но не включают данные [SNI (Server Name Indication)](https://www.cloudflare.com/learning/ssl/what-is-sni) в TLS-рукопожатие.
Без информации SNI система не может выполнить корректную внутреннюю маршрутизацию, поэтому подсказка с поддоменом, встроенная в имя пользователя, предоставляет необходимую информацию для маршрутизации.
Консольный клиент MySQL — пример инструмента, которому это требуется.

:::tip
Рекомендуется создать нового readonly-пользователя MySQL.
:::

:::note
Для имени хоста ClickHouse Cloud вида `foobar.us-east1.aws.clickhouse.cloud` часть `<subdomain>` равна `foobar`, и произвольное имя пользователя MySQL может выглядеть как `mysql4foobar_team1`.
:::

<VerticalStepper headerLevel="h4">
  #### Создайте профиль настроек readonly \{#create-a-custom-settings-user\}

  Создайте [профиль настроек](/sql-reference/statements/create/settings-profile), который будет применяться к вашему readonly-пользователю,
  установив параметр `readonly` в значение `1`:

  ```sql
  CREATE SETTINGS PROFILE readonly_profile SETTINGS readonly = 1
  ```

  #### Создайте нового readonly-пользователя MySQL \{#create-a-readonly-mysql-user\}

  [Создайте пользователя](/sql-reference/statements/create/user) с именем в следующем формате:

  ```sql
  mysql4<subdomain>_<username>
  ```

  Примените `readonly_profile` к новому пользователю и убедитесь, что пароль задан в формате double SHA1. Например:

  ```sql
  CREATE USER mysql4foobar_readonly
  IDENTIFIED WITH double_sha1_password BY 'YourPassword42$'
  SETTINGS PROFILE 'readonly_profile';
  ```

  #### Выдайте новому пользователю права доступа к нужным таблицам \{#grant-the-new-user-the-necessary-permissions\}

  [Выдайте](/sql-reference/statements/grant) новому пользователю необходимые права для работы с нужными таблицами или базами данных.
  Например, если вы хотите предоставить доступ только к `system.query_log`:

  ```sql
  GRANT SELECT ON system.query_log TO mysql4foobar_readonly;
  ```

  :::note
  Для readonly-пользователя убедитесь, что вы выдаете только права `SELECT` к таблицам, к которым хотите предоставить доступ.
  :::

  Созданного пользователя можно использовать для подключения к вашему сервису ClickHouse Cloud через интерфейс MySQL.
</VerticalStepper>

### Устранение неполадок с несколькими пользователями MySQL в ClickHouse Cloud \{#troubleshooting-multiple-mysql-users-in-clickhouse-cloud\}

Если вы создали нового пользователя MySQL и при подключении через CLI‑клиент MySQL видите следующую ошибку:

```
ОШИБКА 2013 (HY000): Потеряно соединение с сервером MySQL при чтении пакета авторизации, системная ошибка: 54
```

В этом случае убедитесь, что имя пользователя имеет формат `mysql4<subdomain>_<username>`, как описано [выше](#creating-multiple-mysql-users-in-clickhouse-cloud).
