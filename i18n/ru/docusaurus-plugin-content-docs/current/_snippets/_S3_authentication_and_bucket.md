import Image from '@theme/IdealImage';
import s3_1 from '@site/static/images/_snippets/s3/s3-1.png';
import s3_2 from '@site/static/images/_snippets/s3/s3-2.png';
import s3_3 from '@site/static/images/_snippets/s3/s3-3.png';
import s3_4 from '@site/static/images/_snippets/s3/s3-4.png';
import s3_5 from '@site/static/images/_snippets/s3/s3-5.png';
import s3_6 from '@site/static/images/_snippets/s3/s3-6.png';
import s3_7 from '@site/static/images/_snippets/s3/s3-7.png';
import s3_8 from '@site/static/images/_snippets/s3/s3-8.png';
import s3_9 from '@site/static/images/_snippets/s3/s3-9.png';
import s3_a from '@site/static/images/_snippets/s3/s3-a.png';
import s3_b from '@site/static/images/_snippets/s3/s3-b.png';
import s3_c from '@site/static/images/_snippets/s3/s3-c.png';
import s3_d from '@site/static/images/_snippets/s3/s3-d.png';
import s3_e from '@site/static/images/_snippets/s3/s3-e.png';
import s3_f from '@site/static/images/_snippets/s3/s3-f.png';
import s3_g from '@site/static/images/_snippets/s3/s3-g.png';
import s3_h from '@site/static/images/_snippets/s3/s3-h.png';

<details>
  <summary>Создание корзин S3 и пользователя IAM</summary>

В этой статье рассматриваются основы настройки пользователя AWS IAM, создания корзины S3 и настройки ClickHouse для использования корзины в качестве диска S3. Вам следует работать с вашей командой безопасности, чтобы определить необходимые разрешения и рассматривать их как отправную точку.

### Создание пользователя AWS IAM {#create-an-aws-iam-user}
В этой процедуре мы создадим пользователя сервисной учетной записи, а не пользователя с правом входа.
1.  Войдите в консоль управления AWS IAM.

2. В разделе "пользователи" выберите **Добавить пользователей**

<Image size="md" img={s3_1} alt="Консоль управления AWS IAM - добавление нового пользователя" border force/>

3. Введите имя пользователя и установите тип удостоверения на **Ключ доступа - Программный доступ**, затем выберите **Далее: Разрешения**

<Image size="md" img={s3_2} alt="Настройка имени пользователя и типа доступа для пользователя IAM" border force/>

4. Не добавляйте пользователя в какую-либо группу; выберите **Далее: Метки**

<Image size="md" img={s3_3} alt="Пропуск назначения группы для пользователя IAM" border force/>

5. Если вам не нужно добавлять никакие метки, выберите **Далее: Обзор**

<Image size="md" img={s3_4} alt="Пропуск назначения меток для пользователя IAM" border force/>

6. Выберите **Создать пользователя**

    :::note
    Предупреждающее сообщение о том, что у пользователя нет разрешений, можно игнорировать; разрешения будут предоставлены на корзину для пользователя в следующем разделе
    :::

<Image size="md" img={s3_5} alt="Создание пользователя IAM без предупреждения о разрешениях" border force/>

7. Пользователь создан; нажмите **показать** и скопируйте ключи доступа и секретные ключи.
:::note
Сохраните ключи в другом месте; это единственный раз, когда секретный ключ доступа будет доступен.
:::

<Image size="md" img={s3_6} alt="Просмотр и копирование ключей доступа пользователя IAM" border force/>

8. Нажмите закрыть, затем найдите пользователя на экране пользователей.

<Image size="md" img={s3_7} alt="Поиск вновь созданного пользователя IAM в списке пользователей" border force/>

9. Скопируйте ARN (имя ресурса Amazon) и сохраните его для использования при настройке политики доступа для корзины.

<Image size="md" img={s3_8} alt="Копирование ARN пользователя IAM" border force/>

### Создание корзины S3 {#create-an-s3-bucket}
1. В разделе корзин S3 выберите **Создать корзину**

<Image size="md" img={s3_9} alt="Запуск процесса создания корзины S3" border force/>

2. Введите имя корзины, оставив остальные параметры по умолчанию
:::note
Имя корзины должно быть уникальным в AWS, а не только в организации, иначе это приведет к ошибке.
:::
3. Оставьте `Блокировать все публичные доступы` включенным; публичный доступ не нужен.

<Image size="md" img={s3_a} alt="Настройка параметров корзины S3 с блокировкой публичного доступа" border force/>

4. Выберите **Создать корзину** внизу страницы

<Image size="md" img={s3_b} alt="Завершение создания корзины S3" border force/>

5. Выберите ссылку, скопируйте ARN и сохраните его для использования при настройке политики доступа для корзины.

6. После создания корзины найдите новую корзину S3 в списке корзин S3 и выберите ссылку

<Image size="md" img={s3_c} alt="Поиск вновь созданной корзины S3 в списке корзин" border force/>

7. Выберите **Создать папку**

<Image size="md" img={s3_d} alt="Создание новой папки в корзине S3" border force/>

8. Введите имя папки, которая будет целью для диска ClickHouse S3, и выберите **Создать папку**

<Image size="md" img={s3_e} alt="Установка имени папки для использования диска ClickHouse S3" border force/>

9. Папка теперь должна быть видима в списке корзин

<Image size="md" img={s3_f} alt="Просмотр вновь созданной папки в корзине S3" border force/>

10. Выберите флажок для новой папки и нажмите **Копировать URL** Сохраните скопированный URL для использования в конфигурации хранения ClickHouse в следующем разделе.

<Image size="md" img={s3_g} alt="Копирование URL папки S3 для конфигурации ClickHouse" border force/>

11. Выберите вкладку **Разрешения** и нажмите кнопку **Изменить** в разделе **Политика корзины**

<Image size="md" img={s3_h} alt="Доступ к настройкам политики корзины S3" border force/>

12. Добавьте политику корзины, пример ниже:
```json
{
  "Version" : "2012-10-17",
  "Id" : "Policy123456",
  "Statement" : [
    {
      "Sid" : "abc123",
      "Effect" : "Allow",
      "Principal" : {
        "AWS" : "arn:aws:iam::921234567898:user/mars-s3-user"
      },
      "Action" : "s3:*",
      "Resource" : [
        "arn:aws:s3:::mars-doc-test",
        "arn:aws:s3:::mars-doc-test/*"
      ]
    }
  ]
}
```

```response
|Параметр | Описание | Пример значения |
|----------|-------------|----------------|
|Version | Версия интерпретатора политики, оставьте как есть | 2012-10-17 |
|Sid | Идентификатор политики, заданный пользователем | abc123 |
|Effect | Разрешается или запрещается ли выполнение запросов пользователем | Allow |
|Principal | Учетные записи или пользователи, которым будет разрешено | arn:aws:iam::921234567898:user/mars-s3-user |
|Action | Какие операции разрешены в корзине| s3:*|
|Resource | В каких ресурсах в корзине будут разрешены операции | "arn:aws:s3:::mars-doc-test", "arn:aws:s3:::mars-doc-test/*" |
```

:::note
Вам следует работать с вашей командой безопасности, чтобы определить необходимые разрешения, рассматривайте их как отправную точку.
Для получения дополнительной информации о политиках и настройках обратитесь к документации AWS:
https://docs.aws.amazon.com/AmazonS3/latest/userguide/access-policy-language-overview.html
:::

13. Сохраните настройки политики.

</details>