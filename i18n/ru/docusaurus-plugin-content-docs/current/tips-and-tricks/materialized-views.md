---
sidebar_position: 1
slug: /tips-and-tricks/materialized-views
sidebar_label: 'Материализованные представления'
doc_type: 'guide'
keywords: [
  'материализованные представления ClickHouse',
  'оптимизация материализованных представлений',
  'проблемы хранения материализованных представлений',
  'лучшие практики использования материализованных представлений',
  'шаблоны агрегации в базах данных',
  'антипаттерны материализованных представлений',
  'проблемы взрывного роста объема хранилища',
  'производительность материализованных представлений',
  'оптимизация представлений базы данных',
  'стратегия агрегации',
  'поиск и устранение неполадок материализованных представлений',
  'накладные расходы на хранение представлений'
]
title: 'Уроки — материализованные представления'
description: 'Практические примеры использования материализованных представлений, типичные проблемы и их решения'
---

# Материализованные представления: как они могут обернуться обоюдоострым мечом \{#materialized-views-the-double-edged-sword\}

*Это руководство — часть серии материалов, подготовленных по результатам митапов сообщества. Для получения дополнительных практических решений и рекомендаций вы можете [просматривать материалы по конкретным проблемам](./community-wisdom.md).*
*Слишком много частей тормозят вашу базу данных? Ознакомьтесь с руководством сообщества [Too Many Parts](./too-many-parts.md).*
*Узнайте больше о [материализованных представлениях](/materialized-views).*

## Антипаттерн хранения с 10-кратным ростом \{#storage-antipattern\}

**Реальная проблема в продакшене:** *«У нас было материализованное представление. Таблица сырых логов занимала около 20 ГБ, но представление для этой таблицы разрослось до 190 ГБ, то есть почти в 10 раз больше исходной таблицы. Это произошло потому, что мы создавали по одной строке на каждый атрибут, а в каждом логе может быть до 10 атрибутов.»*

**Правило:** Если ваш `GROUP BY` создаёт больше строк, чем сокращает, вы строите дорогой индекс, а не материализованное представление.

## Проверка состояния материализованного представления в продакшене \{#mv-health-validation\}

Этот запрос помогает предсказать, будет ли материализованное представление сжимать данные или раздувать их объём до того, как вы его создадите. Запустите его для вашей реальной таблицы и столбцов, чтобы избежать сценария «разрастания до 190 ГБ».

**Что он показывает:**

* **Низкий коэффициент агрегации** (&lt;10%) = хорошее материализованное представление, значительное сжатие
* **Высокий коэффициент агрегации** (&gt;70%) = плохое материализованное представление, риск взрывного роста объёма хранения
* **Множитель хранения** = во сколько раз больше/меньше будет занимать место ваше материализованное представление

```sql
-- Replace with your actual table and columns
SELECT 
    count() as total_rows,
    uniq(your_group_by_columns) as unique_combinations,
    round(uniq(your_group_by_columns) / count() * 100, 2) as aggregation_ratio
FROM your_table
WHERE your_filter_conditions;

-- If aggregation_ratio > 70%, reconsider your MV design
-- If aggregation_ratio < 10%, you'll get good compression
```

## Когда материализованные представления становятся проблемой \{#mv-problems\}

**Предупреждающие признаки, за которыми стоит следить:**
- Увеличивается задержка вставки (запросы, которые занимали 10 мс, теперь занимают 100 мс и более)
- Ошибки «Too many parts» появляются все чаще
- Всплески использования CPU во время операций вставки
- Тайм-ауты вставки, которых раньше не было

Вы можете сравнить производительность вставки до и после добавления материализованных представлений с помощью `system.query_log`, отслеживая тенденции по длительности выполнения запросов.

## Источники видео \{#video-sources\}
- [ClickHouse at CommonRoom - Kirill Sapchuk](https://www.youtube.com/watch?v=liTgGiTuhJE) — источник кейса о «чрезмерном энтузиазме вокруг материализованных представлений» и «раздувании объёма данных с 20 GB до 190 GB»