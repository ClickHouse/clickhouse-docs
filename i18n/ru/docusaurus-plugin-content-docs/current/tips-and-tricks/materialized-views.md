---
sidebar_position: 1
slug: /tips-and-tricks/materialized-views
sidebar_label: 'Материализованные представления'
doc_type: 'guide'
keywords: [
  'clickhouse материализованные представления',
  'оптимизация материализованных представлений',
  'проблемы хранения материализованных представлений',
  'лучшие практики работы с материализованными представлениями',
  'шаблоны агрегации в базах данных',
  'антипаттерны материализованных представлений',
  'проблемы взрывного роста объёма хранилища',
  'производительность материализованных представлений',
  'оптимизация представлений в базах данных',
  'стратегия агрегации',
  'устранение неполадок материализованных представлений',
  'накладные расходы на хранение представлений'
]
title: 'Уроки — материализованные представления'
description: 'Примеры материализованных представлений из реальной практики, проблемы и решения'
---



# Материализованные представления: как они могут стать палкой о двух концах {#materialized-views-the-double-edged-sword}

_Это руководство является частью сборника материалов, полученных на встречах сообщества. Для получения дополнительных практических решений и рекомендаций вы можете [просмотреть материалы по конкретным проблемам](./community-wisdom.md)._
_Слишком много партов замедляет работу вашей базы данных? Ознакомьтесь с руководством сообщества [Слишком много партов](./too-many-parts.md)._
_Подробнее о [материализованных представлениях](/materialized-views)._


## Антипаттерн 10-кратного увеличения объёма хранилища {#storage-antipattern}

**Реальная проблема в production-среде:** _"У нас было материализованное представление. Исходная таблица с логами занимала около 20 ГБ, но представление на основе этой таблицы разрослось до 190 ГБ — почти в 10 раз больше исходной таблицы. Это произошло из-за того, что мы создавали по одной строке на каждый атрибут, а в каждой записи лога может быть до 10 атрибутов."_

**Правило:** Если ваш `GROUP BY` создаёт больше строк, чем устраняет, вы создаёте дорогостоящий индекс, а не материализованное представление.


## Проверка работоспособности материализованных представлений в production {#mv-health-validation}

Этот запрос помогает предсказать, будет ли материализованное представление сжимать или раздувать ваши данные, прежде чем вы его создадите. Выполните его на реальной таблице и столбцах, чтобы избежать сценария «раздувания на 190 ГБ».

**Что показывает запрос:**

- **Низкий коэффициент агрегации** (\<10%) = хорошее MV, значительное сжатие
- **Высокий коэффициент агрегации** (\>70%) = плохое MV, риск раздувания хранилища
- **Множитель хранилища** = во сколько раз больше/меньше будет ваше MV

```sql
-- Замените на вашу реальную таблицу и столбцы
SELECT
    count() as total_rows, -- общее количество строк
    uniq(your_group_by_columns) as unique_combinations, -- уникальные комбинации
    round(uniq(your_group_by_columns) / count() * 100, 2) as aggregation_ratio -- коэффициент агрегации
FROM your_table
WHERE your_filter_conditions;

-- Если aggregation_ratio > 70%, пересмотрите дизайн MV
-- Если aggregation_ratio < 10%, вы получите хорошее сжатие
```


## Когда материализованные представления становятся проблемой {#mv-problems}

**Признаки, на которые следует обратить внимание:**

- Увеличение задержки вставки (запросы, которые выполнялись за 10 мс, теперь занимают более 100 мс)
- Ошибки «Too many parts» появляются чаще
- Всплески нагрузки на CPU во время операций вставки
- Таймауты вставки, которых ранее не было

Вы можете сравнить производительность вставки до и после добавления материализованных представлений с помощью `system.query_log` для отслеживания динамики длительности запросов.


## Видеоматериалы {#video-sources}

- [ClickHouse at CommonRoom - Kirill Sapchuk](https://www.youtube.com/watch?v=liTgGiTuhJE) - Источник кейса о «чрезмерном увлечении материализованными представлениями» и «взрывном росте с 20 ГБ до 190 ГБ»
