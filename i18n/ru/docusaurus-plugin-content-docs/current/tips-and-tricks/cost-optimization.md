---
sidebar_position: 1
slug: /community-wisdom/cost-optimization
sidebar_label: 'Оптимизация затрат'
doc_type: 'guide'
keywords: [
  'cost optimization',
  'storage costs', 
  'partition management',
  'data retention',
  'storage analysis',
  'database optimization',
  'clickhouse cost reduction',
  'storage hot spots',
  'ttl performance',
  'disk usage',
  'compression strategies',
  'retention analysis'
]
title: 'Уроки — оптимизация затрат'
description: 'Стратегии оптимизации затрат из митапов сообщества ClickHouse с реальными примерами продакшена и проверенными методиками.'
---



# Оптимизация затрат: стратегии от сообщества {#cost-optimization}

_Это руководство является частью сборника материалов, полученных на встречах сообщества. Материалы на этой странице содержат опыт сообщества по оптимизации затрат при использовании ClickHouse, который хорошо зарекомендовал себя в конкретных условиях и конфигурациях. Для получения дополнительных практических решений и рекомендаций вы можете [просмотреть материалы по конкретным задачам](./community-wisdom.md)._

_Узнайте, как [ClickHouse Cloud помогает управлять операционными затратами](/cloud/overview)_.


## Стратегия сжатия: LZ4 против ZSTD в production-среде {#compression-strategy}

Когда Microsoft Clarity потребовалось обрабатывать сотни терабайт данных, они обнаружили, что выбор метода сжатия оказывает существенное влияние на затраты. При их масштабах важен каждый бит экономии хранилища, и они столкнулись с классическим компромиссом: производительность против стоимости хранения. Microsoft Clarity обрабатывает огромные объёмы — два петабайта несжатых данных в месяц по всем аккаунтам, выполняя около 60 000 запросов в час на восьми узлах и обслуживая миллиарды просмотров страниц с миллионов веб-сайтов. При таком масштабе стратегия сжатия становится критическим фактором затрат.

Изначально они использовали стандартное для ClickHouse сжатие [LZ4](/sql-reference/statements/create/table#lz4), но обнаружили, что значительная экономия затрат возможна при использовании [ZSTD](/sql-reference/statements/create/table#zstd). Хотя LZ4 работает быстрее, ZSTD обеспечивает лучшее сжатие за счёт немного более низкой производительности. После тестирования обоих подходов они приняли стратегическое решение отдать приоритет экономии хранилища. Результаты оказались впечатляющими: 50% экономии хранилища на больших таблицах при приемлемом влиянии на производительность загрузки данных и выполнения запросов.

**Ключевые результаты:**

- 50% экономии хранилища на больших таблицах благодаря сжатию ZSTD
- 2 петабайта ежемесячной ёмкости обработки данных
- Приемлемое влияние на производительность загрузки данных и выполнения запросов
- Значительное снижение затрат при масштабах в сотни терабайт


## Стратегия хранения на основе столбцов {#column-retention}

Один из наиболее эффективных методов оптимизации затрат заключается в анализе того, какие столбцы фактически используются. Microsoft Clarity реализует продвинутые стратегии хранения на основе столбцов, используя встроенные возможности телеметрии ClickHouse. ClickHouse предоставляет детальные метрики использования хранилища по столбцам, а также исчерпывающую информацию о паттернах запросов: к каким столбцам происходит обращение, как часто, длительность запросов и общую статистику использования.

Такой подход, основанный на данных, позволяет принимать стратегические решения о политиках хранения и управлении жизненным циклом столбцов. Анализируя данные телеметрии, Microsoft может выявить проблемные места хранилища — столбцы, которые занимают значительное пространство, но к которым поступает минимальное количество запросов. Для таких малоиспользуемых столбцов можно применить агрессивные политики хранения, сократив время хранения с 30 месяцев до одного месяца, или полностью удалить столбцы, если к ним вообще не поступает запросов. Эта выборочная стратегия хранения снижает затраты на хранение без влияния на пользовательский опыт.

**Стратегия:**

- Анализировать паттерны использования столбцов с помощью телеметрии ClickHouse
- Выявлять столбцы с высоким потреблением хранилища и низкой частотой запросов
- Внедрять выборочные политики хранения
- Отслеживать паттерны запросов для принятия решений на основе данных

**Связанная документация**

- [Управление данными — TTL на уровне столбцов](/observability/managing-data)


## Управление данными на основе партиций {#partition-management}

Microsoft Clarity обнаружила, что стратегия партиционирования влияет как на производительность, так и на простоту эксплуатации. Их подход: партиционирование по дате, сортировка по часам. Эта стратегия обеспечивает множество преимуществ помимо эффективности очистки — она позволяет легко очищать данные, упрощает расчёты биллинга для клиентского сервиса и поддерживает требования GDPR для построчного удаления.

**Ключевые преимущества:**

- Простая очистка данных (удаление партиции вместо построчного удаления)
- Упрощённые расчёты биллинга
- Улучшенная производительность запросов за счёт исключения партиций
- Упрощённое операционное управление

**Связанная документация**

- [Управление данными — Партиции](/observability/managing-data#partitions)


## Стратегия преобразования строк в целые числа {#string-integer-conversion}

Аналитические платформы часто сталкиваются с проблемой хранения категориальных данных, которые повторяются в миллионах строк. Команда инженеров Microsoft столкнулась с этой проблемой при работе с данными поисковой аналитики и разработала эффективное решение, которое позволило сократить объём хранения на 60% для соответствующих наборов данных.

В системе веб-аналитики Microsoft результаты поиска формируют различные типы ответов — карточки погоды, спортивную информацию, новостные статьи и фактические ответы. Каждый результат запроса помечался описательными строками, такими как "weather_answer", "sports_answer" или "factual_answer". При обработке миллиардов поисковых запросов эти строковые значения многократно сохранялись в ClickHouse, потребляя огромные объёмы дискового пространства и требуя ресурсоёмких строковых сравнений при выполнении запросов.

Microsoft реализовала систему сопоставления строк с целыми числами, используя отдельную базу данных MySQL. Вместо хранения фактических строк в ClickHouse сохраняются только целочисленные идентификаторы. Когда пользователи выполняют запросы через пользовательский интерфейс и запрашивают данные для `weather_answer`, оптимизатор запросов сначала обращается к таблице сопоставления MySQL для получения соответствующего целочисленного идентификатора, затем преобразует запрос для использования этого целого числа перед отправкой в ClickHouse.

Эта архитектура сохраняет пользовательский опыт — люди по-прежнему видят понятные метки, такие как `weather_answer`, в своих дашбордах — в то время как внутреннее хранилище и запросы работают с гораздо более эффективными целыми числами. Система сопоставления обрабатывает все преобразования прозрачно, не требуя изменений в пользовательском интерфейсе или рабочих процессах пользователей.

**Основные преимущества:**

- Сокращение объёма хранения на 60% для соответствующих наборов данных
- Более высокая производительность запросов при сравнении целых чисел
- Снижение потребления памяти для объединений и агрегаций
- Снижение затрат на передачу данных по сети для больших наборов результатов

:::note
Это пример, специально используемый для сценария данных Microsoft Clarity. Если все ваши данные находятся в ClickHouse или у вас нет ограничений на перенос данных в ClickHouse, попробуйте использовать [словари](/dictionary).
:::


## Видеоматериалы {#video-sources}

- **[Microsoft Clarity и ClickHouse](https://www.youtube.com/watch?v=rUVZlquVGw0)** — команда Microsoft Clarity
- **[Опыт использования ClickHouse в Contentsquare](https://www.youtube.com/watch?v=zvuCBAl2T0Q)** — Doron Hoffman и Guram Sigua (ContentSquare)

_Эти материалы сообщества по оптимизации затрат представляют стратегии компаний, обрабатывающих сотни терабайт и петабайты данных, и демонстрируют реальные подходы к снижению эксплуатационных расходов на ClickHouse._
