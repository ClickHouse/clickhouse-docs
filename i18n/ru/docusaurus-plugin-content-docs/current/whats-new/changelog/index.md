---
description: "Журнал изменений за 2025 год"
note: "Этот файл сгенерирован с помощью yarn build"
slug: /whats-new/changelog/
sidebar_position: 2
sidebar_label: "2025"
title: "Журнал изменений 2025"
doc_type: "changelog"
---

### Содержание

**[Релиз ClickHouse v25.10, 2025-10-30](#2510)**<br/>
**[Релиз ClickHouse v25.9, 2025-09-25](#259)**<br/>
**[Релиз ClickHouse v25.8 LTS, 2025-08-28](#258)**<br/>
**[Релиз ClickHouse v25.7, 2025-07-24](#257)**<br/>
**[Релиз ClickHouse v25.6, 2025-06-26](#256)**<br/>
**[Релиз ClickHouse v25.5, 2025-05-22](#255)**<br/>
**[Релиз ClickHouse v25.4, 2025-04-22](#254)**<br/>
**[Релиз ClickHouse v25.3 LTS, 2025-03-20](#253)**<br/>
**[Релиз ClickHouse v25.2, 2025-02-27](#252)**<br/>
**[Релиз ClickHouse v25.1, 2025-01-28](#251)**<br/>
**[Журнал изменений за 2024 год](https://clickhouse.com/docs/whats-new/changelog/2024/)**<br/>
**[Журнал изменений за 2023 год](https://clickhouse.com/docs/whats-new/changelog/2023/)**<br/>
**[Журнал изменений за 2022 год](https://clickhouse.com/docs/whats-new/changelog/2022/)**<br/>
**[Журнал изменений за 2021 год](https://clickhouse.com/docs/whats-new/changelog/2021/)**<br/>
**[Журнал изменений за 2020 год](https://clickhouse.com/docs/whats-new/changelog/2020/)**<br/>
**[Журнал изменений за 2019 год](https://clickhouse.com/docs/whats-new/changelog/2019/)**<br/>
**[Журнал изменений за 2018 год](https://clickhouse.com/docs/whats-new/changelog/2018/)**<br/>
**[Журнал изменений за 2017 год](https://clickhouse.com/docs/whats-new/changelog/2017/)**<br/>

### Релиз ClickHouse 25.10, 2025-10-31 {#2510}


#### Обратно несовместимое изменение

* Изменено значение по умолчанию настройки `schema_inference_make_columns_nullable`: теперь она учитывает информацию о Nullable-свойстве столбцов из метаданных Parquet/ORC/Arrow, вместо того чтобы делать все столбцы Nullable. Для текстовых форматов изменений нет. [#71499](https://github.com/ClickHouse/ClickHouse/pull/71499) ([Michael Kolupaev](https://github.com/al13n321)).
* Кэш результатов запросов будет игнорировать настройку `log_comment`, поэтому изменение только `log_comment` в запросе больше не будет приводить к промаху кэша. Существует небольшая вероятность, что пользователи намеренно сегментировали кэш, изменяя `log_comment`. Это изменение меняет такое поведение и, следовательно, является обратно несовместимым. Для этой цели используйте настройку `query_cache_tag`. [#79878](https://github.com/ClickHouse/ClickHouse/pull/79878) ([filimonov](https://github.com/filimonov)).
* В предыдущих версиях запросы с табличными функциями, называвшимися так же, как функции реализации операторов, форматировались непоследовательно. Закрывает [#81601](https://github.com/ClickHouse/ClickHouse/issues/81601). Закрывает [#81977](https://github.com/ClickHouse/ClickHouse/issues/81977). Закрывает [#82834](https://github.com/ClickHouse/ClickHouse/issues/82834). Закрывает [#82835](https://github.com/ClickHouse/ClickHouse/issues/82835). Запросы EXPLAIN SYNTAX больше не будут во всех случаях форматировать операторы — новое поведение лучше отражает назначение объяснения синтаксиса. `clickhouse-format`, `formatQuery` и подобные инструменты не будут форматировать функции как операторы, если в запросе они использовались в функциональной форме. [#82825](https://github.com/ClickHouse/ClickHouse/pull/82825) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Запретить использование типа `Dynamic` в ключах `JOIN`. Это может приводить к непредвиденным результатам при сравнении значения типа `Dynamic` со значением другого, не относящегося к `Dynamic`, типа. Лучше привести столбец `Dynamic` к требуемому типу. [#86358](https://github.com/ClickHouse/ClickHouse/pull/86358) ([Pavel Kruglov](https://github.com/Avogar)).
* Параметр сервера `storage_metadata_write_full_object_key` по умолчанию включён и сейчас не может быть отключён. Это обратно совместимое изменение. Сообщаем об этом для вашего сведения. Это изменение поддерживает прямую совместимость только с релизами 25.x. Это означает, что при необходимости отката новой версии вы сможете перейти только на любой релиз ветки 25.x. [#87335](https://github.com/ClickHouse/ClickHouse/pull/87335) ([Sema Checherinda](https://github.com/CheSema)).
* Уменьшено значение `replicated_deduplication_window_seconds` с одной недели до одного часа, чтобы хранить меньше znode в ZooKeeper при низкой скорости вставки данных. [#87414](https://github.com/ClickHouse/ClickHouse/pull/87414) ([Sema Checherinda](https://github.com/CheSema)).
* Переименована настройка `query_plan_use_new_logical_join_step` в `query_plan_use_logical_join_step`. [#87679](https://github.com/ClickHouse/ClickHouse/pull/87679) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Новый синтаксис позволяет более гибко задавать параметр tokenizer для текстового индекса. [#87997](https://github.com/ClickHouse/ClickHouse/pull/87997) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Функции `searchAny` и `searchAll` переименованы в `hasAnyTokens` и `hasAllTokens` для лучшего соответствия существующей функции `hasToken`. [#88109](https://github.com/ClickHouse/ClickHouse/pull/88109) ([Robert Schulze](https://github.com/rschu1ze)).
* Удалён `cache_hits_threshold` из файлового кэша. Эта функциональность была добавлена внешним участником до появления политики кэширования SLRU, и теперь, когда она у нас есть, нет смысла поддерживать обе политики. [#88344](https://github.com/ClickHouse/ClickHouse/pull/88344) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Два небольших изменения в том, как работают настройки `min_free_disk_ratio_to_perform_insert` и `min_free_disk_bytes_to_perform_insert`: - использовать незарезервированные, а не доступные байты для определения, должна ли вставка быть отклонена. Это, вероятно, не критично, если резервы для фоновых слияний и мутаций малы по сравнению с настроенными порогами, но так кажется более корректным. - Не применять эти настройки к системным таблицам. Причина в том, что мы по‑прежнему хотим, чтобы такие таблицы, как `query_log`, обновлялись. Это очень помогает при отладке. Объём данных, записываемых в системные таблицы, обычно невелик по сравнению с основными данными, поэтому они смогут продолжать работать гораздо дольше при разумном пороге `min_free_disk_ratio_to_perform_insert`. [#88468](https://github.com/ClickHouse/ClickHouse/pull/88468) ([c-end](https://github.com/c-end)).
* Включите асинхронный режим для внутренней репликации Keeper. Keeper сохранит прежнее поведение с возможным улучшением производительности. Если вы обновляетесь с версии ниже 23.9, необходимо сначала обновиться до 23.9+ и затем до 25.10+. Вы также можете задать для `keeper_server.coordination_settings.async_replication` значение 0 перед обновлением и включить его после завершения обновления. [#88515](https://github.com/ClickHouse/ClickHouse/pull/88515) ([Antonio Andelic](https://github.com/antonio2368)).





#### Новая функция

* Добавлена поддержка отрицательных значений `LIMIT` и `OFFSET`. Закрывает [#28913](https://github.com/ClickHouse/ClickHouse/issues/28913). [#88411](https://github.com/ClickHouse/ClickHouse/pull/88411) ([Nihal Z. Miaji](https://github.com/nihalzp)).
* Движок `Alias` создает прокси для другой таблицы. Все операции чтения и записи перенаправляются в целевую таблицу, при этом сам псевдоним не хранит данные и лишь содержит ссылку на целевую таблицу. [#87965](https://github.com/ClickHouse/ClickHouse/pull/87965) ([Kai Zhu](https://github.com/nauu)).
* Полная поддержка оператора `IS NOT DISTINCT FROM` (`<=>`). [#88155](https://github.com/ClickHouse/ClickHouse/pull/88155) ([simonmichal](https://github.com/simonmichal)).
* Добавлена возможность автоматически создавать статистику по всем соответствующим столбцам в таблицах `MergeTree`. Добавлена настройка на уровне таблицы `auto_statistics_types`, которая хранит разделённые запятыми типы статистики для автоматического создания (например, `auto_statistics_types = 'minmax, uniq, countmin'`). [#87241](https://github.com/ClickHouse/ClickHouse/pull/87241) ([Anton Popov](https://github.com/CurtizJ)).
* Новый текстовый индекс Блума `sparse_gram`. [#79985](https://github.com/ClickHouse/ClickHouse/pull/79985) ([scanhex12](https://github.com/scanhex12)).
* Новая функция `conv` преобразует числа между системами счисления и в данный момент поддерживает основания от `2-36`. [#83058](https://github.com/ClickHouse/ClickHouse/pull/83058) ([hp](https://github.com/hp77-creator)).
* Добавлена поддержка синтаксиса `LIMIT BY ALL`. Аналогично `GROUP BY ALL` и `ORDER BY ALL`, `LIMIT BY ALL` автоматически расширяется до использования всех неагрегатных выражений из предложения SELECT в качестве ключей LIMIT BY. Например, `SELECT id, name, count(*) FROM table GROUP BY id LIMIT 1 BY ALL` эквивалентен `SELECT id, name, count(*) FROM table GROUP BY id LIMIT 1 BY id, name`. Эта возможность упрощает запросы, когда требуется ограничить результат по всем выбранным неагрегатным столбцам без их явного перечисления. Закрывает [#59152](https://github.com/ClickHouse/ClickHouse/issues/59152). [#84079](https://github.com/ClickHouse/ClickHouse/pull/84079) ([Surya Kant Ranjan](https://github.com/iit2009046)).
* В ClickHouse добавлена поддержка выполнения запросов к Apache Paimon. Эта интеграция позволяет пользователям ClickHouse напрямую работать с хранилищем озера данных Paimon. [#84423](https://github.com/ClickHouse/ClickHouse/pull/84423) ([JIaQi](https://github.com/JiaQiTang98)).
* Добавлена агрегатная функция `studentTTestOneSample`. [#85436](https://github.com/ClickHouse/ClickHouse/pull/85436) ([Dylan](https://github.com/DylanBlakemore)).
* `quantilePrometheusHistogram` — агрегатная функция, которая принимает в качестве аргументов верхние границы бакетов гистограммы и их кумулятивные значения и выполняет линейную интерполяцию между верхней и нижней границами того бакета, в котором находится искомый квантиль. Ведёт себя аналогично функции PromQL `histogram_quantile` для классических гистограмм. [#86294](https://github.com/ClickHouse/ClickHouse/pull/86294) ([Stephen Chi](https://github.com/stephchi0)).
* Новая системная таблица для файлов метаданных Delta Lake. [#87263](https://github.com/ClickHouse/ClickHouse/pull/87263) ([scanhex12](https://github.com/scanhex12)).
* Добавлена команда `ALTER TABLE REWRITE PARTS` — она заново перезаписывает части таблицы с учётом всех новых настроек (поскольку некоторые из них, например `use_const_adaptive_granularity`, применяются только к новым частям). [#87774](https://github.com/ClickHouse/ClickHouse/pull/87774) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена команда `SYSTEM RECONNECT ZOOKEEPER` для принудительного разрыва соединения с ZooKeeper и последующего переподключения ([https://github.com/ClickHouse/ClickHouse/issues/87317](https://github.com/ClickHouse/ClickHouse/issues/87317)). [#87318](https://github.com/ClickHouse/ClickHouse/pull/87318) ([Pradeep Chhetri](https://github.com/chhetripradeep)).
* Ограничьте число именованных коллекций с помощью настроек `max_named_collection_num_to_warn` и `max_named_collection_num_to_throw`. Добавлена новая метрика `NamedCollection` и ошибка `TOO_MANY_NAMED_COLLECTIONS`. [#87343](https://github.com/ClickHouse/ClickHouse/pull/87343) ([Pablo Marcos](https://github.com/pamarcos)).
* Добавлены оптимизированные регистронезависимые варианты функций `startsWith` и `endsWith`: `startsWithCaseInsensitive`, `endsWithCaseInsensitive`, `startsWithCaseInsensitiveUTF8` и `endsWithCaseInsensitiveUTF8`. [#87374](https://github.com/ClickHouse/ClickHouse/pull/87374) ([Guang Zhao](https://github.com/zheguang)).
* Добавляет возможность задавать определения `WORKLOAD` и `RESOURCE` в SQL с использованием секции конфигурации сервера «resources&#95;and&#95;workloads». [#87430](https://github.com/ClickHouse/ClickHouse/pull/87430) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена новая настройка таблицы `min_level_for_wide_part`, которая позволяет указать минимальный уровень парта, начиная с которого он будет создаваться в широком формате. [#88179](https://github.com/ClickHouse/ClickHouse/pull/88179) ([Christoph Wurm](https://github.com/cwurm)).
* Добавлены рекурсивные варианты команд `cp`-`cpr` и `mv`-`mvr` в клиенте Keeper. [#88570](https://github.com/ClickHouse/ClickHouse/pull/88570) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Добавлена настройка сессии для исключения из материализации списка пропускающих индексов при вставках (`exclude_materialize_skip_indexes_on_insert`). Добавлена настройка таблицы MergeTree для исключения из материализации списка пропускающих индексов во время слияний (`exclude_materialize_skip_indexes_on_merge`). [#87252](https://github.com/ClickHouse/ClickHouse/pull/87252) ([George Larionov](https://github.com/george-larionov)).



#### Экспериментальные возможности
* Реализован тип данных `QBit`, который хранит векторы в бит-слайсинговом формате, и функция `L2DistanceTransposed`, которая позволяет выполнять приближённый векторный поиск с управляемым параметром компромиссом между точностью и скоростью. [#87922](https://github.com/ClickHouse/ClickHouse/pull/87922) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Функции `searchAll` и `searchAny` теперь могут работать и с таблицами без текстовых столбцов. В таких случаях используется токенизатор по умолчанию. [#87722](https://github.com/ClickHouse/ClickHouse/pull/87722) ([Jimmy Aguilar Mena](https://github.com/Ergus)).



#### Улучшение производительности

* Реализована ленивая репликация столбцов в `JOIN` и `ARRAY JOIN`. Исключено преобразование специальных представлений столбцов, таких как `Sparse` и `Replicated`, в полные столбцы в некоторых выходных форматах. Это позволяет избежать лишнего копирования данных в памяти. [#88752](https://github.com/ClickHouse/ClickHouse/pull/88752) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена возможность опциональной сериализации подстолбца `.size` для строковых столбцов верхнего уровня в таблицах MergeTree для улучшения сжатия и обеспечения эффективного доступа к подстолбцам. Введены новые настройки MergeTree для управления версией сериализации и оптимизации выражений для пустых строк. [#82850](https://github.com/ClickHouse/ClickHouse/pull/82850) ([Amos Bird](https://github.com/amosbird)).
* Поддержка упорядоченного чтения для Iceberg. [#88454](https://github.com/ClickHouse/ClickHouse/pull/88454) ([scanhex12](https://github.com/scanhex12)).
* Ускорены некоторые запросы с JOIN за счёт построения bloom-фильтра из правого поддерева во время выполнения и передачи этого фильтра оператору сканирования в левом поддереве. Это может быть полезно для запросов вида `SELECT avg(o_totalprice) FROM orders, customer, nation WHERE c_custkey = o_custkey AND c_nationkey=n_nationkey AND n_name = 'FRANCE'`. [#84772](https://github.com/ClickHouse/ClickHouse/pull/84772) ([Alexander Gololobov](https://github.com/davenger)).
* Производительность запросов улучшена за счет рефакторинга порядка применения и интеграции Query Condition Cache (QCC) с анализом индексов. Фильтрация с использованием QCC теперь выполняется до анализа первичного ключа и пропускающих индексов, что снижает объем лишних вычислений по индексам. Анализ индексов был расширен для поддержки нескольких диапазонных фильтров, а его результаты фильтрации теперь сохраняются обратно в QCC. Это значительно ускоряет выполнение запросов, в которых анализ индексов занимает основную долю времени исполнения, — особенно тех, что полагаются на пропускающие индексы (например, векторные или инвертированные индексы). [#82380](https://github.com/ClickHouse/ClickHouse/pull/82380) ([Amos Bird](https://github.com/amosbird)).
* Несколько микрооптимизаций для ускорения выполнения небольших запросов. [#83096](https://github.com/ClickHouse/ClickHouse/pull/83096) ([Raúl Marín](https://github.com/Algunenano)).
* Сжаты логи и события профилирования в нативном протоколе. На кластерах со 100+ репликами несжатые события профилирования создают трафик 1–10 МБ/с, и индикатор прогресса работает медленно при медленных интернет-соединениях. Это закрывает [#82533](https://github.com/ClickHouse/ClickHouse/issues/82533). [#83586](https://github.com/ClickHouse/ClickHouse/pull/83586) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Повышена производительность поиска строк с учётом регистра (операции фильтрации, например `WHERE URL LIKE '%google%'`) за счёт использования библиотеки [StringZilla](https://github.com/ashvardanian/StringZilla), применяющей SIMD-инструкции процессора, когда они доступны. [#84161](https://github.com/ClickHouse/ClickHouse/pull/84161) ([Raúl Marín](https://github.com/Algunenano)).
* Снижено количество выделений памяти и операций копирования при выполнении запроса `SELECT` с `FINAL` из таблицы семейства `AggregatingMergeTree`, если таблица содержит столбцы типа `SimpleAggregateFunction(anyLast)`. [#84428](https://github.com/ClickHouse/ClickHouse/pull/84428) ([Duc Canh Le](https://github.com/canhld94)).
* Реализована логика проталкивания дизъюнктивных предикатов JOIN. Пример: в TPC-H Q7 для условия по двум таблицам n1 и n2 вида `(n1.n_name = 'FRANCE' AND n2.n_name = 'GERMANY') OR (n1.n_name = 'GERMANY' AND n2.n_name = 'FRANCE')` извлекаются отдельные частичные фильтры для каждой таблицы: `n1.n_name = 'FRANCE' OR n1.n_name = 'GERMANY'` для n1 и `n2.n_name = 'GERMANY' OR n2.n_name = 'FRANCE'` для n2. [#84735](https://github.com/ClickHouse/ClickHouse/pull/84735) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Повышена производительность оператора `LIKE` с префиксом или суффиксом при использовании нового значения по умолчанию настройки `optimize_rewrite_like_perfect_affix`. [#85920](https://github.com/ClickHouse/ClickHouse/pull/85920) ([Guang Zhao](https://github.com/zheguang)).
* Исправлена деградация производительности, вызванная большим размером сериализованного ключа при группировке по нескольким строковым и числовым столбцам. Это продолжение [#83884](https://github.com/ClickHouse/ClickHouse/pull/83884). [#85924](https://github.com/ClickHouse/ClickHouse/pull/85924) ([李扬](https://github.com/taiyang-li)).
* Добавлена новая настройка `joined_block_split_single_row` для снижения потребления памяти при хеш-соединениях с большим количеством совпадений на один ключ. Это позволяет разбивать результаты хеш-соединения на части даже в пределах совпадений для одной строки левой таблицы, что особенно полезно, когда одна строка из левой таблицы соответствует тысячам или миллионам строк из правой таблицы. Ранее все совпадения должны были материализовываться в памяти одновременно. Это снижает пиковое потребление памяти, но может увеличить нагрузку на CPU. [#87913](https://github.com/ClickHouse/ClickHouse/pull/87913) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Улучшения SharedMutex (повышение производительности при большом числе одновременных запросов). [#87491](https://github.com/ClickHouse/ClickHouse/pull/87491) ([Raúl Marín](https://github.com/Algunenano)).
* Повышена производительность построения текстового индекса для документов, содержащих преимущественно редко встречающиеся токены. [#87546](https://github.com/ClickHouse/ClickHouse/pull/87546) ([Anton Popov](https://github.com/CurtizJ)).
* Ускорен типичный сценарий работы деструктора `Field` (повышена производительность при большом количестве небольших запросов). [#87631](https://github.com/ClickHouse/ClickHouse/pull/87631) ([Raúl Marín](https://github.com/Algunenano)).
* Пропускается повторный пересчёт статистики хеш-таблиц во время оптимизации JOIN (это улучшает производительность всех запросов с JOIN). Добавлены новые профильные события `JoinOptimizeMicroseconds` и `QueryPlanOptimizeMicroseconds`. [#87683](https://github.com/ClickHouse/ClickHouse/pull/87683) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Включено сохранение меток в кэше и исключён прямой ввод-вывод (direct I/O) для читателя MergeTreeLazy. Это повышает производительность запросов с ORDER BY и небольшим LIMIT. [#87989](https://github.com/ClickHouse/ClickHouse/pull/87989) ([Nikita Taranov](https://github.com/nickitat)).
* Запрос SELECT с оператором `FINAL` к таблице `ReplacingMergeTree` со столбцом `is_deleted` теперь выполняется быстрее благодаря улучшенной параллелизации на основе двух существующих оптимизаций: 1. оптимизация `do_not_merge_across_partitions_select_final` для партиций таблицы, которые содержат только один `part`; 2. разбиение остальных выбранных диапазонов таблицы на `intersecting / non-intersecting`, при этом только пересекающиеся диапазоны должны проходить через преобразование с финальным объединением (FINAL merging transform). [#88090](https://github.com/ClickHouse/ClickHouse/pull/88090) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Снижено влияние кода при отсутствии точек отказа (пути выполнения по умолчанию, когда отладка не активна). [#88196](https://github.com/ClickHouse/ClickHouse/pull/88196) ([Raúl Marín](https://github.com/Algunenano)).
* Избегайте полного сканирования `system.tables` при фильтрации по `uuid` (это может быть полезно, если у вас есть только UUID из логов или из пути в ZooKeeper). [#88379](https://github.com/ClickHouse/ClickHouse/pull/88379) ([Azat Khuzhin](https://github.com/azat)).
* Улучшена производительность функций `tokens`, `hasAllTokens`, `hasAnyTokens`. [#88416](https://github.com/ClickHouse/ClickHouse/pull/88416) ([Anton Popov](https://github.com/CurtizJ)).
* Инлайнен метод `AddedColumns::appendFromBlock`, что немного улучшает производительность JOIN в некоторых случаях. [#88455](https://github.com/ClickHouse/ClickHouse/pull/88455) ([Nikita Taranov](https://github.com/nickitat)).
* Автодополнение в клиенте работает быстрее и более единообразно при использовании `system.completions`, а не при выполнении нескольких запросов к системным таблицам. [#84694](https://github.com/ClickHouse/ClickHouse/pull/84694) ([|2ustam](https://github.com/RuS2m)).
* Добавлен новый параметр текстового индекса `dictionary_block_frontcoding_compression` для управления сжатием словаря. По умолчанию используется сжатие `front-coding`. [#87175](https://github.com/ClickHouse/ClickHouse/pull/87175) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Перед вставкой в материализованные представления данные из всех потоков объединяются в зависимости от настроек `min_insert_block_size_rows_for_materialized_views` и `min_insert_block_size_bytes_for_materialized_views`. Ранее, если был включен `parallel_view_processing`, каждый поток, выполняющий вставку в данное материализованное представление, объединял вставку независимо, что могло приводить к большему числу создаваемых частей. [#87280](https://github.com/ClickHouse/ClickHouse/pull/87280) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена настройка `temporary_files_buffer_size` для управления размером буфера при записи временных файлов. * Оптимизировано потребление памяти операцией `scatter` (используется, например, в операции grace hash join) для столбцов `LowCardinality`. [#88237](https://github.com/ClickHouse/ClickHouse/pull/88237) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Добавлена поддержка прямого чтения из текстовых индексов для параллельных реплик. Повышена производительность чтения текстовых индексов из объектного хранилища. [#88262](https://github.com/ClickHouse/ClickHouse/pull/88262) ([Anton Popov](https://github.com/CurtizJ)).
* Запросы с таблицами из каталогов Data Lake будут использовать параллельные реплики для распределённой обработки. [#88273](https://github.com/ClickHouse/ClickHouse/pull/88273) ([scanhex12](https://github.com/scanhex12)).
* Внутренняя эвристика настройки алгоритма фоновых слияний под названием &quot;to&#95;remove&#95;small&#95;parts&#95;at&#95;right&quot; будет выполняться до вычисления оценки диапазона слияния. Ранее селектор слияний сначала выбирал широкое слияние, а затем отфильтровывал его суффикс. Исправления: [#85374](https://github.com/ClickHouse/ClickHouse/issues/85374). [#88736](https://github.com/ClickHouse/ClickHouse/pull/88736) ([Mikhail Artemenko](https://github.com/Michicosun)).





#### Улучшение

* Теперь функция `generateSerialID` поддерживает неконстантный аргумент для имени серии. Закрывает [#83750](https://github.com/ClickHouse/ClickHouse/issues/83750). [#88270](https://github.com/ClickHouse/ClickHouse/pull/88270) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен необязательный параметр `start_value` в функцию `generateSerialID` для задания пользовательских начальных значений для новых последовательностей. [#88085](https://github.com/ClickHouse/ClickHouse/pull/88085) ([Manuel](https://github.com/raimannma)).
* Добавлена опция `--semicolons_inline` в `clickhouse-format` для форматирования запросов так, чтобы точки с запятой размещались в конце последней строки, а не на новой строке. [#88018](https://github.com/ClickHouse/ClickHouse/pull/88018) ([Jan Rada](https://github.com/ZelvaMan)).
* Разрешена настройка троттлинга на уровне сервера, если конфигурация переопределена в Keeper. Закрывает [#73964](https://github.com/ClickHouse/ClickHouse/issues/73964). [#74066](https://github.com/ClickHouse/ClickHouse/pull/74066) ([JIaQi](https://github.com/JiaQiTang98)).
* `mannWhitneyUTest` больше не выбрасывает исключение, когда обе выборки содержат только одинаковые значения. Теперь возвращает корректный результат, соответствующий поведению SciPy. Закрывает: [#79814](https://github.com/ClickHouse/ClickHouse/issues/79814). [#80009](https://github.com/ClickHouse/ClickHouse/pull/80009) ([DeanNeaht](https://github.com/DeanNeaht)).
* Транзакция перезаписи диска объектного хранилища удаляет предыдущие блобы в удалённом хранилище, если транзакция метаданных зафиксирована. [#81787](https://github.com/ClickHouse/ClickHouse/pull/81787) ([Sema Checherinda](https://github.com/CheSema)).
* Исправлен проход оптимизации для избыточного выражения сравнения на равенство, когда `LowCardinality` результирующего типа отличается до и после оптимизации. [#82651](https://github.com/ClickHouse/ClickHouse/pull/82651) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Когда HTTP‑клиенты устанавливают заголовок `X-ClickHouse-100-Continue: defer` в дополнение к `Expect: 100-continue`, ClickHouse не отправляет клиенту ответ `100 Continue` до тех пор, пока не будет выполнена проверка квоты. Это позволяет избежать лишнего расхода сетевого трафика на передачу тел запросов, которые в любом случае будут отброшены. Это актуально для запросов INSERT, когда сам запрос может быть передан в URL‑строке запроса, а данные — в теле запроса. Принудительное прерывание запроса без отправки полного тела препятствует повторному использованию соединения по HTTP/1.1, но дополнительная задержка, возникающая из‑за открытия новых соединений, обычно несущественна по сравнению с общей длительностью выполнения INSERT при работе с большими объемами данных. [#84304](https://github.com/ClickHouse/ClickHouse/pull/84304) ([c-end](https://github.com/c-end)).
* Маскировать учетные данные доступа S3 в журналах при использовании DATABASE ENGINE = Backup с хранилищем S3. [#85336](https://github.com/ClickHouse/ClickHouse/pull/85336) ([Kenny Sun](https://github.com/hwabis)).
* Сделать оптимизации плана запроса доступными для подплана входных данных коррелированного подзапроса путём откладывания его материализации. Часть [#79890](https://github.com/ClickHouse/ClickHouse/issues/79890). [#85455](https://github.com/ClickHouse/ClickHouse/pull/85455) ([Dmitry Novik](https://github.com/novikd)).
* Изменение для SYSTEM DROP DATABASE REPLICA: - При удалении вместе с базой данных или при удалении всей реплики: также удаляется реплика для каждой таблицы базы данных - Если указан параметр &quot;WITH TABLES&quot;, удаляется реплика для каждого хранилища - В противном случае логика не меняется, удаляется только реплика на уровне баз данных - При удалении реплики базы данных с указанием пути в Keeper: - Если указан &quot;WITH TABLES&quot;: - Восстановить базу данных как Atomic - Восстановить таблицы RMT из записей в Keeper - Удалить базу данных (восстановленные таблицы также удаляются) - В противном случае удалить только реплику по указанному пути в Keeper. [#85637](https://github.com/ClickHouse/ClickHouse/pull/85637) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлено некорректное форматирование TTL при использовании функции `materialize`. Закрывает [#82828](https://github.com/ClickHouse/ClickHouse/issues/82828). [#85749](https://github.com/ClickHouse/ClickHouse/pull/85749) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Состояние таблицы Iceberg больше не хранится в объекте хранилища. Это должно обеспечить корректную работу Iceberg в ClickHouse при одновременном выполнении запросов. [#86062](https://github.com/ClickHouse/ClickHouse/pull/86062) ([Daniil Ivanik](https://github.com/divanik)).
* Сделать блокировку бакета в S3Queue в режиме ordered постоянной (persistent), аналогично обработке узлов при `use_persistent_processing_nodes = 1`. Добавить механизм инъекции сбоев для Keeper в тестах. [#86628](https://github.com/ClickHouse/ClickHouse/pull/86628) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Выводить подсказки, когда пользователь допускает опечатку в названии формата. Закрывает [#86761](https://github.com/ClickHouse/ClickHouse/issues/86761). [#87092](https://github.com/ClickHouse/ClickHouse/pull/87092) ([flynn](https://github.com/ucasfl)).
* Удалённые реплики будут пропускать анализ индекса, если проекции отсутствуют. [#87096](https://github.com/ClickHouse/ClickHouse/pull/87096) ([zoomxi](https://github.com/zoomxi)).
* Добавлена возможность отключать кодировку UTF-8 для таблицы ytsaurus. [#87150](https://github.com/ClickHouse/ClickHouse/pull/87150) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Отключить по умолчанию `s3_slow_all_threads_after_retryable_error`. [#87198](https://github.com/ClickHouse/ClickHouse/pull/87198) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Переименована табличная функция `arrowflight` в `arrowFlight`. [#87249](https://github.com/ClickHouse/ClickHouse/pull/87249) ([Vitaly Baranov](https://github.com/vitlibar)).
* Обновлён `clickhouse-benchmark`, чтобы принимать `-` вместо `_` в своих флагах CLI. [#87251](https://github.com/ClickHouse/ClickHouse/pull/87251) ([Ahmed Gouda](https://github.com/0xgouda)).
* Сброс в `system.crash_log` при обработке сигналов сделан синхронным. [#87253](https://github.com/ClickHouse/ClickHouse/pull/87253) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Добавлена настройка `inject_random_order_for_select_without_order_by`, которая добавляет `ORDER BY rand()` в запросы `SELECT` верхнего уровня без секции `ORDER BY`. [#87261](https://github.com/ClickHouse/ClickHouse/pull/87261) ([Rui Zhang](https://github.com/zhangruiddn)).
* Улучшено сообщение об ошибке в `joinGet`, чтобы оно правильно указывало, что количество `join_keys` не совпадает с количеством `right_table_keys`. [#87279](https://github.com/ClickHouse/ClickHouse/pull/87279) ([Isak Ellmer](https://github.com/spinojara)).
* Добавлена возможность проверять `stat` произвольного узла Keeper при выполнении транзакции записи. Это может помочь в выявлении ABA-проблемы. [#87282](https://github.com/ClickHouse/ClickHouse/pull/87282) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Перенаправлять тяжёлые запросы YTsaurus на тяжёлые прокси. [#87342](https://github.com/ClickHouse/ClickHouse/pull/87342) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Исправляет откаты операций unlink/rename/removeRecursive/removeDirectory/и т. д., а также счётчики жёстких ссылок во всех возможных сценариях нагрузки для метаданных, получаемых из дисковых транзакций, и упрощает интерфейсы, делая их более универсальными, чтобы их можно было повторно использовать в других хранилищах метаданных. [#87358](https://github.com/ClickHouse/ClickHouse/pull/87358) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Добавлен параметр конфигурации `keeper_server.tcp_nodelay`, который позволяет отключить `TCP_NODELAY` для Keeper. [#87363](https://github.com/ClickHouse/ClickHouse/pull/87363) (Copilot).
* Реализована поддержка параметра `--connection` в `clickhouse-benchmarks`. Эта опция работает так же, как в `clickhouse-client`: вы можете указать предопределённые подключения в клиентском `config.xml`/`config.yaml` в разделе `connections_credentials`, чтобы не передавать явно пользователя и пароль через аргументы командной строки. Добавлена поддержка `--accept-invalid-certificate` в `clickhouse-benchmark`. [#87370](https://github.com/ClickHouse/ClickHouse/pull/87370) ([Azat Khuzhin](https://github.com/azat)).
* Теперь установка параметра `max_insert_threads` будет применяться к таблицам Iceberg. [#87407](https://github.com/ClickHouse/ClickHouse/pull/87407) ([alesapin](https://github.com/alesapin)).
* В `PrometheusMetricsWriter` добавлены гистограммные и многомерные метрики. Таким образом, обработчик `PrometheusRequestHandler` будет содержать все необходимые метрики и сможет использоваться для надежного сбора метрик в облаке с низкими накладными расходами. [#87521](https://github.com/ClickHouse/ClickHouse/pull/87521) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Функция `hasToken` теперь возвращает ноль совпадений для пустого токена (хотя ранее в этом случае выбрасывалось исключение). [#87564](https://github.com/ClickHouse/ClickHouse/pull/87564) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
* Добавлена поддержка текстового индекса для значений типов `Array` и `Map` (`mapKeys` и `mapValues`). Поддерживаемые функции: `mapContainsKey` и `has`. [#87602](https://github.com/ClickHouse/ClickHouse/pull/87602) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Добавлена новая метрика `ZooKeeperSessionExpired`, которая показывает количество истекших глобальных сессий ZooKeeper. [#87613](https://github.com/ClickHouse/ClickHouse/pull/87613) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Используйте клиент хранилища S3 со специальными настройками для резервного копирования (например, backup&#95;slow&#95;all&#95;threads&#95;after&#95;retryable&#95;s3&#95;error) для серверного (нативного) копирования в целевое хранилище резервной копии. Параметр s3&#95;slow&#95;all&#95;threads&#95;after&#95;retryable&#95;error помечен как устаревший. [#87660](https://github.com/ClickHouse/ClickHouse/pull/87660) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлена некорректная обработка настроек `max_joined_block_size_rows` и `max_joined_block_size_bytes` при сериализации плана запроса с экспериментальной настройкой `make_distributed_plan`. [#87675](https://github.com/ClickHouse/ClickHouse/pull/87675) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Настройка `enable_http_compression` теперь включена по умолчанию. Это означает, что если клиент поддерживает HTTP-сжатие, сервер будет его использовать. Однако у этого изменения есть и определённые недостатки. Клиент может запросить «тяжёлый» метод сжатия, такой как `bzip2`, что неразумно и приведёт к повышенному потреблению ресурсов сервера (хотя это будет заметно только при передаче больших результатов). Клиент может запросить `gzip`, что не так уж плохо, но менее эффективно по сравнению с `zstd`. Закрывает [#71591](https://github.com/ClickHouse/ClickHouse/issues/71591). [#87703](https://github.com/ClickHouse/ClickHouse/pull/87703) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* В таблицу `system.server_settings` добавлен новый параметр `keeper_hosts`, который предоставляет список хостов [Zoo]Keeper, к которым может подключаться ClickHouse. [#87718](https://github.com/ClickHouse/ClickHouse/pull/87718) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлены значения `from` и `to` в системные дашборды для упрощения анализа исторических данных. [#87823](https://github.com/ClickHouse/ClickHouse/pull/87823) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Добавлена дополнительная информация для мониторинга производительности в запросах SELECT к Iceberg. [#87903](https://github.com/ClickHouse/ClickHouse/pull/87903) ([Daniil Ivanik](https://github.com/divanik)).
* Улучшение кеша файловой системы: повторное использование итератора приоритетов кеша несколькими потоками, одновременно резервирующими место в кеше. [#87914](https://github.com/ClickHouse/ClickHouse/pull/87914) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена возможность ограничивать размер запросов для `Keeper` (настройка `max_request_size`, аналогичная `jute.maxbuffer` для `ZooKeeper`, по умолчанию отключена для сохранения обратной совместимости, планируется включить в следующих релизах). [#87952](https://github.com/ClickHouse/ClickHouse/pull/87952) ([Azat Khuzhin](https://github.com/azat)).
* Сделать так, чтобы `clickhouse-benchmark` по умолчанию не добавлял трассировки стека в сообщения об ошибках. [#87954](https://github.com/ClickHouse/ClickHouse/pull/87954) ([Ahmed Gouda](https://github.com/0xgouda)).
* Избегайте использования пула потоков для асинхронной загрузки меток (`load_marks_asynchronously=1`), когда метки уже находятся в кэше (поскольку пул может быть перегружен, и запросы понесут дополнительную задержку из‑за этого, даже если метки уже в кэше). [#87967](https://github.com/ClickHouse/ClickHouse/pull/87967) ([Azat Khuzhin](https://github.com/azat)).
* Ytsaurus: добавлена возможность создавать таблицы/табличные функции/словари только с частью столбцов. [#87982](https://github.com/ClickHouse/ClickHouse/pull/87982) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Теперь `system.zookeeper_connection_log` по умолчанию включён, и его можно использовать для получения информации о сеансах Keeper. [#88011](https://github.com/ClickHouse/ClickHouse/pull/88011) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Сделать поведение TCP и HTTP единообразным при передаче дублирующихся внешних таблиц. HTTP позволяет передавать временную таблицу несколько раз. [#88032](https://github.com/ClickHouse/ClickHouse/pull/88032) ([Sema Checherinda](https://github.com/CheSema)).
* Удалены пользовательские `MemoryPools` для чтения Arrow/ORC/Parquet. Этот компонент, по‑видимому, стал не нужен после [#84082](https://github.com/ClickHouse/ClickHouse/pull/84082), так как теперь мы и так отслеживаем все выделения памяти. [#88035](https://github.com/ClickHouse/ClickHouse/pull/88035) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлена возможность создавать базу данных `Replicated` без аргументов. [#88044](https://github.com/ClickHouse/ClickHouse/pull/88044) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* `clickhouse-keeper-client`: Добавлена поддержка подключения к TLS-порту `clickhouse-keeper`; имена флагов сохранены такими же, как в `clickhouse-client`. [#88065](https://github.com/ClickHouse/ClickHouse/pull/88065) ([Pradeep Chhetri](https://github.com/chhetripradeep)).
* Добавлено новое профильное событие для отслеживания числа отклонений фонового слияния из-за превышения лимита памяти. [#88084](https://github.com/ClickHouse/ClickHouse/pull/88084) ([Grant Holly](https://github.com/grantholly-clickhouse)).
* Включает анализатор для проверки выражений по умолчанию для столбцов в операторах CREATE/ALTER TABLE. [#88087](https://github.com/ClickHouse/ClickHouse/pull/88087) ([Max Justus Spransy](https://github.com/maxjustus)).
* Внутреннее улучшение планировщика запросов: использование JoinStepLogical для `CROSS JOIN`. [#88151](https://github.com/ClickHouse/ClickHouse/pull/88151) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Добавлены псевдонимы функций `hasAnyTokens` (`hasAnyToken`) и `hasAllTokens` (`hasAllToken`). [#88162](https://github.com/ClickHouse/ClickHouse/pull/88162) ([George Larionov](https://github.com/george-larionov)).
* По умолчанию включён глобальный профилировщик сэмплирования (то есть даже для серверных потоков, не связанных с запросами): сбор стек-трейсов всех потоков каждые 10 секунд по процессорному и реальному времени. [#88209](https://github.com/ClickHouse/ClickHouse/pull/88209) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Обновлён SDK Azure, чтобы включить исправление `Content-Length`, необходимое для корректной работы операций копирования и создания контейнера. [#88278](https://github.com/ClickHouse/ClickHouse/pull/88278) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Функция `lag` сделана регистронезависимой для совместимости с MySQL. [#88322](https://github.com/ClickHouse/ClickHouse/pull/88322) ([Lonny Kapelushnik](https://github.com/lonnylot)).
* Теперь разрешен запуск `clickhouse-local` из директории `clickhouse-server`. В предыдущих версиях это приводило к ошибке `Cannot parse UUID: .`. Теперь вы можете запускать `clickhouse-local` и работать с базами данных сервера без запуска самого сервера. [#88383](https://github.com/ClickHouse/ClickHouse/pull/88383) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен параметр конфигурации `keeper_server.coordination_settings.check_node_acl_on_remove`. При его включении перед каждым удалением узла будут проверяться ACL как этого узла, так и его родительского узла. В противном случае будет проверяться только ACL родительского узла. [#88513](https://github.com/ClickHouse/ClickHouse/pull/88513) ([Antonio Andelic](https://github.com/antonio2368)).
* Столбцы `JSON` теперь выводятся в удобочитаемом виде при использовании формата `Vertical`. Исправляет [#81794](https://github.com/ClickHouse/ClickHouse/issues/81794). [#88524](https://github.com/ClickHouse/ClickHouse/pull/88524) ([Frank Rosner](https://github.com/FRosner)).
* Хранить файлы `clickhouse-client` (например, историю запросов) в каталогах, определённых спецификацией [XDG Base Directories](https://specifications.freedesktop.org/basedir-spec/latest/index.html), а не в корне домашнего каталога. `~/.clickhouse-client-history` по-прежнему будет использоваться, если он уже существует. [#88538](https://github.com/ClickHouse/ClickHouse/pull/88538) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлена утечка памяти из-за `GLOBAL IN` ([https://github.com/ClickHouse/ClickHouse/issues/88615](https://github.com/ClickHouse/ClickHouse/issues/88615)). [#88617](https://github.com/ClickHouse/ClickHouse/pull/88617) ([pranavmehta94](https://github.com/pranavmehta94)).
* Добавлена перегрузка hasAny/hasAllTokens, принимающая строковый аргумент. [#88679](https://github.com/ClickHouse/ClickHouse/pull/88679) ([George Larionov](https://github.com/george-larionov)).
* Добавлен шаг в postinstall-скрипт для `clickhouse-keeper` для включения автозапуска при загрузке системы. [#88746](https://github.com/ClickHouse/ClickHouse/pull/88746) ([YenchangChan](https://github.com/YenchangChan)).
* Проверка учетных данных в веб-интерфейсе теперь выполняется только при вставке, а не при каждом нажатии клавиши. Это устраняет проблему с некорректно настроенными серверами LDAP. Исправляет [#85777](https://github.com/ClickHouse/ClickHouse/issues/85777). [#88769](https://github.com/ClickHouse/ClickHouse/pull/88769) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Ограничена длина сообщения об исключении при нарушении ограничения. В предыдущих версиях вы могли получить очень длинное сообщение об исключении при вставке очень длинной строки, что в итоге приводило к его записи в `query_log`. Закрывает [#87032](https://github.com/ClickHouse/ClickHouse/issues/87032). [#88801](https://github.com/ClickHouse/ClickHouse/pull/88801) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена проблема с запросом структуры набора данных с сервера ArrowFlight при создании таблицы. [#87542](https://github.com/ClickHouse/ClickHouse/pull/87542) ([Vitaly Baranov](https://github.com/vitlibar)).





#### Исправление ошибки (некорректное поведение, видимое пользователю, в официальном стабильном релизе)

* Исправлена проблема в GeoParquet, которая вызывала ошибки клиентского протокола. [#84020](https://github.com/ClickHouse/ClickHouse/pull/84020) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена работа зависящих от хоста функций, таких как shardNum(), при их использовании в подзапросах на узле-инициаторе. [#84409](https://github.com/ClickHouse/ClickHouse/pull/84409) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлена некорректная обработка дат до эпохи Unix с дробными секундами в различных функциях, связанных с датой и временем, таких как `parseDateTime64BestEffort`, `change{Year,Month,Day}` и `makeDateTime64`. Ранее дробная часть секунд вычиталась из целых секунд вместо прибавления к ним. Например, `parseDateTime64BestEffort('1969-01-01 00:00:00.468')` возвращала `1968-12-31 23:59:59.532` вместо `1969-01-01 00:00:00.468`. [#85396](https://github.com/ClickHouse/ClickHouse/pull/85396) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Исправлены ошибки выполнения команд ALTER COLUMN IF EXISTS, возникавшие при изменении состояния столбца в пределах одного запроса ALTER. Теперь команды DROP COLUMN IF EXISTS, MODIFY COLUMN IF EXISTS, COMMENT COLUMN IF EXISTS и RENAME COLUMN IF EXISTS корректно обрабатывают случаи, когда столбец удаляется предыдущей командой в том же запросе. [#86046](https://github.com/ClickHouse/ClickHouse/pull/86046) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Исправлен вывод типов Date/DateTime/DateTime64 для дат, выходящих за пределы поддерживаемого диапазона. [#86184](https://github.com/ClickHouse/ClickHouse/pull/86184) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка, из-за которой некоторые корректные данные, отправленные пользователем в столбец `AggregateFunction(quantileDD)`, могли приводить к бесконечной рекурсии при слияниях. [#86560](https://github.com/ClickHouse/ClickHouse/pull/86560) ([Raphaël Thériault](https://github.com/raphael-theriault-swi)).
* Поддержка типов JSON и Dynamic в таблицах, создаваемых с помощью табличной функции `cluster`. [#86821](https://github.com/ClickHouse/ClickHouse/pull/86821) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена проблема, из-за которой результат функции, вычисляемой в CTE, был недетерминированным в запросе. [#86967](https://github.com/ClickHouse/ClickHouse/pull/86967) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена ошибка LOGICAL&#95;ERROR в EXPLAIN при использовании pointInPolygon для столбцов первичного ключа. [#86971](https://github.com/ClickHouse/ClickHouse/pull/86971) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена работа с таблицами озера данных с percent-encoded последовательностью в имени. Закрывает [#86626](https://github.com/ClickHouse/ClickHouse/issues/86626). [#87020](https://github.com/ClickHouse/ClickHouse/pull/87020) ([Anton Ivashkin](https://github.com/ianton-ru)).
* Исправлено некорректное поведение `IS NULL` для столбцов типа Nullable в `OUTER JOIN` при использовании `optimize_functions_to_subcolumns`, закрыт [#78625](https://github.com/ClickHouse/ClickHouse/issues/78625). [#87058](https://github.com/ClickHouse/ClickHouse/pull/87058) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлен некорректный учет освобождения временных данных при отслеживании лимита `max_temporary_data_on_disk_size`, закрыт [#87118](https://github.com/ClickHouse/ClickHouse/issues/87118). [#87140](https://github.com/ClickHouse/ClickHouse/pull/87140) ([JIaQi](https://github.com/JiaQiTang98)).
* Функция checkHeaders теперь корректно проверяет переданные заголовки и отклоняет недопустимые заголовки. Исходный автор: Michael Anastasakis (@michael-anastasakis). [#87172](https://github.com/ClickHouse/ClickHouse/pull/87172) ([Raúl Marín](https://github.com/Algunenano)).
* Делает поведение `toDate` и `toDate32` одинаковым для всех числовых типов. Исправляет проверку на выход за нижнюю границу диапазона (`underflow`) для `Date32` при приведении из `int16`. [#87176](https://github.com/ClickHouse/ClickHouse/pull/87176) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлена логическая ошибка в работе параллельных реплик в запросах с несколькими JOIN, в частности при использовании RIGHT JOIN после LEFT/INNER JOIN. [#87178](https://github.com/ClickHouse/ClickHouse/pull/87178) ([Igor Nikonov](https://github.com/devcrafter)).
* Учитывать настройку `input_format_try_infer_variants` в кеше определения схемы. [#87180](https://github.com/ClickHouse/ClickHouse/pull/87180) ([Pavel Kruglov](https://github.com/Avogar)).
* Теперь pathStartsWith сопоставляет только пути под указанным префиксом. [#87181](https://github.com/ClickHouse/ClickHouse/pull/87181) ([Raúl Марин](https://github.com/Algunenano)).
* Исправлены логические ошибки в виртуальном столбце `_row_number` и при позиционных удалениях в Iceberg. [#87220](https://github.com/ClickHouse/ClickHouse/pull/87220) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена ошибка &quot;Too large size passed to allocator&quot; `LOGICAL_ERROR` в `JOIN` из-за сочетания константных и неконстантных блоков. [#87231](https://github.com/ClickHouse/ClickHouse/pull/87231) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены облегчённые обновления с подзапросами, которые считывают данные из других таблиц `MergeTree`. [#87285](https://github.com/ClickHouse/ClickHouse/pull/87285) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена оптимизация move-to-prewhere, которая не работала при включённой политике строк. Продолжение [#85118](https://github.com/ClickHouse/ClickHouse/issues/85118). Закрывает [#69777](https://github.com/ClickHouse/ClickHouse/issues/69777). Закрывает [#83748](https://github.com/ClickHouse/ClickHouse/issues/83748). [#87303](https://github.com/ClickHouse/ClickHouse/pull/87303) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено применение патчей к столбцам с выражением по умолчанию, отсутствующим в частях данных. [#87347](https://github.com/ClickHouse/ClickHouse/pull/87347) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка сегментации при использовании повторяющихся имен полей партиционирования в таблицах MergeTree. [#87365](https://github.com/ClickHouse/ClickHouse/pull/87365) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Исправлена проблема с обновлением EmbeddedRocksDB. [#87392](https://github.com/ClickHouse/ClickHouse/pull/87392) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено прямое чтение из текстового индекса на объектном хранилище. [#87399](https://github.com/ClickHouse/ClickHouse/pull/87399) ([Anton Popov](https://github.com/CurtizJ)).
* Предотвращено создание привилегии для несуществующего движка. [#87419](https://github.com/ClickHouse/ClickHouse/pull/87419) ([Jitendra](https://github.com/jitendra1411)).
* Игнорируйте только ошибки «not found» для `s3_plain_rewritable` (что может привести к самым разным проблемам). [#87426](https://github.com/ClickHouse/ClickHouse/pull/87426) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены словари с источником YTSaurus и макетами словарей *range&#95;hashed. [#87490](https://github.com/ClickHouse/ClickHouse/pull/87490) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Исправлена ошибка при создании массива пустых кортежей. [#87520](https://github.com/ClickHouse/ClickHouse/pull/87520) ([Pavel Kruglov](https://github.com/Avogar)).
* Проверка наличия недопустимых столбцов при создании временной таблицы. [#87524](https://github.com/ClickHouse/ClickHouse/pull/87524) ([Pavel Kruglov](https://github.com/Avogar)).
* Никогда не помещайте столбцы секционирования Hive в заголовок формата. Исправляет [#87515](https://github.com/ClickHouse/ClickHouse/issues/87515). [#87528](https://github.com/ClickHouse/ClickHouse/pull/87528) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлена подготовка чтения из формата в DeltaLake при использовании текстового формата. [#87529](https://github.com/ClickHouse/ClickHouse/pull/87529) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправляет проверку доступа при выполнении `SELECT` и `INSERT` для таблиц `Buffer`. [#87545](https://github.com/ClickHouse/ClickHouse/pull/87545) ([pufit](https://github.com/pufit)).
* Запрещено создавать индекс пропуска данных для таблицы S3. [#87554](https://github.com/ClickHouse/ClickHouse/pull/87554) ([Bharat Nallan](https://github.com/bharatnc)).
* Исключена утечка отслеживаемой памяти при асинхронном логировании (возможен был значительный дрейф, за 10 часов ~100 GiB) и в `text_log` (мог быть почти такой же дрейф). [#87584](https://github.com/ClickHouse/ClickHouse/pull/87584) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, которая могла привести к тому, что глобальные настройки сервера перезаписывались настройками `SELECT` представления или материализованного представления, если это представление было асинхронно удалено и сервер был перезапущен до завершения фоновой очистки. [#87603](https://github.com/ClickHouse/ClickHouse/pull/87603) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исключать байты кэша страниц в пользовательском пространстве (если возможно) при вычислении предупреждения о превышении использования памяти. [#87610](https://github.com/ClickHouse/ClickHouse/pull/87610) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлена ошибка, при которой некорректный порядок типов при десериализации CSV приводил к `LOGICAL_ERROR`. [#87622](https://github.com/ClickHouse/ClickHouse/pull/87622) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена некорректная обработка `command_read_timeout` для исполняемых словарей. [#87627](https://github.com/ClickHouse/ClickHouse/pull/87627) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено некорректное поведение `SELECT * REPLACE` в предложении WHERE при использовании нового анализатора при фильтрации по заменённым столбцам. [#87630](https://github.com/ClickHouse/ClickHouse/pull/87630) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Исправлена двухуровневая агрегация при использовании `Merge` над `Distributed`. [#87687](https://github.com/ClickHouse/ClickHouse/pull/87687) ([c-end](https://github.com/c-end)).
* Исправлена генерация выходного блока в алгоритме HashJoin, когда не используется список правых строк. Исправление для [#87401](https://github.com/ClickHouse/ClickHouse/issues/87401). [#87699](https://github.com/ClickHouse/ClickHouse/pull/87699) ([Dmitry Novik](https://github.com/novikd)).
* Режим чтения параллельных реплик мог быть выбран некорректно, если после анализа индексов не оставалось данных для чтения. Закрывает [#87653](https://github.com/ClickHouse/ClickHouse/issues/87653). [#87700](https://github.com/ClickHouse/ClickHouse/pull/87700) ([zoomxi](https://github.com/zoomxi)).
* Исправлена обработка столбцов типов `timestamp` и `timestamptz` в Glue. [#87733](https://github.com/ClickHouse/ClickHouse/pull/87733) ([Andrey Zvonov](https://github.com/zvonand)).
* Закрывает [#86587](https://github.com/ClickHouse/ClickHouse/issues/86587). [#87761](https://github.com/ClickHouse/ClickHouse/pull/87761) ([scanhex12](https://github.com/scanhex12)).
* Исправлена запись булевых значений в интерфейсе PostgreSQL. [#87762](https://github.com/ClickHouse/ClickHouse/pull/87762) ([Artem Yurov](https://github.com/ArtemYurov)).
* Исправлена ошибка «неизвестная таблица» в запросе `INSERT SELECT` с использованием CTE, [#85368](https://github.com/ClickHouse/ClickHouse/issues/85368). [#87789](https://github.com/ClickHouse/ClickHouse/pull/87789) ([Guang Zhao](https://github.com/zheguang)).
* Исправлено чтение подстолбца карты с null-значениями из типов Variant, которые не могут быть заключены в Nullable. [#87798](https://github.com/ClickHouse/ClickHouse/pull/87798) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена обработка ошибки при неполном удалении базы данных на вторичном узле кластера. [#87802](https://github.com/ClickHouse/ClickHouse/pull/87802) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлено несколько ошибок в skip-индексах. [#87817](https://github.com/ClickHouse/ClickHouse/pull/87817) ([Raúl Marín](https://github.com/Algunenano)).
* В AzureBlobStorage обновлено поведение: сначала выполняется попытка нативного копирования, а при ошибке &#39;Unauthroized&#39; выполняется переход к чтению и записи (в AzureBlobStorage при использовании разных учетных записей хранилища для источника и приемника возникает ошибка &#39;Unauthorized&#39;). Также исправлено применение параметра &quot;use&#95;native&#95;copy&quot; при указании endpoint в конфигурации. [#87826](https://github.com/ClickHouse/ClickHouse/pull/87826) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* ClickHouse аварийно завершался, если файл ArrowStream содержал неуникальный словарь. [#87863](https://github.com/ClickHouse/ClickHouse/pull/87863) ([Ilya Golshtein](https://github.com/ilejn)).
* Исправлена фатальная ошибка при использовании approx&#95;top&#95;k и finalizeAggregation. [#87892](https://github.com/ClickHouse/ClickHouse/pull/87892) ([Jitendra](https://github.com/jitendra1411)).
* Исправлено слияние с проекциями в случае, когда последний блок пуст. [#87928](https://github.com/ClickHouse/ClickHouse/pull/87928) ([Raúl Marín](https://github.com/Algunenano)).
* Не удаляйте инъективные функции из GROUP BY, если типы их аргументов не допускаются в GROUP BY. [#87958](https://github.com/ClickHouse/ClickHouse/pull/87958) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена некорректная элиминация гранул/партиций для ключей на основе `DateTime` при использовании в запросах настройки `session_timezone`. [#87987](https://github.com/ClickHouse/ClickHouse/pull/87987) ([Eduard Karacharov](https://github.com/korowa)).
* Возвращает количество затронутых строк после выполнения запроса в интерфейсе PostgreSQL. [#87990](https://github.com/ClickHouse/ClickHouse/pull/87990) ([Artem Yurov](https://github.com/ArtemYurov)).
* Ограничено применение проталкивания фильтров для PASTE JOIN, поскольку это может приводить к некорректным результатам. [#88078](https://github.com/ClickHouse/ClickHouse/pull/88078) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Применяет нормализацию URI перед выполнением проверки прав доступа, добавленной в [https://github.com/ClickHouse/ClickHouse/pull/84503](https://github.com/ClickHouse/ClickHouse/pull/84503). [#88089](https://github.com/ClickHouse/ClickHouse/pull/88089) ([pufit](https://github.com/pufit)).
* Исправлена логическая ошибка, возникавшая, если `ARRAY JOIN COLUMNS()` не соответствует ни одному столбцу в новом анализаторе. [#88091](https://github.com/ClickHouse/ClickHouse/pull/88091) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Исправлено предупреждение «High ClickHouse memory usage» (исключён кеш страниц). [#88092](https://github.com/ClickHouse/ClickHouse/pull/88092) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена возможная порча данных в таблицах `MergeTree` со столбцами с заданным `TTL`. [#88095](https://github.com/ClickHouse/ClickHouse/pull/88095) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена возможная ситуация с неперехваченным исключением при чтении `system.tables` при наличии некорректных таблиц во внешних базах данных (`PostgreSQL`/`SQLite`/... ), подключенных к системе. [#88105](https://github.com/ClickHouse/ClickHouse/pull/88105) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка в функциях `mortonEncode` и `hilbertEncode` при вызове с пустым кортежем в качестве аргумента. [#88110](https://github.com/ClickHouse/ClickHouse/pull/88110) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Теперь запросы с `ON CLUSTER` будут выполняться быстрее при наличии неактивных реплик в кластере. [#88153](https://github.com/ClickHouse/ClickHouse/pull/88153) ([alesapin](https://github.com/alesapin)).
* Теперь DDL-воркер удаляет устаревшие хосты из набора реплик. Это уменьшит объём метаданных, хранящихся в ZooKeeper. [#88154](https://github.com/ClickHouse/ClickHouse/pull/88154) ([alesapin](https://github.com/alesapin)).
* Исправлена работа ClickHouse при запуске без cgroups (из-за ошибки cgroups стали обязательным требованием для асинхронных метрик). [#88164](https://github.com/ClickHouse/ClickHouse/pull/88164) ([Azat Khuzhin](https://github.com/azat)).
* Выполнять корректную отмену операции перемещения каталога при ошибке. Нужно перезаписывать все объекты `prefix.path`, изменённые во время выполнения, а не только корневой объект. [#88198](https://github.com/ClickHouse/ClickHouse/pull/88198) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Исправлено распространение флага `is_shared` в `ColumnLowCardinality`. Это могло приводить к неверному результату операции GROUP BY, если новое значение вставлялось в столбец после того, как хеш-значения уже были предварительно вычислены и закэшированы в `ReverseIndex`. [#88213](https://github.com/ClickHouse/ClickHouse/pull/88213) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена настройка профиля нагрузки `max_cpu_share`. Теперь её можно использовать без задания настройки профиля нагрузки `max_cpus`. [#88217](https://github.com/ClickHouse/ClickHouse/pull/88217) ([Neerav](https://github.com/neeravsalaria)).
* Исправлена ошибка, из-за которой очень тяжёлые мутации с подзапросами могли застревать на этапе подготовки. Теперь такие мутации можно остановить командой `SYSTEM STOP MERGES`. [#88241](https://github.com/ClickHouse/ClickHouse/pull/88241) ([alesapin](https://github.com/alesapin)).
* Теперь коррелированные подзапросы работают с объектными хранилищами. [#88290](https://github.com/ClickHouse/ClickHouse/pull/88290) ([alesapin](https://github.com/alesapin)).
* Не пытайтесь инициализировать базы данных DataLake при доступе к `system.projections` и `system.data_skipping_indices`. [#88330](https://github.com/ClickHouse/ClickHouse/pull/88330) ([Azat Khuzhin](https://github.com/azat)).
* Теперь каталоги озёр данных будут отображаться в системных таблицах интроспекции только в том случае, если параметр `show_data_lake_catalogs_in_system_tables` явно включён. [#88341](https://github.com/ClickHouse/ClickHouse/pull/88341) ([alesapin](https://github.com/alesapin)).
* Исправлена работа `DatabaseReplicated` с учётом конфигурации `interserver_http_host`. [#88378](https://github.com/ClickHouse/ClickHouse/pull/88378) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Позиционные аргументы теперь явно отключены в контексте определения проекций, так как они не имеют смысла на этой внутренней стадии выполнения запроса. Это исправляет [#48604](https://github.com/ClickHouse/ClickHouse/issues/48604). [#88380](https://github.com/ClickHouse/ClickHouse/pull/88380) ([Amos Bird](https://github.com/amosbird)).
* Устранена квадратичная сложность в функции `countMatches`. Закрывает [#88400](https://github.com/ClickHouse/ClickHouse/issues/88400). [#88401](https://github.com/ClickHouse/ClickHouse/pull/88401) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Команды `ALTER COLUMN ... COMMENT` для таблиц KeeperMap теперь реплицируются, поэтому они фиксируются в метаданных базы данных Replicated и распространяются на все реплики. Закрывает [#88077](https://github.com/ClickHouse/ClickHouse/issues/88077). [#88408](https://github.com/ClickHouse/ClickHouse/pull/88408) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлен случай ложной циклической зависимости с материализованными представлениями в реплицируемой базе данных, который препятствовал добавлению новых реплик в базу. [#88423](https://github.com/ClickHouse/ClickHouse/pull/88423) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена агрегация разреженных столбцов при установленном значении `group_by_overflow_mode` = `any`. [#88440](https://github.com/ClickHouse/ClickHouse/pull/88440) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлена ошибка &quot;column not found&quot; при использовании `query_plan_use_logical_join_step=0` с несколькими операторами FULL JOIN USING. Закрывает [#88103](https://github.com/ClickHouse/ClickHouse/issues/88103). [#88473](https://github.com/ClickHouse/ClickHouse/pull/88473) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Большие кластеры с числом узлов &gt; 10 имеют высокую вероятность сбоя восстановления с ошибкой `[941] 67c45db4-4df4-4879-87c5-25b8d1e0d414 &lt;Trace&gt;: RestoreCoordinationOnCluster The version of node /clickhouse/backups/restore-7c551a77-bd76-404c-bad0-3213618ac58e/stage/num_hosts changed (attempt #9), will try again`. Узел `num_hosts` одновременно перезаписывается большим числом хостов. Исправление делает параметр, управляющий количеством попыток, динамическим. Закрывает [#87721](https://github.com/ClickHouse/ClickHouse/issues/87721). [#88484](https://github.com/ClickHouse/ClickHouse/pull/88484) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Этот PR предназначен только для обеспечения совместимости с версией 23.8 и более старыми. Проблема совместимости появилась в этом PR: [https://github.com/ClickHouse/ClickHouse/pull/54240](https://github.com/ClickHouse/ClickHouse/pull/54240). Этот SQL-запрос завершится с ошибкой при `enable_analyzer=0` (до 23.8 он выполнялся нормально). [#88491](https://github.com/ClickHouse/ClickHouse/pull/88491) ([JIaQi](https://github.com/JiaQiTang98)).
* Исправлена обнаруженная UBSAN ошибка переполнения целого числа в сообщении об ошибке `accurateCast` при преобразовании больших значений в DateTime. [#88520](https://github.com/ClickHouse/ClickHouse/pull/88520) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Исправлен механизм coalescing merge tree для типов `tuple`. Это закрывает [#88469](https://github.com/ClickHouse/ClickHouse/issues/88469). [#88526](https://github.com/ClickHouse/ClickHouse/pull/88526) ([scanhex12](https://github.com/scanhex12)).
* Запретить удаление при `iceberg_format_version=1`. Это закрывает задачу [#88444](https://github.com/ClickHouse/ClickHouse/issues/88444). [#88532](https://github.com/ClickHouse/ClickHouse/pull/88532) ([scanhex12](https://github.com/scanhex12)).
* Этот патч исправляет операцию перемещения на дисках `plain-rewritable` для каталогов произвольной глубины. [#88586](https://github.com/ClickHouse/ClickHouse/pull/88586) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Исправлена работа SQL SECURITY DEFINER в сочетании с функциями *cluster. [#88588](https://github.com/ClickHouse/ClickHouse/pull/88588) ([Julian Maicher](https://github.com/jmaicher)).
* Исправлен потенциальный сбой, возникавший при конкурентной мутации базовых константных столбцов PREWHERE. [#88605](https://github.com/ClickHouse/ClickHouse/pull/88605) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено чтение из текстового индекса и включено кеширование условий запроса (при включённых настройках `use_skip_indexes_on_data_read` и `use_query_condition_cache`). [#88660](https://github.com/ClickHouse/ClickHouse/pull/88660) ([Anton Popov](https://github.com/CurtizJ)).
* Исключение `Poco::TimeoutException`, выбрасываемое из `Poco::Net::HTTPChunkedStreamBuf::readFromDevice`, приводит к аварийному завершению процесса с SIGABRT. [#88668](https://github.com/ClickHouse/ClickHouse/pull/88668) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Назадпортировано в [#88910](https://github.com/ClickHouse/ClickHouse/issues/88910): после восстановления реплика базы данных Replicated могла надолго «зависать», выводя сообщения вида `Failed to marked query-0004647339 as finished (finished=No node, synced=No node)`. Проблема исправлена. [#88671](https://github.com/ClickHouse/ClickHouse/pull/88671) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлено добавление записей в `system.zookeeper_connection_log` при первом подключении ClickHouse после перезагрузки конфигурации. [#88728](https://github.com/ClickHouse/ClickHouse/pull/88728) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка, при которой преобразование DateTime64 в Date с `date_time_overflow_behavior = 'saturate'` могло приводить к некорректным результатам для значений вне допустимого диапазона при использовании часовых поясов. [#88737](https://github.com/ClickHouse/ClickHouse/pull/88737) ([Manuel](https://github.com/raimannma)).
* N-я попытка исправить ошибку «having zero bytes» в табличном движке S3 с включённым кэшем. [#88740](https://github.com/ClickHouse/ClickHouse/pull/88740) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проверка прав доступа при выполнении операции `SELECT` для табличной функции `loop`. [#88802](https://github.com/ClickHouse/ClickHouse/pull/88802) ([pufit](https://github.com/pufit)).
* Перехватывайте исключения при сбоях асинхронного логирования, чтобы предотвратить аварийное завершение программы. [#88814](https://github.com/ClickHouse/ClickHouse/pull/88814) ([Raúl Marín](https://github.com/Algunenano)).
* Бэкпортировано в [#89060](https://github.com/ClickHouse/ClickHouse/issues/89060): исправлена функция `top_k`, чтобы она учитывала параметр порога при вызове с одним аргументом. Закрывает [#88757](https://github.com/ClickHouse/ClickHouse/issues/88757). [#88867](https://github.com/ClickHouse/ClickHouse/pull/88867) ([Manuel](https://github.com/raimannma)).
* Бэкпортировано в [#88944](https://github.com/ClickHouse/ClickHouse/issues/88944): исправлена ошибка в функции `reverseUTF8`. В предыдущих версиях она по ошибке переворачивала порядок байтов кодовых точек UTF-8 длиной 4 байта. Это закрывает [#88913](https://github.com/ClickHouse/ClickHouse/issues/88913). [#88914](https://github.com/ClickHouse/ClickHouse/pull/88914) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Бэкпортировано в [#88980](https://github.com/ClickHouse/ClickHouse/issues/88980): не проверять наличие доступа `SET DEFINER <current_user>:definer` при создании представления с SQL SECURITY DEFINER. [#88968](https://github.com/ClickHouse/ClickHouse/pull/88968) ([pufit](https://github.com/pufit)).
* Бэкпортировано в [#89058](https://github.com/ClickHouse/ClickHouse/issues/89058): исправлена ошибка `LOGICAL_ERROR` в `L2DistanceTransposed(vec1, vec2, p)`, при которой оптимизация частичного чтения `QBit` некорректно удаляла `Nullable` из возвращаемого типа, когда `p` имел тип `Nullable`. [#88974](https://github.com/ClickHouse/ClickHouse/pull/88974) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Бэкпортировано в [#89167](https://github.com/ClickHouse/ClickHouse/issues/89167): исправлен сбой при неизвестном типе каталога. Исправляет [#88819](https://github.com/ClickHouse/ClickHouse/issues/88819). [#88987](https://github.com/ClickHouse/ClickHouse/pull/88987) ([scanhex12](https://github.com/scanhex12)).
* Бэкпортировано в [#89028](https://github.com/ClickHouse/ClickHouse/issues/89028): исправлено снижение производительности при анализе пропускающих индексов. [#89004](https://github.com/ClickHouse/ClickHouse/pull/89004) ([Anton Popov](https://github.com/CurtizJ)).

#### Улучшения сборки/тестирования/упаковки

- Использование библиотеки `postgres` версии 18.0. [#87647](https://github.com/ClickHouse/ClickHouse/pull/87647) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Включена поддержка ICU для FreeBSD. [#87891](https://github.com/ClickHouse/ClickHouse/pull/87891) ([Raúl Marín](https://github.com/Algunenano)).
- Использование SSE 4.2 при динамической диспетчеризации на SSE 4.2, а не на SSE 4. [#88029](https://github.com/ClickHouse/ClickHouse/pull/88029) ([Raúl Marín](https://github.com/Algunenano)).
- Флаг `NO_ARMV81_OR_HIGHER` больше не требуется, если `Speculative Store Bypass Safe` недоступен. [#88051](https://github.com/ClickHouse/ClickHouse/pull/88051) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Когда ClickHouse собран с `ENABLE_LIBFIU=OFF`, функции, связанные с точками отказа, становятся пустыми операциями и больше не влияют на производительность. В этом случае запросы `SYSTEM ENABLE/DISABLE FAILPOINT` возвращают ошибку `SUPPORT_IS_DISABLED`. [#88184](https://github.com/ClickHouse/ClickHouse/pull/88184) ([c-end](https://github.com/c-end)).

### Релиз ClickHouse 25.9, 2025-09-25 {#259}

#### Обратно несовместимые изменения

- Отключены бессмысленные бинарные операции с IPv4/IPv6: сложение/вычитание IPv4/IPv6 с нецелочисленным типом теперь запрещено. Ранее допускались операции с типами с плавающей точкой и возникали логические ошибки с некоторыми другими типами (например, DateTime). [#86336](https://github.com/ClickHouse/ClickHouse/pull/86336) ([Raúl Marín](https://github.com/Algunenano)).
- Настройка `allow_dynamic_metadata_for_data_lakes` объявлена устаревшей. Теперь все таблицы Iceberg пытаются получить актуальную схему таблицы из хранилища перед выполнением каждого запроса. [#86366](https://github.com/ClickHouse/ClickHouse/pull/86366) ([Daniil Ivanik](https://github.com/divanik)).
- Изменено разрешение объединённого столбца из конструкции `OUTER JOIN ... USING` для большей согласованности: ранее при выборе как столбца USING, так и квалифицированных столбцов (`a, t1.a, t2.a`) в OUTER JOIN столбец USING неправильно разрешался в `t1.a`, показывая 0/NULL для строк из правой таблицы без совпадения слева. Теперь идентификаторы из конструкции USING всегда разрешаются в объединённый столбец, в то время как квалифицированные идентификаторы разрешаются в необъединённые столбцы, независимо от того, какие другие идентификаторы присутствуют в запросе. Например: ```sql SELECT a, t1.a, t2.a FROM (SELECT 1 as a WHERE 0) t1 FULL JOIN (SELECT 2 as a) t2 USING (a) -- Раньше: a=0, t1.a=0, t2.a=2 (неправильно - 'a' разрешается в t1.a) -- Теперь: a=2, t1.a=0, t2.a=2 (правильно - 'a' объединён). [#80848](https://github.com/ClickHouse/ClickHouse/pull/80848) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Увеличено окно репликационной дедупликации до 10000. Это полностью совместимое изменение, но можно представить сценарии, когда оно может привести к высокому потреблению ресурсов при наличии большого количества таблиц. [#86820](https://github.com/ClickHouse/ClickHouse/pull/86820) ([Sema Checherinda](https://github.com/CheSema)).


#### Новая функция

* Пользователи теперь могут использовать NATS JetStream для потребления сообщений, указав новые настройки `nats_stream` и `nats_consumer` для движка NATS. [#84799](https://github.com/ClickHouse/ClickHouse/pull/84799) ([Dmitry Novikov](https://github.com/dmitry-sles-novikov)).
* Добавлена поддержка аутентификации и SSL в табличной функции `arrowFlight`. [#87120](https://github.com/ClickHouse/ClickHouse/pull/87120) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлен новый параметр для движка таблиц `S3` и табличной функции `s3` — `storage_class_name`, который позволяет задавать интеллектуальное распределение по классам хранения (Intelligent-Tiering), поддерживаемое AWS. Поддерживается как в формате ключ-значение, так и в позиционном (устаревшем) формате. [#87122](https://github.com/ClickHouse/ClickHouse/pull/87122) ([alesapin](https://github.com/alesapin)).
* `ALTER UPDATE` для табличного движка Iceberg. [#86059](https://github.com/ClickHouse/ClickHouse/pull/86059) ([scanhex12](https://github.com/scanhex12)).
* Добавлена системная таблица `iceberg_metadata_log` для получения файлов метаданных Iceberg при выполнении запросов SELECT. [#86152](https://github.com/ClickHouse/ClickHouse/pull/86152) ([scanhex12](https://github.com/scanhex12)).
* Таблицы `Iceberg` и `DeltaLake` поддерживают пользовательскую конфигурацию диска через настройку уровня хранилища `disk`. [#86778](https://github.com/ClickHouse/ClickHouse/pull/86778) ([scanhex12](https://github.com/scanhex12)).
* Добавлена поддержка дисков дата-лейков в Azure. [#87173](https://github.com/ClickHouse/ClickHouse/pull/87173) ([scanhex12](https://github.com/scanhex12)).
* Поддержка каталога `Unity` поверх хранилища объектов Azure Blob Storage. [#80013](https://github.com/ClickHouse/ClickHouse/pull/80013) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Добавлена поддержка дополнительных форматов (`ORC`, `Avro`) при записи в `Iceberg`. Это закрывает [#86179](https://github.com/ClickHouse/ClickHouse/issues/86179). [#87277](https://github.com/ClickHouse/ClickHouse/pull/87277) ([scanhex12](https://github.com/scanhex12)).
* Добавлена новая системная таблица `database_replicas` с информацией о репликах баз данных. [#83408](https://github.com/ClickHouse/ClickHouse/pull/83408) ([Konstantin Morozов](https://github.com/k-morozov)).
* Добавлена функция `arrayExcept`, которая вычитает из одного массива элементы другого, рассматривая их как множества. [#82368](https://github.com/ClickHouse/ClickHouse/pull/82368) ([Joanna Hulboj](https://github.com/jh0x)).
* Добавлена новая таблица `system.aggregated_zookeeper_log`. Таблица содержит статистику по операциям ZooKeeper (например, количество операций, среднюю задержку, ошибки), сгруппированную по идентификатору сессии, родительскому пути и типу операции, и периодически записывается на диск. [#85102](https://github.com/ClickHouse/ClickHouse/pull/85102) [#87208](https://github.com/ClickHouse/ClickHouse/pull/87208) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Новая функция `isValidASCII`. Возвращает 1, если входная строка или FixedString содержит только байты ASCII (0x00–0x7F), иначе 0. Закрывает [#85377](https://github.com/ClickHouse/ClickHouse/issues/85377). ... [#85786](https://github.com/ClickHouse/ClickHouse/pull/85786) ([Rajat Mohan](https://github.com/rajatmohan22)).
* Логические настройки могут задаваться без аргументов, например: `SET use_query_cache;`, что эквивалентно установке значения в true. [#85800](https://github.com/ClickHouse/ClickHouse/pull/85800) ([thraeka](https://github.com/thraeka)).
* Новые параметры конфигурации `logger.startupLevel` и `logger.shutdownLevel` позволяют переопределить уровень логирования при запуске и завершении работы ClickHouse соответственно. [#85967](https://github.com/ClickHouse/ClickHouse/pull/85967) ([Lennard Eijsackers](https://github.com/Blokje5)).
* Агрегатные функции `timeSeriesChangesToGrid` и `timeSeriesResetsToGrid`. Ведут себя аналогично `timeSeriesRateToGrid`, принимая параметры начальной метки времени, конечной метки времени, шага и окна просмотра в прошлое (lookback window), а также два аргумента для меток времени и значений, но требуют как минимум одну выборку на окно вместо двух. Вычисляют PromQL `changes`/`resets`, подсчитывая, сколько раз значение выборки изменяется или уменьшается в указанном окне для каждой метки времени во временной сетке, определяемой параметрами. Тип возвращаемого значения — `Array(Nullable(Float64))`. [#86010](https://github.com/ClickHouse/ClickHouse/pull/86010) ([Stephen Chi](https://github.com/stephchi0)).
* Позволяет пользователям создавать временные представления с синтаксисом, аналогичным синтаксису временных таблиц (`CREATE TEMPORARY VIEW`). [#86432](https://github.com/ClickHouse/ClickHouse/pull/86432) ([Aly Kafoury](https://github.com/AlyHKafoury)).
* Добавлены предупреждения об использовании CPU и памяти в таблицу `system.warnings`. [#86838](https://github.com/ClickHouse/ClickHouse/pull/86838) ([Bharat Nallan](https://github.com/bharatnc)).
* Поддержка индикатора `oneof` во входных данных `Protobuf`. Можно использовать специальный столбец для указания того, какое поле из oneof присутствует. Если сообщение содержит [oneof](https://protobuf.dev/programming-guides/proto3/#oneof) и включён `input_format_protobuf_oneof_presence`, ClickHouse заполняет столбец, указывающий, какое поле oneof было обнаружено. [#82885](https://github.com/ClickHouse/ClickHouse/pull/82885) ([Ilya Golshtein](https://github.com/ilejn)).
* Улучшено профилирование выделения памяти на основе внутренних инструментов jemalloc. Глобальный профилировщик jemalloc теперь может быть включён с помощью конфигурационного параметра `jemalloc_enable_global_profiler`. Выборочные глобальные операции выделения и освобождения памяти могут сохраняться в `system.trace_log` с типом `JemallocSample` при включении параметра `jemalloc_collect_global_profile_samples_in_trace_log`. Профилирование jemalloc теперь может быть включено независимо для каждого запроса с помощью настройки `jemalloc_enable_profiler`. Сохранение выборок в `system.trace_log` может контролироваться на уровне запроса с помощью настройки `jemalloc_collect_profile_samples_in_trace_log`. Аллокатор jemalloc обновлён до более новой версии. [#85438](https://github.com/ClickHouse/ClickHouse/pull/85438) ([Antonio Andelic](https://github.com/antonio2368)).
* Новая настройка для удаления файлов при удалении таблиц Iceberg. Этим закрывается задача [#86211](https://github.com/ClickHouse/ClickHouse/issues/86211). [#86501](https://github.com/ClickHouse/ClickHouse/pull/86501) ([scanhex12](https://github.com/scanhex12)).



#### Экспериментальные возможности
* Инвертированный текстовый индекс был переработан с нуля, чтобы масштабироваться для наборов данных, которые не помещаются в оперативную память. [#86485](https://github.com/ClickHouse/ClickHouse/pull/86485) ([Anton Popov](https://github.com/CurtizJ)).
* Переупорядочивание `JOIN` теперь использует статистику. Функцию можно включить, установив `allow_statistics_optimize = 1` и `query_plan_optimize_join_order_limit = 10`. [#86822](https://github.com/ClickHouse/ClickHouse/pull/86822) ([Han Fei](https://github.com/hanfei1991)).
* Поддерживается `alter table ... materialize statistics all`, что позволяет материализовать всю статистику таблицы. [#87197](https://github.com/ClickHouse/ClickHouse/pull/87197) ([Han Fei](https://github.com/hanfei1991)).



#### Улучшение производительности

* Добавлена поддержка фильтрации частей данных с использованием skip-индексов при чтении для сокращения ненужных чтений индексов. Управляется новой настройкой `use_skip_indexes_on_data_read` (по умолчанию отключена). Эта доработка закрывает задачу [#75774](https://github.com/ClickHouse/ClickHouse/issues/75774). Включает общую подготовительную работу, используемую также в [#81021](https://github.com/ClickHouse/ClickHouse/issues/81021). [#81526](https://github.com/ClickHouse/ClickHouse/pull/81526) ([Amos Bird](https://github.com/amosbird)).
* Добавлена оптимизация порядка `JOIN`, которая может автоматически менять порядок `JOIN` для повышения производительности (управляется параметром `query_plan_optimize_join_order_limit`). Обратите внимание, что в настоящий момент оптимизация порядка `JOIN` имеет ограниченную поддержку статистики и в основном опирается на оценки количества строк от движков хранения данных — более совершенный сбор статистики и оценка кардинальности будут добавлены в будущих релизах. **Если после обновления вы столкнетесь с проблемами с запросами с JOIN**, вы можете временно отключить новую реализацию, установив `SET query_plan_use_new_logical_join_step = 0`, и сообщить о проблеме для расследования. **Замечание о разрешении идентификаторов из конструкции USING**: Изменено разрешение сведённого (coalesced) столбца из предложения `OUTER JOIN ... USING` для большей согласованности: ранее, при выборе и столбца из USING, и квалифицированных столбцов (`a, t1.a, t2.a`) в `OUTER JOIN`, столбец из USING некорректно разрешался в `t1.a`, показывая 0/NULL для строк из правой таблицы без соответствия в левой. Теперь идентификаторы из предложения USING всегда разрешаются в сведённый (coalesced) столбец, в то время как квалифицированные идентификаторы сопоставляются с несведёнными столбцами, независимо от того, какие другие идентификаторы присутствуют в запросе. Например:
  SELECT a, t1.a, t2.a
  FROM (SELECT 1 as a WHERE 0) t1
  FULL JOIN (SELECT 2 as a) t2 USING (a)
  -- Ранее: a=0, t1.a=0, t2.a=2 (некорректно — &#39;a&#39; разрешён в t1.a)
  -- Теперь: a=2, t1.a=0, t2.a=2 (корректно — &#39;a&#39; является сведённым).
  [#80848](https://github.com/ClickHouse/ClickHouse/pull/80848) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Распределённый `INSERT SELECT` для озёр данных. [#86783](https://github.com/ClickHouse/ClickHouse/pull/86783) ([scanhex12](https://github.com/scanhex12)).
* Улучшена оптимизация PREWHERE для условий вида `func(primary_column) = 'xx'` и `column in (xxx)`. [#85529](https://github.com/ClickHouse/ClickHouse/pull/85529) ([李扬](https://github.com/taiyang-li)).
* Реализовано переписывание JOIN: 1. Преобразование `LEFT ANY JOIN` и `RIGHT ANY JOIN` в `SEMI`/`ANTI` JOIN, если условие фильтрации всегда ложно для соответствующих или несоответствующих строк. Эта оптимизация управляется новым параметром `query_plan_convert_any_join_to_semi_or_anti_join`. 2. Преобразование `FULL ALL JOIN` в `LEFT ALL` или `RIGHT ALL` JOIN, если условие фильтрации всегда ложно для несоответствующих строк с одной из сторон соединения. [#86028](https://github.com/ClickHouse/ClickHouse/pull/86028) ([Dmitry Novik](https://github.com/novikd)).
* Улучшена производительность вертикальных слияний после выполнения операции лёгкого удаления. [#86169](https://github.com/ClickHouse/ClickHouse/pull/86169) ([Anton Popov](https://github.com/CurtizJ)).
* Немного оптимизирована производительность `HashJoin` в случае соединений `LEFT/RIGHT JOIN` с большим количеством строк без соответствий. [#86312](https://github.com/ClickHouse/ClickHouse/pull/86312) ([Nikita Taranov](https://github.com/nickitat)).
* Radix sort: помогает компилятору эффективнее использовать SIMD и улучшить программную предвыборку (prefetching) данных. Применяет динамическую диспетчеризацию, чтобы включать программную предвыборку только на процессорах Intel. Продолжает работу @taiyang-li в [https://github.com/ClickHouse/ClickHouse/pull/77029](https://github.com/ClickHouse/ClickHouse/pull/77029). [#86378](https://github.com/ClickHouse/ClickHouse/pull/86378) ([Raúl Marín](https://github.com/Algunenano)).
* Повышает производительность коротких запросов по таблицам с большим количеством частей (путём оптимизации `MarkRanges` за счёт использования `devector` вместо `deque`). [#86933](https://github.com/ClickHouse/ClickHouse/pull/86933) ([Azat Khuzhin](https://github.com/azat)).
* Повышена производительность применения патч-частей в режиме `join`. [#87094](https://github.com/ClickHouse/ClickHouse/pull/87094) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена настройка `query_condition_cache_selectivity_threshold` (значение по умолчанию: 1.0), которая исключает результаты сканирования предикатов с низкой селективностью из помещения в кэш условий запроса. Это позволяет снизить потребление памяти кэшем условий запроса ценой более низкого коэффициента попаданий в кэш. [#86076](https://github.com/ClickHouse/ClickHouse/pull/86076) ([zhongyuankai](https://github.com/zhongyuankai)).
* Снижено потребление памяти при записи в Iceberg. [#86544](https://github.com/ClickHouse/ClickHouse/pull/86544) ([scanhex12](https://github.com/scanhex12)).





#### Улучшение

* Поддерживает запись нескольких файлов данных в Iceberg за одну операцию вставки. Добавлены новые настройки `iceberg_insert_max_rows_in_data_file` и `iceberg_insert_max_bytes_in_data_file` для управления ограничениями. [#86275](https://github.com/ClickHouse/ClickHouse/pull/86275) ([scanhex12](https://github.com/scanhex12)).
* Добавлено ограничение на количество строк/байт для файлов данных, вставляемых в Delta Lake. Управляется настройками `delta_lake_insert_max_rows_in_data_file` и `delta_lake_insert_max_bytes_in_data_file`. [#86357](https://github.com/ClickHouse/ClickHouse/pull/86357) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Расширена поддержка типов партиционирования при записи в Iceberg. Это закрывает [#86206](https://github.com/ClickHouse/ClickHouse/issues/86206). [#86298](https://github.com/ClickHouse/ClickHouse/pull/86298) ([scanhex12](https://github.com/scanhex12)).
* Сделать стратегию повторных попыток для S3 настраиваемой и обеспечить возможность горячей перезагрузки настроек диска S3 при изменении XML-файла конфигурации. [#82642](https://github.com/ClickHouse/ClickHouse/pull/82642) ([RinChanNOW](https://github.com/RinChanNOWWW)).
* Улучшен движок таблицы S3(Azure)Queue, чтобы он мог переживать потерю соединения с ZooKeeper без риска появления дубликатов. Для этого требуется включить настройку S3Queue `use_persistent_processing_nodes` (изменяется с помощью `ALTER TABLE MODIFY SETTING`). [#85995](https://github.com/ClickHouse/ClickHouse/pull/85995) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Вы можете использовать параметры запроса после `TO` при создании материализованного представления, например: `CREATE MATERIALIZED VIEW mv TO {to_table:Identifier} AS SELECT * FROM src_table`. [#84899](https://github.com/ClickHouse/ClickHouse/pull/84899) ([Diskein](https://github.com/Diskein)).
* Добавлены более понятные инструкции для пользователей при указании некорректных настроек для движка таблиц `Kafka2`. [#83701](https://github.com/ClickHouse/ClickHouse/pull/83701) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Теперь нельзя указывать часовые пояса для типа `Time` (что не имело смысла). [#84689](https://github.com/ClickHouse/ClickHouse/pull/84689) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Упрощена логика, связанная с разбором Time/Time64 в режиме `best_effort`, и устранён ряд ошибок. [#84730](https://github.com/ClickHouse/ClickHouse/pull/84730) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлены функции `deltaLakeAzureCluster` (аналог `deltaLakeAzure` для кластерного режима) и `deltaLakeS3Cluster` (псевдоним `deltaLakeCluster`). Исправлена проблема [#85358](https://github.com/ClickHouse/ClickHouse/issues/85358). [#85547](https://github.com/ClickHouse/ClickHouse/pull/85547) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Применять настройку `azure_max_single_part_copy_size` для обычных операций копирования так же, как при резервном копировании. [#85767](https://github.com/ClickHouse/ClickHouse/pull/85767) ([Ilya Golshtein](https://github.com/ilejn)).
* Замедлять потоки клиента S3 при повторяемых ошибках в объектном хранилище S3. Расширяет действие предыдущей настройки `backup_slow_all_threads_after_retryable_s3_error` на S3-диски и переименовывает её в более общую `s3_slow_all_threads_after_retryable_error`. [#85918](https://github.com/ClickHouse/ClickHouse/pull/85918) ([Julia Kartseva](https://github.com/jkartseva)).
* Настройки отметок объявляют allow&#95;experimental&#95;variant/dynamic/json и enable&#95;variant/dynamic/json устаревшими. Теперь все три типа включены безусловно. [#85934](https://github.com/ClickHouse/ClickHouse/pull/85934) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена поддержка фильтрации по полной строке URL (директива `full_url`) в `http_handlers` (включая схему и host:port). [#86155](https://github.com/ClickHouse/ClickHouse/pull/86155) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена новая настройка `allow_experimental_delta_lake_writes`. [#86180](https://github.com/ClickHouse/ClickHouse/pull/86180) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено обнаружение systemd в скрипте init.d (исправлена проверка «Install packages»). [#86187](https://github.com/ClickHouse/ClickHouse/pull/86187) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена новая размерная метрика `startup_scripts_failure_reason`. Эта метрика необходима для различения типов ошибок, приводящих к сбою стартовых скриптов. В частности, для целей оповещения нам нужно различать временные (например, `MEMORY_LIMIT_EXCEEDED` или `KEEPER_EXCEPTION`) и ошибки невременного характера. [#86202](https://github.com/ClickHouse/ClickHouse/pull/86202) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Теперь можно опускать функцию `identity` для партиции в таблице Iceberg. [#86314](https://github.com/ClickHouse/ClickHouse/pull/86314) ([scanhex12](https://github.com/scanhex12)).
* Добавлена возможность включать JSON-логирование только для конкретного канала: для этого установите `logger.formatting.channel` в одно из значений `syslog`/`console`/`errorlog`/`log`. [#86331](https://github.com/ClickHouse/ClickHouse/pull/86331) ([Azat Khuzhin](https://github.com/azat)).
* Теперь можно использовать нативные числовые типы в `WHERE`. Они уже допускаются как аргументы логических функций. Это упрощает оптимизации filter-push-down и move-to-prewhere. [#86390](https://github.com/ClickHouse/ClickHouse/pull/86390) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка при выполнении `SYSTEM DROP REPLICA` для Catalog с повреждёнными метаданными. [#86391](https://github.com/ClickHouse/ClickHouse/pull/86391) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлены дополнительные повторные попытки проверки доступа к диску (`skip_access_check = 0`) в Azure, поскольку предоставление доступа может занимать довольно много времени. [#86419](https://github.com/ClickHouse/ClickHouse/pull/86419) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Окно устаревания в функциях `timeSeries*()` сделано левооткрытым и правозамкнутым. [#86588](https://github.com/ClickHouse/ClickHouse/pull/86588) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлены события профилирования `FailedInternal*Query`. [#86627](https://github.com/ClickHouse/ClickHouse/pull/86627) ([Shane Andrade](https://github.com/mauidude)).
* Исправлена обработка пользователей с точкой в имени пользователя при добавлении через конфигурационный файл. [#86633](https://github.com/ClickHouse/ClickHouse/pull/86633) ([Mikhail Koviazin](https://github.com/mkmkme)).
* Добавлены асинхронные метрики использования памяти в запросах (`QueriesMemoryUsage` и `QueriesPeakMemoryUsage`). [#86669](https://github.com/ClickHouse/ClickHouse/pull/86669) ([Azat Khuzhin](https://github.com/azat)).
* Вы можете использовать флаг `clickhouse-benchmark --precise` для более точного отображения QPS и других интервальных метрик. Это помогает получать стабильные значения QPS, когда время выполнения запросов сопоставимо с интервалом отчетности `--delay D`. [#86684](https://github.com/ClickHouse/ClickHouse/pull/86684) ([Sergei Trifonov](https://github.com/serxa)).
* Сделать значения nice-приоритета потоков Linux настраиваемыми, чтобы отдельным потокам (merge/mutate, query, materialized view, zookeeper client) можно было назначать более высокий или более низкий приоритет. [#86703](https://github.com/ClickHouse/ClickHouse/pull/86703) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Исправлена вводящая в заблуждение ошибка «specified upload does not exist», которая возникает, когда исходное исключение теряется при многокомпонентной загрузке из-за состояния гонки. [#86725](https://github.com/ClickHouse/ClickHouse/pull/86725) ([Julia Kartseva](https://github.com/jkartseva)).
* Ограничено описание плана запроса в запросе `EXPLAIN`. Описание больше не вычисляется для запросов, отличных от `EXPLAIN`. Добавлена настройка `query_plan_max_step_description_length`. [#86741](https://github.com/ClickHouse/ClickHouse/pull/86741) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлена возможность настраивать очередь ожидающих сигналов, чтобы избежать ошибок `CANNOT_CREATE_TIMER` (для профилировщиков запросов, `query_profiler_real_time_period_ns`/`query_profiler_cpu_time_period_ns`). Также теперь собирается значение `SigQ` из `/proc/self/status` для интроспекции (если `ProcessSignalQueueSize` близко к `ProcessSignalQueueLimit`, то, скорее всего, будут возникать ошибки `CANNOT_CREATE_TIMER`). [#86760](https://github.com/ClickHouse/ClickHouse/pull/86760) ([Azat Khuzhin](https://github.com/azat)).
* Улучшена производительность запроса `RemoveRecursive` в Keeper. [#86789](https://github.com/ClickHouse/ClickHouse/pull/86789) ([Antonio Andelic](https://github.com/antonio2368)).
* Удалены лишние пробелы в `PrettyJSONEachRow` при выводе данных типа JSON. [#86819](https://github.com/ClickHouse/ClickHouse/pull/86819) ([Pavel Kruglov](https://github.com/Avogar)).
* Теперь при удалении директории на обычном перезаписываемом диске мы записываем размеры блобов для `prefix.path`. [#86908](https://github.com/ClickHouse/ClickHouse/pull/86908) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка тестов производительности для удалённых экземпляров ClickHouse, включая ClickHouse Cloud. Пример использования: `tests/performance/scripts/perf.py tests/performance/math.xml --runs 10 --user <username> --password <password> --host <hostname> --port <port> --secure`. [#86995](https://github.com/ClickHouse/ClickHouse/pull/86995) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Соблюдать лимиты по памяти в ряде мест, где известно, что выделяется значительный объём памяти (&gt;16MiB) (сортировка, асинхронные вставки, `file log`). [#87035](https://github.com/ClickHouse/ClickHouse/pull/87035) ([Azat Khuzhin](https://github.com/azat)).
* Теперь выбрасывается исключение, если параметр `network_compression_method` установлен в неподдерживаемый универсальный кодек. [#87097](https://github.com/ClickHouse/ClickHouse/pull/87097) ([Robert Schulze](https://github.com/rschu1ze)).
* Системная таблица `system.query_cache` теперь возвращает *все* записи кэша результатов запросов, тогда как ранее она возвращала только общие записи или необщие записи того же пользователя и роли. Это приемлемо, поскольку необщие записи не должны раскрывать *результаты запросов*, тогда как `system.query_cache` возвращает *строки запросов*. Это делает поведение системной таблицы более похожим на `system.query_log`. [#87104](https://github.com/ClickHouse/ClickHouse/pull/87104) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка короткой (short-circuit) схемы вычисления для функции `parseDateTime`. [#87184](https://github.com/ClickHouse/ClickHouse/pull/87184) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлен новый столбец `statistics` в таблицу `system.parts_columns`. [#87259](https://github.com/ClickHouse/ClickHouse/pull/87259) ([Han Fei](https://github.com/hanfei1991)).





#### Исправление ошибки (некорректное поведение, видимое пользователю, в официальном стабильном релизе)

* Результаты запросов `ALTER` теперь проверяются только на узле-инициаторе для реплицируемых баз данных и внутренне реплицируемых таблиц. Это решает ситуации, когда уже зафиксированный запрос `ALTER` мог застревать на других узлах. [#83849](https://github.com/ClickHouse/ClickHouse/pull/83849) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Ограничивает количество задач каждого типа в `BackgroundSchedulePool`. Избегает ситуаций, когда все слоты заняты задачами одного типа, а задачи других типов простаивают. Также предотвращает взаимоблокировки, когда задачи ожидают друг друга. Этим управляет серверная настройка `background_schedule_pool_max_parallel_tasks_per_type_ratio`. [#84008](https://github.com/ClickHouse/ClickHouse/pull/84008) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Корректное завершение работы таблиц при восстановлении реплики базы данных. Некорректное завершение могло приводить к LOGICAL&#95;ERROR для некоторых движков таблиц во время восстановления реплики базы данных. [#84744](https://github.com/ClickHouse/ClickHouse/pull/84744) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена проверка прав доступа при генерации подсказок по исправлению опечаток в имени базы данных. [#85371](https://github.com/ClickHouse/ClickHouse/pull/85371) ([Dmitry Novik](https://github.com/novikd)).
* 1. LowCardinality для столбцов Hive 2. Заполнять столбцы Hive перед виртуальными столбцами (требуется для [https://github.com/ClickHouse/ClickHouse/pull/81040](https://github.com/ClickHouse/ClickHouse/pull/81040)) 3. LOGICAL&#95;ERROR при пустом формате для Hive [#85528](https://github.com/ClickHouse/ClickHouse/issues/85528) 4. Исправлена проверка того, что столбцы партиций Hive являются единственными столбцами 5. Проверять, что все столбцы Hive указаны в схеме 6. Частичное исправление для parallel&#95;replicas&#95;cluster с Hive 7. Использовать упорядоченный контейнер в extractkeyValuePairs для утилит Hive (требуется для [https://github.com/ClickHouse/ClickHouse/pull/81040](https://github.com/ClickHouse/ClickHouse/pull/81040)). [#85538](https://github.com/ClickHouse/ClickHouse/pull/85538) ([Arthur Passos](https://github.com/arthurpassos)).
* Предотвращена избыточная оптимизация первого аргумента функций `IN`, которая иногда приводила к ошибке при использовании маппинга массивов. [#85546](https://github.com/ClickHouse/ClickHouse/pull/85546) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Отображение между идентификаторами источников Iceberg и именами Parquet не было приведено в соответствие со схемой при записи файла Parquet. В этом PR обрабатывается схема, релевантная для каждого файла данных Iceberg, а не текущая. [#85829](https://github.com/ClickHouse/ClickHouse/pull/85829) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлено чтение размера файла отдельно от его открытия. Связано с [https://github.com/ClickHouse/ClickHouse/pull/33372](https://github.com/ClickHouse/ClickHouse/pull/33372), который был внесён в ответ на ошибку в ядрах Linux до релиза версии `5.10`. [#85837](https://github.com/ClickHouse/ClickHouse/pull/85837) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* ClickHouse Keeper больше не завершается с ошибкой при запуске на системах, где IPv6 отключён на уровне ядра (например, RHEL с ipv6.disable=1). Теперь он пытается переключиться на IPv4‑слушатель, если не удаётся запустить первоначальный IPv6‑слушатель. [#85901](https://github.com/ClickHouse/ClickHouse/pull/85901) ([jskong1124](https://github.com/jskong1124)).
* Этот PR закрывает [#77990](https://github.com/ClickHouse/ClickHouse/issues/77990). Добавлена поддержка TableFunctionRemote для параллельных реплик в globalJoin. [#85929](https://github.com/ClickHouse/ClickHouse/pull/85929) ([zoomxi](https://github.com/zoomxi)).
* Исправлена ошибка разыменования нулевого указателя в orcschemareader::initializeifneeded(). Этот PR решает следующую проблему: [#85292](https://github.com/ClickHouse/ClickHouse/issues/85292) ### Запись в документации об изменениях, видимых пользователю. [#85951](https://github.com/ClickHouse/ClickHouse/pull/85951) ([yanglongwei](https://github.com/ylw510)).
* Добавлена проверка, которая разрешает коррелированные подзапросы в предложении FROM только в том случае, если они используют столбцы из внешнего запроса. Исправлены [#85469](https://github.com/ClickHouse/ClickHouse/issues/85469) и [#85402](https://github.com/ClickHouse/ClickHouse/issues/85402). [#85966](https://github.com/ClickHouse/ClickHouse/pull/85966) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена операция `ALTER UPDATE` над столбцом, подстолбец которого используется в материализованном выражении другого столбца. Ранее материализованный столбец, в выражении которого использовался подстолбец, обновлялся некорректно. [#85985](https://github.com/ClickHouse/ClickHouse/pull/85985) ([Pavel Kruglov](https://github.com/Avogar)).
* Запрещено изменять столбцы, подстолбцы которых используются в выражении первичного ключа или партиционирования. [#86005](https://github.com/ClickHouse/ClickHouse/pull/86005) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено чтение подстолбцов при использовании нестандартного режима сопоставления столбцов в хранилище DeltaLake. [#86064](https://github.com/ClickHouse/ClickHouse/pull/86064) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка использования неверных значений по умолчанию для пути с подсказкой Enum в JSON. [#86065](https://github.com/ClickHouse/ClickHouse/pull/86065) ([Pavel Kruglov](https://github.com/Avogar)).
* Разбор URL-адреса каталога Hive в DataLake с санитизацией входных данных. Закрывает [#86018](https://github.com/ClickHouse/ClickHouse/issues/86018). [#86092](https://github.com/ClickHouse/ClickHouse/pull/86092) ([rajat mohan](https://github.com/rajatmohan22)).
* Исправлена логическая ошибка при динамическом изменении размера кэша файловой системы. Закрывает [#86122](https://github.com/ClickHouse/ClickHouse/issues/86122). Закрывает [https://github.com/ClickHouse/clickhouse-core-incidents/issues/473](https://github.com/ClickHouse/clickhouse-core-incidents/issues/473). [#86130](https://github.com/ClickHouse/ClickHouse/pull/86130) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Используйте тип `NonZeroUInt64` для параметра `logs_to_keep` в настройках DatabaseReplicatedSettings. [#86142](https://github.com/ClickHouse/ClickHouse/pull/86142) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исключение возникало при выполнении запроса с `FINAL` и пропускающим индексом, если таблица (например, `ReplacingMergeTree`) была создана с настройкой `index_granularity_bytes = 0`. Это исключение теперь устранено. [#86147](https://github.com/ClickHouse/ClickHouse/pull/86147) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Устраняет неопределённое поведение (UB) и исправляет проблемы с разбором выражения секционирования в Iceberg. [#86166](https://github.com/ClickHouse/ClickHouse/pull/86166) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлена ошибка, приводившая к падению при использовании const и non-const блоков в одном INSERT. [#86230](https://github.com/ClickHouse/ClickHouse/pull/86230) ([Azat Khuzhin](https://github.com/azat)).
* По умолчанию процесс при создании дисков из SQL подключает конфигурацию из `/etc/metrika.xml`. [#86232](https://github.com/ClickHouse/ClickHouse/pull/86232) ([alekar](https://github.com/alekar)).
* Исправлена работа accurateCastOrNull/accurateCastOrDefault при преобразовании значений типа String в JSON. [#86240](https://github.com/ClickHouse/ClickHouse/pull/86240) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена поддержка каталогов без &#39;/&#39; в движке Iceberg. [#86249](https://github.com/ClickHouse/ClickHouse/pull/86249) ([scanhex12](https://github.com/scanhex12)).
* Исправлена ошибка, вызывавшая сбой при использовании replaceRegex с haystack типа FixedString и пустой needle. [#86270](https://github.com/ClickHouse/ClickHouse/pull/86270) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлен сбой при ALTER UPDATE Nullable(JSON). [#86281](https://github.com/ClickHouse/ClickHouse/pull/86281) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено отсутствие столбца `definer` в `system.tables`. [#86295](https://github.com/ClickHouse/ClickHouse/pull/86295) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено преобразование типа из LowCardinality(Nullable(T)) в Dynamic. [#86365](https://github.com/ClickHouse/ClickHouse/pull/86365) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена логическая ошибка при записи в Delta Lake. Закрывает [#86175](https://github.com/ClickHouse/ClickHouse/issues/86175). [#86367](https://github.com/ClickHouse/ClickHouse/pull/86367) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка `416 The range specified is invalid for the current size of the resource. The range specified is invalid for the current size of the resource` при чтении пустых BLOB-объектов из Azure Blob Storage для диска plain&#95;rewritable. [#86400](https://github.com/ClickHouse/ClickHouse/pull/86400) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлена работа GROUP BY с Nullable(JSON). [#86410](https://github.com/ClickHouse/ClickHouse/pull/86410) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка в материализованных представлениях: материализованное представление (MV) могло не работать, если оно было создано, удалено, а затем снова создано с тем же именем. [#86413](https://github.com/ClickHouse/ClickHouse/pull/86413) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Выдавать ошибку, если все реплики недоступны при чтении из функций *cluster. [#86414](https://github.com/ClickHouse/ClickHouse/pull/86414) ([Julian Maicher](https://github.com/jmaicher)).
* Исправлена утечка памяти в `MergesMutationsMemoryTracking`, возникавшая из-за таблиц `Buffer`, и исправлен `query_views_log` для потоковой обработки данных из `Kafka` (и других источников). [#86422](https://github.com/ClickHouse/ClickHouse/pull/86422) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа SHOW TABLES после удаления таблицы, на которую ссылается хранилище alias. [#86433](https://github.com/ClickHouse/ClickHouse/pull/86433) ([RinChanNOW](https://github.com/RinChanNOWWW)).
* Исправлено отсутствие заголовка чанка при включённом `send_chunk_header` и вызове UDF по протоколу HTTP. [#86469](https://github.com/ClickHouse/ClickHouse/pull/86469) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлена возможная взаимоблокировка при включённом сбросе профилей jemalloc. [#86473](https://github.com/ClickHouse/ClickHouse/pull/86473) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено чтение подколонок в движке таблицы DeltaLake. Закрывает [#86204](https://github.com/ClickHouse/ClickHouse/issues/86204). [#86477](https://github.com/ClickHouse/ClickHouse/pull/86477) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Корректная обработка идентификатора loopback-хоста для предотвращения коллизий при обработке DDL-задач. [#86479](https://github.com/ClickHouse/ClickHouse/pull/86479) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлены операции detach/attach для таблиц движка базы данных PostgreSQL со столбцами числовых типов NUMERIC/DECIMAL. [#86480](https://github.com/ClickHouse/ClickHouse/pull/86480) ([Julian Maicher](https://github.com/jmaicher)).
* Исправлено обращение к неинициализированной памяти в getSubcolumnType. [#86498](https://github.com/ClickHouse/ClickHouse/pull/86498) ([Raúl Marín](https://github.com/Algunenano)).
* Функции `searchAny` и `searchAll` при вызове с пустыми шаблонами теперь возвращают `true` (т.е. &quot;совпадает с любым значением&quot;). Ранее они возвращали `false`. (issue [#86300](https://github.com/ClickHouse/ClickHouse/issues/86300)). [#86500](https://github.com/ClickHouse/ClickHouse/pull/86500) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Исправлена ошибка в функции `timeSeriesResampleToGridWithStaleness()` для случая, когда в первом интервале нет значения. [#86507](https://github.com/ClickHouse/ClickHouse/pull/86507) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен сбой, возникающий при установке параметра `merge_tree_min_read_task_size` равным 0. [#86527](https://github.com/ClickHouse/ClickHouse/pull/86527) ([yanglongwei](https://github.com/ylw510)).
* При чтении формат каждого файла данных теперь берётся из метаданных Iceberg (ранее — из аргументов таблицы). [#86529](https://github.com/ClickHouse/ClickHouse/pull/86529) ([Daniil Ivanik](https://github.com/divanik)).
* Игнорировать исключения при сбросе лога во время завершения работы и сделать процесс завершения более безопасным (чтобы избежать SIGSEGV). [#86546](https://github.com/ClickHouse/ClickHouse/pull/86546) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен движок базы данных Backup, из-за которого при запросе с файловыми частями нулевого размера возникало исключение. [#86563](https://github.com/ClickHouse/ClickHouse/pull/86563) ([Max Justus Spransy](https://github.com/maxjustus)).
* Исправлено отсутствие заголовка чанка при включённом `send_chunk_header` и вызове UDF по протоколу HTTP. [#86606](https://github.com/ClickHouse/ClickHouse/pull/86606) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлена логическая ошибка в S3Queue &quot;Expected current processor {} to be equal to {}&quot;, возникавшая из-за истечения сессии Keeper. [#86615](https://github.com/ClickHouse/ClickHouse/pull/86615) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Ошибки обработки NULL при вставке и отсечении данных. Это закрывает [#86407](https://github.com/ClickHouse/ClickHouse/issues/86407). [#86630](https://github.com/ClickHouse/ClickHouse/pull/86630) ([scanhex12](https://github.com/scanhex12)).
* Не отключайте кэш файловой системы, если кэш метаданных Iceberg отключён. [#86635](https://github.com/ClickHouse/ClickHouse/pull/86635) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлена ошибка &#39;Deadlock in Parquet::ReadManager (single-threaded)&#39; в считывателе Parquet v3. [#86644](https://github.com/ClickHouse/ClickHouse/pull/86644) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена работа IPv6 в параметре `listen_host` для ArrowFlight. [#86664](https://github.com/ClickHouse/ClickHouse/pull/86664) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено завершение работы обработчика `ArrowFlight`. Этот PR исправляет [#86596](https://github.com/ClickHouse/ClickHouse/issues/86596). [#86665](https://github.com/ClickHouse/ClickHouse/pull/86665) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена работа распределённых запросов при `describe_compact_output=1`. [#86676](https://github.com/ClickHouse/ClickHouse/pull/86676) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены ошибки в разборе определений окон и применении параметров запроса. [#86720](https://github.com/ClickHouse/ClickHouse/pull/86720) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, приводившая к исключению `Partition strategy wildcard can not be used without a '_partition_id' wildcard.` при создании таблицы с `PARTITION BY`, но без подстановочного символа партиции, что в версиях до 25.8 работало. Закрывает [https://github.com/ClickHouse/clickhouse-private/issues/37567](https://github.com/ClickHouse/clickhouse-private/issues/37567). [#86748](https://github.com/ClickHouse/ClickHouse/pull/86748) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка LogicalError, возникавшая, когда параллельные запросы пытались получить одну и ту же блокировку. [#86751](https://github.com/ClickHouse/ClickHouse/pull/86751) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлена запись значения NULL в общие данные JSON во входном формате RowBinary и добавлены дополнительные проверки в ColumnObject. [#86812](https://github.com/ClickHouse/ClickHouse/pull/86812) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена обработка пустой перестановки Tuple при использовании LIMIT. [#86828](https://github.com/ClickHouse/ClickHouse/pull/86828) ([Pavel Kruglov](https://github.com/Avogar)).
* Не использовать отдельный узел Keeper для узлов persistent processing. Исправление для [https://github.com/ClickHouse/ClickHouse/pull/85995](https://github.com/ClickHouse/ClickHouse/pull/85995). Закрывает [#86406](https://github.com/ClickHouse/ClickHouse/issues/86406). [#86841](https://github.com/ClickHouse/ClickHouse/pull/86841) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проблема, из-за которой таблица с движком TimeSeries мешала созданию новой реплики в реплицируемой базе данных. [#86845](https://github.com/ClickHouse/ClickHouse/pull/86845) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена обработка запросов к `system.distributed_ddl_queue` в случаях, когда у задач отсутствуют некоторые узлы Keeper. [#86848](https://github.com/ClickHouse/ClickHouse/pull/86848) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено позиционирование в конце распакованного блока. [#86906](https://github.com/ClickHouse/ClickHouse/pull/86906) ([Pavel Kruglov](https://github.com/Avogar)).
* Обработано исключение, выбрасываемое во время асинхронного выполнения итератора Iceberg. [#86932](https://github.com/ClickHouse/ClickHouse/pull/86932) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлено сохранение больших предварительно обработанных XML-конфигураций. [#86934](https://github.com/ClickHouse/ClickHouse/pull/86934) ([c-end](https://github.com/c-end)).
* Исправлено заполнение поля даты в таблице system.iceberg&#95;metadata&#95;log. [#86961](https://github.com/ClickHouse/ClickHouse/pull/86961) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлен бесконечный пересчёт `TTL` с условием `WHERE`. [#86965](https://github.com/ClickHouse/ClickHouse/pull/86965) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен возможный некорректный результат работы функции `uniqExact` при использовании модификаторов `ROLLUP` и `CUBE`. [#87014](https://github.com/ClickHouse/ClickHouse/pull/87014) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлено определение схемы таблицы табличной функцией `url()` при значении настройки `parallel_replicas_for_cluster_functions`, равном 1. [#87029](https://github.com/ClickHouse/ClickHouse/pull/87029) ([Konstantин Bogdanov](https://github.com/thevar1able)).
* Корректно приводить результат `PREWHERE` к нужному типу после разбиения его на несколько шагов. [#87040](https://github.com/ClickHouse/ClickHouse/pull/87040) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлены легковесные обновления с конструкцией `ON CLUSTER`. [#87043](https://github.com/ClickHouse/ClickHouse/pull/87043) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена работа некоторых состояний агрегатных функций с аргументом типа String. [#87049](https://github.com/ClickHouse/ClickHouse/pull/87049) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка, из-за которой имя модели OpenAI не передавалось. [#87100](https://github.com/ClickHouse/ClickHouse/pull/87100) ([Kaushik Iska](https://github.com/iskakaushik)).
* EmbeddedRocksDB: путь должен находиться внутри user&#95;files. [#87109](https://github.com/ClickHouse/ClickHouse/pull/87109) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена проблема с таблицами KeeperMap, созданными до 25.1, которые оставляли данные в ZooKeeper после выполнения запроса DROP. [#87112](https://github.com/ClickHouse/ClickHouse/pull/87112) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлено некорректное чтение идентификаторов полей карт и массивов из Parquet. [#87136](https://github.com/ClickHouse/ClickHouse/pull/87136) ([scanhex12](https://github.com/scanhex12)).
* Исправлена ошибка чтения массива с подстолбцом размеров массива при отложенной материализации. [#87139](https://github.com/ClickHouse/ClickHouse/pull/87139) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена работа функции CASE с аргументами типа Dynamic. [#87177](https://github.com/ClickHouse/ClickHouse/pull/87177) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка чтения пустого массива из пустой строки в CSV. [#87182](https://github.com/ClickHouse/ClickHouse/pull/87182) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен возможный неверный результат для некоррелированного `EXISTS`. Ошибка возникала при `execute_exists_as_scalar_subquery=1`, которая была добавлена в [https://github.com/ClickHouse/ClickHouse/pull/85481](https://github.com/ClickHouse/ClickHouse/pull/85481) и затрагивает версию `25.8`. Исправляет [#86415](https://github.com/ClickHouse/ClickHouse/issues/86415). [#87207](https://github.com/ClickHouse/ClickHouse/pull/87207) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Вызывает ошибку, если iceberg&#95;metadata&#95;log не настроен, а пользователь пытается получить отладочную информацию о метаданных Iceberg. Исправляет обращение к nullptr. [#87250](https://github.com/ClickHouse/ClickHouse/pull/87250) ([Daniil Ivanik](https://github.com/divanik)).

#### Улучшения сборки/тестирования/упаковки

- Исправлена совместимость с abseil-cpp 20250814.0, https://github.com/abseil/abseil-cpp/issues/1923. [#85970](https://github.com/ClickHouse/ClickHouse/pull/85970) ([Yuriy Chernyshov](https://github.com/georgthegreat)).
- Сборка автономного WASM-лексера помещена под флаг. [#86505](https://github.com/ClickHouse/ClickHouse/pull/86505) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Исправлена сборка crc32c на старых ARM-процессорах без поддержки инструкции `vmull_p64`. [#86521](https://github.com/ClickHouse/ClickHouse/pull/86521) ([Pablo Marcos](https://github.com/pamarcos)).
- Используется `openldap` 2.6.10. [#86623](https://github.com/ClickHouse/ClickHouse/pull/86623) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Отключен перехват `memalign` на darwin. [#86769](https://github.com/ClickHouse/ClickHouse/pull/86769) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Используется `krb5` 1.22.1-final. [#86836](https://github.com/ClickHouse/ClickHouse/pull/86836) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Исправлена распаковка имен Rust-крейтов в `list-licenses.sh`. [#87305](https://github.com/ClickHouse/ClickHouse/pull/87305) ([Konstantin Bogdanov](https://github.com/thevar1able)).

### Релиз ClickHouse 25.8 LTS, 2025-08-28 {#258}


#### Обратно несовместимые изменения
* Выводить `Array(Dynamic)` вместо безымянного `Tuple` для массивов значений с разными типами в JSON. Чтобы использовать прежнее поведение, отключите настройку `input_format_json_infer_array_of_dynamic_from_array_of_different_types`. [#80859](https://github.com/ClickHouse/ClickHouse/pull/80859) ([Pavel Kruglov](https://github.com/Avogar)).
* Перенести метрики задержки S3 в гистограммы для однородности и упрощения. [#82305](https://github.com/ClickHouse/ClickHouse/pull/82305) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Требовать обратные кавычки вокруг идентификаторов с точками в выражениях по умолчанию (DEFAULT), чтобы предотвратить их разбор как составных идентификаторов. [#83162](https://github.com/ClickHouse/ClickHouse/pull/83162) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Ленивая материализация включена только с analyzer (это значение по умолчанию), чтобы избежать сопровождения режима без analyzer, который, по нашему опыту, имеет некоторые проблемы (например, при использовании `indexHint()` в условиях). [#83791](https://github.com/ClickHouse/ClickHouse/pull/83791) ([Igor Nikonov](https://github.com/devcrafter)).
* По умолчанию записывать значения типа `Enum` как `BYTE_ARRAY` с логическим типом `ENUM` в формате вывода Parquet. [#84169](https://github.com/ClickHouse/ClickHouse/pull/84169) ([Pavel Kruglov](https://github.com/Avogar)).
* Включить настройку MergeTree `write_marks_for_substreams_in_compact_parts` по умолчанию. Это существенно улучшает производительность чтения подколонок из вновь созданных Compact-частей. Серверы с версией ниже 25.5 не смогут читать новые Compact-части. [#84171](https://github.com/ClickHouse/ClickHouse/pull/84171) ([Pavel Kruglov](https://github.com/Avogar)).
* Предыдущее значение по умолчанию для `concurrent_threads_scheduler` было `round_robin`, которое оказалось несправедливым при большом количестве однопоточных запросов (например, INSERT). Это изменение делает более безопасный планировщик `fair_round_robin` значением по умолчанию. [#84747](https://github.com/ClickHouse/ClickHouse/pull/84747) ([Sergei Trifonov](https://github.com/serxa)).
* ClickHouse поддерживает синтаксис heredoc в стиле PostgreSQL: `$tag$ string contents... $tag$`, также известный как строковые литералы с долларовым кавычкованием. В предыдущих версиях существовало меньше ограничений на теги: они могли содержать произвольные символы, включая знаки препинания и пробелы. Это приводит к неоднозначности разбора с идентификаторами, которые также могут начинаться с символа доллара. В то же время PostgreSQL разрешает использовать в тегах только буквенно-цифровые символы и подчёркивание. Для решения проблемы мы теперь в тегах heredoc разрешаем только буквенно-цифровые символы и подчёркивание. Закрывает [#84731](https://github.com/ClickHouse/ClickHouse/issues/84731). [#84846](https://github.com/ClickHouse/ClickHouse/pull/84846) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Функции `azureBlobStorage`, `deltaLakeAzure` и `icebergAzure` были обновлены для корректной проверки прав `AZURE`. Все кластерные варианты функций (функции с суффиксом `-Cluster`) теперь проверяют права относительно соответствующих некластерных вариантов. Кроме того, функции `icebergLocal` и `deltaLakeLocal` теперь принудительно выполняют проверки прав `FILE`. [#84938](https://github.com/ClickHouse/ClickHouse/pull/84938) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Включить настройку `allow_dynamic_metadata_for_data_lakes` (настройка уровня движка таблицы) по умолчанию. [#85044](https://github.com/ClickHouse/ClickHouse/pull/85044) ([Daniil Ivanik](https://github.com/divanik)).
* Отключить заключение 64-битных целых чисел в кавычки в форматах JSON по умолчанию. [#74079](https://github.com/ClickHouse/ClickHouse/pull/74079) ([Pavel Kruglov](https://github.com/Avogar))



#### Новая функция

* Добавлена базовая поддержка диалекта PromQL. Чтобы использовать его, укажите `dialect='promql'` в clickhouse-client, задайте таблицу TimeSeries с помощью параметра `promql_table_name='X'` и выполняйте запросы вида `rate(ClickHouseProfileEvents_ReadCompressedBytes[1m])[5m:1m]`. Также можно обернуть запрос PromQL в SQL: `SELECT * FROM prometheusQuery('up', ...);`. На данный момент поддерживаются только функции `rate`, `delta` и `increase`. Унарные и бинарные операторы не поддерживаются. HTTP API отсутствует. [#75036](https://github.com/ClickHouse/ClickHouse/pull/75036) ([Vitaly Baranov](https://github.com/vitlibar)).
* Генерация SQL на базе ИИ теперь может, при наличии, автоматически считывать значения переменных окружения ANTHROPIC&#95;API&#95;KEY и OPENAI&#95;API&#95;KEY, что позволяет использовать эту функцию без какой-либо предварительной настройки. [#83787](https://github.com/ClickHouse/ClickHouse/pull/83787) ([Kaushик Iska](https://github.com/iskakaushik)).
* Реализована поддержка протокола [ArrowFlight RPC](https://arrow.apache.org/docs/format/Flight.html) путём добавления: - новой табличной функции `arrowflight`. [#74184](https://github.com/ClickHouse/ClickHouse/pull/74184) ([zakr600](https://github.com/zakr600)).
* Теперь все таблицы поддерживают виртуальный столбец `_table` (не только таблицы с движком `Merge`), что особенно полезно для запросов с UNION ALL. [#63665](https://github.com/ClickHouse/ClickHouse/pull/63665) ([Xiaozhe Yu](https://github.com/wudidapaopao)).
* Разрешено использовать любую политику хранения (например, объектное хранилище, такое как S3) для внешней агрегации и сортировки. [#84734](https://github.com/ClickHouse/ClickHouse/pull/84734) ([Azat Khuzhin](https://github.com/azat)).
* Реализована аутентификация AWS S3 с явно указанной ролью IAM. Реализован OAuth для GCS. Ранее эти возможности были доступны только в ClickHouse Cloud, а теперь открыты с исходным кодом. Синхронизированы некоторые интерфейсы, например сериализация параметров подключения для объектных хранилищ. [#84011](https://github.com/ClickHouse/ClickHouse/pull/84011) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка позиционных удалений для Iceberg TableEngine. [#83094](https://github.com/ClickHouse/ClickHouse/pull/83094) ([Daniil Ivanik](https://github.com/divanik)).
* Добавлена поддержка Equality Deletes в Iceberg. [#85843](https://github.com/ClickHouse/ClickHouse/pull/85843) ([Han Fei](https://github.com/hanfei1991)).
* Поддержка записи Iceberg при CREATE. Закрывает [#83927](https://github.com/ClickHouse/ClickHouse/issues/83927). [#83983](https://github.com/ClickHouse/ClickHouse/pull/83983) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Каталоги Glue для записи данных. [#84136](https://github.com/ClickHouse/ClickHouse/pull/84136) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Каталоги Iceberg REST для операций записи. [#84684](https://github.com/ClickHouse/ClickHouse/pull/84684) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Все файлы позиционных удалений Iceberg объединяются с файлами данных. Это уменьшает количество и размеры файлов Parquet в хранилище Iceberg. Синтаксис: `OPTIMIZE TABLE table_name`. [#85250](https://github.com/ClickHouse/ClickHouse/pull/85250) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Поддержка оператора `DROP TABLE` для Iceberg (удаление записей из каталогов REST/Glue и метаданных о таблице). [#85395](https://github.com/ClickHouse/ClickHouse/pull/85395) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Реализована поддержка мутаций ALTER DELETE для таблиц Iceberg в формате merge-on-read. [#85549](https://github.com/ClickHouse/ClickHouse/pull/85549) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Добавлена поддержка записи в DeltaLake. Закрывает [#79603](https://github.com/ClickHouse/ClickHouse/issues/79603). [#85564](https://github.com/ClickHouse/ClickHouse/pull/85564) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена настройка `delta_lake_snapshot_version` для чтения определённой версии снимка в движке таблиц `DeltaLake`. [#85295](https://github.com/ClickHouse/ClickHouse/pull/85295) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Записывать более подробную статистику Iceberg (размеры столбцов, нижние и верхние границы) в метаданные (записи манифеста) для min-max-прунинга. [#85746](https://github.com/ClickHouse/ClickHouse/pull/85746) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Добавлена поддержка операций добавления/удаления/изменения столбцов в Iceberg для простых типов. [#85769](https://github.com/ClickHouse/ClickHouse/pull/85769) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Iceberg: реализована поддержка записи файла version-hint. Это закрывает [#85097](https://github.com/ClickHouse/ClickHouse/issues/85097). [#85130](https://github.com/ClickHouse/ClickHouse/pull/85130) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Представления, созданные эфемерными пользователями, теперь будут хранить копию самого пользователя и больше не будут становиться недействительными после удаления эфемерного пользователя. [#84763](https://github.com/ClickHouse/ClickHouse/pull/84763) ([pufit](https://github.com/pufit)).
* Индекс векторного сходства теперь поддерживает бинарную квантизацию. Бинарная квантизация значительно снижает расход памяти и ускоряет процесс построения векторного индекса (за счет более быстрого вычисления расстояний). Также существующий параметр `vector_search_postfilter_multiplier` был объявлен устаревшим и заменен более общим параметром: `vector_search_index_fetch_multiplier`. [#85024](https://github.com/ClickHouse/ClickHouse/pull/85024) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Разрешено использовать аргументы вида ключ-значение в движке/функции таблицы `s3` или `s3Cluster`, например: `s3('url', CSV, structure = 'a Int32', compression_method = 'gzip')`. [#85134](https://github.com/ClickHouse/ClickHouse/pull/85134) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Новая системная таблица для хранения входящих сообщений с ошибками из движков, например Kafka (&quot;dead letter queue&quot;). [#68873](https://github.com/ClickHouse/ClickHouse/pull/68873) ([Ilya Golshtein](https://github.com/ilejn)).
* Новая команда SYSTEM RESTORE DATABASE REPLICA для реплицируемых баз данных; она аналогична существующей функции восстановления в ReplicatedMergeTree. [#73100](https://github.com/ClickHouse/ClickHouse/pull/73100) ([Konstantин Morozov](https://github.com/k-morozov)).
* Протокол PostgreSQL теперь поддерживает команду `COPY`. [#74344](https://github.com/ClickHouse/ClickHouse/pull/74344) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Реализована поддержка C#‑клиента для протокола MySQL. Это закрывает [#83992](https://github.com/ClickHouse/ClickHouse/issues/83992). [#84397](https://github.com/ClickHouse/ClickHouse/pull/84397) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Добавлена поддержка чтения и записи в стиле секционирования таблиц Hive. [#76802](https://github.com/ClickHouse/ClickHouse/pull/76802) ([Arthur Passos](https://github.com/arthurpassos)).
* Добавлена системная таблица `zookeeper_connection_log` для хранения истории подключений к ZooKeeper. [#79494](https://github.com/ClickHouse/ClickHouse/pull/79494) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Серверная настройка `cpu_slot_preemption` включает вытесняющее планирование CPU для рабочих нагрузок и обеспечивает справедливое по принципу max-min распределение процессорного времени между ними. Добавлены новые настройки рабочих нагрузок для ограничения использования CPU: `max_cpus`, `max_cpu_share` и `max_burst_cpu_seconds`. Подробнее: [https://clickhouse.com/docs/operations/workload-scheduling#cpu&#95;scheduling](https://clickhouse.com/docs/operations/workload-scheduling#cpu_scheduling). [#80879](https://github.com/ClickHouse/ClickHouse/pull/80879) ([Sergei Trifonov](https://github.com/serxa)).
* Разрывает TCP-соединение после заданного числа запросов или по достижении заданного временного порога. Это позволяет более равномерно распределять соединения между узлами кластера за балансировщиком нагрузки. Исправляет [#68000](https://github.com/ClickHouse/ClickHouse/issues/68000). [#81472](https://github.com/ClickHouse/ClickHouse/pull/81472) ([Kenny Sun](https://github.com/hwabis)).
* Параллельные реплики теперь поддерживают использование проекций в запросах. [#82659](https://github.com/ClickHouse/ClickHouse/issues/82659). [#82807](https://github.com/ClickHouse/ClickHouse/pull/82807) ([zoomxi](https://github.com/zoomxi)).
* Добавлена поддержка синтаксиса DESCRIBE SELECT в дополнение к DESCRIBE (SELECT ...). [#82947](https://github.com/ClickHouse/ClickHouse/pull/82947) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Обязательное использование защищённого соединения для mysql&#95;port и postgresql&#95;port. [#82962](https://github.com/ClickHouse/ClickHouse/pull/82962) ([tiandiwonder](https://github.com/tiandiwonder)).
* Теперь пользователи могут выполнять поиск по JSON-ключам без учёта регистра с помощью `JSONExtractCaseInsensitive` (и других вариантов `JSONExtract`). [#83770](https://github.com/ClickHouse/ClickHouse/pull/83770) ([Alistair Evans](https://github.com/alistairjevans)).
* Добавлена таблица `system.completions`. Закрывает [#81889](https://github.com/ClickHouse/ClickHouse/issues/81889). [#83833](https://github.com/ClickHouse/ClickHouse/pull/83833) ([|2ustam](https://github.com/RuS2m)).
* Добавлена новая функция `nowInBlock64`. Пример использования: `SELECT nowInBlock64(6)` возвращает `2025-07-29 17:09:37.775725`. [#84178](https://github.com/ClickHouse/ClickHouse/pull/84178) ([Halersson Paris](https://github.com/halersson)).
* Добавлена возможность указывать `extra_credentials` для `AzureBlobStorage` для аутентификации по `client_id` и `tenant_id`. [#84235](https://github.com/ClickHouse/ClickHouse/pull/84235) ([Pablo Marcos](https://github.com/pamarcos)).
* Добавлена функция `dateTimeToUUIDv7` для преобразования значения типа DateTime в UUIDv7. Пример использования: `SELECT dateTimeToUUIDv7(toDateTime('2025-08-15 18:57:56'))` возвращает `0198af18-8320-7a7d-abd3-358db23b9d5c`. [#84319](https://github.com/ClickHouse/ClickHouse/pull/84319) ([samradovich](https://github.com/samradovich)).
* Агрегатные функции `timeSeriesDerivToGrid` и `timeSeriesPredictLinearToGrid` повторно дискретизируют данные на временную сетку, определяемую заданными начальной меткой времени, конечной меткой времени и шагом, и соответственно вычисляют функции `deriv` и `predict_linear`, аналогичные PromQL. [#84328](https://github.com/ClickHouse/ClickHouse/pull/84328) ([Stephen Chi](https://github.com/stephchi0)).
* Добавлены две новые функции TimeSeries: - `timeSeriesRange(start_timestamp, end_timestamp, step)`, - `timeSeriesFromGrid(start_timestamp, end_timestamp, step, values)`. [#85435](https://github.com/ClickHouse/ClickHouse/pull/85435) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлен новый синтаксис `GRANT READ ON S3('s3://foo/.*') TO user`. [#84503](https://github.com/ClickHouse/ClickHouse/pull/84503) ([pufit](https://github.com/pufit)).
* Добавлен новый формат вывода `Hash`. Он вычисляет одно хэш-значение для всех столбцов и строк результата. Это полезно для вычисления «отпечатка» результата, например, в сценариях, когда узким местом является передача данных. Пример: `SELECT arrayJoin(['abc', 'def']), 42 FORMAT Hash` возвращает `e5f9e676db098fdb9530d2059d8c23ef`. [#84607](https://github.com/ClickHouse/ClickHouse/pull/84607) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена возможность устанавливать произвольные наблюдения в запросах Keeper Multi. [#84964](https://github.com/ClickHouse/ClickHouse/pull/84964) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Добавляет параметр `--max-concurrency` для инструмента `clickhouse-benchmark`, который включает режим с постепенным увеличением числа параллельных запросов. [#85623](https://github.com/ClickHouse/ClickHouse/pull/85623) ([Sergei Trifonov](https://github.com/serxa)).
* TODO: что это такое? Поддержка частично агрегированных метрик. [#85328](https://github.com/ClickHouse/ClickHouse/pull/85328) ([Mikhail Artemenko](https://github.com/Michicosun)).



#### Экспериментальные возможности
* Поддержка коррелированных подзапросов теперь включена по умолчанию, они больше не считаются экспериментальными. [#85107](https://github.com/ClickHouse/ClickHouse/pull/85107) ([Dmitry Novik](https://github.com/novikd)).
* Каталоги дата-лейка Unity, Glue, REST и Hive Metastore переведены из экспериментального статуса в статус бета-версии. [#85848](https://github.com/ClickHouse/ClickHouse/pull/85848) ([Melvyn Peignon](https://github.com/melvynator)).
* Лёгкие операции обновления и удаления (lightweight UPDATE и DELETE) переведены из экспериментального статуса в статус бета-версии.
* Приблизительный векторный поиск с индексами векторного сходства теперь доступен в статусе GA. [#85888](https://github.com/ClickHouse/ClickHouse/pull/85888) ([Robert Schulze](https://github.com/rschu1ze)).
* Движок таблицы и табличная функция Ytsaurus. [#77606](https://github.com/ClickHouse/ClickHouse/pull/77606) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Ранее данные текстового индекса разделялись на несколько сегментов (размер каждого сегмента по умолчанию составлял 256 MiB). Это могло снижать потребление памяти при построении текстового индекса, однако увеличивало требования к дисковому пространству и время выполнения запросов. [#84590](https://github.com/ClickHouse/ClickHouse/pull/84590) ([Elmi Ahmadov](https://github.com/ahmadov)).



#### Улучшение производительности

* Новая реализация паркетного ридера. В целом она быстрее и поддерживает проталкивание фильтров на уровне страниц и PREWHERE. В настоящее время является экспериментальной. Используйте настройку `input_format_parquet_use_native_reader_v3` для включения. [#82789](https://github.com/ClickHouse/ClickHouse/pull/82789) ([Michael Kolupaev](https://github.com/al13n321)).
* Официальный HTTP-транспорт в библиотеке Azure был заменён на нашу собственную реализацию HTTP-клиента для Azure Blob Storage. Добавлено множество настроек для этого клиента, которые соответствуют настройкам из S3. Введены агрессивные тайм-ауты соединения как для Azure, так и для S3. Улучшены средства анализа событий и метрик профиля Azure. Новый клиент включён по умолчанию и обеспечивает значительно меньшие задержки для холодных запросов на Azure Blob Storage. Старый клиент на базе `Curl` можно вернуть, установив `azure_sdk_use_native_client=false`. [#83294](https://github.com/ClickHouse/ClickHouse/pull/83294) ([alesapin](https://github.com/alesapin)). Предыдущая, официальная реализация клиента Azure была непригодна для продакшена из-за чудовищных всплесков задержек — от пяти секунд до нескольких минут. Мы отказались от этой реализации и очень этим гордимся.
* Обрабатывает индексы в порядке возрастания размера файла. Итоговый порядок индексов отдаёт приоритет minmax- и векторным индексам (в силу простоты и избирательности соответственно), а затем — небольшим индексам. Среди minmax- и векторных индексов также предпочитаются более компактные индексы. [#84094](https://github.com/ClickHouse/ClickHouse/pull/84094) ([Maruth Goyal](https://github.com/maruthgoyal)).
* Настройка MergeTree `write_marks_for_substreams_in_compact_parts` включена по умолчанию. Это значительно улучшает производительность чтения подстолбцов из вновь создаваемых Compact-частей. Серверы версии ниже 25.5 не смогут читать такие Compact-части. [#84171](https://github.com/ClickHouse/ClickHouse/pull/84171) ([Pavel Kruglov](https://github.com/Avogar)).
* Движок таблиц `azureBlobStorage`: кэширует и повторно использует токены аутентификации управляемого удостоверения, когда это возможно, чтобы избежать ограничения частоты запросов. [#79860](https://github.com/ClickHouse/ClickHouse/pull/79860) ([Nick Blakely](https://github.com/niblak)).
* `ALL` `LEFT/INNER` JOIN будут автоматически преобразованы в `RightAny`, если правая сторона функционально определяется по столбцам ключа соединения (все строки имеют уникальные значения ключа соединения). [#84010](https://github.com/ClickHouse/ClickHouse/pull/84010) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлен параметр `max_joined_block_size_bytes` в дополнение к `max_joined_block_size_rows` для ограничения использования памяти при JOIN с «тяжёлыми» столбцами. [#83869](https://github.com/ClickHouse/ClickHouse/pull/83869) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлена новая логика (управляется настройкой `enable_producing_buckets_out_of_order_in_aggregation`, по умолчанию включена), которая позволяет отправлять некоторые бакеты в произвольном порядке во время экономной по памяти агрегации. Когда слияние некоторых бакетов агрегации занимает значительно больше времени, чем других, это улучшает производительность, позволяя инициатору параллельно выполнять слияние бакетов с более высокими идентификаторами. Недостатком является потенциально более высокое потребление памяти (не должно быть значительным). [#80179](https://github.com/ClickHouse/ClickHouse/pull/80179) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлена настройка `optimize_rewrite_regexp_functions` (по умолчанию включена), которая позволяет оптимизатору преобразовывать некоторые вызовы `replaceRegexpAll`, `replaceRegexpOne` и `extract` в более простые и эффективные формы при обнаружении определённых шаблонов регулярных выражений (issue [#81981](https://github.com/ClickHouse/ClickHouse/issues/81981)). [#81992](https://github.com/ClickHouse/ClickHouse/pull/81992) ([Amos Bird](https://github.com/amosbird)).
* Обработка `max_joined_block_rows` вынесена за пределы основного цикла хеш‑JOIN. Незначительно улучшена производительность JOIN с ALL. [#83216](https://github.com/ClickHouse/ClickHouse/pull/83216) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Сначала обрабатывать min-max-индексы с более высокой гранулярностью. Закрывает [#75381](https://github.com/ClickHouse/ClickHouse/issues/75381). [#83798](https://github.com/ClickHouse/ClickHouse/pull/83798) ([Maruth Goyal](https://github.com/maruthgoyal)).
* Обеспечить линейное время выполнения оконных агрегатов с `DISTINCT` и исправить ошибку в `sumDistinct`. Закрывает [#79792](https://github.com/ClickHouse/ClickHouse/issues/79792). Закрывает [#52253](https://github.com/ClickHouse/ClickHouse/issues/52253). [#79859](https://github.com/ClickHouse/ClickHouse/pull/79859) ([Nihal Z. Miaji](https://github.com/nihalzp)).
* Запросы векторного поиска с использованием векторного индекса сходства выполняются с меньшей задержкой за счёт сокращения операций чтения из хранилища и снижения использования CPU. [#83803](https://github.com/ClickHouse/ClickHouse/pull/83803) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Rendezvous-хеширование для повышения локальности кэша при распределении нагрузки между параллельными репликами. [#82511](https://github.com/ClickHouse/ClickHouse/pull/82511) ([Anton Ivashkin](https://github.com/ianton-ru)).
* Реализована addManyDefaults для комбинаторов If, что ускоряет работу агрегатных функций с комбинаторами If. [#83870](https://github.com/ClickHouse/ClickHouse/pull/83870) ([Raúl Marín](https://github.com/Algunenano)).
* Вычислять сериализованный ключ поколоночно при группировке по нескольким строковым или числовым столбцам. [#83884](https://github.com/ClickHouse/ClickHouse/pull/83884) ([李扬](https://github.com/taiyang-li)).
* Исключено выполнение полного сканирования в случаях, когда анализ индекса даёт пустые диапазоны при параллельном чтении реплик. [#84971](https://github.com/ClickHouse/ClickHouse/pull/84971) ([Eduard Karacharov](https://github.com/korowa)).
* Попробуйте `-falign-functions=64`, чтобы сделать тесты производительности более стабильными. [#83920](https://github.com/ClickHouse/ClickHouse/pull/83920) ([Azat Khuzhin](https://github.com/azat)).
* Индекс блум-фильтра теперь используется для условий вида `has([c1, c2, ...], column)`, где `column` не относится к типу `Array`. Это повышает производительность таких запросов, делая их такими же эффективными, как оператор `IN`. [#83945](https://github.com/ClickHouse/ClickHouse/pull/83945) ([Doron David](https://github.com/dorki)).
* Уменьшено количество лишних вызовов memcpy в CompressedReadBufferBase::readCompressedData. [#83986](https://github.com/ClickHouse/ClickHouse/pull/83986) ([Raúl Marín](https://github.com/Algunenano)).
* Оптимизирован `largestTriangleThreeBuckets` за счёт удаления временных данных. [#84479](https://github.com/ClickHouse/ClickHouse/pull/84479) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Оптимизирована десериализация строк путём упрощения кода. Закрывает [#38564](https://github.com/ClickHouse/ClickHouse/issues/38564). [#84561](https://github.com/ClickHouse/ClickHouse/pull/84561) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлен расчет минимального размера задания для параллельных реплик. [#84752](https://github.com/ClickHouse/ClickHouse/pull/84752) ([Nikita Taranov](https://github.com/nickitat)).
* Улучшена производительность применения патч-частей в режиме `Join`. [#85040](https://github.com/ClickHouse/ClickHouse/pull/85040) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена обработка нулевого байта. Закрыта [#85062](https://github.com/ClickHouse/ClickHouse/issues/85062). Было исправлено несколько незначительных ошибок. Функции `structureToProtobufSchema`, `structureToCapnProtoSchema` неправильно помещали нуль-терминирующий байт и использовали символ перевода строки вместо него. Это приводило к отсутствию перевода строки в выводе и могло приводить к переполнению буфера при использовании других функций, зависящих от нулевого байта (таких, как `logTrace`, `demangle`, `extractURLParameter`, `toStringCutToZero` и `encrypt`/`decrypt`). Формат словаря `regexp_tree` не поддерживал обработку строк с нулевыми байтами. Функция `formatRowNoNewline`, вызываемая с форматом `Values` или с любым другим форматом без перевода строки в конце строк, ошибочно обрезала последний символ вывода. Функция `stem` содержала ошибку, нарушавшую гарантии безопасности при обработке исключений и в очень редком сценарии могшую привести к утечке памяти. Функция `initcap` работала неправильно для аргументов типа `FixedString`: она не распознавала начало слова в начале строки, если предыдущая строка в блоке заканчивалась на буквенно-цифровой символ. Исправлена уязвимость формата Apache `ORC`, которая могла приводить к раскрытию неинициализированной памяти. Изменено поведение функции `replaceRegexpAll` и соответствующего псевдонима `REGEXP_REPLACE`: теперь она может выполнять пустое совпадение в конце строки, даже если предыдущее совпадение обрабатывало всю строку, как в случае `^a*|a*$` или `^|.*` — это соответствует семантике JavaScript, Perl, Python, PHP, Ruby, но отличается от семантики PostgreSQL. Реализация многих функций была упрощена и оптимизирована. Документация для нескольких функций была некорректной и теперь исправлена. Имейте в виду, что вывод `byteSize` для столбцов типа String и составных типов, состоящих из столбцов типа String, изменился (с 9 байт на пустую строку на 8 байт на пустую строку), и это нормальное поведение. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Оптимизировать материализацию констант в случаях, когда она выполняется только чтобы вернуть одну строку. [#85071](https://github.com/ClickHouse/ClickHouse/pull/85071) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшена параллельная обработка файлов с использованием бэкенда delta-kernel-rs. [#85642](https://github.com/ClickHouse/ClickHouse/pull/85642) ([Azat Khuzhin](https://github.com/azat)).
* Была добавлена новая настройка enable&#95;add&#95;distinct&#95;to&#95;in&#95;subqueries. При её включении ClickHouse будет автоматически добавлять DISTINCT к подзапросам в предложениях IN для распределённых запросов. Это может существенно уменьшить размер временных таблиц, передаваемых между шардами, и повысить эффективность использования сети. Примечание: это компромисс — хотя объём сетевого трафика снижается, на каждом узле требуется дополнительная работа по слиянию (удалению дубликатов). Включайте эту настройку, когда сетевой трафик является узким местом и затраты на слияние приемлемы. [#81908](https://github.com/ClickHouse/ClickHouse/pull/81908) ([fhw12345](https://github.com/fhw12345)).
* Снижены накладные расходы на отслеживание использования памяти запросов для исполняемых пользовательских функций. [#83929](https://github.com/ClickHouse/ClickHouse/pull/83929) ([Eduard Karacharov](https://github.com/korowa)).
* Реализована внутренняя фильтрация `delta-kernel-rs` (на основе статистики и отсечения партиций) в хранилище `DeltaLake`. [#84006](https://github.com/ClickHouse/ClickHouse/pull/84006) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Более тонко настроено отключение пропускающих индексов, зависящих от столбцов, обновляемых «на лету» или с помощью patch parts. Теперь пропускающие индексы не используются только в тех партах, на которые влияют мутации «на лету» или patch parts; ранее такие индексы отключались для всех партов. [#84241](https://github.com/ClickHouse/ClickHouse/pull/84241) ([Anton Popov](https://github.com/CurtizJ)).
* Выделять минимально необходимый объём памяти для encrypted&#95;buffer, используемого для зашифрованных именованных коллекций. [#84432](https://github.com/ClickHouse/ClickHouse/pull/84432) ([Pablo Marcos](https://github.com/pamarcos)).
* Улучшена поддержка индексов bloom-фильтра (обычных, ngram и token) при использовании, когда первый аргумент — константный массив (множество), а второй — индексируемый столбец (подмножество), что позволяет более эффективно выполнять запросы. [#84700](https://github.com/ClickHouse/ClickHouse/pull/84700) ([Doron David](https://github.com/dorki)).
* Уменьшена конкуренция за блокировку хранилища в Keeper. [#84732](https://github.com/ClickHouse/ClickHouse/pull/84732) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена недостающая поддержка `read_in_order_use_virtual_row` для `WHERE`. Это позволяет пропускать чтение дополнительных частей данных для запросов с фильтрами, которые не были полностью вынесены в `PREWHERE`. [#84835](https://github.com/ClickHouse/ClickHouse/pull/84835) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Позволяет асинхронно перебирать объекты таблицы Iceberg без явного хранения объектов для каждого файла данных отдельно. [#85369](https://github.com/ClickHouse/ClickHouse/pull/85369) ([Daniil Ivanik](https://github.com/divanik)).
* Выполнять некоррелированный `EXISTS` как скалярный подзапрос. Это позволяет использовать кэш скалярных подзапросов и свёртывать результат в константу, что полезно для индексов. Для совместимости добавлена новая настройка `execute_exists_as_scalar_subquery=1`. [#85481](https://github.com/ClickHouse/ClickHouse/pull/85481) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).





#### Улучшение

* Добавлены настройки `database_replicated`, определяющие значения по умолчанию для параметров DatabaseReplicatedSettings. Если параметр не указан в запросе создания реплицируемой базы данных, используется значение по умолчанию из этих настроек. [#85127](https://github.com/ClickHouse/ClickHouse/pull/85127) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Добавлена возможность изменять ширину столбцов таблицы в веб-интерфейсе (play). [#84012](https://github.com/ClickHouse/ClickHouse/pull/84012) ([Doron David](https://github.com/dorki)).
* Добавлена поддержка сжатого файла `.metadata.json` посредством настройки `iceberg_metadata_compression_method`. Поддерживаются все методы сжатия ClickHouse. Тем самым закрывается задача [#84895](https://github.com/ClickHouse/ClickHouse/issues/84895). [#85196](https://github.com/ClickHouse/ClickHouse/pull/85196) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Показывать в выводе `EXPLAIN indexes = 1` количество диапазонов, которые будут прочитаны. [#79938](https://github.com/ClickHouse/ClickHouse/pull/79938) ([Christoph Wurm](https://github.com/cwurm)).
* Добавлены настройки для задания размера блока сжатия ORC и изменено его значение по умолчанию с 64KB на 256KB, чтобы соответствовать Spark и Hive. [#80602](https://github.com/ClickHouse/ClickHouse/pull/80602) ([李扬](https://github.com/taiyang-li)).
* Добавлен файл `columns_substreams.txt` в широкую часть (Wide part) для отслеживания всех подпотоков, хранящихся в части. Это помогает отслеживать динамические потоки в типах JSON и Dynamic и тем самым избегать чтения образца данных этих столбцов для получения списка динамических потоков (например, для расчёта размеров столбцов). Кроме того, теперь все динамические потоки отображаются в `system.parts_columns`. [#81091](https://github.com/ClickHouse/ClickHouse/pull/81091) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлен флаг командной строки --show&#95;secrets для clickhouse format, скрывающий конфиденциальные данные по умолчанию. [#81524](https://github.com/ClickHouse/ClickHouse/pull/81524) ([Nikolai Ryzhov](https://github.com/Dolaxom)).
* Запросы на чтение и запись в S3 теперь ограничиваются на уровне HTTP-сокета (а не целого S3-запроса), чтобы избежать проблем с ограничением `max_remote_read_network_bandwidth_for_server` и `max_remote_write_network_bandwidth_for_server`. [#81837](https://github.com/ClickHouse/ClickHouse/pull/81837) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена возможность смешивать разные правила сравнения строк (collations) для одного и того же столбца в разных окнах (для оконных функций). [#82877](https://github.com/ClickHouse/ClickHouse/pull/82877) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Добавлен инструмент для имитации, визуализации и сравнения селекторов слияния. [#71496](https://github.com/ClickHouse/ClickHouse/pull/71496) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена поддержка табличных функций `remote*` с параллельными репликами при указании кластера в аргументе `address_expression`. Также исправлена [#73295](https://github.com/ClickHouse/ClickHouse/issues/73295). [#82904](https://github.com/ClickHouse/ClickHouse/pull/82904) ([Igor Nikonov](https://github.com/devcrafter)).
* Установлен уровень TRACE для всех сообщений журнала, связанных с записью файлов резервных копий. [#82907](https://github.com/ClickHouse/ClickHouse/pull/82907) ([Hans Krutzer](https://github.com/hkrutzer)).
* Пользовательские функции с необычными именами и кодеками могут непоследовательно форматироваться SQL-форматтером. Это закрывает [#83092](https://github.com/ClickHouse/ClickHouse/issues/83092). [#83644](https://github.com/ClickHouse/ClickHouse/pull/83644) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Теперь пользователи могут использовать типы Time и Time64 внутри типа JSON. [#83784](https://github.com/ClickHouse/ClickHouse/pull/83784) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Операции `JOIN` с параллельными репликами теперь используют логический шаг соединения. При возникновении каких-либо проблем с запросами `JOIN`, использующими параллельные реплики, попробуйте выполнить `SET query_plan_use_new_logical_join_step=0` и сообщите о проблеме. [#83801](https://github.com/ClickHouse/ClickHouse/pull/83801) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлена проблема совместимости cluster&#95;function&#95;process&#95;archive&#95;on&#95;multiple&#95;nodes. [#83968](https://github.com/ClickHouse/ClickHouse/pull/83968) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка изменения настроек вставки для материализованных представлений на уровне таблицы `S3Queue`. На уровне `S3Queue` добавлены новые настройки: `min_insert_block_size_rows_for_materialized_views` и `min_insert_block_size_bytes_for_materialized_views`. По умолчанию используются настройки профиля, при этом настройки уровня `S3Queue` имеют приоритет над ними. [#83971](https://github.com/ClickHouse/ClickHouse/pull/83971) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлено событие профиля `MutationAffectedRowsUpperBound`, показывающее количество затронутых строк при выполнении мутации (например, общее количество строк, удовлетворяющих условию в запросе `ALTER UPDATE` или `ALTER DELETE`). [#83978](https://github.com/ClickHouse/ClickHouse/pull/83978) ([Anton Popov](https://github.com/CurtizJ)).
* Использовать информацию из cgroup (если применимо, то есть при доступности `memory_worker_use_cgroup` и cgroups) для корректировки трекера памяти (`memory_worker_correct_memory_tracker`). [#83981](https://github.com/ClickHouse/ClickHouse/pull/83981) ([Azat Khuzhin](https://github.com/azat)).
* MongoDB: неявное преобразование строк в числовые типы. Ранее, если из источника MongoDB для числового столбца в таблице ClickHouse поступало строковое значение, выбрасывалось исключение. Теперь движок пытается автоматически преобразовать строку в числовое значение. Закрыта задача [#81167](https://github.com/ClickHouse/ClickHouse/issues/81167). [#84069](https://github.com/ClickHouse/ClickHouse/pull/84069) ([Kirill Nikiforov](https://github.com/allmazz)).
* Подсвечивать группы разрядов в форматах `Pretty` для чисел типа `Nullable`. [#84070](https://github.com/ClickHouse/ClickHouse/pull/84070) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Dashboard: всплывающая подсказка больше не будет выходить за верхнюю границу контейнера. [#84072](https://github.com/ClickHouse/ClickHouse/pull/84072) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Чуть более аккуратное отображение точек на панели мониторинга. [#84074](https://github.com/ClickHouse/ClickHouse/pull/84074) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* У Dashboard теперь немного улучшённый фавикон. [#84076](https://github.com/ClickHouse/ClickHouse/pull/84076) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Web UI: Браузеры теперь могут сохранять пароль. Также запоминаются значения URL. [#84087](https://github.com/ClickHouse/ClickHouse/pull/84087) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка применения дополнительных ACL на отдельных узлах Keeper с использованием параметра конфигурации `apply_to_children`. [#84137](https://github.com/ClickHouse/ClickHouse/pull/84137) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено использование «compact» сериализации дискриминаторов типа Variant в MergeTree. Ранее в некоторых случаях она не применялась, хотя могла бы. [#84141](https://github.com/ClickHouse/ClickHouse/pull/84141) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена серверная настройка `logs_to_keep` в настройки реплицируемых баз данных, которая позволяет изменять значение параметра `logs_to_keep` по умолчанию для таких баз. Более низкие значения уменьшают количество ZNode (особенно если баз данных много), а более высокие значения позволяют отсутствующей реплике догнать состояние кластера после более длительного периода времени. [#84183](https://github.com/ClickHouse/ClickHouse/pull/84183) ([Alexey Khatskevich](https://github.com/Khatskevich)).
* Добавлена настройка `json_type_escape_dots_in_keys` для экранирования точек в ключах JSON при разборе типов JSON. По умолчанию она отключена. [#84207](https://github.com/ClickHouse/ClickHouse/pull/84207) ([Pavel Kruglov](https://github.com/Avogar)).
* Перед проверкой EOF проверяем, не было ли соединение отменено, чтобы предотвратить чтение из закрытого соединения. Исправляет [#83893](https://github.com/ClickHouse/ClickHouse/issues/83893). [#84227](https://github.com/ClickHouse/ClickHouse/pull/84227) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Слегка улучшены цвета выделения текста в веб-интерфейсе. Существенная разница заметна только для выделенных ячеек таблицы в тёмной теме. В предыдущих версиях контраста между текстом и фоном выделения было недостаточно. [#84258](https://github.com/ClickHouse/ClickHouse/pull/84258) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшена обработка клиентских подключений при завершении работы сервера за счёт упрощения внутренних проверок. [#84312](https://github.com/ClickHouse/ClickHouse/pull/84312) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Добавлена настройка `delta_lake_enable_expression_visitor_logging` для отключения логирования обходчика выражений, так как оно может быть чрезмерно подробным даже при уровне логирования `test` во время отладки. [#84315](https://github.com/ClickHouse/ClickHouse/pull/84315) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Метрики уровня cgroup и уровня всей системы теперь выводятся вместе. Метрики уровня cgroup имеют имена `CGroup<Metric>`, а метрики уровня операционной системы (собираемые из procfs) — `OS<Metric>`. [#84317](https://github.com/ClickHouse/ClickHouse/pull/84317) ([Nikita Taranov](https://github.com/nickitat)).
* Немного улучшены графики в веб-интерфейсе. Не намного, но всё же лучше. [#84326](https://github.com/ClickHouse/ClickHouse/pull/84326) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Изменено значение по умолчанию настройки `max_retries_before_automatic_recovery` для базы данных Replicated на 10, чтобы в некоторых случаях ускорить восстановление. [#84369](https://github.com/ClickHouse/ClickHouse/pull/84369) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлено форматирование оператора `CREATE USER` с параметрами запроса (то есть `CREATE USER {username:Identifier} IDENTIFIED WITH no_password`). [#84376](https://github.com/ClickHouse/ClickHouse/pull/84376) ([Azat Khuzhin](https://github.com/azat)).
* Добавлены настройки `backup_restore_s3_retry_initial_backoff_ms`, `backup_restore_s3_retry_max_backoff_ms`, `backup_restore_s3_retry_jitter_factor` для настройки стратегии задержки (backoff) при повторных попытках S3, используемой во время операций резервного копирования и восстановления. [#84421](https://github.com/ClickHouse/ClickHouse/pull/84421) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправление упорядоченного режима S3Queue: более раннее завершение работы при вызове shutdown. [#84463](https://github.com/ClickHouse/ClickHouse/pull/84463) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Поддержка записи в Iceberg при чтении из pyiceberg. [#84466](https://github.com/ClickHouse/ClickHouse/pull/84466) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Разрешено приведение типов значений наборов при проталкивании фильтров `IN` / `GLOBAL IN` по первичным ключам хранилищ KeyValue (например, EmbeddedRocksDB, KeeperMap). [#84515](https://github.com/ClickHouse/ClickHouse/pull/84515) ([Eduard Karacharov](https://github.com/korowa)).
* Обновлен chdig до версии [25.7.1](https://github.com/azat/chdig/releases/tag/v25.7.1). [#84521](https://github.com/ClickHouse/ClickHouse/pull/84521) ([Azat Khuzhin](https://github.com/azat)).
* Низкоуровневые ошибки при выполнении UDF теперь приводят к возврату кода ошибки `UDF_EXECUTION_FAILED`, тогда как ранее могли возвращаться разные коды ошибок. [#84547](https://github.com/ClickHouse/ClickHouse/pull/84547) ([Xu Jia](https://github.com/XuJia0210)).
* Добавлена команда `get_acl` для KeeperClient. [#84641](https://github.com/ClickHouse/ClickHouse/pull/84641) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена поддержка версий снапшотов в движках таблиц озера данных. [#84659](https://github.com/ClickHouse/ClickHouse/pull/84659) ([Pete Hampton](https://github.com/pjhampton)).
* Добавлена размерная метрика для размера `ConcurrentBoundedQueue`, размеченная по типу очереди (т.е. для чего предназначена очередь) и идентификатору очереди (т.е. случайно сгенерированный id для текущего экземпляра очереди). [#84675](https://github.com/ClickHouse/ClickHouse/pull/84675) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Таблица `system.columns` теперь содержит столбец `column` — псевдоним существующего столбца `name`. [#84695](https://github.com/ClickHouse/ClickHouse/pull/84695) ([Yunchi Pang](https://github.com/yunchipang)).
* Новая настройка MergeTree `search_orphaned_parts_drives` для ограничения области поиска частей, например дисками с локальными метаданными. [#84710](https://github.com/ClickHouse/ClickHouse/pull/84710) ([Ilya Golshtein](https://github.com/ilejn)).
* Добавлен 4LW в Keeper, `lgrq`, для включения и отключения логирования входящих запросов. [#84719](https://github.com/ClickHouse/ClickHouse/pull/84719) ([Antonio Andelic](https://github.com/antonio2368)).
* Сопоставлять заголовки forward&#95;headers во внешней аутентификации без учета регистра. [#84737](https://github.com/ClickHouse/ClickHouse/pull/84737) ([ingodwerust](https://github.com/ingodwerust)).
* Инструмент `encrypt_decrypt` теперь поддерживает шифрованные соединения с ZooKeeper. [#84764](https://github.com/ClickHouse/ClickHouse/pull/84764) ([Roman Vasin](https://github.com/rvasin)).
* Добавлен столбец форматной строки (format string) в `system.errors`. Этот столбец необходим для группировки одинаковых типов ошибок в правилах оповещений. [#84776](https://github.com/ClickHouse/ClickHouse/pull/84776) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Обновлён `clickhouse-format`, который теперь принимает `--highlight` в качестве псевдонима для `--hilite`. - Обновлён `clickhouse-client`, который теперь принимает `--hilite` в качестве псевдонима для `--highlight`. - Обновлена документация по `clickhouse-format` с учётом этого изменения. [#84806](https://github.com/ClickHouse/ClickHouse/pull/84806) ([Rishabh Bhardwaj](https://github.com/rishabh1815769)).
* Исправлено чтение таблиц Iceberg по идентификаторам полей для сложных типов. [#84821](https://github.com/ClickHouse/ClickHouse/pull/84821) ([Konstantин Vedernikov](https://github.com/scanhex12)).
* Добавлена новая настройка `backup_slow_all_threads_after_retryable_s3_error` для снижения нагрузки на S3 при массовых повторах запросов, вызванных ошибками вроде `SlowDown`, путём замедления всех потоков после возникновения первой ошибки, допускающей повторную попытку. [#84854](https://github.com/ClickHouse/ClickHouse/pull/84854) ([Julia Kartseva](https://github.com/jkartseva)).
* Пропустить создание и переименование старой временной таблицы для RMV DDL-запросов, не являющихся append, в реплицируемых базах данных. [#84858](https://github.com/ClickHouse/ClickHouse/pull/84858) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Ограничен размер кэша записей журнала Keeper по количеству записей с помощью параметров `keeper_server.coordination_settings.latest_logs_cache_entry_count_threshold` и `keeper_server.coordination_settings.commit_logs_cache_entry_count_threshold`. [#84877](https://github.com/ClickHouse/ClickHouse/pull/84877) ([Antonio Andelic](https://github.com/antonio2368)).
* Теперь разрешено использовать `simdjson` на неподдерживаемых архитектурах (что ранее приводило к ошибкам `CANNOT_ALLOCATE_MEMORY`). [#84966](https://github.com/ClickHouse/ClickHouse/pull/84966) ([Azat Khuzhin](https://github.com/azat)).
* Асинхронное логирование: сделать ограничения настраиваемыми и добавить интроспекцию. [#85105](https://github.com/ClickHouse/ClickHouse/pull/85105) ([Raúl Marín](https://github.com/Algunenano)).
* Собирает все удалённые объекты для выполнения одной операции удаления из объектного хранилища. [#85316](https://github.com/ClickHouse/ClickHouse/pull/85316) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Текущая реализация positional delete-файлов в Iceberg хранит все данные в оперативной памяти. Это может быть весьма затратно, если positional delete-файлы большие, что зачастую так и бывает. Моя реализация хранит в оперативной памяти только последнюю row group Parquet delete-файлов, что значительно дешевле. [#85329](https://github.com/ClickHouse/ClickHouse/pull/85329) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* chdig: исправлены артефакты, остающиеся на экране, устранён сбой после редактирования запроса в редакторе, добавлен поиск по `path` для `editor`, обновлён до версии [25.8.1](https://github.com/azat/chdig/releases/tag/v25.8.1). [#85341](https://github.com/ClickHouse/ClickHouse/pull/85341) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена отсутствующая настройка `partition_columns_in_data_file` в конфигурацию Azure. [#85373](https://github.com/ClickHouse/ClickHouse/pull/85373) ([Arthur Passos](https://github.com/arthurpassos)).
* Разрешено значение шага 0 в функциях `timeSeries*ToGrid`. Это часть [#75036](https://github.com/ClickHouse/ClickHouse/pull/75036). [#85390](https://github.com/ClickHouse/ClickHouse/pull/85390) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлен флаг show&#95;data&#95;lake&#95;catalogs&#95;in&#95;system&#95;tables для управления добавлением в system.tables таблиц из data lake. Устраняет проблему [#85384](https://github.com/ClickHouse/ClickHouse/issues/85384). [#85411](https://github.com/ClickHouse/ClickHouse/pull/85411) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Добавлена поддержка подстановки макросов в `remote_fs_zero_copy_zookeeper_path`. [#85437](https://github.com/ClickHouse/ClickHouse/pull/85437) ([Mikhail Koviazin](https://github.com/mkmkme)).
* ИИ в clickhouse-client станет выглядеть немного лучше. [#85447](https://github.com/ClickHouse/ClickHouse/pull/85447) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Включить по умолчанию trace&#95;log.symbolize для ранее развернутых инсталляций. [#85456](https://github.com/ClickHouse/ClickHouse/pull/85456) ([Azat Khuzhin](https://github.com/azat)).
* Расширена поддержка большего числа случаев для составных идентификаторов. В частности, это улучшает совместимость `ARRAY JOIN` со старым анализатором. Введена новая настройка `analyzer_compatibility_allow_compound_identifiers_in_unflatten_nested` для сохранения прежнего поведения. [#85492](https://github.com/ClickHouse/ClickHouse/pull/85492) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Игнорировать UNKNOWN&#95;DATABASE при получении размеров столбцов таблиц в system.columns. [#85632](https://github.com/ClickHouse/ClickHouse/pull/85632) ([Azat Khuzhin](https://github.com/azat)).
* Добавлено ограничение (настройка таблицы `max_uncompressed_bytes_in_patches`) на суммарное количество несжатых байт в patch-частях. Оно предотвращает существенные замедления выполнения запросов SELECT после лёгких обновлений и исключает возможное злоупотребление лёгкими обновлениями. [#85641](https://github.com/ClickHouse/ClickHouse/pull/85641) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлен столбец `parameter` в `system.grants` для определения типа источника в `GRANT READ/WRITE` и движка таблицы в `GRANT TABLE ENGINE`. [#85643](https://github.com/ClickHouse/ClickHouse/pull/85643) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Исправлена обработка завершающей запятой в списке столбцов запроса CREATE DICTIONARY после столбца с параметрами, например Decimal(8). Закрывает [#85586](https://github.com/ClickHouse/ClickHouse/issues/85586). [#85653](https://github.com/ClickHouse/ClickHouse/pull/85653) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена поддержка внутренних массивов для функции `nested`. [#85719](https://github.com/ClickHouse/ClickHouse/pull/85719) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Все выделения памяти, выполняемые внешними библиотеками, теперь видны трекеру памяти ClickHouse и корректно учитываются. Это может привести к «повышенному» отображаемому использованию памяти для отдельных запросов или к ошибкам с `MEMORY_LIMIT_EXCEEDED`. [#84082](https://github.com/ClickHouse/ClickHouse/pull/84082) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).



#### Исправление ошибки (некорректное поведение, заметное пользователю, в официальном стабильном релизе)



* Этот PR исправляет механизм получения метаданных при выполнении запросов к таблицам Iceberg через REST‑каталог. ... [#80562](https://github.com/ClickHouse/ClickHouse/pull/80562) ([Saurabh Kumar Ojha](https://github.com/saurabhojha)).
* Исправлена функция markReplicasActive в DDLWorker и DatabaseReplicatedDDLWorker. [#81395](https://github.com/ClickHouse/ClickHouse/pull/81395) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлен откат динамического столбца при ошибке парсинга. [#82169](https://github.com/ClickHouse/ClickHouse/pull/82169) ([Pavel Kruglov](https://github.com/Avogar)).
* Функция `trim` при вызове только с константными аргументами теперь возвращает константную выходную строку. (Ошибка [#78796](https://github.com/ClickHouse/ClickHouse/issues/78796)). [#82900](https://github.com/ClickHouse/ClickHouse/pull/82900) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена логическая ошибка с повторяющимися подзапросами при включённой настройке `optimize_syntax_fuse_functions`, закрыто [#75511](https://github.com/ClickHouse/ClickHouse/issues/75511). [#83300](https://github.com/ClickHouse/ClickHouse/pull/83300) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлена ошибка, приводившая к некорректным результатам запросов с условием `WHERE ... IN (<subquery>)` при включённом кэше условий запроса (настройка `use_query_condition_cache`). [#83445](https://github.com/ClickHouse/ClickHouse/pull/83445) ([LB7666](https://github.com/acking-you)).
* Ранее функция `gcs` не требовала каких-либо прав доступа. Теперь при её использовании проверяется наличие права `GRANT READ ON S3`. Закрывает [#70567](https://github.com/ClickHouse/ClickHouse/issues/70567). [#83503](https://github.com/ClickHouse/ClickHouse/pull/83503) ([pufit](https://github.com/pufit)).
* Пропускать недоступные узлы при выполнении `INSERT SELECT` из `s3Cluster()` в реплицируемый `MergeTree`. [#83676](https://github.com/ClickHouse/ClickHouse/pull/83676) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлена операция записи с добавлением (в MergeTree, используемом для экспериментальных транзакций) с типами метаданных `plain_rewritable`/`plain`, которые раньше просто игнорировались. [#83695](https://github.com/ClickHouse/ClickHouse/pull/83695) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Скрывать данные аутентификации к реестру схем Avro, чтобы они не отображались пользователю и не попадали в журналы. [#83713](https://github.com/ClickHouse/ClickHouse/pull/83713) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлена ошибка, при которой, если таблица MergeTree создаётся с параметром `add_minmax_index_for_numeric_columns=1` или `add_minmax_index_for_string_columns=1`, индекс впоследствии материализуется во время операции ALTER и препятствует корректной инициализации реплицируемой базы данных на новой реплике. [#83751](https://github.com/ClickHouse/ClickHouse/pull/83751) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена ошибка в модуле записи Parquet, из-за которой для типов Decimal некорректно формировалась статистика (минимум/максимум). [#83754](https://github.com/ClickHouse/ClickHouse/pull/83754) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена сортировка значений NaN в типе `LowCardinality(Float32|Float64|BFloat16)`. [#83786](https://github.com/ClickHouse/ClickHouse/pull/83786) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* При восстановлении из резервной копии пользователь-definer может не попасть в резервную копию, что сделает всю резервную копию нерабочей. Чтобы это исправить, мы откладываем проверку прав при создании целевой таблицы в процессе восстановления и выполняем её только во время выполнения запроса. [#83818](https://github.com/ClickHouse/ClickHouse/pull/83818) ([pufit](https://github.com/pufit)).
* Исправлено падение клиента из-за соединения, оставшегося в разорванном состоянии после ошибочного INSERT-запроса. [#83842](https://github.com/ClickHouse/ClickHouse/pull/83842) ([Azat Khuzhin](https://github.com/azat)).
* Разрешено ссылаться на любую таблицу в аргументе `view(...)` табличной функции `remote` при включённом анализаторе. Исправлена проблема [#78717](https://github.com/ClickHouse/ClickHouse/issues/78717). Исправлена проблема [#79377](https://github.com/ClickHouse/ClickHouse/issues/79377). [#83844](https://github.com/ClickHouse/ClickHouse/pull/83844) ([Dmitry Novik](https://github.com/novikd)).
* Вызов onprogress в jsoneachrowwithprogress теперь синхронизирован с этапом финализации. [#83879](https://github.com/ClickHouse/ClickHouse/pull/83879) ([Sema Checherinda](https://github.com/CheSema)).
* Закрывает задачу [#81303](https://github.com/ClickHouse/ClickHouse/issues/81303). [#83892](https://github.com/ClickHouse/ClickHouse/pull/83892) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Исправлены функции colorSRGBToOKLCH/colorOKLCHToSRGB при совместном использовании const и non-const аргументов. [#83906](https://github.com/ClickHouse/ClickHouse/pull/83906) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена запись JSON-путей со значениями NULL в формате RowBinary. [#83923](https://github.com/ClickHouse/ClickHouse/pull/83923) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено переполнение больших значений (&gt;2106-02-07) при приведении типа из Date в DateTime64. [#83982](https://github.com/ClickHouse/ClickHouse/pull/83982) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Всегда применять ограничение `filesystem_prefetches_limit` (не только в `MergeTreePrefetchedReadPool`). [#83999](https://github.com/ClickHouse/ClickHouse/pull/83999) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена редкая ошибка, при которой запрос `MATERIALIZE COLUMN` мог приводить к появлению неожиданных файлов в `checksums.txt` и в итоге — к отсоединённым частям данных. [#84007](https://github.com/ClickHouse/ClickHouse/pull/84007) ([alesapin](https://github.com/alesapin)).
* Исправлена логическая ошибка `Expected single dictionary argument for function` при выполнении JOIN с условием неравенства, когда один из столбцов имеет тип `LowCardinality`, а другой является константой. Закрывает [#81779](https://github.com/ClickHouse/ClickHouse/issues/81779). [#84019](https://github.com/ClickHouse/ClickHouse/pull/84019) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлен сбой `clickhouse client` при использовании в интерактивном режиме с подсветкой синтаксиса. [#84025](https://github.com/ClickHouse/ClickHouse/pull/84025) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлены неверные результаты запросов при использовании кэша условий запроса в сочетании с рекурсивными CTE (issue [#81506](https://github.com/ClickHouse/ClickHouse/issues/81506)). [#84026](https://github.com/ClickHouse/ClickHouse/pull/84026) ([zhongyuankai](https://github.com/zhongyuankai)).
* Корректно обрабатывать исключения при периодическом обновлении частей. [#84083](https://github.com/ClickHouse/ClickHouse/pull/84083) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено объединение фильтра с условием JOIN в случаях, когда операнды равенства имеют разные типы или ссылаются на константы. Исправляет [#83432](https://github.com/ClickHouse/ClickHouse/issues/83432). [#84145](https://github.com/ClickHouse/ClickHouse/pull/84145) ([Dmitry Novik](https://github.com/novikd)).
* Исправлен редкий сбой ClickHouse, возникающий, когда у таблицы есть проекция, установлен `lightweight_mutation_projection_mode = 'rebuild'`, и пользователь выполняет легковесное удаление, которое удаляет ВСЕ строки из какого-либо блока в таблице. [#84158](https://github.com/ClickHouse/ClickHouse/pull/84158) ([alesapin](https://github.com/alesapin)).
* Исправлена взаимоблокировка, вызванная фоновым потоком проверки отмены. [#84203](https://github.com/ClickHouse/ClickHouse/pull/84203) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена бесконечная рекурсивная обработка некорректных определений `WINDOW`. Исправляет [#83131](https://github.com/ClickHouse/ClickHouse/issues/83131). [#84242](https://github.com/ClickHouse/ClickHouse/pull/84242) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена ошибка, приводившая к некорректному кодированию и декодированию Bech32. Первоначально ошибка не была обнаружена, поскольку онлайн-реализация алгоритма, использовавшаяся для тестирования, содержала ту же ошибку. [#84257](https://github.com/ClickHouse/ClickHouse/pull/84257) ([George Larionov](https://github.com/george-larionov)).
* Исправлено некорректное создание пустых кортежей в функции `array()`. Это устраняет [#84202](https://github.com/ClickHouse/ClickHouse/issues/84202). [#84297](https://github.com/ClickHouse/ClickHouse/pull/84297) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка `LOGICAL_ERROR` для запросов с параллельными репликами и несколькими соединениями INNER, за которыми следует соединение RIGHT. Не используйте параллельные реплики для таких запросов. [#84299](https://github.com/ClickHouse/ClickHouse/pull/84299) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Ранее индексы типа `set` не учитывали столбцы `Nullable` при проверке того, проходят ли гранулы фильтр (issue [#75485](https://github.com/ClickHouse/ClickHouse/issues/75485)). [#84305](https://github.com/ClickHouse/ClickHouse/pull/84305) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Теперь ClickHouse читает таблицы из каталога Glue, если тип таблицы указан в нижнем регистре. [#84316](https://github.com/ClickHouse/ClickHouse/pull/84316) ([alesapin](https://github.com/alesapin)).
* Не пытайтесь заменять табличные функции их кластерными аналогами в запросах, содержащих `JOIN` или подзапросы. [#84335](https://github.com/ClickHouse/ClickHouse/pull/84335) ([Konstantин Богданов](https://github.com/thevar1able)).
* Исправлено использование логгера в `IAccessStorage`. [#84365](https://github.com/ClickHouse/ClickHouse/pull/84365) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлена логическая ошибка в легковесных обновлениях, которые изменяют все столбцы таблицы. [#84380](https://github.com/ClickHouse/ClickHouse/pull/84380) ([Anton Popov](https://github.com/CurtizJ)).
* Кодек `DoubleDelta` теперь может применяться только к столбцам числового типа. В частности, столбцы типа `FixedString` больше не могут сжиматься с использованием `DoubleDelta`. (исправляет [#80220](https://github.com/ClickHouse/ClickHouse/issues/80220)). [#84383](https://github.com/ClickHouse/ClickHouse/pull/84383) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
* Сравнение с NaN выполнялось с использованием некорректных диапазонов при оценке индекса `MinMax`. [#84386](https://github.com/ClickHouse/ClickHouse/pull/84386) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Исправлено чтение столбца `Variant` при ленивой материализации. [#84400](https://github.com/ClickHouse/ClickHouse/pull/84400) ([Pavel Kruglov](https://github.com/Avogar)).
* Рассматривать `zoutofmemory` как аппаратную ошибку, иначе будет выбрасываться логическая ошибка. См. [https://github.com/clickhouse/clickhouse-core-incidents/issues/877](https://github.com/clickhouse/clickhouse-core-incidents/issues/877). [#84420](https://github.com/ClickHouse/ClickHouse/pull/84420) ([Han Fei](https://github.com/hanfei1991)).
* Исправлено падение сервера, возникавшее, когда пользователь, созданный с `no_password`, пытался войти после того, как серверная настройка `allow_no_password` была изменена на 0. [#84426](https://github.com/ClickHouse/ClickHouse/pull/84426) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Исправлена проблема с нарушением порядка записи в журнал изменений Keeper. Ранее могли выполняться незавершённые операции записи в журнал изменений, но откат мог приводить к одновременному изменению целевого файла. Это приводило к несогласованным журналам и возможной потере данных. [#84434](https://github.com/ClickHouse/ClickHouse/pull/84434) ([Antonio Andelic](https://github.com/antonio2368)).
* Теперь, если все TTL удалены из таблицы MergeTree, она не будет выполнять никаких действий, связанных с TTL. [#84441](https://github.com/ClickHouse/ClickHouse/pull/84441) ([alesapin](https://github.com/alesapin)).
* Было разрешено параллельное распределённое `INSERT SELECT` с `LIMIT`, что является некорректным и приводит к дублированию данных в целевой таблице. [#84477](https://github.com/ClickHouse/ClickHouse/pull/84477) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлено отсечение файлов по виртуальному столбцу в озёрах данных. [#84520](https://github.com/ClickHouse/ClickHouse/pull/84520) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлены утечки в Keeper с хранилищем RocksDB (итераторы не уничтожались). [#84523](https://github.com/ClickHouse/ClickHouse/pull/84523) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема, при которой `ALTER MODIFY ORDER BY` не проверял столбцы TTL в ключах сортировки. Столбцы TTL теперь корректно отклоняются при использовании в выражениях `ORDER BY` в операторах `ALTER`, что предотвращает возможное повреждение таблицы. [#84536](https://github.com/ClickHouse/ClickHouse/pull/84536) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Изменено значение `allow_experimental_delta_kernel_rs` на `false` для версий до 25.5 для обеспечения совместимости. [#84587](https://github.com/ClickHouse/ClickHouse/pull/84587) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Больше не берёт схему из manifest-файлов, вместо этого соответствующие схемы хранятся отдельно для каждого snapshot. Соответствующая схема для каждого файла данных определяется на основе соответствующего ему snapshot. Предыдущее поведение нарушало спецификацию Iceberg для записей manifest-файлов со статусом existing. [#84588](https://github.com/ClickHouse/ClickHouse/pull/84588) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлена ошибка, из-за которой настройка Keeper `rotate_log_storage_interval = 0` приводила к аварийному завершению ClickHouse. (issue [#83975](https://github.com/ClickHouse/ClickHouse/issues/83975)). [#84637](https://github.com/ClickHouse/ClickHouse/pull/84637) ([George Larionov](https://github.com/george-larionov)).
* Исправлена логическая ошибка в S3Queue с сообщением &quot;Table is already registered&quot;. Исправление закрывает [#84433](https://github.com/ClickHouse/ClickHouse/issues/84433). Ошибка появилась после [https://github.com/ClickHouse/ClickHouse/pull/83530](https://github.com/ClickHouse/ClickHouse/pull/83530). [#84677](https://github.com/ClickHouse/ClickHouse/pull/84677) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Блокировать &#39;mutex&#39; при получении zookeeper из &#39;view&#39; в RefreshTask. [#84699](https://github.com/ClickHouse/ClickHouse/pull/84699) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлена ошибка `CORRUPTED_DATA` при использовании ленивых столбцов с внешней сортировкой. [#84738](https://github.com/ClickHouse/ClickHouse/pull/84738) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлено отсечение столбцов при использовании delta-kernel в хранилище `DeltaLake`. Закрывает [#84543](https://github.com/ClickHouse/ClickHouse/issues/84543). [#84745](https://github.com/ClickHouse/ClickHouse/pull/84745) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Обновить учетные данные в delta-kernel хранилища DeltaLake. [#84751](https://github.com/ClickHouse/ClickHouse/pull/84751) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен лишний запуск внутренних резервных копий после проблем с подключением. [#84755](https://github.com/ClickHouse/ClickHouse/pull/84755) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена проблема, при которой запрос к удалённому источнику с задержкой мог приводить к выходу за границы вектора. [#84820](https://github.com/ClickHouse/ClickHouse/pull/84820) ([George Larionov](https://github.com/george-larionov)).
* Токенизаторы `ngram` и `no_op` больше не приводят к сбою экспериментального текстового индекса при обработке пустых входных токенов. [#84849](https://github.com/ClickHouse/ClickHouse/pull/84849) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена работа легковесных обновлений для таблиц с движками `ReplacingMergeTree` и `CollapsingMergeTree`. [#84851](https://github.com/ClickHouse/ClickHouse/pull/84851) ([Anton Popov](https://github.com/CurtizJ)).
* Корректно сохранять все настройки в метаданных таблиц для таблиц, использующих движок object queue. [#84860](https://github.com/ClickHouse/ClickHouse/pull/84860) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлен подсчёт общего количества наблюдений, возвращаемого Keeper. [#84890](https://github.com/ClickHouse/ClickHouse/pull/84890) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена работа легковесных обновлений для таблиц с движком `ReplicatedMergeTree`, созданных на серверах с версией ниже 25.7. [#84933](https://github.com/ClickHouse/ClickHouse/pull/84933) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены легковесные обновления для таблиц с движком `MergeTree` без репликации после выполнения запроса `ALTER TABLE ... REPLACE PARTITION`. [#84941](https://github.com/ClickHouse/ClickHouse/pull/84941) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена генерация имен столбцов для булевых литералов: теперь используются &quot;true&quot;/&quot;false&quot; вместо &quot;1&quot;/&quot;0&quot;, что предотвращает конфликты имен столбцов между булевыми и целочисленными литералами в запросах. [#84945](https://github.com/ClickHouse/ClickHouse/pull/84945) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Исправлена рассинхронизация учёта памяти в пуле фоновых задач и исполнителе. [#84946](https://github.com/ClickHouse/ClickHouse/pull/84946) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены потенциальные ошибки некорректной сортировки в движке таблиц Merge. [#85025](https://github.com/ClickHouse/ClickHouse/pull/85025) ([Xiaozhe Yu](https://github.com/wudidapaopao)).
* Реализованы недостающие API для DiskEncrypted. [#85028](https://github.com/ClickHouse/ClickHouse/pull/85028) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена проверка на использование коррелированного подзапроса в распределённом контексте, чтобы избежать сбоя. Исправляет [#82205](https://github.com/ClickHouse/ClickHouse/issues/82205). [#85030](https://github.com/ClickHouse/ClickHouse/pull/85030) ([Dmitry Novik](https://github.com/novikd)).
* Теперь Iceberg не пытается кэшировать соответствующую версию snapshot между запросами SELECT и всегда честно разрешает snapshot. Предыдущая попытка кэшировать snapshot Iceberg приводила к проблемам при использовании таблицы Iceberg с time travel. [#85038](https://github.com/ClickHouse/ClickHouse/pull/85038) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлено двойное освобождение памяти в `AzureIteratorAsync`. [#85064](https://github.com/ClickHouse/ClickHouse/pull/85064) ([Nikita Taranov](https://github.com/nickitat)).
* Улучшено сообщение об ошибке при попытке создать пользователя с аутентификацией через JWT. [#85072](https://github.com/ClickHouse/ClickHouse/pull/85072) ([Konstantин Bogdanов](https://github.com/thevar1able)).
* Исправлена очистка patch parts в `ReplicatedMergeTree`. Ранее результат легковесного обновления мог временно быть невиден на реплике до тех пор, пока объединённая или мутировавшая часть, материализующая patch parts, не была загружена с другой реплики. [#85121](https://github.com/ClickHouse/ClickHouse/pull/85121) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка &#95;illegal&#95;type&#95;of&#95;argument в mv, когда типы различаются. [#85135](https://github.com/ClickHouse/ClickHouse/pull/85135) ([Sema Checherinda](https://github.com/CheSema)).
* Исправлен сегфолт в реализации delta-kernel. [#85160](https://github.com/ClickHouse/ClickHouse/pull/85160) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено восстановление реплицируемых баз данных в случаях, когда перенос файла метаданных занимает много времени. [#85177](https://github.com/ClickHouse/ClickHouse/pull/85177) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлена проблема `Not-ready Set` для `IN (subquery)` в настройке `additional_table_filters expression`. [#85210](https://github.com/ClickHouse/ClickHouse/pull/85210) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Убраны ненужные вызовы `getStatus()` во время выполнения запросов SYSTEM DROP REPLICA. Исправлена ситуация, когда таблица удаляется в фоновом режиме и выбрасывается исключение `Shutdown for storage is called`. [#85220](https://github.com/ClickHouse/ClickHouse/pull/85220) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена гонка в реализации delta-kernel для движка `DeltaLake`. [#85221](https://github.com/ClickHouse/ClickHouse/pull/85221) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено чтение секционированных данных при отключённом delta-kernel в движке `DeltaLake`. Эта функциональность была нарушена в версии 25.7 ([https://github.com/ClickHouse/ClickHouse/pull/81136](https://github.com/ClickHouse/ClickHouse/pull/81136)). [#85223](https://github.com/ClickHouse/ClickHouse/pull/85223) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлены отсутствующие проверки длины имени таблицы в запросах CREATE OR REPLACE и RENAME. [#85326](https://github.com/ClickHouse/ClickHouse/pull/85326) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена проблема с созданием RMV на новой реплике реплицируемой базы данных, если был удалён `DEFINER`. [#85327](https://github.com/ClickHouse/ClickHouse/pull/85327) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлены операции записи в Iceberg для сложных типов. [#85330](https://github.com/ClickHouse/ClickHouse/pull/85330) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Запись нижних и верхних границ для сложных типов не поддерживается. [#85332](https://github.com/ClickHouse/ClickHouse/pull/85332) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Исправлена логическая ошибка при чтении из функций работы с объектным хранилищем через таблицу Distributed или табличную функцию remote. Исправления: [#84658](https://github.com/ClickHouse/ClickHouse/issues/84658), [#85173](https://github.com/ClickHouse/ClickHouse/issues/85173), [#52022](https://github.com/ClickHouse/ClickHouse/issues/52022). [#85359](https://github.com/ClickHouse/ClickHouse/pull/85359) ([alesapin](https://github.com/alesapin)).
* Исправлено резервное копирование кусков с повреждёнными проекциями. [#85362](https://github.com/ClickHouse/ClickHouse/pull/85362) ([Antonio Andelic](https://github.com/antonio2368)).
* Запрещено использование столбца `_part_offset` в проекциях в релизах до тех пор, пока он не будет стабилизирован. [#85372](https://github.com/ClickHouse/ClickHouse/pull/85372) ([Sema Checherinda](https://github.com/CheSema)).
* Исправлено падение и повреждение данных при выполнении ALTER UPDATE для JSON. [#85383](https://github.com/ClickHouse/ClickHouse/pull/85383) ([Pavel Kruglov](https://github.com/Avogar)).
* Запросы с параллельными репликами, которые используют оптимизацию чтения в обратном порядке, могли возвращать некорректные результаты. [#85406](https://github.com/ClickHouse/ClickHouse/pull/85406) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлено возможное неопределённое поведение (сбои) в случае MEMORY&#95;LIMIT&#95;EXCEEDED во время десериализации типа String. [#85440](https://github.com/ClickHouse/ClickHouse/pull/85440) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены ошибки в метриках KafkaAssignedPartitions и KafkaConsumersWithAssignment. [#85494](https://github.com/ClickHouse/ClickHouse/pull/85494) ([Ilya Golshtein](https://github.com/ilejn)).
* Исправлена заниженная оценка статистики по обработанным байтам при использовании PREWHERE (явном или автоматическом). [#85495](https://github.com/ClickHouse/ClickHouse/pull/85495) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлено условие раннего выхода для замедления скорости запросов к S3: для включения поведения замедления, когда все потоки приостановлены из‑за повторяемой ошибки, теперь достаточно, чтобы `s3_slow_all_threads_after_network_error` или `backup_slow_all_threads_after_retryable_s3_error` были установлены в `true`, вместо требования одновременного выполнения обоих условий. [#85505](https://github.com/ClickHouse/ClickHouse/pull/85505) ([Julia Kartseva](https://github.com/jkartseva)).
* Этот PR исправляет определение метаданных при выполнении запросов к таблицам Iceberg через REST-каталог. ... [#85531](https://github.com/ClickHouse/ClickHouse/pull/85531) ([Saurabh Kumar Ojha](https://github.com/saurabhojha)).
* Исправлен редкий сбой при асинхронных вставках, которые изменяют настройки `log_comment` или `insert_deduplication_token`. [#85540](https://github.com/ClickHouse/ClickHouse/pull/85540) ([Anton Popov](https://github.com/CurtizJ)).
* Параметры вроде date&#95;time&#95;input&#95;format игнорировались при использовании HTTP с multipart/form-data. [#85570](https://github.com/ClickHouse/ClickHouse/pull/85570) ([Sema Checherinda](https://github.com/CheSema)).
* Исправлено маскирование секретов в табличных функциях icebergS3Cluster и icebergAzureCluster. [#85658](https://github.com/ClickHouse/ClickHouse/pull/85658) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Исправлена потеря точности в `JSONExtract` при преобразовании числовых значений JSON в типы Decimal. Теперь числовые значения JSON сохраняют своё точное десятичное представление, избегая ошибок округления с плавающей запятой. [#85665](https://github.com/ClickHouse/ClickHouse/pull/85665) ([ssive7b](https://github.com/ssive7b)).
* Исправлена ошибка `LOGICAL_ERROR`, возникавшая при использовании `COMMENT COLUMN IF EXISTS` в том же операторе `ALTER` после `DROP COLUMN`. Теперь условие `IF EXISTS` корректно пропускает операцию комментария, если столбец был удалён в рамках того же оператора. [#85688](https://github.com/ClickHouse/ClickHouse/pull/85688) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Исправлено считывание значения счётчика из кэша для Delta Lake. [#85704](https://github.com/ClickHouse/ClickHouse/pull/85704) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка сегфолта в CoalescingMergeTree при обработке больших строк. Закрывает [#84582](https://github.com/ClickHouse/ClickHouse/issues/84582). [#85709](https://github.com/ClickHouse/ClickHouse/pull/85709) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Обновлена метка времени метаданных при операциях записи в Iceberg. [#85711](https://github.com/ClickHouse/ClickHouse/pull/85711) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Использование `distributed_depth` в качестве индикатора для функции *Cluster было некорректным и могло приводить к дублированию данных; вместо этого используйте `client_info.collaborate_with_initiator`. [#85734](https://github.com/ClickHouse/ClickHouse/pull/85734) ([Konstantин Bogdanov](https://github.com/thevar1able)).
* Spark не может читать файлы позиционных удалений. [#85762](https://github.com/ClickHouse/ClickHouse/pull/85762) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Исправлен `send_logs_source_regexp` (после рефакторинга асинхронного логирования в [#85105](https://github.com/ClickHouse/ClickHouse/issues/85105)). [#85797](https://github.com/ClickHouse/ClickHouse/pull/85797) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена потенциальная неконсистентность в словарях с `update_field` при ошибках `MEMORY_LIMIT_EXCEEDED`. [#85807](https://github.com/ClickHouse/ClickHouse/pull/85807) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка глобальных констант из оператора `WITH` для параллельной распределённой операции `INSERT SELECT` с целевой таблицей `Distributed`. Ранее такой запрос мог завершаться ошибкой `Unknown expression identifier`. [#85811](https://github.com/ClickHouse/ClickHouse/pull/85811) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Реализовано маскирование учетных данных для `deltaLakeAzure`, `deltaLakeCluster`, `icebergS3Cluster` и `icebergAzureCluster`. [#85889](https://github.com/ClickHouse/ClickHouse/pull/85889) ([Julian Maicher](https://github.com/jmaicher)).
* Исправлена логическая ошибка при попытке `CREATE ... AS (SELECT * FROM s3Cluster(...))` при использовании `DatabaseReplicated`. [#85904](https://github.com/ClickHouse/ClickHouse/pull/85904) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправляет HTTP-запросы, выполняемые табличной функцией `url()`, чтобы корректно указывать номера портов в заголовке Host при обращении к нестандартным портам. Это устраняет сбои аутентификации при использовании предподписанных URL с S3-совместимыми сервисами, такими как MinIO, работающими на нестандартных портах, что часто встречается в средах разработки. (Исправляет [#85898](https://github.com/ClickHouse/ClickHouse/issues/85898)). [#85921](https://github.com/ClickHouse/ClickHouse/pull/85921) ([Tom Quist](https://github.com/tomquist)).
* Теперь Unity Catalog игнорирует схемы с некорректными типами данных для таблиц, не являющихся Delta. Исправляет [#85699](https://github.com/ClickHouse/ClickHouse/issues/85699). [#85950](https://github.com/ClickHouse/ClickHouse/pull/85950) ([alesapin](https://github.com/alesapin)).
* Исправлена поддержка значений NULL для полей в Iceberg. [#85977](https://github.com/ClickHouse/ClickHouse/pull/85977) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Исправлена ошибка в восстановлении базы данных `Replicated`: если имя таблицы содержало символ `%`, в процессе восстановления таблица могла быть пересоздана под другим именем. [#85987](https://github.com/ClickHouse/ClickHouse/pull/85987) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена проблема сбоя восстановления резервных копий с ошибкой `BACKUP_ENTRY_NOT_FOUND` при восстановлении пустой таблицы `Memory`. [#86012](https://github.com/ClickHouse/ClickHouse/pull/86012) ([Julia Kartseva](https://github.com/jkartseva)).
* Добавлены проверки для sharding&#95;key во время выполнения ALTER таблицы Distributed. Ранее некорректный ALTER мог привести к повреждению определения таблицы и требовать перезапуска сервера. [#86015](https://github.com/ClickHouse/ClickHouse/pull/86015) ([Nikolay Degterinsky](https://github.com/evillique)).
* Не создавать пустой файл удаления Iceberg. [#86061](https://github.com/ClickHouse/ClickHouse/pull/86061) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Исправлена проблема, из-за которой большие значения настроек могли приводить к сбоям в работе таблиц S3Queue и перезапуске реплик. [#86074](https://github.com/ClickHouse/ClickHouse/pull/86074) ([Nikolay Degterinsky](https://github.com/evillique)).

#### Улучшения сборки/тестирования/упаковки

- По умолчанию используются зашифрованные диски для тестов с S3. [#59898](https://github.com/ClickHouse/ClickHouse/pull/59898) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- В интеграционных тестах используется бинарный файл `clickhouse` для получения неочищенных отладочных символов. [#83779](https://github.com/ClickHouse/ClickHouse/pull/83779) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Внутренняя библиотека libxml2 обновлена с версии 2.14.4 до 2.14.5. [#84230](https://github.com/ClickHouse/ClickHouse/pull/84230) ([Robert Schulze](https://github.com/rschu1ze)).
- Внутренняя библиотека curl обновлена с версии 8.14.0 до 8.15.0. [#84231](https://github.com/ClickHouse/ClickHouse/pull/84231) ([Robert Schulze](https://github.com/rschu1ze)).
- Теперь в CI используется меньше памяти для кэшей, а также улучшены тесты для вытеснения. [#84676](https://github.com/ClickHouse/ClickHouse/pull/84676) ([alesapin](https://github.com/alesapin)).

### Релиз ClickHouse 25.7, 2025-07-24 {#257}

#### Обратно несовместимые изменения

- Изменения в функции `extractKeyValuePairs`: добавлен новый аргумент `unexpected_quoting_character_strategy`, который управляет поведением при неожиданном обнаружении символа `quoting_character` при чтении неквотированного ключа или значения. Значение может быть одним из: `invalid`, `accept` или `promote`. `invalid` отбрасывает ключ и возвращается в состояние ожидания ключа. `accept` рассматривает его как часть ключа. `promote` отбрасывает предыдущий символ и начинает разбор как квотированного ключа. Кроме того, после разбора квотированного значения следующий ключ разбирается только при обнаружении разделителя пар. [#80657](https://github.com/ClickHouse/ClickHouse/pull/80657) ([Arthur Passos](https://github.com/arthurpassos)).
- Добавлена поддержка нулевого совпадения в функции `countMatches`. Пользователи, желающие сохранить прежнее поведение, могут включить настройку `count_matches_stop_at_empty_match`. [#81676](https://github.com/ClickHouse/ClickHouse/pull/81676) ([Elmi Ahmadov](https://github.com/ahmadov)).
- При создании резервных копий используются общесерверные ограничители для локальных операций (`max_local_read_bandwidth_for_server` и `max_local_write_bandwidth_for_server`) и удалённых операций (`max_remote_read_network_bandwidth_for_server` и `max_remote_write_network_bandwidth_for_server`) в дополнение к выделенным серверным настройкам (`max_backup_bandwidth_for_server`, `max_mutations_bandwidth_for_server` и `max_merges_bandwidth_for_server`). [#81753](https://github.com/ClickHouse/ClickHouse/pull/81753) ([Sergei Trifonov](https://github.com/serxa)).
- Запрещено создание таблицы без столбцов, доступных для вставки. [#81835](https://github.com/ClickHouse/ClickHouse/pull/81835) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
- Распараллеливание кластерных функций по файлам внутри архивов. В предыдущих версиях весь архив (например, zip, tar или 7z) был единицей работы. Добавлена новая настройка `cluster_function_process_archive_on_multiple_nodes`, по умолчанию равная `true`. Если установлена в `true`, повышает производительность обработки архивов в кластерных функциях. Должна быть установлена в `false` для совместимости и во избежание ошибок при обновлении до версии 25.7+ при использовании кластерных функций с архивами в более ранних версиях. [#82355](https://github.com/ClickHouse/ClickHouse/pull/82355) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Запрос `SYSTEM RESTART REPLICAS` приводил к пробуждению таблиц в базе данных Lazy даже без доступа к этой базе данных, и это происходило во время одновременного удаления этих таблиц. Примечание: теперь `SYSTEM RESTART REPLICAS` будет перезапускать реплики только в тех базах данных, где у вас есть разрешение на выполнение `SHOW TABLES`, что является естественным поведением. [#83321](https://github.com/ClickHouse/ClickHouse/pull/83321) ([Alexey Milovidov](https://github.com/alexey-milovidov)).


#### Новая функция

* Добавлена поддержка легковесных обновлений для таблиц семейства `MergeTree`. Легковесные обновления могут использоваться с новым синтаксисом: `UPDATE <table> SET col1 = val1, col2 = val2, ... WHERE <condition>`. Добавлена реализация легковесных удалений путём использования легковесных обновлений. Это можно включить, установив `lightweight_delete_mode = 'lightweight_update'`. [#82004](https://github.com/ClickHouse/ClickHouse/pull/82004) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена поддержка сложных типов в эволюции схемы Iceberg. [#73714](https://github.com/ClickHouse/ClickHouse/pull/73714) ([Konstantин Vedernikov](https://github.com/scanhex12)).
* Добавлена поддержка вставки данных (INSERT) в таблицы Iceberg. [#82692](https://github.com/ClickHouse/ClickHouse/pull/82692) ([Konstantин Vedernikov](https://github.com/scanhex12)).
* Чтение файлов данных Iceberg по идентификаторам полей. Это улучшает совместимость с Iceberg: поля могут быть переименованы в метаданных при сопоставлении им других имен в соответствующих файлах Parquet. Это устраняет проблему [#83065](https://github.com/ClickHouse/ClickHouse/issues/83065). [#83653](https://github.com/ClickHouse/ClickHouse/pull/83653) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Теперь ClickHouse поддерживает сжатые файлы `metadata.json` для Iceberg. Исправлено в [#70874](https://github.com/ClickHouse/ClickHouse/issues/70874). [#81451](https://github.com/ClickHouse/ClickHouse/pull/81451) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка `TimestampTZ` в каталоге Glue, что закрывает [#81654](https://github.com/ClickHouse/ClickHouse/issues/81654). [#83132](https://github.com/ClickHouse/ClickHouse/pull/83132) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* В клиент ClickHouse добавлена генерация SQL-запросов на основе ИИ. Теперь пользователи могут генерировать SQL-запросы по описаниям на естественном языке, добавляя префикс `??` перед своим запросом. Поддерживаются провайдеры OpenAI и Anthropic, а также автоматическое обнаружение схемы. [#83314](https://github.com/ClickHouse/ClickHouse/pull/83314) ([Kaushik Iska](https://github.com/iskakaushik)).
* Добавлена функция для записи типов Geo в формат WKB. [#82935](https://github.com/ClickHouse/ClickHouse/pull/82935) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Введены два новых типа доступа для источников: `READ` и `WRITE`; все предыдущие типы доступа, связанные с источниками, объявлены устаревшими. Ранее: `GRANT S3 ON *.* TO user`, теперь: `GRANT READ, WRITE ON S3 TO user`. Это также позволяет разделять права `READ` и `WRITE` для источников, например: `GRANT READ ON * TO user`, `GRANT WRITE ON S3 TO user`. Эта возможность управляется настройкой `access_control_improvements.enable_read_write_grants` и по умолчанию отключена. [#73659](https://github.com/ClickHouse/ClickHouse/pull/73659) ([pufit](https://github.com/pufit)).
* NumericIndexedVector: новая векторная структура данных, основанная на бит-слайсинговом сжатии с использованием Roaring-bitmap, с более чем 20 функциями для построения, анализа и покомпонентной арифметики. Может сокращать объём хранения и ускорять операции `JOIN`, фильтрацию и агрегации на разреженных данных. Реализует [#70582](https://github.com/ClickHouse/ClickHouse/issues/70582) и идеи статьи [“Large-Scale Metric Computation in Online Controlled Experiment Platform”](https://arxiv.org/abs/2405.08411) T. Xiong и Y. Wang, представленной на VLDB 2024. [#74193](https://github.com/ClickHouse/ClickHouse/pull/74193) ([FriendLey](https://github.com/FriendLey)).
* Теперь поддерживается настройка профиля нагрузки `max_waiting_queries`. Её можно использовать для ограничения размера очереди запросов. При достижении лимита все последующие запросы будут завершены с ошибкой `SERVER_OVERLOADED`. [#81250](https://github.com/ClickHouse/ClickHouse/pull/81250) ([Oleg Doronin](https://github.com/dorooleg)).
* Добавлены финансовые функции: `financialInternalRateOfReturnExtended` (`XIRR`), `financialInternalRateOfReturn` (`IRR`), `financialNetPresentValueExtended` (`XNPV`), `financialNetPresentValue` (`NPV`). [#81599](https://github.com/ClickHouse/ClickHouse/pull/81599) ([Joanna Hulboj](https://github.com/jh0x)).
* Добавлены геопространственные функции `polygonsIntersectCartesian` и `polygonsIntersectSpherical` для проверки, пересекаются ли два полигона. [#81882](https://github.com/ClickHouse/ClickHouse/pull/81882) ([Paul Lamb](https://github.com/plamb)).
* Добавлена поддержка виртуального столбца `_part_granule_offset` в таблицах семейства MergeTree. Этот столбец указывает индекс (отсчёт с нуля) гранулы/метки, к которой относится каждая строка в своей части данных. Это решает проблему [#79572](https://github.com/ClickHouse/ClickHouse/issues/79572). [#82341](https://github.com/ClickHouse/ClickHouse/pull/82341) ([Amos Bird](https://github.com/amosbird)). [#82341](https://github.com/ClickHouse/ClickHouse/pull/82341) ([Amos Bird](https://github.com/amosbird))
* Добавлены SQL-функции `colorSRGBToOkLCH` и `colorOkLCHToSRGB` для преобразования цветов между цветовыми пространствами sRGB и OkLCH. [#83679](https://github.com/ClickHouse/ClickHouse/pull/83679) ([Fgrtue](https://github.com/Fgrtue)).
* Разрешено использовать параметры в запросах `CREATE USER` для задания имен пользователей. [#81387](https://github.com/ClickHouse/ClickHouse/pull/81387) ([Diskein](https://github.com/Diskein)).
* Таблица `system.formats` теперь содержит расширенную информацию о форматах, например HTTP Content-Type, возможности автоматического определения схемы и т.д. [#81505](https://github.com/ClickHouse/ClickHouse/pull/81505) ([Alexey Milovidov](https://github.com/alexey-milovidov)).



#### Экспериментальные возможности
* Добавлены функции `searchAny` и `searchAll` — универсальные инструменты для поиска по текстовым индексам. [#80641](https://github.com/ClickHouse/ClickHouse/pull/80641) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Текстовый индекс теперь поддерживает новый токенизатор `split`. [#81752](https://github.com/ClickHouse/ClickHouse/pull/81752) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Значение гранулярности индекса по умолчанию для индексов типа `text` изменено на 64. Это улучшает ожидаемую производительность для среднего тестового запроса во внутренних бенчмарках. [#82162](https://github.com/ClickHouse/ClickHouse/pull/82162) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
* 256-битная битовая маска хранит выходящие метки состояния в упорядоченном виде, но выходящие состояния сохраняются на диск в том порядке, в котором они появляются в хеш-таблице. Поэтому метка при чтении с диска могла указывать на неверное следующее состояние. [#82783](https://github.com/ClickHouse/ClickHouse/pull/82783) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Включено сжатие zstd для BLOB дерева FST в текстовых индексах. [#83093](https://github.com/ClickHouse/ClickHouse/pull/83093) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Индекс схожести векторов переведён в статус бета. Добавлен параметр-алиас `enable_vector_similarity_index`, который должен быть включён для использования индекса схожести векторов. [#83459](https://github.com/ClickHouse/ClickHouse/pull/83459) ([Robert Schulze](https://github.com/rschu1ze)).
* Удалена экспериментальная логика `send_metadata`, связанная с экспериментальной репликацией без копирования (zero-copy). Она никогда не использовалась, и этот код никто не поддерживал. Поскольку не было даже тестов для этой функциональности, с высокой вероятностью она уже давно не работает. [#82508](https://github.com/ClickHouse/ClickHouse/pull/82508) ([alesapin](https://github.com/alesapin)).
* Интегрирован `StorageKafka2` в `system.kafka_consumers`. [#82652](https://github.com/ClickHouse/ClickHouse/pull/82652) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Реализована оценка сложных CNF/DNF, например, `(a < 1 and a > 0) or b = 3`, на основе статистики. [#82663](https://github.com/ClickHouse/ClickHouse/pull/82663) ([Han Fei](https://github.com/hanfei1991)).



#### Улучшение производительности

* Добавлено асинхронное логирование. При выводе логов на медленное устройство это больше не приводит к задержке запросов. [#82516](https://github.com/ClickHouse/ClickHouse/pull/82516) ([Raúl Marín](https://github.com/Algunenano)). Ограничено максимальное количество записей, которые хранятся в очереди. [#83214](https://github.com/ClickHouse/ClickHouse/pull/83214) ([Raúl Marín](https://github.com/Algunenano)).
* Параллельный распределённый INSERT SELECT по умолчанию работает в режиме, при котором INSERT SELECT выполняется на каждом шарде независимо, см. настройку `parallel_distributed_insert_select`. [#83040](https://github.com/ClickHouse/ClickHouse/pull/83040) ([Igor Nikonov](https://github.com/devcrafter)).
* Когда агрегирующий запрос содержит только одну функцию `count()` для не-`Nullable` столбца, логика агрегации полностью встраивается во время зондирования хеш-таблицы. Это позволяет избежать выделения и поддержки какого-либо состояния агрегации, что существенно снижает потребление памяти и накладные расходы на ЦП. Это частично решает [#81982](https://github.com/ClickHouse/ClickHouse/issues/81982). [#82104](https://github.com/ClickHouse/ClickHouse/pull/82104) ([Amos Bird](https://github.com/amosbird)).
* Производительность `HashJoin` оптимизирована за счёт удаления дополнительного цикла по хеш-таблицам в типичном случае с единственным ключевым столбцом, а также исключения проверок `null_map` и `join_mask`, когда их значения заведомо всегда `true` или `false`. [#82308](https://github.com/ClickHouse/ClickHouse/pull/82308) ([Nikita Taranov](https://github.com/nickitat)).
* Простая оптимизация для комбинатора `-If`. [#78454](https://github.com/ClickHouse/ClickHouse/pull/78454) ([李扬](https://github.com/taiyang-li)).
* Запросы векторного поиска с использованием индекса сходства векторов выполняются с меньшей задержкой за счёт сокращения обращений к хранилищу и снижения нагрузки на CPU. [#79103](https://github.com/ClickHouse/ClickHouse/pull/79103) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Учитывать `merge_tree_min_{rows,bytes}_for_seek` в `filterPartsByQueryConditionCache`, чтобы привести его поведение в соответствие с другими методами фильтрации по индексам. [#80312](https://github.com/ClickHouse/ClickHouse/pull/80312) ([李扬](https://github.com/taiyang-li)).
* Сделать конвейер обработки после шага `TOTALS` многопоточным. [#80331](https://github.com/ClickHouse/ClickHouse/pull/80331) ([UnamedRus](https://github.com/UnamedRus)).
* Исправлена фильтрация по ключу в хранилищах `Redis` и `KeeperMap`. [#81833](https://github.com/ClickHouse/ClickHouse/pull/81833) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Добавлена новая настройка `min_joined_block_size_rows` (аналогичная `min_joined_block_size_bytes`; по умолчанию 65409) для управления минимальным размером блока (в строках) для входных и выходных блоков JOIN (если алгоритм JOIN это поддерживает). Мелкие блоки будут объединяться. [#81886](https://github.com/ClickHouse/ClickHouse/pull/81886) ([Nikita Taranov](https://github.com/nickitat)).
* `ATTACH PARTITION` больше не приводит к сбросу всех кэшей. [#82377](https://github.com/ClickHouse/ClickHouse/pull/82377) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Оптимизировать сгенерированный план для коррелированных подзапросов, удаляя избыточные операции JOIN с использованием классов эквивалентности. Если существуют эквивалентные выражения для всех коррелированных столбцов и включена настройка `query_plan_correlated_subqueries_use_substitution`, оператор `CROSS JOIN` не порождается. [#82435](https://github.com/ClickHouse/ClickHouse/pull/82435) ([Dmitry Novik](https://github.com/novikd)).
* Считывать только необходимые столбцы в коррелированном подзапросе, когда он является аргументом функции `EXISTS`. [#82443](https://github.com/ClickHouse/ClickHouse/pull/82443) ([Dmitry Novik](https://github.com/novikd)).
* Незначительно ускорено сравнение деревьев запросов при анализе запроса. [#82617](https://github.com/ClickHouse/ClickHouse/pull/82617) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлено выравнивание в счётчике `ProfileEvents` для уменьшения эффекта ложного совместного использования (false sharing). [#82697](https://github.com/ClickHouse/ClickHouse/pull/82697) ([Jiebin Sun](https://github.com/jiebinn)).
* Оптимизации для `null_map` и `JoinMask` из [#82308](https://github.com/ClickHouse/ClickHouse/issues/82308) были применены для `JOIN` с несколькими дизъюнктами. Также была оптимизирована структура данных `KnownRowsHolder`. [#83041](https://github.com/ClickHouse/ClickHouse/pull/83041) ([Nikita Taranov](https://github.com/nickitat)).
* Для флагов join используется обычный `std::vector<std::atomic_bool>`, чтобы избежать вычисления хеша при каждом обращении к флагам. [#83043](https://github.com/ClickHouse/ClickHouse/pull/83043) ([Nikita Taranov](https://github.com/nickitat)).
* Не выделяйте память для результирующих столбцов заранее, когда `HashJoin` использует режим вывода `lazy`. Это неоптимально, особенно когда количество совпадений невелико. Кроме того, после завершения соединения мы знаем точное количество совпадений и можем более точно зарезервировать память. [#83304](https://github.com/ClickHouse/ClickHouse/pull/83304) ([Nikita Taranov](https://github.com/nickitat)).
* Минимизировать копирование памяти в заголовках портов при построении конвейера. Исходный [PR](https://github.com/ClickHouse/ClickHouse/pull/70105) от [heymind](https://github.com/heymind). [#83381](https://github.com/ClickHouse/ClickHouse/pull/83381) ([Raúl Marín](https://github.com/Algunenano)).
* Улучшен процесс запуска clickhouse-keeper при использовании хранилища rocksdb. [#83390](https://github.com/ClickHouse/ClickHouse/pull/83390) ([Antonio Andelic](https://github.com/antonio2368)).
* Избегайте удержания блокировки при создании данных снимка хранилища, чтобы уменьшить конфликтность блокировок при высокой конкурентной нагрузке. [#83510](https://github.com/ClickHouse/ClickHouse/pull/83510) ([Duc Canh Le](https://github.com/canhld94)).
* Улучшена производительность формата ввода `ProtobufSingle` за счёт повторного использования сериализатора при отсутствии ошибок разбора. [#83613](https://github.com/ClickHouse/ClickHouse/pull/83613) ([Eduard Karacharov](https://github.com/korowa)).
* Повышена производительность построения конвейера, что ускоряет выполнение коротких запросов. [#83631](https://github.com/ClickHouse/ClickHouse/pull/83631) ([Raúl Marín](https://github.com/Algunenano)).
* Оптимизирован `MergeTreeReadersChain::getSampleBlock`, что ускорило выполнение коротких запросов. [#83875](https://github.com/ClickHouse/ClickHouse/pull/83875) ([Raúl Marín](https://github.com/Algunenano)).
* Ускорен вывод списка таблиц в каталогах данных за счет асинхронных запросов. [#81084](https://github.com/ClickHouse/ClickHouse/pull/81084) ([alesapin](https://github.com/alesapin)).
* Добавлен джиттер в механизм повторных попыток S3 при включённой конфигурации `s3_slow_all_threads_after_network_error`. [#81849](https://github.com/ClickHouse/ClickHouse/pull/81849) ([zoomxi](https://github.com/zoomxi)).





#### Улучшение

* Цветовая подсветка скобок несколькими цветами для улучшения читаемости. [#82538](https://github.com/ClickHouse/ClickHouse/pull/82538) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Подсвечиваются метасимволы в шаблонах LIKE/REGEXP при вводе. Ранее это уже было реализовано в `clickhouse-format` и в выводе `clickhouse-client`, но теперь работает и в командной строке. [#82871](https://github.com/ClickHouse/ClickHouse/pull/82871) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Подсветка в `clickhouse-format` и в echo-выводе клиента будет работать аналогично подсветке в приглашении командной строки. [#82874](https://github.com/ClickHouse/ClickHouse/pull/82874) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Теперь диски `plain_rewritable` могут использоваться в качестве дисков для метаданных баз данных. Реализованы методы `moveFile` и `replaceFile` в `plain_rewritable`, чтобы поддержать их использование в качестве дисков базы данных. [#79424](https://github.com/ClickHouse/ClickHouse/pull/79424) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Добавлена поддержка резервного копирования баз данных `PostgreSQL`, `MySQL` и `DataLake`. Резервная копия такой базы данных будет сохранять только определение, но не содержащиеся в ней данные. [#79982](https://github.com/ClickHouse/ClickHouse/pull/79982) ([Nikolay Degterinsky](https://github.com/evillique)).
* Настройка `allow_experimental_join_condition` помечена как устаревшая, поскольку соответствующее поведение теперь всегда разрешено. [#80566](https://github.com/ClickHouse/ClickHouse/pull/80566) ([Vladimir Cherkasov](https://github.com/vdimir)).
* В набор асинхронных метрик ClickHouse добавлены метрики нагрузки. [#80779](https://github.com/ClickHouse/ClickHouse/pull/80779) ([Xander Garbett](https://github.com/Garbett1)).
* Добавлены метрики `MarkCacheEvictedBytes`, `MarkCacheEvictedMarks`, `MarkCacheEvictedFiles` для отслеживания удалений элементов из кэша меток (mark cache). (issue [#60989](https://github.com/ClickHouse/ClickHouse/issues/60989)). [#80799](https://github.com/ClickHouse/ClickHouse/pull/80799) ([Shivji Kumar Jha](https://github.com/shiv4289)).
* Добавлена поддержка записи enum Parquet в виде массива байтов, как предписывает [спецификация](https://github.com/apache/parquet-format/blob/master/LogicalTypes.md#enum). [#81090](https://github.com/ClickHouse/ClickHouse/pull/81090) ([Arthur Passos](https://github.com/arthurpassos)).
* Улучшение для движка таблиц `DeltaLake`: в delta-kernel-rs появился API `ExpressionVisitor`, который реализован в этом PR и используется для преобразования выражений над столбцами партиционирования (он заменит старый устаревший механизм в delta-kernel-rs, который ранее использовался в нашем коде). В будущем этот `ExpressionVisitor` также позволит реализовать отсечение (pruning), основанное на статистике, а также некоторые проприетарные возможности delta-lake. Кроме того, цель этого изменения — поддержать отсечение по партициям в движке таблиц `DeltaLakeCluster` (результат разобранного выражения — ActionsDAG — будет сериализован и отправлен инициатором вместе с путём к данным, поскольку информация, необходимая для отсечения, доступна только как метаинформация при перечислении файлов данных, которое выполняется только инициатором, но при этом должна применяться к данным на каждом сервере чтения). [#81136](https://github.com/ClickHouse/ClickHouse/pull/81136) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Сохранять имена элементов при выводе супертипов для именованных кортежей. [#81345](https://github.com/ClickHouse/ClickHouse/pull/81345) ([lgbo](https://github.com/lgbo-ustc)).
* Подсчитывать вручную количество потреблённых сообщений, чтобы избежать зависимости от ранее зафиксированного смещения в StorageKafka2. [#81662](https://github.com/ClickHouse/ClickHouse/pull/81662) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Добавлен `clickhouse-keeper-utils` — новый инструмент командной строки для управления и анализа данных ClickHouse Keeper. Инструмент поддерживает создание дампа состояния из snapshots и changelogs, анализ файлов changelog и извлечение определённых диапазонов записей журнала. [#81677](https://github.com/ClickHouse/ClickHouse/pull/81677) ([Antonio Andelic](https://github.com/antonio2368)).
* Глобальные и пользовательские ограничители сетевой пропускной способности никогда не сбрасываются, что гарантирует, что лимиты `max_network_bandwidth_for_all_users` и `max_network_bandwidth_for_all_users` никогда не превышаются. [#81729](https://github.com/ClickHouse/ClickHouse/pull/81729) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена поддержка записи в формат GeoParquet. [#81784](https://github.com/ClickHouse/ClickHouse/pull/81784) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Запрещён запуск мутации ALTER с `RENAME COLUMN`, если она должна переименовать столбец, который в данный момент затронут незавершённой мутацией данных. [#81823](https://github.com/ClickHouse/ClickHouse/pull/81823) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Заголовок Connection отправляется в конце заголовков, когда уже известно, следует ли сохранять соединение. [#81951](https://github.com/ClickHouse/ClickHouse/pull/81951) ([Sema Checherinda](https://github.com/CheSema)).
* Очередь TCP-серверов (по умолчанию 64) настроена в соответствии со значением listen&#95;backlog (по умолчанию 4096). [#82045](https://github.com/ClickHouse/ClickHouse/pull/82045) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена возможность перезагружать `max_local_read_bandwidth_for_server` и `max_local_write_bandwidth_for_server` на лету, без перезапуска сервера. [#82083](https://github.com/ClickHouse/ClickHouse/pull/82083) ([Kai Zhu](https://github.com/nauu)).
* Добавлена поддержка очистки всех предупреждений в таблице `system.warnings` с помощью `TRUNCATE TABLE system.warnings`. [#82087](https://github.com/ClickHouse/ClickHouse/pull/82087) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлено отсечение партиций при работе кластерных функций с data lake. [#82131](https://github.com/ClickHouse/ClickHouse/pull/82131) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено чтение партиционированных данных в табличной функции DeltaLakeCluster. В этом PR повышена версия протокола для кластерных функций, что позволяет отправлять дополнительную информацию от инициатора к репликам. Эта дополнительная информация содержит выражение преобразования delta-kernel, которое требуется для разбора столбцов партиционирования (а также некоторых других сущностей в будущем, например генерируемых столбцов и т.д.). [#82132](https://github.com/ClickHouse/ClickHouse/pull/82132) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Функция `reinterpret` теперь поддерживает преобразование в `Array(T)`, где `T` — тип данных фиксированного размера (issue [#82621](https://github.com/ClickHouse/ClickHouse/issues/82621)). [#83399](https://github.com/ClickHouse/ClickHouse/pull/83399) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Теперь база данных Datalake генерирует более понятное исключение. Исправляет [#81211](https://github.com/ClickHouse/ClickHouse/issues/81211). [#82304](https://github.com/ClickHouse/ClickHouse/pull/82304) ([alesapin](https://github.com/alesapin)).
* Улучшен `CROSS JOIN` путём возвращения значения `false` из `HashJoin::needUsedFlagsForPerRightTableRow`. [#82379](https://github.com/ClickHouse/ClickHouse/pull/82379) ([lgbo](https://github.com/lgbo-ustc)).
* Добавлена возможность записи и чтения столбцов типа Map в виде массива кортежей (Array of Tuples). [#82408](https://github.com/ClickHouse/ClickHouse/pull/82408) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Добавлен вывод лицензий [Rust](https://clickhouse.com/blog/rust)-крейтов в таблицу `system.licenses`. [#82440](https://github.com/ClickHouse/ClickHouse/pull/82440) ([Raúl Marín](https://github.com/Algunenano)).
* Макросы, такие как `{uuid}`, теперь могут использоваться в параметре `keeper_path` движка таблицы S3Queue. [#82463](https://github.com/ClickHouse/ClickHouse/pull/82463) ([Nikolay Degterinsky](https://github.com/evillique)).
* Улучшение в Keeper: перенос файлов журнала изменений между дисками в фоновом потоке. Ранее перенос журнала изменений на другой диск полностью блокировал работу Keeper до завершения операции. Это приводило к деградации производительности, если операция занимала много времени (например, при переносе на диск S3). [#82485](https://github.com/ClickHouse/ClickHouse/pull/82485) ([Antonio Andelic](https://github.com/antonio2368)).
* Улучшение в Keeper: добавлена новая настройка `keeper_server.cleanup_old_and_ignore_new_acl`. Если она включена, у всех узлов будет очищен ACL, а ACL для новых запросов будет игнорироваться. Если цель — полностью удалить ACL с узлов, важно оставить эту настройку включённой до тех пор, пока не будет создан новый снимок. [#82496](https://github.com/ClickHouse/ClickHouse/pull/82496) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена новая серверная настройка `s3queue_disable_streaming`, которая отключает стриминг в таблицах с табличным движком S3Queue. Эту настройку можно изменять без перезапуска сервера. [#82515](https://github.com/ClickHouse/ClickHouse/pull/82515) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Рефакторинг механизма динамического изменения размера файлового кэша. Добавлено больше логирования для анализа. [#82556](https://github.com/ClickHouse/ClickHouse/pull/82556) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `clickhouse-server` без файла конфигурации также будет прослушивать порт PostgreSQL 9005, как и при использовании конфигурации по умолчанию. [#82633](https://github.com/ClickHouse/ClickHouse/pull/82633) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* В `ReplicatedMergeTree::executeMetadataAlter` мы получаем `StorageID` и, не захватывая `DDLGuard`, пытаемся вызвать `IDatabase::alterTable`. За это время мы теоретически могли заменить рассматриваемую таблицу другой, так что при получении определения таблицы можем получить неверное. Чтобы избежать этого, мы добавляем отдельную проверку на совпадение UUID при вызове `IDatabase::alterTable`. [#82666](https://github.com/ClickHouse/ClickHouse/pull/82666) ([Nikolay Degterinsky](https://github.com/evillique)).
* При подключении базы данных с удалённым диском в режиме только для чтения необходимо вручную добавить UUID таблиц в DatabaseCatalog. [#82670](https://github.com/ClickHouse/ClickHouse/pull/82670) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Запрещено использование значений `nan` и `inf` в `NumericIndexedVector`. Исправляет [#82239](https://github.com/ClickHouse/ClickHouse/issues/82239) и некоторые сопутствующие случаи. [#82681](https://github.com/ClickHouse/ClickHouse/pull/82681) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Не опускайте нулевые значения в форматах заголовков `X-ClickHouse-Progress` и `X-ClickHouse-Summary`. [#82727](https://github.com/ClickHouse/ClickHouse/pull/82727) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Улучшение в Keeper: добавлена поддержка конкретных прав доступа для ACL world:anyone. [#82755](https://github.com/ClickHouse/ClickHouse/pull/82755) ([Antonio Andelic](https://github.com/antonio2368)).
* Запрещено выполнять `RENAME COLUMN` или `DROP COLUMN` для столбцов, явно перечисленных в `columns_to_sum` в SummingMergeTree. Закрывает [#81836](https://github.com/ClickHouse/ClickHouse/issues/81836). [#82821](https://github.com/ClickHouse/ClickHouse/pull/82821) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшена точность преобразования значений из `Decimal` в `Float32`. Реализовано преобразование из `Decimal` в `BFloat16`. Закрывает [#82660](https://github.com/ClickHouse/ClickHouse/issues/82660). [#82823](https://github.com/ClickHouse/ClickHouse/pull/82823) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Полосы прокрутки в веб-интерфейсе станут выглядеть немного лучше. [#82869](https://github.com/ClickHouse/ClickHouse/pull/82869) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* `clickhouse-server` со встроенной конфигурацией позволит использовать веб-интерфейс, возвращая HTTP-ответ OPTIONS. [#82870](https://github.com/ClickHouse/ClickHouse/pull/82870) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка указания дополнительных ACL для Keeper для путей в конфигурации. Чтобы добавить дополнительные ACL для конкретного пути, укажите их в конфигурации в параметре `zookeeper.path_acls`. [#82898](https://github.com/ClickHouse/ClickHouse/pull/82898) ([Antonio Andelic](https://github.com/antonio2368)).
* Теперь снимок мутаций будет формироваться из снимка видимых частей. Также счётчики мутаций, используемые в снимке, будут пересчитаны на основе включённых в него мутаций. [#82945](https://github.com/ClickHouse/ClickHouse/pull/82945) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Добавлено событие ProfileEvent, фиксирующее случаи, когда Keeper отклоняет запись из‑за мягкого ограничения по памяти. [#82963](https://github.com/ClickHouse/ClickHouse/pull/82963) ([Xander Garbett](https://github.com/Garbett1)).
* Добавлены столбцы `commit_time`, `commit_id` в таблицу `system.s3queue_log`. [#83016](https://github.com/ClickHouse/ClickHouse/pull/83016) ([Kseniia Sumarokova](https://github.com/kssenii)).
* В некоторых случаях нам нужно учитывать несколько измерений для наших метрик. Например, считать неудачные слияния или мутации по кодам ошибок, а не вести один общий счётчик. Представляем `system.dimensional_metrics`, который делает именно это и добавляет первую размерную метрику под названием `failed_merges`. [#83030](https://github.com/ClickHouse/ClickHouse/pull/83030) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Предупреждения о неизвестных настройках в clickhouse-client теперь объединяются и записываются в журнал в виде сводки. [#83042](https://github.com/ClickHouse/ClickHouse/pull/83042) ([Bharat Nallan](https://github.com/bharatnc)).
* Клиент ClickHouse теперь выводит локальный порт при возникновении ошибки подключения. [#83050](https://github.com/ClickHouse/ClickHouse/pull/83050) ([Jianfei Hu](https://github.com/incfly)).
* Незначительно улучшена обработка ошибок в `AsynchronousMetrics`. Если каталог `/sys/block` существует, но недоступен, сервер будет запущен без мониторинга блочных устройств. Закрывает [#79229](https://github.com/ClickHouse/ClickHouse/issues/79229). [#83115](https://github.com/ClickHouse/ClickHouse/pull/83115) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Завершать работу SystemLogs после обычных таблиц (и перед системными таблицами, вместо того чтобы делать это перед обычными). [#83134](https://github.com/ClickHouse/ClickHouse/pull/83134) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлено логирование процесса остановки `S3Queue`. [#83163](https://github.com/ClickHouse/ClickHouse/pull/83163) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Возможность разбора значений типов `Time` и `Time64` как `MM:SS`, `M:SS`, `SS` или `S`. [#83299](https://github.com/ClickHouse/ClickHouse/pull/83299) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Когда `distributed_ddl_output_mode='*_only_active'`, не ждать появления новых или восстановленных реплик, у которых лаг репликации больше, чем `max_replication_lag_to_enqueue`. Это должно помочь избежать ошибки `DDL task is not finished on some hosts`, когда новая реплика становится активной после завершения инициализации или восстановления, но за это время накопила большой журнал репликации. Также реализован запрос `SYSTEM SYNC DATABASE REPLICA STRICT`, который ждёт, пока журнал репликации не станет меньше значения `max_replication_lag_to_enqueue`. [#83302](https://github.com/ClickHouse/ClickHouse/pull/83302) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Не выводить слишком длинные описания действий выражений в сообщениях об исключениях. Закрывает [#83164](https://github.com/ClickHouse/ClickHouse/issues/83164). [#83350](https://github.com/ClickHouse/ClickHouse/pull/83350) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность парсить префикс и суффикс парта, а также проверять покрытие для неконстантных столбцов. [#83377](https://github.com/ClickHouse/ClickHouse/pull/83377) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Унифицированы названия параметров в ODBC и JDBC при работе с именованными коллекциями. [#83410](https://github.com/ClickHouse/ClickHouse/pull/83410) ([Andrey Zvonov](https://github.com/zvonand)).
* Когда хранилище завершает работу, `getStatus` выбрасывает исключение `ErrorCodes::ABORTED`. Ранее это приводило к ошибке выполнения запроса `SELECT`. Теперь мы перехватываем исключения `ErrorCodes::ABORTED` и намеренно их игнорируем. [#83435](https://github.com/ClickHouse/ClickHouse/pull/83435) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Добавлены метрики ресурсов процесса (такие как `UserTimeMicroseconds`, `SystemTimeMicroseconds`, `RealTimeMicroseconds`) в события профилирования part&#95;log для записей `MergeParts`. [#83460](https://github.com/ClickHouse/ClickHouse/pull/83460) ([Vladimir Cherkasov](https://github.com/vdimir)).
* В Keeper по умолчанию включены флаги функциональности `create_if_not_exists`, `check_not_exists`, `remove_recursive`, которые позволяют использовать новые типы запросов. [#83488](https://github.com/ClickHouse/ClickHouse/pull/83488) ([Antonio Andelic](https://github.com/antonio2368)).
* Останавливайте стриминг очереди S3 (Azure/и т.п.) перед остановкой любых таблиц при выключении сервера. [#83530](https://github.com/ClickHouse/ClickHouse/pull/83530) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Включить поддержку типов `Date`/`Date32` в виде целых чисел во входных форматах `JSON`. [#83597](https://github.com/ClickHouse/ClickHouse/pull/83597) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Сообщения об исключениях в некоторых ситуациях при загрузке и добавлении проекций сделаны более понятными. [#83728](https://github.com/ClickHouse/ClickHouse/pull/83728) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлен параметр конфигурации, позволяющий отключить проверку целостности бинарника по контрольной сумме для `clickhouse-server`. Закрывает [#83637](https://github.com/ClickHouse/ClickHouse/issues/83637). [#83749](https://github.com/ClickHouse/ClickHouse/pull/83749) ([Rafael Roquetto](https://github.com/rafaelroquetto)).





#### Исправление ошибки (некорректное поведение, видимое пользователю, в официальном стабильном релизе)

* Исправлено неверное значение по умолчанию для опции `--reconnect` в `clickhouse-benchmark`. Оно было изменено по ошибке в [#79465](https://github.com/ClickHouse/ClickHouse/issues/79465). [#82677](https://github.com/ClickHouse/ClickHouse/pull/82677) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено неконсистентное форматирование оператора `CREATE DICTIONARY`. Закрывает [#82105](https://github.com/ClickHouse/ClickHouse/issues/82105). [#82829](https://github.com/ClickHouse/ClickHouse/pull/82829) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено неконсистентное форматирование TTL, когда в нём используется функция `materialize`. Закрывает [#82828](https://github.com/ClickHouse/ClickHouse/issues/82828). [#82831](https://github.com/ClickHouse/ClickHouse/pull/82831) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено непоследовательное форматирование `EXPLAIN AST` в подзапросе, если он содержит опции вывода, такие как `INTO OUTFILE`. Закрывает [#82826](https://github.com/ClickHouse/ClickHouse/issues/82826). [#82840](https://github.com/ClickHouse/ClickHouse/pull/82840) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено несогласованное форматирование выражений в скобках с псевдонимами в контексте, где использование псевдонимов не допускается. Закрывает [#82836](https://github.com/ClickHouse/ClickHouse/issues/82836). Закрывает [#82837](https://github.com/ClickHouse/ClickHouse/issues/82837). [#82867](https://github.com/ClickHouse/ClickHouse/pull/82867) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Теперь используется корректный код ошибки при умножении состояния агрегатной функции на IPv4. Закрывает [#82817](https://github.com/ClickHouse/ClickHouse/issues/82817). [#82818](https://github.com/ClickHouse/ClickHouse/pull/82818) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена логическая ошибка в файловом кэше: &quot;Having zero bytes but range is not finished&quot;. [#81868](https://github.com/ClickHouse/ClickHouse/pull/81868) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Пересчитывает индекс min-max при удалении строк по TTL, чтобы обеспечить корректность алгоритмов, зависящих от него, таких как `minmax_count_projection`. Это исправляет [#77091](https://github.com/ClickHouse/ClickHouse/issues/77091). [#77166](https://github.com/ClickHouse/ClickHouse/pull/77166) ([Amos Bird](https://github.com/amosbird)).
* Для запросов с сочетанием `ORDER BY ... LIMIT BY ... LIMIT N`, когда ORDER BY выполняется в режиме PartialSorting, счётчик `rows_before_limit_at_least` теперь отражает количество строк, потреблённых оператором LIMIT, вместо количества строк, обработанных преобразованием сортировки. [#78999](https://github.com/ClickHouse/ClickHouse/pull/78999) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлено избыточное пропускание гранул при фильтрации по token/ngram-индексам с использованием регулярного выражения, содержащего альтернативы, где первая альтернатива не является литеральной. [#79373](https://github.com/ClickHouse/ClickHouse/pull/79373) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлена логическая ошибка при использовании оператора `<=>` с хранилищем Join, теперь запрос возвращает корректный код ошибки. [#80165](https://github.com/ClickHouse/ClickHouse/pull/80165) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлен сбой в функции `loop` при использовании с семейством функций `remote`. Теперь в `loop(remote(...))` корректно соблюдается оператор LIMIT. [#80299](https://github.com/ClickHouse/ClickHouse/pull/80299) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлено некорректное поведение функций `to_utc_timestamp` и `from_utc_timestamp` при обработке дат до эпохи Unix (1970-01-01) и после максимально допустимой даты (2106-02-07 06:28:15). Теперь эти функции корректно ограничивают значения началом эпохи Unix и максимально допустимой датой соответственно. [#80498](https://github.com/ClickHouse/ClickHouse/pull/80498) ([Surya Kant Ranjan](https://github.com/iit2009046)).
* Для некоторых запросов с параллельными репликами оптимизации чтения в заданном порядке могут быть применены на инициаторе, но не могут быть применены на удалённых узлах. Это приводит к тому, что координатор параллельных реплик (на инициаторе) и удалённые узлы используют разные режимы чтения, что является логической ошибкой. [#80652](https://github.com/ClickHouse/ClickHouse/pull/80652) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлена логическая ошибка при материализации проекции, возникавшая при изменении типа столбца на Nullable. [#80741](https://github.com/ClickHouse/ClickHouse/pull/80741) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен некорректный перерасчёт TTL в `TTL GROUP BY` при обновлении TTL. [#81222](https://github.com/ClickHouse/ClickHouse/pull/81222) ([Evgeniy Ulasik](https://github.com/H0uston)).
* Исправлена ошибка в bloom-фильтре Parquet, из-за которой условие вида `WHERE function(key) IN (...)` неверно обрабатывалось как `WHERE key IN (...)`. [#81255](https://github.com/ClickHouse/ClickHouse/pull/81255) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлено возможное аварийное завершение `Aggregator` при возникновении исключения во время слияния. [#81450](https://github.com/ClickHouse/ClickHouse/pull/81450) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлен `InterpreterInsertQuery::extendQueryLogElemImpl`, чтобы при необходимости добавлять обратные кавычки к именам баз данных и таблиц (например, в случаях, когда имена содержат специальные символы, такие как `-`). [#81528](https://github.com/ClickHouse/ClickHouse/pull/81528) ([Ilia Shvyrialkin](https://github.com/Harzu)).
* Исправлено выполнение `IN` при `transform_null_in=1` с `NULL` в левом аргументе и результатом подзапроса, не допускающим `NULL`. [#81584](https://github.com/ClickHouse/ClickHouse/pull/81584) ([Pavel Kruglov](https://github.com/Avogar)).
* Не выполнять проверку экспериментальных/подозрительных типов данных при выполнении выражений `DEFAULT`/`MATERIALIZE` во время чтения из существующей таблицы. [#81618](https://github.com/ClickHouse/ClickHouse/pull/81618) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка &quot;Context has expired&quot; при слияниях, когда словарь используется в выражении TTL. [#81690](https://github.com/ClickHouse/ClickHouse/pull/81690) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена монотонность функции `cast`. [#81722](https://github.com/ClickHouse/ClickHouse/pull/81722) ([zoomxi](https://github.com/zoomxi)).
* Исправлена проблема, из-за которой обязательные столбцы не считывались при обработке скалярного коррелированного подзапроса. Устраняет [#81716](https://github.com/ClickHouse/ClickHouse/issues/81716). [#81805](https://github.com/ClickHouse/ClickHouse/pull/81805) ([Dmitry Novik](https://github.com/novikd)).
* В предыдущих версиях сервер возвращал избыточный объём данных для запросов к `/js`. Устраняет проблему [#61890](https://github.com/ClickHouse/ClickHouse/issues/61890). [#81895](https://github.com/ClickHouse/ClickHouse/pull/81895) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Ранее определения движка таблиц `MongoDB` могли включать компонент пути в аргументе `host:port`, который тихо игнорировался. Интеграция с MongoDB отказывалась загружать такие таблицы. С этим исправлением *мы допускаем загрузку таких таблиц и игнорируем компонент пути*, если движок `MongoDB` имеет пять аргументов, используя имя базы данных из аргументов. *Примечание:* исправление не применяется к вновь создаваемым таблицам или запросам с табличной функцией `mongo`, а также к источникам словарей и именованным коллекциям. [#81942](https://github.com/ClickHouse/ClickHouse/pull/81942) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлена потенциальная аварийная остановка `Aggregator` при возникновении исключения при слиянии. [#82022](https://github.com/ClickHouse/ClickHouse/pull/82022) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлен анализ условия фильтрации, когда в запросе используется только столбец-псевдоним с константой. Исправляет [#79448](https://github.com/ClickHouse/ClickHouse/issues/79448). [#82037](https://github.com/ClickHouse/ClickHouse/pull/82037) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена ошибка LOGICAL&#95;ERROR и последующее падение при использовании одного и того же столбца в TTL для GROUP BY и SET. [#82054](https://github.com/ClickHouse/ClickHouse/pull/82054) ([Pablo Marcos](https://github.com/pamarcos)).
* Исправлена валидация аргументов табличной функции S3 в механизме маскирования секретов, что предотвращает возможную ошибку `LOGICAL_ERROR`, закрыта [#80620](https://github.com/ClickHouse/ClickHouse/issues/80620). [#82056](https://github.com/ClickHouse/ClickHouse/pull/82056) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Устранены гонки данных в Iceberg. [#82088](https://github.com/ClickHouse/ClickHouse/pull/82088) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена `DatabaseReplicated::getClusterImpl`. Если первый элемент (или несколько первых элементов) массива `hosts` имеет `id == DROPPED_MARK` и нет других элементов для того же шарда, первый элемент `shards` будет пустым вектором, что приводит к выбросу исключения `std::out_of_range`. [#82093](https://github.com/ClickHouse/ClickHouse/pull/82093) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Исправлена ошибка копирования и вставки в arraySimilarity, запрещено использование весов типов UInt32 и Int32. Обновлены тесты и документация. [#82103](https://github.com/ClickHouse/ClickHouse/pull/82103) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Исправлена ошибка `Not found column` в запросах с `arrayJoin` в условии `WHERE` и при использовании `IndexSet`. [#82113](https://github.com/ClickHouse/ClickHouse/pull/82113) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка в интеграции с Glue Catalog. Теперь ClickHouse может читать таблицы с вложенными типами данных, где некоторые из подстолбцов имеют тип Decimal, например: `map<string, decimal(9, 2)>`. Исправляет [#81301](https://github.com/ClickHouse/ClickHouse/issues/81301). [#82114](https://github.com/ClickHouse/ClickHouse/pull/82114) ([alesapin](https://github.com/alesapin)).
* Исправлено ухудшение производительности в SummingMergeTree, появившееся в 25.5 из‑за [https://github.com/ClickHouse/ClickHouse/pull/79051](https://github.com/ClickHouse/ClickHouse/pull/79051). [#82130](https://github.com/ClickHouse/ClickHouse/pull/82130) ([Pavel Kruglov](https://github.com/Avogar)).
* При передаче настроек через URI учитывается только последнее значение. [#82137](https://github.com/ClickHouse/ClickHouse/pull/82137) ([Sema Checherinda](https://github.com/CheSema)).
* Исправлена ошибка «Context has expired» в Iceberg. [#82146](https://github.com/ClickHouse/ClickHouse/pull/82146) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена возможная взаимная блокировка для удалённых запросов, возникающая при недостатке памяти на сервере. [#82160](https://github.com/ClickHouse/ClickHouse/pull/82160) ([Kirill](https://github.com/kirillgarbar)).
* Исправлено переполнение в функциях `numericIndexedVectorPointwiseAdd`, `numericIndexedVectorPointwiseSubtract`, `numericIndexedVectorPointwiseMultiply`, `numericIndexedVectorPointwiseDivide`, которое происходило при работе с большими числами. [#82165](https://github.com/ClickHouse/ClickHouse/pull/82165) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Исправлена ошибка в зависимостях таблиц, из-за которой материализованные представления пропускали INSERT-запросы. [#82222](https://github.com/ClickHouse/ClickHouse/pull/82222) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена потенциальная гонка данных между потоком подсказок и основным потоком клиента. [#82233](https://github.com/ClickHouse/ClickHouse/pull/82233) ([Azat Khuzhin](https://github.com/azat)).
* Теперь ClickHouse может читать таблицы Iceberg из каталога Glue после изменения схемы. Исправлена проблема [#81272](https://github.com/ClickHouse/ClickHouse/issues/81272). [#82301](https://github.com/ClickHouse/ClickHouse/pull/82301) ([alesapin](https://github.com/alesapin)).
* Исправлена валидация настроек асинхронных метрик `asynchronous_metrics_update_period_s` и `asynchronous_heavy_metrics_update_period_s`. [#82310](https://github.com/ClickHouse/ClickHouse/pull/82310) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлена логическая ошибка при определении сопоставителя в запросе с несколькими JOIN, закрыт [#81969](https://github.com/ClickHouse/ClickHouse/issues/81969). [#82421](https://github.com/ClickHouse/ClickHouse/pull/82421) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Добавлено время жизни токена AWS ECS, чтобы его можно было обновлять. [#82422](https://github.com/ClickHouse/ClickHouse/pull/82422) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлена ошибка обработки аргументов `NULL` в функции `CASE`. [#82436](https://github.com/ClickHouse/ClickHouse/pull/82436) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлены гонки данных в клиенте (за счёт отказа от использования глобального контекста) и переопределения `session_timezone` (ранее если `session_timezone` был установлен, например, в `users.xml`/опциях клиента в непустое значение, а в контексте запроса — в пустое, использовалось значение из `users.xml`, что было неверно; теперь контекст запроса всегда имеет приоритет над глобальным контекстом). [#82444](https://github.com/ClickHouse/ClickHouse/pull/82444) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа отключения выравнивания по границе для кэшированного буфера во внешних движках таблиц. Ошибка была внесена в [https://github.com/ClickHouse/ClickHouse/pull/81868](https://github.com/ClickHouse/ClickHouse/pull/81868). [#82493](https://github.com/ClickHouse/ClickHouse/pull/82493) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено падение при объединении хранилища ключ-значение с ключом, приведённым к другому типу. [#82497](https://github.com/ClickHouse/ClickHouse/pull/82497) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлена проблема со скрытием значений именованных коллекций в logs/query&#95;log. Закрывает [#82405](https://github.com/ClickHouse/ClickHouse/issues/82405). [#82510](https://github.com/ClickHouse/ClickHouse/pull/82510) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено возможное падение при логировании при завершении сессии, поскольку `user_id` иногда мог быть пустым. [#82513](https://github.com/ClickHouse/ClickHouse/pull/82513) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправляет проблему, из-за которой разбор `Time` мог приводить к ошибкам msan. Это исправляет: [#82477](https://github.com/ClickHouse/ClickHouse/issues/82477). [#82514](https://github.com/ClickHouse/ClickHouse/pull/82514) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Запрещена установка параметра `threadpool_writer_pool_size` в ноль, чтобы операции сервера не зависали. [#82532](https://github.com/ClickHouse/ClickHouse/pull/82532) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлен `LOGICAL_ERROR` при анализе выражения политики строк для коррелированных столбцов. [#82618](https://github.com/ClickHouse/ClickHouse/pull/82618) ([Dmitry Novik](https://github.com/novikd)).
* Исправлено некорректное использование метаданных родительской таблицы в табличной функции `mergeTreeProjection`, когда `enable_shared_storage_snapshot_in_query = 1`. Относится к [#82634](https://github.com/ClickHouse/ClickHouse/issues/82634). [#82638](https://github.com/ClickHouse/ClickHouse/pull/82638) ([Amos Bird](https://github.com/amosbird)).
* Функции `trim{Left,Right,Both}` теперь поддерживают строки входных данных типа «FixedString(N)». Например, `SELECT trimBoth(toFixedString('abc', 3), 'ac')` теперь работает. [#82691](https://github.com/ClickHouse/ClickHouse/pull/82691) ([Robert Schulze](https://github.com/rschu1ze)).
* В AzureBlobStorage для нативного копирования мы сравниваем методы аутентификации, и если при этом возникает исключение, код теперь выполняет переход к чтению и копированию (то есть к ненативному копированию). [#82693](https://github.com/ClickHouse/ClickHouse/pull/82693) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Исправлена десериализация `groupArraySample`/`groupArrayLast` в случае пустых элементов (при десериализации могла быть пропущена часть бинарных данных, если входные данные были пустыми, что могло приводить к повреждению данных при чтении и к UNKNOWN&#95;PACKET&#95;FROM&#95;SERVER в протоколе TCP). Это не затрагивает числовые типы и типы даты и времени. [#82763](https://github.com/ClickHouse/ClickHouse/pull/82763) ([Pedro Ferreira](https://github.com/PedroTadim)).
* Исправлена проблема с созданием резервной копии пустой таблицы `Memory`, из-за которой восстановление резервной копии завершалось с ошибкой `BACKUP_ENTRY_NOT_FOUND`. [#82791](https://github.com/ClickHouse/ClickHouse/pull/82791) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлена безопасность при обработке исключений в переписывании union/intersect/except&#95;default&#95;mode. Закрывает [#82664](https://github.com/ClickHouse/ClickHouse/issues/82664). [#82820](https://github.com/ClickHouse/ClickHouse/pull/82820) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Отслеживать количество заданий асинхронной загрузки таблиц. Если какие‑либо задания выполняются, не обновлять `tail_ptr` в `TransactionLog::removeOldEntries`. [#82824](https://github.com/ClickHouse/ClickHouse/pull/82824) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлены гонки данных в Iceberg. [#82841](https://github.com/ClickHouse/ClickHouse/pull/82841) ([Azat Khuzhin](https://github.com/azat)).
* Оптимизация `use_skip_indexes_if_final_exact_mode` (введённая в 25.6) могла не выбирать соответствующий диапазон кандидатов в зависимости от настроек движка `MergeTree` и распределения данных. Теперь это исправлено. [#82879](https://github.com/ClickHouse/ClickHouse/pull/82879) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Установлена соль для данных аутентификации при разборе AST с типом SCRAM&#95;SHA256&#95;PASSWORD. [#82888](https://github.com/ClickHouse/ClickHouse/pull/82888) ([Tuan Pham Anh](https://github.com/tuanpach)).
* При использовании реализации Database без кэширования метаданные соответствующей таблицы удаляются после возврата столбцов и инвалидации ссылки. [#82939](https://github.com/ClickHouse/ClickHouse/pull/82939) ([buyval01](https://github.com/buyval01)).
* Исправлена модификация фильтра в запросах с выражением JOIN и таблицей с движком `Merge`. Устраняет проблему [#82092](https://github.com/ClickHouse/ClickHouse/issues/82092). [#82950](https://github.com/ClickHouse/ClickHouse/pull/82950) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена LOGICAL&#95;ERROR в QueryMetricLog: мьютекс не может быть NULL. [#82979](https://github.com/ClickHouse/ClickHouse/pull/82979) ([Pablo Marcos](https://github.com/pamarcos)).
* Исправлен некорректный вывод функции `formatDateTime` при использовании спецификатора формата `%f` совместно со спецификаторами переменной длины (например, `%M`). [#83020](https://github.com/ClickHouse/ClickHouse/pull/83020) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена деградация производительности при включённом анализаторе, возникавшая, когда вторичные запросы всегда читали все столбцы из представлений (VIEW). Исправляет [#81718](https://github.com/ClickHouse/ClickHouse/issues/81718). [#83036](https://github.com/ClickHouse/ClickHouse/pull/83036) ([Dmitry Novik](https://github.com/novikd)).
* Исправлено некорректное сообщение об ошибке при восстановлении резервной копии на диске, доступном только для чтения. [#83051](https://github.com/ClickHouse/ClickHouse/pull/83051) ([Julia Kartseva](https://github.com/jkartseva)).
* Больше не выполняется проверка на циклические зависимости при создании таблиц без зависимостей. Это исправляет деградацию производительности в сценариях, связанных с созданием тысяч таблиц, которая была внесена изменением [https://github.com/ClickHouse/ClickHouse/pull/65405](https://github.com/ClickHouse/ClickHouse/pull/65405). [#83077](https://github.com/ClickHouse/ClickHouse/pull/83077) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена проблема неявного чтения отрицательных значений типа Time в таблицу и сделана документация более понятной. [#83091](https://github.com/ClickHouse/ClickHouse/pull/83091) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Не используйте несвязанные между собой части общего словаря в функции `lowCardinalityKeys`. [#83118](https://github.com/ClickHouse/ClickHouse/pull/83118) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена регрессия, связанная с использованием подколонок в материализованных представлениях. Исправлено: [#82784](https://github.com/ClickHouse/ClickHouse/issues/82784). [#83221](https://github.com/ClickHouse/ClickHouse/pull/83221) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлен сбой в клиенте из-за того, что соединение оставалось в отключённом состоянии после ошибочного запроса INSERT. [#83253](https://github.com/ClickHouse/ClickHouse/pull/83253) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен сбой при вычислении размера блока с пустыми столбцами. [#83271](https://github.com/ClickHouse/ClickHouse/pull/83271) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена возможная аварийная остановка при использовании типа Variant в UNION. [#83295](https://github.com/ClickHouse/ClickHouse/pull/83295) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка LOGICAL&#95;ERROR в clickhouse-local для неподдерживаемых запросов SYSTEM. [#83333](https://github.com/ClickHouse/ClickHouse/pull/83333) ([Surya Kant Ranjan](https://github.com/iit2009046)).
* Исправлен параметр `no_sign_request` для S3‑клиента. Он может использоваться для явного отключения подписи запросов к S3. Его также можно задать для отдельных endpoint-ов с помощью настроек, привязанных к конкретным endpoint-ам. [#83379](https://github.com/ClickHouse/ClickHouse/pull/83379) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка, приводившая к аварийному завершению запроса с настройкой &#39;max&#95;threads=1&#39; при выполнении под нагрузкой и включённом планировании CPU. [#83387](https://github.com/ClickHouse/ClickHouse/pull/83387) ([Fan Ziqi](https://github.com/f2quantum)).
* Исправлено исключение `TOO_DEEP_SUBQUERIES`, возникающее, когда определение CTE ссылается на другое табличное выражение с тем же именем. [#83413](https://github.com/ClickHouse/ClickHouse/pull/83413) ([Dmitry Novik](https://github.com/novikd)).
* Исправлено некорректное поведение, при котором выполнение `REVOKE S3 ON system.*` отзывает привилегии S3 для `*.*`. Это исправляет [#83417](https://github.com/ClickHouse/ClickHouse/issues/83417). [#83420](https://github.com/ClickHouse/ClickHouse/pull/83420) ([pufit](https://github.com/pufit)).
* Не используйте общие async&#95;read&#95;counters между запросами. [#83423](https://github.com/ClickHouse/ClickHouse/pull/83423) ([Azat Khuzhin](https://github.com/azat)).
* Отключены параллельные реплики, если подзапрос содержит FINAL. [#83455](https://github.com/ClickHouse/ClickHouse/pull/83455) ([zoomxi](https://github.com/zoomxi)).
* Исправлено незначительное целочисленное переполнение при конфигурировании настройки `role_cache_expiration_time_seconds` (issue [#83374](https://github.com/ClickHouse/ClickHouse/issues/83374)). [#83461](https://github.com/ClickHouse/ClickHouse/pull/83461) ([wushap](https://github.com/wushap)).
* Исправлена ошибка, внесённая в [https://github.com/ClickHouse/ClickHouse/pull/79963](https://github.com/ClickHouse/ClickHouse/pull/79963). При вставке в MV с definer проверка прав должна использовать привилегии определяющего пользователя (definer). Это исправляет [#79951](https://github.com/ClickHouse/ClickHouse/issues/79951). [#83502](https://github.com/ClickHouse/ClickHouse/pull/83502) ([pufit](https://github.com/pufit)).
* Отключено отсечение файлов по границам для значений элементов массивов Iceberg и значений карт Iceberg, включая все их вложенные подполя. [#83520](https://github.com/ClickHouse/ClickHouse/pull/83520) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлены возможные ошибки «file cache not initialized» при использовании файлового кэша в качестве временного хранилища данных. [#83539](https://github.com/ClickHouse/ClickHouse/pull/83539) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправление в Keeper: корректное обновление общего счётчика наблюдений при удалении эфемерных узлов во время закрытия сессии. [#83583](https://github.com/ClickHouse/ClickHouse/pull/83583) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена некорректная обработка памяти, связанная с `max_untracked_memory`. [#83607](https://github.com/ClickHouse/ClickHouse/pull/83607) ([Azat Khuzhin](https://github.com/azat)).
* INSERT SELECT с UNION ALL мог приводить к разыменованию нулевого указателя в граничном случае. Это закрывает [#83618](https://github.com/ClickHouse/ClickHouse/issues/83618). [#83643](https://github.com/ClickHouse/ClickHouse/pull/83643) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Запрещено использование нулевого значения для max&#95;insert&#95;block&#95;size, поскольку оно может привести к логической ошибке. [#83688](https://github.com/ClickHouse/ClickHouse/pull/83688) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлен бесконечный цикл в estimateCompressionRatio() при block&#95;size&#95;bytes=0. [#83704](https://github.com/ClickHouse/ClickHouse/pull/83704) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены метрики `IndexUncompressedCacheBytes`/`IndexUncompressedCacheCells`/`IndexMarkCacheBytes`/`IndexMarkCacheFiles` (ранее они учитывались в метрике без префикса `Cache`). [#83730](https://github.com/ClickHouse/ClickHouse/pull/83730) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено возможное аварийное завершение процесса (при ожидании завершения потоков задачи) и, возможно, зависания (в модульных тестах) во время завершения работы `BackgroundSchedulePool`. [#83769](https://github.com/ClickHouse/ClickHouse/pull/83769) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена настройка для обеспечения обратной совместимости, позволяющая новому анализатору ссылаться на внешний псевдоним в предложении WITH при конфликте имён. Исправляет [#82700](https://github.com/ClickHouse/ClickHouse/issues/82700). [#83797](https://github.com/ClickHouse/ClickHouse/pull/83797) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена взаимоблокировка при остановке из-за рекурсивной блокировки контекста во время очистки моста библиотек. [#83824](https://github.com/ClickHouse/ClickHouse/pull/83824) ([Azat Khuzhin](https://github.com/azat)).

#### Улучшения сборки/тестирования/упаковки

- Создана минимальная библиотека C (10 КБ) для лексера ClickHouse. Это необходимо для [#80977](https://github.com/ClickHouse/ClickHouse/issues/80977). [#81347](https://github.com/ClickHouse/ClickHouse/pull/81347) ([Alexey Milovidov](https://github.com/alexey-milovidov)). Добавлен тест для автономного лексера, добавлен тег теста `fasttest-only`. [#82472](https://github.com/ClickHouse/ClickHouse/pull/82472) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Добавлена проверка входных данных подмодуля Nix. [#81691](https://github.com/ClickHouse/ClickHouse/pull/81691) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Исправлен ряд проблем, которые могут возникать при попытке запуска интеграционных тестов на localhost. [#82135](https://github.com/ClickHouse/ClickHouse/pull/82135) ([Oleg Doronin](https://github.com/dorooleg)).
- Компиляция SymbolIndex на Mac и FreeBSD. (Но работать будет только на системах ELF, Linux и FreeBSD). [#82347](https://github.com/ClickHouse/ClickHouse/pull/82347) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Обновлен Azure SDK до версии v1.15.0. [#82747](https://github.com/ClickHouse/ClickHouse/pull/82747) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
- Добавлен модуль storage из google-cloud-cpp в систему сборки. [#82881](https://github.com/ClickHouse/ClickHouse/pull/82881) ([Pablo Marcos](https://github.com/pamarcos)).
- Изменен `Dockerfile.ubuntu` для clickhouse-server в соответствии с требованиями Docker Official Library. [#83039](https://github.com/ClickHouse/ClickHouse/pull/83039) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Дополнение к [#83158](https://github.com/ClickHouse/ClickHouse/issues/83158) для исправления загрузки сборок на `curl clickhouse.com`. [#83463](https://github.com/ClickHouse/ClickHouse/pull/83463) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Добавлен бинарный файл `busybox` и инструменты установки в образы `clickhouse/clickhouse-server` и официальные образы `clickhouse`. [#83735](https://github.com/ClickHouse/ClickHouse/pull/83735) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Добавлена поддержка переменной окружения `CLICKHOUSE_HOST` для указания хоста сервера ClickHouse, что согласуется с существующими переменными окружения `CLICKHOUSE_USER` и `CLICKHOUSE_PASSWORD`. Это позволяет упростить конфигурацию без непосредственного изменения клиентских или конфигурационных файлов. [#83659](https://github.com/ClickHouse/ClickHouse/pull/83659) ([Doron David](https://github.com/dorki)).

### Релиз ClickHouse 25.6, 2025-06-26 {#256}

#### Обратно несовместимые изменения

- Ранее функция `countMatches` прекращала подсчет при первом пустом совпадении, даже если шаблон его допускает. Для решения этой проблемы `countMatches` теперь продолжает выполнение, продвигаясь на один символ при возникновении пустого совпадения. Пользователи, желающие сохранить прежнее поведение, могут включить настройку `count_matches_stop_at_empty_match`. [#81676](https://github.com/ClickHouse/ClickHouse/pull/81676) ([Elmi Ahmadov](https://github.com/ahmadov)).
- Незначительное изменение: серверные настройки `backup_threads` и `restore_threads` теперь должны быть ненулевыми. [#80224](https://github.com/ClickHouse/ClickHouse/pull/80224) ([Raúl Marín](https://github.com/Algunenano)).
- Незначительное изменение: исправление `bitNot` для `String` будет возвращать строку с нулевым завершением во внутреннем представлении памяти. Это не должно влиять на видимое пользователю поведение, однако автор хотел выделить это изменение. [#80791](https://github.com/ClickHouse/ClickHouse/pull/80791) ([Azat Khuzhin](https://github.com/azat)).


#### Новая функция

* Новые типы данных: `Time` ([H]HH:MM:SS) и `Time64` ([H]HH:MM:SS[.fractional]), а также некоторые базовые функции приведения типов и функции для взаимодействия с другими типами данных. Добавлены настройки для совместимости с существующей функцией `toTime`. Параметр `use_legacy_to_time` сейчас настроен так, чтобы сохранять старое поведение. [#81217](https://github.com/ClickHouse/ClickHouse/pull/81217) ([Yarik Briukhovetskyi](https://github.com/yariks5s)). Реализована поддержка сравнения значений типов Time и Time64. [#80327](https://github.com/ClickHouse/ClickHouse/pull/80327) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Новый CLI-инструмент [`chdig`](https://github.com/azat/chdig/) — TUI-интерфейс для ClickHouse (аналог `top`), входящий в состав ClickHouse. [#79666](https://github.com/ClickHouse/ClickHouse/pull/79666) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка настройки `disk` для движков баз данных `Atomic` и `Ordinary`, позволяющей указывать диск для хранения файлов метаданных таблиц. [#80546](https://github.com/ClickHouse/ClickHouse/pull/80546) ([Tuan Pham Anh](https://github.com/tuanpach)). Это позволяет подключать базы данных из внешних источников.
* Новый тип MergeTree, `CoalescingMergeTree` — движок берет первое значение, не равное Null, в процессе фоновых слияний. Это закрывает задачу [#78869](https://github.com/ClickHouse/ClickHouse/issues/78869). [#79344](https://github.com/ClickHouse/ClickHouse/pull/79344) ([scanhex12](https://github.com/scanhex12)).
* Поддержка функций для чтения WKB (&quot;Well-Known Binary&quot; — формат двоичного представления различных типов геометрий, используемый в GIS-приложениях). См. [#43941](https://github.com/ClickHouse/ClickHouse/issues/43941). [#80139](https://github.com/ClickHouse/ClickHouse/pull/80139) ([scanhex12](https://github.com/scanhex12)).
* Добавлено планирование слотов для запросов в рамках рабочих нагрузок, подробности см. в разделе [планирование рабочих нагрузок](https://clickhouse.com/docs/operations/workload-scheduling#query_scheduling). [#78415](https://github.com/ClickHouse/ClickHouse/pull/78415) ([Sergei Trifonov](https://github.com/serxa)).
* Вспомогательные функции `timeSeries*` для ускорения некоторых сценариев работы с временными рядами данных: - ресемплирование данных на временную сетку с заданными начальной и конечной метками времени и шагом - вычисление PromQL-подобных `delta`, `rate`, `idelta` и `irate`. [#80590](https://github.com/ClickHouse/ClickHouse/pull/80590) ([Alexander Gololobov](https://github.com/davenger)).
* Добавлены функции `mapContainsValuesLike`/`mapContainsValues`/`mapExtractValuesLike` для фильтрации по значениям map и их поддержка в индексах на основе фильтра Блума. [#78171](https://github.com/ClickHouse/ClickHouse/pull/78171) ([UnamedRus](https://github.com/UnamedRus)).
* Теперь ограничения для настроек могут задавать набор недопустимых значений. [#78499](https://github.com/ClickHouse/ClickHouse/pull/78499) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлена настройка `enable_shared_storage_snapshot_in_query`, которая позволяет всем подзапросам в одном запросе использовать один и тот же снимок хранилища. Это обеспечивает согласованное чтение из одной и той же таблицы, даже если таблица упоминается в запросе несколько раз. [#79471](https://github.com/ClickHouse/ClickHouse/pull/79471) ([Amos Bird](https://github.com/amosbird)).
* Добавлена поддержка записи столбцов `JSON` в `Parquet` и чтения столбцов `JSON` из `Parquet` напрямую. [#79649](https://github.com/ClickHouse/ClickHouse/pull/79649) ([Nihal Z. Miaji](https://github.com/nihalzp)).
* Добавлена поддержка `MultiPolygon` в `pointInPolygon`. [#79773](https://github.com/ClickHouse/ClickHouse/pull/79773) ([Nihал Z. Miaji](https://github.com/nihalzp)).
* Добавлена поддержка выполнения запросов к таблицам Delta, расположенным на локальной файловой системе, с помощью табличной функции `deltaLakeLocal`. [#79781](https://github.com/ClickHouse/ClickHouse/pull/79781) ([roykim98](https://github.com/roykim98)).
* Добавлена новая настройка `cast_string_to_date_time_mode`, которая позволяет выбрать режим разбора DateTime при приведении из String. [#80210](https://github.com/ClickHouse/ClickHouse/pull/80210) ([Pavel Kruglov](https://github.com/Avogar)). Например, вы можете установить для неё режим best effort.
* Добавлены функции `bech32Encode` и `bech32Decode` для работы с алгоритмом Bech протокола Bitcoin (issue [#40381](https://github.com/ClickHouse/ClickHouse/issues/40381)). [#80239](https://github.com/ClickHouse/ClickHouse/pull/80239) ([George Larionov](https://github.com/glarik)).
* Добавлены SQL-функции для анализа имён частей MergeTree. [#80573](https://github.com/ClickHouse/ClickHouse/pull/80573) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Добавлена возможность фильтровать части, выбранные для запроса, по диску, на котором они находятся, с помощью новой виртуальной колонки `_disk_name`. [#80650](https://github.com/ClickHouse/ClickHouse/pull/80650) ([tanner-bruce](https://github.com/tanner-bruce)).
* Добавлена стартовая страница со списком встроенных веб-инструментов. Она будет открываться при обращении из браузероподобного пользовательского агента. [#81129](https://github.com/ClickHouse/ClickHouse/pull/81129) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Функции `arrayFirst`, `arrayFirstIndex`, `arrayLast` и `arrayLastIndex` теперь отбрасывают значения NULL, возвращаемые выражением фильтрации. В предыдущих версиях результаты фильтрации с типом Nullable не поддерживались. Исправление [#81113](https://github.com/ClickHouse/ClickHouse/issues/81113). [#81197](https://github.com/ClickHouse/ClickHouse/pull/81197) ([Lennard Eijsackers](https://github.com/Blokje5)).
* Теперь можно использовать `USE DATABASE name` вместо `USE name`. [#81307](https://github.com/ClickHouse/ClickHouse/pull/81307) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена новая системная таблица `system.codecs` для получения информации о доступных кодеках. (issue [#81525](https://github.com/ClickHouse/ClickHouse/issues/81525)). [#81600](https://github.com/ClickHouse/ClickHouse/pull/81600) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
* Добавлена поддержка оконных функций `lag` и `lead`. Исправляет [#9887](https://github.com/ClickHouse/ClickHouse/issues/9887). [#82108](https://github.com/ClickHouse/ClickHouse/pull/82108) ([Dmitry Novik](https://github.com/novikd)).
* Функция `tokens` теперь поддерживает новый токенизатор под названием `split`, который хорошо подходит для логов. [#80195](https://github.com/ClickHouse/ClickHouse/pull/80195) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка аргумента `--database` в `clickhouse-local`. Теперь можно переключаться на ранее созданную базу данных. Это закрывает [#44115](https://github.com/ClickHouse/ClickHouse/issues/44115). [#81465](https://github.com/ClickHouse/ClickHouse/pull/81465) ([Alexey Milovidov](https://github.com/alexey-milovidov)).



#### Экспериментальная возможность
* Реализована логика перераспределения партиций Kafka, аналогичная `Kafka2`, с использованием ClickHouse Keeper. Для каждой реплики поддерживаются два типа блокировок партиций: постоянные и временные. Реплика старается удерживать постоянные блокировки как можно дольше; в любой момент времени на реплике не более чем `all_topic_partitions / active_replicas_count` постоянных блокировок (где `all_topic_partitions` — количество всех партиций, `active_replicas_count` — количество активных реплик). Если блокировок становится больше, реплика освобождает часть партиций. Некоторые партиции временно удерживаются репликой. Максимальное количество временных блокировок на реплике динамически изменяется, чтобы дать другим репликам возможность взять часть партиций в постоянные блокировки. При обновлении временных блокировок реплика освобождает их все и пытается снова взять некоторые другие. [#78726](https://github.com/ClickHouse/ClickHouse/pull/78726) ([Daria Fomina](https://github.com/sinfillo)).
* Улучшение для экспериментального текстового индекса: явные параметры поддерживаются через пары ключ–значение. В настоящее время поддерживаются параметры: обязательный `tokenizer` и два необязательных — `max_rows_per_postings_list` и `ngram_size`. [#80262](https://github.com/ClickHouse/ClickHouse/pull/80262) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Ранее хранилище `packed` не поддерживалось для полнотекстового индекса, так как идентификатор сегмента обновлялся «на лету» посредством чтения и записи файла (`.gin_sid`) на диск. В случае хранилища `packed` чтение значения из незакоммиченного файла не поддерживается, что приводило к проблеме. Теперь это исправлено. [#80852](https://github.com/ClickHouse/ClickHouse/pull/80852) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Экспериментальные индексы типа `gin` (которые мне не нравятся, потому что это внутренняя шутка хакеров PostgreSQL) были переименованы в `text`. Существующие индексы типа `gin` по‑прежнему могут быть загружены, но при попытке использовать их в поисковых запросах они будут выбрасывать исключение (с рекомендацией использовать индексы `text`). [#80855](https://github.com/ClickHouse/ClickHouse/pull/80855) ([Robert Schulze](https://github.com/rschu1ze)).



#### Улучшение производительности

* Реализована поддержка фильтрации по нескольким проекциям, позволяющая использовать более одной проекции для фильтрации на уровне частей (part-level filtering). Это решает задачу [#55525](https://github.com/ClickHouse/ClickHouse/issues/55525). Это второй шаг к реализации индекса проекций, после [#78429](https://github.com/ClickHouse/ClickHouse/issues/78429). [#80343](https://github.com/ClickHouse/ClickHouse/pull/80343) ([Amos Bird](https://github.com/amosbird)).
* По умолчанию использовать политику кеширования `SLRU` для файлового кеша. [#75072](https://github.com/ClickHouse/ClickHouse/pull/75072) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Устранена конкуренция потоков на этапе Resize в конвейере запросов. [#77562](https://github.com/ClickHouse/ClickHouse/pull/77562) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
* Добавлена опция для переноса (де)сжатия и (де)сериализации блоков в потоки конвейера обработки (pipeline threads) вместо использования одного потока, связанного с сетевым подключением. Управляется настройкой `enable_parallel_blocks_marshalling`. Должно ускорить распределённые запросы, которые передают значительные объёмы данных между инициатором и удалёнными узлами. [#78694](https://github.com/ClickHouse/ClickHouse/pull/78694) ([Nikita Taranov](https://github.com/nickitat)).
* Повышена производительность во всех типах фильтров Блума. [Видео доклада с конференции OpenHouse](https://www.youtube.com/watch?v=yIVz0NKwQvA\&pp=ygUQb3BlbmhvdXNlIG9wZW5haQ%3D%3D) [#79800](https://github.com/ClickHouse/ClickHouse/pull/79800) ([Delyan Kratunov](https://github.com/dkratunov)).
* Добавлен оптимальный сценарий в `UniqExactSet::merge` на случай, когда одно из множеств пусто. Также теперь, если левое множество (LHS) двухуровневое, а правое (RHS) одноуровневое, мы не выполняем преобразование правого множества в двухуровневое. [#79971](https://github.com/ClickHouse/ClickHouse/pull/79971) ([Nikita Taranov](https://github.com/nickitat)).
* Повышена эффективность повторного использования памяти и снижено количество обращений к страницам (page faults) при использовании двухуровневых хеш-таблиц. Это позволило ускорить выполнение GROUP BY. [#80245](https://github.com/ClickHouse/ClickHouse/pull/80245) ([Jiebin Sun](https://github.com/jiebinn)).
* Избегайте ненужных обновлений и снижайте конкуренцию за блокировки в кэше условий запросов. [#80247](https://github.com/ClickHouse/ClickHouse/pull/80247) ([Jiebin Sun](https://github.com/jiebinn)).
* Тривиальная оптимизация для `concatenateBlocks`. Скорее всего, она будет полезна для параллельного хеш-соединения. [#80328](https://github.com/ClickHouse/ClickHouse/pull/80328) ([李扬](https://github.com/taiyang-li)).
* При выборе диапазонов меток из диапазона первичного ключа двоичный поиск не может использоваться, если первичный ключ обернут функциями. В этом PR улучшено это ограничение: двоичный поиск по-прежнему может применяться, когда первичный ключ обернут цепочкой всегда монотонных функций или когда RPN содержит элемент, который всегда истинен. Закрывает [#45536](https://github.com/ClickHouse/ClickHouse/issues/45536). [#80597](https://github.com/ClickHouse/ClickHouse/pull/80597) ([zoomxi](https://github.com/zoomxi)).
* Ускорено завершение работы движка `Kafka` (удален дополнительный 3‑секундный интервал задержки при наличии нескольких таблиц `Kafka`). [#80796](https://github.com/ClickHouse/ClickHouse/pull/80796) ([Azat Khuzhin](https://github.com/azat)).
* Асинхронные вставки: уменьшают потребление памяти и повышают производительность запросов вставки. [#80972](https://github.com/ClickHouse/ClickHouse/pull/80972) ([Raúl Marín](https://github.com/Algunenano)).
* Профилирование процессоров не выполняется, если таблица логов отключена. [#81256](https://github.com/ClickHouse/ClickHouse/pull/81256) ([Raúl Marín](https://github.com/Algunenano)). Это ускоряет выполнение очень коротких запросов.
* Ускорена функция `toFixedString`, когда исходное значение полностью соответствует запрошенному. [#81257](https://github.com/ClickHouse/ClickHouse/pull/81257) ([Raúl Marín](https://github.com/Algunenano)).
* Не обрабатывать значения квот, если к пользователю не применяются ограничения. [#81549](https://github.com/ClickHouse/ClickHouse/pull/81549) ([Raúl Marín](https://github.com/Algunenano)). Это ускоряет выполнение очень коротких запросов.
* Исправлена регрессия производительности в механизме отслеживания памяти. [#81694](https://github.com/ClickHouse/ClickHouse/pull/81694) ([Michael Kolupaev](https://github.com/al13n321)).
* Улучшена оптимизация ключа шардирования в распределённых запросах. [#78452](https://github.com/ClickHouse/ClickHouse/pull/78452) ([fhw12345](https://github.com/fhw12345)).
* Параллельные реплики: теперь не происходит ожидания медленных неиспользуемых реплик, если все задачи чтения уже распределены между другими репликами. [#80199](https://github.com/ClickHouse/ClickHouse/pull/80199) ([Igor Nikonov](https://github.com/devcrafter)).
* Параллельные реплики используют отдельный таймаут подключения, см. настройку `parallel_replicas_connect_timeout_ms`. Ранее настройки `connect_timeout_with_failover_ms`/`connect_timeout_with_failover_secure_ms` использовались в качестве таймаута подключения для запросов с параллельными репликами (1 секунда по умолчанию). [#80421](https://github.com/ClickHouse/ClickHouse/pull/80421) ([Igor Nikonov](https://github.com/devcrafter)).
* В файловых системах с журналированием операция `mkdir` записывается в журнал файловой системы, который затем записывается на диск. В случае медленного диска это может занять много времени. Вынесите эту операцию за пределы области резервной блокировки. [#81371](https://github.com/ClickHouse/ClickHouse/pull/81371) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отложить чтение файлов манифестов Iceberg до выполнения первого запроса на чтение. [#81619](https://github.com/ClickHouse/ClickHouse/pull/81619) ([Daniil Ivanik](https://github.com/divanik)).
* Разрешено переносить предикат `GLOBAL [NOT] IN` в секцию `PREWHERE`, если это возможно. [#79996](https://github.com/ClickHouse/ClickHouse/pull/79996) ([Eduard Karacharov](https://github.com/korowa)).





#### Улучшение

* `EXPLAIN SYNTAX` теперь использует новый анализатор. Он возвращает AST, построенное на основе дерева запроса. Добавлен параметр `query_tree_passes` для управления числом проходов, выполняемых перед преобразованием дерева запроса в AST. [#74536](https://github.com/ClickHouse/ClickHouse/pull/74536) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Реализована уплощённая сериализация для Dynamic и JSON в формате Native, которая позволяет выполнять сериализацию и десериализацию данных Dynamic и JSON без использования специальных структур, таких как shared variant для Dynamic и shared data для JSON. Эту сериализацию можно включить, установив `output_format_native_use_flattened_dynamic_and_json_serialization`. Её можно использовать для упрощения поддержки Dynamic и JSON в TCP‑протоколе в клиентах, реализованных на разных языках программирования. [#80499](https://github.com/ClickHouse/ClickHouse/pull/80499) ([Pavel Kruglov](https://github.com/Avogar)).
* Обновлять учетные данные `S3` после ошибки `AuthenticationRequired`. [#77353](https://github.com/ClickHouse/ClickHouse/pull/77353) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлены метрики словарей в `system.asynchronous_metrics`: `DictionaryMaxUpdateDelay` — максимальная задержка обновления словаря (в секундах); `DictionaryTotalFailedUpdates` — число ошибок с момента последней успешной загрузки во всех словарях. [#78175](https://github.com/ClickHouse/ClickHouse/pull/78175) ([Vlad](https://github.com/codeworse)).
* Добавлено предупреждение о базах данных, которые могли быть созданы для сохранения повреждённых таблиц. [#78841](https://github.com/ClickHouse/ClickHouse/pull/78841) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Добавлен виртуальный столбец `_time` в движки `S3Queue` и `AzureQueue`. [#78926](https://github.com/ClickHouse/ClickHouse/pull/78926) ([Anton Ivashkin](https://github.com/ianton-ru)).
* Сделать настройки, управляющие разрывом соединений при перегрузке CPU, поддерживающими горячую перезагрузку. [#79052](https://github.com/ClickHouse/ClickHouse/pull/79052) ([Alexey Katsman](https://github.com/alexkats)).
* Добавлен префикс контейнера к путям данных, возвращаемым в system.tables для plain-дисков в хранилище Azure Blob, для согласованности с S3 и GCP. [#79241](https://github.com/ClickHouse/ClickHouse/pull/79241) ([Julia Kartseva](https://github.com/jkartseva)).
* Теперь clickhouse-client и local также поддерживают параметры запроса в виде `param-<name>` (через дефис) наряду с `param_<name>` (через подчёркивание). Это закрывает [#63093](https://github.com/ClickHouse/ClickHouse/issues/63093). [#79429](https://github.com/ClickHouse/ClickHouse/pull/79429) ([Engel Danila](https://github.com/aaaengel)).
* Подробное предупреждающее сообщение об экономии пропускной способности при копировании данных из локального хранилища в удалённый S3 при включённой проверке контрольной суммы. [#79464](https://github.com/ClickHouse/ClickHouse/pull/79464) ([VicoWu](https://github.com/VicoWu)).
* Ранее, если `input_format_parquet_max_block_size = 0` (недопустимое значение), ClickHouse зависал. Теперь это поведение исправлено. Это исправление закрывает [#79394](https://github.com/ClickHouse/ClickHouse/issues/79394). [#79601](https://github.com/ClickHouse/ClickHouse/pull/79601) ([abashkeev](https://github.com/abashkeev)).
* Добавлена настройка `throw_on_error` для `startup_scripts`: когда `throw_on_error` установлена в true, сервер не запустится, пока все запросы не завершатся успешно. По умолчанию значение `throw_on_error` — false, что соответствует предыдущему поведению. [#79732](https://github.com/ClickHouse/ClickHouse/pull/79732) ([Aleksandr Musorin](https://github.com/AVMusorin)).
* Позволяет добавлять `http_response_headers` в любые `http_handlers`. [#79975](https://github.com/ClickHouse/ClickHouse/pull/79975) ([Andrey Zvonov](https://github.com/zvonand)).
* Функция `reverse` теперь поддерживает тип данных `Tuple`. Закрывает [#80053](https://github.com/ClickHouse/ClickHouse/issues/80053). [#80083](https://github.com/ClickHouse/ClickHouse/pull/80083) ([flynn](https://github.com/ucasfl)).
* Решена задача [#75817](https://github.com/ClickHouse/ClickHouse/issues/75817): добавлена возможность получать данные о `auxiliary_zookeepers` из таблицы `system.zookeeper`. [#80146](https://github.com/ClickHouse/ClickHouse/pull/80146) ([Nikolay Govorov](https://github.com/mrdimidium)).
* Добавлены асинхронные метрики по TCP-сокетам сервера. Это улучшает наблюдаемость. Закрывает [#80187](https://github.com/ClickHouse/ClickHouse/issues/80187). [#80188](https://github.com/ClickHouse/ClickHouse/pull/80188) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка `anyLast_respect_nulls` и `any_respect_nulls` как `SimpleAggregateFunction`. [#80219](https://github.com/ClickHouse/ClickHouse/pull/80219) ([Diskein](https://github.com/Diskein)).
* Удалён ненужный вызов `adjustCreateQueryForBackup` для реплицируемых баз данных. [#80282](https://github.com/ClickHouse/ClickHouse/pull/80282) ([Vitaly Baranov](https://github.com/vitlibar)).
* Разрешена передача дополнительных опций (которые идут после `--`, например `-- --config.value='abc'`) в `clickhouse-local` без знака равенства. Закрывает [#80292](https://github.com/ClickHouse/ClickHouse/issues/80292). [#80293](https://github.com/ClickHouse/ClickHouse/pull/80293) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена подсветка метасимволов в запросах `SHOW ... LIKE`. Это закрывает [#80275](https://github.com/ClickHouse/ClickHouse/issues/80275). [#80297](https://github.com/ClickHouse/ClickHouse/pull/80297) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность сохранять SQL UDF между запусками в `clickhouse-local`. Ранее созданная функция будет загружаться при старте. Это закрывает [#80085](https://github.com/ClickHouse/ClickHouse/issues/80085). [#80300](https://github.com/ClickHouse/ClickHouse/pull/80300) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено описание в плане выполнения запроса для предварительного шага DISTINCT. [#80330](https://github.com/ClickHouse/ClickHouse/pull/80330) ([UnamedRus](https://github.com/UnamedRus)).
* Разрешено использовать именованные коллекции в ODBC/JDBC. [#80334](https://github.com/ClickHouse/ClickHouse/pull/80334) ([Andrey Zvonov](https://github.com/zvonand)).
* Метрики числа дисков в режиме только для чтения и повреждённых дисков. Индикатор записывает в лог момент запуска DiskLocalCheckThread. [#80391](https://github.com/ClickHouse/ClickHouse/pull/80391) ([VicoWu](https://github.com/VicoWu)).
* Реализована поддержка хранилища `s3_plain_rewritable` с проекциями. В предыдущих версиях объекты метаданных в S3, ссылающиеся на проекции, не обновлялись при их перемещении. Закрывает [#70258](https://github.com/ClickHouse/ClickHouse/issues/70258). [#80393](https://github.com/ClickHouse/ClickHouse/pull/80393) ([Sav](https://github.com/sberss)).
* Команда `SYSTEM UNFREEZE` больше не пытается искать парты на дисках типа `readonly` и `write-once`. Это закрывает [#80430](https://github.com/ClickHouse/ClickHouse/issues/80430). [#80432](https://github.com/ClickHouse/ClickHouse/pull/80432) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Уменьшен уровень логирования сообщений о слитых партах. [#80476](https://github.com/ClickHouse/ClickHouse/pull/80476) ([Hans Krutzer](https://github.com/hkrutzer)).
* Изменено поведение отсечения партиций (partition pruning) по умолчанию для таблиц Iceberg. [#80583](https://github.com/ClickHouse/ClickHouse/pull/80583) ([Melvyn Peignon](https://github.com/melvynator)).
* Добавлены два новых события `ProfileEvents` для мониторинга алгоритма поиска по индексам: `IndexBinarySearchAlgorithm` и `IndexGenericExclusionSearchAlgorithm`. [#80679](https://github.com/ClickHouse/ClickHouse/pull/80679) ([Pablo Marcos](https://github.com/pamarcos)).
* Не выводить в логи сообщения о неподдерживаемом `MADV_POPULATE_WRITE` в старых версиях ядра (чтобы не засорять логи). [#80704](https://github.com/ClickHouse/ClickHouse/pull/80704) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка типов `Date32` и `DateTime64` в выражениях `TTL`. [#80710](https://github.com/ClickHouse/ClickHouse/pull/80710) ([Andrey Zvonov](https://github.com/zvonand)).
* Скорректированы значения совместимости для `max_merge_delayed_streams_for_parallel_write`. [#80760](https://github.com/ClickHouse/ClickHouse/pull/80760) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, приводившая к аварийному завершению программы: если в деструкторе при попытке удалить временный файл (они используются для выгрузки временных данных на диск) выбрасывается исключение, программа может аварийно завершиться. [#80776](https://github.com/ClickHouse/ClickHouse/pull/80776) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен модификатор `IF EXISTS` к команде `SYSTEM SYNC REPLICA`. [#80810](https://github.com/ClickHouse/ClickHouse/pull/80810) ([Raúl Marín](https://github.com/Algunenano)).
* Расширено сообщение об исключении «Having zero bytes, but read range is not finished...», в `system.filesystem_cache` добавлен столбец finished&#95;download&#95;time. [#80849](https://github.com/ClickHouse/ClickHouse/pull/80849) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлен раздел с алгоритмом поиска в вывод `EXPLAIN` при использовании с indexes = 1. Теперь он показывает либо «binary search», либо «generic exclusion search». [#80881](https://github.com/ClickHouse/ClickHouse/pull/80881) ([Pablo Marcos](https://github.com/pamarcos)).
* В начале 2024 года значение `prefer_column_name_to_alias` было жестко зафиксировано в true для обработчика MySQL, поскольку новый анализатор по умолчанию не был включен. Теперь это значение можно сделать настраиваемым. [#80916](https://github.com/ClickHouse/ClickHouse/pull/80916) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Теперь `system.iceberg_history` отображает историю для каталогов баз данных, таких как Glue или Iceberg REST. Также для согласованности переименованы столбцы `table_name` и `database_name` в `table` и `database` в `system.iceberg_history`. [#80975](https://github.com/ClickHouse/ClickHouse/pull/80975) ([alesapin](https://github.com/alesapin)).
* Разрешён режим только для чтения для табличной функции `merge`, поэтому для её использования больше не требуется привилегия `CREATE TEMPORARY TABLE`. [#80981](https://github.com/ClickHouse/ClickHouse/pull/80981) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Улучшена возможность анализа кэшей в памяти (информация о кэшах теперь предоставляется в `system.metrics` вместо неполной `system.asynchronouse_metrics`). В `dashboard.html` добавлен размер кэшей в памяти (в байтах). `VectorSimilarityIndexCacheSize`/`IcebergMetadataFilesCacheSize` переименованы в `VectorSimilarityIndexCacheBytes`/`IcebergMetadataFilesCacheBytes`. [#81023](https://github.com/ClickHouse/ClickHouse/pull/81023) ([Azat Khuzhin](https://github.com/azat)).
* Базы данных с движками, не поддерживающими таблицы `RocksDB`, игнорируются при чтении из `system.rocksdb`. [#81083](https://github.com/ClickHouse/ClickHouse/pull/81083) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Разрешено использование `filesystem_caches` и `named_collections` в конфигурационном файле `clickhouse-local`. [#81105](https://github.com/ClickHouse/ClickHouse/pull/81105) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена подсветка синтаксиса для `PARTITION BY` в запросах `INSERT`. В предыдущих версиях `PARTITION BY` не выделялся как ключевое слово. [#81106](https://github.com/ClickHouse/ClickHouse/pull/81106) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Два небольших улучшения в Web UI: - корректно обрабатывать запросы без вывода, такие как `CREATE`, `INSERT` (до недавнего времени такие запросы вызывали бесконечный индикатор загрузки); - при двойном щелчке по таблице прокручивать к началу. [#81131](https://github.com/ClickHouse/ClickHouse/pull/81131) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Метрика `MemoryResidentWithoutPageCache` показывает объём физической памяти, используемой серверным процессом, за вычетом кэша страниц в пространстве пользователя (userspace page cache), в байтах. Это даёт более точное представление о фактическом использовании памяти при задействованном userspace page cache. Когда userspace page cache отключён, это значение равно `MemoryResident`. [#81233](https://github.com/ClickHouse/ClickHouse/pull/81233) ([Jayme Bird](https://github.com/jaymebrd)).
* Вручную регистрируемые исключения в клиенте, локальном сервере, keeper-клиенте и приложении дисков помечены как уже записанные в журнал, чтобы они не протоколировались дважды. [#81271](https://github.com/ClickHouse/ClickHouse/pull/81271) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Параметры `use_skip_indexes_if_final` и `use_skip_indexes_if_final_exact_mode` теперь по умолчанию имеют значение `True`. Запросы с оператором `FINAL` теперь будут использовать пропускающие индексы (если применимо) для предварительного отбора гранул, а также считывать любые дополнительные гранулы, соответствующие совпадающим диапазонам первичного ключа. Пользователи, которым требуется прежнее поведение с приблизительными/неточными результатами, могут установить `use_skip_indexes_if_final_exact_mode` в `False` после тщательной оценки. [#81331](https://github.com/ClickHouse/ClickHouse/pull/81331) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Когда в веб‑интерфейсе у вас несколько запросов, будет выполняться тот запрос, под которым находится курсор. Продолжение [#80977](https://github.com/ClickHouse/ClickHouse/issues/80977). [#81354](https://github.com/ClickHouse/ClickHouse/pull/81354) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Этот pull request устраняет проблемы реализации `is_strict` в проверках монотонности функций преобразования. В настоящее время некоторые функции преобразования, такие как `toFloat64(UInt32)` и `toDate(UInt8)`, ошибочно возвращают для `is_strict` значение false, хотя должны возвращать true. [#81359](https://github.com/ClickHouse/ClickHouse/pull/81359) ([zoomxi](https://github.com/zoomxi)).
* При проверке, соответствует ли `KeyCondition` непрерывному диапазону, если ключ обернут цепочкой нестрогих функций, `Constraint::POINT` может потребовать преобразования в `Constraint::RANGE`. Например: `toDate(event_time) = '2025-06-03'` задаёт диапазон для `event_time`: [&#39;2025-06-03 00:00:00&#39;, &#39;2025-06-04 00:00:00&#39;). Этот PR исправляет это поведение. [#81400](https://github.com/ClickHouse/ClickHouse/pull/81400) ([zoomxi](https://github.com/zoomxi)).
* Псевдонимы `clickhouse`/`ch` будут вызывать `clickhouse-client` вместо `clickhouse-local`, если заданы параметры `--host` или `--port`. Продолжение [#79422](https://github.com/ClickHouse/ClickHouse/issues/79422). Закрывает [#65252](https://github.com/ClickHouse/ClickHouse/issues/65252). [#81509](https://github.com/ClickHouse/ClickHouse/pull/81509) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Теперь, когда у нас есть данные о распределении времени ответа Keeper, мы можем настроить бакеты гистограммы для метрик. [#81516](https://github.com/ClickHouse/ClickHouse/pull/81516) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Добавлено событие профиля `PageCacheReadBytes`. [#81742](https://github.com/ClickHouse/ClickHouse/pull/81742) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена логическая ошибка в кэше файловой системы: &quot;Having zero bytes but range is not finished&quot;. [#81868](https://github.com/ClickHouse/ClickHouse/pull/81868) ([Kseniia Sumarokova](https://github.com/kssenii)).





#### Исправление ошибки (некорректное поведение, видимое пользователю, в официальном стабильном релизе)

* Исправлена работа параметризованного представления с запросом SELECT EXCEPT. Закрывает [#49447](https://github.com/ClickHouse/ClickHouse/issues/49447). [#57380](https://github.com/ClickHouse/ClickHouse/pull/57380) ([Nikolay Degterinsky](https://github.com/evillique)).
* Analyzer: Исправлено имя проекции столбца после повышения типа столбца при соединении. Закрывает [#63345](https://github.com/ClickHouse/ClickHouse/issues/63345). [#63519](https://github.com/ClickHouse/ClickHouse/pull/63519) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена логическая ошибка в случае конфликтов имён столбцов при включённом параметре analyzer&#95;compatibility&#95;join&#95;using&#95;top&#95;level&#95;identifier. [#75676](https://github.com/ClickHouse/ClickHouse/pull/75676) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлено использование CTE в проталкиваемых предикатах, когда включен `allow_push_predicate_ast_for_distributed_subqueries`. Исправлены [#75647](https://github.com/ClickHouse/ClickHouse/issues/75647). Исправлены [#79672](https://github.com/ClickHouse/ClickHouse/issues/79672). [#77316](https://github.com/ClickHouse/ClickHouse/pull/77316) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена проблема, при которой команда SYSTEM SYNC REPLICA LIGHTWEIGHT &#39;foo&#39; сообщала об успешном выполнении, даже если указанная реплика не существовала. Теперь команда корректно проверяет наличие реплики в Keeper перед попыткой синхронизации. [#78405](https://github.com/ClickHouse/ClickHouse/pull/78405) ([Jayme Bird](https://github.com/jaymebrd)).
* Исправлена ошибка в очень специфической ситуации, когда функция `currentDatabase` использовалась в секциях `CONSTRAINT` для запросов с `ON CLUSTER`. Закрывает [#78100](https://github.com/ClickHouse/ClickHouse/issues/78100). [#79070](https://github.com/ClickHouse/ClickHouse/pull/79070) ([pufit](https://github.com/pufit)).
* Исправлена передача внешних ролей в межсерверных запросах. [#79099](https://github.com/ClickHouse/ClickHouse/pull/79099) ([Andrey Zvonov](https://github.com/zvonand)).
* Используйте IColumn вместо Field в SingleValueDataGeneric. Это исправляет некорректные возвращаемые значения некоторых агрегатных функций, таких как `argMax` для типов `Dynamic/Variant/JSON`. [#79166](https://github.com/ClickHouse/ClickHouse/pull/79166) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено применение настроек use&#95;native&#95;copy и allow&#95;azure&#95;native&#95;copy для хранилища Azure Blob и обновлено поведение так, чтобы native copy использовалась только при совпадении учетных данных, что исправляет [#78964](https://github.com/ClickHouse/ClickHouse/issues/78964). [#79561](https://github.com/ClickHouse/ClickHouse/pull/79561) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Исправлены логические ошибки, связанные с неизвестной областью происхождения столбца при проверке, коррелирован ли этот столбец. Исправляет [#78183](https://github.com/ClickHouse/ClickHouse/issues/78183). Исправляет [#79451](https://github.com/ClickHouse/ClickHouse/issues/79451). [#79727](https://github.com/ClickHouse/ClickHouse/pull/79727) ([Dmitry Novik](https://github.com/novikd)).
* Исправлены некорректные результаты для grouping sets при использовании `ColumnConst` и Analyzer. [#79743](https://github.com/ClickHouse/ClickHouse/pull/79743) ([Andrey Zvonov](https://github.com/zvonand)).
* Исправлено дублирование результатов локального шарда при чтении из распределённой таблицы, если локальная реплика устарела. [#79761](https://github.com/ClickHouse/ClickHouse/pull/79761) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлен порядок сортировки значений NaN с отрицательным знаковым битом. [#79847](https://github.com/ClickHouse/ClickHouse/pull/79847) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Теперь GROUP BY ALL не учитывает секцию GROUPING. [#79915](https://github.com/ClickHouse/ClickHouse/pull/79915) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлено некорректное объединение состояний для функций `TopK` / `TopKWeighted`, приводившее к чрезмерным значениям ошибки даже при незаполненной емкости. [#79939](https://github.com/ClickHouse/ClickHouse/pull/79939) ([Joel Höner](https://github.com/athre0z)).
* Учитывается настройка `readonly` в объектном хранилище `azure_blob_storage`. [#79954](https://github.com/ClickHouse/ClickHouse/pull/79954) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлены некорректные результаты запросов и сбои из-за нехватки памяти при использовании `match(column, '^…')` с символами, экранированными обратной косой чертой. [#79969](https://github.com/ClickHouse/ClickHouse/pull/79969) ([filimonov](https://github.com/filimonov)).
* Отключение Hive-секционирования для озер данных. Частично решает [https://github.com/issues/assigned?issue=ClickHouse%7CClickHouse%7C79937](https://github.com/issues/assigned?issue=ClickHouse%7CClickHouse%7C79937). [#80005](https://github.com/ClickHouse/ClickHouse/pull/80005) ([Daniil Ivanik](https://github.com/divanik)).
* Skip-индексы с лямбда-выражениями не применялись. Исправлен случай, когда функции верхнего уровня в определении индекса в точности совпадали с функциями в запросе. [#80025](https://github.com/ClickHouse/ClickHouse/pull/80025) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена версия метаданных при присоединении парта на реплике, выполняющей команду ATTACH&#95;PART из журнала репликации. [#80038](https://github.com/ClickHouse/ClickHouse/pull/80038) ([Aleksei Filatov](https://github.com/aalexfvk)).
* В отличие от других функций, имена исполняемых пользовательских функций (eUDF) не добавляются в столбец `used_functions` таблицы `system.query_log`. В этом pull request реализовано добавление имени eUDF, если она была использована в запросе. [#80073](https://github.com/ClickHouse/ClickHouse/pull/80073) ([Kyamran](https://github.com/nibblerenush)).
* Исправлена логическая ошибка в формате Arrow при использовании LowCardinality(FixedString). [#80156](https://github.com/ClickHouse/ClickHouse/pull/80156) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено чтение подстолбцов из движка Merge. [#80158](https://github.com/ClickHouse/ClickHouse/pull/80158) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка в сравнении числовых типов в `KeyCondition`. [#80207](https://github.com/ClickHouse/ClickHouse/pull/80207) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена ошибка AMBIGUOUS&#95;COLUMN&#95;NAME, возникавшая при применении ленивой материализации к таблице с проекциями. [#80251](https://github.com/ClickHouse/ClickHouse/pull/80251) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлена некорректная оптимизация `count` для строковых фильтров по префиксу, таких как LIKE &#39;ab&#95;c%&#39;, при использовании неявных проекций. Это исправляет [#80250](https://github.com/ClickHouse/ClickHouse/issues/80250). [#80261](https://github.com/ClickHouse/ClickHouse/pull/80261) ([Amos Bird](https://github.com/amosbird)).
* Исправлена некорректная сериализация вложенных числовых полей как строк в документах MongoDB. Удалено ограничение на максимальную глубину документов из MongoDB. [#80289](https://github.com/ClickHouse/ClickHouse/pull/80289) ([Kirill Nikiforov](https://github.com/allmazz)).
* Выполнять менее строгие проверки метаданных RMT в реплицируемой базе данных. Закрывает [#80296](https://github.com/ClickHouse/ClickHouse/issues/80296). [#80298](https://github.com/ClickHouse/ClickHouse/pull/80298) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлено текстовое представление типов DateTime и DateTime64 для хранилища PostgreSQL. [#80301](https://github.com/ClickHouse/ClickHouse/pull/80301) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Разрешено использование `DateTime` с часовым поясом в таблицах `StripeLog`, что закрывает [#44120](https://github.com/ClickHouse/ClickHouse/issues/44120). [#80304](https://github.com/ClickHouse/ClickHouse/pull/80304) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Отключает проталкивание фильтра (filter-push-down) для предиката с недетерминированной функцией в случае, если шаг плана запроса изменяет количество строк. Исправляет [#40273](https://github.com/ClickHouse/ClickHouse/issues/40273). [#80329](https://github.com/ClickHouse/ClickHouse/pull/80329) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлены возможные логические ошибки и аварийные завершения в проекциях с подстолбцами. [#80333](https://github.com/ClickHouse/ClickHouse/pull/80333) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка `NOT_FOUND_COLUMN_IN_BLOCK`, возникавшая при оптимизации filter-push-down логического JOIN в случае, когда выражение в `ON` не является простым равенством. Исправляет [#79647](https://github.com/ClickHouse/ClickHouse/issues/79647) и [#77848](https://github.com/ClickHouse/ClickHouse/issues/77848). [#80360](https://github.com/ClickHouse/ClickHouse/pull/80360) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен некорректный результат при чтении ключей в обратном порядке в секционированных таблицах. Это исправляет [#79987](https://github.com/ClickHouse/ClickHouse/issues/79987). [#80448](https://github.com/ClickHouse/ClickHouse/pull/80448) ([Amos Bird](https://github.com/amosbird)).
* Исправлена некорректная сортировка в таблицах с ключом, допускающим значение `NULL`, и включённым параметром `optimize_read_in_order`. [#80515](https://github.com/ClickHouse/ClickHouse/pull/80515) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлено зависание операции DROP обновляемого материализованного представления, если представление было приостановлено с помощью SYSTEM STOP REPLICATED VIEW. [#80543](https://github.com/ClickHouse/ClickHouse/pull/80543) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена ошибка &#39;Cannot find column&#39; с константным кортежем в распределённом запросе. [#80596](https://github.com/ClickHouse/ClickHouse/pull/80596) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена функция `shardNum` в таблицах Distributed при использовании `join_use_nulls`. [#80612](https://github.com/ClickHouse/ClickHouse/pull/80612) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлен некорректный результат при чтении столбца, который существует только в части таблиц в движке Merge. [#80643](https://github.com/ClickHouse/ClickHouse/pull/80643) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена возможная проблема с протоколом SSH (из-за зависания в replxx). [#80688](https://github.com/ClickHouse/ClickHouse/pull/80688) ([Azat Khuzhin](https://github.com/azat)).
* Метка времени в таблице iceberg&#95;history теперь должна быть корректной. [#80711](https://github.com/ClickHouse/ClickHouse/pull/80711) ([Melvyn Peignon](https://github.com/melvynator)).
* Исправлена возможная аварийная остановка при неудачной регистрации словаря (когда `CREATE DICTIONARY` завершался с ошибкой `CANNOT_SCHEDULE_TASK`, в реестре словарей мог оставаться висячий указатель, что впоследствии приводило к сбою). [#80714](https://github.com/ClickHouse/ClickHouse/pull/80714) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена обработка glob-шаблонов перечислений с одним элементом в табличных функциях объектного хранилища. [#80716](https://github.com/ClickHouse/ClickHouse/pull/80716) ([Konstantин Bogdanov](https://github.com/thevar1able)).
* Исправлен неверный тип результата функций сравнения между Tuple(Dynamic) и String, приводивший к логической ошибке. [#80728](https://github.com/ClickHouse/ClickHouse/pull/80728) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена поддержка отсутствовавшего типа данных `timestamp_ntz` в Unity Catalog. Исправлены [#79535](https://github.com/ClickHouse/ClickHouse/issues/79535), [#79875](https://github.com/ClickHouse/ClickHouse/issues/79875). [#80740](https://github.com/ClickHouse/ClickHouse/pull/80740) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка `THERE_IS_NO_COLUMN` в распределённых запросах с `IN cte`. Устранена проблема [#75032](https://github.com/ClickHouse/ClickHouse/issues/75032). [#80757](https://github.com/ClickHouse/ClickHouse/pull/80757) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено чрезмерное количество файлов (что приводило к чрезмерному использованию памяти) во внешнем ORDER BY. [#80777](https://github.com/ClickHouse/ClickHouse/pull/80777) ([Azat Khuzhin](https://github.com/azat)).
* Этот PR может закрыть [#80742](https://github.com/ClickHouse/ClickHouse/issues/80742). [#80783](https://github.com/ClickHouse/ClickHouse/pull/80783) ([zoomxi](https://github.com/zoomxi)).
* Исправлено аварийное завершение работы Kafka, возникавшее из-за того, что get&#95;member&#95;id() создавал std::string из NULL (вероятно, проблема проявлялась только в случае неудачного подключения к брокеру). [#80793](https://github.com/ClickHouse/ClickHouse/pull/80793) ([Azat Khuzhin](https://github.com/azat)).
* Корректное ожидание завершения работы консьюмеров перед остановкой движка Kafka (активные консьюмеры, остающиеся после остановки, могут вызывать различные отладочные утверждения и продолжать фоновое чтение данных у брокеров после удаления/отсоединения таблицы). [#80795](https://github.com/ClickHouse/ClickHouse/pull/80795) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка `NOT_FOUND_COLUMN_IN_BLOCK`, возникавшая из-за оптимизации `predicate-push-down`. Исправляет [#80443](https://github.com/ClickHouse/ClickHouse/issues/80443). [#80834](https://github.com/ClickHouse/ClickHouse/pull/80834) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена логическая ошибка при обработке шаблона `*` в табличной функции в JOIN с USING. [#80894](https://github.com/ClickHouse/ClickHouse/pull/80894) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлен учет потребления памяти для кэша файлов метаданных Iceberg. [#80904](https://github.com/ClickHouse/ClickHouse/pull/80904) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено некорректное секционирование при использовании nullable-ключа секционирования. [#80913](https://github.com/ClickHouse/ClickHouse/pull/80913) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлена ошибка `Table does not exist` для распределённых запросов с проталкиванием предиката (`allow_push_predicate_ast_for_distributed_subqueries=1`), когда исходная таблица отсутствует на инициаторе запроса. Исправление [#77281](https://github.com/ClickHouse/ClickHouse/issues/77281). [#80915](https://github.com/ClickHouse/ClickHouse/pull/80915) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена логическая ошибка во вложенных функциях с именованными окнами. [#80926](https://github.com/ClickHouse/ClickHouse/pull/80926) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлена обработка экстремальных значений для столбцов Nullable и с плавающей запятой. [#80970](https://github.com/ClickHouse/ClickHouse/pull/80970) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлен возможный сбой при выполнении запроса к system.tables (скорее всего проявлявшийся при нехватке памяти). [#80976](https://github.com/ClickHouse/ClickHouse/pull/80976) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена операция атомарного переименования с усечением (truncate) для файлов, у которых тип сжатия определяется по расширению. [#80979](https://github.com/ClickHouse/ClickHouse/pull/80979) ([Pablo Marcos](https://github.com/pamarcos)).
* Исправлена ошибка в ErrorCodes::getName. [#81032](https://github.com/ClickHouse/ClickHouse/pull/81032) ([RinChanNOW](https://github.com/RinChanNOWWW)).
* Исправлена ошибка, из-за которой пользователь не мог просматривать список таблиц в Unity Catalog без прав на каждую из них. Теперь все таблицы корректно отображаются, а попытка чтения из таблицы с ограниченным доступом приведёт к исключению. [#81044](https://github.com/ClickHouse/ClickHouse/pull/81044) ([alesapin](https://github.com/alesapin)).
* Теперь ClickHouse будет игнорировать ошибки и неожиданные ответы от каталогов дата-лейка в запросе `SHOW TABLES`. Исправляет проблему [#79725](https://github.com/ClickHouse/ClickHouse/issues/79725). [#81046](https://github.com/ClickHouse/ClickHouse/pull/81046) ([alesapin](https://github.com/alesapin)).
* Исправлен разбор `DateTime64` из целых чисел в `JSONExtract` и разбор типа `JSON`. [#81050](https://github.com/ClickHouse/ClickHouse/pull/81050) ([Pavel Kruglov](https://github.com/Avogar)).
* В кэше вывода схемы теперь учитывается настройка date&#95;time&#95;input&#95;format. [#81052](https://github.com/ClickHouse/ClickHouse/pull/81052) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка, приводившая к сбою при INSERT, если таблица была удалена (DROP) после запуска запроса, но до отправки столбцов. [#81053](https://github.com/ClickHouse/ClickHouse/pull/81053) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка use-of-uninitialized-value в quantileDeterministic. [#81062](https://github.com/ClickHouse/ClickHouse/pull/81062) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено управление счётчиком жёстких ссылок в транзакциях диска metadatastoragefromdisk. Добавлены тесты. [#81066](https://github.com/ClickHouse/ClickHouse/pull/81066) ([Sema Checherinda](https://github.com/CheSema)).
* Имена пользовательских функций (UDF) не добавляются в таблицу `system.query_log` в отличие от других функций. Этот pull request добавляет имя UDF в один из двух столбцов — `used_executable_user_defined_functions` или `used_sql_user_defined_functions`, если UDF использовалась в запросе. [#81101](https://github.com/ClickHouse/ClickHouse/pull/81101) ([Kyamran](https://github.com/nibblerenush)).
* Исправлены ошибки `Too large size ... passed to allocator` и возможные аварийные завершения при вставках через HTTP-протокол с текстовыми форматами (`JSON`, `Values`, ...) при пропуске полей типа `Enum`. [#81145](https://github.com/ClickHouse/ClickHouse/pull/81145) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка LOGICAL&#95;ERROR при наличии разрежённого столбца (Sparse column) в блоке INSERT, отправленном в не-MT материализованное представление. [#81161](https://github.com/ClickHouse/ClickHouse/pull/81161) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка `Unknown table expression identifier` для `distributed_product_mode_local=local` при кросс-репликации. [#81162](https://github.com/ClickHouse/ClickHouse/pull/81162) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, из-за которой некорректно кэшировалось количество строк в файлах Parquet после фильтрации. [#81184](https://github.com/ClickHouse/ClickHouse/pull/81184) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена настройка fs cache max&#95;size&#95;to&#95;total&#95;space при использовании относительного пути к каталогу кэша. [#81237](https://github.com/ClickHouse/ClickHouse/pull/81237) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка аварийного завершения clickhouse-local при выводе константных кортежей или значений типа Map в формате Parquet. [#81249](https://github.com/ClickHouse/ClickHouse/pull/81249) ([Michael Kolupaev](https://github.com/al13n321)).
* Проверять смещения массивов, принимаемых по сети. [#81269](https://github.com/ClickHouse/ClickHouse/pull/81269) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен пограничный случай в запросе, который выполняет `JOIN` пустых таблиц и использует оконные функции. Ошибка приводила к взрывному увеличению числа параллельных потоков, что вызывало ошибки Out Of Memory (OOM). [#81299](https://github.com/ClickHouse/ClickHouse/pull/81299) ([Alexander Gololobov](https://github.com/davenger)).
* Исправления для кластерных функций data lake (`deltaLakeCluster`, `icebergCluster` и т. д.): (1) исправлен потенциальный segfault в `DataLakeConfiguration` при использовании функции `Cluster` со старым анализатором; (2) удалено дублирующее обновление метаданных data lake (лишние запросы к объектному хранилищу); (3) исправлено избыточное перечисление в объектном хранилище, когда формат явно не задан (что уже было сделано для некластерных движков data lake). [#81300](https://github.com/ClickHouse/ClickHouse/pull/81300) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Флаг force&#95;restore&#95;data теперь восстанавливает утраченные метаданные Keeper. [#81324](https://github.com/ClickHouse/ClickHouse/pull/81324) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена ошибка региона в delta-kernel. Исправление для [#79914](https://github.com/ClickHouse/ClickHouse/issues/79914). [#81353](https://github.com/ClickHouse/ClickHouse/pull/81353) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отключена некорректная JIT-компиляция операции divideOrNull. [#81370](https://github.com/ClickHouse/ClickHouse/pull/81370) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена ошибка вставки в таблицу MergeTree, возникавшая при длинном имени столбца партиционирования. [#81390](https://github.com/ClickHouse/ClickHouse/pull/81390) ([hy123q](https://github.com/haoyangqian)).
* Бэкпортировано в [#81957](https://github.com/ClickHouse/ClickHouse/issues/81957): исправлено возможное падение `Aggregator` при возникновении исключения в процессе слияния. [#81450](https://github.com/ClickHouse/ClickHouse/pull/81450) ([Nikita Taranov](https://github.com/nickitat)).
* Не хранить содержимое нескольких файлов манифеста в памяти. [#81470](https://github.com/ClickHouse/ClickHouse/pull/81470) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлен возможный сбой при остановке фоновых пулов (`background_.*pool_size`). [#81473](https://github.com/ClickHouse/ClickHouse/pull/81473) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено чтение за пределами допустимых границ в формате `Npy`, происходящее при записи в таблицу с движком `URL`. Это закрывает [#81356](https://github.com/ClickHouse/ClickHouse/issues/81356). [#81502](https://github.com/ClickHouse/ClickHouse/pull/81502) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Возможна ситуация, когда Web UI отображает `NaN%` (типичная проблема JavaScript). [#81507](https://github.com/ClickHouse/ClickHouse/pull/81507) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена работа движка `DatabaseReplicated` при включённом параметре `database_replicated_enforce_synchronous_settings=1`. [#81564](https://github.com/ClickHouse/ClickHouse/pull/81564) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен порядок сортировки типов LowCardinality(Nullable(...)). [#81583](https://github.com/ClickHouse/ClickHouse/pull/81583) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Сервер не должен поддерживать HTTP-соединение, если запрос не был полностью прочитан из сокета. [#81595](https://github.com/ClickHouse/ClickHouse/pull/81595) ([Sema Checherinda](https://github.com/CheSema)).
* Сделано так, что скалярные коррелированные подзапросы возвращают Nullable‑результат выражения проекции. Исправлен случай, когда коррелированный подзапрос возвращает пустой набор результатов. [#81632](https://github.com/ClickHouse/ClickHouse/pull/81632) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена ошибка `Unexpected relative path for a deduplicated part` при выполнении операции `ATTACH` к `ReplicatedMergeTree`. [#81647](https://github.com/ClickHouse/ClickHouse/pull/81647) ([Azat Khuzhin](https://github.com/azat)).
* Настройка запроса `use_iceberg_partition_pruning` не будет действовать для хранилища Iceberg, поскольку оно использует глобальный контекст, а не контекст запроса. Это не критично, так как значение по умолчанию — true. Этот PR исправляет проблему. [#81673](https://github.com/ClickHouse/ClickHouse/pull/81673) ([Han Fei](https://github.com/hanfei1991)).
* Бэкпортировано в [#82128](https://github.com/ClickHouse/ClickHouse/issues/82128): исправлена ошибка «Context has expired» при слияниях, когда словарь используется в выражении TTL. [#81690](https://github.com/ClickHouse/ClickHouse/pull/81690) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена проверка для настройки mergetree `merge_max_block_size`, чтобы гарантировать, что её значение не равно нулю. [#81693](https://github.com/ClickHouse/ClickHouse/pull/81693) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлены проблемы в `clickhouse-local`, приводившие к зависанию запросов `DROP VIEW `. [#81705](https://github.com/ClickHouse/ClickHouse/pull/81705) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлен `JOIN` для `StorageRedis` в некоторых случаях. [#81736](https://github.com/ClickHouse/ClickHouse/pull/81736) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлен сбой в `ConcurrentHashJoin` при пустом `USING ()` и включённом старом анализаторе. [#81754](https://github.com/ClickHouse/ClickHouse/pull/81754) ([Nikita Taranov](https://github.com/nickitat)).
* Исправление Keeper: блокировать коммит новых записей журнала, если в журнале есть некорректная запись. Ранее, если лидер некорректно применял часть записей журнала, он продолжал коммитить новые записи, хотя фолловер обнаруживал несоответствие дайджеста и прерывал выполнение. [#81780](https://github.com/ClickHouse/ClickHouse/pull/81780) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена проблема, из-за которой необходимые столбцы не считывались при обработке скалярного коррелированного подзапроса. Исправляет [#81716](https://github.com/ClickHouse/ClickHouse/issues/81716). [#81805](https://github.com/ClickHouse/ClickHouse/pull/81805) ([Dmitry Novik](https://github.com/novikd)).
* Кто-то засорил наш код Kusto. Почистил. Это закрывает [#81643](https://github.com/ClickHouse/ClickHouse/issues/81643). [#81885](https://github.com/ClickHouse/ClickHouse/pull/81885) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* В предыдущих версиях сервер возвращал избыточное содержимое ответа для запросов к `/js`. Тем самым закрывается [#61890](https://github.com/ClickHouse/ClickHouse/issues/61890). [#81895](https://github.com/ClickHouse/ClickHouse/pull/81895) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Ранее определения движка таблиц `MongoDB` могли включать компонент пути в аргументе `host:port`, который молча игнорировался. Интеграция с MongoDB отказывается загружать такие таблицы. С этим исправлением *мы разрешаем загрузку таких таблиц и игнорируем компонент пути*, если движок `MongoDB` вызывается с пятью аргументами, используя имя базы данных из аргументов. *Примечание:* Исправление не применяется к заново создаваемым таблицам или запросам с табличной функцией `mongo`, а также к источникам словарей и именованным коллекциям. [#81942](https://github.com/ClickHouse/ClickHouse/pull/81942) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлено возможное аварийное завершение работы `Aggregator` при возникновении исключения во время слияния. [#82022](https://github.com/ClickHouse/ClickHouse/pull/82022) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена ошибка копипаста в `arraySimilarity`, запрещено использовать веса типов `UInt32` и `Int32`. Обновлены тесты и документация. [#82103](https://github.com/ClickHouse/ClickHouse/pull/82103) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Исправлена возможная гонка данных между потоком подсказок и основным потоком клиента. [#82233](https://github.com/ClickHouse/ClickHouse/pull/82233) ([Azat Khuzhin](https://github.com/azat)).





#### Улучшения сборки/тестирования/упаковки

* Используйте `postgres` 16.9. [#81437](https://github.com/ClickHouse/ClickHouse/pull/81437) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Используется `openssl` 3.2.4. [#81438](https://github.com/ClickHouse/ClickHouse/pull/81438) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Использовать `abseil-cpp` от 2025-01-27. [#81440](https://github.com/ClickHouse/ClickHouse/pull/81440) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Используйте `mongo-c-driver` 1.30.4. [#81449](https://github.com/ClickHouse/ClickHouse/pull/81449) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Используйте `krb5` 1.21.3-final. [#81453](https://github.com/ClickHouse/ClickHouse/pull/81453) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Используйте `orc` 2.1.2. [#81455](https://github.com/ClickHouse/ClickHouse/pull/81455) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Используйте `grpc` 1.73.0. [#81629](https://github.com/ClickHouse/ClickHouse/pull/81629) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Используйте `delta-kernel-rs` v0.12.1. [#81707](https://github.com/ClickHouse/ClickHouse/pull/81707) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Обновлён `c-ares` до версии `v1.34.5`. [#81159](https://github.com/ClickHouse/ClickHouse/pull/81159) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Обновите `curl` до версии 8.14 для устранения уязвимостей CVE-2025-5025 и CVE-2025-4947. [#81171](https://github.com/ClickHouse/ClickHouse/pull/81171) ([larryluogit](https://github.com/larryluogit)).
* Обновлён `libarchive` до версии 3.7.9 для устранения уязвимостей: CVE-2024-20696 CVE-2025-25724 CVE-2024-48958 CVE-2024-57970 CVE-2025-1632 CVE-2024-48957 CVE-2024-48615. [#81174](https://github.com/ClickHouse/ClickHouse/pull/81174) ([larryluogit](https://github.com/larryluogit)).
* Обновить `libxml2` до версии 2.14.3. [#81187](https://github.com/ClickHouse/ClickHouse/pull/81187) ([larryluogit](https://github.com/larryluogit)).
* Не копируйте завендоренные исходники Rust в `CARGO_HOME`. [#79560](https://github.com/ClickHouse/ClickHouse/pull/79560) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Удалена зависимость от библиотеки Sentry, заменив её на наш собственный endpoint. [#80236](https://github.com/ClickHouse/ClickHouse/pull/80236) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Обновлены зависимости Python в CI-образах для устранения предупреждений Dependabot. [#80658](https://github.com/ClickHouse/ClickHouse/pull/80658) ([Raúl Marín](https://github.com/Algunenano)).
* Повторно считывать флаг остановки replicated DDL из Keeper при старте, чтобы сделать тесты более устойчивыми при включённой инъекции сбоев в Keeper. [#80964](https://github.com/ClickHouse/ClickHouse/pull/80964) ([Alexander Gololobov](https://github.com/davenger)).
* Используйте https для URL-адреса архива Ubuntu. [#81016](https://github.com/ClickHouse/ClickHouse/pull/81016) ([Raúl Marín](https://github.com/Algunenano)).
* Обновлены зависимости Python в тестовых образах. [#81042](https://github.com/ClickHouse/ClickHouse/pull/81042) ([dependabot[bot]](https://github.com/apps/dependabot)).
* Добавлен `flake.nix` для сборок с использованием Nix. [#81463](https://github.com/ClickHouse/ClickHouse/pull/81463) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлена проблема, из-за которой `delta-kernel-rs` требовал сетевой доступ при сборке. Закрывает [#80609](https://github.com/ClickHouse/ClickHouse/issues/80609). [#81602](https://github.com/ClickHouse/ClickHouse/pull/81602) ([Konstantin Bogdanov](https://github.com/thevar1able)). Прочитайте статью [Год Rust в ClickHouse](https://clickhouse.com/blog/rust).

### Релиз ClickHouse 25.5, 2025-05-22 {#255}

#### Обратно несовместимые изменения

- Функция `geoToH3` теперь принимает входные данные в порядке (lat, lon, res) (что является стандартным для других геометрических функций). Пользователи, желающие сохранить прежний порядок аргументов (lon, lat, res), могут установить настройку `geotoh3_argument_order = 'lon_lat'`. [#78852](https://github.com/ClickHouse/ClickHouse/pull/78852) ([Pratima Patel](https://github.com/pratimapatel2008)).
- Добавлена настройка кэша файловой системы `allow_dynamic_cache_resize` (по умолчанию `false`) для разрешения динамического изменения размера кэша файловой системы. Обоснование: в некоторых окружениях (ClickHouse Cloud) все события масштабирования происходят через перезапуск процесса, и мы хотели бы явно отключить эту функцию для большего контроля над поведением, а также в качестве меры безопасности. Это изменение помечено как обратно несовместимое, поскольку в более старых версиях динамическое изменение размера кэша работало по умолчанию без специальной настройки. [#79148](https://github.com/ClickHouse/ClickHouse/pull/79148) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Удалена поддержка устаревших типов индексов `annoy` и `usearch`. Оба типа уже давно являлись заглушками, то есть любая попытка использовать устаревшие индексы в любом случае возвращала ошибку. Если у вас все еще есть индексы `annoy` и `usearch`, пожалуйста, удалите их. [#79802](https://github.com/ClickHouse/ClickHouse/pull/79802) ([Robert Schulze](https://github.com/rschu1ze)).
- Удалена серверная настройка `format_alter_commands_with_parentheses`. Настройка была введена и отключена по умолчанию в версии 24.2. Она была включена по умолчанию в версии 25.2. Поскольку нет LTS-версий, которые не поддерживают новый формат, мы можем удалить эту настройку. [#79970](https://github.com/ClickHouse/ClickHouse/pull/79970) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- По умолчанию включена реализация `delta-kernel-rs` для хранилища `DeltaLake`. [#79541](https://github.com/ClickHouse/ClickHouse/pull/79541) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Если чтение из `URL` включает несколько перенаправлений, настройка `enable_url_encoding` корректно применяется ко всем перенаправлениям в цепочке. [#79563](https://github.com/ClickHouse/ClickHouse/pull/79563) ([Shankar Iyer](https://github.com/shankar-iyer)). Значение по умолчанию для настройки `enble_url_encoding` теперь установлено в `false`. [#80088](https://github.com/ClickHouse/ClickHouse/pull/80088) ([Shankar Iyer](https://github.com/shankar-iyer)).


#### Новая функция

* Добавлена поддержка скалярных коррелированных подзапросов в предложении WHERE. Закрывает [#6697](https://github.com/ClickHouse/ClickHouse/issues/6697). [#79600](https://github.com/ClickHouse/ClickHouse/pull/79600) ([Dmitry Novik](https://github.com/novikd)). Добавлена поддержка коррелированных подзапросов в списке проекций в простых случаях. [#79925](https://github.com/ClickHouse/ClickHouse/pull/79925) ([Dmitry Novik](https://github.com/novikd)). [#76078](https://github.com/ClickHouse/ClickHouse/pull/76078) ([Dmitry Novik](https://github.com/novikd)). Теперь это покрывает 100% тестового набора TPC-H.
* Поиск по векторам с использованием индекса векторного сходства переведён в стадию бета-тестирования (ранее — экспериментальная функция). [#80164](https://github.com/ClickHouse/ClickHouse/pull/80164) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка географических типов данных в формате `Parquet`. Это закрывает [#75317](https://github.com/ClickHouse/ClickHouse/issues/75317). [#79777](https://github.com/ClickHouse/ClickHouse/pull/79777) ([scanhex12](https://github.com/scanhex12)).
* Новые функции `sparseGrams`, `sparseGramsHashes`, `sparseGramsHashesUTF8`, `sparseGramsUTF8` для вычисления «sparse-ngrams» — робастного алгоритма извлечения подстрок для индексирования и поиска. [#79517](https://github.com/ClickHouse/ClickHouse/pull/79517) ([scanhex12](https://github.com/scanhex12)).
* `clickhouse-local` (и его краткий псевдоним `ch`) теперь неявно используют `FROM table`, когда есть входные данные для обработки. Это закрывает [#65023](https://github.com/ClickHouse/ClickHouse/issues/65023). Также в `clickhouse-local` включено автоопределение формата, если не указан `--input-format` и обрабатывается обычный файл. [#79085](https://github.com/ClickHouse/ClickHouse/pull/79085) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлены функции `stringBytesUniq` и `stringBytesEntropy` для обнаружения потенциально случайных или зашифрованных данных. [#79350](https://github.com/ClickHouse/ClickHouse/pull/79350) ([Sachin Kumar Singh](https://github.com/sachinkumarsingh092)).
* Добавлены функции для кодирования и декодирования в Base32. [#79809](https://github.com/ClickHouse/ClickHouse/pull/79809) ([Joanna Hulboj](https://github.com/jh0x)).
* Добавлены функции `getServerSetting` и `getMergeTreeSetting`. Закрывает #78318. [#78439](https://github.com/ClickHouse/ClickHouse/pull/78439) ([NamNguyenHoai](https://github.com/NamHoaiNguyen)).
* Добавлена новая настройка `iceberg_enable_version_hint` для использования файла `version-hint.text`. [#78594](https://github.com/ClickHouse/ClickHouse/pull/78594) ([Arnaud Briche](https://github.com/arnaudbriche)).
* Предоставляет возможность выполнять TRUNCATE для отдельных таблиц в базе данных, отфильтрованных по шаблону с помощью ключевого слова `LIKE`. [#78597](https://github.com/ClickHouse/ClickHouse/pull/78597) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена поддержка виртуального столбца `_part_starting_offset` в таблицах семейства `MergeTree`. Этот столбец представляет собой накопительное количество строк во всех предшествующих партах, вычисляемое во время выполнения запроса на основе текущего списка партов. Накопительные значения сохраняются на протяжении всего выполнения запроса и остаются актуальными даже после отсечения партов. Связанная внутренняя логика была переработана для поддержки этого поведения. [#79417](https://github.com/ClickHouse/ClickHouse/pull/79417) ([Amos Bird](https://github.com/amosbird)).
* Добавлены функции `divideOrNull`, `moduloOrNull`, `intDivOrNull`, `positiveModuloOrNull`, которые возвращают NULL при нулевом правом аргументе. [#78276](https://github.com/ClickHouse/ClickHouse/pull/78276) ([kevinyhzou](https://github.com/KevinyhZou)).
* Векторный поиск в ClickHouse теперь поддерживает как предварительную, так и последующую фильтрацию и предоставляет соответствующие настройки для более тонкого управления. (issue [#78161](https://github.com/ClickHouse/ClickHouse/issues/78161)). [#79854](https://github.com/ClickHouse/ClickHouse/pull/79854) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Добавлены функции [`icebergHash`](https://iceberg.apache.org/spec/#appendix-b-32-bit-hash-requirements) и [`icebergBucket`](https://iceberg.apache.org/spec/#bucket-transform-details). Реализована поддержка отсечения файлов данных в таблицах `Iceberg`, разбитых на партиции с помощью [`bucket transfom`](https://iceberg.apache.org/spec/#partitioning). [#79262](https://github.com/ClickHouse/ClickHouse/pull/79262) ([Daniil Ivanik](https://github.com/divanik)).



#### Экспериментальные возможности
* Новые типы данных `Time`/`Time64`: `Time` (HHH:MM:SS) и `Time64` (HHH:MM:SS.`&lt;fractional&gt;`), а также некоторые базовые функции приведения типов и функции для взаимодействия с другими типами данных. Также переименована существующая функция `toTime` в `toTimeWithFixedDate`, поскольку имя `toTime` требуется для функции приведения типов. [#75735](https://github.com/ClickHouse/ClickHouse/pull/75735) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Каталог Hive Metastore для озера данных Iceberg. [#77677](https://github.com/ClickHouse/ClickHouse/pull/77677) ([scanhex12](https://github.com/scanhex12)).
* Индексы типа `full_text` были переименованы в `gin`. Это соответствует более привычной терминологии PostgreSQL и других систем управления базами данных. Существующие индексы типа `full_text` по-прежнему можно загружать, но при попытке использовать их в поиске они будут выбрасывать исключение (с рекомендацией использовать индексы `gin`). [#79024](https://github.com/ClickHouse/ClickHouse/pull/79024) ([Robert Schulze](https://github.com/rschu1ze)).



#### Улучшение производительности

* Изменён формат компактных частей (Compact) для сохранения меток для каждого подпотока, чтобы можно было читать отдельные подстолбцы. Старый компактный формат по-прежнему поддерживается для чтения и может быть включён для записи с помощью настройки MergeTree `write_marks_for_substreams_in_compact_parts`. По умолчанию она отключена для более безопасного обновления, поскольку меняет хранилище компактных частей. В одном из следующих релизов она будет включена по умолчанию. [#77940](https://github.com/ClickHouse/ClickHouse/pull/77940) ([Pavel Kruglov](https://github.com/Avogar)).
* Разрешено перемещение условий с подстолбцами в PREWHERE. [#79489](https://github.com/ClickHouse/ClickHouse/pull/79489) ([Pavel Kruglov](https://github.com/Avogar)).
* Ускорена работа вторичных индексов за счёт вычисления их выражений одновременно на нескольких гранулах. [#64109](https://github.com/ClickHouse/ClickHouse/pull/64109) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Параметр `compile_expressions` (JIT‑компилятор для фрагментов обычных выражений) теперь включён по умолчанию. Это закрывает задачи [#51264](https://github.com/ClickHouse/ClickHouse/issues/51264), [#56386](https://github.com/ClickHouse/ClickHouse/issues/56386) и [#66486](https://github.com/ClickHouse/ClickHouse/issues/66486). [#79907](https://github.com/ClickHouse/ClickHouse/pull/79907) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена новая настройка: `use_skip_indexes_in_final_exact_mode`. Если запрос к таблице `ReplacingMergeTree` содержит оператор FINAL, чтение только диапазонов таблицы, основанных на пропускающих индексах, может привести к некорректному результату. Эта настройка гарантирует корректные результаты за счёт сканирования более новых частей данных, которые пересекаются с диапазонами по первичному ключу, возвращёнными пропускающим индексом. Установите 0 для отключения, 1 для включения. [#78350](https://github.com/ClickHouse/ClickHouse/pull/78350) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Табличные функции для кластеров объектного хранилища (например, `s3Cluster`) теперь распределяют файлы между репликами для чтения на основе консистентного хэширования, чтобы улучшить локальность кэша. [#77326](https://github.com/ClickHouse/ClickHouse/pull/77326) ([Andrej Hoos](https://github.com/adikus)).
* Повышена производительность `S3Queue`/`AzureQueue` за счёт возможности выполнять вставку данных (`INSERT`) параллельно (можно включить настройкой очереди `parallel_inserts=true`). Ранее S3Queue/AzureQueue выполняли параллельно только первую часть конвейера (загрузка, парсинг), а `INSERT` выполнялся в одном потоке. При этом `INSERT` почти всегда является узким местом по производительности. Теперь производительность будет масштабироваться почти линейно с `processing_threads_num`. [#77671](https://github.com/ClickHouse/ClickHouse/pull/77671) ([Azat Khuzhin](https://github.com/azat)). Более справедливое значение параметра max&#95;processed&#95;files&#95;before&#95;commit в S3Queue/AzureQueue. [#79363](https://github.com/ClickHouse/ClickHouse/pull/79363) ([Azat Khuzhin](https://github.com/azat)).
* Введён порог (управляется настройкой `parallel_hash_join_threshold`), при котором выполняется откат к алгоритму `hash`, если размер правой таблицы меньше этого порога. [#76185](https://github.com/ClickHouse/ClickHouse/pull/76185) ([Nikita Taranov](https://github.com/nickitat)).
* Теперь мы используем количество реплик для определения размера задачи при чтении с включёнными параллельными репликами. Это обеспечивает более равномерное распределение нагрузки между репликами, когда объём данных для чтения не слишком велик. [#78695](https://github.com/ClickHouse/ClickHouse/pull/78695) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлена возможность параллельного слияния состояний `uniqExact` на финальном этапе распределённой агрегации. [#78703](https://github.com/ClickHouse/ClickHouse/pull/78703) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлено потенциальное ухудшение производительности параллельного слияния состояний `uniqExact` при агрегации по ключу. [#78724](https://github.com/ClickHouse/ClickHouse/pull/78724) ([Nikita Taranov](https://github.com/nickitat)).
* Сокращено количество вызовов к API List Blobs хранилища Azure. [#78860](https://github.com/ClickHouse/ClickHouse/pull/78860) ([Julia Kartseva](https://github.com/jkartseva)).
* Улучшена производительность распределённого INSERT SELECT с параллельными репликами. [#79441](https://github.com/ClickHouse/ClickHouse/pull/79441) ([Azat Khuzhin](https://github.com/azat)).
* Предотвращено выполнение очистки в `LogSeriesLimiter` при каждом создании экземпляра, что позволяет избежать конкуренции за блокировки и деградации производительности в высокопараллельных сценариях. [#79864](https://github.com/ClickHouse/ClickHouse/pull/79864) ([filimonov](https://github.com/filimonov)).
* Ускорено выполнение запросов за счет тривиальной оптимизации функции COUNT. [#79945](https://github.com/ClickHouse/ClickHouse/pull/79945) ([Raúl Marín](https://github.com/Algunenano)).
* Улучшен инлайнинг некоторых операций с `Decimal`. [#79999](https://github.com/ClickHouse/ClickHouse/pull/79999) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Параметр `input_format_parquet_bloom_filter_push_down` по умолчанию теперь имеет значение true. Также исправлена ошибка в истории изменений настроек. [#80058](https://github.com/ClickHouse/ClickHouse/pull/80058) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Оптимизированы мутации `ALTER ... DELETE` для кусков, в которых должны быть удалены все строки. Теперь в таких случаях вместо исходного куска создаётся пустой, и мутация не выполняется. [#79307](https://github.com/ClickHouse/ClickHouse/pull/79307) ([Anton Popov](https://github.com/CurtizJ)).
* Избегать лишнего копирования блока при вставке в часть Compact по возможности. [#79536](https://github.com/ClickHouse/ClickHouse/pull/79536) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена настройка `input_format_max_block_size_bytes`, позволяющая ограничить в байтах размер блоков, создаваемых во входных форматах. Это может помочь избежать высокого потребления памяти при импорте данных, когда строки содержат большие значения. [#79495](https://github.com/ClickHouse/ClickHouse/pull/79495) ([Pavel Kruglov](https://github.com/Avogar)).
* Удалены защитные страницы для потоков и async&#95;socket&#95;for&#95;remote/use&#95;hedge&#95;requests. Изменён метод выделения памяти в `FiberStack` с `mmap` на `aligned_alloc`. Это приводит к разбиению областей виртуальной памяти (VMA), из‑за чего при высокой нагрузке может быть достигнут предел vm.max&#95;map&#95;count. [#79147](https://github.com/ClickHouse/ClickHouse/pull/79147) ([Sema Checherinda](https://github.com/CheSema)).
* Ленивая материализация с параллельными репликами. [#79401](https://github.com/ClickHouse/ClickHouse/pull/79401) ([Igor Nikonov](https://github.com/devcrafter)).





#### Улучшение

* Добавлена возможность применять легковесные удаления на лету (с настройками `lightweight_deletes_sync = 0`, `apply_mutations_on_fly = 1`). [#79281](https://github.com/ClickHouse/ClickHouse/pull/79281) ([Anton Popov](https://github.com/CurtizJ)).
* Если данные в формате `Pretty` отображаются в терминале и последующий блок имеет те же ширины столбцов, что и предыдущий, его вывод может продолжаться с предыдущего блока, «склеиваясь» с ним за счёт перемещения курсора вверх. Это закрывает [#79333](https://github.com/ClickHouse/ClickHouse/issues/79333). Поведение настраивается новым параметром `output_format_pretty_glue_chunks`. [#79339](https://github.com/ClickHouse/ClickHouse/pull/79339) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Функция `isIPAddressInRange` расширена на типы данных `String`, `IPv4`, `IPv6`, `Nullable(String)`, `Nullable(IPv4)` и `Nullable(IPv6)`. [#78364](https://github.com/ClickHouse/ClickHouse/pull/78364) ([YjyJeff](https://github.com/YjyJeff)).
* Добавлена возможность динамически изменять настройки пула подключений движка `PostgreSQL`. [#78414](https://github.com/ClickHouse/ClickHouse/pull/78414) ([Samay Sharma](https://github.com/samay-sharma)).
* Разрешить указывать `_part_offset` в обычной проекции. Это первый шаг к построению индекса проекций. Его можно использовать вместе с [#58224](https://github.com/ClickHouse/ClickHouse/issues/58224), а также это может помочь улучшить #63207. [#78429](https://github.com/ClickHouse/ClickHouse/pull/78429) ([Amos Bird](https://github.com/amosbird)).
* Добавлены новые столбцы (`create_query` и `source`) в `system.named_collections`. Закрывает [#78179](https://github.com/ClickHouse/ClickHouse/issues/78179). [#78582](https://github.com/ClickHouse/ClickHouse/pull/78582) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Добавлено новое поле `condition` в системную таблицу `system.query_condition_cache`. В нём хранится условие в виде открытого текста, хэш которого используется в качестве ключа в кэше условий запросов. [#78671](https://github.com/ClickHouse/ClickHouse/pull/78671) ([Robert Schulze](https://github.com/rschu1ze)).
* Векторные индексы сходства теперь можно создавать на столбцах типа `BFloat16`. [#78850](https://github.com/ClickHouse/ClickHouse/pull/78850) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка Unix-временных меток с дробной частью при эвристическом (`best effort`) разборе `DateTime64`. [#78908](https://github.com/ClickHouse/ClickHouse/pull/78908) ([Pavel Kruglov](https://github.com/Avogar)).
* В реализации delta-kernel хранилища `DeltaLake` исправлена поддержка режима сопоставления столбцов, добавлены тесты на эволюцию схемы. [#78921](https://github.com/ClickHouse/ClickHouse/pull/78921) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Улучшена вставка в столбец `Variant` в формате Values благодаря более корректному преобразованию значений. [#78923](https://github.com/ClickHouse/ClickHouse/pull/78923) ([Pavel Kruglov](https://github.com/Avogar)).
* Функция `tokens` была расширена и теперь принимает дополнительный аргумент `tokenizer`, а также дополнительные аргументы, специфичные для выбранного токенизатора. [#79001](https://github.com/ClickHouse/ClickHouse/pull/79001) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Оператор `SHOW CLUSTER` теперь разворачивает макросы (если они есть) в своём аргументе. [#79006](https://github.com/ClickHouse/ClickHouse/pull/79006) ([arf42](https://github.com/arf42)).
* Хеш-функции теперь поддерживают `NULL` внутри массивов, кортежей и ассоциативных массивов (map) (issues [#48365](https://github.com/ClickHouse/ClickHouse/issues/48365) и [#48623](https://github.com/ClickHouse/ClickHouse/issues/48623)). [#79008](https://github.com/ClickHouse/ClickHouse/pull/79008) ([Michael Kolupaev](https://github.com/al13n321)).
* Обновлён cctz до версии 2025a. [#79043](https://github.com/ClickHouse/ClickHouse/pull/79043) ([Raúl Marín](https://github.com/Algunenano)).
* Изменена обработка stderr по умолчанию для UDF на «log&#95;last», что улучшает удобство использования. [#79066](https://github.com/ClickHouse/ClickHouse/pull/79066) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сделать вкладки в веб-интерфейсе поддерживающими отмену (undo). Закрывает [#71284](https://github.com/ClickHouse/ClickHouse/issues/71284). [#79084](https://github.com/ClickHouse/ClickHouse/pull/79084) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Удалены настройки при выполнении `recoverLostReplica` аналогично тому, как это было сделано в: [https://github.com/ClickHouse/ClickHouse/pull/78637](https://github.com/ClickHouse/ClickHouse/pull/78637). [#79113](https://github.com/ClickHouse/ClickHouse/pull/79113) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлены события профилирования `ParquetReadRowGroups` и `ParquetPrunedRowGroups` для анализа работы обрезки индекса Parquet. [#79180](https://github.com/ClickHouse/ClickHouse/pull/79180) ([flynn](https://github.com/ucasfl)).
* Добавлена поддержка операции `ALTER DATABASE ... ON CLUSTER`. [#79242](https://github.com/ClickHouse/ClickHouse/pull/79242) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Явно пропускайте пропущенные запуски сбора статистики для QueryMetricLog, иначе журналу потребуется много времени, чтобы синхронизироваться с текущим временем. [#79257](https://github.com/ClickHouse/ClickHouse/pull/79257) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Небольшие оптимизации чтения форматов на базе `Arrow`. [#79308](https://github.com/ClickHouse/ClickHouse/pull/79308) ([Bharat Nallan](https://github.com/bharatnc)).
* Настройка `allow_archive_path_syntax` была помечена как экспериментальная по ошибке. Добавлен тест, предотвращающий включение экспериментальных настроек по умолчанию. [#79320](https://github.com/ClickHouse/ClickHouse/pull/79320) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сделали настройки кэша страниц настраиваемыми на уровне отдельного запроса. Это нужно для более быстрого проведения экспериментов и возможности тонкой настройки запросов с высокой пропускной способностью и низкой задержкой. [#79337](https://github.com/ClickHouse/ClickHouse/pull/79337) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Не показывать подсказки с красивым форматированием для чисел, которые выглядят как большинство 64-битных хешей. Это закрывает [#79334](https://github.com/ClickHouse/ClickHouse/issues/79334). [#79338](https://github.com/ClickHouse/ClickHouse/pull/79338) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Цвета графиков на расширенных панелях мониторинга будут вычисляться на основе хеша соответствующего запроса. Это упрощает запоминание и поиск графика при прокрутке панели. [#79341](https://github.com/ClickHouse/ClickHouse/pull/79341) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена асинхронная метрика `FilesystemCacheCapacity` — общая ёмкость виртуальной файловой системы `cache`. Она полезна для глобального мониторинга инфраструктуры. [#79348](https://github.com/ClickHouse/ClickHouse/pull/79348) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Оптимизирован доступ к system.parts (чтение размеров столбцов и индексов выполняется только по запросу). [#79352](https://github.com/ClickHouse/ClickHouse/pull/79352) ([Azat Khuzhin](https://github.com/azat)).
* Вычислять только необходимые поля в запросе `'SHOW CLUSTER <name>'` вместо всех полей. [#79368](https://github.com/ClickHouse/ClickHouse/pull/79368) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Добавлена возможность указывать настройки хранилища для `DatabaseCatalog`. [#79407](https://github.com/ClickHouse/ClickHouse/pull/79407) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка локального хранилища в `DeltaLake`. [#79416](https://github.com/ClickHouse/ClickHouse/pull/79416) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена настройка на уровне запроса для включения delta-kernel-rs: `allow_experimental_delta_kernel_rs`. [#79418](https://github.com/ClickHouse/ClickHouse/pull/79418) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен возможный бесконечный цикл при перечислении blob-объектов в хранилище Azure/S3. [#79425](https://github.com/ClickHouse/ClickHouse/pull/79425) ([Alexander Gololobov](https://github.com/davenger)).
* Добавлена настройка кеша файловой системы `max_size_ratio_to_total_space`. [#79460](https://github.com/ClickHouse/ClickHouse/pull/79460) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Для `clickhouse-benchmark` параметр `reconnect` перенастроен так, чтобы принимать значения 0, 1 или N, задающие соответствующее количество переподключений. [#79465](https://github.com/ClickHouse/ClickHouse/pull/79465) ([Sachin Kumar Singh](https://github.com/sachinkumarsingh092)).
* Разрешено использование `ALTER TABLE ... MOVE|REPLACE PARTITION` для таблиц на разных дисках `plain_rewritable`. [#79566](https://github.com/ClickHouse/ClickHouse/pull/79566) ([Julia Kartseva](https://github.com/jkartseva)).
* Индекс векторного сходства теперь также используется, если опорный вектор имеет тип `Array(BFloat16)`. [#79745](https://github.com/ClickHouse/ClickHouse/pull/79745) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Добавлены last&#95;error&#95;message, last&#95;error&#95;trace и query&#95;id в таблицу system.error&#95;log. Связанный issue [#75816](https://github.com/ClickHouse/ClickHouse/issues/75816). [#79836](https://github.com/ClickHouse/ClickHouse/pull/79836) ([Andrei Tinikov](https://github.com/Dolso)).
* По умолчанию включена отправка отчётов о сбоях. Это можно отключить в конфигурационном файле сервера. [#79838](https://github.com/ClickHouse/ClickHouse/pull/79838) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Системная таблица `system.functions` теперь показывает, в какой версии ClickHouse функции впервые появились. [#79839](https://github.com/ClickHouse/ClickHouse/pull/79839) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена настройка `access_control_improvements.enable_user_name_access_type`. Эта настройка позволяет включать и отключать точные гранты для пользователей и ролей, добавленные в [https://github.com/ClickHouse/ClickHouse/pull/72246](https://github.com/ClickHouse/ClickHouse/pull/72246). Имеет смысл отключить эту настройку, если в вашем кластере есть реплики версии старше 25.1. [#79842](https://github.com/ClickHouse/ClickHouse/pull/79842) ([pufit](https://github.com/pufit)).
* Корректная реализация метода `ASTSelectWithUnionQuery::clone()` теперь также учитывает поле `is_normalized`. Это может помочь с [#77569](https://github.com/ClickHouse/ClickHouse/issues/77569). [#79909](https://github.com/ClickHouse/ClickHouse/pull/79909) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлено несогласованное форматирование некоторых запросов с оператором EXCEPT. Если левая часть оператора EXCEPT заканчивается на `*`, отформатированный запрос теряет круглые скобки и затем интерпретируется как `*` с модификатором `EXCEPT`. Эти запросы обнаруживаются фаззером и в реальной практике вряд ли встретятся. Это закрывает [#79950](https://github.com/ClickHouse/ClickHouse/issues/79950). [#79952](https://github.com/ClickHouse/ClickHouse/pull/79952) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Небольшое улучшение парсинга типа `JSON` за счёт использования кэша порядка десериализации вариантов. [#79984](https://github.com/ClickHouse/ClickHouse/pull/79984) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена настройка `s3_slow_all_threads_after_network_error`. [#80035](https://github.com/ClickHouse/ClickHouse/pull/80035) ([Vitaly Baranov](https://github.com/vitlibar)).
* Уровень логирования сообщений о выбранных для слияния частях был неверным (Information). Закрывает [#80061](https://github.com/ClickHouse/ClickHouse/issues/80061). [#80062](https://github.com/ClickHouse/ClickHouse/pull/80062) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* trace-visualizer: добавить runtime/share во всплывающие подсказки и статусные сообщения. [#79040](https://github.com/ClickHouse/ClickHouse/pull/79040) ([Sergei Trifonov](https://github.com/serxa)).
* trace-visualizer: загружать данные с сервера ClickHouse. [#79042](https://github.com/ClickHouse/ClickHouse/pull/79042) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлены метрики по неудачным слияниям. [#79228](https://github.com/ClickHouse/ClickHouse/pull/79228) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* `clickhouse-benchmark` будет отображать процент выполнения, исходя из максимального числа итераций, если оно указано. [#79346](https://github.com/ClickHouse/ClickHouse/pull/79346) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен визуализатор для таблицы system.parts. [#79437](https://github.com/ClickHouse/ClickHouse/pull/79437) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлен инструмент для анализа задержки выполнения запросов. [#79978](https://github.com/ClickHouse/ClickHouse/pull/79978) ([Sergei Trifonov](https://github.com/serxa)).





#### Исправление ошибки (некорректное поведение, видимое пользователю, в официальном стабильном релизе)

* Исправлена обработка переименования столбцов, отсутствующих в части. [#76346](https://github.com/ClickHouse/ClickHouse/pull/76346) ([Anton Popov](https://github.com/CurtizJ)).
* Материализованное представление может быть запущено слишком поздно, например уже после таблицы Kafka, которая подаёт в него данные. [#72123](https://github.com/ClickHouse/ClickHouse/pull/72123) ([Ilya Golshtein](https://github.com/ilejn)).
* Исправлено переписывание запроса `SELECT` при создании `VIEW` при включённом анализаторе. Закрывает [#75956](https://github.com/ClickHouse/ClickHouse/issues/75956). [#76356](https://github.com/ClickHouse/ClickHouse/pull/76356) ([Dmitry Novik](https://github.com/novikd)).
* Исправлено применение `async_insert` на стороне сервера (через `apply_settings_from_server`), которое ранее приводило к ошибкам `Unknown packet 11 from server` на клиенте. [#77578](https://github.com/ClickHouse/ClickHouse/pull/77578) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема, из-за которой обновляемое материализованное представление в реплицируемой базе данных не работало на новых репликах. [#77774](https://github.com/ClickHouse/ClickHouse/pull/77774) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена проблема, при которой обновляемые материализованные представления приводили к повреждению резервных копий. [#77893](https://github.com/ClickHouse/ClickHouse/pull/77893) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена старая логическая ошибка в `transform`. [#78247](https://github.com/ClickHouse/ClickHouse/pull/78247) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлены некоторые случаи, когда вторичный индекс не применялся анализатором. Исправляет [#65607](https://github.com/ClickHouse/ClickHouse/issues/65607), исправляет [#69373](https://github.com/ClickHouse/ClickHouse/issues/69373). [#78485](https://github.com/ClickHouse/ClickHouse/pull/78485) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена запись событий профилирования (`NetworkSendElapsedMicroseconds`/`NetworkSendBytes`) для протокола HTTP при включённом сжатии (погрешность не должна превышать размер буфера, обычно около 1MiB). [#78516](https://github.com/ClickHouse/ClickHouse/pull/78516) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен анализатор, вызывавший LOGICAL&#95;ERROR при использовании JOIN ... USING со столбцом ALIAS — теперь выдаётся соответствующая ошибка. [#78618](https://github.com/ClickHouse/ClickHouse/pull/78618) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлен анализатор: `CREATE VIEW ... ON CLUSTER` завершался ошибкой, если `SELECT` содержал позиционные аргументы. [#78663](https://github.com/ClickHouse/ClickHouse/pull/78663) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена ошибка `Block structure mismatch` при выполнении `INSERT SELECT` в табличную функцию с автоматическим определением схемы, если в `SELECT` используются скалярные подзапросы. [#78677](https://github.com/ClickHouse/ClickHouse/pull/78677) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлен анализатор: при установке prefer&#95;global&#95;in&#95;and&#95;join=1 для распределённой таблицы в запросе SELECT функция `in` должна заменяться на `globalIn`. [#78749](https://github.com/ClickHouse/ClickHouse/pull/78749) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлено несколько типов запросов `SELECT`, читающих из таблиц с движком `MongoDB` или табличной функции `mongodb`: запросы с неявным преобразованием константного значения в условии `WHERE` (например, `WHERE datetime = '2025-03-10 00:00:00'`); запросы с `LIMIT` и `GROUP BY`. Ранее они могли возвращать некорректный результат. [#78777](https://github.com/ClickHouse/ClickHouse/pull/78777) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено преобразование между различными типами JSON. Теперь оно выполняется путём простого приведения типов через преобразование к и от String. Это менее эффективно, но на 100% корректно. [#78807](https://github.com/ClickHouse/ClickHouse/pull/78807) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена логическая ошибка при преобразовании типа Dynamic в Interval. [#78813](https://github.com/ClickHouse/ClickHouse/pull/78813) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен откат столбца при ошибке разбора JSON. [#78836](https://github.com/ClickHouse/ClickHouse/pull/78836) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка &#39;bad cast&#39; при выполнении операции `JOIN` с использованием константного столбца-псевдонима. [#78848](https://github.com/ClickHouse/ClickHouse/pull/78848) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Запрещено использовать PREWHERE в материализованном представлении для столбцов, у которых типы данных в представлении и целевой таблице различаются. [#78889](https://github.com/ClickHouse/ClickHouse/pull/78889) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена логическая ошибка при разборе некорректных двоичных данных столбца типа Variant. [#78982](https://github.com/ClickHouse/ClickHouse/pull/78982) ([Pavel Kruglov](https://github.com/Avogar)).
* Теперь выбрасывается исключение, если размер пакета Parquet установлен в 0. Ранее при output&#95;format&#95;parquet&#95;batch&#95;size = 0 ClickHouse зависал. Теперь это поведение исправлено. [#78991](https://github.com/ClickHouse/ClickHouse/pull/78991) ([daryawessely](https://github.com/daryawessely)).
* Исправлена десериализация дискриминаторов Variant с базовым форматом в компактных частях. Она была внесена в [https://github.com/ClickHouse/ClickHouse/pull/55518](https://github.com/ClickHouse/ClickHouse/pull/55518). [#79000](https://github.com/ClickHouse/ClickHouse/pull/79000) ([Pavel Kruglov](https://github.com/Avogar)).
* Словари типа `complex_key_ssd_cache` теперь отклоняют нулевые или отрицательные значения параметров `block_size` и `write_buffer_size` (issue [#78314](https://github.com/ClickHouse/ClickHouse/issues/78314)). [#79028](https://github.com/ClickHouse/ClickHouse/pull/79028) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Следует избегать использования `Field` для неагрегатных столбцов в `SummingMergeTree`. Это может привести к неожиданным ошибкам при использовании типов `Dynamic`/`Variant` в `SummingMergeTree`. [#79051](https://github.com/ClickHouse/ClickHouse/pull/79051) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено чтение из материализованного представления с целевой таблицей типа Distributed и отличающимся заголовком в анализаторе. [#79059](https://github.com/ClickHouse/ClickHouse/pull/79059) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправляет ошибку, из-за которой `arrayUnion()` возвращала дополнительные (некорректные) значения в таблицах с пакетной вставкой данных. Исправляет [#75057](https://github.com/ClickHouse/ClickHouse/issues/75057). [#79079](https://github.com/ClickHouse/ClickHouse/pull/79079) ([Peter Nguyen](https://github.com/petern48)).
* Исправлен segfault в `OpenSSLInitializer`. Закрывает [#79092](https://github.com/ClickHouse/ClickHouse/issues/79092). [#79097](https://github.com/ClickHouse/ClickHouse/pull/79097) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Всегда задавайте префикс для операции S3 ListObject. [#79114](https://github.com/ClickHouse/ClickHouse/pull/79114) ([Azat Khuzhin](https://github.com/azat)).
* Исправляет ошибку, при которой arrayUnion() возвращала дополнительные (некорректные) значения для таблиц с пакетными вставками. Исправляет [#79157](https://github.com/ClickHouse/ClickHouse/issues/79157). [#79158](https://github.com/ClickHouse/ClickHouse/pull/79158) ([Peter Nguyen](https://github.com/petern48)).
* Исправлена логическая ошибка после проталкивания фильтра. [#79164](https://github.com/ClickHouse/ClickHouse/pull/79164) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлен движок таблиц DeltaLake при использовании реализации delta-kernel с HTTP-эндпоинтами, исправлена опция NOSIGN. Закрывает [#78124](https://github.com/ClickHouse/ClickHouse/issues/78124). [#79203](https://github.com/ClickHouse/ClickHouse/pull/79203) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправление в Keeper: предотвращено срабатывание наблюдателей для неуспешных multi-запросов. [#79247](https://github.com/ClickHouse/ClickHouse/pull/79247) ([Antonio Andelic](https://github.com/antonio2368)).
* Типы Dynamic и JSON запрещены в `IN`. При текущей реализации оператора `IN` это может приводить к некорректным результатам. Корректная поддержка этих типов в `IN` сложна и может быть реализована в будущем. [#79282](https://github.com/ClickHouse/ClickHouse/pull/79282) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена проверка дублирующихся путей при разборе типа JSON. [#79317](https://github.com/ClickHouse/ClickHouse/pull/79317) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлены проблемы с подключением через SecureStreamSocket. [#79383](https://github.com/ClickHouse/ClickHouse/pull/79383) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлена загрузка дисков plain&#95;rewritable, содержащих данные. [#79439](https://github.com/ClickHouse/ClickHouse/pull/79439) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлено аварийное завершение при обнаружении динамических подстолбцов в Wide-частях MergeTree. [#79466](https://github.com/ClickHouse/ClickHouse/pull/79466) ([Pavel Kruglov](https://github.com/Avogar)).
* Проверяйте длину имени таблицы только для первоначальных запросов CREATE. Не выполняйте эту проверку для последующих CREATE, чтобы избежать проблем с обратной совместимостью. [#79488](https://github.com/ClickHouse/ClickHouse/pull/79488) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Исправлена ошибка `Block structure mismatch` в ряде случаев для таблиц с разреженными столбцами. [#79491](https://github.com/ClickHouse/ClickHouse/pull/79491) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены два случая ошибки «Logical Error: Can&#39;t set alias of * of Asterisk on alias». [#79505](https://github.com/ClickHouse/ClickHouse/pull/79505) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено использование некорректных путей при переименовании базы данных с движком Atomic. [#79569](https://github.com/ClickHouse/ClickHouse/pull/79569) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлена сортировка по JSON-столбцу в сочетании с другими столбцами. [#79591](https://github.com/ClickHouse/ClickHouse/pull/79591) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено дублирование результатов при чтении с удалённого сервера, когда отключены `use_hedged_requests` и `allow_experimental_parallel_reading_from_replicas`. [#79599](https://github.com/ClickHouse/ClickHouse/pull/79599) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлена ошибка, приводившая к аварийному завершению работы реализации delta-kernel при использовании Unity Catalog. [#79677](https://github.com/ClickHouse/ClickHouse/pull/79677) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Обрабатывать макросы для кластеров с автообнаружением. [#79696](https://github.com/ClickHouse/ClickHouse/pull/79696) ([Anton Ivashkin](https://github.com/ianton-ru)).
* Корректная обработка некорректно настроенных page&#95;cache&#95;limits. [#79805](https://github.com/ClickHouse/ClickHouse/pull/79805) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправляет результат работы SQL-функции `formatDateTime`, если форматтер переменной длины (например, `%W`, то есть день недели `Monday`, `Tuesday` и т. д.) следует за составным форматтером (форматтером, который выводит несколько компонентов сразу, например, `%D`, то есть дата в американском формате `05/04/25`). [#79835](https://github.com/ClickHouse/ClickHouse/pull/79835) ([Robert Schulze](https://github.com/rschu1ze)).
* IcebergS3 поддерживает оптимизацию count, но IcebergS3Cluster — нет. В результате в кластерном режиме результат, возвращаемый функцией count(), может быть кратен количеству реплик. [#79844](https://github.com/ClickHouse/ClickHouse/pull/79844) ([wxybear](https://github.com/wxybear)).
* Исправляет ошибку AMBIGUOUS&#95;COLUMN&#95;NAME при ленивой материализации, когда до проекции ни один столбец не используется для выполнения запроса. Например, SELECT * FROM t ORDER BY rand() LIMIT 5. [#79926](https://github.com/ClickHouse/ClickHouse/pull/79926) ([Igor Nikonov](https://github.com/devcrafter)).
* Пароль в запросе `CREATE DATABASE datalake ENGINE = DataLakeCatalog(\'http://catalog:8181\', \'admin\', \'password\')` скрыт. [#79941](https://github.com/ClickHouse/ClickHouse/pull/79941) ([Han Fei](https://github.com/hanfei1991)).
* Добавлена возможность задавать псевдоним в JOIN USING. Указывайте этот псевдоним, если столбец был переименован (например, из-за ARRAY JOIN). Исправляет [#73707](https://github.com/ClickHouse/ClickHouse/issues/73707). [#79942](https://github.com/ClickHouse/ClickHouse/pull/79942) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Обеспечить корректную работу материализованных представлений с UNION на новых репликах. [#80037](https://github.com/ClickHouse/ClickHouse/pull/80037) ([Samay Sharma](https://github.com/samay-sharma)).
* Спецификатор формата `%e` в SQL-функции `parseDateTime` теперь распознает однозначные значения дня месяца (например, `3`), тогда как ранее требовалось добивание пробелом слева (например, ` 3`). Это делает его поведение совместимым с MySQL. Чтобы сохранить прежнее поведение, установите настройку `parsedatetime_e_requires_space_padding = 1`. (issue [#78243](https://github.com/ClickHouse/ClickHouse/issues/78243)). [#80057](https://github.com/ClickHouse/ClickHouse/pull/80057) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлены предупреждения `Cannot find 'kernel' in '[...]/memory.stat'` в журнале ClickHouse (issue [#77410](https://github.com/ClickHouse/ClickHouse/issues/77410)). [#80129](https://github.com/ClickHouse/ClickHouse/pull/80129) ([Robert Schulze](https://github.com/rschu1ze)).
* Проверять размер стека в FunctionComparison, чтобы избежать переполнения стека и последующего сбоя. [#78208](https://github.com/ClickHouse/ClickHouse/pull/78208) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлена гонка при выполнении запроса SELECT из `system.workloads`. [#78743](https://github.com/ClickHouse/ClickHouse/pull/78743) ([Sergei Trifonov](https://github.com/serxa)).
* Исправлена ленивая материализация в распределённых запросах. [#78815](https://github.com/ClickHouse/ClickHouse/pull/78815) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлено преобразование `Array(Bool)` в `Array(FixedString)`. [#78863](https://github.com/ClickHouse/ClickHouse/pull/78863) ([Nikita Taranov](https://github.com/nickitat)).
* Выбор версии Parquet сделан более понятным. [#78818](https://github.com/ClickHouse/ClickHouse/pull/78818) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлено поведение самослияния `ReservoirSampler`. [#79031](https://github.com/ClickHouse/ClickHouse/pull/79031) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлено хранение таблицы вставки данных в контексте клиента. [#79046](https://github.com/ClickHouse/ClickHouse/pull/79046) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлен порядок уничтожения членов данных класса в `AggregatingSortedAlgorithm` и `SummingSortedAlgorithm`. [#79056](https://github.com/ClickHouse/ClickHouse/pull/79056) ([Nikita Taranov](https://github.com/nickitat)).
* `enable_user_name_access_type` не должен влиять на тип доступа `DEFINER`. [#80026](https://github.com/ClickHouse/ClickHouse/pull/80026) ([pufit](https://github.com/pufit)).
* Запрос к системной базе данных может зависнуть, если её метаданные размещены в Keeper. [#79304](https://github.com/ClickHouse/ClickHouse/pull/79304) ([Mikhail Artemenko](https://github.com/Michicosun)).

#### Улучшения сборки/тестирования/упаковки

- Добавлена возможность повторного использования собранного бинарного файла `chcache` вместо его постоянной пересборки. [#78851](https://github.com/ClickHouse/ClickHouse/pull/78851) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Добавлено ожидание паузы NATS. [#78987](https://github.com/ClickHouse/ClickHouse/pull/78987) ([Dmitry Novikov](https://github.com/dmitry-sles-novikov)).
- Исправлена ошибка некорректной публикации ARM-сборки как amd64compat. [#79122](https://github.com/ClickHouse/ClickHouse/pull/79122) ([Alexander Gololobov](https://github.com/davenger)).
- Используется предварительно сгенерированный ассемблерный код для OpenSSL. [#79386](https://github.com/ClickHouse/ClickHouse/pull/79386) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Исправления для обеспечения возможности сборки с `clang20`. [#79588](https://github.com/ClickHouse/ClickHouse/pull/79588) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- `chcache`: поддержка кэширования Rust. [#78691](https://github.com/ClickHouse/ClickHouse/pull/78691) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Добавлена информация для раскрутки стека в ассемблерных файлах `zstd`. [#79288](https://github.com/ClickHouse/ClickHouse/pull/79288) ([Michael Kolupaev](https://github.com/al13n321)).

### Релиз ClickHouse 25.4, 2025-04-22 {#254}

#### Обратно несовместимые изменения

- Проверка соответствия всех столбцов материализованного представления целевой таблице, когда `allow_materialized_view_with_bad_select` установлен в `false`. [#74481](https://github.com/ClickHouse/ClickHouse/pull/74481) ([Christoph Wurm](https://github.com/cwurm)).
- Исправлены случаи использования `dateTrunc` с отрицательными аргументами Date/DateTime. [#77622](https://github.com/ClickHouse/ClickHouse/pull/77622) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Устаревшая интеграция `MongoDB` удалена. Серверная настройка `use_legacy_mongodb_integration` стала устаревшей и теперь не выполняет никаких действий. [#77895](https://github.com/ClickHouse/ClickHouse/pull/77895) ([Robert Schulze](https://github.com/rschu1ze)).
- Улучшена валидация `SummingMergeTree` для пропуска агрегации столбцов, используемых в ключах партиционирования или сортировки. [#78022](https://github.com/ClickHouse/ClickHouse/pull/78022) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).


#### Новая функция

* Добавлено планирование слотов CPU для рабочих нагрузок, подробности см. в [документации](https://clickhouse.com/docs/operations/workload-scheduling#cpu_scheduling). [#77595](https://github.com/ClickHouse/ClickHouse/pull/77595) ([Sergei Trifonov](https://github.com/serxa)).
* `clickhouse-local` будет сохранять свои базы данных после перезапуска, если указать аргумент командной строки `--path`. Исправляет [#50647](https://github.com/ClickHouse/ClickHouse/issues/50647). Исправляет [#49947](https://github.com/ClickHouse/ClickHouse/issues/49947). [#71722](https://github.com/ClickHouse/ClickHouse/pull/71722) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Отклонять запросы при перегрузке сервера. Решение принимается на основе соотношения времени ожидания (`OSCPUWaitMicroseconds`) к времени работы (`OSCPUVirtualTimeMicroseconds`). Запрос может быть отброшен с некоторой вероятностью, когда это соотношение находится в пределах от `min_os_cpu_wait_time_ratio_to_throw` до `max_os_cpu_wait_time_ratio_to_throw` (это настройки на уровне запроса). [#63206](https://github.com/ClickHouse/ClickHouse/pull/63206) ([Alexey Katsman](https://github.com/alexkats)).
* Путешествие во времени в `Iceberg`: добавлена настройка, позволяющая выполнять запросы к таблицам `Iceberg` в состоянии на момент, соответствующий заданной метке времени. [#71072](https://github.com/ClickHouse/ClickHouse/pull/71072) ([Brett Hoerner](https://github.com/bretthoerner)). [#77439](https://github.com/ClickHouse/ClickHouse/pull/77439) ([Daniil Ivanik](https://github.com/divanik)).
* Кэш метаданных `Iceberg` в памяти, который хранит файлы манифестов и их список, а также `metadata.json` для ускорения выполнения запросов. [#77156](https://github.com/ClickHouse/ClickHouse/pull/77156) ([Han Fei](https://github.com/hanfei1991)).
* Добавлена поддержка движка таблицы `DeltaLake` для Azure Blob Storage. Исправление [#68043](https://github.com/ClickHouse/ClickHouse/issues/68043). [#74541](https://github.com/ClickHouse/ClickHouse/pull/74541) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Добавлен кэш в памяти для десериализованных индексов сходства векторов. Это должно ускорить повторяющиеся запросы поиска приблизительных ближайших соседей (ANN). Размер нового кэша управляется серверными настройками `vector_similarity_index_cache_size` и `vector_similarity_index_cache_max_entries`. Эта возможность заменяет кэш пропускающего индекса из более ранних версий. [#77905](https://github.com/ClickHouse/ClickHouse/pull/77905) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Реализована поддержка отсечения партиций (partition pruning) в Delta Lake. [#78486](https://github.com/ClickHouse/ClickHouse/pull/78486) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Поддержка фонового обновления в таблицах `MergeTree` только для чтения, что позволяет выполнять запросы к обновляемым таблицам с неограниченным количеством распределённых читателей (родное для ClickHouse хранилище данных формата data lake). [#76467](https://github.com/ClickHouse/ClickHouse/pull/76467) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Поддерживается использование пользовательских дисков для хранения файлов метаданных баз данных. В настоящее время это можно настроить только на глобальном уровне сервера. [#77365](https://github.com/ClickHouse/ClickHouse/pull/77365) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Добавлена поддержка операций ALTER TABLE ... ATTACH|DETACH|MOVE|REPLACE PARTITION для диска plain&#95;rewritable. [#77406](https://github.com/ClickHouse/ClickHouse/pull/77406) ([Julia Kartseva](https://github.com/jkartseva)).
* Добавлены параметры таблицы для настройки `SASL` и учетных данных в движок таблиц `Kafka`. Это позволяет настраивать аутентификацию с использованием SASL для Kafka и совместимых с Kafka систем непосредственно в операторе CREATE TABLE, без необходимости использования конфигурационных файлов или именованных коллекций. [#78810](https://github.com/ClickHouse/ClickHouse/pull/78810) ([Christoph Wurm](https://github.com/cwurm)).
* Добавлена возможность задавать `default_compression_codec` для таблиц MergeTree: этот кодек используется, когда в запросе CREATE явно не указан кодек для соответствующих столбцов. Это закрывает [#42005](https://github.com/ClickHouse/ClickHouse/issues/42005). [#66394](https://github.com/ClickHouse/ClickHouse/pull/66394) ([gvoelfin](https://github.com/gvoelfin)).
* Добавьте настройку `bind_host` в конфигурацию кластеров, чтобы ClickHouse использовал определённую сеть для распределённых подключений. [#74741](https://github.com/ClickHouse/ClickHouse/pull/74741) ([Todd Yocum](https://github.com/toddyocum)).
* Добавлен новый столбец `parametrized_view_parameters` в таблицу `system.tables`. Закрывает [https://github.com/clickhouse/clickhouse/issues/66756](https://github.com/clickhouse/clickhouse/issues/66756). [#75112](https://github.com/ClickHouse/ClickHouse/pull/75112) ([NamNguyenHoai](https://github.com/NamHoaiNguyen)).
* Разрешено изменять комментарий базы данных. Закрывает [#73351](https://github.com/ClickHouse/ClickHouse/issues/73351) ### Запись в документации об изменениях, видимых пользователям. [#75622](https://github.com/ClickHouse/ClickHouse/pull/75622) ([NamNguyenHoai](https://github.com/NamHoaiNguyen)).
* Добавлена поддержка аутентификации `SCRAM-SHA-256` в протоколе совместимости с PostgreSQL. [#76839](https://github.com/ClickHouse/ClickHouse/pull/76839) ([scanhex12](https://github.com/scanhex12)).
* Добавлены функции `arrayLevenshteinDistance`, `arrayLevenshteinDistanceWeighted` и `arraySimilarity`. [#77187](https://github.com/ClickHouse/ClickHouse/pull/77187) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Настройка `parallel_distributed_insert_select` теперь действует для `INSERT SELECT` в `ReplicatedMergeTree` (ранее для этого требовались таблицы `Distributed`). [#78041](https://github.com/ClickHouse/ClickHouse/pull/78041) ([Igor Nikonov](https://github.com/devcrafter)).
* Добавлена функция `toInterval`. Эта функция принимает 2 аргумента (значение и единицу измерения) и преобразует значение в соответствующий тип `Interval`. [#78723](https://github.com/ClickHouse/ClickHouse/pull/78723) ([Andrew Davis](https://github.com/pulpdrew)).
* Добавлено несколько удобных способов определения корневого файла `metadata.json` в табличной функции и движке Iceberg. Закрывает [#78455](https://github.com/ClickHouse/ClickHouse/issues/78455). [#78475](https://github.com/ClickHouse/ClickHouse/pull/78475) ([Daniil Ivanik](https://github.com/divanik)).
* Реализована поддержка аутентификации по паролю по протоколу SSH в ClickHouse. [#78586](https://github.com/ClickHouse/ClickHouse/pull/78586) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).



#### Экспериментальная возможность
* Поддержка коррелированных подзапросов в качестве аргумента выражения `EXISTS` в предложении `WHERE`. Закрывает [#72459](https://github.com/ClickHouse/ClickHouse/issues/72459). [#76078](https://github.com/ClickHouse/ClickHouse/pull/76078) ([Dmitry Novik](https://github.com/novikd)).
* Добавлены функции `sparseGrams` и `sparseGramsHashes` с вариантами для ASCII и UTF8. Автор: [scanhex12](https://github.com/scanhex12). [#78176](https://github.com/ClickHouse/ClickHouse/pull/78176) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)). Не используйте их: реализация будет изменена в следующих версиях.



#### Улучшение производительности

* Оптимизирована производительность с помощью «ленивых» столбцов, которые читают данные только после применения ORDER BY и LIMIT. [#55518](https://github.com/ClickHouse/ClickHouse/pull/55518) ([Xiaozhe Yu](https://github.com/wudidapaopao)).
* По умолчанию включен кэш условий запросов. [#79080](https://github.com/ClickHouse/ClickHouse/pull/79080) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Ускорена сборка результата JOIN за счёт девиртуализации вызовов `col->insertFrom()`. [#77350](https://github.com/ClickHouse/ClickHouse/pull/77350) ([Alexander Gololobov](https://github.com/davenger)).
* Выполнено объединение условий равенства из шага плана запроса `FILTER` в условие `JOIN`, если это возможно, чтобы можно было использовать их в качестве ключей хеш-таблицы. [#78877](https://github.com/ClickHouse/ClickHouse/pull/78877) ([Dmitry Novik](https://github.com/novikd)).
* Используйте динамический шардинг для JOIN, если ключ JOIN является префиксом PK для обеих таблиц. Эта оптимизация включается с помощью настройки `query_plan_join_shard_by_pk_ranges` (по умолчанию отключена). [#74733](https://github.com/ClickHouse/ClickHouse/pull/74733) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлена поддержка отсечения данных в `Iceberg` на основе нижних и верхних границ значений столбцов. Исправляет [#77638](https://github.com/ClickHouse/ClickHouse/issues/77638). [#78242](https://github.com/ClickHouse/ClickHouse/pull/78242) ([alesapin](https://github.com/alesapin)).
* Реализована оптимизация тривиального подсчёта для `Iceberg`. Теперь запросы с `count()` и без каких-либо фильтров должны выполняться быстрее. Закрывает [#77639](https://github.com/ClickHouse/ClickHouse/issues/77639). [#78090](https://github.com/ClickHouse/ClickHouse/pull/78090) ([alesapin](https://github.com/alesapin)).
* Добавлена возможность настраивать количество столбцов, которые слияния могут параллельно сбрасывать на диск с помощью `max_merge_delayed_streams_for_parallel_write` (это должно примерно в 25 раз снизить потребление памяти при вертикальных слияниях в S3). [#77922](https://github.com/ClickHouse/ClickHouse/pull/77922) ([Azat Khuzhin](https://github.com/azat)).
* Отключайте `filesystem_cache_prefer_bigger_buffer_size` при пассивном использовании кэша, например при слияниях. Это снижает потребление памяти во время слияний. [#77898](https://github.com/ClickHouse/ClickHouse/pull/77898) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Теперь мы используем количество реплик для определения размера задачи чтения при включённых параллельных репликах. Это обеспечивает более равномерное распределение работы между репликами, когда объём читаемых данных не слишком велик. [#78695](https://github.com/ClickHouse/ClickHouse/pull/78695) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлена поддержка асинхронного предвыборочного чтения (prefetch) I/O для формата `ORC`, что повышает общую производительность за счёт скрытия задержек удалённого I/O. [#70534](https://github.com/ClickHouse/ClickHouse/pull/70534) ([李扬](https://github.com/taiyang-li)).
* Предварительно выделять память для асинхронных вставок, чтобы повысить производительность. [#74945](https://github.com/ClickHouse/ClickHouse/pull/74945) ([Ilya Golshtein](https://github.com/ilejn)).
* Снижено количество запросов к Keeper за счёт отказа от использования одиночных запросов `get`, которые могли создавать значительную нагрузку на Keeper при росте числа реплик, в местах, где доступен `multiRead`. [#56862](https://github.com/ClickHouse/ClickHouse/pull/56862) ([Nikolay Degterinsky](https://github.com/evillique)).
* Незначительная оптимизация выполнения функций с аргументами типа Nullable. [#76489](https://github.com/ClickHouse/ClickHouse/pull/76489) ([李扬](https://github.com/taiyang-li)).
* Оптимизация `arraySort`. [#76850](https://github.com/ClickHouse/ClickHouse/pull/76850) ([李扬](https://github.com/taiyang-li)).
* Объединены метки одной части и выполняется их единоразовая запись в кэш условий запроса для снижения затрат на блокировки. [#77377](https://github.com/ClickHouse/ClickHouse/pull/77377) ([zhongyuankai](https://github.com/zhongyuankai)).
* Оптимизирована производительность `s3Cluster` для запросов с одним расширением скобок. [#77686](https://github.com/ClickHouse/ClickHouse/pull/77686) ([Tomáš Hromada](https://github.com/gyfis)).
* Оптимизирован `ORDER BY` по отдельным столбцам типов `Nullable` или `LowCardinality`. [#77789](https://github.com/ClickHouse/ClickHouse/pull/77789) ([李扬](https://github.com/taiyang-li)).
* Оптимизировано использование памяти формата `Native`. [#78442](https://github.com/ClickHouse/ClickHouse/pull/78442) ([Azat Khuzhin](https://github.com/azat)).
* Тривиальная оптимизация: не переписывать `count(if(...))` в `countIf`, если требуется приведение типов. Закрывает [#78564](https://github.com/ClickHouse/ClickHouse/issues/78564). [#78565](https://github.com/ClickHouse/ClickHouse/pull/78565) ([李扬](https://github.com/taiyang-li)).
* Функция `hasAll` теперь может использовать пропускающие индексы полнотекстового поиска `tokenbf_v1`, `ngrambf_v1`. [#77662](https://github.com/ClickHouse/ClickHouse/pull/77662) ([UnamedRus](https://github.com/UnamedRus)).
* Индекс векторного сходства мог выделять оперативную память с избыточным запасом — до 2 раз больше необходимого. Это исправление перерабатывает стратегию выделения памяти, снижая её потребление и повышая эффективность кэша индекса векторного сходства. (issue [#78056](https://github.com/ClickHouse/ClickHouse/issues/78056)). [#78394](https://github.com/ClickHouse/ClickHouse/pull/78394) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Введена настройка `schema_type` для таблицы `system.metric_log`, задающая тип её схемы. Допустимы три варианта: `wide` — текущая схема, каждая метрика/событие в отдельном столбце (наиболее эффективно при чтении отдельных столбцов), `transposed` — похожа на `system.asynchronous_metric_log`, метрики/события хранятся по строкам, и наиболее интересная `transposed_with_wide_view` — создаётся базовая таблица со схемой `transposed`, а также представление со схемой `wide`, которое транслирует запросы в базовую таблицу. В случае `transposed_with_wide_view` субсекундное разрешение для представления не поддерживается, `event_time_microseconds` — это только псевдоним для обеспечения обратной совместимости. [#78412](https://github.com/ClickHouse/ClickHouse/pull/78412) ([alesapin](https://github.com/alesapin)).





#### Улучшение

* Сериализация плана запроса для запросов `Distributed`. Добавлена новая настройка `serialize_query_plan`. При её включении запросы к таблице `Distributed` будут использовать сериализованный план запроса для удалённого выполнения. Для этого в протокол TCP введён новый тип пакета; в конфигурацию сервера нужно добавить `<process_query_plan_packet>true</process_query_plan_packet>`, чтобы разрешить обработку этого пакета. [#69652](https://github.com/ClickHouse/ClickHouse/pull/69652) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлена поддержка чтения типа `JSON` и подколонок из представлений. [#76903](https://github.com/ClickHouse/ClickHouse/pull/76903) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена поддержка ALTER DATABASE ... ON CLUSTER. [#79242](https://github.com/ClickHouse/ClickHouse/pull/79242) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Обновления обновляемых материализованных представлений теперь фиксируются в `system.query_log`. [#71333](https://github.com/ClickHouse/ClickHouse/pull/71333) ([Michael Kolupaev](https://github.com/al13n321)).
* Пользовательские функции (UDF) теперь могут быть помечены как детерминированные с помощью нового параметра конфигурации. Кроме того, кэш запросов теперь проверяет, являются ли UDF, вызываемые внутри запроса, детерминированными. Если да, кэшируется результат запроса. (Issue [#59988](https://github.com/ClickHouse/ClickHouse/issues/59988)). [#77769](https://github.com/ClickHouse/ClickHouse/pull/77769) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
* Включена логика backoff для всех типов реплицируемых задач. Это позволит снизить загрузку CPU, потребление памяти и размеры журнальных файлов. Добавлены новые настройки `max_postpone_time_for_failed_replicated_fetches_ms`, `max_postpone_time_for_failed_replicated_merges_ms` и `max_postpone_time_for_failed_replicated_tasks_ms`, которые аналогичны `max_postpone_time_for_failed_mutations_ms`. [#74576](https://github.com/ClickHouse/ClickHouse/pull/74576) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Добавлен `query_id` в `system.errors`. Закрывает [#75815](https://github.com/ClickHouse/ClickHouse/issues/75815). [#76581](https://github.com/ClickHouse/ClickHouse/pull/76581) ([Vladimir Baikov](https://github.com/bkvvldmr)).
* Добавлена поддержка преобразования `UInt128` в `IPv6`. Это позволяет выполнять операцию `bitAnd` и арифметические операции над значениями типа `IPv6`, а также преобразовывать результаты обратно в `IPv6`. Закрывает [#76752](https://github.com/ClickHouse/ClickHouse/issues/76752). Кроме того, теперь результат операции `bitAnd` над `IPv6` также может быть преобразован обратно в `IPv6`. См. также [#57707](https://github.com/ClickHouse/ClickHouse/pull/57707). [#76928](https://github.com/ClickHouse/ClickHouse/pull/76928) ([Muzammil Abdul Rehman](https://github.com/muzammilar)).
* По умолчанию не выполнять разбор специальных значений `Bool` в текстовых форматах внутри типа `Variant`. Это можно включить с помощью настройки `allow_special_bool_values_inside_variant`. [#76974](https://github.com/ClickHouse/ClickHouse/pull/76974) ([Pavel Kruglov](https://github.com/Avogar)).
* Поддержка настройки времени ожидания для отдельных задач низкоприоритетных запросов на уровне сессии и на уровне сервера. [#77013](https://github.com/ClickHouse/ClickHouse/pull/77013) ([VicoWu](https://github.com/VicoWu)).
* Реализовано сравнение для значений типа данных JSON. Теперь JSON-объекты можно сравнивать так же, как объекты типа Map. [#77397](https://github.com/ClickHouse/ClickHouse/pull/77397) ([Pavel Kruglov](https://github.com/Avogar)).
* Улучшена поддержка прав доступа в `system.kafka_consumers`. Внутренние ошибки `librdkafka` теперь пробрасываются (стоит отметить, что эта библиотека откровенно плохая). [#77700](https://github.com/ClickHouse/ClickHouse/pull/77700) ([Ilya Golshtein](https://github.com/ilejn)).
* Добавлена проверка настроек движка таблицы Buffer. [#77840](https://github.com/ClickHouse/ClickHouse/pull/77840) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Добавлен параметр конфигурации `enable_hdfs_pread`, позволяющий включать или отключать `pread` в `HDFS`. [#77885](https://github.com/ClickHouse/ClickHouse/pull/77885) ([kevinyhzou](https://github.com/KevinyhZou)).
* Добавлены события профиля для числа запросов чтения и записи ZooKeeper `multi`. [#77888](https://github.com/ClickHouse/ClickHouse/pull/77888) ([JackyWoo](https://github.com/JackyWoo)).
* Разрешено создавать и вставлять данные во временные таблицы, когда включён параметр `disable_insertion_and_mutation`. [#77901](https://github.com/ClickHouse/ClickHouse/pull/77901) ([Xu Jia](https://github.com/XuJia0210)).
* Уменьшено значение `max_insert_delayed_streams_for_parallel_write` до 100. [#77919](https://github.com/ClickHouse/ClickHouse/pull/77919) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен разбор года в синтаксисе Joda (из мира Java, если вы вдруг задаётесь вопросом), например `yyy`. [#77973](https://github.com/ClickHouse/ClickHouse/pull/77973) ([李扬](https://github.com/taiyang-li)).
* Присоединение частей таблиц `MergeTree` теперь выполняется в порядке следования блоков, что важно для специальных алгоритмов слияния, таких как `ReplacingMergeTree`. Это закрывает [#71009](https://github.com/ClickHouse/ClickHouse/issues/71009). [#77976](https://github.com/ClickHouse/ClickHouse/pull/77976) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Правила маскировки запросов теперь могут выбрасывать `LOGICAL_ERROR` при совпадении. Это поможет проверить, не просачивается ли заранее заданный пароль в логи. [#78094](https://github.com/ClickHouse/ClickHouse/pull/78094) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлен столбец `index_length_column` в таблицу `information_schema.tables` для лучшей совместимости с MySQL. [#78119](https://github.com/ClickHouse/ClickHouse/pull/78119) ([Paweł Zakrzewski](https://github.com/KrzaQ)).
* Введены две новые метрики: `TotalMergeFailures` и `NonAbortedMergeFailures`. Эти метрики необходимы для обнаружения случаев, когда слишком много слияний завершается с ошибкой за короткий промежуток времени. [#78150](https://github.com/ClickHouse/ClickHouse/pull/78150) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Исправлен некорректный разбор URL S3, когда ключ не указан при использовании path-style адресации. [#78185](https://github.com/ClickHouse/ClickHouse/pull/78185) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлены некорректные значения асинхронных метрик `BlockActiveTime`, `BlockDiscardTime`, `BlockWriteTime`, `BlockQueueTime` и `BlockReadTime` (до изменения значение 1 секунды ошибочно сообщалось как 0.001). [#78211](https://github.com/ClickHouse/ClickHouse/pull/78211) ([filimonov](https://github.com/filimonov)).
* Теперь учитывается ограничение `loading_retries` для ошибок при отправке данных в материализованное представление для StorageS3(Azure)Queue. Ранее такие ошибки повторялись бесконечно. [#78313](https://github.com/ClickHouse/ClickHouse/pull/78313) ([Kseniia Sumarokova](https://github.com/kssenii)).
* В DeltaLake с реализацией `delta-kernel-rs` исправлены проблемы с производительностью и индикатором прогресса. [#78368](https://github.com/ClickHouse/ClickHouse/pull/78368) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка `include`, `from_env`, `from_zk` для runtime-дисков. Закрывает [#78177](https://github.com/ClickHouse/ClickHouse/issues/78177). [#78470](https://github.com/ClickHouse/ClickHouse/pull/78470) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлено динамическое предупреждение в таблицу `system.warnings` для длительно выполняющихся мутаций. [#78658](https://github.com/ClickHouse/ClickHouse/pull/78658) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлено поле `condition` в системную таблицу `system.query_condition_cache`. В нём хранится условие в виде открытого текста, хэш которого используется в качестве ключа в кэше условий запроса. [#78671](https://github.com/ClickHouse/ClickHouse/pull/78671) ([Robert Schulze](https://github.com/rschu1ze)).
* Теперь допускается пустое значение при секционировании Hive. [#78816](https://github.com/ClickHouse/ClickHouse/pull/78816) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлено приведение типов в условии `IN` для `BFloat16` (то есть теперь `SELECT toBFloat16(1) IN [1, 2, 3];` возвращает `1`). Закрывает [#78754](https://github.com/ClickHouse/ClickHouse/issues/78754). [#78839](https://github.com/ClickHouse/ClickHouse/pull/78839) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Не проверять части на других дисках для таблиц `MergeTree`, если установлен параметр `disk = ...`. [#78855](https://github.com/ClickHouse/ClickHouse/pull/78855) ([Azat Khuzhin](https://github.com/azat)).
* Типы данных в `used_data_type_families` в `system.query_log` теперь записываются с каноническими именами. [#78972](https://github.com/ClickHouse/ClickHouse/pull/78972) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Очистка настроек в процессе `recoverLostReplica` аналогично тому, как это было сделано в [#78637](https://github.com/ClickHouse/ClickHouse/pull/78637). [#79113](https://github.com/ClickHouse/ClickHouse/pull/79113) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Используйте столбцы вставки для определения схемы INFILE. [#78490](https://github.com/ClickHouse/ClickHouse/pull/78490) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).





#### Исправление ошибки (некорректное поведение, видимое пользователю, в официальном стабильном релизе)

* Исправлен некорректный анализ проекций при использовании `count(Nullable)` в агрегатных проекциях. Исправлена проблема [#74495](https://github.com/ClickHouse/ClickHouse/issues/74495). В этот PR также добавлено дополнительное логирование анализа проекций, чтобы прояснить, почему проекция используется или нет. [#74498](https://github.com/ClickHouse/ClickHouse/pull/74498) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка `Part <...> does not contain in snapshot of previous virtual parts. (PART_IS_TEMPORARILY_LOCKED)`, возникавшая при выполнении `DETACH PART`. [#76039](https://github.com/ClickHouse/ClickHouse/pull/76039) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Исправлена проблема некорректной работы пропускающих индексов с выражениями, содержащими литералы, в анализаторе, а также удалены тривиальные приведения типов при анализе индексов. [#77229](https://github.com/ClickHouse/ClickHouse/pull/77229) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка, из-за которой параметр запроса `close_session` не действовал, и именованные сессии закрывались только после истечения `session_timeout`. [#77336](https://github.com/ClickHouse/ClickHouse/pull/77336) ([Alexey Katsman](https://github.com/alexkats)).
* Исправлено получение сообщений с сервера NATS без подключённых материализованных представлений. [#77392](https://github.com/ClickHouse/ClickHouse/pull/77392) ([Dmitry Novikov](https://github.com/dmitry-sles-novikov)).
* Исправлена логическая ошибка при чтении из пустого `FileLog` через табличную функцию `merge`, закрыта задача [#75575](https://github.com/ClickHouse/ClickHouse/issues/75575). [#77441](https://github.com/ClickHouse/ClickHouse/pull/77441) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Использовать настройки формата по умолчанию в сериализации `Dynamic` общего варианта. [#77572](https://github.com/ClickHouse/ClickHouse/pull/77572) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена проверка наличия пути к данным таблицы на локальном диске. [#77608](https://github.com/ClickHouse/ClickHouse/pull/77608) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлена отправка константных значений на удалённые серверы для некоторых типов. [#77634](https://github.com/ClickHouse/ClickHouse/pull/77634) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен сбой из-за просроченного контекста в S3/AzureQueue. [#77720](https://github.com/ClickHouse/ClickHouse/pull/77720) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Скрывать учетные данные в движках таблиц RabbitMQ, Nats, Redis и AzureQueue. [#77755](https://github.com/ClickHouse/ClickHouse/pull/77755) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено неопределённое поведение при сравнении значений `NaN` в функциях `argMin`/`argMax`. [#77756](https://github.com/ClickHouse/ClickHouse/pull/77756) ([Raúl Marín](https://github.com/Algunenano)).
* Регулярно проверяйте, не были ли слияния и мутации отменены, даже если операция не создает блоков для записи. [#77766](https://github.com/ClickHouse/ClickHouse/pull/77766) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлена проблема, из-за которой обновляемое материализованное представление в базе данных Replicated не работало на новых репликах. [#77774](https://github.com/ClickHouse/ClickHouse/pull/77774) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлено возможное аварийное завершение работы при возникновении ошибки `NOT_FOUND_COLUMN_IN_BLOCK`. [#77854](https://github.com/ClickHouse/ClickHouse/pull/77854) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлена ошибка, приводившая к сбою в S3/AzureQueue при заполнении данными. [#77878](https://github.com/ClickHouse/ClickHouse/pull/77878) ([Bharat Nallan](https://github.com/bharatnc)).
* Отключен нечеткий поиск по истории в SSH-сервере (так как для него требуется библиотека skim). [#78002](https://github.com/ClickHouse/ClickHouse/pull/78002) ([Azat Khuzhin](https://github.com/azat)).
* Исправляет ошибку, из-за которой запрос векторного поиска по неиндексированному столбцу возвращал некорректные результаты, если в таблице был другой векторный столбец с заданным индексом векторного сходства. (Issue [#77978](https://github.com/ClickHouse/ClickHouse/issues/77978)). [#78069](https://github.com/ClickHouse/ClickHouse/pull/78069) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Исправлена мелкая ошибка в запросе подтверждения &quot;The requested output format {} is binary... Do you want to output it anyway? [y/N]&quot;. [#78095](https://github.com/ClickHouse/ClickHouse/pull/78095) ([Azat Khuzhin](https://github.com/azat)).
* Исправление ошибки при использовании `toStartOfInterval` с аргументом origin, равным нулю. [#78096](https://github.com/ClickHouse/ClickHouse/pull/78096) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Запрещена передача пустого параметра запроса `session_id` в HTTP-интерфейсе. [#78098](https://github.com/ClickHouse/ClickHouse/pull/78098) ([Alexey Katsman](https://github.com/alexkats)).
* Исправлена ошибка, из-за которой в базе данных `Replicated` могло происходить переопределение метаданных при выполнении запроса `RENAME` сразу после запроса `ALTER`. [#78107](https://github.com/ClickHouse/ClickHouse/pull/78107) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлен сбой в движке `NATS`. [#78108](https://github.com/ClickHouse/ClickHouse/pull/78108) ([Dmitry Novikov](https://github.com/dmitry-sles-novikov)).
* Не пытайтесь создавать history&#95;file во встроенном SSH-клиенте (в предыдущих версиях его создание всегда завершалось с ошибкой, хотя попытка предпринималась). [#78112](https://github.com/ClickHouse/ClickHouse/pull/78112) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема, из-за которой `system.detached_tables` отображала некорректную информацию после выполнения запросов `RENAME DATABASE` или `DROP TABLE`. [#78126](https://github.com/ClickHouse/ClickHouse/pull/78126) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена проверка на слишком большое количество таблиц в базе данных `Replicated` после [#77274](https://github.com/ClickHouse/ClickHouse/pull/77274). Теперь проверка выполняется до создания хранилища, чтобы избежать создания неучтённых узлов в Keeper в случае `ReplicatedMergeTree` или `KeeperMap`. [#78127](https://github.com/ClickHouse/ClickHouse/pull/78127) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена возможная аварийная остановка из‑за конкурентной инициализации метаданных `S3Queue`. [#78131](https://github.com/ClickHouse/ClickHouse/pull/78131) ([Azat Khuzhin](https://github.com/azat)).
* Функции `groupArray*` теперь выдают ошибку `BAD_ARGUMENTS` для значения 0 целочисленного типа Int в аргументе `max_size` (как это уже делается для значения типа UInt), вместо попытки выполнить функцию с ним. [#78140](https://github.com/ClickHouse/ClickHouse/pull/78140) ([Eduard Karacharov](https://github.com/korowa)).
* Предотвращён сбой при восстановлении потерянной реплики, когда локальная таблица была удалена до её отсоединения. [#78173](https://github.com/ClickHouse/ClickHouse/pull/78173) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена ошибка, из-за которой столбец &quot;alterable&quot; в `system.s3_queue_settings` всегда возвращал `false`. [#78187](https://github.com/ClickHouse/ClickHouse/pull/78187) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Маскировать сигнатуру доступа Azure, чтобы она не отображалась пользователю и в журналах. [#78189](https://github.com/ClickHouse/ClickHouse/pull/78189) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена предзагрузка подпотоков с префиксами в Wide-частях. [#78205](https://github.com/ClickHouse/ClickHouse/pull/78205) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлены падения и некорректные результаты для `mapFromArrays` в случае, когда массив ключей имеет тип `LowCardinality(Nullable)`. [#78240](https://github.com/ClickHouse/ClickHouse/pull/78240) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлены настройки аутентификации для delta-kernel-rs. [#78255](https://github.com/ClickHouse/ClickHouse/pull/78255) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Не планировать задачу Refreshable Materialized Views, если для реплики параметр `disable_insertion_and_mutation` установлен в true. Задача представляет собой операцию вставки и завершится с ошибкой, если `disable_insertion_and_mutation` равно true. [#78277](https://github.com/ClickHouse/ClickHouse/pull/78277) ([Xu Jia](https://github.com/XuJia0210)).
* Добавлена проверка доступа к базовым таблицам для движка `Merge`. [#78339](https://github.com/ClickHouse/ClickHouse/pull/78339) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Модификатор `FINAL` может игнорироваться при выполнении запроса к таблице `Distributed`. [#78428](https://github.com/ClickHouse/ClickHouse/pull/78428) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* `bitmapMin` возвращает uint32&#95;max, когда битовая карта пуста (и uint64&#95;max, когда входной тип имеет больший размер), что соответствует поведению минимума пустого roaring&#95;bitmap. [#78444](https://github.com/ClickHouse/ClickHouse/pull/78444) ([wxybear](https://github.com/wxybear)).
* Отключена параллелизация обработки запроса сразу после чтения секции FROM при включённом режиме `distributed_aggregation_memory_efficient`, так как это могло приводить к логической ошибке. Закрывает [#76934](https://github.com/ClickHouse/ClickHouse/issues/76934). [#78500](https://github.com/ClickHouse/ClickHouse/pull/78500) ([flynn](https://github.com/ucasfl)).
* Теперь всегда устанавливается как минимум один поток на чтение на случай, если после применения настройки `max_streams_to_max_threads_ratio` не остаётся ни одного запланированного потока. [#78505](https://github.com/ClickHouse/ClickHouse/pull/78505) ([Eduard Karacharov](https://github.com/korowa)).
* В хранилище `S3Queue` исправлена логическая ошибка «Cannot unregister: table uuid is not registered». Исправление закрывает [#78285](https://github.com/ClickHouse/ClickHouse/issues/78285). [#78541](https://github.com/ClickHouse/ClickHouse/pull/78541) ([Kseniia Sumarokova](https://github.com/kssenii)).
* ClickHouse теперь умеет определять свой cgroup v2 в системах, где одновременно включены cgroups v1 и v2. [#78566](https://github.com/ClickHouse/ClickHouse/pull/78566) ([Grigory Korolev](https://github.com/gkorolev)).
* Функции таблиц `-Cluster` выдавали ошибку при использовании с настройками на уровне таблицы. [#78587](https://github.com/ClickHouse/ClickHouse/pull/78587) ([Daniil Ivanik](https://github.com/divanik)).
* Улучшены проверки для операций INSERT, когда транзакции не поддерживаются ReplicatedMergeTree. [#78633](https://github.com/ClickHouse/ClickHouse/pull/78633) ([Azat Khuzhin](https://github.com/azat)).
* Очистка настроек запроса при выполнении ATTACH. [#78637](https://github.com/ClickHouse/ClickHouse/pull/78637) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено аварийное завершение при указании недопустимого пути в `iceberg_metadata_file_path`. [#78688](https://github.com/ClickHouse/ClickHouse/pull/78688) ([alesapin](https://github.com/alesapin)).
* В движке таблиц `DeltaLake` с реализацией delta-kernel-s исправлен случай, когда схема чтения отличается от схемы таблицы и при этом присутствуют колонки партиционирования, что приводило к ошибке «column not found». [#78690](https://github.com/ClickHouse/ClickHouse/pull/78690) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проблема, при которой после планирования закрытия именованной сессии (но до истечения тайм-аута) создание новой именованной сессии с тем же именем приводило к её закрытию в момент, когда было запланировано закрытие первой сессии. [#78698](https://github.com/ClickHouse/ClickHouse/pull/78698) ([Alexey Katsman](https://github.com/alexkats)).
* Исправлено несколько типов запросов `SELECT`, читающих из таблиц с движком `MongoDB` или с использованием табличной функции `mongodb`: запросы с неявным преобразованием константного значения в предложении `WHERE` (например, `WHERE datetime = '2025-03-10 00:00:00'`); запросы с `LIMIT` и `GROUP BY`. Ранее они могли возвращать неверные результаты. [#78777](https://github.com/ClickHouse/ClickHouse/pull/78777) ([Anton Popov](https://github.com/CurtizJ)).
* Не блокировать остановку таблицы во время выполнения `CHECK TABLE`. [#78782](https://github.com/ClickHouse/ClickHouse/pull/78782) ([Raúl Marín](https://github.com/Algunenano)).
* Исправление в Keeper: скорректирован подсчет эфемерных узлов во всех случаях. [#78799](https://github.com/ClickHouse/ClickHouse/pull/78799) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено некорректное приведение типов (`cast`) в `StorageDistributed` при использовании табличных функций, отличных от `view`. Закрывает [#78464](https://github.com/ClickHouse/ClickHouse/issues/78464). [#78828](https://github.com/ClickHouse/ClickHouse/pull/78828) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Приведено к единому виду форматирование для `tupleElement(*, 1)`. Закрывает [#78639](https://github.com/ClickHouse/ClickHouse/issues/78639). [#78832](https://github.com/ClickHouse/ClickHouse/pull/78832) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Словари типа `ssd_cache` теперь отклоняют нулевые или отрицательные значения параметров `block_size` и `write_buffer_size` (issue [#78314](https://github.com/ClickHouse/ClickHouse/issues/78314)). [#78854](https://github.com/ClickHouse/ClickHouse/pull/78854) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Исправлен сбой в Refreshable MATERIALIZED VIEW при выполнении ALTER после некорректного завершения работы. [#78858](https://github.com/ClickHouse/ClickHouse/pull/78858) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена обработка некорректных значений типа `DateTime` в формате `CSV`. [#78919](https://github.com/ClickHouse/ClickHouse/pull/78919) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправление в Keeper: теперь наблюдения (watches) не срабатывают при неуспешных multi-запросах. [#79247](https://github.com/ClickHouse/ClickHouse/pull/79247) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка при чтении таблицы Iceberg, возникавшая, когда явно задавались минимальные и максимальные значения, равные `NULL`. Отмечено, что библиотека Go Iceberg может генерировать такие некорректные файлы. Закрывает [#78740](https://github.com/ClickHouse/ClickHouse/issues/78740). [#78764](https://github.com/ClickHouse/ClickHouse/pull/78764) ([flynn](https://github.com/ucasfl)).

#### Улучшения сборки/тестирования/упаковки

- Учёт целевых возможностей процессора в Rust и включение LTO во всех crate. [#78590](https://github.com/ClickHouse/ClickHouse/pull/78590) ([Raúl Marín](https://github.com/Algunenano)).

### Релиз ClickHouse 25.3 LTS, 2025-03-20 {#253}

#### Обратно несовместимые изменения

- Запрещена операция TRUNCATE для реплицируемых баз данных. [#76651](https://github.com/ClickHouse/ClickHouse/pull/76651) ([Bharat Nallan](https://github.com/bharatnc)).
- Отменено кэширование skipping-индексов. [#77447](https://github.com/ClickHouse/ClickHouse/pull/77447) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).


#### Новая функция

* Тип данных `JSON` готов к использованию в продакшене. См. также [https://jsonbench.com/](https://jsonbench.com/). Типы данных `Dynamic` и `Variant` готовы к использованию в продакшене. [#77785](https://github.com/ClickHouse/ClickHouse/pull/77785) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка протокола SSH для clickhouse-server. Теперь к ClickHouse можно подключаться с помощью любого SSH‑клиента. Это закрывает задачу: [#74340](https://github.com/ClickHouse/ClickHouse/issues/74340). [#74989](https://github.com/ClickHouse/ClickHouse/pull/74989) ([George Gamezardashvili](https://github.com/Infjoker)).
* Замените табличные функции на их варианты с суффиксом -Cluster, если включены параллельные реплики. Исправляет [#65024](https://github.com/ClickHouse/ClickHouse/issues/65024). [#70659](https://github.com/ClickHouse/ClickHouse/pull/70659) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Новая реализация Userspace Page Cache, которая позволяет кэшировать данные в памяти текущего процесса вместо использования страничного кэша ОС, что полезно, когда данные хранятся на удалённой виртуальной файловой системе без локального файлового кэша. [#70509](https://github.com/ClickHouse/ClickHouse/pull/70509) ([Michael Kolupaev](https://github.com/al13n321)).
* Добавлена серверная настройка `concurrent_threads_scheduler`, которая определяет, как распределяются слоты ЦП между одновременными запросами. Её можно установить в значение `round_robin` (предыдущее поведение) или `fair_round_robin`, чтобы устранить проблему несправедливого распределения ЦП между операциями INSERT и SELECT. [#75949](https://github.com/ClickHouse/ClickHouse/pull/75949) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена агрегатная функция `estimateCompressionRatio` [#70801](https://github.com/ClickHouse/ClickHouse/issues/70801). [#76661](https://github.com/ClickHouse/ClickHouse/pull/76661) ([Tariq Almawash](https://github.com/talmawash)).
* Добавлена функция `arraySymmetricDifference`. Она возвращает все элементы из нескольких массивов-аргументов, которые не присутствуют во всех массивах одновременно. Пример: `SELECT arraySymmetricDifference([1, 2], [2, 3])` возвращает `[1, 3]`. (issue [#61673](https://github.com/ClickHouse/ClickHouse/issues/61673)). [#76231](https://github.com/ClickHouse/ClickHouse/pull/76231) ([Filipp Abapolov](https://github.com/pheepa)).
* Добавлена возможность явно указывать файл метаданных Iceberg для чтения с помощью настройки хранилища/табличной функции `iceberg_metadata_file_path`. Исправляет [#47412](https://github.com/ClickHouse/ClickHouse/issues/47412). [#77318](https://github.com/ClickHouse/ClickHouse/pull/77318) ([alesapin](https://github.com/alesapin)).
* Добавлена функция хеширования `keccak256`, часто используемая в реализациях блокчейна, особенно в системах на основе EVM. [#76669](https://github.com/ClickHouse/ClickHouse/pull/76669) ([Arnaud Briche](https://github.com/arnaudbriche)).
* Добавлены три новые функции: `icebergTruncate` согласно спецификации [https://iceberg.apache.org/spec/#truncate-transform-details](https://iceberg.apache.org/spec/#truncate-transform-details), `toYearNumSinceEpoch` и `toMonthNumSinceEpoch`. Добавлена поддержка преобразования `truncate` при отсечении партиций для движка `Iceberg`. [#77403](https://github.com/ClickHouse/ClickHouse/pull/77403) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка типов данных `LowCardinality(Decimal)` [#72256](https://github.com/ClickHouse/ClickHouse/issues/72256). [#72833](https://github.com/ClickHouse/ClickHouse/pull/72833) ([zhanglistar](https://github.com/zhanglistar)).
* Профильные события `FilterTransformPassedRows` и `FilterTransformPassedBytes` будут показывать количество строк и байт, отфильтрованных во время выполнения запроса. [#76662](https://github.com/ClickHouse/ClickHouse/pull/76662) ([Onkar Deshpande](https://github.com/onkar)).
* Поддержка метрик типа histogram. Интерфейс во многом повторяет клиентскую библиотеку Prometheus, где вы просто вызываете `observe(value)`, чтобы увеличить счётчик в бакете, соответствующем значению. Метрики типа histogram доступны через `system.histogram_metrics`. [#75736](https://github.com/ClickHouse/ClickHouse/pull/75736) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Поддержка неконстантного CASE с переключением по явным значениям. [#77399](https://github.com/ClickHouse/ClickHouse/pull/77399) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).



#### Экспериментальные возможности
* Добавлена поддержка [Unity Catalog](https://www.databricks.com/product/unity-catalog) для таблиц Delta Lake поверх AWS S3 и локальной файловой системы. [#76988](https://github.com/ClickHouse/ClickHouse/pull/76988) ([alesapin](https://github.com/alesapin)).
* Введена экспериментальная интеграция с каталогом сервиса AWS Glue для таблиц Iceberg. [#77257](https://github.com/ClickHouse/ClickHouse/pull/77257) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка динамического автообнаружения кластеров. Это расширяет существующую функциональность автообнаружения _узлов_. ClickHouse теперь может автоматически обнаруживать и регистрировать новые _кластеры_ в рамках общего пути в ZooKeeper с использованием `<multicluster_root_path>`. [#76001](https://github.com/ClickHouse/ClickHouse/pull/76001) ([Anton Ivashkin](https://github.com/ianton-ru)).
* Добавлена возможность автоматической очистки слиянием целых партиций по истечении настраиваемого таймаута с помощью нового параметра `enable_replacing_merge_with_cleanup_for_min_age_to_force_merge`. [#76440](https://github.com/ClickHouse/ClickHouse/pull/76440) ([Christoph Wurm](https://github.com/cwurm)).



#### Повышение производительности
* Реализован кэш условий запросов для улучшения производительности запросов с повторяющимися условиями. Диапазон данных, не удовлетворяющих условию, запоминается как временный индекс в памяти. Последующие запросы будут использовать этот индекс. Закрыты задачи [#67768](https://github.com/ClickHouse/ClickHouse/issues/67768) [#69236](https://github.com/ClickHouse/ClickHouse/pull/69236) ([zhongyuankai](https://github.com/zhongyuankai)).
* Активное вытеснение данных из кэша при удалении частей. Кэш не разрастается до максимального размера, если объём данных меньше. [#76641](https://github.com/ClickHouse/ClickHouse/pull/76641) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Заменены `Int256` и `UInt256` на встроенный в clang `i256` в арифметических вычислениях, что даёт прирост производительности [#70502](https://github.com/ClickHouse/ClickHouse/issues/70502). [#73658](https://github.com/ClickHouse/ClickHouse/pull/73658) ([李扬](https://github.com/taiyang-li)).
* В некоторых случаях (например, пустой столбец массива) части могут содержать пустые файлы. Можно пропускать запись пустых blob-объектов в `ObjectStorage` и сохранять только метаданные для таких файлов, когда таблица находится на диске с раздельным хранением метаданных и объектов. [#75860](https://github.com/ClickHouse/ClickHouse/pull/75860) ([Alexander Gololobov](https://github.com/davenger)).
* Повышена производительность вычисления `min`/`max` для `Decimal32`/`Decimal64`/`DateTime64`. [#76570](https://github.com/ClickHouse/ClickHouse/pull/76570) ([李扬](https://github.com/taiyang-li)).
* Компиляция запросов (настройка `compile_expressions`) теперь учитывает тип машины. Это существенно ускоряет такие запросы. [#76753](https://github.com/ClickHouse/ClickHouse/pull/76753) ([ZhangLiStar](https://github.com/zhanglistar)).
* Оптимизирован `arraySort`. [#76850](https://github.com/ClickHouse/ClickHouse/pull/76850) ([李扬](https://github.com/taiyang-li)).
* Отключён `filesystem_cache_prefer_bigger_buffer_size`, когда кэш используется пассивно, например, для слияний. [#77898](https://github.com/ClickHouse/ClickHouse/pull/77898) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Применён атрибут `preserve_most` в некоторых местах кода, что позволяет немного улучшить генерацию кода. [#67778](https://github.com/ClickHouse/ClickHouse/pull/67778) ([Nikita Taranov](https://github.com/nickitat)).
* Ускорено завершение работы серверов ClickHouse (устранена задержка 2,5 секунды). [#76550](https://github.com/ClickHouse/ClickHouse/pull/76550) ([Azat Khuzhin](https://github.com/azat)).
* Исключено лишнее выделение памяти в `ReadBufferFromS3` и других буферах для удалённого чтения, их потребление памяти уменьшено вдвое. [#76692](https://github.com/ClickHouse/ClickHouse/pull/76692) ([Sema Checherinda](https://github.com/CheSema)).
* Обновлён `zstd` с версии 1.5.5 до 1.5.7, что может привести к некоторым [улучшениям производительности](https://github.com/facebook/zstd/releases/tag/v1.5.7). [#77137](https://github.com/ClickHouse/ClickHouse/pull/77137) ([Pradeep Chhetri](https://github.com/chhetripradeep)).
* Снижено потребление памяти при предзагрузке (prefetch) столбца JSON в Wide-партах. Это актуально, когда ClickHouse используется поверх разделяемого хранилища, например, в ClickHouse Cloud. [#77640](https://github.com/ClickHouse/ClickHouse/pull/77640) ([Pavel Kruglov](https://github.com/Avogar)).



#### Улучшение

* Добавлена поддержка атомарного переименования при использовании `TRUNCATE` с `INTO OUTFILE`. Исправляет [#70323](https://github.com/ClickHouse/ClickHouse/issues/70323). [#77181](https://github.com/ClickHouse/ClickHouse/pull/77181) ([Onkar Deshpande](https://github.com/onkar)).
* Теперь нельзя использовать `NaN` или `inf` в качестве значений с плавающей запятой в настройках. Впрочем, и раньше это не имело никакого смысла. [#77546](https://github.com/ClickHouse/ClickHouse/pull/77546) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Параллельные реплики по умолчанию отключаются, когда analyzer отключён, независимо от настройки `compatibility`. По‑прежнему можно изменить это поведение, явно установив `parallel_replicas_only_with_analyzer` в `false`. [#77115](https://github.com/ClickHouse/ClickHouse/pull/77115) ([Igor Nikonov](https://github.com/devcrafter)).
* Добавлена возможность указать список заголовков, которые передаются из заголовков клиентского запроса во внешний HTTP-аутентификатор. [#77054](https://github.com/ClickHouse/ClickHouse/pull/77054) ([inv2004](https://github.com/inv2004)).
* Учитывать регистронезависимое сопоставление имен столбцов для полей в столбцах типа `tuple`. Закрывает [https://github.com/apache/incubator-gluten/issues/8324](https://github.com/apache/incubator-gluten/issues/8324). [#73780](https://github.com/ClickHouse/ClickHouse/pull/73780) ([李扬](https://github.com/taiyang-li)).
* Параметры кодека Gorilla теперь всегда будут сохраняться в метаданных таблицы в файле .sql. Тем самым закрывается задача: [#70072](https://github.com/ClickHouse/ClickHouse/issues/70072). [#74814](https://github.com/ClickHouse/ClickHouse/pull/74814) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Реализованы улучшения парсинга для некоторых озёр данных (разбор идентификаторов последовательностей: добавлена возможность разбора идентификаторов последовательностей в manifest-файлах и парсинг метаданных Avro: переработан парсер метаданных Avro, чтобы его было легко расширять в будущем). [#75010](https://github.com/ClickHouse/ClickHouse/pull/75010) ([Daniil Ivanik](https://github.com/divanik)).
* Удалён `trace&#95;id` из сортировки по умолчанию (ORDER BY) в таблице `system.opentelemetry_span_log`. [#75907](https://github.com/ClickHouse/ClickHouse/pull/75907) ([Azat Khuzhin](https://github.com/azat)).
* Шифрование (атрибут `encrypted_by`) теперь может применяться к любому конфигурационному файлу (config.xml, users.xml, вложенные файлы конфигурации). Ранее оно поддерживалось только для верхнеуровневого файла config.xml. [#75911](https://github.com/ClickHouse/ClickHouse/pull/75911) ([Mikhail Gorshkov](https://github.com/mgorshkov)).
* Улучшена таблица `system.warnings` и добавлены динамические предупреждения, которые можно добавлять, обновлять или удалять. [#76029](https://github.com/ClickHouse/ClickHouse/pull/76029) ([Bharat Nallan](https://github.com/bharatnc)).
* Этот PR делает невозможным выполнение запроса `ALTER USER user1 ADD PROFILES a, DROP ALL PROFILES`, поскольку все операции `DROP` должны идти первыми. [#76242](https://github.com/ClickHouse/ClickHouse/pull/76242) ([pufit](https://github.com/pufit)).
* Различные усовершенствования в SYNC REPLICA (более информативные сообщения об ошибках, улучшенные тесты, дополнительные проверки корректности). [#76307](https://github.com/ClickHouse/ClickHouse/pull/76307) ([Azat Khuzhin](https://github.com/azat)).
* Использовать корректный резервный механизм при сбое многосоставного копирования в S3 во время резервного копирования с ошибкой Access Denied. Многосоставное копирование может приводить к ошибке Access Denied, когда резервное копирование выполняется между бакетами с разными учетными данными. [#76515](https://github.com/ClickHouse/ClickHouse/pull/76515) ([Antonio Andelic](https://github.com/antonio2368)).
* Библиотека librdkafka (которая представляет собой кучу хлама) обновлена до версии 2.8.0 (от чего этот хлам лучше не стал), а последовательность завершения работы таблиц Kafka улучшена, что сократило задержки при удалении таблиц и перезапуске сервера. `engine=Kafka` больше не выходит из группы потребителей явно при удалении таблицы. Вместо этого потребитель остаётся в группе до тех пор, пока не будет автоматически удалён после `session_timeout_ms` (по умолчанию — 45 секунд) бездействия. [#76621](https://github.com/ClickHouse/ClickHouse/pull/76621) ([filimonov](https://github.com/filimonov)).
* Исправлена валидация настроек запросов S3. [#76658](https://github.com/ClickHouse/ClickHouse/pull/76658) ([Vitaly Baranov](https://github.com/vitlibar)).
* Системные таблицы, такие как `server_settings` или `settings`, имеют столбец `default`, что удобно. Этот столбец добавлен в `merge_tree_settings` и `replicated_merge_tree_settings`. [#76942](https://github.com/ClickHouse/ClickHouse/pull/76942) ([Diego Nieto](https://github.com/lesandie)).
* Добавлен `ProfileEvents::QueryPreempted` с логикой, аналогичной `CurrentMetrics::QueryPreempted`. [#77015](https://github.com/ClickHouse/ClickHouse/pull/77015) ([VicoWu](https://github.com/VicoWu)).
* Ранее база данных Replicated могла записывать в логи учетные данные, указанные в запросе. Это поведение исправлено. Исправлено в: [#77123](https://github.com/ClickHouse/ClickHouse/issues/77123). [#77133](https://github.com/ClickHouse/ClickHouse/pull/77133) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Разрешён `ALTER TABLE DROP PARTITION` для диска `plain_rewritable`. [#77138](https://github.com/ClickHouse/ClickHouse/pull/77138) ([Julia Kartseva](https://github.com/jkartseva)).
* Параметр резервного копирования/восстановления `allow_s3_native_copy` теперь поддерживает три возможных значения: - `False` — S3 native copy использоваться не будет; - `True` (старое значение по умолчанию) — ClickHouse сначала попытается использовать S3 native copy, а в случае неудачи перейдёт к подходу чтения и записи; - `'auto'` (новое значение по умолчанию) — ClickHouse сначала сравнит учётные данные источника и назначения. Если они совпадают, ClickHouse попробует S3 native copy и затем при необходимости может перейти к подходу чтения и записи. Если они различаются, ClickHouse сразу перейдёт к подходу чтения и записи. [#77401](https://github.com/ClickHouse/ClickHouse/pull/77401) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена поддержка использования AWS session token и учетных данных из окружения в delta kernel движка таблиц DeltaLake. [#77661](https://github.com/ClickHouse/ClickHouse/pull/77661) ([Kseniia Sumarokova](https://github.com/kssenii)).





#### Исправление ошибки (некорректное поведение, видимое пользователю, в официальном стабильном релизе)

* Исправлено зависание при обработке ожидающей партии данных для асинхронного распределённого INSERT (из‑за ошибки, например `No such file or directory`). [#72939](https://github.com/ClickHouse/ClickHouse/pull/72939) ([Azat Khuzhin](https://github.com/azat)).
* Улучшено преобразование datetime при анализе индексов за счёт принудительного поведения с ограничением значений до границ диапазона (saturating behavior) для неявных преобразований Date в DateTime. Это устраняет возможные неточности анализа индексов, вызванные ограничениями диапазона datetime. Исправлена проблема [#73307](https://github.com/ClickHouse/ClickHouse/issues/73307). Также исправлено явное преобразование в `toDateTime` при `date_time_overflow_behavior = 'ignore'`, что является значением по умолчанию. [#73326](https://github.com/ClickHouse/ClickHouse/pull/73326) ([Amos Bird](https://github.com/amosbird)).
* Исправлены всевозможные ошибки, вызванные гонкой между UUID и именами таблиц (например, это устранит гонку между `RENAME` и `RESTART REPLICA`: в случае одновременного выполнения `RENAME` с `SYSTEM RESTART REPLICA` в итоге можно было перезапустить не ту реплику и/или оставить одну из таблиц в состоянии `Table X is being restarted`). [#76308](https://github.com/ClickHouse/ClickHouse/pull/76308) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена потеря данных при включённой опции async insert и выполнении INSERT INTO ... FROM FILE ... с блоками разного размера: если размер первого блока &lt; async&#95;max&#95;size, а второго блока &gt; async&#95;max&#95;size, второй блок не вставлялся. Эти данные оставались в `squashing`. [#76343](https://github.com/ClickHouse/ClickHouse/pull/76343) ([Han Fei](https://github.com/hanfei1991)).
* Переименовано поле &#39;marks&#39; в &#39;marks&#95;bytes&#39; в таблице `system.data_skipping_indices`. [#76374](https://github.com/ClickHouse/ClickHouse/pull/76374) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена обработка неожиданных ошибок при изменении размера динамического файлового кэша во время вытеснения данных. [#76466](https://github.com/ClickHouse/ClickHouse/pull/76466) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена инициализация `used_flag` в параллельном хеше. Это могло приводить к сбою сервера. [#76580](https://github.com/ClickHouse/ClickHouse/pull/76580) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена логическая ошибка при вызове функции `defaultProfiles` внутри проекции. [#76627](https://github.com/ClickHouse/ClickHouse/pull/76627) ([pufit](https://github.com/pufit)).
* Не запрашивать в браузере интерактивную базовую аутентификацию в Web UI. Закрывает [#76319](https://github.com/ClickHouse/ClickHouse/issues/76319). [#76637](https://github.com/ClickHouse/ClickHouse/pull/76637) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено возникновение исключения THERE&#95;IS&#95;NO&#95;COLUMN при выборке булевого литерала из распределённых таблиц. [#76656](https://github.com/ClickHouse/ClickHouse/pull/76656) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Вложенный путь в каталоге таблицы теперь определяется более оптимальным образом. [#76681](https://github.com/ClickHouse/ClickHouse/pull/76681) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлена ошибка `Not found column in block` после изменения таблицы с подстолбцом в составе первичного ключа. После [https://github.com/ClickHouse/ClickHouse/pull/72644](https://github.com/ClickHouse/ClickHouse/pull/72644) требуется [https://github.com/ClickHouse/ClickHouse/pull/74403](https://github.com/ClickHouse/ClickHouse/pull/74403). [#76686](https://github.com/ClickHouse/ClickHouse/pull/76686) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлены тесты производительности для null short-circuit и исправлены ошибки. [#76708](https://github.com/ClickHouse/ClickHouse/pull/76708) ([李扬](https://github.com/taiyang-li)).
* Перед финализацией выходных буферов записи выполняется их сброс. Исправлена ошибка `LOGICAL_ERROR`, возникавшая при финализации некоторых выходных форматов, например `JSONEachRowWithProgressRowOutputFormat`. [#76726](https://github.com/ClickHouse/ClickHouse/pull/76726) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена поддержка двоичного UUID MongoDB ([#74452](https://github.com/ClickHouse/ClickHouse/issues/74452)) - Исправлено проталкивание условия WHERE в MongoDB при использовании табличной функции ([#72210](https://github.com/ClickHouse/ClickHouse/issues/72210)) - Изменено соответствие типов между MongoDB и ClickHouse таким образом, что двоичный UUID MongoDB может быть преобразован только в тип UUID ClickHouse. Это позволит избежать неоднозначностей и неожиданных эффектов в будущем. - Исправлено сопоставление OID с сохранением обратной совместимости. [#76762](https://github.com/ClickHouse/ClickHouse/pull/76762) ([Kirill Nikiforov](https://github.com/allmazz)).
* Исправлена обработка исключений при параллельной десериализации префиксов JSON-подстолбцов. [#76809](https://github.com/ClickHouse/ClickHouse/pull/76809) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено поведение функции lgamma для отрицательных целых чисел. [#76840](https://github.com/ClickHouse/ClickHouse/pull/76840) ([Ilya Kataev](https://github.com/IlyaKataev)).
* Исправлен анализ реверсивного ключа для явно определённых первичных ключей. Аналогично [#76654](https://github.com/ClickHouse/ClickHouse/issues/76654). [#76846](https://github.com/ClickHouse/ClickHouse/pull/76846) ([Amos Bird](https://github.com/amosbird)).
* Исправлен красивый вывод значений Bool в формате JSON. [#76905](https://github.com/ClickHouse/ClickHouse/pull/76905) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено возможное аварийное завершение из-за некорректного отката столбца JSON при ошибке во время асинхронных вставок. [#76908](https://github.com/ClickHouse/ClickHouse/pull/76908) ([Pavel Kruglov](https://github.com/Avogar)).
* Ранее `multiIf` мог возвращать столбцы разных типов на этапах планирования и основного выполнения. Это приводило к неопределённому поведению кода с точки зрения C++. [#76914](https://github.com/ClickHouse/ClickHouse/pull/76914) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена некорректная сериализация константных ключей типа Nullable в MergeTree. Это исправляет [#76939](https://github.com/ClickHouse/ClickHouse/issues/76939). [#76985](https://github.com/ClickHouse/ClickHouse/pull/76985) ([Amos Bird](https://github.com/amosbird)).
* Исправлена сортировка значений типа `BFloat16`. Исправление закрывает [#75487](https://github.com/ClickHouse/ClickHouse/issues/75487). Исправление закрывает [#75669](https://github.com/ClickHouse/ClickHouse/issues/75669). [#77000](https://github.com/ClickHouse/ClickHouse/pull/77000) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка в JSON с подстолбцом типа Variant путём добавления проверки, пропускающей эфемерные подстолбцы при проверке целостности парта. [#72187](https://github.com/ClickHouse/ClickHouse/issues/72187). [#77034](https://github.com/ClickHouse/ClickHouse/pull/77034) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Исправлен сбой при разборе шаблона формата Values в случае несоответствия типов. [#77071](https://github.com/ClickHouse/ClickHouse/pull/77071) ([Pavel Kruglov](https://github.com/Avogar)).
* Запрещено создавать таблицу EmbeddedRocksDB с подколонкой в первичном ключе. Ранее такую таблицу можно было создать, но запросы SELECT завершались с ошибкой. [#77074](https://github.com/ClickHouse/ClickHouse/pull/77074) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено недопустимое сравнение в распределённых запросах, так как при проталкивании предикатов на удалённые узлы не учитываются типы литералов. [#77093](https://github.com/ClickHouse/ClickHouse/pull/77093) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлено аварийное завершение при создании таблицы Kafka при возникновении исключения. [#77121](https://github.com/ClickHouse/ClickHouse/pull/77121) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена поддержка JSON и подстолбцов в движках Kafka и RabbitMQ. [#77122](https://github.com/ClickHouse/ClickHouse/pull/77122) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена раскрутка стека исключений на macOS. [#77126](https://github.com/ClickHouse/ClickHouse/pull/77126) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлено чтение подстолбца &#39;null&#39; в функции getSubcolumn. [#77163](https://github.com/ClickHouse/ClickHouse/pull/77163) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена работа индекса блум-фильтра с типом `Array` и неподдерживаемыми функциями. [#77271](https://github.com/ClickHouse/ClickHouse/pull/77271) ([Pavel Kruglov](https://github.com/Avogar)).
* Ограничение на количество таблиц следует проверять только при выполнении первоначального запроса CREATE. [#77274](https://github.com/ClickHouse/ClickHouse/pull/77274) ([Nikolay Degterinsky](https://github.com/evillique)).
* Не ошибка: `SELECT toBFloat16(-0.0) == toBFloat16(0.0)` теперь корректно возвращает `true` (ранее возвращал `false`). Это делает поведение таким же, как у `Float32` и `Float64`. [#77290](https://github.com/ClickHouse/ClickHouse/pull/77290) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Исправлена возможная некорректная ссылка на неинициализированную переменную key&#95;index, которая может приводить к сбоям в debug-сборках (эта неинициализированная ссылка не вызывает проблем в release-сборках, поскольку последующий код, скорее всего, приводит к выбросу ошибок). ### Запись в документации о пользовательских изменениях. [#77305](https://github.com/ClickHouse/ClickHouse/pull/77305) ([wxybear](https://github.com/wxybear)).
* Исправлено имя партиции для значения типа Bool. Оно было сломано в [https://github.com/ClickHouse/ClickHouse/pull/74533](https://github.com/ClickHouse/ClickHouse/pull/74533). [#77319](https://github.com/ClickHouse/ClickHouse/pull/77319) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена работа сравнения между кортежами с элементами типа Nullable и строками. Например, до изменения сравнение между кортежем `(1, null)` и строкой `'(1,null)'` приводило к ошибке. Другой пример — сравнение между кортежем `(1, a)`, где `a` — столбец типа Nullable, и строкой `'(1, 2)'`. Это изменение устраняет указанные проблемы. [#77323](https://github.com/ClickHouse/ClickHouse/pull/77323) ([Alexey Katsman](https://github.com/alexkats)).
* Исправлен сбой в ObjectStorageQueueSource. Он был внесён в [https://github.com/ClickHouse/ClickHouse/pull/76358](https://github.com/ClickHouse/ClickHouse/pull/76358). [#77325](https://github.com/ClickHouse/ClickHouse/pull/77325) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена обработка `async_insert` с `input`. [#77340](https://github.com/ClickHouse/ClickHouse/pull/77340) ([Azat Khuzhin](https://github.com/azat)).
* Исправление: `WITH FILL` мог завершаться ошибкой NOT&#95;FOUND&#95;COLUMN&#95;IN&#95;BLOCK, если сортируемый столбец удалялся планировщиком. Аналогичная проблема была связана с несогласованным DAG, вычисленным для выражения INTERPOLATE. [#77343](https://github.com/ClickHouse/ClickHouse/pull/77343) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлены несколько ошибок LOGICAL&#95;ERROR при задании псевдонима для некорректных узлов AST. [#77445](https://github.com/ClickHouse/ClickHouse/pull/77445) ([Raúl Marín](https://github.com/Algunenano)).
* В реализации кеша файловой системы исправлена обработка ошибок при записи сегмента файла. [#77471](https://github.com/ClickHouse/ClickHouse/pull/77471) ([Kseniia Sumarokova](https://github.com/kssenii)).
* DatabaseIceberg теперь использует корректный файл метаданных, предоставленный каталогом. Закрывает [#75187](https://github.com/ClickHouse/ClickHouse/issues/75187). [#77486](https://github.com/ClickHouse/ClickHouse/pull/77486) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Кэш запросов теперь рассматривает пользовательские функции (UDF) как недетерминированные. Соответственно, результаты запросов с UDF больше не кэшируются. Ранее пользователи могли определять недетерминированные UDF, результаты которых по ошибке кэшировались (issue [#77553](https://github.com/ClickHouse/ClickHouse/issues/77553)). [#77633](https://github.com/ClickHouse/ClickHouse/pull/77633) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
* Исправлена проблема, из-за которой system.filesystem&#95;cache&#95;log работал только при включённой настройке `enable_filesystem_cache_log`. [#77650](https://github.com/ClickHouse/ClickHouse/pull/77650) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена логическая ошибка при вызове функции `defaultRoles` внутри проекции. Доработка по задаче [#76627](https://github.com/ClickHouse/ClickHouse/issues/76627). [#77667](https://github.com/ClickHouse/ClickHouse/pull/77667) ([pufit](https://github.com/pufit)).
* Использование второго аргумента типа `Nullable` в функции `arrayResize` теперь запрещено. Ранее при использовании `Nullable` в качестве второго аргумента могли возникать как ошибки, так и некорректные результаты (issue [#48398](https://github.com/ClickHouse/ClickHouse/issues/48398)). [#77724](https://github.com/ClickHouse/ClickHouse/pull/77724) ([Manish Gill](https://github.com/mgill25)).
* Регулярно проверяйте, были ли слияния и мутации отменены, даже в том случае, если операция не создает блоков для записи. [#77766](https://github.com/ClickHouse/ClickHouse/pull/77766) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).

#### Улучшения сборки/тестирования/упаковки

- `clickhouse-odbc-bridge` и `clickhouse-library-bridge` перенесены в отдельный репозиторий https://github.com/ClickHouse/odbc-bridge/. [#76225](https://github.com/ClickHouse/ClickHouse/pull/76225) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Исправлена кросс-компиляция Rust и добавлена возможность полного отключения Rust. [#76921](https://github.com/ClickHouse/ClickHouse/pull/76921) ([Raúl Marín](https://github.com/Algunenano)).

### Релиз ClickHouse 25.2, 2025-02-27 {#252}

#### Обратно несовместимые изменения

- Настройка `async_load_databases` полностью включена по умолчанию (даже для установок, в которых не обновлялся `config.xml`). [#74772](https://github.com/ClickHouse/ClickHouse/pull/74772) ([Azat Khuzhin](https://github.com/azat)).
- Добавлены форматы `JSONCompactEachRowWithProgress` и `JSONCompactStringsEachRowWithProgress`. Продолжение [#69989](https://github.com/ClickHouse/ClickHouse/issues/69989). Форматы `JSONCompactWithNames` и `JSONCompactWithNamesAndTypes` больше не выводят «totals» — по-видимому, это была ошибка в реализации. [#75037](https://github.com/ClickHouse/ClickHouse/pull/75037) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Значение по умолчанию для настройки `format_alter_operations_with_parentheses` изменено на true для устранения неоднозначности в списке команд ALTER (см. https://github.com/ClickHouse/ClickHouse/pull/59532). Это нарушает репликацию с кластерами версий до 24.3. Если вы обновляете кластер, использующий более старые релизы, отключите эту настройку в конфигурации сервера или сначала обновитесь до версии 24.3. [#75302](https://github.com/ClickHouse/ClickHouse/pull/75302) ([Raúl Marín](https://github.com/Algunenano)).
- Удалена возможность фильтрации сообщений журнала с помощью регулярных выражений. Реализация приводила к состоянию гонки данных, поэтому её пришлось удалить. [#75577](https://github.com/ClickHouse/ClickHouse/pull/75577) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Настройка `min_chunk_bytes_for_parallel_parsing` больше не может иметь нулевое значение. Это исправляет: [#71110](https://github.com/ClickHouse/ClickHouse/issues/71110). [#75239](https://github.com/ClickHouse/ClickHouse/pull/75239) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Добавлена валидация настроек в конфигурации кеша. Несуществующие настройки ранее игнорировались, теперь они будут вызывать ошибку и должны быть удалены. [#75452](https://github.com/ClickHouse/ClickHouse/pull/75452) ([Kseniia Sumarokova](https://github.com/kssenii)).


#### Новые возможности
* Поддержка типа `Nullable(JSON)`. [#73556](https://github.com/ClickHouse/ClickHouse/pull/73556) ([Pavel Kruglov](https://github.com/Avogar)).
* Поддержка подстолбцов (subcolumns) в выражениях DEFAULT и MATERIALIZED. [#74403](https://github.com/ClickHouse/ClickHouse/pull/74403) ([Pavel Kruglov](https://github.com/Avogar)).
* Поддержка записи bloom-фильтров Parquet с использованием настройки `output_format_parquet_write_bloom_filter` (включена по умолчанию). [#71681](https://github.com/ClickHouse/ClickHouse/pull/71681) ([Michael Kolupaev](https://github.com/al13n321)).
* В Web UI появилась интерактивная навигация по базам данных. [#75777](https://github.com/ClickHouse/ClickHouse/pull/75777) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Разрешено сочетать диски только для чтения и для чтения/записи в политике хранения (как несколько томов или несколько дисков). Это позволяет читать данные со всего тома, тогда как вставки будут выполняться преимущественно на диск с возможностью записи (т.е. политика хранения Copy-on-Write). [#75862](https://github.com/ClickHouse/ClickHouse/pull/75862) ([Azat Khuzhin](https://github.com/azat)).
* Добавлен новый движок базы данных `DatabaseBackup`, который позволяет мгновенно прикреплять таблицу/базу данных из бэкапа. [#75725](https://github.com/ClickHouse/ClickHouse/pull/75725) ([Maksim Kita](https://github.com/kitaisreal)).
* Поддержка подготовленных запросов (prepared statements) в протоколе взаимодействия PostgreSQL (Postgres wire protocol). [#75035](https://github.com/ClickHouse/ClickHouse/pull/75035) ([scanhex12](https://github.com/scanhex12)).
* Добавлена возможность ATTACH таблиц без уровня базы данных (без указания базы), что полезно для таблиц MergeTree, размещённых в Web, S3 и аналогичных внешних виртуальных файловых системах. [#75788](https://github.com/ClickHouse/ClickHouse/pull/75788) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена новая функция сравнения строк `compareSubstrings` для сравнения частей двух строк. Пример: `SELECT compareSubstrings('Saxony', 'Anglo-Saxon', 0, 6, 5) AS result` означает «лексикографически сравнить 6 байт строк `Saxon` и `Anglo-Saxon`, начиная со смещения 0 в первой строке и 5 во второй строке». [#74070](https://github.com/ClickHouse/ClickHouse/pull/74070) ([lgbo](https://github.com/lgbo-ustc)).
* Добавлена новая функция `initialQueryStartTime`. Она возвращает время начала текущего запроса. Значение одинаково на всех шардах при распределённом запросе. [#75087](https://github.com/ClickHouse/ClickHouse/pull/75087) ([Roman Lomonosov](https://github.com/lomik)).
* Добавлена поддержка аутентификации по SSL с именованными коллекциями для MySQL. Закрывает [#59111](https://github.com/ClickHouse/ClickHouse/issues/59111). [#59452](https://github.com/ClickHouse/ClickHouse/pull/59452) ([Nikolay Degterinsky](https://github.com/evillique)).

#### Экспериментальные возможности
* Добавлена новая настройка `enable_adaptive_memory_spill_scheduler`, которая позволяет нескольким Grace JOIN в одном запросе отслеживать их совокупное потребление памяти и адаптивно инициировать выгрузку во внешнее хранилище, чтобы предотвратить ошибку MEMORY_LIMIT_EXCEEDED. [#72728](https://github.com/ClickHouse/ClickHouse/pull/72728) ([lgbo](https://github.com/lgbo-ustc)).
* Новый экспериментальный движок таблиц `Kafka` теперь полностью учитывает feature-флаги Keeper. [#76004](https://github.com/ClickHouse/ClickHouse/pull/76004) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Восстановлен кодек (Intel) QPL, который был удалён в v24.10 из-за лицензионных ограничений. [#76021](https://github.com/ClickHouse/ClickHouse/pull/76021) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Для интеграции с HDFS добавлена поддержка конфигурационной опции `dfs.client.use.datanode.hostname`. [#74635](https://github.com/ClickHouse/ClickHouse/pull/74635) ([Mikhail Tiukavkin](https://github.com/freshertm)).



#### Улучшения производительности
* Повышена производительность чтения всего JSON-столбца в Wide-частях из S3. Это сделано за счёт добавления предварительного чтения (prefetch) для десериализации префиксов подстолбцов, кеширования десериализованных префиксов и параллельной десериализации префиксов подстолбцов. Это улучшает чтение JSON-столбца из S3 в 4 раза в запросах вида `SELECT data FROM table` и примерно в 10 раз в запросах вида `SELECT data FROM table LIMIT 10`. [#74827](https://github.com/ClickHouse/ClickHouse/pull/74827) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлены избыточные конфликты при синхронизации (contention) в `parallel_hash`, когда `max_rows_in_join = max_bytes_in_join = 0`. [#75155](https://github.com/ClickHouse/ClickHouse/pull/75155) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлено двойное предварительное выделение памяти в `ConcurrentHashJoin` в случае, когда стороны соединения переставляются оптимизатором. [#75149](https://github.com/ClickHouse/ClickHouse/pull/75149) ([Nikita Taranov](https://github.com/nickitat)).
* Небольшое улучшение в некоторых сценариях соединений: предварительный расчёт количества результирующих строк и резервирование памяти под них. [#75376](https://github.com/ClickHouse/ClickHouse/pull/75376) ([Alexander Gololobov](https://github.com/davenger)).
* Для запросов вида `WHERE a < b AND b < c AND c < 5` теперь можно выводить новые условия сравнения (`a < 5 AND b < 5`) для повышения эффективности фильтрации. [#73164](https://github.com/ClickHouse/ClickHouse/pull/73164) ([Shichao Jin](https://github.com/jsc0218)).
* Улучшение Keeper: отключён подсчёт дайджеста при фиксации (commit) в встроенное (in-memory) хранилище для повышения производительности. Его можно включить с помощью настройки `keeper_server.digest_enabled_on_commit`. Дайджест по-прежнему считается при предварительной обработке запросов. [#75490](https://github.com/ClickHouse/ClickHouse/pull/75490) ([Antonio Andelic](https://github.com/antonio2368)).
* По возможности выполняется проталкивание (push down) выражения фильтра из JOIN ON. [#75536](https://github.com/ClickHouse/ClickHouse/pull/75536) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Ленивый (lazy) расчёт размеров столбцов и индексов в MergeTree. [#75938](https://github.com/ClickHouse/ClickHouse/pull/75938) ([Pavel Kruglov](https://github.com/Avogar)).
* Снова учитывается настройка `ttl_only_drop_parts` для `MATERIALIZE TTL`; читаются только необходимые столбцы для перерасчёта TTL и удаления кусков путём замены их на пустые. [#72751](https://github.com/ClickHouse/ClickHouse/pull/72751) ([Andrey Zvonov](https://github.com/zvonand)).
* Уменьшен размер буфера записи для файлов метаданных `plain_rewritable`. [#75758](https://github.com/ClickHouse/ClickHouse/pull/75758) ([Julia Kartseva](https://github.com/jkartseva)).
* Снижено потребление памяти для некоторых оконных функций. [#65647](https://github.com/ClickHouse/ClickHouse/pull/65647) ([lgbo](https://github.com/lgbo-ustc)).
* Совместная оценка parquet bloom-фильтров и min/max-индексов. Необходимо для корректной поддержки выражений вида: `x = 3 or x > 5` при данных = [1, 2, 4, 5]. [#71383](https://github.com/ClickHouse/ClickHouse/pull/71383) ([Arthur Passos](https://github.com/arthurpassos)).
* Запросы, передаваемые в хранилище `Executable`, больше не ограничены однопоточным выполнением. [#70084](https://github.com/ClickHouse/ClickHouse/pull/70084) ([yawnt](https://github.com/yawnt)).
* Параллельная загрузка кусков в ALTER TABLE FETCH PARTITION (размер пула потоков контролируется настройкой `max_fetch_partition_thread_pool_size`). [#74978](https://github.com/ClickHouse/ClickHouse/pull/74978) ([Azat Khuzhin](https://github.com/azat)).
* Разрешено переносить предикаты с функцией `indexHint` в `PREWHERE`. [#74987](https://github.com/ClickHouse/ClickHouse/pull/74987) ([Anton Popov](https://github.com/CurtizJ)).



#### Улучшение

* Исправлен расчет размера, занимаемого в памяти, для столбцов `LowCardinality`. [#74688](https://github.com/ClickHouse/ClickHouse/pull/74688) ([Nikita Taranov](https://github.com/nickitat)).
* Таблица `processors_profile_log` теперь имеет конфигурацию по умолчанию с TTL в 30 дней. [#66139](https://github.com/ClickHouse/ClickHouse/pull/66139) ([Ilya Yatsishin](https://github.com/qoega)).
* Добавлена возможность задавать имена шардам в конфигурации кластера. [#72276](https://github.com/ClickHouse/ClickHouse/pull/72276) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Изменён код успешного ответа для Prometheus remote write с 200/OK на 204/NoContent. [#74170](https://github.com/ClickHouse/ClickHouse/pull/74170) ([Michael Dempsey](https://github.com/bluestealth)).
* Добавлена возможность перезагружать `max_remote_read_network_bandwidth_for_serve` и `max_remote_write_network_bandwidth_for_server` на лету, без перезапуска сервера. [#74206](https://github.com/ClickHouse/ClickHouse/pull/74206) ([Kai Zhu](https://github.com/nauu)).
* Разрешено использовать пути к BLOB-объектам для вычисления контрольных сумм при создании резервной копии. [#74729](https://github.com/ClickHouse/ClickHouse/pull/74729) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлен столбец с идентификатором запроса в `system.query_cache` (закрывает [#68205](https://github.com/ClickHouse/ClickHouse/issues/68205)). [#74982](https://github.com/ClickHouse/ClickHouse/pull/74982) ([NamHoaiNguyen](https://github.com/NamHoaiNguyen)).
* Теперь можно отменять запросы `ALTER TABLE ... FREEZE ...` с помощью `KILL QUERY`, а также автоматически по тайм-ауту (`max_execution_time`). [#75016](https://github.com/ClickHouse/ClickHouse/pull/75016) ([Kirill](https://github.com/kirillgarbar)).
* Добавлена поддержка `groupUniqArrayArrayMap` в качестве `SimpleAggregateFunction`. [#75034](https://github.com/ClickHouse/ClickHouse/pull/75034) ([Miel Donkers](https://github.com/mdonkers)).
* Скрыты параметры учётных данных каталога в движке базы данных `Iceberg`. Закрывает [#74559](https://github.com/ClickHouse/ClickHouse/issues/74559). [#75080](https://github.com/ClickHouse/ClickHouse/pull/75080) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `intExp2` / `intExp10`: Определено поведение ранее неопределённых случаев: возвращать 0 для слишком малых аргументов, `18446744073709551615` для слишком больших аргументов, выбрасывать исключение, если аргумент — `nan`. [#75312](https://github.com/ClickHouse/ClickHouse/pull/75312) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена поддержка `s3.endpoint` напрямую из конфигурации каталога в `DatabaseIceberg`. Закрывает [#74558](https://github.com/ClickHouse/ClickHouse/issues/74558). [#75375](https://github.com/ClickHouse/ClickHouse/pull/75375) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Не завершать операцию без сообщения об ошибке, если у пользователя, выполняющего `SYSTEM DROP REPLICA`, недостаточно прав. [#75377](https://github.com/ClickHouse/ClickHouse/pull/75377) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлен `ProfileEvent` о числе неудачных операций сброса любого из системных журналов. [#75466](https://github.com/ClickHouse/ClickHouse/pull/75466) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена проверка и дополнительное логирование для расшифровки и декомпрессии. [#75471](https://github.com/ClickHouse/ClickHouse/pull/75471) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена поддержка символа микро (U+00B5) в функции `parseTimeDelta`. Теперь и знак микро (U+00B5), и греческая буква мю (U+03BC) распознаются как допустимые обозначения микросекунд, что приводит поведение ClickHouse в соответствие с реализацией Go ([см. time.go](https://github.com/golang/go/blob/ad7b46ee4ac1cee5095d64b01e8cf7fcda8bee5e/src/time/time.go#L983C19-L983C20) и [time/format.go](https://github.com/golang/go/blob/ad7b46ee4ac1cee5095d64b01e8cf7fcda8bee5e/src/time/format.go#L1608-L1609)). [#75472](https://github.com/ClickHouse/ClickHouse/pull/75472) ([Vitaly Orlov](https://github.com/orloffv)).
* Серверный параметр настройки (`send_settings_to_client`) заменён на клиентский параметр (`apply_settings_from_server`), который определяет, должен ли клиентский код (например, при разборе данных INSERT и форматировании вывода запроса) использовать настройки из `users.xml` на сервере и профиля пользователя. В противном случае используются только настройки, заданные через клиентскую командную строку, сессию и сам запрос. Обратите внимание, что это относится только к нативному клиенту (а не, например, к HTTP-интерфейсу) и не применяется к большей части обработки запросов (которая выполняется на сервере). [#75478](https://github.com/ClickHouse/ClickHouse/pull/75478) ([Michael Kolupaev](https://github.com/al13n321)).
* Улучшены сообщения о синтаксических ошибках. Ранее, если запрос был слишком большим, и токен, длина которого превышала лимит, представлял собой очень длинный строковый литерал, сообщение о причине терялось посередине между двумя примерами этого токена. Исправлена проблема, при которой запрос с UTF-8 некорректно обрезался в сообщении об ошибке. Исправлено избыточное экранирование фрагментов запроса. Закрывает [#75473](https://github.com/ClickHouse/ClickHouse/issues/75473). [#75561](https://github.com/ClickHouse/ClickHouse/pull/75561) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлены события профилирования в хранилище `S3(Azure)Queue`. [#75618](https://github.com/ClickHouse/ClickHouse/pull/75618) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отключена отправка настроек с сервера на клиент (`send_settings_to_client=false`) для обеспечения совместимости (позднее эта возможность будет реализована заново как настройка клиента для повышения удобства работы). [#75648](https://github.com/ClickHouse/ClickHouse/pull/75648) ([Michael Kolupaev](https://github.com/al13n321)).
* Добавлен параметр конфигурации `memory_worker_correct_memory_tracker`, позволяющий включить корректировку внутреннего трекера памяти на основе информации из различных источников, периодически считываемой в фоновом потоке. [#75714](https://github.com/ClickHouse/ClickHouse/pull/75714) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлен столбец `normalized_query_hash` в таблицу `system.processes`. Примечание: хотя его можно легко вычислить на лету с помощью функции `normalizedQueryHash`, это необходимо для подготовки к последующим изменениям. [#75756](https://github.com/ClickHouse/ClickHouse/pull/75756) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Запрос к `system.tables` не приведёт к исключению, даже если существует таблица `Merge`, созданная для базы данных, которой больше не существует. Из таблиц `Hive` удалён метод `getTotalRows`, так как ему не разрешено выполнять сложные операции. [#75772](https://github.com/ClickHouse/ClickHouse/pull/75772) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сохранять значения start&#95;time/end&#95;time для резервных копий с точностью до микросекунд. [#75929](https://github.com/ClickHouse/ClickHouse/pull/75929) ([Aleksandr Musorin](https://github.com/AVMusorin)).
* Добавлена метрика `MemoryTrackingUncorrected`, показывающая значение внутреннего глобального трекера памяти, не скорректированное по RSS. [#75935](https://github.com/ClickHouse/ClickHouse/pull/75935) ([Antonio Andelic](https://github.com/antonio2368)).
* Разрешён разбор конечных точек вида `localhost:1234/handle` в табличных функциях `PostgreSQL` и `MySQL`. Это исправляет регрессию, внесённую изменением [https://github.com/ClickHouse/ClickHouse/pull/52503](https://github.com/ClickHouse/ClickHouse/pull/52503). [#75944](https://github.com/ClickHouse/ClickHouse/pull/75944) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлена настройка сервера `throw_on_unknown_workload`, которая позволяет выбрать поведение при выполнении запроса с параметром `workload`, имеющим неизвестное значение: либо разрешить неограниченный доступ (по умолчанию), либо сгенерировать ошибку `RESOURCE_ACCESS_DENIED`. Это полезно, если нужно принудительно включить использование планировщика рабочих нагрузок для всех запросов. [#75999](https://github.com/ClickHouse/ClickHouse/pull/75999) ([Sergei Trifonov](https://github.com/serxa)).
* Не переписывайте подстолбцы на использование `getSubcolumn` в `ARRAY JOIN`, если в этом нет необходимости. [#76018](https://github.com/ClickHouse/ClickHouse/pull/76018) ([Pavel Kruglov](https://github.com/Avogar)).
* Повторные попытки при ошибках координации при загрузке таблиц. [#76020](https://github.com/ClickHouse/ClickHouse/pull/76020) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Добавлена поддержка сброса отдельных журналов в `SYSTEM FLUSH LOGS`. [#76132](https://github.com/ClickHouse/ClickHouse/pull/76132) ([Raúl Marín](https://github.com/Algunenano)).
* Улучшена страница сервера `/binary`. Вместо кривой Мортон используется кривая Хильберта. В квадрате отображается до 512 МБ адресного пространства, что лучше заполняет квадрат (в предыдущих версиях адреса занимали только половину квадрата). Цвет адресов определяется ближе к имени библиотеки, а не имени функции. Прокрутку можно выполнять немного дальше за пределы области. [#76192](https://github.com/ClickHouse/ClickHouse/pull/76192) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Повтор выполнения запросов ON CLUSTER при ошибке TOO&#95;MANY&#95;SIMULTANEOUS&#95;QUERIES. [#76352](https://github.com/ClickHouse/ClickHouse/pull/76352) ([Patrick Galbraith](https://github.com/CaptTofu)).
* Добавлена асинхронная метрика `CPUOverload`, которая вычисляет относительный дефицит CPU на сервере. [#76404](https://github.com/ClickHouse/ClickHouse/pull/76404) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Изменено значение параметра `output_format_pretty_max_rows` по умолчанию с 10000 до 1000. Это должно улучшить удобство использования. [#76407](https://github.com/ClickHouse/ClickHouse/pull/76407) ([Alexey Milovidov](https://github.com/alexey-milovidov)).





#### Исправление ошибки (некорректное поведение, видимое пользователю, в официальном стабильном релизе)

* Исправлено форматирование исключений с использованием пользовательского формата, если они возникают во время интерпретации запроса. В предыдущих версиях исключения форматировались в формате по умолчанию, а не в формате, указанном в запросе. Тем самым закрывается [#55422](https://github.com/ClickHouse/ClickHouse/issues/55422). [#74994](https://github.com/ClickHouse/ClickHouse/pull/74994) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено сопоставление типов для SQLite (целочисленные типы в `int64`, числа с плавающей запятой в `float64`). [#73853](https://github.com/ClickHouse/ClickHouse/pull/73853) ([Joanna Hulboj](https://github.com/jh0x)).
* Исправлено разрешение идентификаторов из родительских областей видимости. Разрешено использование алиасов для выражений в предложении WITH. Исправляет [#58994](https://github.com/ClickHouse/ClickHouse/issues/58994). Исправляет [#62946](https://github.com/ClickHouse/ClickHouse/issues/62946). Исправляет [#63239](https://github.com/ClickHouse/ClickHouse/issues/63239). Исправляет [#65233](https://github.com/ClickHouse/ClickHouse/issues/65233). Исправляет [#71659](https://github.com/ClickHouse/ClickHouse/issues/71659). Исправляет [#71828](https://github.com/ClickHouse/ClickHouse/issues/71828). Исправляет [#68749](https://github.com/ClickHouse/ClickHouse/issues/68749). [#66143](https://github.com/ClickHouse/ClickHouse/pull/66143) ([Dmitry Novik](https://github.com/novikd)).
* Исправлено монотонное поведение функции negate. В предыдущих версиях запрос `select * from a where -x = -42;`, где `x` является первичным ключом, мог вернуть неверный результат. [#71440](https://github.com/ClickHouse/ClickHouse/pull/71440) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена обработка пустых кортежей в arrayIntersect. Это устраняет проблему [#72578](https://github.com/ClickHouse/ClickHouse/issues/72578). [#72581](https://github.com/ClickHouse/ClickHouse/pull/72581) ([Amos Bird](https://github.com/amosbird)).
* Исправлено чтение подстолбцов под-объектов JSON с некорректным префиксом. [#73182](https://github.com/ClickHouse/ClickHouse/pull/73182) ([Pavel Kruglov](https://github.com/Avogar)).
* Обеспечена корректная передача настроек формата Native при взаимодействии клиент–сервер. [#73924](https://github.com/ClickHouse/ClickHouse/pull/73924) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена проверка на неподдерживаемые типы для некоторых хранилищ. [#74218](https://github.com/ClickHouse/ClickHouse/pull/74218) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка при выполнении запроса `INSERT INTO SELECT` через интерфейс PostgreSQL на macOS (issue [#72938](https://github.com/ClickHouse/ClickHouse/issues/72938)). [#74231](https://github.com/ClickHouse/ClickHouse/pull/74231) ([Artem Yurov](https://github.com/ArtemYurov)).
* Исправлена проблема с неинициализированным max&#95;log&#95;ptr в реплицируемой базе данных. [#74336](https://github.com/ClickHouse/ClickHouse/pull/74336) ([Konstantin Morozov](https://github.com/k-morozov)).
* Исправлена ошибка, приводившая к аварийному завершению при вставке интервала (issue [#74299](https://github.com/ClickHouse/ClickHouse/issues/74299)). [#74478](https://github.com/ClickHouse/ClickHouse/pull/74478) ([NamHoaiNguyen](https://github.com/NamHoaiNguyen)).
* Исправлено форматирование константных литералов JSON. Ранее это могло приводить к синтаксическим ошибкам при отправке запроса на другой сервер. [#74533](https://github.com/ClickHouse/ClickHouse/pull/74533) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено некорректное формирование запроса `CREATE` при использовании константных выражений в `PARTITION` при включённых неявных проекциях. Это исправляет [#74596](https://github.com/ClickHouse/ClickHouse/issues/74596). [#74634](https://github.com/ClickHouse/ClickHouse/pull/74634) ([Amos Bird](https://github.com/amosbird)).
* Исключено оставление соединения в некорректном состоянии после завершения INSERT с исключением. [#74740](https://github.com/ClickHouse/ClickHouse/pull/74740) ([Azat Khuzhin](https://github.com/azat)).
* Не переиспользуйте соединения, оставленные в промежуточном состоянии. [#74749](https://github.com/ClickHouse/ClickHouse/pull/74749) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено аварийное завершение при разборе объявления типа JSON, если имя типа указано не в верхнем регистре. [#74784](https://github.com/ClickHouse/ClickHouse/pull/74784) ([Pavel Kruglov](https://github.com/Avogar)).
* Keeper: устранена ошибка logical&#95;error, возникавшая при разрыве соединения до его установления. [#74844](https://github.com/ClickHouse/ClickHouse/pull/74844) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена ошибка, из-за которой сервер не мог запуститься при наличии таблицы, использующей `AzureBlobStorage`. Теперь таблицы загружаются без каких-либо запросов к Azure. [#74880](https://github.com/ClickHouse/ClickHouse/pull/74880) ([Alexey Katsman](https://github.com/alexkats)).
* Исправлено отсутствие полей `used_privileges` и `missing_privileges` в `query_log` для операций BACKUP и RESTORE. [#74887](https://github.com/ClickHouse/ClickHouse/pull/74887) ([Alexey Katsman](https://github.com/alexkats)).
* HDFS обновляет krb-билет при ошибке SASL во время запроса SELECT к HDFS. [#74930](https://github.com/ClickHouse/ClickHouse/pull/74930) ([inv2004](https://github.com/inv2004)).
* Исправлены запросы к базе данных Replicated в скриптах запуска (startup&#95;scripts). [#74942](https://github.com/ClickHouse/ClickHouse/pull/74942) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены ошибки при использовании null-safe сравнения для выражений с псевдонимами типов в предложении JOIN ON. [#74970](https://github.com/ClickHouse/ClickHouse/pull/74970) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Возвращает состояние парта из `deleting` обратно в `outdated`, если операция удаления не удалась. [#74985](https://github.com/ClickHouse/ClickHouse/pull/74985) ([Sema Checherinda](https://github.com/CheSema)).
* В предыдущих версиях при использовании скалярного подзапроса мы начинали записывать прогресс (накопленный при обработке подзапроса) во время инициализации формата данных, то есть до записи HTTP-заголовков. Это приводило к потере HTTP-заголовков, таких как X-ClickHouse-QueryId и X-ClickHouse-Format, а также Content-Type. [#74991](https://github.com/ClickHouse/ClickHouse/pull/74991) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена работа запросов `CREATE TABLE AS...` при `database_replicated_allow_replicated_engine_arguments=0`. [#75000](https://github.com/ClickHouse/ClickHouse/pull/75000) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлена проблема, из-за которой соединение клиента оставалось в некорректном состоянии после исключений INSERT. [#75030](https://github.com/ClickHouse/ClickHouse/pull/75030) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен краш из-за необработанного исключения в репликации PSQL. [#75062](https://github.com/ClickHouse/ClickHouse/pull/75062) ([Azat Khuzhin](https://github.com/azat)).
* SASL может завершить с ошибкой любой RPC-вызов, исправление позволяет повторно выполнить вызов в случае, если истёк krb5-ticket. [#75063](https://github.com/ClickHouse/ClickHouse/pull/75063) ([inv2004](https://github.com/inv2004)).
* Исправлено использование индексов (первичных и вторичных) для столбцов типов `Array`, `Map` и `Nullable(..)` при включённой настройке `optimize_function_to_subcolumns`. Ранее индексы для этих столбцов могли не использоваться. [#75081](https://github.com/ClickHouse/ClickHouse/pull/75081) ([Anton Popov](https://github.com/CurtizJ)).
* Отключайте `flatten_nested` при создании материализованных представлений с внутренними таблицами, так как такие развёрнутые столбцы нельзя будет использовать. [#75085](https://github.com/ClickHouse/ClickHouse/pull/75085) ([Christoph Wurm](https://github.com/cwurm)).
* Исправлена неправильная интерпретация некоторых IPv6-адресов (таких как ::ffff:1.1.1.1) в поле forwarded&#95;for, приводившая к разрыву соединения с клиентом и возникновению исключения. [#75133](https://github.com/ClickHouse/ClickHouse/pull/75133) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена обработка nullsafe JOIN для Nullable-типа данных LowCardinality. Ранее JOIN ON с nullsafe-сравнением, таким как `IS NOT DISTINCT FROM`, `<=>`, `a IS NULL AND b IS NULL OR a == b`, выполнялся некорректно для колонок LowCardinality. [#75143](https://github.com/ClickHouse/ClickHouse/pull/75143) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Проверка отсутствия `key_condition` при подсчёте `total_number_of_rows` для `NumRowsCache`. [#75164](https://github.com/ClickHouse/ClickHouse/pull/75164) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлены запросы с неиспользуемой интерполяцией с помощью нового анализатора. [#75173](https://github.com/ClickHouse/ClickHouse/pull/75173) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлена ошибка, вызывавшая аварийное завершение работы при использовании CTE с Insert. [#75188](https://github.com/ClickHouse/ClickHouse/pull/75188) ([Shichao Jin](https://github.com/jsc0218)).
* Исправление в Keeper: предотвращена запись в повреждённые журналы изменений при откате. [#75197](https://github.com/ClickHouse/ClickHouse/pull/75197) ([Antonio Andelic](https://github.com/antonio2368)).
* Используйте `BFloat16` в качестве супертипа там, где это уместно. Это закрывает: [#74404](https://github.com/ClickHouse/ClickHouse/issues/74404). [#75236](https://github.com/ClickHouse/ClickHouse/pull/75236) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлено неожиданное поведение значений по умолчанию в результате JOIN при использовании any&#95;join&#95;distinct&#95;right&#95;table&#95;keys и OR в JOIN ON. [#75262](https://github.com/ClickHouse/ClickHouse/pull/75262) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Маскировать учетные данные движка таблицы azureblobstorage. [#75319](https://github.com/ClickHouse/ClickHouse/pull/75319) ([Garrett Thomas](https://github.com/garrettthomaskth)).
* Исправлена ошибка, из-за которой ClickHouse мог ошибочно выполнять проталкивание фильтра (filter pushdown) во внешнюю базу данных, такую как PostgreSQL, MySQL или SQLite. Это исправление закрывает задачу: [#71423](https://github.com/ClickHouse/ClickHouse/issues/71423). [#75320](https://github.com/ClickHouse/ClickHouse/pull/75320) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлен сбой в кэше схем Protobuf, который мог происходить при выводе данных в формате Protobuf и одновременном выполнении запроса `SYSTEM DROP FORMAT SCHEMA CACHE`. [#75357](https://github.com/ClickHouse/ClickHouse/pull/75357) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена возможная логическая ошибка или проблема с неинициализированной памятью, возникающая при проталкивании фильтра из `HAVING` при использовании параллельных реплик. [#75363](https://github.com/ClickHouse/ClickHouse/pull/75363) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Скрытие конфиденциальной информации для табличных функций и табличных движков `icebergS3` и `icebergAzure`. [#75378](https://github.com/ClickHouse/ClickHouse/pull/75378) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Функция `TRIM` теперь корректно обрабатывает вычисляемые пустые наборы символов для обрезки. Пример: `SELECT TRIM(LEADING concat('') FROM 'foo')` (Issue [#69922](https://github.com/ClickHouse/ClickHouse/issues/69922)). [#75399](https://github.com/ClickHouse/ClickHouse/pull/75399) ([Manish Gill](https://github.com/mgill25)).
* Исправлена гонка данных в IOutputFormat. [#75448](https://github.com/ClickHouse/ClickHouse/pull/75448) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена возможная ошибка `Elements ... and ... of Nested data structure ... (Array columns) have different array sizes` при использовании JSON-подстолбцов типа Array в операциях JOIN над распределёнными таблицами. [#75512](https://github.com/ClickHouse/ClickHouse/pull/75512) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена проблема повреждения данных при использовании `CODEC(ZSTD, DoubleDelta)`. Закрыта задача [#70031](https://github.com/ClickHouse/ClickHouse/issues/70031). [#75548](https://github.com/ClickHouse/ClickHouse/pull/75548) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлено некорректное взаимодействие параметра `allow_feature_tier` с настройкой совместимости `mergetree`. [#75635](https://github.com/ClickHouse/ClickHouse/pull/75635) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено некорректное значение processed&#95;rows в system.s3queue&#95;log при повторной попытке обработки файла. [#75666](https://github.com/ClickHouse/ClickHouse/pull/75666) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Учитывать параметр `materialized_views_ignore_errors`, когда материализованное представление записывает в движок URL и возникают проблемы с подключением. [#75679](https://github.com/ClickHouse/ClickHouse/pull/75679) ([Christoph Wurm](https://github.com/cwurm)).
* Исправлены редкие аварийные завершения при чтении из таблицы `MergeTree` после выполнения нескольких асинхронных запросов `RENAME` (с `alter_sync = 0`), изменяющих столбцы с различными типами данных. [#75693](https://github.com/ClickHouse/ClickHouse/pull/75693) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка `Block structure mismatch in QueryPipeline stream`, возникавшая в некоторых запросах с `UNION ALL`. [#75715](https://github.com/ClickHouse/ClickHouse/pull/75715) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Перестраивать проекцию при изменении (`ALTER MODIFY`) столбца ее первичного ключа. Ранее это могло приводить к ошибкам `CANNOT_READ_ALL_DATA` при выполнении запросов SELECT после изменения (`ALTER MODIFY`) столбца, используемого в первичном ключе проекции. [#75720](https://github.com/ClickHouse/ClickHouse/pull/75720) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен некорректный результат работы `ARRAY JOIN` для скалярных подзапросов при использовании анализатора. [#75732](https://github.com/ClickHouse/ClickHouse/pull/75732) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено разыменование нулевого указателя в `DistinctSortedStreamTransform`. [#75734](https://github.com/ClickHouse/ClickHouse/pull/75734) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлено поведение параметра `allow_suspicious_ttl_expressions`. [#75771](https://github.com/ClickHouse/ClickHouse/pull/75771) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Исправлено чтение неинициализированной памяти в функции `translate`. Это закрывает [#75592](https://github.com/ClickHouse/ClickHouse/issues/75592). [#75794](https://github.com/ClickHouse/ClickHouse/pull/75794) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Настройки формата для JSON теперь распространяются на строковое форматирование в формате Native. [#75832](https://github.com/ClickHouse/ClickHouse/pull/75832) ([Pavel Kruglov](https://github.com/Avogar)).
* В истории изменений настроек зафиксировано включение параллельного hash в качестве алгоритма JOIN по умолчанию в v24.12. Это означает, что ClickHouse продолжит выполнять JOIN, используя непараллельный hash, если настроен уровень совместимости ниже v24.12. [#75870](https://github.com/ClickHouse/ClickHouse/pull/75870) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена ошибка, из-за которой таблицы с неявно добавленными min-max индексами не удавалось копировать в новую таблицу (issue [#75677](https://github.com/ClickHouse/ClickHouse/issues/75677)). [#75877](https://github.com/ClickHouse/ClickHouse/pull/75877) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* `clickhouse-library-bridge` позволяет открывать произвольные библиотеки из файловой системы, что делает безопасным его запуск только в изолированной среде. Чтобы предотвратить уязвимость при запуске рядом с clickhouse-server, мы ограничим пути к библиотекам расположением, заданным в конфигурации. Эта уязвимость была обнаружена в рамках [ClickHouse Bug Bounty Program](https://github.com/ClickHouse/ClickHouse/issues/38986) **Арсением Дугиным**. [#75954](https://github.com/ClickHouse/ClickHouse/pull/75954) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Мы использовали JSON-сериализацию для некоторых метаданных, что оказалось ошибкой, поскольку JSON не поддерживает бинарные данные внутри строковых литералов, включая нулевые байты. SQL-запросы могут содержать бинарные данные и некорректный UTF-8, поэтому нам также нужно поддерживать это в наших файлах с метаданными. В то же время форматы ClickHouse `JSONEachRow` и подобные обходят это ограничение, отклоняясь от стандарта JSON в пользу идеального обратимого преобразования бинарных данных. См. обоснование здесь: [https://github.com/ClickHouse/ClickHouse/pull/73668#issuecomment-2560501790](https://github.com/ClickHouse/ClickHouse/pull/73668#issuecomment-2560501790). Решение состоит в том, чтобы сделать библиотеку `Poco::JSON` согласованной с JSON-форматами сериализации в ClickHouse. Это закрывает [#73668](https://github.com/ClickHouse/ClickHouse/issues/73668). [#75963](https://github.com/ClickHouse/ClickHouse/pull/75963) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена проверка лимитов на коммиты в хранилище `S3Queue`. [#76104](https://github.com/ClickHouse/ClickHouse/pull/76104) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено подключение таблиц MergeTree с автоматическими индексами (`add_minmax_index_for_numeric_columns`/`add_minmax_index_for_string_columns`). [#76139](https://github.com/ClickHouse/ClickHouse/pull/76139) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема, из-за которой не выводились stack trace из родительских потоков job (настройка `enable_job_stack_trace`). Исправлена проблема, при которой настройка `enable_job_stack_trace` некорректно распространялась на потоки, из-за чего содержимое stack trace не всегда учитывало это значение. [#76191](https://github.com/ClickHouse/ClickHouse/pull/76191) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена некорректная проверка прав, при которой для `ALTER RENAME` требовался грант `CREATE USER`. Закрывает [#74372](https://github.com/ClickHouse/ClickHouse/issues/74372). [#76241](https://github.com/ClickHouse/ClickHouse/pull/76241) ([pufit](https://github.com/pufit)).
* Исправлена работа reinterpretAs с FixedString на архитектурах с порядком байт big-endian. [#76253](https://github.com/ClickHouse/ClickHouse/pull/76253) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена логическая ошибка в S3Queue: &quot;Expected current processor {} to be equal to {} for bucket {}&quot;. [#76358](https://github.com/ClickHouse/ClickHouse/pull/76358) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена взаимоблокировка при выполнении ALTER в базе данных Memory. [#76359](https://github.com/ClickHouse/ClickHouse/pull/76359) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена логическая ошибка при анализе индекса, если в условии `WHERE` используется функция `pointInPolygon`. [#76360](https://github.com/ClickHouse/ClickHouse/pull/76360) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен потенциально небезопасный вызов в обработчике сигналов. [#76549](https://github.com/ClickHouse/ClickHouse/pull/76549) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена поддержка обратного ключа в PartsSplitter. Устраняет проблему [#73400](https://github.com/ClickHouse/ClickHouse/issues/73400). [#73418](https://github.com/ClickHouse/ClickHouse/pull/73418) ([Amos Bird](https://github.com/amosbird)).

#### Улучшения сборки/тестирования/упаковки

- Поддержка сборки HDFS на ARM и Intel Mac. [#74244](https://github.com/ClickHouse/ClickHouse/pull/74244) ([Yan Xin](https://github.com/yxheartipp)).
- Включение ICU и GRPC при кросс-компиляции для Darwin. [#75922](https://github.com/ClickHouse/ClickHouse/pull/75922) ([Raúl Marín](https://github.com/Algunenano)).
- Обновление встроенного LLVM до версии 19. [#75148](https://github.com/ClickHouse/ClickHouse/pull/75148) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Отключение сетевого доступа для пользователя default в образе Docker. [#75259](https://github.com/ClickHouse/ClickHouse/pull/75259) ([Mikhail f. Shiryaev](https://github.com/Felixoid)). Все действия, связанные с clickhouse-server, преобразованы в функцию и выполняются только при запуске стандартного бинарного файла в `entrypoint.sh`. Давно откладываемое улучшение было предложено в [#50724](https://github.com/ClickHouse/ClickHouse/issues/50724). Добавлен параметр `--users` в `clickhouse-extract-from-config` для получения значений из `users.xml`. [#75643](https://github.com/ClickHouse/ClickHouse/pull/75643) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Удалено около 20 МБ неиспользуемого кода из бинарного файла. [#76226](https://github.com/ClickHouse/ClickHouse/pull/76226) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Релиз ClickHouse 25.1, 2025-01-28 {#251}


#### Обратная несовместимость
* `JSONEachRowWithProgress` будет записывать прогресс по мере его изменения. В предыдущих версиях прогресс показывался только после каждого блока результата, что делало его бесполезным. Изменен способ отображения прогресса: нулевые значения показываться не будут. Это закрывает [#70800](https://github.com/ClickHouse/ClickHouse/issues/70800). [#73834](https://github.com/ClickHouse/ClickHouse/pull/73834) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Таблицы `Merge` теперь унифицируют структуру базовых таблиц, используя объединение их столбцов и выводя общие типы. Это закрывает [#64864](https://github.com/ClickHouse/ClickHouse/issues/64864). В некоторых случаях это изменение может быть несовместимо с предыдущими версиями. Один из примеров — когда между таблицами нет общего типа, но преобразование к типу первой таблицы все еще возможно, как в случае с UInt64 и Int64 или любым числовым типом и String. Если вы хотите вернуть старое поведение, установите `merge_table_max_tables_to_look_for_schema_inference` равным `1` или установите `compatibility` в значение `24.12` или более раннее. [#73956](https://github.com/ClickHouse/ClickHouse/pull/73956) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Формат вывода Parquet преобразует столбцы Date и DateTime в типы даты/времени, поддерживаемые Parquet, вместо записи их как «сырых» чисел. `DateTime` становится `DateTime64(3)` (ранее: `UInt32`); установка `output_format_parquet_datetime_as_uint32` возвращает старое поведение. `Date` становится `Date32` (ранее: `UInt16`). [#70950](https://github.com/ClickHouse/ClickHouse/pull/70950) ([Michael Kolupaev](https://github.com/al13n321)).
* По умолчанию не допускаются несравнимые типы (такие как `JSON`/`Object`/`AggregateFunction`) в `ORDER BY` и в функциях сравнения `less/greater/equal/etc`. [#73276](https://github.com/ClickHouse/ClickHouse/pull/73276) ([Pavel Kruglov](https://github.com/Avogar)).
* Устаревший движок баз данных `MaterializedMySQL` был удален и больше недоступен. [#73879](https://github.com/ClickHouse/ClickHouse/pull/73879) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Источник словаря `mysql` больше не выполняет запрос `SHOW TABLE STATUS`, потому что он не дает никакой полезной информации для таблиц InnoDB, так же как и для любых современных версий MySQL. Это закрывает [#72636](https://github.com/ClickHouse/ClickHouse/issues/72636). Это изменение обратно совместимо, но помещено в эту категорию, чтобы у вас была возможность его заметить. [#73914](https://github.com/ClickHouse/ClickHouse/pull/73914) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Запросы `CHECK TABLE` теперь требуют отдельной привилегии `CHECK`. В предыдущих версиях для выполнения этих запросов было достаточно привилегии `SHOW TABLES`. Но запрос `CHECK TABLE` может быть ресурсоемким, и обычные лимиты сложности запросов для запросов `SELECT` к нему не применяются. Это создавало потенциальную возможность DoS-атаки. [#74471](https://github.com/ClickHouse/ClickHouse/pull/74471) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Функция `h3ToGeo()` теперь возвращает результаты в порядке `(lat, lon)` (что является стандартным порядком для геометрических функций). Пользователи, которые хотят сохранить старый порядок результата `(lon, lat)`, могут установить настройку `h3togeo_lon_lat_result_order = true`. [#74719](https://github.com/ClickHouse/ClickHouse/pull/74719) ([Manish Gill](https://github.com/mgill25)).
* Новый драйвер MongoDB теперь используется по умолчанию. Пользователи, которые хотят продолжить использование старого драйвера, могут установить серверную настройку `use_legacy_mongodb_integration` в значение true. [#73359](https://github.com/ClickHouse/ClickHouse/pull/73359) ([Robert Schulze](https://github.com/rschu1ze)).



#### Новая функция

* Добавлена возможность применять незавершённые мутации (ещё не материализованные фоновым процессом) во время выполнения запросов `SELECT` сразу после их отправки. Это можно включить, установив `apply_mutations_on_fly`. [#74877](https://github.com/ClickHouse/ClickHouse/pull/74877) ([Anton Popov](https://github.com/CurtizJ)).
* Реализован `partition pruning` партиций таблиц `Iceberg` для операций преобразования партиций по времени (time-related transform partition operations) в Iceberg. [#72044](https://github.com/ClickHouse/ClickHouse/pull/72044) ([Daniil Ivanik](https://github.com/divanik)).
* Добавлена поддержка подколонок в ключе сортировки MergeTree и пропускающих индексах. [#72644](https://github.com/ClickHouse/ClickHouse/pull/72644) ([Pavel Kruglov](https://github.com/Avogar)).
* Поддержка чтения значений `HALF_FLOAT` из `Apache Arrow`/`Parquet`/`ORC` (они считываются в `Float32`). Это закрывает [#72960](https://github.com/ClickHouse/ClickHouse/issues/72960). Имейте в виду, что формат half-precision IEEE-754 (`HALF_FLOAT`) — это не то же самое, что `BFloat16`. Закрывает [#73835](https://github.com/ClickHouse/ClickHouse/issues/73835). [#73836](https://github.com/ClickHouse/ClickHouse/pull/73836) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* В таблице `system.trace_log` появятся два новых столбца — `symbols` и `lines`, содержащие символизированный стек-трейс. Это позволяет легко собирать и экспортировать профилировочную информацию. Поведение контролируется параметром конфигурации сервера `symbolize` в секции `trace_log`; параметр включен по умолчанию. [#73896](https://github.com/ClickHouse/ClickHouse/pull/73896) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена новая функция `generateSerialID`, которую можно использовать для генерации автоинкрементных идентификаторов в таблицах. Продолжение [#64310](https://github.com/ClickHouse/ClickHouse/issues/64310) от [kazalika](https://github.com/kazalika). Закрывает [#62485](https://github.com/ClickHouse/ClickHouse/issues/62485). [#73950](https://github.com/ClickHouse/ClickHouse/pull/73950) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен синтаксис `query1 PARALLEL WITH query2 PARALLEL WITH query3 ... PARALLEL WITH queryN` для DDL-запросов. Это означает, что подзапросы `{query1, query2, ... queryN}` могут выполняться параллельно друг с другом (и такой режим предпочтителен). [#73983](https://github.com/ClickHouse/ClickHouse/pull/73983) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлен кэш в оперативной памяти для десериализованных гранул пропускающих индексов. Это должно ускорить повторяющиеся запросы, использующие пропускающие индексы. Размер нового кэша управляется серверными настройками `skipping_index_cache_size` и `skipping_index_cache_max_entries`. Исходной мотивацией для добавления кэша были индексы векторного сходства, которые теперь работают значительно быстрее. [#70102](https://github.com/ClickHouse/ClickHouse/pull/70102) ([Robert Schulze](https://github.com/rschu1ze)).
* Теперь во встроенном веб-интерфейсе есть индикатор прогресса во время выполнения запроса. Он позволяет отменять запросы. Он отображает общее количество записей и расширенную информацию о скорости. Таблица может отображаться постепенно, по мере поступления данных. Добавлена поддержка HTTP-сжатия. Отрисовка таблицы стала быстрее. Заголовок таблицы стал закреплённым. Интерфейс позволяет выделять ячейки и перемещаться по ним с помощью клавиш со стрелками. Исправлена проблема, из-за которой контур выделенной ячейки делал её меньше. Ячейки больше не расширяются при наведении курсора мыши, а только при выделении. Момент остановки отрисовки входящих данных теперь определяется на стороне клиента, а не на стороне сервера. Группы разрядов в числах подсвечиваются. Общий дизайн был обновлён и стал более выразительным. Выполняется проверка доступности сервера и корректности учётных данных, а также отображаются версия сервера и время его работы. Значок облака имеет контур во всех шрифтах, даже в Safari. Большие целые числа во вложенных типах данных будут отображаться корректнее. Значения inf/nan будут отображаться корректно. Типы данных будут отображаться при наведении курсора на заголовок столбца. [#74204](https://github.com/ClickHouse/ClickHouse/pull/74204) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность по умолчанию создавать min-max (skipping) индексы для столбцов, управляемых MergeTree, с помощью настроек `add_minmax_index_for_numeric_columns` (для числовых столбцов) и `add_minmax_index_for_string_columns` (для строковых столбцов). Пока обе настройки отключены, поэтому поведение пока не меняется. [#74266](https://github.com/ClickHouse/ClickHouse/pull/74266) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Добавлены поля `script_query_number` и `script_line_number` в `system.query_log`, в ClientInfo в нативном протоколе и в журналы сервера. Это закрывает [#67542](https://github.com/ClickHouse/ClickHouse/issues/67542). Благодарность [pinsvin00](https://github.com/pinsvin00) за инициирование этой функциональности ранее в [#68133](https://github.com/ClickHouse/ClickHouse/issues/68133). [#74477](https://github.com/ClickHouse/ClickHouse/pull/74477) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена агрегатная функция `sequenceMatchEvents`, которая возвращает временные метки событий, соответствующих шаблону, для самой длинной последовательности событий, удовлетворяющей этому шаблону. [#72349](https://github.com/ClickHouse/ClickHouse/pull/72349) ([UnamedRus](https://github.com/UnamedRus)).
* Добавлена функция `arrayNormalizedGini`. [#72823](https://github.com/ClickHouse/ClickHouse/pull/72823) ([flynn](https://github.com/ucasfl)).
* Добавлена поддержка оператора вычитания для `DateTime64`, что позволяет выполнять вычитание между значениями типов `DateTime64` и `DateTime`. [#74482](https://github.com/ClickHouse/ClickHouse/pull/74482) ([Li Yin](https://github.com/liyinsg)).



#### Экспериментальные возможности
* Тип данных `BFloat16` готов к промышленной эксплуатации. [#73840](https://github.com/ClickHouse/ClickHouse/pull/73840) ([Alexey Milovidov](https://github.com/alexey-milovidov)).



#### Улучшение производительности

* Оптимизирована функция `indexHint`. Теперь столбцы, которые используются только в качестве аргументов функции `indexHint`, не считываются из таблицы. [#74314](https://github.com/ClickHouse/ClickHouse/pull/74314) ([Anton Popov](https://github.com/CurtizJ)). Если функция `indexHint` является центральным элементом вашей корпоративной архитектуры данных, эта оптимизация спасёт вам жизнь.
* Более точный учет параметра `max_joined_block_size_rows` для алгоритма JOIN `parallel_hash`. Помогает избежать повышенного потребления памяти по сравнению с алгоритмом `hash`. [#74630](https://github.com/ClickHouse/ClickHouse/pull/74630) ([Nikita Taranov](https://github.com/nickitat)).
* Реализована поддержка оптимизации проталкивания предикатов (predicate push down) на уровне плана выполнения запроса для шага `MergingAggregated`. Это улучшает производительность некоторых запросов при использовании анализатора. [#74073](https://github.com/ClickHouse/ClickHouse/pull/74073) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Разбиение блоков левой таблицы по хешу было исключено из этапа probe алгоритма JOIN `parallel_hash`. [#73089](https://github.com/ClickHouse/ClickHouse/pull/73089) ([Nikita Taranov](https://github.com/nickitat)).
* Оптимизирован формат ввода RowBinary. Закрывает [#63805](https://github.com/ClickHouse/ClickHouse/issues/63805). [#65059](https://github.com/ClickHouse/ClickHouse/pull/65059) ([Pavel Kruglov](https://github.com/Avogar)).
* Записывать парты уровня 1, если включен `optimize_on_insert`. Это позволяет использовать несколько оптимизаций запросов с `FINAL` для недавно записанных партов. [#73132](https://github.com/ClickHouse/ClickHouse/pull/73132) ([Anton Popov](https://github.com/CurtizJ)).
* Ускорена десериализация строк за счет низкоуровневых оптимизаций. [#65948](https://github.com/ClickHouse/ClickHouse/pull/65948) ([Nikita Taranov](https://github.com/nickitat)).
* При выполнении сравнения записей на равенство, например при слияниях, в первую очередь сравнивайте значения в тех столбцах, которые с наибольшей вероятностью окажутся различными. [#63780](https://github.com/ClickHouse/ClickHouse/pull/63780) ([UnamedRus](https://github.com/UnamedRus)).
* Улучшена производительность операции grace hash join за счёт пересортировки правой таблицы соединения по ключам. [#72237](https://github.com/ClickHouse/ClickHouse/pull/72237) ([kevinyhzou](https://github.com/KevinyhZou)).
* Позволить функциям `arrayROCAUC` и `arrayAUCPR` вычислять частичную площадь под всей кривой, чтобы их вычисление можно было распараллелить на очень больших наборах данных. [#72904](https://github.com/ClickHouse/ClickHouse/pull/72904) ([Emmanuel](https://github.com/emmanuelsdias)).
* Избегайте порождения слишком большого числа простаивающих потоков. [#72920](https://github.com/ClickHouse/ClickHouse/pull/72920) ([Guo Wangyang](https://github.com/guowangy)).
* Не перечислять ключи в blob‑хранилище, если в табличной функции используется только раскрытие фигурных скобок. Закрывает [#73333](https://github.com/ClickHouse/ClickHouse/issues/73333). [#73518](https://github.com/ClickHouse/ClickHouse/pull/73518) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Оптимизация вычислений с коротким замыканием для функций, выполняемых над аргументами типа Nullable. [#73820](https://github.com/ClickHouse/ClickHouse/pull/73820) ([李扬](https://github.com/taiyang-li)).
* Не применять `maskedExecute` к столбцам, не являющимся функциями, улучшена производительность укороченного (short-circuit) выполнения. [#73965](https://github.com/ClickHouse/ClickHouse/pull/73965) ([lgbo](https://github.com/lgbo-ustc)).
* Отключено автоматическое определение заголовков во входных форматах для `Kafka`/`NATS`/`RabbitMQ`/`FileLog` для повышения производительности. [#74006](https://github.com/ClickHouse/ClickHouse/pull/74006) ([Azat Khuzhin](https://github.com/azat)).
* Выполнять конвейер обработки с более высокой степенью параллелизма после агрегации с grouping sets. [#74082](https://github.com/ClickHouse/ClickHouse/pull/74082) ([Nikita Taranov](https://github.com/nickitat)).
* Сокращена критическая секция в `MergeTreeReadPool`. [#74202](https://github.com/ClickHouse/ClickHouse/pull/74202) ([Guo Wangyang](https://github.com/guowangy)).
* Повышение производительности параллельных реплик. Десериализация пакетов на инициаторе запроса для пакетов, не связанных с протоколом параллельных реплик, теперь всегда выполняется в потоке конвейера. Ранее она могла выполняться в потоке, отвечающем за планирование конвейера, что могло снижать отзывчивость инициатора и приводить к задержкам выполнения конвейера. [#74398](https://github.com/ClickHouse/ClickHouse/pull/74398) ([Igor Nikonov](https://github.com/devcrafter)).
* Улучшена производительность больших multi-запросов в Keeper. [#74849](https://github.com/ClickHouse/ClickHouse/pull/74849) ([Antonio Andelic](https://github.com/antonio2368)).
* Используйте обёртки для логирования по значению и не выделяйте память под них в куче. [#74034](https://github.com/ClickHouse/ClickHouse/pull/74034) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Восстанавливать соединение с репликами словарей MySQL и Postgres в фоновом режиме, чтобы не задерживать запросы к соответствующим словарям. [#71101](https://github.com/ClickHouse/ClickHouse/pull/71101) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Параллельные реплики использовали исторические данные о доступности реплик для улучшения выбора, но не обновляли счётчик ошибок реплики, когда подключение было недоступно. В этом PR счётчик ошибок реплики обновляется при её недоступности. [#72666](https://github.com/ClickHouse/ClickHouse/pull/72666) ([zoomxi](https://github.com/zoomxi)).
* Добавлена настройка MergeTree `materialize_skip_indexes_on_merge`, которая отключает создание пропускающих индексов при слиянии. Это позволяет пользователям явно контролировать (через `ALTER TABLE [..] MATERIALIZE INDEX [...]`), когда создаются пропускающие индексы. Это может быть полезно, если пропускающие индексы дороги в построении (например, индексы векторного сходства). [#74401](https://github.com/ClickHouse/ClickHouse/pull/74401) ([Robert Schulze](https://github.com/rschu1ze)).
* Оптимизированы запросы к Keeper в Storage(S3/Azure)Queue. [#74410](https://github.com/ClickHouse/ClickHouse/pull/74410) ([Kseniia Sumarokova](https://github.com/kssenii)). [#74538](https://github.com/ClickHouse/ClickHouse/pull/74538) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Теперь по умолчанию используется до `1000` параллельных реплик. [#74504](https://github.com/ClickHouse/ClickHouse/pull/74504) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Улучшено повторное использование HTTP-сессий при чтении с диска S3 ([#72401](https://github.com/ClickHouse/ClickHouse/issues/72401)). [#74548](https://github.com/ClickHouse/ClickHouse/pull/74548) ([Julian Maicher](https://github.com/jmaicher)).





#### Улучшение

* Добавлена поддержка секции SETTINGS в запросе CREATE TABLE с неявным ENGINE, а также поддержка совместного использования настроек движка и настроек запроса. [#73120](https://github.com/ClickHouse/ClickHouse/pull/73120) ([Raúl Marín](https://github.com/Algunenano)).
* Включить `use_hive_partitioning` по умолчанию. [#71636](https://github.com/ClickHouse/ClickHouse/pull/71636) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Поддержаны `CAST` и `ALTER` между типами JSON с различными параметрами. [#72303](https://github.com/ClickHouse/ClickHouse/pull/72303) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена поддержка сравнения на равенство значений в столбце JSON. [#72991](https://github.com/ClickHouse/ClickHouse/pull/72991) ([Pavel Kruglov](https://github.com/Avogar)).
* Улучшено форматирование идентификаторов с JSON-подстолбцами, чтобы избежать лишних обратных кавычек. [#73085](https://github.com/ClickHouse/ClickHouse/pull/73085) ([Pavel Kruglov](https://github.com/Avogar)).
* Улучшения интерактивных метрик. Исправлена проблема, из-за которой метрики от параллельных реплик отображались не полностью. Метрики отображаются в порядке времени последнего обновления, затем лексикографически по имени. Устаревшие метрики не отображаются. [#71631](https://github.com/ClickHouse/ClickHouse/pull/71631) ([Julia Kartseva](https://github.com/jkartseva)).
* Формат вывода JSON по умолчанию сделан удобочитаемым. Добавлена новая настройка `output_format_json_pretty_print` для управления этим поведением, она включена по умолчанию. [#72148](https://github.com/ClickHouse/ClickHouse/pull/72148) ([Pavel Kruglov](https://github.com/Avogar)).
* Разрешить `LowCardinality(UUID)` по умолчанию. Практика показала, что это удобно для клиентов ClickHouse Cloud. [#73826](https://github.com/ClickHouse/ClickHouse/pull/73826) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшено сообщение, выводимое при установке. [#73827](https://github.com/ClickHouse/ClickHouse/pull/73827) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Более информативное сообщение о сбросе пароля в ClickHouse Cloud. [#73831](https://github.com/ClickHouse/ClickHouse/pull/73831) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшено сообщение об ошибке для таблицы File, которая не может выполнять дозапись в файл. [#73832](https://github.com/ClickHouse/ClickHouse/pull/73832) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Запрашивать подтверждение, если пользователь по ошибке пытается вывести бинарный формат (например, Native, Parquet, Avro) в терминал. Исправляет [#59524](https://github.com/ClickHouse/ClickHouse/issues/59524). [#73833](https://github.com/ClickHouse/ClickHouse/pull/73833) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Подсвечивать пробелы в конце строк в форматах Pretty и Vertical в терминале для лучшей наглядности. Поведение управляется настройкой `output_format_pretty_highlight_trailing_spaces`. Исходная реализация от [Braden Burns](https://github.com/bradenburns) из [#72996](https://github.com/ClickHouse/ClickHouse/issues/72996). Закрывает [#71590](https://github.com/ClickHouse/ClickHouse/issues/71590). [#73847](https://github.com/ClickHouse/ClickHouse/pull/73847) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* `clickhouse-client` и `clickhouse-local` автоматически определяют тип сжатия stdin, если он перенаправлен из файла. Это устраняет проблему [#70865](https://github.com/ClickHouse/ClickHouse/issues/70865). [#73848](https://github.com/ClickHouse/ClickHouse/pull/73848) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* По умолчанию в форматах `pretty` слишком длинные имена столбцов обрезаются. Это поведение управляется настройками `output_format_pretty_max_column_name_width_cut_to` и `output_format_pretty_max_column_name_width_min_chars_to_cut`. Это продолжение работы [tanmaydatta](https://github.com/tanmaydatta) по задаче [#66502](https://github.com/ClickHouse/ClickHouse/issues/66502). Этим закрывается задача [#65968](https://github.com/ClickHouse/ClickHouse/issues/65968). [#73851](https://github.com/ClickHouse/ClickHouse/pull/73851) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Форматы `Pretty` стали более удобочитаемыми: блоки объединяются, если с момента вывода предыдущего блока прошло немного времени. Это регулируется новыми настройками `output_format_pretty_squash_consecutive_ms` (по умолчанию 50 мс) и `output_format_pretty_squash_max_wait_ms` (по умолчанию 1000 мс). Продолжение [#49537](https://github.com/ClickHouse/ClickHouse/issues/49537). Закрывает [#49153](https://github.com/ClickHouse/ClickHouse/issues/49153). [#73852](https://github.com/ClickHouse/ClickHouse/pull/73852) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена метрика числа исходных частей, которые в данный момент находятся в процессе слияния. Это закрывает [#70809](https://github.com/ClickHouse/ClickHouse/issues/70809). [#73868](https://github.com/ClickHouse/ClickHouse/pull/73868) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Теперь столбцы в формате `Vertical`, если вывод идет в терминал, подсвечиваются цветом. Это можно отключить с помощью настройки `output_format_pretty_color`. [#73898](https://github.com/ClickHouse/ClickHouse/pull/73898) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшена совместимость с MySQL до такого уровня, что `mysqlsh` (расширенный CLI-интерфейс MySQL от Oracle) теперь может подключаться к ClickHouse. Это необходимо для упрощения тестирования. [#73912](https://github.com/ClickHouse/ClickHouse/pull/73912) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Форматы Pretty могут отображать многострочные поля внутри ячейки таблицы, что улучшает читаемость. Это поведение включено по умолчанию и может управляться настройкой `output_format_pretty_multiline_fields`. Продолжение работы [Volodyachan](https://github.com/Volodyachan) в [#64094](https://github.com/ClickHouse/ClickHouse/issues/64094). Это закрывает [#56912](https://github.com/ClickHouse/ClickHouse/issues/56912). [#74032](https://github.com/ClickHouse/ClickHouse/pull/74032) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* HTTP-заголовки X-ClickHouse стали доступны JavaScript в браузере. Это упрощает разработку приложений. [#74180](https://github.com/ClickHouse/ClickHouse/pull/74180) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Формат `JSONEachRowWithProgress` теперь включает события с метаданными, а также totals и extremes. Он также включает `rows_before_limit_at_least` и `rows_before_aggregation`. Формат корректно выводит исключение, если оно возникает после частичных результатов. В сведения о прогрессе теперь включено затраченное время в наносекундах. В конце испускается одно финальное событие о прогрессе. События прогресса во время выполнения запроса будут выводиться не чаще, чем это задано настройкой `interactive_delay`. [#74181](https://github.com/ClickHouse/ClickHouse/pull/74181) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Иконка песочных часов будет плавно вращаться в интерфейсе Play. [#74182](https://github.com/ClickHouse/ClickHouse/pull/74182) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Даже если HTTP-ответ сжат, отправляйте пакеты по мере их поступления. Это позволяет браузеру получать пакеты прогресса и сжатые данные. [#74201](https://github.com/ClickHouse/ClickHouse/pull/74201) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Если количество строк в выводе превышает N = `output_format_pretty_max_rows`, вместо отображения только первых N строк мы обрежем таблицу посередине и покажем N/2 первых и N/2 последних строк. Продолжение [#64200](https://github.com/ClickHouse/ClickHouse/issues/64200). Это закрывает [#59502](https://github.com/ClickHouse/ClickHouse/issues/59502). [#73929](https://github.com/ClickHouse/ClickHouse/pull/73929) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Разрешить использование более общего алгоритма планирования операций JOIN при включённом алгоритме hash join. [#71926](https://github.com/ClickHouse/ClickHouse/pull/71926) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Добавлена возможность создавать индекс bloom&#95;filter на столбцах с типом данных `DateTime64`. [#66416](https://github.com/ClickHouse/ClickHouse/pull/66416) ([Yutong Xiao](https://github.com/YutSean)).
* Когда одновременно включены `min_age_to_force_merge_seconds` и `min_age_to_force_merge_on_partition_only`, слияние частей будет игнорировать ограничение по максимальному размеру (в байтах). [#73656](https://github.com/ClickHouse/ClickHouse/pull/73656) ([Kai Zhu](https://github.com/nauu)).
* Добавлены HTTP-заголовки в таблицу журналов спанов OpenTelemetry для повышения трассируемости. [#70516](https://github.com/ClickHouse/ClickHouse/pull/70516) ([jonymohajanGmail](https://github.com/jonymohajanGmail)).
* Добавлена поддержка записи файлов `orc` с использованием произвольного часового пояса, а не только `GMT`. [#70615](https://github.com/ClickHouse/ClickHouse/pull/70615) ([kevinyhzou](https://github.com/KevinyhZou)).
* Учитывать настройки планирования ввода-вывода при записи резервных копий между различными облаками. [#71093](https://github.com/ClickHouse/ClickHouse/pull/71093) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Добавлен псевдоним столбца `metric` — `name` — в таблицу `system.asynchronous_metrics`. [#71164](https://github.com/ClickHouse/ClickHouse/pull/71164) ([megao](https://github.com/jetgm)).
* Исторически сложилось, что по какой-то причине запрос `ALTER TABLE MOVE PARTITION TO TABLE` проверял права `SELECT` и `ALTER DELETE` вместо отдельного права `ALTER_MOVE_PARTITION`. В этом PR используется соответствующий тип доступа. Для совместимости это разрешение также будет неявно предоставляться, если выданы `SELECT` и `ALTER DELETE`, но это поведение будет удалено в будущих релизах. Закрывает [#16403](https://github.com/ClickHouse/ClickHouse/issues/16403). [#71632](https://github.com/ClickHouse/ClickHouse/pull/71632) ([pufit](https://github.com/pufit)).
* Выбрасывать исключение при попытке материализовать столбец в ключе сортировки вместо того, чтобы допускать нарушение порядка сортировки. [#71891](https://github.com/ClickHouse/ClickHouse/pull/71891) ([Peter Nguyen](https://github.com/petern48)).
* Скрывать секретные данные в `EXPLAIN QUERY TREE`. [#72025](https://github.com/ClickHouse/ClickHouse/pull/72025) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Добавлена поддержка целочисленных логических типов Parquet в &quot;native&quot;-ридере. [#72105](https://github.com/ClickHouse/ClickHouse/pull/72105) ([Arthur Passos](https://github.com/arthurpassos)).
* Учетные данные теперь интерактивно запрашиваются в браузере, если для пользователя по умолчанию требуется пароль. В предыдущих версиях сервер возвращал HTTP 403; теперь он возвращает HTTP 401. [#72198](https://github.com/ClickHouse/ClickHouse/pull/72198) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Преобразованы типы доступа `CREATE_USER`, `ALTER_USER`, `DROP_USER`, `CREATE_ROLE`, `ALTER_ROLE`, `DROP_ROLE` из глобальных в параметризованные. Это означает, что пользователи теперь могут более точно выдавать права управления доступом. [#72246](https://github.com/ClickHouse/ClickHouse/pull/72246) ([pufit](https://github.com/pufit)).
* Добавлен столбец `latest_fail_error_code_name` в `system.mutations`. Этот столбец необходим для введения новой метрики по застрявшим мутациям и её использования для построения графиков ошибок, возникающих в облаке, а также, при необходимости, добавления нового, менее шумного оповещения. [#72398](https://github.com/ClickHouse/ClickHouse/pull/72398) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Снижено количество выделений памяти в запросе `ATTACH PARTITION`. [#72583](https://github.com/ClickHouse/ClickHouse/pull/72583) ([Konstantин Morozov](https://github.com/k-morozov)).
* Значение `max_bytes_before_external_sort` теперь зависит от общего потребления памяти запросом (ранее оно определяло количество байт в блоке сортировки для одного потока сортировки, теперь оно имеет то же значение, что и `max_bytes_before_external_group_by` — это общий лимит памяти, потребляемой запросом всеми потоками). Также добавлена ещё одна настройка для управления размером блоков на диске — `min_external_sort_block_bytes`. [#72598](https://github.com/ClickHouse/ClickHouse/pull/72598) ([Azat Khuzhin](https://github.com/azat)).
* Игнорировать ограничения по памяти в сборщике трассировки. [#72606](https://github.com/ClickHouse/ClickHouse/pull/72606) ([Azat Khuzhin](https://github.com/azat)).
* Добавлены настройки сервера `dictionaries_lazy_load` и `wait_dictionaries_load_at_startup` в `system.server_settings`. [#72664](https://github.com/ClickHouse/ClickHouse/pull/72664) ([Christoph Wurm](https://github.com/cwurm)).
* Добавляет настройку `max_backup_bandwidth` в список настроек, которые можно указывать в запросах `BACKUP`/`RESTORE`. [#72665](https://github.com/ClickHouse/ClickHouse/pull/72665) ([Christoph Wurm](https://github.com/cwurm)).
* Снижен уровень логирования появления реплицированных частей в движке ReplicatedMergeTree, чтобы уменьшить объем логов, генерируемых в реплицированном кластере. [#72876](https://github.com/ClickHouse/ClickHouse/pull/72876) ([mor-akamai](https://github.com/morkalfon)).
* Улучшено извлечение общих выражений в дизъюнкциях. Добавлена возможность упрощать результирующее фильтрующее выражение даже при отсутствии общего подвыражения для всех дизъюнктов. Продолжение [#71537](https://github.com/ClickHouse/ClickHouse/issues/71537). [#73271](https://github.com/ClickHouse/ClickHouse/pull/73271) ([Dmitry Novik](https://github.com/novikd)).
* В хранилищах `S3Queue`/`AzureQueue` теперь можно добавлять настройки для таблиц, которые были созданы без настроек. [#73283](https://github.com/ClickHouse/ClickHouse/pull/73283) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена настройка `least_greatest_legacy_null_behavior` (по умолчанию: `false`), которая задаёт, должны ли функции `least` и `greatest` при обработке аргументов `NULL` безусловно возвращать `NULL` (если `true`) или игнорировать такие аргументы (если `false`). [#73344](https://github.com/ClickHouse/ClickHouse/pull/73344) ([Robert Schulze](https://github.com/rschu1ze)).
* Использовать Keeper multi-requests в потоке очистки ObjectStorageQueueMetadata. [#73357](https://github.com/ClickHouse/ClickHouse/pull/73357) ([Antonio Andelic](https://github.com/antonio2368)).
* Когда ClickHouse выполняется в cgroup, мы по-прежнему собираем асинхронные метрики в масштабах всей системы, связанные с системной нагрузкой, планированием процессов, памятью и т. д. Они могут давать полезные сигналы, когда ClickHouse является единственным процессом на хосте с высоким потреблением ресурсов. [#73369](https://github.com/ClickHouse/ClickHouse/pull/73369) ([Nikita Taranov](https://github.com/nickitat)).
* В хранилище `S3Queue` добавлена возможность переноса старых упорядоченных таблиц, созданных до версии 24.6, в новую структуру с бакетами. [#73467](https://github.com/ClickHouse/ClickHouse/pull/73467) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена таблица `system.azure_queue`, аналогичная существующей `system.s3queue`. [#73477](https://github.com/ClickHouse/ClickHouse/pull/73477) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Функция `parseDateTime64` (и её варианты) теперь выдаёт корректные результаты для входных дат до 1970 года и после 2106 года. Пример: `SELECT parseDateTime64InJodaSyntax('2200-01-01 00:00:00.000', 'yyyy-MM-dd HH:mm:ss.SSS')`. [#73594](https://github.com/ClickHouse/ClickHouse/pull/73594) ([zhanglistar](https://github.com/zhanglistar)).
* Исправлены отдельные проблемы удобства использования `clickhouse-disks`, отмеченные пользователями. Закрывает [#67136](https://github.com/ClickHouse/ClickHouse/issues/67136). [#73616](https://github.com/ClickHouse/ClickHouse/pull/73616) ([Daniil Ivanik](https://github.com/divanik)).
* Разрешить изменять параметры коммита в хранилище S3(Azure)Queue. (Параметры коммита: `max_processed_files_before_commit`, `max_processed_rows_before_commit`, `max_processed_bytes_before_commit`, `max_processing_time_sec_before_commit`). [#73635](https://github.com/ClickHouse/ClickHouse/pull/73635) ([Kseniia Sumarokova](https://github.com/kssenii)).
* В движке хранения S3(Azure)Queue агрегируется прогресс между источниками для сравнения с настройками лимита коммита. [#73641](https://github.com/ClickHouse/ClickHouse/pull/73641) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка основных настроек в запросах `BACKUP`/`RESTORE`. [#73650](https://github.com/ClickHouse/ClickHouse/pull/73650) ([Vitaly Baranov](https://github.com/vitlibar)).
* Теперь учитывается `output_format_compression_level` при выводе в формате Parquet. [#73651](https://github.com/ClickHouse/ClickHouse/pull/73651) ([Arthur Passos](https://github.com/arthurpassos)).
* Добавлено чтение Apache Arrow `fixed_size_list` как `Array` вместо обработки его как неподдерживаемого типа. [#73654](https://github.com/ClickHouse/ClickHouse/pull/73654) ([Julian Meyers](https://github.com/J-Meyers)).
* Добавлены два движка резервного копирования: `Memory` (хранит резервные копии в рамках текущей пользовательской сессии) и `Null` (не сохраняет резервные копии, предназначен для тестирования). [#73690](https://github.com/ClickHouse/ClickHouse/pull/73690) ([Vitaly Baranov](https://github.com/vitlibar)).
* `concurrent_threads_soft_limit_num` и `concurrent_threads_soft_limit_num_ratio_to_cores` можно изменять без перезапуска сервера. [#73713](https://github.com/ClickHouse/ClickHouse/pull/73713) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена поддержка расширенных числовых типов данных (`Decimal`, большие целые числа) в функциях `formatReadable`. [#73765](https://github.com/ClickHouse/ClickHouse/pull/73765) ([Raúl Marín](https://github.com/Algunenano)).
* Реализована поддержка TLS для совместимости с протоколом взаимодействия Postgres (wire protocol). [#73812](https://github.com/ClickHouse/ClickHouse/pull/73812) ([scanhex12](https://github.com/scanhex12)).
* Функция `isIPv4String` возвращала true, если за корректным IPv4-адресом следовал нулевой байт, хотя в этом случае она должна возвращать false. Продолжение [#65387](https://github.com/ClickHouse/ClickHouse/issues/65387). [#73946](https://github.com/ClickHouse/ClickHouse/pull/73946) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сделать код ошибки в протоколе MySQL Wire совместимым с MySQL. Продолжение [#56831](https://github.com/ClickHouse/ClickHouse/issues/56831). Закрывает [#50957](https://github.com/ClickHouse/ClickHouse/issues/50957). [#73948](https://github.com/ClickHouse/ClickHouse/pull/73948) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена настройка `validate_enum_literals_in_opearators` для проверки литералов перечислений в операторах `IN` и `NOT IN` на соответствие enum-типу и выброса исключения, если литерал не является допустимым значением enum. [#73985](https://github.com/ClickHouse/ClickHouse/pull/73985) ([Vladimir Cherkasov](https://github.com/vdimir)).
* В хранилище `S3(Azure)Queue` все файлы (в одном батче, определённом настройками коммита) фиксируются в одной транзакции Keeper. [#73991](https://github.com/ClickHouse/ClickHouse/pull/73991) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отключено определение заголовков для исполняемых UDF и словарей (могло приводить к ошибке вида Function &#39;X&#39;: wrong result, expected Y row(s), actual Y-1). [#73992](https://github.com/ClickHouse/ClickHouse/pull/73992) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена опция `distributed` для `EXPLAIN PLAN`. Теперь команда `EXPLAIN distributed=1 ...` добавляет удалённый план к шагам `ReadFromParallelRemote*`. [#73994](https://github.com/ClickHouse/ClickHouse/pull/73994) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Теперь для not/xor с аргументами типа Dynamic используется корректный тип возвращаемого значения. [#74013](https://github.com/ClickHouse/ClickHouse/pull/74013) ([Pavel Kruglov](https://github.com/Avogar)).
* Разрешена возможность изменять `add_implicit_sign_column_constraint_for_collapsing_engine` после создания таблицы. [#74014](https://github.com/ClickHouse/ClickHouse/pull/74014) ([Christoph Wurm](https://github.com/cwurm)).
* Поддержка подстолбцов в запросе SELECT для материализованного представления. [#74030](https://github.com/ClickHouse/ClickHouse/pull/74030) ([Pavel Kruglov](https://github.com/Avogar)).
* Теперь есть три простых способа задать пользовательское приглашение (prompt) в `clickhouse-client`: 1. через параметр командной строки `--prompt`, 2. в конфигурационном файле, с помощью настройки `<prompt>[...]</prompt>`, и 3. также в конфигурационном файле, через настройки для отдельных подключений `<connections_credentials><prompt>[...]</prompt></connections_credentials>`. [#74168](https://github.com/ClickHouse/ClickHouse/pull/74168) ([Christoph Wurm](https://github.com/cwurm)).
* Автоматическое определение использования защищённого соединения при подключении к порту 9440 в ClickHouse Client. [#74212](https://github.com/ClickHouse/ClickHouse/pull/74212) ([Christoph Wurm](https://github.com/cwurm)).
* Разрешить аутентификацию пользователей только по имени пользователя для http&#95;handlers (раньше также требовалось указывать пароль). [#74221](https://github.com/ClickHouse/ClickHouse/pull/74221) ([Azat Khuzhin](https://github.com/azat)).
* Поддержка альтернативных языков запросов PRQL и KQL была помечена как экспериментальная. Для их использования включите настройки `allow_experimental_prql_dialect = 1` и `allow_experimental_kusto_dialect = 1`. [#74224](https://github.com/ClickHouse/ClickHouse/pull/74224) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка возврата типа `Enum` по умолчанию в большем количестве агрегатных функций. [#74272](https://github.com/ClickHouse/ClickHouse/pull/74272) ([Raúl Marín](https://github.com/Algunenano)).
* В операции `OPTIMIZE TABLE` теперь можно указать ключевое слово `FORCE` в качестве альтернативы существующему ключевому слову `FINAL`. [#74342](https://github.com/ClickHouse/ClickHouse/pull/74342) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена метрика `IsServerShuttingDown`, необходимая для срабатывания оповещения, если завершение работы сервера занимает слишком много времени. [#74429](https://github.com/ClickHouse/ClickHouse/pull/74429) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Добавлены имена таблиц Iceberg в вывод EXPLAIN. [#74485](https://github.com/ClickHouse/ClickHouse/pull/74485) ([alekseev-maksim](https://github.com/alekseev-maksim)).
* Добавлено более информативное сообщение об ошибке при использовании RECURSIVE CTE со старым анализатором. [#74523](https://github.com/ClickHouse/ClickHouse/pull/74523) ([Raúl Marín](https://github.com/Algunenano)).
* Отображать расширенные сообщения об ошибках в `system.errors`. [#74574](https://github.com/ClickHouse/ClickHouse/pull/74574) ([Vitaly Baranov](https://github.com/vitlibar)).
* Разрешено использовать пароль для взаимодействия клиента с clickhouse-keeper. Эта возможность не особо полезна, если вы настроите корректную SSL‑конфигурацию для сервера и клиента, но всё же может быть полезна в некоторых случаях. Пароль не может быть длиннее 16 символов. Это не связано с моделью аутентификации Keeper. [#74673](https://github.com/ClickHouse/ClickHouse/pull/74673) ([alesapin](https://github.com/alesapin)).
* Добавлен код ошибки для перезагрузчика конфигурации. [#74746](https://github.com/ClickHouse/ClickHouse/pull/74746) ([Garrett Thomas](https://github.com/garrettthomaskth)).
* Добавлена поддержка IPv6-адресов в табличных функциях и движках таблиц MySQL и PostgreSQL. [#74796](https://github.com/ClickHouse/ClickHouse/pull/74796) ([Mikhail Koviazin](https://github.com/mkmkme)).
* Реализована оптимизация с коротким замыканием для `divideDecimal`. Исправляет [#74280](https://github.com/ClickHouse/ClickHouse/issues/74280). [#74843](https://github.com/ClickHouse/ClickHouse/pull/74843) ([Kevin Mingtarja](https://github.com/kevinmingtarja)).
* Теперь пользователей можно указывать в скриптах запуска. [#74894](https://github.com/ClickHouse/ClickHouse/pull/74894) ([pufit](https://github.com/pufit)).
* Добавлена поддержка токенов SAS Azure. [#72959](https://github.com/ClickHouse/ClickHouse/pull/72959) ([Azat Khuzhin](https://github.com/azat)).





#### Исправление ошибки (некорректное поведение, видимое пользователю, в официальном стабильном релизе)

* Устанавливайте уровень сжатия Parquet только в том случае, если используемый кодек сжатия поддерживает эту настройку. [#74659](https://github.com/ClickHouse/ClickHouse/pull/74659) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлена регрессия, из‑за которой использование локалей сортировки с модификаторами приводило к ошибке. Например, запрос `SELECT arrayJoin(['kk 50', 'KK 01', ' KK 2', ' KK 3', 'kk 1', 'x9y99', 'x9y100']) item ORDER BY item ASC COLLATE 'tr-u-kn-true-ka-shifted` теперь выполняется корректно. [#73544](https://github.com/ClickHouse/ClickHouse/pull/73544) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена проблема, из-за которой было невозможно создать узел SEQUENTIAL с помощью keeper-client. [#64177](https://github.com/ClickHouse/ClickHouse/pull/64177) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлен некорректный подсчёт символов в функциях position. [#71003](https://github.com/ClickHouse/ClickHouse/pull/71003) ([思维](https://github.com/heymind)).
* Операции `RESTORE` для сущностей доступа требовали больше прав, чем было необходимо, из-за необработанных частичных отзывов прав. Этот PR исправляет проблему. Закрывает [#71853](https://github.com/ClickHouse/ClickHouse/issues/71853). [#71958](https://github.com/ClickHouse/ClickHouse/pull/71958) ([pufit](https://github.com/pufit)).
* Исключена пауза после `ALTER TABLE REPLACE/MOVE PARTITION FROM/TO TABLE`. Теперь корректно считываются настройки для планирования фоновых задач. [#72024](https://github.com/ClickHouse/ClickHouse/pull/72024) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Исправлена обработка пустых кортежей в некоторых форматах ввода и вывода (например, Parquet, Arrow). [#72616](https://github.com/ClickHouse/ClickHouse/pull/72616) ([Michael Kolupaev](https://github.com/al13n321)).
* Операторы GRANT SELECT/INSERT на уровне столбцов для баз данных и таблиц, указанных с помощью подстановочных символов, теперь завершаются ошибкой. [#72646](https://github.com/ClickHouse/ClickHouse/pull/72646) ([Johann Gan](https://github.com/johanngan)).
* Исправлена ситуация, когда пользователь не может выполнить `REVOKE ALL ON *.*` из‑за неявных привилегий в целевом объекте доступа. [#72872](https://github.com/ClickHouse/ClickHouse/pull/72872) ([pufit](https://github.com/pufit)).
* Исправлено форматирование положительных смещений часового пояса в скалярной функции formatDateTime. [#73091](https://github.com/ClickHouse/ClickHouse/pull/73091) ([ollidraese](https://github.com/ollidraese)).
* Исправлено корректное определение исходного порта при подключении через PROXYv1 и установленном `auth_use_forwarded_address` — ранее ошибочно использовался порт прокси. Добавлена функция `currentQueryID()`. [#73095](https://github.com/ClickHouse/ClickHouse/pull/73095) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Пробрасывать настройки формата из `TCPHandler` в `NativeWriter`, чтобы такие настройки, как `output_format_native_write_json_as_string`, корректно применялись. [#73179](https://github.com/ClickHouse/ClickHouse/pull/73179) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен сбой в StorageObjectStorageQueue. [#73274](https://github.com/ClickHouse/ClickHouse/pull/73274) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено редкое падение обновляемого материализованного представления во время остановки сервера. [#73323](https://github.com/ClickHouse/ClickHouse/pull/73323) ([Michael Kolupaev](https://github.com/al13n321)).
* Спецификатор `%f` функции `formatDateTime` теперь всегда генерирует шесть цифр для долей секунды. Это делает поведение совместимым с функцией MySQL `DATE_FORMAT`. Предыдущее поведение можно восстановить с помощью настройки `formatdatetime_f_prints_scale_number_of_digits = 1`. [#73324](https://github.com/ClickHouse/ClickHouse/pull/73324) ([ollidraese](https://github.com/ollidraese)).
* Исправлена фильтрация по столбцу `_etag` при чтении из хранилища `s3` и при использовании табличной функции `s3`. [#73353](https://github.com/ClickHouse/ClickHouse/pull/73353) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка `Not-ready Set is passed as the second argument for function 'in'`, возникающая при использовании `IN (subquery)` в выражении `JOIN ON` при использовании старого анализатора. [#73382](https://github.com/ClickHouse/ClickHouse/pull/73382) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена подготовка к схлопыванию для столбцов Dynamic и JSON. Ранее в некоторых случаях новые типы могли быть вставлены в shared variant/shared data, даже если ограничение на количество типов/путей ещё не было достигнуто. [#73388](https://github.com/ClickHouse/ClickHouse/pull/73388) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена проверка повреждённых размеров при бинарном декодировании типов, чтобы избежать слишком больших выделений памяти. [#73390](https://github.com/ClickHouse/ClickHouse/pull/73390) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена логическая ошибка при чтении из кластера с одной репликой при включённом режиме параллельных реплик. [#73403](https://github.com/ClickHouse/ClickHouse/pull/73403) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена работа очереди ObjectStorageQueue с ZooKeeper и старыми версиями Keeper. [#73420](https://github.com/ClickHouse/ClickHouse/pull/73420) ([Antonio Andelic](https://github.com/antonio2368)).
* Реализовано исправление, необходимое для включения по умолчанию разбиения на разделы Hive. [#73479](https://github.com/ClickHouse/ClickHouse/pull/73479) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена гонка данных при создании индекса векторного сходства. [#73517](https://github.com/ClickHouse/ClickHouse/pull/73517) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлен сегфолт, возникающий, когда источник словаря содержит функцию с некорректными данными. [#73535](https://github.com/ClickHouse/ClickHouse/pull/73535) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена логика повторных попыток вставки при сбое в `storage S3(Azure)Queue`. Закрывает [#70951](https://github.com/ClickHouse/ClickHouse/issues/70951). [#73546](https://github.com/ClickHouse/ClickHouse/pull/73546) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка в функции `tupleElement`, которая могла возникать в некоторых случаях для кортежей с элементами `LowCardinality` при включённой настройке `optimize_functions_to_subcolumns`. [#73548](https://github.com/ClickHouse/ClickHouse/pull/73548) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен разбор шаблона enum, за которым следует диапазон. Исправление для [#73473](https://github.com/ClickHouse/ClickHouse/issues/73473). [#73569](https://github.com/ClickHouse/ClickHouse/pull/73569) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлена ошибка, из-за которой настройка parallel&#95;replicas&#95;for&#95;non&#95;replicated&#95;merge&#95;tree игнорировалась в подзапросах для нереплицируемых таблиц. [#73584](https://github.com/ClickHouse/ClickHouse/pull/73584) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправление ошибки `std::logical&#95;error`, выбрасываемой, когда задачу невозможно запланировать. Обнаружено в стресс‑тестах. [#73629](https://github.com/ClickHouse/ClickHouse/pull/73629) ([Alexander Gololobov](https://github.com/davenger)).
* Не интерпретировать запросы в `EXPLAIN SYNTAX`, чтобы избежать логических ошибок из‑за некорректного этапа обработки распределённых запросов. Исправление [#65205](https://github.com/ClickHouse/ClickHouse/issues/65205). [#73634](https://github.com/ClickHouse/ClickHouse/pull/73634) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена возможная неконсистентность данных в Dynamic column. Исправлена возможная логическая ошибка `Nested columns sizes are inconsistent with local_discriminators column size`. [#73644](https://github.com/ClickHouse/ClickHouse/pull/73644) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка `NOT_FOUND_COLUMN_IN_BLOCK` в запросах с `FINAL` и `SAMPLE`. Исправлен некорректный результат в запросах `SELECT` с `FINAL` из `CollapsingMergeTree` и включены оптимизации для `FINAL`. [#73682](https://github.com/ClickHouse/ClickHouse/pull/73682) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка, приводившая к аварийному завершению при использовании `LIMIT BY COLUMNS`. [#73686](https://github.com/ClickHouse/ClickHouse/pull/73686) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена ошибка, из-за которой при принудительном использовании нормальной проекции запрос, в точности совпадающий с определённой проекцией, не приводил к выбору этой проекции, из‑за чего возникала ошибка. [#73700](https://github.com/ClickHouse/ClickHouse/pull/73700) ([Shichao Jin](https://github.com/jsc0218)).
* Исправлена десериализация структуры Dynamic/Object. Это могло приводить к исключениям CANNOT&#95;READ&#95;ALL&#95;DATA. [#73767](https://github.com/ClickHouse/ClickHouse/pull/73767) ([Pavel Kruglov](https://github.com/Avogar)).
* Пропускать файл `metadata_version.txt` при восстановлении частей из резервной копии. [#73768](https://github.com/ClickHouse/ClickHouse/pull/73768) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена ошибка сегментации при приведении к Enum с использованием оператора LIKE. [#73775](https://github.com/ClickHouse/ClickHouse/pull/73775) ([zhanglistar](https://github.com/zhanglistar)).
* Исправлена проблема, из-за которой бакет S3 Express не работал как диск. [#73777](https://github.com/ClickHouse/ClickHouse/pull/73777) ([Sameer Tamsekar](https://github.com/stamsekar)).
* Разрешить слияние строк с недопустимыми значениями столбца `sign` в таблицах `CollapsingMergeTree`. [#73864](https://github.com/ClickHouse/ClickHouse/pull/73864) ([Christoph Wurm](https://github.com/cwurm)).
* Исправлена ошибка, возникавшая при выполнении запроса `ddl` к офлайн-реплике. [#73876](https://github.com/ClickHouse/ClickHouse/pull/73876) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлена редкая ошибка сравнения типов `map()`, возникавшая из‑за возможности создавать `Map` без явных имён («keys», «values») для его вложенного кортежа. [#73878](https://github.com/ClickHouse/ClickHouse/pull/73878) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Игнорировать оконные функции при обработке предложения GROUP BY ALL. Исправить [#73501](https://github.com/ClickHouse/ClickHouse/issues/73501). [#73916](https://github.com/ClickHouse/ClickHouse/pull/73916) ([Dmitry Novik](https://github.com/novikd)).
* Исправлены неявные привилегии (ранее работали как подстановочные шаблоны). [#73932](https://github.com/ClickHouse/ClickHouse/pull/73932) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема высокого потребления памяти при создании вложенных Map. [#73982](https://github.com/ClickHouse/ClickHouse/pull/73982) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена обработка вложенного JSON с пустыми ключами. [#73993](https://github.com/ClickHouse/ClickHouse/pull/73993) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка, из‑за которой псевдоним мог не быть добавлен в проекцию, если на него ссылался другой псевдоним, а в запросе они указывались в обратном порядке. [#74033](https://github.com/ClickHouse/ClickHouse/pull/74033) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Игнорировать ошибки «object not found» для Azure при инициализации диска plain&#95;rewritable. [#74059](https://github.com/ClickHouse/ClickHouse/pull/74059) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлено поведение `any` и `anyLast` для типов Enum и пустых таблиц. [#74061](https://github.com/ClickHouse/ClickHouse/pull/74061) ([Joanna Hulboj](https://github.com/jh0x)).
* Исправлен случай, когда пользователь указывал именованные аргументы в движке таблиц Kafka. [#74064](https://github.com/ClickHouse/ClickHouse/pull/74064) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена обработка изменения настроек хранилища `S3Queue` при смене префикса «s3queue&#95;» на его отсутствие и обратно. [#74075](https://github.com/ClickHouse/ClickHouse/pull/74075) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена настройка `allow_push_predicate_ast_for_distributed_subqueries`. Она включает основанный на AST push-down предикатов для распределённых запросов с анализатором. Это временное решение, которое используется до тех пор, пока не будет добавлена поддержка распределённых запросов с сериализацией плана запроса. Закрывает [#66878](https://github.com/ClickHouse/ClickHouse/issues/66878) [#69472](https://github.com/ClickHouse/ClickHouse/issues/69472) [#65638](https://github.com/ClickHouse/ClickHouse/issues/65638) [#68030](https://github.com/ClickHouse/ClickHouse/issues/68030) [#73718](https://github.com/ClickHouse/ClickHouse/issues/73718). [#74085](https://github.com/ClickHouse/ClickHouse/pull/74085) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Устраняет проблему, при которой после [#73095](https://github.com/ClickHouse/ClickHouse/issues/73095) порт может присутствовать в поле forwarded&#95;for, что приводит к невозможности разрешить имя хоста, если в нём указан порт. [#74116](https://github.com/ClickHouse/ClickHouse/pull/74116) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлено некорректное форматирование `ALTER TABLE (DROP STATISTICS ...) (DROP STATISTICS ...)`. [#74126](https://github.com/ClickHouse/ClickHouse/pull/74126) ([Han Fei](https://github.com/hanfei1991)).
* Исправление для задачи [#66112](https://github.com/ClickHouse/ClickHouse/issues/66112). [#74128](https://github.com/ClickHouse/ClickHouse/pull/74128) ([Anton Ivashkin](https://github.com/ianton-ru)).
* Больше нельзя использовать `Loop` в качестве движка таблицы в `CREATE TABLE`. Ранее это приводило к ошибкам сегментации. [#74137](https://github.com/ClickHouse/ClickHouse/pull/74137) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Устранена уязвимость, позволявшая выполнять SQL-инъекции в табличных функциях postgresql и sqlite. [#74144](https://github.com/ClickHouse/ClickHouse/pull/74144) ([Pablo Marcos](https://github.com/pamarcos)).
* Исправлено аварийное завершение при чтении подстолбца из сжатой таблицы движка Memory. Исправляет [#74009](https://github.com/ClickHouse/ClickHouse/issues/74009). [#74161](https://github.com/ClickHouse/ClickHouse/pull/74161) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлено зацикливание, возникавшее при выполнении запросов к таблице system.detached&#95;tables. [#74190](https://github.com/ClickHouse/ClickHouse/pull/74190) ([Konstantin Morozov](https://github.com/k-morozov)).
* Исправлена логическая ошибка в `s3queue` при пометке файла как ошибочного. [#74216](https://github.com/ClickHouse/ClickHouse/pull/74216) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлены параметры нативного копирования (`allow_s3_native_copy`/`allow_azure_native_copy`) при выполнении `RESTORE` из базового бэкапа. [#74286](https://github.com/ClickHouse/ClickHouse/pull/74286) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема, возникавшая, когда количество отсоединённых таблиц в базе данных было кратным значению параметра `max&#95;block&#95;size`. [#74289](https://github.com/ClickHouse/ClickHouse/pull/74289) ([Konstantин Morозов](https://github.com/k-morozov)).
* Исправлена ошибка копирования через ObjectStorage (например, S3), если учетные данные источника и назначения отличаются. [#74331](https://github.com/ClickHouse/ClickHouse/pull/74331) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено определение опции «use the Rewrite method in the JSON API» при нативном копировании в GCS. [#74338](https://github.com/ClickHouse/ClickHouse/pull/74338) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен некорректный расчет `BackgroundMergesAndMutationsPoolSize` (он был вдвое больше реального значения). [#74509](https://github.com/ClickHouse/ClickHouse/pull/74509) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка утечки наблюдателей Keeper при включении функции Cluster Discovery. [#74521](https://github.com/ClickHouse/ClickHouse/pull/74521) ([RinChanNOW](https://github.com/RinChanNOWWW)).
* Исправлена ошибка выравнивания памяти, выявленная UBSan [#74512](https://github.com/ClickHouse/ClickHouse/issues/74512). [#74534](https://github.com/ClickHouse/ClickHouse/pull/74534) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлена проблема конкурентной очистки KeeperMap при создании таблицы. [#74568](https://github.com/ClickHouse/ClickHouse/pull/74568) ([Antonio Andelic](https://github.com/antonio2368)).
* Не удалять неиспользуемые столбцы проекций в подзапросах при наличии операторов `EXCEPT` или `INTERSECT`, чтобы сохранить корректный результат запроса. Исправляет [#73930](https://github.com/ClickHouse/ClickHouse/issues/73930). Исправляет [#66465](https://github.com/ClickHouse/ClickHouse/issues/66465). [#74577](https://github.com/ClickHouse/ClickHouse/pull/74577) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена работа запросов `INSERT SELECT` между таблицами со столбцами типа `Tuple` при включённой разрежённой сериализации. [#74698](https://github.com/ClickHouse/ClickHouse/pull/74698) ([Anton Popov](https://github.com/CurtizJ)).
* Функция `right` работала некорректно для отрицательного константного смещения. [#74701](https://github.com/ClickHouse/ClickHouse/pull/74701) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлена ошибка, из-за которой вставка gzip-сжатых данных иногда завершалась неудачно вследствие некорректной декомпрессии на стороне клиента. [#74707](https://github.com/ClickHouse/ClickHouse/pull/74707) ([siyuan](https://github.com/linkwk7)).
* Частичные операции REVOKE при использовании прав с подстановочными символами могли отзывать больше привилегий, чем ожидалось. Закрывает [#74263](https://github.com/ClickHouse/ClickHouse/issues/74263). [#74751](https://github.com/ClickHouse/ClickHouse/pull/74751) ([pufit](https://github.com/pufit)).
* Исправление в Keeper: устранена ошибка чтения записей журнала с диска. [#74785](https://github.com/ClickHouse/ClickHouse/pull/74785) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена проверка прав для SYSTEM REFRESH/START/STOP VIEW: теперь для выполнения запроса к конкретному представлению не требуется иметь это право на `*.*`, достаточно прав только на это представление. [#74789](https://github.com/ClickHouse/ClickHouse/pull/74789) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Функция `hasColumnInTable` не учитывала столбцы-псевдонимы. Исправлена, чтобы она также работала со столбцами-псевдонимами. [#74841](https://github.com/ClickHouse/ClickHouse/pull/74841) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлена ошибка FILE&#95;DOESNT&#95;EXIST, возникающая при слиянии частей данных для таблицы с пустым столбцом в Azure Blob Storage. [#74892](https://github.com/ClickHouse/ClickHouse/pull/74892) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлено имя столбца проекции при объединении временных таблиц, закрыт [#68872](https://github.com/ClickHouse/ClickHouse/issues/68872). [#74897](https://github.com/ClickHouse/ClickHouse/pull/74897) ([Vladimir Cherkasov](https://github.com/vdimir)).



#### Улучшения сборки/тестирования/упаковки
* Универсальный скрипт установки теперь предлагает установить ClickHouse и на macOS. [#74339](https://github.com/ClickHouse/ClickHouse/pull/74339) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
