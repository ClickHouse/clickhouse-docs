---
description: "Журнал изменений за 2025 год"
note: "Этот файл сгенерирован с помощью yarn build"
slug: /whats-new/changelog/
sidebar_position: 2
sidebar_label: "2025"
title: "Журнал изменений 2025"
doc_type: "changelog"
---

### Содержание

**[Релиз ClickHouse v25.10, 2025-10-30](#2510)**<br/>
**[Релиз ClickHouse v25.9, 2025-09-25](#259)**<br/>
**[Релиз ClickHouse v25.8 LTS, 2025-08-28](#258)**<br/>
**[Релиз ClickHouse v25.7, 2025-07-24](#257)**<br/>
**[Релиз ClickHouse v25.6, 2025-06-26](#256)**<br/>
**[Релиз ClickHouse v25.5, 2025-05-22](#255)**<br/>
**[Релиз ClickHouse v25.4, 2025-04-22](#254)**<br/>
**[Релиз ClickHouse v25.3 LTS, 2025-03-20](#253)**<br/>
**[Релиз ClickHouse v25.2, 2025-02-27](#252)**<br/>
**[Релиз ClickHouse v25.1, 2025-01-28](#251)**<br/>
**[Журнал изменений за 2024](https://clickhouse.com/docs/whats-new/changelog/2024/)**<br/>
**[Журнал изменений за 2023](https://clickhouse.com/docs/whats-new/changelog/2023/)**<br/>
**[Журнал изменений за 2022](https://clickhouse.com/docs/whats-new/changelog/2022/)**<br/>
**[Журнал изменений за 2021](https://clickhouse.com/docs/whats-new/changelog/2021/)**<br/>
**[Журнал изменений за 2020](https://clickhouse.com/docs/whats-new/changelog/2020/)**<br/>
**[Журнал изменений за 2019](https://clickhouse.com/docs/whats-new/changelog/2019/)**<br/>
**[Журнал изменений за 2018](https://clickhouse.com/docs/whats-new/changelog/2018/)**<br/>
**[Журнал изменений за 2017](https://clickhouse.com/docs/whats-new/changelog/2017/)**<br/>

### Релиз ClickHouse 25.10, 2025-10-31 {#2510}


#### Обратно несовместимое изменение

* Изменено значение настройки по умолчанию `schema_inference_make_columns_nullable`, чтобы учитывать информацию о Nullable‑статусе столбцов из метаданных Parquet/ORC/Arrow, вместо того чтобы делать все столбцы Nullable. Для текстовых форматов изменений нет. [#71499](https://github.com/ClickHouse/ClickHouse/pull/71499) ([Michael Kolupaev](https://github.com/al13n321)).
* Кэш результатов запросов будет игнорировать настройку `log_comment`, чтобы изменение только `log_comment` в запросе больше не приводило к промаху по кэшу. Существует небольшая вероятность, что пользователи намеренно сегментировали кэш, изменяя `log_comment`. Это изменение изменяет такое поведение и, следовательно, является обратно несовместимым. Для этой цели используйте настройку `query_cache_tag`. [#79878](https://github.com/ClickHouse/ClickHouse/pull/79878) ([filimonov](https://github.com/filimonov)).
* В предыдущих версиях запросы с табличными функциями, названными так же, как функции-реализации операторов, форматировались непоследовательно. Закрывает [#81601](https://github.com/ClickHouse/ClickHouse/issues/81601). Закрывает [#81977](https://github.com/ClickHouse/ClickHouse/issues/81977). Закрывает [#82834](https://github.com/ClickHouse/ClickHouse/issues/82834). Закрывает [#82835](https://github.com/ClickHouse/ClickHouse/issues/82835). Запросы EXPLAIN SYNTAX теперь не всегда будут форматировать операторы — новое поведение лучше отражает назначение объяснения синтаксиса. `clickhouse-format`, `formatQuery` и подобные инструменты не будут форматировать функции как операторы, если в запросе они использовались в функциональной форме. [#82825](https://github.com/ClickHouse/ClickHouse/pull/82825) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Запрещено использовать тип `Dynamic` в ключах `JOIN`. Это может привести к неожиданным результатам при сравнении значения типа `Dynamic` со значением другого типа. Лучше явно привести колонку `Dynamic` к требуемому типу. [#86358](https://github.com/ClickHouse/ClickHouse/pull/86358) ([Pavel Kruglov](https://github.com/Avogar)).
* Опция сервера `storage_metadata_write_full_object_key` по умолчанию включена, сейчас её нельзя отключить. Это изменение обратно совместимо. Просим просто принять его к сведению. Это изменение совместимо по направлению вперёд только с релизами 25.x. Это означает, что при необходимости отката нового релиза вы сможете выполнить даунгрейд только на любой релиз 25.x. [#87335](https://github.com/ClickHouse/ClickHouse/pull/87335) ([Sema Checherinda](https://github.com/CheSema)).
* Уменьшено значение `replicated_deduplication_window_seconds` с одной недели до одного часа, чтобы хранить меньше znode в ZooKeeper при низкой скорости вставки данных. [#87414](https://github.com/ClickHouse/ClickHouse/pull/87414) ([Sema Checherinda](https://github.com/CheSema)).
* Переименована настройка `query_plan_use_new_logical_join_step` в `query_plan_use_logical_join_step`. [#87679](https://github.com/ClickHouse/ClickHouse/pull/87679) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Новый синтаксис позволяет параметру `tokenizer` для текстового индекса быть более выразительным. [#87997](https://github.com/ClickHouse/ClickHouse/pull/87997) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Функции `searchAny` и `searchAll` были переименованы в `hasAnyTokens` и `hasAllTokens` для лучшей согласованности с существующей функцией `hasToken`. [#88109](https://github.com/ClickHouse/ClickHouse/pull/88109) ([Robert Schulze](https://github.com/rschu1ze)).
* Удалён параметр `cache_hits_threshold` для кэша файловой системы. Эта возможность была добавлена внешним участником до появления политики кэширования SLRU, и теперь, когда она есть, нет смысла поддерживать обе. [#88344](https://github.com/ClickHouse/ClickHouse/pull/88344) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Два небольших изменения в том, как работают настройки `min_free_disk_ratio_to_perform_insert` и `min_free_disk_bytes_to_perform_insert`: - использовать незарезервированные, а не доступные байты для определения, следует ли отклонить `INSERT`. Вероятно, это не критично, если резервирования для фоновых слияний и мутаций малы по сравнению с настроенными порогами, но так выглядит более корректно. - Не применять эти настройки к системным таблицам. Причина в том, что мы по-прежнему хотим, чтобы такие таблицы, как `query_log`, обновлялись. Это очень помогает при отладке. Объём данных, записываемых в системные таблицы, обычно невелик по сравнению с основными данными, поэтому они смогут продолжать обновляться гораздо дольше при разумном пороге `min_free_disk_ratio_to_perform_insert`. [#88468](https://github.com/ClickHouse/ClickHouse/pull/88468) ([c-end](https://github.com/c-end)).
* Включите асинхронный режим для внутренней репликации Keeper. Keeper сохранит прежнее поведение с возможными улучшениями производительности. Если вы обновляетесь с версии младше 23.9, вам нужно сначала обновиться до 23.9+ и затем до 25.10+. Вы также можете установить `keeper_server.coordination_settings.async_replication` в 0 перед обновлением и включить его после завершения обновления. [#88515](https://github.com/ClickHouse/ClickHouse/pull/88515) ([Antonio Andelic](https://github.com/antonio2368)).





#### Новая функция

* Добавлена поддержка отрицательных значений `LIMIT` и `OFFSET`. Закрывает [#28913](https://github.com/ClickHouse/ClickHouse/issues/28913). [#88411](https://github.com/ClickHouse/ClickHouse/pull/88411) ([Nihal Z. Miaji](https://github.com/nihalzp)).
* Движок `Alias` создает прокси-таблицу к другой таблице. Все операции чтения и записи перенаправляются в целевую таблицу, при этом сам алиас не хранит данные и только поддерживает ссылку на целевую таблицу. [#87965](https://github.com/ClickHouse/ClickHouse/pull/87965) ([Kai Zhu](https://github.com/nauu)).
* Полная поддержка оператора `IS NOT DISTINCT FROM` (`<=>`). [#88155](https://github.com/ClickHouse/ClickHouse/pull/88155) ([simonmichal](https://github.com/simonmichal)).
* Добавлена возможность автоматически создавать статистику по всем подходящим столбцам в таблицах `MergeTree`. Добавлена настройка уровня таблицы `auto_statistics_types`, в которой через запятую перечисляются типы статистики, подлежащие созданию (например, `auto_statistics_types = 'minmax, uniq, countmin'`). [#87241](https://github.com/ClickHouse/ClickHouse/pull/87241) ([Anton Popov](https://github.com/CurtizJ)).
* Новый блум-фильтр-индекс для текстов, `sparse_gram`. [#79985](https://github.com/ClickHouse/ClickHouse/pull/79985) ([scanhex12](https://github.com/scanhex12)).
* Новая функция `conv` для преобразования чисел между основаниями систем счисления, в данный момент поддерживает основания от `2` до `36`. [#83058](https://github.com/ClickHouse/ClickHouse/pull/83058) ([hp](https://github.com/hp77-creator)).
* Добавлена поддержка синтаксиса `LIMIT BY ALL`. Аналогично `GROUP BY ALL` и `ORDER BY ALL`, `LIMIT BY ALL` автоматически разворачивается в использование всех неагрегатных выражений из секции SELECT в качестве ключей LIMIT BY. Например, `SELECT id, name, count(*) FROM table GROUP BY id LIMIT 1 BY ALL` эквивалентен `SELECT id, name, count(*) FROM table GROUP BY id LIMIT 1 BY id, name`. Эта возможность упрощает запросы, когда вы хотите ограничивать по всем выбранным неагрегатным столбцам, не перечисляя их явно. Закрывает [#59152](https://github.com/ClickHouse/ClickHouse/issues/59152). [#84079](https://github.com/ClickHouse/ClickHouse/pull/84079) ([Surya Kant Ranjan](https://github.com/iit2009046)).
* Добавлена поддержка выполнения запросов к Apache Paimon в ClickHouse. Эта интеграция позволяет пользователям ClickHouse напрямую работать с хранилищем дата-лейка Paimon. [#84423](https://github.com/ClickHouse/ClickHouse/pull/84423) ([JIaQi](https://github.com/JiaQiTang98)).
* Добавлена агрегатная функция `studentTTestOneSample`. [#85436](https://github.com/ClickHouse/ClickHouse/pull/85436) ([Dylan](https://github.com/DylanBlakemore)).
* Агрегатная функция `quantilePrometheusHistogram`, которая принимает в качестве аргументов верхние границы и кумулятивные значения бакетов гистограммы и выполняет линейную интерполяцию между верхней и нижней границами того бакета, в котором находится позиция квантиля. Ведет себя аналогично функции PromQL `histogram_quantile` для классических гистограмм. [#86294](https://github.com/ClickHouse/ClickHouse/pull/86294) ([Stephen Chi](https://github.com/stephchi0)).
* Новая системная таблица для файлов метаданных Delta Lake. [#87263](https://github.com/ClickHouse/ClickHouse/pull/87263) ([scanhex12](https://github.com/scanhex12)).
* Добавлена команда `ALTER TABLE REWRITE PARTS`, которая полностью переписывает парты таблицы с нуля с использованием всех новых настроек (так как некоторые, например `use_const_adaptive_granularity`, применяются только к новым партам). [#87774](https://github.com/ClickHouse/ClickHouse/pull/87774) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена команда `SYSTEM RECONNECT ZOOKEEPER` для принудительного разрыва и повторного установления соединения с ZooKeeper ([https://github.com/ClickHouse/ClickHouse/issues/87317](https://github.com/ClickHouse/ClickHouse/issues/87317)). [#87318](https://github.com/ClickHouse/ClickHouse/pull/87318) ([Pradeep Chhetri](https://github.com/chhetripradeep)).
* Ограничьте количество именованных коллекций с помощью настроек `max_named_collection_num_to_warn` и `max_named_collection_num_to_throw`. Добавлена новая метрика `NamedCollection` и ошибка `TOO_MANY_NAMED_COLLECTIONS`. [#87343](https://github.com/ClickHouse/ClickHouse/pull/87343) ([Pablo Marcos](https://github.com/pamarcos)).
* Добавлены оптимизированные варианты функций `startsWith` и `endsWith`, нечувствительные к регистру: `startsWithCaseInsensitive`, `endsWithCaseInsensitive`, `startsWithCaseInsensitiveUTF8` и `endsWithCaseInsensitiveUTF8`. [#87374](https://github.com/ClickHouse/ClickHouse/pull/87374) ([Guang Zhao](https://github.com/zheguang)).
* Добавлен способ задавать определения `WORKLOAD` и `RESOURCE` в SQL с использованием секции конфигурации сервера «resources&#95;and&#95;workloads». [#87430](https://github.com/ClickHouse/ClickHouse/pull/87430) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена новая настройка таблицы `min_level_for_wide_part`, позволяющая указать минимальный уровень части, которая будет создаваться в формате wide-part. [#88179](https://github.com/ClickHouse/ClickHouse/pull/88179) ([Christoph Wurm](https://github.com/cwurm)).
* Добавлены рекурсивные варианты команд `cp`–`cpr` и `mv`–`mvr` в клиенте Keeper. [#88570](https://github.com/ClickHouse/ClickHouse/pull/88570) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Добавлена сессионная настройка для исключения списка пропускающих индексов из материализации при вставках (`exclude_materialize_skip_indexes_on_insert`). Добавлена настройка таблицы MergeTree для исключения списка пропускающих индексов из материализации во время слияний (`exclude_materialize_skip_indexes_on_merge`). [#87252](https://github.com/ClickHouse/ClickHouse/pull/87252) ([George Larionov](https://github.com/george-larionov)).



#### Экспериментальная возможность
* Реализован тип данных `QBit`, который хранит векторы в бит-срезанном формате, и функция `L2DistanceTransposed`, позволяющая выполнять приблизительный векторный поиск с управляемым параметром компромиссом между точностью и скоростью. [#87922](https://github.com/ClickHouse/ClickHouse/pull/87922) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Функции `searchAll` и `searchAny` теперь работают и со столбцами без текстовых данных. В этих случаях используется токенизатор по умолчанию. [#87722](https://github.com/ClickHouse/ClickHouse/pull/87722) ([Jimmy Aguilar Mena](https://github.com/Ergus)).



#### Улучшение производительности

* Реализована репликация лениво вычисляемых столбцов в `JOIN` и `ARRAY JOIN`. Избегается преобразование специального представления столбцов, такого как `Sparse` и `Replicated`, в полные столбцы в некоторых форматах вывода. Это позволяет избежать лишнего копирования данных в памяти. [#88752](https://github.com/ClickHouse/ClickHouse/pull/88752) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена опциональная сериализация подстолбца `.size` для строковых столбцов верхнего уровня в таблицах MergeTree для улучшения сжатия и обеспечения эффективного доступа к подстолбцам. Добавлены новые настройки MergeTree для управления версиями сериализации и оптимизации выражений для пустых строк. [#82850](https://github.com/ClickHouse/ClickHouse/pull/82850) ([Amos Bird](https://github.com/amosbird)).
* Поддержка чтения в заданном порядке для Iceberg. [#88454](https://github.com/ClickHouse/ClickHouse/pull/88454) ([scanhex12](https://github.com/scanhex12)).
* Ускоряет некоторые запросы с `JOIN`, создавая во время выполнения bloom-фильтр из правого поддерева и передавая этот фильтр сканированию в левом поддереве. Это может быть полезно для запросов вида `SELECT avg(o_totalprice) FROM orders, customer, nation WHERE c_custkey = o_custkey AND c_nationkey=n_nationkey AND n_name = 'FRANCE'`. [#84772](https://github.com/ClickHouse/ClickHouse/pull/84772) ([Alexander Gololobov](https://github.com/davenger)).
* Производительность запросов улучшена за счёт изменения порядка и интеграции Query Condition Cache (QCC) с анализом индексов. Фильтрация с помощью QCC теперь применяется до анализа по первичному ключу и skip-индексам, что снижает объём лишних вычислений по индексам. Анализ индексов был расширен для поддержки нескольких диапазонных фильтров, а его результаты фильтрации теперь сохраняются обратно в QCC. Это значительно ускоряет запросы, в которых анализ индексов доминирует во времени выполнения — особенно те, которые зависят от skip-индексов (например, векторных или инвертированных индексов). [#82380](https://github.com/ClickHouse/ClickHouse/pull/82380) ([Amos Bird](https://github.com/amosbird)).
* Набор микрооптимизаций для ускорения малых запросов. [#83096](https://github.com/ClickHouse/ClickHouse/pull/83096) ([Raúl Marín](https://github.com/Algunenano)).
* Сжаты логи и события профилирования в нативном протоколе. На кластерах со 100+ репликами несжатые события профилирования занимают 1–10 МБ/с, а индикатор прогресса работает медленно при медленном интернет-соединении. Это закрывает [#82533](https://github.com/ClickHouse/ClickHouse/issues/82533). [#83586](https://github.com/ClickHouse/ClickHouse/pull/83586) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшена производительность поиска по строкам с учётом регистра (операции вроде фильтрации, например `WHERE URL LIKE '%google%'`) за счёт использования библиотеки [StringZilla](https://github.com/ashvardanian/StringZilla), применяющей SIMD-инструкции CPU при их наличии. [#84161](https://github.com/ClickHouse/ClickHouse/pull/84161) ([Raúl Marín](https://github.com/Algunenano)).
* Снижены затраты на выделение и копирование памяти при выполнении `SELECT ... FINAL` из таблицы типа AggregatingMergeTree, если таблица содержит столбцы типа `SimpleAggregateFunction(anyLast)`. [#84428](https://github.com/ClickHouse/ClickHouse/pull/84428) ([Duc Canh Le](https://github.com/canhld94)).
* Реализует логику проталкивания дизъюнктивных предикатов JOIN. Пример: в TPC-H Q7 для условия над двумя таблицами n1 и n2 вида `(n1.n_name = 'FRANCE' AND n2.n_name = 'GERMANY') OR (n1.n_name = 'GERMANY' AND n2.n_name = 'FRANCE')` мы извлекаем отдельные частичные фильтры для каждой таблицы: `n1.n_name = 'FRANCE' OR n1.n_name = 'GERMANY'` для n1 и `n2.n_name = 'GERMANY' OR n2.n_name = 'FRANCE'` для n2. [#84735](https://github.com/ClickHouse/ClickHouse/pull/84735) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Повышена производительность оператора `LIKE` с префиксным или суффиксным шаблоном за счёт использования нового значения по умолчанию настройки `optimize_rewrite_like_perfect_affix`. [#85920](https://github.com/ClickHouse/ClickHouse/pull/85920) ([Guang Zhao](https://github.com/zheguang)).
* Исправлена деградация производительности, вызванная большим сериализованным ключом при группировке по нескольким строковым и числовым столбцам. Является продолжением [#83884](https://github.com/ClickHouse/ClickHouse/pull/83884). [#85924](https://github.com/ClickHouse/ClickHouse/pull/85924) ([李扬](https://github.com/taiyang-li)).
* Добавлена новая настройка `joined_block_split_single_row` для уменьшения потребления памяти при хеш-соединениях с большим количеством совпадений на ключ. Она позволяет разбивать результаты хеш-соединения на чанки даже внутри совпадений для одной строки левой таблицы, что особенно полезно, когда одна строка из левой таблицы соответствует тысячам или миллионам строк из правой таблицы. Ранее все совпадения должны были материализовываться в памяти одновременно. Это снижает пиковое потребление памяти, но может увеличить загрузку CPU. [#87913](https://github.com/ClickHouse/ClickHouse/pull/87913) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Улучшения SharedMutex (повышена производительность при большом числе параллельных запросов). [#87491](https://github.com/ClickHouse/ClickHouse/pull/87491) ([Raúl Marín](https://github.com/Algunenano)).
* Улучшена производительность построения текстового индекса для документов, содержащих в основном редкие токены. [#87546](https://github.com/ClickHouse/ClickHouse/pull/87546) ([Anton Popov](https://github.com/CurtizJ)).
* Ускорен типовой случай работы деструктора `Field` (повышена производительность при большом количестве небольших запросов). [#87631](https://github.com/ClickHouse/ClickHouse/pull/87631) ([Raúl Marín](https://github.com/Algunenano)).
* Пропускается пересчёт статистики хеш-таблицы во время оптимизации JOIN (повышает производительность всех запросов с JOIN). Добавлены новые profile events `JoinOptimizeMicroseconds` и `QueryPlanOptimizeMicroseconds`. [#87683](https://github.com/ClickHouse/ClickHouse/pull/87683) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Включено сохранение меток в кэше и исключён прямой ввод-вывод для читателя MergeTreeLazy. Это улучшает производительность запросов с ORDER BY и небольшим LIMIT. [#87989](https://github.com/ClickHouse/ClickHouse/pull/87989) ([Nikita Taranov](https://github.com/nickitat)).
* Запрос SELECT с предложением `FINAL` для таблицы `ReplacingMergeTree` со столбцом `is_deleted` теперь выполняется быстрее благодаря улучшенной параллелизации на основе двух существующих оптимизаций: 1. оптимизация `do_not_merge_across_partitions_select_final` для партиций таблицы, которые содержат только один `part`; 2. разбиение остальных выбранных диапазонов таблицы на `intersecting / non-intersecting`, при этом только пересекающиеся диапазоны проходят через преобразование финального (`FINAL`) слияния. [#88090](https://github.com/ClickHouse/ClickHouse/pull/88090) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Снизить влияние отключённых fail points (стандартный путь выполнения кода, когда отладка не активна). [#88196](https://github.com/ClickHouse/ClickHouse/pull/88196) ([Raúl Marín](https://github.com/Algunenano)).
* Избегайте полного сканирования `system.tables` с фильтром по `uuid` (это может быть полезно, если у вас есть только UUID из логов или пути в ZooKeeper). [#88379](https://github.com/ClickHouse/ClickHouse/pull/88379) ([Azat Khuzhin](https://github.com/azat)).
* Повышена производительность функций `tokens`, `hasAllTokens`, `hasAnyTokens`. [#88416](https://github.com/ClickHouse/ClickHouse/pull/88416) ([Anton Popov](https://github.com/CurtizJ)).
* Встроил `AddedColumns::appendFromBlock`, что немного улучшило производительность `JOIN` в некоторых случаях. [#88455](https://github.com/ClickHouse/ClickHouse/pull/88455) ([Nikita Taranov](https://github.com/nickitat)).
* Автодополнение в клиенте работает быстрее и стабильнее при использовании `system.completions` вместо выполнения нескольких запросов к системным таблицам. [#84694](https://github.com/ClickHouse/ClickHouse/pull/84694) ([|2ustam](https://github.com/RuS2m)).
* Добавлен новый параметр текстового индекса `dictionary_block_frontcoding_compression` для управления сжатием словаря. По умолчанию он включён и используется сжатие `front-coding`. [#87175](https://github.com/ClickHouse/ClickHouse/pull/87175) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Перед вставкой в материализованные представления данные из всех потоков теперь объединяются в зависимости от настроек `min_insert_block_size_rows_for_materialized_views` и `min_insert_block_size_bytes_for_materialized_views`. Ранее, если был включен `parallel_view_processing`, каждый поток, выполняющий вставку в конкретное материализованное представление, объединял данные независимо, что могло приводить к большему количеству создаваемых частей. [#87280](https://github.com/ClickHouse/ClickHouse/pull/87280) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена настройка `temporary_files_buffer_size` для управления размером буфера при записи во временные файлы. * Оптимизировано потребление памяти операцией `scatter` (используется, например, в grace hash join) для столбцов `LowCardinality`. [#88237](https://github.com/ClickHouse/ClickHouse/pull/88237) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Добавлена поддержка прямого чтения текстовых индексов с параллельными репликами. Улучшена производительность чтения текстовых индексов из объектного хранилища. [#88262](https://github.com/ClickHouse/ClickHouse/pull/88262) ([Anton Popov](https://github.com/CurtizJ)).
* Запросы к таблицам из каталогов Data Lake будут использовать параллельные реплики для распределённой обработки. [#88273](https://github.com/ClickHouse/ClickHouse/pull/88273) ([scanhex12](https://github.com/scanhex12)).
* Внутренняя эвристика настройки алгоритма фоновых слияний под названием &quot;to&#95;remove&#95;small&#95;parts&#95;at&#95;right&quot; теперь выполняется до вычисления оценки диапазона слияния. Раньше селектор слияний сначала выбирал широкое слияние, а затем отфильтровывал его суффикс. Исправления: [#85374](https://github.com/ClickHouse/ClickHouse/issues/85374). [#88736](https://github.com/ClickHouse/ClickHouse/pull/88736) ([Mikhail Artemenko](https://github.com/Michicosun)).





#### Улучшение

* Теперь функция `generateSerialID` поддерживает неконстантный аргумент с именем серии. Закрывает [#83750](https://github.com/ClickHouse/ClickHouse/issues/83750). [#88270](https://github.com/ClickHouse/ClickHouse/pull/88270) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* В функцию `generateSerialID` добавлен необязательный параметр `start_value`, позволяющий задавать пользовательские начальные значения для новых последовательностей. [#88085](https://github.com/ClickHouse/ClickHouse/pull/88085) ([Manuel](https://github.com/raimannma)).
* Добавлена опция `--semicolons_inline` в `clickhouse-format` для форматирования запросов так, чтобы точки с запятой ставились в последней строке, а не на новой строке. [#88018](https://github.com/ClickHouse/ClickHouse/pull/88018) ([Jan Rada](https://github.com/ZelvaMan)).
* Добавлена возможность настраивать ограничение скорости на уровне сервера, когда конфигурация переопределена в Keeper. Закрывает [#73964](https://github.com/ClickHouse/ClickHouse/issues/73964). [#74066](https://github.com/ClickHouse/ClickHouse/pull/74066) ([JIaQi](https://github.com/JiaQiTang98)).
* `mannWhitneyUTest` больше не выбрасывает исключение, когда обе выборки содержат только одинаковые значения. Теперь возвращает корректный результат, согласующийся с SciPy. Исправляет: [#79814](https://github.com/ClickHouse/ClickHouse/issues/79814). [#80009](https://github.com/ClickHouse/ClickHouse/pull/80009) ([DeanNeaht](https://github.com/DeanNeaht)).
* Транзакция перезаписи (`rewrite`) для объектного хранилища на диске удаляет предыдущие удалённые блобы, если транзакция с метаданными зафиксирована. [#81787](https://github.com/ClickHouse/ClickHouse/pull/81787) ([Sema Checherinda](https://github.com/CheSema)).
* Исправлен этап оптимизации для избыточного выражения равенства, когда `LowCardinality` результирующего типа различается до и после оптимизации. [#82651](https://github.com/ClickHouse/ClickHouse/pull/82651) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Когда HTTP‑клиенты устанавливают заголовок `X-ClickHouse-100-Continue: defer` в дополнение к `Expect: 100-continue`, ClickHouse не отправляет клиенту ответ `100 Continue` до завершения проверки квоты, что предотвращает бесполезную трату сетевой пропускной способности на передачу тел запросов, которые все равно будут отброшены. Это актуально для запросов INSERT, где сам запрос может быть передан в строке параметров URL, а данные — в теле запроса. Прерывание запроса без отправки полного тела не позволяет повторно использовать соединение в HTTP/1.1, но дополнительная задержка, связанная с открытием новых соединений, обычно несущественна по сравнению с общей длительностью INSERT при больших объемах данных. [#84304](https://github.com/ClickHouse/ClickHouse/pull/84304) ([c-end](https://github.com/c-end)).
* Маскировать учетные данные S3 в логах при использовании `DATABASE ENGINE = Backup` с хранилищем S3. [#85336](https://github.com/ClickHouse/ClickHouse/pull/85336) ([Kenny Sun](https://github.com/hwabis)).
* Сделать оптимизации плана запроса доступными для подплана входных данных коррелированного подзапроса за счёт отложенной материализации. Часть [#79890](https://github.com/ClickHouse/ClickHouse/issues/79890). [#85455](https://github.com/ClickHouse/ClickHouse/pull/85455) ([Dmitry Novik](https://github.com/novikd)).
* Изменение для SYSTEM DROP DATABASE REPLICA: - When dropping with database or drop the whole replica: it also drops replica for each table of the database - If &#39;WITH TABLES&#39; is provided, drop replica for each storage - Otherwise, the logic is unchanged, only drop replica on the databases - When dropping a database replica with the keeper path: - If &#39;WITH TABLES&#39; is provided: - Restore the database as Atomic - Restore RMT tables from statement in Keeper - Drop the database (restored tables are also dropped) - Otherwise, only drop replica on the provided keeper path. [#85637](https://github.com/ClickHouse/ClickHouse/pull/85637) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлено несогласованное форматирование TTL, когда он содержит функцию `materialize`. Закрывает [#82828](https://github.com/ClickHouse/ClickHouse/issues/82828). [#85749](https://github.com/ClickHouse/ClickHouse/pull/85749) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Состояние таблицы Iceberg больше не хранится в объекте хранилища. Это должно сделать Iceberg в ClickHouse доступным для использования с конкурентными запросами. [#86062](https://github.com/ClickHouse/ClickHouse/pull/86062) ([Daniil Ivanik](https://github.com/divanik)).
* Сделан постоянным режим блокировки бакета в S3Queue в упорядоченном режиме, аналогично узлам обработки при `use_persistent_processing_nodes = 1`. Добавлена инъекция сбоев Keeper в тестах. [#86628](https://github.com/ClickHouse/ClickHouse/pull/86628) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Показывает подсказки, когда пользователь допускает опечатку в названии формата. Закрывает [#86761](https://github.com/ClickHouse/ClickHouse/issues/86761). [#87092](https://github.com/ClickHouse/ClickHouse/pull/87092) ([flynn](https://github.com/ucasfl)).
* Удалённые реплики будут пропускать анализ индексов, если нет проекций. [#87096](https://github.com/ClickHouse/ClickHouse/pull/87096) ([zoomxi](https://github.com/zoomxi)).
* Добавлена возможность отключать кодировку UTF-8 для таблицы YTsaurus. [#87150](https://github.com/ClickHouse/ClickHouse/pull/87150) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* По умолчанию отключить `s3_slow_all_threads_after_retryable_error`. [#87198](https://github.com/ClickHouse/ClickHouse/pull/87198) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Переименована табличная функция `arrowflight` в `arrowFlight`. [#87249](https://github.com/ClickHouse/ClickHouse/pull/87249) ([Vitaly Baranov](https://github.com/vitlibar)).
* Обновлён `clickhouse-benchmark`, теперь он принимает `-` вместо `_` в своих CLI-флагах. [#87251](https://github.com/ClickHouse/ClickHouse/pull/87251) ([Ahmed Gouda](https://github.com/0xgouda)).
* Сделать сброс в `system.crash_log` при обработке сигналов синхронной операцией. [#87253](https://github.com/ClickHouse/ClickHouse/pull/87253) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Добавлена настройка `inject_random_order_for_select_without_order_by`, которая добавляет `ORDER BY rand()` во внешние запросы `SELECT` без предложения `ORDER BY`. [#87261](https://github.com/ClickHouse/ClickHouse/pull/87261) ([Rui Zhang](https://github.com/zhangruiddn)).
* Улучшено сообщение об ошибке `joinGet`, чтобы оно явно указывало, что количество `join_keys` не совпадает с количеством `right_table_keys`. [#87279](https://github.com/ClickHouse/ClickHouse/pull/87279) ([Isak Ellmer](https://github.com/spinojara)).
* Добавлена возможность проверять `stat` произвольного узла Keeper во время операции записи в транзакцию (`tx`). Это может помочь в обнаружении проблемы ABA. [#87282](https://github.com/ClickHouse/ClickHouse/pull/87282) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Перенаправлять ресурсоёмкие запросы ytsaurus на специализированные прокси. [#87342](https://github.com/ClickHouse/ClickHouse/pull/87342) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Исправляет откаты операций unlink/rename/removeRecursive/removeDirectory/etc, а также счётчики жёстких ссылок при любых возможных типах нагрузок для метаданных из дисковых транзакций и упрощает интерфейсы, делая их более универсальными, чтобы их можно было переиспользовать в других хранилищах метаданных. [#87358](https://github.com/ClickHouse/ClickHouse/pull/87358) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Добавлен параметр конфигурации `keeper_server.tcp_nodelay`, позволяющий отключить `TCP_NODELAY` для Keeper. [#87363](https://github.com/ClickHouse/ClickHouse/pull/87363) (Copilot).
* Поддержка параметра `--connection` в `clickhouse-benchmarks`. Он работает так же, как в `clickhouse-client`: вы можете задать предопределённые подключения в клиентском `config.xml`/`config.yaml` в разделе `connections_credentials`, чтобы не указывать явно пользователя и пароль через аргументы командной строки. Добавлена поддержка параметра `--accept-invalid-certificate` в `clickhouse-benchmark`. [#87370](https://github.com/ClickHouse/ClickHouse/pull/87370) ([Azat Khuzhin](https://github.com/azat)).
* Теперь настройка `max_insert_threads` будет влиять и на таблицы Iceberg. [#87407](https://github.com/ClickHouse/ClickHouse/pull/87407) ([alesapin](https://github.com/alesapin)).
* Добавлены гистограммные и размерные метрики в `PrometheusMetricsWriter`. Таким образом, обработчик `PrometheusRequestHandler` будет иметь все необходимые метрики и сможет использоваться для надежного и малозатратного сбора метрик в облачной среде. [#87521](https://github.com/ClickHouse/ClickHouse/pull/87521) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Функция `hasToken` теперь возвращает ноль совпадений для пустого токена (раньше в этом случае выбрасывалось исключение). [#87564](https://github.com/ClickHouse/ClickHouse/pull/87564) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
* Добавлена поддержка текстовых индексов для значений типов `Array` и `Map` (`mapKeys` и `mapValues`). Поддерживаемые функции: `mapContainsKey` и `has`. [#87602](https://github.com/ClickHouse/ClickHouse/pull/87602) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Добавлена новая метрика `ZooKeeperSessionExpired`, показывающая количество истекших глобальных сессий ZooKeeper. [#87613](https://github.com/ClickHouse/ClickHouse/pull/87613) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Используйте клиент хранилища S3 с отдельными настройками, специфичными для резервного копирования (например, backup&#95;slow&#95;all&#95;threads&#95;after&#95;retryable&#95;s3&#95;error), для серверного (нативного) копирования в целевое хранилище бэкапа. Сделать параметр s3&#95;slow&#95;all&#95;threads&#95;after&#95;retryable&#95;error устаревшим. [#87660](https://github.com/ClickHouse/ClickHouse/pull/87660) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлена некорректная обработка настроек `max_joined_block_size_rows` и `max_joined_block_size_bytes` при сериализации плана запроса с экспериментальной опцией `make_distributed_plan`. [#87675](https://github.com/ClickHouse/ClickHouse/pull/87675) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Настройка `enable_http_compression` теперь включена по умолчанию. Это означает, что если клиент поддерживает HTTP-сжатие, сервер будет его использовать. Однако у этого изменения есть определённые недостатки. Клиент может запросить «тяжёлый» метод сжатия, такой как `bzip2`, что нецелесообразно и увеличит потребление ресурсов сервера (хотя это будет заметно только при передаче больших объёмов результатов). Клиент может запросить `gzip`, что не так уж плохо, но не оптимально по сравнению с `zstd`. Закрывает [#71591](https://github.com/ClickHouse/ClickHouse/issues/71591). [#87703](https://github.com/ClickHouse/ClickHouse/pull/87703) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена новая запись в `system.server_settings` — `keeper_hosts`, отображающая список хостов [Zoo]Keeper, к которым ClickHouse может подключаться. [#87718](https://github.com/ClickHouse/ClickHouse/pull/87718) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлены параметры `from` и `to` в системные дашборды для упрощения исторического анализа. [#87823](https://github.com/ClickHouse/ClickHouse/pull/87823) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Добавлена дополнительная информация для отслеживания производительности в запросах SELECT для Iceberg. [#87903](https://github.com/ClickHouse/ClickHouse/pull/87903) ([Daniil Ivanik](https://github.com/divanik)).
* Улучшение кэша файловой системы: повторное использование итератора приоритетов кэша между потоками, которые одновременно резервируют место в кэше. [#87914](https://github.com/ClickHouse/ClickHouse/pull/87914) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена возможность ограничивать размер запросов для `Keeper` (настройка `max_request_size`, аналогичная `jute.maxbuffer` для `ZooKeeper`, по умолчанию ОТКЛЮЧЕНА для сохранения обратной совместимости, будет включена в следующих релизах). [#87952](https://github.com/ClickHouse/ClickHouse/pull/87952) ([Azat Khuzhin](https://github.com/azat)).
* Сделано так, что `clickhouse-benchmark` по умолчанию не включает трассировки стека в сообщения об ошибках. [#87954](https://github.com/ClickHouse/ClickHouse/pull/87954) ([Ahmed Gouda](https://github.com/0xgouda)).
* Избегайте использования асинхронной загрузки меток через пул потоков (`load_marks_asynchronously=1`), когда метки уже находятся в кеше (так как пул может быть перегружен, и запросы понесут издержки, даже если метки уже находятся в кеше). [#87967](https://github.com/ClickHouse/ClickHouse/pull/87967) ([Azat Khuzhin](https://github.com/azat)).
* Ytsaurus: возможность создавать таблицы/табличные функции/словари с подмножеством столбцов. [#87982](https://github.com/ClickHouse/ClickHouse/pull/87982) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Теперь `system.zookeeper_connection_log` включён по умолчанию, и его можно использовать для получения информации о сессиях Keeper. [#88011](https://github.com/ClickHouse/ClickHouse/pull/88011) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Сделано поведение TCP и HTTP единообразным при передаче дублирующихся внешних таблиц. В HTTP допускается передавать временную таблицу несколько раз. [#88032](https://github.com/ClickHouse/ClickHouse/pull/88032) ([Sema Checherinda](https://github.com/CheSema)).
* Удалены пользовательские `MemoryPools` для чтения Arrow/ORC/Parquet. Этот компонент, по‑видимому, больше не нужен после [#84082](https://github.com/ClickHouse/ClickHouse/pull/84082), поскольку теперь мы в любом случае отслеживаем все выделения памяти. [#88035](https://github.com/ClickHouse/ClickHouse/pull/88035) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлена возможность создавать базу данных `Replicated` без аргументов. [#88044](https://github.com/ClickHouse/ClickHouse/pull/88044) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* `clickhouse-keeper-client`: Добавлена поддержка подключения к TLS-порту clickhouse-keeper; имена флагов сохранены такими же, как в clickhouse-client. [#88065](https://github.com/ClickHouse/ClickHouse/pull/88065) ([Pradeep Chhetri](https://github.com/chhetripradeep)).
* Добавлено новое событие профилирования для отслеживания количества отклонений фоновых слияний из‑за превышения лимитов памяти. [#88084](https://github.com/ClickHouse/ClickHouse/pull/88084) ([Grant Holly](https://github.com/grantholly-clickhouse)).
* Включает анализатор для проверки выражений значений по умолчанию столбцов в операторах CREATE/ALTER TABLE. [#88087](https://github.com/ClickHouse/ClickHouse/pull/88087) ([Max Justus Spransy](https://github.com/maxjustus)).
* Внутреннее улучшение планировщика запросов: использование JoinStepLogical для `CROSS JOIN`. [#88151](https://github.com/ClickHouse/ClickHouse/pull/88151) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Добавлены псевдонимы для функций `hasAnyTokens` (`hasAnyToken`) и `hasAllTokens` (`hasAllToken`). [#88162](https://github.com/ClickHouse/ClickHouse/pull/88162) ([George Larionov](https://github.com/george-larionov)).
* По умолчанию включён глобальный сэмплирующий профилировщик (то есть даже для серверных потоков, не связанных с запросами): собираются stacktrace всех потоков каждые 10 секунд процессорного и реального времени. [#88209](https://github.com/ClickHouse/ClickHouse/pull/88209) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Обновлён Azure SDK, чтобы включить исправление `Content-Length`, затрагивающее операции копирования и создания контейнера. [#88278](https://github.com/ClickHouse/ClickHouse/pull/88278) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Функция `lag` сделана регистронезависимой для совместимости с MySQL. [#88322](https://github.com/ClickHouse/ClickHouse/pull/88322) ([Lonny Kapelushnik](https://github.com/lonnylot)).
* Разрешен запуск `clickhouse-local` из каталога `clickhouse-server`. В предыдущих версиях это приводило к ошибке `Cannot parse UUID: .`. Теперь вы можете запускать clickhouse-local и работать с базами данных сервера, не поднимая сам сервер. [#88383](https://github.com/ClickHouse/ClickHouse/pull/88383) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена настройка `keeper_server.coordination_settings.check_node_acl_on_remove`. Если она включена, перед каждым удалением узла будут проверяться ACL как самого узла, так и его родительского узла. В противном случае будет проверяться только ACL родительского узла. [#88513](https://github.com/ClickHouse/ClickHouse/pull/88513) ([Antonio Andelic](https://github.com/antonio2368)).
* Столбцы `JSON` теперь выводятся в удобочитаемом формате при использовании формата `Vertical`. Закрывает [#81794](https://github.com/ClickHouse/ClickHouse/issues/81794). [#88524](https://github.com/ClickHouse/ClickHouse/pull/88524) ([Frank Rosner](https://github.com/FRosner)).
* Хранить файлы `clickhouse-client` (например, историю запросов) в местах, определённых спецификацией [XDG Base Directories](https://specifications.freedesktop.org/basedir-spec/latest/index.html), а не в корне домашнего каталога. `~/.clickhouse-client-history` по-прежнему будет использоваться, если он уже существует. [#88538](https://github.com/ClickHouse/ClickHouse/pull/88538) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлена утечка памяти при использовании `GLOBAL IN` ([https://github.com/ClickHouse/ClickHouse/issues/88615](https://github.com/ClickHouse/ClickHouse/issues/88615)). [#88617](https://github.com/ClickHouse/ClickHouse/pull/88617) ([pranavmehta94](https://github.com/pranavmehta94)).
* Добавлена перегрузка hasAny/hasAllTokens, принимающая строковый аргумент. [#88679](https://github.com/ClickHouse/ClickHouse/pull/88679) ([George Larionov](https://github.com/george-larionov)).
* Добавлен шаг в postinstall-скрипт для `clickhouse-keeper`, который включает автозапуск при загрузке системы. [#88746](https://github.com/ClickHouse/ClickHouse/pull/88746) ([YenchangChan](https://github.com/YenchangChan)).
* Проверка учетных данных в Web UI теперь выполняется только при вставке, а не при каждом нажатии клавиши. Это позволяет избежать проблемы с некорректно настроенными серверами LDAP. Исправляет [#85777](https://github.com/ClickHouse/ClickHouse/issues/85777). [#88769](https://github.com/ClickHouse/ClickHouse/pull/88769) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Ограничена длина сообщения об исключении при нарушении ограничения. В предыдущих версиях можно было получить очень длинное сообщение об исключении при вставке очень длинной строки, и оно в итоге записывалось в `query_log`. Закрывает [#87032](https://github.com/ClickHouse/ClickHouse/issues/87032). [#88801](https://github.com/ClickHouse/ClickHouse/pull/88801) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено получение структуры набора данных с сервера ArrowFlight при создании таблицы. [#87542](https://github.com/ClickHouse/ClickHouse/pull/87542) ([Vitaly Baranov](https://github.com/vitlibar)).





#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе)

* Исправлена проблема с GeoParquet, приводившая к ошибкам клиентского протокола. [#84020](https://github.com/ClickHouse/ClickHouse/pull/84020) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлено вычисление зависящих от хоста функций, таких как shardNum(), в подзапросах на инициаторе. [#84409](https://github.com/ClickHouse/ClickHouse/pull/84409) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлена некорректная обработка дат до эпохи с дробными секундами в различных функциях, связанных с датой и временем, таких как `parseDateTime64BestEffort`, `change{Year,Month,Day}` и `makeDateTime64`. Ранее дробная часть секунды вычиталась из количества секунд вместо прибавления. Например, `parseDateTime64BestEffort('1969-01-01 00:00:00.468')` возвращала `1968-12-31 23:59:59.532` вместо `1969-01-01 00:00:00.468`. [#85396](https://github.com/ClickHouse/ClickHouse/pull/85396) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Исправлены ошибки выполнения команд `ALTER COLUMN IF EXISTS`, возникавшие при изменении состояния столбца в рамках одного и того же оператора `ALTER`. Команды `DROP COLUMN IF EXISTS`, `MODIFY COLUMN IF EXISTS`, `COMMENT COLUMN IF EXISTS` и `RENAME COLUMN IF EXISTS` теперь корректно обрабатывают случаи, когда столбец был удалён предыдущей командой в том же операторе. [#86046](https://github.com/ClickHouse/ClickHouse/pull/86046) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Исправлено определение типов Date/DateTime/DateTime64 для дат, выходящих за пределы поддерживаемого диапазона. [#86184](https://github.com/ClickHouse/ClickHouse/pull/86184) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен сбой, при котором некоторые корректные данные, отправленные пользователем в столбец `AggregateFunction(quantileDD)`, могли приводить к бесконечной рекурсии при слияниях. [#86560](https://github.com/ClickHouse/ClickHouse/pull/86560) ([Raphaël Thériault](https://github.com/raphael-theriault-swi)).
* Поддержка типов JSON/Dynamic в таблицах, создаваемых с помощью табличной функции `cluster`. [#86821](https://github.com/ClickHouse/ClickHouse/pull/86821) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена недетерминированность результата функции, вычисляемой в CTE-запросе. [#86967](https://github.com/ClickHouse/ClickHouse/pull/86967) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена ошибка LOGICAL&#95;ERROR в EXPLAIN при использовании pointInPolygon со столбцами первичного ключа. [#86971](https://github.com/ClickHouse/ClickHouse/pull/86971) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлены таблицы в дата‑лейке с процентно кодированной последовательностью в имени. Закрывает [#86626](https://github.com/ClickHouse/ClickHouse/issues/86626). [#87020](https://github.com/ClickHouse/ClickHouse/pull/87020) ([Anton Ivashkin](https://github.com/ianton-ru)).
* Исправлено некорректное поведение `IS NULL` для nullable-столбцов в `OUTER JOIN` при использовании `optimize_functions_to_subcolumns`, закрыта [#78625](https://github.com/ClickHouse/ClickHouse/issues/78625). [#87058](https://github.com/ClickHouse/ClickHouse/pull/87058) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлен некорректный учёт освобождения временных данных при отслеживании лимита `max_temporary_data_on_disk_size`, закрыта задача [#87118](https://github.com/ClickHouse/ClickHouse/issues/87118). [#87140](https://github.com/ClickHouse/ClickHouse/pull/87140) ([JIaQi](https://github.com/JiaQiTang98)).
* Функция checkHeaders теперь корректно проверяет переданные заголовки и отклоняет недопустимые заголовки. Автор оригинального изменения: Michael Anastasakis (@michael-anastasakis). [#87172](https://github.com/ClickHouse/ClickHouse/pull/87172) ([Raúl Marín](https://github.com/Algunenano)).
* Делает поведение функций `toDate` и `toDate32` одинаковым для всех числовых типов. Исправляет проверку на выход за нижнюю границу (`underflow`) для `Date32` при приведении типа из `int16`. [#87176](https://github.com/ClickHouse/ClickHouse/pull/87176) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлена логическая ошибка при использовании parallel replicas в запросах с несколькими JOIN, в частности с RIGHT JOIN после LEFT/INNER JOIN. [#87178](https://github.com/ClickHouse/ClickHouse/pull/87178) ([Igor Nikonov](https://github.com/devcrafter)).
* Учтена настройка `input_format_try_infer_variants` в кэше вывода схемы. [#87180](https://github.com/ClickHouse/ClickHouse/pull/87180) ([Pavel Kruglov](https://github.com/Avogar)).
* Сделать так, чтобы `pathStartsWith` сопоставлял только пути с указанным префиксом. [#87181](https://github.com/ClickHouse/ClickHouse/pull/87181) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлены логические ошибки в виртуальном столбце `_row_number` и при позиционных удалениях в Iceberg. [#87220](https://github.com/ClickHouse/ClickHouse/pull/87220) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена ошибка `LOGICAL_ERROR` «Too large size passed to allocator» в `JOIN`, возникавшая из-за смешения константных и неконстантных блоков. [#87231](https://github.com/ClickHouse/ClickHouse/pull/87231) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены легковесные обновления с подзапросами, которые читают из других таблиц `MergeTree`. [#87285](https://github.com/ClickHouse/ClickHouse/pull/87285) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена оптимизация move-to-prewhere, которая не работала при наличии политик строк. Продолжение [#85118](https://github.com/ClickHouse/ClickHouse/issues/85118). Закрывает [#69777](https://github.com/ClickHouse/ClickHouse/issues/69777). Закрывает [#83748](https://github.com/ClickHouse/ClickHouse/issues/83748). [#87303](https://github.com/ClickHouse/ClickHouse/pull/87303) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено применение патчей к столбцам с выражением по умолчанию, которые отсутствуют в партициях данных. [#87347](https://github.com/ClickHouse/ClickHouse/pull/87347) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка сегментации при использовании повторяющихся имён полей партиций в таблицах MergeTree. [#87365](https://github.com/ClickHouse/ClickHouse/pull/87365) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Исправлена процедура обновления EmbeddedRocksDB. [#87392](https://github.com/ClickHouse/ClickHouse/pull/87392) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено прямое чтение текстового индекса из объектного хранилища. [#87399](https://github.com/ClickHouse/ClickHouse/pull/87399) ([Anton Popov](https://github.com/CurtizJ)).
* Предотвращено создание привилегии для несуществующего движка. [#87419](https://github.com/ClickHouse/ClickHouse/pull/87419) ([Jitendra](https://github.com/jitendra1411)).
* Игнорировать только ошибки `not found` для `s3_plain_rewritable` (что может привести к самым разным проблемам). [#87426](https://github.com/ClickHouse/ClickHouse/pull/87426) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены словари с источником YTSaurus и макетами *range&#95;hashed. [#87490](https://github.com/ClickHouse/ClickHouse/pull/87490) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Исправлена ошибка при создании массива пустых кортежей. [#87520](https://github.com/ClickHouse/ClickHouse/pull/87520) ([Pavel Kruglov](https://github.com/Avogar)).
* Проверка наличия недопустимых столбцов при создании временной таблицы. [#87524](https://github.com/ClickHouse/ClickHouse/pull/87524) ([Pavel Kruglov](https://github.com/Avogar)).
* Никогда не помещайте секционные столбцы Hive в заголовок формата. Исправление [#87515](https://github.com/ClickHouse/ClickHouse/issues/87515). [#87528](https://github.com/ClickHouse/ClickHouse/pull/87528) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлена подготовка чтения из формата в DeltaLake при использовании текстового формата. [#87529](https://github.com/ClickHouse/ClickHouse/pull/87529) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена проверка прав доступа на `SELECT` и `INSERT` для таблиц `Buffer`. [#87545](https://github.com/ClickHouse/ClickHouse/pull/87545) ([pufit](https://github.com/pufit)).
* Запрещено создавать индекс пропуска данных для таблицы S3. [#87554](https://github.com/ClickHouse/ClickHouse/pull/87554) ([Bharat Nallan](https://github.com/bharatnc)).
* Избежана утечка отслеживаемой памяти при async logging (может приводить к значительному смещению, за 10 часов — примерно на 100 GiB) и text&#95;log (возможен почти такой же дрейф). [#87584](https://github.com/ClickHouse/ClickHouse/pull/87584) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, из-за которой глобальные настройки сервера могли переопределяться настройками `SELECT` представления или материализованного представления, если это представление было удалено асинхронно, а сервер был перезапущен до завершения фоновой очистки. [#87603](https://github.com/ClickHouse/ClickHouse/pull/87603) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исключать байты кэша страниц в пользовательском пространстве (если возможно) при вычислении предупреждения о превышении объёма памяти. [#87610](https://github.com/ClickHouse/ClickHouse/pull/87610) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлена ошибка, при которой неверный порядок типов при десериализации CSV приводил к `LOGICAL_ERROR`. [#87622](https://github.com/ClickHouse/ClickHouse/pull/87622) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена некорректная обработка `command_read_timeout` для исполняемых словарей. [#87627](https://github.com/ClickHouse/ClickHouse/pull/87627) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено некорректное поведение `SELECT * REPLACE` в секции `WHERE` с новым анализатором при фильтрации по заменённым столбцам. [#87630](https://github.com/ClickHouse/ClickHouse/pull/87630) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Исправлена двухуровневая агрегация при использовании `Merge` над `Distributed`. [#87687](https://github.com/ClickHouse/ClickHouse/pull/87687) ([c-end](https://github.com/c-end)).
* Исправлена генерация выходного блока в алгоритме `HashJoin`, когда список строк правой таблицы не используется. Исправление [#87401](https://github.com/ClickHouse/ClickHouse/issues/87401). [#87699](https://github.com/ClickHouse/ClickHouse/pull/87699) ([Dmitry Novik](https://github.com/novikd)).
* Режим чтения параллельных реплик мог быть выбран неправильно, если после анализа индексов не оставалось данных для чтения. Закрывает [#87653](https://github.com/ClickHouse/ClickHouse/issues/87653). [#87700](https://github.com/ClickHouse/ClickHouse/pull/87700) ([zoomxi](https://github.com/zoomxi)).
* Исправлена обработка столбцов типов `timestamp` / `timestamptz` в Glue. [#87733](https://github.com/ClickHouse/ClickHouse/pull/87733) ([Andrey Zvonov](https://github.com/zvonand)).
* Это закрывает задачу [#86587](https://github.com/ClickHouse/ClickHouse/issues/86587). [#87761](https://github.com/ClickHouse/ClickHouse/pull/87761) ([scanhex12](https://github.com/scanhex12)).
* Исправлена запись логических значений в интерфейсе PostgreSQL. [#87762](https://github.com/ClickHouse/ClickHouse/pull/87762) ([Artem Yurov](https://github.com/ArtemYurov)).
* Исправлена ошибка «unknown table» в запросе `INSERT ... SELECT` с CTE, [#85368](https://github.com/ClickHouse/ClickHouse/issues/85368). [#87789](https://github.com/ClickHouse/ClickHouse/pull/87789) ([Guang Zhao](https://github.com/zheguang)).
* Исправлено чтение подстолбца null map из `Variant`, который не может находиться внутри `Nullable`. [#87798](https://github.com/ClickHouse/ClickHouse/pull/87798) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена обработка ошибки при неполном удалении базы данных в кластере на вторичном узле. [#87802](https://github.com/ClickHouse/ClickHouse/pull/87802) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлены несколько ошибок в пропускающих индексах. [#87817](https://github.com/ClickHouse/ClickHouse/pull/87817) ([Raúl Marín](https://github.com/Algunenano)).
* В AzureBlobStorage обновлено поведение: сначала выполняется попытка нативного копирования, а при ошибке &#39;Unauthorized&#39; происходит переход к чтению и записи (в AzureBlobStorage, если учетные записи хранилища для источника и назначения различаются, возникает ошибка &#39;Unauthorized&#39;). Также исправлено применение параметра &quot;use&#95;native&#95;copy&quot;, когда endpoint задан в конфигурации. [#87826](https://github.com/ClickHouse/ClickHouse/pull/87826) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* ClickHouse аварийно завершался, если файл ArrowStream содержал неуникальный словарь. [#87863](https://github.com/ClickHouse/ClickHouse/pull/87863) ([Ilya Golshtein](https://github.com/ilejn)).
* Исправлена критическая ошибка при использовании approx&#95;top&#95;k и finalizeAggregation. [#87892](https://github.com/ClickHouse/ClickHouse/pull/87892) ([Jitendra](https://github.com/jitendra1411)).
* Исправлено слияние с проекциями, когда последний блок пуст. [#87928](https://github.com/ClickHouse/ClickHouse/pull/87928) ([Raúl Marín](https://github.com/Algunenano)).
* Не удаляйте инъективные функции из GROUP BY, если типы их аргументов не допускаются в GROUP BY. [#87958](https://github.com/ClickHouse/ClickHouse/pull/87958) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправление некорректного отсечения гранул/партиций для ключей на основе datetime при использовании настройки `session_timezone` в запросах. [#87987](https://github.com/ClickHouse/ClickHouse/pull/87987) ([Eduard Karacharov](https://github.com/korowa)).
* Возвращает количество затронутых строк после выполнения запроса в интерфейсе PostgreSQL. [#87990](https://github.com/ClickHouse/ClickHouse/pull/87990) ([Artem Yurov](https://github.com/ArtemYurov)).
* Ограничено использование `filter pushdown` для `PASTE JOIN`, так как это может приводить к некорректным результатам. [#88078](https://github.com/ClickHouse/ClickHouse/pull/88078) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Применяет нормализацию URI перед выполнением проверки прав, добавленной в [https://github.com/ClickHouse/ClickHouse/pull/84503](https://github.com/ClickHouse/ClickHouse/pull/84503). [#88089](https://github.com/ClickHouse/ClickHouse/pull/88089) ([pufit](https://github.com/pufit)).
* Исправлена логическая ошибка, возникавшая, когда `ARRAY JOIN COLUMNS()` не соответствовал ни одному столбцу в новом анализаторе. [#88091](https://github.com/ClickHouse/ClickHouse/pull/88091) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Исправлено предупреждение «High ClickHouse memory usage» (без учёта кэша страниц). [#88092](https://github.com/ClickHouse/ClickHouse/pull/88092) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена возможная порча данных в таблицах `MergeTree` с настроенным столбцовым `TTL`. [#88095](https://github.com/ClickHouse/ClickHouse/pull/88095) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена возможная необработанная ошибка при чтении `system.tables` при наличии некорректных таблиц во внешних базах данных (`PostgreSQL`/`SQLite`/...), подключённых к системе. [#88105](https://github.com/ClickHouse/ClickHouse/pull/88105) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен сбой в функциях `mortonEncode` и `hilbertEncode` при вызове с пустым кортежем в качестве аргумента. [#88110](https://github.com/ClickHouse/ClickHouse/pull/88110) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Теперь запросы с `ON CLUSTER` будут выполняться быстрее при наличии неактивных реплик в кластере. [#88153](https://github.com/ClickHouse/ClickHouse/pull/88153) ([alesapin](https://github.com/alesapin)).
* Теперь DDL worker удаляет устаревшие хосты из набора реплик. Это уменьшит объём хранимых метаданных в ZooKeeper. [#88154](https://github.com/ClickHouse/ClickHouse/pull/88154) ([alesapin](https://github.com/alesapin)).
* Исправлена работа ClickHouse без cgroups (cgroups по ошибке стали обязательными для асинхронных метрик). [#88164](https://github.com/ClickHouse/ClickHouse/pull/88164) ([Azat Khuzhin](https://github.com/azat)).
* Выполнить корректный откат операции перемещения директории в случае ошибки. Необходимо перезаписывать все объекты `prefix.path`, изменённые во время выполнения, а не только корневой. [#88198](https://github.com/ClickHouse/ClickHouse/pull/88198) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Исправлено распространение флага `is_shared` в `ColumnLowCardinality`. Это могло приводить к неверному результату операции GROUP BY, если в столбец вставлялось новое значение после того, как хеш-значения уже были предварительно вычислены и закэшированы в `ReverseIndex`. [#88213](https://github.com/ClickHouse/ClickHouse/pull/88213) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена настройка рабочей нагрузки `max_cpu_share`. Теперь её можно использовать без предварительной настройки `max_cpus`. [#88217](https://github.com/ClickHouse/ClickHouse/pull/88217) ([Neerav](https://github.com/neeravsalaria)).
* Исправлена ошибка, из-за которой очень тяжёлые мутации с подзапросами могли застревать на стадии подготовки. Теперь такие мутации можно остановить с помощью `SYSTEM STOP MERGES`. [#88241](https://github.com/ClickHouse/ClickHouse/pull/88241) ([alesapin](https://github.com/alesapin)).
* Теперь коррелированные подзапросы работают с объектными хранилищами. [#88290](https://github.com/ClickHouse/ClickHouse/pull/88290) ([alesapin](https://github.com/alesapin)).
* Избегайте инициализации баз данных DataLake при обращении к `system.projections` и `system.data_skipping_indices`. [#88330](https://github.com/ClickHouse/ClickHouse/pull/88330) ([Azat Khuzhin](https://github.com/azat)).
* Теперь каталоги даталейков будут отображаться в системных таблицах интроспекции только в том случае, если параметр `show_data_lake_catalogs_in_system_tables` явно включён. [#88341](https://github.com/ClickHouse/ClickHouse/pull/88341) ([alesapin](https://github.com/alesapin)).
* DatabaseReplicated исправлен так, чтобы учитывать конфигурацию `interserver_http_host`. [#88378](https://github.com/ClickHouse/ClickHouse/pull/88378) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Позиционные аргументы теперь явно запрещены в контексте определения `Projections`, поскольку они не имеют смысла на этом внутреннем этапе обработки запроса. Это исправляет [#48604](https://github.com/ClickHouse/ClickHouse/issues/48604). [#88380](https://github.com/ClickHouse/ClickHouse/pull/88380) ([Amos Bird](https://github.com/amosbird)).
* Исправлена квадратичная сложность в функции `countMatches`. Закрывает [#88400](https://github.com/ClickHouse/ClickHouse/issues/88400). [#88401](https://github.com/ClickHouse/ClickHouse/pull/88401) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Команды `ALTER COLUMN ... COMMENT` для таблиц KeeperMap сделаны реплицируемыми, чтобы они фиксировались в метаданных реплицируемой базы данных и распространялись на все реплики. Закрывает [#88077](https://github.com/ClickHouse/ClickHouse/issues/88077). [#88408](https://github.com/ClickHouse/ClickHouse/pull/88408) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлен случай ложной циклической зависимости с материализованными представлениями в базе данных `Replicated`, который не позволял добавлять в неё новые реплики. [#88423](https://github.com/ClickHouse/ClickHouse/pull/88423) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена агрегация разреженных столбцов при `group_by_overflow_mode = 'any'`. [#88440](https://github.com/ClickHouse/ClickHouse/pull/88440) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлена ошибка «column not found» при использовании `query_plan_use_logical_join_step=0` с несколькими операторами FULL JOIN USING. Закрывает [#88103](https://github.com/ClickHouse/ClickHouse/issues/88103). [#88473](https://github.com/ClickHouse/ClickHouse/pull/88473) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Большие кластеры с числом узлов &gt; 10 имеют высокую вероятность сбоя восстановления с ошибкой `[941] 67c45db4-4df4-4879-87c5-25b8d1e0d414 &lt;Trace&gt;: RestoreCoordinationOnCluster The version of node /clickhouse/backups/restore-7c551a77-bd76-404c-bad0-3213618ac58e/stage/num_hosts changed (attempt #9), will try again`. Узел `num_hosts` перезаписывается множеством хостов одновременно. Исправление делает настройку, контролирующую число попыток, динамической. Закрывает [#87721](https://github.com/ClickHouse/ClickHouse/issues/87721). [#88484](https://github.com/ClickHouse/ClickHouse/pull/88484) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Этот PR предназначен только для обеспечения совместимости с версией 23.8 и более ранними. Проблема совместимости была внесена этим PR: [https://github.com/ClickHouse/ClickHouse/pull/54240](https://github.com/ClickHouse/ClickHouse/pull/54240) Этот SQL-запрос завершится с ошибкой при `enable_analyzer=0` (до 23.8 он выполнялся нормально). [#88491](https://github.com/ClickHouse/ClickHouse/pull/88491) ([JIaQi](https://github.com/JiaQiTang98)).
* Исправлено переполнение целого числа, выявляемое UBSAN, в сообщении об ошибке `accurateCast` при приведении больших значений к DateTime. [#88520](https://github.com/ClickHouse/ClickHouse/pull/88520) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Исправлен `coalescing merge tree` для типов `tuple`. Это закрывает [#88469](https://github.com/ClickHouse/ClickHouse/issues/88469). [#88526](https://github.com/ClickHouse/ClickHouse/pull/88526) ([scanhex12](https://github.com/scanhex12)).
* Запрещены операции удаления для `iceberg_format_version=1`. Исправляет [#88444](https://github.com/ClickHouse/ClickHouse/issues/88444). [#88532](https://github.com/ClickHouse/ClickHouse/pull/88532) ([scanhex12](https://github.com/scanhex12)).
* Этот патч исправляет операцию перемещения дисков `plain-rewritable` для каталогов произвольной глубины. [#88586](https://github.com/ClickHouse/ClickHouse/pull/88586) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Исправлена работа `SQL SECURITY DEFINER` с функциями `*cluster`. [#88588](https://github.com/ClickHouse/ClickHouse/pull/88588) ([Julian Maicher](https://github.com/jmaicher)).
* Исправлена потенциальная ошибка, приводившая к сбою при одновременной мутации базовых константных столбцов PREWHERE. [#88605](https://github.com/ClickHouse/ClickHouse/pull/88605) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено чтение из текстового индекса и включён кэш условий запроса (при включённых настройках `use_skip_indexes_on_data_read` и `use_query_condition_cache`). [#88660](https://github.com/ClickHouse/ClickHouse/pull/88660) ([Anton Popov](https://github.com/CurtizJ)).
* Исключение `Poco::TimeoutException`, выбрасываемое из `Poco::Net::HTTPChunkedStreamBuf::readFromDevice`, приводит к аварийному завершению с SIGABRT. [#88668](https://github.com/ClickHouse/ClickHouse/pull/88668) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Бэкпортировано в [#88910](https://github.com/ClickHouse/ClickHouse/issues/88910): после восстановления реплика базы данных с движком `Replicated` могла надолго зависать, выводя сообщения вида `Failed to marked query-0004647339 as finished (finished=No node, synced=No node)`, теперь это исправлено. [#88671](https://github.com/ClickHouse/ClickHouse/pull/88671) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлено добавление записей в `system.zookeeper_connection_log` в случае, когда ClickHouse подключается впервые после перезагрузки конфигурации. [#88728](https://github.com/ClickHouse/ClickHouse/pull/88728) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка, из-за которой преобразование DateTime64 в Date при `date_time_overflow_behavior = 'saturate'` могло приводить к некорректным результатам для значений вне диапазона в условиях использования часовых поясов. [#88737](https://github.com/ClickHouse/ClickHouse/pull/88737) ([Manuel](https://github.com/raimannma)).
* Очередная (N-я) попытка исправить ошибку «having zero bytes» в движке таблиц `s3` при включённом кэше. [#88740](https://github.com/ClickHouse/ClickHouse/pull/88740) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проверка прав доступа при выполнении запроса `SELECT` для табличной функции `loop`. [#88802](https://github.com/ClickHouse/ClickHouse/pull/88802) ([pufit](https://github.com/pufit)).
* Обрабатывайте исключения при сбоях асинхронного логирования, чтобы предотвратить аварийное завершение работы программы. [#88814](https://github.com/ClickHouse/ClickHouse/pull/88814) ([Raúl Marín](https://github.com/Algunenano)).
* Бэкпортировано в [#89060](https://github.com/ClickHouse/ClickHouse/issues/89060): исправлен `top_k`, чтобы учитывать параметр threshold при вызове с одним аргументом. Закрывает [#88757](https://github.com/ClickHouse/ClickHouse/issues/88757). [#88867](https://github.com/ClickHouse/ClickHouse/pull/88867) ([Manuel](https://github.com/raimannma)).
* Бэкпортировано в [#88944](https://github.com/ClickHouse/ClickHouse/issues/88944): исправлена ошибка в функции `reverseUTF8`. В предыдущих версиях по ошибке переворачивались байты UTF-8 кодовых точек длиной 4. Это закрывает [#88913](https://github.com/ClickHouse/ClickHouse/issues/88913). [#88914](https://github.com/ClickHouse/ClickHouse/pull/88914) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Бэкпортировано в [#88980](https://github.com/ClickHouse/ClickHouse/issues/88980): не проверять права доступа `SET DEFINER <current_user>:definer` при создании представления с SQL SECURITY DEFINER. [#88968](https://github.com/ClickHouse/ClickHouse/pull/88968) ([pufit](https://github.com/pufit)).
* Бэкпортировано в [#89058](https://github.com/ClickHouse/ClickHouse/issues/89058): исправлена ошибка `LOGICAL_ERROR` в `L2DistanceTransposed(vec1, vec2, p)`, из-за которой оптимизация частичного чтения `QBit` некорректно удаляла `Nullable` из возвращаемого типа, когда `p` был `Nullable`. [#88974](https://github.com/ClickHouse/ClickHouse/pull/88974) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Бэкпортировано в [#89167](https://github.com/ClickHouse/ClickHouse/issues/89167): исправлен сбой при неизвестном типе каталога. Исправляет [#88819](https://github.com/ClickHouse/ClickHouse/issues/88819). [#88987](https://github.com/ClickHouse/ClickHouse/pull/88987) ([scanhex12](https://github.com/scanhex12)).
* Бэкпортировано в [#89028](https://github.com/ClickHouse/ClickHouse/issues/89028): исправлено снижение производительности при анализе пропускающих индексов. [#89004](https://github.com/ClickHouse/ClickHouse/pull/89004) ([Anton Popov](https://github.com/CurtizJ)).

#### Улучшения сборки/тестирования/упаковки

- Использование библиотеки `postgres` версии 18.0. [#87647](https://github.com/ClickHouse/ClickHouse/pull/87647) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Включена поддержка ICU для FreeBSD. [#87891](https://github.com/ClickHouse/ClickHouse/pull/87891) ([Raúl Marín](https://github.com/Algunenano)).
- Использование SSE 4.2 при динамической диспетчеризации на SSE 4.2, а не на SSE 4. [#88029](https://github.com/ClickHouse/ClickHouse/pull/88029) ([Raúl Marín](https://github.com/Algunenano)).
- Флаг `NO_ARMV81_OR_HIGHER` больше не требуется, если `Speculative Store Bypass Safe` недоступен. [#88051](https://github.com/ClickHouse/ClickHouse/pull/88051) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Когда ClickHouse собран с `ENABLE_LIBFIU=OFF`, функции, связанные с точками отказа, становятся пустыми операциями и больше не влияют на производительность. В этом случае запросы `SYSTEM ENABLE/DISABLE FAILPOINT` возвращают ошибку `SUPPORT_IS_DISABLED`. [#88184](https://github.com/ClickHouse/ClickHouse/pull/88184) ([c-end](https://github.com/c-end)).

### Релиз ClickHouse 25.9, 2025-09-25 {#259}

#### Обратно несовместимые изменения

- Отключены бессмысленные бинарные операции с IPv4/IPv6: сложение/вычитание IPv4/IPv6 с нецелочисленным типом теперь запрещено. Ранее допускались операции с типами с плавающей точкой и возникали логические ошибки с некоторыми другими типами (например, DateTime). [#86336](https://github.com/ClickHouse/ClickHouse/pull/86336) ([Raúl Marín](https://github.com/Algunenano)).
- Настройка `allow_dynamic_metadata_for_data_lakes` объявлена устаревшей. Теперь все таблицы Iceberg пытаются получить актуальную схему таблицы из хранилища перед выполнением каждого запроса. [#86366](https://github.com/ClickHouse/ClickHouse/pull/86366) ([Daniil Ivanik](https://github.com/divanik)).
- Изменено разрешение объединённого столбца из конструкции `OUTER JOIN ... USING` для большей согласованности: ранее при выборе как столбца USING, так и квалифицированных столбцов (`a, t1.a, t2.a`) в OUTER JOIN столбец USING неправильно разрешался в `t1.a`, показывая 0/NULL для строк из правой таблицы без совпадения слева. Теперь идентификаторы из конструкции USING всегда разрешаются в объединённый столбец, в то время как квалифицированные идентификаторы разрешаются в необъединённые столбцы, независимо от того, какие другие идентификаторы присутствуют в запросе. Например: ```sql SELECT a, t1.a, t2.a FROM (SELECT 1 as a WHERE 0) t1 FULL JOIN (SELECT 2 as a) t2 USING (a) -- Раньше: a=0, t1.a=0, t2.a=2 (неправильно — 'a' разрешается в t1.a) -- Теперь: a=2, t1.a=0, t2.a=2 (правильно — 'a' объединён). [#80848](https://github.com/ClickHouse/ClickHouse/pull/80848) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Увеличено окно репликационной дедупликации до 10000. Это полностью совместимое изменение, но можно представить сценарии, когда оно может привести к высокому потреблению ресурсов при наличии большого количества таблиц. [#86820](https://github.com/ClickHouse/ClickHouse/pull/86820) ([Sema Checherinda](https://github.com/CheSema)).


#### Новая функция

* Теперь пользователи могут использовать NATS JetStream для чтения сообщений, задавая новые настройки `nats_stream` и `nats_consumer` для движка NATS. [#84799](https://github.com/ClickHouse/ClickHouse/pull/84799) ([Dmitry Novikov](https://github.com/dmitry-sles-novikov)).
* Добавлена поддержка аутентификации и SSL в табличной функции `arrowFlight`. [#87120](https://github.com/ClickHouse/ClickHouse/pull/87120) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлен новый параметр `storage_class_name` для движка таблиц `S3` и табличной функции `s3`, который позволяет указывать intelligent tiering, поддерживаемый AWS. Параметр поддерживается как в формате ключ-значение, так и в позиционном (устаревшем) формате. [#87122](https://github.com/ClickHouse/ClickHouse/pull/87122) ([alesapin](https://github.com/alesapin)).
* `ALTER UPDATE` для движка таблицы Iceberg. [#86059](https://github.com/ClickHouse/ClickHouse/pull/86059) ([scanhex12](https://github.com/scanhex12)).
* Добавлена системная таблица `iceberg_metadata_log` для получения файлов метаданных Iceberg во время выполнения операторов SELECT. [#86152](https://github.com/ClickHouse/ClickHouse/pull/86152) ([scanhex12](https://github.com/scanhex12)).
* Таблицы `Iceberg` и `DeltaLake` поддерживают настраиваемую конфигурацию диска с помощью настройки уровня хранения `disk`. [#86778](https://github.com/ClickHouse/ClickHouse/pull/86778) ([scanhex12](https://github.com/scanhex12)).
* Добавлена поддержка Azure для дисков data lake. [#87173](https://github.com/ClickHouse/ClickHouse/pull/87173) ([scanhex12](https://github.com/scanhex12)).
* Реализована поддержка каталога `Unity` поверх хранилища Azure Blob. [#80013](https://github.com/ClickHouse/ClickHouse/pull/80013) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Добавлена поддержка дополнительных форматов (`ORC`, `Avro`) при записи в `Iceberg`. Это закрывает [#86179](https://github.com/ClickHouse/ClickHouse/issues/86179). [#87277](https://github.com/ClickHouse/ClickHouse/pull/87277) ([scanhex12](https://github.com/scanhex12)).
* Добавлена новая системная таблица `database_replicas` с информацией о репликах баз данных. [#83408](https://github.com/ClickHouse/ClickHouse/pull/83408) ([Konstantin Morozov](https://github.com/k-morozov)).
* Добавлена функция `arrayExcept`, которая вычитает один массив из другого, рассматривая их как множества. [#82368](https://github.com/ClickHouse/ClickHouse/pull/82368) ([Joanna Hulboj](https://github.com/jh0x)).
* Добавлена новая таблица `system.aggregated_zookeeper_log`. Таблица содержит статистику (например, количество операций, среднюю задержку, ошибки) операций ZooKeeper, сгруппированную по идентификатору сессии, родительскому пути и типу операции, и периодически сбрасывается на диск. [#85102](https://github.com/ClickHouse/ClickHouse/pull/85102) [#87208](https://github.com/ClickHouse/ClickHouse/pull/87208) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Новая функция `isValidASCII`. Возвращает 1, если входная строка или FixedString содержит только ASCII-байты (0x00–0x7F), иначе — 0. Закрывает [#85377](https://github.com/ClickHouse/ClickHouse/issues/85377). ... [#85786](https://github.com/ClickHouse/ClickHouse/pull/85786) ([rajat mohan](https://github.com/rajatmohan22)).
* Логические настройки можно указывать без аргументов, например `SET use_query_cache;`, что эквивалентно установке значения `true`. [#85800](https://github.com/ClickHouse/ClickHouse/pull/85800) ([thraeka](https://github.com/thraeka)).
* Новые параметры конфигурации `logger.startupLevel` и `logger.shutdownLevel` позволяют переопределять уровень логирования во время запуска и завершения работы ClickHouse соответственно. [#85967](https://github.com/ClickHouse/ClickHouse/pull/85967) ([Lennard Eijsackers](https://github.com/Blokje5)).
* Агрегатные функции `timeSeriesChangesToGrid` и `timeSeriesResetsToGrid`. Их поведение аналогично `timeSeriesRateToGrid`: они принимают параметры начальной метки времени, конечной метки времени, шага и окна ретроспективного просмотра (look back window), а также два аргумента — для меток времени и значений, но при этом требуют как минимум 1 измерение на окно вместо 2. Вычисляют PromQL-функции `changes`/`resets`, подсчитывая, сколько раз значение выборки изменяется или уменьшается в указанном окне для каждой метки времени во временной сетке, определённой параметрами. Тип возвращаемого значения — `Array(Nullable(Float64))`. [#86010](https://github.com/ClickHouse/ClickHouse/pull/86010) ([Stephen Chi](https://github.com/stephchi0)).
* Позволяет пользователям создавать временные представления с синтаксисом, аналогичным синтаксису временных таблиц (`CREATE TEMPORARY VIEW`). [#86432](https://github.com/ClickHouse/ClickHouse/pull/86432) ([Aly Kafoury](https://github.com/AlyHKafoury)).
* Добавлены предупреждения об использовании CPU и памяти в таблицу `system.warnings`. [#86838](https://github.com/ClickHouse/ClickHouse/pull/86838) ([Bharat Nallan](https://github.com/bharatnc)).
* Поддержка индикатора `oneof` во входных данных `Protobuf`. Для указания наличия части oneof может использоваться специальный столбец. Если сообщение содержит [oneof](https://protobuf.dev/programming-guides/proto3/#oneof) и задан параметр `input_format_protobuf_oneof_presence`, ClickHouse заполняет столбец, который указывает, какое поле oneof было найдено. [#82885](https://github.com/ClickHouse/ClickHouse/pull/82885) ([Ilya Golshtein](https://github.com/ilejn)).
* Улучшено профилирование выделения памяти на основе внутреннего инструментария jemalloc. Глобальный профилировщик jemalloc теперь может быть включён с помощью конфигурации `jemalloc_enable_global_profiler`. Сэмплируемые глобальные операции выделения и освобождения памяти могут сохраняться в `system.trace_log` с типом `JemallocSample` при включении конфигурации `jemalloc_collect_global_profile_samples_in_trace_log`. Профилирование jemalloc теперь может быть включено для каждого запроса отдельно с помощью настройки `jemalloc_enable_profiler`. Сохранение сэмплов в `system.trace_log` может управляться по каждому запросу с помощью настройки `jemalloc_collect_profile_samples_in_trace_log`. Обновлена версия jemalloc. [#85438](https://github.com/ClickHouse/ClickHouse/pull/85438) ([Antonio Andelic](https://github.com/antonio2368)).
* Новая настройка для удаления файлов при удалении (DROP) таблиц Iceberg. Это закрывает [#86211](https://github.com/ClickHouse/ClickHouse/issues/86211). [#86501](https://github.com/ClickHouse/ClickHouse/pull/86501) ([scanhex12](https://github.com/scanhex12)).



#### Экспериментальная функция
* Инвертированный текстовый индекс был переработан с нуля, чтобы масштабироваться для наборов данных, которые не помещаются в оперативную память. [#86485](https://github.com/ClickHouse/ClickHouse/pull/86485) ([Anton Popov](https://github.com/CurtizJ)).
* Перестановка `JOIN` теперь использует статистику. Функцию можно включить, установив `allow_statistics_optimize = 1` и `query_plan_optimize_join_order_limit = 10`. [#86822](https://github.com/ClickHouse/ClickHouse/pull/86822) ([Han Fei](https://github.com/hanfei1991)).
* `alter table ... materialize statistics all` теперь позволяет материализовать всю статистику таблицы. [#87197](https://github.com/ClickHouse/ClickHouse/pull/87197) ([Han Fei](https://github.com/hanfei1991)).



#### Улучшение производительности

* Добавлена поддержка фильтрации кусков данных с помощью skip-индексов при чтении для сокращения лишних чтений индексов. Управляется новой настройкой `use_skip_indexes_on_data_read` (по умолчанию отключена). Это решает проблему [#75774](https://github.com/ClickHouse/ClickHouse/issues/75774). Включает часть общей базовой работы, общей с [#81021](https://github.com/ClickHouse/ClickHouse/issues/81021). [#81526](https://github.com/ClickHouse/ClickHouse/pull/81526) ([Amos Bird](https://github.com/amosbird)).
* Добавлена оптимизация порядка `JOIN`, которая может автоматически переупорядочивать `JOIN` для повышения производительности (управляется настройкой `query_plan_optimize_join_order_limit`). Обратите внимание, что оптимизация порядка `JOIN` в настоящее время имеет ограниченную поддержку статистики и в основном полагается на оценки количества строк от движков хранения — более продвинутый сбор статистики и оценка кардинальности будут добавлены в будущих релизах. **Если после обновления вы столкнётесь с проблемами с запросами с JOIN**, вы можете временно отключить новую реализацию, установив `SET query_plan_use_new_logical_join_step = 0`, и сообщить о проблеме для анализа. **Замечание о разрешении идентификаторов из предложения USING**: Изменено разрешение объединённого (coalesced) столбца из предложения `OUTER JOIN ... USING` для большей согласованности: ранее, при выборе и столбца из USING, и квалифицированных столбцов (`a, t1.a, t2.a`) в `OUTER JOIN`, столбец из USING ошибочно разрешался в `t1.a`, показывая 0/NULL для строк из правой таблицы без соответствия в левой. Теперь идентификаторы из предложения USING всегда разрешаются в объединённый (coalesced) столбец, в то время как квалифицированные идентификаторы разрешаются в не объединённые столбцы, независимо от того, какие ещё идентификаторы присутствуют в запросе. Например: ```sql SELECT a, t1.a, t2.a FROM (SELECT 1 as a WHERE 0) t1 FULL JOIN (SELECT 2 as a) t2 USING (a) -- Before: a=0, t1.a=0, t2.a=2 (incorrect - &#39;a&#39; resolved to t1.a) -- After: a=2, t1.a=0, t2.a=2 (correct - &#39;a&#39; is coalesced). [#80848](https://github.com/ClickHouse/ClickHouse/pull/80848) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Распределённый `INSERT SELECT` для data lake-хранилищ. [#86783](https://github.com/ClickHouse/ClickHouse/pull/86783) ([scanhex12](https://github.com/scanhex12)).
* Улучшена оптимизация PREWHERE для условий вида `func(primary_column) = 'xx'` и `column IN (xxx)`. [#85529](https://github.com/ClickHouse/ClickHouse/pull/85529) ([李扬](https://github.com/taiyang-li)).
* Реализовано переписывание JOIN: 1. Преобразование `LEFT ANY JOIN` и `RIGHT ANY JOIN` в `SEMI`/`ANTI` JOIN, если условие фильтра всегда ложно для совпавших или несовпавших строк. Эта оптимизация управляется новой настройкой `query_plan_convert_any_join_to_semi_or_anti_join`. 2. Преобразование `FULL ALL JOIN` в `LEFT ALL` или `RIGHT ALL` JOIN, если условие фильтра всегда ложно для несовпавших строк с одной стороны. [#86028](https://github.com/ClickHouse/ClickHouse/pull/86028) ([Dmitry Novik](https://github.com/novikd)).
* Улучшена производительность вертикальных слияний после выполнения лёгкого удаления (`lightweight delete`). [#86169](https://github.com/ClickHouse/ClickHouse/pull/86169) ([Anton Popov](https://github.com/CurtizJ)).
* Незначительно оптимизирована производительность `HashJoin` в случае операций соединения `LEFT/RIGHT` с большим количеством не совпавших строк. [#86312](https://github.com/ClickHouse/ClickHouse/pull/86312) ([Nikita Taranov](https://github.com/nickitat)).
* Radix sort: помогает компилятору использовать SIMD и улучшать предварительную выборку. Использует динамическую диспетчеризацию, чтобы применять программную предварительную выборку только на процессорах Intel. Продолжает работу @taiyang-li в [https://github.com/ClickHouse/ClickHouse/pull/77029](https://github.com/ClickHouse/ClickHouse/pull/77029). [#86378](https://github.com/ClickHouse/ClickHouse/pull/86378) ([Raúl Marín](https://github.com/Algunenano)).
* Улучшает производительность коротких запросов над таблицами с большим числом партиций (за счёт оптимизации `MarkRanges` с использованием `devector` вместо `deque`). [#86933](https://github.com/ClickHouse/ClickHouse/pull/86933) ([Azat Khuzhin](https://github.com/azat)).
* Повышена производительность применения патч-запчастей в режиме `JOIN`. [#87094](https://github.com/ClickHouse/ClickHouse/pull/87094) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена настройка `query_condition_cache_selectivity_threshold` (значение по умолчанию: 1.0), которая исключает результаты сканирования предикатов с низкой селективностью из помещения в кэш условий запроса. Это позволяет уменьшить потребление памяти кэшем условий запроса ценой более низкого коэффициента попаданий в кэш. [#86076](https://github.com/ClickHouse/ClickHouse/pull/86076) ([zhongyuankai](https://github.com/zhongyuankai)).
* Снижено потребление памяти при записи в Iceberg. [#86544](https://github.com/ClickHouse/ClickHouse/pull/86544) ([scanhex12](https://github.com/scanhex12)).





#### Улучшение

* Поддерживается запись нескольких файлов данных в Iceberg за одну вставку. Добавлены новые настройки `iceberg_insert_max_rows_in_data_file` и `iceberg_insert_max_bytes_in_data_file` для управления лимитами. [#86275](https://github.com/ClickHouse/ClickHouse/pull/86275) ([scanhex12](https://github.com/scanhex12)).
* Добавлено ограничение на число строк и объём в байтах для файлов данных, вставляемых в Delta Lake. Управляется настройками `delta_lake_insert_max_rows_in_data_file` и `delta_lake_insert_max_bytes_in_data_file`. [#86357](https://github.com/ClickHouse/ClickHouse/pull/86357) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка большего числа типов партиционирования при записи в Iceberg. Это закрывает [#86206](https://github.com/ClickHouse/ClickHouse/issues/86206). [#86298](https://github.com/ClickHouse/ClickHouse/pull/86298) ([scanhex12](https://github.com/scanhex12)).
* Сделана настраиваемой стратегия повторных попыток для S3 и добавлена возможность горячей перезагрузки настроек диска S3 при изменении конфигурационного XML-файла. [#82642](https://github.com/ClickHouse/ClickHouse/pull/82642) ([RinChanNOW](https://github.com/RinChanNOWWW)).
* Улучшен движок таблиц S3(Azure)Queue, чтобы он мог переживать потерю соединения с ZooKeeper без появления потенциальных дубликатов. Требуется включить настройку S3Queue `use_persistent_processing_nodes` (можно изменить с помощью `ALTER TABLE MODIFY SETTING`). [#85995](https://github.com/ClickHouse/ClickHouse/pull/85995) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Можно использовать параметры запроса после `TO` при создании материализованного представления, например: `CREATE MATERIALIZED VIEW mv TO {to_table:Identifier} AS SELECT * FROM src_table`. [#84899](https://github.com/ClickHouse/ClickHouse/pull/84899) ([Diskein](https://github.com/Diskein)).
* Более явно информировать пользователей при указании некорректных настроек для движка таблиц `Kafka2`. [#83701](https://github.com/ClickHouse/ClickHouse/pull/83701) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Больше нельзя указывать часовые пояса для типа `Time` (это не имело смысла). [#84689](https://github.com/ClickHouse/ClickHouse/pull/84689) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Упростили (и устранили некоторые ошибки) логику, связанную с разбором Time/Time64 в режиме `best_effort`. [#84730](https://github.com/ClickHouse/ClickHouse/pull/84730) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена функция `deltaLakeAzureCluster` (аналогична `deltaLakeAzure` в кластерном режиме) и функция `deltaLakeS3Cluster` (псевдоним для `deltaLakeCluster`). Исправляет [#85358](https://github.com/ClickHouse/ClickHouse/issues/85358). [#85547](https://github.com/ClickHouse/ClickHouse/pull/85547) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Применять настройку `azure_max_single_part_copy_size` к обычным операциям копирования так же, как к резервному копированию. [#85767](https://github.com/ClickHouse/ClickHouse/pull/85767) ([Ilya Golshtein](https://github.com/ilejn)).
* Замедление потоков клиента S3 при повторяемых ошибках в объектном хранилище S3. Эта настройка расширяет действие предыдущей `backup_slow_all_threads_after_retryable_s3_error` на S3-диски и переименовывает её в более общую `s3_slow_all_threads_after_retryable_error`. [#85918](https://github.com/ClickHouse/ClickHouse/pull/85918) ([Julia Kartseva](https://github.com/jkartseva)).
* Настройки allow&#95;experimental&#95;variant/dynamic/json и enable&#95;variant/dynamic/json помечены как устаревшие. Теперь все три типа включены безусловно. [#85934](https://github.com/ClickHouse/ClickHouse/pull/85934) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена поддержка фильтрации по полной строке URL (директива `full_url`) в `http_handlers` (включая схему и host:port). [#86155](https://github.com/ClickHouse/ClickHouse/pull/86155) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена новая настройка `allow_experimental_delta_lake_writes`. [#86180](https://github.com/ClickHouse/ClickHouse/pull/86180) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено определение systemd в скрипте init.d (исправлена проверка «Install packages»). [#86187](https://github.com/ClickHouse/ClickHouse/pull/86187) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена новая размерностная метрика `startup_scripts_failure_reason`. Эта метрика нужна для различения разных типов ошибок, которые приводят к сбою стартовых скриптов. В частности, для целей оповещений нам нужно различать временные (например, `MEMORY_LIMIT_EXCEEDED` или `KEEPER_EXCEPTION`) и невременные ошибки. [#86202](https://github.com/ClickHouse/ClickHouse/pull/86202) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Позволяет опускать функцию `identity` для секции партиционирования в таблице Iceberg. [#86314](https://github.com/ClickHouse/ClickHouse/pull/86314) ([scanhex12](https://github.com/scanhex12)).
* Добавлена возможность включать JSON-логирование только для определённого канала — для этого установите `logger.formatting.channel` в одно из значений `syslog`/`console`/`errorlog`/`log`. [#86331](https://github.com/ClickHouse/ClickHouse/pull/86331) ([Azat Khuzhin](https://github.com/azat)).
* Разрешено использовать нативные числа в `WHERE`. Они уже допускаются в качестве аргументов логических функций. Это упрощает оптимизации filter-push-down и move-to-prewhere. [#86390](https://github.com/ClickHouse/ClickHouse/pull/86390) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка при выполнении `SYSTEM DROP REPLICA` для каталога с повреждёнными метаданными. [#86391](https://github.com/ClickHouse/ClickHouse/pull/86391) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлены дополнительные попытки повторной проверки доступа к диску (`skip_access_check = 0`) в Azure, поскольку предоставление доступа может занимать довольно продолжительное время. [#86419](https://github.com/ClickHouse/ClickHouse/pull/86419) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Окно устаревания в функциях `timeSeries*()` сделано левосторонне открытым и правосторонне закрытым. [#86588](https://github.com/ClickHouse/ClickHouse/pull/86588) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлены события профилирования `FailedInternal*Query`. [#86627](https://github.com/ClickHouse/ClickHouse/pull/86627) ([Shane Andrade](https://github.com/mauidude)).
* Исправлена обработка пользователей, в имени которых есть точка, при добавлении через конфигурационный файл. [#86633](https://github.com/ClickHouse/ClickHouse/pull/86633) ([Mikhail Koviazin](https://github.com/mkmkme)).
* Добавлены асинхронные метрики использования памяти в запросах (`QueriesMemoryUsage` и `QueriesPeakMemoryUsage`). [#86669](https://github.com/ClickHouse/ClickHouse/pull/86669) ([Azat Khuzhin](https://github.com/azat)).
* Вы можете использовать флаг `clickhouse-benchmark --precise` для более точного измерения QPS и других интервальных метрик. Это помогает получать стабильные значения QPS, если длительности запросов сопоставимы с интервалом отчётности `--delay D`. [#86684](https://github.com/ClickHouse/ClickHouse/pull/86684) ([Sergei Trifonov](https://github.com/serxa)).
* Сделать значения `nice` для потоков Linux настраиваемыми, чтобы можно было назначать некоторым потокам (merge/mutate, query, materialized view, zookeeper client) более высокий или более низкий приоритет. [#86703](https://github.com/ClickHouse/ClickHouse/pull/86703) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Исправлена вводящая в заблуждение ошибка «specified upload does not exist», которая возникает, когда исходное исключение теряется при многокомпонентной загрузке из‑за состояния гонки. [#86725](https://github.com/ClickHouse/ClickHouse/pull/86725) ([Julia Kartseva](https://github.com/jkartseva)).
* Ограничено описание плана запроса в запросе `EXPLAIN`. Описание не вычисляется для запросов, отличных от `EXPLAIN`. Добавлена настройка `query_plan_max_step_description_length`. [#86741](https://github.com/ClickHouse/ClickHouse/pull/86741) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлена возможность настраивать отложенные сигналы, чтобы попытаться устранить ошибку CANNOT&#95;CREATE&#95;TIMER (для профилировщиков запросов: `query_profiler_real_time_period_ns`/`query_profiler_cpu_time_period_ns`). А также добавлен сбор `SigQ` из `/proc/self/status` для интроспекции (если `ProcessSignalQueueSize` близко к `ProcessSignalQueueLimit`, то, скорее всего, вы получите ошибки `CANNOT_CREATE_TIMER`). [#86760](https://github.com/ClickHouse/ClickHouse/pull/86760) ([Azat Khuzhin](https://github.com/azat)).
* Улучшена производительность запроса `RemoveRecursive` в Keeper. [#86789](https://github.com/ClickHouse/ClickHouse/pull/86789) ([Antonio Andelic](https://github.com/antonio2368)).
* Удалены лишние пробелы в `PrettyJSONEachRow` при выводе значений типа JSON. [#86819](https://github.com/ClickHouse/ClickHouse/pull/86819) ([Pavel Kruglov](https://github.com/Avogar)).
* Теперь при удалении каталога на обычном перезаписываемом диске мы записываем размеры блобов для `prefix.path`. [#86908](https://github.com/ClickHouse/ClickHouse/pull/86908) ([alesapin](https://github.com/alesapin)).
* Поддержка тестов производительности на удалённых экземплярах ClickHouse, включая ClickHouse Cloud. Пример использования: `tests/performance/scripts/perf.py tests/performance/math.xml --runs 10 --user <username> --password <password> --host <hostname> --port <port> --secure`. [#86995](https://github.com/ClickHouse/ClickHouse/pull/86995) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Соблюдать ограничения по памяти в ряде мест, где известно, что выделяется значительный (&gt;16MiB) объём памяти (сортировка, асинхронные вставки, файловый журнал). [#87035](https://github.com/ClickHouse/ClickHouse/pull/87035) ([Azat Khuzhin](https://github.com/azat)).
* Выбрасывать исключение, если значение настройки `network_compression_method` не является поддерживаемым универсальным кодеком. [#87097](https://github.com/ClickHouse/ClickHouse/pull/87097) ([Robert Schulze](https://github.com/rschu1ze)).
* Системная таблица `system.query_cache` теперь возвращает *все* записи кэша результатов запросов, тогда как ранее она возвращала только общие записи или необщие записи того же пользователя и роли. Это допустимо, поскольку необщие записи по замыслу не должны раскрывать *результаты запросов*, тогда как `system.query_cache` возвращает *строки запросов*. Это делает поведение системной таблицы более похожим на `system.query_log`. [#87104](https://github.com/ClickHouse/ClickHouse/pull/87104) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена короткая схема вычислений (short-circuit evaluation) для функции `parseDateTime`. [#87184](https://github.com/ClickHouse/ClickHouse/pull/87184) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлен новый столбец `statistics` в `system.parts_columns`. [#87259](https://github.com/ClickHouse/ClickHouse/pull/87259) ([Han Fei](https://github.com/hanfei1991)).





#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе)

* Результаты `ALTER`-запросов теперь проверяются только на инициирующем узле для реплицируемых баз данных и таблиц с внутренней репликацией. Это исправляет ситуации, когда уже зафиксированный `ALTER`-запрос мог «застревать» на других узлах. [#83849](https://github.com/ClickHouse/ClickHouse/pull/83849) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Ограничено количество задач каждого типа в `BackgroundSchedulePool`. Это позволяет избежать ситуаций, когда все слоты заняты задачами одного типа, в то время как другие задачи простаивают. Также предотвращаются взаимные блокировки (deadlock), когда задачи ожидают друг друга. Это контролируется серверной настройкой `background_schedule_pool_max_parallel_tasks_per_type_ratio`. [#84008](https://github.com/ClickHouse/ClickHouse/pull/84008) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Корректно останавливать таблицы при восстановлении реплики базы данных. Некорректное завершение работы приводило к ошибке `LOGICAL_ERROR` для некоторых движков таблиц во время восстановления реплики базы данных. [#84744](https://github.com/ClickHouse/ClickHouse/pull/84744) ([Antonio Andelic](https://github.com/antonio2368)).
* Проверка прав доступа при генерации подсказок по исправлению опечаток в имени базы данных. [#85371](https://github.com/ClickHouse/ClickHouse/pull/85371) ([Dmitry Novik](https://github.com/novikd)).
* 1. `LowCardinality` для столбцов Hive 2. Заполнять столбцы Hive перед виртуальными столбцами (требуется для [https://github.com/ClickHouse/ClickHouse/pull/81040](https://github.com/ClickHouse/ClickHouse/pull/81040)) 3. `LOGICAL_ERROR` при пустом формате для Hive [#85528](https://github.com/ClickHouse/ClickHouse/issues/85528) 4. Исправлена проверка, что столбцы секций Hive являются единственными столбцами 5. Добавлена проверка, что все столбцы Hive указаны в схеме 6. Частичное исправление для `parallel_replicas_cluster` с Hive 7. Использовать упорядоченный контейнер в `extractkeyValuePairs` для утилит Hive (требуется для [https://github.com/ClickHouse/ClickHouse/pull/81040](https://github.com/ClickHouse/ClickHouse/pull/81040)). [#85538](https://github.com/ClickHouse/ClickHouse/pull/85538) ([Arthur Passos](https://github.com/arthurpassos)).
* Предотвращена ненужная оптимизация первого аргумента функций `IN`, которая в некоторых случаях приводила к ошибке при использовании array mapping. [#85546](https://github.com/ClickHouse/ClickHouse/pull/85546) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Соответствие между идентификаторами источников `iceberg` и именами `parquet` не было приведено в соответствие со схемой при записи файла `parquet`. В этом PR обрабатывается схема, соответствующая каждому файлу данных `iceberg`, а не текущая. [#85829](https://github.com/ClickHouse/ClickHouse/pull/85829) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлена отдельная операция чтения размера файла от его открытия. Относится к [https://github.com/ClickHouse/ClickHouse/pull/33372](https://github.com/ClickHouse/ClickHouse/pull/33372), который был добавлен в ответ на ошибку в ядрах Linux до релиза `5.10`. [#85837](https://github.com/ClickHouse/ClickHouse/pull/85837) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* ClickHouse Keeper больше не завершается с ошибкой при запуске на системах, где IPv6 отключён на уровне ядра (например, RHEL с ipv6.disable=1). Теперь он пытается переключиться на прослушиватель IPv4, если не удаётся запустить исходный прослушиватель IPv6. [#85901](https://github.com/ClickHouse/ClickHouse/pull/85901) ([jskong1124](https://github.com/jskong1124)).
* Этот PR закрывает [#77990](https://github.com/ClickHouse/ClickHouse/issues/77990). Добавлена поддержка TableFunctionRemote для параллельных реплик в global join. [#85929](https://github.com/ClickHouse/ClickHouse/pull/85929) ([zoomxi](https://github.com/zoomxi)).
* Исправлен null pointer в orcschemareader::initializeifneeded(). Этот PR решает следующую проблему: [#85292](https://github.com/ClickHouse/ClickHouse/issues/85292) ### запись в документации об изменениях, заметных пользователям. [#85951](https://github.com/ClickHouse/ClickHouse/pull/85951) ([yanglongwei](https://github.com/ylw510)).
* Добавлена проверка, разрешающая коррелированные подзапросы в предложении FROM только в том случае, если они используют столбцы внешнего запроса. Исправляет [#85469](https://github.com/ClickHouse/ClickHouse/issues/85469). Исправляет [#85402](https://github.com/ClickHouse/ClickHouse/issues/85402). [#85966](https://github.com/ClickHouse/ClickHouse/pull/85966) ([Dmitry Novik](https://github.com/novikd)).
* Исправлено поведение `ALTER UPDATE` для столбца с подстолбцом, используемым в материализованном выражении другого столбца. Ранее материализованный столбец с подстолбцом в своём выражении обновлялся некорректно. [#85985](https://github.com/ClickHouse/ClickHouse/pull/85985) ([Pavel Kruglov](https://github.com/Avogar)).
* Запрещено изменять столбцы, чьи подстолбцы используются в первичном ключе или в выражении партиционирования. [#86005](https://github.com/ClickHouse/ClickHouse/pull/86005) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено чтение подстолбцов с нестандартным режимом отображения столбцов в хранилище DeltaLake. [#86064](https://github.com/ClickHouse/ClickHouse/pull/86064) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено некорректное использование значений по умолчанию для пути с подсказкой `Enum` внутри `JSON`. [#86065](https://github.com/ClickHouse/ClickHouse/pull/86065) ([Pavel Kruglov](https://github.com/Avogar)).
* Разбор URL каталога DataLake Hive с очисткой входных данных. Закрывает [#86018](https://github.com/ClickHouse/ClickHouse/issues/86018). [#86092](https://github.com/ClickHouse/ClickHouse/pull/86092) ([rajat mohan](https://github.com/rajatmohan22)).
* Исправлена логическая ошибка при динамическом изменении размера файлового кэша. Закрывает [#86122](https://github.com/ClickHouse/ClickHouse/issues/86122). Закрывает [https://github.com/ClickHouse/clickhouse-core-incidents/issues/473](https://github.com/ClickHouse/clickhouse-core-incidents/issues/473). [#86130](https://github.com/ClickHouse/ClickHouse/pull/86130) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Использовать `NonZeroUInt64` для `logs_to_keep` в DatabaseReplicatedSettings. [#86142](https://github.com/ClickHouse/ClickHouse/pull/86142) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Запрос `FINAL` с пропускаемым индексом выбрасывал исключение, если таблица (например, `ReplacingMergeTree`) была создана с настройкой `index_granularity_bytes = 0`. Теперь эта проблема устранена. [#86147](https://github.com/ClickHouse/ClickHouse/pull/86147) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Устраняет неопределённое поведение (UB) и исправляет проблемы при разборе выражений секционирования в Iceberg. [#86166](https://github.com/ClickHouse/ClickHouse/pull/86166) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлен сбой при одновременном использовании `const`- и не-`const`-блоков в одном `INSERT`. [#86230](https://github.com/ClickHouse/ClickHouse/pull/86230) ([Azat Khuzhin](https://github.com/azat)).
* При создании дисков через SQL по умолчанию подключается конфигурация из `/etc/metrika.xml`. [#86232](https://github.com/ClickHouse/ClickHouse/pull/86232) ([alekar](https://github.com/alekar)).
* Исправлена работа accurateCastOrNull/accurateCastOrDefault при преобразовании из String в JSON. [#86240](https://github.com/ClickHouse/ClickHouse/pull/86240) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена поддержка директорий без &#39;/&#39; в движке Iceberg. [#86249](https://github.com/ClickHouse/ClickHouse/pull/86249) ([scanhex12](https://github.com/scanhex12)).
* Исправлен сбой при использовании replaceRegex с haystack типа FixedString и пустым needle. [#86270](https://github.com/ClickHouse/ClickHouse/pull/86270) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена авария при выполнении ALTER UPDATE Nullable(JSON). [#86281](https://github.com/ClickHouse/ClickHouse/pull/86281) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено отсутствие описания столбца в `system.tables`. [#86295](https://github.com/ClickHouse/ClickHouse/pull/86295) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена операция приведения типов из LowCardinality(Nullable(T)) к Dynamic. [#86365](https://github.com/ClickHouse/ClickHouse/pull/86365) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена логическая ошибка при записи в Delta Lake. Закрывает [#86175](https://github.com/ClickHouse/ClickHouse/issues/86175). [#86367](https://github.com/ClickHouse/ClickHouse/pull/86367) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка `416 The range specified is invalid for the current size of the resource. The range specified is invalid for the current size of the resource` при чтении пустых blob-объектов из Azure Blob Storage для диска plain&#95;rewritable. [#86400](https://github.com/ClickHouse/ClickHouse/pull/86400) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлена работа `GROUP BY` с `Nullable(JSON)`. [#86410](https://github.com/ClickHouse/ClickHouse/pull/86410) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка в Materialized Views: материализованное представление могло не работать, если его создавали, удаляли, а затем снова создавали с тем же именем. [#86413](https://github.com/ClickHouse/ClickHouse/pull/86413) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Выдавать ошибку, если все реплики недоступны при чтении из функций *cluster. [#86414](https://github.com/ClickHouse/ClickHouse/pull/86414) ([Julian Maicher](https://github.com/jmaicher)).
* Исправлена утечка `MergesMutationsMemoryTracking` из-за таблиц `Buffer` и исправлен `query_views_log` для потоковой обработки из `Kafka` (и других источников). [#86422](https://github.com/ClickHouse/ClickHouse/pull/86422) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа `SHOW TABLES` после удаления таблицы-ссылки хранилища alias. [#86433](https://github.com/ClickHouse/ClickHouse/pull/86433) ([RinChanNOW](https://github.com/RinChanNOWWW)).
* Исправлено отсутствие заголовка чанка, когда включён `send_chunk_header`, а UDF вызывается через протокол HTTP. [#86469](https://github.com/ClickHouse/ClickHouse/pull/86469) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлена возможная взаимная блокировка при включённых сбросах профилей jemalloc. [#86473](https://github.com/ClickHouse/ClickHouse/pull/86473) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено чтение подстолбцов в движке таблиц DeltaLake. Закрывает [#86204](https://github.com/ClickHouse/ClickHouse/issues/86204). [#86477](https://github.com/ClickHouse/ClickHouse/pull/86477) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Корректная обработка идентификатора loopback‑хоста для предотвращения коллизий при выполнении задач DDL:. [#86479](https://github.com/ClickHouse/ClickHouse/pull/86479) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлены операции `DETACH`/`ATTACH` для таблиц движка базы данных Postgres с колонками типа `numeric`/`decimal`. [#86480](https://github.com/ClickHouse/ClickHouse/pull/86480) ([Julian Maicher](https://github.com/jmaicher)).
* Исправлено использование неинициализированной памяти в getSubcolumnType. [#86498](https://github.com/ClickHouse/ClickHouse/pull/86498) ([Raúl Marín](https://github.com/Algunenano)).
* Функции `searchAny` и `searchAll` при вызове с пустыми `needles` теперь возвращают `true` (то есть «совпадает со всем»). Ранее они возвращали `false`. (issue [#86300](https://github.com/ClickHouse/ClickHouse/issues/86300)). [#86500](https://github.com/ClickHouse/ClickHouse/pull/86500) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Исправлена функция `timeSeriesResampleToGridWithStaleness()` для случая отсутствия значения в первом бакете. [#86507](https://github.com/ClickHouse/ClickHouse/pull/86507) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено падение, вызванное установкой параметра `merge_tree_min_read_task_size` в 0. [#86527](https://github.com/ClickHouse/ClickHouse/pull/86527) ([yanglongwei](https://github.com/ylw510)).
* При чтении формат для каждого файла данных теперь берётся из метаданных Iceberg (раньше он брался из аргументов таблицы). [#86529](https://github.com/ClickHouse/ClickHouse/pull/86529) ([Daniil Ivanik](https://github.com/divanik)).
* Игнорировать исключения при сбросе журнала во время завершения работы, чтобы сделать его более безопасным (и избежать SIGSEGV). [#86546](https://github.com/ClickHouse/ClickHouse/pull/86546) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка: движок резервного копирования выбрасывал исключение при запросе с файловыми частями нулевого размера. [#86563](https://github.com/ClickHouse/ClickHouse/pull/86563) ([Max Justus Spransy](https://github.com/maxjustus)).
* Исправлено отсутствие заголовка чанка, когда `send_chunk_header` включён и UDF вызывается по протоколу HTTP. [#86606](https://github.com/ClickHouse/ClickHouse/pull/86606) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлена логическая ошибка S3Queue &quot;Expected current processor {} to be equal to {}&quot;, возникавшая из-за истечения срока действия сессии Keeper. [#86615](https://github.com/ClickHouse/ClickHouse/pull/86615) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Ошибки, связанные с `Nullable`, при вставке и отсечении данных. Закрывает [#86407](https://github.com/ClickHouse/ClickHouse/issues/86407). [#86630](https://github.com/ClickHouse/ClickHouse/pull/86630) ([scanhex12](https://github.com/scanhex12)).
* Не отключайте кэш файловой системы, если кэш метаданных Iceberg уже отключён. [#86635](https://github.com/ClickHouse/ClickHouse/pull/86635) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлена ошибка «Deadlock in Parquet::ReadManager (single-threaded)» в parquet reader v3. [#86644](https://github.com/ClickHouse/ClickHouse/pull/86644) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена поддержка IPv6 в `listen_host` для ArrowFlight. [#86664](https://github.com/ClickHouse/ClickHouse/pull/86664) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено завершение работы обработчика `ArrowFlight`. Этот PR исправляет [#86596](https://github.com/ClickHouse/ClickHouse/issues/86596). [#86665](https://github.com/ClickHouse/ClickHouse/pull/86665) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлены распределённые запросы при `describe_compact_output=1`. [#86676](https://github.com/ClickHouse/ClickHouse/pull/86676) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены разбор определения окна и применение параметров запроса. [#86720](https://github.com/ClickHouse/ClickHouse/pull/86720) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено исключение `Partition strategy wildcard can not be used without a '_partition_id' wildcard.` при создании таблицы с `PARTITION BY`, но без шаблона партиций, что работало в версиях до 25.8. Закрывает [https://github.com/ClickHouse/clickhouse-private/issues/37567](https://github.com/ClickHouse/clickhouse-private/issues/37567). [#86748](https://github.com/ClickHouse/ClickHouse/pull/86748) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка LogicalError, возникающая при попытке параллельных запросов получить один и тот же блокировку. [#86751](https://github.com/ClickHouse/ClickHouse/pull/86751) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлена запись NULL в общие данные JSON во входном формате RowBinary и добавлены дополнительные проверки в ColumnObject. [#86812](https://github.com/ClickHouse/ClickHouse/pull/86812) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка с пустой перестановкой `Tuple` при использовании `LIMIT`. [#86828](https://github.com/ClickHouse/ClickHouse/pull/86828) ([Pavel Kruglov](https://github.com/Avogar)).
* Не использовать отдельный keeper-узел для persistent-узлов обработки. Исправление для [https://github.com/ClickHouse/ClickHouse/pull/85995](https://github.com/ClickHouse/ClickHouse/pull/85995). Закрывает [#86406](https://github.com/ClickHouse/ClickHouse/issues/86406). [#86841](https://github.com/ClickHouse/ClickHouse/pull/86841) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проблема, из-за которой таблица с движком `TimeSeries` нарушала создание новой реплики в `Replicated`-базе данных. [#86845](https://github.com/ClickHouse/ClickHouse/pull/86845) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлен запрос к `system.distributed_ddl_queue` в случаях, когда в заданиях отсутствуют некоторые узлы Keeper. [#86848](https://github.com/ClickHouse/ClickHouse/pull/86848) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено позиционирование в конце разжатого блока. [#86906](https://github.com/ClickHouse/ClickHouse/pull/86906) ([Pavel Kruglov](https://github.com/Avogar)).
* Обработано исключение, выбрасываемое при асинхронном выполнении итератора Iceberg. [#86932](https://github.com/ClickHouse/ClickHouse/pull/86932) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлено сохранение крупных предварительно обработанных XML-конфигов. [#86934](https://github.com/ClickHouse/ClickHouse/pull/86934) ([c-end](https://github.com/c-end)).
* Исправлено заполнение поля даты в таблице system.iceberg&#95;metadata&#95;log. [#86961](https://github.com/ClickHouse/ClickHouse/pull/86961) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлен бесконечный пересчёт `TTL` с условием `WHERE`. [#86965](https://github.com/ClickHouse/ClickHouse/pull/86965) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен потенциально некорректный результат работы функции `uniqExact` с модификаторами `ROLLUP` и `CUBE`. [#87014](https://github.com/ClickHouse/ClickHouse/pull/87014) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлено определение схемы таблицы табличной функцией `url()` при значении настройки `parallel_replicas_for_cluster_functions`, равном 1. [#87029](https://github.com/ClickHouse/ClickHouse/pull/87029) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Корректно приводить тип результата `PREWHERE` после разбиения его на несколько шагов. [#87040](https://github.com/ClickHouse/ClickHouse/pull/87040) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена работа lightweight-обновлений с оператором `ON CLUSTER`. [#87043](https://github.com/ClickHouse/ClickHouse/pull/87043) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена совместимость некоторых состояний агрегатных функций с аргументом типа String. [#87049](https://github.com/ClickHouse/ClickHouse/pull/87049) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена проблема, из-за которой имя модели из OpenAI не передавалось. [#87100](https://github.com/ClickHouse/ClickHouse/pull/87100) ([Kaushik Iska](https://github.com/iskakaushik)).
* EmbeddedRocksDB: путь должен находиться внутри user&#95;files. [#87109](https://github.com/ClickHouse/ClickHouse/pull/87109) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена проблема с таблицами KeeperMap, созданными до версии 25.1, которые оставляли данные в ZooKeeper после выполнения запроса DROP. [#87112](https://github.com/ClickHouse/ClickHouse/pull/87112) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлено чтение идентификаторов полей типов `map` и `array` из файлов формата `parquet`. [#87136](https://github.com/ClickHouse/ClickHouse/pull/87136) ([scanhex12](https://github.com/scanhex12)).
* Исправлено чтение массива с подстолбцом размеров при ленивой материализации. [#87139](https://github.com/ClickHouse/ClickHouse/pull/87139) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена работа функции CASE с аргументами типа Dynamic. [#87177](https://github.com/ClickHouse/ClickHouse/pull/87177) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено чтение пустого массива из пустой строки в CSV. [#87182](https://github.com/ClickHouse/ClickHouse/pull/87182) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена возможная некорректная работа некоррелированного `EXISTS`. Ошибка проявлялась при `execute_exists_as_scalar_subquery=1`, который был добавлен в [https://github.com/ClickHouse/ClickHouse/pull/85481](https://github.com/ClickHouse/ClickHouse/pull/85481) и влияет на версию `25.8`. Исправляет [#86415](https://github.com/ClickHouse/ClickHouse/issues/86415). [#87207](https://github.com/ClickHouse/ClickHouse/pull/87207) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Вызывает ошибку, если `iceberg_metadata_log` не настроен, а пользователь пытается получить отладочную информацию о метаданных Iceberg. Исправляет обращение к `nullptr`. [#87250](https://github.com/ClickHouse/ClickHouse/pull/87250) ([Daniil Ivanik](https://github.com/divanik)).

#### Улучшения сборки/тестирования/упаковки

- Исправлена совместимость с abseil-cpp 20250814.0, https://github.com/abseil/abseil-cpp/issues/1923. [#85970](https://github.com/ClickHouse/ClickHouse/pull/85970) ([Yuriy Chernyshov](https://github.com/georgthegreat)).
- Сборка автономного WASM-лексера помещена под флаг. [#86505](https://github.com/ClickHouse/ClickHouse/pull/86505) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Исправлена сборка crc32c на старых ARM-процессорах без поддержки инструкции `vmull_p64`. [#86521](https://github.com/ClickHouse/ClickHouse/pull/86521) ([Pablo Marcos](https://github.com/pamarcos)).
- Используется `openldap` 2.6.10. [#86623](https://github.com/ClickHouse/ClickHouse/pull/86623) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Отключен перехват `memalign` на darwin. [#86769](https://github.com/ClickHouse/ClickHouse/pull/86769) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Используется `krb5` 1.22.1-final. [#86836](https://github.com/ClickHouse/ClickHouse/pull/86836) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Исправлена распаковка имён Rust-крейтов в `list-licenses.sh`. [#87305](https://github.com/ClickHouse/ClickHouse/pull/87305) ([Konstantin Bogdanov](https://github.com/thevar1able)).

### Релиз ClickHouse 25.8 LTS, 2025-08-28 {#258}


#### Обратное несовместимое изменение
* Выводить `Array(Dynamic)` вместо безымянного `Tuple` для массивов значений с разными типами в JSON. Чтобы использовать прежнее поведение, отключите настройку `input_format_json_infer_array_of_dynamic_from_array_of_different_types`. [#80859](https://github.com/ClickHouse/ClickHouse/pull/80859) ([Pavel Kruglov](https://github.com/Avogar)).
* Перенести метрики задержек S3 в гистограммы для однородности и упрощения. [#82305](https://github.com/ClickHouse/ClickHouse/pull/82305) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Требовать обратные кавычки вокруг идентификаторов с точками в выражениях по умолчанию, чтобы предотвратить их разбор как составных идентификаторов. [#83162](https://github.com/ClickHouse/ClickHouse/pull/83162) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Ленивую материализацию включать только с analyzer (который используется по умолчанию), чтобы избежать сопровождения режима без analyzer, который, по нашему опыту, имеет некоторые проблемы (например, при использовании `indexHint()` в условиях). [#83791](https://github.com/ClickHouse/ClickHouse/pull/83791) ([Igor Nikonov](https://github.com/devcrafter)).
* По умолчанию записывать значения типа `Enum` как `BYTE_ARRAY` с логическим типом `ENUM` в формате вывода Parquet. [#84169](https://github.com/ClickHouse/ClickHouse/pull/84169) ([Pavel Kruglov](https://github.com/Avogar)).
* Включить настройку MergeTree `write_marks_for_substreams_in_compact_parts` по умолчанию. Это значительно улучшает производительность чтения подколнок из заново созданных частей в формате Compact. Серверы версии ниже 25.5 не смогут читать новые части в формате Compact. [#84171](https://github.com/ClickHouse/ClickHouse/pull/84171) ([Pavel Kruglov](https://github.com/Avogar)).
* Предыдущее значение по умолчанию для `concurrent_threads_scheduler` было `round_robin`, что оказалось несправедливым при большом количестве однопоточных запросов (например, INSERT). Это изменение делает более безопасный планировщик `fair_round_robin` значением по умолчанию. [#84747](https://github.com/ClickHouse/ClickHouse/pull/84747) ([Sergei Trifonov](https://github.com/serxa)).
* ClickHouse поддерживает синтаксис heredoc в стиле PostgreSQL: `$tag$ string contents... $tag$`, также известный как строковые литералы с ограничителями-долларами. В предыдущих версиях ограничения на теги были слабее: они могли содержать произвольные символы, включая знаки препинания и пробелы. Это создает неоднозначность при разборе с идентификаторами, которые также могут начинаться с символа доллара. В то же время PostgreSQL допускает в тегах только символьные (word) символы. Чтобы решить проблему, теперь мы ограничиваем теги heredoc только символьными (word) символами. Закрывает [#84731](https://github.com/ClickHouse/ClickHouse/issues/84731). [#84846](https://github.com/ClickHouse/ClickHouse/pull/84846) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Функции `azureBlobStorage`, `deltaLakeAzure` и `icebergAzure` были обновлены для корректной проверки прав `AZURE`. Все кластерные варианты функций (функции с суффиксом `-Cluster`) теперь проверяют права относительно своих некластерных аналогов. Кроме того, функции `icebergLocal` и `deltaLakeLocal` теперь требуют проверки прав `FILE`. [#84938](https://github.com/ClickHouse/ClickHouse/pull/84938) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Включить настройку `allow_dynamic_metadata_for_data_lakes` (настройка уровня движка таблицы) по умолчанию. [#85044](https://github.com/ClickHouse/ClickHouse/pull/85044) ([Daniil Ivanik](https://github.com/divanik)).
* Отключить заключение 64-битных целых чисел в кавычки в форматах JSON по умолчанию. [#74079](https://github.com/ClickHouse/ClickHouse/pull/74079) ([Pavel Kruglov](https://github.com/Avogar))



#### Новая функция

* Добавлена базовая поддержка диалекта PromQL. Чтобы использовать его, задайте `dialect='promql'` в clickhouse-client, укажите таблицу TimeSeries с помощью настройки `promql_table_name='X'` и выполняйте запросы вида `rate(ClickHouseProfileEvents_ReadCompressedBytes[1m])[5m:1m]`. Также вы можете обернуть запрос PromQL в SQL: `SELECT * FROM prometheusQuery('up', ...);`. На данный момент поддерживаются только функции `rate`, `delta` и `increase`. Унарные/бинарные операторы не поддерживаются. HTTP API отсутствует. [#75036](https://github.com/ClickHouse/ClickHouse/pull/75036) ([Vitaly Baranov](https://github.com/vitlibar)).
* Генерация SQL с использованием ИИ теперь при наличии может автоматически считывать из окружения переменные `ANTHROPIC_API_KEY` и `OPENAI_API_KEY`, что позволяет использовать эту функцию без дополнительной конфигурации. [#83787](https://github.com/ClickHouse/ClickHouse/pull/83787) ([Kaushik Iska](https://github.com/iskakaushik)).
* Реализована поддержка протокола [ArrowFlight RPC](https://arrow.apache.org/docs/format/Flight.html) путём добавления новой табличной функции `arrowflight`. [#74184](https://github.com/ClickHouse/ClickHouse/pull/74184) ([zakr600](https://github.com/zakr600)).
* Теперь все таблицы поддерживают виртуальный столбец `_table` (не только таблицы с движком `Merge`), что особенно полезно для запросов с `UNION ALL`. [#63665](https://github.com/ClickHouse/ClickHouse/pull/63665) ([Xiaozhe Yu](https://github.com/wudidapaopao)).
* Разрешить использование любой политики хранения (например, объектного хранилища, такого как S3) для внешней агрегации/сортировки. [#84734](https://github.com/ClickHouse/ClickHouse/pull/84734) ([Azat Khuzhin](https://github.com/azat)).
* Реализована аутентификация AWS S3 с явно заданной ролью IAM. Реализован OAuth для GCS. До недавнего времени эти возможности были доступны только в ClickHouse Cloud, а теперь открыты в виде open source. Синхронизированы некоторые интерфейсы, такие как сериализация параметров подключения к объектным хранилищам. [#84011](https://github.com/ClickHouse/ClickHouse/pull/84011) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка позиционных удалений в Iceberg TableEngine. [#83094](https://github.com/ClickHouse/ClickHouse/pull/83094) ([Daniil Ivanik](https://github.com/divanik)).
* Поддержка удаления записей по равенству в Iceberg. [#85843](https://github.com/ClickHouse/ClickHouse/pull/85843) ([Han Fei](https://github.com/hanfei1991)).
* Поддержка записи в Iceberg при выполнении `CREATE`. Закрывает [#83927](https://github.com/ClickHouse/ClickHouse/issues/83927). [#83983](https://github.com/ClickHouse/ClickHouse/pull/83983) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Glue-каталоги для записи. [#84136](https://github.com/ClickHouse/ClickHouse/pull/84136) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Каталоги Iceberg REST для записи. [#84684](https://github.com/ClickHouse/ClickHouse/pull/84684) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Все файлы `iceberg position delete` объединяются с файлами данных. Это уменьшит количество и размеры файлов Parquet в хранилище Iceberg. Синтаксис: `OPTIMIZE TABLE table_name`. [#85250](https://github.com/ClickHouse/ClickHouse/pull/85250) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Поддержка `drop table` для Iceberg (удаление записей из REST/Glue-каталогов и метаданных о таблице). [#85395](https://github.com/ClickHouse/ClickHouse/pull/85395) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Добавлена поддержка мутаций `ALTER DELETE` для Iceberg в формате merge-on-read. [#85549](https://github.com/ClickHouse/ClickHouse/pull/85549) ([Konstantин Ведерников](https://github.com/scanhex12)).
* Поддерживает запись в Delta Lake. Закрывает [#79603](https://github.com/ClickHouse/ClickHouse/issues/79603). [#85564](https://github.com/ClickHouse/ClickHouse/pull/85564) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена настройка `delta_lake_snapshot_version`, позволяющая считывать конкретную версию снимка в движке таблиц `DeltaLake`. [#85295](https://github.com/ClickHouse/ClickHouse/pull/85295) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Записывать больше статистики Iceberg (размеры столбцов, нижние и верхние границы) в метаданные (manifest entries) для отсечения по min-max. [#85746](https://github.com/ClickHouse/ClickHouse/pull/85746) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Добавлена поддержка операций add/drop/modify столбцов в Iceberg для простых типов. [#85769](https://github.com/ClickHouse/ClickHouse/pull/85769) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Iceberg: добавлена поддержка записи файла version-hint. Закрывает [#85097](https://github.com/ClickHouse/ClickHouse/issues/85097). [#85130](https://github.com/ClickHouse/ClickHouse/pull/85130) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Представления, созданные эфемерными пользователями, теперь будут хранить копию реального пользователя и больше не будут инвалидироваться после удаления эфемерного пользователя. [#84763](https://github.com/ClickHouse/ClickHouse/pull/84763) ([pufit](https://github.com/pufit)).
* Индекс векторного сходства теперь поддерживает бинарное квантование. Бинарное квантование значительно снижает потребление памяти и ускоряет процесс построения векторного индекса (благодаря более быстрому вычислению расстояний). Кроме того, существующая настройка `vector_search_postfilter_multiplier` признана устаревшей и заменена более общей настройкой: `vector_search_index_fetch_multiplier`. [#85024](https://github.com/ClickHouse/ClickHouse/pull/85024) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Разрешено использовать аргументы в виде пар ключ–значение в движке таблиц/функции `s3` или `s3Cluster`, например: `s3('url', CSV, structure = 'a Int32', compression_method = 'gzip')`. [#85134](https://github.com/ClickHouse/ClickHouse/pull/85134) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Новая системная таблица для хранения ошибочных входящих сообщений из движков, таких как Kafka (очередь «мертвых писем»). [#68873](https://github.com/ClickHouse/ClickHouse/pull/68873) ([Ilya Golshtein](https://github.com/ilejn)).
* Новая команда SYSTEM RESTORE DATABASE REPLICA для реплицируемых баз данных, аналогичная уже существующей функциональности восстановления для ReplicatedMergeTree. [#73100](https://github.com/ClickHouse/ClickHouse/pull/73100) ([Konstantин Morozov](https://github.com/k-morozov)).
* Протокол PostgreSQL теперь поддерживает команду `COPY`. [#74344](https://github.com/ClickHouse/ClickHouse/pull/74344) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Поддержка C#‑клиента для протокола MySQL. Это закрывает [#83992](https://github.com/ClickHouse/ClickHouse/issues/83992). [#84397](https://github.com/ClickHouse/ClickHouse/pull/84397) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Добавлена поддержка чтения и записи в стиле секционирования Hive. [#76802](https://github.com/ClickHouse/ClickHouse/pull/76802) ([Arthur Passos](https://github.com/arthurpassos)).
* Добавлена системная таблица `zookeeper_connection_log` для хранения истории подключений к ZooKeeper. [#79494](https://github.com/ClickHouse/ClickHouse/pull/79494) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Серверная настройка `cpu_slot_preemption` включает вытесняющее планирование CPU для рабочих нагрузок и обеспечивает max-min-справедливое распределение процессорного времени между ними. Добавлены новые настройки рабочих нагрузок для ограничения использования CPU: `max_cpus`, `max_cpu_share` и `max_burst_cpu_seconds`. Подробнее: [https://clickhouse.com/docs/operations/workload-scheduling#cpu&#95;scheduling](https://clickhouse.com/docs/operations/workload-scheduling#cpu_scheduling). [#80879](https://github.com/ClickHouse/ClickHouse/pull/80879) ([Sergei Trifonov](https://github.com/serxa)).
* Разрывать TCP-соединение после заданного количества запросов или по истечении заданного интервала времени. Это имеет смысл для более равномерного распределения соединений между узлами кластера за балансировщиком нагрузки. Исправляет [#68000](https://github.com/ClickHouse/ClickHouse/issues/68000). [#81472](https://github.com/ClickHouse/ClickHouse/pull/81472) ([Kenny Sun](https://github.com/hwabis)).
* Параллельные реплики теперь поддерживают использование проекций для запросов. [#82659](https://github.com/ClickHouse/ClickHouse/issues/82659). [#82807](https://github.com/ClickHouse/ClickHouse/pull/82807) ([zoomxi](https://github.com/zoomxi)).
* Добавлена поддержка `DESCRIBE SELECT` в дополнение к `DESCRIBE (SELECT ...)`. [#82947](https://github.com/ClickHouse/ClickHouse/pull/82947) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Принудительно использовать защищённое подключение для mysql&#95;port и postgresql&#95;port. [#82962](https://github.com/ClickHouse/ClickHouse/pull/82962) ([tiandiwonder](https://github.com/tiandiwonder)).
* Теперь пользователи могут выполнять поиск по JSON-ключам без учета регистра с помощью `JSONExtractCaseInsensitive` (и других вариантов `JSONExtract`). [#83770](https://github.com/ClickHouse/ClickHouse/pull/83770) ([Alistair Evans](https://github.com/alistairjevans)).
* Добавлена таблица `system.completions`. Закрыта задача [#81889](https://github.com/ClickHouse/ClickHouse/issues/81889). [#83833](https://github.com/ClickHouse/ClickHouse/pull/83833) ([|2ustam](https://github.com/RuS2m)).
* Добавлена новая функция `nowInBlock64`. Пример использования: `SELECT nowInBlock64(6)` возвращает `2025-07-29 17:09:37.775725`. [#84178](https://github.com/ClickHouse/ClickHouse/pull/84178) ([Halersson Paris](https://github.com/halersson)).
* Добавлены extra&#95;credentials в AzureBlobStorage для аутентификации по client&#95;id и tenant&#95;id. [#84235](https://github.com/ClickHouse/ClickHouse/pull/84235) ([Pablo Marcos](https://github.com/pamarcos)).
* Добавлена функция `dateTimeToUUIDv7` для преобразования значения `DateTime` в `UUIDv7`. Пример использования: `SELECT dateTimeToUUIDv7(toDateTime('2025-08-15 18:57:56'))` возвращает `0198af18-8320-7a7d-abd3-358db23b9d5c`. [#84319](https://github.com/ClickHouse/ClickHouse/pull/84319) ([samradovich](https://github.com/samradovich)).
* агрегатные функции `timeSeriesDerivToGrid` и `timeSeriesPredictLinearToGrid` для ресемплирования данных по временной сетке, задаваемой указанными метками времени начала и конца и шагом; соответственно вычисляют функции PromQL `deriv` и `predict_linear`. [#84328](https://github.com/ClickHouse/ClickHouse/pull/84328) ([Stephen Chi](https://github.com/stephchi0)).
* Добавлены две новые функции TimeSeries: - `timeSeriesRange(start_timestamp, end_timestamp, step)`, - `timeSeriesFromGrid(start_timestamp, end_timestamp, step, values)`. [#85435](https://github.com/ClickHouse/ClickHouse/pull/85435) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлен новый синтаксис: `GRANT READ ON S3('s3://foo/.*') TO user`. [#84503](https://github.com/ClickHouse/ClickHouse/pull/84503) ([pufit](https://github.com/pufit)).
* Добавлен новый формат вывода `Hash`. Он вычисляет одно хеш-значение для всех столбцов и строк результата. Это полезно для вычисления «отпечатка» результата, например, в сценариях, где узким местом является передача данных. Пример: `SELECT arrayJoin(['abc', 'def']), 42 FORMAT Hash` возвращает `e5f9e676db098fdb9530d2059d8c23ef`. [#84607](https://github.com/ClickHouse/ClickHouse/pull/84607) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена возможность настраивать произвольные watch-и в запросах Keeper Multi. [#84964](https://github.com/ClickHouse/ClickHouse/pull/84964) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Добавлена опция `--max-concurrency` для инструмента `clickhouse-benchmark`, которая включает режим с постепенным увеличением количества параллельных запросов. [#85623](https://github.com/ClickHouse/ClickHouse/pull/85623) ([Sergei Trifonov](https://github.com/serxa)).
* TODO: что это? Поддержать частично агрегированные метрики. [#85328](https://github.com/ClickHouse/ClickHouse/pull/85328) ([Mikhail Artemenko](https://github.com/Michicosun)).



#### Экспериментальная функция
* Поддержка коррелированных подзапросов включена по умолчанию, они больше не считаются экспериментальными. [#85107](https://github.com/ClickHouse/ClickHouse/pull/85107) ([Dmitry Novik](https://github.com/novikd)).
* Каталоги озера данных Unity, Glue, Rest и Hive Metastore переведены из статуса экспериментальных в статус бета. [#85848](https://github.com/ClickHouse/ClickHouse/pull/85848) ([Melvyn Peignon](https://github.com/melvynator)).
* «Лёгкие» операции `UPDATE` и `DELETE` переведены из статуса экспериментальных в статус бета.
* Приблизительный векторный поиск с индексами векторного сходства теперь имеет статус GA. [#85888](https://github.com/ClickHouse/ClickHouse/pull/85888) ([Robert Schulze](https://github.com/rschu1ze)).
* Движок таблиц и табличная функция `Ytsaurus`. [#77606](https://github.com/ClickHouse/ClickHouse/pull/77606) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Ранее данные текстового индекса разделялись на несколько сегментов (размер каждого сегмента по умолчанию составлял 256 MiB). Это могло уменьшать потребление памяти при построении текстового индекса, однако увеличивало требования к дисковому пространству и время ответа на запросы. [#84590](https://github.com/ClickHouse/ClickHouse/pull/84590) ([Elmi Ahmadov](https://github.com/ahmadov)).



#### Улучшение производительности

* Новая реализация паркетного ридера. В целом работает быстрее и поддерживает фильтрацию на уровне страниц и PREWHERE. В настоящее время является экспериментальной. Используйте настройку `input_format_parquet_use_native_reader_v3`, чтобы включить её. [#82789](https://github.com/ClickHouse/ClickHouse/pull/82789) ([Michael Kolupaev](https://github.com/al13n321)).
* Официальный HTTP-транспорт в библиотеке Azure был заменён нашей собственной реализацией HTTP-клиента для Azure Blob Storage. Добавлено несколько настроек для этого клиента, которые соответствуют настройкам для S3. Введены агрессивные таймауты установления соединения как для Azure, так и для S3. Улучшена наблюдаемость профилей событий и метрик Azure. Новый клиент включён по умолчанию и обеспечивает значительно меньшие задержки для холодных запросов к Azure Blob Storage. Старый клиент `Curl` можно вернуть, установив `azure_sdk_use_native_client=false`. [#83294](https://github.com/ClickHouse/ClickHouse/pull/83294) ([alesapin](https://github.com/alesapin)). Предыдущая официальная реализация клиента Azure была непригодна для промышленного использования из-за чудовищных всплесков задержек — от пяти секунд до нескольких минут. Мы отказались от этой реализации и очень этим гордимся.
* Обрабатывает индексы в порядке возрастания размера файла. Итоговый порядок индексов отдает приоритет индексам `minmax` и векторным индексам (по причине простоты и селективности соответственно), а затем — небольшим индексам. Внутри групп индексов `minmax` и векторных также предпочитаются более маленькие индексы. [#84094](https://github.com/ClickHouse/ClickHouse/pull/84094) ([Maruth Goyal](https://github.com/maruthgoyal)).
* В настройках MergeTree по умолчанию включена опция `write_marks_for_substreams_in_compact_parts`. Она существенно повышает производительность чтения подколнок из заново созданных Compact‑частей. Серверы версии ниже 25.5 не смогут читать новые Compact‑части. [#84171](https://github.com/ClickHouse/ClickHouse/pull/84171) ([Pavel Kruglov](https://github.com/Avogar)).
* Движок таблиц `azureBlobStorage`: кэшировать и повторно использовать токены аутентификации управляемой идентичности, когда это возможно, чтобы избежать троттлинга. [#79860](https://github.com/ClickHouse/ClickHouse/pull/79860) ([Nick Blakely](https://github.com/niblak)).
* `ALL` `LEFT/INNER` JOIN автоматически будут преобразованы в `RightAny`, если правая сторона функционально определяется столбцами ключа соединения (все строки имеют уникальные значения ключа соединения). [#84010](https://github.com/ClickHouse/ClickHouse/pull/84010) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлен параметр `max_joined_block_size_bytes` в дополнение к `max_joined_block_size_rows` для ограничения потребления памяти при выполнении `JOIN` с «тяжёлыми» столбцами. [#83869](https://github.com/ClickHouse/ClickHouse/pull/83869) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлена новая логика (управляется настройкой `enable_producing_buckets_out_of_order_in_aggregation`, по умолчанию включена), позволяющая отправлять некоторые бакеты в произвольном порядке при агрегации с экономным использованием памяти. Когда слияние некоторых бакетов агрегации занимает значительно больше времени, чем остальных, это улучшает производительность, позволяя инициатору в это время сливать бакеты с более высокими идентификаторами. Недостатком является потенциально более высокое потребление памяти (не должно быть существенным). [#80179](https://github.com/ClickHouse/ClickHouse/pull/80179) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлена настройка `optimize_rewrite_regexp_functions` (по умолчанию включена), которая позволяет оптимизатору переписывать некоторые вызовы `replaceRegexpAll`, `replaceRegexpOne` и `extract` в более простые и эффективные формы при обнаружении определённых шаблонов регулярных выражений. (issue [#81981](https://github.com/ClickHouse/ClickHouse/issues/81981)). [#81992](https://github.com/ClickHouse/ClickHouse/pull/81992) ([Amos Bird](https://github.com/amosbird)).
* Обрабатывать `max_joined_block_rows` вне основного цикла хешевого JOIN. Незначительно улучшена производительность для JOIN с типом ALL. [#83216](https://github.com/ClickHouse/ClickHouse/pull/83216) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Сначала обрабатывать индексы min-max с более высокой детализацией. Закрывает [#75381](https://github.com/ClickHouse/ClickHouse/issues/75381). [#83798](https://github.com/ClickHouse/ClickHouse/pull/83798) ([Maruth Goyal](https://github.com/maruthgoyal)).
* Обеспечить линейное время работы оконных агрегатов с `DISTINCT` и исправить баг в `sumDistinct`. Закрывает [#79792](https://github.com/ClickHouse/ClickHouse/issues/79792). Закрывает [#52253](https://github.com/ClickHouse/ClickHouse/issues/52253). [#79859](https://github.com/ClickHouse/ClickHouse/pull/79859) ([Nihal Z. Miaji](https://github.com/nihalzp)).
* Запросы векторного поиска с использованием индекса векторного сходства выполняются с меньшей задержкой за счёт сокращения операций чтения из хранилища и снижения загрузки ЦП. [#83803](https://github.com/ClickHouse/ClickHouse/pull/83803) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Хеширование рандеву для улучшения локальности кэша при распределении нагрузки между параллельными репликами. [#82511](https://github.com/ClickHouse/ClickHouse/pull/82511) ([Anton Ivashkin](https://github.com/ianton-ru)).
* Реализована функция `addManyDefaults` для комбинаторов `If`, благодаря чему агрегатные функции с комбинаторами `If` работают быстрее. [#83870](https://github.com/ClickHouse/ClickHouse/pull/83870) ([Raúl Marín](https://github.com/Algunenano)).
* Вычислять сериализованный ключ по столбцам при `GROUP BY` по нескольким строковым и числовым столбцам. [#83884](https://github.com/ClickHouse/ClickHouse/pull/83884) ([李扬](https://github.com/taiyang-li)).
* Исключены полные сканирования в случаях, когда анализ индекса приводит к пустым диапазонам при чтении из параллельных реплик. [#84971](https://github.com/ClickHouse/ClickHouse/pull/84971) ([Eduard Karacharov](https://github.com/korowa)).
* Попробуйте использовать `-falign-functions=64`, чтобы сделать тесты производительности более стабильными. [#83920](https://github.com/ClickHouse/ClickHouse/pull/83920) ([Azat Khuzhin](https://github.com/azat)).
* Индекс `bloom filter` теперь используется для условий вида `has([c1, c2, ...], column)`, где `column` имеет тип, отличный от `Array`. Это повышает производительность таких запросов, делая их столь же эффективными, как оператор `IN`. [#83945](https://github.com/ClickHouse/ClickHouse/pull/83945) ([Doron David](https://github.com/dorki)).
* Снижено количество лишних вызовов memcpy в CompressedReadBufferBase::readCompressedData. [#83986](https://github.com/ClickHouse/ClickHouse/pull/83986) ([Raúl Marín](https://github.com/Algunenano)).
* Оптимизирован `largestTriangleThreeBuckets` за счёт удаления временных данных. [#84479](https://github.com/ClickHouse/ClickHouse/pull/84479) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Оптимизировать десериализацию строк за счёт упрощения кода. Закрывает [#38564](https://github.com/ClickHouse/ClickHouse/issues/38564). [#84561](https://github.com/ClickHouse/ClickHouse/pull/84561) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлен расчёт минимального размера задания для параллельных реплик. [#84752](https://github.com/ClickHouse/ClickHouse/pull/84752) ([Nikita Taranov](https://github.com/nickitat)).
* Улучшена производительность применения патч-частей в режиме `Join`. [#85040](https://github.com/ClickHouse/ClickHouse/pull/85040) ([Anton Popov](https://github.com/CurtizJ)).
* Удалён нулевой байт. Закрывает [#85062](https://github.com/ClickHouse/ClickHouse/issues/85062). Было исправлено несколько незначительных ошибок. Функции `structureToProtobufSchema`, `structureToCapnProtoSchema` некорректно добавляли нуль-терминирующий байт и вместо него использовали символ перевода строки. Это приводило к отсутствующему переводу строки на выходе и могло приводить к переполнению буфера при использовании других функций, зависящих от нулевого байта (таких как `logTrace`, `demangle`, `extractURLParameter`, `toStringCutToZero` и `encrypt`/`decrypt`). Макет словаря `regexp_tree` не поддерживал обработку строк с нулевыми байтами. Функция `formatRowNoNewline`, вызываемая с форматом `Values` или с любым другим форматом без перевода строки в конце строк, ошибочно обрезала последний символ вывода. Функция `stem` содержала ошибку в обеспечении безопасности при обработке исключений, которая в крайне редком случае могла приводить к утечке памяти. Функция `initcap` работала неправильно для аргументов типа `FixedString`: она не распознавала начало слова в начале строки, если предыдущая строка в блоке заканчивалась на буквенно-цифровой символ. Исправлена уязвимость в формате Apache `ORC`, которая могла приводить к раскрытию неинициализированной памяти. Изменено поведение функции `replaceRegexpAll` и соответствующего псевдонима `REGEXP_REPLACE`: теперь она может выполнять пустое совпадение в конце строки, даже если предыдущее совпадение обрабатывало всю строку, как в случае `^a*|a*$` или `^|.*` — это соответствует семантике JavaScript, Perl, Python, PHP, Ruby, но отличается от семантики PostgreSQL. Реализация многих функций была упрощена и оптимизирована. Документация для нескольких функций была неверной и теперь исправлена. Имейте в виду, что выходное значение `byteSize` для столбцов типа String и сложных типов, состоящих из столбцов типа String, изменилось (с 9 байт на пустую строку на 8 байт на пустую строку), и это ожидаемое поведение. [#85063](https://github.com/ClickHouse/ClickHouse/pull/85063) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Оптимизировать материализацию констант в случаях, когда она выполняется только для возврата одной строки. [#85071](https://github.com/ClickHouse/ClickHouse/pull/85071) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшена параллельная обработка файлов с использованием бэкенда delta-kernel-rs. [#85642](https://github.com/ClickHouse/ClickHouse/pull/85642) ([Azat Khuzhin](https://github.com/azat)).
* Была добавлена новая настройка enable&#95;add&#95;distinct&#95;to&#95;in&#95;subqueries. При её включении ClickHouse автоматически добавляет DISTINCT к подзапросам в выражениях IN для распределённых запросов. Это может значительно уменьшить размер временных таблиц, передаваемых между шардами, и повысить эффективность использования сети. Примечание: это компромисс — хотя объём сетевого трафика сокращается, на каждом узле требуется дополнительная работа по слиянию (удалению дубликатов). Включайте эту настройку, когда сетевой обмен является узким местом и стоимость слияния приемлема. [#81908](https://github.com/ClickHouse/ClickHouse/pull/81908) ([fhw12345](https://github.com/fhw12345)).
* Снижены накладные расходы на отслеживание потребления памяти запросами для исполняемых пользовательских определяемых функций. [#83929](https://github.com/ClickHouse/ClickHouse/pull/83929) ([Eduard Karacharov](https://github.com/korowa)).
* Реализована внутренняя фильтрация `delta-kernel-rs` (статистика и отсечение разделов) в хранилище `DeltaLake`. [#84006](https://github.com/ClickHouse/ClickHouse/pull/84006) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отключено избыточное отключение пропускающих индексов, зависящих от столбцов, обновляемых «на лету» или с помощью patch parts. Теперь пропускающие индексы не используются только в частях, затронутых «on-the-fly» мутациями или patch parts; ранее эти индексы отключались для всех частей. [#84241](https://github.com/ClickHouse/ClickHouse/pull/84241) ([Anton Popov](https://github.com/CurtizJ)).
* Выделять минимально необходимый объём памяти под `encrypted_buffer` для зашифрованных именованных коллекций. [#84432](https://github.com/ClickHouse/ClickHouse/pull/84432) ([Pablo Marcos](https://github.com/pamarcos)).
* Улучшена поддержка индексов bloom filter (обычных, `ngram` и `token`) для использования в случаях, когда первый аргумент — константный массив (множество), а второй — индексируемый столбец (подмножество), что обеспечивает более эффективное выполнение запросов. [#84700](https://github.com/ClickHouse/ClickHouse/pull/84700) ([Doron David](https://github.com/dorki)).
* Снизить конкуренцию за блокировку хранилища в Keeper. [#84732](https://github.com/ClickHouse/ClickHouse/pull/84732) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена отсутствовавшая поддержка `read_in_order_use_virtual_row` для `WHERE`. Это позволяет пропускать чтение дополнительных кусков данных для запросов с фильтрами, которые не были полностью перенесены в `PREWHERE`. [#84835](https://github.com/ClickHouse/ClickHouse/pull/84835) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Позволяет асинхронно обходить объекты в таблице Iceberg без явного хранения объектов для каждого файла данных. [#85369](https://github.com/ClickHouse/ClickHouse/pull/85369) ([Daniil Ivanik](https://github.com/divanik)).
* Выполнять некоррелированный `EXISTS` как скалярный подзапрос. Это позволяет использовать кеш скалярных подзапросов и выполнять свёртку констант результата, что полезно для индексов. Для совместимости добавлена новая настройка `execute_exists_as_scalar_subquery=1`. [#85481](https://github.com/ClickHouse/ClickHouse/pull/85481) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).





#### Улучшение

* Добавлены настройки `database_replicated`, определяющие значения по умолчанию для DatabaseReplicatedSettings. Если настройка не указана в запросе создания Replicated DB, используется значение из этой настройки. [#85127](https://github.com/ClickHouse/ClickHouse/pull/85127) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Сделали столбцы таблицы в веб-интерфейсе (play) с возможностью изменения ширины. [#84012](https://github.com/ClickHouse/ClickHouse/pull/84012) ([Doron David](https://github.com/dorki)).
* Добавлена поддержка сжатого файла `.metadata.json` через настройку `iceberg_metadata_compression_method`. Поддерживаются все методы сжатия ClickHouse. Это закрывает [#84895](https://github.com/ClickHouse/ClickHouse/issues/84895). [#85196](https://github.com/ClickHouse/ClickHouse/pull/85196) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Показывать количество диапазонов, которые будут прочитаны, в выводе `EXPLAIN indexes = 1`. [#79938](https://github.com/ClickHouse/ClickHouse/pull/79938) ([Christoph Wurm](https://github.com/cwurm)).
* Добавлены настройки для задания размера блока сжатия ORC и обновлено значение по умолчанию с 64 KB до 256 KB для согласованности со Spark и Hive. [#80602](https://github.com/ClickHouse/ClickHouse/pull/80602) ([李扬](https://github.com/taiyang-li)).
* Добавлен файл `columns_substreams.txt` в Wide-часть для отслеживания всех подпотоков, хранящихся в части. Это помогает отслеживать динамические потоки в типах JSON и Dynamic и таким образом избегать чтения выборки этих столбцов для получения списка динамических потоков (например, для расчёта размеров столбцов). Также теперь все динамические потоки отражаются в `system.parts_columns`. [#81091](https://github.com/ClickHouse/ClickHouse/pull/81091) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлен флаг CLI --show&#95;secrets для clickhouse format, который по умолчанию скрывает конфиденциальные данные. [#81524](https://github.com/ClickHouse/ClickHouse/pull/81524) ([Nikolai Ryzhov](https://github.com/Dolaxom)).
* Запросы чтения и записи S3 ограничиваются на уровне HTTP-сокета (а не целых S3‑запросов), чтобы избежать проблем с ограничениями `max_remote_read_network_bandwidth_for_server` и `max_remote_write_network_bandwidth_for_server`. [#81837](https://github.com/ClickHouse/ClickHouse/pull/81837) ([Sergei Trifonov](https://github.com/serxa)).
* Разрешено смешивать разные правила сортировки (сопоставления строк) для одного и того же столбца в разных окнах (для оконных функций). [#82877](https://github.com/ClickHouse/ClickHouse/pull/82877) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Добавлен инструмент для моделирования, визуализации и сравнения селекторов слияний. [#71496](https://github.com/ClickHouse/ClickHouse/pull/71496) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена поддержка табличных функций `remote*` с параллельными репликами, если кластер указан в аргументе `address_expression`. Также исправлена ошибка [#73295](https://github.com/ClickHouse/ClickHouse/issues/73295). [#82904](https://github.com/ClickHouse/ClickHouse/pull/82904) ([Igor Nikonov](https://github.com/devcrafter)).
* Все сообщения журнала, связанные с записью файлов резервных копий, переведены на уровень TRACE. [#82907](https://github.com/ClickHouse/ClickHouse/pull/82907) ([Hans Krutzer](https://github.com/hkrutzer)).
* Пользовательские функции с необычными именами и кодеками могут непоследовательно форматироваться SQL-форматтером. Это закрывает [#83092](https://github.com/ClickHouse/ClickHouse/issues/83092). [#83644](https://github.com/ClickHouse/ClickHouse/pull/83644) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Теперь пользователи могут использовать типы Time и Time64 внутри JSON-типа. [#83784](https://github.com/ClickHouse/ClickHouse/pull/83784) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* `JOIN` с параллельными репликами теперь использует логический шаг объединения. В случае любых проблем с запросами `JOIN`, использующими параллельные реплики, попробуйте выполнить `SET query_plan_use_new_logical_join_step=0` и сообщите о проблеме. [#83801](https://github.com/ClickHouse/ClickHouse/pull/83801) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлена совместимость функции `cluster_function_process_archive_on_multiple_nodes`. [#83968](https://github.com/ClickHouse/ClickHouse/pull/83968) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка изменения настроек вставки в материализованные представления на уровне таблицы `S3Queue`. Добавлены новые настройки уровня `S3Queue`: `min_insert_block_size_rows_for_materialized_views` и `min_insert_block_size_bytes_for_materialized_views`. По умолчанию используются настройки на уровне профиля, а настройки уровня `S3Queue` их переопределяют. [#83971](https://github.com/ClickHouse/ClickHouse/pull/83971) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлено событие профилирования `MutationAffectedRowsUpperBound`, которое показывает количество затронутых строк в мутации (например, общее число строк, удовлетворяющих условию в запросе `ALTER UPDATE` или `ALTER DELETE`). [#83978](https://github.com/ClickHouse/ClickHouse/pull/83978) ([Anton Popov](https://github.com/CurtizJ)).
* Использовать информацию из cgroup (если применимо, т.е. доступны `memory_worker_use_cgroup` и cgroups) для корректировки трекера памяти (`memory_worker_correct_memory_tracker`). [#83981](https://github.com/ClickHouse/ClickHouse/pull/83981) ([Azat Khuzhin](https://github.com/azat)).
* MongoDB: неявное преобразование строк в числовые типы. Раньше, если из источника MongoDB для числового столбца в таблице ClickHouse поступало строковое значение, возникало исключение. Теперь движок пытается автоматически распарсить числовое значение из строки. Закрывает [#81167](https://github.com/ClickHouse/ClickHouse/issues/81167). [#84069](https://github.com/ClickHouse/ClickHouse/pull/84069) ([Kirill Nikiforov](https://github.com/allmazz)).
* Подсветка групп цифр в форматах `Pretty` для чисел типа `Nullable`. [#84070](https://github.com/ClickHouse/ClickHouse/pull/84070) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Dashboard: всплывающая подсказка больше не будет выходить за верхнюю границу контейнера. [#84072](https://github.com/ClickHouse/ClickHouse/pull/84072) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Немного более аккуратно выглядящие точки на панели мониторинга. [#84074](https://github.com/ClickHouse/ClickHouse/pull/84074) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* У Dashboard теперь немного лучший фавикон. [#84076](https://github.com/ClickHouse/ClickHouse/pull/84076) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Web UI: Разрешить браузерам сохранять пароль. Также будут запоминаться значения URL. [#84087](https://github.com/ClickHouse/ClickHouse/pull/84087) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка применения дополнительного ACL к отдельным узлам Keeper с помощью конфигурации `apply_to_children`. [#84137](https://github.com/ClickHouse/ClickHouse/pull/84137) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено использование сериализации дискриминаторов Variant в «компактном» формате в MergeTree. Ранее она не использовалась в некоторых случаях, когда могла быть использована. [#84141](https://github.com/ClickHouse/ClickHouse/pull/84141) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена серверная настройка `logs_to_keep` в настройки реплицируемых баз данных, позволяющая изменять значение параметра `logs_to_keep` по умолчанию для реплицируемых баз данных. Меньшие значения уменьшают количество ZNodes (особенно если баз данных много), тогда как большие значения позволяют отсутствующей реплике догнать состояние кластера после более длительного периода времени. [#84183](https://github.com/ClickHouse/ClickHouse/pull/84183) ([Alexey Khatskevich](https://github.com/Khatskevich)).
* Добавлена настройка `json_type_escape_dots_in_keys` для экранирования точек в ключах JSON при разборе типа JSON. По умолчанию настройка отключена. [#84207](https://github.com/ClickHouse/ClickHouse/pull/84207) ([Pavel Kruglov](https://github.com/Avogar)).
* Перед проверкой EOF проверять, отменено ли соединение, чтобы предотвратить чтение из закрытого соединения. Исправляет [#83893](https://github.com/ClickHouse/ClickHouse/issues/83893). [#84227](https://github.com/ClickHouse/ClickHouse/pull/84227) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Немного улучшены цвета выделения текста в Web UI. Разница заметна главным образом для выделенных ячеек таблицы в тёмном режиме. В предыдущих версиях контраст между текстом и фоном выделения был недостаточным. [#84258](https://github.com/ClickHouse/ClickHouse/pull/84258) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшена обработка завершения работы сервера для клиентских подключений за счёт упрощения внутренних проверок. [#84312](https://github.com/ClickHouse/ClickHouse/pull/84312) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Добавлена настройка `delta_lake_enable_expression_visitor_logging` для отключения логов обходчика выражений, так как они могут быть слишком подробными даже для тестового уровня логирования при отладке. [#84315](https://github.com/ClickHouse/ClickHouse/pull/84315) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Метрики на уровне cgroup и на уровне всей системы теперь выводятся вместе. Метрики на уровне cgroup имеют имена `CGroup&lt;Metric&gt;`, а метрики на уровне ОС (собираемые из procfs) имеют имена `OS&lt;Metric&gt;`. [#84317](https://github.com/ClickHouse/ClickHouse/pull/84317) ([Nikita Taranov](https://github.com/nickitat)).
* Немного улучшенные графики в Web UI. Не намного, но всё же лучше. [#84326](https://github.com/ClickHouse/ClickHouse/pull/84326) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Изменено значение по умолчанию настройки реплицируемой базы данных `max_retries_before_automatic_recovery` на 10, чтобы в некоторых случаях ускорить восстановление. [#84369](https://github.com/ClickHouse/ClickHouse/pull/84369) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлено форматирование `CREATE USER` с параметрами запроса (например, `CREATE USER {username:Identifier} IDENTIFIED WITH no_password`). [#84376](https://github.com/ClickHouse/ClickHouse/pull/84376) ([Azat Khuzhin](https://github.com/azat)).
* Добавлены настройки `backup_restore_s3_retry_initial_backoff_ms`, `backup_restore_s3_retry_max_backoff_ms`, `backup_restore_s3_retry_jitter_factor` для настройки стратегии `backoff` при повторных попытках S3, используемой во время операций резервного копирования и восстановления. [#84421](https://github.com/ClickHouse/ClickHouse/pull/84421) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправление упорядоченного режима S3Queue: досрочное завершение работы при вызове shutdown. [#84463](https://github.com/ClickHouse/ClickHouse/pull/84463) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Поддержка записи в Iceberg с чтением через pyiceberg. [#84466](https://github.com/ClickHouse/ClickHouse/pull/84466) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Разрешено приведение типов значений множества при проталкивании фильтров `IN` / `GLOBAL IN` к первичным ключам хранилищ KeyValue (например, EmbeddedRocksDB, KeeperMap). [#84515](https://github.com/ClickHouse/ClickHouse/pull/84515) ([Eduard Karacharov](https://github.com/korowa)).
* Обновлён chdig до версии [25.7.1](https://github.com/azat/chdig/releases/tag/v25.7.1). [#84521](https://github.com/ClickHouse/ClickHouse/pull/84521) ([Azat Khuzhin](https://github.com/azat)).
* Низкоуровневые ошибки во время выполнения UDF теперь приводят к ошибке с кодом `UDF_EXECUTION_FAILED`, тогда как ранее могли возвращаться разные коды ошибок. [#84547](https://github.com/ClickHouse/ClickHouse/pull/84547) ([Xu Jia](https://github.com/XuJia0210)).
* Добавлена команда `get_acl` в KeeperClient. [#84641](https://github.com/ClickHouse/ClickHouse/pull/84641) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавляет версию снапшота для движков таблиц data lake. [#84659](https://github.com/ClickHouse/ClickHouse/pull/84659) ([Pete Hampton](https://github.com/pjhampton)).
* Добавлена размерная метрика для `ConcurrentBoundedQueue` с измерениями по типу очереди (то есть для чего предназначена очередь) и идентификатору очереди (то есть случайно сгенерированному идентификатору текущего экземпляра очереди). [#84675](https://github.com/ClickHouse/ClickHouse/pull/84675) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* В таблице `system.columns` теперь имеется псевдоним `column` для существующего столбца `name`. [#84695](https://github.com/ClickHouse/ClickHouse/pull/84695) ([Yunchi Pang](https://github.com/yunchipang)).
* Новая настройка MergeTree `search_orphaned_parts_drives` для ограничения области поиска кусков, например по дискам с локальными метаданными. [#84710](https://github.com/ClickHouse/ClickHouse/pull/84710) ([Ilya Golshtein](https://github.com/ilejn)).
* Добавлен 4LW-запрос `lgrq` в Keeper для переключения логирования полученных запросов. [#84719](https://github.com/ClickHouse/ClickHouse/pull/84719) ([Antonio Andelic](https://github.com/antonio2368)).
* Сопоставлять заголовки `external auth forward_headers` без учета регистра. [#84737](https://github.com/ClickHouse/ClickHouse/pull/84737) ([ingodwerust](https://github.com/ingodwerust)).
* Инструмент `encrypt_decrypt` теперь поддерживает шифрованные подключения к ZooKeeper. [#84764](https://github.com/ClickHouse/ClickHouse/pull/84764) ([Roman Vasin](https://github.com/rvasin)).
* Добавлен столбец с форматной строкой в `system.errors`. Этот столбец нужен для группировки по одному и тому же типу ошибки в правилах оповещений. [#84776](https://github.com/ClickHouse/ClickHouse/pull/84776) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Обновлён `clickhouse-format`, чтобы принимать `--highlight` как синоним `--hilite`. - Обновлён `clickhouse-client`, чтобы принимать `--hilite` как синоним `--highlight`. - Обновлена документация `clickhouse-format`, чтобы отразить это изменение. [#84806](https://github.com/ClickHouse/ClickHouse/pull/84806) ([Rishabh Bhardwaj](https://github.com/rishabh1815769)).
* Исправлено чтение Iceberg по идентификаторам полей для сложных типов. [#84821](https://github.com/ClickHouse/ClickHouse/pull/84821) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Добавлена новая настройка `backup_slow_all_threads_after_retryable_s3_error`, уменьшающая нагрузку на S3 во время «штормов» повторных попыток, вызванных ошибками типа `SlowDown`, за счёт замедления всех потоков после возникновения одной повторяемой ошибки. [#84854](https://github.com/ClickHouse/ClickHouse/pull/84854) ([Julia Kartseva](https://github.com/jkartseva)).
* Пропускается создание и переименование старой временной таблицы для не-append DDL `RMV` в реплицируемых БД. [#84858](https://github.com/ClickHouse/ClickHouse/pull/84858) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Ограничен размер кеша записей журнала Keeper по числу записей с помощью `keeper_server.coordination_settings.latest_logs_cache_entry_count_threshold` и `keeper_server.coordination_settings.commit_logs_cache_entry_count_threshold`. [#84877](https://github.com/ClickHouse/ClickHouse/pull/84877) ([Antonio Andelic](https://github.com/antonio2368)).
* Разрешено использование `simdjson` на неподдерживаемых архитектурах (раньше это приводило к ошибкам `CANNOT_ALLOCATE_MEMORY`). [#84966](https://github.com/ClickHouse/ClickHouse/pull/84966) ([Azat Khuzhin](https://github.com/azat)).
* Асинхронное логирование: сделать лимиты настраиваемыми и добавить средства интроспекции. [#85105](https://github.com/ClickHouse/ClickHouse/pull/85105) ([Raúl Marín](https://github.com/Algunenano)).
* Все удалённые объекты теперь собираются для выполнения одной операции удаления в объектном хранилище. [#85316](https://github.com/ClickHouse/ClickHouse/pull/85316) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Текущая реализация positional delete-файлов в Iceberg хранит все данные в оперативной памяти. Это может быть довольно затратно, если positional delete-файлы большие, что нередко бывает. Моя реализация держит в оперативной памяти только последнюю row-group Parquet delete-файлов, что значительно дешевле. [#85329](https://github.com/ClickHouse/ClickHouse/pull/85329) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* chdig: устранены артефакты, оставшиеся на экране, исправлен сбой после редактирования запроса в редакторе, добавлен поиск `editor` в `PATH`, обновление до [25.8.1](https://github.com/azat/chdig/releases/tag/v25.8.1). [#85341](https://github.com/ClickHouse/ClickHouse/pull/85341) ([Azat Khuzhin](https://github.com/azat)).
* Добавлен отсутствующий параметр `partition_columns_in_data_file` в конфигурацию Azure. [#85373](https://github.com/ClickHouse/ClickHouse/pull/85373) ([Arthur Passos](https://github.com/arthurpassos)).
* Разрешен нулевой шаг в функциях `timeSeries*ToGrid`. Это часть [#75036](https://github.com/ClickHouse/ClickHouse/pull/75036). [#85390](https://github.com/ClickHouse/ClickHouse/pull/85390) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлен флаг show&#95;data&#95;lake&#95;catalogs&#95;in&#95;system&#95;tables для управления добавлением таблиц из data lake в system.tables. Исправляет [#85384](https://github.com/ClickHouse/ClickHouse/issues/85384). [#85411](https://github.com/ClickHouse/ClickHouse/pull/85411) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Добавлена поддержка подстановки макросов в `remote_fs_zero_copy_zookeeper_path`. [#85437](https://github.com/ClickHouse/ClickHouse/pull/85437) ([Mikhail Koviazin](https://github.com/mkmkme)).
* ИИ в clickhouse-client будет выглядеть чуть лучше. [#85447](https://github.com/ClickHouse/ClickHouse/pull/85447) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* По умолчанию включить trace&#95;log.symbolize для старых развёртываний. [#85456](https://github.com/ClickHouse/ClickHouse/pull/85456) ([Azat Khuzhin](https://github.com/azat)).
* Расширена поддержка большего числа вариантов использования составных идентификаторов. В частности, улучшена совместимость `ARRAY JOIN` со старым анализатором. Добавлена новая настройка `analyzer_compatibility_allow_compound_identifiers_in_unflatten_nested` для сохранения прежнего поведения. [#85492](https://github.com/ClickHouse/ClickHouse/pull/85492) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Игнорируйте UNKNOWN&#95;DATABASE при получении размеров столбцов таблиц для system.columns. [#85632](https://github.com/ClickHouse/ClickHouse/pull/85632) ([Azat Khuzhin](https://github.com/azat)).
* Добавлено ограничение (настройка таблицы `max_uncompressed_bytes_in_patches`) на общий объём несжатых данных в патч-частях. Оно предотвращает существенные замедления запросов SELECT после легковесных обновлений и возможное злоупотребление легковесными обновлениями. [#85641](https://github.com/ClickHouse/ClickHouse/pull/85641) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлен столбец `parameter` в `system.grants`, позволяющий определять тип источника для `GRANT READ/WRITE` и движок таблицы для `GRANT TABLE ENGINE`. [#85643](https://github.com/ClickHouse/ClickHouse/pull/85643) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Исправлен разбор завершающей запятой в списке столбцов в запросе CREATE DICTIONARY после столбца с параметрами, например Decimal(8). Закрывает [#85586](https://github.com/ClickHouse/ClickHouse/issues/85586). [#85653](https://github.com/ClickHouse/ClickHouse/pull/85653) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена поддержка внутренних массивов для функции `nested`. [#85719](https://github.com/ClickHouse/ClickHouse/pull/85719) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Все выделения памяти, выполняемые внешними библиотеками, теперь видны трекеру памяти ClickHouse и корректно учитываются. Это может привести к более «высокому» отображаемому использованию памяти для некоторых запросов или к ошибкам `MEMORY_LIMIT_EXCEEDED`. [#84082](https://github.com/ClickHouse/ClickHouse/pull/84082) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).



#### Исправление ошибки (некорректное поведение, заметное пользователю, в официальном стабильном релизе)



* Этот PR исправляет разрешение метаданных при выполнении запросов к таблицам Iceberg через REST-каталог. ... [#80562](https://github.com/ClickHouse/ClickHouse/pull/80562) ([Saurabh Kumar Ojha](https://github.com/saurabhojha)).
* Исправлена работа markReplicasActive в DDLWorker и DatabaseReplicatedDDLWorker. [#81395](https://github.com/ClickHouse/ClickHouse/pull/81395) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлен откат динамического столбца при ошибке парсинга. [#82169](https://github.com/ClickHouse/ClickHouse/pull/82169) ([Pavel Kruglov](https://github.com/Avogar)).
* Функция `trim`, вызванная со всеми константными входными аргументами, теперь возвращает константную выходную строку. (Ошибка [#78796](https://github.com/ClickHouse/ClickHouse/issues/78796)). [#82900](https://github.com/ClickHouse/ClickHouse/pull/82900) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена логическая ошибка с дублирующимися подзапросами при включённой настройке `optimize_syntax_fuse_functions`, закрыт [#75511](https://github.com/ClickHouse/ClickHouse/issues/75511). [#83300](https://github.com/ClickHouse/ClickHouse/pull/83300) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлен некорректный результат выполнения запросов с предложением `WHERE ... IN (<subquery>)` при включённом кеше условий запроса (настройка `use_query_condition_cache`). [#83445](https://github.com/ClickHouse/ClickHouse/pull/83445) ([LB7666](https://github.com/acking-you)).
* Ранее для использования функции `gcs` не требовались никакие права доступа. Теперь при её использовании будет проверяться наличие права `GRANT READ ON S3`. Закрывает [#70567](https://github.com/ClickHouse/ClickHouse/issues/70567). [#83503](https://github.com/ClickHouse/ClickHouse/pull/83503) ([pufit](https://github.com/pufit)).
* Пропуск недоступных узлов при выполнении `INSERT SELECT` из `s3Cluster()` в реплицированный `MergeTree`. [#83676](https://github.com/ClickHouse/ClickHouse/pull/83676) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлена запись с добавлением (в MergeTree, используемом для экспериментальных транзакций) с типами метаданных `plain_rewritable`/`plain`, которые ранее просто игнорировались. [#83695](https://github.com/ClickHouse/ClickHouse/pull/83695) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Скрывать данные аутентификации в реестре схем Avro, чтобы они не отображались пользователю и не попадали в журналы. [#83713](https://github.com/ClickHouse/ClickHouse/pull/83713) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлена проблема, при которой, если таблица MergeTree создаётся с `add_minmax_index_for_numeric_columns=1` или `add_minmax_index_for_string_columns=1`, индекс впоследствии материализуется во время операции ALTER и мешает базе данных Replicated корректно инициализироваться на новой реплике. [#83751](https://github.com/ClickHouse/ClickHouse/pull/83751) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлен паркетный writer, выводивший некорректную статистику (min/max) для типов Decimal. [#83754](https://github.com/ClickHouse/ClickHouse/pull/83754) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена сортировка значений NaN для типа `LowCardinality(Float32|Float64|BFloat16)`. [#83786](https://github.com/ClickHouse/ClickHouse/pull/83786) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* При восстановлении из резервной копии пользователь-definer может не быть включён в резервную копию, из‑за чего вся резервная копия окажется некорректной. Чтобы это исправить, мы откладываем проверку прав при создании целевой таблицы во время восстановления и выполняем её только во время исполнения запроса. [#83818](https://github.com/ClickHouse/ClickHouse/pull/83818) ([pufit](https://github.com/pufit)).
* Исправлена ошибка в клиенте, возникавшая из‑за того, что соединение оставалось в разорванном состоянии после неудачного INSERT. [#83842](https://github.com/ClickHouse/ClickHouse/pull/83842) ([Azat Khuzhin](https://github.com/azat)).
* Разрешено обращаться к любой таблице в аргументе `view(...)` табличной функции `remote` при включённом анализаторе. Исправляет [#78717](https://github.com/ClickHouse/ClickHouse/issues/78717). Исправляет [#79377](https://github.com/ClickHouse/ClickHouse/issues/79377). [#83844](https://github.com/ClickHouse/ClickHouse/pull/83844) ([Dmitry Novik](https://github.com/novikd)).
* Вызов onprogress в jsoneachrowwithprogress теперь синхронизирован с финализацией. [#83879](https://github.com/ClickHouse/ClickHouse/pull/83879) ([Sema Checherinda](https://github.com/CheSema)).
* Это закрывает задачу [#81303](https://github.com/ClickHouse/ClickHouse/issues/81303). [#83892](https://github.com/ClickHouse/ClickHouse/pull/83892) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Исправлены функции colorSRGBToOKLCH/colorOKLCHToSRGB при совместном использовании константных и неконстантных аргументов. [#83906](https://github.com/ClickHouse/ClickHouse/pull/83906) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена запись JSON-путей со значениями NULL в формате RowBinary. [#83923](https://github.com/ClickHouse/ClickHouse/pull/83923) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено переполнение больших значений (&gt;2106-02-07) при приведении типа Date к DateTime64. [#83982](https://github.com/ClickHouse/ClickHouse/pull/83982) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Всегда применять `filesystem_prefetches_limit` (не только в `MergeTreePrefetchedReadPool`). [#83999](https://github.com/ClickHouse/ClickHouse/pull/83999) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена редкая ошибка, при которой запрос `MATERIALIZE COLUMN` мог приводить к появлению неожиданных файлов в `checksums.txt` и в итоге — к переходу частей данных в состояние detached. [#84007](https://github.com/ClickHouse/ClickHouse/pull/84007) ([alesapin](https://github.com/alesapin)).
* Исправлена логическая ошибка `Expected single dictionary argument for function` при выполнении JOIN по условию неравенства, когда один из столбцов имеет тип `LowCardinality`, а другой является константой. Закрывает [#81779](https://github.com/ClickHouse/ClickHouse/issues/81779). [#84019](https://github.com/ClickHouse/ClickHouse/pull/84019) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка, приводившая к сбою `clickhouse client` при использовании в интерактивном режиме с подсветкой синтаксиса. [#84025](https://github.com/ClickHouse/ClickHouse/pull/84025) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлены некорректные результаты при использовании кэша условий запроса совместно с рекурсивными CTE (issue [#81506](https://github.com/ClickHouse/ClickHouse/issues/81506)). [#84026](https://github.com/ClickHouse/ClickHouse/pull/84026) ([zhongyuankai](https://github.com/zhongyuankai)).
* Корректная обработка исключений при периодическом обновлении частей. [#84083](https://github.com/ClickHouse/ClickHouse/pull/84083) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено объединение фильтра с условием JOIN в случаях, когда операнды равенства имеют разные типы или ссылаются на константы. Исправляет [#83432](https://github.com/ClickHouse/ClickHouse/issues/83432). [#84145](https://github.com/ClickHouse/ClickHouse/pull/84145) ([Dmitry Novik](https://github.com/novikd)).
* Исправлен редкий сбой ClickHouse, возникавший, когда у таблицы есть projection, задано `lightweight_mutation_projection_mode = 'rebuild'`, а пользователь выполняет lightweight delete, который удаляет ВСЕ строки из любого блока таблицы. [#84158](https://github.com/ClickHouse/ClickHouse/pull/84158) ([alesapin](https://github.com/alesapin)).
* Исправлена взаимоблокировка, вызванная фоновым потоком проверки отмены. [#84203](https://github.com/ClickHouse/ClickHouse/pull/84203) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлен бесконечный рекурсивный разбор некорректных определений `WINDOW`. Исправляет [#83131](https://github.com/ClickHouse/ClickHouse/issues/83131). [#84242](https://github.com/ClickHouse/ClickHouse/pull/84242) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена ошибка, приводившая к некорректному кодированию и декодированию Bech32. Изначально ошибка не была обнаружена, поскольку онлайн-реализация алгоритма, использовавшаяся для тестирования, имела ту же проблему. [#84257](https://github.com/ClickHouse/ClickHouse/pull/84257) ([George Larionov](https://github.com/george-larionov)).
* Исправлена некорректная обработка пустых кортежей в функции `array()`. Это исправляет [#84202](https://github.com/ClickHouse/ClickHouse/issues/84202). [#84297](https://github.com/ClickHouse/ClickHouse/pull/84297) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка `LOGICAL_ERROR` для запросов с параллельными репликами и несколькими INNER JOIN, за которыми следует RIGHT JOIN. Не используйте параллельные реплики для таких запросов. [#84299](https://github.com/ClickHouse/ClickHouse/pull/84299) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Ранее индексы `set` не учитывали столбцы `Nullable` при проверке, проходят ли гранулы через фильтр (issue [#75485](https://github.com/ClickHouse/ClickHouse/issues/75485)). [#84305](https://github.com/ClickHouse/ClickHouse/pull/84305) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Теперь ClickHouse читает таблицы из Glue Catalog, когда тип таблицы указан в нижнем регистре. [#84316](https://github.com/ClickHouse/ClickHouse/pull/84316) ([alesapin](https://github.com/alesapin)).
* Не пытайтесь заменять табличные функции их кластерными альтернативами при наличии `JOIN` или подзапроса. [#84335](https://github.com/ClickHouse/ClickHouse/pull/84335) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлено использование логгера в `IAccessStorage`. [#84365](https://github.com/ClickHouse/ClickHouse/pull/84365) ([Konstantin Bogdanов](https://github.com/thevar1able)).
* Исправлена логическая ошибка в лёгких обновлениях, которые изменяют все столбцы в таблице. [#84380](https://github.com/ClickHouse/ClickHouse/pull/84380) ([Anton Popov](https://github.com/CurtizJ)).
* Кодек `DoubleDelta` теперь может применяться только к столбцам числовых типов. В частности, столбцы типа `FixedString` больше не могут сжиматься с помощью `DoubleDelta` (исправление [#80220](https://github.com/ClickHouse/ClickHouse/issues/80220)). [#84383](https://github.com/ClickHouse/ClickHouse/pull/84383) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
* Сравнение со значением `nan` выполнялось с использованием некорректных диапазонов при вычислении индекса `MinMax`. [#84386](https://github.com/ClickHouse/ClickHouse/pull/84386) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Исправлено чтение столбца типа Variant с ленивой материализацией. [#84400](https://github.com/ClickHouse/ClickHouse/pull/84400) ([Pavel Kruglov](https://github.com/Avogar)).
* Сделать `zoutofmemory` аппаратной ошибкой, иначе будет выбрасываться логическая ошибка. См. [https://github.com/clickhouse/clickhouse-core-incidents/issues/877](https://github.com/clickhouse/clickhouse-core-incidents/issues/877). [#84420](https://github.com/ClickHouse/ClickHouse/pull/84420) ([Han Fei](https://github.com/hanfei1991)).
* Исправлено падение сервера, возникавшее, когда пользователь, созданный с `no_password`, пытался войти в систему после того, как настройка сервера `allow_no_password` была изменена на 0. [#84426](https://github.com/ClickHouse/ClickHouse/pull/84426) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Исправлена проблема с нарушением порядка записи в журнал изменений Keeper. Ранее могли существовать незавершённые операции записи в журнал изменений, а откат мог приводить к конкурентному изменению целевого файла. Это приводило к неконсистентным журналам и возможной потере данных. [#84434](https://github.com/ClickHouse/ClickHouse/pull/84434) ([Antonio Andelic](https://github.com/antonio2368)).
* Теперь, если все TTL удалены из таблицы, MergeTree не будет выполнять никаких действий, связанных с TTL. [#84441](https://github.com/ClickHouse/ClickHouse/pull/84441) ([alesapin](https://github.com/alesapin)).
* Была разрешена параллельная распределённая операция `INSERT SELECT` с `LIMIT`, что некорректно и приводит к дублированию данных в целевой таблице. [#84477](https://github.com/ClickHouse/ClickHouse/pull/84477) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлено отсечение файлов по виртуальному столбцу в дата-лейках. [#84520](https://github.com/ClickHouse/ClickHouse/pull/84520) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлены утечки в Keeper с хранилищем RocksDB (итераторы не разрушались). [#84523](https://github.com/ClickHouse/ClickHouse/pull/84523) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема, из-за которой `ALTER MODIFY ORDER BY` не проверял наличие TTL-столбцов в ключах сортировки. Теперь TTL-столбцы корректно отклоняются при использовании в клаузах `ORDER BY` во время операций `ALTER`, что предотвращает потенциальное повреждение таблиц. [#84536](https://github.com/ClickHouse/ClickHouse/pull/84536) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Изменено значение параметра `allow_experimental_delta_kernel_rs` до версии 25.5 на `false` для обеспечения совместимости. [#84587](https://github.com/ClickHouse/ClickHouse/pull/84587) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Перестаёт брать схему из manifest-файлов и вместо этого хранит отдельные соответствующие схемы для каждого snapshot. Определяет подходящую схему для каждого файла данных на основе соответствующего ему snapshot. Предыдущее поведение нарушало спецификацию Iceberg для записей в manifest-файлах со статусом existing. [#84588](https://github.com/ClickHouse/ClickHouse/pull/84588) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлена проблема, из-за которой настройка Keeper `rotate_log_storage_interval = 0` приводила к аварийному завершению работы ClickHouse. (issue [#83975](https://github.com/ClickHouse/ClickHouse/issues/83975)). [#84637](https://github.com/ClickHouse/ClickHouse/pull/84637) ([George Larionov](https://github.com/george-larionov)).
* Исправлена логическая ошибка в S3Queue «Table is already registered». Закрывает [#84433](https://github.com/ClickHouse/ClickHouse/issues/84433). Поломалось после [https://github.com/ClickHouse/ClickHouse/pull/83530](https://github.com/ClickHouse/ClickHouse/pull/83530). [#84677](https://github.com/ClickHouse/ClickHouse/pull/84677) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Блокировать &#39;mutex&#39; при получении zookeeper из &#39;view&#39; в RefreshTask. [#84699](https://github.com/ClickHouse/ClickHouse/pull/84699) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлена ошибка `CORRUPTED_DATA`, возникавшая при использовании lazy-столбцов с внешней сортировкой. [#84738](https://github.com/ClickHouse/ClickHouse/pull/84738) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлено отсечение столбцов при использовании `delta-kernel` в хранилище `DeltaLake`. Закрывает [#84543](https://github.com/ClickHouse/ClickHouse/issues/84543). [#84745](https://github.com/ClickHouse/ClickHouse/pull/84745) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Обновление учетных данных в delta-kernel в хранилище DeltaLake. [#84751](https://github.com/ClickHouse/ClickHouse/pull/84751) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен запуск лишних внутренних бэкапов после проблем с подключением. [#84755](https://github.com/ClickHouse/ClickHouse/pull/84755) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена проблема, из-за которой запрос к отложенному удалённому источнику мог приводить к выходу индекса вектора за пределы допустимого диапазона. [#84820](https://github.com/ClickHouse/ClickHouse/pull/84820) ([George Larionov](https://github.com/george-larionov)).
* Токенизаторы `ngram` и `no_op` больше не приводят к сбою (экспериментального) текстового индекса при пустых входных токенах. [#84849](https://github.com/ClickHouse/ClickHouse/pull/84849) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена работа легковесных обновлений для таблиц с движками `ReplacingMergeTree` и `CollapsingMergeTree`. [#84851](https://github.com/ClickHouse/ClickHouse/pull/84851) ([Anton Popov](https://github.com/CurtizJ)).
* Корректно сохранять все настройки в метаданных для таблиц с движком object queue. [#84860](https://github.com/ClickHouse/ClickHouse/pull/84860) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлен общий счётчик watch-событий, возвращаемый Keeper. [#84890](https://github.com/ClickHouse/ClickHouse/pull/84890) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлены легковесные обновления для таблиц с движком `ReplicatedMergeTree`, созданных на серверах с версией ниже 25.7. [#84933](https://github.com/ClickHouse/ClickHouse/pull/84933) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена работа легковесных обновлений для таблиц с нереплицируемым движком `MergeTree` после выполнения запроса `ALTER TABLE ... REPLACE PARTITION`. [#84941](https://github.com/ClickHouse/ClickHouse/pull/84941) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена генерация имён столбцов для булевых литералов: теперь используются «true»/«false» вместо «1»/«0», что предотвращает конфликты имён столбцов между булевыми и целочисленными литералами в запросах. [#84945](https://github.com/ClickHouse/ClickHouse/pull/84945) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Исправлено некорректное отслеживание памяти в фоновом пуле планировщика и исполнителя. [#84946](https://github.com/ClickHouse/ClickHouse/pull/84946) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены потенциальные проблемы с некорректной сортировкой в движке таблиц Merge. [#85025](https://github.com/ClickHouse/ClickHouse/pull/85025) ([Xiaozhe Yu](https://github.com/wudidapaopao)).
* Реализованы недостающие API для DiskEncrypted. [#85028](https://github.com/ClickHouse/ClickHouse/pull/85028) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена проверка на использование коррелированного подзапроса в распределённом контексте, чтобы избежать сбоя. Исправляет [#82205](https://github.com/ClickHouse/ClickHouse/issues/82205). [#85030](https://github.com/ClickHouse/ClickHouse/pull/85030) ([Dmitry Novik](https://github.com/novikd)).
* Теперь Iceberg не пытается кэшировать соответствующую версию снимка между запросами `SELECT` и всегда корректно заново определяет снимок. Ранее предпринятая попытка кэшировать снимок Iceberg приводила к проблемам при использовании таблицы Iceberg с возможностями time travel. [#85038](https://github.com/ClickHouse/ClickHouse/pull/85038) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлена ошибка двойного освобождения памяти в `AzureIteratorAsync`. [#85064](https://github.com/ClickHouse/ClickHouse/pull/85064) ([Nikita Taranov](https://github.com/nickitat)).
* Улучшено сообщение об ошибке при попытке создать пользователя, аутентифицируемого с помощью JWT. [#85072](https://github.com/ClickHouse/ClickHouse/pull/85072) ([Konstantин Bogdanов](https://github.com/thevar1able)).
* Исправлена очистка patch parts в `ReplicatedMergeTree`. Ранее результат легковесного обновления мог временно не отображаться на реплике до тех пор, пока объединённая или мутировавшая часть, материализующая patch parts, не была загружена с другой реплики. [#85121](https://github.com/ClickHouse/ClickHouse/pull/85121) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка `illegal_type_of_argument` в `mv` при несовпадающих типах. [#85135](https://github.com/ClickHouse/ClickHouse/pull/85135) ([Sema Checherinda](https://github.com/CheSema)).
* Исправлена ошибка segfault в реализации delta-kernel. [#85160](https://github.com/ClickHouse/ClickHouse/pull/85160) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено восстановление реплицируемых баз данных в случаях, когда перемещение файла метаданных занимает слишком много времени. [#85177](https://github.com/ClickHouse/ClickHouse/pull/85177) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлена проблема с `Not-ready Set` для `IN (subquery)` в настройке `additional_table_filters expression`. [#85210](https://github.com/ClickHouse/ClickHouse/pull/85210) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Убраны лишние вызовы `getStatus()` при выполнении запросов SYSTEM DROP REPLICA. Исправлена ситуация, когда таблица удаляется в фоновом режиме и выбрасывается исключение `Shutdown for storage is called`. [#85220](https://github.com/ClickHouse/ClickHouse/pull/85220) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена гонка данных в реализации движка `DeltaLake` в delta-kernel. [#85221](https://github.com/ClickHouse/ClickHouse/pull/85221) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено чтение секционированных данных с отключённым delta-kernel в движке `DeltaLake`. Проблема появилась в версии 25.7 ([https://github.com/ClickHouse/ClickHouse/pull/81136](https://github.com/ClickHouse/ClickHouse/pull/81136)). [#85223](https://github.com/ClickHouse/ClickHouse/pull/85223) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлены недостающие проверки длины имени таблицы в запросах CREATE OR REPLACE и RENAME. [#85326](https://github.com/ClickHouse/ClickHouse/pull/85326) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлено создание RMV на новой реплике реплицируемой базы данных, если `DEFINER` был удалён. [#85327](https://github.com/ClickHouse/ClickHouse/pull/85327) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена запись в Iceberg для сложных типов данных. [#85330](https://github.com/ClickHouse/ClickHouse/pull/85330) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Запись нижних и верхних границ для сложных типов не поддерживается. [#85332](https://github.com/ClickHouse/ClickHouse/pull/85332) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Исправлена логическая ошибка при чтении из функций объектного хранилища через таблицу `Distributed` или табличную функцию `remote`. Исправляет: [#84658](https://github.com/ClickHouse/ClickHouse/issues/84658), [#85173](https://github.com/ClickHouse/ClickHouse/issues/85173), [#52022](https://github.com/ClickHouse/ClickHouse/issues/52022). [#85359](https://github.com/ClickHouse/ClickHouse/pull/85359) ([alesapin](https://github.com/alesapin)).
* Исправлено резервное копирование кусков с повреждёнными проекциями. [#85362](https://github.com/ClickHouse/ClickHouse/pull/85362) ([Antonio Andelic](https://github.com/antonio2368)).
* Запрещено использовать столбец `_part_offset` в проекциях в релизах до тех пор, пока он не будет стабилизирован. [#85372](https://github.com/ClickHouse/ClickHouse/pull/85372) ([Sema Checherinda](https://github.com/CheSema)).
* Исправлены сбой и повреждение данных при выполнении ALTER UPDATE для JSON. [#85383](https://github.com/ClickHouse/ClickHouse/pull/85383) ([Pavel Kruglov](https://github.com/Avogar)).
* Запросы с параллельными репликами, использующие оптимизацию чтения в обратном порядке, могли приводить к некорректным результатам. [#85406](https://github.com/ClickHouse/ClickHouse/pull/85406) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлено возможное неопределённое поведение (сбои) в случае MEMORY&#95;LIMIT&#95;EXCEEDED во время десериализации String. [#85440](https://github.com/ClickHouse/ClickHouse/pull/85440) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены неверные метрики KafkaAssignedPartitions и KafkaConsumersWithAssignment. [#85494](https://github.com/ClickHouse/ClickHouse/pull/85494) ([Ilya Golshtein](https://github.com/ilejn)).
* Исправлена заниженная оценка статистики обработанных байт при использовании PREWHERE (явного или автоматического). [#85495](https://github.com/ClickHouse/ClickHouse/pull/85495) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлено условие раннего выхода для замедления частоты запросов к S3: теперь для включения замедления, когда все потоки приостановлены из-за повторяемой ошибки, достаточно, чтобы было истинно либо s3&#95;slow&#95;all&#95;threads&#95;after&#95;network&#95;error, либо backup&#95;slow&#95;all&#95;threads&#95;after&#95;retryable&#95;s3&#95;error, тогда как ранее требовалось, чтобы истинными были оба. [#85505](https://github.com/ClickHouse/ClickHouse/pull/85505) ([Julia Kartseva](https://github.com/jkartseva)).
* Этот PR исправляет разрешение метаданных при выполнении запросов к таблицам Iceberg через REST‑каталог. ... [#85531](https://github.com/ClickHouse/ClickHouse/pull/85531) ([Saurabh Kumar Ojha](https://github.com/saurabhojha)).
* Исправлен редкий сбой при асинхронных вставках, которые изменяют настройку `log_comment` или `insert_deduplication_token`. [#85540](https://github.com/ClickHouse/ClickHouse/pull/85540) ([Anton Popov](https://github.com/CurtizJ)).
* Параметры, такие как date&#95;time&#95;input&#95;format, игнорировались при использовании HTTP с multipart/form-data. [#85570](https://github.com/ClickHouse/ClickHouse/pull/85570) ([Sema Checherinda](https://github.com/CheSema)).
* Исправлено сокрытие секретов в табличных функциях icebergS3Cluster и icebergAzureCluster. [#85658](https://github.com/ClickHouse/ClickHouse/pull/85658) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Исправлена потеря точности в `JSONExtract` при преобразовании чисел из JSON в типы Decimal. Теперь числовые значения JSON сохраняют своё точное десятичное представление и не приводят к ошибкам округления при использовании чисел с плавающей запятой. [#85665](https://github.com/ClickHouse/ClickHouse/pull/85665) ([ssive7b](https://github.com/ssive7b)).
* Исправлена ошибка `LOGICAL_ERROR` при использовании `COMMENT COLUMN IF EXISTS` в том же операторе `ALTER` после `DROP COLUMN`. Условие `IF EXISTS` теперь корректно пропускает операцию добавления комментария, если столбец был удалён в рамках того же оператора. [#85688](https://github.com/ClickHouse/ClickHouse/pull/85688) ([xiaohuanlin](https://github.com/xiaohuanlin)).
* Исправлено чтение значения счетчика из кэша для Delta Lake. [#85704](https://github.com/ClickHouse/ClickHouse/pull/85704) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка сегментации в CoalescingMergeTree для больших строк. Это закрывает [#84582](https://github.com/ClickHouse/ClickHouse/issues/84582). [#85709](https://github.com/ClickHouse/ClickHouse/pull/85709) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Обновлена временная метка метаданных при записи в Iceberg. [#85711](https://github.com/ClickHouse/ClickHouse/pull/85711) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Использование `distributed_depth` в качестве индикатора функции *Cluster было некорректным и могло приводить к дублированию данных; вместо этого используйте `client_info.collaborate_with_initiator`. [#85734](https://github.com/ClickHouse/ClickHouse/pull/85734) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Spark не может читать position delete-файлы. [#85762](https://github.com/ClickHouse/ClickHouse/pull/85762) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Исправлен `send_logs_source_regexp` (после рефакторинга асинхронного логирования в [#85105](https://github.com/ClickHouse/ClickHouse/issues/85105)). [#85797](https://github.com/ClickHouse/ClickHouse/pull/85797) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена возможная неконсистентность словарей с `update_field` при ошибках `MEMORY_LIMIT_EXCEEDED`. [#85807](https://github.com/ClickHouse/ClickHouse/pull/85807) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка глобальных констант из оператора `WITH` для параллельного распределённого `INSERT SELECT` с целевой таблицей `Distributed`. Ранее запрос мог завершаться ошибкой `Unknown expression identifier`. [#85811](https://github.com/ClickHouse/ClickHouse/pull/85811) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Маскирование учетных данных для `deltaLakeAzure`, `deltaLakeCluster`, `icebergS3Cluster` и `icebergAzureCluster`. [#85889](https://github.com/ClickHouse/ClickHouse/pull/85889) ([Julian Maicher](https://github.com/jmaicher)).
* Исправлена логическая ошибка при попытке выполнения `CREATE ... AS (SELECT * FROM s3Cluster(...))` с `DatabaseReplicated`. [#85904](https://github.com/ClickHouse/ClickHouse/pull/85904) ([Konstantin Bogданов](https://github.com/thevar1able)).
* Исправляет HTTP-запросы, выполняемые табличной функцией `url()`, чтобы корректно добавлять номера портов в заголовок Host при обращении к нестандартным портам. Это устраняет ошибки аутентификации при использовании предварительно подписанных URL-адресов с S3-совместимыми сервисами, такими как MinIO, работающими на нестандартных портах, что часто встречается в средах разработки. (Исправляет [#85898](https://github.com/ClickHouse/ClickHouse/issues/85898)). [#85921](https://github.com/ClickHouse/ClickHouse/pull/85921) ([Tom Quist](https://github.com/tomquist)).
* Теперь Unity Catalog будет игнорировать схемы с некорректными типами данных для недельта-таблиц. Исправляет [#85699](https://github.com/ClickHouse/ClickHouse/issues/85699). [#85950](https://github.com/ClickHouse/ClickHouse/pull/85950) ([alesapin](https://github.com/alesapin)).
* Исправлена nullability полей в Iceberg. [#85977](https://github.com/ClickHouse/ClickHouse/pull/85977) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Исправлена ошибка при восстановлении базы данных `Replicated`: если имя таблицы содержало символ `%`, во время восстановления таблица могла быть заново создана под другим именем. [#85987](https://github.com/ClickHouse/ClickHouse/pull/85987) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена ошибка, из-за которой восстановление резервной копии завершалось с ошибкой `BACKUP_ENTRY_NOT_FOUND` при восстановлении пустой таблицы `Memory`. [#86012](https://github.com/ClickHouse/ClickHouse/pull/86012) ([Julia Kartseva](https://github.com/jkartseva)).
* Добавлены проверки для sharding&#95;key при выполнении ALTER таблицы типа Distributed. Ранее некорректный ALTER нарушал определение таблицы и приводил к перезапуску сервера. [#86015](https://github.com/ClickHouse/ClickHouse/pull/86015) ([Nikolay Degterinsky](https://github.com/evillique)).
* Не создавать пустой файл удаления Iceberg. [#86061](https://github.com/ClickHouse/ClickHouse/pull/86061) ([Konstantин Ведерников](https://github.com/scanhex12)).
* Исправлена проблема, из-за которой большие значения настроек нарушали работу таблиц `S3Queue` и перезапуск реплик. [#86074](https://github.com/ClickHouse/ClickHouse/pull/86074) ([Nikolay Degterinsky](https://github.com/evillique)).

#### Улучшения сборки/тестирования/упаковки

- По умолчанию используются зашифрованные диски для тестов с S3. [#59898](https://github.com/ClickHouse/ClickHouse/pull/59898) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- В интеграционных тестах используется бинарный файл `clickhouse` для получения неочищенных отладочных символов. [#83779](https://github.com/ClickHouse/ClickHouse/pull/83779) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Внутренняя библиотека libxml2 обновлена с версии 2.14.4 до 2.14.5. [#84230](https://github.com/ClickHouse/ClickHouse/pull/84230) ([Robert Schulze](https://github.com/rschu1ze)).
- Внутренняя библиотека curl обновлена с версии 8.14.0 до 8.15.0. [#84231](https://github.com/ClickHouse/ClickHouse/pull/84231) ([Robert Schulze](https://github.com/rschu1ze)).
- Теперь в CI используется меньше памяти для кэшей, а также улучшены тесты для вытеснения. [#84676](https://github.com/ClickHouse/ClickHouse/pull/84676) ([alesapin](https://github.com/alesapin)).

### Релиз ClickHouse 25.7, 2025-07-24 {#257}

#### Обратно несовместимые изменения

- Изменения в функции `extractKeyValuePairs`: добавлен новый аргумент `unexpected_quoting_character_strategy`, который управляет поведением при неожиданном обнаружении символа `quoting_character` при чтении неквотированного ключа или значения. Значение может быть одним из: `invalid`, `accept` или `promote`. `invalid` отбрасывает ключ и возвращается в состояние ожидания ключа. `accept` рассматривает его как часть ключа. `promote` отбрасывает предыдущий символ и начинает разбор как квотированного ключа. Кроме того, после разбора квотированного значения следующий ключ разбирается только при обнаружении разделителя пар. [#80657](https://github.com/ClickHouse/ClickHouse/pull/80657) ([Arthur Passos](https://github.com/arthurpassos)).
- Добавлена поддержка нулевого совпадения в функции `countMatches`. Пользователи, желающие сохранить прежнее поведение, могут включить настройку `count_matches_stop_at_empty_match`. [#81676](https://github.com/ClickHouse/ClickHouse/pull/81676) ([Elmi Ahmadov](https://github.com/ahmadov)).
- При создании резервных копий используются общесерверные ограничители для локальных операций (`max_local_read_bandwidth_for_server` и `max_local_write_bandwidth_for_server`) и удалённых операций (`max_remote_read_network_bandwidth_for_server` и `max_remote_write_network_bandwidth_for_server`) в дополнение к их выделенным серверным настройкам (`max_backup_bandwidth_for_server`, `max_mutations_bandwidth_for_server` и `max_merges_bandwidth_for_server`). [#81753](https://github.com/ClickHouse/ClickHouse/pull/81753) ([Sergei Trifonov](https://github.com/serxa)).
- Запрещено создание таблицы без столбцов, доступных для вставки. [#81835](https://github.com/ClickHouse/ClickHouse/pull/81835) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
- Добавлена параллелизация кластерных функций по файлам внутри архивов. В предыдущих версиях весь архив (например, zip, tar или 7z) был единицей работы. Добавлена новая настройка `cluster_function_process_archive_on_multiple_nodes`, по умолчанию равная `true`. Если установлена в `true`, повышает производительность обработки архивов в кластерных функциях. Должна быть установлена в `false` для совместимости и во избежание ошибок при обновлении до версии 25.7+ при использовании кластерных функций с архивами в более ранних версиях. [#82355](https://github.com/ClickHouse/ClickHouse/pull/82355) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Запрос `SYSTEM RESTART REPLICAS` приводил к пробуждению таблиц в базе данных Lazy даже без доступа к этой базе данных, и это происходило во время одновременного удаления этих таблиц. Примечание: теперь `SYSTEM RESTART REPLICAS` будет перезапускать реплики только в тех базах данных, где у вас есть разрешение на `SHOW TABLES`, что является естественным поведением. [#83321](https://github.com/ClickHouse/ClickHouse/pull/83321) ([Alexey Milovidov](https://github.com/alexey-milovidov)).


#### Новая функция

* Добавлена поддержка легковесных обновлений для таблиц семейства `MergeTree`. Легковесные обновления можно использовать с новым синтаксисом: `UPDATE <table> SET col1 = val1, col2 = val2, ... WHERE <condition>`. Добавлена реализация легковесных удалений на основе легковесных обновлений. Это можно включить, установив `lightweight_delete_mode = 'lightweight_update'`. [#82004](https://github.com/ClickHouse/ClickHouse/pull/82004) ([Anton Popov](https://github.com/CurtizJ)).
* Поддержка сложных типов в эволюции схемы Iceberg. [#73714](https://github.com/ClickHouse/ClickHouse/pull/73714) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Добавлена поддержка операторов `INSERT` в таблицы Iceberg. [#82692](https://github.com/ClickHouse/ClickHouse/pull/82692) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Чтение файлов данных Iceberg по идентификаторам полей. Это улучшает совместимость с Iceberg: поля можно переименовывать в метаданных, при этом сопоставляя их с другими именами во входных файлах Parquet. Это закрывает [#83065](https://github.com/ClickHouse/ClickHouse/issues/83065). [#83653](https://github.com/ClickHouse/ClickHouse/pull/83653) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Теперь ClickHouse поддерживает сжатые файлы `metadata.json` для Iceberg. Исправлена ошибка [#70874](https://github.com/ClickHouse/ClickHouse/issues/70874). [#81451](https://github.com/ClickHouse/ClickHouse/pull/81451) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка `TimestampTZ` в каталоге Glue. Это закрывает [#81654](https://github.com/ClickHouse/ClickHouse/issues/81654). [#83132](https://github.com/ClickHouse/ClickHouse/pull/83132) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Добавлена генерация SQL с помощью ИИ в клиент ClickHouse. Теперь пользователи могут создавать SQL‑запросы из описаний на естественном языке, добавляя префикс `??` к своему запросу. Поддерживаются поставщики OpenAI и Anthropic с автоматическим обнаружением схемы. [#83314](https://github.com/ClickHouse/ClickHouse/pull/83314) ([Kaushik Iska](https://github.com/iskakaushik)).
* Добавлена функция для записи геотипов в формат WKB. [#82935](https://github.com/ClickHouse/ClickHouse/pull/82935) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Добавлены два новых типа доступа к источникам: `READ` и `WRITE`, при этом все прежние типы доступа, связанные с источниками, объявлены устаревшими. Раньше: `GRANT S3 ON *.* TO user`, теперь: `GRANT READ, WRITE ON S3 TO user`. Это также позволяет раздельно управлять правами `READ` и `WRITE` для источников, например: `GRANT READ ON * TO user`, `GRANT WRITE ON S3 TO user`. Функциональность управляется настройкой `access_control_improvements.enable_read_write_grants` и по умолчанию отключена. [#73659](https://github.com/ClickHouse/ClickHouse/pull/73659) ([pufit](https://github.com/pufit)).
* NumericIndexedVector: новая векторная структура данных на основе бит-слайс- и Roaring-bitmap-сжатия, а также более 20 функций для построения, анализа и поэлементной арифметики. Может сократить объем хранимых данных и ускорить `JOIN`, фильтрацию и агрегации для разреженных данных. Реализует [#70582](https://github.com/ClickHouse/ClickHouse/issues/70582) и идеи из статьи “[Large-Scale Metric Computation in Online Controlled Experiment Platform](https://arxiv.org/abs/2405.08411)” T. Xiong и Y. Wang с конференции VLDB 2024. [#74193](https://github.com/ClickHouse/ClickHouse/pull/74193) ([FriendLey](https://github.com/FriendLey)).
* Настройка нагрузки `max_waiting_queries` теперь поддерживается. Ее можно использовать для ограничения размера очереди запросов. При достижении лимита все последующие запросы будут завершаться с ошибкой `SERVER_OVERLOADED`. [#81250](https://github.com/ClickHouse/ClickHouse/pull/81250) ([Oleg Doronin](https://github.com/dorooleg)).
* Добавлены финансовые функции: `financialInternalRateOfReturnExtended` (`XIRR`), `financialInternalRateOfReturn` (`IRR`), `financialNetPresentValueExtended` (`XNPV`), `financialNetPresentValue` (`NPV`). [#81599](https://github.com/ClickHouse/ClickHouse/pull/81599) ([Joanna Hulboj](https://github.com/jh0x)).
* Добавлены геопространственные функции `polygonsIntersectCartesian` и `polygonsIntersectSpherical` для проверки, пересекаются ли два полигона. [#81882](https://github.com/ClickHouse/ClickHouse/pull/81882) ([Paul Lamb](https://github.com/plamb)).
* Добавлена поддержка виртуального столбца `_part_granule_offset` в таблицах семейства MergeTree. Этот столбец указывает индекс (с нуля) гранулы/метки, к которой принадлежит каждая строка внутри своего куска данных. Это решает задачу [#79572](https://github.com/ClickHouse/ClickHouse/issues/79572). [#82341](https://github.com/ClickHouse/ClickHouse/pull/82341) ([Amos Bird](https://github.com/amosbird)). [#82341](https://github.com/ClickHouse/ClickHouse/pull/82341) ([Amos Bird](https://github.com/amosbird))
* Добавлены SQL-функции `colorSRGBToOkLCH` и `colorOkLCHToSRGB` для преобразования цветов между цветовыми пространствами sRGB и OkLCH. [#83679](https://github.com/ClickHouse/ClickHouse/pull/83679) ([Fgrtue](https://github.com/Fgrtue)).
* Разрешено использование параметров в запросах `CREATE USER` для имён пользователей. [#81387](https://github.com/ClickHouse/ClickHouse/pull/81387) ([Diskein](https://github.com/Diskein)).
* Таблица `system.formats` теперь содержит расширенную информацию о форматах, такую как HTTP content type, возможности автоматического вывода схемы и т. д. [#81505](https://github.com/ClickHouse/ClickHouse/pull/81505) ([Alexey Milovidov](https://github.com/alexey-milovidov)).



#### Экспериментальная функциональность
* Добавлены функции `searchAny` и `searchAll` — универсальные инструменты для поиска по текстовым индексам. [#80641](https://github.com/ClickHouse/ClickHouse/pull/80641) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Текстовый индекс теперь поддерживает новый токенизатор `split`. [#81752](https://github.com/ClickHouse/ClickHouse/pull/81752) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Значение `index_granularity` по умолчанию для индексов `text` изменено на 64. Это повышает ожидаемую производительность типичного тестового запроса во внутренних бенчмарках. [#82162](https://github.com/ClickHouse/ClickHouse/pull/82162) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
* 256-битная битовая карта хранит исходящие метки состояния в упорядоченном виде, но исходящие состояния записываются на диск в том порядке, в котором они появляются в хеш-таблице. Поэтому при чтении с диска метка может указывать на некорректное следующее состояние. [#82783](https://github.com/ClickHouse/ClickHouse/pull/82783) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Включено сжатие zstd для FST-blob-дерева в текстовых индексах. [#83093](https://github.com/ClickHouse/ClickHouse/pull/83093) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Индекс векторного сходства переведён в статус beta. Добавлена псевдонимная настройка `enable_vector_similarity_index`, которую необходимо включить для использования индекса векторного сходства. [#83459](https://github.com/ClickHouse/ClickHouse/pull/83459) ([Robert Schulze](https://github.com/rschu1ze)).
* Удалена экспериментальная логика `send_metadata`, связанная с экспериментальной репликацией с нулевым копированием (zero-copy replication). Она никогда не использовалась, и этот код никто не поддерживает. Поскольку не было даже связанных с ней тестов, есть высокая вероятность, что он давно был сломан. [#82508](https://github.com/ClickHouse/ClickHouse/pull/82508) ([alesapin](https://github.com/alesapin)).
* Интегрирован `StorageKafka2` в `system.kafka_consumers`. [#82652](https://github.com/ClickHouse/ClickHouse/pull/82652) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Добавлена оценка сложных выражений в форме КНФ/ДНФ (CNF/DNF) по статистике, например `(a < 1 and a > 0) or b = 3`. [#82663](https://github.com/ClickHouse/ClickHouse/pull/82663) ([Han Fei](https://github.com/hanfei1991)).



#### Улучшение производительности

* Введён асинхронный логгинг. Когда логи выводятся на медленное устройство, это больше не замедляет выполнение запросов. [#82516](https://github.com/ClickHouse/ClickHouse/pull/82516) ([Raúl Marín](https://github.com/Algunenano)). Ограничено максимальное количество записей, хранимых в очереди. [#83214](https://github.com/ClickHouse/ClickHouse/pull/83214) ([Raúl Marín](https://github.com/Algunenano)).
* Параллельный распределённый INSERT SELECT по умолчанию включён в режиме, при котором INSERT SELECT выполняется независимо на каждом шарде, см. настройку `parallel_distributed_insert_select`. [#83040](https://github.com/ClickHouse/ClickHouse/pull/83040) ([Igor Nikonov](https://github.com/devcrafter)).
* Когда запрос с агрегацией содержит только одну функцию `count()` по не-`Nullable` столбцу, логика агрегации полностью встраивается на этапе пробинга хеш-таблицы. Это позволяет избежать выделения и поддержания какого-либо агрегатного состояния, что значительно снижает использование памяти и накладные расходы по CPU. Это частично решает [#81982](https://github.com/ClickHouse/ClickHouse/issues/81982). [#82104](https://github.com/ClickHouse/ClickHouse/pull/82104) ([Amos Bird](https://github.com/amosbird)).
* Производительность `HashJoin` оптимизирована за счёт удаления дополнительного прохода по хеш-таблицам в типичном случае с единственным ключевым столбцом, а также устранения проверок `null_map` и `join_mask`, когда их значения всегда `true`/`false`. [#82308](https://github.com/ClickHouse/ClickHouse/pull/82308) ([Nikita Taranov](https://github.com/nickitat)).
* Тривиальная оптимизация комбинатора `-If`. [#78454](https://github.com/ClickHouse/ClickHouse/pull/78454) ([李扬](https://github.com/taiyang-li)).
* Запросы векторного поиска с использованием индекса векторного сходства выполняются с меньшей задержкой за счет сокращения операций чтения из хранилища и снижения загрузки CPU. [#79103](https://github.com/ClickHouse/ClickHouse/pull/79103) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Параметр `merge_tree_min_{rows,bytes}_for_seek` теперь учитывается в `filterPartsByQueryConditionCache`, чтобы согласовать его с другими методами фильтрации по индексам. [#80312](https://github.com/ClickHouse/ClickHouse/pull/80312) ([李扬](https://github.com/taiyang-li)).
* Сделан многопоточным конвейер после шага `TOTALS`. [#80331](https://github.com/ClickHouse/ClickHouse/pull/80331) ([UnamedRus](https://github.com/UnamedRus)).
* Исправлена фильтрация по ключу для хранилищ `Redis` и `KeeperMap`. [#81833](https://github.com/ClickHouse/ClickHouse/pull/81833) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Добавлена новая настройка `min_joined_block_size_rows` (аналогичная `min_joined_block_size_bytes`; по умолчанию — 65409) для управления минимальным размером блока (в строках) для входных и выходных блоков JOIN (если это поддерживается выбранным алгоритмом соединения). Мелкие блоки будут объединяться. [#81886](https://github.com/ClickHouse/ClickHouse/pull/81886) ([Nikita Taranov](https://github.com/nickitat)).
* `ATTACH PARTITION` больше не приводит к сбросу всех кешей. [#82377](https://github.com/ClickHouse/ClickHouse/pull/82377) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Оптимизирован сгенерированный план для коррелированных подзапросов за счет удаления избыточных операций `JOIN` с использованием классов эквивалентности. Если существуют эквивалентные выражения для всех коррелированных столбцов и включена настройка `query_plan_correlated_subqueries_use_substitution`, то `CROSS JOIN` не создается. [#82435](https://github.com/ClickHouse/ClickHouse/pull/82435) ([Dmitry Novik](https://github.com/novikd)).
* Считывать только необходимые столбцы в коррелированном подзапросе, когда он используется как аргумент функции `EXISTS`. [#82443](https://github.com/ClickHouse/ClickHouse/pull/82443) ([Dmitry Novik](https://github.com/novikd)).
* Незначительно ускорено сравнение деревьев запросов во время анализа запроса. [#82617](https://github.com/ClickHouse/ClickHouse/pull/82617) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлено выравнивание в `Counter` из `ProfileEvents` для уменьшения ложного шаринга кэша. [#82697](https://github.com/ClickHouse/ClickHouse/pull/82697) ([Jiebin Sun](https://github.com/jiebinn)).
* Оптимизации для `null_map` и `JoinMask` из [#82308](https://github.com/ClickHouse/ClickHouse/issues/82308) были применены к случаю JOIN с несколькими дизъюнктивными условиями. Также была оптимизирована структура данных `KnownRowsHolder`. [#83041](https://github.com/ClickHouse/ClickHouse/pull/83041) ([Nikita Taranov](https://github.com/nickitat)).
* Обычный `std::vector<std::atomic_bool>` используется для флагов JOIN, чтобы избежать вычисления хеша при каждом обращении к ним. [#83043](https://github.com/ClickHouse/ClickHouse/pull/83043) ([Nikita Taranov](https://github.com/nickitat)).
* Не выделяйте память для результирующих столбцов заранее, когда `HashJoin` использует режим ленивого (`lazy`) вывода. Это неэффективно, особенно когда количество совпадений невелико. Кроме того, после завершения операции соединения нам известно точное количество совпадений, поэтому мы можем предварительно выделить память более точно. [#83304](https://github.com/ClickHouse/ClickHouse/pull/83304) ([Nikita Taranov](https://github.com/nickitat)).
* Минимизировали копирование памяти в заголовках портов во время построения конвейера. Исходный [PR](https://github.com/ClickHouse/ClickHouse/pull/70105) от [heymind](https://github.com/heymind). [#83381](https://github.com/ClickHouse/ClickHouse/pull/83381) ([Raúl Marín](https://github.com/Algunenano)).
* Улучшен запуск clickhouse-keeper при использовании хранилища RocksDB. [#83390](https://github.com/ClickHouse/ClickHouse/pull/83390) ([Antonio Andelic](https://github.com/antonio2368)).
* Избегайте удержания блокировки во время создания данных снимка хранилища, чтобы уменьшить конкуренцию за блокировку при высокой конкурентной нагрузке. [#83510](https://github.com/ClickHouse/ClickHouse/pull/83510) ([Duc Canh Le](https://github.com/canhld94)).
* Улучшена производительность формата ввода `ProtobufSingle` за счёт повторного использования сериализатора при отсутствии ошибок парсинга. [#83613](https://github.com/ClickHouse/ClickHouse/pull/83613) ([Eduard Karacharov](https://github.com/korowa)).
* Улучшена производительность построения конвейера, что ускоряет выполнение коротких запросов. [#83631](https://github.com/ClickHouse/ClickHouse/pull/83631) ([Raúl Marín](https://github.com/Algunenano)).
* Оптимизирован `MergeTreeReadersChain::getSampleBlock`, что ускоряет выполнение коротких запросов. [#83875](https://github.com/ClickHouse/ClickHouse/pull/83875) ([Raúl Marín](https://github.com/Algunenano)).
* Ускорен вывод списка таблиц в каталогах данных за счёт асинхронных запросов. [#81084](https://github.com/ClickHouse/ClickHouse/pull/81084) ([alesapin](https://github.com/alesapin)).
* Добавлен джиттер в механизм повторных попыток S3 при включённой конфигурации `s3_slow_all_threads_after_network_error`. [#81849](https://github.com/ClickHouse/ClickHouse/pull/81849) ([zoomxi](https://github.com/zoomxi)).





#### Улучшение

* Цветовая подсветка скобок несколькими цветами для улучшения читаемости. [#82538](https://github.com/ClickHouse/ClickHouse/pull/82538) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Подсветка метасимволов в шаблонах LIKE/REGEXP по мере ввода. Она уже есть в `clickhouse-format` и в выводе `clickhouse-client`, но теперь работает и в интерактивной командной строке. [#82871](https://github.com/ClickHouse/ClickHouse/pull/82871) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Подсветка в `clickhouse-format` и в выводе клиента будет работать так же, как подсветка в командной строке. [#82874](https://github.com/ClickHouse/ClickHouse/pull/82874) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Теперь диски `plain_rewritable` можно использовать для хранения метаданных баз данных. В `plain_rewritable` реализованы методы `moveFile` и `replaceFile`, чтобы поддерживать его использование в качестве диска базы данных. [#79424](https://github.com/ClickHouse/ClickHouse/pull/79424) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Разрешено создание резервных копий для баз данных `PostgreSQL`, `MySQL` и `DataLake`. Такая резервная копия будет сохранять только определение базы данных, но не содержащиеся в ней данные. [#79982](https://github.com/ClickHouse/ClickHouse/pull/79982) ([Nikolay Degterinsky](https://github.com/evillique)).
* Настройка `allow_experimental_join_condition` помечена как устаревшая, поскольку теперь она всегда включена. [#80566](https://github.com/ClickHouse/ClickHouse/pull/80566) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Добавлены метрики нагрузки к асинхронным метрикам ClickHouse. [#80779](https://github.com/ClickHouse/ClickHouse/pull/80779) ([Xander Garbett](https://github.com/Garbett1)).
* Добавлены метрики `MarkCacheEvictedBytes`, `MarkCacheEvictedMarks`, `MarkCacheEvictedFiles` для отслеживания удаления данных из кэша меток. (issue [#60989](https://github.com/ClickHouse/ClickHouse/issues/60989)). [#80799](https://github.com/ClickHouse/ClickHouse/pull/80799) ([Shivji Kumar Jha](https://github.com/shiv4289)).
* Добавлена поддержка записи Parquet enum в виде массива байтов, как предписано [спецификацией](https://github.com/apache/parquet-format/blob/master/LogicalTypes.md#enum). [#81090](https://github.com/ClickHouse/ClickHouse/pull/81090) ([Arthur Passos](https://github.com/arthurpassos)).
* Улучшение для движка таблиц `DeltaLake`: в delta-kernel-rs появился API `ExpressionVisitor`, который реализован в этом PR и применяется для преобразования выражений по столбцам партиционирования (он заменит старый, помеченный как устаревший, способ в delta-kernel-rs, который ранее использовался в нашем коде). В будущем этот `ExpressionVisitor` также позволит реализовать отсечение на основе статистики и некоторые проприетарные возможности delta-lake. Дополнительно целью этого изменения является поддержка отсечения по партициям в движке таблиц `DeltaLakeCluster` (результат разбора выражения — ActionsDAG — будет сериализован и отправлен с инициатора вместе с путем к данным, поскольку информация такого рода, необходимая для отсечения, доступна только как метаинформация при перечислении файлов данных, которое выполняется только инициатором, но должна применяться к данным на каждом сервере чтения). [#81136](https://github.com/ClickHouse/ClickHouse/pull/81136) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Сохранять имена элементов при выводе супертипов для именованных кортежей. [#81345](https://github.com/ClickHouse/ClickHouse/pull/81345) ([lgbo](https://github.com/lgbo-ustc)).
* Реализован ручной подсчёт потреблённых сообщений, чтобы избежать зависимости от ранее зафиксированного смещения в StorageKafka2. [#81662](https://github.com/ClickHouse/ClickHouse/pull/81662) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Добавлен `clickhouse-keeper-utils` — новый инструмент командной строки для управления и анализа данных ClickHouse Keeper. Инструмент поддерживает дамп состояния из снимков и журналов изменений, анализ файлов журналов изменений и извлечение определённых диапазонов логов. [#81677](https://github.com/ClickHouse/ClickHouse/pull/81677) ([Antonio Andelic](https://github.com/antonio2368)).
* Общие и пользовательские ограничители сетевой пропускной способности никогда не сбрасываются, что гарантирует, что лимиты `max_network_bandwidth_for_all_users` и `max_network_bandwidth_for_user` никогда не превышаются. [#81729](https://github.com/ClickHouse/ClickHouse/pull/81729) ([Sergei Trifonov](https://github.com/serxa)).
* Поддержана запись geoparquet в качестве выходного формата. [#81784](https://github.com/ClickHouse/ClickHouse/pull/81784) ([Konstantin Vedernikov](https://github.com/scanhex12)).
* Запрещён запуск мутации `RENAME COLUMN`, если она переименует столбец, на который в данный момент влияет незавершённая мутация данных. [#81823](https://github.com/ClickHouse/ClickHouse/pull/81823) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Заголовок Connection теперь отправляется в конце списка заголовков, когда известно, что соединение должно быть сохранено. [#81951](https://github.com/ClickHouse/ClickHouse/pull/81951) ([Sema Checherinda](https://github.com/CheSema)).
* Настройте очередь TCP-серверов (по умолчанию 64) в зависимости от параметра listen&#95;backlog (по умолчанию 4096). [#82045](https://github.com/ClickHouse/ClickHouse/pull/82045) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена возможность динамически изменять `max_local_read_bandwidth_for_server` и `max_local_write_bandwidth_for_server` на лету, без перезапуска сервера. [#82083](https://github.com/ClickHouse/ClickHouse/pull/82083) ([Kai Zhu](https://github.com/nauu)).
* Добавлена поддержка очистки всех предупреждений из таблицы `system.warnings` с помощью команды `TRUNCATE TABLE system.warnings`. [#82087](https://github.com/ClickHouse/ClickHouse/pull/82087) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлено отсечение партиций в кластерных функциях для data lake. [#82131](https://github.com/ClickHouse/ClickHouse/pull/82131) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено чтение секционированных данных в табличной функции DeltaLakeCluster. В этом PR увеличена версия протокола кластерных функций, что позволяет передавать дополнительную информацию от инициатора к репликам. Эта дополнительная информация содержит выражение преобразования delta-kernel, которое необходимо для разбора столбцов секций (а в будущем — и некоторых других сущностей, например, вычисляемых столбцов и т. д.). [#82132](https://github.com/ClickHouse/ClickHouse/pull/82132) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Функция `reinterpret` теперь поддерживает преобразование в `Array(T)`, где `T` — тип данных фиксированной длины (issue [#82621](https://github.com/ClickHouse/ClickHouse/issues/82621)). [#83399](https://github.com/ClickHouse/ClickHouse/pull/83399) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Теперь база данных Datalake выдаёт более понятное исключение. Исправляет [#81211](https://github.com/ClickHouse/ClickHouse/issues/81211). [#82304](https://github.com/ClickHouse/ClickHouse/pull/82304) ([alesapin](https://github.com/alesapin)).
* Улучшен `CROSS JOIN` за счёт возврата значения `false` из `HashJoin::needUsedFlagsForPerRightTableRow`. [#82379](https://github.com/ClickHouse/ClickHouse/pull/82379) ([lgbo](https://github.com/lgbo-ustc)).
* Разрешена запись и чтение столбцов типа Map как Array(Tuple). [#82408](https://github.com/ClickHouse/ClickHouse/pull/82408) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Перечисление лицензий crates на [Rust](https://clickhouse.com/blog/rust) в `system.licenses`. [#82440](https://github.com/ClickHouse/ClickHouse/pull/82440) ([Raúl Marín](https://github.com/Algunenano)).
* Макросы наподобие `{uuid}` теперь можно использовать в настройке `keeper_path` движка таблиц S3Queue. [#82463](https://github.com/ClickHouse/ClickHouse/pull/82463) ([Nikolay Degterinsky](https://github.com/evillique)).
* Улучшение Keeper: перемещение файлов журнала изменений между дисками вынесено в фоновый поток. Ранее перенос журнала изменений на другой диск глобально блокировал Keeper до завершения операции. Это приводило к снижению производительности, если перенос занимал много времени (например, на диск S3). [#82485](https://github.com/ClickHouse/ClickHouse/pull/82485) ([Antonio Andelic](https://github.com/antonio2368)).
* Улучшение Keeper: добавлен новый параметр конфигурации `keeper_server.cleanup_old_and_ignore_new_acl`. Если он включён, у всех узлов будут очищены ACL, а ACL для новых запросов будут игнорироваться. Если цель — полностью удалить ACL с узлов, важно оставить этот параметр включённым до тех пор, пока не будет создан новый snapshot. [#82496](https://github.com/ClickHouse/ClickHouse/pull/82496) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена новая серверная настройка `s3queue_disable_streaming`, которая отключает потоковую обработку в таблицах с движком S3Queue. Эту настройку можно изменять без перезапуска сервера. [#82515](https://github.com/ClickHouse/ClickHouse/pull/82515) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Рефакторинг механизма динамического изменения размера кэша файловой системы. Добавлено больше логов для анализа. [#82556](https://github.com/ClickHouse/ClickHouse/pull/82556) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `clickhouse-server` без файла конфигурации также будет слушать порт PostgreSQL 9005, как и с конфигурацией по умолчанию. [#82633](https://github.com/ClickHouse/ClickHouse/pull/82633) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* В `ReplicatedMergeTree::executeMetadataAlter` мы получаем `StorageID` и, не беря `DDLGuard`, пытаемся вызвать `IDatabase::alterTable`. За это время мы технически могли подменить рассматриваемую таблицу другой, так что при получении определения мы бы получили неверное. Чтобы избежать этого, мы добавляем отдельную проверку на совпадение `UUID` при вызове `IDatabase::alterTable`. [#82666](https://github.com/ClickHouse/ClickHouse/pull/82666) ([Nikolay Degterinsky](https://github.com/evillique)).
* При присоединении базы данных с удалённым диском только для чтения вручную добавляйте UUID таблиц в DatabaseCatalog. [#82670](https://github.com/ClickHouse/ClickHouse/pull/82670) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Запрещено использовать значения `nan` и `inf` с `NumericIndexedVector`. Исправляет [#82239](https://github.com/ClickHouse/ClickHouse/issues/82239) и немного больше. [#82681](https://github.com/ClickHouse/ClickHouse/pull/82681) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Не опускайте нулевые значения в форматах заголовков `X-ClickHouse-Progress` и `X-ClickHouse-Summary`. [#82727](https://github.com/ClickHouse/ClickHouse/pull/82727) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Улучшение Keeper: поддержка отдельных разрешений для ACL `world:anyone`. [#82755](https://github.com/ClickHouse/ClickHouse/pull/82755) ([Antonio Andelic](https://github.com/antonio2368)).
* Запрещены операции `RENAME COLUMN` и `DROP COLUMN`, затрагивающие явно указанные столбцы для суммирования в SummingMergeTree. Закрывает [#81836](https://github.com/ClickHouse/ClickHouse/issues/81836). [#82821](https://github.com/ClickHouse/ClickHouse/pull/82821) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшена точность преобразования из `Decimal` в `Float32`. Реализовано преобразование из `Decimal` в `BFloat16`. Исправляет [#82660](https://github.com/ClickHouse/ClickHouse/issues/82660). [#82823](https://github.com/ClickHouse/ClickHouse/pull/82823) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Полосы прокрутки в веб-интерфейсе будут выглядеть чуть лучше. [#82869](https://github.com/ClickHouse/ClickHouse/pull/82869) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* `clickhouse-server` со встроенной конфигурацией позволит использовать Web UI, формируя HTTP-ответ на запрос OPTIONS. [#82870](https://github.com/ClickHouse/ClickHouse/pull/82870) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка указания дополнительных ACL Keeper для путей в конфигурации. Если вы хотите добавить дополнительные ACL для конкретного пути, задайте их в конфигурации в разделе `zookeeper.path_acls`. [#82898](https://github.com/ClickHouse/ClickHouse/pull/82898) ([Antonio Andelic](https://github.com/antonio2368)).
* Теперь снимок `mutations` будет формироваться из снимка видимых частей. Также счетчики мутаций, используемые в этом снимке, будут пересчитываться на основе включенных мутаций. [#82945](https://github.com/ClickHouse/ClickHouse/pull/82945) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Добавлен `ProfileEvent`, фиксируемый, когда Keeper отклоняет запись из-за мягкого лимита памяти. [#82963](https://github.com/ClickHouse/ClickHouse/pull/82963) ([Xander Garbett](https://github.com/Garbett1)).
* Добавлены столбцы `commit_time` и `commit_id` в `system.s3queue_log`. [#83016](https://github.com/ClickHouse/ClickHouse/pull/83016) ([Kseniia Sumarokova](https://github.com/kssenii)).
* В некоторых случаях нам нужно иметь несколько измерений для метрик. Например, считать неудавшиеся слияния (`merges`) или мутации (`mutations`) по кодам ошибок, а не одним общим счетчиком. Для этого введена таблица `system.dimensional_metrics`, которая как раз это и делает и добавляет первую многомерную метрику `failed_merges`. [#83030](https://github.com/ClickHouse/ClickHouse/pull/83030) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Объединить предупреждения о неизвестных настройках в clickhouse client и логировать их в виде сводки. [#83042](https://github.com/ClickHouse/ClickHouse/pull/83042) ([Bharat Nallan](https://github.com/bharatnc)).
* Клиент ClickHouse теперь выводит локальный порт при ошибке подключения. [#83050](https://github.com/ClickHouse/ClickHouse/pull/83050) ([Jianfei Hu](https://github.com/incfly)).
* Незначительно улучшена обработка ошибок в `AsynchronousMetrics`. Если каталог `/sys/block` существует, но недоступен, сервер запустится без мониторинга блочных устройств. Закрывает [#79229](https://github.com/ClickHouse/ClickHouse/issues/79229). [#83115](https://github.com/ClickHouse/ClickHouse/pull/83115) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Останавливать `SystemLogs` после обычных таблиц (и перед системными таблицами, вместо остановки перед обычными). [#83134](https://github.com/ClickHouse/ClickHouse/pull/83134) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлены логи для процесса завершения работы `S3Queue`. [#83163](https://github.com/ClickHouse/ClickHouse/pull/83163) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена возможность разбора типов `Time` и `Time64` из форматов `MM:SS`, `M:SS`, `SS` или `S`. [#83299](https://github.com/ClickHouse/ClickHouse/pull/83299) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Когда `distributed_ddl_output_mode='*_only_active'`, не дожидаемся новых или восстановленных реплик, у которых задержка репликации больше, чем `max_replication_lag_to_enqueue`. Это помогает избежать ошибки `DDL task is not finished on some hosts` в ситуации, когда новая реплика становится активной после завершения инициализации или восстановления, но за время инициализации накопила большой журнал репликации. Также реализован запрос `SYSTEM SYNC DATABASE REPLICA STRICT`, который ожидает, пока журнал репликации не станет меньше значения `max_replication_lag_to_enqueue`. [#83302](https://github.com/ClickHouse/ClickHouse/pull/83302) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Не выводить слишком подробные описания действий выражений в сообщениях об исключениях. Закрывает [#83164](https://github.com/ClickHouse/ClickHouse/issues/83164). [#83350](https://github.com/ClickHouse/ClickHouse/pull/83350) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность разбирать префикс и суффикс парта, а также проверять покрытие для неконстантных столбцов. [#83377](https://github.com/ClickHouse/ClickHouse/pull/83377) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Унифицированы названия параметров в ODBC и JDBC при использовании именованных коллекций. [#83410](https://github.com/ClickHouse/ClickHouse/pull/83410) ([Andrey Zvonov](https://github.com/zvonand)).
* Когда хранилище останавливается, `getStatus` выбрасывает исключение `ErrorCodes::ABORTED`. Ранее это приводило к ошибке запроса `SELECT`. Теперь мы перехватываем исключения `ErrorCodes::ABORTED` и преднамеренно их игнорируем. [#83435](https://github.com/ClickHouse/ClickHouse/pull/83435) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Добавлены метрики использования ресурсов процесса (такие как `UserTimeMicroseconds`, `SystemTimeMicroseconds`, `RealTimeMicroseconds`) в события профилирования `part_log` для записей `MergeParts`. [#83460](https://github.com/ClickHouse/ClickHouse/pull/83460) ([Vladimir Cherkasov](https://github.com/vdimir)).
* По умолчанию включены флаги функциональности `create_if_not_exists`, `check_not_exists`, `remove_recursive` в Keeper, что позволяет использовать новые типы запросов. [#83488](https://github.com/ClickHouse/ClickHouse/pull/83488) ([Antonio Andelic](https://github.com/antonio2368)).
* Останавливать потоковую обработку очередей S3 (Azure и т. д.) перед остановкой любых таблиц при завершении работы сервера. [#83530](https://github.com/ClickHouse/ClickHouse/pull/83530) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка типов `Date`/`Date32` как целых чисел во входных форматах `JSON`. [#83597](https://github.com/ClickHouse/ClickHouse/pull/83597) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Сделали сообщения об исключениях в некоторых ситуациях при загрузке и добавлении проекций более понятными. [#83728](https://github.com/ClickHouse/ClickHouse/pull/83728) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена опция конфигурации, позволяющая отключить проверку целостности двоичного `checksum` для `clickhouse-server`. Решает [#83637](https://github.com/ClickHouse/ClickHouse/issues/83637). [#83749](https://github.com/ClickHouse/ClickHouse/pull/83749) ([Rafael Roquetto](https://github.com/rafaelroquetto)).





#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе)

* Исправлено некорректное значение по умолчанию для опции `--reconnect` в `clickhouse-benchmark`. Оно было ошибочно изменено в [#79465](https://github.com/ClickHouse/ClickHouse/issues/79465). [#82677](https://github.com/ClickHouse/ClickHouse/pull/82677) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено несогласованное форматирование `CREATE DICTIONARY`. Закрывает [#82105](https://github.com/ClickHouse/ClickHouse/issues/82105). [#82829](https://github.com/ClickHouse/ClickHouse/pull/82829) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено неконсistentное форматирование TTL, когда он содержит функцию `materialize`. Закрывает [#82828](https://github.com/ClickHouse/ClickHouse/issues/82828). [#82831](https://github.com/ClickHouse/ClickHouse/pull/82831) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено некорректное форматирование `EXPLAIN AST` во вложенном запросе, когда он содержит параметры вывода, такие как `INTO OUTFILE`. Закрывает [#82826](https://github.com/ClickHouse/ClickHouse/issues/82826). [#82840](https://github.com/ClickHouse/ClickHouse/pull/82840) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено непоследовательное форматирование заключённых в скобки выражений с псевдонимами в контексте, где псевдонимы не допускаются. Закрывает [#82836](https://github.com/ClickHouse/ClickHouse/issues/82836). Закрывает [#82837](https://github.com/ClickHouse/ClickHouse/issues/82837). [#82867](https://github.com/ClickHouse/ClickHouse/pull/82867) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Используется корректный код ошибки при умножении состояния агрегатной функции на IPv4. Закрывает [#82817](https://github.com/ClickHouse/ClickHouse/issues/82817). [#82818](https://github.com/ClickHouse/ClickHouse/pull/82818) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена логическая ошибка в файловом кэше: «Having zero bytes but range is not finished». [#81868](https://github.com/ClickHouse/ClickHouse/pull/81868) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Пересчитывает min-max индекс при уменьшении числа строк с помощью TTL, чтобы обеспечить корректную работу алгоритмов, которые на него полагаются, таких как `minmax_count_projection`. Это исправляет [#77091](https://github.com/ClickHouse/ClickHouse/issues/77091). [#77166](https://github.com/ClickHouse/ClickHouse/pull/77166) ([Amos Bird](https://github.com/amosbird)).
* Для запросов с комбинацией `ORDER BY ... LIMIT BY ... LIMIT N`, когда ORDER BY выполняется как PartialSorting, счётчик `rows_before_limit_at_least` теперь отражает количество строк, обработанных оператором LIMIT, вместо количества строк, обработанных преобразованием сортировки. [#78999](https://github.com/ClickHouse/ClickHouse/pull/78999) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлено избыточное пропускание гранул при фильтрации по token/ngram-индексам с `regexp`, который содержит альтернативы и первую альтернативу, не являющуюся литералом. [#79373](https://github.com/ClickHouse/ClickHouse/pull/79373) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлена логическая ошибка с оператором `<=>` и хранилищем Join: теперь запрос возвращает корректный код ошибки. [#80165](https://github.com/ClickHouse/ClickHouse/pull/80165) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлена ошибка, вызывавшая сбой в функции `loop` при использовании с семейством функций `remote`. Обеспечено соблюдение оператора LIMIT в `loop(remote(...))`. [#80299](https://github.com/ClickHouse/ClickHouse/pull/80299) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлено некорректное поведение функций `to_utc_timestamp` и `from_utc_timestamp` при обработке дат до Unix-эпохи (1970-01-01) и после максимально допустимой даты (2106-02-07 06:28:15). Теперь эти функции корректно ограничивают значения началом эпохи и максимально допустимой датой соответственно. [#80498](https://github.com/ClickHouse/ClickHouse/pull/80498) ([Surya Kant Ranjan](https://github.com/iit2009046)).
* Для некоторых запросов, выполняемых с использованием параллельных реплик, оптимизации чтения по порядку могли применяться на инициаторе, но не применялись на удалённых узлах. Это приводило к тому, что координатор параллельных реплик (на инициаторе) и удалённые узлы использовали разные режимы чтения, что является логической ошибкой. [#80652](https://github.com/ClickHouse/ClickHouse/pull/80652) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлена логическая ошибка при материализации проекции, возникавшая при изменении типа столбца на Nullable. [#80741](https://github.com/ClickHouse/ClickHouse/pull/80741) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен некорректный перерасчёт TTL в `TTL GROUP BY` при обновлении TTL. [#81222](https://github.com/ClickHouse/ClickHouse/pull/81222) ([Evgeniy Ulasik](https://github.com/H0uston)).
* Исправлена ошибка, из-за которой bloom-фильтр Parquet при условии вида `WHERE function(key) IN (...)` применялся так, как будто это было `WHERE key IN (...)`. [#81255](https://github.com/ClickHouse/ClickHouse/pull/81255) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлен возможный сбой в `Aggregator` при возникновении исключения во время слияния. [#81450](https://github.com/ClickHouse/ClickHouse/pull/81450) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлен `InterpreterInsertQuery::extendQueryLogElemImpl`, чтобы при необходимости добавлять обратные кавычки к именам баз данных и таблиц (например, когда имена содержат специальные символы, такие как `-`). [#81528](https://github.com/ClickHouse/ClickHouse/pull/81528) ([Ilia Shvyrialkin](https://github.com/Harzu)).
* Исправлено выполнение `IN` с `transform_null_in=1` при наличии `null` в левом аргументе и не допускающим `NULL` результатом подзапроса. [#81584](https://github.com/ClickHouse/ClickHouse/pull/81584) ([Pavel Kruglov](https://github.com/Avogar)).
* Не выполнять проверку экспериментальных/подозрительных типов в выражениях DEFAULT/MATERIALIZE при чтении из существующей таблицы. [#81618](https://github.com/ClickHouse/ClickHouse/pull/81618) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка «Context has expired» во время слияний при использовании dict в выражении TTL. [#81690](https://github.com/ClickHouse/ClickHouse/pull/81690) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена монотонность функции `cast`. [#81722](https://github.com/ClickHouse/ClickHouse/pull/81722) ([zoomxi](https://github.com/zoomxi)).
* Исправлена проблема, из-за которой необходимые столбцы не считывались при обработке скалярного коррелированного подзапроса. Исправляет [#81716](https://github.com/ClickHouse/ClickHouse/issues/81716). [#81805](https://github.com/ClickHouse/ClickHouse/pull/81805) ([Dmitry Novik](https://github.com/novikd)).
* В предыдущих версиях сервер возвращал избыточный объём данных для запросов к `/js`. Это решает [#61890](https://github.com/ClickHouse/ClickHouse/issues/61890). [#81895](https://github.com/ClickHouse/ClickHouse/pull/81895) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Ранее в определениях движка таблиц `MongoDB` мог указываться компонент пути в аргументе `host:port`, который просто игнорировался. Интеграция с mongodb отказывается загружать такие таблицы. С этим исправлением *мы разрешаем загрузку таких таблиц и игнорируем компонент пути*, если у движка `MongoDB` пять аргументов, используя имя базы данных из этих аргументов. *Примечание:* Исправление не применяется к заново создаваемым таблицам или к запросам с табличной функцией `mongo`, а также к источникам словарей и именованным коллекциям. [#81942](https://github.com/ClickHouse/ClickHouse/pull/81942) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлен возможный сбой в `Aggregator` при возникновении исключения во время слияния. [#82022](https://github.com/ClickHouse/ClickHouse/pull/82022) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлен анализ фильтра, когда в запросе используется только константный псевдоним столбца. Исправляет [#79448](https://github.com/ClickHouse/ClickHouse/issues/79448). [#82037](https://github.com/ClickHouse/ClickHouse/pull/82037) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена ошибка `LOGICAL_ERROR` и последующий сбой при использовании одного и того же столбца в `TTL` для `GROUP BY` и `SET`. [#82054](https://github.com/ClickHouse/ClickHouse/pull/82054) ([Pablo Marcos](https://github.com/pamarcos)).
* Исправлена проверка аргументов табличной функции S3 при маскировании секретов, что предотвращает возможную `LOGICAL_ERROR`, закрыта [#80620](https://github.com/ClickHouse/ClickHouse/issues/80620). [#82056](https://github.com/ClickHouse/ClickHouse/pull/82056) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлены состояния гонки в Iceberg. [#82088](https://github.com/ClickHouse/ClickHouse/pull/82088) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен `DatabaseReplicated::getClusterImpl`. Если первый элемент (или элементы) `hosts` имеет `id == DROPPED_MARK` и нет других элементов для того же шарда, первый элемент `shards` окажется пустым вектором, что приведёт к `std::out_of_range`. [#82093](https://github.com/ClickHouse/ClickHouse/pull/82093) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Исправлена ошибка, возникшая из‑за копирования и вставки, в arraySimilarity, запрещено использование весов типов UInt32 и Int32. Обновлены тесты и документация. [#82103](https://github.com/ClickHouse/ClickHouse/pull/82103) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Исправлена ошибка `Not found column` для запросов с `arrayJoin` в условии `WHERE` при использовании `IndexSet`. [#82113](https://github.com/ClickHouse/ClickHouse/pull/82113) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка в интеграции с Glue Catalog. Теперь ClickHouse может читать таблицы с вложенными типами данных, где некоторые из подстолбцов содержат числа с фиксированной точкой, например: `map<string, decimal(9, 2)>`. Исправляет [#81301](https://github.com/ClickHouse/ClickHouse/issues/81301). [#82114](https://github.com/ClickHouse/ClickHouse/pull/82114) ([alesapin](https://github.com/alesapin)).
* Исправлена деградация производительности в SummingMergeTree, появившаяся в 25.5 из‑за изменений в [https://github.com/ClickHouse/ClickHouse/pull/79051](https://github.com/ClickHouse/ClickHouse/pull/79051). [#82130](https://github.com/ClickHouse/ClickHouse/pull/82130) ([Pavel Kruglov](https://github.com/Avogar)).
* При передаче настроек через URI учитывается последнее указанное значение. [#82137](https://github.com/ClickHouse/ClickHouse/pull/82137) ([Sema Checherinda](https://github.com/CheSema)).
* Исправлено сообщение об ошибке «Context has expired» для Iceberg. [#82146](https://github.com/ClickHouse/ClickHouse/pull/82146) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен возможный дедлок при выполнении удалённых запросов при дефиците памяти на сервере. [#82160](https://github.com/ClickHouse/ClickHouse/pull/82160) ([Kirill](https://github.com/kirillgarbar)).
* Исправлено переполнение в функциях `numericIndexedVectorPointwiseAdd`, `numericIndexedVectorPointwiseSubtract`, `numericIndexedVectorPointwiseMultiply` и `numericIndexedVectorPointwiseDivide`, которое возникало при их применении к большим числам. [#82165](https://github.com/ClickHouse/ClickHouse/pull/82165) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Исправлена ошибка в зависимостях таблиц, из-за которой материализованные представления пропускали запросы `INSERT`. [#82222](https://github.com/ClickHouse/ClickHouse/pull/82222) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена возможная гонка данных между потоком предложений и основным потоком клиента. [#82233](https://github.com/ClickHouse/ClickHouse/pull/82233) ([Azat Khuzhin](https://github.com/azat)).
* Теперь ClickHouse может читать таблицы Iceberg из каталога Glue после изменения схемы. Исправляет [#81272](https://github.com/ClickHouse/ClickHouse/issues/81272). [#82301](https://github.com/ClickHouse/ClickHouse/pull/82301) ([alesapin](https://github.com/alesapin)).
* Исправлена проверка настроек асинхронных метрик `asynchronous_metrics_update_period_s` и `asynchronous_heavy_metrics_update_period_s`. [#82310](https://github.com/ClickHouse/ClickHouse/pull/82310) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлена логическая ошибка при разрешении сопоставителя в запросе с несколькими JOIN, закрыт [#81969](https://github.com/ClickHouse/ClickHouse/issues/81969). [#82421](https://github.com/ClickHouse/ClickHouse/pull/82421) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Добавлено время истечения срока действия токена AWS ECS, чтобы его можно было обновлять. [#82422](https://github.com/ClickHouse/ClickHouse/pull/82422) ([Konstantин Богданов](https://github.com/thevar1able)).
* Исправлена ошибка обработки аргументов `NULL` в функции `CASE`. [#82436](https://github.com/ClickHouse/ClickHouse/pull/82436) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлены гонки данных в клиенте (за счёт отказа от использования глобального контекста) и обработка переопределений `session_timezone` (ранее, если `session_timezone` был установлен, например, в `users.xml`/опциях клиента в непустое значение, а в контексте запроса — в пустое, то использовалось значение из `users.xml`, что неверно; теперь контекст запроса всегда имеет приоритет над глобальным контекстом). [#82444](https://github.com/ClickHouse/ClickHouse/pull/82444) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено отключение выравнивания по границе для кэшированного буфера во внешних движках таблиц. Функциональность была нарушена в [https://github.com/ClickHouse/ClickHouse/pull/81868](https://github.com/ClickHouse/ClickHouse/pull/81868). [#82493](https://github.com/ClickHouse/ClickHouse/pull/82493) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено падение при соединении key-value-хранилища с ключом, к которому применено приведение типа. [#82497](https://github.com/ClickHouse/ClickHouse/pull/82497) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлено скрытие значений именованных коллекций в logs/query&#95;log. Закрывает [#82405](https://github.com/ClickHouse/ClickHouse/issues/82405). [#82510](https://github.com/ClickHouse/ClickHouse/pull/82510) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена возможная ошибка при логировании во время завершения сеанса, так как `user_id` иногда может быть пустым. [#82513](https://github.com/ClickHouse/ClickHouse/pull/82513) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлены случаи, когда разбор `Time` мог приводить к msan-проблемам. Это исправляет: [#82477](https://github.com/ClickHouse/ClickHouse/issues/82477). [#82514](https://github.com/ClickHouse/ClickHouse/pull/82514) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Запрещена установка `threadpool_writer_pool_size` в ноль, чтобы предотвратить зависание операций сервера. [#82532](https://github.com/ClickHouse/ClickHouse/pull/82532) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлена ошибка `LOGICAL_ERROR` при анализе выражения построчной политики (row policy) для коррелированных столбцов. [#82618](https://github.com/ClickHouse/ClickHouse/pull/82618) ([Dmitry Novik](https://github.com/novikd)).
* Исправлено некорректное использование родительских метаданных в табличной функции `mergeTreeProjection`, когда `enable_shared_storage_snapshot_in_query = 1`. Это для [#82634](https://github.com/ClickHouse/ClickHouse/issues/82634). [#82638](https://github.com/ClickHouse/ClickHouse/pull/82638) ([Amos Bird](https://github.com/amosbird)).
* Функции `trim{Left,Right,Both}` теперь поддерживают входные строки типа `FixedString(N)`. Например, `SELECT trimBoth(toFixedString('abc', 3), 'ac')` теперь работает. [#82691](https://github.com/ClickHouse/ClickHouse/pull/82691) ([Robert Schulze](https://github.com/rschu1ze)).
* В AzureBlobStorage для нативного копирования мы сравниваем методы аутентификации, и если при этом возникает исключение, код изменён так, чтобы выполнялся откат к чтению и копированию (т.е. ненативному копированию). [#82693](https://github.com/ClickHouse/ClickHouse/pull/82693) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Исправлена десериализация `groupArraySample`/`groupArrayLast` в случае пустых элементов (при пустом вводе десериализация могла пропустить часть бинарных данных, что могло приводить к повреждению данных при чтении и к UNKNOWN&#95;PACKET&#95;FROM&#95;SERVER в протоколе TCP). Это не затрагивает числовые типы и типы даты/времени. [#82763](https://github.com/ClickHouse/ClickHouse/pull/82763) ([Pedro Ferreira](https://github.com/PedroTadim)).
* Исправлена проблема с созданием бэкапа пустой таблицы `Memory`, из-за которой восстановление из бэкапа завершалось с ошибкой `BACKUP_ENTRY_NOT_FOUND`. [#82791](https://github.com/ClickHouse/ClickHouse/pull/82791) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлена гарантия безопасности при возникновении исключений в переписывании union/intersect/except&#95;default&#95;mode. Закрывает [#82664](https://github.com/ClickHouse/ClickHouse/issues/82664). [#82820](https://github.com/ClickHouse/ClickHouse/pull/82820) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Отслеживать количество заданий на асинхронную загрузку таблиц. Если есть выполняющиеся задания, не обновлять `tail_ptr` в `TransactionLog::removeOldEntries`. [#82824](https://github.com/ClickHouse/ClickHouse/pull/82824) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлены состояния гонки (data races) в Iceberg. [#82841](https://github.com/ClickHouse/ClickHouse/pull/82841) ([Azat Khuzhin](https://github.com/azat)).
* Настройка оптимизации `use_skip_indexes_if_final_exact_mode` (введённой в версии 25.6) могла приводить к тому, что в зависимости от настроек движка `MergeTree` и распределения данных не выбирался корректный диапазон-кандидат. Сейчас это исправлено. [#82879](https://github.com/ClickHouse/ClickHouse/pull/82879) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Установлена соль для данных аутентификации при разборе из AST с типом SCRAM&#95;SHA256&#95;PASSWORD. [#82888](https://github.com/ClickHouse/ClickHouse/pull/82888) ([Tuan Pham Anh](https://github.com/tuanpach)).
* При использовании некеширующей реализации Database метаданные соответствующей таблицы удаляются после возврата столбцов и аннулирования ссылки. [#82939](https://github.com/ClickHouse/ClickHouse/pull/82939) ([buyval01](https://github.com/buyval01)).
* Исправлена модификация фильтра для запросов с выражением JOIN с таблицей с движком `Merge`. Исправлено [#82092](https://github.com/ClickHouse/ClickHouse/issues/82092). [#82950](https://github.com/ClickHouse/ClickHouse/pull/82950) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена LOGICAL&#95;ERROR в QueryMetricLog: мьютекс не может быть NULL. [#82979](https://github.com/ClickHouse/ClickHouse/pull/82979) ([Pablo Marcos](https://github.com/pamarcos)).
* Исправлен некорректный вывод функции `formatDateTime` при использовании спецификатора `%f` вместе со спецификаторами переменной длины (например, `%M`). [#83020](https://github.com/ClickHouse/ClickHouse/pull/83020) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена деградация производительности с включённым analyzer, когда вторичные запросы всегда читают все столбцы из VIEW. Исправление для [#81718](https://github.com/ClickHouse/ClickHouse/issues/81718). [#83036](https://github.com/ClickHouse/ClickHouse/pull/83036) ([Dmitry Novik](https://github.com/novikd)).
* Исправлено некорректное сообщение об ошибке при восстановлении резервной копии на диске только для чтения. [#83051](https://github.com/ClickHouse/ClickHouse/pull/83051) ([Julia Kartseva](https://github.com/jkartseva)).
* Не выполнять проверку циклических зависимостей при создании таблиц без зависимостей. Это исправляет деградацию производительности в сценариях с созданием тысяч таблиц, которая была внесена изменением [https://github.com/ClickHouse/ClickHouse/pull/65405](https://github.com/ClickHouse/ClickHouse/pull/65405). [#83077](https://github.com/ClickHouse/ClickHouse/pull/83077) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправляет проблему с неявным чтением отрицательных значений типа Time в таблицу и делает документацию менее запутанной. [#83091](https://github.com/ClickHouse/ClickHouse/pull/83091) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Не используйте посторонние части общего словаря в функции `lowCardinalityKeys`. [#83118](https://github.com/ClickHouse/ClickHouse/pull/83118) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена регрессия при использовании подстолбцов с материализованными представлениями. Исправлено: [#82784](https://github.com/ClickHouse/ClickHouse/issues/82784). [#83221](https://github.com/ClickHouse/ClickHouse/pull/83221) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлен сбой в клиенте из‑за соединения, оставшегося в состоянии отключения после некорректного INSERT. [#83253](https://github.com/ClickHouse/ClickHouse/pull/83253) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено падение при вычислении размера блока с пустыми столбцами. [#83271](https://github.com/ClickHouse/ClickHouse/pull/83271) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена возможная ошибка с типом Variant в UNION. [#83295](https://github.com/ClickHouse/ClickHouse/pull/83295) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка `LOGICAL_ERROR` в `clickhouse-local` при выполнении неподдерживаемых запросов `SYSTEM`. [#83333](https://github.com/ClickHouse/ClickHouse/pull/83333) ([Surya Kant Ranjan](https://github.com/iit2009046)).
* Исправлен параметр `no_sign_request` для клиента S3. Его можно использовать для явного отключения подписи запросов к S3. Его также можно задать для отдельных конечных точек с помощью настроек, зависящих от конечной точки. [#83379](https://github.com/ClickHouse/ClickHouse/pull/83379) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправляет сбой, который может произойти при выполнении запроса с настройкой &#39;max&#95;threads=1&#39; под нагрузкой при включённом планировании CPU. [#83387](https://github.com/ClickHouse/ClickHouse/pull/83387) ([Fan Ziqi](https://github.com/f2quantum)).
* Исправлено исключение `TOO_DEEP_SUBQUERIES`, возникавшее, когда определение CTE ссылалось на другое табличное выражение с тем же именем. [#83413](https://github.com/ClickHouse/ClickHouse/pull/83413) ([Dmitry Novik](https://github.com/novikd)).
* Исправлено некорректное поведение, при котором выполнение `REVOKE S3 ON system.*` отзывает права S3 для `*.*`. Это исправляет [#83417](https://github.com/ClickHouse/ClickHouse/issues/83417). [#83420](https://github.com/ClickHouse/ClickHouse/pull/83420) ([pufit](https://github.com/pufit)).
* Не используйте общий async&#95;read&#95;counters между запросами. [#83423](https://github.com/ClickHouse/ClickHouse/pull/83423) ([Azat Khuzhin](https://github.com/azat)).
* Отключать параллельные реплики, если подзапрос содержит FINAL. [#83455](https://github.com/ClickHouse/ClickHouse/pull/83455) ([zoomxi](https://github.com/zoomxi)).
* Исправлено незначительное целочисленное переполнение в конфигурации настройки `role_cache_expiration_time_seconds` (issue [#83374](https://github.com/ClickHouse/ClickHouse/issues/83374)). [#83461](https://github.com/ClickHouse/ClickHouse/pull/83461) ([wushap](https://github.com/wushap)).
* Исправлена ошибка, появившаяся в [https://github.com/ClickHouse/ClickHouse/pull/79963](https://github.com/ClickHouse/ClickHouse/pull/79963). При вставке в MV с `definer` проверка прав должна использовать права `definer`. Это исправляет [#79951](https://github.com/ClickHouse/ClickHouse/issues/79951). [#83502](https://github.com/ClickHouse/ClickHouse/pull/83502) ([pufit](https://github.com/pufit)).
* Отключён отсев файлов, основанный на граничных значениях, для значений элементов массивов и словарей Iceberg, включая все их вложенные подполе. [#83520](https://github.com/ClickHouse/ClickHouse/pull/83520) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлена возможная ошибка «file cache not initialized» при использовании файлового кэша для временного хранения данных. [#83539](https://github.com/ClickHouse/ClickHouse/pull/83539) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправление в Keeper: корректное обновление общего количества наблюдений при удалении эфемерных узлов при закрытии сессии. [#83583](https://github.com/ClickHouse/ClickHouse/pull/83583) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена некорректная работа с памятью, связанная с max&#95;untracked&#95;memory. [#83607](https://github.com/ClickHouse/ClickHouse/pull/83607) ([Azat Khuzhin](https://github.com/azat)).
* INSERT SELECT с UNION ALL мог приводить к разыменованию нулевого указателя в граничном случае. Это исправляет [#83618](https://github.com/ClickHouse/ClickHouse/issues/83618). [#83643](https://github.com/ClickHouse/ClickHouse/pull/83643) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Запрещено использовать нулевое значение для `max_insert_block_size`, так как оно может привести к логической ошибке. [#83688](https://github.com/ClickHouse/ClickHouse/pull/83688) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлен бесконечный цикл в estimateCompressionRatio() при block&#95;size&#95;bytes = 0. [#83704](https://github.com/ClickHouse/ClickHouse/pull/83704) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены метрики `IndexUncompressedCacheBytes`/`IndexUncompressedCacheCells`/`IndexMarkCacheBytes`/`IndexMarkCacheFiles` (раньше они включались в метрику без префикса `Cache`). [#83730](https://github.com/ClickHouse/ClickHouse/pull/83730) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена возможная аварийная остановка (из-за присоединения потоков из задачи) и, вероятно, зависания (в модульных тестах) во время завершения работы `BackgroundSchedulePool`. [#83769](https://github.com/ClickHouse/ClickHouse/pull/83769) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена настройка обратной совместимости, позволяющая новому анализатору ссылаться на внешний псевдоним в предложении WITH в случае конфликтов имён. Исправление [#82700](https://github.com/ClickHouse/ClickHouse/issues/82700). [#83797](https://github.com/ClickHouse/ClickHouse/pull/83797) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена взаимоблокировка при завершении работы из-за рекурсивной блокировки контекста во время очистки моста библиотек (library bridge). [#83824](https://github.com/ClickHouse/ClickHouse/pull/83824) ([Azat Khuzhin](https://github.com/azat)).

#### Улучшения сборки/тестирования/упаковки

- Создана минимальная библиотека C (10 КБ) для лексера ClickHouse. Это необходимо для [#80977](https://github.com/ClickHouse/ClickHouse/issues/80977). [#81347](https://github.com/ClickHouse/ClickHouse/pull/81347) ([Alexey Milovidov](https://github.com/alexey-milovidov)). Добавлен тест для автономного лексера, добавлен тег теста `fasttest-only`. [#82472](https://github.com/ClickHouse/ClickHouse/pull/82472) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Добавлена проверка входных данных подмодуля Nix. [#81691](https://github.com/ClickHouse/ClickHouse/pull/81691) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Исправлен ряд проблем, которые могут возникать при попытке запуска интеграционных тестов на localhost. [#82135](https://github.com/ClickHouse/ClickHouse/pull/82135) ([Oleg Doronin](https://github.com/dorooleg)).
- Компиляция SymbolIndex на Mac и FreeBSD. (Но работать будет только на ELF-системах, Linux и FreeBSD). [#82347](https://github.com/ClickHouse/ClickHouse/pull/82347) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Обновлен Azure SDK до версии v1.15.0. [#82747](https://github.com/ClickHouse/ClickHouse/pull/82747) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
- Добавлен модуль storage из google-cloud-cpp в систему сборки. [#82881](https://github.com/ClickHouse/ClickHouse/pull/82881) ([Pablo Marcos](https://github.com/pamarcos)).
- Изменен `Dockerfile.ubuntu` для clickhouse-server в соответствии с требованиями Docker Official Library. [#83039](https://github.com/ClickHouse/ClickHouse/pull/83039) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Дополнение к [#83158](https://github.com/ClickHouse/ClickHouse/issues/83158) для исправления загрузки сборок на `curl clickhouse.com`. [#83463](https://github.com/ClickHouse/ClickHouse/pull/83463) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Добавлен бинарный файл `busybox` и инструменты установки в образы `clickhouse/clickhouse-server` и официальные образы `clickhouse`. [#83735](https://github.com/ClickHouse/ClickHouse/pull/83735) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Добавлена поддержка переменной окружения `CLICKHOUSE_HOST` для указания хоста сервера ClickHouse, что согласуется с существующими переменными окружения `CLICKHOUSE_USER` и `CLICKHOUSE_PASSWORD`. Это позволяет упростить конфигурацию без непосредственного изменения клиентских или конфигурационных файлов. [#83659](https://github.com/ClickHouse/ClickHouse/pull/83659) ([Doron David](https://github.com/dorki)).

### Релиз ClickHouse 25.6, 2025-06-26 {#256}

#### Обратно несовместимые изменения

- Ранее функция `countMatches` прекращала подсчет при первом пустом совпадении, даже если шаблон его допускает. Для решения этой проблемы `countMatches` теперь продолжает выполнение, продвигаясь на один символ при возникновении пустого совпадения. Пользователи, желающие сохранить прежнее поведение, могут включить настройку `count_matches_stop_at_empty_match`. [#81676](https://github.com/ClickHouse/ClickHouse/pull/81676) ([Elmi Ahmadov](https://github.com/ahmadov)).
- Незначительное изменение: серверные настройки `backup_threads` и `restore_threads` теперь должны быть ненулевыми. [#80224](https://github.com/ClickHouse/ClickHouse/pull/80224) ([Raúl Marín](https://github.com/Algunenano)).
- Незначительное изменение: исправление `bitNot` для `String` будет возвращать строку с нулевым завершением во внутреннем представлении памяти. Это не должно влиять на видимое пользователю поведение, однако автор хотел выделить это изменение. [#80791](https://github.com/ClickHouse/ClickHouse/pull/80791) ([Azat Khuzhin](https://github.com/azat)).


#### Новая функция

* Новые типы данных: `Time` ([H]HH:MM:SS) и `Time64` ([H]HH:MM:SS[.fractional]), а также некоторые базовые функции приведения типов и функции для взаимодействия с другими типами данных. Добавлены настройки для совместимости с существующей функцией `toTime`. Параметр `use_legacy_to_time` пока включён для сохранения старого поведения. [#81217](https://github.com/ClickHouse/ClickHouse/pull/81217) ([Yarik Briukhovetskyi](https://github.com/yariks5s)). Добавлена поддержка сравнения значений типов Time/Time64. [#80327](https://github.com/ClickHouse/ClickHouse/pull/80327) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Новый CLI-инструмент [`chdig`](https://github.com/azat/chdig/) — TUI-интерфейс для ClickHouse (в стиле `top`) в составе ClickHouse. [#79666](https://github.com/ClickHouse/ClickHouse/pull/79666) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка настройки `disk` для движков баз данных `Atomic` и `Ordinary`, задающей диск для хранения файлов метаданных таблиц. [#80546](https://github.com/ClickHouse/ClickHouse/pull/80546) ([Tuan Pham Anh](https://github.com/tuanpach)). Это позволяет подключать базы данных из внешних источников.
* Новый тип MergeTree — `CoalescingMergeTree`: движок берёт первое ненулевое (non-Null) значение во время фоновых слияний. Это закрывает [#78869](https://github.com/ClickHouse/ClickHouse/issues/78869). [#79344](https://github.com/ClickHouse/ClickHouse/pull/79344) ([scanhex12](https://github.com/scanhex12)).
* Поддержка функций для чтения WKB («Well-Known Binary» — формат двоичного кодирования различных типов геометрии, используемый в GIS‑приложениях). См. [#43941](https://github.com/ClickHouse/ClickHouse/issues/43941). [#80139](https://github.com/ClickHouse/ClickHouse/pull/80139) ([scanhex12](https://github.com/scanhex12)).
* Добавлено планирование слотов запросов для рабочих нагрузок, подробности см. в разделе [планирования рабочих нагрузок](https://clickhouse.com/docs/operations/workload-scheduling#query_scheduling). [#78415](https://github.com/ClickHouse/ClickHouse/pull/78415) ([Sergei Trifonov](https://github.com/serxa)).
* Вспомогательные функции `timeSeries*` для ускорения некоторых сценариев при работе с временными рядами: - ресемплирование данных на временную сетку с указанными начальной и конечной метками времени и шагом - вычисление PromQL-подобных `delta`, `rate`, `idelta` и `irate`. [#80590](https://github.com/ClickHouse/ClickHouse/pull/80590) ([Alexander Gololobov](https://github.com/davenger)).
* Добавлены функции `mapContainsValuesLike`/`mapContainsValues`/`mapExtractValuesLike` для фильтрации по значениям map и их поддержка в индекcах на основе bloom-фильтров. [#78171](https://github.com/ClickHouse/ClickHouse/pull/78171) ([UnamedRus](https://github.com/UnamedRus)).
* Теперь в ограничениях настроек можно указывать набор запрещённых значений. [#78499](https://github.com/ClickHouse/ClickHouse/pull/78499) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлена настройка `enable_shared_storage_snapshot_in_query` для включения совместного использования одного и того же снапшота хранилища во всех подзапросах одного запроса. Это обеспечивает согласованное чтение из одной и той же таблицы, даже если таблица упоминается в запросе несколько раз. [#79471](https://github.com/ClickHouse/ClickHouse/pull/79471) ([Amos Bird](https://github.com/amosbird)).
* Поддерживает запись столбцов `JSON` в `Parquet` и прямое чтение столбцов `JSON` из `Parquet`. [#79649](https://github.com/ClickHouse/ClickHouse/pull/79649) ([Nihal Z. Miaji](https://github.com/nihalzp)).
* Добавлена поддержка типа `MultiPolygon` для функции `pointInPolygon`. [#79773](https://github.com/ClickHouse/ClickHouse/pull/79773) ([Nihal Z. Miaji](https://github.com/nihalzp)).
* Добавлена поддержка выполнения запросов к таблицам Delta, примонтированным к локальной файловой системе, с помощью табличной функции `deltaLakeLocal`. [#79781](https://github.com/ClickHouse/ClickHouse/pull/79781) ([roykim98](https://github.com/roykim98)).
* Добавлена новая настройка `cast_string_to_date_time_mode`, которая позволяет выбрать режим разбора `DateTime` при приведении из `String`. [#80210](https://github.com/ClickHouse/ClickHouse/pull/80210) ([Pavel Kruglov](https://github.com/Avogar)). Например, вы можете установить для неё режим best effort.
* Добавлены функции `bech32Encode` и `bech32Decode` для работы с алгоритмом Bech в Bitcoin (issue [#40381](https://github.com/ClickHouse/ClickHouse/issues/40381)). [#80239](https://github.com/ClickHouse/ClickHouse/pull/80239) ([George Larionov](https://github.com/glarik)).
* Добавлены SQL-функции для анализа названий частей MergeTree. [#80573](https://github.com/ClickHouse/ClickHouse/pull/80573) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Добавлена возможность фильтровать части, выбранные запросом, по диску, на котором они находятся, с помощью нового виртуального столбца `_disk_name`. [#80650](https://github.com/ClickHouse/ClickHouse/pull/80650) ([tanner-bruce](https://github.com/tanner-bruce)).
* Добавлена стартовая страница со списком встроенных веб-инструментов. Она будет открываться при запросе от пользовательского агента, подобного браузеру. [#81129](https://github.com/ClickHouse/ClickHouse/pull/81129) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Функции `arrayFirst`, `arrayFirstIndex`, `arrayLast` и `arrayLastIndex` будут отфильтровывать значения NULL, возвращаемые выражением фильтра. В предыдущих версиях результаты фильтрации с типом Nullable не поддерживались. Исправляет [#81113](https://github.com/ClickHouse/ClickHouse/issues/81113). [#81197](https://github.com/ClickHouse/ClickHouse/pull/81197) ([Lennard Eijsackers](https://github.com/Blokje5)).
* Теперь можно использовать команду `USE DATABASE name` вместо `USE name`. [#81307](https://github.com/ClickHouse/ClickHouse/pull/81307) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена новая системная таблица `system.codecs` для исследования доступных кодеков. (issue [#81525](https://github.com/ClickHouse/ClickHouse/issues/81525)). [#81600](https://github.com/ClickHouse/ClickHouse/pull/81600) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
* Поддержка оконных функций `lag` и `lead`. Закрывает [#9887](https://github.com/ClickHouse/ClickHouse/issues/9887). [#82108](https://github.com/ClickHouse/ClickHouse/pull/82108) ([Dmitry Novik](https://github.com/novikd)).
* Функция `tokens` теперь поддерживает новый токенизатор `split`, который хорошо подходит для логов. [#80195](https://github.com/ClickHouse/ClickHouse/pull/80195) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка аргумента `--database` в `clickhouse-local`. Теперь можно переключаться на ранее созданную базу данных. Это закрывает [#44115](https://github.com/ClickHouse/ClickHouse/issues/44115). [#81465](https://github.com/ClickHouse/ClickHouse/pull/81465) ([Alexey Milovidov](https://github.com/alexey-milovidov)).



#### Экспериментальная функция
* Реализована логика перераспределения по аналогии с Kafka для `Kafka2` с использованием ClickHouse Keeper. Для каждой реплики поддерживаются два типа блокировок партиций: постоянные и временные. Реплика пытается удерживать постоянные блокировки как можно дольше; в любой момент времени на реплике не больше чем `all_topic_partitions / active_replicas_count` (где `all_topic_partitions` — количество всех партиций, `active_replicas_count` — количество активных реплик) постоянных блокировок. Если их больше, реплика освобождает часть партиций. Некоторые партиции временно удерживаются репликой. Максимальное количество временных блокировок на реплике динамически изменяется, чтобы дать другим репликам возможность взять часть партиций в постоянные блокировки. При обновлении временных блокировок реплика освобождает их все и пытается снова захватить некоторые другие. [#78726](https://github.com/ClickHouse/ClickHouse/pull/78726) ([Daria Fomina](https://github.com/sinfillo)).
* Улучшение для экспериментального текстового индекса: явные параметры задаются через пары ключ-значение. В настоящий момент поддерживаются параметры: обязательный `tokenizer` и два необязательных — `max_rows_per_postings_list` и `ngram_size`. [#80262](https://github.com/ClickHouse/ClickHouse/pull/80262) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Ранее хранилище `packed` не поддерживалось для полнотекстового индекса, поскольку идентификатор сегмента обновлялся «на лету» путем чтения и записи файла (`.gin_sid`) на диске. В случае хранилища `packed` чтение значения из неподтверждённого (uncommitted) файла не поддерживается, что приводило к проблеме. Теперь это исправлено. [#80852](https://github.com/ClickHouse/ClickHouse/pull/80852) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Экспериментальные индексы типа `gin` (которые мне не нравятся, потому что это внутренняя шутка хакеров PostgreSQL) были переименованы в `text`. Существующие индексы типа `gin` по-прежнему можно загрузить, но при попытке использовать их в поиске они будут выбрасывать исключение (предлагая вместо них использовать индексы `text`). [#80855](https://github.com/ClickHouse/ClickHouse/pull/80855) ([Robert Schulze](https://github.com/rschu1ze)).



#### Улучшение производительности

* Включена поддержка фильтрации с использованием нескольких проекций, позволяющая применять более одной проекции для фильтрации на уровне парта. Это решает [#55525](https://github.com/ClickHouse/ClickHouse/issues/55525). Это второй шаг к реализации индекса проекций, следующий за [#78429](https://github.com/ClickHouse/ClickHouse/issues/78429). [#80343](https://github.com/ClickHouse/ClickHouse/pull/80343) ([Amos Bird](https://github.com/amosbird)).
* По умолчанию использовать политику кэширования `SLRU` в файловом кэше. [#75072](https://github.com/ClickHouse/ClickHouse/pull/75072) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Устранена конкуренция (contention) на этапе Resize в конвейере запросов. [#77562](https://github.com/ClickHouse/ClickHouse/pull/77562) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
* Добавлена возможность вынести (де)сжатие и (де)сериализацию блоков в потоки конвейера вместо одного потока, связанного с сетевым соединением. Управляется настройкой `enable_parallel_blocks_marshalling`. Это должно ускорить распределённые запросы, которые передают значительные объёмы данных между инициатором и удалёнными узлами. [#78694](https://github.com/ClickHouse/ClickHouse/pull/78694) ([Nikita Taranov](https://github.com/nickitat)).
* Улучшена производительность всех типов bloom-фильтров. [Видео с конференции OpenHouse](https://www.youtube.com/watch?v=yIVz0NKwQvA\&pp=ygUQb3BlbmhvdXNlIG9wZW5haQ%3D%3D) [#79800](https://github.com/ClickHouse/ClickHouse/pull/79800) ([Delyan Kratunov](https://github.com/dkratunov)).
* Добавлен оптимальный сценарий в `UniqExactSet::merge` для случая, когда один из наборов пуст. Также теперь, если левый набор (LHS) двухуровневый, а правый (RHS) одноуровневый, мы не выполняем преобразование правого набора в двухуровневый. [#79971](https://github.com/ClickHouse/ClickHouse/pull/79971) ([Nikita Taranov](https://github.com/nickitat)).
* Повышена эффективность повторного использования памяти и снижено количество ошибок страниц при использовании двухуровневых хеш-таблиц. Это должно ускорить выполнение GROUP BY. [#80245](https://github.com/ClickHouse/ClickHouse/pull/80245) ([Jiebin Sun](https://github.com/jiebinn)).
* Избегает ненужных обновлений и снижает конкуренцию за блокировки в кэше условий запроса. [#80247](https://github.com/ClickHouse/ClickHouse/pull/80247) ([Jiebin Sun](https://github.com/jiebinn)).
* Незначительная оптимизация для `concatenateBlocks`. Скорее всего, она будет полезна для параллельного hash join. [#80328](https://github.com/ClickHouse/ClickHouse/pull/80328) ([李扬](https://github.com/taiyang-li)).
* При выборе диапазонов меток из диапазона первичного ключа двоичный поиск не может быть использован, если к первичному ключу применены функции. Этот PR смягчает это ограничение: двоичный поиск по‑прежнему может быть применён, когда к первичному ключу применяется всегда монотонная цепочка функций или когда в RPN присутствует элемент, который всегда истинным. Закрывает [#45536](https://github.com/ClickHouse/ClickHouse/issues/45536). [#80597](https://github.com/ClickHouse/ClickHouse/pull/80597) ([zoomxi](https://github.com/zoomxi)).
* Ускорено завершение работы движка `Kafka` (убрана дополнительная задержка в 3 секунды при наличии нескольких таблиц `Kafka`). [#80796](https://github.com/ClickHouse/ClickHouse/pull/80796) ([Azat Khuzhin](https://github.com/azat)).
* Асинхронные вставки: снижают потребление памяти и повышают производительность запросов `INSERT`. [#80972](https://github.com/ClickHouse/ClickHouse/pull/80972) ([Raúl Marín](https://github.com/Algunenano)).
* Не профилируйте процессоры, если таблица журнала отключена. [#81256](https://github.com/ClickHouse/ClickHouse/pull/81256) ([Raúl Marín](https://github.com/Algunenano)). Это ускоряет выполнение очень коротких запросов.
* Ускорена функция `toFixedString`, когда исходное значение уже имеет нужный формат. [#81257](https://github.com/ClickHouse/ClickHouse/pull/81257) ([Raúl Marín](https://github.com/Algunenano)).
* Не обрабатывать значения квот, если для пользователя нет ограничений. [#81549](https://github.com/ClickHouse/ClickHouse/pull/81549) ([Raúl Marín](https://github.com/Algunenano)). Это ускоряет выполнение очень коротких запросов.
* Исправлена регрессия производительности в системе отслеживания памяти. [#81694](https://github.com/ClickHouse/ClickHouse/pull/81694) ([Michael Kolupaev](https://github.com/al13n321)).
* Улучшена оптимизация ключа шардинга в распределённых запросах. [#78452](https://github.com/ClickHouse/ClickHouse/pull/78452) ([fhw12345](https://github.com/fhw12345)).
* Параллельные реплики: избегайте ожидания медленных неиспользуемых реплик, если все задачи чтения уже назначены другим. [#80199](https://github.com/ClickHouse/ClickHouse/pull/80199) ([Igor Nikonov](https://github.com/devcrafter)).
* Для `parallel_replicas` используется отдельный таймаут подключения, см. настройку `parallel_replicas_connect_timeout_ms`. Ранее настройки `connect_timeout_with_failover_ms`/`connect_timeout_with_failover_secure_ms` использовались в качестве таймаута подключения для запросов с параллельными репликами (1 секунда по умолчанию). [#80421](https://github.com/ClickHouse/ClickHouse/pull/80421) ([Igor Nikonov](https://github.com/devcrafter)).
* В файловой системе с журналированием операция `mkdir` записывается в журнал файловой системы, который затем сбрасывается на диск. На медленном диске это может занимать много времени. Перенесите эту операцию за пределы области действия резервной блокировки. [#81371](https://github.com/ClickHouse/ClickHouse/pull/81371) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отложили чтение файлов манифестов Iceberg до выполнения первого запроса на чтение. [#81619](https://github.com/ClickHouse/ClickHouse/pull/81619) ([Daniil Ivanik](https://github.com/divanik)).
* Разрешить перенос предиката `GLOBAL [NOT] IN` в предложение `PREWHERE`, если применимо. [#79996](https://github.com/ClickHouse/ClickHouse/pull/79996) ([Eduard Karacharov](https://github.com/korowa)).





#### Улучшение

* `EXPLAIN SYNTAX` теперь использует новый анализатор. Он возвращает AST, построенное на основе дерева запроса. Добавлена опция `query_tree_passes` для управления количеством проходов, выполняемых перед преобразованием дерева запроса в AST. [#74536](https://github.com/ClickHouse/ClickHouse/pull/74536) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Реализована уплощённая сериализация для Dynamic и JSON в формате Native, которая позволяет сериализовать и десериализовать данные Dynamic и JSON без специальных структур, таких как shared variant для Dynamic и shared data для JSON. Эту сериализацию можно включить, установив `output_format_native_use_flattened_dynamic_and_json_serialization`. Её можно использовать для упрощения поддержки Dynamic и JSON в протоколе TCP в клиентах на разных языках. [#80499](https://github.com/ClickHouse/ClickHouse/pull/80499) ([Pavel Kruglov](https://github.com/Avogar)).
* Обновление учетных данных `S3` после ошибки `AuthenticationRequired`. [#77353](https://github.com/ClickHouse/ClickHouse/pull/77353) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлены метрики словарей в `system.asynchronous_metrics` — `DictionaryMaxUpdateDelay` — максимальная задержка (в секундах) обновления словаря; `DictionaryTotalFailedUpdates` — количество ошибок с момента последней успешной загрузки во всех словарях. [#78175](https://github.com/ClickHouse/ClickHouse/pull/78175) ([Vlad](https://github.com/codeworse)).
* Добавлено предупреждение о базах данных, которые, возможно, были созданы для сохранения повреждённых таблиц. [#78841](https://github.com/ClickHouse/ClickHouse/pull/78841) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Добавлен виртуальный столбец `_time` в движки `S3Queue` и `AzureQueue`. [#78926](https://github.com/ClickHouse/ClickHouse/pull/78926) ([Anton Ivashkin](https://github.com/ianton-ru)).
* Настройки, управляющие разрывом соединения при перегрузке CPU, сделали поддерживающими горячую перезагрузку. [#79052](https://github.com/ClickHouse/ClickHouse/pull/79052) ([Alexey Katsman](https://github.com/alexkats)).
* Добавлен префикс контейнера к путям данных, отображаемым в `system.tables` для обычных дисков в хранилище Azure Blob, что делает отображение данных согласованным с S3 и GCP. [#79241](https://github.com/ClickHouse/ClickHouse/pull/79241) ([Julia Kartseva](https://github.com/jkartseva)).
* Теперь clickhouse-client и local также принимают параметры запроса в виде `param-<name>` (дефис) наряду с `param_<name>` (нижнее подчёркивание). Это закрывает [#63093](https://github.com/ClickHouse/ClickHouse/issues/63093). [#79429](https://github.com/ClickHouse/ClickHouse/pull/79429) ([Engel Danila](https://github.com/aaaengel)).
* Расширенное предупреждающее сообщение о снижении трафика при копировании данных с локального хранилища в удалённый S3 при включённой проверке контрольных сумм (`checksum`). [#79464](https://github.com/ClickHouse/ClickHouse/pull/79464) ([VicoWu](https://github.com/VicoWu)).
* Ранее, когда `input_format_parquet_max_block_size = 0` (некорректное значение), ClickHouse зависал. Теперь эта проблема исправлена. Это закрывает [#79394](https://github.com/ClickHouse/ClickHouse/issues/79394). [#79601](https://github.com/ClickHouse/ClickHouse/pull/79601) ([abashkeev](https://github.com/abashkeev)).
* Добавлена настройка `throw_on_error` для `startup_scripts`: когда `throw_on_error` установлена в true, сервер не запустится, пока все запросы не завершатся успешно. По умолчанию `throw_on_error` установлена в false, что сохраняет прежнее поведение. [#79732](https://github.com/ClickHouse/ClickHouse/pull/79732) ([Aleksandr Musorin](https://github.com/AVMusorin)).
* Добавлена возможность добавлять `http_response_headers` в `http_handlers` любого типа. [#79975](https://github.com/ClickHouse/ClickHouse/pull/79975) ([Andrey Zvonov](https://github.com/zvonand)).
* Функция `reverse` теперь поддерживает тип данных `Tuple`. Исправление для [#80053](https://github.com/ClickHouse/ClickHouse/issues/80053). [#80083](https://github.com/ClickHouse/ClickHouse/pull/80083) ([flynn](https://github.com/ucasfl)).
* Решена задача [#75817](https://github.com/ClickHouse/ClickHouse/issues/75817): разрешено получать данные `auxiliary_zookeepers` из таблицы `system.zookeeper`. [#80146](https://github.com/ClickHouse/ClickHouse/pull/80146) ([Nikolay Govorov](https://github.com/mrdimidium)).
* Добавлены асинхронные метрики TCP-сокетов сервера. Это улучшает наблюдаемость. Закрывает [#80187](https://github.com/ClickHouse/ClickHouse/issues/80187). [#80188](https://github.com/ClickHouse/ClickHouse/pull/80188) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка `anyLast_respect_nulls` и `any_respect_nulls` как `SimpleAggregateFunction`. [#80219](https://github.com/ClickHouse/ClickHouse/pull/80219) ([Diskein](https://github.com/Diskein)).
* Удалён лишний вызов `adjustCreateQueryForBackup` для реплицируемых баз данных. [#80282](https://github.com/ClickHouse/ClickHouse/pull/80282) ([Vitaly Baranov](https://github.com/vitlibar)).
* Разрешены дополнительные опции (которые идут после `--`, например `-- --config.value='abc'`) в `clickhouse-local` без знака равенства. Закрывает [#80292](https://github.com/ClickHouse/ClickHouse/issues/80292). [#80293](https://github.com/ClickHouse/ClickHouse/pull/80293) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Подсветка метасимволов в запросах `SHOW ... LIKE`. Закрывает [#80275](https://github.com/ClickHouse/ClickHouse/issues/80275). [#80297](https://github.com/ClickHouse/ClickHouse/pull/80297) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сделаны постоянными SQL UDF в `clickhouse-local`. Ранее созданная функция будет загружаться при запуске. Это закрывает [#80085](https://github.com/ClickHouse/ClickHouse/issues/80085). [#80300](https://github.com/ClickHouse/ClickHouse/pull/80300) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено описание в плане выполнения для предварительного шага DISTINCT. [#80330](https://github.com/ClickHouse/ClickHouse/pull/80330) ([UnamedRus](https://github.com/UnamedRus)).
* Добавлена возможность использовать именованные коллекции в ODBC/JDBC. [#80334](https://github.com/ClickHouse/ClickHouse/pull/80334) ([Andrey Zvonov](https://github.com/zvonand)).
* Метрики количества дисков в режиме readonly и повреждённых дисков. Метрики фиксируются при запуске DiskLocalCheckThread. [#80391](https://github.com/ClickHouse/ClickHouse/pull/80391) ([VicoWu](https://github.com/VicoWu)).
* Реализована поддержка хранилища `s3_plain_rewritable` с проекциями. В предыдущих версиях объекты метаданных в S3, ссылающиеся на проекции, не обновлялись при перемещении. Закрывает [#70258](https://github.com/ClickHouse/ClickHouse/issues/70258). [#80393](https://github.com/ClickHouse/ClickHouse/pull/80393) ([Sav](https://github.com/sberss)).
* Команда `SYSTEM UNFREEZE` больше не пытается искать парты на дисках только для чтения (`readonly`) и с однократной записью (`write-once`). Это закрывает [#80430](https://github.com/ClickHouse/ClickHouse/issues/80430). [#80432](https://github.com/ClickHouse/ClickHouse/pull/80432) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Понижен уровень логирования сообщений о слиянии кусков. [#80476](https://github.com/ClickHouse/ClickHouse/pull/80476) ([Hans Krutzer](https://github.com/hkrutzer)).
* Изменено поведение по умолчанию для отсечения разделов (partition pruning) в таблицах Iceberg. [#80583](https://github.com/ClickHouse/ClickHouse/pull/80583) ([Melvyn Peignon](https://github.com/melvynator)).
* Добавлены два новых события `ProfileEvents` для наблюдаемости алгоритмов поиска по индексам: `IndexBinarySearchAlgorithm` и `IndexGenericExclusionSearchAlgorithm`. [#80679](https://github.com/ClickHouse/ClickHouse/pull/80679) ([Pablo Marcos](https://github.com/pamarcos)).
* Не выводить в лог предупреждения о неподдерживаемом `MADV_POPULATE_WRITE` на старых ядрах (чтобы избежать засорения логов). [#80704](https://github.com/ClickHouse/ClickHouse/pull/80704) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка `Date32` и `DateTime64` в выражениях `TTL`. [#80710](https://github.com/ClickHouse/ClickHouse/pull/80710) ([Andrey Zvonov](https://github.com/zvonand)).
* Скорректированы значения совместимости для `max_merge_delayed_streams_for_parallel_write`. [#80760](https://github.com/ClickHouse/ClickHouse/pull/80760) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен сбой: если при попытке удалить временный файл (они используются для сброса временных данных на диск) в деструкторе выбрасывается исключение, программа может аварийно завершиться. [#80776](https://github.com/ClickHouse/ClickHouse/pull/80776) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен модификатор `IF EXISTS` к `SYSTEM SYNC REPLICA`. [#80810](https://github.com/ClickHouse/ClickHouse/pull/80810) ([Raúl Marín](https://github.com/Algunenano)).
* Расширено сообщение об исключении «Having zero bytes, but read range is not finished...», добавлен столбец finished&#95;download&#95;time в `system.filesystem_cache`. [#80849](https://github.com/ClickHouse/ClickHouse/pull/80849) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлен раздел с алгоритмом поиска в вывод `EXPLAIN` при использовании его с indexes = 1. Теперь он показывает либо «binary search», либо «generic exclusion search». [#80881](https://github.com/ClickHouse/ClickHouse/pull/80881) ([Pablo Marcos](https://github.com/pamarcos)).
* В начале 2024 года значение `prefer_column_name_to_alias` было жестко установлено в true для обработчика MySQL, поскольку новый анализатор не был включен по умолчанию. Теперь это ограничение можно снять. [#80916](https://github.com/ClickHouse/ClickHouse/pull/80916) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Теперь `system.iceberg_history` показывает историю для баз данных каталогов, таких как Glue или Iceberg REST. Также для согласованности в `system.iceberg_history` столбцы `table_name` и `database_name` были переименованы в `table` и `database`. [#80975](https://github.com/ClickHouse/ClickHouse/pull/80975) ([alesapin](https://github.com/alesapin)).
* Добавлен режим только для чтения для табличной функции `merge`, поэтому для её использования больше не требуется привилегия `CREATE TEMPORARY TABLE`. [#80981](https://github.com/ClickHouse/ClickHouse/pull/80981) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Улучшена интроспекция кэшей в памяти (информация о кэшах теперь доступна в `system.metrics` взамен неполных `system.asynchronouse_metrics`). В `dashboard.html` добавлено отображение размера кэшей в памяти (в байтах). `VectorSimilarityIndexCacheSize`/`IcebergMetadataFilesCacheSize` были переименованы в `VectorSimilarityIndexCacheBytes`/`IcebergMetadataFilesCacheBytes`. [#81023](https://github.com/ClickHouse/ClickHouse/pull/81023) ([Azat Khuzhin](https://github.com/azat)).
* Игнорировать базы данных с движками, которые не могут содержать таблицы `RocksDB`, при чтении из `system.rocksdb`. [#81083](https://github.com/ClickHouse/ClickHouse/pull/81083) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Разрешены `filesystem_caches` и `named_collections` в конфигурационном файле `clickhouse-local`. [#81105](https://github.com/ClickHouse/ClickHouse/pull/81105) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена подсветка `PARTITION BY` в запросах `INSERT`. В предыдущих версиях `PARTITION BY` не выделялся как ключевое слово. [#81106](https://github.com/ClickHouse/ClickHouse/pull/81106) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Два небольших улучшения в Web UI: - корректная обработка запросов без вывода, таких как `CREATE`, `INSERT` (до недавнего времени эти запросы приводили к бесконечной анимации загрузки); - при двойном щелчке по таблице происходит прокрутка к началу. [#81131](https://github.com/ClickHouse/ClickHouse/pull/81131) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Метрика `MemoryResidentWithoutPageCache` показывает объем физической памяти, используемой серверным процессом (в байтах), за вычетом page cache в пространстве пользователя. Это дает более точное представление о фактическом использовании памяти при задействованном page cache в пространстве пользователя. Когда page cache в пространстве пользователя отключен, это значение совпадает с `MemoryResident`. [#81233](https://github.com/ClickHouse/ClickHouse/pull/81233) ([Jayme Bird](https://github.com/jaymebrd)).
* Пометили вручную записываемые исключения в клиенте, локальном сервере, Keeper client и приложении дисков как уже залогированные, чтобы они не протоколировались дважды. [#81271](https://github.com/ClickHouse/ClickHouse/pull/81271) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Настройки `use_skip_indexes_if_final` и `use_skip_indexes_if_final_exact_mode` теперь по умолчанию равны `True`. Запросы с оператором `FINAL` теперь будут использовать пропускающие индексы (если применимо) для предварительного отбора гранул, а также считывать любые дополнительные гранулы, соответствующие совпадающим диапазонам первичного ключа. Пользователи, которым требуется прежнее поведение с приблизительными/неточными результатами, могут установить `use_skip_indexes_if_final_exact_mode` в `False` после тщательной оценки. [#81331](https://github.com/ClickHouse/ClickHouse/pull/81331) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Если в веб-интерфейсе открыто несколько запросов, будет выполнен тот, на котором находится курсор. Продолжение [#80977](https://github.com/ClickHouse/ClickHouse/issues/80977). [#81354](https://github.com/ClickHouse/ClickHouse/pull/81354) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Этот PR устраняет проблемы с реализацией `is_strict` в проверках монотонности для функций преобразования. В настоящее время некоторые функции преобразования, такие как `toFloat64(UInt32)` и `toDate(UInt8)`, ошибочно возвращают `is_strict` как false, хотя должны возвращать true. [#81359](https://github.com/ClickHouse/ClickHouse/pull/81359) ([zoomxi](https://github.com/zoomxi)).
* При проверке, соответствует ли `KeyCondition` непрерывному диапазону, если ключ обёрнут цепочкой нестрогих функций, `Constraint::POINT` может потребовать преобразования в `Constraint::RANGE`. Например, выражение `toDate(event_time) = '2025-06-03'` подразумевает следующий диапазон для `event_time`: [&#39;2025-06-03 00:00:00&#39;, &#39;2025-06-04 00:00:00&#39;). Этот PR исправляет это поведение. [#81400](https://github.com/ClickHouse/ClickHouse/pull/81400) ([zoomxi](https://github.com/zoomxi)).
* Псевдонимы `clickhouse`/`ch` будут вызывать `clickhouse-client` вместо `clickhouse-local`, если указаны `--host` или `--port`. Продолжение [#79422](https://github.com/ClickHouse/ClickHouse/issues/79422). Закрывает [#65252](https://github.com/ClickHouse/ClickHouse/issues/65252). [#81509](https://github.com/ClickHouse/ClickHouse/pull/81509) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Теперь, когда у нас есть данные о распределении времени отклика Keeper, мы можем точнее настроить интервалы гистограммы для метрик. [#81516](https://github.com/ClickHouse/ClickHouse/pull/81516) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Добавлено событие профилирования `PageCacheReadBytes`. [#81742](https://github.com/ClickHouse/ClickHouse/pull/81742) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена логическая ошибка в файловом кэше: «Having zero bytes but range is not finished». [#81868](https://github.com/ClickHouse/ClickHouse/pull/81868) ([Kseniia Sumarokova](https://github.com/kssenii)).





#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе)

* Исправлен параметризованный представление с запросом SELECT EXCEPT. Закрывает [#49447](https://github.com/ClickHouse/ClickHouse/issues/49447). [#57380](https://github.com/ClickHouse/ClickHouse/pull/57380) ([Nikolay Degterinsky](https://github.com/evillique)).
* Analyzer: Исправлено имя проекции столбца после повышения типа столбца в `JOIN`. Закрывает [#63345](https://github.com/ClickHouse/ClickHouse/issues/63345). [#63519](https://github.com/ClickHouse/ClickHouse/pull/63519) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена логическая ошибка в случаях конфликта имён столбцов при включённой настройке `analyzer_compatibility_join_using_top_level_identifier`. [#75676](https://github.com/ClickHouse/ClickHouse/pull/75676) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлено использование CTE в проталкиваемых предикатах при включённом параметре `allow_push_predicate_ast_for_distributed_subqueries`. Исправляет [#75647](https://github.com/ClickHouse/ClickHouse/issues/75647). Исправляет [#79672](https://github.com/ClickHouse/ClickHouse/issues/79672). [#77316](https://github.com/ClickHouse/ClickHouse/pull/77316) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена проблема, из-за которой SYSTEM SYNC REPLICA LIGHTWEIGHT &#39;foo&#39; сообщала об успехе, даже если указанная реплика не существовала. Теперь команда корректно проверяет наличие реплики в Keeper перед попыткой синхронизации. [#78405](https://github.com/ClickHouse/ClickHouse/pull/78405) ([Jayme Bird](https://github.com/jaymebrd)).
* Исправлено падение в очень специфической ситуации, когда функция `currentDatabase` использовалась в секциях `CONSTRAINT` в запросах с `ON CLUSTER`. Закрывает [#78100](https://github.com/ClickHouse/ClickHouse/issues/78100). [#79070](https://github.com/ClickHouse/ClickHouse/pull/79070) ([pufit](https://github.com/pufit)).
* Исправлена передача внешних ролей во межсерверных запросах. [#79099](https://github.com/ClickHouse/ClickHouse/pull/79099) ([Andrey Zvonov](https://github.com/zvonand)).
* Используйте IColumn вместо Field в SingleValueDataGeneric. Это исправляет некорректные возвращаемые значения для некоторых агрегатных функций, например `argMax` для типов `Dynamic/Variant/JSON`. [#79166](https://github.com/ClickHouse/ClickHouse/pull/79166) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено применение настроек `use_native_copy` и `allow_azure_native_copy` для Azure Blob Storage и изменено поведение так, чтобы нативное копирование использовалось только при совпадении учетных данных, что решает проблему [#78964](https://github.com/ClickHouse/ClickHouse/issues/78964). [#79561](https://github.com/ClickHouse/ClickHouse/pull/79561) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Исправлены логические ошибки, связанные с неизвестной областью происхождения столбца, возникающие при проверке на коррелированность этого столбца. Исправляет [#78183](https://github.com/ClickHouse/ClickHouse/issues/78183). Исправляет [#79451](https://github.com/ClickHouse/ClickHouse/issues/79451). [#79727](https://github.com/ClickHouse/ClickHouse/pull/79727) ([Dmitry Novik](https://github.com/novikd)).
* Исправлены некорректные результаты для grouping sets с ColumnConst и Analyzer. [#79743](https://github.com/ClickHouse/ClickHouse/pull/79743) ([Andrey Zvonov](https://github.com/zvonand)).
* Исправлено дублирование результатов от локального шарда при чтении из распределённой таблицы, когда локальная реплика устарела. [#79761](https://github.com/ClickHouse/ClickHouse/pull/79761) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлен порядок сортировки значений NaN с установленным отрицательным знаковым битом. [#79847](https://github.com/ClickHouse/ClickHouse/pull/79847) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Теперь `GROUP BY ALL` не учитывает оператор `GROUPING`. [#79915](https://github.com/ClickHouse/ClickHouse/pull/79915) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлено некорректное слияние состояний для функций `TopK` / `TopKWeighted`, которое приводило к чрезмерной погрешности даже при не исчерпанной вместимости. [#79939](https://github.com/ClickHouse/ClickHouse/pull/79939) ([Joel Höner](https://github.com/athre0z)).
* Учитывать параметр `readonly` в объектном хранилище `azure_blob_storage`. [#79954](https://github.com/ClickHouse/ClickHouse/pull/79954) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлены некорректные результаты запросов и аварийные завершения из-за нехватки памяти при использовании `match(column, '^…')` с символами, экранированными обратной косой чертой. [#79969](https://github.com/ClickHouse/ClickHouse/pull/79969) ([filimonov](https://github.com/filimonov)).
* Отключение hive-разбиения для дата-озёр. Частично решает [https://github.com/issues/assigned?issue=ClickHouse%7CClickHouse%7C79937](https://github.com/issues/assigned?issue=ClickHouse%7CClickHouse%7C79937). [#80005](https://github.com/ClickHouse/ClickHouse/pull/80005) ([Daniil Ivanik](https://github.com/divanik)).
* Индексы пропуска с lambda-выражениями не применялись. Исправлен случай, когда высокоуровневые функции в определении индекса в точности совпадают с функциями в запросе. [#80025](https://github.com/ClickHouse/ClickHouse/pull/80025) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена версия метаданных при присоединении парта на реплике, выполняющей команду ATTACH&#95;PART из журнала репликации. [#80038](https://github.com/ClickHouse/ClickHouse/pull/80038) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Имена исполняемых пользовательских функций (eUDF) в отличие от других функций не добавляются в столбец `used_functions` таблицы `system.query_log`. В этом PR добавляется имя eUDF, если eUDF была использована в запросе. [#80073](https://github.com/ClickHouse/ClickHouse/pull/80073) ([Kyamran](https://github.com/nibblerenush)).
* Исправлена логическая ошибка в формате Arrow для `LowCardinality(FixedString)`. [#80156](https://github.com/ClickHouse/ClickHouse/pull/80156) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено чтение подстолбцов из движка Merge. [#80158](https://github.com/ClickHouse/ClickHouse/pull/80158) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка сравнения числовых типов в `KeyCondition`. [#80207](https://github.com/ClickHouse/ClickHouse/pull/80207) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена ошибка AMBIGUOUS&#95;COLUMN&#95;NAME при применении отложенной материализации к таблице с проекциями. [#80251](https://github.com/ClickHouse/ClickHouse/pull/80251) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлена некорректная оптимизация `count` для фильтров по строковому префиксу, таких как LIKE &#39;ab&#95;c%&#39;, при использовании неявных проекций. Это исправляет [#80250](https://github.com/ClickHouse/ClickHouse/issues/80250). [#80261](https://github.com/ClickHouse/ClickHouse/pull/80261) ([Amos Bird](https://github.com/amosbird)).
* Исправлена некорректная сериализация вложенных числовых полей как строк в документах MongoDB. Убрано ограничение на максимальную глубину документов из MongoDB. [#80289](https://github.com/ClickHouse/ClickHouse/pull/80289) ([Kirill Nikiforov](https://github.com/allmazz)).
* Менее строгие проверки метаданных для RMT в реплицируемой базе данных. Закрывает [#80296](https://github.com/ClickHouse/ClickHouse/issues/80296). [#80298](https://github.com/ClickHouse/ClickHouse/pull/80298) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлено текстовое представление типов `DateTime` и `DateTime64` при использовании хранилища PostgreSQL. [#80301](https://github.com/ClickHouse/ClickHouse/pull/80301) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Добавлена поддержка `DateTime` с часовым поясом в таблицах `StripeLog`. Это закрывает [#44120](https://github.com/ClickHouse/ClickHouse/issues/44120). [#80304](https://github.com/ClickHouse/ClickHouse/pull/80304) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Отключен `filter-push-down` для предиката с недетерминированной функцией в случае, если шаг плана запроса изменяет количество строк. Исправляет [#40273](https://github.com/ClickHouse/ClickHouse/issues/40273). [#80329](https://github.com/ClickHouse/ClickHouse/pull/80329) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлены возможные логические ошибки и сбои в проекциях с подстолбцами. [#80333](https://github.com/ClickHouse/ClickHouse/pull/80333) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка `NOT_FOUND_COLUMN_IN_BLOCK`, вызываемая оптимизацией filter-push-down для логического JOIN sep в случае, когда выражение `ON` не является тривиальным равенством. Исправлены [#79647](https://github.com/ClickHouse/ClickHouse/issues/79647) и [#77848](https://github.com/ClickHouse/ClickHouse/issues/77848). [#80360](https://github.com/ClickHouse/ClickHouse/pull/80360) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка с некорректным результатом при чтении ключей в обратном порядке в секционированных таблицах. Исправляет [#79987](https://github.com/ClickHouse/ClickHouse/issues/79987). [#80448](https://github.com/ClickHouse/ClickHouse/pull/80448) ([Amos Bird](https://github.com/amosbird)).
* Исправлена некорректная сортировка в таблицах с nullable-ключом и включённым optimize&#95;read&#95;in&#95;order. [#80515](https://github.com/ClickHouse/ClickHouse/pull/80515) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлена проблема, из-за которой операция DROP для обновляемого материализованного представления зависала, если представление было остановлено с помощью SYSTEM STOP REPLICATED VIEW. [#80543](https://github.com/ClickHouse/ClickHouse/pull/80543) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена ошибка &#39;Cannot find column&#39; при использовании константного кортежа в распределённом запросе. [#80596](https://github.com/ClickHouse/ClickHouse/pull/80596) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена функция `shardNum` в таблицах Distributed с `join_use_nulls`. [#80612](https://github.com/ClickHouse/ClickHouse/pull/80612) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлен некорректный результат при чтении столбца, который присутствует только в подмножестве таблиц в движке Merge. [#80643](https://github.com/ClickHouse/ClickHouse/pull/80643) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена возможная проблема с протоколом SSH (из-за зависания replxx). [#80688](https://github.com/ClickHouse/ClickHouse/pull/80688) ([Azat Khuzhin](https://github.com/azat)).
* Отметка времени в таблице iceberg&#95;history теперь должна быть корректной. [#80711](https://github.com/ClickHouse/ClickHouse/pull/80711) ([Melvyn Peignon](https://github.com/melvynator)).
* Исправлен возможный сбой в случае неудачной регистрации словаря (когда `CREATE DICTIONARY` завершался с ошибкой `CANNOT_SCHEDULE_TASK`, в реестре словарей мог оставаться висячий указатель, что позднее приводило к сбою). [#80714](https://github.com/ClickHouse/ClickHouse/pull/80714) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена обработка шаблонов перечислений с одним элементом в табличных функциях для объектного хранилища. [#80716](https://github.com/ClickHouse/ClickHouse/pull/80716) ([Konstantин Богданов](https://github.com/thevar1able)).
* Исправлен неверный тип результата функций сравнения для `Tuple(Dynamic)` и `String`, который приводил к логической ошибке. [#80728](https://github.com/ClickHouse/ClickHouse/pull/80728) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена недостающая поддержка типа данных `timestamp_ntz` для Unity Catalog. Исправляет [#79535](https://github.com/ClickHouse/ClickHouse/issues/79535), [#79875](https://github.com/ClickHouse/ClickHouse/issues/79875). [#80740](https://github.com/ClickHouse/ClickHouse/pull/80740) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка `THERE_IS_NO_COLUMN` для распределённых запросов с `IN cte`. Исправляет [#75032](https://github.com/ClickHouse/ClickHouse/issues/75032). [#80757](https://github.com/ClickHouse/ClickHouse/pull/80757) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено избыточное количество файлов (приводило к чрезмерному использованию памяти) для внешнего ORDER BY. [#80777](https://github.com/ClickHouse/ClickHouse/pull/80777) ([Azat Khuzhin](https://github.com/azat)).
* Этот PR может закрыть [#80742](https://github.com/ClickHouse/ClickHouse/issues/80742). [#80783](https://github.com/ClickHouse/ClickHouse/pull/80783) ([zoomxi](https://github.com/zoomxi)).
* Исправлен сбой в Kafka из-за того, что get&#95;member&#95;id() создавал std::string из NULL (вероятно, проблема проявлялась только в случае неудачного подключения к брокеру). [#80793](https://github.com/ClickHouse/ClickHouse/pull/80793) ([Azat Khuzhin](https://github.com/azat)).
* Корректно дожидаться завершения потребителей перед остановкой движка `Kafka` (активные потребители после остановки могут приводить к срабатыванию различных отладочных assert&#39;ов, а также читать данные у брокеров в фоне после удаления/отсоединения таблицы). [#80795](https://github.com/ClickHouse/ClickHouse/pull/80795) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка `NOT_FOUND_COLUMN_IN_BLOCK`, вызванная оптимизацией `predicate-push-down`. Исправляет [#80443](https://github.com/ClickHouse/ClickHouse/issues/80443). [#80834](https://github.com/ClickHouse/ClickHouse/pull/80834) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена логическая ошибка при обработке шаблона `*` (звёздочки) в табличной функции в `JOIN` с `USING`. [#80894](https://github.com/ClickHouse/ClickHouse/pull/80894) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлен учет памяти для кэша файлов метаданных Iceberg. [#80904](https://github.com/ClickHouse/ClickHouse/pull/80904) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена некорректная партиционизация с nullable-ключом партиционирования. [#80913](https://github.com/ClickHouse/ClickHouse/pull/80913) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлена ошибка `Table does not exist` для распределённых запросов с pushed-down-предикатом (`allow_push_predicate_ast_for_distributed_subqueries=1`), когда исходная таблица отсутствует на инициаторе. Исправляет [#77281](https://github.com/ClickHouse/ClickHouse/issues/77281). [#80915](https://github.com/ClickHouse/ClickHouse/pull/80915) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена логическая ошибка во вложенных функциях с именованными окнами. [#80926](https://github.com/ClickHouse/ClickHouse/pull/80926) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлены экстремальные значения для nullable- и вещественных столбцов. [#80970](https://github.com/ClickHouse/ClickHouse/pull/80970) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлена возможная авария при выполнении запроса к system.tables (скорее всего, в условиях дефицита памяти). [#80976](https://github.com/ClickHouse/ClickHouse/pull/80976) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена атомарная операция переименования с `TRUNCATE` для файлов, сжатие которых определяется по их расширению. [#80979](https://github.com/ClickHouse/ClickHouse/pull/80979) ([Pablo Marcos](https://github.com/pamarcos)).
* Исправлена функция ErrorCodes::getName. [#81032](https://github.com/ClickHouse/ClickHouse/pull/81032) ([RinChanNOW](https://github.com/RinChanNOWWW)).
* Исправлена ошибка, из-за которой пользователь не мог просматривать список таблиц в Unity Catalog без прав на каждую из них. Теперь все таблицы корректно отображаются, а при попытке чтения из ограниченной таблицы будет сгенерировано исключение. [#81044](https://github.com/ClickHouse/ClickHouse/pull/81044) ([alesapin](https://github.com/alesapin)).
* Теперь ClickHouse будет игнорировать ошибки и неожиданные ответы от каталогов дата-лейка в запросе `SHOW TABLES`. Исправление [#79725](https://github.com/ClickHouse/ClickHouse/issues/79725). [#81046](https://github.com/ClickHouse/ClickHouse/pull/81046) ([alesapin](https://github.com/alesapin)).
* Исправлен парсинг `DateTime64` из целых чисел в `JSONExtract` и при разборе типа `JSON`. [#81050](https://github.com/ClickHouse/ClickHouse/pull/81050) ([Pavel Kruglov](https://github.com/Avogar)).
* Отражать настройку date&#95;time&#95;input&#95;format в кэше вывода схемы. [#81052](https://github.com/ClickHouse/ClickHouse/pull/81052) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен сбой при INSERT, если таблица была удалена (DROP) после начала запроса, но до отправки столбцов. [#81053](https://github.com/ClickHouse/ClickHouse/pull/81053) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено использование неинициализированного значения в quantileDeterministic. [#81062](https://github.com/ClickHouse/ClickHouse/pull/81062) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено управление количеством жёстких ссылок (`hardlinks`) для транзакций диска `metadatastoragefromdisk`. Добавлены тесты. [#81066](https://github.com/ClickHouse/ClickHouse/pull/81066) ([Sema Checherinda](https://github.com/CheSema)).
* Имена пользовательских функций (UDF) не добавляются в таблицу `system.query_log` в отличие от других функций. В этом PR реализовано добавление имени UDF в один из двух столбцов `used_executable_user_defined_functions` или `used_sql_user_defined_functions`, если UDF была использована в запросе. [#81101](https://github.com/ClickHouse/ClickHouse/pull/81101) ([Kyamran](https://github.com/nibblerenush)).
* Исправлены ошибки `Too large size ... passed to allocator` и возможные сбои при вставках через протокол HTTP с текстовыми форматами (`JSON`, `Values`, ...) при пропуске полей типа `Enum`. [#81145](https://github.com/ClickHouse/ClickHouse/pull/81145) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка LOGICAL&#95;ERROR в случае разреженного столбца (Sparse column) в блоке INSERT, переданном в не-MT материализованное представление (MV). [#81161](https://github.com/ClickHouse/ClickHouse/pull/81161) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка `Unknown table expression identifier` при `distributed_product_mode_local=local` в сценариях с кросс-репликацией. [#81162](https://github.com/ClickHouse/ClickHouse/pull/81162) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено некорректное кэширование числа строк в файлах Parquet после фильтрации. [#81184](https://github.com/ClickHouse/ClickHouse/pull/81184) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена настройка fs cache max&#95;size&#95;to&#95;total&#95;space при использовании относительного пути к кэшу. [#81237](https://github.com/ClickHouse/ClickHouse/pull/81237) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено падение clickhouse-local при выводе константных кортежей или отображений в формате Parquet. [#81249](https://github.com/ClickHouse/ClickHouse/pull/81249) ([Michael Kolupaev](https://github.com/al13n321)).
* Проверять смещения массивов, полученных по сети. [#81269](https://github.com/ClickHouse/ClickHouse/pull/81269) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен частный случай в запросе, который объединяет пустые таблицы и использует оконные функции. Ошибка приводила к взрывному росту числа параллельных потоков, что вызывало OOM. [#81299](https://github.com/ClickHouse/ClickHouse/pull/81299) ([Alexander Gololobov](https://github.com/davenger)).
* Исправления для функций кластеров дата-лейка (`deltaLakeCluster`, `icebergCluster` и т. д.): (1) исправлен потенциальный segfault в `DataLakeConfiguration` при использовании функции `Cluster` со старым анализатором; (2) удалено дублирующее обновление метаданных дата-лейка (лишние запросы к объектному хранилищу); (3) исправлено избыточное перечисление в объектном хранилище, когда формат явно не указан (что уже было сделано для некластерных движков дата-лейка). [#81300](https://github.com/ClickHouse/ClickHouse/pull/81300) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Флаг force&#95;restore&#95;data теперь восстанавливает потерянные метаданные keeper. [#81324](https://github.com/ClickHouse/ClickHouse/pull/81324) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена ошибка области в `delta-kernel`. Исправляет [#79914](https://github.com/ClickHouse/ClickHouse/issues/79914). [#81353](https://github.com/ClickHouse/ClickHouse/pull/81353) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отключена некорректная JIT-компиляция для divideOrNull. [#81370](https://github.com/ClickHouse/ClickHouse/pull/81370) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена ошибка вставки, возникавшая, когда в таблице MergeTree использовался столбец секции с длинным именем. [#81390](https://github.com/ClickHouse/ClickHouse/pull/81390) ([hy123q](https://github.com/haoyangqian)).
* Забэкпортировано в [#81957](https://github.com/ClickHouse/ClickHouse/issues/81957): исправлен возможный сбой в `Aggregator` при возникновении исключения во время слияния. [#81450](https://github.com/ClickHouse/ClickHouse/pull/81450) ([Nikita Taranov](https://github.com/nickitat)).
* Не хранить в памяти содержимое нескольких файлов манифеста. [#81470](https://github.com/ClickHouse/ClickHouse/pull/81470) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлен возможный сбой при завершении работы фоновых пулов потоков (`background_.*pool_size`). [#81473](https://github.com/ClickHouse/ClickHouse/pull/81473) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено чтение за пределами границ буфера в формате `Npy`, возникавшее при записи в таблицу с движком `URL`. Это закрывает [#81356](https://github.com/ClickHouse/ClickHouse/issues/81356). [#81502](https://github.com/ClickHouse/ClickHouse/pull/81502) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Есть вероятность, что Web UI будет отображать `NaN%` (типичная проблема JavaScript). [#81507](https://github.com/ClickHouse/ClickHouse/pull/81507) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена работа `DatabaseReplicated` при `database_replicated_enforce_synchronous_settings=1`. [#81564](https://github.com/ClickHouse/ClickHouse/pull/81564) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен порядок сортировки для типов `LowCardinality(Nullable(...))`. [#81583](https://github.com/ClickHouse/ClickHouse/pull/81583) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Сервер не должен сохранять HTTP-соединение, если запрос не был полностью прочитан из сокета. [#81595](https://github.com/ClickHouse/ClickHouse/pull/81595) ([Sema Checherinda](https://github.com/CheSema)).
* Скалярные коррелированные подзапросы теперь возвращают `Nullable`‑результат выражения проекции. Исправлен случай, когда коррелированный подзапрос возвращает пустое множество строк. [#81632](https://github.com/ClickHouse/ClickHouse/pull/81632) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена ошибка `Unexpected relative path for a deduplicated part` при выполнении `ATTACH` к `ReplicatedMergeTree`. [#81647](https://github.com/ClickHouse/ClickHouse/pull/81647) ([Azat Khuzhin](https://github.com/azat)).
* Настройка запроса `use_iceberg_partition_pruning` не будет работать для хранилища Iceberg, потому что она использует глобальный контекст, а не контекст запроса. Это не критично, поскольку значение по умолчанию — `true`. Этот PR это исправляет. [#81673](https://github.com/ClickHouse/ClickHouse/pull/81673) ([Han Fei](https://github.com/hanfei1991)).
* Бэкпортировано в [#82128](https://github.com/ClickHouse/ClickHouse/issues/82128): исправлена ошибка «Context has expired» во время слияний при использовании dict в выражении TTL. [#81690](https://github.com/ClickHouse/ClickHouse/pull/81690) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена проверка для настройки mergetree `merge_max_block_size`, гарантирующая, что её значение не равно нулю. [#81693](https://github.com/ClickHouse/ClickHouse/pull/81693) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлены проблемы в `clickhouse-local`, приводившие к зависанию запросов `DROP VIEW `. [#81705](https://github.com/ClickHouse/ClickHouse/pull/81705) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлена работа соединения StorageRedis в некоторых случаях. [#81736](https://github.com/ClickHouse/ClickHouse/pull/81736) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлен сбой в `ConcurrentHashJoin` при пустом `USING ()` и включённом старом анализаторе. [#81754](https://github.com/ClickHouse/ClickHouse/pull/81754) ([Nikita Taranov](https://github.com/nickitat)).
* Исправление в Keeper: блокировать коммиты новых логов, если в логах есть некорректная запись. Ранее, если лидер неправильно применял часть логов, он продолжал коммитить новые логи, хотя фолловер обнаруживал несоответствие дайджеста и прерывал выполнение. [#81780](https://github.com/ClickHouse/ClickHouse/pull/81780) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена проблема, из-за которой необходимые столбцы не считывались при обработке скалярного коррелированного подзапроса. Исправляет [#81716](https://github.com/ClickHouse/ClickHouse/issues/81716). [#81805](https://github.com/ClickHouse/ClickHouse/pull/81805) ([Dmitry Novik](https://github.com/novikd)).
* Кто-то засорил наш код Kusto. Очистил. Это закрывает [#81643](https://github.com/ClickHouse/ClickHouse/issues/81643). [#81885](https://github.com/ClickHouse/ClickHouse/pull/81885) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* В предыдущих версиях сервер возвращал избыточный объём данных для запросов к `/js`. Это закрывает [#61890](https://github.com/ClickHouse/ClickHouse/issues/61890). [#81895](https://github.com/ClickHouse/ClickHouse/pull/81895) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Ранее определения движка таблиц `MongoDB` могли включать компонент пути в аргументе `host:port`, который без каких‑либо сообщений игнорировался. Интеграция с MongoDB отказывалась загружать такие таблицы. С этим исправлением *мы разрешаем загрузку таких таблиц и продолжаем игнорировать компонент пути*, если движок `MongoDB` имеет пять аргументов, используя имя базы данных из аргументов. *Примечание:* исправление не применяется к заново создаваемым таблицам или запросам с табличной функцией `mongo`, а также к источникам словарей и именованным коллекциям. [#81942](https://github.com/ClickHouse/ClickHouse/pull/81942) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлена потенциальная аварийная остановка `Aggregator` при возникновении исключения во время слияния. [#82022](https://github.com/ClickHouse/ClickHouse/pull/82022) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена ошибка копирования-вставки в `arraySimilarity`, запрещено использование весов типов `UInt32` и `Int32`. Обновлены тесты и документация. [#82103](https://github.com/ClickHouse/ClickHouse/pull/82103) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Исправлена возможная гонка данных между потоком подсказок и основным потоком клиента. [#82233](https://github.com/ClickHouse/ClickHouse/pull/82233) ([Azat Khuzhin](https://github.com/azat)).





#### Улучшение сборки/тестирования/упаковки

* Используется `postgres` 16.9. [#81437](https://github.com/ClickHouse/ClickHouse/pull/81437) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Используется `openssl` 3.2.4. [#81438](https://github.com/ClickHouse/ClickHouse/pull/81438) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Использовать `abseil-cpp` от 2025-01-27. [#81440](https://github.com/ClickHouse/ClickHouse/pull/81440) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Используется `mongo-c-driver` 1.30.4. [#81449](https://github.com/ClickHouse/ClickHouse/pull/81449) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Используется `krb5` 1.21.3-final. [#81453](https://github.com/ClickHouse/ClickHouse/pull/81453) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Использование `orc` 2.1.2. [#81455](https://github.com/ClickHouse/ClickHouse/pull/81455) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Используйте `grpc` 1.73.0. [#81629](https://github.com/ClickHouse/ClickHouse/pull/81629) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Используется `delta-kernel-rs` v0.12.1. [#81707](https://github.com/ClickHouse/ClickHouse/pull/81707) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Обновлён `c-ares` до версии `v1.34.5`. [#81159](https://github.com/ClickHouse/ClickHouse/pull/81159) ([Konstantин Богданов](https://github.com/thevar1able)).
* Обновите `curl` до версии 8.14, чтобы устранить уязвимости CVE-2025-5025 и CVE-2025-4947. [#81171](https://github.com/ClickHouse/ClickHouse/pull/81171) ([larryluogit](https://github.com/larryluogit)).
* Обновлена `libarchive` до версии 3.7.9 для устранения уязвимостей: CVE-2024-20696 CVE-2025-25724 CVE-2024-48958 CVE-2024-57970 CVE-2025-1632 CVE-2024-48957 CVE-2024-48615. [#81174](https://github.com/ClickHouse/ClickHouse/pull/81174) ([larryluogit](https://github.com/larryluogit)).
* Обновление `libxml2` до версии 2.14.3. [#81187](https://github.com/ClickHouse/ClickHouse/pull/81187) ([larryluogit](https://github.com/larryluogit)).
* Избегайте копировать вендорные исходники Rust в `CARGO_HOME`. [#79560](https://github.com/ClickHouse/ClickHouse/pull/79560) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Убрана зависимость от библиотеки Sentry, заменив её на наш собственный endpoint. [#80236](https://github.com/ClickHouse/ClickHouse/pull/80236) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Обновлены зависимости Python в CI-образах для устранения предупреждений Dependabot. [#80658](https://github.com/ClickHouse/ClickHouse/pull/80658) ([Raúl Marín](https://github.com/Algunenano)).
* Повторно считывать флаг остановки реплицируемого DDL из Keeper при запуске, чтобы сделать тесты более надёжными, когда для Keeper включена инъекция сбоев. [#80964](https://github.com/ClickHouse/ClickHouse/pull/80964) ([Alexander Gololobov](https://github.com/davenger)).
* Использовать https для URL архива Ubuntu. [#81016](https://github.com/ClickHouse/ClickHouse/pull/81016) ([Raúl Marín](https://github.com/Algunenano)).
* Обновление зависимостей Python в тестовых образах. [#81042](https://github.com/ClickHouse/ClickHouse/pull/81042) ([dependabot[bot]](https://github.com/apps/dependabot)).
* Добавлен `flake.nix` для сборки с помощью Nix. [#81463](https://github.com/ClickHouse/ClickHouse/pull/81463) ([Konstantin Bogданов](https://github.com/thevar1able)).
* Исправлена проблема, из-за которой `delta-kernel-rs` требовал сетевой доступ во время сборки. Закрывает [#80609](https://github.com/ClickHouse/ClickHouse/issues/80609). [#81602](https://github.com/ClickHouse/ClickHouse/pull/81602) ([Konstantin Bogdanov](https://github.com/thevar1able)). См. статью [A Year of Rust in ClickHouse](https://clickhouse.com/blog/rust).

### Релиз ClickHouse 25.5, 2025-05-22 {#255}

#### Обратно несовместимые изменения

- Функция `geoToH3` теперь принимает входные данные в порядке (lat, lon, res) (что соответствует другим геометрическим функциям). Пользователи, желающие сохранить прежний порядок аргументов (lon, lat, res), могут установить настройку `geotoh3_argument_order = 'lon_lat'`. [#78852](https://github.com/ClickHouse/ClickHouse/pull/78852) ([Pratima Patel](https://github.com/pratimapatel2008)).
- Добавлена настройка кеша файловой системы `allow_dynamic_cache_resize` (по умолчанию `false`) для разрешения динамического изменения размера кеша файловой системы. Причина: в некоторых окружениях (ClickHouse Cloud) все события масштабирования происходят через перезапуск процесса, и мы хотели бы явно отключить эту функцию для большего контроля над поведением, а также в качестве меры безопасности. Это изменение помечено как обратно несовместимое, поскольку в старых версиях динамическое изменение размера кеша работало по умолчанию без специальной настройки. [#79148](https://github.com/ClickHouse/ClickHouse/pull/79148) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Удалена поддержка устаревших типов индексов `annoy` и `usearch`. Оба типа уже давно являлись заглушками, т.е. любая попытка использовать устаревшие индексы в любом случае возвращала ошибку. Если у вас все еще есть индексы `annoy` и `usearch`, пожалуйста, удалите их. [#79802](https://github.com/ClickHouse/ClickHouse/pull/79802) ([Robert Schulze](https://github.com/rschu1ze)).
- Удалена серверная настройка `format_alter_commands_with_parentheses`. Настройка была введена и отключена по умолчанию в версии 24.2. Она была включена по умолчанию в версии 25.2. Поскольку нет LTS-версий, которые не поддерживают новый формат, мы можем удалить эту настройку. [#79970](https://github.com/ClickHouse/ClickHouse/pull/79970) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Включена по умолчанию реализация `delta-kernel-rs` для хранилища `DeltaLake`. [#79541](https://github.com/ClickHouse/ClickHouse/pull/79541) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Если чтение из `URL` включает несколько перенаправлений, настройка `enable_url_encoding` корректно применяется ко всем перенаправлениям в цепочке. [#79563](https://github.com/ClickHouse/ClickHouse/pull/79563) ([Shankar Iyer](https://github.com/shankar-iyer)). Значение по умолчанию для настройки `enble_url_encoding` теперь установлено в `false`. [#80088](https://github.com/ClickHouse/ClickHouse/pull/80088) ([Shankar Iyer](https://github.com/shankar-iyer)).


#### Новая функция

* Поддержка скалярных коррелированных подзапросов в секции WHERE. Исправляет [#6697](https://github.com/ClickHouse/ClickHouse/issues/6697). [#79600](https://github.com/ClickHouse/ClickHouse/pull/79600) ([Dmitry Novik](https://github.com/novikd)). Поддержка коррелированных подзапросов в списке проекций в простых случаях. [#79925](https://github.com/ClickHouse/ClickHouse/pull/79925) ([Dmitry Novik](https://github.com/novikd)). [#76078](https://github.com/ClickHouse/ClickHouse/pull/76078) ([Dmitry Novik](https://github.com/novikd)). Теперь это покрывает 100% набора тестов TPC-H.
* Векторный поиск с использованием индекса векторного сходства теперь имеет статус beta (ранее был experimental). [#80164](https://github.com/ClickHouse/ClickHouse/pull/80164) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка геотипов в формате `Parquet`. Закрывает [#75317](https://github.com/ClickHouse/ClickHouse/issues/75317). [#79777](https://github.com/ClickHouse/ClickHouse/pull/79777) ([scanhex12](https://github.com/scanhex12)).
* Новые функции `sparseGrams`, `sparseGramsHashes`, `sparseGramsHashesUTF8`, `sparseGramsUTF8` для вычисления «sparse-ngrams» — надёжного алгоритма извлечения подстрок для индексирования и поиска. [#79517](https://github.com/ClickHouse/ClickHouse/pull/79517) ([scanhex12](https://github.com/scanhex12)).
* `clickhouse-local` (и его сокращённый псевдоним `ch`) теперь неявно использует `FROM table`, когда есть входные данные для обработки. Это закрывает [#65023](https://github.com/ClickHouse/ClickHouse/issues/65023). Также в clickhouse-local включено автоопределение формата, если `--input-format` не задан и обрабатывается обычный файл. [#79085](https://github.com/ClickHouse/ClickHouse/pull/79085) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлены функции `stringBytesUniq` и `stringBytesEntropy` для поиска потенциально случайных или шифрованных данных. [#79350](https://github.com/ClickHouse/ClickHouse/pull/79350) ([Sachin Kumar Singh](https://github.com/sachinkumarsingh092)).
* Добавлены функции кодирования и декодирования base32. [#79809](https://github.com/ClickHouse/ClickHouse/pull/79809) ([Joanna Hulboj](https://github.com/jh0x)).
* Добавлены функции `getServerSetting` и `getMergeTreeSetting`. Закрывает #78318. [#78439](https://github.com/ClickHouse/ClickHouse/pull/78439) ([NamNguyenHoai](https://github.com/NamHoaiNguyen)).
* Добавлена новая настройка `iceberg_enable_version_hint` для использования файла `version-hint.text`. [#78594](https://github.com/ClickHouse/ClickHouse/pull/78594) ([Arnaud Briche](https://github.com/arnaudbriche)).
* Дает возможность очищать (`TRUNCATE`) отдельные таблицы базы данных, отфильтрованные с помощью ключевого слова `LIKE`. [#78597](https://github.com/ClickHouse/ClickHouse/pull/78597) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Реализована поддержка виртуального столбца `_part_starting_offset` в таблицах семейства `MergeTree`. Этот столбец представляет собой накопительное количество строк во всех предшествующих частях, вычисляемое во время выполнения запроса на основе текущего списка частей. Накопительные значения сохраняются на протяжении всего выполнения запроса и продолжают действовать даже после отсечения частей. Связанная внутренняя логика была переработана для поддержки такого поведения. [#79417](https://github.com/ClickHouse/ClickHouse/pull/79417) ([Amos Bird](https://github.com/amosbird)).
* Добавлены функции `divideOrNull`, `moduloOrNull`, `intDivOrNull`, `positiveModuloOrNull`, которые возвращают NULL, если правый аргумент равен нулю. [#78276](https://github.com/ClickHouse/ClickHouse/pull/78276) ([kevinyhzou](https://github.com/KevinyhZou)).
* Векторный поиск в ClickHouse теперь поддерживает как предварительную, так и последующую фильтрацию и предоставляет соответствующие настройки для более тонкого контроля. (issue [#78161](https://github.com/ClickHouse/ClickHouse/issues/78161)). [#79854](https://github.com/ClickHouse/ClickHouse/pull/79854) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Добавлены функции [`icebergHash`](https://iceberg.apache.org/spec/#appendix-b-32-bit-hash-requirements) и [`icebergBucket`](https://iceberg.apache.org/spec/#bucket-transform-details). Добавлена поддержка отсечения файлов данных в таблицах `Iceberg`, секционированных с помощью [`bucket transform`](https://iceberg.apache.org/spec/#partitioning). [#79262](https://github.com/ClickHouse/ClickHouse/pull/79262) ([Daniil Ivanik](https://github.com/divanik)).



#### Экспериментальная возможность
* Новые типы данных `Time`/`Time64`: `Time` (HHH:MM:SS) и `Time64` (HHH:MM:SS.`&lt;fractional&gt;`), а также несколько базовых функций приведения типов и функций для взаимодействия с другими типами данных. Также изменено имя существующей функции toTime на toTimeWithFixedDate, поскольку функция toTime требуется для функции приведения типов. [#75735](https://github.com/ClickHouse/ClickHouse/pull/75735) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Каталог Hive Metastore для дата-лейка Iceberg. [#77677](https://github.com/ClickHouse/ClickHouse/pull/77677) ([scanhex12](https://github.com/scanhex12)).
* Индексы типа `full_text` были переименованы в `gin`. Это соответствует более привычной терминологии PostgreSQL и других СУБД. Существующие индексы типа `full_text` по-прежнему можно загружать, но при попытке использовать их в поиске они будут выбрасывать исключение (предлагая вместо них индексы `gin`). [#79024](https://github.com/ClickHouse/ClickHouse/pull/79024) ([Robert Schulze](https://github.com/rschu1ze)).



#### Улучшение производительности

* Изменён формат Compact для сохранения меток для каждого подпотока, чтобы можно было читать отдельные подстолбцы. Старый формат Compact по-прежнему поддерживается для чтения и может быть включён для записи с помощью настройки MergeTree `write_marks_for_substreams_in_compact_parts`. По умолчанию он отключён для более безопасного обновления, так как изменяет хранилище компактных кусков. По умолчанию будет включён в одном из следующих релизов. [#77940](https://github.com/ClickHouse/ClickHouse/pull/77940) ([Pavel Kruglov](https://github.com/Avogar)).
* Разрешен перенос условий с подколнками в `PREWHERE`. [#79489](https://github.com/ClickHouse/ClickHouse/pull/79489) ([Pavel Kruglov](https://github.com/Avogar)).
* Ускорена работа вторичных индексов за счёт вычисления их выражений сразу на нескольких гранулах. [#64109](https://github.com/ClickHouse/ClickHouse/pull/64109) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Включена настройка `compile_expressions` (JIT-компилятор для фрагментов обычных выражений) по умолчанию. Это закрывает [#51264](https://github.com/ClickHouse/ClickHouse/issues/51264), [#56386](https://github.com/ClickHouse/ClickHouse/issues/56386) и [#66486](https://github.com/ClickHouse/ClickHouse/issues/66486). [#79907](https://github.com/ClickHouse/ClickHouse/pull/79907) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена новая настройка: `use_skip_indexes_in_final_exact_mode`. Если запрос к таблице `ReplacingMergeTree` содержит оператор FINAL, чтение только диапазонов таблицы на основе пропускающих индексов может привести к некорректному результату. Эта настройка обеспечивает корректность результатов за счёт сканирования более новых кусков, которые пересекаются с диапазонами первичного ключа, возвращёнными пропускающим индексом. Установите 0, чтобы отключить, и 1 — чтобы включить. [#78350](https://github.com/ClickHouse/ClickHouse/pull/78350) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Табличные функции для кластеров объектного хранилища (например, `s3Cluster`) теперь распределяют файлы между репликами для чтения на основе согласованного хеша, чтобы улучшить локальность кэша. [#77326](https://github.com/ClickHouse/ClickHouse/pull/77326) ([Andrej Hoos](https://github.com/adikus)).
* Улучшена производительность `S3Queue`/`AzureQueue` за счёт возможности выполнять вставку данных (`INSERT`) параллельно (можно включить с помощью настройки очереди `parallel_inserts=true`). Ранее S3Queue/AzureQueue могли выполнять только первую часть конвейера параллельно (загрузка, разбор), сам `INSERT` был однопоточным, и именно `INSERT` почти всегда являлся узким местом. Теперь производительность будет масштабироваться почти линейно с `processing_threads_num`. [#77671](https://github.com/ClickHouse/ClickHouse/pull/77671) ([Azat Khuzhin](https://github.com/azat)). Более справедливое значение max&#95;processed&#95;files&#95;before&#95;commit в S3Queue/AzureQueue. [#79363](https://github.com/ClickHouse/ClickHouse/pull/79363) ([Azat Khuzhin](https://github.com/azat)).
* Добавлен порог (настраивается параметром `parallel_hash_join_threshold`), при котором выполняется возврат к алгоритму `hash`, если размер правой таблицы меньше этого порога. [#76185](https://github.com/ClickHouse/ClickHouse/pull/76185) ([Nikita Taranov](https://github.com/nickitat)).
* Теперь для определения размера задачи при чтении с включёнными параллельными репликами мы используем количество реплик. Это обеспечивает более равномерное распределение работы между репликами, когда объём данных для чтения невелик. [#78695](https://github.com/ClickHouse/ClickHouse/pull/78695) ([Nikita Taranov](https://github.com/nickitat)).
* Разрешено параллельное слияние состояний `uniqExact` на финальном этапе распределённой агрегации. [#78703](https://github.com/ClickHouse/ClickHouse/pull/78703) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена возможная деградация производительности при параллельном слиянии состояний `uniqExact` для агрегации с ключом. [#78724](https://github.com/ClickHouse/ClickHouse/pull/78724) ([Nikita Taranov](https://github.com/nickitat)).
* Снижено количество вызовов API List Blobs к хранилищу Azure. [#78860](https://github.com/ClickHouse/ClickHouse/pull/78860) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлена производительность распределённого запроса `INSERT SELECT` с параллельными репликами. [#79441](https://github.com/ClickHouse/ClickHouse/pull/79441) ([Azat Khuzhin](https://github.com/azat)).
* Исключён вызов очистки в `LogSeriesLimiter` при каждом создании объекта, что позволяет избежать конкуренции за блокировки и снижения производительности в сценариях с высокой степенью параллелизма. [#79864](https://github.com/ClickHouse/ClickHouse/pull/79864) ([filimonov](https://github.com/filimonov)).
* Ускорены запросы за счёт тривиальной оптимизации `count`. [#79945](https://github.com/ClickHouse/ClickHouse/pull/79945) ([Raúl Marín](https://github.com/Algunenano)).
* Улучшенный инлайнинг для некоторых операций с `Decimal`. [#79999](https://github.com/ClickHouse/ClickHouse/pull/79999) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* По умолчанию включить `input_format_parquet_bloom_filter_push_down`. Также исправлена ошибка в истории изменений настроек. [#80058](https://github.com/ClickHouse/ClickHouse/pull/80058) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Оптимизированы мутации `ALTER ... DELETE` для кусков, в которых все строки должны быть удалены. Теперь в таких случаях вместо исходного куска создаётся пустой, без фактического выполнения мутации. [#79307](https://github.com/ClickHouse/ClickHouse/pull/79307) ([Anton Popov](https://github.com/CurtizJ)).
* Избегать лишнего копирования блока при вставке в компактную часть, когда это возможно. [#79536](https://github.com/ClickHouse/ClickHouse/pull/79536) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена настройка `input_format_max_block_size_bytes` для ограничения размера блоков в байтах, создаваемых во входных форматах. Это может помочь избежать высокого потребления памяти при импорте данных, когда строки содержат большие значения. [#79495](https://github.com/ClickHouse/ClickHouse/pull/79495) ([Pavel Kruglov](https://github.com/Avogar)).
* Удалены guard-страницы для потоков и async&#95;socket&#95;for&#95;remote/use&#95;hedge&#95;requests. Изменён метод выделения памяти в `FiberStack` с `mmap` на `aligned_alloc`, так как предыдущее поведение приводило к фрагментации VMA, и под высокой нагрузкой может достигаться лимит vm.max&#95;map&#95;count. [#79147](https://github.com/ClickHouse/ClickHouse/pull/79147) ([Sema Checherinda](https://github.com/CheSema)).
* Ленивая материализация с параллельными репликами. [#79401](https://github.com/ClickHouse/ClickHouse/pull/79401) ([Igor Nikonov](https://github.com/devcrafter)).





#### Улучшение

* Добавлена возможность применять легковесные удаления на лету (с настройками `lightweight_deletes_sync = 0`, `apply_mutations_on_fly = 1`. [#79281](https://github.com/ClickHouse/ClickHouse/pull/79281) ([Anton Popov](https://github.com/CurtizJ)).
* Если данные в формате `Pretty` отображаются в терминале и последующий блок имеет те же ширины столбцов, он может продолжать вывод предыдущего блока, «склеивая» его с ним за счёт перемещения курсора вверх. Это закрывает [#79333](https://github.com/ClickHouse/ClickHouse/issues/79333). Функция управляется новой настройкой `output_format_pretty_glue_chunks`. [#79339](https://github.com/ClickHouse/ClickHouse/pull/79339) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Функция `isIPAddressInRange` расширена для типов данных `String`, `IPv4`, `IPv6`, `Nullable(String)`, `Nullable(IPv4)` и `Nullable(IPv6)`. [#78364](https://github.com/ClickHouse/ClickHouse/pull/78364) ([YjyJeff](https://github.com/YjyJeff)).
* Разрешить динамически изменять настройки пула соединений движка `PostgreSQL`. [#78414](https://github.com/ClickHouse/ClickHouse/pull/78414) ([Samay Sharma](https://github.com/samay-sharma)).
* Позволить указывать `_part_offset` в обычной проекции. Это первый шаг к построению индекса проекции. Может использоваться вместе с [#58224](https://github.com/ClickHouse/ClickHouse/issues/58224) и может помочь улучшить #63207. [#78429](https://github.com/ClickHouse/ClickHouse/pull/78429) ([Amos Bird](https://github.com/amosbird)).
* Добавлены новые столбцы (`create_query` и `source`) в `system.named_collections`. Закрывает [#78179](https://github.com/ClickHouse/ClickHouse/issues/78179). [#78582](https://github.com/ClickHouse/ClickHouse/pull/78582) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* В системную таблицу `system.query_condition_cache` добавлено новое поле `condition`. В нем хранится условие в виде открытого текста, хэш которого используется в качестве ключа в кэше условий запросов. [#78671](https://github.com/ClickHouse/ClickHouse/pull/78671) ([Robert Schulze](https://github.com/rschu1ze)).
* Индексы векторного сходства теперь можно создавать для столбцов типа `BFloat16`. [#78850](https://github.com/ClickHouse/ClickHouse/pull/78850) ([Robert Schulze](https://github.com/rschu1ze)).
* Поддержка Unix-временных меток с дробной частью при разборе `DateTime64` в режиме best effort. [#78908](https://github.com/ClickHouse/ClickHouse/pull/78908) ([Pavel Kruglov](https://github.com/Avogar)).
* В реализации хранилища `DeltaLake` на основе delta-kernel исправлен режим сопоставления столбцов, добавлены тесты для эволюции схемы. [#78921](https://github.com/ClickHouse/ClickHouse/pull/78921) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Улучшена вставка в столбец `Variant` в формате Values за счёт более корректного преобразования значений. [#78923](https://github.com/ClickHouse/ClickHouse/pull/78923) ([Pavel Kruglov](https://github.com/Avogar)).
* Функция `tokens` была расширена: добавлен дополнительный аргумент `tokenizer`, а также другие аргументы, специфичные для токенизатора. [#79001](https://github.com/ClickHouse/ClickHouse/pull/79001) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Оператор `SHOW CLUSTER` теперь разворачивает макросы (если они есть) в своём аргументе. [#79006](https://github.com/ClickHouse/ClickHouse/pull/79006) ([arf42](https://github.com/arf42)).
* Хэш-функции теперь поддерживают `NULL` внутри массивов, кортежей и отображений. (issues [#48365](https://github.com/ClickHouse/ClickHouse/issues/48365) и [#48623](https://github.com/ClickHouse/ClickHouse/issues/48623)). [#79008](https://github.com/ClickHouse/ClickHouse/pull/79008) ([Michael Kolupaev](https://github.com/al13n321)).
* Обновлена библиотека cctz до версии 2025a. [#79043](https://github.com/ClickHouse/ClickHouse/pull/79043) ([Raúl Marín](https://github.com/Algunenano)).
* Изменена обработка stderr по умолчанию для UDF на &quot;log&#95;last&quot;. Это улучшает удобство использования. [#79066](https://github.com/ClickHouse/ClickHouse/pull/79066) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сделать вкладки в Web UI поддерживающими операцию отмены. Это закрывает [#71284](https://github.com/ClickHouse/ClickHouse/issues/71284). [#79084](https://github.com/ClickHouse/ClickHouse/pull/79084) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Удаление настроек во время `recoverLostReplica` выполнено так же, как в: [https://github.com/ClickHouse/ClickHouse/pull/78637](https://github.com/ClickHouse/ClickHouse/pull/78637). [#79113](https://github.com/ClickHouse/ClickHouse/pull/79113) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлены события профилирования `ParquetReadRowGroups` и `ParquetPrunedRowGroups` для профилирования обрезки индекса Parquet. [#79180](https://github.com/ClickHouse/ClickHouse/pull/79180) ([flynn](https://github.com/ucasfl)).
* Поддержка `ALTER` для баз данных в кластере. [#79242](https://github.com/ClickHouse/ClickHouse/pull/79242) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Явно пропускать пропущенные запуски сбора статистики для QueryMetricLog, иначе журналу потребуется много времени, чтобы догнать текущее время. [#79257](https://github.com/ClickHouse/ClickHouse/pull/79257) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Небольшие оптимизации чтения форматов на основе `Arrow`. [#79308](https://github.com/ClickHouse/ClickHouse/pull/79308) ([Bharat Nallan](https://github.com/bharatnc)).
* Настройка `allow_archive_path_syntax` была по ошибке помечена как экспериментальная. Добавлен тест, предотвращающий включение экспериментальных настроек по умолчанию. [#79320](https://github.com/ClickHouse/ClickHouse/pull/79320) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сделали настройки кэша страниц настраиваемыми для отдельных запросов. Это нужно для более быстрого проведения экспериментов и возможности тонкой настройки запросов с высокой пропускной способностью и низкой задержкой. [#79337](https://github.com/ClickHouse/ClickHouse/pull/79337) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Не выводить подсказки по числам в «красивых» форматах для чисел, которые выглядят как большинство 64-битных хешей. Это закрывает [#79334](https://github.com/ClickHouse/ClickHouse/issues/79334). [#79338](https://github.com/ClickHouse/ClickHouse/pull/79338) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Цвета графиков на расширенных дашбордах будут вычисляться из хеша соответствующего запроса. Это упрощает запоминание и поиск нужного графика при прокрутке дашборда. [#79341](https://github.com/ClickHouse/ClickHouse/pull/79341) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена асинхронная метрика `FilesystemCacheCapacity` — суммарная ёмкость виртуальной файловой системы `cache`. Это полезно для глобального мониторинга инфраструктуры. [#79348](https://github.com/ClickHouse/ClickHouse/pull/79348) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Оптимизирован доступ к `system.parts` (размеры столбцов и индексов читаются только по запросу). [#79352](https://github.com/ClickHouse/ClickHouse/pull/79352) ([Azat Khuzhin](https://github.com/azat)).
* Вычислять только необходимые поля для запроса `'SHOW CLUSTER <name>'` вместо всех полей. [#79368](https://github.com/ClickHouse/ClickHouse/pull/79368) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Добавлена возможность задавать настройки хранилища для `DatabaseCatalog`. [#79407](https://github.com/ClickHouse/ClickHouse/pull/79407) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка локального хранилища в `DeltaLake`. [#79416](https://github.com/ClickHouse/ClickHouse/pull/79416) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена настройка уровня запроса для включения delta-kernel-rs: `allow_experimental_delta_kernel_rs`. [#79418](https://github.com/ClickHouse/ClickHouse/pull/79418) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена возможная бесконечная петля при перечислении блобов в хранилищах Azure/S3. [#79425](https://github.com/ClickHouse/ClickHouse/pull/79425) ([Alexander Gololobov](https://github.com/davenger)).
* Добавлена настройка кеша файловой системы `max_size_ratio_to_total_space`. [#79460](https://github.com/ClickHouse/ClickHouse/pull/79460) ([Kseniia Sumarokova](https://github.com/kssenii)).
* В `clickhouse-benchmark` параметр `reconnect` перенастроен так, чтобы он принимал значения 0, 1 или N, задающие соответствующее поведение переподключения. [#79465](https://github.com/ClickHouse/ClickHouse/pull/79465) ([Sachin Kumar Singh](https://github.com/sachinkumarsingh092)).
* Разрешено использовать `ALTER TABLE ... MOVE|REPLACE PARTITION` для таблиц на разных дисках `plain_rewritable`. [#79566](https://github.com/ClickHouse/ClickHouse/pull/79566) ([Julia Kartseva](https://github.com/jkartseva)).
* Индекс векторного сходства теперь также применяется, если опорный вектор имеет тип `Array(BFloat16)`. [#79745](https://github.com/ClickHouse/ClickHouse/pull/79745) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Добавлены поля `last_error_message`, `last_error_trace` и `query_id` в таблицу `system.error_log`. Связанный тикет: [#75816](https://github.com/ClickHouse/ClickHouse/issues/75816). [#79836](https://github.com/ClickHouse/ClickHouse/pull/79836) ([Andrei Tinikov](https://github.com/Dolso)).
* Включена отправка отчётов о сбоях по умолчанию. Это можно отключить в файле конфигурации сервера. [#79838](https://github.com/ClickHouse/ClickHouse/pull/79838) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Системная таблица `system.functions` теперь показывает, в какой версии ClickHouse функции были впервые добавлены. [#79839](https://github.com/ClickHouse/ClickHouse/pull/79839) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена настройка `access_control_improvements.enable_user_name_access_type`. Эта настройка позволяет включать или отключать точные права для пользователей и ролей, добавленные в [https://github.com/ClickHouse/ClickHouse/pull/72246](https://github.com/ClickHouse/ClickHouse/pull/72246). Имеет смысл отключить её, если в вашем кластере есть реплики версии ниже 25.1. [#79842](https://github.com/ClickHouse/ClickHouse/pull/79842) ([pufit](https://github.com/pufit)).
* Корректная реализация метода `ASTSelectWithUnionQuery::clone()` теперь учитывает и поле `is_normalized`. Это может помочь с [#77569](https://github.com/ClickHouse/ClickHouse/issues/77569). [#79909](https://github.com/ClickHouse/ClickHouse/pull/79909) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлено непоследовательное форматирование некоторых запросов с оператором EXCEPT. Если левая часть оператора EXCEPT заканчивается на `*`, отформатированный запрос теряет скобки и затем разбирается как `*` с модификатором `EXCEPT`. Эти запросы находились фаззером и маловероятны в реальной практике. Это закрывает [#79950](https://github.com/ClickHouse/ClickHouse/issues/79950). [#79952](https://github.com/ClickHouse/ClickHouse/pull/79952) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Небольшое улучшение разбора типа `JSON` за счёт использования кеша порядка десериализации вариантов. [#79984](https://github.com/ClickHouse/ClickHouse/pull/79984) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена настройка `s3_slow_all_threads_after_network_error`. [#80035](https://github.com/ClickHouse/ClickHouse/pull/80035) ([Vitaly Baranov](https://github.com/vitlibar)).
* Неправильно использовался уровень логирования (Information) для выбранных к слиянию частей. Закрывает [#80061](https://github.com/ClickHouse/ClickHouse/issues/80061). [#80062](https://github.com/ClickHouse/ClickHouse/pull/80062) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* trace-visualizer: добавлено отображение runtime/share во всплывающих подсказках и статусных сообщениях. [#79040](https://github.com/ClickHouse/ClickHouse/pull/79040) ([Sergei Trifonov](https://github.com/serxa)).
* trace-visualizer: загрузка данных с сервера ClickHouse. [#79042](https://github.com/ClickHouse/ClickHouse/pull/79042) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлены метрики для неудачных слияний. [#79228](https://github.com/ClickHouse/ClickHouse/pull/79228) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* `clickhouse-benchmark` будет отображать прогресс в процентах, рассчитанный исходя из максимального числа итераций, если оно задано. [#79346](https://github.com/ClickHouse/ClickHouse/pull/79346) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен визуализатор таблицы `system.parts`. [#79437](https://github.com/ClickHouse/ClickHouse/pull/79437) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлен инструмент для анализа латентности запросов. [#79978](https://github.com/ClickHouse/ClickHouse/pull/79978) ([Sergei Trifonov](https://github.com/serxa)).





#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе)

* Исправлена обработка переименований столбцов, отсутствующих в парте. [#76346](https://github.com/ClickHouse/ClickHouse/pull/76346) ([Anton Popov](https://github.com/CurtizJ)).
* Материализованное представление может запуститься слишком поздно, например после Kafka-таблицы, которая передаёт в него данные. [#72123](https://github.com/ClickHouse/ClickHouse/pull/72123) ([Ilya Golshtein](https://github.com/ilejn)).
* Исправлена перезапись запроса `SELECT` при создании `VIEW` с включённым анализатором. Закрывает [#75956](https://github.com/ClickHouse/ClickHouse/issues/75956). [#76356](https://github.com/ClickHouse/ClickHouse/pull/76356) ([Dmitry Novik](https://github.com/novikd)).
* Исправлено применение настройки `async_insert` на стороне сервера (через `apply_settings_from_server`), которое ранее приводило к ошибкам `Unknown packet 11 from server` на клиенте. [#77578](https://github.com/ClickHouse/ClickHouse/pull/77578) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема, из-за которой обновляемое материализованное представление в реплицируемой базе данных не работало на недавно добавленных репликах. [#77774](https://github.com/ClickHouse/ClickHouse/pull/77774) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена проблема, из-за которой обновляемые материализованные представления нарушали создание резервных копий. [#77893](https://github.com/ClickHouse/ClickHouse/pull/77893) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена старая логическая ошибка срабатывания функции `transform`. [#78247](https://github.com/ClickHouse/ClickHouse/pull/78247) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлены некоторые случаи, когда вторичный индекс не применялся при использовании анализатора. Исправляет [#65607](https://github.com/ClickHouse/ClickHouse/issues/65607), исправляет [#69373](https://github.com/ClickHouse/ClickHouse/issues/69373). [#78485](https://github.com/ClickHouse/ClickHouse/pull/78485) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена выгрузка событий профилирования (`NetworkSendElapsedMicroseconds`/`NetworkSendBytes`) для протокола HTTP с включённым сжатием (ошибка не должна превышать размер буфера — обычно около 1MiB). [#78516](https://github.com/ClickHouse/ClickHouse/pull/78516) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен анализатор, который выдавал LOGICAL&#95;ERROR, когда JOIN ... USING включал столбец ALIAS; теперь он выдаёт корректную ошибку. [#78618](https://github.com/ClickHouse/ClickHouse/pull/78618) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлен анализатор: `CREATE VIEW ... ON CLUSTER` завершался с ошибкой, если `SELECT` содержал позиционные аргументы. [#78663](https://github.com/ClickHouse/ClickHouse/pull/78663) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена ошибка `Block structure mismatch` в случае `INSERT SELECT` в табличную функцию с выводом схемы, если `SELECT` содержит скалярные подзапросы. [#78677](https://github.com/ClickHouse/ClickHouse/pull/78677) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлен анализатор: при `prefer_global_in_and_join=1` для таблицы `Distributed` в запросе `SELECT` функция `in` заменяется на `globalIn`. [#78749](https://github.com/ClickHouse/ClickHouse/pull/78749) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлено несколько типов запросов `SELECT`, которые читают из таблиц с движком `MongoDB` или табличной функции `mongodb`: запросы с неявным приведением константного значения в секции `WHERE` (например, `WHERE datetime = '2025-03-10 00:00:00'`); запросы с `LIMIT` и `GROUP BY`. Ранее они могли возвращать некорректный результат. [#78777](https://github.com/ClickHouse/ClickHouse/pull/78777) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена конвертация между разными типами JSON. Теперь она выполняется простым приведением типов через преобразование к/из String. Это менее эффективно, но на 100% корректно. [#78807](https://github.com/ClickHouse/ClickHouse/pull/78807) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена логическая ошибка при преобразовании типа Dynamic в Interval. [#78813](https://github.com/ClickHouse/ClickHouse/pull/78813) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен откат значения столбца при ошибке парсинга JSON. [#78836](https://github.com/ClickHouse/ClickHouse/pull/78836) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка «bad cast» при `JOIN` с использованием константного столбца-алиаса. [#78848](https://github.com/ClickHouse/ClickHouse/pull/78848) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Запрещено использовать PREWHERE в материализованном представлении для столбцов, имеющих разные типы в представлении и целевой таблице. [#78889](https://github.com/ClickHouse/ClickHouse/pull/78889) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена логическая ошибка при разборе некорректных двоичных данных столбца Variant. [#78982](https://github.com/ClickHouse/ClickHouse/pull/78982) ([Pavel Kruglov](https://github.com/Avogar)).
* Бросать исключение, когда размер батча Parquet установлен в 0. Ранее при `output_format_parquet_batch_size = 0` ClickHouse зависал. Теперь это поведение исправлено. [#78991](https://github.com/ClickHouse/ClickHouse/pull/78991) ([daryawessely](https://github.com/daryawessely)).
* Исправлена десериализация дискриминаторов `Variant` с базовым форматом в компактных парциях. Ошибка была внесена в [https://github.com/ClickHouse/ClickHouse/pull/55518](https://github.com/ClickHouse/ClickHouse/pull/55518). [#79000](https://github.com/ClickHouse/ClickHouse/pull/79000) ([Pavel Kruglov](https://github.com/Avogar)).
* Словари типа `complex_key_ssd_cache` теперь отклоняют значения параметров `block_size` и `write_buffer_size`, равные нулю или отрицательные (issue [#78314](https://github.com/ClickHouse/ClickHouse/issues/78314)). [#79028](https://github.com/ClickHouse/ClickHouse/pull/79028) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Избегайте использования `Field` для неагрегированных столбцов в `SummingMergeTree`. Это может привести к неожиданным ошибкам при работе с типами `Dynamic`/`Variant`, используемыми в `SummingMergeTree`. [#79051](https://github.com/ClickHouse/ClickHouse/pull/79051) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено чтение из материализованного представления с распределённой таблицей назначения и другим заголовком в анализаторе. [#79059](https://github.com/ClickHouse/ClickHouse/pull/79059) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка, из-за которой `arrayUnion()` возвращала дополнительные (некорректные) значения в таблицах с пакетными вставками. Исправлено [#75057](https://github.com/ClickHouse/ClickHouse/issues/75057). [#79079](https://github.com/ClickHouse/ClickHouse/pull/79079) ([Peter Nguyen](https://github.com/petern48)).
* Исправлено падение (segfault) в `OpenSSLInitializer`. Закрывает [#79092](https://github.com/ClickHouse/ClickHouse/issues/79092). [#79097](https://github.com/ClickHouse/ClickHouse/pull/79097) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Всегда задавайте префикс для S3 ListObject. [#79114](https://github.com/ClickHouse/ClickHouse/pull/79114) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, из-за которой `arrayUnion()` возвращала лишние (некорректные) значения в таблицах с пакетными вставками. Исправляет [#79157](https://github.com/ClickHouse/ClickHouse/issues/79157). [#79158](https://github.com/ClickHouse/ClickHouse/pull/79158) ([Peter Nguyen](https://github.com/petern48)).
* Исправлена логическая ошибка после проталкивания фильтра. [#79164](https://github.com/ClickHouse/ClickHouse/pull/79164) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлен движок таблиц DeltaLake с реализацией delta-kernel при работе через HTTP-эндпоинты, исправлен NOSIGN. Закрывает [#78124](https://github.com/ClickHouse/ClickHouse/issues/78124). [#79203](https://github.com/ClickHouse/ClickHouse/pull/79203) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправление в Keeper: предотвращено срабатывание watch-ов при неуспешных multi-запросах. [#79247](https://github.com/ClickHouse/ClickHouse/pull/79247) ([Antonio Andelic](https://github.com/antonio2368)).
* Запрещено использование типов Dynamic и JSON в операторе `IN`. При текущей реализации `IN` это может приводить к некорректным результатам. Корректная поддержка этих типов в `IN` сложна и может быть реализована в будущем. [#79282](https://github.com/ClickHouse/ClickHouse/pull/79282) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена проверка на дубликаты путей при разборе типа JSON. [#79317](https://github.com/ClickHouse/ClickHouse/pull/79317) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлены проблемы с соединением `SecureStreamSocket`. [#79383](https://github.com/ClickHouse/ClickHouse/pull/79383) ([Konstantин Богданов](https://github.com/thevar1able)).
* Исправлена загрузка дисков `plain_rewritable`, содержащих данные. [#79439](https://github.com/ClickHouse/ClickHouse/pull/79439) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлено падение при поиске динамических подсстолбцов в Wide‑частях MergeTree. [#79466](https://github.com/ClickHouse/ClickHouse/pull/79466) ([Pavel Kruglov](https://github.com/Avogar)).
* Проверять длину имени таблицы только для исходных запросов `CREATE`. Не выполнять эту проверку для повторных `CREATE`, чтобы избежать проблем с обратной совместимостью. [#79488](https://github.com/ClickHouse/ClickHouse/pull/79488) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Исправлена ошибка `Block structure mismatch` в нескольких случаях при работе с таблицами с разреженными столбцами. [#79491](https://github.com/ClickHouse/ClickHouse/pull/79491) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены два случая ошибки «Logical Error: Can&#39;t set alias of * of Asterisk on alias». [#79505](https://github.com/ClickHouse/ClickHouse/pull/79505) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено использование неверных путей при переименовании базы данных Atomic. [#79569](https://github.com/ClickHouse/ClickHouse/pull/79569) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлена сортировка по столбцу JSON совместно с другими столбцами. [#79591](https://github.com/ClickHouse/ClickHouse/pull/79591) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено дублирование результатов при чтении с удалённого сервера при одновременном отключении `use_hedged_requests` и `allow_experimental_parallel_reading_from_replicas`. [#79599](https://github.com/ClickHouse/ClickHouse/pull/79599) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлена ошибка, приводившая к сбою в реализации delta-kernel при использовании unity catalog. [#79677](https://github.com/ClickHouse/ClickHouse/pull/79677) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Разрешено использование макросов для кластеров autodiscovery. [#79696](https://github.com/ClickHouse/ClickHouse/pull/79696) ([Anton Ivashkin](https://github.com/ianton-ru)).
* Корректная обработка неправильно настроенных page&#95;cache&#95;limits. [#79805](https://github.com/ClickHouse/ClickHouse/pull/79805) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправляет результат работы SQL-функции `formatDateTime`, если форматтер переменного размера (например, `%W`, то есть название дня недели `Monday`, `Tuesday` и т. д.) следует за составным форматтером (форматтером, который выводит сразу несколько компонентов, например, `%D`, то есть американская дата `05/04/25`). [#79835](https://github.com/ClickHouse/ClickHouse/pull/79835) ([Robert Schulze](https://github.com/rschu1ze)).
* IcebergS3 поддерживает оптимизацию count, но IcebergS3Cluster — нет. В результате возвращаемый в кластерном режиме результат count() может быть кратен числу реплик. [#79844](https://github.com/ClickHouse/ClickHouse/pull/79844) ([wxybear](https://github.com/wxybear)).
* Исправляет ошибку AMBIGUOUS&#95;COLUMN&#95;NAME при отложенной материализации, когда до проекции ни один столбец не используется при выполнении запроса. Например, SELECT * FROM t ORDER BY rand() LIMIT 5. [#79926](https://github.com/ClickHouse/ClickHouse/pull/79926) ([Igor Nikonov](https://github.com/devcrafter)).
* Скрывать пароль в запросе `CREATE DATABASE datalake ENGINE = DataLakeCatalog(\'http://catalog:8181\', \'admin\', \'password\')`. [#79941](https://github.com/ClickHouse/ClickHouse/pull/79941) ([Han Fei](https://github.com/hanfei1991)).
* Добавлена возможность указывать псевдоним в JOIN USING. Указывайте этот псевдоним, если столбец был переименован (например, из-за ARRAY JOIN). Исправляет [#73707](https://github.com/ClickHouse/ClickHouse/issues/73707). [#79942](https://github.com/ClickHouse/ClickHouse/pull/79942) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Обеспечивает корректную работу материализованных представлений с UNION на новых репликах. [#80037](https://github.com/ClickHouse/ClickHouse/pull/80037) ([Samay Sharma](https://github.com/samay-sharma)).
* Спецификатор формата `%e` в SQL-функции `parseDateTime` теперь распознаёт однозначные числа дня (например, `3`), тогда как раньше требовалась вставка пробела (например, ` 3`). Это делает его поведение совместимым с MySQL. Чтобы сохранить прежнее поведение, установите настройку `parsedatetime_e_requires_space_padding = 1`. (issue [#78243](https://github.com/ClickHouse/ClickHouse/issues/78243)). [#80057](https://github.com/ClickHouse/ClickHouse/pull/80057) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлено появление предупреждений `Cannot find 'kernel' in '[...]/memory.stat'` в журнале ClickHouse (issue [#77410](https://github.com/ClickHouse/ClickHouse/issues/77410)). [#80129](https://github.com/ClickHouse/ClickHouse/pull/80129) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена проверка размера стека в FunctionComparison, чтобы избежать сбоя из-за переполнения стека. [#78208](https://github.com/ClickHouse/ClickHouse/pull/78208) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлена гонка данных при выполнении SELECT из `system.workloads`. [#78743](https://github.com/ClickHouse/ClickHouse/pull/78743) ([Sergei Trifonov](https://github.com/serxa)).
* Исправление: ленивую материализацию в распределённых запросах. [#78815](https://github.com/ClickHouse/ClickHouse/pull/78815) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлено преобразование из `Array(Bool)` в `Array(FixedString)`. [#78863](https://github.com/ClickHouse/ClickHouse/pull/78863) ([Nikita Taranov](https://github.com/nickitat)).
* Выбор версии Parquet сделан менее запутанным. [#78818](https://github.com/ClickHouse/ClickHouse/pull/78818) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлено самослияние функции `ReservoirSampler`. [#79031](https://github.com/ClickHouse/ClickHouse/pull/79031) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлено хранение таблицы для вставки в контексте клиента. [#79046](https://github.com/ClickHouse/ClickHouse/pull/79046) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Исправлен порядок разрушения полей данных в `AggregatingSortedAlgorithm` и `SummingSortedAlgorithm`. [#79056](https://github.com/ClickHouse/ClickHouse/pull/79056) ([Nikita Taranov](https://github.com/nickitat)).
* `enable_user_name_access_type` не должен влиять на тип доступа `DEFINER`. [#80026](https://github.com/ClickHouse/ClickHouse/pull/80026) ([pufit](https://github.com/pufit)).
* Запрос к системной базе данных может зависнуть, если метаданные системной базы данных находятся в Keeper. [#79304](https://github.com/ClickHouse/ClickHouse/pull/79304) ([Mikhail Artemenko](https://github.com/Michicosun)).

#### Улучшения сборки/тестирования/упаковки

- Добавлена возможность повторного использования собранного бинарного файла `chcache` вместо его постоянной пересборки. [#78851](https://github.com/ClickHouse/ClickHouse/pull/78851) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Добавлено ожидание паузы NATS. [#78987](https://github.com/ClickHouse/ClickHouse/pull/78987) ([Dmitry Novikov](https://github.com/dmitry-sles-novikov)).
- Исправлена ошибка некорректной публикации ARM-сборки как amd64compat. [#79122](https://github.com/ClickHouse/ClickHouse/pull/79122) ([Alexander Gololobov](https://github.com/davenger)).
- Используется предварительно сгенерированный ассемблерный код для OpenSSL. [#79386](https://github.com/ClickHouse/ClickHouse/pull/79386) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Исправления для обеспечения возможности сборки с `clang20`. [#79588](https://github.com/ClickHouse/ClickHouse/pull/79588) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- `chcache`: поддержка кэширования Rust. [#78691](https://github.com/ClickHouse/ClickHouse/pull/78691) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Добавлена информация для раскрутки стека в ассемблерных файлах `zstd`. [#79288](https://github.com/ClickHouse/ClickHouse/pull/79288) ([Michael Kolupaev](https://github.com/al13n321)).

### Релиз ClickHouse 25.4, 2025-04-22 {#254}

#### Обратно несовместимые изменения

- Добавлена проверка соответствия всех столбцов материализованного представления целевой таблице, когда `allow_materialized_view_with_bad_select` установлен в `false`. [#74481](https://github.com/ClickHouse/ClickHouse/pull/74481) ([Christoph Wurm](https://github.com/cwurm)).
- Исправлены случаи использования `dateTrunc` с отрицательными аргументами Date/DateTime. [#77622](https://github.com/ClickHouse/ClickHouse/pull/77622) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Устаревшая интеграция `MongoDB` удалена. Серверная настройка `use_legacy_mongodb_integration` стала устаревшей и теперь не выполняет никаких действий. [#77895](https://github.com/ClickHouse/ClickHouse/pull/77895) ([Robert Schulze](https://github.com/rschu1ze)).
- Улучшена валидация `SummingMergeTree` для пропуска агрегации столбцов, используемых в ключах партиционирования или сортировки. [#78022](https://github.com/ClickHouse/ClickHouse/pull/78022) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).


#### Новая функция

* Добавлено планирование рабочих нагрузок по слотам ЦП, подробности см. в [документации](https://clickhouse.com/docs/operations/workload-scheduling#cpu_scheduling). [#77595](https://github.com/ClickHouse/ClickHouse/pull/77595) ([Sergei Trifonov](https://github.com/serxa)).
* `clickhouse-local` будет сохранять свои базы данных после перезапуска, если указать аргумент командной строки `--path`. Исправляет [#50647](https://github.com/ClickHouse/ClickHouse/issues/50647). Исправляет [#49947](https://github.com/ClickHouse/ClickHouse/issues/49947). [#71722](https://github.com/ClickHouse/ClickHouse/pull/71722) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Отклонять запросы, когда сервер перегружен. Решение принимается на основе отношения времени ожидания (`OSCPUWaitMicroseconds`) к времени занятости (`OSCPUVirtualTimeMicroseconds`). Запрос с некоторой вероятностью отбрасывается, когда это отношение находится между `min_os_cpu_wait_time_ratio_to_throw` и `max_os_cpu_wait_time_ratio_to_throw` (это настройки на уровне запроса). [#63206](https://github.com/ClickHouse/ClickHouse/pull/63206) ([Alexey Katsman](https://github.com/alexkats)).
* Путешествия во времени в `Iceberg`: добавлена настройка для выполнения запросов к таблицам `Iceberg` на состояние на определённый момент времени (по `timestamp`). [#71072](https://github.com/ClickHouse/ClickHouse/pull/71072) ([Brett Hoerner](https://github.com/bretthoerner)). [#77439](https://github.com/ClickHouse/ClickHouse/pull/77439) ([Daniil Ivanik](https://github.com/divanik)).
* Кэш в памяти для метаданных `Iceberg`, в котором хранятся файлы/списки манифестов и `metadata.json` для ускорения выполнения запросов. [#77156](https://github.com/ClickHouse/ClickHouse/pull/77156) ([Han Fei](https://github.com/hanfei1991)).
* Поддержка движка таблиц `DeltaLake` для Azure Blob Storage. Исправляет [#68043](https://github.com/ClickHouse/ClickHouse/issues/68043). [#74541](https://github.com/ClickHouse/ClickHouse/pull/74541) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Добавлен кэш в памяти для десериализованных индексов векторного сходства. Это должно ускорить повторяющиеся запросы приблизительного поиска ближайших соседей (ANN). Размер нового кэша задаётся серверными настройками `vector_similarity_index_cache_size` и `vector_similarity_index_cache_max_entries`. Эта возможность заменяет механизм кэша пропускающего индекса из более ранних релизов. [#77905](https://github.com/ClickHouse/ClickHouse/pull/77905) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Добавлена поддержка отсечения партиций в DeltaLake. [#78486](https://github.com/ClickHouse/ClickHouse/pull/78486) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Поддержка фонового обновления в таблицах `MergeTree` в режиме только для чтения, что позволяет выполнять запросы к обновляемым таблицам с неограниченным количеством распределённых читателей (родное для ClickHouse озеро данных). [#76467](https://github.com/ClickHouse/ClickHouse/pull/76467) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Поддержка использования пользовательских дисков для хранения файлов метаданных баз данных. В настоящее время это можно настроить только на глобальном уровне сервера. [#77365](https://github.com/ClickHouse/ClickHouse/pull/77365) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Добавлена поддержка `ALTER TABLE ... ATTACH|DETACH|MOVE|REPLACE PARTITION` для диска `plain_rewritable`. [#77406](https://github.com/ClickHouse/ClickHouse/pull/77406) ([Julia Kartseva](https://github.com/jkartseva)).
* Добавлены настройки таблицы для конфигурации `SASL` и учетных данных в таблицу с движком `Kafka`. Это позволяет настраивать аутентификацию на основе SASL для Kafka и совместимых с Kafka систем непосредственно в операторе CREATE TABLE, вместо использования конфигурационных файлов или именованных коллекций. [#78810](https://github.com/ClickHouse/ClickHouse/pull/78810) ([Christoph Wurm](https://github.com/cwurm)).
* Разрешена установка `default_compression_codec` для таблиц MergeTree: он используется, если в запросе CREATE он явно не задан для соответствующих столбцов. Это закрывает [#42005](https://github.com/ClickHouse/ClickHouse/issues/42005). [#66394](https://github.com/ClickHouse/ClickHouse/pull/66394) ([gvoelfin](https://github.com/gvoelfin)).
* Добавлена настройка `bind_host` в конфигурацию кластеров, чтобы ClickHouse мог использовать определённую сеть для распределённых подключений. [#74741](https://github.com/ClickHouse/ClickHouse/pull/74741) ([Todd Yocum](https://github.com/toddyocum)).
* Добавлен новый столбец `parametrized_view_parameters` в `system.tables`. Закрывает [https://github.com/clickhouse/clickhouse/issues/66756](https://github.com/clickhouse/clickhouse/issues/66756). [#75112](https://github.com/ClickHouse/ClickHouse/pull/75112) ([NamNguyenHoai](https://github.com/NamHoaiNguyen)).
* Разрешить изменение комментария базы данных. Закрывает [#73351](https://github.com/ClickHouse/ClickHouse/issues/73351) ### Запись в документации об изменениях, видимых пользователю. [#75622](https://github.com/ClickHouse/ClickHouse/pull/75622) ([NamNguyenHoai](https://github.com/NamHoaiNguyen)).
* Поддержка аутентификации `SCRAM-SHA-256` в протоколе совместимости с PostgreSQL. [#76839](https://github.com/ClickHouse/ClickHouse/pull/76839) ([scanhex12](https://github.com/scanhex12)).
* Добавлены функции `arrayLevenshteinDistance`, `arrayLevenshteinDistanceWeighted` и `arraySimilarity`. [#77187](https://github.com/ClickHouse/ClickHouse/pull/77187) ([Mikhail F. Shiryaev](https://github.com/Felixoid)).
* Настройка `parallel_distributed_insert_select` теперь применяется и к `INSERT SELECT` в `ReplicatedMergeTree` (ранее для этого требовались таблицы `Distributed`). [#78041](https://github.com/ClickHouse/ClickHouse/pull/78041) ([Igor Nikonov](https://github.com/devcrafter)).
* Добавлена функция `toInterval`. Она принимает два аргумента (значение и единицу измерения) и преобразует значение в конкретный тип `Interval`. [#78723](https://github.com/ClickHouse/ClickHouse/pull/78723) ([Andrew Davis](https://github.com/pulpdrew)).
* Добавлено несколько удобных способов определения корневого файла `metadata.json` в табличной функции и движке iceberg. Закрывает [#78455](https://github.com/ClickHouse/ClickHouse/issues/78455). [#78475](https://github.com/ClickHouse/ClickHouse/pull/78475) ([Daniil Ivanik](https://github.com/divanik)).
* Добавлена поддержка аутентификации по паролю в протоколе SSH в ClickHouse. [#78586](https://github.com/ClickHouse/ClickHouse/pull/78586) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).



#### Экспериментальная возможность
* Поддержка коррелированных подзапросов в качестве аргумента выражения `EXISTS` в предложении `WHERE`. Закрывает [#72459](https://github.com/ClickHouse/ClickHouse/issues/72459). [#76078](https://github.com/ClickHouse/ClickHouse/pull/76078) ([Dmitry Novik](https://github.com/novikd)).
* Добавлены функции `sparseGrams` и `sparseGramsHashes` с вариантами для ASCII и UTF8. Автор: [scanhex12](https://github.com/scanhex12). [#78176](https://github.com/ClickHouse/ClickHouse/pull/78176) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)). Не используйте их: реализация будет изменена в следующих версиях.



#### Улучшение производительности

* Оптимизирована производительность за счёт ленивых столбцов, которые читают данные после ORDER BY и LIMIT. [#55518](https://github.com/ClickHouse/ClickHouse/pull/55518) ([Xiaozhe Yu](https://github.com/wudidapaopao)).
* По умолчанию включено кеширование условий запросов. [#79080](https://github.com/ClickHouse/ClickHouse/pull/79080) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Ускорена сборка результата JOIN за счёт девиртуализации вызовов `col->insertFrom()`. [#77350](https://github.com/ClickHouse/ClickHouse/pull/77350) ([Alexander Gololobov](https://github.com/davenger)).
* При возможности объединяются условия равенства из шага плана запроса `FILTER` с условием `JOIN`, чтобы их можно было использовать в качестве ключей хеш-таблицы. [#78877](https://github.com/ClickHouse/ClickHouse/pull/78877) ([Dmitry Novik](https://github.com/novikd)).
* Используйте динамический шардинг для JOIN, если ключ JOIN является префиксом первичного ключа для обеих частей. Эта оптимизация включается с помощью настройки `query_plan_join_shard_by_pk_ranges` (по умолчанию отключена). [#74733](https://github.com/ClickHouse/ClickHouse/pull/74733) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Поддержка прореживания данных `Iceberg` на основе нижних и верхних граничных значений для столбцов. Исправляет [#77638](https://github.com/ClickHouse/ClickHouse/issues/77638). [#78242](https://github.com/ClickHouse/ClickHouse/pull/78242) ([alesapin](https://github.com/alesapin)).
* Реализована простая оптимизация подсчёта для `Iceberg`. Теперь запросы с `count()` и без каких‑либо фильтров должны выполняться быстрее. Закрывает [#77639](https://github.com/ClickHouse/ClickHouse/issues/77639). [#78090](https://github.com/ClickHouse/ClickHouse/pull/78090) ([alesapin](https://github.com/alesapin)).
* Добавлена возможность настраивать количество столбцов, которые операции слияния могут сбрасывать параллельно, с помощью `max_merge_delayed_streams_for_parallel_write` (это должно примерно в 25 раз снизить потребление памяти при вертикальных слияниях в S3). [#77922](https://github.com/ClickHouse/ClickHouse/pull/77922) ([Azat Khuzhin](https://github.com/azat)).
* Отключите `filesystem_cache_prefer_bigger_buffer_size`, когда кэш используется пассивно, например при слияниях. Это снижает потребление памяти во время слияний. [#77898](https://github.com/ClickHouse/ClickHouse/pull/77898) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Теперь для определения размера задачи при чтении с включёнными параллельными репликами используется количество реплик. Это обеспечивает более равномерное распределение нагрузки между репликами, когда объём данных для чтения не слишком велик. [#78695](https://github.com/ClickHouse/ClickHouse/pull/78695) ([Nikita Taranov](https://github.com/nickitat)).
* Поддержка асинхронного предварительного чтения (prefetch) для формата `ORC`, что повышает общую производительность за счёт сокрытия задержек удалённого ввода-вывода. [#70534](https://github.com/ClickHouse/ClickHouse/pull/70534) ([李扬](https://github.com/taiyang-li)).
* Предварительно выделяется память, используемая для асинхронных вставок, чтобы повысить производительность. [#74945](https://github.com/ClickHouse/ClickHouse/pull/74945) ([Ilya Golshtein](https://github.com/ilejn)).
* Уменьшает количество запросов к Keeper за счет отказа от использования одиночных запросов `get` в местах, где доступен `multiRead`, поскольку при увеличении числа реплик они могли создавать значительную нагрузку на Keeper. [#56862](https://github.com/ClickHouse/ClickHouse/pull/56862) ([Nikolay Degterinsky](https://github.com/evillique)).
* Незначительная оптимизация выполнения функций над аргументами типа Nullable. [#76489](https://github.com/ClickHouse/ClickHouse/pull/76489) ([李扬](https://github.com/taiyang-li)).
* Оптимизация `arraySort`. [#76850](https://github.com/ClickHouse/ClickHouse/pull/76850) ([李扬](https://github.com/taiyang-li)).
* Метки одной и той же части теперь объединяются и единоразово записываются в кэш условий запроса, чтобы сократить использование блокировок. [#77377](https://github.com/ClickHouse/ClickHouse/pull/77377) ([zhongyuankai](https://github.com/zhongyuankai)).
* Оптимизирована производительность `s3Cluster` для запросов с одной раскрывающейся скобкой. [#77686](https://github.com/ClickHouse/ClickHouse/pull/77686) ([Tomáš Hromada](https://github.com/gyfis)).
* Оптимизация `ORDER BY` по отдельным столбцам типа `Nullable` или `LowCardinality`. [#77789](https://github.com/ClickHouse/ClickHouse/pull/77789) ([李扬](https://github.com/taiyang-li)).
* Оптимизировано использование памяти формата `Native`. [#78442](https://github.com/ClickHouse/ClickHouse/pull/78442) ([Azat Khuzhin](https://github.com/azat)).
* Тривиальная оптимизация: не переписывать `count(if(...))` на `countIf`, если требуется приведение типа. Закрывает [#78564](https://github.com/ClickHouse/ClickHouse/issues/78564). [#78565](https://github.com/ClickHouse/ClickHouse/pull/78565) ([李扬](https://github.com/taiyang-li)).
* Функция `hasAll` теперь может использовать полнотекстовые пропускающие индексы `tokenbf_v1`, `ngrambf_v1`. [#77662](https://github.com/ClickHouse/ClickHouse/pull/77662) ([UnamedRus](https://github.com/UnamedRus)).
* Индекс сходства векторов мог выделять основную память с избыточным запасом — до 2 раз. Это исправление пересматривает стратегию выделения памяти, снижает её потребление и повышает эффективность кэша индекса сходства векторов. (issue [#78056](https://github.com/ClickHouse/ClickHouse/issues/78056)). [#78394](https://github.com/ClickHouse/ClickHouse/pull/78394) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Введена настройка `schema_type` для таблицы `system.metric_log`, задающая тип схемы. Доступны три варианта схем: `wide` — текущая схема, каждая метрика/событие в отдельном столбце (наиболее эффективно для чтения отдельных столбцов), `transposed` — аналогична `system.asynchronous_metric_log`, метрики/события хранятся по строкам, и самая интересная `transposed_with_wide_view` — создаётся базовая таблица со схемой `transposed`, а также добавляется представление со схемой `wide`, которое транслирует запросы в базовую таблицу. В `transposed_with_wide_view` субсекундное разрешение для представления не поддерживается, `event_time_microseconds` — это лишь псевдоним для обеспечения обратной совместимости. [#78412](https://github.com/ClickHouse/ClickHouse/pull/78412) ([alesapin](https://github.com/alesapin)).





#### Улучшение

* Сериализация плана запроса для запросов к таблицам `Distributed`. Добавлена новая настройка `serialize_query_plan`. При её включении запросы из таблицы `Distributed` будут использовать сериализованный план запроса для удалённого выполнения. Это добавляет новый тип пакета в протокол TCP; в конфигурацию сервера следует добавить `<process_query_plan_packet>true</process_query_plan_packet>`, чтобы разрешить обработку этого пакета. [#69652](https://github.com/ClickHouse/ClickHouse/pull/69652) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлена поддержка чтения типа `JSON` и подстолбцов из представлений. [#76903](https://github.com/ClickHouse/ClickHouse/pull/76903) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена поддержка ALTER DATABASE ... ON CLUSTER. [#79242](https://github.com/ClickHouse/ClickHouse/pull/79242) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Обновления обновляемых материализованных представлений теперь отражаются в `system.query_log`. [#71333](https://github.com/ClickHouse/ClickHouse/pull/71333) ([Michael Kolupaev](https://github.com/al13n321)).
* Пользовательские функции (UDF) теперь можно помечать как детерминированные с помощью нового параметра в их конфигурации. Кроме того, кэш запросов теперь проверяет, являются ли вызываемые в запросе UDF детерминированными. Если да, результат запроса кэшируется. (Issue [#59988](https://github.com/ClickHouse/ClickHouse/issues/59988)). [#77769](https://github.com/ClickHouse/ClickHouse/pull/77769) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
* Включена логика бэкоффа (backoff) для всех типов реплицируемых задач. Это позволит снизить нагрузку на CPU, потребление памяти и размер файлов логов. Добавлены новые настройки `max_postpone_time_for_failed_replicated_fetches_ms`, `max_postpone_time_for_failed_replicated_merges_ms` и `max_postpone_time_for_failed_replicated_tasks_ms`, аналогичные `max_postpone_time_for_failed_mutations_ms`. [#74576](https://github.com/ClickHouse/ClickHouse/pull/74576) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Добавлен `query_id` в `system.errors`. Исправляет [#75815](https://github.com/ClickHouse/ClickHouse/issues/75815). [#76581](https://github.com/ClickHouse/ClickHouse/pull/76581) ([Vladimir Baikov](https://github.com/bkvvldmr)).
* Добавлена поддержка преобразования `UInt128` в `IPv6`. Это позволяет использовать операцию `bitAnd` и выполнять арифметические операции для `IPv6`, а также выполнять преобразование обратно в `IPv6`. Закрывает [#76752](https://github.com/ClickHouse/ClickHouse/issues/76752). Это также позволяет преобразовывать результат операции `bitAnd` над `IPv6` обратно в `IPv6`. См. также [#57707](https://github.com/ClickHouse/ClickHouse/pull/57707). [#76928](https://github.com/ClickHouse/ClickHouse/pull/76928) ([Muzammil Abdul Rehman](https://github.com/muzammilar)).
* По умолчанию не парсить специальные значения `Bool` в текстовых форматах внутри типа `Variant`. Это поведение можно включить с помощью настройки `allow_special_bool_values_inside_variant`. [#76974](https://github.com/ClickHouse/ClickHouse/pull/76974) ([Pavel Kruglov](https://github.com/Avogar)).
* Поддержка настраиваемого времени ожидания для запросов с низким `priority` на уровне сессии и сервера. [#77013](https://github.com/ClickHouse/ClickHouse/pull/77013) ([VicoWu](https://github.com/VicoWu)).
* Реализовано сравнение значений типа данных JSON. Теперь объекты JSON можно сравнивать аналогично значениям Map. [#77397](https://github.com/ClickHouse/ClickHouse/pull/77397) ([Pavel Kruglov](https://github.com/Avogar)).
* Улучшена поддержка прав доступа в `system.kafka_consumers`. Добавлена передача внутренних ошибок `librdkafka` (стоит отметить, что эта библиотека оставляет желать лучшего). [#77700](https://github.com/ClickHouse/ClickHouse/pull/77700) ([Ilya Golshtein](https://github.com/ilejn)).
* Добавлена валидация настроек движка таблицы Buffer. [#77840](https://github.com/ClickHouse/ClickHouse/pull/77840) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Добавлен параметр конфигурации `enable_hdfs_pread` для включения или отключения `pread` в `HDFS`. [#77885](https://github.com/ClickHouse/ClickHouse/pull/77885) ([kevinyhzou](https://github.com/KevinyhZou)).
* Добавлены события профилирования для количества операций чтения и записи ZooKeeper через `multi`. [#77888](https://github.com/ClickHouse/ClickHouse/pull/77888) ([JackyWoo](https://github.com/JackyWoo)).
* Разрешить создание и вставку во временные таблицы, когда `disable_insertion_and_mutation` включён. [#77901](https://github.com/ClickHouse/ClickHouse/pull/77901) ([Xu Jia](https://github.com/XuJia0210)).
* Уменьшить значение `max_insert_delayed_streams_for_parallel_write` (до 100). [#77919](https://github.com/ClickHouse/ClickHouse/pull/77919) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен разбор года в синтаксисе Joda (из мира Java, если вы вдруг не знали) вроде `yyy`. [#77973](https://github.com/ClickHouse/ClickHouse/pull/77973) ([李扬](https://github.com/taiyang-li)).
* Присоединение кусков таблиц `MergeTree` теперь выполняется в порядке их блоков, что важно для специальных алгоритмов слияния, таких как `ReplacingMergeTree`. Это закрывает [#71009](https://github.com/ClickHouse/ClickHouse/issues/71009). [#77976](https://github.com/ClickHouse/ClickHouse/pull/77976) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Правила маскирования запросов теперь могут выбрасывать `LOGICAL_ERROR` в случае, если произошло совпадение. Это помогает проверить, не утечёт ли предопределённый пароль где-либо в логах. [#78094](https://github.com/ClickHouse/ClickHouse/pull/78094) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлен столбец `index_length_column` в `information_schema.tables` для улучшения совместимости с MySQL. [#78119](https://github.com/ClickHouse/ClickHouse/pull/78119) ([Paweł Zakrzewski](https://github.com/KrzaQ)).
* Добавлены две новые метрики: `TotalMergeFailures` и `NonAbortedMergeFailures`. Эти метрики необходимы для выявления ситуаций, когда за короткий период происходит слишком много неуспешных операций слияния. [#78150](https://github.com/ClickHouse/ClickHouse/pull/78150) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Исправлен некорректный разбор URL S3 при отсутствии ключа в режиме path-style. [#78185](https://github.com/ClickHouse/ClickHouse/pull/78185) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлены некорректные значения асинхронных метрик `BlockActiveTime`, `BlockDiscardTime`, `BlockWriteTime`, `BlockQueueTime` и `BlockReadTime` (до изменения 1 секунда ошибочно отображалась как 0.001). [#78211](https://github.com/ClickHouse/ClickHouse/pull/78211) ([filimonov](https://github.com/filimonov)).
* Соблюдается лимит `loading_retries` для ошибок во время отправки данных в материализованное представление для StorageS3(Azure)Queue. Ранее такие ошибки переотправлялись бесконечно. [#78313](https://github.com/ClickHouse/ClickHouse/pull/78313) ([Kseniia Sumarokova](https://github.com/kssenii)).
* В DeltaLake с реализацией `delta-kernel-rs` улучшена производительность и индикатор прогресса. [#78368](https://github.com/ClickHouse/ClickHouse/pull/78368) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Поддержка `include`, `from_env`, `from_zk` для дисков в режиме runtime. Закрывает [#78177](https://github.com/ClickHouse/ClickHouse/issues/78177). [#78470](https://github.com/ClickHouse/ClickHouse/pull/78470) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлено динамическое предупреждение в таблицу `system.warnings` для долго выполняющихся изменений. [#78658](https://github.com/ClickHouse/ClickHouse/pull/78658) ([Bharat Nallan](https://github.com/bharatnc)).
* В системную таблицу `system.query_condition_cache` добавлено поле `condition`. В нём хранится условие в текстовом виде, хеш которого используется в качестве ключа в кеше условий запросов. [#78671](https://github.com/ClickHouse/ClickHouse/pull/78671) ([Robert Schulze](https://github.com/rschu1ze)).
* Разрешить пустое значение для разбиения на разделы Hive. [#78816](https://github.com/ClickHouse/ClickHouse/pull/78816) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлено приведение типов в предложении `IN` для `BFloat16` (т.е. `SELECT toBFloat16(1) IN [1, 2, 3];` теперь возвращает `1`). Закрывает [#78754](https://github.com/ClickHouse/ClickHouse/issues/78754). [#78839](https://github.com/ClickHouse/ClickHouse/pull/78839) ([Raufs Dunamalijevs](https://github.com/rienath)).
* Не проверять части на других дисках для `MergeTree`, если установлено `disk = ...`. [#78855](https://github.com/ClickHouse/ClickHouse/pull/78855) ([Azat Khuzhin](https://github.com/azat)).
* Типы данных в `used_data_type_families` в `system.query_log` теперь записываются с каноническими именами. [#78972](https://github.com/ClickHouse/ClickHouse/pull/78972) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Очистка настроек во время `recoverLostReplica` реализована так же, как в: [#78637](https://github.com/ClickHouse/ClickHouse/pull/78637). [#79113](https://github.com/ClickHouse/ClickHouse/pull/79113) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Используйте столбцы вставки для вывода схемы при использовании `INFILE`. [#78490](https://github.com/ClickHouse/ClickHouse/pull/78490) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).





#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе)

* Исправлен некорректный анализ проекций при использовании `count(Nullable)` в агрегатных проекциях. Это устраняет [#74495](https://github.com/ClickHouse/ClickHouse/issues/74495). В этот PR также добавлены логи, связанные с анализом проекций, чтобы прояснить, почему проекция используется или не используется. [#74498](https://github.com/ClickHouse/ClickHouse/pull/74498) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка `Part <...> does not contain in snapshot of previous virtual parts. (PART_IS_TEMPORARILY_LOCKED)` при выполнении `DETACH PART`. [#76039](https://github.com/ClickHouse/ClickHouse/pull/76039) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Исправлена некорректная работа пропускающих индексов с выражениями, содержащими литералы, в analyzer и удалены тривиальные приведения типов при анализе индексов. [#77229](https://github.com/ClickHouse/ClickHouse/pull/77229) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка, из-за которой параметр запроса `close_session` не оказывал никакого эффекта и именованные сессии закрывались только после `session_timeout`. [#77336](https://github.com/ClickHouse/ClickHouse/pull/77336) ([Alexey Katsman](https://github.com/alexkats)).
* Исправлен приём сообщений от сервера NATS без прикреплённых Materialized Views. [#77392](https://github.com/ClickHouse/ClickHouse/pull/77392) ([Dmitry Novikov](https://github.com/dmitry-sles-novikov)).
* Исправлена логическая ошибка при чтении из пустого `FileLog` с помощью табличной функции `merge`, закрыт [#75575](https://github.com/ClickHouse/ClickHouse/issues/75575). [#77441](https://github.com/ClickHouse/ClickHouse/pull/77441) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Использовать настройки формата по умолчанию в сериализации `Dynamic` для общего варианта. [#77572](https://github.com/ClickHouse/ClickHouse/pull/77572) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена проверка существования пути к данным таблицы на локальном диске. [#77608](https://github.com/ClickHouse/ClickHouse/pull/77608) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлена передача константных значений на удалённый сервер для некоторых типов. [#77634](https://github.com/ClickHouse/ClickHouse/pull/77634) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка, приводившая к сбою из-за просроченного контекста в S3/AzureQueue. [#77720](https://github.com/ClickHouse/ClickHouse/pull/77720) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Скрытие учетных данных в движках таблиц RabbitMQ, Nats, Redis и AzureQueue. [#77755](https://github.com/ClickHouse/ClickHouse/pull/77755) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено неопределённое поведение при сравнении `NaN` в `argMin`/`argMax`. [#77756](https://github.com/ClickHouse/ClickHouse/pull/77756) ([Raúl Marín](https://github.com/Algunenano)).
* Регулярно проверяйте, были ли слияния и мутации отменены, даже в тех случаях, когда операция не создает блоков для записи. [#77766](https://github.com/ClickHouse/ClickHouse/pull/77766) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлена проблема с работой обновляемого материализованного представления в реплицируемой базе данных на вновь добавленных репликах. [#77774](https://github.com/ClickHouse/ClickHouse/pull/77774) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлен возможный сбой при возникновении ошибки `NOT_FOUND_COLUMN_IN_BLOCK`. [#77854](https://github.com/ClickHouse/ClickHouse/pull/77854) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлена ошибка, приводившая к сбою в S3/AzureQueue при заполнении данных. [#77878](https://github.com/ClickHouse/ClickHouse/pull/77878) ([Bharat Nallan](https://github.com/bharatnc)).
* Отключен нечёткий поиск по истории на SSH-сервере (так как он требует библиотеку skim). [#78002](https://github.com/ClickHouse/ClickHouse/pull/78002) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, из-за которой запрос векторного поиска по неиндексированному столбцу возвращал некорректные результаты, если в таблице был другой векторный столбец с настроенным индексом векторного сходства. (Issue [#77978](https://github.com/ClickHouse/ClickHouse/issues/77978)). [#78069](https://github.com/ClickHouse/ClickHouse/pull/78069) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Исправлена незначительная ошибка в сообщении запроса &quot;The requested output format {} is binary... Do you want to output it anyway? [y/N]&quot;. [#78095](https://github.com/ClickHouse/ClickHouse/pull/78095) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка при использовании `toStartOfInterval` с нулевым аргументом origin. [#78096](https://github.com/ClickHouse/ClickHouse/pull/78096) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Запрещено указывать пустой параметр запроса `session_id` в HTTP-интерфейсе. [#78098](https://github.com/ClickHouse/ClickHouse/pull/78098) ([Alexey Katsman](https://github.com/alexkats)).
* Исправлено перезаписывание метаданных в базе данных `Replicated`, которое могло происходить из‑за выполнения запроса `RENAME` сразу после запроса `ALTER`. [#78107](https://github.com/ClickHouse/ClickHouse/pull/78107) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлено падение в движке `NATS`. [#78108](https://github.com/ClickHouse/ClickHouse/pull/78108) ([Dmitry Novikov](https://github.com/dmitry-sles-novikov)).
* Не пытаться создавать history&#95;file во встроенном SSH-клиенте (в предыдущих версиях создание всегда завершалось неудачей, но всё же выполнялось). [#78112](https://github.com/ClickHouse/ClickHouse/pull/78112) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено некорректное отображение данных в `system.detached_tables` после выполнения запросов `RENAME DATABASE` или `DROP TABLE`. [#78126](https://github.com/ClickHouse/ClickHouse/pull/78126) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена проверка на слишком большое количество таблиц в базе данных `Replicated` после [#77274](https://github.com/ClickHouse/ClickHouse/pull/77274). Также теперь проверка выполняется до создания хранилища, чтобы избежать создания неучтённых узлов в Keeper в случае `ReplicatedMergeTree` или `KeeperMap`. [#78127](https://github.com/ClickHouse/ClickHouse/pull/78127) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлено возможное аварийное завершение работы из-за параллельной инициализации метаданных `S3Queue`. [#78131](https://github.com/ClickHouse/ClickHouse/pull/78131) ([Azat Khuzhin](https://github.com/azat)).
* Функции `groupArray*` теперь выдают ошибку `BAD_ARGUMENTS` для значения 0 типа Int в аргументе `max_size` (как это уже делается для значения типа UInt), вместо попытки выполнить его. [#78140](https://github.com/ClickHouse/ClickHouse/pull/78140) ([Eduard Karacharov](https://github.com/korowa)).
* Предотвращён сбой при восстановлении потерянной реплики, если локальная таблица была удалена до её отсоединения. [#78173](https://github.com/ClickHouse/ClickHouse/pull/78173) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена проблема, из-за которой столбец &quot;alterable&quot; в `system.s3_queue_settings` всегда возвращал `false`. [#78187](https://github.com/ClickHouse/ClickHouse/pull/78187) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Маскировать подпись доступа Azure, чтобы она не отображалась пользователю и в логах. [#78189](https://github.com/ClickHouse/ClickHouse/pull/78189) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена предварительная выборка подпотоков с префиксами в Wide-частях. [#78205](https://github.com/ClickHouse/ClickHouse/pull/78205) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлены падения и некорректные результаты для `mapFromArrays` в случае типа массива ключей `LowCardinality(Nullable)`. [#78240](https://github.com/ClickHouse/ClickHouse/pull/78240) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлены параметры авторизации в delta-kernel-rs. [#78255](https://github.com/ClickHouse/ClickHouse/pull/78255) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Не планировать задачу Refreshable Materialized Views, если у реплики `disable_insertion_and_mutation` установлено в true. Задача подразумевает вставку, которая завершится с ошибкой, если `disable_insertion_and_mutation` равно true. [#78277](https://github.com/ClickHouse/ClickHouse/pull/78277) ([Xu Jia](https://github.com/XuJia0210)).
* Проверена корректность доступа к базовым таблицам для движка `Merge`. [#78339](https://github.com/ClickHouse/ClickHouse/pull/78339) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Модификатор `FINAL` может игнорироваться при запросах к таблице `Distributed`. [#78428](https://github.com/ClickHouse/ClickHouse/pull/78428) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* `bitmapMin` возвращает uint32&#95;max, когда битовая карта пуста (и uint64&#95;max, когда тип входных данных шире), что соответствует поведению функции minimum для пустого roaring&#95;bitmap. [#78444](https://github.com/ClickHouse/ClickHouse/pull/78444) ([wxybear](https://github.com/wxybear)).
* Отключена параллелизация обработки запроса сразу после чтения секции FROM при включённом `distributed_aggregation_memory_efficient`, так как это может приводить к логической ошибке. Закрывает [#76934](https://github.com/ClickHouse/ClickHouse/issues/76934). [#78500](https://github.com/ClickHouse/ClickHouse/pull/78500) ([flynn](https://github.com/ucasfl)).
* Устанавливается как минимум один поток для чтения на случай, если после применения настройки `max_streams_to_max_threads_ratio` не останется ни одного запланированного потока. [#78505](https://github.com/ClickHouse/ClickHouse/pull/78505) ([Eduard Karacharov](https://github.com/korowa)).
* В хранилище `S3Queue` исправлена логическая ошибка «Cannot unregister: table uuid is not registered». Закрывает [#78285](https://github.com/ClickHouse/ClickHouse/issues/78285). [#78541](https://github.com/ClickHouse/ClickHouse/pull/78541) ([Kseniia Sumarokova](https://github.com/kssenii)).
* ClickHouse теперь умеет определять свой cgroup v2 на системах, где одновременно включены cgroups v1 и v2. [#78566](https://github.com/ClickHouse/ClickHouse/pull/78566) ([Grigory Korolev](https://github.com/gkorolev)).
* Табличные функции `-Cluster` завершались с ошибкой при использовании с настройками на уровне таблицы. [#78587](https://github.com/ClickHouse/ClickHouse/pull/78587) ([Daniil Ivanik](https://github.com/divanik)).
* Улучшены проверки на отсутствие поддержки транзакций в ReplicatedMergeTree при выполнении INSERT. [#78633](https://github.com/ClickHouse/ClickHouse/pull/78633) ([Azat Khuzhin](https://github.com/azat)).
* Очистка настроек запроса при выполнении `ATTACH`. [#78637](https://github.com/ClickHouse/ClickHouse/pull/78637) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено падение при указании некорректного пути в `iceberg_metadata_file_path`. [#78688](https://github.com/ClickHouse/ClickHouse/pull/78688) ([alesapin](https://github.com/alesapin)).
* В движке таблиц `DeltaLake` с реализацией delta-kernel-s исправлена ситуация, когда схема чтения отличается от схемы таблицы и при этом присутствуют колонки секционирования, что приводило к ошибке «not found column». [#78690](https://github.com/ClickHouse/ClickHouse/pull/78690) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проблема, при которой после планирования закрытия именованной сессии (но до истечения тайм-аута) создание новой именованной сессии с тем же именем приводило к её закрытию в момент, когда должна была быть закрыта первая сессия. [#78698](https://github.com/ClickHouse/ClickHouse/pull/78698) ([Alexey Katsman](https://github.com/alexkats)).
* Исправлено несколько типов запросов `SELECT`, читающих из таблиц с движком `MongoDB` или табличной функцией `mongodb`: запросы с неявным преобразованием константного значения в выражении `WHERE` (например, `WHERE datetime = '2025-03-10 00:00:00'`); запросы с `LIMIT` и `GROUP BY`. Ранее они могли возвращать неверный результат. [#78777](https://github.com/ClickHouse/ClickHouse/pull/78777) ([Anton Popov](https://github.com/CurtizJ)).
* Не блокировать выключение таблицы во время выполнения `CHECK TABLE`. [#78782](https://github.com/ClickHouse/ClickHouse/pull/78782) ([Raúl Marín](https://github.com/Algunenano)).
* Keeper: исправление — корректный подсчёт эфемерных нод во всех случаях. [#78799](https://github.com/ClickHouse/ClickHouse/pull/78799) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено некорректное приведение типов в `StorageDistributed` при использовании табличных функций, отличных от `view`. Закрывает [#78464](https://github.com/ClickHouse/ClickHouse/issues/78464). [#78828](https://github.com/ClickHouse/ClickHouse/pull/78828) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлена единообразность форматирования для `tupleElement(*, 1)`. Закрывает [#78639](https://github.com/ClickHouse/ClickHouse/issues/78639). [#78832](https://github.com/ClickHouse/ClickHouse/pull/78832) ([Konstantин Богданов](https://github.com/thevar1able)).
* Словари типа `ssd_cache` теперь отклоняют нулевые или отрицательные значения параметров `block_size` и `write_buffer_size` (issue [#78314](https://github.com/ClickHouse/ClickHouse/issues/78314)). [#78854](https://github.com/ClickHouse/ClickHouse/pull/78854) ([Elmi Ahmadov](https://github.com/ahmadov)).
* Исправлена ошибка, приводившая к сбою в Refreshable MATERIALIZED VIEW при выполнении ALTER после некорректного завершения работы. [#78858](https://github.com/ClickHouse/ClickHouse/pull/78858) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен разбор некорректных значений `DateTime` в формате `CSV`. [#78919](https://github.com/ClickHouse/ClickHouse/pull/78919) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправление Keeper: предотвращён запуск `watches` при неуспешных `multi`-запросах. [#79247](https://github.com/ClickHouse/ClickHouse/pull/79247) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка чтения таблицы Iceberg, когда минимально-максимальное значение указано явно, но равно `NULL`. Было отмечено, что библиотека Go Iceberg генерирует такие некорректные файлы. Закрывает [#78740](https://github.com/ClickHouse/ClickHouse/issues/78740). [#78764](https://github.com/ClickHouse/ClickHouse/pull/78764) ([flynn](https://github.com/ucasfl)).

#### Улучшения сборки/тестирования/упаковки

- Учёт целевых возможностей процессора в Rust и включение LTO во всех крейтах. [#78590](https://github.com/ClickHouse/ClickHouse/pull/78590) ([Raúl Marín](https://github.com/Algunenano)).

### Релиз ClickHouse 25.3 LTS, 2025-03-20 {#253}

#### Обратно несовместимые изменения

- Запрещено усечение реплицируемых баз данных. [#76651](https://github.com/ClickHouse/ClickHouse/pull/76651) ([Bharat Nallan](https://github.com/bharatnc)).
- Отменён кэш индексов с пропуском данных. [#77447](https://github.com/ClickHouse/ClickHouse/pull/77447) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).


#### Новая функция

* Тип данных `JSON` готов к промышленной эксплуатации. См. [https://jsonbench.com/](https://jsonbench.com/). Типы данных `Dynamic` и `Variant` готовы к промышленной эксплуатации. [#77785](https://github.com/ClickHouse/ClickHouse/pull/77785) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен протокол SSH для clickhouse-server. Теперь к ClickHouse можно подключаться с помощью любого SSH‑клиента. Это закрывает: [#74340](https://github.com/ClickHouse/ClickHouse/issues/74340). [#74989](https://github.com/ClickHouse/ClickHouse/pull/74989) ([George Gamezardashvili](https://github.com/Infjoker)).
* Заменены табличные функции на их варианты с суффиксом -Cluster, если включены параллельные реплики. Исправлено [#65024](https://github.com/ClickHouse/ClickHouse/issues/65024). [#70659](https://github.com/ClickHouse/ClickHouse/pull/70659) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Новая реализация Userspace Page Cache, которая позволяет кэшировать данные в памяти процесса вместо использования кэша страниц ОС; это полезно, когда данные хранятся на удалённой виртуальной файловой системе без локального файлового кэша. [#70509](https://github.com/ClickHouse/ClickHouse/pull/70509) ([Michael Kolupaev](https://github.com/al13n321)).
* Добавлена серверная настройка `concurrent_threads_scheduler`, которая определяет, как распределяются CPU-слоты между конкурентными запросами. Может принимать значение `round_robin` (предыдущее поведение) или `fair_round_robin` для устранения проблемы несправедливого распределения CPU между INSERT и SELECT. [#75949](https://github.com/ClickHouse/ClickHouse/pull/75949) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена агрегатная функция `estimateCompressionRatio` [#70801](https://github.com/ClickHouse/ClickHouse/issues/70801). [#76661](https://github.com/ClickHouse/ClickHouse/pull/76661) ([Tariq Almawash](https://github.com/talmawash)).
* Добавлена функция `arraySymmetricDifference`. Она возвращает все элементы из нескольких аргументов-массивов, которые не присутствуют во всех аргументах одновременно. Пример: `SELECT arraySymmetricDifference([1, 2], [2, 3])` возвращает `[1, 3]`. (issue [#61673](https://github.com/ClickHouse/ClickHouse/issues/61673)). [#76231](https://github.com/ClickHouse/ClickHouse/pull/76231) ([Filipp Abapolov](https://github.com/pheepa)).
* Добавлена возможность явно указывать файл метаданных для чтения в Iceberg с помощью настройки функции хранилища/таблицы `iceberg_metadata_file_path`. Исправляет [#47412](https://github.com/ClickHouse/ClickHouse/issues/47412). [#77318](https://github.com/ClickHouse/ClickHouse/pull/77318) ([alesapin](https://github.com/alesapin)).
* Добавлена хеш-функция `keccak256`, широко используемая в блокчейн-реализациях, особенно в системах на базе EVM. [#76669](https://github.com/ClickHouse/ClickHouse/pull/76669) ([Arnaud Briche](https://github.com/arnaudbriche)).
* Добавлены три новые функции: `icebergTruncate` (в соответствии со спецификацией: [https://iceberg.apache.org/spec/#truncate-transform-details](https://iceberg.apache.org/spec/#truncate-transform-details)), `toYearNumSinceEpoch` и `toMonthNumSinceEpoch`. Добавлена поддержка преобразования `truncate` при отсечении партиций для движка `Iceberg`. [#77403](https://github.com/ClickHouse/ClickHouse/pull/77403) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка типов данных `LowCardinality(Decimal)` [#72256](https://github.com/ClickHouse/ClickHouse/issues/72256). [#72833](https://github.com/ClickHouse/ClickHouse/pull/72833) ([zhanglistar](https://github.com/zhanglistar)).
* События профилирования `FilterTransformPassedRows` и `FilterTransformPassedBytes` покажут количество строк и байт, отфильтрованных во время выполнения запроса. [#76662](https://github.com/ClickHouse/ClickHouse/pull/76662) ([Onkar Deshpande](https://github.com/onkar)).
* Поддержка типа метрик histogram. Интерфейс во многом повторяет клиент Prometheus: вы просто вызываете `observe(value)`, чтобы увеличить счётчик в корзине, соответствующей значению. Метрики histogram доступны в таблице `system.histogram_metrics`. [#75736](https://github.com/ClickHouse/ClickHouse/pull/75736) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Поддержка неконстантного `CASE` для переключения по конкретным значениям. [#77399](https://github.com/ClickHouse/ClickHouse/pull/77399) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).



#### Экспериментальная возможность
* Добавлена поддержка [Unity Catalog](https://www.databricks.com/product/unity-catalog) для таблиц DeltaLake поверх AWS S3 и локальной файловой системы. [#76988](https://github.com/ClickHouse/ClickHouse/pull/76988) ([alesapin](https://github.com/alesapin)).
* Добавлена экспериментальная интеграция с каталогом сервисов AWS Glue для таблиц Iceberg. [#77257](https://github.com/ClickHouse/ClickHouse/pull/77257) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка динамического автообнаружения кластеров. Это расширяет существующую функциональность автообнаружения _узлов_. ClickHouse теперь может автоматически обнаруживать и регистрировать новые _кластеры_ под общим путем в ZooKeeper с использованием `<multicluster_root_path>`. [#76001](https://github.com/ClickHouse/ClickHouse/pull/76001) ([Anton Ivashkin](https://github.com/ianton-ru)).
* Добавлена возможность автоматической очистки (cleanup) целых партиций слияниями по истечении настраиваемого тайм-аута с помощью нового параметра `enable_replacing_merge_with_cleanup_for_min_age_to_force_merge`. [#76440](https://github.com/ClickHouse/ClickHouse/pull/76440) ([Christoph Wurm](https://github.com/cwurm)).



#### Улучшение производительности
* Реализовано кэширование условий запроса для повышения производительности запросов с повторяющимися условиями. Диапазон части данных, которые не удовлетворяют условию, запоминается как временный индекс в памяти. Последующие запросы будут использовать этот индекс. Закрыты [#67768](https://github.com/ClickHouse/ClickHouse/issues/67768) [#69236](https://github.com/ClickHouse/ClickHouse/pull/69236) ([zhongyuankai](https://github.com/zhongyuankai)).
* Активное вытеснение данных из кэша при удалении партиций. Не даем кэшу расти до максимального размера, если объем данных меньше. [#76641](https://github.com/ClickHouse/ClickHouse/pull/76641) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Заменены Int256 и UInt256 на встроенный в clang i256 в арифметических вычислениях, что дало прирост производительности [#70502](https://github.com/ClickHouse/ClickHouse/issues/70502). [#73658](https://github.com/ClickHouse/ClickHouse/pull/73658) ([李扬](https://github.com/taiyang-li)).
* В некоторых случаях (например, пустой столбец-массив) партиции данных могут содержать пустые файлы. Мы можем пропускать запись пустых блобов в ObjectStorage и сохранять только метаданные для таких файлов, когда таблица размещается на диске с раздельными хранилищами метаданных и объектов. [#75860](https://github.com/ClickHouse/ClickHouse/pull/75860) ([Alexander Gololobov](https://github.com/davenger)).
* Улучшена производительность вычисления min/max для Decimal32/Decimal64/DateTime64. [#76570](https://github.com/ClickHouse/ClickHouse/pull/76570) ([李扬](https://github.com/taiyang-li)).
* Компиляция запросов (настройка `compile_expressions`) теперь учитывает тип машины. Это значительно ускоряет такие запросы. [#76753](https://github.com/ClickHouse/ClickHouse/pull/76753) ([ZhangLiStar](https://github.com/zhanglistar)).
* Оптимизирован `arraySort`. [#76850](https://github.com/ClickHouse/ClickHouse/pull/76850) ([李扬](https://github.com/taiyang-li)).
* Отключено `filesystem_cache_prefer_bigger_buffer_size`, когда кэш используется пассивно, например при слияниях. [#77898](https://github.com/ClickHouse/ClickHouse/pull/77898) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Применен атрибут `preserve_most` в некоторых местах кода, что позволяет немного улучшить генерацию кода. [#67778](https://github.com/ClickHouse/ClickHouse/pull/67778) ([Nikita Taranov](https://github.com/nickitat)).
* Ускорено завершение работы серверов ClickHouse (устранена задержка 2,5 секунды). [#76550](https://github.com/ClickHouse/ClickHouse/pull/76550) ([Azat Khuzhin](https://github.com/azat)).
* Исключены лишние выделения памяти в ReadBufferFromS3 и других буферах удаленного чтения, их потребление памяти уменьшено вдвое. [#76692](https://github.com/ClickHouse/ClickHouse/pull/76692) ([Sema Checherinda](https://github.com/CheSema)).
* Обновлен zstd с 1.5.5 до 1.5.7, что может привести к [улучшению производительности](https://github.com/facebook/zstd/releases/tag/v1.5.7). [#77137](https://github.com/ClickHouse/ClickHouse/pull/77137) ([Pradeep Chhetri](https://github.com/chhetripradeep)).
* Снижено потребление памяти при предварительном чтении JSON-столбца в Wide-партициях. Это актуально, когда ClickHouse используется поверх общего хранилища, например в ClickHouse Cloud. [#77640](https://github.com/ClickHouse/ClickHouse/pull/77640) ([Pavel Kruglov](https://github.com/Avogar)).



#### Улучшение

* Поддержка атомарного переименования при использовании `TRUNCATE` с `INTO OUTFILE`. Исправляет [#70323](https://github.com/ClickHouse/ClickHouse/issues/70323). [#77181](https://github.com/ClickHouse/ClickHouse/pull/77181) ([Onkar Deshpande](https://github.com/onkar)).
* Больше нельзя использовать `NaN` или `inf` в качестве значений типа float для настроек. Да и раньше в этом не было никакого смысла. [#77546](https://github.com/ClickHouse/ClickHouse/pull/77546) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Параллельные реплики по умолчанию отключаются, когда `analyzer` выключен, независимо от настройки `compatibility`. По‑прежнему можно изменить это поведение, явно установив `parallel_replicas_only_with_analyzer` в `false`. [#77115](https://github.com/ClickHouse/ClickHouse/pull/77115) ([Igor Nikonov](https://github.com/devcrafter)).
* Добавлена возможность задать список заголовков, которые будут передаваться из заголовков клиентского запроса во внешний HTTP-аутентификатор. [#77054](https://github.com/ClickHouse/ClickHouse/pull/77054) ([inv2004](https://github.com/inv2004)).
* Соблюдать регистронезависимое сопоставление столбцов для полей в столбцах типа `tuple`. Закрывает [https://github.com/apache/incubator-gluten/issues/8324](https://github.com/apache/incubator-gluten/issues/8324). [#73780](https://github.com/ClickHouse/ClickHouse/pull/73780) ([李扬](https://github.com/taiyang-li)).
* Параметры кодека Gorilla теперь всегда будут сохраняться в метаданных таблицы в файле .sql. Это закрывает проблему: [#70072](https://github.com/ClickHouse/ClickHouse/issues/70072). [#74814](https://github.com/ClickHouse/ClickHouse/pull/74814) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Реализованы улучшения парсинга для некоторых хранилищ данных (парсинг идентификаторов последовательностей: добавлена возможность разбора идентификаторов последовательностей в manifest-файлах и парсинг метаданных Avro: переработан парсер метаданных Avro, чтобы его было легко расширять в будущем). [#75010](https://github.com/ClickHouse/ClickHouse/pull/75010) ([Daniil Ivanik](https://github.com/divanik)).
* Из значения по умолчанию для ORDER BY в `system.opentelemetry_span_log` удалено поле `trace_id`. [#75907](https://github.com/ClickHouse/ClickHouse/pull/75907) ([Azat Khuzhin](https://github.com/azat)).
* Шифрование (атрибут `encrypted_by`) теперь может применяться к любому конфигурационному файлу (config.xml, users.xml, вложенные конфигурационные файлы). Ранее его можно было применять только к файлу верхнего уровня config.xml. [#75911](https://github.com/ClickHouse/ClickHouse/pull/75911) ([Mikhail Gorshkov](https://github.com/mgorshkov)).
* Улучшена таблица `system.warnings` и добавлены динамические предупреждения, которые можно добавлять, обновлять или удалять. [#76029](https://github.com/ClickHouse/ClickHouse/pull/76029) ([Bharat Nallan](https://github.com/bharatnc)).
* Этот PR делает невозможным выполнение запроса `ALTER USER user1 ADD PROFILES a, DROP ALL PROFILES`, поскольку все операции `DROP` должны идти первыми. [#76242](https://github.com/ClickHouse/ClickHouse/pull/76242) ([pufit](https://github.com/pufit)).
* Различные улучшения для `SYNC REPLICA` (более информативные сообщения об ошибках, улучшенные тесты, проверки корректности). [#76307](https://github.com/ClickHouse/ClickHouse/pull/76307) ([Azat Khuzhin](https://github.com/azat)).
* Используется корректный резервный сценарий при сбое многочастичного копирования в S3 с ошибкой Access Denied во время создания бэкапа. Многочастичное копирование может приводить к ошибке Access Denied, если бэкап выполняется между бакетами с разными учетными данными. [#76515](https://github.com/ClickHouse/ClickHouse/pull/76515) ([Antonio Andelic](https://github.com/antonio2368)).
* Обновлена librdkafka (которая представляет собой кучу хлама) до версии 2.8.0 (куча от этого лучше не становится), а также улучшена последовательность завершения работы для таблиц Kafka, что сократило задержки при удалении таблиц и перезапусках сервера. `engine=Kafka` больше не выходит явно из consumer group при удалении таблицы. Вместо этого consumer остается в группе до тех пор, пока не будет автоматически удалён после периода бездействия `session_timeout_ms` (по умолчанию: 45 секунд). [#76621](https://github.com/ClickHouse/ClickHouse/pull/76621) ([filimonov](https://github.com/filimonov)).
* Исправлена проверка настроек запросов в S3. [#76658](https://github.com/ClickHouse/ClickHouse/pull/76658) ([Vitaly Baranov](https://github.com/vitlibar)).
* В системных таблицах, таких как `server_settings` или `settings`, есть удобный столбец `default`. Добавьте его в `merge_tree_settings` и `replicated_merge_tree_settings`. [#76942](https://github.com/ClickHouse/ClickHouse/pull/76942) ([Diego Nieto](https://github.com/lesandie)).
* Добавлен `ProfileEvents::QueryPreempted` с логикой, аналогичной `CurrentMetrics::QueryPreempted`. [#77015](https://github.com/ClickHouse/ClickHouse/pull/77015) ([VicoWu](https://github.com/VicoWu)).
* Ранее база данных `Replicated` могла записывать в логи учетные данные, указанные в запросе. Это поведение исправлено. Закрывает: [#77123](https://github.com/ClickHouse/ClickHouse/issues/77123). [#77133](https://github.com/ClickHouse/ClickHouse/pull/77133) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Разрешена команда `ALTER TABLE DROP PARTITION` для `plain_rewritable disk`. [#77138](https://github.com/ClickHouse/ClickHouse/pull/77138) ([Julia Kartseva](https://github.com/jkartseva)).
* Настройка резервного копирования и восстановления `allow_s3_native_copy` теперь поддерживает три возможных значения: - `False` — s3 native copy не будет использоваться; - `True` (старое значение по умолчанию) — ClickHouse сначала попытается использовать s3 native copy, а в случае неудачи перейдёт к подходу «чтение+запись»; - `'auto'` (новое значение по умолчанию) — ClickHouse сначала сравнит учётные данные источника и назначения. Если они совпадают, ClickHouse попытается использовать s3 native copy, а при необходимости может затем перейти к подходу «чтение+запись». Если они различаются, ClickHouse сразу будет использовать подход «чтение+запись». [#77401](https://github.com/ClickHouse/ClickHouse/pull/77401) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена поддержка `AWS session token` и использования учетных данных из окружения в `delta kernel` для движка таблиц `DeltaLake`. [#77661](https://github.com/ClickHouse/ClickHouse/pull/77661) ([Kseniia Sumarokova](https://github.com/kssenii)).





#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе)

* Исправлено зависание при обработке ожидающей пачки для асинхронного распределённого INSERT (из-за, например, ошибки `No such file or directory`). [#72939](https://github.com/ClickHouse/ClickHouse/pull/72939) ([Azat Khuzhin](https://github.com/azat)).
* Улучшена конвертация datetime при анализе индексов за счёт принудительного насыщенного поведения для неявных преобразований из Date в DateTime. Это устраняет возможные неточности анализа индексов, вызванные ограничениями диапазона datetime. Исправляет [#73307](https://github.com/ClickHouse/ClickHouse/issues/73307). Также исправлено явное преобразование `toDateTime`, когда `date_time_overflow_behavior = 'ignore'`, что является значением по умолчанию. [#73326](https://github.com/ClickHouse/ClickHouse/pull/73326) ([Amos Bird](https://github.com/amosbird)).
* Исправлены различные ошибки, вызванные гонкой между UUID и именами таблиц (например, это устраняет гонку между `RENAME` и `RESTART REPLICA`: при одновременном выполнении `RENAME` и `SYSTEM RESTART REPLICA` можно было перезапустить неверную реплику и/или оставить одну из таблиц в состоянии `Table X is being restarted`). [#76308](https://github.com/ClickHouse/ClickHouse/pull/76308) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена потеря данных при включённом async insert и выполнении insert into ... from file ... с блоками разного размера: если размер первого блока &lt; async&#95;max&#95;size, а второго блока &gt; async&#95;max&#95;size, второй блок не вставлялся. Эти данные оставались в `squashing`. [#76343](https://github.com/ClickHouse/ClickHouse/pull/76343) ([Han Fei](https://github.com/hanfei1991)).
* Поле &#39;marks&#39; было переименовано в &#39;marks&#95;bytes&#39; в `system.data_skipping_indices`. [#76374](https://github.com/ClickHouse/ClickHouse/pull/76374) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена обработка динамического изменения размера кэша файловой системы при неожиданных ошибках во время вытеснения. [#76466](https://github.com/ClickHouse/ClickHouse/pull/76466) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена инициализация `used_flag` в параллельном хеше. Это могло приводить к аварийному завершению работы сервера. [#76580](https://github.com/ClickHouse/ClickHouse/pull/76580) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена логическая ошибка при вызове функции `defaultProfiles` внутри проекции. [#76627](https://github.com/ClickHouse/ClickHouse/pull/76627) ([pufit](https://github.com/pufit)).
* Не запрашивать интерактивную базовую аутентификацию в браузере в веб-интерфейсе. Закрывает [#76319](https://github.com/ClickHouse/ClickHouse/issues/76319). [#76637](https://github.com/ClickHouse/ClickHouse/pull/76637) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено исключение THERE&#95;IS&#95;NO&#95;COLUMN при выборе логического литерала из распределённых таблиц. [#76656](https://github.com/ClickHouse/ClickHouse/pull/76656) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Подкаталог внутри директории таблицы теперь выбирается по более продуманному принципу. [#76681](https://github.com/ClickHouse/ClickHouse/pull/76681) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлена ошибка `Not found column in block`, возникавшая после изменения таблицы с подстолбцом в первичном ключе. После [https://github.com/ClickHouse/ClickHouse/pull/72644](https://github.com/ClickHouse/ClickHouse/pull/72644) требуется [https://github.com/ClickHouse/ClickHouse/pull/74403](https://github.com/ClickHouse/ClickHouse/pull/74403). [#76686](https://github.com/ClickHouse/ClickHouse/pull/76686) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлены тесты производительности для null short-circuit и исправлены ошибки. [#76708](https://github.com/ClickHouse/ClickHouse/pull/76708) ([李扬](https://github.com/taiyang-li)).
* Сбрасывать выходные буферы записи перед их финализацией. Исправлена ошибка `LOGICAL_ERROR`, возникавшая при финализации некоторых форматов вывода, например `JSONEachRowWithProgressRowOutputFormat`. [#76726](https://github.com/ClickHouse/ClickHouse/pull/76726) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена поддержка бинарного UUID MongoDB ([#74452](https://github.com/ClickHouse/ClickHouse/issues/74452)) - Исправлен проталкиваемый в MongoDB предикат `WHERE` при использовании табличной функции ([#72210](https://github.com/ClickHouse/ClickHouse/issues/72210)) - Изменено сопоставление типов MongoDB – ClickHouse таким образом, что бинарный UUID MongoDB теперь может быть разобран только в UUID ClickHouse. Это должно избежать неоднозначностей и неожиданных ситуаций в будущем. - Исправлено сопоставление OID с сохранением обратной совместимости. [#76762](https://github.com/ClickHouse/ClickHouse/pull/76762) ([Kirill Nikiforov](https://github.com/allmazz)).
* Исправлена обработка исключений при параллельной десериализации префиксов JSON-подстолбцов. [#76809](https://github.com/ClickHouse/ClickHouse/pull/76809) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено поведение функции lgamma для отрицательных целых чисел. [#76840](https://github.com/ClickHouse/ClickHouse/pull/76840) ([Ilya Kataev](https://github.com/IlyaKataev)).
* Исправлен анализ реверсивного ключа для явно заданных первичных ключей. Аналогично [#76654](https://github.com/ClickHouse/ClickHouse/issues/76654). [#76846](https://github.com/ClickHouse/ClickHouse/pull/76846) ([Amos Bird](https://github.com/amosbird)).
* Исправлен красивый вывод значений Bool в формате JSON. [#76905](https://github.com/ClickHouse/ClickHouse/pull/76905) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена возможная аварийная остановка из‑за некорректного отката столбца JSON при ошибке во время асинхронных вставок. [#76908](https://github.com/ClickHouse/ClickHouse/pull/76908) ([Pavel Kruglov](https://github.com/Avogar)).
* Ранее `multiIf` мог возвращать разные типы столбцов на этапе планирования и во время основного выполнения. Это приводило к тому, что с точки зрения C++ код демонстрировал неопределённое поведение. [#76914](https://github.com/ClickHouse/ClickHouse/pull/76914) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена некорректная сериализация константных nullable-ключей в MergeTree. Это исправляет [#76939](https://github.com/ClickHouse/ClickHouse/issues/76939). [#76985](https://github.com/ClickHouse/ClickHouse/pull/76985) ([Amos Bird](https://github.com/amosbird)).
* Исправлена сортировка значений `BFloat16`. Исправление закрывает [#75487](https://github.com/ClickHouse/ClickHouse/issues/75487) и [#75669](https://github.com/ClickHouse/ClickHouse/issues/75669). [#77000](https://github.com/ClickHouse/ClickHouse/pull/77000) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка в JSON с подстолбцом `Variant` за счёт добавления проверки, пропускающей эфемерные подстолбцы при проверке целостности парта. [#72187](https://github.com/ClickHouse/ClickHouse/issues/72187). [#77034](https://github.com/ClickHouse/ClickHouse/pull/77034) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Исправлено падение при разборе шаблона в формате Values в случае несовпадения типов. [#77071](https://github.com/ClickHouse/ClickHouse/pull/77071) ([Pavel Kruglov](https://github.com/Avogar)).
* Запрещено создание таблицы EmbeddedRocksDB с подкoлонкой в первичном ключе. Ранее такую таблицу можно было создать, но запросы SELECT завершались с ошибкой. [#77074](https://github.com/ClickHouse/ClickHouse/pull/77074) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено некорректное сравнение в распределённых запросах, вызванное тем, что при проталкивании предикатов на удалённые серверы не учитываются типы литералов. [#77093](https://github.com/ClickHouse/ClickHouse/pull/77093) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлено падение при создании таблицы Kafka при возникновении исключения. [#77121](https://github.com/ClickHouse/ClickHouse/pull/77121) ([Pavel Kruglov](https://github.com/Avogar)).
* Поддержка JSON и подстолбцов в движках Kafka и RabbitMQ. [#77122](https://github.com/ClickHouse/ClickHouse/pull/77122) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено раскручивание стека исключений на macOS. [#77126](https://github.com/ClickHouse/ClickHouse/pull/77126) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлена обработка чтения подколонки &#39;null&#39; в функции getSubcolumn. [#77163](https://github.com/ClickHouse/ClickHouse/pull/77163) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен индекс bloom filter с типом `Array` и неподдерживаемыми функциями. [#77271](https://github.com/ClickHouse/ClickHouse/pull/77271) ([Pavel Kruglov](https://github.com/Avogar)).
* Ограничение на количество таблиц следует проверять только при исходном запросе CREATE. [#77274](https://github.com/ClickHouse/ClickHouse/pull/77274) ([Nikolay Degterinsky](https://github.com/evillique)).
* Не баг: `SELECT toBFloat16(-0.0) == toBFloat16(0.0)` теперь корректно возвращает `true` (ранее возвращал `false`). Это делает поведение согласованным с `Float32` и `Float64`. [#77290](https://github.com/ClickHouse/ClickHouse/pull/77290) ([Shankar Iyer](https://github.com/shankar-iyer)).
* Исправлена возможная некорректная ссылка на неинициализированную переменную key&#95;index, которая может приводить к сбою в отладочных сборках (эта неинициализированная ссылка не вызывает проблем в релизных сборках, потому что последующий код, скорее всего, выбросит ошибку). ### запись в документации для изменений, видимых пользователям. [#77305](https://github.com/ClickHouse/ClickHouse/pull/77305) ([wxybear](https://github.com/wxybear)).
* Исправлено имя партиции со значением типа Bool. Оно было сломано в [https://github.com/ClickHouse/ClickHouse/pull/74533](https://github.com/ClickHouse/ClickHouse/pull/74533). [#77319](https://github.com/ClickHouse/ClickHouse/pull/77319) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено сравнение между кортежами с nullable-элементами и строками. Например, до изменения сравнение между кортежем `(1, null)` и строкой `'(1,null)'` приводило к ошибке. Другой пример — сравнение между кортежем `(1, a)`, где `a` — столбец типа Nullable, и строкой `'(1, 2)'`. Это изменение устраняет эти проблемы. [#77323](https://github.com/ClickHouse/ClickHouse/pull/77323) ([Alexey Katsman](https://github.com/alexkats)).
* Исправлена ошибка, приводившая к сбою в ObjectStorageQueueSource. Была внесена в [https://github.com/ClickHouse/ClickHouse/pull/76358](https://github.com/ClickHouse/ClickHouse/pull/76358). [#77325](https://github.com/ClickHouse/ClickHouse/pull/77325) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена работа `async_insert` с `input`. [#77340](https://github.com/ClickHouse/ClickHouse/pull/77340) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено: `WITH FILL` мог завершаться ошибкой NOT&#95;FOUND&#95;COLUMN&#95;IN&#95;BLOCK, когда сортируемый столбец удалялся планировщиком. Аналогичная проблема была связана с неконсистентным DAG, вычисляемым для выражения INTERPOLATE. [#77343](https://github.com/ClickHouse/ClickHouse/pull/77343) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлено несколько `LOGICAL_ERROR` при установке псевдонимов для некорректных узлов AST. [#77445](https://github.com/ClickHouse/ClickHouse/pull/77445) ([Raúl Marín](https://github.com/Algunenano)).
* В реализации кеша файловой системы исправлена обработка ошибок при записи сегмента файла. [#77471](https://github.com/ClickHouse/ClickHouse/pull/77471) ([Kseniia Sumarokova](https://github.com/kssenii)).
* DatabaseIceberg теперь использует корректный файл метаданных, предоставленный каталогом. Закрывает [#75187](https://github.com/ClickHouse/ClickHouse/issues/75187). [#77486](https://github.com/ClickHouse/ClickHouse/pull/77486) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Кэш запросов теперь исходит из того, что UDF являются недетерминированными. Соответственно, результаты запросов с UDF больше не кэшируются. Ранее пользователи могли определять недетерминированные UDF, результаты которых ошибочно кэшировались (issue [#77553](https://github.com/ClickHouse/ClickHouse/issues/77553)). [#77633](https://github.com/ClickHouse/ClickHouse/pull/77633) ([Jimmy Aguilar Mena](https://github.com/Ergus)).
* Исправлена работа `system.filesystem_cache_log`, который функционировал только при включённой настройке `enable_filesystem_cache_log`. [#77650](https://github.com/ClickHouse/ClickHouse/pull/77650) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена логическая ошибка при вызове функции `defaultRoles` внутри проекции. Продолжение [#76627](https://github.com/ClickHouse/ClickHouse/issues/76627). [#77667](https://github.com/ClickHouse/ClickHouse/pull/77667) ([pufit](https://github.com/pufit)).
* Вторые аргументы типа `Nullable` для функции `arrayResize` теперь не допускаются. Ранее при использовании `Nullable` в качестве второго аргумента могло происходить всё: от ошибок до некорректных результатов. (issue [#48398](https://github.com/ClickHouse/ClickHouse/issues/48398)). [#77724](https://github.com/ClickHouse/ClickHouse/pull/77724) ([Manish Gill](https://github.com/mgill25)).
* Регулярно проверять, были ли объединения и мутации отменены, даже в случаях, когда операция не создает блоков для записи. [#77766](https://github.com/ClickHouse/ClickHouse/pull/77766) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).

#### Улучшения сборки/тестирования/упаковки

- `clickhouse-odbc-bridge` и `clickhouse-library-bridge` перенесены в отдельный репозиторий https://github.com/ClickHouse/odbc-bridge/. [#76225](https://github.com/ClickHouse/ClickHouse/pull/76225) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Исправлена кросс-компиляция Rust и добавлена возможность полного отключения Rust. [#76921](https://github.com/ClickHouse/ClickHouse/pull/76921) ([Raúl Marín](https://github.com/Algunenano)).

### Релиз ClickHouse 25.2, 2025-02-27 {#252}

#### Обратно несовместимые изменения

- Настройка `async_load_databases` полностью включена по умолчанию (даже для установок, в которых не обновлялся `config.xml`). [#74772](https://github.com/ClickHouse/ClickHouse/pull/74772) ([Azat Khuzhin](https://github.com/azat)).
- Добавлены форматы `JSONCompactEachRowWithProgress` и `JSONCompactStringsEachRowWithProgress`. Продолжение [#69989](https://github.com/ClickHouse/ClickHouse/issues/69989). Форматы `JSONCompactWithNames` и `JSONCompactWithNamesAndTypes` больше не выводят «totals» — по-видимому, это была ошибка в реализации. [#75037](https://github.com/ClickHouse/ClickHouse/pull/75037) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Значение по умолчанию для настройки `format_alter_operations_with_parentheses` изменено на true для устранения неоднозначности в списке команд ALTER (см. https://github.com/ClickHouse/ClickHouse/pull/59532). Это нарушает репликацию с кластерами версий до 24.3. Если вы обновляете кластер, использующий более старые релизы, отключите эту настройку в конфигурации сервера или сначала обновитесь до версии 24.3. [#75302](https://github.com/ClickHouse/ClickHouse/pull/75302) ([Raúl Marín](https://github.com/Algunenano)).
- Удалена возможность фильтрации сообщений журнала с помощью регулярных выражений. Реализация приводила к состоянию гонки данных, поэтому её пришлось удалить. [#75577](https://github.com/ClickHouse/ClickHouse/pull/75577) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Настройка `min_chunk_bytes_for_parallel_parsing` больше не может иметь нулевое значение. Это исправляет: [#71110](https://github.com/ClickHouse/ClickHouse/issues/71110). [#75239](https://github.com/ClickHouse/ClickHouse/pull/75239) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Добавлена валидация настроек в конфигурации кеша. Несуществующие настройки ранее игнорировались, теперь они будут вызывать ошибку и должны быть удалены. [#75452](https://github.com/ClickHouse/ClickHouse/pull/75452) ([Kseniia Sumarokova](https://github.com/kssenii)).


#### Новая функциональность
* Поддержка типа `Nullable(JSON)`. [#73556](https://github.com/ClickHouse/ClickHouse/pull/73556) ([Pavel Kruglov](https://github.com/Avogar)).
* Поддержка подколнок в выражениях DEFAULT и MATERIALIZED. [#74403](https://github.com/ClickHouse/ClickHouse/pull/74403) ([Pavel Kruglov](https://github.com/Avogar)).
* Поддержка записи bloom-фильтров Parquet с помощью настройки `output_format_parquet_write_bloom_filter` (включена по умолчанию). [#71681](https://github.com/ClickHouse/ClickHouse/pull/71681) ([Michael Kolupaev](https://github.com/al13n321)).
* В Web UI появилась интерактивная навигация по базам данных. [#75777](https://github.com/ClickHouse/ClickHouse/pull/75777) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Разрешено комбинировать диски только для чтения и диски для чтения-записи в политике хранения (как несколько томов или несколько дисков). Это позволяет читать данные со всего тома, в то время как вставки будут выполняться на предпочтительный диск с возможностью записи (то есть политика хранения Copy-on-Write). [#75862](https://github.com/ClickHouse/ClickHouse/pull/75862) ([Azat Khuzhin](https://github.com/azat)).
* Добавлен новый движок базы данных `DatabaseBackup`, который позволяет мгновенно подключать таблицу/базу данных из бэкапа. [#75725](https://github.com/ClickHouse/ClickHouse/pull/75725) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена поддержка подготовленных запросов (prepared statements) в протоколе Postgres wire. [#75035](https://github.com/ClickHouse/ClickHouse/pull/75035) ([scanhex12](https://github.com/scanhex12)).
* Добавлена возможность выполнять ATTACH таблиц без уровня базы данных, что полезно для таблиц MergeTree, размещённых в Web, S3 и подобных внешних виртуальных файловых системах. [#75788](https://github.com/ClickHouse/ClickHouse/pull/75788) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена новая функция сравнения строк `compareSubstrings` для сравнения частей двух строк. Пример: `SELECT compareSubstrings('Saxony', 'Anglo-Saxon', 0, 6, 5) AS result` означает «лексикографически сравнить 6 байт строк 'Saxon' и 'Anglo-Saxon', начиная со смещения 0 в первой строке и 5 во второй строке». [#74070](https://github.com/ClickHouse/ClickHouse/pull/74070) ([lgbo](https://github.com/lgbo-ustc)).
* Добавлена новая функция `initialQueryStartTime`. Она возвращает время начала текущего запроса. Значение совпадает на всех шардах при распределённом запросе. [#75087](https://github.com/ClickHouse/ClickHouse/pull/75087) ([Roman Lomonosov](https://github.com/lomik)).
* Добавлена поддержка SSL-аутентификации с именованными коллекциями для MySQL. Закрывает [#59111](https://github.com/ClickHouse/ClickHouse/issues/59111). [#59452](https://github.com/ClickHouse/ClickHouse/pull/59452) ([Nikolay Degterinsky](https://github.com/evillique)).

#### Экспериментальные возможности
* Добавлена новая настройка `enable_adaptive_memory_spill_scheduler`, которая позволяет нескольким Grace JOIN в одном запросе отслеживать их суммарное потребление памяти и адаптивно инициировать выгрузку во внешнее хранилище, чтобы предотвратить MEMORY_LIMIT_EXCEEDED. [#72728](https://github.com/ClickHouse/ClickHouse/pull/72728) ([lgbo](https://github.com/lgbo-ustc)).
* Новый экспериментальный движок таблиц `Kafka` теперь полностью учитывает feature flags Keeper. [#76004](https://github.com/ClickHouse/ClickHouse/pull/76004) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Восстановлен кодек (Intel) QPL, который был удалён в v24.10 из-за лицензионных ограничений. [#76021](https://github.com/ClickHouse/ClickHouse/pull/76021) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Для интеграции с HDFS добавлена поддержка конфигурационной опции `dfs.client.use.datanode.hostname`. [#74635](https://github.com/ClickHouse/ClickHouse/pull/74635) ([Mikhail Tiukavkin](https://github.com/freshertm)).



#### Повышение производительности
* Улучшена производительность чтения всего JSON-столбца в Wide-частях из S3. Это сделано за счёт добавления предварительной выборки при десериализации префиксов подстолбцов, кэша десериализованных префиксов и параллельной десериализации префиксов подстолбцов. Это ускоряет чтение JSON-столбца из S3 в 4 раза в запросах вида `SELECT data FROM table` и примерно в 10 раз в запросах вида `SELECT data FROM table LIMIT 10`. [#74827](https://github.com/ClickHouse/ClickHouse/pull/74827) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена избыточная конкуренция потоков в `parallel_hash`, когда `max_rows_in_join = max_bytes_in_join = 0`. [#75155](https://github.com/ClickHouse/ClickHouse/pull/75155) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлено двойное предварительное выделение памяти в `ConcurrentHashJoin` в случае, когда стороны `JOIN` меняются местами оптимизатором. [#75149](https://github.com/ClickHouse/ClickHouse/pull/75149) ([Nikita Taranov](https://github.com/nickitat)).
* Незначительное улучшение в некоторых сценариях `JOIN`: предварительный расчёт количества выходных строк и резервирование под них памяти. [#75376](https://github.com/ClickHouse/ClickHouse/pull/75376) ([Alexander Gololobov](https://github.com/davenger)).
* Для запросов вида `WHERE a < b AND b < c AND c < 5` можно выводить новые условия сравнения (`a < 5 AND b < 5`) для улучшения эффективности фильтрации. [#73164](https://github.com/ClickHouse/ClickHouse/pull/73164) ([Shichao Jin](https://github.com/jsc0218)).
* Улучшение в Keeper: отключено вычисление дайджеста при фиксации в in-memory-хранилище для повышения производительности. Его можно включить с помощью настройки `keeper_server.digest_enabled_on_commit`. Дайджест по-прежнему вычисляется при предварительной обработке запросов. [#75490](https://github.com/ClickHouse/ClickHouse/pull/75490) ([Antonio Andelic](https://github.com/antonio2368)).
* По возможности выполняется проталкивание выражения фильтра из `JOIN ON`. [#75536](https://github.com/ClickHouse/ClickHouse/pull/75536) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Отложенный (ленивый) расчёт размеров столбцов и индексов в MergeTree. [#75938](https://github.com/ClickHouse/ClickHouse/pull/75938) ([Pavel Kruglov](https://github.com/Avogar)).
* Снова учитывается `ttl_only_drop_parts` при `MATERIALIZE TTL`; читаются только необходимые столбцы для перерасчёта TTL, а части удаляются путём их замены на пустые. [#72751](https://github.com/ClickHouse/ClickHouse/pull/72751) ([Andrey Zvonov](https://github.com/zvonand)).
* Уменьшен размер буфера записи для файлов метаданных `plain_rewritable`. [#75758](https://github.com/ClickHouse/ClickHouse/pull/75758) ([Julia Kartseva](https://github.com/jkartseva)).
* Снижено потребление памяти некоторыми оконными функциями. [#65647](https://github.com/ClickHouse/ClickHouse/pull/65647) ([lgbo](https://github.com/lgbo-ustc)).
* Совместная оценка parquet bloom-фильтров и min/max-индексов. Необходимо для корректной поддержки выражений вида: `x = 3 or x > 5`, где данные = [1, 2, 4, 5]. [#71383](https://github.com/ClickHouse/ClickHouse/pull/71383) ([Arthur Passos](https://github.com/arthurpassos)).
* Запросы, передаваемые в хранилище `Executable`, больше не ограничены однопоточным выполнением. [#70084](https://github.com/ClickHouse/ClickHouse/pull/70084) ([yawnt](https://github.com/yawnt)).
* Параллельная загрузка частей в `ALTER TABLE FETCH PARTITION` (размер пула потоков управляется параметром `max_fetch_partition_thread_pool_size`). [#74978](https://github.com/ClickHouse/ClickHouse/pull/74978) ([Azat Khuzhin](https://github.com/azat)).
* Разрешено переносить предикаты с функцией `indexHint` в `PREWHERE`. [#74987](https://github.com/ClickHouse/ClickHouse/pull/74987) ([Anton Popov](https://github.com/CurtizJ)).



#### Улучшение

* Исправлен расчет занимаемого в памяти размера для столбцов `LowCardinality`. [#74688](https://github.com/ClickHouse/ClickHouse/pull/74688) ([Nikita Taranov](https://github.com/nickitat)).
* Для таблицы `processors_profile_log` теперь по умолчанию задан TTL 30 дней. [#66139](https://github.com/ClickHouse/ClickHouse/pull/66139) ([Ilya Yatsishin](https://github.com/qoega)).
* Добавлена возможность задавать имена шардов в конфигурации кластера. [#72276](https://github.com/ClickHouse/ClickHouse/pull/72276) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Изменён код успешного ответа для Prometheus remote write с 200/OK на 204/NoContent. [#74170](https://github.com/ClickHouse/ClickHouse/pull/74170) ([Michael Dempsey](https://github.com/bluestealth)).
* Добавлена возможность динамически изменять `max_remote_read_network_bandwidth_for_serve` и `max_remote_write_network_bandwidth_for_server` без перезапуска сервера. [#74206](https://github.com/ClickHouse/ClickHouse/pull/74206) ([Kai Zhu](https://github.com/nauu)).
* Разрешено использовать blob-пути для вычисления контрольных сумм при создании резервной копии. [#74729](https://github.com/ClickHouse/ClickHouse/pull/74729) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлен столбец идентификатора запроса в `system.query_cache` (issue [#68205](https://github.com/ClickHouse/ClickHouse/issues/68205) закрыт). [#74982](https://github.com/ClickHouse/ClickHouse/pull/74982) ([NamHoaiNguyen](https://github.com/NamHoaiNguyen)).
* Теперь можно отменять запросы `ALTER TABLE ... FREEZE ...` с помощью `KILL QUERY`, а также автоматически по тайм-ауту (`max_execution_time`). [#75016](https://github.com/ClickHouse/ClickHouse/pull/75016) ([Kirill](https://github.com/kirillgarbar)).
* Добавлена поддержка `groupUniqArrayArrayMap` в `SimpleAggregateFunction`. [#75034](https://github.com/ClickHouse/ClickHouse/pull/75034) ([Miel Donkers](https://github.com/mdonkers)).
* Скрыли настройки учетных данных каталога в движке базы данных `Iceberg`. Закрывает [#74559](https://github.com/ClickHouse/ClickHouse/issues/74559). [#75080](https://github.com/ClickHouse/ClickHouse/pull/75080) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `intExp2` / `intExp10`: Определено поведение для ранее неопределённых случаев: возвращать 0 для слишком маленького аргумента, `18446744073709551615` для слишком большого аргумента, выбрасывать исключение, если `nan`. [#75312](https://github.com/ClickHouse/ClickHouse/pull/75312) ([Vitaly Baranov](https://github.com/vitlibar)).
* Поддержка `s3.endpoint` из конфигурации каталога непосредственно в `DatabaseIceberg`. Закрывает [#74558](https://github.com/ClickHouse/ClickHouse/issues/74558). [#75375](https://github.com/ClickHouse/ClickHouse/pull/75375) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Не завершать операцию без сообщения об ошибке, если у пользователя, выполняющего `SYSTEM DROP REPLICA`, недостаточно прав. [#75377](https://github.com/ClickHouse/ClickHouse/pull/75377) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлен `ProfileEvent`, отражающий количество неудачных попыток сброса данных на диск для любых системных логов. [#75466](https://github.com/ClickHouse/ClickHouse/pull/75466) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена проверка и дополнительное логирование при расшифровке и распаковке. [#75471](https://github.com/ClickHouse/ClickHouse/pull/75471) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена поддержка символа микро (U+00B5) в функции `parseTimeDelta`. Теперь и символ микро (U+00B5), и греческая буква мю (U+03BC) распознаются как корректные обозначения микросекунд, что согласует поведение ClickHouse с реализацией Go ([см. time.go](https://github.com/golang/go/blob/ad7b46ee4ac1cee5095d64b01e8cf7fcda8bee5e/src/time/time.go#L983C19-L983C20) и [time/format.go](https://github.com/golang/go/blob/ad7b46ee4ac1cee5095d64b01e8cf7fcda8bee5e/src/time/format.go#L1608-L1609)). [#75472](https://github.com/ClickHouse/ClickHouse/pull/75472) ([Vitaly Orlov](https://github.com/orloffv)).
* Серверная настройка (`send_settings_to_client`) заменена на клиентскую (`apply_settings_from_server`), которая управляет тем, должен ли клиентский код (например, разбор данных `INSERT` и форматирование вывода запроса) использовать настройки из `users.xml` сервера и профиля пользователя. В противном случае используются только настройки, переданные через командную строку клиента, сеанс и сам запрос. Обратите внимание, что это относится только к нативному клиенту (а не, например, к HTTP) и не применяется к большей части обработки запроса (которая выполняется на сервере). [#75478](https://github.com/ClickHouse/ClickHouse/pull/75478) ([Michael Kolupaev](https://github.com/al13n321)).
* Улучшены сообщения при синтаксических ошибках. Ранее, если запрос был слишком большим и токен, длина которого превышала лимит, представлял собой очень длинный строковый литерал, сообщение о причине терялось между двумя примерами этого очень длинного токена. Исправлена проблема, из-за которой запрос в UTF‑8 некорректно обрезался в сообщении об ошибке. Исправлено избыточное заключение фрагментов запроса в кавычки. Закрывает [#75473](https://github.com/ClickHouse/ClickHouse/issues/75473). [#75561](https://github.com/ClickHouse/ClickHouse/pull/75561) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлены события профилирования в хранилище `S3(Azure)Queue`. [#75618](https://github.com/ClickHouse/ClickHouse/pull/75618) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отключена отправка настроек с сервера на клиент (`send_settings_to_client=false`) для обеспечения совместимости (позднее эта функция будет реализована заново как клиентская настройка для повышения удобства использования). [#75648](https://github.com/ClickHouse/ClickHouse/pull/75648) ([Michael Kolupaev](https://github.com/al13n321)).
* Добавлена настройка `memory_worker_correct_memory_tracker`, включающая корректировку внутреннего трекера памяти на основе информации из различных источников, периодически считываемой в фоновом потоке. [#75714](https://github.com/ClickHouse/ClickHouse/pull/75714) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлен столбец `normalized_query_hash` в `system.processes`. Примечание: хотя его можно легко вычислить на лету с помощью функции `normalizedQueryHash`, это сделано для подготовки к последующим изменениям. [#75756](https://github.com/ClickHouse/ClickHouse/pull/75756) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Запрос к `system.tables` не приведёт к исключению, даже если существует таблица `Merge`, созданная поверх уже не существующей базы данных. Метод `getTotalRows` удалён из таблиц `Hive`, поскольку мы не допускаем, чтобы он выполнял сложные операции. [#75772](https://github.com/ClickHouse/ClickHouse/pull/75772) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Хранить start&#95;time/end&#95;time для резервных копий с точностью до микросекунд. [#75929](https://github.com/ClickHouse/ClickHouse/pull/75929) ([Aleksandr Musorin](https://github.com/AVMusorin)).
* Добавлена метрика `MemoryTrackingUncorrected`, показывающая значение внутреннего глобального трекера памяти, которое не корректируется по значению RSS. [#75935](https://github.com/ClickHouse/ClickHouse/pull/75935) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлен разбор эндпоинтов вида `localhost:1234/handle` в табличных функциях `PostgreSQL` и `MySQL`. Это исправляет регрессию, внесённую в [https://github.com/ClickHouse/ClickHouse/pull/52503](https://github.com/ClickHouse/ClickHouse/pull/52503). [#75944](https://github.com/ClickHouse/ClickHouse/pull/75944) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлена серверная настройка `throw_on_unknown_workload`, которая позволяет выбрать поведение при выполнении запроса с настройкой `workload`, установленной в неизвестное значение: либо разрешить неограниченный доступ (по умолчанию), либо выдать ошибку `RESOURCE_ACCESS_DENIED`. Это полезно для принудительного использования планировщика рабочих нагрузок всеми запросами. [#75999](https://github.com/ClickHouse/ClickHouse/pull/75999) ([Sergei Trifonov](https://github.com/serxa)).
* Не переписывайте подстолбцы на `getSubcolumn` в `ARRAY JOIN`, если в этом нет необходимости. [#76018](https://github.com/ClickHouse/ClickHouse/pull/76018) ([Pavel Kruglov](https://github.com/Avogar)).
* Ошибки координации повторных попыток при загрузке таблиц. [#76020](https://github.com/ClickHouse/ClickHouse/pull/76020) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Поддержка сброса отдельных логов в `SYSTEM FLUSH LOGS`. [#76132](https://github.com/ClickHouse/ClickHouse/pull/76132) ([Raúl Marín](https://github.com/Algunenano)).
* Улучшена страница сервера `/binary`. Используется кривая Хильберта вместо кривой Морттона. В квадрате отображаются адреса на объём 512 МБ, что заполняет квадрат лучше (в предыдущих версиях адреса заполняли только половину квадрата). Цвет адресов определяется библиотекой, а не функцией. Разрешена прокрутка немного дальше за пределы области. [#76192](https://github.com/ClickHouse/ClickHouse/pull/76192) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Повторное выполнение запросов ON CLUSTER при ошибке TOO&#95;MANY&#95;SIMULTANEOUS&#95;QUERIES. [#76352](https://github.com/ClickHouse/ClickHouse/pull/76352) ([Patrick Galbraith](https://github.com/CaptTofu)).
* Добавлена асинхронная метрика `CPUOverload`, которая вычисляет относительную нехватку ресурсов CPU на сервере. [#76404](https://github.com/ClickHouse/ClickHouse/pull/76404) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Значение по умолчанию параметра `output_format_pretty_max_rows` изменено с 10000 на 1000. Полагаю, так удобнее в использовании. [#76407](https://github.com/ClickHouse/ClickHouse/pull/76407) ([Alexey Milovidov](https://github.com/alexey-milovidov)).





#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе)

* Исправлено форматирование исключений с использованием пользовательского формата, если они возникают во время интерпретации запроса. В предыдущих версиях исключения форматировались с использованием формата по умолчанию, а не формата, указанного в запросе. Исправляет [#55422](https://github.com/ClickHouse/ClickHouse/issues/55422). [#74994](https://github.com/ClickHouse/ClickHouse/pull/74994) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено сопоставление типов для SQLite (целочисленные типы в `int64`, числа с плавающей запятой в `float64`). [#73853](https://github.com/ClickHouse/ClickHouse/pull/73853) ([Joanna Hulboj](https://github.com/jh0x)).
* Исправлено разрешение идентификаторов из родительских областей. Разрешено использование алиасов для выражений в предложении WITH. Исправляет [#58994](https://github.com/ClickHouse/ClickHouse/issues/58994). Исправляет [#62946](https://github.com/ClickHouse/ClickHouse/issues/62946). Исправляет [#63239](https://github.com/ClickHouse/ClickHouse/issues/63239). Исправляет [#65233](https://github.com/ClickHouse/ClickHouse/issues/65233). Исправляет [#71659](https://github.com/ClickHouse/ClickHouse/issues/71659). Исправляет [#71828](https://github.com/ClickHouse/ClickHouse/issues/71828). Исправляет [#68749](https://github.com/ClickHouse/ClickHouse/issues/68749). [#66143](https://github.com/ClickHouse/ClickHouse/pull/66143) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена монотонность функции `negate`. В предыдущих версиях запрос `select * from a where -x = -42;`, где `x` — первичный ключ, мог возвращать неверный результат. [#71440](https://github.com/ClickHouse/ClickHouse/pull/71440) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена обработка пустого кортежа в arrayIntersect. Это исправляет [#72578](https://github.com/ClickHouse/ClickHouse/issues/72578). [#72581](https://github.com/ClickHouse/ClickHouse/pull/72581) ([Amos Bird](https://github.com/amosbird)).
* Исправлено чтение подобъектов JSON в подстолбцах с некорректным префиксом. [#73182](https://github.com/ClickHouse/ClickHouse/pull/73182) ([Pavel Kruglov](https://github.com/Avogar)).
* Корректно передавать настройки формата Native при взаимодействии клиент-сервер. [#73924](https://github.com/ClickHouse/ClickHouse/pull/73924) ([Pavel Kruglov](https://github.com/Avogar)).
* Проверка наличия неподдерживаемых типов для некоторых хранилищ. [#74218](https://github.com/ClickHouse/ClickHouse/pull/74218) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено падение при выполнении запроса `INSERT INTO SELECT` через интерфейс PostgreSQL на macOS (issue [#72938](https://github.com/ClickHouse/ClickHouse/issues/72938)). [#74231](https://github.com/ClickHouse/ClickHouse/pull/74231) ([Artem Yurov](https://github.com/ArtemYurov)).
* Исправлено неинициализированное значение `max_log_ptr` в реплицируемой базе данных. [#74336](https://github.com/ClickHouse/ClickHouse/pull/74336) ([Konstantin Morozov](https://github.com/k-morozov)).
* Исправлено падение при вставке значения типа `interval` (issue [#74299](https://github.com/ClickHouse/ClickHouse/issues/74299)). [#74478](https://github.com/ClickHouse/ClickHouse/pull/74478) ([NamHoaiNguyen](https://github.com/NamHoaiNguyen)).
* Исправлено форматирование константных JSON-литералов. Ранее это могло приводить к синтаксическим ошибкам при отправке запроса на другой сервер. [#74533](https://github.com/ClickHouse/ClickHouse/pull/74533) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен некорректный `CREATE`-запрос при использовании константных выражений секции `PARTITION` с включёнными неявными проекциями. Это исправляет [#74596](https://github.com/ClickHouse/ClickHouse/issues/74596). [#74634](https://github.com/ClickHouse/ClickHouse/pull/74634) ([Amos Bird](https://github.com/amosbird)).
* Избегайте оставлять соединение в некорректном состоянии после завершения INSERT с исключением. [#74740](https://github.com/ClickHouse/ClickHouse/pull/74740) ([Azat Khuzhin](https://github.com/azat)).
* Избегайте повторного использования соединений, оставленных в промежуточном состоянии. [#74749](https://github.com/ClickHouse/ClickHouse/pull/74749) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен сбой при разборе объявления типа JSON, если имя типа указано не в верхнем регистре. [#74784](https://github.com/ClickHouse/ClickHouse/pull/74784) ([Pavel Kruglov](https://github.com/Avogar)).
* Keeper: исправлена ошибка `LOGICAL_ERROR`, возникавшая при разрыве подключения до установления соединения. [#74844](https://github.com/ClickHouse/ClickHouse/pull/74844) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлено поведение, из-за которого сервер не мог запуститься при наличии таблицы, использующей `AzureBlobStorage`. Таблицы загружаются без каких-либо запросов к Azure. [#74880](https://github.com/ClickHouse/ClickHouse/pull/74880) ([Alexey Katsman](https://github.com/alexkats)).
* Исправлены отсутствовавшие поля `used_privileges` и `missing_privileges` в `query_log` для операций BACKUP и RESTORE. [#74887](https://github.com/ClickHouse/ClickHouse/pull/74887) ([Alexey Katsman](https://github.com/alexkats)).
* HDFS обновляет krb ticket при sasl-ошибке во время hdfs select-запроса. [#74930](https://github.com/ClickHouse/ClickHouse/pull/74930) ([inv2004](https://github.com/inv2004)).
* Исправлены запросы к базе данных Replicated в startup&#95;scripts. [#74942](https://github.com/ClickHouse/ClickHouse/pull/74942) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены проблемы с выражениями с псевдонимами типов в условии JOIN ON при использовании null-safe сравнения. [#74970](https://github.com/ClickHouse/ClickHouse/pull/74970) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Возвращает состояние парта из `deleting` обратно в `outdated`, если операция удаления завершилась неудачно. [#74985](https://github.com/ClickHouse/ClickHouse/pull/74985) ([Sema Checherinda](https://github.com/CheSema)).
* В предыдущих версиях при наличии скалярного подзапроса мы начинали выводить прогресс (накопленный при обработке подзапроса) на этапе инициализации формата данных, то есть до отправки HTTP-заголовков. Это приводило к потере HTTP-заголовков, таких как X-ClickHouse-QueryId и X-ClickHouse-Format, а также Content-Type. [#74991](https://github.com/ClickHouse/ClickHouse/pull/74991) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлены запросы `CREATE TABLE AS...` для `database_replicated_allow_replicated_engine_arguments=0`. [#75000](https://github.com/ClickHouse/ClickHouse/pull/75000) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлено оставление соединения клиентом в некорректном состоянии после исключений при INSERT. [#75030](https://github.com/ClickHouse/ClickHouse/pull/75030) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена аварийная остановка из-за неперехваченного исключения в репликации PSQL. [#75062](https://github.com/ClickHouse/ClickHouse/pull/75062) ([Azat Khuzhin](https://github.com/azat)).
* Sasl может привести к сбою любого вызова RPC; это исправление позволяет повторить вызов в случае, если истёк krb5‑тикет. [#75063](https://github.com/ClickHouse/ClickHouse/pull/75063) ([inv2004](https://github.com/inv2004)).
* Исправлено использование индексов (первичных и вторичных) для столбцов `Array`, `Map` и `Nullable(..)` при включённой настройке `optimize_function_to_subcolumns`. Ранее индексы для этих столбцов могли быть проигнорированы. [#75081](https://github.com/ClickHouse/ClickHouse/pull/75081) ([Anton Popov](https://github.com/CurtizJ)).
* Отключайте `flatten_nested` при создании материализованных представлений с внутренними таблицами, поскольку использовать такие «расплющенные» столбцы будет невозможно. [#75085](https://github.com/ClickHouse/ClickHouse/pull/75085) ([Christoph Wurm](https://github.com/cwurm)).
* Исправлена некорректная интерпретация некоторых IPv6-адресов (таких как ::ffff:1.1.1.1) в поле forwarded&#95;for, приводившая к разрыву соединения с клиентом с выбрасыванием исключения. [#75133](https://github.com/ClickHouse/ClickHouse/pull/75133) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена обработка nullsafe JOIN для допускающего NULL типа данных LowCardinality. Ранее `JOIN ON` с nullsafe-сравнением, таким как `IS NOT DISTINCT FROM`, `<=>`, `a IS NULL AND b IS NULL OR a == b`, работал некорректно с колонками LowCardinality. [#75143](https://github.com/ClickHouse/ClickHouse/pull/75143) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Проверка того, что мы не указываем key&#95;condition при подсчёте total&#95;number&#95;of&#95;rows для NumRowsCache. [#75164](https://github.com/ClickHouse/ClickHouse/pull/75164) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлена обработка запросов с неиспользуемой интерполяцией в новом анализаторе. [#75173](https://github.com/ClickHouse/ClickHouse/pull/75173) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлена ошибка сбоя при использовании CTE с Insert. [#75188](https://github.com/ClickHouse/ClickHouse/pull/75188) ([Shichao Jin](https://github.com/jsc0218)).
* Исправление в Keeper: предотвращена запись в повреждённые журналы изменений при откате логов. [#75197](https://github.com/ClickHouse/ClickHouse/pull/75197) ([Antonio Andelic](https://github.com/antonio2368)).
* Использовать `BFloat16` в качестве супертиипа там, где это уместно. Это закрывает: [#74404](https://github.com/ClickHouse/ClickHouse/issues/74404). [#75236](https://github.com/ClickHouse/ClickHouse/pull/75236) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлены неожиданные значения по умолчанию в результате `JOIN` при использовании `any_join_distinct_right_table_keys` и `OR` в условии `JOIN ON`. [#75262](https://github.com/ClickHouse/ClickHouse/pull/75262) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Маскировать учетные данные движка таблиц azureblobstorage. [#75319](https://github.com/ClickHouse/ClickHouse/pull/75319) ([Garrett Thomas](https://github.com/garrettthomaskth)).
* Исправлено поведение, при котором ClickHouse мог ошибочно выполнять проталкивание фильтра (`filter pushdown`) во внешнюю базу данных, такую как PostgreSQL, MySQL или SQLite. Это закрывает: [#71423](https://github.com/ClickHouse/ClickHouse/issues/71423). [#75320](https://github.com/ClickHouse/ClickHouse/pull/75320) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлен сбой в кэше схем Protobuf, который мог происходить при выводе в формате Protobuf и одновременном выполнении запроса `SYSTEM DROP FORMAT SCHEMA CACHE`. [#75357](https://github.com/ClickHouse/ClickHouse/pull/75357) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена возможная логическая ошибка или проблема с неинициализированной памятью при проталкивании фильтра из `HAVING` в режиме параллельных реплик. [#75363](https://github.com/ClickHouse/ClickHouse/pull/75363) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Скрытие конфиденциальной информации для табличных функций и движков таблиц `icebergS3` и `icebergAzure`. [#75378](https://github.com/ClickHouse/ClickHouse/pull/75378) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Функция `TRIM` с вычисляемыми пустыми символами для обрезки теперь корректно обрабатывается. Пример: `SELECT TRIM(LEADING concat('') FROM 'foo')` (Issue [#69922](https://github.com/ClickHouse/ClickHouse/issues/69922)). [#75399](https://github.com/ClickHouse/ClickHouse/pull/75399) ([Manish Gill](https://github.com/mgill25)).
* Исправлена гонка данных в IOutputFormat. [#75448](https://github.com/ClickHouse/ClickHouse/pull/75448) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена возможная ошибка `Elements ... and ... of Nested data structure ... (Array columns) have different array sizes` при использовании JSON-подстолбцов с типом Array в JOIN по распределённым таблицам. [#75512](https://github.com/ClickHouse/ClickHouse/pull/75512) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена порча данных при использовании `CODEC(ZSTD, DoubleDelta)`. Закрывает [#70031](https://github.com/ClickHouse/ClickHouse/issues/70031). [#75548](https://github.com/ClickHouse/ClickHouse/pull/75548) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлено взаимодействие между `allow_feature_tier` и настройкой совместимости `merge_tree`. [#75635](https://github.com/ClickHouse/ClickHouse/pull/75635) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено некорректное значение processed&#95;rows в system.s3queue&#95;log при повторной обработке файла. [#75666](https://github.com/ClickHouse/ClickHouse/pull/75666) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Учитывать `materialized_views_ignore_errors`, когда материализованное представление пишет в движок URL и возникает проблема с подключением. [#75679](https://github.com/ClickHouse/ClickHouse/pull/75679) ([Christoph Wurm](https://github.com/cwurm)).
* Исправлены редкие сбои при чтении из таблицы `MergeTree` после нескольких асинхронных запросов `RENAME` (с `alter_sync = 0`), переименовывавших столбцы с разными типами. [#75693](https://github.com/ClickHouse/ClickHouse/pull/75693) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка `Block structure mismatch in QueryPipeline stream` для некоторых запросов с `UNION ALL`. [#75715](https://github.com/ClickHouse/ClickHouse/pull/75715) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Перестроение проекции при `ALTER MODIFY` столбца, входящего в её первичный ключ. Ранее это могло приводить к ошибкам `CANNOT_READ_ALL_DATA` при `SELECT` после `ALTER MODIFY` столбца, использовавшегося в первичном ключе проекции. [#75720](https://github.com/ClickHouse/ClickHouse/pull/75720) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен некорректный результат `ARRAY JOIN` для скалярных подзапросов (с анализатором). [#75732](https://github.com/ClickHouse/ClickHouse/pull/75732) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка разыменования нулевого указателя в `DistinctSortedStreamTransform`. [#75734](https://github.com/ClickHouse/ClickHouse/pull/75734) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлено поведение `allow_suspicious_ttl_expressions`. [#75771](https://github.com/ClickHouse/ClickHouse/pull/75771) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Исправлено чтение неинициализированной памяти в функции `translate`, что закрывает [#75592](https://github.com/ClickHouse/ClickHouse/issues/75592). [#75794](https://github.com/ClickHouse/ClickHouse/pull/75794) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Передавать настройки формата в JSON для строкового форматирования в формате Native. [#75832](https://github.com/ClickHouse/ClickHouse/pull/75832) ([Pavel Kruglov](https://github.com/Avogar)).
* В истории изменений настроек зафиксировано стандартное включение параллельного `hash` как алгоритма `JOIN` в v24.12. Это означает, что ClickHouse продолжит выполнять `JOIN` с использованием непараллельного `hash`, если настроен уровень совместимости ниже v24.12. [#75870](https://github.com/ClickHouse/ClickHouse/pull/75870) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена ошибка, из-за которой таблицы с неявно добавленными min-max-индексами нельзя было копировать в новую таблицу (issue [#75677](https://github.com/ClickHouse/ClickHouse/issues/75677)). [#75877](https://github.com/ClickHouse/ClickHouse/pull/75877) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* `clickhouse-library-bridge` позволяет открывать произвольные библиотеки из файловой системы, поэтому его безопасно запускать только в изолированной среде. Чтобы исключить уязвимость при запуске рядом с clickhouse-server, мы ограничим пути к библиотекам расположением, указанным в конфигурации. Эта уязвимость была обнаружена в рамках программы [ClickHouse Bug Bounty Program](https://github.com/ClickHouse/ClickHouse/issues/38986) **Арсением Дугиным**. [#75954](https://github.com/ClickHouse/ClickHouse/pull/75954) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Мы по ошибке использовали сериализацию в JSON для некоторых метаданных, что оказалось неверным решением, потому что JSON не поддерживает бинарные данные внутри строковых литералов, включая нулевые байты. SQL-запросы могут содержать бинарные данные и некорректный UTF-8, поэтому мы должны поддерживать это и в наших файлах с метаданными. При этом форматы ClickHouse `JSONEachRow` и подобные обходят это ограничение, отходя от стандарта JSON ради идеального обратимого преобразования бинарных данных. См. обоснование здесь: [https://github.com/ClickHouse/ClickHouse/pull/73668#issuecomment-2560501790](https://github.com/ClickHouse/ClickHouse/pull/73668#issuecomment-2560501790). Решение заключается в том, чтобы сделать библиотеку `Poco::JSON` согласованной с форматом сериализации JSON в ClickHouse. Это закрывает [#73668](https://github.com/ClickHouse/ClickHouse/issues/73668). [#75963](https://github.com/ClickHouse/ClickHouse/pull/75963) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена проверка ограничения количества коммитов в хранилище `S3Queue`. [#76104](https://github.com/ClickHouse/ClickHouse/pull/76104) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено присоединение таблиц MergeTree с автоиндексами (`add_minmax_index_for_numeric_columns`/`add_minmax_index_for_string_columns`). [#76139](https://github.com/ClickHouse/ClickHouse/pull/76139) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема, из-за которой стек-трейсы из родительских потоков задания (настройка `enable_job_stack_trace`) не выводились. Также исправлена проблема, из-за которой настройка `enable_job_stack_trace` некорректно передавалась в потоки, в результате чего содержимое стек-трейса не всегда соответствовало этому параметру. [#76191](https://github.com/ClickHouse/ClickHouse/pull/76191) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена некорректная проверка прав, из-за которой для `ALTER RENAME` требовалась привилегия `CREATE USER`. Закрывает [#74372](https://github.com/ClickHouse/ClickHouse/issues/74372). [#76241](https://github.com/ClickHouse/ClickHouse/pull/76241) ([pufit](https://github.com/pufit)).
* Исправлена работа reinterpretAs с FixedString на архитектуре big-endian. [#76253](https://github.com/ClickHouse/ClickHouse/pull/76253) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена логическая ошибка в S3Queue: &quot;Expected current processor {} to be equal to {} for bucket {}&quot;. [#76358](https://github.com/ClickHouse/ClickHouse/pull/76358) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена взаимная блокировка при выполнении `ALTER` с базой данных `Memory`. [#76359](https://github.com/ClickHouse/ClickHouse/pull/76359) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена логическая ошибка в анализе индекса, если условие в `WHERE` содержит функцию `pointInPolygon`. [#76360](https://github.com/ClickHouse/ClickHouse/pull/76360) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен потенциально небезопасный вызов в обработчике сигналов. [#76549](https://github.com/ClickHouse/ClickHouse/pull/76549) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена поддержка обратных ключей в PartsSplitter. Это исправляет [#73400](https://github.com/ClickHouse/ClickHouse/issues/73400). [#73418](https://github.com/ClickHouse/ClickHouse/pull/73418) ([Amos Bird](https://github.com/amosbird)).

#### Улучшения сборки/тестирования/упаковки

- Поддержка сборки HDFS на ARM и Intel Mac. [#74244](https://github.com/ClickHouse/ClickHouse/pull/74244) ([Yan Xin](https://github.com/yxheartipp)).
- Включение ICU и GRPC при кросс-компиляции для Darwin. [#75922](https://github.com/ClickHouse/ClickHouse/pull/75922) ([Raúl Marín](https://github.com/Algunenano)).
- Обновление встроенного LLVM до версии 19. [#75148](https://github.com/ClickHouse/ClickHouse/pull/75148) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Отключение сетевого доступа для пользователя default в docker-образе. [#75259](https://github.com/ClickHouse/ClickHouse/pull/75259) ([Mikhail f. Shiryaev](https://github.com/Felixoid)). Все действия, связанные с clickhouse-server, преобразованы в функции и выполняются только при запуске стандартного бинарного файла в `entrypoint.sh`. Давно откладываемое улучшение было предложено в [#50724](https://github.com/ClickHouse/ClickHouse/issues/50724). Добавлен параметр `--users` в `clickhouse-extract-from-config` для получения значений из `users.xml`. [#75643](https://github.com/ClickHouse/ClickHouse/pull/75643) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Удалено около 20 МБ неиспользуемого кода из бинарного файла. [#76226](https://github.com/ClickHouse/ClickHouse/pull/76226) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### Релиз ClickHouse 25.1, 2025-01-28 {#251}


#### Обратное несовместимое изменение
* `JSONEachRowWithProgress` будет записывать прогресс каждый раз, когда он обновляется. В предыдущих версиях прогресс показывался только после каждого блока результата, что делало его бесполезным. Изменён способ отображения прогресса: нулевые значения показываться не будут. Это закрывает [#70800](https://github.com/ClickHouse/ClickHouse/issues/70800). [#73834](https://github.com/ClickHouse/ClickHouse/pull/73834) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Таблицы `Merge` будут унифицировать структуру подлежащих таблиц, используя объединение их столбцов и выводя общие типы. Это закрывает [#64864](https://github.com/ClickHouse/ClickHouse/issues/64864). В определённых случаях это изменение может быть обратно несовместимым. Один из примеров — когда между таблицами нет общего типа, но преобразование к типу первой таблицы всё ещё возможно, как в случае `UInt64` и `Int64` или любого числового типа и `String`. Если вы хотите вернуться к старому поведению, установите `merge_table_max_tables_to_look_for_schema_inference` в `1` или установите `compatibility` в `24.12` или более раннее значение. [#73956](https://github.com/ClickHouse/ClickHouse/pull/73956) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Формат вывода Parquet теперь конвертирует столбцы `Date` и `DateTime` в типы даты/времени, поддерживаемые Parquet, вместо записи их как «сырых» чисел. `DateTime` преобразуется в `DateTime64(3)` (было: `UInt32`); настройка `output_format_parquet_datetime_as_uint32` возвращает старое поведение. `Date` преобразуется в `Date32` (было: `UInt16`). [#70950](https://github.com/ClickHouse/ClickHouse/pull/70950) ([Michael Kolupaev](https://github.com/al13n321)).
* По умолчанию больше не допускаются несравнимые типы (такие как `JSON`/`Object`/`AggregateFunction`) в `ORDER BY` и функциях сравнения `less/greater/equal/etc`. [#73276](https://github.com/ClickHouse/ClickHouse/pull/73276) ([Pavel Kruglov](https://github.com/Avogar)).
* Устаревший движок базы данных `MaterializedMySQL` удалён и больше недоступен. [#73879](https://github.com/ClickHouse/ClickHouse/pull/73879) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Источник словаря `mysql` больше не выполняет запрос `SHOW TABLE STATUS`, потому что он не даёт никакой полезной информации для таблиц InnoDB, как и для любых современных версий MySQL. Это закрывает [#72636](https://github.com/ClickHouse/ClickHouse/issues/72636). Это изменение обратно совместимо, но помещено в эту категорию, чтобы вы имели возможность его заметить. [#73914](https://github.com/ClickHouse/ClickHouse/pull/73914) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Запросы `CHECK TABLE` теперь требуют отдельного права `CHECK`. В предыдущих версиях для выполнения этих запросов было достаточно права `SHOW TABLES`. Но запрос `CHECK TABLE` может быть «тяжёлым», и обычные лимиты сложности запросов для запросов `SELECT` к нему не применяются. Это приводило к потенциальной возможности DoS. [#74471](https://github.com/ClickHouse/ClickHouse/pull/74471) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Функция `h3ToGeo()` теперь возвращает результаты в порядке `(lat, lon)` (что является стандартным порядком для геометрических функций). Пользователи, которые хотят сохранить устаревший порядок результата `(lon, lat)`, могут установить настройку `h3togeo_lon_lat_result_order = true`. [#74719](https://github.com/ClickHouse/ClickHouse/pull/74719) ([Manish Gill](https://github.com/mgill25)).
* Новый драйвер MongoDB теперь используется по умолчанию. Пользователи, которые хотят продолжить использовать старый драйвер, могут установить серверную настройку `use_legacy_mongodb_integration` в значение `true`. [#73359](https://github.com/ClickHouse/ClickHouse/pull/73359) ([Robert Schulze](https://github.com/rschu1ze)).



#### Новая функция

* Добавлена возможность применять незавершённые мутации (ещё не материализованные фоновым процессом) при выполнении запросов `SELECT` сразу после их отправки. Это можно включить с помощью настройки `apply_mutations_on_fly`. [#74877](https://github.com/ClickHouse/ClickHouse/pull/74877) ([Anton Popov](https://github.com/CurtizJ)).
* Реализовано отсечение партиций таблиц `Iceberg` для операций партиционирования с временными преобразованиями в Iceberg. [#72044](https://github.com/ClickHouse/ClickHouse/pull/72044) ([Daniil Ivanik](https://github.com/divanik)).
* Добавлена поддержка подстолбцов в ключе сортировки MergeTree и пропускающих индексах. [#72644](https://github.com/ClickHouse/ClickHouse/pull/72644) ([Pavel Kruglov](https://github.com/Avogar)).
* Поддержка чтения значений `HALF_FLOAT` из `Apache Arrow`/`Parquet`/`ORC` (они читаются в `Float32`). Это закрывает [#72960](https://github.com/ClickHouse/ClickHouse/issues/72960). Имейте в виду, что половинная точность IEEE-754 — это не то же самое, что `BFloat16`. Закрывает [#73835](https://github.com/ClickHouse/ClickHouse/issues/73835). [#73836](https://github.com/ClickHouse/ClickHouse/pull/73836) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* В таблице `system.trace_log` появятся два новых столбца — `symbols` и `lines`, содержащие символизированный стек-трейс. Это позволяет легко собирать и экспортировать профильную информацию. Работа этой функции управляется конфигурационным параметром сервера `symbolize` в секции `trace_log` и по умолчанию включена. [#73896](https://github.com/ClickHouse/ClickHouse/pull/73896) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена новая функция `generateSerialID`, которую можно использовать для генерации автоинкрементных чисел в таблицах. Продолжение [#64310](https://github.com/ClickHouse/ClickHouse/issues/64310) от [kazalika](https://github.com/kazalika). Закрывает [#62485](https://github.com/ClickHouse/ClickHouse/issues/62485). [#73950](https://github.com/ClickHouse/ClickHouse/pull/73950) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен синтаксис `query1 PARALLEL WITH query2 PARALLEL WITH query3 ... PARALLEL WITH queryN` для DDL-запросов. Это означает, что подзапросы `{query1, query2, ... queryN}` могут (и предпочтительнее) выполняться параллельно друг с другом. [#73983](https://github.com/ClickHouse/ClickHouse/pull/73983) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлен кэш в памяти для десериализованных гранул пропускающих индексов. Это должно ускорить повторяющиеся запросы, использующие пропускающие индексы. Размер нового кэша контролируется серверными настройками `skipping_index_cache_size` и `skipping_index_cache_max_entries`. Изначальной мотивацией для добавления кэша были индексы векторного подобия, которые теперь работают значительно быстрее. [#70102](https://github.com/ClickHouse/ClickHouse/pull/70102) ([Robert Schulze](https://github.com/rschu1ze)).
* Теперь встроенный Web UI показывает индикатор прогресса во время выполнения запроса. Он позволяет отменять запросы. Он отображает общее количество записей и расширенную информацию о скорости. Таблица может отрисовываться по мере поступления данных. Включено HTTP-сжатие. Отрисовка таблицы стала быстрее. Заголовок таблицы стал «липким». Это позволяет выделять ячейки и перемещаться по ним с помощью клавиш-стрелок. Исправлена проблема, из-за которой контур выделенной ячейки делал её меньше. Ячейки больше не расширяются при наведении мыши, а только при выделении. Момент остановки отрисовки входящих данных теперь определяется на стороне клиента, а не сервера. Группы разрядов в числах подсвечиваются. Общий дизайн был обновлён и стал более выразительным. Выполняется проверка доступности сервера и корректности учётных данных, а также отображаются версия сервера и время его работы. Иконка облака теперь отображается контуром с любым шрифтом, даже в Safari. Большие целые числа внутри вложенных типов данных будут отображаться лучше. Корректно отображаются значения inf/nan. Типы данных отображаются при наведении курсора на заголовок столбца. [#74204](https://github.com/ClickHouse/ClickHouse/pull/74204) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность по умолчанию создавать мин-макс (skipping) индексы для столбцов в MergeTree с помощью настроек `add_minmax_index_for_numeric_columns` (для числовых столбцов) и `add_minmax_index_for_string_columns` (для строковых столбцов). Пока обе настройки отключены, поэтому поведение еще не изменилось. [#74266](https://github.com/ClickHouse/ClickHouse/pull/74266) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* Добавлены поля `script_query_number` и `script_line_number` в `system.query_log`, в ClientInfo в нативном протоколе и в серверные логи. Это закрывает [#67542](https://github.com/ClickHouse/ClickHouse/issues/67542). Благодарность [pinsvin00](https://github.com/pinsvin00) за запуск разработки этой функциональности ранее в [#68133](https://github.com/ClickHouse/ClickHouse/issues/68133). [#74477](https://github.com/ClickHouse/ClickHouse/pull/74477) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена агрегатная функция `sequenceMatchEvents`, которая возвращает временные метки событий, входящих в самую длинную цепочку, соответствующую шаблону. [#72349](https://github.com/ClickHouse/ClickHouse/pull/72349) ([UnamedRus](https://github.com/UnamedRus)).
* Добавлена функция `arrayNormalizedGini`. [#72823](https://github.com/ClickHouse/ClickHouse/pull/72823) ([flynn](https://github.com/ucasfl)).
* Добавлена поддержка оператора вычитания для `DateTime64`, позволяющая вычитать одно значение `DateTime64` из другого, а также из `DateTime`. [#74482](https://github.com/ClickHouse/ClickHouse/pull/74482) ([Li Yin](https://github.com/liyinsg)).



#### Экспериментальные возможности
* Тип данных `BFloat16` готов к использованию в продакшене. [#73840](https://github.com/ClickHouse/ClickHouse/pull/73840) ([Alexey Milovidov](https://github.com/alexey-milovidov)).



#### Улучшение производительности

* Оптимизирована функция `indexHint`. Теперь столбцы, которые используются только в качестве аргументов функции `indexHint`, не считываются из таблицы. [#74314](https://github.com/ClickHouse/ClickHouse/pull/74314) ([Anton Popov](https://github.com/CurtizJ)). Если функция `indexHint` — ключевой элемент вашей корпоративной архитектуры данных, эта оптимизация спасёт вам жизнь.
* Более точный учет настройки `max_joined_block_size_rows` для алгоритма JOIN `parallel_hash`. Это помогает избежать повышенного потребления памяти по сравнению с алгоритмом `hash`. [#74630](https://github.com/ClickHouse/ClickHouse/pull/74630) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлена поддержка оптимизации проталкивания предикатов на уровне плана запроса для шага `MergingAggregated`. Это улучшает производительность некоторых запросов при использовании анализатора. [#74073](https://github.com/ClickHouse/ClickHouse/pull/74073) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Разбиение блоков левой таблицы по хэшу было убрано из стадии probe алгоритма объединения `parallel_hash`. [#73089](https://github.com/ClickHouse/ClickHouse/pull/73089) ([Nikita Taranov](https://github.com/nickitat)).
* Оптимизирован формат ввода RowBinary. Закрывает [#63805](https://github.com/ClickHouse/ClickHouse/issues/63805). [#65059](https://github.com/ClickHouse/ClickHouse/pull/65059) ([Pavel Kruglov](https://github.com/Avogar)).
* Записывайте части с уровнем 1, если включён `optimize_on_insert`. Это позволяет применять несколько оптимизаций запросов с `FINAL` к только что записанным частям. [#73132](https://github.com/ClickHouse/ClickHouse/pull/73132) ([Anton Popov](https://github.com/CurtizJ)).
* Ускорена десериализация строк за счёт низкоуровневых оптимизаций. [#65948](https://github.com/ClickHouse/ClickHouse/pull/65948) ([Nikita Taranov](https://github.com/nickitat)).
* При выполнении проверки на равенство между записями, например во время слияний, начинайте сравнение строк со столбцов, значения в которых с наибольшей вероятностью различаются. [#63780](https://github.com/ClickHouse/ClickHouse/pull/63780) ([UnamedRus](https://github.com/UnamedRus)).
* Улучшена производительность grace hash join за счёт повторной сортировки правой таблицы соединения по ключам. [#72237](https://github.com/ClickHouse/ClickHouse/pull/72237) ([kevinyhzou](https://github.com/KevinyhZou)).
* Добавлена возможность для `arrayROCAUC` и `arrayAUCPR` вычислять частичную площадь под всей кривой, чтобы их вычисление можно было распараллелить на очень больших наборах данных. [#72904](https://github.com/ClickHouse/ClickHouse/pull/72904) ([Emmanuel](https://github.com/emmanuelsdias)).
* Избегайте создания слишком большого числа простаивающих потоков. [#72920](https://github.com/ClickHouse/ClickHouse/pull/72920) ([Guo Wangyang](https://github.com/guowangy)).
* Не перечислять ключи blob-хранилища, если в табличной функции используется только раскрытие фигурных скобок. Закрывает [#73333](https://github.com/ClickHouse/ClickHouse/issues/73333). [#73518](https://github.com/ClickHouse/ClickHouse/pull/73518) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Оптимизация короткого замыкания для функций, выполняемых над аргументами Nullable. [#73820](https://github.com/ClickHouse/ClickHouse/pull/73820) ([李扬](https://github.com/taiyang-li)).
* Не применять `maskedExecute` к нефункциональным столбцам, улучшить производительность выполнения с коротким замыканием. [#73965](https://github.com/ClickHouse/ClickHouse/pull/73965) ([lgbo](https://github.com/lgbo-ustc)).
* Отключено автоопределение заголовков во входных форматах для `Kafka`/`NATS`/`RabbitMQ`/`FileLog` для улучшения производительности. [#74006](https://github.com/ClickHouse/ClickHouse/pull/74006) ([Azat Khuzhin](https://github.com/azat)).
* Выполнять конвейер с более высокой степенью параллелизма после агрегации с `GROUPING SETS`. [#74082](https://github.com/ClickHouse/ClickHouse/pull/74082) ([Nikita Taranov](https://github.com/nickitat)).
* Снижена длительность критической секции в `MergeTreeReadPool`. [#74202](https://github.com/ClickHouse/ClickHouse/pull/74202) ([Guo Wangyang](https://github.com/guowangy)).
* Улучшена производительность параллельных реплик. Десериализация пакетов на инициаторе запроса для пакетов, не относящихся к протоколу параллельных реплик, теперь всегда выполняется в потоке конвейера. Ранее это могло происходить в потоке, отвечающем за планирование конвейера, что могло снижать отзывчивость инициатора и приводить к задержкам в выполнении конвейера. [#74398](https://github.com/ClickHouse/ClickHouse/pull/74398) ([Igor Nikonov](https://github.com/devcrafter)).
* Улучшена производительность больших мультизапросов в Keeper. [#74849](https://github.com/ClickHouse/ClickHouse/pull/74849) ([Antonio Andelic](https://github.com/antonio2368)).
* Используйте обёртки логов по значению и не размещайте их в heap-памяти. [#74034](https://github.com/ClickHouse/ClickHouse/pull/74034) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Фоново восстанавливать соединение с репликами словарей MySQL и Postgres, чтобы это не задерживало запросы к соответствующим словарям. [#71101](https://github.com/ClickHouse/ClickHouse/pull/71101) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Параллельные реплики использовали историческую информацию о доступности реплик для улучшения выбора, но не обновляли счетчик ошибок реплики, когда подключение было недоступно. Этот PR обновляет счетчик ошибок реплики при её недоступности. [#72666](https://github.com/ClickHouse/ClickHouse/pull/72666) ([zoomxi](https://github.com/zoomxi)).
* Добавлена настройка MergeTree `materialize_skip_indexes_on_merge`, которая подавляет создание skip-индексов во время слияния. Это позволяет пользователям явно контролировать (через `ALTER TABLE [..] MATERIALIZE INDEX [...]`), когда создаются skip-индексы. Это может быть полезно, если построение skip-индексов является дорогостоящей операцией (например, для индексов векторного сходства). [#74401](https://github.com/ClickHouse/ClickHouse/pull/74401) ([Robert Schulze](https://github.com/rschu1ze)).
* Оптимизированы запросы к Keeper в Storage(S3/Azure)Queue. [#74410](https://github.com/ClickHouse/ClickHouse/pull/74410) ([Kseniia Sumarokova](https://github.com/kssenii)). [#74538](https://github.com/ClickHouse/ClickHouse/pull/74538) ([Kseniia Sumarokova](https://github.com/kssenii)).
* По умолчанию используется до `1000` параллельных реплик. [#74504](https://github.com/ClickHouse/ClickHouse/pull/74504) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Улучшено повторное использование HTTP-сессий при чтении с S3-диска ([#72401](https://github.com/ClickHouse/ClickHouse/issues/72401)). [#74548](https://github.com/ClickHouse/ClickHouse/pull/74548) ([Julian Maicher](https://github.com/jmaicher)).





#### Улучшение

* Добавлена поддержка `SETTINGS` в запросе `CREATE TABLE` с неявным `ENGINE`, а также возможность совместного использования настроек движка и настроек запроса. [#73120](https://github.com/ClickHouse/ClickHouse/pull/73120) ([Raúl Marín](https://github.com/Algunenano)).
* Включить `use_hive_partitioning` по умолчанию. [#71636](https://github.com/ClickHouse/ClickHouse/pull/71636) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена поддержка `CAST` и `ALTER` между типами `JSON` с разными параметрами. [#72303](https://github.com/ClickHouse/ClickHouse/pull/72303) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена поддержка сравнения на равенство для значений столбца `JSON`. [#72991](https://github.com/ClickHouse/ClickHouse/pull/72991) ([Pavel Kruglov](https://github.com/Avogar)).
* Улучшено форматирование идентификаторов с JSON-подстолбцами, чтобы избежать ненужных обратных кавычек. [#73085](https://github.com/ClickHouse/ClickHouse/pull/73085) ([Pavel Kruglov](https://github.com/Avogar)).
* Интерактивные метрики: улучшения. Исправлена проблема, из-за которой метрики с параллельных реплик отображались не полностью. Метрики отображаются в порядке последнего обновления, затем лексикографически по имени. Устаревшие метрики не отображаются. [#71631](https://github.com/ClickHouse/ClickHouse/pull/71631) ([Julia Kartseva](https://github.com/jkartseva)).
* Формат вывода JSON теперь по умолчанию является «красивым». Добавлена новая настройка `output_format_json_pretty_print` для управления этим и она включена по умолчанию. [#72148](https://github.com/ClickHouse/ClickHouse/pull/72148) ([Pavel Kruglov](https://github.com/Avogar)).
* Разрешить `LowCardinality(UUID)` по умолчанию. На практике это оказалось удобным для клиентов ClickHouse Cloud. [#73826](https://github.com/ClickHouse/ClickHouse/pull/73826) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшено сообщение при установке. [#73827](https://github.com/ClickHouse/ClickHouse/pull/73827) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшено сообщение о восстановлении пароля в ClickHouse Cloud. [#73831](https://github.com/ClickHouse/ClickHouse/pull/73831) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшено сообщение об ошибке для таблицы `File`, которая не поддерживает дописывание данных в файл. [#73832](https://github.com/ClickHouse/ClickHouse/pull/73832) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Запрашивать подтверждение, когда пользователь по ошибке пытается вывести бинарный формат (например, Native, Parquet, Avro) в терминал. Это закрывает [#59524](https://github.com/ClickHouse/ClickHouse/issues/59524). [#73833](https://github.com/ClickHouse/ClickHouse/pull/73833) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Подсветка конечных пробелов в форматах Pretty и Vertical в терминале для лучшей наглядности. Управляется настройкой `output_format_pretty_highlight_trailing_spaces`. Изначальная реализация — [Braden Burns](https://github.com/bradenburns) из [#72996](https://github.com/ClickHouse/ClickHouse/issues/72996). Закрывает [#71590](https://github.com/ClickHouse/ClickHouse/issues/71590). [#73847](https://github.com/ClickHouse/ClickHouse/pull/73847) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* `clickhouse-client` и `clickhouse-local` будут автоматически определять тип сжатия данных из stdin, когда он перенаправлен из файла. Это закрывает [#70865](https://github.com/ClickHouse/ClickHouse/issues/70865). [#73848](https://github.com/ClickHouse/ClickHouse/pull/73848) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* По умолчанию укорачивать слишком длинные имена столбцов в форматах `pretty`. Это контролируется настройками `output_format_pretty_max_column_name_width_cut_to` и `output_format_pretty_max_column_name_width_min_chars_to_cut`. Это продолжение работы [tanmaydatta](https://github.com/tanmaydatta) в [#66502](https://github.com/ClickHouse/ClickHouse/issues/66502). Это закрывает задачу [#65968](https://github.com/ClickHouse/ClickHouse/issues/65968). [#73851](https://github.com/ClickHouse/ClickHouse/pull/73851) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сделать форматы `Pretty` более наглядными: объединять блоки, если с момента вывода предыдущего блока прошло немного времени. Это контролируется новыми настройками `output_format_pretty_squash_consecutive_ms` (по умолчанию 50 мс) и `output_format_pretty_squash_max_wait_ms` (по умолчанию 1000 мс). Продолжение [#49537](https://github.com/ClickHouse/ClickHouse/issues/49537). Закрывает [#49153](https://github.com/ClickHouse/ClickHouse/issues/49153). [#73852](https://github.com/ClickHouse/ClickHouse/pull/73852) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена метрика числа исходных кусков, которые в данный момент сливаются. Закрывает [#70809](https://github.com/ClickHouse/ClickHouse/issues/70809). [#73868](https://github.com/ClickHouse/ClickHouse/pull/73868) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Подсвечивает столбцы в формате `Vertical`, если вывод производится в терминал. Это можно отключить с помощью настройки `output_format_pretty_color`. [#73898](https://github.com/ClickHouse/ClickHouse/pull/73898) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшена совместимость с MySQL до уровня, при котором `mysqlsh` (функциональный CLI-клиент MySQL от Oracle) теперь может подключаться к ClickHouse. Это необходимо для упрощения тестирования. [#73912](https://github.com/ClickHouse/ClickHouse/pull/73912) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Красивые форматы могут отображать многострочные поля внутри ячейки таблицы, что улучшает читаемость. Эта возможность включена по умолчанию и управляется настройкой `output_format_pretty_multiline_fields`. Продолжение работы [Volodyachan](https://github.com/Volodyachan) из [#64094](https://github.com/ClickHouse/ClickHouse/issues/64094). Это закрывает [#56912](https://github.com/ClickHouse/ClickHouse/issues/56912). [#74032](https://github.com/ClickHouse/ClickHouse/pull/74032) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность передавать HTTP-заголовки X-ClickHouse в JavaScript в браузере. Это делает разработку приложений более удобной. [#74180](https://github.com/ClickHouse/ClickHouse/pull/74180) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Формат `JSONEachRowWithProgress` будет включать события с метаданными, а также итоговые значения и экстремумы. Он также включает `rows_before_limit_at_least` и `rows_before_aggregation`. Формат корректно выводит исключение, если оно возникает после частичных результатов. Прогресс теперь включает прошедшие наносекунды. В конце выводится одно финальное событие прогресса. Прогресс во время выполнения запроса будет выводиться не чаще, чем это задано параметром `interactive_delay`. [#74181](https://github.com/ClickHouse/ClickHouse/pull/74181) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Песочные часы будут плавно вращаться в интерфейсе Play. [#74182](https://github.com/ClickHouse/ClickHouse/pull/74182) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Даже если HTTP-ответ сжат, отправляйте пакеты сразу по мере их появления. Это позволяет браузеру получать пакеты прогресса и сжатые данные. [#74201](https://github.com/ClickHouse/ClickHouse/pull/74201) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Если количество выводимых записей больше N = `output_format_pretty_max_rows`, вместо отображения только первых N строк выходная таблица будет обрезана посередине: будут показаны первые N/2 строк и последние N/2 строк. Продолжение [#64200](https://github.com/ClickHouse/ClickHouse/issues/64200). Закрывает [#59502](https://github.com/ClickHouse/ClickHouse/issues/59502). [#73929](https://github.com/ClickHouse/ClickHouse/pull/73929) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Разрешить более общий алгоритм планирования `JOIN` при включённом алгоритме хеш-`JOIN`. [#71926](https://github.com/ClickHouse/ClickHouse/pull/71926) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Добавлена возможность создавать индекс bloom&#95;filter на столбцах с типом данных `DateTime64`. [#66416](https://github.com/ClickHouse/ClickHouse/pull/66416) ([Yutong Xiao](https://github.com/YutSean)).
* Когда одновременно включены `min_age_to_force_merge_seconds` и `min_age_to_force_merge_on_partition_only`, слияние частей будет игнорировать ограничение на максимальное количество байт. [#73656](https://github.com/ClickHouse/ClickHouse/pull/73656) ([Kai Zhu](https://github.com/nauu)).
* В таблицу логов спанов OpenTelemetry добавлены HTTP-заголовки для повышения трассируемости. [#70516](https://github.com/ClickHouse/ClickHouse/pull/70516) ([jonymohajanGmail](https://github.com/jonymohajanGmail)).
* Добавлена поддержка записи файла `orc` с использованием произвольного часового пояса, а не только часового пояса `GMT`. [#70615](https://github.com/ClickHouse/ClickHouse/pull/70615) ([kevinyhzou](https://github.com/KevinyhZou)).
* Учитывать настройки планирования ввода-вывода при записи резервных копий между облаками. [#71093](https://github.com/ClickHouse/ClickHouse/pull/71093) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Добавлен псевдоним `name` для столбца `metric` в `system.asynchronous_metrics`. [#71164](https://github.com/ClickHouse/ClickHouse/pull/71164) ([megao](https://github.com/jetgm)).
* Исторически по какой-то причине запрос `ALTER TABLE MOVE PARTITION TO TABLE` проверял права `SELECT` и `ALTER DELETE` вместо отдельного `ALTER_MOVE_PARTITION`. Этот PR начинает использовать этот тип доступа. Для совместимости это разрешение также будет неявно выдаваться, если выданы `SELECT` и `ALTER DELETE`, но такое поведение будет удалено в будущих релизах. Закрывает [#16403](https://github.com/ClickHouse/ClickHouse/issues/16403). [#71632](https://github.com/ClickHouse/ClickHouse/pull/71632) ([pufit](https://github.com/pufit)).
* Выбрасывать исключение при попытке материализовать столбец в ключе сортировки, а не допускать нарушения порядка сортировки. [#71891](https://github.com/ClickHouse/ClickHouse/pull/71891) ([Peter Nguyen](https://github.com/petern48)).
* Скрытие секретов в `EXPLAIN QUERY TREE`. [#72025](https://github.com/ClickHouse/ClickHouse/pull/72025) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Поддержка логических целочисленных типов Parquet в нативном ридере. [#72105](https://github.com/ClickHouse/ClickHouse/pull/72105) ([Arthur Passos](https://github.com/arthurpassos)).
* Интерактивно запрашивать учетные данные в браузере, если пользователь `default` требует пароль. В предыдущих версиях сервер возвращал HTTP 403; теперь он возвращает HTTP 401. [#72198](https://github.com/ClickHouse/ClickHouse/pull/72198) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Типы доступа `CREATE_USER`, `ALTER_USER`, `DROP_USER`, `CREATE_ROLE`, `ALTER_ROLE`, `DROP_ROLE` преобразованы из глобальных в параметризованные. Это означает, что теперь пользователи могут более точно выдавать права на управление доступом. [#72246](https://github.com/ClickHouse/ClickHouse/pull/72246) ([pufit](https://github.com/pufit)).
* Добавлен столбец `latest_fail_error_code_name` в `system.mutations`. Он нужен для введения новой метрики по застрявшим мутациям и построения графиков ошибок, возникающих в облаке, а также, при необходимости, для добавления нового, менее шумного алерта. [#72398](https://github.com/ClickHouse/ClickHouse/pull/72398) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Сокращено количество выделений памяти в запросе `ATTACH PARTITION`. [#72583](https://github.com/ClickHouse/ClickHouse/pull/72583) ([Konstantин Morozov](https://github.com/k-morozov)).
* Ограничение `max_bytes_before_external_sort` теперь зависит от общего потребления памяти запросом (ранее оно определяло число байт в блоке сортировки для одного потока сортировки, теперь имеет тот же смысл, что и `max_bytes_before_external_group_by` — это общий лимит памяти для всего запроса для всех потоков). Также добавлена ещё одна настройка для управления размером блока на диске — `min_external_sort_block_bytes`. [#72598](https://github.com/ClickHouse/ClickHouse/pull/72598) ([Azat Khuzhin](https://github.com/azat)).
* Игнорировать ограничения по памяти в коллекторе трассировок. [#72606](https://github.com/ClickHouse/ClickHouse/pull/72606) ([Azat Khuzhin](https://github.com/azat)).
* Добавьте настройки сервера `dictionaries_lazy_load` и `wait_dictionaries_load_at_startup` в `system.server_settings`. [#72664](https://github.com/ClickHouse/ClickHouse/pull/72664) ([Christoph Wurm](https://github.com/cwurm)).
* Добавлена настройка `max_backup_bandwidth` в список настроек, которые можно указывать в запросах `BACKUP`/`RESTORE`. [#72665](https://github.com/ClickHouse/ClickHouse/pull/72665) ([Christoph Wurm](https://github.com/cwurm)).
* Снижен уровень логирования для появляющихся реплицированных кусков в движке ReplicatedMergeTree, чтобы уменьшить объем логов, генерируемых в реплицированном кластере. [#72876](https://github.com/ClickHouse/ClickHouse/pull/72876) ([mor-akamai](https://github.com/morkalfon)).
* Улучшено извлечение общих выражений в дизъюнкциях. Теперь можно упрощать результирующее фильтрующее выражение, даже если нет общего подвыражения для всех дизъюнктов. Продолжение [#71537](https://github.com/ClickHouse/ClickHouse/issues/71537). [#73271](https://github.com/ClickHouse/ClickHouse/pull/73271) ([Dmitry Novik](https://github.com/novikd)).
* В хранилищах `S3Queue`/`AzureQueue` появилась возможность добавлять настройки к таблицам, которые были созданы без настроек. [#73283](https://github.com/ClickHouse/ClickHouse/pull/73283) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена настройка `least_greatest_legacy_null_behavior` (по умолчанию: `false`), которая определяет, должны ли функции `least` и `greatest` при наличии аргументов `NULL` безусловно возвращать `NULL` (если `true`) или игнорировать такие аргументы (если `false`). [#73344](https://github.com/ClickHouse/ClickHouse/pull/73344) ([Robert Schulze](https://github.com/rschu1ze)).
* Использование многозапросных операций Keeper в потоке очистки `ObjectStorageQueueMetadata`. [#73357](https://github.com/ClickHouse/ClickHouse/pull/73357) ([Antonio Andelic](https://github.com/antonio2368)).
* Когда ClickHouse работает в cgroup, мы по‑прежнему собираем асинхронные системные метрики, связанные с нагрузкой, планированием процессов, памятью и т. д. Они могут давать полезные сигналы, когда ClickHouse — единственный процесс на хосте с высоким потреблением ресурсов. [#73369](https://github.com/ClickHouse/ClickHouse/pull/73369) ([Nikita Taranov](https://github.com/nickitat)).
* В хранилище `S3Queue` добавлена возможность переноса старых упорядоченных таблиц, созданных до версии 24.6, в новую структуру с бакетами. [#73467](https://github.com/ClickHouse/ClickHouse/pull/73467) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена таблица `system.azure_queue`, аналогичная уже существующей `system.s3queue`. [#73477](https://github.com/ClickHouse/ClickHouse/pull/73477) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Функция `parseDateTime64` (и её варианты) теперь корректно обрабатывает входные даты до 1970 года и после 2106 года. Пример: `SELECT parseDateTime64InJodaSyntax('2200-01-01 00:00:00.000', 'yyyy-MM-dd HH:mm:ss.SSS')`. [#73594](https://github.com/ClickHouse/ClickHouse/pull/73594) ([zhanglistar](https://github.com/zhanglistar)).
* Устранены некоторые проблемы удобства использования `clickhouse-disks`, на которые указывали пользователи. Закрывает [#67136](https://github.com/ClickHouse/ClickHouse/issues/67136). [#73616](https://github.com/ClickHouse/ClickHouse/pull/73616) ([Daniil Ivanik](https://github.com/divanik)).
* Добавлена возможность изменять настройки фиксации (commit) в хранилище S3(Azure)Queue. (Настройки фиксации: `max_processed_files_before_commit`, `max_processed_rows_before_commit`, `max_processed_bytes_before_commit`, `max_processing_time_sec_before_commit`). [#73635](https://github.com/ClickHouse/ClickHouse/pull/73635) ([Kseniia Sumarokova](https://github.com/kssenii)).
* В хранилище S3(Azure)Queue агрегируется прогресс чтения между источниками для сравнения с настройками предельного значения фиксации (commit limit). [#73641](https://github.com/ClickHouse/ClickHouse/pull/73641) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Поддержаны основные настройки в запросах `BACKUP`/`RESTORE`. [#73650](https://github.com/ClickHouse/ClickHouse/pull/73650) ([Vitaly Baranov](https://github.com/vitlibar)).
* Учитывать `output_format_compression_level` при выводе в формате Parquet. [#73651](https://github.com/ClickHouse/ClickHouse/pull/73651) ([Arthur Passos](https://github.com/arthurpassos)).
* Добавлено чтение `fixed_size_list` Apache Arrow как `Array` вместо трактовки его как неподдерживаемого типа. [#73654](https://github.com/ClickHouse/ClickHouse/pull/73654) ([Julian Meyers](https://github.com/J-Meyers)).
* Добавлены два движка бэкапов: `Memory` (хранит бэкапы в текущей пользовательской сессии) и `Null` (вообще не хранит бэкапы), предназначенный для тестирования. [#73690](https://github.com/ClickHouse/ClickHouse/pull/73690) ([Vitaly Baranov](https://github.com/vitlibar)).
* `concurrent_threads_soft_limit_num` и `concurrent_threads_soft_limit_num_ratio_to_cores` теперь можно изменять без перезапуска сервера. [#73713](https://github.com/ClickHouse/ClickHouse/pull/73713) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена поддержка расширенных числовых типов (`Decimal`, целые большого размера) в функциях `formatReadable`. [#73765](https://github.com/ClickHouse/ClickHouse/pull/73765) ([Raúl Marín](https://github.com/Algunenano)).
* Поддержка TLS для совместимости с протоколом взаимодействия Postgres (wire protocol). [#73812](https://github.com/ClickHouse/ClickHouse/pull/73812) ([scanhex12](https://github.com/scanhex12)).
* Функция `isIPv4String` возвращала true, если за корректным IPv4-адресом следовал нулевой байт, хотя в этом случае она должна возвращать false. Продолжение [#65387](https://github.com/ClickHouse/ClickHouse/issues/65387). [#73946](https://github.com/ClickHouse/ClickHouse/pull/73946) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сделать коды ошибок в протоколе MySQL Wire совместимыми с MySQL. Продолжение [#56831](https://github.com/ClickHouse/ClickHouse/issues/56831). Закрывает [#50957](https://github.com/ClickHouse/ClickHouse/issues/50957). [#73948](https://github.com/ClickHouse/ClickHouse/pull/73948) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена настройка `validate_enum_literals_in_opearators` для проверки литералов enum в операторах `IN`, `NOT IN` на соответствие типу enum и выброса исключения, если литерал не является допустимым значением enum. [#73985](https://github.com/ClickHouse/ClickHouse/pull/73985) ([Vladimir Cherkasov](https://github.com/vdimir)).
* В хранилище `S3(Azure)Queue` все файлы (в одном пакете, задаваемом настройками commit) фиксируются в одной транзакции Keeper. [#73991](https://github.com/ClickHouse/ClickHouse/pull/73991) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отключено определение заголовков для исполняемых UDF и словарей (это могло приводить к ошибке Function &#39;X&#39;: wrong result, expected Y row(s), actual Y-1). [#73992](https://github.com/ClickHouse/ClickHouse/pull/73992) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена опция `distributed` для `EXPLAIN PLAN`. Теперь `EXPLAIN distributed=1 ...` добавляет удалённый план к шагам `ReadFromParallelRemote*`. [#73994](https://github.com/ClickHouse/ClickHouse/pull/73994) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Использован корректный возвращаемый тип для not/xor с аргументами типа Dynamic. [#74013](https://github.com/ClickHouse/ClickHouse/pull/74013) ([Pavel Kruglov](https://github.com/Avogar)).
* Разрешена смена параметра `add_implicit_sign_column_constraint_for_collapsing_engine` после создания таблицы. [#74014](https://github.com/ClickHouse/ClickHouse/pull/74014) ([Christoph Wurm](https://github.com/cwurm)).
* Поддержка подстолбцов в запросе `SELECT` материализованного представления. [#74030](https://github.com/ClickHouse/ClickHouse/pull/74030) ([Pavel Kruglov](https://github.com/Avogar)).
* Теперь есть три простых способа задать пользовательскую строку приглашения в `clickhouse-client`: 1. через параметр командной строки `--prompt`, 2. в конфигурационном файле, через настройку `<prompt>[...]</prompt>`, и 3. также в конфигурационном файле, через настройки для отдельных подключений `<connections_credentials><prompt>[...]</prompt></connection_credentials>`. [#74168](https://github.com/ClickHouse/ClickHouse/pull/74168) ([Christoph Wurm](https://github.com/cwurm)).
* Автоматически определять защищённое подключение при подключении к порту 9440 в ClickHouse Client. [#74212](https://github.com/ClickHouse/ClickHouse/pull/74212) ([Christoph Wurm](https://github.com/cwurm)).
* Аутентифицировать пользователей только по имени пользователя для `http_handlers` (ранее требовалось также указывать пароль). [#74221](https://github.com/ClickHouse/ClickHouse/pull/74221) ([Azat Khuzhin](https://github.com/azat)).
* Поддержка альтернативных языков запросов PRQL и KQL отмечена как экспериментальная. Чтобы их использовать, задайте настройки `allow_experimental_prql_dialect = 1` и `allow_experimental_kusto_dialect = 1`. [#74224](https://github.com/ClickHouse/ClickHouse/pull/74224) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка возврата типа по умолчанию `Enum` в большем числе агрегатных функций. [#74272](https://github.com/ClickHouse/ClickHouse/pull/74272) ([Raúl Marín](https://github.com/Algunenano)).
* В `OPTIMIZE TABLE` теперь можно указать ключевое слово `FORCE` как альтернативу существующему ключевому слову `FINAL`. [#74342](https://github.com/ClickHouse/ClickHouse/pull/74342) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлен метрик `IsServerShuttingDown`, необходимый для срабатывания оповещения, если завершение работы сервера занимает слишком много времени. [#74429](https://github.com/ClickHouse/ClickHouse/pull/74429) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* В EXPLAIN добавлены имена таблиц Iceberg. [#74485](https://github.com/ClickHouse/ClickHouse/pull/74485) ([alekseev-maksim](https://github.com/alekseev-maksim)).
* Улучшено сообщение об ошибке при использовании RECURSIVE CTE со старым анализатором. [#74523](https://github.com/ClickHouse/ClickHouse/pull/74523) ([Raúl Marín](https://github.com/Algunenano)).
* Показывать подробные сообщения об ошибках в `system.errors`. [#74574](https://github.com/ClickHouse/ClickHouse/pull/74574) ([Vitaly Baranov](https://github.com/vitlibar)).
* Разрешает использовать пароль для взаимодействия клиента с clickhouse-keeper. Эта возможность не особенно полезна, если у вас корректно настроена конфигурация SSL для сервера и клиента, но всё же может быть полезна в некоторых случаях. Пароль не может быть длиннее 16 символов. Это не связано с моделью аутентификации Keeper. [#74673](https://github.com/ClickHouse/ClickHouse/pull/74673) ([alesapin](https://github.com/alesapin)).
* Добавлен код ошибки для перезагрузчика конфигурации. [#74746](https://github.com/ClickHouse/ClickHouse/pull/74746) ([Garrett Thomas](https://github.com/garrettthomaskth)).
* Добавлена поддержка адресов IPv6 в табличных функциях и движках MySQL и PostgreSQL. [#74796](https://github.com/ClickHouse/ClickHouse/pull/74796) ([Mikhail Koviazin](https://github.com/mkmkme)).
* Реализована оптимизация с коротким замыканием для `divideDecimal`. Исправляет [#74280](https://github.com/ClickHouse/ClickHouse/issues/74280). [#74843](https://github.com/ClickHouse/ClickHouse/pull/74843) ([Kevin Mingtarja](https://github.com/kevinmingtarja)).
* Теперь пользователей можно задавать в скриптах запуска. [#74894](https://github.com/ClickHouse/ClickHouse/pull/74894) ([pufit](https://github.com/pufit)).
* Добавлена поддержка токенов Azure SAS. [#72959](https://github.com/ClickHouse/ClickHouse/pull/72959) ([Azat Khuzhin](https://github.com/azat)).





#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе)

* Задавайте уровень сжатия Parquet только в том случае, если кодек сжатия его поддерживает. [#74659](https://github.com/ClickHouse/ClickHouse/pull/74659) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлена регрессия, из-за которой использование локалей сортировки с модификаторами вызывало ошибку. Например, теперь работает запрос `SELECT arrayJoin(['kk 50', 'KK 01', ' KK 2', ' KK 3', 'kk 1', 'x9y99', 'x9y100']) item ORDER BY item ASC COLLATE 'tr-u-kn-true-ka-shifted`. [#73544](https://github.com/ClickHouse/ClickHouse/pull/73544) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена ошибка, из‑за которой нельзя было создать SEQUENTIAL-узел с помощью keeper-client. [#64177](https://github.com/ClickHouse/ClickHouse/pull/64177) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлен некорректный подсчёт символов в функциях position. [#71003](https://github.com/ClickHouse/ClickHouse/pull/71003) ([思维](https://github.com/heymind)).
* Операции `RESTORE` для объектов доступа требовали больше прав, чем было необходимо, из‑за необработанных частичных отзывов прав. Этот PR исправляет проблему. Закрывает [#71853](https://github.com/ClickHouse/ClickHouse/issues/71853). [#71958](https://github.com/ClickHouse/ClickHouse/pull/71958) ([pufit](https://github.com/pufit)).
* Избегает паузы после выполнения `ALTER TABLE REPLACE/MOVE PARTITION FROM/TO TABLE`. Корректно получает настройки для планирования фоновых задач. [#72024](https://github.com/ClickHouse/ClickHouse/pull/72024) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Исправлена обработка пустых кортежей в некоторых входных и выходных форматах (например, Parquet, Arrow). [#72616](https://github.com/ClickHouse/ClickHouse/pull/72616) ([Michael Kolupaev](https://github.com/al13n321)).
* Оператор `GRANT SELECT/INSERT` на уровне столбцов для баз данных/таблиц, заданных с использованием подстановочных символов, теперь приводит к ошибке. [#72646](https://github.com/ClickHouse/ClickHouse/pull/72646) ([Johann Gan](https://github.com/johanngan)).
* Исправлена ситуация, когда пользователь не может выполнить `REVOKE ALL ON *.*` из‑за неявно выданных прав у целевого объекта доступа. [#72872](https://github.com/ClickHouse/ClickHouse/pull/72872) ([pufit](https://github.com/pufit)).
* Исправлено форматирование положительных временных зон в скалярной функции formatDateTime. [#73091](https://github.com/ClickHouse/ClickHouse/pull/73091) ([ollidraese](https://github.com/ollidraese)).
* Исправлена корректная установка исходного порта при соединении через PROXYv1 и включённом `auth_use_forwarded_address` — ранее использовался порт прокси. Добавлена функция `currentQueryID()`. [#73095](https://github.com/ClickHouse/ClickHouse/pull/73095) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Передавать настройки формата в `NativeWriter` в `TCPHandler`, чтобы настройки вроде `output_format_native_write_json_as_string` применялись корректно. [#73179](https://github.com/ClickHouse/ClickHouse/pull/73179) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка, приводившая к сбою в StorageObjectStorageQueue. [#73274](https://github.com/ClickHouse/ClickHouse/pull/73274) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен редкий сбой в обновляемом материализованном представлении при остановке сервера. [#73323](https://github.com/ClickHouse/ClickHouse/pull/73323) ([Michael Kolupaev](https://github.com/al13n321)).
* Плейсхолдер `%f` функции `formatDateTime` теперь всегда выводит шесть (дробных) цифр. Это делает поведение совместимым с функцией MySQL `DATE_FORMAT`. Предыдущее поведение можно восстановить с помощью настройки `formatdatetime_f_prints_scale_number_of_digits = 1`. [#73324](https://github.com/ClickHouse/ClickHouse/pull/73324) ([ollidraese](https://github.com/ollidraese)).
* Исправлена фильтрация по столбцу `_etag` при чтении из хранилища `s3` и табличной функции `s3`. [#73353](https://github.com/ClickHouse/ClickHouse/pull/73353) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка `Not-ready Set is passed as the second argument for function 'in'`, возникающая при использовании `IN (subquery)` в выражении `JOIN ON` со старым анализатором. [#73382](https://github.com/ClickHouse/ClickHouse/pull/73382) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена подготовка к схлопыванию для столбцов Dynamic и JSON. Ранее в некоторых случаях новые типы могли добавляться в `shared variant`/`shared data`, даже когда ограничение на количество типов/путей ещё не было достигнуто. [#73388](https://github.com/ClickHouse/ClickHouse/pull/73388) ([Pavel Kruglov](https://github.com/Avogar)).
* Проверяйте корректность размеров при бинарном декодировании типов, чтобы избежать чрезмерных выделений памяти. [#73390](https://github.com/ClickHouse/ClickHouse/pull/73390) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена логическая ошибка при чтении из однорепличного кластера при включённых параллельных репликах. [#73403](https://github.com/ClickHouse/ClickHouse/pull/73403) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена работа `ObjectStorageQueue` с ZooKeeper и более старыми версиями Keeper. [#73420](https://github.com/ClickHouse/ClickHouse/pull/73420) ([Antonio Andelic](https://github.com/antonio2368)).
* Реализовано исправление, необходимое для включения секционирования Hive по умолчанию. [#73479](https://github.com/ClickHouse/ClickHouse/pull/73479) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена гонка данных при создании индекса векторного подобия. [#73517](https://github.com/ClickHouse/ClickHouse/pull/73517) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправляет сегфолт, когда источник словаря содержит функцию с некорректными данными. [#73535](https://github.com/ClickHouse/ClickHouse/pull/73535) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлены повторные попытки при неудачной вставке в `storage S3(Azure)Queue`. Закрывает [#70951](https://github.com/ClickHouse/ClickHouse/issues/70951). [#73546](https://github.com/ClickHouse/ClickHouse/pull/73546) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка в функции `tupleElement`, которая в некоторых случаях могла возникать для кортежей с элементами типа `LowCardinality` при включённой настройке `optimize_functions_to_subcolumns`. [#73548](https://github.com/ClickHouse/ClickHouse/pull/73548) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен разбор `enum` с шаблоном (glob), за которым следует диапазон. Исправляет [#73473](https://github.com/ClickHouse/ClickHouse/issues/73473). [#73569](https://github.com/ClickHouse/ClickHouse/pull/73569) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлена проблема, из-за которой parallel&#95;replicas&#95;for&#95;non&#95;replicated&#95;merge&#95;tree игнорировался в подзапросах для нереплицируемых таблиц. [#73584](https://github.com/ClickHouse/ClickHouse/pull/73584) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправление ошибки `std::logical_error`, возникающей, когда задачу невозможно запланировать. Обнаружено в стресс‑тестах. [#73629](https://github.com/ClickHouse/ClickHouse/pull/73629) ([Alexander Gololobov](https://github.com/davenger)).
* Не интерпретировать запросы в `EXPLAIN SYNTAX`, чтобы избежать логических ошибок из‑за некорректного этапа обработки распределённых запросов. Исправляет [#65205](https://github.com/ClickHouse/ClickHouse/issues/65205). [#73634](https://github.com/ClickHouse/ClickHouse/pull/73634) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена потенциальная несогласованность данных в столбце `Dynamic`. Также исправлена возможная логическая ошибка `Nested columns sizes are inconsistent with local_discriminators column size`. [#73644](https://github.com/ClickHouse/ClickHouse/pull/73644) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка `NOT_FOUND_COLUMN_IN_BLOCK` в запросах с `FINAL` и `SAMPLE`. Исправлен некорректный результат в запросах `SELECT` с `FINAL` из `CollapsingMergeTree` и включены оптимизации `FINAL`. [#73682](https://github.com/ClickHouse/ClickHouse/pull/73682) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено падение при использовании LIMIT BY COLUMNS. [#73686](https://github.com/ClickHouse/ClickHouse/pull/73686) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена ошибка, при которой при принудительном использовании обычной проекции и выполнении запроса, в точности совпадающего с определением проекции, эта проекция не выбиралась и, соответственно, возникала ошибка. [#73700](https://github.com/ClickHouse/ClickHouse/pull/73700) ([Shichao Jin](https://github.com/jsc0218)).
* Исправлена десериализация структур Dynamic/Object. Это могло приводить к исключениям CANNOT&#95;READ&#95;ALL&#95;DATA. [#73767](https://github.com/ClickHouse/ClickHouse/pull/73767) ([Pavel Kruglov](https://github.com/Avogar)).
* Пропускать `metadata_version.txt` при восстановлении партов из резервной копии. [#73768](https://github.com/ClickHouse/ClickHouse/pull/73768) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена ошибка сегментации при приведении к типу Enum с использованием LIKE. [#73775](https://github.com/ClickHouse/ClickHouse/pull/73775) ([zhanglistar](https://github.com/zhanglistar)).
* Исправлена проблема, из-за которой бакет S3 Express не работал как диск. [#73777](https://github.com/ClickHouse/ClickHouse/pull/73777) ([Sameer Tamsekar](https://github.com/stamsekar)).
* Разрешено объединение строк с некорректными значениями столбца `sign` в таблицах `CollapsingMergeTree`. [#73864](https://github.com/ClickHouse/ClickHouse/pull/73864) ([Christoph Wurm](https://github.com/cwurm)).
* Исправлена ошибка, возникавшая при выполнении запроса `ddl` с офлайн-репликой. [#73876](https://github.com/ClickHouse/ClickHouse/pull/73876) ([Tuan Pham Anh](https://github.com/tuanpach)).
* Исправлена редкая ошибка сравнения типов `map()`, возникавшая из‑за возможности создавать `Map` без явного именования (`keys`, `values`) его вложенного кортежа. [#73878](https://github.com/ClickHouse/ClickHouse/pull/73878) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Игнорировать оконные функции при разборе предложения GROUP BY ALL. Исправление [#73501](https://github.com/ClickHouse/ClickHouse/issues/73501). [#73916](https://github.com/ClickHouse/ClickHouse/pull/73916) ([Dmitry Novik](https://github.com/novikd)).
* Исправлены неявные привилегии (ранее работали как шаблон с подстановкой). [#73932](https://github.com/ClickHouse/ClickHouse/pull/73932) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено высокое потребление памяти при создании вложенных `Map`. [#73982](https://github.com/ClickHouse/ClickHouse/pull/73982) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен парсинг вложенного JSON с пустыми ключами. [#73993](https://github.com/ClickHouse/ClickHouse/pull/73993) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправление: псевдоним мог не добавляться в проекцию, если на него ссылается другой псевдоним и он указан в запросе позже. [#74033](https://github.com/ClickHouse/ClickHouse/pull/74033) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Игнорировать ошибки «object not found» для Azure во время инициализации диска plain&#95;rewritable. [#74059](https://github.com/ClickHouse/ClickHouse/pull/74059) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлено поведение `any` и `anyLast` с типами enum и пустой таблицей. [#74061](https://github.com/ClickHouse/ClickHouse/pull/74061) ([Joanna Hulboj](https://github.com/jh0x)).
* Исправляет случай, когда пользователь указывает именованные аргументы в движке таблицы Kafka. [#74064](https://github.com/ClickHouse/ClickHouse/pull/74064) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена смена формата настроек хранилища `S3Queue` с префиксом &quot;s3queue&#95;&quot; на вариант без него и обратно. [#74075](https://github.com/ClickHouse/ClickHouse/pull/74075) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена настройка `allow_push_predicate_ast_for_distributed_subqueries`. Она включает push-down предикатов на основе AST для распределённых запросов с analyzer. Это временное решение, которое используется до тех пор, пока не будет добавлена поддержка распределённых запросов с сериализацией плана запроса. Закрывает [#66878](https://github.com/ClickHouse/ClickHouse/issues/66878) [#69472](https://github.com/ClickHouse/ClickHouse/issues/69472) [#65638](https://github.com/ClickHouse/ClickHouse/issues/65638) [#68030](https://github.com/ClickHouse/ClickHouse/issues/68030) [#73718](https://github.com/ClickHouse/ClickHouse/issues/73718). [#74085](https://github.com/ClickHouse/ClickHouse/pull/74085) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена проблема, из-за которой после [#73095](https://github.com/ClickHouse/ClickHouse/issues/73095) порт мог присутствовать в поле forwarded&#95;for, что приводило к невозможности разрешить имя хоста вместе с портом. [#74116](https://github.com/ClickHouse/ClickHouse/pull/74116) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлено некорректное форматирование конструкции `ALTER TABLE (DROP STATISTICS ...) (DROP STATISTICS ...)`. [#74126](https://github.com/ClickHouse/ClickHouse/pull/74126) ([Han Fei](https://github.com/hanfei1991)).
* Исправление для задачи [#66112](https://github.com/ClickHouse/ClickHouse/issues/66112). [#74128](https://github.com/ClickHouse/ClickHouse/pull/74128) ([Anton Ivashkin](https://github.com/ianton-ru)).
* Больше нельзя использовать `Loop` в качестве движка таблицы в `CREATE TABLE`. Это сочетание ранее приводило к ошибкам сегментации. [#74137](https://github.com/ClickHouse/ClickHouse/pull/74137) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена уязвимость безопасности, предотвращающая SQL-инъекции в табличных функциях `postgresql` и `sqlite`. [#74144](https://github.com/ClickHouse/ClickHouse/pull/74144) ([Pablo Marcos](https://github.com/pamarcos)).
* Исправлено падение при чтении подстолбца из сжатой таблицы движка Memory. Исправляет [#74009](https://github.com/ClickHouse/ClickHouse/issues/74009). [#74161](https://github.com/ClickHouse/ClickHouse/pull/74161) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлен бесконечный цикл, возникавший при запросах к system.detached&#95;tables. [#74190](https://github.com/ClickHouse/ClickHouse/pull/74190) ([Konstantin Morozov](https://github.com/k-morozov)).
* Исправлена логическая ошибка в `s3queue` при пометке файла как сбойного. [#74216](https://github.com/ClickHouse/ClickHouse/pull/74216) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлены настройки нативного копирования (`allow_s3_native_copy`/`allow_azure_native_copy`) для `RESTORE` из базовой резервной копии. [#74286](https://github.com/ClickHouse/ClickHouse/pull/74286) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема, возникавшая, когда число отсоединённых таблиц в базе данных кратно значению max&#95;block&#95;size. [#74289](https://github.com/ClickHouse/ClickHouse/pull/74289) ([Konstantin Morozov](https://github.com/k-morozov)).
* Исправлено копирование через ObjectStorage (например, S3), когда учетные данные источника и назначения различаются. [#74331](https://github.com/ClickHouse/ClickHouse/pull/74331) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено определение параметра «использовать метод Rewrite в JSON API» для нативного копирования в GCS. [#74338](https://github.com/ClickHouse/ClickHouse/pull/74338) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен некорректный расчет `BackgroundMergesAndMutationsPoolSize` (он был в 2 раза больше фактического значения). [#74509](https://github.com/ClickHouse/ClickHouse/pull/74509) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка утечки наблюдателей Keeper при включении Cluster Discovery. [#74521](https://github.com/ClickHouse/ClickHouse/pull/74521) ([RinChanNOW](https://github.com/RinChanNOWWW)).
* Исправлена проблема с выравниванием памяти, обнаруженная UBSan [#74512](https://github.com/ClickHouse/ClickHouse/issues/74512). [#74534](https://github.com/ClickHouse/ClickHouse/pull/74534) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлена конкурентная очистка KeeperMap при создании таблицы. [#74568](https://github.com/ClickHouse/ClickHouse/pull/74568) ([Antonio Andelic](https://github.com/antonio2368)).
* Не удалять неиспользуемые столбцы проекций в подзапросах при наличии `EXCEPT` или `INTERSECT`, чтобы сохранить корректный результат запроса. Исправление [#73930](https://github.com/ClickHouse/ClickHouse/issues/73930). Исправление [#66465](https://github.com/ClickHouse/ClickHouse/issues/66465). [#74577](https://github.com/ClickHouse/ClickHouse/pull/74577) ([Dmitry Novik](https://github.com/novikd)).
* Исправлены запросы `INSERT SELECT` между таблицами с колонками типа `Tuple` при включённой разрежённой (sparse) сериализации. [#74698](https://github.com/ClickHouse/ClickHouse/pull/74698) ([Anton Popov](https://github.com/CurtizJ)).
* Функция `right` работает некорректно для константного отрицательного смещения. [#74701](https://github.com/ClickHouse/ClickHouse/pull/74701) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлена ошибка, из-за которой вставка gzip-сжатых данных иногда завершалась неудачно из-за некорректной распаковки на стороне клиента. [#74707](https://github.com/ClickHouse/ClickHouse/pull/74707) ([siyuan](https://github.com/linkwk7)).
* Частичный отзыв прав при использовании маскирующих `GRANT` мог удалять больше привилегий, чем ожидалось. Закрывает [#74263](https://github.com/ClickHouse/ClickHouse/issues/74263). [#74751](https://github.com/ClickHouse/ClickHouse/pull/74751) ([pufit](https://github.com/pufit)).
* Исправление в Keeper: устранена ошибка чтения записей журнала с диска. [#74785](https://github.com/ClickHouse/ClickHouse/pull/74785) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена проверка прав для SYSTEM REFRESH/START/STOP VIEW: теперь для выполнения запроса к конкретному представлению не требуется иметь это право на `*.*`, достаточно права на само это представление. [#74789](https://github.com/ClickHouse/ClickHouse/pull/74789) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Функция `hasColumnInTable` не учитывает столбцы-псевдонимы. Исправлена, чтобы также работать со столбцами-псевдонимами. [#74841](https://github.com/ClickHouse/ClickHouse/pull/74841) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлена ошибка FILE&#95;DOESNT&#95;EXIST, возникавшая при слиянии кусков данных таблицы с пустым столбцом в Azure Blob Storage. [#74892](https://github.com/ClickHouse/ClickHouse/pull/74892) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлено имя столбца проекции при соединении временных таблиц, закрыта задача [#68872](https://github.com/ClickHouse/ClickHouse/issues/68872). [#74897](https://github.com/ClickHouse/ClickHouse/pull/74897) ([Vladimir Cherkasov](https://github.com/vdimir)).



#### Улучшения сборки, тестирования и упаковки
* Универсальный скрипт установки теперь будет предлагать установку и на macOS. [#74339](https://github.com/ClickHouse/ClickHouse/pull/74339) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
