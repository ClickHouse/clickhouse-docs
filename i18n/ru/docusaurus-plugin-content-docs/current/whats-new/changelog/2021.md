---
slug: /whats-new/changelog/2021
sidebar_position: 6
sidebar_label: '2021'
title: 'Список изменений за 2021 год'
description: 'Список изменений за 2021 год'
doc_type: 'changelog'
keywords: ['ClickHouse 2021', 'список изменений 2021', 'заметки о выпуске', 'история версий', 'новые функции']
---

### Релиз ClickHouse v21.12, 2021-12-15. [Презентация](https://presentations.clickhouse.com/2021-release-21.12/), [Видео](https://www.youtube.com/watch?v=6qi_S9CEqa4) {#clickhouse-release-v2112-2021-12-15}

<iframe width="1024" height="576" src="https://www.youtube.com/embed/6qi_S9CEqa4" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

#### Изменения, нарушающие обратную совместимость {#backward-incompatible-change}

* *Исправление функции, которая ранее вела себя нежелательным образом.* Запрещён прямой select для Kafka/RabbitMQ/FileLog. Его можно включить с помощью настройки `stream_like_engine_allow_direct_select`. Прямой select не будет разрешён даже при включённой настройке, если есть присоединённое материализованное представление. Для Kafka и RabbitMQ прямой select, если он разрешён, по умолчанию не будет фиксировать сообщения (commit). Чтобы включить коммиты при прямом select, пользователь должен использовать настройку на уровне хранилища `kafka{rabbitmq}_commit_on_select=1` (по умолчанию `0`). [#31053](https://github.com/ClickHouse/ClickHouse/pull/31053) ([Kseniia Sumarokova](https://github.com/kssenii)).
* *Незначительное изменение поведения новой функции.* Возвращать строку без кавычек в JSON_VALUE. Закрывает [#27965](https://github.com/ClickHouse/ClickHouse/issues/27965). [#31008](https://github.com/ClickHouse/ClickHouse/pull/31008) ([Kseniia Sumarokova](https://github.com/kssenii)).
* *Переименование настройки.* Добавлена поддержка пользовательского представления значений null для входных форматов TSV/CSV. Исправлена десериализация Nullable(String) во входных форматах TSV/CSV/JSONCompactStringsEachRow/JSONStringsEachRow. Настройки `output_format_csv_null_representation` и `output_format_tsv_null_representation` переименованы соответственно в `format_csv_null_representation` и `format_tsv_null_representation`. [#30497](https://github.com/ClickHouse/ClickHouse/pull/30497) ([Kruglov Pavel](https://github.com/Avogar)).
* *Дальнейшее удаление уже неиспользуемого кода.* Это актуально только для пользователей версий ClickHouse ранее 20.6. Механизм «выбора лидера» удалён из `ReplicatedMergeTree`, так как несколько лидеров поддерживаются начиная с 20.6. Если вы обновляетесь со старой версии и некоторая реплика со старой версией является лидером, то сервер не сможет запуститься после обновления. Остановите реплики со старой версией, чтобы новая версия смогла стартовать. После этого будет невозможно откатиться на версию ниже 20.6. [#32140](https://github.com/ClickHouse/ClickHouse/pull/32140) ([tavplubix](https://github.com/tavplubix)).

#### Новая возможность {#new-feature}

* Реализовано больше команд из набора ZooKeeper Four Letter Words в clickhouse-keeper: [https://zookeeper.apache.org/doc/r3.4.8/zookeeperAdmin.html#sc&#95;zkCommands](https://zookeeper.apache.org/doc/r3.4.8/zookeeperAdmin.html#sc_zkCommands). [#28981](https://github.com/ClickHouse/ClickHouse/pull/28981) ([JackyWoo](https://github.com/JackyWoo)). Теперь `clickhouse-keeper` обладает полной функциональностью.
* Поддержка типа данных `Bool`. [#31072](https://github.com/ClickHouse/ClickHouse/pull/31072) ([kevin wan](https://github.com/MaxWk)).
* Добавлена поддержка `PARTITION BY` в хранилищах File, URL, HDFS и для табличной функции `INSERT INTO`. Закрывает [#30273](https://github.com/ClickHouse/ClickHouse/issues/30273). [#30690](https://github.com/ClickHouse/ClickHouse/pull/30690) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлен `CONSTRAINT ... ASSUME ...` (без проверки при `INSERT`). Добавлено преобразование запроса в КНФ ([https://github.com/ClickHouse/ClickHouse/issues/11749](https://github.com/ClickHouse/ClickHouse/issues/11749)) для более удобной оптимизации. Добавлено простое переписывание запросов с использованием ограничений (сейчас поддерживается только простое сопоставление, в дальнейшем будет расширено для поддержки &lt;,=,&gt;...). Добавлена возможность заменять «тяжёлые» столбцы «лёгкими» столбцами, если это возможно. [#18787](https://github.com/ClickHouse/ClickHouse/pull/18787) ([Nikita Vasilev](https://github.com/nikvas0)).
* Базовая аутентификация для функций HTTP/URL. [#31648](https://github.com/ClickHouse/ClickHouse/pull/31648) ([michael1589](https://github.com/michael1589)).
* Добавлена поддержка использования типа `INTERVAL` в предложении `STEP` для модификатора `WITH FILL`. [#30927](https://github.com/ClickHouse/ClickHouse/pull/30927) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена поддержка параллельного чтения из нескольких файлов, а также glob-шаблонов в конструкции `FROM INFILE`. [#30135](https://github.com/ClickHouse/ClickHouse/pull/30135) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* Добавлена поддержка параметров запросов для таблиц и баз данных типа `Identifier`. Закрывает [#27226](https://github.com/ClickHouse/ClickHouse/issues/27226). [#28668](https://github.com/ClickHouse/ClickHouse/pull/28668) ([Nikolay Degterinsky](https://github.com/evillique)).
* *Кратко: существенные улучшения полноты и согласованности текстовых форматов.* Рефакторинг форматов `TSV`, `TSVRaw`, `CSV` и `JSONCompactEachRow`, `JSONCompactStringsEachRow`, удаление дублирующегося кода, добавление базового интерфейса для форматов с суффиксами `-WithNames` и `-WithNamesAndTypes`. Добавлены форматы `CSVWithNamesAndTypes`, `TSVRawWithNames`, `TSVRawWithNamesAndTypes`, `JSONCompactEachRowWIthNames`, `JSONCompactStringsEachRowWIthNames`, `RowBinaryWithNames`. Добавлена поддержка параллельного парсинга для форматов `TSVWithNamesAndTypes`, `TSVRaw(WithNames/WIthNamesAndTypes)`, `CSVWithNamesAndTypes`, `JSONCompactEachRow(WithNames/WIthNamesAndTypes)`, `JSONCompactStringsEachRow(WithNames/WIthNamesAndTypes)`. Добавлена поддержка сопоставления столбцов и проверки типов для формата `RowBinaryWithNamesAndTypes`. Добавлена настройка `input_format_with_types_use_header`, которая задаёт, нужно ли проверять, что типы, записанные в формате `<format_name>WIthNamesAndTypes`, совпадают со структурой таблицы. Добавлена настройка `input_format_csv_empty_as_default`, которая используется в формате CSV вместо `input_format_defaults_for_omitted_fields` (поскольку эта настройка не должна управлять поведением `csv_empty_as_default`). Исправлено использование настройки `input_format_defaults_for_omitted_fields` (она использовалась только как `csv_empty_as_default`, но должна управлять вычислением значений по умолчанию для опущенных полей). Исправлен ввод/вывод Nullable в формате `TSVRaw`, этот формат сделан полностью совместимым со вставкой в TSV. Исправлена вставка значений NULL в `LowCardinality(Nullable)` при включённой настройке `input_format_null_as_default` (ранее вставлялись значения по умолчанию вместо реальных NULL). Исправлена десериализация строк в форматах `JSONStringsEachRow`/`JSONCompactStringsEachRow` (строки парсились только до первого символа &#39;\n&#39; или &#39;\t&#39;). Добавлена возможность использовать правило экранирования `Raw` во входном формате `Template`. Добавлена диагностическая информация для входного формата `JSONCompactEachRow(WithNames/WIthNamesAndTypes)`. Исправлена ошибка при параллельном парсинге форматов `-WithNames` в случае, когда значение настройки `min_chunk_bytes_for_parallel_parsing` меньше размера одной строки в байтах. [#30178](https://github.com/ClickHouse/ClickHouse/pull/30178) ([Kruglov Pavel](https://github.com/Avogar)). Добавлена возможность выводить и парсить имена и типы столбцов во входном/выходном формате `CustomSeparated`. Добавлены форматы `CustomSeparatedWithNames/WithNamesAndTypes`, аналогичные `TSVWithNames/WithNamesAndTypes`. [#31434](https://github.com/ClickHouse/ClickHouse/pull/31434) ([Kruglov Pavel](https://github.com/Avogar)).
* Поддержка хранилища Aliyun OSS. [#31286](https://github.com/ClickHouse/ClickHouse/pull/31286) ([cfcz48](https://github.com/cfcz48)).
* Делает доступными все параметры глобального пула потоков в конфигурационном файле. [#31285](https://github.com/ClickHouse/ClickHouse/pull/31285) ([Tomáš Hromada](https://github.com/gyfis)).
* Добавлены оконные функции `exponentialTimeDecayedSum`, `exponentialTimeDecayedMax`, `exponentialTimeDecayedCount` и `exponentialTimeDecayedAvg`, которые более эффективны, чем `exponentialMovingAverage`, для больших окон. Также охвачено больше сценариев использования. [#29799](https://github.com/ClickHouse/ClickHouse/pull/29799) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Добавлена возможность сжимать логи перед записью в файл с помощью LZ4. Закрывает [#23860](https://github.com/ClickHouse/ClickHouse/issues/23860). [#29219](https://github.com/ClickHouse/ClickHouse/pull/29219) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена поддержка конструкций `JOIN ON 1 = 1`, которые имеют семантику CROSS JOIN. Это закрывает [#25578](https://github.com/ClickHouse/ClickHouse/issues/25578). [#25894](https://github.com/ClickHouse/ClickHouse/pull/25894) ([Vladimir C](https://github.com/vdimir)).
* Добавлен комбинатор Map для типа `Map`. Также старые функции `sum-, min-, max- Map` для отображённых массивов переименованы в `sum-, min-, max- MappedArrays`. [#24539](https://github.com/ClickHouse/ClickHouse/pull/24539) ([Ildus Kurbangaliev](https://github.com/ildus)).
* Сделать чтение по HTTP операцией с поддержкой повторных попыток. Закрывает [#29696](https://github.com/ClickHouse/ClickHouse/issues/29696). [#29894](https://github.com/ClickHouse/ClickHouse/pull/29894) ([Kseniia Sumarokova](https://github.com/kssenii)).

#### Экспериментальная возможность {#experimental-feature}

* `WINDOW VIEW` для реализации потоковой обработки в ClickHouse. [#8331](https://github.com/ClickHouse/ClickHouse/pull/8331) ([vxider](https://github.com/Vxider)).
* Прекращена поддержка использования баз данных типа Ordinary с `MaterializedMySQL`. [#31292](https://github.com/ClickHouse/ClickHouse/pull/31292) ([Stig Bakken](https://github.com/stigsb)).
* Реализованы команды BACKUP и RESTORE для семейства таблиц Log. Эта функция находится в разработке. [#30688](https://github.com/ClickHouse/ClickHouse/pull/30688) ([Vitaly Baranov](https://github.com/vitlibar)).

#### Улучшение производительности {#performance-improvement}

* Снижено потребление памяти при чтении форматов `Parquet`, `ORC`, `Arrow` через `s3` / `url` / `hdfs` (эта оптимизация управляется настройкой `input_format_allow_seeks`, которая по умолчанию включена). Также добавлена настройка `remote_read_min_bytes_for_seek` для управления seek‑операциями. Закрывает [#10461](https://github.com/ClickHouse/ClickHouse/issues/10461). Закрывает [#16857](https://github.com/ClickHouse/ClickHouse/issues/16857). [#30936](https://github.com/ClickHouse/ClickHouse/pull/30936) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлены оптимизации для константных условий в JOIN ON, см. [#26928](https://github.com/ClickHouse/ClickHouse/issues/26928). [#27021](https://github.com/ClickHouse/ClickHouse/pull/27021) ([Vladimir C](https://github.com/vdimir)).
* Добавлена поддержка параллельного форматирования для всех текстовых форматов, за исключением `JSONEachRowWithProgress` и `PrettyCompactMonoBlock`. [#31489](https://github.com/ClickHouse/ClickHouse/pull/31489) ([Kruglov Pavel](https://github.com/Avogar)).
* Ускорен подсчёт количества для nullable‑столбцов. [#31806](https://github.com/ClickHouse/ClickHouse/pull/31806) ([Raúl Marín](https://github.com/Algunenano)).
* Ускорены агрегатные функции `avg` и `sumCount`. [#31694](https://github.com/ClickHouse/ClickHouse/pull/31694) ([Raúl Марин](https://github.com/Algunenano)).
* Повышена производительность форматов вывода JSON и XML. [#31673](https://github.com/ClickHouse/ClickHouse/pull/31673) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Повышена производительность синхронизации данных с блочным устройством. Закрывает [#31181](https://github.com/ClickHouse/ClickHouse/issues/31181). [#31229](https://github.com/ClickHouse/ClickHouse/pull/31229) ([zhanglistar](https://github.com/zhanglistar)).
* Исправлена проблема с производительностью запросов в таблицах `LiveView`. Исправляет [#30831](https://github.com/ClickHouse/ClickHouse/issues/30831). [#31006](https://github.com/ClickHouse/ClickHouse/pull/31006) ([vzakaznikov](https://github.com/vzakaznikov)).
* Ускорен разбор запросов. [#31949](https://github.com/ClickHouse/ClickHouse/pull/31949) ([Raúl Марин](https://github.com/Algunenano)).
* Добавлена возможность разделять правила rollup в `GraphiteMergeTree` для обычных/помеченных метрик (необязательное поле `rule_type`). [#25122](https://github.com/ClickHouse/ClickHouse/pull/25122) ([Michail Safronov](https://github.com/msaf1980)).
* Удалены избыточные запросы `DESC TABLE` для `remote()` (в случае `remote('127.1', system.one)` (т. е. идентификатор в виде db.table вместо строки) выполнялся избыточный запрос `DESC TABLE`). [#32019](https://github.com/ClickHouse/ClickHouse/pull/32019) ([Azat Khuzhin](https://github.com/azat)).
* Оптимизирована функция `tupleElement` для чтения подколонки при включённой настройке `optimize_functions_to_subcolumns`. [#31261](https://github.com/ClickHouse/ClickHouse/pull/31261) ([Anton Popov](https://github.com/CurtizJ)).
* Оптимизирована функция `mapContains` для чтения подколонки `key` при включённой настройке `optimize_functions_to_subcolumns`. [#31218](https://github.com/ClickHouse/ClickHouse/pull/31218) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлены настройки `merge_tree_min_rows_for_concurrent_read_for_remote_filesystem` и `merge_tree_min_bytes_for_concurrent_read_for_remote_filesystem`. [#30970](https://github.com/ClickHouse/ClickHouse/pull/30970) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Реализован пропуск мутаций для различных партиций в `StorageMergeTree`. [#21326](https://github.com/ClickHouse/ClickHouse/pull/21326) ([Vladimir Chebotarev](https://github.com/excitoon)).

#### Улучшения {#improvement}

* Запретить удаление таблицы или словаря, если от них зависят другие таблицы или словари. [#30977](https://github.com/ClickHouse/ClickHouse/pull/30977) ([tavplubix](https://github.com/tavplubix)).
* Добавлена возможность версионирования состояний агрегатных функций. Теперь мы можем вносить обратно-совместимые изменения в формат сериализации состояний агрегатных функций. Закрывает [#12552](https://github.com/ClickHouse/ClickHouse/issues/12552). [#24820](https://github.com/ClickHouse/ClickHouse/pull/24820) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка синтаксиса `ALTER MODIFY COLUMN` в стиле PostgreSQL. [#32003](https://github.com/ClickHouse/ClickHouse/pull/32003) ([SuperDJY](https://github.com/cmsxbc)).
* Добавлена поддержка `update_field` для `RangeHashedDictionary`, `ComplexKeyRangeHashedDictionary`. [#32185](https://github.com/ClickHouse/ClickHouse/pull/32185) ([Maksim Kita](https://github.com/kitaisreal)).
* Функции `murmurHash3_128` и `sipHash128` теперь принимают произвольное количество аргументов. Это устраняет проблему, описанную в [#28774](https://github.com/ClickHouse/ClickHouse/issues/28774). [#28965](https://github.com/ClickHouse/ClickHouse/pull/28965) ([小路](https://github.com/nicelulu)).
* Добавлена поддержка выражений по умолчанию для хранилища `HDFS` и оптимизировано извлечение данных, когда источник является колоночным. [#32256](https://github.com/ClickHouse/ClickHouse/pull/32256) ([李扬](https://github.com/taiyang-li)).
* Улучшено имя операции для спана OpenTelemetry. [#32234](https://github.com/ClickHouse/ClickHouse/pull/32234) ([Frank Chen](https://github.com/FrankChen021)).
* Используйте `Content-Type: application/x-ndjson` ([http://ndjson.org/](http://ndjson.org/)) для формата вывода `JSONEachRow`. [#32223](https://github.com/ClickHouse/ClickHouse/pull/32223) ([Dmitriy Dorофеев](https://github.com/deem0n)).
* Улучшен пропуск неизвестных полей при использовании правила экранирования в кавычках в форматах Template/CustomSeparated. Ранее можно было пропускать только строковые значения в кавычках, теперь можно пропускать значения любого типа. [#32204](https://github.com/ClickHouse/ClickHouse/pull/32204) ([Kruglov Pavel](https://github.com/Avogar)).
* Теперь `clickhouse-keeper` отказывается запускаться или применять изменения конфигурации, если в них есть дублирующиеся идентификаторы или конечные точки. Исправляет [#31339](https://github.com/ClickHouse/ClickHouse/issues/31339). [#32121](https://github.com/ClickHouse/ClickHouse/pull/32121) ([alesapin](https://github.com/alesapin)).
* Устанавливать заголовок Content-Type в HTTP-запросах, генерируемых движком URL. [#32113](https://github.com/ClickHouse/ClickHouse/pull/32113) ([Frank Chen](https://github.com/FrankChen021)).
* Возвращать заголовок Content-Type со значением &#39;application/json&#39; для формата `JSONEachRow`, если включен `output_format_json_array_of_rows`. [#32112](https://github.com/ClickHouse/ClickHouse/pull/32112) ([Frank Chen](https://github.com/FrankChen021)).
* Добавлена поддержка разбора знака `+` перед значениями типов `Float32`/`Float64`. [#32079](https://github.com/ClickHouse/ClickHouse/pull/32079) ([Kruglov Pavel](https://github.com/Avogar)).
* Разрешена настройка пользователем параметра `hdfs_replication` для `DiskHDFS` и `StorageHDFS`. Закрывает [#32039](https://github.com/ClickHouse/ClickHouse/issues/32039). [#32049](https://github.com/ClickHouse/ClickHouse/pull/32049) ([leosunli](https://github.com/leosunli)).
* Добавлены поля ClickHouse `exception` и `exception_code` в span-лог OpenTelemetry. [#32040](https://github.com/ClickHouse/ClickHouse/pull/32040) ([Frank Chen](https://github.com/FrankChen021)).
* Улучшена обработка длительности логов спанов OpenTelemetry — ранее на уровне запроса она становилась равной нулю, если при выполнении запроса возникало исключение. [#32038](https://github.com/ClickHouse/ClickHouse/pull/32038) ([Frank Chen](https://github.com/FrankChen021)).
* Исправлена проблема, из-за которой нельзя было создать `LowCardinality` для `Int256`. [#31832](https://github.com/ClickHouse/ClickHouse/pull/31832) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Таблицы `system.*_log` пересоздаются в случае изменения движка или выражения `partition_by`. [#31824](https://github.com/ClickHouse/ClickHouse/pull/31824) ([Azat Khuzhin](https://github.com/azat)).
* `MaterializedMySQL`: Исправлена ошибка при работе с таблицей с именем &#39;table&#39;. [#31781](https://github.com/ClickHouse/ClickHouse/pull/31781) ([Håvard Kvålen](https://github.com/havardk)).
* Источник словаря ClickHouse: поддержка предопределённых подключений. Закрывает [#31705](https://github.com/ClickHouse/ClickHouse/issues/31705). [#31749](https://github.com/ClickHouse/ClickHouse/pull/31749) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена возможность использовать предопределённые конфигурации подключений для движков Kafka и RabbitMQ (аналогично другим интеграционным табличным движкам). [#31691](https://github.com/ClickHouse/ClickHouse/pull/31691) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Всегда заново отображать приглашение при перемещении по истории в clickhouse-client. Это улучшит удобство работы с очень длинными запросами, которые не помещаются на экран. [#31675](https://github.com/ClickHouse/ClickHouse/pull/31675) ([alexey-milovidov](https://github.com/alexey-milovidov)) (автор: Amos Bird).
* Добавить сочетания клавиш для перемещения по истории (вместо lines/history). [#31641](https://github.com/ClickHouse/ClickHouse/pull/31641) ([Azat Khuzhin](https://github.com/azat)).
* Улучшены проверки параметра `max_execution_time`. Исправлены некоторые случаи, когда проверки тайм‑аута не выполнялись и запрос мог выполняться слишком долго. [#31636](https://github.com/ClickHouse/ClickHouse/pull/31636) ([Raúl Marín](https://github.com/Algunenano)).
* Улучшено сообщение об исключении, когда `users.xml` невозможно загрузить из‑за некорректного хеша пароля. Это закрывает [#24126](https://github.com/ClickHouse/ClickHouse/issues/24126). [#31557](https://github.com/ClickHouse/ClickHouse/pull/31557) ([Vitaly Baranov](https://github.com/vitlibar)).
* Использовать имена шарда и реплики из аргументов базы данных `Replicated` при расширении макросов в аргументах `ReplicatedMergeTree`, если эти макросы не определены в конфигурации. Закрывает [#31471](https://github.com/ClickHouse/ClickHouse/issues/31471). [#31488](https://github.com/ClickHouse/ClickHouse/pull/31488) ([tavplubix](https://github.com/tavplubix)).
* Улучшен анализ проекции `min/max/count`. Теперь при включённом параметре `allow_experimental_projection_optimization` виртуальная проекция `min/max/count` может использоваться вместе со столбцами из ключа партиционирования. [#31474](https://github.com/ClickHouse/ClickHouse/pull/31474) ([Amos Bird](https://github.com/amosbird)).
* Добавлена поддержка параметра `--pager` для `clickhouse-local`. [#31457](https://github.com/ClickHouse/ClickHouse/pull/31457) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено поведение ожидания редактора во время интерактивного редактирования запроса (`waitpid()` возвращает -1 при `SIGWINCH`, а `EDITOR` и `clickhouse-local`/`clickhouse-client` работают одновременно). [#31456](https://github.com/ClickHouse/ClickHouse/pull/31456) ([Azat Khuzhin](https://github.com/azat)).
* Выбрасывать исключение, если после поля в формате `JSONCompactStrings(EachRow)` присутствуют лишние данные. [#31455](https://github.com/ClickHouse/ClickHouse/pull/31455) ([Kruglov Pavel](https://github.com/Avogar)).
* Значение по умолчанию для настроек `http_send_timeout` и `http_receive_timeout` изменено с 1800 (30 минут) на 180 (3 минуты). [#31450](https://github.com/ClickHouse/ClickHouse/pull/31450) ([tavplubix](https://github.com/tavplubix)).
* `MaterializedMySQL` теперь обрабатывает DDL-запросы `CREATE TABLE ... LIKE ...`. [#31410](https://github.com/ClickHouse/ClickHouse/pull/31410) ([Stig Bakken](https://github.com/stigsb)).
* Возвращать синтетический запрос CREATE при выполнении `SHOW CREATE TABLE` для системных таблиц. [#31391](https://github.com/ClickHouse/ClickHouse/pull/31391) ([SuperDJY](https://github.com/cmsxbc)).
* Ранее прогресс отображался только для табличной функции `numbers`. Теперь он также отображается для `numbers_mt`. [#31318](https://github.com/ClickHouse/ClickHouse/pull/31318) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исходные роли пользователя теперь используются для поиска политик строк, см. [#31080](https://github.com/ClickHouse/ClickHouse/issues/31080). [#31262](https://github.com/ClickHouse/ClickHouse/pull/31262) ([Vitaly Baranov](https://github.com/vitlibar)).
* При изменении устаревшей настройки выводить предупреждение в `system.warnings`. [#31252](https://github.com/ClickHouse/ClickHouse/pull/31252) ([tavplubix](https://github.com/tavplubix)).
* Улучшен механизм backoff для фоновых задач очистки в `MergeTree`. Настройки `merge_tree_clear_old_temporary_directories_interval_seconds` и `merge_tree_clear_old_parts_interval_seconds` перенесены из пользовательских настроек в настройки движка MergeTree. [#31180](https://github.com/ClickHouse/ClickHouse/pull/31180) ([tavplubix](https://github.com/tavplubix)).
* Теперь каждая реплика будет отправлять клиенту только приращения по счетчикам событий профилирования. [#31155](https://github.com/ClickHouse/ClickHouse/pull/31155) ([Dmitry Novik](https://github.com/novikd)). Это делает опцию `--hardware_utilization` в `clickhouse-client` действительно полезной.
* Включить в clickhouse-client многострочное редактирование по умолчанию. Это устраняет проблему [#31121](https://github.com/ClickHouse/ClickHouse/issues/31121). [#31123](https://github.com/ClickHouse/ClickHouse/pull/31123) ([Amos Bird](https://github.com/amosbird)).
* Нормализация имён функций для запросов `ALTER`. Это помогает избежать несоответствия метаданных между созданием таблицы с индексами/проекциями и добавлением индексов/проекций через команды `ALTER`. Это продолжение PR [https://github.com/ClickHouse/ClickHouse/pull/20174](https://github.com/ClickHouse/ClickHouse/pull/20174). Отнесено к улучшениям, так как не было сообщений об ошибках, а сам сценарий встречается довольно редко. [#31095](https://github.com/ClickHouse/ClickHouse/pull/31095) ([Amos Bird](https://github.com/amosbird)).
* Добавлена поддержка модификатора `IF EXISTS` для запросов `RENAME DATABASE`/`TABLE`/`DICTIONARY`. В этом случае ошибка не возникнет, даже если переименуемая DATABASE/TABLE/DICTIONARY не существует. [#31081](https://github.com/ClickHouse/ClickHouse/pull/31081) ([victorgao](https://github.com/kafka1991)).
* Отменять вертикальные слияния при удалении партиции. Это продолжение изменений из [https://github.com/ClickHouse/ClickHouse/pull/25684](https://github.com/ClickHouse/ClickHouse/pull/25684) и [https://github.com/ClickHouse/ClickHouse/pull/30996](https://github.com/ClickHouse/ClickHouse/pull/30996). [#31057](https://github.com/ClickHouse/ClickHouse/pull/31057) ([Amos Bird](https://github.com/amosbird)).
* Локальная сессия внутри источника словаря ClickHouse больше не будет отправлять свои события в сессионный лог. Это устраняет возможную взаимную блокировку (предупреждение tsan) при завершении работы. Также этот PR исправляет нестабильный тест `test_dictionaries_dependency_xml/`. [#31013](https://github.com/ClickHouse/ClickHouse/pull/31013) ([Vitaly Baranov](https://github.com/vitlibar)).
* Меньше блокировок при операции ALTER. [#31010](https://github.com/ClickHouse/ClickHouse/pull/31010) ([Amos Bird](https://github.com/amosbird)).
* Исправлена опция `--verbose` в интерактивном режиме clickhouse-local и разрешена запись логов в файл. [#30881](https://github.com/ClickHouse/ClickHouse/pull/30881) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлены команды `\l`, `\d`, `\c` в `clickhouse-client` по аналогии с MySQL и PostgreSQL. [#30876](https://github.com/ClickHouse/ClickHouse/pull/30876) ([Pavel Medvedev](https://github.com/pmed)).
* Для clickhouse-local или clickhouse-client: если указана опция `--interactive` вместе с `--query` или `--queries-file`, то они сначала выполняются так же, как в неинтерактивном режиме, а затем запускается интерактивный режим. [#30851](https://github.com/ClickHouse/ClickHouse/pull/30851) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена возможная ошибка &quot;The local set of parts of X doesn&#39;t look like the set of parts in ZooKeeper&quot; (если команда DROP завершалась с ошибкой при удалении znode из ZooKeeper). [#30826](https://github.com/ClickHouse/ClickHouse/pull/30826) ([Azat Khuzhin](https://github.com/azat)).
* Формат Avro теперь работает с Kafka. Добавлена настройка `output_format_avro_rows_in_file`. [#30351](https://github.com/ClickHouse/ClickHouse/pull/30351) ([Ilya Golshtein](https://github.com/ilejn)).
* Позволяет задать одну или несколько схем PostgreSQL для одной базы данных `MaterializedPostgreSQL`. Закрывает [#28901](https://github.com/ClickHouse/ClickHouse/issues/28901). Закрывает [#29324](https://github.com/ClickHouse/ClickHouse/issues/29324). [#28933](https://github.com/ClickHouse/ClickHouse/pull/28933) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Изменены порты по умолчанию, используемые clickhouse-keeper для внутреннего взаимодействия, с 44444 на 9234. Исправляет [#30879](https://github.com/ClickHouse/ClickHouse/issues/30879). [#31799](https://github.com/ClickHouse/ClickHouse/pull/31799) ([alesapin](https://github.com/alesapin)).
* Реализована функция transform с аргументами типа Decimal. [#31839](https://github.com/ClickHouse/ClickHouse/pull/31839) ([李帅](https://github.com/loneylee)).
* Исправлено аварийное завершение на debug-сервере и ошибка `DB::Exception: std::out_of_range: basic_string` на release-сервере при некорректном URL-адресе HDFS путем добавления дополнительной проверки структуры URL-адреса HDFS. [#31042](https://github.com/ClickHouse/ClickHouse/pull/31042) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена возможная ошибка assert в функции/движке таблиц `hdfs`, добавлен тест. [#31036](https://github.com/ClickHouse/ClickHouse/pull/31036) ([Kruglov Pavel](https://github.com/Avogar)).

#### Исправления ошибок {#bug-fixes}

* Исправлена работа псевдонимов в конструкциях GROUP BY / ORDER BY / LIMIT BY при включённых позиционных аргументах. Закрывает [#31173](https://github.com/ClickHouse/ClickHouse/issues/31173). [#31741](https://github.com/ClickHouse/ClickHouse/pull/31741) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено использование движка таблицы `Buffer` с типом данных `Map`. Исправляет [#30546](https://github.com/ClickHouse/ClickHouse/issues/30546). [#31742](https://github.com/ClickHouse/ClickHouse/pull/31742) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено чтение из таблиц `MergeTree` при включённом `use_uncompressed_cache`. [#31826](https://github.com/ClickHouse/ClickHouse/pull/31826) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено поведение, при котором мутации, для которых нет работы, зависали (при включённой настройке `empty_result_for_aggregation_by_empty_set`). [#32358](https://github.com/ClickHouse/ClickHouse/pull/32358) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлен пропуск столбцов при записи protobuf. Этот PR исправляет [#31160](https://github.com/ClickHouse/ClickHouse/issues/31160), см. комментарий [#31160](https://github.com/ClickHouse/ClickHouse/issues/31160)#issuecomment-980595318. [#31988](https://github.com/ClickHouse/ClickHouse/pull/31988) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена ошибка при удалении ненужных столбцов в подзапросе. Если в запросе есть агрегатная функция без `GROUP BY`, она не должна удаляться, даже если считается ненужной. [#32289](https://github.com/ClickHouse/ClickHouse/pull/32289) ([dongyifeng](https://github.com/dyf6372)).
* Лимит квоты ещё не был достигнут, но ограничение уже было превышено. Этот PR исправляет [#31174](https://github.com/ClickHouse/ClickHouse/issues/31174). [#31337](https://github.com/ClickHouse/ClickHouse/pull/31337) ([sunny](https://github.com/sunny19930321)).
* Исправлена команда `SHOW GRANTS` при использовании частичных отзывов прав доступа. Этот PR исправляет [#31138](https://github.com/ClickHouse/ClickHouse/issues/31138). [#31249](https://github.com/ClickHouse/ClickHouse/pull/31249) ([Vitaly Baranov](https://github.com/vitlibar)).
* Объем памяти был неверно оценен, когда ClickHouse запускался в контейнерах с ограничениями cgroup. [#31157](https://github.com/ClickHouse/ClickHouse/pull/31157) ([Pavel Medvedev](https://github.com/pmed)).
* Исправлена обработка запросов `ALTER ... MATERIALIZE COLUMN ...` в случаях, когда тип данных выражения по умолчанию не совпадает с типом данных столбца. [#32348](https://github.com/ClickHouse/ClickHouse/pull/32348) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено падение с SIGFPE в агрегатной функции `avgWeighted` с аргументом `Decimal`. Исправлена ошибка [#32053](https://github.com/ClickHouse/ClickHouse/issues/32053). [#32303](https://github.com/ClickHouse/ClickHouse/pull/32303) ([tavplubix](https://github.com/tavplubix)).
* Сервер мог не запускаться с ошибкой `Cannot attach 1 tables due to cyclic dependencies`, если таблица `Dictionary` ссылалась на XML-словарь с тем же именем; это исправлено. Исправлена [#31315](https://github.com/ClickHouse/ClickHouse/issues/31315). [#32288](https://github.com/ClickHouse/ClickHouse/pull/32288) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка разбора при десериализации NaN для `Nullable(Float)` при использовании правила экранирования `Quoted`. [#32190](https://github.com/ClickHouse/ClickHouse/pull/32190) ([Kruglov Pavel](https://github.com/Avogar)).
* Словари XML: идентификаторы, используемые в запросе CREATE TABLE, во время обновления до более новой версии могут автоматически получать префикс `default_database`. Закрывает [#31963](https://github.com/ClickHouse/ClickHouse/issues/31963). [#32187](https://github.com/ClickHouse/ClickHouse/pull/32187) ([Maksim Kita](https://github.com/kitaisreal)).
* Количество активных реплик могло определяться некорректно при вставке с кворумом, если на некоторых репликах был отключён параметр `replicated_can_become_leader`. Исправлено. [#32157](https://github.com/ClickHouse/ClickHouse/pull/32157) ([tavplubix](https://github.com/tavplubix)).
* Словари: исправлены случаи, когда `{condition}` не работал в пользовательских запросах к базе данных. [#32117](https://github.com/ClickHouse/ClickHouse/pull/32117) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена работа `CAST` из `Nullable` с `cast_keep_nullable` (ранее приводила к ошибке `PARAMETER_OUT_OF_BOUND`, например для `toUInt32OrDefault(toNullable(toUInt32(1)))`). [#32080](https://github.com/ClickHouse/ClickHouse/pull/32080) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен оператор CREATE TABLE для хранилища Join в некоторых нестандартных случаях. Закрыт [#31680](https://github.com/ClickHouse/ClickHouse/issues/31680). [#32066](https://github.com/ClickHouse/ClickHouse/pull/32066) ([SuperDJY](https://github.com/cmsxbc)).
* Исправлена ошибка `Directory ... already exists and is not empty` при отсоединении части. [#32063](https://github.com/ClickHouse/ClickHouse/pull/32063) ([tavplubix](https://github.com/tavplubix)).
* `MaterializedMySQL` (экспериментальная возможность): исправлена некорректная интерпретация данных типа `DECIMAL` из MySQL. [#31990](https://github.com/ClickHouse/ClickHouse/pull/31990) ([Håvard Kvålen](https://github.com/havardk)).
* Движок `FileLog` (экспериментальная возможность) излишне создавал директорию метаданных при ошибке создания таблицы. Исправлено [#31962](https://github.com/ClickHouse/ClickHouse/issues/31962). [#31967](https://github.com/ClickHouse/ClickHouse/pull/31967) ([flynn](https://github.com/ucasfl)).
* Некоторая запись `GET_PART` может зависнуть в очереди репликации, если часть утеряна на всех репликах и в том же разделе нет других частей. Проблема исправлена в случаях, когда ключ раздела содержит только столбцы целочисленных типов или `Date[Time]`. Исправляет [#31485](https://github.com/ClickHouse/ClickHouse/issues/31485). [#31887](https://github.com/ClickHouse/ClickHouse/pull/31887) ([tavplubix](https://github.com/tavplubix)).
* Исправлены функции `empty` и `notEmpty` с аргументами типа `UUID`, что устраняет проблему [#31819](https://github.com/ClickHouse/ClickHouse/issues/31819). [#31883](https://github.com/ClickHouse/ClickHouse/pull/31883) ([Anton Popov](https://github.com/CurtizJ)).
* Измените путь конфигурации с `keeper_server.session_timeout_ms` на `keeper_server.coordination_settings.session_timeout_ms` при создании `KeeperTCPHandler`. Аналогично для `operation_timeout`. [#31859](https://github.com/ClickHouse/ClickHouse/pull/31859) ([JackyWoo](https://github.com/JackyWoo)).
* Исправлена некорректная операция приведения типа `Nullable` при использовании первичного ключа типа `Nullable`. (Использование первичного ключа типа `Nullable` не рекомендуется — пожалуйста, не используйте его.) Это исправляет [#31075](https://github.com/ClickHouse/ClickHouse/issues/31075). [#31823](https://github.com/ClickHouse/ClickHouse/pull/31823) ([Amos Bird](https://github.com/amosbird)).
* Исправлен сбой при использовании рекурсивной UDF в SQL. Закрывает [#30856](https://github.com/ClickHouse/ClickHouse/issues/30856). [#31820](https://github.com/ClickHouse/ClickHouse/pull/31820) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена ошибка, приводившая к сбою при использовании функции `dictGet` с типом для атрибута словаря, когда этот тип — `Nullable`. Исправляет [#30980](https://github.com/ClickHouse/ClickHouse/issues/30980). [#31800](https://github.com/ClickHouse/ClickHouse/pull/31800) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлено падение при пустом результате выполнения ODBC-запроса (с некоторыми ODBC-драйверами). Закрывает [#31465](https://github.com/ClickHouse/ClickHouse/issues/31465). [#31766](https://github.com/ClickHouse/ClickHouse/pull/31766) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проблема с отключением профайлера запросов (в случае `query_profiler_real_time_period_ns>0`/`query_profiler_cpu_time_period_ns>0` профайлер запросов мог оставаться включённым даже после завершения запроса). [#31740](https://github.com/ClickHouse/ClickHouse/pull/31740) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена редкая ошибка сегментации при одновременном выполнении запросов `ATTACH PARTITION`. [#31738](https://github.com/ClickHouse/ClickHouse/pull/31738) ([tavplubix](https://github.com/tavplubix)).
* Исправлено состояние гонки в формате вывода JSONEachRowWithProgress, возникавшее при одновременном выводе данных и строк с прогрессом. [#31736](https://github.com/ClickHouse/ClickHouse/pull/31736) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка с сообщением `there are no such cluster here` при выполнении запроса `ON CLUSTER`, если указанное имя кластера совпадает с именем базы данных `Replicated`. [#31723](https://github.com/ClickHouse/ClickHouse/pull/31723) ([tavplubix](https://github.com/tavplubix)).
* Исправлено исключение при некоторых вариантах применения функции `decrypt` к столбцам типа Nullable. Это закрывает [#31662](https://github.com/ClickHouse/ClickHouse/issues/31662). Это закрывает [#31426](https://github.com/ClickHouse/ClickHouse/issues/31426). [#31707](https://github.com/ClickHouse/ClickHouse/pull/31707) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена работа функции ngrams при наличии в строке символов UTF-8. [#31706](https://github.com/ClickHouse/ClickHouse/pull/31706) ([yandd](https://github.com/yandd)).
* Настройки `input_format_allow_errors_num` и `input_format_allow_errors_ratio` не работали при разборе доменных типов данных, таких как `IPv4`; это было исправлено. Исправляет [#31686](https://github.com/ClickHouse/ClickHouse/issues/31686). [#31697](https://github.com/ClickHouse/ClickHouse/pull/31697) ([tavplubix](https://github.com/tavplubix)).
* Исправлено исключение нулевого указателя в `MATERIALIZE COLUMN`. [#31679](https://github.com/ClickHouse/ClickHouse/pull/31679) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Запрос `RENAME TABLE` работал некорректно при попытке переименовать DDL-словарь в базе данных `Ordinary`, ошибка исправлена. [#31638](https://github.com/ClickHouse/ClickHouse/pull/31638) ([tavplubix](https://github.com/tavplubix)).
* Реализована агрегатная функция `sparkbar` так, как было изначально задумано, см.: [#26175](https://github.com/ClickHouse/ClickHouse/issues/26175)#issuecomment-960353867, [комментарий](https://github.com/ClickHouse/ClickHouse/issues/26175#issuecomment-961155065). [#31624](https://github.com/ClickHouse/ClickHouse/pull/31624) ([小路](https://github.com/nicelulu)).
* Исправлена генерация некорректного JSON, возникавшая, когда только имена столбцов содержали недопустимые последовательности UTF-8. [#31534](https://github.com/ClickHouse/ClickHouse/pull/31534) ([Kevin Michel](https://github.com/kmichel-aiven)).
* Отключите `partial_merge_join_left_table_buffer_bytes`, пока ошибка в этой оптимизации не будет исправлена. См. [#31009](https://github.com/ClickHouse/ClickHouse/issues/31009)). Удалите лишнюю опцию `partial_merge_join_optimizations`. [#31528](https://github.com/ClickHouse/ClickHouse/pull/31528) ([Vladimir C](https://github.com/vdimir)).
* Исправлено отображение прогресса выполнения для коротких запросов `INSERT SELECT`. [#31510](https://github.com/ClickHouse/ClickHouse/pull/31510) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено некорректное поведение при использовании `GROUP BY` с позиционными аргументами. Закрывает [#31280](https://github.com/ClickHouse/ClickHouse/issues/31280)#issuecomment-968696186. [#31420](https://github.com/ClickHouse/ClickHouse/pull/31420) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка с использованием `nullptr` в провайдере учетных данных STS для S3. [#31409](https://github.com/ClickHouse/ClickHouse/pull/31409) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Удалена функция `notLike` из анализа индексов, так как она работала некорректно. [#31169](https://github.com/ClickHouse/ClickHouse/pull/31169) ([sundyli](https://github.com/sundy-li)).
* Исправлена ошибка в Keeper, которая могла приводить к невозможности запуска, если часть журналов координации была утеряна и снимок состояния был новее последнего журнала. [#31150](https://github.com/ClickHouse/ClickHouse/pull/31150) ([alesapin](https://github.com/alesapin)).
* Переписано использование правой распределённой таблицы в локальном соединении. Исправляет [#25809](https://github.com/ClickHouse/ClickHouse/issues/25809). [#31105](https://github.com/ClickHouse/ClickHouse/pull/31105) ([abel-cheng](https://github.com/abel-cheng)).
* Исправлена таблица `Merge` с псевдонимами и предложением WHERE (ранее она вовсе не работала). Закрывает [#28802](https://github.com/ClickHouse/ClickHouse/issues/28802). [#31044](https://github.com/ClickHouse/ClickHouse/pull/31044) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлены JSON&#95;VALUE/JSON&#95;QUERY с идентификаторами в кавычках. Это позволяет использовать пробелы в JSON-пути. Закрывает [#30971](https://github.com/ClickHouse/ClickHouse/issues/30971). [#31003](https://github.com/ClickHouse/ClickHouse/pull/31003) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Использование функции `formatRow` с форматами, не ориентированными на строки, приводило к ошибке сегментации (segfault). Теперь использование этой функции с такими форматами не допускается (так как в этом нет смысла). [#31001](https://github.com/ClickHouse/ClickHouse/pull/31001) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка, из-за которой переставали работать запросы `SELECT`, выполнявшиеся после удаления материализованного представления. Обнаружено в [#30691](https://github.com/ClickHouse/ClickHouse/issues/30691). [#30997](https://github.com/ClickHouse/ClickHouse/pull/30997) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Пропустить проверку `max_partition_size_to_drop` для ATTACH PARTITION ... FROM и MOVE PARTITION ... [#30995](https://github.com/ClickHouse/ClickHouse/pull/30995) ([Amr Alaa](https://github.com/amralaa-MSFT)).
* Исправлены некоторые краевые случаи при работе операторов `INTERSECT` и `EXCEPT`. Закрывает [#30803](https://github.com/ClickHouse/ClickHouse/issues/30803). [#30965](https://github.com/ClickHouse/ClickHouse/pull/30965) ([Kseniia Sumarokova](https://github.com/kssenii)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement}

* Исправлен некорректный результат фильтрации в сборках для архитектур, отличных от x86. Закрывает [#31417](https://github.com/ClickHouse/ClickHouse/issues/31417). Закрывает [#31524](https://github.com/ClickHouse/ClickHouse/issues/31524). [#31574](https://github.com/ClickHouse/ClickHouse/pull/31574) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Реализована полностью воспроизводимая сборка ClickHouse (байтово идентичная на разных машинах). Закрывает [#22113](https://github.com/ClickHouse/ClickHouse/issues/22113). [#31899](https://github.com/ClickHouse/ClickHouse/pull/31899) ([alexey-milovidov](https://github.com/alexey-milovidov)). Удалён путь файловой системы к каталогу сборки из бинарных файлов для обеспечения воспроизводимых сборок. Это необходимо для [#22113](https://github.com/ClickHouse/ClickHouse/issues/22113). [#31838](https://github.com/ClickHouse/ClickHouse/pull/31838) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Используем собственные CMakeLists для `zlib-ng`, `cassandra`, `mariadb-connector-c`, а также `xz`, `re2`, `sentry`, `gsasl`, `arrow`, `protobuf`. Это необходимо для [#20151](https://github.com/ClickHouse/ClickHouse/issues/20151). Часть [#9226](https://github.com/ClickHouse/ClickHouse/issues/9226). Небольшой шаг к удалению надоедливого мусора из системы сборки. [#30599](https://github.com/ClickHouse/ClickHouse/pull/30599) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Герметичные сборки: используем фиксированную версию libc и гарантируем, что никакие исходные или бинарные файлы из хостовой ОС не используются во время сборки. Закрывает [#27133](https://github.com/ClickHouse/ClickHouse/issues/27133). Закрывает [#21435](https://github.com/ClickHouse/ClickHouse/issues/21435). Закрывает [#30462](https://github.com/ClickHouse/ClickHouse/issues/30462). [#30011](https://github.com/ClickHouse/ClickHouse/pull/30011) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена функция `getFuzzerData()` для упрощения фаззинга отдельных функций. Закрывает [#23227](https://github.com/ClickHouse/ClickHouse/issues/23227). [#27526](https://github.com/ClickHouse/ClickHouse/pull/27526) ([Alexey Boykov](https://github.com/mathalex)).
* Более корректная настройка `capabilities` внутри Docker. [#31802](https://github.com/ClickHouse/ClickHouse/pull/31802) ([Constantine Peresypkin](https://github.com/pkit)).
* Включены опции компиляции clang `-fstrict-vtable-pointers`, `-fwhole-program-vtables`. [#20151](https://github.com/ClickHouse/ClickHouse/pull/20151) ([Maksim Kita](https://github.com/kitaisreal)).
* Исключена необходимость загружать архивы с toolchain для кросс-компиляции под FreeBSD. [#31672](https://github.com/ClickHouse/ClickHouse/pull/31672) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Начальная поддержка RISC-V. См. development/build-cross-riscv для особенностей и команды сборки, которая была протестирована. [#31309](https://github.com/ClickHouse/ClickHouse/pull/31309) ([Vladimir Smirnov](https://github.com/Civil)).
* Поддерживается компиляция на ARM-машинах с параметром `-DENABLE_TESTS=OFF`. [#31007](https://github.com/ClickHouse/ClickHouse/pull/31007) ([zhanghuajie](https://github.com/zhanghuajieHIT)).

### Релиз ClickHouse 21.11 от 2021-11-09. [Презентация](https://presentations.clickhouse.com/2021-release-21.11/), [видео](https://www.youtube.com/watch?v=xb64zoPYvqQ) {#clickhouse-release-v2111-2021-11-09}

<iframe width="1024" height="576" src="https://www.youtube.com/embed/xb64zoPYvqQ" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

#### Обратная несовместимость {#backward-incompatible-change-1}

* Изменён порядок аргументов `json_path` и `json` в функциях SQL/JSON (для соответствия стандарту). Закрывает [#30449](https://github.com/ClickHouse/ClickHouse/issues/30449). [#30474](https://github.com/ClickHouse/ClickHouse/pull/30474) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Удалена настройка таблиц `MergeTree` `write_final_mark`. Теперь она всегда будет иметь значение `true`. [#30455](https://github.com/ClickHouse/ClickHouse/pull/30455) ([Kseniia Sumarokova](https://github.com/kssenii)). Никаких действий не требуется, все таблицы совместимы с новой версией.
* Функция `bayesAB` удалена. Пожалуйста, помогите вернуть эту функцию в обновлённом виде. Это закрывает [#26233](https://github.com/ClickHouse/ClickHouse/issues/26233). [#29934](https://github.com/ClickHouse/ClickHouse/pull/29934) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Это актуально только в том случае, если вы уже начали использовать экспериментальную поддержку `clickhouse-keeper`. Теперь ClickHouse Keeper по умолчанию создаёт снапшоты, сжатые кодеком `ZSTD`, вместо собственного формата блочного сжатия ClickHouse LZ4. Это поведение можно отключить с помощью настройки координации `compress_snapshots_with_zstd_format` (она должна быть одинаковой на всех репликах кворума). Обратная несовместимость встречается довольно редко и может возникнуть только тогда, когда новый узел отправляет снапшот (например, при восстановлении) на старый узел, который не умеет читать снапшоты в формате ZSTD. [#29417](https://github.com/ClickHouse/ClickHouse/pull/29417) ([alesapin](https://github.com/alesapin)).

#### Новая функциональность {#new-feature-1}

* Новый асинхронный режим `INSERT` позволяет накапливать вставляемые данные и сохранять их единым пакетом в фоновом режиме. На стороне клиента он может быть включен установкой параметра `async_insert` для запросов `INSERT` с данными, встроенными в запрос, или размещёнными в отдельном буфере (например, для запросов `INSERT` по протоколу HTTP). Если `wait_for_async_insert` равен true (по умолчанию), клиент будет ждать, пока данные не будут сброшены в таблицу. На стороне сервера он управляется настройками `async_insert_threads`, `async_insert_max_data_size` и `async_insert_busy_timeout_ms`. Реализует [#18282](https://github.com/ClickHouse/ClickHouse/issues/18282). [#27537](https://github.com/ClickHouse/ClickHouse/pull/27537) ([Anton Popov](https://github.com/CurtizJ)). [#20557](https://github.com/ClickHouse/ClickHouse/pull/20557) ([Ivan](https://github.com/abyss7)). Замечания по производительности: с асинхронными вставками можно выполнять до примерно 10 000 отдельных запросов `INSERT` в секунду, поэтому по‑прежнему рекомендуется выполнять вставку пакетами, если требуется достичь производительности до миллионов вставляемых строк в секунду.
* Добавлен интерактивный режим для `clickhouse-local`. Теперь вы можете просто запустить `clickhouse-local`, чтобы получить клиентский интерфейс командной строки ClickHouse без подключения к серверу и обрабатывать данные из файлов и внешних источников. Также объединён код `clickhouse-client` и `clickhouse-local`. Закрывает [#7203](https://github.com/ClickHouse/ClickHouse/issues/7203). Закрывает [#25516](https://github.com/ClickHouse/ClickHouse/issues/25516). Закрывает [#22401](https://github.com/ClickHouse/ClickHouse/issues/22401). [#26231](https://github.com/ClickHouse/ClickHouse/pull/26231) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка исполняемых (скриптовых) пользовательских функций. Это пользовательские функции (UDF), которые могут быть написаны на любом языке программирования. [#28803](https://github.com/ClickHouse/ClickHouse/pull/28803) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена поддержка предопределённых подключений к внешним источникам данных. Это позволяет избежать необходимости указывать учётные данные или адреса при использовании внешних источников данных — вместо этого к ним можно обращаться по именам. Закрывает [#28367](https://github.com/ClickHouse/ClickHouse/issues/28367). [#28577](https://github.com/ClickHouse/ClickHouse/pull/28577) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена база данных `INFORMATION_SCHEMA` с представлениями `SCHEMATA`, `TABLES`, `VIEWS` и `COLUMNS`, соответствующими таблицам в базе данных `system`. Закрывает [#9770](https://github.com/ClickHouse/ClickHouse/issues/9770). [#28691](https://github.com/ClickHouse/ClickHouse/pull/28691) ([tavplubix](https://github.com/tavplubix)).
* Добавлена поддержка выражения `EXISTS (subquery)`. Закрывает [#6852](https://github.com/ClickHouse/ClickHouse/issues/6852). [#29731](https://github.com/ClickHouse/ClickHouse/pull/29731) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Ведение журнала сессий для аудита. Запись всех успешных и неуспешных событий входа в систему и выхода из неё в новую таблицу `system.session_log`. [#22415](https://github.com/ClickHouse/ClickHouse/pull/22415) ([Vasily Nemkov](https://github.com/Enmk)) ([Vitaly Baranov](https://github.com/vitlibar)).
* Поддержка многомерных функций косинусного и евклидова расстояний; расстояний и норм L1, L2, Lp, Linf. Скалярное произведение над кортежами и различные арифметические операторы над кортежами. Это полностью закрывает [#4509](https://github.com/ClickHouse/ClickHouse/issues/4509) и даже больше. [#27933](https://github.com/ClickHouse/ClickHouse/pull/27933) ([Alexey Boykov](https://github.com/mathalex)).
* Добавлена поддержка сжатия и распаковки для `INTO OUTFILE` и `FROM INFILE` (с автоматическим определением или с дополнительным необязательным параметром). [#27135](https://github.com/ClickHouse/ClickHouse/pull/27135) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* Добавлена поддержка CORS (Cross-Origin Resource Sharing) для HTTP-запросов `OPTIONS`. Это означает, что теперь Grafana будет работать с serverless-запросами без костылей. Закрывает [#18693](https://github.com/ClickHouse/ClickHouse/issues/18693). [#29155](https://github.com/ClickHouse/ClickHouse/pull/29155) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* Запросы с `JOIN ON` теперь поддерживают логические операции `OR`. [#21320](https://github.com/ClickHouse/ClickHouse/pull/21320) ([Ilya Golshtein](https://github.com/ilejn)).
* Добавлена функция `tokens`, которая позволяет разбивать строку на токены, используя небуквенно-цифровые ASCII-символы в качестве разделителей. [#29981](https://github.com/ClickHouse/ClickHouse/pull/29981) ([Maksim Kita](https://github.com/kitaisreal)). Добавлена функция `ngrams` для извлечения n-грамм из текста. Закрывает [#29699](https://github.com/ClickHouse/ClickHouse/issues/29699). [#29738](https://github.com/ClickHouse/ClickHouse/pull/29738) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлены функции нормализации Unicode: `normalizeUTF8NFC`, `normalizeUTF8NFD`, `normalizeUTF8NFKC`, `normalizeUTF8NFKD`. [#28633](https://github.com/ClickHouse/ClickHouse/pull/28633) ([darkkeks](https://github.com/darkkeks)).
* Потоковое чтение файлов журналов приложений в ClickHouse с использованием движка таблицы `FileLog`. Аналогично движкам `Kafka` или `RabbitMQ`, но предназначено для добавляемых (append-only) и ротируемых логов в локальной файловой системе. Закрывает [#6953](https://github.com/ClickHouse/ClickHouse/issues/6953). [#25969](https://github.com/ClickHouse/ClickHouse/pull/25969) ([flynn](https://github.com/ucasfl)) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлен формат вывода `CapnProto`, переработан формат ввода `CapnProto`. [#29291](https://github.com/ClickHouse/ClickHouse/pull/29291) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена возможность записывать числа в запросах в виде двоичных литералов. Пример: `SELECT 0b001;`. [#29304](https://github.com/ClickHouse/ClickHouse/pull/29304) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлен тип словаря `hashed_array`. Он экономит память при работе со словарями с несколькими атрибутами. Закрывает [#30236](https://github.com/ClickHouse/ClickHouse/issues/30236). [#30242](https://github.com/ClickHouse/ClickHouse/pull/30242) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена функция `JSONExtractKeys`. [#30056](https://github.com/ClickHouse/ClickHouse/pull/30056) ([Vitaly](https://github.com/orloffv)).
* Добавлена функция `getOSKernelVersion` — она возвращает строку с версией ядра операционной системы. [#29755](https://github.com/ClickHouse/ClickHouse/pull/29755) ([Memo](https://github.com/Joeywzr)).
* Добавлены функции `MD4` и `SHA384`. MD4 — устаревшая и небезопасная хеш-функция; её можно использовать только в редких случаях, когда MD4 уже применяется в какой-то устаревшей системе и вам нужно получить в точности такой же результат. [#29602](https://github.com/ClickHouse/ClickHouse/pull/29602) ([Nikita Tikhomirov](https://github.com/NSTikhomirov)).
* HSTS может быть включён для HTTP-сервера ClickHouse, задав положительное значение параметра `hsts_max_age` в конфигурационном файле. [#29516](https://github.com/ClickHouse/ClickHouse/pull/29516) ([凌涛](https://github.com/lingtaolf)).
* Поддержка хранилища Huawei OBS. Закрыта задача [#24294](https://github.com/ClickHouse/ClickHouse/issues/24294). [#29511](https://github.com/ClickHouse/ClickHouse/pull/29511) ([kevin wan](https://github.com/MaxWk)).
* Новая функция `mapContainsKeyLike` для проверки наличия в карте ключа, соответствующего простому регулярному выражению. [#29471](https://github.com/ClickHouse/ClickHouse/pull/29471) ([凌涛](https://github.com/lingtaolf)). Новая функция `mapExtractKeyLike` для получения карты, содержащей только элементы, ключи которых соответствуют заданному шаблону. [#30793](https://github.com/ClickHouse/ClickHouse/pull/30793) ([凌涛](https://github.com/lingtaolf)).
* Реализована поддержка команды `ALTER TABLE x MODIFY COMMENT`. [#29264](https://github.com/ClickHouse/ClickHouse/pull/29264) ([Vasily Nemkov](https://github.com/Enmk)).
* Добавляет функции анализа H3, которые отсутствуют в ClickHouse, но доступны через API H3: [https://h3geo.org/docs/api/inspection](https://h3geo.org/docs/api/inspection). [#29209](https://github.com/ClickHouse/ClickHouse/pull/29209) ([Bharat Nallan](https://github.com/bharatnc)).
* Разрешить выполнение нереплицируемых операций ALTER TABLE FETCH и ATTACH в реплицируемых базах данных. [#29202](https://github.com/ClickHouse/ClickHouse/pull/29202) ([Kevin Michel](https://github.com/kmichel-aiven)).
* Добавлена настройка `output_format_csv_null_representation`: она аналогична `output_format_tsv_null_representation`, но предназначена для вывода в формате CSV. [#29123](https://github.com/ClickHouse/ClickHouse/pull/29123) ([PHO](https://github.com/depressed-pho)).
* Добавлена функция `zookeeperSessionUptime()`, которая возвращает время работы текущей сессии ZooKeeper в секундах. [#28983](https://github.com/ClickHouse/ClickHouse/pull/28983) ([tavplubix](https://github.com/tavplubix)).
* Реализована функция `h3ToGeoBoundary`. [#28952](https://github.com/ClickHouse/ClickHouse/pull/28952) ([Ivan Veselov](https://github.com/fuzzERot)).
* Добавлена агрегатная функция `exponentialMovingAverage`, которую можно использовать в качестве оконной функции, что закрывает [#27511](https://github.com/ClickHouse/ClickHouse/issues/27511). [#28914](https://github.com/ClickHouse/ClickHouse/pull/28914) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Позволяет включать подстолбцы столбцов таблицы в результат запроса `DESCRIBE` (включается настройкой `describe_include_subcolumns`). [#28905](https://github.com/ClickHouse/ClickHouse/pull/28905) ([Anton Popov](https://github.com/CurtizJ)).
* В `Executable` и `ExecutablePool` добавлена опция `send_chunk_header`. Если эта опция включена, количество строк чанка (`rows_count`) с символом перевода строки будет отправлено клиенту перед чанком. [#28833](https://github.com/ClickHouse/ClickHouse/pull/28833) ([Maksim Kita](https://github.com/kitaisreal)).
* `tokenbf_v1` и `ngram` поддерживают Map с ключом типа String или FixedString. Это повышает эффективность пропуска данных в запросах с фильтром по ключу map. `sql CREATE TABLE map_tokenbf ( row_id UInt32, map Map(String, String), INDEX map_tokenbf map TYPE ngrambf_v1(4,256,2,0) GRANULARITY 1 ) Engine=MergeTree() Order by id ` Для таблицы выше запрос `select * from map_tokebf where map['K']='V'` пропустит гранулы, которые не содержат ключ `A`. Конечно, то, сколько строк будет пропущено, зависит от значений `granularity` и `index_granularity`, которые вы задали. [#28511](https://github.com/ClickHouse/ClickHouse/pull/28511) ([凌涛](https://github.com/lingtaolf)).
* Отправка событий профиля с сервера на клиент. Добавлен новый тип пакета `ProfileEvents`. Закрывает [#26177](https://github.com/ClickHouse/ClickHouse/issues/26177). [#28364](https://github.com/ClickHouse/ClickHouse/pull/28364) ([Dmitry Novik](https://github.com/novikd)).
* Операции побитового сдвига для типов данных `FixedString` и `String`. Это закрывает [#27763](https://github.com/ClickHouse/ClickHouse/issues/27763). [#28325](https://github.com/ClickHouse/ClickHouse/pull/28325) ([小路](https://github.com/nicelulu)).
* Поддерживается динамическое добавление и удаление таблиц из репликации PostgreSQL в движке базы данных MaterializedPostgreSQL. Добавлена поддержка оператора `ALTER` для настроек базы данных. Закрывает [#27573](https://github.com/ClickHouse/ClickHouse/issues/27573). [#28301](https://github.com/ClickHouse/ClickHouse/pull/28301) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена функция accurateCastOrDefault(x, T). Закрывает задачу [#21330](https://github.com/ClickHouse/ClickHouse/issues/21330). Автор — @taiyang-li. [#23028](https://github.com/ClickHouse/ClickHouse/pull/23028) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлены функции `toUUIDOrDefault`, `toUInt8/16/32/64/256OrDefault`, `toInt8/16/32/64/128/256OrDefault`, которые позволяют пользователю задавать значение по умолчанию (не `NULL`) при неудачном разборе строки. [#21330](https://github.com/ClickHouse/ClickHouse/pull/21330) ([taiyang-li](https://github.com/taiyang-li)).

#### Повышение производительности {#performance-improvement-1}

* Фоновые слияния могут вытеснять друг друга, и они планируются с соответствующими приоритетами. Теперь длительные слияния не будут препятствовать выполнению коротких. Это необходимо для более эффективного планирования и контроля выполнения слияний. Это снижает вероятность возникновения ошибки &quot;too many parts&quot;. [#22381](https://github.com/ClickHouse/ClickHouse/issues/22381). [#25165](https://github.com/ClickHouse/ClickHouse/pull/25165) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)). Добавлена возможность выполнять больше слияний и мутаций, чем количество потоков в фоновом пуле. Слияния и мутации будут выполняться поочередно в соответствии с их размерами (меньший размер имеет более высокий приоритет). Соотношение количества задач к количеству потоков выполнения контролируется настройкой `background_merges_mutations_concurrency_ratio`, по умолчанию — 2. [#29140](https://github.com/ClickHouse/ClickHouse/pull/29140) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Появилась возможность использовать асинхронное чтение для удалённых файловых систем. Уменьшается количество операций позиционирования при чтении из удалённых файловых систем. Это значительно повышает производительность и позволяет экспериментальным дискам `web` и `s3` работать быстрее, чем EBS при определённых условиях. [#29205](https://github.com/ClickHouse/ClickHouse/pull/29205) ([Kseniia Sumarokova](https://github.com/kssenii)). Тем временем тип диска `web` (статический набор данных, размещённый на веб‑сервере) выведен из статуса экспериментального и признан готовым к промышленной эксплуатации.
* Запросы с `INTO OUTFILE` в `clickhouse-client` теперь будут использовать несколько потоков. Исправлена проблема с мерцанием индикатора прогресса при использовании `INTO OUTFILE`. Это закрывает [#30873](https://github.com/ClickHouse/ClickHouse/issues/30873). Это закрывает [#30872](https://github.com/ClickHouse/ClickHouse/issues/30872). [#30886](https://github.com/ClickHouse/ClickHouse/pull/30886) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Уменьшен объём избыточных сжатых данных, читаемых с диска, для некоторых типов запросов `SELECT` (только для семейства движков `MergeTree`). [#30111](https://github.com/ClickHouse/ClickHouse/pull/30111) ([alesapin](https://github.com/alesapin)).
* Удалены некоторые избыточные вызовы `seek` при чтении сжатых блоков в семействе движков таблиц MergeTree. [#29766](https://github.com/ClickHouse/ClickHouse/pull/29766) ([alesapin](https://github.com/alesapin)).
* Сделать табличную функцию `url` способной обрабатывать несколько URL параллельно. Это закрывает задачи [#29670](https://github.com/ClickHouse/ClickHouse/issues/29670) и [#29671](https://github.com/ClickHouse/ClickHouse/issues/29671). [#29673](https://github.com/ClickHouse/ClickHouse/pull/29673) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Улучшена производительность агрегации в порядке первичного ключа (при включённой настройке `optimize_aggregation_in_order`). [#30266](https://github.com/ClickHouse/ClickHouse/pull/30266) ([Anton Popov](https://github.com/CurtizJ)).
* Теперь ClickHouse использует DNS‑кэш при взаимодействии с внешним S3. [#29999](https://github.com/ClickHouse/ClickHouse/pull/29999) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка передачи условий `IS NULL`/`IS NOT NULL` во внешние базы данных (например, MySQL). [#29463](https://github.com/ClickHouse/ClickHouse/pull/29463) ([Azat Khuzhin](https://github.com/azat)). Реализовано преобразование `isNull`/`isNotNull` в `IS NULL`/`IS NOT NULL` (для внешних БД, например MySQL). [#29446](https://github.com/ClickHouse/ClickHouse/pull/29446) ([Azat Khuzhin](https://github.com/azat)).
* Запросы SELECT к таблицам словарей будут использовать несколько потоков. [#30500](https://github.com/ClickHouse/ClickHouse/pull/30500) ([Maksim Kita](https://github.com/kitaisreal)).
* Улучшена производительность фильтрации (операция WHERE) по столбцам типа `Decimal`. [#30431](https://github.com/ClickHouse/ClickHouse/pull/30431) ([Jun Jin](https://github.com/vesslanjin)).
* Удалён разветвлённый код в операции фильтрации, вместо него использована более эффективная реализация на основе popcnt/ctz, обеспечивающая лучшую производительность. [#29881](https://github.com/ClickHouse/ClickHouse/pull/29881) ([Jun Jin](https://github.com/vesslanjin)).
* Улучшен генератор байтовой маски фильтра (используется для оператора WHERE) — единая функция с инструкциями SSE/AVX2/AVX512. Обратите внимание, что по умолчанию ClickHouse использует только SSE, поэтому это актуально только для кастомных сборок. [#30014](https://github.com/ClickHouse/ClickHouse/pull/30014) ([jasperzhu](https://github.com/jinjunzh)). [#30670](https://github.com/ClickHouse/ClickHouse/pull/30670) ([jasperzhu](https://github.com/jinjunzh)).
* Улучшена производительность агрегатной функции SUM над Nullable-числами с плавающей запятой. [#28906](https://github.com/ClickHouse/ClickHouse/pull/28906) ([Raúl Marín](https://github.com/Algunenano)).
* Ускорен процесс загрузки партий данных при использовании нескольких дисков. Идея аналогична [https://github.com/ClickHouse/ClickHouse/pull/16423](https://github.com/ClickHouse/ClickHouse/pull/16423). В продакшене наблюдается улучшение: 24 мин -&gt; 16 мин. [#28363](https://github.com/ClickHouse/ClickHouse/pull/28363) ([Amos Bird](https://github.com/amosbird)).
* Уменьшены значения по умолчанию для размера частей многочастичной загрузки в S3, чтобы снизить потребление памяти. [#28679](https://github.com/ClickHouse/ClickHouse/pull/28679) ([ianton-ru](https://github.com/ianton-ru)).
* Ускорена функция `bitmapAnd`. [#28332](https://github.com/ClickHouse/ClickHouse/pull/28332) ([dddounaiking](https://github.com/OodounaikingoO)).
* Удалены неоптимальные уведомления о мутациях в `StorageMergeTree`, когда ещё идут слияния. [#27552](https://github.com/ClickHouse/ClickHouse/pull/27552) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Попытка повысить производительность сравнения строк. [#28767](https://github.com/ClickHouse/ClickHouse/pull/28767) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Индекс по первичному ключу и фильтр по партиции могут работать в виде кортежа. [#29281](https://github.com/ClickHouse/ClickHouse/pull/29281) ([凌涛](https://github.com/lingtaolf)).
* Если запрос содержит несколько агрегатных функций quantile с одинаковыми аргументами, но разными значениями параметра уровня, они будут объединены и выполнены за один проход, если включена настройка `optimize_syntax_fuse_functions`. [#26657](https://github.com/ClickHouse/ClickHouse/pull/26657) ([hexiaoting](https://github.com/hexiaoting)).
* Теперь агрегация min-max по первому выражению первичного ключа оптимизирована за счёт проекций. Это для [#329](https://github.com/ClickHouse/ClickHouse/issues/329). [#29918](https://github.com/ClickHouse/ClickHouse/pull/29918) ([Amos Bird](https://github.com/amosbird)).

#### Экспериментальная возможность {#experimental-feature-1}

* Добавлена возможность изменять конфигурацию узлов (в конфигурационном файле `.xml`) для ClickHouse Keeper. [#30372](https://github.com/ClickHouse/ClickHouse/pull/30372) ([alesapin](https://github.com/alesapin)).
* Добавлена агрегатная функция `sparkbar`. Это закрывает задачу [#26175](https://github.com/ClickHouse/ClickHouse/issues/26175). [#27481](https://github.com/ClickHouse/ClickHouse/pull/27481) ([小路](https://github.com/nicelulu)). Примечание: в этой функции есть один недостаток, поведение будет изменено в будущих релизах.

#### Улучшение {#improvement-1}

* Добавлена возможность изменять уровни логирования без перезапуска. [#29586](https://github.com/ClickHouse/ClickHouse/pull/29586) ([Nikolay Degterinsky](https://github.com/evillique)).
* Многочисленные улучшения для пользовательских SQL-функций (SQL UDF). Запросы для операций с пользовательскими SQL-функциями теперь поддерживают оператор ON CLUSTER. Пример: `CREATE FUNCTION test_function ON CLUSTER 'cluster' AS x -> x + 1;`. Закрывает [#30666](https://github.com/ClickHouse/ClickHouse/issues/30666). [#30734](https://github.com/ClickHouse/ClickHouse/pull/30734) ([Maksim Kita](https://github.com/kitaisreal)). Добавлена поддержка синтаксисов `CREATE OR REPLACE`, `CREATE IF NOT EXISTS`. [#30454](https://github.com/ClickHouse/ClickHouse/pull/30454) ([Maksim Kita](https://github.com/kitaisreal)). Добавлена поддержка `DROP IF EXISTS`. Пример: `DROP FUNCTION IF EXISTS test_function`. [#30437](https://github.com/ClickHouse/ClickHouse/pull/30437) ([Maksim Kita](https://github.com/kitaisreal)). Добавлена поддержка лямбда-функций. Пример: `CREATE FUNCTION lambda_function AS x -> arrayMap(element -> element * 2, x);`. [#30435](https://github.com/ClickHouse/ClickHouse/pull/30435) ([Maksim Kita](https://github.com/kitaisreal)). Добавлена поддержка пользовательских SQL-функций для `clickhouse-local`. [#30179](https://github.com/ClickHouse/ClickHouse/pull/30179) ([Maksim Kita](https://github.com/kitaisreal)).
* Включён профилировщик памяти для каждого запроса (глобальное значение `memory_profiler_step` установлено в 4MiB). [#29455](https://github.com/ClickHouse/ClickHouse/pull/29455) ([Azat Khuzhin](https://github.com/azat)).
* Добавлены столбцы `data_compressed_bytes`, `data_uncompressed_bytes`, `marks_bytes` в `system.data_skipping_indices`. Добавлены столбцы `secondary_indices_compressed_bytes`, `secondary_indices_uncompressed_bytes`, `secondary_indices_marks_bytes` в `system.parts`. Закрыта задача [#29697](https://github.com/ClickHouse/ClickHouse/issues/29697). [#29896](https://github.com/ClickHouse/ClickHouse/pull/29896) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлены псевдонимы `table` для system.tables и `database` для system.databases [#29677](https://github.com/ClickHouse/ClickHouse/issues/29677). [#29882](https://github.com/ClickHouse/ClickHouse/pull/29882) ([kevin wan](https://github.com/MaxWk)).
* Корректно обрабатываются взаимозависимости таблиц при запуске сервера. Закрывает [#8004](https://github.com/ClickHouse/ClickHouse/issues/8004), закрывает [#15170](https://github.com/ClickHouse/ClickHouse/issues/15170). [#28373](https://github.com/ClickHouse/ClickHouse/pull/28373) ([tavplubix](https://github.com/tavplubix)).
* Предотвращает возникновение ошибки «Division by zero», когда знаменатель имеет тип Nullable в функциях `divide`, `intDiv` и `modulo`. Закрывает [#22621](https://github.com/ClickHouse/ClickHouse/issues/22621). [#28352](https://github.com/ClickHouse/ClickHouse/pull/28352) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена возможность разбирать значения типа данных `Date` в текстовых форматах как `YYYYMMDD` в дополнение к `YYYY-MM-DD`. Это закрывает [#30870](https://github.com/ClickHouse/ClickHouse/issues/30870). [#30871](https://github.com/ClickHouse/ClickHouse/pull/30871) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Web UI: отображение столбиков в ячейках таблицы. [#29792](https://github.com/ClickHouse/ClickHouse/pull/29792) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Теперь пользователь может создавать словари с комментариями: `CREATE DICTIONARY ... COMMENT 'vaue'` ... [#29899](https://github.com/ClickHouse/ClickHouse/pull/29899) ([Vasily Nemkov](https://github.com/Enmk)). Теперь пользователи могут задавать комментарии для базы данных в операторе `CREATE DATABASE` ... [#29429](https://github.com/ClickHouse/ClickHouse/pull/29429) ([Vasily Nemkov](https://github.com/Enmk)).
* Добавлена настройка `compiled_expression_cache_elements_size`. Если когда‑нибудь вы захотите воспользоваться этой настройкой, вы уже будете знать, что она делает. [#30667](https://github.com/ClickHouse/ClickHouse/pull/30667) ([Maksim Kita](https://github.com/kitaisreal)).
* clickhouse-format теперь поддерживает параметр `--query`. В предыдущих версиях запрос приходилось передавать через stdin. [#29325](https://github.com/ClickHouse/ClickHouse/pull/29325) ([凌涛](https://github.com/lingtaolf)).
* Добавлена поддержка `ALTER TABLE` для таблиц в базах данных `Memory`. Базы данных `Memory` используются в `clickhouse-local`. [#30866](https://github.com/ClickHouse/ClickHouse/pull/30866) ([tavplubix](https://github.com/tavplubix)).
* Функция `arrayStringConcat` теперь поддерживает массивы всех сериализуемых типов. [#30840](https://github.com/ClickHouse/ClickHouse/pull/30840) ([Nickita Taranov](https://github.com/nickitat)).
* ClickHouse теперь учитывает ограничения Docker/cgroups при определении доступного объёма памяти. См. [#25662](https://github.com/ClickHouse/ClickHouse/issues/25662). [#30574](https://github.com/ClickHouse/ClickHouse/pull/30574) ([Pavel Medvedev](https://github.com/pmed)).
* Структура таблиц, получаемая из базы данных PostgreSQL, теперь определяется более надёжно. [#30477](https://github.com/ClickHouse/ClickHouse/pull/30477) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Полная поддержка позиционных аргументов в GROUP BY и ORDER BY. [#30433](https://github.com/ClickHouse/ClickHouse/pull/30433) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена возможность извлекать элементы нестрокового типа в виде строк с помощью JSONExtractString. Это относится к [pull/25452#issuecomment-927123287](https://github.com/ClickHouse/ClickHouse/pull/25452#issuecomment-927123287). [#30426](https://github.com/ClickHouse/ClickHouse/pull/30426) ([Amos Bird](https://github.com/amosbird)).
* Добавлена возможность использовать клауза FINAL в запросах SELECT к таблицам на движке `GraphiteMergeTree`. [#30360](https://github.com/ClickHouse/ClickHouse/pull/30360) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Незначительные улучшения в клонировании реплик и постановке в очередь выборки для повреждённых частей, которые должны предотвратить крайне редкие случаи зависания записей `GET_PART` в очереди репликации. [#30346](https://github.com/ClickHouse/ClickHouse/pull/30346) ([tavplubix](https://github.com/tavplubix)).
* Разрешены символические ссылки на файлы в каталоге `user_files` для табличной функции `file`. [#30309](https://github.com/ClickHouse/ClickHouse/pull/30309) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено сравнение `Date32` с `Date`, `DateTime`, `DateTime64` и `String`. [#30219](https://github.com/ClickHouse/ClickHouse/pull/30219) ([liang.huang](https://github.com/lhuang09287750)).
* Добавлена возможность удалять выражение `SAMPLE BY` из таблиц `MergeTree` (`ALTER TABLE <table> REMOVE SAMPLE BY`). [#30180](https://github.com/ClickHouse/ClickHouse/pull/30180) ([Anton Popov](https://github.com/CurtizJ)).
* Теперь `Keeper` (как часть `clickhouse-server`) будет запускаться асинхронно, если сможет подключиться к другому узлу. [#30170](https://github.com/ClickHouse/ClickHouse/pull/30170) ([alesapin](https://github.com/alesapin)).
* Теперь `clickhouse-client` поддерживает родное многострочное редактирование. [#30143](https://github.com/ClickHouse/ClickHouse/pull/30143) ([Amos Bird](https://github.com/amosbird)).
* Словари `polygon` (обратное геокодирование): добавлена поддержка чтения содержимого словаря с помощью запроса SELECT, если настройка `store_polygon_key_column` установлена в true. Закрывает [#30090](https://github.com/ClickHouse/ClickHouse/issues/30090). [#30142](https://github.com/ClickHouse/ClickHouse/pull/30142) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлен логотип ClickHouse в интерфейс Play. [#29674](https://github.com/ClickHouse/ClickHouse/pull/29674) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Более информативное сообщение об ошибке при чтении столбца из форматов, поддерживающих Arrow, таких как `Arrow`, `ArrowStream`, `Parquet` и `ORC`. Это закрывает [#29926](https://github.com/ClickHouse/ClickHouse/issues/29926). [#29927](https://github.com/ClickHouse/ClickHouse/pull/29927) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Устранена гонка данных между flush и startup в таблицах `Buffer`. Она могла проявляться в тестах. [#29930](https://github.com/ClickHouse/ClickHouse/pull/29930) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема `lock-order-inversion` между `DROP TABLE` для `DatabaseMemory` и `LiveView`. Live View — экспериментальная функциональность. База данных `DatabaseMemory` используется в clickhouse-local. [#29929](https://github.com/ClickHouse/ClickHouse/pull/29929) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена инверсия порядка захвата блокировок между периодической перезагрузкой словаря и перезагрузкой конфигурации. [#29928](https://github.com/ClickHouse/ClickHouse/pull/29928) ([Azat Khuzhin](https://github.com/azat)).
* Обновлены файлы zoneinfo до 2021c. [#29925](https://github.com/ClickHouse/ClickHouse/pull/29925) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность настройки повторных попыток и задержек между ними для `clickhouse-copier`. [#29921](https://github.com/ClickHouse/ClickHouse/pull/29921) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена настройка сервера `shutdown_wait_unfinished_queries`, позволяющая ожидать выполнения запущенных запросов в течение времени, заданного в `shutdown_wait_unfinished`. Связано с [#24451](https://github.com/ClickHouse/ClickHouse/issues/24451). [#29914](https://github.com/ClickHouse/ClickHouse/pull/29914) ([Amos Bird](https://github.com/amosbird)).
* Добавлена возможность отслеживать пиковое использование памяти (с новым `trace_type` в `system.trace_log` — `MemoryPeak`). [#29858](https://github.com/ClickHouse/ClickHouse/pull/29858) ([Azat Khuzhin](https://github.com/azat)).
* Внешние таблицы PostgreSQL: добавлен префикс &#39;p&#39; для секционированной таблицы в запросе выборки индекса replica identity. [#29828](https://github.com/ClickHouse/ClickHouse/pull/29828) ([Shoh Jahon](https://github.com/Shohjahon)).
* Применять `max_untracked_memory`/`memory_profiler_step`/`memory_profiler_sample_probability` в операциях mutate/merge для профилирования использования памяти при слияниях. [#29681](https://github.com/ClickHouse/ClickHouse/pull/29681) ([Azat Khuzhin](https://github.com/azat)).
* Обфускатор запросов: `clickhouse-format --obfuscate` теперь работает с большим числом типов запросов. [#29672](https://github.com/ClickHouse/ClickHouse/pull/29672) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена проблема: `clickhouse-format --obfuscate` не мог обрабатывать запросы со встроенными словарями (функции `regionTo...`). [#29667](https://github.com/ClickHouse/ClickHouse/pull/29667) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена некорректная обработка Nullable в JSON-функциях. Это исправляет [#29615](https://github.com/ClickHouse/ClickHouse/issues/29615). Помечено как улучшение, так как [https://github.com/ClickHouse/ClickHouse/pull/28012](https://github.com/ClickHouse/ClickHouse/pull/28012) ещё не вошёл в релиз. [#29659](https://github.com/ClickHouse/ClickHouse/pull/29659) ([Amos Bird](https://github.com/amosbird)).
* Увеличить значение `listen_backlog` по умолчанию (чтобы оно соответствовало значению по умолчанию в более новых версиях ядра Linux). [#29643](https://github.com/ClickHouse/ClickHouse/pull/29643) ([Azat Khuzhin](https://github.com/azat)).
* Перезагружать словари, модели и пользовательские исполняемые функции при изменении конфигурации сервера (`dictionaries_config`, `models_config`, `user_defined_executable_functions_config`). Закрывает [#28142](https://github.com/ClickHouse/ClickHouse/issues/28142). [#29529](https://github.com/ClickHouse/ClickHouse/pull/29529) ([Maksim Kita](https://github.com/kitaisreal)).
* Снято бессмысленное ограничение на имя проекции. Теперь имя проекции может начинаться с `tmp_`. [#29520](https://github.com/ClickHouse/ClickHouse/pull/29520) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка `There is no query or query context has expired` в мутациях с вложенными подзапросами. Подзапросы в мутациях больше не допускаются, если таблица является реплицируемой и настройка `allow_nondeterministic_mutations` отключена. [#29495](https://github.com/ClickHouse/ClickHouse/pull/29495) ([tavplubix](https://github.com/tavplubix)).
* Применять изменения конфигурации `max_concurrent_queries` во время работы (без перезапуска). [#29414](https://github.com/ClickHouse/ClickHouse/pull/29414) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлена настройка `use_skip_indexes`. [#29405](https://github.com/ClickHouse/ClickHouse/pull/29405) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена поддержка `FREEZE` для частей в памяти (для резервного копирования). [#29376](https://github.com/ClickHouse/ClickHouse/pull/29376) ([Mo Xuan](https://github.com/mo-avatar)).
* Пробрасывать начальный query&#95;id для `clickhouse-benchmark` (ранее при выполнении удалённого запроса через `clickhouse-benchmark` запросы на шардах не были связаны с исходным запросом по `initial_query_id`). [#29364](https://github.com/ClickHouse/ClickHouse/pull/29364) ([Azat Khuzhin](https://github.com/azat)).
* Пропускающие индексы `tokenbf_v1` и `ngrambf_v1`: добавлена поддержка типа данных `Array` с ключом типа `String` или `FixedString`. [#29280](https://github.com/ClickHouse/ClickHouse/pull/29280) ([Maksim Kita](https://github.com/kitaisreal)). В пропускающие индексы `tokenbf_v1` и `ngrambf_v1` добавлена поддержка типа данных `Map` с ключом типа `String` или `FixedString`. Автор @lingtaolf. [#29220](https://github.com/ClickHouse/ClickHouse/pull/29220) ([Maksim Kita](https://github.com/kitaisreal)).
* Функция `has`: добавлена поддержка типа данных `Map`. [#29267](https://github.com/ClickHouse/ClickHouse/pull/29267) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлены настройки `compress_logs` для clickhouse-keeper, которые позволяют сжимать логи clickhouse-keeper (реплицированной машины состояний) с помощью `ZSTD`. Реализация: [#26977](https://github.com/ClickHouse/ClickHouse/issues/26977). [#29223](https://github.com/ClickHouse/ClickHouse/pull/29223) ([alesapin](https://github.com/alesapin)).
* Добавлена настройка `external_table_strict_query` — при её включении всё выражение WHERE в запросах к внешним базам данных будет передаваться целиком, даже если оно с ними несовместимо. [#29206](https://github.com/ClickHouse/ClickHouse/pull/29206) ([Azat Khuzhin](https://github.com/azat)).
* Отключены проекции при использовании `ARRAY JOIN`. В предыдущих версиях анализ проекций мог нарушать работу псевдонимов в `ARRAY JOIN`. [#29139](https://github.com/ClickHouse/ClickHouse/pull/29139) ([Amos Bird](https://github.com/amosbird)).
* Добавлена поддержка большего числа типов в формате ввода/вывода `MsgPack`. [#29077](https://github.com/ClickHouse/ClickHouse/pull/29077) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена возможность ввода и вывода столбцов `LowCardinality` в формате `ORC`. [#29062](https://github.com/ClickHouse/ClickHouse/pull/29062) ([Kruglov Pavel](https://github.com/Avogar)).
* SELECT из `system.distributed_ddl_queue` мог показывать некорректные значения, ошибка исправлена. [#29061](https://github.com/ClickHouse/ClickHouse/pull/29061) ([tavplubix](https://github.com/tavplubix)).
* Корректная обработка неизвестных HTTP-методов. Решает [#29050](https://github.com/ClickHouse/ClickHouse/issues/29050). [#29057](https://github.com/ClickHouse/ClickHouse/pull/29057) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* `clickhouse-keeper`: Исправлена ошибка в `clickhouse-keeper-converter`, которая могла приводить к потере некоторых данных при восстановлении из журналов ZooKeeper (не из snapshot-снимка). [#29030](https://github.com/ClickHouse/ClickHouse/pull/29030) ([小路](https://github.com/nicelulu)). Исправлена ошибка в `clickhouse-keeper-converter`, которая могла приводить к некорректной десериализации журналов ZooKeeper. [#29071](https://github.com/ClickHouse/ClickHouse/pull/29071) ([小路](https://github.com/nicelulu)).
* Применять настройки из запросов `CREATE ... AS SELECT` (исправляет: [#28810](https://github.com/ClickHouse/ClickHouse/issues/28810)). [#28962](https://github.com/ClickHouse/ClickHouse/pull/28962) ([Azat Khuzhin](https://github.com/azat)).
* Учитывать базу данных по умолчанию для ALTER TABLE ... ON CLUSTER ... REPLACE/MOVE PARTITION FROM/TO ... [#28955](https://github.com/ClickHouse/ClickHouse/pull/28955) ([anneji-dev](https://github.com/anneji-dev)).
* Протокол gRPC: Разрешено изменять серверное сжатие со стороны клиента. [#28953](https://github.com/ClickHouse/ClickHouse/pull/28953) ([Vitaly Baranov](https://github.com/vitlibar)).
* Игнорировать исключение «no data» при чтении температурных датчиков для асинхронных метрик. Тем самым закрывается задача [#28852](https://github.com/ClickHouse/ClickHouse/issues/28852). [#28882](https://github.com/ClickHouse/ClickHouse/pull/28882) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена логическая гонка, которая в редких случаях могла приводить к ошибке `Dictionary not found` для существующего словаря. [#28853](https://github.com/ClickHouse/ClickHouse/pull/28853) ([tavplubix](https://github.com/tavplubix)).
* Ослаблено ограничение на вложенную функцию при проверке If-комбинатора (но вложенные идентичные комбинаторы запрещены). [#28828](https://github.com/ClickHouse/ClickHouse/pull/28828) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено возможное необработанное исключение при остановке сервера. [#28761](https://github.com/ClickHouse/ClickHouse/pull/28761) ([Azat Khuzhin](https://github.com/azat)).
* Запрещена очистка временных каталогов tmp, которые могут использоваться активной мутацией/слиянием, если мутация/слияние выполняется чрезвычайно долго. [#28760](https://github.com/ClickHouse/ClickHouse/pull/28760) ([Azat Khuzhin](https://github.com/azat)).
* Разрешена оптимизация `optimize_arithmetic_operations_in_aggregate_functions = 1` при использовании псевдонимов. [#28746](https://github.com/ClickHouse/ClickHouse/pull/28746) ([Amos Bird](https://github.com/amosbird)).
* Реализована настройка `detach_not_byte_identical_parts` для `ReplicatedMergeTree`, которая будет отсоединять, а не удалять части, которые не совпадают побайтно (после операций merge/mutate). [#28708](https://github.com/ClickHouse/ClickHouse/pull/28708) ([Azat Khuzhin](https://github.com/azat)).
* Введена настройка `max_suspicious_broken_parts_bytes` для `MergeTree` (ограничивает общий размер всех повреждённых частей, значение по умолчанию — `1GiB`). [#28707](https://github.com/ClickHouse/ClickHouse/pull/28707) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка раскрытия макросов в настройках таблицы `RabbitMQ`. [#28683](https://github.com/ClickHouse/ClickHouse/pull/28683) ([Vitaly Baranov](https://github.com/vitlibar)).
* Восстановлена возможность многопоточного чтения данных из таблицы с движком `Log`. [#28125](https://github.com/ClickHouse/ClickHouse/pull/28125) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено некорректное обращение с NULL-столбцами в JSON-функциях. Это исправление закрывает [#27930](https://github.com/ClickHouse/ClickHouse/issues/27930). [#28012](https://github.com/ClickHouse/ClickHouse/pull/28012) ([Amos Bird](https://github.com/amosbird)).
* Добавлена возможность задавать размер кэша Mark/Uncompressed для пропускающих индексов отдельно от столбцов. [#27961](https://github.com/ClickHouse/ClickHouse/pull/27961) ([Amos Bird](https://github.com/amosbird)).
* Теперь можно смешивать JOIN с `USING` с другими типами JOIN. [#23881](https://github.com/ClickHouse/ClickHouse/pull/23881) ([darkkeks](https://github.com/darkkeks)).
* Обновлён подмодуль aws-sdk для обработки ограничений частоты запросов (throttling) в Yandex Cloud S3. [#30646](https://github.com/ClickHouse/ClickHouse/pull/30646) ([ianton-ru](https://github.com/ianton-ru)).
* Исправлено освобождение идентификатора запроса и идентификатора сессии в конце обработки запроса во время gRPC-вызова. [#29954](https://github.com/ClickHouse/ClickHouse/pull/29954) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено завершение работы `AccessControlManager`, чтобы устранить нестабильный тест. [#29951](https://github.com/ClickHouse/ClickHouse/pull/29951) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено падение по assert при чтении из `HDFS`. Обновлена библиотека libhdfs3 для возможности запуска тестов в отладочном режиме. Закрывает [#29251](https://github.com/ClickHouse/ClickHouse/issues/29251). Закрывает [#27814](https://github.com/ClickHouse/ClickHouse/issues/27814). [#29276](https://github.com/ClickHouse/ClickHouse/pull/29276) ([Kseniia Sumarokova](https://github.com/kssenii)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-1}

* Добавлена поддержка сборки FreeBSD для машин Aarch64. [#29952](https://github.com/ClickHouse/ClickHouse/pull/29952) ([MikaelUrankar](https://github.com/MikaelUrankar)).
* Рекурсивные подмодули больше не требуются для ClickHouse. [#30315](https://github.com/ClickHouse/ClickHouse/pull/30315) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* ClickHouse может быть статически собран с musl. Это добавлено как эксперимент, он не поддерживает сборку `odbc-bridge`, `library-bridge`, интеграцию с CatBoost и с некоторыми библиотеками. [#30248](https://github.com/ClickHouse/ClickHouse/pull/30248) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Включены `Protobuf`, `Arrow`, `ORC`, `Parquet` для сборок `AArch64` и `Darwin` (macOS). Это закрывает [#29248](https://github.com/ClickHouse/ClickHouse/issues/29248). Это закрывает [#28018](https://github.com/ClickHouse/ClickHouse/issues/28018). [#30015](https://github.com/ClickHouse/ClickHouse/pull/30015) ([alexey-мilovidov](https://github.com/alexey-milovidov)).
* Добавлена кросс-сборка для PowerPC (powerpc64le). Это закрывает [#9589](https://github.com/ClickHouse/ClickHouse/issues/9589). Включена поддержка взаимодействия с MySQL для AArch64 и PowerPC. Это закрывает [#26301](https://github.com/ClickHouse/ClickHouse/issues/26301). [#30010](https://github.com/ClickHouse/ClickHouse/pull/30010) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* В кросс-компиляционных toolchain'ах оставлены только необходимые файлы. Они включены как подмодули (ранее они загружались как tarball-архивы). [#29974](https://github.com/ClickHouse/ClickHouse/pull/29974) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Реализован подход structure-aware fuzzing в ClickHouse для парсера операторов SELECT. [#30012](https://github.com/ClickHouse/ClickHouse/pull/30012) ([Paul](https://github.com/PaulCher)).
* Включён экспериментальный вычислитель constexpr-выражений для clang для ускорения компиляции шаблонного кода. [#29668](https://github.com/ClickHouse/ClickHouse/pull/29668) ([myrrc](https://github.com/myrrc)).
* Добавлена возможность компиляции с использованием более новой версии glibc без использования новых символов. [#29594](https://github.com/ClickHouse/ClickHouse/pull/29594) ([Azat Khuzhin](https://github.com/azat)).
* Уменьшен размер бинарника Debug-сборки с помощью опции оптимизации clang. [#28736](https://github.com/ClickHouse/ClickHouse/pull/28736) ([flynn](https://github.com/ucasfl)).
* Теперь все образы для CI будут размещаться в отдельном репозитории Docker Hub. [#28656](https://github.com/ClickHouse/ClickHouse/pull/28656) ([alesapin](https://github.com/alesapin)).
* Улучшена поддержка сборки с clang-13. [#28046](https://github.com/ClickHouse/ClickHouse/pull/28046) ([Sergei Semin](https://github.com/syominsergey)).
* Добавлена возможность выводить «сырые» события профилирования в `clickhouse-client` (это может быть полезно для отладки и тестирования). [#30064](https://github.com/ClickHouse/ClickHouse/pull/30064) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена зависимость по времени запуска для юнита clickhouse-server (systemd и sysvinit init). [#28891](https://github.com/ClickHouse/ClickHouse/pull/28891) ([Azat Khuzhin](https://github.com/azat)).
* Теперь кэш stacktrace перезагружается при повторной загрузке символа. [#28137](https://github.com/ClickHouse/ClickHouse/pull/28137) ([Amos Bird](https://github.com/amosbird)).

#### Исправление ошибок {#bug-fix}

* Функции для поиска без учета регистра в строках UTF-8, такие как `positionCaseInsensitiveUTF8` и `countSubstringsCaseInsensitiveUTF8`, в очень редких случаях могли находить подстроки, которые на самом деле не совпадали, — проблема исправлена. [#30663](https://github.com/ClickHouse/ClickHouse/pull/30663) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка чтения из пустого файла на зашифрованном диске. [#30494](https://github.com/ClickHouse/ClickHouse/pull/30494) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена трансформация цепочки дизъюнкций в `IN` (управляется настройкой `optimize_min_equality_disjunction_chain_length`) в распределённых запросах с настройкой `legacy_column_name_of_tuple_literal = 0`. [#28658](https://github.com/ClickHouse/ClickHouse/pull/28658) ([Anton Popov](https://github.com/CurtizJ)).
* Теперь можно использовать материализованный столбец в качестве ключа шардинга в распределённой таблице, даже если `insert_allow_materialized_columns=0`. [#28637](https://github.com/ClickHouse/ClickHouse/pull/28637) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена обработка `ORDER BY ... WITH FILL` с заданными `TO` и `FROM` при отсутствии строк в результирующем наборе. [#30888](https://github.com/ClickHouse/ClickHouse/pull/30888) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена проблема, из-за которой индекс множества не использовался в выражениях AND/OR при более чем двух операндах. Это исправляет [#30416](https://github.com/ClickHouse/ClickHouse/issues/30416). [#30887](https://github.com/ClickHouse/ClickHouse/pull/30887) ([Amos Bird](https://github.com/amosbird)).
* Исправлен сбой при материализации проекции с хеширующей функцией. Этим исправляется [#30861](https://github.com/ClickHouse/ClickHouse/issues/30861). Проблема аналогична [https://github.com/ClickHouse/ClickHouse/pull/28560](https://github.com/ClickHouse/ClickHouse/pull/28560), причина которой — некорректное понимание инварианта о пустоте заголовка. [#30877](https://github.com/ClickHouse/ClickHouse/pull/30877) ([Amos Bird](https://github.com/amosbird)).
* Исправлена неоднозначность при извлечении имени вспомогательного ZooKeeper из пути ZooKeeper в `ReplicatedMergeTree`. Ранее сервер мог не запуститься с ошибкой `Unknown auxiliary ZooKeeper name`, если путь ZooKeeper содержал двоеточие. Исправление для [#29052](https://github.com/ClickHouse/ClickHouse/issues/29052). Ранее также допускалось указывать путь ZooKeeper, который не начинается со слэша, но теперь это поведение объявлено устаревшим, и создание новых таблиц с таким путём не допускается. Слэши и двоеточия во вспомогательных именах ZooKeeper также не разрешены. [#30822](https://github.com/ClickHouse/ClickHouse/pull/30822) ([tavplubix](https://github.com/tavplubix)).
* Очищать временный каталог, если выполнение `localBackup` завершилось ошибкой. [#30797](https://github.com/ClickHouse/ClickHouse/pull/30797) ([ianton-ru](https://github.com/ianton-ru)).
* Исправлено состояние гонки между `REPLACE/MOVE PARTITION` и фоновым слиянием в нереплицируемом `MergeTree`, из-за которого часть перемещённых/заменённых данных могла оставаться в партиции. Исправляет [#29327](https://github.com/ClickHouse/ClickHouse/issues/29327). [#30717](https://github.com/ClickHouse/ClickHouse/pull/30717) ([tavplubix](https://github.com/tavplubix)).
* Исправлена работа `PREWHERE` совместно с `WHERE` в случае всегда истинного условия `PREWHERE`. [#30668](https://github.com/ClickHouse/ClickHouse/pull/30668) ([Azat Khuzhin](https://github.com/azat)).
* Оптимизация проталкивания LIMIT могла приводить к ошибке `Cannot find column`. Исправляет [#30438](https://github.com/ClickHouse/ClickHouse/issues/30438). [#30562](https://github.com/ClickHouse/ClickHouse/pull/30562) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлены недостающие скобки при переписывании `isNotNull`/`isNull` в `IS [NOT] NULL` (что исправляет выполнение запросов, содержащих выражения вроде `isNotNull(1)+isNotNull(2)`). [#30520](https://github.com/ClickHouse/ClickHouse/pull/30520) ([Azat Khuzhin](https://github.com/azat)).
* Устранена взаимоблокировка при операции `ALTER` со скалярным подзапросом к той же таблице, закрыт [#30461](https://github.com/ClickHouse/ClickHouse/issues/30461). [#30492](https://github.com/ClickHouse/ClickHouse/pull/30492) ([Vladimir C](https://github.com/vdimir)).
* Исправлена ошибка, приводившая к segfault, который мог произойти, если сеанс истекал во время выполнения REPLACE PARTITION. [#30432](https://github.com/ClickHouse/ClickHouse/pull/30432) ([tavplubix](https://github.com/tavplubix)).
* Запросы с условием вида `IN (subquery)` могли возвращать некорректные результаты в случае, если применялась агрегирующая проекция. Исправлено создание множеств для проекций. [#30310](https://github.com/ClickHouse/ClickHouse/pull/30310) ([Amos Bird](https://github.com/amosbird)).
* Исправлена обработка псевдонимов столбцов в запросах JOIN при включённой проекции. Это исправляет [#30146](https://github.com/ClickHouse/ClickHouse/issues/30146). [#30293](https://github.com/ClickHouse/ClickHouse/pull/30293) ([Amos Bird](https://github.com/amosbird)).
* Исправлены некоторые недостатки функции `replaceRegexpAll`. [#30292](https://github.com/ClickHouse/ClickHouse/pull/30292) ([Memo](https://github.com/Joeywzr)).
* Исправлен разбор опции `preallocate` в конфигурации layout для ComplexKeyHashedDictionary и ComplexKeySparseHashedDictionary. [#30246](https://github.com/ClickHouse/ClickHouse/pull/30246) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена работа функции `[I]LIKE`. Закрывает [#28661](https://github.com/ClickHouse/ClickHouse/issues/28661). [#30244](https://github.com/ClickHouse/ClickHouse/pull/30244) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлен сбой при использовании `shortcircuit` и `LowCardinality` в `multiIf`. [#30243](https://github.com/ClickHouse/ClickHouse/pull/30243) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено вычисление bytes&#95;allocated для nullable-атрибутов в FlatDictionary и HashedDictionary. [#30238](https://github.com/ClickHouse/ClickHouse/pull/30238) ([Maksim Kita](https://github.com/kitaisreal)).
* Разрешены идентификаторы, начинающиеся с цифр, в нескольких соединениях (JOIN). [#30230](https://github.com/ClickHouse/ClickHouse/pull/30230) ([Vladimir C](https://github.com/vdimir)).
* Исправлено чтение из `MergeTree` при `max_read_buffer_size = 0` (когда пользователь хочет выстрелить себе в ногу), что могло приводить к исключениям `Can't adjust last granule`, `LOGICAL_ERROR` или даже к потере данных. [#30192](https://github.com/ClickHouse/ClickHouse/pull/30192) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа `pread_fake_async`/`pread_threadpool` с `min_bytes_to_use_direct_io`. [#30191](https://github.com/ClickHouse/ClickHouse/pull/30191) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема, из‑за которой оператор INSERT SELECT некорректно заполнял MATERIALIZED столбец на основе столбца типа Nullable. [#30189](https://github.com/ClickHouse/ClickHouse/pull/30189) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка аргументов с типом Nullable в функции `initializeAggregation`. [#30177](https://github.com/ClickHouse/ClickHouse/pull/30177) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка `Port is already connected` для запросов с `GLOBAL IN` и `WITH TOTALS`. Только для версий 21.9 и 21.10. [#30086](https://github.com/ClickHouse/ClickHouse/pull/30086) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Устранена гонка между MOVE PARTITION и слияниями/мутациями для MergeTree. [#30074](https://github.com/ClickHouse/ClickHouse/pull/30074) ([Azat Khuzhin](https://github.com/azat)).
* Удалённая база данных `Memory` могла снова появляться после перезапуска сервера; проблема исправлена ([#29795](https://github.com/ClickHouse/ClickHouse/issues/29795)). Также добавлена настройка `force_remove_data_recursively_on_drop` как обходное решение для ошибки `Directory not empty` при удалении базы данных типа `Ordinary` (так как в облачной среде невозможно вручную удалить оставшиеся данные). [#30054](https://github.com/ClickHouse/ClickHouse/pull/30054) ([tavplubix](https://github.com/tavplubix)).
* Исправлен сбой примера с использованием `tuple()`, что закрывает [#30004](https://github.com/ClickHouse/ClickHouse/issues/30004). [#30016](https://github.com/ClickHouse/ClickHouse/pull/30016) ([flynn](https://github.com/ucasfl)).
* Попытка закрыть задачу: [#29965](https://github.com/ClickHouse/ClickHouse/issues/29965). [#29976](https://github.com/ClickHouse/ClickHouse/pull/29976) ([hexiaoting](https://github.com/hexiaoting)).
* Устранена возможная гонка данных между `FileChecker` и `StorageLog`/`StorageStripeLog`. [#29959](https://github.com/ClickHouse/ClickHouse/pull/29959) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена гонка данных между `LogSink::writeMarks()` и `LogSource` в `StorageLog`. [#29946](https://github.com/ClickHouse/ClickHouse/pull/29946) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена потенциальная утечка ресурсов, связанная с лимитом числа параллельных запросов для таблиц семейства MergeTree, возникшая в [https://github.com/ClickHouse/ClickHouse/pull/19544](https://github.com/ClickHouse/ClickHouse/pull/19544). [#29879](https://github.com/ClickHouse/ClickHouse/pull/29879) ([Amos Bird](https://github.com/amosbird)).
* Исправлена проверка повторного создания системных таблиц (не удавалось обнаружить изменения в значениях ENUM). [#29857](https://github.com/ClickHouse/ClickHouse/pull/29857) ([Azat Khuzhin](https://github.com/azat)).
* MaterializedMySQL: Исправлена ошибка, из-за которой при потере соединения с MySQL могла быть обработана только часть транзакции. [#29837](https://github.com/ClickHouse/ClickHouse/pull/29837) ([Håvard Kvålen](https://github.com/havardk)).
* Предотвращает возникновение ошибки `Timeout exceeded: elapsed 18446744073.709553 seconds`, которая могла возникать в крайне редких случаях, предположительно из‑за некоторого бага в ядре. Исправляет [#29154](https://github.com/ClickHouse/ClickHouse/issues/29154). [#29811](https://github.com/ClickHouse/ClickHouse/pull/29811) ([tavplubix](https://github.com/tavplubix)).
* Исправлено некорректное приведение типов в запросе `ATTACH TABLE ... FROM 'path'`, когда вместо пути используется нестроковый литерал. Это могло приводить к чтению из неинициализированной памяти. [#29790](https://github.com/ClickHouse/ClickHouse/pull/29790) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен конкурентный доступ к `LowCardinality` во время выполнения `GROUP BY` (в сочетании с таблицами `Buffer` это могло приводить к проблемам). [#29782](https://github.com/ClickHouse/ClickHouse/pull/29782) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена некорректная работа `GROUP BY` (несколько строк с одинаковыми ключами в результате) в случае распределённого запроса, когда шарды были на смешанных версиях `<= 21.3` и `>= 21.4`, ключ `GROUP BY` содержал несколько столбцов, каждый из которых имел фиксированный размер, и была активирована двухуровневая агрегация (см. `group_by_two_level_threshold` и `group_by_two_level_threshold_bytes`). Устраняет [#29580](https://github.com/ClickHouse/ClickHouse/issues/29580). [#29735](https://github.com/ClickHouse/ClickHouse/pull/29735) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено некорректное поведение при установке параметра `materialized_postgresql_tables_list` во время перезапуска сервера. Обнаружено в [#28529](https://github.com/ClickHouse/ClickHouse/issues/28529). [#29686](https://github.com/ClickHouse/ClickHouse/pull/29686) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Условие в предикате фильтрации могло теряться после оптимизации проталкивания (push-down). [#29625](https://github.com/ClickHouse/ClickHouse/pull/29625) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена JIT-компиляция выражений с псевдонимами и укороченным вычислением выражений. Закрывает [#29403](https://github.com/ClickHouse/ClickHouse/issues/29403). [#29574](https://github.com/ClickHouse/ClickHouse/pull/29574) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена редкая ошибка сегментации в запросе `ALTER MODIFY` при использовании некорректного идентификатора таблицы в выражении `DEFAULT`, таком как `x.y.z...`. Исправлено [#29184](https://github.com/ClickHouse/ClickHouse/issues/29184). [#29573](https://github.com/ClickHouse/ClickHouse/pull/29573) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка разыменования нулевого указателя (`nullptr`) для `GROUP BY WITH TOTALS HAVING` (когда столбец из `HAVING` не был выбран). [#29553](https://github.com/ClickHouse/ClickHouse/pull/29553) ([Azat Khuzhin](https://github.com/azat)).
* Избегайте взаимоблокировок при одновременном чтении и записи в таблицах движка Join. [#29544](https://github.com/ClickHouse/ClickHouse/pull/29544) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена ошибка в проверке `pathStartsWith`, вызванная некорректным использованием `std::mismatch`: `The behavior is undefined if the second range is shorter than the first range.`. [#29531](https://github.com/ClickHouse/ClickHouse/pull/29531) ([Kseniia Sumarokova](https://github.com/kssenii)).
* В ODBC Bridge добавлены повторные попытки при ошибке Invalid cursor state. Это ошибка, при которой допустимо повторение запроса. Закрывает [#29473](https://github.com/ClickHouse/ClickHouse/issues/29473). [#29518](https://github.com/ClickHouse/ClickHouse/pull/29518) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен некорректный разбор имени таблицы при загрузке базы данных `Lazy`. Исправлена проблема [#29456](https://github.com/ClickHouse/ClickHouse/issues/29456). [#29476](https://github.com/ClickHouse/ClickHouse/pull/29476) ([tavplubix](https://github.com/tavplubix)).
* Исправлена возможная ошибка `Block structure mismatch` для подзапросов с протолкнутым вниз предикатом `HAVING`. Исправлено [#29010](https://github.com/ClickHouse/ClickHouse/issues/29010). [#29475](https://github.com/ClickHouse/ClickHouse/pull/29475) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена логическая ошибка `Cannot capture columns` в функциях greatest и least. Закрывает [#29334](https://github.com/ClickHouse/ClickHouse/issues/29334). [#29454](https://github.com/ClickHouse/ClickHouse/pull/29454) ([Kruglov Pavel](https://github.com/Avogar)).
* Движок таблицы RocksDB: исправлено состояние гонки при одновременном открытии БД (и возвращены некоторые тесты, воспроизводящие проблему в CI). [#29393](https://github.com/ClickHouse/ClickHouse/pull/29393) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема, при которой replicated access storage некорректно завершало работу при ошибочной конфигурации. [#29388](https://github.com/ClickHouse/ClickHouse/pull/29388) ([Kevin Michel](https://github.com/kmichel-aiven)).
* Удалена оконная функция `nth_value`, так как она небезопасна с точки зрения использования памяти. Это закрывает [#29347](https://github.com/ClickHouse/ClickHouse/issues/29347). [#29348](https://github.com/ClickHouse/ClickHouse/pull/29348) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправить вертикальные слияния частей проекций. Это устраняет проблему [#29253](https://github.com/ClickHouse/ClickHouse/issues/29253). Этот PR также исправляет несколько проблем со слиянием и мутацией частей проекций, появившихся в [https://github.com/ClickHouse/ClickHouse/pull/25165](https://github.com/ClickHouse/ClickHouse/pull/25165). [#29337](https://github.com/ClickHouse/ClickHouse/pull/29337) ([Amos Bird](https://github.com/amosbird)).
* Исправлена проблема зависания DDL-запросов в реплицируемой базе данных при добавлении новой реплики. [#29328](https://github.com/ClickHouse/ClickHouse/pull/29328) ([Kevin Michel](https://github.com/kmichel-aiven)).
* Исправлены таймауты соединения (`send_timeout`/`receive_timeout`). [#29282](https://github.com/ClickHouse/ClickHouse/pull/29282) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено возможное исключение `Table columns structure in ZooKeeper is different from local table structure` при пересоздании или создании новых реплик `ReplicatedMergeTree`, когда один из столбцов таблицы имеет выражение DEFAULT с регистронезависимыми функциями. [#29266](https://github.com/ClickHouse/ClickHouse/pull/29266) ([Anton Popov](https://github.com/CurtizJ)).
* Отправлять клиенту (по TCP) обычную ошибку `Database doesn't exist` (`UNKNOWN_DATABASE`) вместо `Attempt to read after eof` (`ATTEMPT_TO_READ_AFTER_EOF`). [#29229](https://github.com/ClickHouse/ClickHouse/pull/29229) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен сегфолт при вставке в столбец типа LowCardinality(Nullable) во входном формате Avro. [#29132](https://github.com/ClickHouse/ClickHouse/pull/29132) ([Kruglov Pavel](https://github.com/Avogar)).
* Не допускать повторного использования ранее выданных учетных данных в случае межсерверного секрета (ранее перед выполнением INSERT через Buffer/Kafka в Distributed-таблицу с настроенным для этого кластера межсерверным секретом для данного соединения мог повторно использоваться ранее установленный пользователь). [#29060](https://github.com/ClickHouse/ClickHouse/pull/29060) ([Azat Khuzhin](https://github.com/azat)).
* Обработать `any_join_distinct_right_table_keys` при JOIN-е со словарём, закрыть [#29007](https://github.com/ClickHouse/ClickHouse/issues/29007). [#29014](https://github.com/ClickHouse/ClickHouse/pull/29014) ([Vladimir C](https://github.com/vdimir)).
* Исправлена ошибка «Not found column ... in block» при выполнении `JOIN` по столбцу-алиасу, что позволило закрыть [#26980](https://github.com/ClickHouse/ClickHouse/issues/26980). [#29008](https://github.com/ClickHouse/ClickHouse/pull/29008) ([Vladimir C](https://github.com/vdimir)).
* Исправлено количество потоков, используемых в подзапросе `GLOBAL IN` (из‑за исправления ошибки [#19414](https://github.com/ClickHouse/ClickHouse/issues/19414) он выполнялся только в одном потоке). [#28997](https://github.com/ClickHouse/ClickHouse/pull/28997) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлены некорректные оптимизации ORDER BY, если используется WITH FILL. Закрывает [#28908](https://github.com/ClickHouse/ClickHouse/issues/28908). Закрывает [#26049](https://github.com/ClickHouse/ClickHouse/issues/26049). [#28910](https://github.com/ClickHouse/ClickHouse/pull/28910) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены ошибки в функциях высшего порядка для массивов (`SIGSEGV` для `arrayCompact`/`ILLEGAL_COLUMN` для `arrayDifference`/`arrayCumSumNonNegative`) при использовании констант. [#28904](https://github.com/ClickHouse/ClickHouse/pull/28904) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено ожидание выполнения мутаций при `mutations_sync=2`. [#28889](https://github.com/ClickHouse/ClickHouse/pull/28889) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены запросы к внешним базам данных (например, MySQL) с несколькими столбцами в условии IN (например, `(k,v) IN ((1, 2))`). [#28888](https://github.com/ClickHouse/ClickHouse/pull/28888) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка с `LowCardinality` при ленивом (short-circuit) вычислении функций. Закрывает [#28884](https://github.com/ClickHouse/ClickHouse/issues/28884). [#28887](https://github.com/ClickHouse/ClickHouse/pull/28887) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено чтение подстолбцов из compact-частей. [#28873](https://github.com/ClickHouse/ClickHouse/pull/28873) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено условие гонки между `DROP PART` и `REPLACE/MOVE PARTITION`, которое в редких случаях могло приводить к расхождению реплик. [#28864](https://github.com/ClickHouse/ClickHouse/pull/28864) ([tavplubix](https://github.com/tavplubix)).
* Исправлена компиляция выражений с вычислением с коротким замыканием. [#28821](https://github.com/ClickHouse/ClickHouse/pull/28821) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен крайне редкий случай, когда реплики ReplicatedMergeTree могут расходиться после жёсткой перезагрузки всех реплик. Ошибка выглядит как `Part ... intersects (previous|next) part ...`. [#28817](https://github.com/ClickHouse/ClickHouse/pull/28817) ([alesapin](https://github.com/alesapin)).
* Улучшена проверка работоспособности соединения, а также добавлен перехват любых исключений при завершении работы `RabbitMQ`. [#28797](https://github.com/ClickHouse/ClickHouse/pull/28797) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена безобидная гонка в ReplicatedMergeTreeQueue. Не должна быть заметна пользователю, но могла приводить к неочевидным ошибкам. [#28734](https://github.com/ClickHouse/ClickHouse/pull/28734) ([alesapin](https://github.com/alesapin)).
* Исправлена возможная аварийная остановка при выполнении запроса `SELECT` с частично созданной агрегатной проекцией при возникновении исключения. [#28700](https://github.com/ClickHouse/ClickHouse/pull/28700) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка при создании распределённых таблиц, приводившая к дампу ядра при передаче ошибочных параметров. [#28686](https://github.com/ClickHouse/ClickHouse/pull/28686) ([Zhiyong Wang](https://github.com/ljcui)).
* Добавлены псевдонимы Settings.Names и Settings.Values для таблицы system.processes. [#28685](https://github.com/ClickHouse/ClickHouse/pull/28685) ([Vitaly](https://github.com/orloffv)).
* Поддержка библиотеки S2 Geometry: исправлено количество аргументов, которые принимают функции `s2RectAdd` и `s2RectContains`. [#28663](https://github.com/ClickHouse/ClickHouse/pull/28663) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлено некорректное приведение типа константы при использовании первичного ключа типа Nullable или LowCardinality. [#28636](https://github.com/ClickHouse/ClickHouse/pull/28636) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка &quot;Column is not under aggregate function and not in GROUP BY&quot; при использовании PREWHERE (исправляет: [#28461](https://github.com/ClickHouse/ClickHouse/issues/28461)). [#28502](https://github.com/ClickHouse/ClickHouse/pull/28502) ([Azat Khuzhin](https://github.com/azat)).

### Релиз ClickHouse v21.10, 2021-10-16. [Презентация](https://presentations.clickhouse.com/2021-release-21.10/), [Видео](https://www.youtube.com/watch?v=b9MeoOtAivQ) {#clickhouse-release-v2110-2021-10-16}

<iframe width="1024" height="576" src="https://www.youtube.com/embed/b9MeoOtAivQ" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

#### Обратно несовместимое изменение {#backward-incompatible-change-2}

* Теперь следующие настройки уровня таблицы MergeTree: `replicated_max_parallel_sends`, `replicated_max_parallel_sends_for_table`, `replicated_max_parallel_fetches`, `replicated_max_parallel_fetches_for_table` больше ни на что не влияют. Они никогда хорошо не работали и были заменены на `max_replicated_fetches_network_bandwidth`, `max_replicated_sends_network_bandwidth` и `background_fetches_pool_size`. [#28404](https://github.com/ClickHouse/ClickHouse/pull/28404) ([alesapin](https://github.com/alesapin)).

#### Новая возможность {#new-feature-2}

* Добавлена возможность создания определяемых пользователем функций (UDF) в виде лямбда-выражений. Синтаксис `CREATE FUNCTION {function_name} as ({parameters}) -> {function core}`. Пример `CREATE FUNCTION plus_one as (a) -> a + 1`. Авторы @Realist007. [#27796](https://github.com/ClickHouse/ClickHouse/pull/27796) ([Maksim Kita](https://github.com/kitaisreal)) [#23978](https://github.com/ClickHouse/ClickHouse/pull/23978) ([Realist007](https://github.com/Realist007)).
* Добавлен движок таблиц `Executable` и табличная функция `executable`. Они позволяют обрабатывать данные внешними скриптами в потоковом режиме. [#28102](https://github.com/ClickHouse/ClickHouse/pull/28102) ([Maksim Kita](https://github.com/kitaisreal)) ([ruct](https://github.com/ruct)).
* Добавлен движок таблиц `ExecutablePool`. Аналогичен `Executable`, но использует пул долго живущих процессов. [#28518](https://github.com/ClickHouse/ClickHouse/pull/28518) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлен запрос `ALTER TABLE ... MATERIALIZE COLUMN`. [#27038](https://github.com/ClickHouse/ClickHouse/pull/27038) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Добавлена поддержка записи по партициям (partitioned) в табличную функцию `s3`. [#23051](https://github.com/ClickHouse/ClickHouse/pull/23051) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Добавлена поддержка формата сжатия `lz4` (в дополнение к `gz`, `bz2`, `xz`, `zstd`) для импорта/экспорта данных. [#25310](https://github.com/ClickHouse/ClickHouse/pull/25310) ([Bharat Nallan](https://github.com/bharatnc)).
* Разрешены позиционные аргументы при включённой настройке `enable_positional_arguments`. Закрывает [#2592](https://github.com/ClickHouse/ClickHouse/issues/2592). [#27530](https://github.com/ClickHouse/ClickHouse/pull/27530) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Разрешено указывать пользовательские настройки, связанные с файловыми форматами, в секции `SETTINGS` запроса `CREATE` для таблиц `s3`. Это закрывает [#27580](https://github.com/ClickHouse/ClickHouse/issues/27580). [#28037](https://github.com/ClickHouse/ClickHouse/pull/28037) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Разрешено SSL-подключение для движка `RabbitMQ`. [#28365](https://github.com/ClickHouse/ClickHouse/pull/28365) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена функция `getServerPort` для получения порта сервера. Если порт не используется сервером, выбрасывается исключение. [#27900](https://github.com/ClickHouse/ClickHouse/pull/27900) ([Amos Bird](https://github.com/amosbird)).
* Добавлены функции преобразования между «Snowflake ID» и `DateTime`, `DateTime64`. См. [#27058](https://github.com/ClickHouse/ClickHouse/issues/27058). [#27704](https://github.com/ClickHouse/ClickHouse/pull/27704) ([jasine](https://github.com/jasine)).
* Добавлена функция `SHA512`. [#27830](https://github.com/ClickHouse/ClickHouse/pull/27830) ([zhanglistar](https://github.com/zhanglistar)).
* Добавлена настройка `log_queries_probability`, которая позволяет логировать в `query_log` только часть запросов. Закрывает [#16609](https://github.com/ClickHouse/ClickHouse/issues/16609). [#27527](https://github.com/ClickHouse/ClickHouse/pull/27527) ([Nikolay Degterinsky](https://github.com/evillique)).

#### Экспериментальная возможность {#experimental-feature-2}

* Тип диска `web` для хранения таблиц только для чтения на веб‑сервере в виде статических файлов. См. [#23982](https://github.com/ClickHouse/ClickHouse/issues/23982). [#25251](https://github.com/ClickHouse/ClickHouse/pull/25251) ([Kseniia Sumarokova](https://github.com/kssenii)). В основном он нужен для упрощения тестирования работы на разделяемом хранилище и для удобного импорта наборов данных. Не рекомендуется использовать до релиза 21.11.
* Добавлены новые команды `BACKUP` и `RESTORE`. [#21945](https://github.com/ClickHouse/ClickHouse/pull/21945) ([Vitaly Baranov](https://github.com/vitlibar)). Функциональность находится в разработке и не предназначена для использования в текущей версии.

#### Повышение производительности {#performance-improvement-2}

* Ускорены агрегатные функции `sumIf` и `countIf`. [#28272](https://github.com/ClickHouse/ClickHouse/pull/28272) ([Raúl Marín](https://github.com/Algunenano)).
* Создана виртуальная проекция для индексов `minmax`. Теперь, когда включена настройка `allow_experimental_projection_optimization`, запросы будут использовать minmax‑индекс вместо чтения данных, когда это возможно. [#26286](https://github.com/ClickHouse/ClickHouse/pull/26286) ([Amos Bird](https://github.com/amosbird)).
* Добавлены две проверки в `sequenceMatch` и `sequenceCount`, которые позволяют завершать выполнение раньше, если некоторой детерминированной части шаблона последовательности нет в списке событий. Это изменение разблокирует множество запросов, которые ранее завершались ошибкой из‑за достижения лимита операций, и в целом ускоряет конвейер обработки. [#27729](https://github.com/ClickHouse/ClickHouse/pull/27729) ([Jakub Kuklis](https://github.com/jkuklis)).
* Улучшен анализ первичного ключа за счёт всегда монотонной информации о бинарных функциях, в частности деления на ненулевую константу. [#28302](https://github.com/ClickHouse/ClickHouse/pull/28302) ([Amos Bird](https://github.com/amosbird)).
* Условие фильтрации `hasAll` теперь использует индексы пропуска данных на основе фильтра Блума. [#27984](https://github.com/ClickHouse/ClickHouse/pull/27984) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM)).
* Ускорена загрузка кусков данных за счёт откладывания процесса запуска таблицы. [#28313](https://github.com/ClickHouse/ClickHouse/pull/28313) ([Amos Bird](https://github.com/amosbird)).
* Исправлено возможное избыточное количество условий, перенесённых из `WHERE` в `PREWHERE` (оптимизация управляется настройкой `optimize_move_to_prewhere`). [#28139](https://github.com/ClickHouse/ClickHouse/pull/28139) ([lthaooo](https://github.com/lthaooo)).
* Настройка `optimize_distributed_group_by_sharding_key` включена по умолчанию. [#28105](https://github.com/ClickHouse/ClickHouse/pull/28105) ([Azat Khuzhin](https://github.com/azat)).

#### Улучшения {#improvement-2}

* Перед созданием таблицы `Distributed` проверять имя кластера и не допускать создание таблицы с неверным именем кластера. Исправляет [#27832](https://github.com/ClickHouse/ClickHouse/issues/27832). [#27927](https://github.com/ClickHouse/ClickHouse/pull/27927) ([tavplubix](https://github.com/tavplubix)).
* Добавлена агрегатная функция `quantileBFloat16Weighted` по аналогии с другими функциями quantile...Weighted, что закрывает [#27745](https://github.com/ClickHouse/ClickHouse/issues/27745). [#27758](https://github.com/ClickHouse/ClickHouse/pull/27758) ([Ivan Novitskiy](https://github.com/RedClusive)).
* Добавлена возможность создавать словари с пустым списком атрибутов. [#27905](https://github.com/ClickHouse/ClickHouse/pull/27905) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена интерактивная документация в `clickhouse-client` о том, как сбросить пароль. Это полезно в случае, когда пользователь установил ClickHouse, задал пароль и тут же его забыл. См. [#27750](https://github.com/ClickHouse/ClickHouse/issues/27750). [#27903](https://github.com/ClickHouse/ClickHouse/pull/27903) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка случая, когда данные во входном формате `JSONAsString` заключены в массив. Закрывает [#25517](https://github.com/ClickHouse/ClickHouse/issues/25517). [#25633](https://github.com/ClickHouse/ClickHouse/pull/25633) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен новый столбец `last_queue_update_exception` в таблицу `system.replicas`. [#26843](https://github.com/ClickHouse/ClickHouse/pull/26843) ([nvartolomei](https://github.com/nvartolomei)).
* Добавлена поддержка переподключений при отказе для таблиц `MaterializedPostgreSQL`. Закрывает [#28529](https://github.com/ClickHouse/ClickHouse/issues/28529). [#28614](https://github.com/ClickHouse/ClickHouse/pull/28614) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Генерировать уникальный UUID сервера при первом запуске. [#20089](https://github.com/ClickHouse/ClickHouse/pull/20089) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлена настройка `connection_wait_timeout` (значение по умолчанию — 5 секунд, 0 — не ждать) для движка `MySQL`. [#28474](https://github.com/ClickHouse/ClickHouse/pull/28474) ([Azat Khuzhin](https://github.com/azat)).
* Запрещено создавать `MaterializedPostgreSQL` с некорректными аргументами. Закрывает [#28423](https://github.com/ClickHouse/ClickHouse/issues/28423). [#28430](https://github.com/ClickHouse/ClickHouse/pull/28430) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Использовать реальный временный файл вместо предопределённого файла «rows&#95;sources» для вертикальных слияний. Это позволяет избежать создания мусорных каталогов на временных дисках. [#28299](https://github.com/ClickHouse/ClickHouse/pull/28299) ([Amos Bird](https://github.com/amosbird)).
* Добавлен параметр `libhdfs3_conf` в конфигурацию сервера вместо использования переменной окружения `LIBHDFS3_CONF`, экспортируемой в clickhouse-server.service. Это используется для настройки взаимодействия с HDFS. [#28268](https://github.com/ClickHouse/ClickHouse/pull/28268) ([Zhichang Yu](https://github.com/yuzhichang)).
* Исправлена проблема с удалением частей во временном состоянии, которая могла приводить к неожиданному исключению (`Part %name% doesn't exist`). Исправляет [#23661](https://github.com/ClickHouse/ClickHouse/issues/23661). [#28221](https://github.com/ClickHouse/ClickHouse/pull/28221) [#28221](https://github.com/ClickHouse/ClickHouse/issues/28221)) ([Azat Khuzhin](https://github.com/azat)).
* Исправить `zookeeper_log.address` (до первого патча в этом PR адрес всегда был `::`) и сократить количество вызовов `getpeername(2)` для этого столбца (так как при каждом добавлении записи в `zookeeper_log` вызывается `getpeername()`, кэшировать этот адрес в клиенте ZooKeeper, чтобы избежать этого). [#28212](https://github.com/ClickHouse/ClickHouse/pull/28212) ([Azat Khuzhin](https://github.com/azat)).
* Поддержка неявных преобразований между индексом оператора `[]` и ключом типа `Map` (например, между различными типами `Int`, а также `String` и `FixedString`). [#28096](https://github.com/ClickHouse/ClickHouse/pull/28096) ([Anton Popov](https://github.com/CurtizJ)).
* Реализована поддержка предложения `ON CONFLICT` при вставке в таблицу с движком PostgreSQL или в табличную функцию. Закрывает [#27727](https://github.com/ClickHouse/ClickHouse/issues/27727). [#28081](https://github.com/ClickHouse/ClickHouse/pull/28081) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Снижены ограничения для типа данных `Enum`, чтобы можно было присоединять совместимые данные. Закрывает [#26672](https://github.com/ClickHouse/ClickHouse/issues/26672). [#28028](https://github.com/ClickHouse/ClickHouse/pull/28028) ([Dmitry Novik](https://github.com/novikd)).
* Добавлена настройка `empty_result_for_aggregation_by_constant_keys_on_empty_set` для управления поведением группировки по константным ключам над пустым набором данных. Это позволяет вернуть прежнее поведение из [#6842](https://github.com/ClickHouse/ClickHouse/issues/6842). [#27932](https://github.com/ClickHouse/ClickHouse/pull/27932) ([Amos Bird](https://github.com/amosbird)).
* Добавлена настройка `replication_wait_for_inactive_replica_timeout`. Она позволяет указать, как долго ждать, пока неактивные реплики выполнят запрос `ALTER`/`OPTIMZE`/`TRUNCATE` (значение по умолчанию — 120 секунд). Если `replication_alter_partitions_sync` равно 2 и некоторые реплики остаются неактивными дольше, чем `replication_wait_for_inactive_replica_timeout` секунд, будет сгенерировано исключение `UNFINISHED`. [#27931](https://github.com/ClickHouse/ClickHouse/pull/27931) ([tavplubix](https://github.com/tavplubix)).
* Добавлена поддержка лямбда-аргумента для трансформера столбца `APPLY`, что позволяет вызывать функции с более чем одним аргументом. Реализация для [#27877](https://github.com/ClickHouse/ClickHouse/issues/27877). [#27901](https://github.com/ClickHouse/ClickHouse/pull/27901) ([Amos Bird](https://github.com/amosbird)).
* Включить `tcp_keep_alive_timeout` по умолчанию. [#27882](https://github.com/ClickHouse/ClickHouse/pull/27882) ([Azat Khuzhin](https://github.com/azat)).
* Улучшена отмена удалённых запросов (в случае аварийного завершения удалённого сервера). [#27881](https://github.com/ClickHouse/ClickHouse/pull/27881) ([Azat Khuzhin](https://github.com/azat)).
* Используйте многокомпонентную (multipart) загрузку при копировании для больших объектов S3. [#27858](https://github.com/ClickHouse/ClickHouse/pull/27858) ([ianton-ru](https://github.com/ianton-ru)).
* Разрешён обход символьных ссылок в пути к словарю библиотеки. [#27815](https://github.com/ClickHouse/ClickHouse/pull/27815) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Теперь `ALTER MODIFY COLUM` столбца из типа `T` в `Nullable(T)` не требует выполнения мутации. [#27787](https://github.com/ClickHouse/ClickHouse/pull/27787) ([victorgao](https://github.com/kafka1991)).
* Не игнорировать ошибки без сообщения и не учитывать задержки в `ReadBufferFromS3`. [#27484](https://github.com/ClickHouse/ClickHouse/pull/27484) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Улучшить `ALTER ... MATERIALIZE TTL` за счёт пересчёта только метаданных без фактического применения TTL. [#27019](https://github.com/ClickHouse/ClickHouse/pull/27019) ([lthaooo](https://github.com/lthaooo)).
* Добавлена возможность считывать список пользовательских доменов верхнего уровня без новой строки в конце файла. [#28213](https://github.com/ClickHouse/ClickHouse/pull/28213) ([Azat Khuzhin](https://github.com/azat)).

#### Исправление ошибки {#bug-fix-1}

* Устранены случаи, при которых чтение сжатых данных из `carbon-clickhouse` приводило к ошибке &#39;attempt to read after end of file&#39;. Закрывает [#26149](https://github.com/ClickHouse/ClickHouse/issues/26149). [#28150](https://github.com/ClickHouse/ClickHouse/pull/28150) ([FArthur-cmd](https://github.com/FArthur-cmd)).
* Исправлена проверка прав доступа при выполнении запроса `GRANT WITH REPLACE` с указанием `ON CLUSTER`. Этот PR улучшает исправление из [#27001](https://github.com/ClickHouse/ClickHouse/pull/27701). [#27983](https://github.com/ClickHouse/ClickHouse/pull/27983) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена возможность выполнять выборку с `extremes = 1` из столбца типа `LowCardinality(UUID)`. [#27918](https://github.com/ClickHouse/ClickHouse/pull/27918) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено приведение типов в стиле PostgreSQL (оператор `::`) для отрицательных чисел. [#27876](https://github.com/ClickHouse/ClickHouse/pull/27876) ([Anton Popov](https://github.com/CurtizJ)).
* После [#26864](https://github.com/ClickHouse/ClickHouse/pull/26864). Исправлено завершение работы `NamedSessionStorage`: контексты сессий, хранящиеся в `NamedSessionStorage`, теперь уничтожаются до уничтожения глобального контекста. [#27875](https://github.com/ClickHouse/ClickHouse/pull/27875) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправление ошибки в режиме &quot;strict&quot; функции `windowFunnel`. Это исправляет [#27469](https://github.com/ClickHouse/ClickHouse/issues/27469). [#27563](https://github.com/ClickHouse/ClickHouse/pull/27563) ([achimbab](https://github.com/achimbab)).
* Исправлен бесконечный цикл при чтении усечённого архива `bzip2`. [#28543](https://github.com/ClickHouse/ClickHouse/pull/28543) ([Azat Khuzhin](https://github.com/azat)).
* Устранён конфликт UUID в `DROP TABLE` для внутренних DDL-запросов из `MaterializedMySQL`. MaterializedMySQL — экспериментальная функция. [#28533](https://github.com/ClickHouse/ClickHouse/pull/28533) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка `There is no subcolumn` при выполнении запроса `SELECT` к таблицам, содержащим столбцы типа `Nested` и скалярные столбцы с точкой в имени и тем же префиксом, что и у `Nested` (например, `n.id UInt32, n.arr1 Array(UInt64), n.arr2 Array(UInt64)`). [#28531](https://github.com/ClickHouse/ClickHouse/pull/28531) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка, которая могла приводить к сообщению `Existing table metadata in ZooKeeper differs in sorting key expression.` после выполнения оператора `ALTER` над `ReplicatedVersionedCollapsingMergeTree`. Исправлена [#28515](https://github.com/ClickHouse/ClickHouse/issues/28515). [#28528](https://github.com/ClickHouse/ClickHouse/pull/28528) ([alesapin](https://github.com/alesapin)).
* Исправлена возможная утечка наблюдателей ZooKeeper (незначительная проблема) при фоновой обработке распределённой очереди DDL. Закрывает [#26036](https://github.com/ClickHouse/ClickHouse/issues/26036). [#28446](https://github.com/ClickHouse/ClickHouse/pull/28446) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка отсутствия кавычек у имён таблиц в движке `MaterializedPostgreSQL`. Закрывает [#28316](https://github.com/ClickHouse/ClickHouse/issues/28316). [#28433](https://github.com/ClickHouse/ClickHouse/pull/28433) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено некорректное поведение неприсоединённых строк из nullable-столбца. Закрывает [#27691](https://github.com/ClickHouse/ClickHouse/issues/27691). [#28349](https://github.com/ClickHouse/ClickHouse/pull/28349) ([vdimir](https://github.com/vdimir)).
* Исправлена оптимизация индекса NOT IN для случая, когда используются не все ключевые столбцы. Это исправляет [#28120](https://github.com/ClickHouse/ClickHouse/issues/28120). [#28315](https://github.com/ClickHouse/ClickHouse/pull/28315) ([Amos Bird](https://github.com/amosbird)).
* Исправлена проблема с пересекающимися частями, вызванная заменой новой части на пустую. [#28310](https://github.com/ClickHouse/ClickHouse/pull/28310) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены непоследовательные результаты в запросах с `ORDER BY` и таблицами `Merge` при включённой настройке `optimize_read_in_order`. [#28266](https://github.com/ClickHouse/ClickHouse/pull/28266) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено возможное чтение неинициализированной памяти при запросах с типом `Nullable(LowCardinality)` и настройкой `extremes`, установленной в 1. Тем самым исправлена [#28165](https://github.com/ClickHouse/ClickHouse/issues/28165). [#28205](https://github.com/ClickHouse/ClickHouse/pull/28205) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Несколько небольших исправлений для проекций. Подробное описание см. в PR. [#28178](https://github.com/ClickHouse/ClickHouse/pull/28178) ([Amos Bird](https://github.com/amosbird)).
* Исправлены крайне редкие сегфолты при завершении работы из-за неправильного порядка остановки контекста и перезагрузчика конфигурации. [#28088](https://github.com/ClickHouse/ClickHouse/pull/28088) ([nvartolomei](https://github.com/nvartolomei)).
* Исправлена обработка значения NULL типа `Nullable(String)` в функции `JSONExtract`. Это устраняет проблемы [#27929](https://github.com/ClickHouse/ClickHouse/issues/27929) и [#27930](https://github.com/ClickHouse/ClickHouse/issues/27930). Ошибка была внесена в [https://github.com/ClickHouse/ClickHouse/pull/25452](https://github.com/ClickHouse/ClickHouse/pull/25452). [#27939](https://github.com/ClickHouse/ClickHouse/pull/27939) ([Amos Bird](https://github.com/amosbird)).
* Несколько исправлений для нового инструмента `clickhouse-keeper`. Исправлена редкая ошибка в `clickhouse-keeper`, когда клиент мог получить ответ наблюдателя (watch response) раньше, чем ответ на исходный запрос (request-response). [#28197](https://github.com/ClickHouse/ClickHouse/pull/28197) ([alesapin](https://github.com/alesapin)). Исправлено некорректное поведение в `clickhouse-keeper`, когда наблюдатели списка (`getChildren`) срабатывали при `set`-запросах для дочерних элементов. [#28190](https://github.com/ClickHouse/ClickHouse/pull/28190) ([alesapin](https://github.com/alesapin)). Исправлен редкий случай, когда изменения настроек `clickhouse-keeper` могли приводить к потере записей логов и зависанию сервера. [#28360](https://github.com/ClickHouse/ClickHouse/pull/28360) ([alesapin](https://github.com/alesapin)). Исправлена ошибка в `clickhouse-keeper`, которая могла приводить к бесконечной генерации логов при уменьшении `rotate_logs_interval`. [#28152](https://github.com/ClickHouse/ClickHouse/pull/28152) ([alesapin](https://github.com/alesapin)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-2}

* Включён Thread Fuzzer в стресс‑тесте. Thread Fuzzer — это возможность ClickHouse, которая позволяет тестировать большее количество вариантов планирования потоков и обнаруживать больше потенциальных проблем. Это закрывает [#9813](https://github.com/ClickHouse/ClickHouse/issues/9813). Это закрывает [#9814](https://github.com/ClickHouse/ClickHouse/issues/9814). Это закрывает [#9515](https://github.com/ClickHouse/ClickHouse/issues/9515). Это закрывает [#9516](https://github.com/ClickHouse/ClickHouse/issues/9516). [#27538](https://github.com/ClickHouse/ClickHouse/pull/27538) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлен новый уровень логирования `test` для тестовых сред. Он ещё более подробный, чем стандартный `trace`. [#28559](https://github.com/ClickHouse/ClickHouse/pull/28559) ([alesapin](https://github.com/alesapin)).
* На этапе конфигурирования CMake теперь выводится информация о состоянии git. [#28047](https://github.com/ClickHouse/ClickHouse/pull/28047) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM)).
* Временно переключён репозиторий ubuntu apt на зеркало ru.archive.ubuntu.com, так как репозиторий по умолчанию (archive.ubuntu.com) не отвечает из нашей системы CI. [#28016](https://github.com/ClickHouse/ClickHouse/pull/28016) ([Ilya Yatsishin](https://github.com/qoega)).

### Релиз ClickHouse v21.9, 2021-09-09 {#clickhouse-release-v219-2021-09-09}

#### Обратно несовместимое изменение {#backward-incompatible-change-3}

* Не выводить конечные нули в текстовом представлении типов `Decimal`. Пример: `1.23` будет выведено вместо `1.230000` для десятичного числа с масштабом 6. Это закрывает [#15794](https://github.com/ClickHouse/ClickHouse/issues/15794). Это может привести к небольшой несовместимости, если ваши приложения каким‑то образом полагались на конечные нули. Сериализацию в выходных форматах можно контролировать с помощью настройки `output_format_decimal_trailing_zeros`. Реализация `toString` и приведения к String изменена безусловно. [#27680](https://github.com/ClickHouse/ClickHouse/pull/27680) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Запретить применение параметрической агрегатной функции с комбинатором `-Merge` к состоянию агрегатной функции, если это состояние было получено агрегатной функцией с другими параметрами. Например, состояние `fooState(42)(x)` нельзя финализировать с помощью `fooMerge(s)` или `fooMerge(123)(s)`, параметры должны быть явно указаны как `fooMerge(42)(s)` и должны совпадать. Это не затрагивает некоторые специальные агрегатные функции, такие как `quantile` и `sequence*`, которые используют параметры только для финализации. [#26847](https://github.com/ClickHouse/ClickHouse/pull/26847) ([tavplubix](https://github.com/tavplubix)).
* В режиме clickhouse-local всегда считать локальные адреса с портом удалёнными. [#26736](https://github.com/ClickHouse/ClickHouse/pull/26736) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена проблема, из‑за которой в случае сложных запросов с алиасами столбцов, совпадающими с именами выражений, мог происходить некорректный каст. Это исправляет [#25447](https://github.com/ClickHouse/ClickHouse/issues/25447). Это исправляет [#26914](https://github.com/ClickHouse/ClickHouse/issues/26914). Это исправление может привести к несовместимости с предыдущими версиями: если существуют разные выражения с одинаковыми именами, будет выброшено исключение. Это может сломать некоторые редкие случаи, когда установлена настройка `enable_optimize_predicate_expression`. [#26639](https://github.com/ClickHouse/ClickHouse/pull/26639) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Теперь скалярный подзапрос всегда возвращает результат типа `Nullable`, если его тип потенциально может быть `Nullable`. Это необходимо, потому что в случае пустого подзапроса его результат должен быть `Null`. Ранее могла возникать ошибка о несовместимых типах (вывод типа не выполняет скалярный подзапрос и мог использовать не‑nullable тип). Скалярный подзапрос с пустым результатом, который не может быть преобразован к `Nullable` (например, `Array` или `Tuple`), теперь выбрасывает ошибку. Исправляет [#25411](https://github.com/ClickHouse/ClickHouse/issues/25411). [#26423](https://github.com/ClickHouse/ClickHouse/pull/26423) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Введён синтаксис here-документов. Пример: `SELECT $doc$ VALUE $doc$`. [#26671](https://github.com/ClickHouse/ClickHouse/pull/26671) ([Maksim Kita](https://github.com/kitaisreal)). Это изменение обратно несовместимо, если в запросе есть идентификаторы, содержащие `$` [#28768](https://github.com/ClickHouse/ClickHouse/issues/28768).
* Теперь индексы могут обрабатывать типы Nullable, включая `isNull` и `isNotNull`. [#12433](https://github.com/ClickHouse/ClickHouse/pull/12433) и [#12455](https://github.com/ClickHouse/ClickHouse/pull/12455) ([Amos Bird](https://github.com/amosbird)) и [#27250](https://github.com/ClickHouse/ClickHouse/pull/27250) ([Azat Khuzhin](https://github.com/azat)). Но это было сделано с изменением формата на диске, и хотя новый сервер может читать старые данные, старый сервер не может. Также, если у вас есть индексы пропуска данных `MINMAX`, вы можете получить ошибку `Data after mutation/merge is not byte-identical`, так как новый индекс будет иметь расширение `.idx2`, тогда как раньше это было `.idx`. Это означает, что вам не следует откладывать обновление всех существующих реплик в этом случае, иначе, если старая реплика (&lt;21.9) скачает данные с новой реплики с версией 21.9+, она не сможет применить индекс к загруженной части.

#### Новая функциональность {#new-feature-3}

* Реализована укороченная (short-circuit) схема вычисления функций, что закрывает [#12587](https://github.com/ClickHouse/ClickHouse/issues/12587). Добавлена настройка `short_circuit_function_evaluation` для управления укороченной схемой вычисления функций. [#23367](https://github.com/ClickHouse/ClickHouse/pull/23367) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка операторов INTERSECT, EXCEPT, ANY и ALL. [#24757](https://github.com/ClickHouse/ClickHouse/pull/24757) ([Kirill Ershov](https://github.com/zdikov)). ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка шифрования на уровне виртуальной файловой системы (шифрование данных на диске) с использованием алгоритма AES-CTR. [#24206](https://github.com/ClickHouse/ClickHouse/pull/24206) ([Latysheva Alexandra](https://github.com/alexelex)). ([Vitaly Baranov](https://github.com/vitlibar)) [#26733](https://github.com/ClickHouse/ClickHouse/pull/26733) [#26377](https://github.com/ClickHouse/ClickHouse/pull/26377) [#26465](https://github.com/ClickHouse/ClickHouse/pull/26465).
* Добавлены функции обработки естественного языка (NLP) для токенизации, стемминга, лемматизации и поиска по расширениям синонимов. [#24997](https://github.com/ClickHouse/ClickHouse/pull/24997) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена интеграция с библиотекой геометрии S2. [#24980](https://github.com/ClickHouse/ClickHouse/pull/24980) ([Andr0901](https://github.com/Andr0901)). ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлены движок таблицы SQLite, табличная функция и движок базы данных. [#24194](https://github.com/ClickHouse/ClickHouse/pull/24194) ([Arslan Gumerov](https://github.com/g-arslan)). ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка пользовательского запроса для источников словаря `MySQL`, `PostgreSQL`, `ClickHouse`, `JDBC`, `Cassandra`. Закрывает [#1270](https://github.com/ClickHouse/ClickHouse/issues/1270). [#26995](https://github.com/ClickHouse/ClickHouse/pull/26995) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлено общее (реплицируемое) хранилище пользователей, ролей, политик по строкам, квот и профилей настроек на базе ZooKeeper. [#27426](https://github.com/ClickHouse/ClickHouse/pull/27426) ([Kevin Michel](https://github.com/kmichel-aiven)).
* Добавлена поддержка сжатия для `INTO OUTFILE` с автоматическим выбором алгоритма сжатия. Закрывает [#3473](https://github.com/ClickHouse/ClickHouse/issues/3473). [#27134](https://github.com/ClickHouse/ClickHouse/pull/27134) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* Добавлена поддержка `INSERT ... FROM INFILE` по аналогии с `SELECT ... INTO OUTFILE`. [#27655](https://github.com/ClickHouse/ClickHouse/pull/27655) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* Добавлен словарь `complex_key_range_hashed`. Закрыта задача [#22029](https://github.com/ClickHouse/ClickHouse/issues/22029). [#27629](https://github.com/ClickHouse/ClickHouse/pull/27629) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена поддержка выражений в секции JOIN ON. Закрыта задача [#21868](https://github.com/ClickHouse/ClickHouse/issues/21868). [#24420](https://github.com/ClickHouse/ClickHouse/pull/24420) ([Vladimir C](https://github.com/vdimir)).
* Когда клиент подключается к серверу, он получает информацию обо всех предупреждениях, которые уже были собраны сервером (это можно отключить с помощью опции `--no-warnings`). Добавлена таблица `system.warnings` для сбора предупреждений о конфигурации сервера. [#26246](https://github.com/ClickHouse/ClickHouse/pull/26246) ([Filatenkov Artur](https://github.com/FArthur-cmd)). [#26282](https://github.com/ClickHouse/ClickHouse/pull/26282) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* Разрешено использовать константные выражения из предложений WITH и SELECT в параметрах агрегатных функций. Закрывает [#10945](https://github.com/ClickHouse/ClickHouse/issues/10945). [#27531](https://github.com/ClickHouse/ClickHouse/pull/27531) ([abel-cheng](https://github.com/abel-cheng)).
* Добавлена функция `tupleToNameValuePairs`, которая преобразует именованный кортеж в массив пар. [#27505](https://github.com/ClickHouse/ClickHouse/pull/27505) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM)).
* Добавлена поддержка метода сжатия `bzip2` для импорта и экспорта. Закрывает [#22428](https://github.com/ClickHouse/ClickHouse/issues/22428). [#27377](https://github.com/ClickHouse/ClickHouse/pull/27377) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена функция `bitmapSubsetOffsetLimit(bitmap, offset, cardinality_limit)`. Она создаёт подмножество bitmap, ограниченное числом результатов `cardinality_limit` и начинающееся со смещения `offset`. [#27234](https://github.com/ClickHouse/ClickHouse/pull/27234) ([DHBin](https://github.com/DHBin)).
* Добавлен столбец `default_database` в `system.users`. [#27054](https://github.com/ClickHouse/ClickHouse/pull/27054) ([kevin wan](https://github.com/MaxWk)).
* Добавлена поддержка макросов `cluster` внутри табличных функций &#39;cluster&#39; и &#39;clusterAllReplicas&#39;. [#26913](https://github.com/ClickHouse/ClickHouse/pull/26913) ([polyprogrammist](https://github.com/PolyProgrammist)).
* Добавлены новые функции `currentRoles()`, `enabledRoles()`, `defaultRoles()`. [#26780](https://github.com/ClickHouse/ClickHouse/pull/26780) ([Vitaly Baranov](https://github.com/vitlibar)).
* Новые функции `currentProfiles()`, `enabledProfiles()`, `defaultProfiles()`. [#26714](https://github.com/ClickHouse/ClickHouse/pull/26714) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлены функции для получения (initial&#95;)query&#95;id текущего запроса. Это закрывает [#23682](https://github.com/ClickHouse/ClickHouse/issues/23682). [#26410](https://github.com/ClickHouse/ClickHouse/pull/26410) ([Alexey Boykov](https://github.com/mathalex)).
* Добавлена поддержка `REPLACE GRANT`. [#26384](https://github.com/ClickHouse/ClickHouse/pull/26384) ([Caspian](https://github.com/Cas-pian)).
* Запрос `EXPLAIN` теперь имеет режим `EXPLAIN ESTIMATE ...`, который отображает информацию о читаемых строках, метках и частях из таблиц MergeTree. Закрывает [#23941](https://github.com/ClickHouse/ClickHouse/issues/23941). [#26131](https://github.com/ClickHouse/ClickHouse/pull/26131) ([fastio](https://github.com/fastio)).
* Добавлена таблица `system.zookeeper_log`. В эту таблицу записываются все действия клиента ZooKeeper. Реализация [#25449](https://github.com/ClickHouse/ClickHouse/issues/25449). [#26129](https://github.com/ClickHouse/ClickHouse/pull/26129) ([tavplubix](https://github.com/tavplubix)).
* Репликация без копирования данных для `ReplicatedMergeTree` поверх хранилища `HDFS`. [#25918](https://github.com/ClickHouse/ClickHouse/pull/25918) ([Zhichang Yu](https://github.com/yuzhichang)).
* Добавлена возможность вставки типа данных Nested в виде массива структур во входных форматах `Arrow`, `ORC` и `Parquet`. [#25902](https://github.com/ClickHouse/ClickHouse/pull/25902) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен новый тип данных `Date32` (хранит данные как Int32) с тем же диапазоном дат, что и `DateTime64`; добавлена поддержка загрузки данных формата Parquet Date32 в ClickHouse `Date32`. Добавлена новая функция `toDate32`, аналогичная `toDate`. [#25774](https://github.com/ClickHouse/ClickHouse/pull/25774) ([LiuNeng](https://github.com/liuneng1994)).
* Добавлена возможность задавать пользователям базу данных по умолчанию. [#25268](https://github.com/ClickHouse/ClickHouse/issues/25268). [#25687](https://github.com/ClickHouse/ClickHouse/pull/25687) ([kevin wan](https://github.com/MaxWk)).
* Добавлен необязательный параметр в движок `MongoDB`, позволяющий указывать параметры строки подключения и использовать SSL-соединение. Закрывает [#21189](https://github.com/ClickHouse/ClickHouse/issues/21189). Закрывает [#21041](https://github.com/ClickHouse/ClickHouse/issues/21041). [#22045](https://github.com/ClickHouse/ClickHouse/pull/22045) ([Omar Bazaraa](https://github.com/OmarBazaraa)).

#### Экспериментальная функция {#experimental-feature-3}

* Добавлен кодек сжатия `AES_128_GCM_SIV`, который шифрует столбцы вместо их сжатия. [#19896](https://github.com/ClickHouse/ClickHouse/pull/19896) ([PHO](https://github.com/depressed-pho)). Будет переписан, не используйте его.
* `MaterializeMySQL` переименован в `MaterializedMySQL`. [#26822](https://github.com/ClickHouse/ClickHouse/pull/26822) ([tavplubix](https://github.com/tavplubix)).

#### Улучшение производительности {#performance-improvement-3}

* Улучшена производительность быстрых запросов при `max_execution_time = 0` за счет уменьшения количества системных вызовов `clock_gettime`. [#27325](https://github.com/ClickHouse/ClickHouse/pull/27325) ([filimonov](https://github.com/filimonov)).
* Специализированы сравнения, связанные с типами даты и времени, для достижения лучшей производительности. Это исправляет [#27083](https://github.com/ClickHouse/ClickHouse/issues/27083). [#27122](https://github.com/ClickHouse/ClickHouse/pull/27122) ([Amos Bird](https://github.com/amosbird)).
* Реализовано совместное использование файловых дескрипторов при параллельном чтении одних и тех же файлов. На Linux нет заметной разницы в производительности. Но количество открытых файлов на типичных серверах будет значительно (в 10–100 раз) меньше, и это упрощает эксплуатацию. См. [#26214](https://github.com/ClickHouse/ClickHouse/issues/26214). [#26768](https://github.com/ClickHouse/ClickHouse/pull/26768) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Снижена латентность коротких запросов, которые требуют чтения из таблиц с большим количеством столбцов. [#26371](https://github.com/ClickHouse/ClickHouse/pull/26371) ([Anton Popov](https://github.com/CurtizJ)).
* Отключено построение множеств для индексов при анализе запроса. [#26365](https://github.com/ClickHouse/ClickHouse/pull/26365) ([Raúl Marín](https://github.com/Algunenano)).
* Векторизовано вычисление `SUM` для типов `Nullable` целых чисел с нативным представлением ([David Manzanares](https://github.com/davidmanzanares), [Raúl Marín](https://github.com/Algunenano)). [#26248](https://github.com/ClickHouse/ClickHouse/pull/26248) ([Raúl Marín](https://github.com/Algunenano)).
* Компилируются выражения, включающие столбцы с типами `Enum`. [#26237](https://github.com/ClickHouse/ClickHouse/pull/26237) ([Maksim Kita](https://github.com/kitaisreal)).
* Компилируются агрегатные функции `groupBitOr`, `groupBitAnd`, `groupBitXor`. [#26161](https://github.com/ClickHouse/ClickHouse/pull/26161) ([Maksim Kita](https://github.com/kitaisreal)).
* Улучшено использование памяти за счет более точного прогнозирования размера блока при чтении пустых столбцов с DEFAULT. Закрывает [#17317](https://github.com/ClickHouse/ClickHouse/issues/17317). [#25917](https://github.com/ClickHouse/ClickHouse/pull/25917) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Снижено потребление памяти и количество читаемых строк в запросах с `ORDER BY primary_key`. [#25721](https://github.com/ClickHouse/ClickHouse/pull/25721) ([Anton Popov](https://github.com/CurtizJ)).
* По умолчанию включен `distributed_push_down_limit`. [#27104](https://github.com/ClickHouse/ClickHouse/pull/27104) ([Azat Khuzhin](https://github.com/azat)).
* Обеспечена монотонность `toTimeZone`, когда `timeZone` имеет константное значение, чтобы поддержать отсечение партиций при использовании SQL‑запросов вида: [#26261](https://github.com/ClickHouse/ClickHouse/pull/26261) ([huangzhaowei](https://github.com/SaintBacchus)).

#### Улучшение {#improvement-3}

* Оконные функции помечены как готовые к общему использованию. Настройка `allow_experimental_window_functions` удалена. [#27184](https://github.com/ClickHouse/ClickHouse/pull/27184) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Улучшена совместимость с часовыми поясами, имеющими смещение, не равное целому числу минут. [#27080](https://github.com/ClickHouse/ClickHouse/pull/27080) ([Raúl Marín](https://github.com/Algunenano)).
* Если файловый дескриптор в таблице `File` указывает на обычный файл — разрешить многократное чтение из него. Это позволяет `clickhouse-local` многократно читать из stdin (с несколькими запросами SELECT или подзапросами), если stdin представляет собой обычный файл, например: `clickhouse-local --query "SELECT * FROM table UNION ALL SELECT * FROM table" ... &lt; file`. Это исправляет [#11124](https://github.com/ClickHouse/ClickHouse/issues/11124). Совместно с ([alexey-milovidov](https://github.com/alexey-milovidov)). [#25960](https://github.com/ClickHouse/ClickHouse/pull/25960) ([BoloniniD](https://github.com/BoloniniD)).
* Удалён дублирующийся анализ индексов и исключены возможные некорректные проверки ограничения `LIMIT` во время анализа проекций. [#27742](https://github.com/ClickHouse/ClickHouse/pull/27742) ([Amos Bird](https://github.com/amosbird)).
* Включена возможность передавать параметры запроса в теле HTTP‑запросов. [#27706](https://github.com/ClickHouse/ClickHouse/pull/27706) ([Hermano Lustosa](https://github.com/hllustosa)).
* Запрещено использовать `arrayJoin` в выражениях партиционирования. [#27648](https://github.com/ClickHouse/ClickHouse/pull/27648) ([Raúl Marín](https://github.com/Algunenano)).
* Записывать IP-адрес клиента в лог при ошибке аутентификации. [#27514](https://github.com/ClickHouse/ClickHouse/pull/27514) ([Misko Lee](https://github.com/imiskolee)).
* Используйте bytes вместо strings для бинарных данных в протоколе gRPC. [#27431](https://github.com/ClickHouse/ClickHouse/pull/27431) ([Vitaly Baranov](https://github.com/vitlibar)).
* Отправлять ответ с сообщением об ошибке, если HTTP-порт не настроен, а пользователь пытается отправить HTTP-запрос на TCP-порт. [#27385](https://github.com/ClickHouse/ClickHouse/pull/27385) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM)).
* Добавлена функция `_CAST` для внутреннего использования, которая не сохраняет nullability типа, тогда как обычное приведение типов сохраняет его в соответствии с настройкой `cast_keep_nullable`. Закрывает [#12636](https://github.com/ClickHouse/ClickHouse/issues/12636). [#27382](https://github.com/ClickHouse/ClickHouse/pull/27382) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена настройка `log_formatted_queries` для логирования дополнительной отформатированной версии запроса в `system.query_log`. Это полезно для анализа нормализованных запросов, так как функции `normalizeQuery` и `normalizeQueryKeepNames` не выполняют разбор и форматирование запросов ради повышения производительности. [#27380](https://github.com/ClickHouse/ClickHouse/pull/27380) ([Amos Bird](https://github.com/amosbird)).
* Добавлены две настройки `max_hyperscan_regexp_length` и `max_hyperscan_regexp_total_length`, чтобы предотвратить использование чрезмерно больших регулярных выражений в функциях, связанных с hyperscan, таких как `multiMatchAny`. [#27378](https://github.com/ClickHouse/ClickHouse/pull/27378) ([Amos Bird](https://github.com/amosbird)).
* Память, потребляемая битовыми агрегатными функциями, теперь учитывается при применении лимитов памяти. Это закрывает [#26555](https://github.com/ClickHouse/ClickHouse/issues/26555). [#27252](https://github.com/ClickHouse/ClickHouse/pull/27252) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлено 10-секундное кэширование для резолвера S3-прокси. [#27216](https://github.com/ClickHouse/ClickHouse/pull/27216) ([ianton-ru](https://github.com/ianton-ru)).
* Глобальный мьютекс заменён на отдельные блокировки при построении регулярных выражений. Это помогает избежать ситуации, когда длительное построение регулярного выражения блокирует другие связанные потоки. [#27211](https://github.com/ClickHouse/ClickHouse/pull/27211) ([Amos Bird](https://github.com/amosbird)).
* Поддержка схем в движке базы данных PostgreSQL. Закрывает [#27166](https://github.com/ClickHouse/ClickHouse/issues/27166). [#27198](https://github.com/ClickHouse/ClickHouse/pull/27198) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отслеживание использования памяти в clickhouse-client. [#27191](https://github.com/ClickHouse/ClickHouse/pull/27191) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* Попробуйте записывать `query_kind` в `system.query_log` даже если запрос не удалось запустить. [#27182](https://github.com/ClickHouse/ClickHouse/pull/27182) ([Amos Bird](https://github.com/amosbird)).
* В таблицу `system.replicas` добавлен столбец `replica_is_active`, который показывает, активна ли реплика. Закрывает [#27138](https://github.com/ClickHouse/ClickHouse/issues/27138). [#27180](https://github.com/ClickHouse/ClickHouse/pull/27180) ([Maksim Kita](https://github.com/kitaisreal)).
* Разрешена передача параметров запроса через URI сервера в веб-интерфейсе. [#27177](https://github.com/ClickHouse/ClickHouse/pull/27177) ([kolsys](https://github.com/kolsys)).
* Добавлена новая метрика `MaxPushedDDLEntryID`, представляющая собой максимальный идентификатор DDL-записи, который текущий узел отправляет в ZooKeeper. [#27174](https://github.com/ClickHouse/ClickHouse/pull/27174) ([Fuwang Hu](https://github.com/fuwhu)).
* Улучшены проверки существования и проверки на узел с пустой строкой при создании znode в `clickhouse-keeper`. [#27125](https://github.com/ClickHouse/ClickHouse/pull/27125) ([小路](https://github.com/nicelulu)).
* Merge JOIN корректно обрабатывает пустое множество справа. [#27078](https://github.com/ClickHouse/ClickHouse/pull/27078) ([Vladimir C](https://github.com/vdimir)).
* Теперь функции могут быть константами на уровне шарда, что означает, что если они выполняются в контексте распределённой таблицы, то генерируют обычный столбец, а в противном случае возвращают константное значение. Наиболее заметные функции: `hostName()`, `tcpPort()`, `version()`, `buildId()`, `uptime()` и т. д. [#27020](https://github.com/ClickHouse/ClickHouse/pull/27020) ([Amos Bird](https://github.com/amosbird)).
* Обновлён `extractAllGroupsHorizontal` — верхнюю границу числа совпадений в строке можно задать с помощью необязательного третьего аргумента. [#26961](https://github.com/ClickHouse/ClickHouse/pull/26961) ([Vasily Nemkov](https://github.com/Enmk)).
* Экспортировать статистику `RocksDB` через таблицу system.rocksdb. Читать параметры RocksDB из конфигурации ClickHouse (ключи `rocksdb...`). ПРИМЕЧАНИЕ: ClickHouse не зависит от RocksDB, это всего лишь один из дополнительных интеграционных движков хранения данных. [#26821](https://github.com/ClickHouse/ClickHouse/pull/26821) ([Azat Khuzhin](https://github.com/azat)).
* Менее многословные внутренние логи RocksDB. ПРИМЕЧАНИЕ: ClickHouse не полагается на RocksDB, это всего лишь один из дополнительных интеграционных движков хранения данных. Тем самым закрывается [#26252](https://github.com/ClickHouse/ClickHouse/issues/26252). [#26789](https://github.com/ClickHouse/ClickHouse/pull/26789) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Изменение ролей по умолчанию влияет только на новые сеансы. [#26759](https://github.com/ClickHouse/ClickHouse/pull/26759) ([Vitaly Baranov](https://github.com/vitlibar)).
* Watchdog по умолчанию отключён в Docker. Исправлена проблема, из-за которой не обрабатывался Ctrl+C. [#26757](https://github.com/ClickHouse/ClickHouse/pull/26757) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* `SET PROFILE` теперь также применяет ограничения, если они заданы для указанного профиля. [#26730](https://github.com/ClickHouse/ClickHouse/pull/26730) ([Vitaly Baranov](https://github.com/vitlibar)).
* Улучшена обработка запросов `KILL QUERY`. [#26675](https://github.com/ClickHouse/ClickHouse/pull/26675) ([Raúl Marín](https://github.com/Algunenano)).
* Функция `mapPopulatesSeries` поддерживает тип данных `Map`. [#26663](https://github.com/ClickHouse/ClickHouse/pull/26663) ([Ildus Kurbangaliev](https://github.com/ildus)).
* Исправлены избыточные (x2) попытки подключений при `skip_unavailable_shards`. [#26658](https://github.com/ClickHouse/ClickHouse/pull/26658) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено зависание `clickhouse-benchmark` при ошибке подключения (например, EMFILE). [#26656](https://github.com/ClickHouse/ClickHouse/pull/26656) ([Azat Khuzhin](https://github.com/azat)).
* Позволяет задействовать больше потоков в движке Kafka. [#26642](https://github.com/ClickHouse/ClickHouse/pull/26642) ([feihengye](https://github.com/feihengye)).
* Добавлена поддержка распределения запросов по кругу (round-robin) для `clickhouse-benchmark` (оно не отличается от обычного запуска на нескольких хостах/портах, за исключением отчёта по статистике). [#26607](https://github.com/ClickHouse/ClickHouse/pull/26607) ([Azat Khuzhin](https://github.com/azat)).
* Исполняемые словари (`executable`, `executable_pool`) позволяют создавать их с помощью DDL-запроса, выполняемого в `clickhouse-local`. Закрывает [#22355](https://github.com/ClickHouse/ClickHouse/issues/22355). [#26510](https://github.com/ClickHouse/ClickHouse/pull/26510) ([Maksim Kita](https://github.com/kitaisreal)).
* Установлен тип клиентского запроса для обработчиков протоколов совместимости `mysql` и `postgresql`. [#26498](https://github.com/ClickHouse/ClickHouse/pull/26498) ([anneji-dev](https://github.com/anneji-dev)).
* Применяйте `LIMIT` на шардах для запросов вида `SELECT * FROM dist ORDER BY key LIMIT 10` при `distributed_push_down_limit=1`. Избегайте выполнения этапов `DISTINCT`/`LIMIT BY` для запросов вида `SELECT DISTINCT shading_key FROM dist ORDER BY key`. Теперь параметр `distributed_push_down_limit` учитывается оптимизацией `optimize_distributed_group_by_sharding_key`. [#26466](https://github.com/ClickHouse/ClickHouse/pull/26466) ([Azat Khuzhin](https://github.com/azat)).
* Обновлён protobuf до версии 3.17.3. Журнал изменений доступен по адресу [https://github.com/protocolbuffers/protobuf/releases](https://github.com/protocolbuffers/protobuf/releases). [#26424](https://github.com/ClickHouse/ClickHouse/pull/26424) ([Ilya Yatsishin](https://github.com/qoega)).
* Включена настройка `use_hedged_requests`, позволяющая снижать хвостовые задержки в крупных кластерах. [#26380](https://github.com/ClickHouse/ClickHouse/pull/26380) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Улучшено поведение при наличии несуществующего хоста в списке разрешённых хостов пользователя. [#26368](https://github.com/ClickHouse/ClickHouse/pull/26368) ([ianton-ru](https://github.com/ianton-ru)).
* Добавлена возможность задавать настройки мониторинга директории движка `Distributed` через оператор CREATE TABLE (например, `CREATE TABLE dist (key Int) Engine=Distributed(cluster, db, table) SETTINGS monitor_batch_inserts=1` и т.п.). [#26336](https://github.com/ClickHouse/ClickHouse/pull/26336) ([Azat Khuzhin](https://github.com/azat)).
* Сохранять адрес сервера в URL в истории веб-интерфейса, если он отличается от origin веб-интерфейса. Исправляет [#26044](https://github.com/ClickHouse/ClickHouse/issues/26044). [#26322](https://github.com/ClickHouse/ClickHouse/pull/26322) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлены события профилирования для вызовов `sleep` / `sleepEachRow`. [#26320](https://github.com/ClickHouse/ClickHouse/pull/26320) ([Raúl Marín](https://github.com/Algunenano)).
* Позволяет повторно использовать соединения шардов между разными кластерами. Также позволяет избежать создания новых соединений при использовании табличной функции `cluster`. [#26318](https://github.com/ClickHouse/ClickHouse/pull/26318) ([Amos Bird](https://github.com/amosbird)).
* Периодичность очистки старых временных каталогов теперь можно настраивать с помощью параметра со значением по умолчанию. [#26212](https://github.com/ClickHouse/ClickHouse/issues/26212). [#26313](https://github.com/ClickHouse/ClickHouse/pull/26313) ([fastio](https://github.com/fastio)).
* Добавлена настройка `function_range_max_elements_in_block` для настройки безопасного порога объёма данных, генерируемого функцией `range`. Это закрывает [#26303](https://github.com/ClickHouse/ClickHouse/issues/26303). [#26305](https://github.com/ClickHouse/ClickHouse/pull/26305) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Проверять хеш-функцию при создании таблицы, а не при семплировании. Добавлены настройки для MergeTree: если таблица создана с некорректным столбцом семплирования, но семплирование никогда не используется, эти настройки можно отключить, чтобы запускать сервер без выброса исключения. [#26256](https://github.com/ClickHouse/ClickHouse/pull/26256) ([zhaoyu](https://github.com/zxc111)).
* Добавлена настройка `output_format_avro_string_column_pattern` для вывода указанных столбцов типа String в Avro в виде строк вместо значения по умолчанию — байтов. Реализовано в [#22414](https://github.com/ClickHouse/ClickHouse/issues/22414). [#26245](https://github.com/ClickHouse/ClickHouse/pull/26245) ([Ilya Golshtein](https://github.com/ilejn)).
* Добавлена информация о размерах столбцов в таблицу `system.columns` для таблиц `Log` и `TinyLog`. Это закрывает [#9001](https://github.com/ClickHouse/ClickHouse/issues/9001). [#26241](https://github.com/ClickHouse/ClickHouse/pull/26241) ([Nikolay Degterinsky](https://github.com/evillique)).
* Не выбрасывать исключение при запросе таблицы `system.detached_parts`, если используется настраиваемая конфигурация дисков и каталог `detached` отсутствует на некоторых из них. Это закрывает [#26078](https://github.com/ClickHouse/ClickHouse/issues/26078). [#26236](https://github.com/ClickHouse/ClickHouse/pull/26236) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена проверка наличия недетерминированных функций в ключах, включая константные выражения, такие как `now()`, `today()`. Исправляет [#25875](https://github.com/ClickHouse/ClickHouse/issues/25875). Исправляет [#11333](https://github.com/ClickHouse/ClickHouse/issues/11333). [#26235](https://github.com/ClickHouse/ClickHouse/pull/26235) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* преобразовывать типы данных timestamp и timestamptz в `DateTime64` в движке таблицы PostgreSQL. [#26234](https://github.com/ClickHouse/ClickHouse/pull/26234) ([jasine](https://github.com/jasine)).
* Применён более агрессивный анализ индекса IN для проекций, чтобы можно было выбирать лучшую кандидатную проекцию. [#26218](https://github.com/ClickHouse/ClickHouse/pull/26218) ([Amos Bird](https://github.com/amosbird)).
* Удалено ключевое слово GLOBAL для IN при передаче скалярной функции. В предыдущих версиях, если пользователь указывал `GLOBAL IN f(x)`, выбрасывалось исключение. [#26217](https://github.com/ClickHouse/ClickHouse/pull/26217) ([Amos Bird](https://github.com/amosbird)).
* Добавлен идентификатор ошибки (например, `BAD_ARGUMENTS`) в сообщения об исключениях. Это закрывает [#25862](https://github.com/ClickHouse/ClickHouse/issues/25862). [#26172](https://github.com/ClickHouse/ClickHouse/pull/26172) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена проблема некорректного вывода с опцией --progress для clickhouse-local. Полоса прогресса будет очищаться при достижении 100% — так же, как в clickhouse-client. Закрывает [#17484](https://github.com/ClickHouse/ClickHouse/issues/17484). [#26128](https://github.com/ClickHouse/ClickHouse/pull/26128) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена настройка `merge_selecting_sleep_ms`. [#26120](https://github.com/ClickHouse/ClickHouse/pull/26120) ([lthaooo](https://github.com/lthaooo)).
* Удалено сложное использование Linux AIO с предварительным чтением одного блока, вместо него используется простой синхронный ввод-вывод с O&#95;DIRECT. В предыдущих версиях настройка `min_bytes_to_use_direct_io` могла работать некорректно, если `max_threads` больше единицы. Чтение с использованием прямого ввода-вывода (который по умолчанию отключен для запросов и включен для крупных слияний) теперь будет работать менее эффективно. Это закрывает [#25997](https://github.com/ClickHouse/ClickHouse/issues/25997). [#26003](https://github.com/ClickHouse/ClickHouse/pull/26003) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Сбрасывать данные в таблице `Distributed` при выполнении запроса `REPLACE TABLE`. Исправляет [#24566](https://github.com/ClickHouse/ClickHouse/issues/24566) — не заменять (и не создавать) таблицу в запросе `[CREATE OR] REPLACE TABLE ... AS SELECT`, если вставка в новую таблицу завершилась с ошибкой. Исправляет [#23175](https://github.com/ClickHouse/ClickHouse/issues/23175). [#25895](https://github.com/ClickHouse/ClickHouse/pull/25895) ([tavplubix](https://github.com/tavplubix)).
* Добавлен столбец `views` в `system.query_log`, содержащий имена (материализованных или live) представлений, выполняемых запросом. Добавлена новая таблица лога (`system.query_views_log`), которая содержит информацию о каждом представлении, выполненном в ходе запроса. Изменено выполнение представлений: когда при выполнении представления выбрасывается исключение, любое представление, выполнение которого уже начато, продолжит выполняться до завершения. Ранее так вело себя выполнение только при parallel&#95;view&#95;processing=true, а теперь это поведение используется всегда. — Зависимые представления теперь сообщают о ходе чтения в контекст. [#25714](https://github.com/ClickHouse/ClickHouse/pull/25714) ([Raúl Marín](https://github.com/Algunenano)).
* Освобождение соединений теперь выполняется асинхронно после завершения выполнения распределённых запросов. Добавлена новая серверная настройка `max_threads_for_connection_collector`, которая задаёт количество рабочих потоков для фонового освобождения соединений. Если пул заполнен, соединение будет освобождаться синхронно, но немного иначе, чем раньше: оно освобождается после отправки клиенту EOS, запрос будет считаться успешно завершённым сразу после получения достаточного объёма данных, а любое исключение будет записано в лог вместо проброса клиенту. Добавлена настройка `drain_timeout` (по умолчанию 3 секунды). Освобождение соединения приведёт к его разрыву по истечении таймаута. [#25674](https://github.com/ClickHouse/ClickHouse/pull/25674) ([Amos Bird](https://github.com/amosbird)).
* Поддержка нескольких директив include в конфигурации. Теперь можно подключать конфигурацию пользователей и конфигурацию удалённых серверов из нескольких источников. Просто поместите элемент `<include />` с атрибутом `from_zk`, `from_env` или `incl`, и он будет заменён результатом подстановки. [#24404](https://github.com/ClickHouse/ClickHouse/pull/24404) ([nvartolomei](https://github.com/nvartolomei)).
* Исправлена вставка нескольких блоков в распределённую таблицу при `insert_distributed_one_random_shard = 1`. Это редко используемая возможность. Отмечено как улучшение. [#23140](https://github.com/ClickHouse/ClickHouse/pull/23140) ([Amos Bird](https://github.com/amosbird)).
* Добавлена поддержка ключей и значений `LowCardinality` и `FixedString` для типа `Map`. [#21543](https://github.com/ClickHouse/ClickHouse/pull/21543) ([hexiaoting](https://github.com/hexiaoting)).
* Добавлена возможность перезагрузки конфигурации с локального диска. [#19526](https://github.com/ClickHouse/ClickHouse/pull/19526) ([taiyang-li](https://github.com/taiyang-li)).

#### Исправление ошибки {#bug-fix-2}

* Исправлены несколько ошибок, которые могли приводить к расхождению данных между репликами. [#27808](https://github.com/ClickHouse/ClickHouse/pull/27808) ([tavplubix](https://github.com/tavplubix)).
* Исправлена редкая ошибка в `DROP PART`, которая могла приводить к появлению ошибки `Unexpected merged part intersects drop range`. [#27807](https://github.com/ClickHouse/ClickHouse/pull/27807) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка, приводившая к сбоям для некоторых форматов при получении из Kafka NULL‑сообщения (tombstone). Закрывает [#19255](https://github.com/ClickHouse/ClickHouse/issues/19255). [#27794](https://github.com/ClickHouse/ClickHouse/pull/27794) ([filimonov](https://github.com/filimonov)).
* Исправлена фильтрация столбцов при использовании UNION DISTINCT в подзапросе. Закрывает [#27578](https://github.com/ClickHouse/ClickHouse/issues/27578). [#27689](https://github.com/ClickHouse/ClickHouse/pull/27689) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено некорректное приведение типа, когда функции вроде `arrayHas` применяются к массивам LowCardinality от Nullable разных нечисловых типов, таких как `DateTime` и `DateTime64`. В предыдущих версиях происходило некорректное приведение типа. В новой версии такая ситуация приводит к исключению. Закрывает [#26330](https://github.com/ClickHouse/ClickHouse/issues/26330). [#27682](https://github.com/ClickHouse/ClickHouse/pull/27682) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена табличная функция PostgreSQL, из-за которой соединения не закрывались. Исправляет [#26088](https://github.com/ClickHouse/ClickHouse/issues/26088). [#27662](https://github.com/ClickHouse/ClickHouse/pull/27662) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен ещё один случай возникновения ошибки `Unexpected merged part ... intersecting drop range ...`. [#27656](https://github.com/ClickHouse/ClickHouse/pull/27656) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка при работе со столбцом‑псевдонимом в таблице `Distributed`. [#27652](https://github.com/ClickHouse/ClickHouse/pull/27652) ([Vladimir C](https://github.com/vdimir)).
* После того как для `max_memory_usage*` было установлено ненулевое значение, параметр нельзя было вернуть к 0 (без ограничения). Теперь это исправлено. [#27638](https://github.com/ClickHouse/ClickHouse/pull/27638) ([tavplubix](https://github.com/tavplubix)).
* Исправлено переполнение в меньшую сторону (underflow) значения времени при его конструировании из компонентов. Закрывает [#27193](https://github.com/ClickHouse/ClickHouse/issues/27193). [#27605](https://github.com/ClickHouse/ClickHouse/pull/27605) ([Vasily Nemkov](https://github.com/Enmk)).
* Исправлена ошибка, приводившая к сбою во время материализации проекций, если некоторые части содержат отсутствующие столбцы. Это исправляет [#27512](https://github.com/ClickHouse/ClickHouse/issues/27512). [#27528](https://github.com/ClickHouse/ClickHouse/pull/27528) ([Amos Bird](https://github.com/amosbird)).
* исправлена метрика `BackgroundMessageBrokerSchedulePoolTask`, вероятно, содержавшая опечатку. [#27452](https://github.com/ClickHouse/ClickHouse/pull/27452) ([Ben](https://github.com/benbiti)).
* Исправлены распределённые запросы с нулём шардов и агрегацией. [#27427](https://github.com/ClickHouse/ClickHouse/pull/27427) ([Azat Khuzhin](https://github.com/azat)).
* Совместимость в случае отсутствия суффикса «KB» в `/proc/meminfo`. [#27361](https://github.com/ClickHouse/ClickHouse/pull/27361) ([Mike Kot](https://github.com/myrrc)).
* Исправлен некорректный результат выполнения запроса с построчной защитой (row-level security), PREWHERE и фильтром по LowCardinality. Исправляет проблему [#27179](https://github.com/ClickHouse/ClickHouse/issues/27179). [#27329](https://github.com/ClickHouse/ClickHouse/pull/27329) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена некорректная проверка идентификатора партиции для таблиц MergeTree, созданных с использованием старого синтаксиса. [#27328](https://github.com/ClickHouse/ClickHouse/pull/27328) ([tavplubix](https://github.com/tavplubix)).
* Исправлен протокол MySQL при использовании параллельных форматов (CSV/TSV). [#27326](https://github.com/ClickHouse/ClickHouse/pull/27326) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена ошибка `Cannot find column` для запросов с семплированием (sampling). Появилась в [#24574](https://github.com/ClickHouse/ClickHouse/issues/24574). Исправляет [#26522](https://github.com/ClickHouse/ClickHouse/issues/26522). [#27301](https://github.com/ClickHouse/ClickHouse/pull/27301) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлены ошибки вида `Expected ColumnLowCardinality, gotUInt8` или `Bad cast from type DB::ColumnVector<char8_t> to DB::ColumnLowCardinality` для некоторых запросов с `LowCardinality` в `PREWHERE`. И, что ещё важнее, исправлено отсутствие пробела в сообщении об ошибке. Исправление для [#23515](https://github.com/ClickHouse/ClickHouse/issues/23515). [#27298](https://github.com/ClickHouse/ClickHouse/pull/27298) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена работа `distributed_group_by_no_merge = 2` в сочетании с `distributed_push_down_limit = 1` или `optimize_distributed_group_by_sharding_key = 1` в сочетании с `LIMIT BY` и `LIMIT OFFSET`. [#27249](https://github.com/ClickHouse/ClickHouse/pull/27249) ([Azat Khuzhin](https://github.com/azat)). Это неочевидные комбинации настроек, которые практически никто не использует.
* Исправлена проблема, при которой мутация застревала на недопустимых партициях в нереплицированном MergeTree. [#27248](https://github.com/ClickHouse/ClickHouse/pull/27248) ([Azat Khuzhin](https://github.com/azat)).
* В случае неоднозначности лямбда-функции отдают предпочтение своим аргументам перед другими псевдонимами или идентификаторами. [#27235](https://github.com/ClickHouse/ClickHouse/pull/27235) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена структура столбцов в операции merge join, закрыт [#27091](https://github.com/ClickHouse/ClickHouse/issues/27091). [#27217](https://github.com/ClickHouse/ClickHouse/pull/27217) ([Vladimir C](https://github.com/vdimir)).
* В редких случаях в таблице `system.detached_parts` могла содержаться некорректная информация о некоторых частях; это исправлено. Исправлена ошибка [#27114](https://github.com/ClickHouse/ClickHouse/issues/27114). [#27183](https://github.com/ClickHouse/ClickHouse/pull/27183) ([tavplubix](https://github.com/tavplubix)).
* Исправлено использование неинициализированной памяти в функциях `multiSearch*` при пустом массиве, закрыт [#27169](https://github.com/ClickHouse/ClickHouse/issues/27169). [#27181](https://github.com/ClickHouse/ClickHouse/pull/27181) ([Vladimir C](https://github.com/vdimir)).
* Исправлена работа синхронизации в GRPCServer. Этот PR исправляет [#27024](https://github.com/ClickHouse/ClickHouse/issues/27024). [#27064](https://github.com/ClickHouse/ClickHouse/pull/27064) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен разбор конфигурации для словарей типов `cache`, `complex_key_cache`, `ssd_cache`, `complex_key_ssd_cache`. Опции `allow_read_expired_keys`, `max_update_queue_size`, `update_queue_push_timeout_milliseconds`, `query_wait_timeout_milliseconds` не разбирались для словарей не типа `cache`. [#27032](https://github.com/ClickHouse/ClickHouse/pull/27032) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлено возможное зависание мутаций из-за гонки с DROP&#95;RANGE. [#27002](https://github.com/ClickHouse/ClickHouse/pull/27002) ([Azat Khuzhin](https://github.com/azat)).
* Теперь идентификатор партиции в запросах вида `ALTER TABLE ... PARTITION ID xxx` проверяется на корректность. Исправлено [#25718](https://github.com/ClickHouse/ClickHouse/issues/25718). [#26963](https://github.com/ClickHouse/ClickHouse/pull/26963) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка &quot;Unknown column name&quot; при использовании нескольких JOIN в некоторых случаях, закрыт [#26899](https://github.com/ClickHouse/ClickHouse/issues/26899). [#26957](https://github.com/ClickHouse/ClickHouse/pull/26957) ([Vladimir C](https://github.com/vdimir)).
* Исправлено чтение пользовательских доменов верхнего уровня (TLD; обработка останавливалась при меньшем буфере или большем файле). [#26948](https://github.com/ClickHouse/ClickHouse/pull/26948) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка `Missing columns: 'xxx'`, возникавшая, если столбец с `DEFAULT` ссылался на другой нематериализованный столбец без выражения `DEFAULT`. Исправлено [#26591](https://github.com/ClickHouse/ClickHouse/issues/26591). [#26900](https://github.com/ClickHouse/ClickHouse/pull/26900) ([alesapin](https://github.com/alesapin)).
* Исправлена проблема с загрузкой ключей словаря в `library-bridge` для источника словаря `library`. [#26834](https://github.com/ClickHouse/ClickHouse/pull/26834) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Параметры агрегатной функции могли теряться при применении некоторых комбинаторов, что приводило к исключениям вида `Conversion from AggregateFunction(topKArray, Array(String)) to AggregateFunction(topKArray(10), Array(String)) is not supported`. Проблема исправлена. Исправляет [#26196](https://github.com/ClickHouse/ClickHouse/issues/26196) и [#26433](https://github.com/ClickHouse/ClickHouse/issues/26433). [#26814](https://github.com/ClickHouse/ClickHouse/pull/26814) ([tavplubix](https://github.com/tavplubix)).
* Добавлено значение `event_time_microseconds` для `REMOVE_PART` в `system.part_log`. В предыдущих версиях оно не было задано. [#26720](https://github.com/ClickHouse/ClickHouse/pull/26720) ([Azat Khuzhin](https://github.com/azat)).
* Не удаляйте данные при остановке таблицы ReplicatedMergeTree во избежание несоответствия данных и метаданных. [#26716](https://github.com/ClickHouse/ClickHouse/pull/26716) ([nvartolomei](https://github.com/nvartolomei)).
* В некоторых случаях `SET ROLE` работал некорректно; этот PR исправляет проблему. [#26707](https://github.com/ClickHouse/ClickHouse/pull/26707) ([Vitaly Baranov](https://github.com/vitlibar)).
* Некоторые исправления в параллельном форматировании ([https://github.com/ClickHouse/ClickHouse/issues/26694](https://github.com/ClickHouse/ClickHouse/issues/26694)). [#26703](https://github.com/ClickHouse/ClickHouse/pull/26703) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена потенциальная ошибка разыменования нулевого указателя (nullptr) в оконных функциях. Это исправляет [#25276](https://github.com/ClickHouse/ClickHouse/issues/25276). [#26668](https://github.com/ClickHouse/ClickHouse/pull/26668) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Исправлено преобразование файла истории clickhouse-client (при обновлении с формата версии clickhouse-client трёхлетней давности), если файл пуст. [#26589](https://github.com/ClickHouse/ClickHouse/pull/26589) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены некорректные имена функций groupBitmapAnd/Or/Xor (в некоторых случаях они могли отображаться неправильно), что устраняет проблему. [#26557](https://github.com/ClickHouse/ClickHouse/pull/26557) ([Amos Bird](https://github.com/amosbird)).
* Обновлена проверка команды `chown` в entrypoint контейнера clickhouse-server. Это исправляет ошибку, из-за которой в Kubernetes перезапуск пода кластера завершался с ошибкой (или по тайм-ауту). [#26545](https://github.com/ClickHouse/ClickHouse/pull/26545) ([Ky Li](https://github.com/Kylinrix)).
* Исправлено падение при завершении работы `RabbitMQ`, если `RabbitMQ` не был запущен. Закрывает [#26504](https://github.com/ClickHouse/ClickHouse/issues/26504). [#26529](https://github.com/ClickHouse/ClickHouse/pull/26529) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлены проблемы с запросом `CREATE DICTIONARY`, если имя словаря или имя базы данных были заключены в кавычки. Закрывает [#26491](https://github.com/ClickHouse/ClickHouse/issues/26491). [#26508](https://github.com/ClickHouse/ClickHouse/pull/26508) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлено некорректное разрешение имён столбцов после перезаписи псевдонимов столбцов. Это исправляет [#26432](https://github.com/ClickHouse/ClickHouse/issues/26432). [#26475](https://github.com/ClickHouse/ClickHouse/pull/26475) ([Amos Bird](https://github.com/amosbird)).
* Исправлен сбой под msan, выявленный фаззингом. Исправляет [#22517](https://github.com/ClickHouse/ClickHouse/issues/22517). [#26428](https://github.com/ClickHouse/ClickHouse/pull/26428) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен бесконечный поток несоединённых блоков в `partial_merge_join`, закрыта проблема [#26325](https://github.com/ClickHouse/ClickHouse/issues/26325). [#26374](https://github.com/ClickHouse/ClickHouse/pull/26374) ([Vladimir C](https://github.com/vdimir)).
* Исправлено возможное аварийное завершение при входе под удалённым пользователем. Этот PR исправляет [#26073](https://github.com/ClickHouse/ClickHouse/issues/26073). [#26363](https://github.com/ClickHouse/ClickHouse/pull/26363) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена `optimize_distributed_group_by_sharding_key` для случая нескольких столбцов (приводило к некорректному результату при `optimize_skip_unused_shards=1`/`allow_nondeterministic_optimize_skip_unused_shards=1` и нескольких столбцах в выражении ключа шардинга). [#26353](https://github.com/ClickHouse/ClickHouse/pull/26353) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена редкая ошибка в механизме восстановления потерянной реплики, из-за которой реплики могли расходиться. [#26321](https://github.com/ClickHouse/ClickHouse/pull/26321) ([tavplubix](https://github.com/tavplubix)).
* Исправлена проблема с декомпрессией zstd (для импорта/экспорта во фреймовом формате zstd, не связанном с данными таблиц), когда в конце внутреннего буфера присутствуют escape-последовательности. Закрывает [#26013](https://github.com/ClickHouse/ClickHouse/issues/26013). [#26314](https://github.com/ClickHouse/ClickHouse/pull/26314) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена логическая ошибка при выполнении JOIN с totals, закрыт [#26017](https://github.com/ClickHouse/ClickHouse/issues/26017). [#26250](https://github.com/ClickHouse/ClickHouse/pull/26250) ([Vladimir C](https://github.com/vdimir)).
* Удалён лишний символ перевода строки в столбце `thread_name` таблицы `system.stack_trace`. Это исправляет [#24124](https://github.com/ClickHouse/ClickHouse/issues/24124). [#26210](https://github.com/ClickHouse/ClickHouse/pull/26210) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен возможный сбой при использовании более одного выражения `untuple`. [#26179](https://github.com/ClickHouse/ClickHouse/pull/26179) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Не выбрасывать исключение в `toString` для Nullable Enum, если в Enum отсутствует значение для нуля; закрыта [#25806](https://github.com/ClickHouse/ClickHouse/issues/25806). [#26123](https://github.com/ClickHouse/ClickHouse/pull/26123) ([Vladimir C](https://github.com/vdimir)).
* Исправлен некорректный `sequence_id` в пакетах протокола MySQL, которые ClickHouse отправляет при возникновении исключения в ходе выполнения запроса. Это могло приводить к тому, что клиент MySQL разрывал соединение с сервером ClickHouse. Исправляет [#21184](https://github.com/ClickHouse/ClickHouse/issues/21184). [#26051](https://github.com/ClickHouse/ClickHouse/pull/26051) ([tavplubix](https://github.com/tavplubix)).
* Исправлен случай, когда `cutToFirstSignificantSubdomainCustom()`/`cutToFirstSignificantSubdomainCustomWithWWW()`/`firstSignificantSubdomainCustom()` возвращают некорректный тип у констант, из‑за чего `optimize_skip_unused_shards` не работает: [#26041](https://github.com/ClickHouse/ClickHouse/pull/26041) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено возможное несоответствие заголовков при использовании обычной проекции с PREWHERE. Это исправляет [#26020](https://github.com/ClickHouse/ClickHouse/issues/26020). [#26038](https://github.com/ClickHouse/ClickHouse/pull/26038) ([Amos Bird](https://github.com/amosbird)).
* Исправлено использование sharding&#95;key, заданного столбцом без функции, для remote() (раньше `select * from remote('127.1', system.one, dummy)` приводил к ошибке вида `Unknown column: dummy, there are only columns .`). [#25824](https://github.com/ClickHouse/ClickHouse/pull/25824) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены ошибки `Not found column ...` и `Missing column ...` при выполнении запросов SELECT к `MaterializeMySQL`. Исправляет [#23708](https://github.com/ClickHouse/ClickHouse/issues/23708), [#24830](https://github.com/ClickHouse/ClickHouse/issues/24830), [#25794](https://github.com/ClickHouse/ClickHouse/issues/25794). [#25822](https://github.com/ClickHouse/ClickHouse/pull/25822) ([tavplubix](https://github.com/tavplubix)).
* Исправлен `optimize_skip_unused_shards_rewrite_in` для типов, отличных от UInt64 (это могло приводить к выбору неверных шардов или выбрасыванию ошибок `Cannot infer type of an empty tuple` или `Function tuple requires at least one argument`). [#25798](https://github.com/ClickHouse/ClickHouse/pull/25798) ([Azat Khuzhin](https://github.com/azat)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-3}

* Теперь мы запускаем stateful- и stateless‑тесты в случайных часовых поясах. Исправляет [#12439](https://github.com/ClickHouse/ClickHouse/issues/12439). Чтение `String` как `DateTime` и запись `DateTime` как `String` в формате Protobuf теперь учитывают часовой пояс. Чтение `UInt16` как `DateTime` в форматах Arrow и Parquet теперь сначала обрабатывает значение как `Date`, а затем преобразует его в `DateTime` с учётом часового пояса `DateTime`, поскольку `Date` сериализуется в Arrow и Parquet как `UInt16`. `GraphiteMergeTree` теперь учитывает часовой пояс при округлении времени. Исправляет [#5098](https://github.com/ClickHouse/ClickHouse/issues/5098). Автор: @alexey-milovidov. [#15408](https://github.com/ClickHouse/ClickHouse/pull/15408) ([alesapin](https://github.com/alesapin)).
* `clickhouse-test` поддерживает SQL‑тесты с шаблонами [Jinja2](https://jinja.palletsprojects.com/en/3.0.x/templates/#synopsis). [#26579](https://github.com/ClickHouse/ClickHouse/pull/26579) ([Vladimir C](https://github.com/vdimir)).
* Добавлена поддержка сборки с `clang-13`. Это закрывает [#27705](https://github.com/ClickHouse/ClickHouse/issues/27705). [#27714](https://github.com/ClickHouse/ClickHouse/pull/27714) ([alexey-milovidov](https://github.com/alexey-milovidov)). [#27777](https://github.com/ClickHouse/ClickHouse/pull/27777) ([Sergei Semin](https://github.com/syominsergey))
* Добавлены параметры CMake для сборки с определённым набором инструкций CPU или без него. Это для [#17469](https://github.com/ClickHouse/ClickHouse/issues/17469) и [#27509](https://github.com/ClickHouse/ClickHouse/issues/27509). [#27508](https://github.com/ClickHouse/ClickHouse/pull/27508) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена компоновка вспомогательных программ при использовании динамических библиотек. [#26958](https://github.com/ClickHouse/ClickHouse/pull/26958) ([Raúl Marín](https://github.com/Algunenano)).
* Обновлён RocksDB до состояния ветки master от `2021-07-16`. [#26411](https://github.com/ClickHouse/ClickHouse/pull/26411) ([alexey-milovidov](https://github.com/alexey-milovidov)).

### Релиз ClickHouse v21.8, 2021-08-12 {#clickhouse-release-v218-2021-08-12}

#### Заметки по обновлению {#upgrade-notes}

* В новой версии используется тип данных `Map` для таблиц системных логов (`system.query_log`, `system.query_thread_log`, `system.processes`, `system.opentelemetry_span_log`). Эти таблицы будут автоматически созданы с новыми типами данных. Для поддержки старых запросов создаются виртуальные столбцы. Закрывает [#18698](https://github.com/ClickHouse/ClickHouse/issues/18698). [#23934](https://github.com/ClickHouse/ClickHouse/pull/23934), [#25773](https://github.com/ClickHouse/ClickHouse/pull/25773) ([hexiaoting](https://github.com/hexiaoting), [sundy-li](https://github.com/sundy-li), [Maksim Kita](https://github.com/kitaisreal)). Если вы хотите выполнить *downgrade* с версии 21.8 на более старые версии, вам потребуется вручную очистить системные таблицы с логами. См. `/var/lib/clickhouse/data/system/*_log`.

#### Новые возможности {#new-features}

* Добавлена поддержка части стандарта SQL/JSON. [#24148](https://github.com/ClickHouse/ClickHouse/pull/24148) ([l1tsolaiki](https://github.com/l1tsolaiki), [Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлен сбор общих системных метрик (в `system.asynchronous_metrics` и `system.asynchronous_metric_log`) по использованию CPU, диска, памяти, IO, сети, файлов, средней нагрузке, частотам CPU, термодатчикам, счётчикам EDAC, времени работы системы; также добавлены метрики по джиттеру планировщика и времени, затраченному на сбор метрик. Работает аналогично `atop` в ClickHouse и позволяет получать данные мониторинга даже при отсутствии установленных дополнительных инструментов. Закрывает [#9430](https://github.com/ClickHouse/ClickHouse/issues/9430). [#24416](https://github.com/ClickHouse/ClickHouse/pull/24416) ([alexey-milovidov](https://github.com/alexey-milovidov), [Yegor Levankov](https://github.com/elevankoff)).
* Добавлены движок таблицы и движок базы данных MaterializedPostgreSQL. Движок базы данных позволяет реплицировать целую базу данных или любой поднабор таблиц этой базы. [#20470](https://github.com/ClickHouse/ClickHouse/pull/20470) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлены новые функции `leftPad()`, `rightPad()`, `leftPadUTF8()`, `rightPadUTF8()`. [#26075](https://github.com/ClickHouse/ClickHouse/pull/26075) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлено ключевое слово `FIRST` в команду `ADD INDEX`, чтобы можно было добавить индекс в начало списка индексов. [#25904](https://github.com/ClickHouse/ClickHouse/pull/25904) ([xjewer](https://github.com/xjewer)).
* Добавлена таблица `system.data_skipping_indices`, содержащая информацию о существующих индексах пропуска данных. Закрывает [#7659](https://github.com/ClickHouse/ClickHouse/issues/7659). [#25693](https://github.com/ClickHouse/ClickHouse/pull/25693) ([Dmitry Novik](https://github.com/novikd)).
* Добавлены функции `bin`/`unbin`. [#25609](https://github.com/ClickHouse/ClickHouse/pull/25609) ([zhaoyu](https://github.com/zxc111)).
* Добавлена поддержка типов `Map` и `UInt128`, `Int128`, `UInt256`, `Int256` в функциях `mapAdd` и `mapSubtract`. [#25596](https://github.com/ClickHouse/ClickHouse/pull/25596) ([Ildus Kurbangaliev](https://github.com/ildus)).
* Добавлена поддержка выражения `DISTINCT ON (columns)`, закрывает [#25404](https://github.com/ClickHouse/ClickHouse/issues/25404). [#25589](https://github.com/ClickHouse/ClickHouse/pull/25589) ([Zijie Lu](https://github.com/TszKitLo40)).
* Добавлена возможность сбросить пользовательскую настройку к значению по умолчанию и удалить её из метаданных таблицы. Это позволяет откатить изменение, не зная значения настройки по умолчанию в системе/конфигурации. Закрывает [#14449](https://github.com/ClickHouse/ClickHouse/issues/14449). [#17769](https://github.com/ClickHouse/ClickHouse/pull/17769) ([xjewer](https://github.com/xjewer)).
* Реализована визуализация конвейеров в виде графов в Web UI при выполнении запроса `EXPLAIN PIPELINE graph = 1`. [#26067](https://github.com/ClickHouse/ClickHouse/pull/26067) ([alexey-milovidov](https://github.com/alexey-milovidov)).

#### Улучшения производительности {#performance-improvements}

* Добавлена компиляция агрегатных функций. Используйте опцию `compile_aggregate_expressions` для включения. [#24789](https://github.com/ClickHouse/ClickHouse/pull/24789) ([Maksim Kita](https://github.com/kitaisreal)).
* Снижена задержка коротких запросов, которым требуется чтение из таблиц с большим количеством столбцов. [#26371](https://github.com/ClickHouse/ClickHouse/pull/26371) ([Anton Popov](https://github.com/CurtizJ)).

#### Улучшения {#improvements}

* Для таблиц системных логов (`system.query_log`, `system.query_thread_log`, `system.processes`, `system.opentelemetry_span_log`) используется тип данных `Map`. Эти таблицы будут автоматически создаваться с новыми типами данных. Для поддержки старых запросов добавлены виртуальные столбцы. Закрывает [#18698](https://github.com/ClickHouse/ClickHouse/issues/18698). [#23934](https://github.com/ClickHouse/ClickHouse/pull/23934), [#25773](https://github.com/ClickHouse/ClickHouse/pull/25773) ([hexiaoting](https://github.com/hexiaoting), [sundy-li](https://github.com/sundy-li), [Maksim Kita](https://github.com/kitaisreal)).
* Для словаря со сложным ключом, содержащим только один атрибут, можно не оборачивать выражение ключа в `tuple` в функциях `dictGet`, `dictHas`. [#26130](https://github.com/ClickHouse/ClickHouse/pull/26130) ([Maksim Kita](https://github.com/kitaisreal)).
* Реализована функция `bin`/`hex` на основе состояний `AggregateFunction`. [#26094](https://github.com/ClickHouse/ClickHouse/pull/26094) ([zhaoyu](https://github.com/zxc111)).
* Добавлена поддержка аргументов типа `UUID` для функций `empty` и `notEmpty`. `UUID` считается пустым, если он полностью состоит из нулей (nil UUID). Закрывает [#3446](https://github.com/ClickHouse/ClickHouse/issues/3446). [#25974](https://github.com/ClickHouse/ClickHouse/pull/25974) ([zhaoyu](https://github.com/zxc111)).
* В протокол MySQL добавлена поддержка `SET SQL_SELECT_LIMIT`. Закрывает [#17115](https://github.com/ClickHouse/ClickHouse/issues/17115). [#25972](https://github.com/ClickHouse/ClickHouse/pull/25972) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Расширена инструментация сетевого взаимодействия: добавлены счётчики байт recv/send; добавлены gauge-метрики для операций recv/send. Добавлена отсутствовавшая документация. Закрывает [#5897](https://github.com/ClickHouse/ClickHouse/issues/5897). [#25962](https://github.com/ClickHouse/ClickHouse/pull/25962) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена настройка `optimize_move_to_prewhere_if_final`. Если в запросе используется `FINAL`, оптимизация `move_to_prewhere` будет включена только в том случае, если включены обе настройки: `optimize_move_to_prewhere` и `optimize_move_to_prewhere_if_final`. Закрывает [#8684](https://github.com/ClickHouse/ClickHouse/issues/8684). [#25940](https://github.com/ClickHouse/ClickHouse/pull/25940) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Разрешить использование сложных идентификаторов соединённых таблиц в кавычках. Закрывает [#17861](https://github.com/ClickHouse/ClickHouse/issues/17861). [#25924](https://github.com/ClickHouse/ClickHouse/pull/25924) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка элементов с символами Unicode (например, китайскими, кириллическими) в типах данных `Nested`. Закрывает [#25594](https://github.com/ClickHouse/ClickHouse/issues/25594). [#25923](https://github.com/ClickHouse/ClickHouse/pull/25923) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Разрешить использование функций `quantiles*` с `aggregate_functions_null_for_empty`. Закрывает [#25892](https://github.com/ClickHouse/ClickHouse/issues/25892). [#25919](https://github.com/ClickHouse/ClickHouse/pull/25919) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Позволяет задавать параметры параметрических агрегатных функций в виде произвольных константных выражений (например, `1 + 2`), а не только литералов. Также позволяет использовать параметры запроса (в параметризованных запросах вида `{param:UInt8}`) внутри параметрических агрегатных функций. Закрывает [#11607](https://github.com/ClickHouse/ClickHouse/issues/11607). [#25910](https://github.com/ClickHouse/ClickHouse/pull/25910) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Корректно выбрасывать исключение при попытке разобрать некорректное значение типа `Date`. Закрывает [#6481](https://github.com/ClickHouse/ClickHouse/issues/6481). [#25909](https://github.com/ClickHouse/ClickHouse/pull/25909) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Поддержка нескольких include-директив в конфигурации. Теперь можно подключать конфигурации пользователей и удалённых серверов из нескольких источников. Достаточно поместить элемент `<include />` с атрибутом `from_zk`, `from_env` или `incl`, и он будет заменён соответствующим содержимым. [#24404](https://github.com/ClickHouse/ClickHouse/pull/24404) ([nvartolomei](https://github.com/nvartolomei)).
* Поддержка запросов со столбцом с именем `"null"` (имя должно быть заключено в обратные кавычки или двойные кавычки) и `ON CLUSTER`. Закрывает [#24035](https://github.com/ClickHouse/ClickHouse/issues/24035). [#25907](https://github.com/ClickHouse/ClickHouse/pull/25907) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка `LowCardinality`, `Decimal` и `UUID` для `JSONExtract`. Закрывает [#24606](https://github.com/ClickHouse/ClickHouse/issues/24606). [#25900](https://github.com/ClickHouse/ClickHouse/pull/25900) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Файл истории конвертирован из формата `readline` в формат `replxx`. [#25888](https://github.com/ClickHouse/ClickHouse/pull/25888) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, которая могла приводить к появлению пересекающихся частей после выполнения `DROP PART` или фонового удаления пустой части. [#25884](https://github.com/ClickHouse/ClickHouse/pull/25884) ([alesapin](https://github.com/alesapin)).
* Улучшена обработка потерянных кусков для таблиц `ReplicatedMergeTree`. Исправлены редкие несоответствия в `ReplicationQueue`. Исправлена проблема [#10368](https://github.com/ClickHouse/ClickHouse/issues/10368). [#25820](https://github.com/ClickHouse/ClickHouse/pull/25820) ([alesapin](https://github.com/alesapin)).
* Разрешён запуск clickhouse-client при недоступном для чтения рабочем каталоге. [#25817](https://github.com/ClickHouse/ClickHouse/pull/25817) ([ianton-ru](https://github.com/ianton-ru)).
* Исправлена ошибка «No available columns» для хранилища `Merge`. [#25801](https://github.com/ClickHouse/ClickHouse/pull/25801) ([Azat Khuzhin](https://github.com/azat)).
* Движок MySQL теперь поддерживает обмен комментариями столбцов между MySQL и ClickHouse. [#25795](https://github.com/ClickHouse/ClickHouse/pull/25795) ([Storozhuk Kostiantyn](https://github.com/sand6255)).
* Исправлено непоследовательное поведение `GROUP BY` с константой на пустом наборе данных. Закрывает [#6842](https://github.com/ClickHouse/ClickHouse/issues/6842). [#25786](https://github.com/ClickHouse/ClickHouse/pull/25786) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отмена уже запущенных слияний в разделе при выполнении операций `DROP PARTITION` и `TRUNCATE` для `ReplicatedMergeTree`. Решает проблему [#17151](https://github.com/ClickHouse/ClickHouse/issues/17151). [#25684](https://github.com/ClickHouse/ClickHouse/pull/25684) ([tavplubix](https://github.com/tavplubix)).
* Реализована поддержка типа данных `ENUM` для MaterializeMySQL. [#25676](https://github.com/ClickHouse/ClickHouse/pull/25676) ([Storozhuk Kostiantyn](https://github.com/sand6255)).
* Добавлена поддержка материализованных и псевдонимных столбцов в операциях JOIN, закрыт [#13274](https://github.com/ClickHouse/ClickHouse/issues/13274). [#25634](https://github.com/ClickHouse/ClickHouse/pull/25634) ([Vladimir C](https://github.com/vdimir)).
* Исправлено возможное логическое условие гонки между `ALTER TABLE ... DETACH` и фоновыми слияниями. [#25605](https://github.com/ClickHouse/ClickHouse/pull/25605) ([Azat Khuzhin](https://github.com/azat)).
* Метрика `NetworkReceiveElapsedMicroseconds` теперь корректно учитывает время ожидания данных от клиента при выполнении `INSERT`. Закрыта [#9958](https://github.com/ClickHouse/ClickHouse/issues/9958). [#25602](https://github.com/ClickHouse/ClickHouse/pull/25602) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка `TRUNCATE TABLE` для S3 и HDFS. Закрыта задача [#25530](https://github.com/ClickHouse/ClickHouse/issues/25530). [#25550](https://github.com/ClickHouse/ClickHouse/pull/25550) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Поддержка динамической перезагрузки конфигурации для изменения количества потоков в пуле потоков для выполнения фоновых задач (слияния, мутации, загрузки). [#25548](https://github.com/ClickHouse/ClickHouse/pull/25548) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Разрешено извлекать элемент нестрокового типа как строку с помощью `JSONExtract`. Это для [#25414](https://github.com/ClickHouse/ClickHouse/issues/25414). [#25452](https://github.com/ClickHouse/ClickHouse/pull/25452) ([Amos Bird](https://github.com/amosbird)).
* Добавлена поддержка регулярных выражений в аргументе `Database` для `StorageMerge`. Закрыт [#776](https://github.com/ClickHouse/ClickHouse/issues/776). [#25064](https://github.com/ClickHouse/ClickHouse/pull/25064) ([flynn](https://github.com/ucasfl)).
* Веб-интерфейс: если значение выглядит как URL, ссылка создаётся автоматически. [#25965](https://github.com/ClickHouse/ClickHouse/pull/25965) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Команда `sudo service clickhouse-server start` теперь работает на системах с `systemd`, таких как CentOS 8. Закрыты [#14298](https://github.com/ClickHouse/ClickHouse/issues/14298). Закрыты [#17799](https://github.com/ClickHouse/ClickHouse/issues/17799). [#25921](https://github.com/ClickHouse/ClickHouse/pull/25921) ([alexey-milovidov](https://github.com/alexey-milovidov)).

#### Исправления ошибок {#bug-fixes-1}

* Исправлена некорректная работа `SET ROLE` в некоторых случаях. [#26707](https://github.com/ClickHouse/ClickHouse/pull/26707) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено возможное разыменование `nullptr` в оконных функциях. Исправлена [#25276](https://github.com/ClickHouse/ClickHouse/issues/25276). [#26668](https://github.com/ClickHouse/ClickHouse/pull/26668) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Исправлены некорректные имена функций `groupBitmapAnd/Or/Xor`. См. [#26557](https://github.com/ClickHouse/ClickHouse/pull/26557) ([Amos Bird](https://github.com/amosbird)).
* Исправлен сбой при завершении работы RabbitMQ, если его настройка не была выполнена. Закрывает [#26504](https://github.com/ClickHouse/ClickHouse/issues/26504). [#26529](https://github.com/ClickHouse/ClickHouse/pull/26529) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлены проблемы с запросом `CREATE DICTIONARY`, возникавшие при заключении в кавычки имени словаря или базы данных. Закрывает [#26491](https://github.com/ClickHouse/ClickHouse/issues/26491). [#26508](https://github.com/ClickHouse/ClickHouse/pull/26508) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлено некорректное разрешение имён после переписывания псевдонимов столбцов. Исправляет [#26432](https://github.com/ClickHouse/ClickHouse/issues/26432). [#26475](https://github.com/ClickHouse/ClickHouse/pull/26475) ([Amos Bird](https://github.com/amosbird)).
* Исправлена проблема бесконечного потока несоединённых блоков в `partial_merge_join`, закрыта задача [#26325](https://github.com/ClickHouse/ClickHouse/issues/26325). [#26374](https://github.com/ClickHouse/ClickHouse/pull/26374) ([Vladimir C](https://github.com/vdimir)).
* Исправлен возможный сбой при входе под удалённым пользователем. Исправлено [#26073](https://github.com/ClickHouse/ClickHouse/issues/26073). [#26363](https://github.com/ClickHouse/ClickHouse/pull/26363) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено поведение настройки `optimize_distributed_group_by_sharding_key` для нескольких столбцов (оно приводило к некорректным результатам при `optimize_skip_unused_shards=1`/`allow_nondeterministic_optimize_skip_unused_shards=1` и нескольких столбцах в выражении ключа шардинга). [#26353](https://github.com/ClickHouse/ClickHouse/pull/26353) ([Azat Khuzhin](https://github.com/azat)).
* Операция `CAST` из `Date` в `DateTime` (или `DateTime64`) не использовала часовой пояс типа `DateTime`. Это также могло влиять на сравнение между `Date` и `DateTime`. Определение общего типа для `Date` и `DateTime` также не использовало соответствующий часовой пояс. Это влияло на результаты функции `if` и построение массивов. Закрывает [#24128](https://github.com/ClickHouse/ClickHouse/issues/24128). [#24129](https://github.com/ClickHouse/ClickHouse/pull/24129) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена редкая ошибка в механизме восстановления потерянной реплики, которая могла приводить к расхождению между репликами. [#26321](https://github.com/ClickHouse/ClickHouse/pull/26321) ([tavplubix](https://github.com/tavplubix)).
* Исправлена декомпрессия zstd в случае, если в конце внутреннего буфера имеются escape-последовательности. Закрывает [#26013](https://github.com/ClickHouse/ClickHouse/issues/26013). [#26314](https://github.com/ClickHouse/ClickHouse/pull/26314) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена логическая ошибка в `JOIN` с `WITH TOTALS`, закрыт [#26017](https://github.com/ClickHouse/ClickHouse/issues/26017). [#26250](https://github.com/ClickHouse/ClickHouse/pull/26250) ([Vladimir C](https://github.com/vdimir)).
* Удалён лишний перенос строки в столбце `thread_name` таблицы `system.stack_trace`. Исправлена проблема [#24124](https://github.com/ClickHouse/ClickHouse/issues/24124). [#26210](https://github.com/ClickHouse/ClickHouse/pull/26210) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен `joinGet` при работе со столбцами `LowCardinality`, закрыт [#25993](https://github.com/ClickHouse/ClickHouse/issues/25993). [#26118](https://github.com/ClickHouse/ClickHouse/pull/26118) ([Vladimir C](https://github.com/vdimir)).
* Исправлено возможное аварийное завершение `pointInPolygon` при отключенной настройке `validate_polygons`. [#26113](https://github.com/ClickHouse/ClickHouse/pull/26113) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено возникновение исключения при итерации по несуществующему удалённому каталогу. [#26087](https://github.com/ClickHouse/ClickHouse/pull/26087) ([ianton-ru](https://github.com/ianton-ru)).
* Исправлен редкий аварийный останов сервера из-за вызова `abort` в клиенте ZooKeeper. Исправляет [#25813](https://github.com/ClickHouse/ClickHouse/issues/25813). [#26079](https://github.com/ClickHouse/ClickHouse/pull/26079) ([alesapin](https://github.com/alesapin)).
* Исправлена некорректная оценка числа потоков для right join-а с подзапросом в некоторых случаях. Закрывает [#24075](https://github.com/ClickHouse/ClickHouse/issues/24075). [#26052](https://github.com/ClickHouse/ClickHouse/pull/26052) ([Vladimir C](https://github.com/vdimir)).
* Исправлен некорректный `sequence_id` в пакетах протокола MySQL, которые ClickHouse отправляет при возникновении исключения во время выполнения запроса. Это могло приводить к разрыву соединения MySQL-клиента с сервером ClickHouse. Исправляет [#21184](https://github.com/ClickHouse/ClickHouse/issues/21184). [#26051](https://github.com/ClickHouse/ClickHouse/pull/26051) ([tavplubix](https://github.com/tavplubix)).
* Исправлено возможное несоответствие заголовка при использовании обычной проекции с `PREWHERE`. Исправление для [#26020](https://github.com/ClickHouse/ClickHouse/issues/26020). [#26038](https://github.com/ClickHouse/ClickHouse/pull/26038) ([Amos Bird](https://github.com/amosbird)).
* Исправлено форматирование типа `Map` с целочисленными ключами при выводе в `JSON`. [#25982](https://github.com/ClickHouse/ClickHouse/pull/25982) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена возможная взаимоблокировка при раскрутке стека профилировщика запросов. Исправление [#25968](https://github.com/ClickHouse/ClickHouse/issues/25968). [#25970](https://github.com/ClickHouse/ClickHouse/pull/25970) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлен сбой при вызове `dictGet()` с некорректными аргументами. [#25913](https://github.com/ClickHouse/ClickHouse/pull/25913) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен механизм аутентификации `scram-sha-256` для движков PostgreSQL. Закрывает [#24516](https://github.com/ClickHouse/ClickHouse/issues/24516). [#25906](https://github.com/ClickHouse/ClickHouse/pull/25906) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена чрезмерно долгая задержка повторных попыток для фоновых задач, когда фоновый пул заполнен. Исправляет проблему [#25836](https://github.com/ClickHouse/ClickHouse/issues/25836). [#25893](https://github.com/ClickHouse/ClickHouse/pull/25893) ([alesapin](https://github.com/alesapin)).
* Исправлена обработка исключений на ARM при нестандартном размере страницы памяти. Исправляет [#25512](https://github.com/ClickHouse/ClickHouse/issues/25512), [#25044](https://github.com/ClickHouse/ClickHouse/issues/25044), [#24901](https://github.com/ClickHouse/ClickHouse/issues/24901), [#23183](https://github.com/ClickHouse/ClickHouse/issues/23183), [#20221](https://github.com/ClickHouse/ClickHouse/issues/20221), [#19703](https://github.com/ClickHouse/ClickHouse/issues/19703), [#19028](https://github.com/ClickHouse/ClickHouse/issues/19028), [#18391](https://github.com/ClickHouse/ClickHouse/issues/18391), [#18121](https://github.com/ClickHouse/ClickHouse/issues/18121), [#17994](https://github.com/ClickHouse/ClickHouse/issues/17994), [#12483](https://github.com/ClickHouse/ClickHouse/issues/12483). [#25854](https://github.com/ClickHouse/ClickHouse/pull/25854) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена работа `sharding_key`, сформированной из столбца без функции, для `remote()` (раньше `select * from remote('127.1', system.one, dummy)` приводил к ошибке `Unknown column: dummy, there are only columns .`). [#25824](https://github.com/ClickHouse/ClickHouse/pull/25824) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены ошибки `Not found column ...` и `Missing column ...` при выполнении запросов `SELECT` к `MaterializeMySQL`. Исправляет [#23708](https://github.com/ClickHouse/ClickHouse/issues/23708), [#24830](https://github.com/ClickHouse/ClickHouse/issues/24830), [#25794](https://github.com/ClickHouse/ClickHouse/issues/25794). [#25822](https://github.com/ClickHouse/ClickHouse/pull/25822) ([tavplubix](https://github.com/tavplubix)).
* Исправлена работа `optimize_skip_unused_shards_rewrite_in` для типов данных, отличных от UInt64 (мог в итоге выбирать некорректные шарды или вызывать ошибки `Cannot infer type of an empty tuple` или `Function tuple requires at least one argument`). [#25798](https://github.com/ClickHouse/ClickHouse/pull/25798) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена редкая ошибка в запросе `DROP PART` для таблиц `ReplicatedMergeTree`, которая могла приводить к сообщению об ошибке `Unexpected merged part intersecting drop range`. [#25783](https://github.com/ClickHouse/ClickHouse/pull/25783) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка в `TTL` с выражением `GROUP BY`, из-за которой `TTL` отказывался выполняться после первого запуска в части. [#25743](https://github.com/ClickHouse/ClickHouse/pull/25743) ([alesapin](https://github.com/alesapin)).
* Разрешен доступ движку StorageMerge к таблицам с псевдонимами. Закрывает [#6051](https://github.com/ClickHouse/ClickHouse/issues/6051). [#25694](https://github.com/ClickHouse/ClickHouse/pull/25694) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена медленная работа dict join в некоторых случаях, закрыта задача [#24209](https://github.com/ClickHouse/ClickHouse/issues/24209). [#25618](https://github.com/ClickHouse/ClickHouse/pull/25618) ([Vladimir C](https://github.com/vdimir)).
* Исправлена работа `ALTER MODIFY COLUMN` для столбцов, которые участвуют в TTL-выражениях. [#25554](https://github.com/ClickHouse/ClickHouse/pull/25554) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ассерция в `PREWHERE` при использовании типа, отличного от UInt8, закрыт [#19589](https://github.com/ClickHouse/ClickHouse/issues/19589). [#25484](https://github.com/ClickHouse/ClickHouse/pull/25484) ([Vladimir C](https://github.com/vdimir)).
* Исправлен краш под msan, выявленный фаззингом. Исправляет [#22517](https://github.com/ClickHouse/ClickHouse/issues/22517). [#26428](https://github.com/ClickHouse/ClickHouse/pull/26428) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Обновлена проверка команды `chown` во входной точке Docker-контейнера `clickhouse-server`. Исправлена ошибка «cluster pod restart failed (or timeout)» в Kubernetes. [#26545](https://github.com/ClickHouse/ClickHouse/pull/26545) ([Ky Li](https://github.com/Kylinrix)).

### Релиз ClickHouse v21.7, 2021-07-09 {#clickhouse-release-v217-2021-07-09}

#### Изменение, несовместимое с предыдущими версиями {#backward-incompatible-change-4}

* Повышена производительность запросов с явно заданными большими наборами. Добавлена настройка совместимости `legacy_column_name_of_tuple_literal`. Имеет смысл установить её в `true` при поэтапном обновлении кластера с версии ниже 21.7 до любой более новой версии. В противном случае распределённые запросы с явно заданными наборами в конструкции `IN` могут завершаться с ошибкой во время обновления. [#25371](https://github.com/ClickHouse/ClickHouse/pull/25371) ([Anton Popov](https://github.com/CurtizJ)).
* Вперёд- и обратно-несовместимое изменение максимального размера буфера в clickhouse-keeper (экспериментальная альтернатива ZooKeeper). Лучше сделать это сейчас (до вывода в production), чем позже. [#25421](https://github.com/ClickHouse/ClickHouse/pull/25421) ([alesapin](https://github.com/alesapin)).

#### Новая функциональность {#new-feature-4}

* Поддержка конфигурации в формате YAML в качестве альтернативы XML. Это закрывает [#3607](https://github.com/ClickHouse/ClickHouse/issues/3607). [#21858](https://github.com/ClickHouse/ClickHouse/pull/21858) ([BoloniniD](https://github.com/BoloniniD)).
* Добавлен способ восстановления реплицируемой таблицы, когда данные (возможно) присутствуют, но метаданные ZooKeeper потеряны. Решает [#13458](https://github.com/ClickHouse/ClickHouse/issues/13458). [#13652](https://github.com/ClickHouse/ClickHouse/pull/13652) ([Mike Kot](https://github.com/myrrc)).
* Поддержка `structs` и `maps` в форматах Arrow/Parquet/ORC и словарей в форматах ввода/вывода Arrow. Представлена новая настройка `output_format_arrow_low_cardinality_as_dictionary`. [#24341](https://github.com/ClickHouse/ClickHouse/pull/24341) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка типа `Array` в словарях. [#25119](https://github.com/ClickHouse/ClickHouse/pull/25119) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена функция `bitPositionsToArray`. Закрывает [#23792](https://github.com/ClickHouse/ClickHouse/issues/23792). Автор [Kevin Wan] (@MaxWk). [#25394](https://github.com/ClickHouse/ClickHouse/pull/25394) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена функция `dateName`, которая возвращает такие названия, как 'Friday' или 'April'. Автор [Daniil Kondratyev] (@dankondr). [#25372](https://github.com/ClickHouse/ClickHouse/pull/25372) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена функция `toJSONString` для сериализации столбцов в их представление в формате JSON. [#25164](https://github.com/ClickHouse/ClickHouse/pull/25164) ([Amos Bird](https://github.com/amosbird)).
* Теперь `query_log` имеет два новых столбца: `initial_query_start_time`, `initial_query_start_time_microsecond`, которые записывают время начала распределённого запроса, если такой есть. [#25022](https://github.com/ClickHouse/ClickHouse/pull/25022) ([Amos Bird](https://github.com/amosbird)).
* Добавлена агрегатная функция `segmentLengthSum`. [#24250](https://github.com/ClickHouse/ClickHouse/pull/24250) ([flynn](https://github.com/ucasfl)).
* Добавлена новая булева настройка `prefer_global_in_and_join`, которая по умолчанию выполняет все IN/JOIN как GLOBAL IN/JOIN. [#23434](https://github.com/ClickHouse/ClickHouse/pull/23434) ([Amos Bird](https://github.com/amosbird)).
* Добавлена поддержка запросов `ALTER DELETE` для движка таблиц `Join`. [#23260](https://github.com/ClickHouse/ClickHouse/pull/23260) ([foolchi](https://github.com/foolchi)).
* Добавлена агрегатная функция `quantileBFloat16`, а также соответствующие `quantilesBFloat16` и `medianBFloat16`. Это очень простой и быстрый метод оценки квантилей с относительной погрешностью не более 0.390625%. Это закрывает [#16641](https://github.com/ClickHouse/ClickHouse/issues/16641). [#23204](https://github.com/ClickHouse/ClickHouse/pull/23204) ([Ivan Novitskiy](https://github.com/RedClusive)).
* Реализована функция `sequenceNextNode()`, полезная для анализа потоков (`flow analysis`). [#19766](https://github.com/ClickHouse/ClickHouse/pull/19766) ([achimbab](https://github.com/achimbab)).

#### Экспериментальная функциональность {#experimental-feature-4}

* Добавлена поддержка виртуальной файловой системы поверх HDFS. [#11058](https://github.com/ClickHouse/ClickHouse/pull/11058) ([overshov](https://github.com/overshov)) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Теперь `clickhouse-keeper` (экспериментальная альтернатива ZooKeeper) поддерживает ACL типа `digest`, как в ZooKeeper. [#24448](https://github.com/ClickHouse/ClickHouse/pull/24448) ([alesapin](https://github.com/alesapin)).

#### Повышение производительности {#performance-improvement-4}

* Добавлена оптимизация, которая преобразует некоторые функции в чтение подстолбцов для уменьшения объёма читаемых данных. Например, выражение `col IS NULL` преобразуется в чтение подстолбца `col.null`. Оптимизацию можно включить с помощью настройки `optimize_functions_to_subcolumns`, которая сейчас по умолчанию отключена. [#24406](https://github.com/ClickHouse/ClickHouse/pull/24406) ([Anton Popov](https://github.com/CurtizJ)).
* Переписывается большее количество столбцов в возможные выражения-алиасы. Это может включать более эффективные оптимизации, такие как проекции. [#24405](https://github.com/ClickHouse/ClickHouse/pull/24405) ([Amos Bird](https://github.com/amosbird)).
* Индекс типа `bloom_filter` может использоваться для выражений с функцией `hasAny` с константными массивами. Закрывает: [#24291](https://github.com/ClickHouse/ClickHouse/issues/24291). [#24900](https://github.com/ClickHouse/ClickHouse/pull/24900) ([Vasily Nemkov](https://github.com/Enmk)).
* Добавлен экспоненциальный backoff для повторного планирования попытки чтения в случае, если очереди RabbitMQ пусты. (ClickHouse поддерживает импорт данных из RabbitMQ). Закрывает [#24340](https://github.com/ClickHouse/ClickHouse/issues/24340). [#24415](https://github.com/ClickHouse/ClickHouse/pull/24415) ([Kseniia Sumarokova](https://github.com/kssenii)).

#### Улучшение {#improvement-4}

* Добавлена возможность ограничивать пропускную способность для репликации. Добавлены две настройки движков Replicated*MergeTree: `max_replicated_fetches_network_bandwidth` и `max_replicated_sends_network_bandwidth`, которые позволяют ограничить максимальную скорость реплицируемых загрузок (fetch) и отправок для таблицы. Добавлены две серверные настройки (в профиле пользователя `default`): `max_replicated_fetches_network_bandwidth_for_server` и `max_replicated_sends_network_bandwidth_for_server`, которые ограничивают максимальную скорость репликации для всех таблиц. Ограничения применяются не с идеальной точностью. По умолчанию выключены. Исправляет [#1821](https://github.com/ClickHouse/ClickHouse/issues/1821). [#24573](https://github.com/ClickHouse/ClickHouse/pull/24573) ([alesapin](https://github.com/alesapin)).
* Ограничения на ресурсы и изоляция для мостов ODBC и Library. Используйте отдельную группу и пользователя `clickhouse-bridge` для процессов bridge. Установите oom&#95;score&#95;adj так, чтобы bridge-процессы были первыми кандидатами для OOM killer. Установите максимальный размер RSS равным 1 GiB. Закрывает [#23861](https://github.com/ClickHouse/ClickHouse/issues/23861). [#25280](https://github.com/ClickHouse/ClickHouse/pull/25280) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена отдельная символьная ссылка `clickhouse-keeper` на основной исполняемый файл `clickhouse`. Теперь можно запускать сервис координации без основного сервера ClickHouse. [#24059](https://github.com/ClickHouse/ClickHouse/pull/24059) ([alesapin](https://github.com/alesapin)).
* Для запросов к `VIEW` теперь используются глобальные настройки. Исправлена проблема, при которой запросы к `VIEW` использовали локальные настройки, что приводило к ошибкам, если настройки при `CREATE VIEW` и `SELECT` различались. Начиная с текущей версии, `VIEW` не будет использовать эти изменённые настройки, но вы всё ещё можете передавать дополнительные настройки в секции `SETTINGS` запроса `CREATE VIEW`. Закрывает [#20551](https://github.com/ClickHouse/ClickHouse/issues/20551). [#24095](https://github.com/ClickHouse/ClickHouse/pull/24095) ([Vladimir](https://github.com/vdimir)).
* При запуске сервера части с некорректным идентификатором партиции не удалялись, а всегда только отсоединялись. [#25070](https://github.com/ClickHouse/ClickHouse/issues/25070). [#25166](https://github.com/ClickHouse/ClickHouse/pull/25166) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Увеличен размер пула фоновых задач до 128 (настройка `background_schedule_pool_size`). Это позволяет избежать зависаний очереди репликации при медленном подключении к ZooKeeper. [#25072](https://github.com/ClickHouse/ClickHouse/pull/25072) ([alesapin](https://github.com/alesapin)).
* Добавлен параметр MergeTree `max_parts_to_merge_at_once`, который ограничивает количество частей, которые могут одновременно сливаться в фоновом режиме. Не влияет на запрос `OPTIMIZE FINAL`. Исправляет [#1820](https://github.com/ClickHouse/ClickHouse/issues/1820). [#24496](https://github.com/ClickHouse/ClickHouse/pull/24496) ([alesapin](https://github.com/alesapin)).
* Разрешено использование оператора `NOT IN` при отсечении партиций. [#24894](https://github.com/ClickHouse/ClickHouse/pull/24894) ([Amos Bird](https://github.com/amosbird)).
* Распознавать IPv4-адреса, такие как `127.0.1.1`, как локальные. Это спорное изменение, которое закрывает [#23504](https://github.com/ClickHouse/ClickHouse/issues/23504). Michael Filimonov протестирует эту возможность. [#24316](https://github.com/ClickHouse/ClickHouse/pull/24316) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* База данных ClickHouse, созданная с помощью MaterializeMySQL (это экспериментальная функция), теперь содержит все комментарии к столбцам из материализованной базы данных MySQL. [#25199](https://github.com/ClickHouse/ClickHouse/pull/25199) ([Storozhuk Kostiantyn](https://github.com/sand6255)).
* Добавлены настройки (`connection_auto_close`/`connection_max_tries`/`connection_pool_size`) для табличного движка MySQL. [#24146](https://github.com/ClickHouse/ClickHouse/pull/24146) ([Azat Khuzhin](https://github.com/azat)).
* Ускорен запуск движка Distributed. [#25663](https://github.com/ClickHouse/ClickHouse/pull/25663) ([Azat Khuzhin](https://github.com/azat)).
* Улучшение для Distributed-таблиц. Исключены реплики из имени каталога (`dirname`) при `internal_replication=true` (это позволяет выполнять `INSERT` в Distributed-таблицу в кластере с любым количеством реплик; ранее поддерживалось только 15 реплик, при большем количестве возникала ошибка `ENAMETOOLONG` при создании директории для асинхронных блоков). [#25513](https://github.com/ClickHouse/ClickHouse/pull/25513) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка типа `Interval` для `LowCardinality`. Это требуется для промежуточных значений некоторых выражений. Закрыта задача [#21730](https://github.com/ClickHouse/ClickHouse/issues/21730). [#25410](https://github.com/ClickHouse/ClickHouse/pull/25410) ([Vladimir](https://github.com/vdimir)).
* Добавлен оператор `==` во временных условиях для функций `sequenceMatch` и `sequenceCount`. Например: sequenceMatch(&#39;(?1)(?t==1)(?2)&#39;)(time, data = 1, data = 2). [#25299](https://github.com/ClickHouse/ClickHouse/pull/25299) ([Christophe Kalenzaga](https://github.com/mga-chka)).
* Добавлены настройки `http_max_fields`, `http_max_field_name_size`, `http_max_field_value_size`. [#25296](https://github.com/ClickHouse/ClickHouse/pull/25296) ([Ivan](https://github.com/abyss7)).
* Добавлена поддержка функции `if` при использовании в её ветках типов `Decimal` и `Int`. Это закрывает [#20549](https://github.com/ClickHouse/ClickHouse/issues/20549). Это закрывает [#10142](https://github.com/ClickHouse/ClickHouse/issues/10142). [#25283](https://github.com/ClickHouse/ClickHouse/pull/25283) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Обновлено приглашение в `clickhouse-client` и добавлено сообщение при переподключении. Закрывает [#10577](https://github.com/ClickHouse/ClickHouse/issues/10577). [#25281](https://github.com/ClickHouse/ClickHouse/pull/25281) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено отслеживание памяти в агрегирующей функции `topK`. Это закрывает [#25259](https://github.com/ClickHouse/ClickHouse/issues/25259). [#25260](https://github.com/ClickHouse/ClickHouse/pull/25260) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен `topLevelDomain` для IDN-хостов (например, `example.рф`), ранее для таких хостов возвращалась пустая строка. [#25103](https://github.com/ClickHouse/ClickHouse/pull/25103) ([Azat Khuzhin](https://github.com/azat)).
* Определять версию ядра Linux во время выполнения (для корректной работы вложенного epoll, который требуется для `async_socket_for_remote`/`use_hedged_requests`, иначе удалённые запросы могут застревать). [#25067](https://github.com/ClickHouse/ClickHouse/pull/25067) ([Azat Khuzhin](https://github.com/azat)).
* Для распределённых запросов при `optimize_skip_unused_shards=1` теперь можно пропускать шарду с условием вида `(sharding key) IN (one-element-tuple)`. (Кортежи с несколькими элементами уже поддерживались. Кортеж с одним элементом не работал, потому что он интерпретируется как литерал). [#24930](https://github.com/ClickHouse/ClickHouse/pull/24930) ([Amos Bird](https://github.com/amosbird)).
* Улучшены сообщения логов об ошибках S3, больше нет двойных пробелов в случае пустых ключей и бакетов. [#24897](https://github.com/ClickHouse/ClickHouse/pull/24897) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Некоторые запросы требуют многопроходного семантического анализа. В таком случае попробуйте повторно использовать уже построенные множества для `IN`. [#24874](https://github.com/ClickHouse/ClickHouse/pull/24874) ([Amos Bird](https://github.com/amosbird)).
* Теперь учитывается `max_distributed_connections` для `insert_distributed_sync` (иначе, для очень больших кластеров при синхронной вставке может быть превышен предел `max_thread_pool_size`). [#24754](https://github.com/ClickHouse/ClickHouse/pull/24754) ([Azat Khuzhin](https://github.com/azat)).
* Избегайте подавления ошибок, таких как `Limit for rows or bytes to read exceeded`, для скалярных подзапросов. [#24545](https://github.com/ClickHouse/ClickHouse/pull/24545) ([nvartolomei](https://github.com/nvartolomei)).
* Ужесточить парсер String-to-Int, чтобы `toInt64('+')` вызывал исключение. [#24475](https://github.com/ClickHouse/ClickHouse/pull/24475) ([Amos Bird](https://github.com/amosbird)).
* Если `SSD_CACHE` создаётся с помощью DDL-запроса, он может быть создан только внутри каталога `user_files`. [#24466](https://github.com/ClickHouse/ClickHouse/pull/24466) ([Maksim Kita](https://github.com/kitaisreal)).
* Поддержка PostgreSQL для указания схемы, отличной от схемы по умолчанию, в запросах `INSERT`. Закрывает [#24149](https://github.com/ClickHouse/ClickHouse/issues/24149). [#24413](https://github.com/ClickHouse/ClickHouse/pull/24413) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено разрешение IPv6-адресов (то есть теперь корректно выполняется запрос `select * from remote('[::1]', system.one)`). [#24319](https://github.com/ClickHouse/ClickHouse/pull/24319) ([Azat Khuzhin](https://github.com/azat)).
* Устраняет висячие пробелы в конце предложения FROM с подзапросами в многострочном режиме, а также немного изменяет вывод запросов, делая его более удобочитаемым для человека. [#24151](https://github.com/ClickHouse/ClickHouse/pull/24151) ([Azat Khuzhin](https://github.com/azat)).
* Улучшение работы распределённых таблиц. Добавлена возможность разбивать распределённый пакет при ошибках (например, из‑за нехватки памяти или повреждения данных) с помощью настройки `distributed_directory_monitor_split_batch_on_failure` (по умолчанию отключена). [#23864](https://github.com/ClickHouse/ClickHouse/pull/23864) ([Azat Khuzhin](https://github.com/azat)).
* Реализована обработка конфликтов имён столбцов в движке таблиц `Join`. Закрывает [#20309](https://github.com/ClickHouse/ClickHouse/issues/20309). [#23769](https://github.com/ClickHouse/ClickHouse/pull/23769) ([Vladimir](https://github.com/vdimir)).
* Отображение прогресса для движка таблицы `File` в `clickhouse-local` и при выполнении запроса INSERT в `clickhouse-client` при передаче данных через stdin. Закрывает [#18209](https://github.com/ClickHouse/ClickHouse/issues/18209). [#23656](https://github.com/ClickHouse/ClickHouse/pull/23656) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлены ошибки и внесены улучшения в `clickhouse-copier`. Разрешено копирование таблиц с различными (но совместимыми) схемами. Закрывает [#9159](https://github.com/ClickHouse/ClickHouse/issues/9159). Добавлен тест для копирования ReplacingMergeTree. Закрывает [#22711](https://github.com/ClickHouse/ClickHouse/issues/22711). Добавлена поддержка TTL на столбцах и индексов пропуска данных (Data Skipping Indices). При создании внутренней таблицы типа Distributed они просто удаляются (базовая таблица при этом будет иметь TTL и индексы пропуска данных). Закрывает [#19384](https://github.com/ClickHouse/ClickHouse/issues/19384). Разрешено копирование столбцов MATERIALIZED и ALIAS. В некоторых случаях это может быть полезно (например, если этот столбец входит в PRIMARY KEY). Теперь это можно разрешить, установив свойство `allow_to_copy_alias_and_materialized_columns` в значение true в конфигурации задачи. Закрывает [#9177](https://github.com/ClickHouse/ClickHouse/issues/9177). Закрывает [#11007] ([https://github.com/ClickHouse/ClickHouse/issues/11007](https://github.com/ClickHouse/ClickHouse/issues/11007)). Закрывает [#9514](https://github.com/ClickHouse/ClickHouse/issues/9514). Добавлено свойство `allow_to_drop_target_partitions` в конфигурацию задачи для удаления секций в исходной таблице перед перемещением вспомогательных таблиц. Закрывает [#20957](https://github.com/ClickHouse/ClickHouse/issues/20957). Удалён запрос `OPTIMIZE DEDUPLICATE`. Этот обходной приём был необходим, потому что `ALTER TABLE MOVE PARTITION` повторялся много раз, а обычные таблицы MergeTree не поддерживают дедупликацию. Закрывает [#17966](https://github.com/ClickHouse/ClickHouse/issues/17966). Прогресс теперь записывается в узел ZooKeeper по пути `task_path + /status` в формате JSON. Закрывает [#20955](https://github.com/ClickHouse/ClickHouse/issues/20955). Добавлена поддержка ReplicatedTables без аргументов. Закрывает [#24834](https://github.com/ClickHouse/ClickHouse/issues/24834). [#23518](https://github.com/ClickHouse/ClickHouse/pull/23518) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлена пауза с экспоненциальной задержкой между повторными попытками чтения из S3. [#23461](https://github.com/ClickHouse/ClickHouse/pull/23461) ([Vladimir Chebotarev](https://github.com/excitoon)).
* При выполнении INSERT в таблицу `Distributed` учитывать настройку `insert_allow_materialized_columns` (разрешает вставку в материализованные столбцы). [#23349](https://github.com/ClickHouse/ClickHouse/pull/23349) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка проталкивания LIMIT в распределённые запросы. [#23027](https://github.com/ClickHouse/ClickHouse/pull/23027) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема zero-copy репликации с несколькими томами S3 (устраняет [#22679](https://github.com/ClickHouse/ClickHouse/issues/22679)). [#22864](https://github.com/ClickHouse/ClickHouse/pull/22864) ([ianton-ru](https://github.com/ianton-ru)).
* Определять фактический номер порта, к которому осуществляется привязка, когда пользователь запрашивает у операционной системы любой доступный порт, и выводить его в сообщении журнала. [#25569](https://github.com/ClickHouse/ClickHouse/pull/25569) ([bnaecker](https://github.com/bnaecker)).
* Исправлена проблема, из-за которой при преобразовании массивов PostgreSQL иногда получался тип данных String вместо n-мерного массива, так как `attndims` в некоторых случаях работает некорректно. Закрывает [#24804](https://github.com/ClickHouse/ClickHouse/issues/24804). [#25538](https://github.com/ClickHouse/ClickHouse/pull/25538) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено преобразование `DateTime` с часовым поясом для MySQL, PostgreSQL и ODBC. Закрывает [#5057](https://github.com/ClickHouse/ClickHouse/issues/5057). [#25528](https://github.com/ClickHouse/ClickHouse/pull/25528) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Различать KILL MUTATION для разных таблиц (исправляет неожиданную ошибку `Cancelled mutating parts`). [#25025](https://github.com/ClickHouse/ClickHouse/pull/25025) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена возможность объявлять диск S3 в корне бакета (виртуальная файловая система S3 — экспериментальная функция, находящаяся в разработке). [#24898](https://github.com/ClickHouse/ClickHouse/pull/24898) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Включено чтение подколонок (например, компонентов `Tuple`) для распределённых таблиц. [#24472](https://github.com/ClickHouse/ClickHouse/pull/24472) ([Anton Popov](https://github.com/CurtizJ)).
* Изменение для протокола совместимости с MySQL: функция `user` теперь возвращает корректный результат. Закрывает [#25697](https://github.com/ClickHouse/ClickHouse/pull/25697). [#25697](https://github.com/ClickHouse/ClickHouse/pull/25697) ([sundyli](https://github.com/sundy-li)).

#### Исправление ошибки {#bug-fix-3}

* Улучшена обратная совместимость. Использовать старую версию функции вычисления остатка от деления, если она используется в ключе партиционирования. Закрывает [#23508](https://github.com/ClickHouse/ClickHouse/issues/23508). [#24157](https://github.com/ClickHouse/ClickHouse/pull/24157) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена крайне редкая ошибка на серверах с малым объёмом памяти, которая могла приводить к невозможности выполнять слияния без перезапуска. Возможно, исправляет [#24603](https://github.com/ClickHouse/ClickHouse/issues/24603). [#24872](https://github.com/ClickHouse/ClickHouse/pull/24872) ([alesapin](https://github.com/alesapin)).
* Исправлена крайне редкая ошибка `Tagging already tagged part` в очереди репликации при одновременном выполнении `alter move/replace partition`. Вероятно, исправляет [#22142](https://github.com/ClickHouse/ClickHouse/issues/22142). [#24961](https://github.com/ClickHouse/ClickHouse/pull/24961) ([alesapin](https://github.com/alesapin)).
* Исправлено потенциальное падение при вычислении состояний агрегатных функций путём агрегирования состояний других агрегатных функций (непрактичный сценарий использования). См. [#24523](https://github.com/ClickHouse/ClickHouse/issues/24523). [#25015](https://github.com/ClickHouse/ClickHouse/pull/25015) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено поведение в случае, когда запрос `SYSTEM RESTART REPLICA` или `SYSTEM SYNC REPLICA` не завершается. Это было обнаружено на сервере с крайне небольшим объёмом ОЗУ. [#24457](https://github.com/ClickHouse/ClickHouse/pull/24457) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена ошибка, которая могла приводить к зависанию клиента ZooKeeper в clickhouse-server. [#24721](https://github.com/ClickHouse/ClickHouse/pull/24721) ([alesapin](https://github.com/alesapin)).
* Если соединение с ZooKeeper было потеряно и реплика была клонирована после его восстановления, ее очередь репликации могла содержать устаревшие записи. Исправлено ошибочное срабатывание assert, когда очередь репликации содержит пересекающиеся виртуальные части. Это может редко происходить, если какая‑то часть данных была утеряна. Вместо завершения работы теперь выводится сообщение об ошибке в лог. [#24777](https://github.com/ClickHouse/ClickHouse/pull/24777) ([tavplubix](https://github.com/tavplubix)).
* Исправлена потеря условия `WHERE` при оптимизации проталкивания выражений в плане запроса (настройка `query_plan_filter_push_down = 1` теперь включена по умолчанию). Исправляет [#25368](https://github.com/ClickHouse/ClickHouse/issues/25368). [#25370](https://github.com/ClickHouse/ClickHouse/pull/25370) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, которая могла приводить к пересекающимся частям данных после слияний с TTL: `Part all_40_40_0 is covered by all_40_40_1 but should be merged into all_40_41_1. This shouldn't happen often.`. [#25549](https://github.com/ClickHouse/ClickHouse/pull/25549) ([alesapin](https://github.com/alesapin)).
* При потере соединения с ZooKeeper таблица `ReplicatedMergeTree` могла ожидать завершения фоновых операций перед повторной попыткой подключения. Это исправлено, теперь фоновые операции принудительно останавливаются. [#25306](https://github.com/ClickHouse/ClickHouse/pull/25306) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка `Key expression contains comparison between inconvertible types` в запросах с `ARRAY JOIN` в случае, если массив используется в качестве первичного ключа. Исправляет [#8247](https://github.com/ClickHouse/ClickHouse/issues/8247). [#25546](https://github.com/ClickHouse/ClickHouse/pull/25546) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены некорректные итоги в запросах `WITH TOTALS` и `WITH FILL`. Исправляет [#20872](https://github.com/ClickHouse/ClickHouse/issues/20872). [#25539](https://github.com/ClickHouse/ClickHouse/pull/25539) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена гонка данных при выполнении запроса к `system.clusters` одновременно с перезагрузкой конфигурации кластера. [#25737](https://github.com/ClickHouse/ClickHouse/pull/25737) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка `No such file or directory` при перемещении таблицы типа `Distributed` между базами данных. Исправление для [#24971](https://github.com/ClickHouse/ClickHouse/issues/24971). [#25667](https://github.com/ClickHouse/ClickHouse/pull/25667) ([tavplubix](https://github.com/tavplubix)).
* `REPLACE PARTITION` в редких случаях мог игнорироваться, если исходный раздел был пустым. Ошибка исправлена. Исправляет [#24869](https://github.com/ClickHouse/ClickHouse/issues/24869). [#25665](https://github.com/ClickHouse/ClickHouse/pull/25665) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка в движке базы данных `Replicated`, которая в редких случаях могла приводить к пропуску поставленного в очередь DDL‑запроса одной из реплик. [#24805](https://github.com/ClickHouse/ClickHouse/pull/24805) ([tavplubix](https://github.com/tavplubix)).
* Исправлено разыменование нулевого указателя при вызове `EXPLAIN AST` без запроса. [#25631](https://github.com/ClickHouse/ClickHouse/pull/25631) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена логика ожидания автоматического удаления пустых частей. Это могло приводить к полному заполнению пула фоновых задач и зависанию репликации. [#23315](https://github.com/ClickHouse/ClickHouse/pull/23315) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено восстановление таблицы, хранящейся в виртуальной файловой системе S3 (это экспериментальная функция, пока не предназначенная для использования в продакшене). [#25601](https://github.com/ClickHouse/ClickHouse/pull/25601) ([ianton-ru](https://github.com/ianton-ru)).
* Исправлено разыменование `nullptr` в формате `Arrow` при использовании `Decimal256`. Добавлена поддержка `Decimal256` в формате `Arrow`. [#25531](https://github.com/ClickHouse/ClickHouse/pull/25531) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен лишний символ подчёркивания перед именами предварительно обработанных файлов конфигурации. [#25431](https://github.com/ClickHouse/ClickHouse/pull/25431) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправление для инструмента `clickhouse-copier`: устранена ошибка, приводившая к сегфолту при отсутствии `sharding_key` в конфигурации задачи копировщика. [#25419](https://github.com/ClickHouse/ClickHouse/pull/25419) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлен столбцовый трансформер `REPLACE` при использовании в DDL путём корректного заключения форматированного запроса в кавычки. Это исправляет [#23925](https://github.com/ClickHouse/ClickHouse/issues/23925). [#25391](https://github.com/ClickHouse/ClickHouse/pull/25391) ([Amos Bird](https://github.com/amosbird)).
* Исправлена проблема, которая могла приводить к недетерминированному поведению функции `quantileDeterministic` и аналогичных функций. Это закрывает [#20480](https://github.com/ClickHouse/ClickHouse/issues/20480). [#25313](https://github.com/ClickHouse/ClickHouse/pull/25313) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка `SimpleAggregateFunction(LowCardinality)` для `SummingMergeTree`. Исправляет проблему [#25134](https://github.com/ClickHouse/ClickHouse/issues/25134). [#25300](https://github.com/ClickHouse/ClickHouse/pull/25300) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена логическая ошибка, приводившая к исключению с сообщением &quot;Cannot sum Array/Tuple in min/maxMap&quot;. [#25298](https://github.com/ClickHouse/ClickHouse/pull/25298) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка `Bad cast from type DB::ColumnLowCardinality to DB::ColumnVector<char8_t>` в запросах, в которых аргумент `LowCardinality` использовался в операторе IN (эта ошибка появилась в 21.6). Исправляет [#25187](https://github.com/ClickHouse/ClickHouse/issues/25187). [#25290](https://github.com/ClickHouse/ClickHouse/pull/25290) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено некорректное поведение `joinGetOrNull` с не-nullable столбцами. Это исправляет [#24261](https://github.com/ClickHouse/ClickHouse/issues/24261). [#25288](https://github.com/ClickHouse/ClickHouse/pull/25288) ([Amos Bird](https://github.com/amosbird)).
* Исправлено некорректное поведение и отчёт UBSan при работе с большими целыми числами. В предыдущих версиях `CAST(1e19 AS UInt128)` возвращал ноль. [#25279](https://github.com/ClickHouse/ClickHouse/pull/25279) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка, возникавшая при вставке подмножества столбцов в формате CSVWithNames. Исправляет [#25129](https://github.com/ClickHouse/ClickHouse/issues/25129). [#25169](https://github.com/ClickHouse/ClickHouse/pull/25169) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Не используйте проекцию таблицы для `SELECT` с `FINAL`. Это в настоящее время не поддерживается. [#25163](https://github.com/ClickHouse/ClickHouse/pull/25163) ([Amos Bird](https://github.com/amosbird)).
* Исправлена возможная потеря частей данных после обновления до 21.5 в случае, если в ключе партиционирования таблицы использовался `UUID` (использовать `UUID` в ключе партиционирования не рекомендуется). Исправление для [#25070](https://github.com/ClickHouse/ClickHouse/issues/25070). [#25127](https://github.com/ClickHouse/ClickHouse/pull/25127) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, приводившая к сбою запроса с CROSS JOIN при `joined_subquery_requires_alias = 0`. Исправляет [#24011](https://github.com/ClickHouse/ClickHouse/issues/24011). [#25082](https://github.com/ClickHouse/ClickHouse/pull/25082) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка с константными `map` в функции `mapContains`, которая приводила к ошибке `empty column was returned by function mapContains`. Закрывает [#25077](https://github.com/ClickHouse/ClickHouse/issues/25077). [#25080](https://github.com/ClickHouse/ClickHouse/pull/25080) ([Kruglov Pavel](https://github.com/Avogar)).
* Убрана возможность создавать таблицы со столбцами, ссылающимися на самих себя, например `a UInt32 ALIAS a + 1` или `b UInt32 MATERIALIZED b`. Исправлены [#24910](https://github.com/ClickHouse/ClickHouse/issues/24910), [#24292](https://github.com/ClickHouse/ClickHouse/issues/24292). [#25059](https://github.com/ClickHouse/ClickHouse/pull/25059) ([alesapin](https://github.com/alesapin)).
* Исправлен неверный результат при использовании агрегирующей проекции с *непустым* ключом `GROUP BY` для запроса с `GROUP BY` по *пустому* ключу. [#25055](https://github.com/ClickHouse/ClickHouse/pull/25055) ([Amos Bird](https://github.com/amosbird)).
* Исправлена сериализация разделённых вложенных сообщений в формате Protobuf. Этот PR исправляет [#24647](https://github.com/ClickHouse/ClickHouse/issues/24647). [#25000](https://github.com/ClickHouse/ClickHouse/pull/25000) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена обработка настроек LIMIT/OFFSET для распределённых запросов (теперь они игнорируются на удалённых узлах). [#24940](https://github.com/ClickHouse/ClickHouse/pull/24940) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено возможное переполнение буфера кучи (heap-buffer-overflow) в формате `Arrow`. [#24922](https://github.com/ClickHouse/ClickHouse/pull/24922) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена возможная ошибка &#39;Cannot read from istream at offset 0&#39; при чтении файла с DiskS3 (виртуальная файловая система S3 является экспериментальной функциональностью в разработке и не должна использоваться в продакшене). [#24885](https://github.com/ClickHouse/ClickHouse/pull/24885) ([Pavel Kovalenko](https://github.com/Jokser)).
* Исправлено исключение &quot;Missing columns&quot; при выполнении JOIN с распределённым материализованным представлением. [#24870](https://github.com/ClickHouse/ClickHouse/pull/24870) ([Azat Khuzhin](https://github.com/azat)).
* Разрешить использование значений `NULL` в протоколе совместимости с PostgreSQL. Закрывает [#22622](https://github.com/ClickHouse/ClickHouse/issues/22622). [#24857](https://github.com/ClickHouse/ClickHouse/pull/24857) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка, из-за которой при ожидании завершения мутации клиенту могло выбрасываться исключение `Mutation was killed`, когда мутация ещё не была загружена в память. [#24809](https://github.com/ClickHouse/ClickHouse/pull/24809) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка в десериализации состояния генератора случайных чисел, которая могла приводить к тому, что некоторые типы данных, такие как `AggregateFunction(groupArraySample(N), T))`, вели себя недетерминированно. [#24538](https://github.com/ClickHouse/ClickHouse/pull/24538) ([tavplubix](https://github.com/tavplubix)).
* Запрещено строить uniqXXXXStates на основе других состояний агрегации. [#24523](https://github.com/ClickHouse/ClickHouse/pull/24523) ([Raúl Marín](https://github.com/Algunenano)). Затем это снова разрешено за счёт устранения первопричины связанной проблемы. ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено использование кортежей в запросах вида `CREATE .. AS SELECT`. [#24464](https://github.com/ClickHouse/ClickHouse/pull/24464) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено вычисление общего количества байтов в таблице `Buffer`. В текущей версии ClickHouse счётчик total&#95;writes.bytes слишком сильно уменьшается во время сброса буфера. Это приводит к переполнению счётчика, и totalBytes начинает возвращать значение порядка 17,44 ЭБ спустя некоторое время после сброса. [#24450](https://github.com/ClickHouse/ClickHouse/pull/24450) ([DimasKovas](https://github.com/DimasKovas)).
* Исправлена некорректная информация о монотонности функции toWeek. Это исправление закрывает [#24422](https://github.com/ClickHouse/ClickHouse/issues/24422). Этот баг появился в [https://github.com/ClickHouse/ClickHouse/pull/5212](https://github.com/ClickHouse/ClickHouse/pull/5212) и позже проявился из‑за более продвинутого механизма отсечения партиций. [#24446](https://github.com/ClickHouse/ClickHouse/pull/24446) ([Amos Bird](https://github.com/amosbird)).
* Когда аутентификация пользователей осуществляется через LDAP. Исправлена потенциальная взаимоблокировка, которая могла возникать при (пере)сопоставлении ролей LDAP, когда группа LDAP сопоставлялась с несуществующей локальной ролью. [#24431](https://github.com/ClickHouse/ClickHouse/pull/24431) ([Denis Glazachev](https://github.com/traceon)).
* В сообщении &quot;multipart/form-data&quot; CRLF, предшествующий границе, следует считать частью этой границы. Исправляет [#23905](https://github.com/ClickHouse/ClickHouse/issues/23905). [#24399](https://github.com/ClickHouse/ClickHouse/pull/24399) ([Ivan](https://github.com/abyss7)).
* Исправлена операция DROP PARTITION при пересечении с фиктивными частями. В редких случаях могли существовать части с версией мутации, превышающей текущий номер блока. [#24321](https://github.com/ClickHouse/ClickHouse/pull/24321) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка переноса материализованного представления из базы данных Ordinary в Atomic (запрос `RENAME TABLE`). Теперь внутренняя таблица переносится в новую базу данных вместе с материализованным представлением. Исправляет [#23926](https://github.com/ClickHouse/ClickHouse/issues/23926). [#24309](https://github.com/ClickHouse/ClickHouse/pull/24309) ([tavplubix](https://github.com/tavplubix)).
* Разрешены пустые HTTP-заголовки. Исправляет [#23901](https://github.com/ClickHouse/ClickHouse/issues/23901). [#24285](https://github.com/ClickHouse/ClickHouse/pull/24285) ([Ivan](https://github.com/abyss7)).
* Правильная обработка мутаций (ALTER UPDATE/DELETE) в таблицах Memory. Закрывает [#24274](https://github.com/ClickHouse/ClickHouse/issues/24274). [#24275](https://github.com/ClickHouse/ClickHouse/pull/24275) ([flynn](https://github.com/ucasfl)).
* Сделать свойство LowCardinality для столбца в результате JOIN таким же, как у входного столбца, закрыть [#23351](https://github.com/ClickHouse/ClickHouse/issues/23351) и [#20315](https://github.com/ClickHouse/ClickHouse/issues/20315). [#24061](https://github.com/ClickHouse/ClickHouse/pull/24061) ([Vladimir](https://github.com/vdimir)).
* Исправление для таблиц Kafka. Устранён баг в поведении при аварийном переключении: движок с Engine = Kafka не мог запустить потребление, если у того же потребителя ранее было пустое назначение разделов. Закрывает [#21118](https://github.com/ClickHouse/ClickHouse/issues/21118). [#21267](https://github.com/ClickHouse/ClickHouse/pull/21267) ([filimonov](https://github.com/filimonov)).

#### Улучшения сборки, тестирования и упаковки {#buildtestingpackaging-improvement-4}

* Добавлены сборки `darwin-aarch64` (Mac M1 / Apple Silicon) в CI [#25560](https://github.com/ClickHouse/ClickHouse/pull/25560) ([Ivan](https://github.com/abyss7)) и добавлены ссылки в документацию и на сайт ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлено кроссплатформенное встраивание бинарных ресурсов в исполняемые файлы. Работает на Illumos. [#25146](https://github.com/ClickHouse/ClickHouse/pull/25146) ([bnaecker](https://github.com/bnaecker)).
* Добавлены параметры, связанные с `JOIN`, в стресс‑тесты для улучшения фаззинга. [#25200](https://github.com/ClickHouse/ClickHouse/pull/25200) ([Vladimir](https://github.com/vdimir)).
* Включена сборка с модулем s3 в OS X [#25217](https://github.com/ClickHouse/ClickHouse/issues/25217). [#25218](https://github.com/ClickHouse/ClickHouse/pull/25218) ([kevin wan](https://github.com/MaxWk)).
* Добавлены интеграционные тесты для JDBC bridge. [#25047](https://github.com/ClickHouse/ClickHouse/pull/25047) ([Zhichun Wu](https://github.com/zhicwu)).
* Конфигурация интеграционных тестов теперь по‑особому обрабатывает словари. Удалена оставшаяся ручная настройка словарей. [#24728](https://github.com/ClickHouse/ClickHouse/pull/24728) ([Ilya Yatsishin](https://github.com/qoega)).
* Добавлены тесты libfuzzer для класса YAMLParser. [#24480](https://github.com/ClickHouse/ClickHouse/pull/24480) ([BoloniniD](https://github.com/BoloniniD)).
* Для запуска интеграционных тестов теперь используется Ubuntu 20.04, версия docker-compose, используемая для интеграционных тестов, обновлена до 1.28.2. Переменные окружения теперь влияют на работу docker-compose. Переработан тест `test_dictionaries_all_layouts_separate_sources`, чтобы разрешить параллельный запуск. [#20393](https://github.com/ClickHouse/ClickHouse/pull/20393) ([Ilya Yatsишин](https://github.com/qoega)).
* Исправлена ошибка TOCTOU в установочном скрипте. [#25277](https://github.com/ClickHouse/ClickHouse/pull/25277) ([alexey-milovidov](https://github.com/alexey-milovidov)).

### Релиз ClickHouse 21.6, 2021-06-05 {#clickhouse-release-216-2021-06-05}

#### Изменения, нарушающие обратную совместимость {#backward-incompatible-change-5}

* `uniqState` / `uniqHLL12State` / `uniqCombinedState` / `uniqCombined64State` создают несовместимые состояния с типом `UUID`. [#33607](https://github.com/ClickHouse/ClickHouse/issues/33607).

#### Примечания по обновлению {#upgrade-notes-1}

* Библиотека сжатия `zstd` обновлена до v1.5.0. При репликации вы можете получать сообщения вида «checksum does not match». Эти сообщения ожидаемы из‑за обновления алгоритма сжатия, и вы можете их игнорировать. Они носят информационный характер и не указывают ни на какие виды нежелательного поведения.
* Настройка `compile_expressions` включена по умолчанию. Хотя она была тщательно протестирована в широком спектре сценариев, если вы обнаружите какое‑либо нежелательное поведение на ваших серверах, вы можете попробовать отключить эту настройку.
* Значения типа `UUID` нельзя сравнивать с целыми числами. Например, вместо `uuid != 0` указывайте `uuid != '00000000-0000-0000-0000-000000000000'`.

#### Новая возможность {#new-feature-5}

* Добавлен оператор приведения типа, аналогичный оператору в Postgres (`::`). Например: `[1, 2]::Array(UInt8)`, `0.1::Decimal(4, 4)`, `number::UInt16`. [#23871](https://github.com/ClickHouse/ClickHouse/pull/23871) ([Anton Popov](https://github.com/CurtizJ)).
* Подготовить поддержку больших целых чисел к использованию в production. Добавить поддержку типа данных `UInt128`. Исправить известные проблемы с типом данных `Decimal256`. Добавить поддержку больших целых чисел в словарях. Добавить поддержку функций `gcd`/`lcm` для больших целых чисел. Добавить поддержку больших целых чисел в функциях поиска по массивам и условных функциях. Добавить поддержку `LowCardinality(UUID)`. Добавить поддержку больших целых чисел в табличной функции `generateRandom` и в `clickhouse-obfuscator`. Исправить ошибку при возврате `UUID` из скалярных подзапросов. Это исправляет [#7834](https://github.com/ClickHouse/ClickHouse/issues/7834). Это исправляет [#23936](https://github.com/ClickHouse/ClickHouse/issues/23936). Это исправляет [#4176](https://github.com/ClickHouse/ClickHouse/issues/4176). Это исправляет [#24018](https://github.com/ClickHouse/ClickHouse/issues/24018). Обратное несовместимое изменение: значения типа `UUID` нельзя сравнивать с целым числом. Например, вместо `uuid != 0` пишите `uuid != '00000000-0000-0000-0000-000000000000'`. [#23631](https://github.com/ClickHouse/ClickHouse/pull/23631) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Реализована поддержка типа данных `Array` для вставки и выборки данных в форматах `Arrow`, `Parquet` и `ORC`. [#21770](https://github.com/ClickHouse/ClickHouse/pull/21770) ([taylor12805](https://github.com/taylor12805)).
* Реализованы комментарии для таблиц. Закрывает [#23225](https://github.com/ClickHouse/ClickHouse/issues/23225). [#23548](https://github.com/ClickHouse/ClickHouse/pull/23548) ([flynn](https://github.com/ucasFL)).
* Добавлена поддержка создания словарей с помощью DDL-запросов в `clickhouse-local`. Закрывает [#22354](https://github.com/ClickHouse/ClickHouse/issues/22354). Добавлена поддержка `DETACH DICTIONARY PERMANENTLY`. Добавлена поддержка `EXCHANGE DICTIONARIES` для движка базы данных `Atomic`. Добавлена поддержка перемещения словарей между базами данных с помощью `RENAME DICTIONARY`. [#23436](https://github.com/ClickHouse/ClickHouse/pull/23436) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена агрегатная функция `uniqTheta` для поддержки [Theta Sketch](https://datasketches.apache.org/docs/Theta/ThetaSketchFramework.html) в ClickHouse. [#23894](https://github.com/ClickHouse/ClickHouse/pull/23894). [#22609](https://github.com/ClickHouse/ClickHouse/pull/22609) ([Ping Yu](https://github.com/pingyu)).
* Добавлена функция `splitByRegexp`. [#24077](https://github.com/ClickHouse/ClickHouse/pull/24077) ([abel-cheng](https://github.com/abel-cheng)).
* Добавлена функция `arrayProduct`, которая принимает массив в качестве аргумента и возвращает произведение всех элементов массива. Закрывает [#21613](https://github.com/ClickHouse/ClickHouse/issues/21613). [#23782](https://github.com/ClickHouse/ClickHouse/pull/23782) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлен столбец `thread_name` в `system.stack_trace`. Тем самым закрыта задача [#23256](https://github.com/ClickHouse/ClickHouse/issues/23256). [#24124](https://github.com/ClickHouse/ClickHouse/pull/24124) ([abel-cheng](https://github.com/abel-cheng)).
* Если `insert_null_as_default` = 1, в запросах `INSERT ... SELECT` и `INSERT ... SELECT ... UNION ALL ...` вместо NULL вставляются значения по умолчанию. Закрывает [#22832](https://github.com/ClickHouse/ClickHouse/issues/22832). [#23524](https://github.com/ClickHouse/ClickHouse/pull/23524) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка отображения прогресса в `clickhouse-local` с помощью опции `--progress`. [#23196](https://github.com/ClickHouse/ClickHouse/pull/23196) ([Egor Savin](https://github.com/Amesaru)).
* Добавлена поддержка HTTP-сжатия (определяемого HTTP-заголовком `Content-Encoding`) в источнике словаря `http`. Это исправляет [#8912](https://github.com/ClickHouse/ClickHouse/issues/8912). [#23946](https://github.com/ClickHouse/ClickHouse/pull/23946) ([FArthur-cmd](https://github.com/FArthur-cmd)).
* Добавлены `SYSTEM QUERY RELOAD MODEL`, `SYSTEM QUERY RELOAD MODELS`. Закрыта задача [#18722](https://github.com/ClickHouse/ClickHouse/issues/18722). [#23182](https://github.com/ClickHouse/ClickHouse/pull/23182) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена настройка `json` (булевый параметр, по умолчанию 0) для запроса `EXPLAIN PLAN`. При включении вывод запроса будет одной JSON-строкой. Рекомендуется использовать формат `TSVRaw`, чтобы избежать излишнего экранирования. [#23082](https://github.com/ClickHouse/ClickHouse/pull/23082) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлена настройка `indexes` (логическая, по умолчанию отключена) для запроса `EXPLAIN PIPELINE`. При включении показывает используемые индексы, количество отфильтрованных частей и гранул для каждого применённого индекса. Поддерживается для таблиц семейства `MergeTree*`. [#22352](https://github.com/ClickHouse/ClickHouse/pull/22352) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* LDAP: реализовано определение DN пользователя для использования при сопоставлении групп Active Directory с ролями ClickHouse. [#22228](https://github.com/ClickHouse/ClickHouse/pull/22228) ([Denis Glazachev](https://github.com/traceon)).
* Новая агрегатная функция `deltaSumTimestamp` для суммирования разницы между последовательными строками с сохранением порядка при слиянии за счёт хранения временных меток. [#21888](https://github.com/ClickHouse/ClickHouse/pull/21888) ([Russ Frank](https://github.com/rf)).
* Добавлен менее безопасный IMDS-провайдер учетных данных для S3, который корректно работает в Docker. [#21852](https://github.com/ClickHouse/ClickHouse/pull/21852) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Добавить обратно функцию `indexHint`. Это для [#21238](https://github.com/ClickHouse/ClickHouse/issues/21238). Это отменяет изменения из [#9542](https://github.com/ClickHouse/ClickHouse/pull/9542). Это исправляет [#9540](https://github.com/ClickHouse/ClickHouse/issues/9540). [#21304](https://github.com/ClickHouse/ClickHouse/pull/21304) ([Amos Bird](https://github.com/amosbird)).

#### Экспериментальная функция {#experimental-feature-5}

* Добавлена поддержка проекций (`PROJECTION`) для таблиц `MergeTree*`. [#20202](https://github.com/ClickHouse/ClickHouse/pull/20202) ([Amos Bird](https://github.com/amosbird)).

#### Улучшение производительности {#performance-improvement-5}

* Включена настройка `compile_expressions` по умолчанию. Когда эта настройка включена, комбинации простых функций и операторов во время выполнения компилируются в нативный код с помощью LLVM. [#8482](https://github.com/ClickHouse/ClickHouse/pull/8482) ([Maksim Kita](https://github.com/kitaisreal), [alexey-milovidov](https://github.com/alexey-milovidov)). Примечание: если у вас возникают проблемы, отключите эту опцию.
* Обновлена библиотека `re2`. Улучшена производительность сопоставления с регулярными выражениями. Также этот PR добавляет совместимость с gcc-11. [#24196](https://github.com/ClickHouse/ClickHouse/pull/24196) ([Raúl Marín](https://github.com/Algunenano)).
* Формат ввода ORC теперь читает данные по stripe вместо чтения всей таблицы в память за один раз, что экономит память при очень большом размере файла. [#23102](https://github.com/ClickHouse/ClickHouse/pull/23102) ([Chao Ma](https://github.com/godliness)).
* Слияние агрегатных функций `sum`, `count` и `avg` в запросе в одну агрегатную функцию. Оптимизация управляется настройкой `optimize_fuse_sum_count_avg`. Это реализовано с помощью новой агрегатной функции `sumCount`. Эта функция возвращает кортеж из двух полей: `sum` и `count`. [#21337](https://github.com/ClickHouse/ClickHouse/pull/21337) ([hexiaoting](https://github.com/hexiaoting)).
* Обновление `zstd` до v1.5.0. Производительность сжатия улучшена на несколько процентов. [#24135](https://github.com/ClickHouse/ClickHouse/pull/24135) ([Raúl Марин](https://github.com/Algunenano)). Примечание: вы можете получать сообщения о том, что "checksum does not match" при репликации. Эти сообщения ожидаемы из-за обновления алгоритма сжатия, и их можно игнорировать.
* Улучшена производительность таблиц `Buffer`: больше не берётся блокировка для total_bytes/total_rows для движка `Buffer`. [#24066](https://github.com/ClickHouse/ClickHouse/pull/24066) ([Azat Khuzhin](https://github.com/azat)).
* Возвращена поддержка предварительного выделения памяти (preallocate) для словарей `hashed`/`sparse_hashed`. [#23979](https://github.com/ClickHouse/ClickHouse/pull/23979) ([Azat Khuzhin](https://github.com/azat)).
* Включён `async_socket_for_remote` по умолчанию (меньшее количество потоков при выполнении запросов к Distributed-таблицам с большим fanout). [#23683](https://github.com/ClickHouse/ClickHouse/pull/23683) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).

#### Улучшение {#improvement-5}

* Добавлен виртуальный столбец `_partition_value` в семейство таблиц MergeTree. Он может использоваться для детерминированной фильтрации партиций. Это необходимо для реализации механизма сопоставления партиций при мутациях. [#23673](https://github.com/ClickHouse/ClickHouse/pull/23673) ([Amos Bird](https://github.com/amosbird)).
* Добавлен параметр `region` для S3‑хранилища и диска. [#23846](https://github.com/ClickHouse/ClickHouse/pull/23846) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Добавлена возможность настраивать разные уровни логирования для разных каналов. Закрывает [#19569](https://github.com/ClickHouse/ClickHouse/issues/19569). [#23857](https://github.com/ClickHouse/ClickHouse/pull/23857) ([filimonov](https://github.com/filimonov)).
* Сохраняется часовой пояс по умолчанию в операциях с `DateTime`, если он не был указан явно. Например, если вы добавите одну секунду к значению типа `DateTime` без часового пояса, оно останется `DateTime` без часового пояса. В предыдущих версиях значение часового пояса по умолчанию явно подставлялось в возвращаемый тип данных, и тип становился DateTime(&#39;something&#39;). Это закрывает [#4854](https://github.com/ClickHouse/ClickHouse/issues/4854). [#23392](https://github.com/ClickHouse/ClickHouse/pull/23392) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность указывать пустую строку вместо имени базы данных для хранилища `MySQL`. Для запросов будет использоваться база данных по умолчанию. В предыдущих версиях это работало только для запросов SELECT; теперь добавлена поддержка и для INSERT. Это закрывает [#19281](https://github.com/ClickHouse/ClickHouse/issues/19281). Это может быть полезно при работе с `Sphinx` или другими внешними базами данных, совместимыми с MySQL. [#23319](https://github.com/ClickHouse/ClickHouse/pull/23319) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен `quantile(s)TDigest`. Добавлена специальная обработка единичных центроидов в соответствии с tdunning/t-digest 3.2+. Также была исправлена ошибка с чрезмерной компрессией центроидов в реализации более ранней версии алгоритма. [#23314](https://github.com/ClickHouse/ClickHouse/pull/23314) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Функция `now64` теперь поддерживает необязательный аргумент часового пояса. [#24091](https://github.com/ClickHouse/ClickHouse/pull/24091) ([Vasily Nemkov](https://github.com/Enmk)).
* Исправлена ситуация, когда индикатор прогресса при работе в интерактивном режиме clickhouse-client, появляясь посреди данных, мог перезаписывать часть уже выведенных на экран данных в терминале. Это закрывает [#19283](https://github.com/ClickHouse/ClickHouse/issues/19283). [#23050](https://github.com/ClickHouse/ClickHouse/pull/23050) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен сбой при ошибке выделения памяти в simdjson. [https://github.com/simdjson/simdjson/pull/1567](https://github.com/simdjson/simdjson/pull/1567). Помечено как улучшение, поскольку это крайне редкая ошибка. [#24147](https://github.com/ClickHouse/ClickHouse/pull/24147) ([Amos Bird](https://github.com/amosbird)).
* Не выгружать словари до остановки хранилища (это позволит избежать возможных ошибок `external dictionary 'DICT' not found` при остановке сервера во время финального сброса данных движка `Buffer`). [#24068](https://github.com/ClickHouse/ClickHouse/pull/24068) ([Azat Khuzhin](https://github.com/azat)).
* Сбрасывать таблицы типа `Buffer` перед их остановкой (в рамках одной базы данных), чтобы избежать отбрасывания блоков, когда базовая таблица уже отсоединена (и появления ошибки `Destination table default.a_data_01870 doesn't exist. Block of data is discarded` в журнале). [#24067](https://github.com/ClickHouse/ClickHouse/pull/24067) ([Azat Khuzhin](https://github.com/azat)).
* Теперь при `prefer_column_name_to_alias = 1` также будут предпочитаться имена столбцов для `group by`, `having` и `order by`. Это исправляет [#23882](https://github.com/ClickHouse/ClickHouse/issues/23882). [#24022](https://github.com/ClickHouse/ClickHouse/pull/24022) ([Amos Bird](https://github.com/amosbird)).
* Добавлена поддержка `ORDER BY WITH FILL` для `DateTime64`. [#24016](https://github.com/ClickHouse/ClickHouse/pull/24016) ([kevin wan](https://github.com/MaxWk)).
* Включить возможность использования `DateTime64` в качестве столбца версии в `ReplacingMergeTree`. [#23992](https://github.com/ClickHouse/ClickHouse/pull/23992) ([kevin wan](https://github.com/MaxWk)).
* Записывать в журнал сведения об имени ОС, версии ядра и архитектуре CPU при запуске сервера. [#23988](https://github.com/ClickHouse/ClickHouse/pull/23988) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка указания схемы таблицы для источника словаря `postgresql`. Закрывает [#23958](https://github.com/ClickHouse/ClickHouse/issues/23958). [#23980](https://github.com/ClickHouse/ClickHouse/pull/23980) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлены подсказки для имён элементов `Enum` (предлагаются варианты имён в случае опечаток). Закрывает [#17112](https://github.com/ClickHouse/ClickHouse/issues/17112). [#23919](https://github.com/ClickHouse/ClickHouse/pull/23919) ([flynn](https://github.com/ucasFL)).
* Измеряйте долю найденных значений (процент ключей, для которых значение было найдено) для словарей (см. `found_rate` в `system.dictionaries`). [#23916](https://github.com/ClickHouse/ClickHouse/pull/23916) ([Azat Khuzhin](https://github.com/azat)).
* Разрешить добавление отдельных настроек очереди через настройку таблицы `rabbitmq_queue_settings_list`. (Закрывает [#23737](https://github.com/ClickHouse/ClickHouse/issues/23737) и [#23918](https://github.com/ClickHouse/ClickHouse/issues/23918)). Разрешить пользователю управлять всей конфигурацией RabbitMQ: если настройка таблицы `rabbitmq_queue_consume` установлена в `1`, движок таблицы RabbitMQ будет подключаться только к указанной очереди и не будет выполнять никакую настройку на стороне потребителя RabbitMQ, такую как объявление обменников, очередей и привязок. (Закрывает [#21757](https://github.com/ClickHouse/ClickHouse/issues/21757)). Добавить корректную очистку при удалении таблицы RabbitMQ — удалять очереди, которые были объявлены таблицей, и все привязанные обменники, если они были созданы таблицей. [#23887](https://github.com/ClickHouse/ClickHouse/pull/23887) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлены `broken_data_files`/`broken_data_compressed_bytes` в `system.distribution_queue`. Добавлена метрика для числа файлов асинхронной вставки в таблицы типа Distributed, помеченных как повреждённые (`BrokenDistributedFilesToInsert`). [#23885](https://github.com/ClickHouse/ClickHouse/pull/23885) ([Azat Khuzhin](https://github.com/azat)).
* Выполнение запроса к `system.tables` больше не требует обращения к ZooKeeper. [#23793](https://github.com/ClickHouse/ClickHouse/pull/23793) ([Fuwang Hu](https://github.com/fuwhu)).
* Теперь параметр `lock_acquire_timeout_for_background_operations` учитывается для запросов `OPTIMIZE`. [#23623](https://github.com/ClickHouse/ClickHouse/pull/23623) ([Azat Khuzhin](https://github.com/azat)).
* Возможность изменять настройки диска `S3` во время работы с помощью новой SQL-команды `SYSTEM RESTART DISK`. [#23429](https://github.com/ClickHouse/ClickHouse/pull/23429) ([Pavel Kovalenko](https://github.com/Jokser)).
* Если пользователь допустил ошибочную конфигурацию, по ошибке установив `max_distributed_connections` в значение ноль, каждый запрос к таблице `Distributed` будет приводить к исключению с сообщением, содержащим &quot;logical error&quot;. Но на самом деле это ожидаемое поведение, а не логическая ошибка, так что текст сообщения об исключении был немного некорректным. Это также запускало проверки в нашей CI-среде, призванные гарантировать отсутствие логических ошибок. Вместо этого мы будем рассматривать `max_distributed_connections`, ошибочно настроенный в ноль, как минимально возможное значение (один). [#23348](https://github.com/ClickHouse/ClickHouse/pull/23348) ([Azat Khuzhin](https://github.com/azat)).
* По умолчанию параметр `min_bytes_to_use_mmap_io` отключён. [#23322](https://github.com/ClickHouse/ClickHouse/pull/23322) ([Azat Khuzhin](https://github.com/azat)).
* Реализована поддержка NULL-значений (`nullability`) для `LowCardinality` при использовании `join_use_nulls`, закрыт [#15101](https://github.com/ClickHouse/ClickHouse/issues/15101). [#23237](https://github.com/ClickHouse/ClickHouse/pull/23237) ([vdimir](https://github.com/vdimir)).
* Добавлена возможность восстанавливать части таблиц `MergeTree` в каталог `detached` для диска `S3`. [#23112](https://github.com/ClickHouse/ClickHouse/pull/23112) ([Pavel Kovalenko](https://github.com/Jokser)).
* Повторные попытки при обрыве HTTP-соединения с S3. [#22988](https://github.com/ClickHouse/ClickHouse/pull/22988) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Добавлены настройки `external_storage_max_read_rows` и `external_storage_max_read_rows` для движка таблиц MySQL, источника словаря и выборки небольших объемов данных в MaterializeMySQL. [#22697](https://github.com/ClickHouse/ClickHouse/pull/22697) ([TCeason](https://github.com/TCeason)).
* `MaterializeMySQL` (экспериментальная функция): ранее MySQL 5.7.9 не поддерживался из‑за несовместимости SQL. Теперь проверка параметров MySQL делегирована MaterializeMySQL. [#23413](https://github.com/ClickHouse/ClickHouse/pull/23413) ([TCeason](https://github.com/TCeason)).
* Добавлена поддержка чтения подстолбцов для распределённых таблиц. [#24472](https://github.com/ClickHouse/ClickHouse/pull/24472) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено использование кортежей в запросах `CREATE .. AS SELECT`. [#24464](https://github.com/ClickHouse/ClickHouse/pull/24464) ([Anton Popov](https://github.com/CurtizJ)).
* Поддержка формата `Parquet` в таблицах `Kafka`. [#23412](https://github.com/ClickHouse/ClickHouse/pull/23412) ([Chao Ma](https://github.com/godliness)).

#### Исправление ошибки {#bug-fix-4}

* Используйте старую версию функции вычисления остатка (`modulo`) при её использовании в ключе партиционирования и первичном ключе. Закрывает [#23508](https://github.com/ClickHouse/ClickHouse/issues/23508). [#24157](https://github.com/ClickHouse/ClickHouse/pull/24157) ([Kseniia Sumarokova](https://github.com/kssenii)). Это было причиной обратной несовместимости в предыдущих релизах.
* Исправлено поведение, при котором запрос `SYSTEM RESTART REPLICA` или `SYSTEM SYNC REPLICA` обрабатывался бесконечно долго и не завершался. Это наблюдалось на сервере с крайне малым объёмом оперативной памяти. [#24457](https://github.com/ClickHouse/ClickHouse/pull/24457) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена некорректная монотонность функции `toWeek`. Это исправляет [#24422](https://github.com/ClickHouse/ClickHouse/issues/24422). Эта ошибка была допущена в [#5212](https://github.com/ClickHouse/ClickHouse/pull/5212) и позднее проявилась из‑за более интеллектуального механизма отсечения партиций. [#24446](https://github.com/ClickHouse/ClickHouse/pull/24446) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка удаления раздела с пересекающимися фиктивными частями. В редких случаях могли появляться части с версией мутации больше текущего номера блока. [#24321](https://github.com/ClickHouse/ClickHouse/pull/24321) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка при перемещении материализованного представления из базы данных Ordinary в Atomic с помощью запроса `RENAME TABLE`. Теперь внутренняя таблица также перемещается в новую базу данных вместе с материализованным представлением. Исправлено [#23926](https://github.com/ClickHouse/ClickHouse/issues/23926). [#24309](https://github.com/ClickHouse/ClickHouse/pull/24309) ([tavplubix](https://github.com/tavplubix)).
* Разрешены пустые HTTP-заголовки в клиентских запросах. Исправляет [#23901](https://github.com/ClickHouse/ClickHouse/issues/23901). [#24285](https://github.com/ClickHouse/ClickHouse/pull/24285) ([Ivan](https://github.com/abyss7)).
* Установите `max_threads = 1`, чтобы исправить ошибку мутаций таблиц `Memory`. Закрывает [#24274](https://github.com/ClickHouse/ClickHouse/issues/24274). [#24275](https://github.com/ClickHouse/ClickHouse/pull/24275) ([flynn](https://github.com/ucasFL)).
* Исправлена опечатка в реализации таблиц `Memory`, эта ошибка появилась в [#15127](https://github.com/ClickHouse/ClickHouse/issues/15127). Закрывает [#24192](https://github.com/ClickHouse/ClickHouse/issues/24192). [#24193](https://github.com/ClickHouse/ClickHouse/pull/24193) ([张中南](https://github.com/plugine)).
* Исправлено некорректное завершение работы сервера из‑за недоступности `HDFS` во время выполнения запроса. Закрывает [#24117](https://github.com/ClickHouse/ClickHouse/issues/24117). [#24191](https://github.com/ClickHouse/ClickHouse/pull/24191) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен сбой при обновлении столбца `Nested` с константным условием. [#24183](https://github.com/ClickHouse/ClickHouse/pull/24183) ([hexiaoting](https://github.com/hexiaoting)).
* Исправлено состояние гонки, которое могло возникать в RBAC при большой нагрузке. Этот PR исправляет [#24090](https://github.com/ClickHouse/ClickHouse/issues/24090), [#24134](https://github.com/ClickHouse/ClickHouse/issues/24134), [#24176](https://github.com/ClickHouse/ClickHouse/pull/24176) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена редкая ошибка, из‑за которой могла появляться частично инициализированная таблица, способная обрабатывать запросы на запись (insert/alter/и т. д.). Теперь такие таблицы будут в режиме только для чтения. [#24122](https://github.com/ClickHouse/ClickHouse/pull/24122) ([alesapin](https://github.com/alesapin)).
* Исправлена проблема, из-за которой `EXPLAIN PIPELINE` с `SELECT xxx FINAL` показывал неверный конвейер. ([hexiaoting](https://github.com/hexiaoting)).
* Исправлено использование константного (`const`) значения типа `DateTime` вместо столбца типа `DateTime64` в `WHERE`. [#24100](https://github.com/ClickHouse/ClickHouse/pull/24100) ([Vasily Nemkov](https://github.com/Enmk)).
* Исправлен сбой в операции merge JOIN, закрывает [#24010](https://github.com/ClickHouse/ClickHouse/issues/24010). [#24013](https://github.com/ClickHouse/ClickHouse/pull/24013) ([vdimir](https://github.com/vdimir)).
* Некоторые запросы `ALTER PARTITION` могли вызывать ошибки `Part A intersects previous part B` и `Unexpected merged part C intersecting drop range D` в очереди репликации. Проблема исправлена. Исправляет [#23296](https://github.com/ClickHouse/ClickHouse/issues/23296). [#23997](https://github.com/ClickHouse/ClickHouse/pull/23997) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка SIGSEGV при использовании внешнего GROUP BY и строки переполнения (т. е. для запросов вида `SELECT FROM GROUP BY WITH TOTALS SETTINGS max_bytes_before_external_group_by>0, max_rows_to_group_by>0, group_by_overflow_mode='any', totals_mode='before_having'`). [#23962](https://github.com/ClickHouse/ClickHouse/pull/23962) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен учет метрик ключей словаря `CACHE` при наличии дубликатов в источнике (что приводило к переполнению `DictCacheKeysRequestedMiss`). [#23929](https://github.com/ClickHouse/ClickHouse/pull/23929) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена реализация пула соединений движка `PostgreSQL`. Закрывает [#23897](https://github.com/ClickHouse/ClickHouse/issues/23897). [#23909](https://github.com/ClickHouse/ClickHouse/pull/23909) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено поведение настройки `distributed_group_by_no_merge = 2` с `GROUP BY` и агрегатной функцией, заключённой в обычную функцию (было сломано в [#23546](https://github.com/ClickHouse/ClickHouse/issues/23546)). Выбрасывается исключение при попытке использовать `distributed_group_by_no_merge = 2` с оконными функциями. Отключён `optimize_distributed_group_by_sharding_key` для запросов с оконными функциями. [#23906](https://github.com/ClickHouse/ClickHouse/pull/23906) ([Azat Khuzhin](https://github.com/azat)).
* Исправление для табличной функции `s3`: улучшена обработка HTTP‑ошибок. Тела ответов HTTP‑ошибок раньше игнорировались. [#23844](https://github.com/ClickHouse/ClickHouse/pull/23844) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Исправление для табличной функции `s3`: улучшена обработка URI. Устранена проблема совместимости с URL-адресами, содержащими символ `+`: данные с такими ключами ранее не удавалось прочитать. [#23822](https://github.com/ClickHouse/ClickHouse/pull/23822) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Исправлена ошибка `Can't initialize pipeline with empty pipe` для запросов с `GLOBAL IN/JOIN` и `use_hedged_requests`. Это исправление закрывает [#23431](https://github.com/ClickHouse/ClickHouse/issues/23431). [#23805](https://github.com/ClickHouse/ClickHouse/pull/23805) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена проблема: `CLEAR COLUMN` не работал, когда на него ссылалось материализованное представление. Закрыта [#23764](https://github.com/ClickHouse/ClickHouse/issues/23764). [#23781](https://github.com/ClickHouse/ClickHouse/pull/23781) ([flynn](https://github.com/ucasFL)).
* Исправлена ошибка использования памяти после её освобождения (heap use-after-free) при чтении из HDFS при использовании формата `Values`. [#23761](https://github.com/ClickHouse/ClickHouse/pull/23761) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Избежать возможной ошибки «Cannot schedule a task» (в случае возникновения исключения) при выполнении INSERT в таблицу Distributed. [#23744](https://github.com/ClickHouse/ClickHouse/pull/23744) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка при восстановлении отставшей реплики `ReplicatedMergeTree`. Некоторые обновления метаданных могли быть проигнорированы такой репликой, если запрос `ALTER` выполнялся во время её простоя. [#23742](https://github.com/ClickHouse/ClickHouse/pull/23742) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка в работе `Join` с `WITH TOTALS`, закрыт [#17718](https://github.com/ClickHouse/ClickHouse/issues/17718). [#23549](https://github.com/ClickHouse/ClickHouse/pull/23549) ([vdimir](https://github.com/vdimir)).
* Исправлена потенциальная ошибка `Block structure mismatch` для запросов с `UNION`, которая могла возникнуть после оптимизации filter-pushdown. Исправляет [#23029](https://github.com/ClickHouse/ClickHouse/issues/23029). [#23359](https://github.com/ClickHouse/ClickHouse/pull/23359) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлено приведение типов при включённой настройке `optimize_skip_unused_shards_rewrite_in`. Исправляет отчёт MSan. [#23219](https://github.com/ClickHouse/ClickHouse/pull/23219) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена недостающая проверка при обновлении вложенных подстолбцов, закрыта задача: [#22353](https://github.com/ClickHouse/ClickHouse/issues/22353). [#22503](https://github.com/ClickHouse/ClickHouse/pull/22503) ([hexiaoting](https://github.com/hexiaoting)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-5}

* Добавлена поддержка сборки на Illumos. [#24144](https://github.com/ClickHouse/ClickHouse/pull/24144). Добавлена поддержка сборки на операционных системах, основанных на Solaris. [#23746](https://github.com/ClickHouse/ClickHouse/pull/23746) ([bnaecker](https://github.com/bnaecker)).
* Добавлены дополнительные бенчмарки для хеш-таблиц, включая Swiss Table от Google (которая оказалась медленнее хеш-таблицы ClickHouse в нашем конкретном сценарии использования). [#24111](https://github.com/ClickHouse/ClickHouse/pull/24111) ([Maksim Kita](https://github.com/kitaisreal)).
* Обновлена librdkafka с 1.6.0-RC3 до 1.6.1. [#23874](https://github.com/ClickHouse/ClickHouse/pull/23874) ([filimonov](https://github.com/filimonov)).
* Всегда явно включён параметр `asynchronous-unwind-tables`. Это может исправить профилировщик запросов на AArch64. [#23602](https://github.com/ClickHouse/ClickHouse/pull/23602) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Устранена возможная зависимость сборки от локали и порядка в файловой системе. Это позволяет получать воспроизводимые сборки. [#23600](https://github.com/ClickHouse/ClickHouse/pull/23600) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Удалён источник недетерминизма при сборке. Теперь сборки, выполненные в разное время, будут давать байтово идентичные бинарные файлы. Частично решает [#22113](https://github.com/ClickHouse/ClickHouse/issues/22113). [#23559](https://github.com/ClickHouse/ClickHouse/pull/23559) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлен простой инструмент для бенчмаркинга (Zoo)Keeper. [#23038](https://github.com/ClickHouse/ClickHouse/pull/23038) ([alesapin](https://github.com/alesapin)).

## Релиз ClickHouse 21.5, 2021-05-20 {#clickhouse-release-215-2021-05-20}

#### Обратно несовместимое изменение {#backward-incompatible-change-6}

* Изменено сравнение целых чисел и чисел с плавающей запятой, когда целое число не может быть точно представлено в типе с плавающей запятой. В новой версии операция сравнения будет возвращать `false`, поскольку при этом возникает ошибка округления. Пример: `9223372036854775808.0 != 9223372036854775808`, потому что число `9223372036854775808` не может быть точно представлено в виде числа с плавающей запятой (и `9223372036854775808.0` округляется до `9223372036854776000.0`). Но в предыдущей версии сравнение возвращало, что числа равны, потому что при преобразовании числа с плавающей запятой `9223372036854776000.0` обратно в UInt64 получается `9223372036854775808`. Для справки: язык программирования Python также считает эти числа равными. Но это поведение зависело от модели CPU (разные результаты на AMD64 и AArch64 для некоторых чисел вне диапазона), поэтому мы сделали сравнение более точным. Целые и вещественные числа будут считаться равными только если целое число может быть представлено в типе с плавающей запятой точно. [#22595](https://github.com/ClickHouse/ClickHouse/pull/22595) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Удалена поддержка `argMin` и `argMax` для единственного аргумента типа `Tuple`. Код не был безопасен с точки зрения управления памятью. Возможность была добавлена по ошибке и сбивала людей с толку. Эти функции могут быть повторно введены под другими именами позднее. Это исправляет [#22384](https://github.com/ClickHouse/ClickHouse/issues/22384) и откатывает [#17359](https://github.com/ClickHouse/ClickHouse/issues/17359). [#23393](https://github.com/ClickHouse/ClickHouse/pull/23393) ([alexey-milovidov](https://github.com/alexey-milovidov)).

#### Новая функциональность {#new-feature-6}

* Добавлены функции `dictGetChildren(dictionary, key)`, `dictGetDescendants(dictionary, key, level)`. Функция `dictGetChildren` возвращает всех прямых потомков в виде массива индексов. Это обратное преобразование для `dictGetHierarchy`. Функция `dictGetDescendants` возвращает всех потомков так, как если бы `dictGetChildren` была применена рекурсивно `level` раз. Нулевое значение параметра `level` эквивалентно бесконечности. Улучшена производительность функций `dictGetHierarchy`, `dictIsIn`. Закрывает [#14656](https://github.com/ClickHouse/ClickHouse/issues/14656). [#22096](https://github.com/ClickHouse/ClickHouse/pull/22096) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена функция `dictGetOrNull`. Работает как `dictGet`, но возвращает `Null`, если ключ не найден в словаре. Закрывает [#22375](https://github.com/ClickHouse/ClickHouse/issues/22375). [#22413](https://github.com/ClickHouse/ClickHouse/pull/22413) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена табличная функция `s3Cluster`, которая позволяет обрабатывать файлы из `s3` параллельно на каждом узле заданного кластера. [#22012](https://github.com/ClickHouse/ClickHouse/pull/22012) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлена поддержка реплик и шардов в движке таблиц / табличной функции MySQL/PostgreSQL. Вы можете написать `SELECT * FROM mysql('host{1,2}-{1|2}', ...)`. Закрывает [#20969](https://github.com/ClickHouse/ClickHouse/issues/20969). [#22217](https://github.com/ClickHouse/ClickHouse/pull/22217) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлен запрос `ALTER TABLE ... FETCH PART ...`. Аналогичен `FETCH PARTITION`, но загружает только одну часть. [#22706](https://github.com/ClickHouse/ClickHouse/pull/22706) ([turbo jason](https://github.com/songenjie)).
* Добавлена настройка `max_distributed_depth`, которая ограничивает глубину рекурсивных запросов к таблицам `Distributed`. Закрывает [#20229](https://github.com/ClickHouse/ClickHouse/issues/20229). [#21942](https://github.com/ClickHouse/ClickHouse/pull/21942) ([flynn](https://github.com/ucasFL)).

#### Повышение производительности {#performance-improvement-6}

* Повышена производительность `intDiv` за счёт динамической диспетчеризации для AVX2. Это закрывает [#22314](https://github.com/ClickHouse/ClickHouse/issues/22314). [#23000](https://github.com/ClickHouse/ClickHouse/pull/23000) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Повышена производительность чтения из входного формата `ArrowStream` для источников, отличных от локального файла (например, URL). [#22673](https://github.com/ClickHouse/ClickHouse/pull/22673) ([nvartolomei](https://github.com/nvartolomei)).
* Отключено сжатие по умолчанию при работе с localhost (через clickhouse-client или между серверами при распределённых запросах) по нативному протоколу. Это может улучшить производительность некоторых операций импорта/экспорта. Это закрывает [#22234](https://github.com/ClickHouse/ClickHouse/issues/22234). [#22237](https://github.com/ClickHouse/ClickHouse/pull/22237) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исключены значения, не принадлежащие сегменту, из правой части условия IN для распределённых запросов (при включённом `optimize_skip_unused_shards_rewrite_in`, он включён по умолчанию, так как по-прежнему требует `optimize_skip_unused_shards`). [#21511](https://github.com/ClickHouse/ClickHouse/pull/21511) ([Azat Khuzhin](https://github.com/azat)).
* Повышена производительность чтения подмножества столбцов с движком таблиц семейства File и столбцовыми форматами, такими как Parquet, Arrow или ORC. Это закрывает [#issue:20129](https://github.com/ClickHouse/ClickHouse/issues/20129). [#21302](https://github.com/ClickHouse/ClickHouse/pull/21302) ([keenwolf](https://github.com/keen-wolf)).
* Разрешено переносить больше условий в `PREWHERE`, как это было до версии 21.1 (корректировка внутренних эвристик). Недостаточное количество перенесённых условий могло приводить к ухудшению производительности. [#23397](https://github.com/ClickHouse/ClickHouse/pull/23397) ([Anton Popov](https://github.com/CurtizJ)).
* Повышена производительность ODBC-подключений и исправлены все накопившиеся в бэклоге проблемы. Вместо библиотеки `Poco::ODBC` используется библиотека `nanodbc`. Закрывает [#9678](https://github.com/ClickHouse/ClickHouse/issues/9678). Добавлена поддержка DateTime64 и Decimal* для движка таблиц ODBC. Закрывает [#21961](https://github.com/ClickHouse/ClickHouse/issues/21961). Исправлена проблема с обрезанием текста на кириллице. Закрывает [#16246](https://github.com/ClickHouse/ClickHouse/issues/16246). Добавлены пулы подключений для ODBC bridge. [#21972](https://github.com/ClickHouse/ClickHouse/pull/21972) ([Kseniia Sumarokova](https://github.com/kssenii)).

#### Улучшения {#improvement-6}

* По умолчанию значение `max_uri_size` (максимального размера URL в HTTP-интерфейсе) увеличено до 1 МиБ. Это закрывает задачу [#21197](https://github.com/ClickHouse/ClickHouse/issues/21197). [#22997](https://github.com/ClickHouse/ClickHouse/pull/22997) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Установите `background_fetches_pool_size` в значение `8`, что лучше подходит для продакшн-сред с частыми небольшими вставками данных или медленным кластером ZooKeeper. [#22945](https://github.com/ClickHouse/ClickHouse/pull/22945) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* В FlatDictionary добавлены параметры `initial_array_size`, `max_array_size`. [#22521](https://github.com/ClickHouse/ClickHouse/pull/22521) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена новая настройка `non_replicated_deduplication_window` для дедупликации вставок в нереплицируемые таблицы MergeTree. [#22514](https://github.com/ClickHouse/ClickHouse/pull/22514) ([alesapin](https://github.com/alesapin)).
* Обновлены пути к конфигам модели `CatBoost` при перезагрузке конфигурации. [#22434](https://github.com/ClickHouse/ClickHouse/pull/22434) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка типа `Decimal256` в словарях. `Decimal256` — экспериментальная возможность. Закрывает [#20979](https://github.com/ClickHouse/ClickHouse/issues/20979). [#22960](https://github.com/ClickHouse/ClickHouse/pull/22960) ([Maksim Kita](https://github.com/kitaisreal)).
* По умолчанию включён `async_socket_for_remote` (для распределённых запросов требуется меньше потоков ОС). [#23683](https://github.com/ClickHouse/ClickHouse/pull/23683) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен `quantile(s)TDigest`. Добавлена специальная обработка одиночных центроидов в соответствии с tdunning/t-digest 3.2+. Также исправлена ошибка с чрезмерным сжатием центроидов в реализации более ранней версии алгоритма. [#23314](https://github.com/ClickHouse/ClickHouse/pull/23314) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Имя функции `unhex` сделано регистронезависимым для совместимости с MySQL. [#23229](https://github.com/ClickHouse/ClickHouse/pull/23229) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Реализованы функции `arrayHasAny`, `arrayHasAll`, `has`, `indexOf`, `countEqual` для общего случая, когда типы элементов массива различаются. В предыдущих версиях функции `arrayHasAny`, `arrayHasAll` возвращали значение false, а `has`, `indexOf`, `countEqual` выбрасывали исключение. Также добавлена поддержка типов `Decimal` и больших целых чисел в функциях `has` и аналогичных им. Это закрывает [#20272](https://github.com/ClickHouse/ClickHouse/issues/20272). [#23044](https://github.com/ClickHouse/ClickHouse/pull/23044) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Увеличен лимит на максимальное число совпадений в результате функции `extractAllGroupsHorizontal`. [#23036](https://github.com/ClickHouse/ClickHouse/pull/23036) ([Vasily Nemkov](https://github.com/Enmk)).
* Не выполняйте `optimize_skip_unused_shards` для кластера с одним узлом. [#22999](https://github.com/ClickHouse/ClickHouse/pull/22999) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка запуска clickhouse-keeper (экспериментальной замены ZooKeeper, совместимой по интерфейсу) с SSL. Параметр конфигурации `keeper_server.tcp_port_secure` можно использовать для безопасного взаимодействия между клиентом и keeper-сервером. Параметр `keeper_server.raft_configuration.secure` можно использовать для включения внутреннего защищённого взаимодействия между узлами. [#22992](https://github.com/ClickHouse/ClickHouse/pull/22992) ([alesapin](https://github.com/alesapin)).
* Добавлена возможность сбрасывать буфер только в фоновом режиме для таблиц `Buffer`. [#22986](https://github.com/ClickHouse/ClickHouse/pull/22986) ([Azat Khuzhin](https://github.com/azat)).
* При выполнении выборки из таблицы MergeTree с NULL в условии WHERE в редких случаях генерировалось исключение. Это закрывает [#20019](https://github.com/ClickHouse/ClickHouse/issues/20019). [#22978](https://github.com/ClickHouse/ClickHouse/pull/22978) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена обработка ошибок в Poco HTTP Client для AWS. [#22973](https://github.com/ClickHouse/ClickHouse/pull/22973) ([kreuzerkrieg](https://github.com/kreuzerkrieg)).
* Теперь учитывается `max_part_removal_threads` для `ReplicatedMergeTree`. [#22971](https://github.com/ClickHouse/ClickHouse/pull/22971) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен неочевидный граничный случай в настройках MergeTree при inactive&#95;parts&#95;to&#95;throw&#95;insert = 0 совместно с inactive&#95;parts&#95;to&#95;delay&#95;insert &gt; 0. [#22947](https://github.com/ClickHouse/ClickHouse/pull/22947) ([Azat Khuzhin](https://github.com/azat)).
* `dateDiff` теперь работает с аргументами `DateTime64` (даже для значений, выходящих за пределы диапазона `DateTime`) [#22931](https://github.com/ClickHouse/ClickHouse/pull/22931) ([Vasily Nemkov](https://github.com/Enmk)).
* MaterializeMySQL (экспериментальная функция): добавлена возможность реплицировать базы данных MySQL, содержащие представления, не приводя к ошибкам. Это достигается за счёт игнорирования представлений. [#22760](https://github.com/ClickHouse/ClickHouse/pull/22760) ([Christian](https://github.com/cfroystad)).
* Разрешено использование строковых политик RBAC через протокол PostgreSQL. Закрывает [#22658](https://github.com/ClickHouse/ClickHouse/issues/22658). Протокол PostgreSQL по умолчанию включён в конфигурации. [#22755](https://github.com/ClickHouse/ClickHouse/pull/22755) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена метрика для отслеживания того, сколько времени уходит на ожидание блокировки буферного слоя. [#22725](https://github.com/ClickHouse/ClickHouse/pull/22725) ([Azat Khuzhin](https://github.com/azat)).
* Разрешено использование CTE в определениях VIEW. Это закрывает [#22491](https://github.com/ClickHouse/ClickHouse/issues/22491). [#22657](https://github.com/ClickHouse/ClickHouse/pull/22657) ([Amos Bird](https://github.com/amosbird)).
* Очищать оставшуюся часть экрана и показывать курсор в `clickhouse-client`, если предыдущая программа оставила в терминале мусор. Исправляет [#16518](https://github.com/ClickHouse/ClickHouse/issues/16518). [#22634](https://github.com/ClickHouse/ClickHouse/pull/22634) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Функция `round` теперь ведет себя одинаково на платформах, отличных от x86&#95;64. Используется округление половин до ближайшего четного (банковское округление). [#22582](https://github.com/ClickHouse/ClickHouse/pull/22582) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Корректно проверять структуру блоков данных, отправляемых распределёнными таблицами. [#22325](https://github.com/ClickHouse/ClickHouse/pull/22325) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена возможность публиковать ошибки Kafka в виртуальный столбец движка Kafka, поведение которой контролируется настройкой `kafka_handle_error_mode`. [#21850](https://github.com/ClickHouse/ClickHouse/pull/21850) ([fastio](https://github.com/fastio)).
* Добавлены псевдонимы `simpleJSONExtract/simpleJSONHas` для `visitParam/visitParamExtract{UInt, Int, Bool, Float, Raw, String}`. Исправляет [#21383](https://github.com/ClickHouse/ClickHouse/issues/21383). [#21519](https://github.com/ClickHouse/ClickHouse/pull/21519) ([fastio](https://github.com/fastio)).
* Добавлен `clickhouse-library-bridge` для источника словаря library. Закрывает [#9502](https://github.com/ClickHouse/ClickHouse/issues/9502). [#21509](https://github.com/ClickHouse/ClickHouse/pull/21509) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Запретить удаление столбца, если он используется в материализованном представлении. Закрывает [#21164](https://github.com/ClickHouse/ClickHouse/issues/21164). [#21303](https://github.com/ClickHouse/ClickHouse/pull/21303) ([flynn](https://github.com/ucasFL)).
* Добавлена поддержка динамических межсерверных учетных данных (их ротация без простоя). [#14113](https://github.com/ClickHouse/ClickHouse/pull/14113) ([johnskopis](https://github.com/johnskopis)).
* Добавлена поддержка хранения в Kafka с сообщениями в форматах `Arrow` и `ArrowStream`. [#23415](https://github.com/ClickHouse/ClickHouse/pull/23415) ([Chao Ma](https://github.com/godliness)).
* Исправлена отсутствующая точка с запятой в сообщении об исключении. Пользователю может быть неприятно читать это сообщение. [#23208](https://github.com/ClickHouse/ClickHouse/pull/23208) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены пропущенные пробелы в некоторых сообщениях об исключениях, связанных с типом `LowCardinality`. [#23207](https://github.com/ClickHouse/ClickHouse/pull/23207) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Ранее некоторые значения в ячейках таблиц в формате `Markdown` выравнивались по центру. Теперь этого нет. [#23096](https://github.com/ClickHouse/ClickHouse/pull/23096) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Удалены несущественные детали из подсказок в clickhouse-client. Закрывает [#22158](https://github.com/ClickHouse/ClickHouse/issues/22158). [#23040](https://github.com/ClickHouse/ClickHouse/pull/23040) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен расчёт поля `bytes_allocated` в system.dictionaries для sparse&#95;hashed словарей. [#22867](https://github.com/ClickHouse/ClickHouse/pull/22867) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен приблизительный подсчёт общего числа строк с учётом обратного чтения из MergeTree. [#22726](https://github.com/ClickHouse/ClickHouse/pull/22726) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен случай, когда можно было сконфигурировать словарь с источником ClickHouse, ссылающимся на себя, что приводило к бесконечному циклу. Закрывает [#14314](https://github.com/ClickHouse/ClickHouse/issues/14314). [#22479](https://github.com/ClickHouse/ClickHouse/pull/22479) ([Maksim Kita](https://github.com/kitaisreal)).

#### Исправление ошибки {#bug-fix-5}

* Несколько исправлений для подстрахованных (hedged) запросов. Исправлена ошибка `Can't initialize pipeline with empty pipe` для запросов с `GLOBAL IN/JOIN`, когда включена настройка `use_hedged_requests`. Исправляет [#23431](https://github.com/ClickHouse/ClickHouse/issues/23431). [#23805](https://github.com/ClickHouse/ClickHouse/pull/23805) ([Nikolai Kochetov](https://github.com/KochetovNicolai)). Исправлена гонка состояний в подстрахованных подключениях, приводившая к сбою. Исправляет [#22161](https://github.com/ClickHouse/ClickHouse/issues/22161). [#22443](https://github.com/ClickHouse/ClickHouse/pull/22443) ([Kruglov Pavel](https://github.com/Avogar)). Исправлен возможный сбой в случае, если от удалённого запроса был получен `unknown packet` (при включённом `async_socket_for_remote`). Исправляет [#21167](https://github.com/ClickHouse/ClickHouse/issues/21167). [#23309](https://github.com/ClickHouse/ClickHouse/pull/23309) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, из-за которой при отключении настройки `input_format_with_names_use_header` все входные данные в формате CSVWithNames отбрасывались. Это исправляет [#22406](https://github.com/ClickHouse/ClickHouse/issues/22406). [#23202](https://github.com/ClickHouse/ClickHouse/pull/23202) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена проблема с тайм-аутом соединения через удалённый JDBC bridge. Закрывает [#9609](https://github.com/ClickHouse/ClickHouse/issues/9609). [#23771](https://github.com/ClickHouse/ClickHouse/pull/23771) ([Maksim Kita](https://github.com/kitaisreal), [alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена логика начальной загрузки `complex_key_hashed`, если указан `update_field`. Закрывает [#23800](https://github.com/ClickHouse/ClickHouse/issues/23800). [#23824](https://github.com/ClickHouse/ClickHouse/pull/23824) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлен сбой, возникавший при одновременном применении `PREWHERE` и фильтра политики строк при пустом результате выборки. [#23763](https://github.com/ClickHouse/ClickHouse/pull/23763) ([Amos Bird](https://github.com/amosbird)).
* Исправлена возможная ошибка &quot;Cannot schedule a task&quot; (которая могла возникать при исключении) при выполнении INSERT в таблицу Distributed. [#23744](https://github.com/ClickHouse/ClickHouse/pull/23744) ([Azat Khuzhin](https://github.com/azat)).
* Добавлено исключение на случай полностью совпадающих значений в обеих выборках в агрегатной функции `mannWhitneyUTest`. Это исправляет [#23646](https://github.com/ClickHouse/ClickHouse/issues/23646). [#23654](https://github.com/ClickHouse/ClickHouse/pull/23654) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена ошибка сервера при вставке данных по HTTP, приводившая к возникновению исключения. Исправляет [#23512](https://github.com/ClickHouse/ClickHouse/issues/23512). [#23643](https://github.com/ClickHouse/ClickHouse/pull/23643) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена неверная интерпретация некоторых выражений `LIKE` с последовательностями экранирования. [#23610](https://github.com/ClickHouse/ClickHouse/pull/23610) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено зависание команды перезапуска/остановки. Закрывает [#20214](https://github.com/ClickHouse/ClickHouse/issues/20214). [#23552](https://github.com/ClickHouse/ClickHouse/pull/23552) ([filimonov](https://github.com/filimonov)).
* Исправлена работа сопоставителя `COLUMNS` для запросов SELECT с несколькими операциями JOIN. Закрывает [#22736](https://github.com/ClickHouse/ClickHouse/issues/22736). [#23501](https://github.com/ClickHouse/ClickHouse/pull/23501) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлен сбой при изменении значения по умолчанию у столбца, когда сам столбец используется как параметр `ReplacingMergeTree`. [#23483](https://github.com/ClickHouse/ClickHouse/pull/23483) ([hexiaoting](https://github.com/hexiaoting)).
* Исправлены краевые случаи при вертикальных слияниях с `ReplacingMergeTree`. В редких случаях они могли приводить к сбоям слияний с исключениями вида `Incomplete granules are not allowed while blocks are granules size`. [#23459](https://github.com/ClickHouse/ClickHouse/pull/23459) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка, из-за которой было невозможно привести пустой литерал массива к массиву с размерностью больше 1, например `CAST([] AS Array(Array(String)))`. Закрывает [#14476](https://github.com/ClickHouse/ClickHouse/issues/14476). [#23456](https://github.com/ClickHouse/ClickHouse/pull/23456) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена ошибка, из‑за которой агрегатная функция `deltaSum` возвращала некорректный результат после сброса счётчика. [#23437](https://github.com/ClickHouse/ClickHouse/pull/23437) ([Russ Frank](https://github.com/rf)).
* Исправлена ошибка `Cannot unlink file`, возникавшая при неудачном создании таблицы ReplicatedMergeTree с многодисковой конфигурацией. Это закрывает [#21755](https://github.com/ClickHouse/ClickHouse/issues/21755). [#23433](https://github.com/ClickHouse/ClickHouse/pull/23433) ([tavplubix](https://github.com/tavplubix)).
* Исправлена проблема генерации несовместимых константных выражений при отсечении партиций на основе виртуальных столбцов. Это исправляет [https://github.com/ClickHouse/ClickHouse/pull/21401#discussion&#95;r611888913](https://github.com/ClickHouse/ClickHouse/pull/21401#discussion_r611888913). [#23366](https://github.com/ClickHouse/ClickHouse/pull/23366) ([Amos Bird](https://github.com/amosbird)).
* Исправлен сбой при установке join&#95;algorithm в значение &#39;auto&#39; и выполнении JOIN с Dictionary. Закрыто [#23002](https://github.com/ClickHouse/ClickHouse/issues/23002). [#23312](https://github.com/ClickHouse/ClickHouse/pull/23312) ([Vladimir](https://github.com/vdimir)).
* Не ослаблять условия NOT при отсечении партиций. Это исправляет [#23305](https://github.com/ClickHouse/ClickHouse/issues/23305) и [#21539](https://github.com/ClickHouse/ClickHouse/issues/21539). [#23310](https://github.com/ClickHouse/ClickHouse/pull/23310) ([Amos Bird](https://github.com/amosbird)).
* Исправлена крайне редкая гонка состояний при фоновом удалении старых блоков. Она могла приводить к тому, что блок не дедуплицировался, если он находился слишком близко к концу окна дедупликации. [#23301](https://github.com/ClickHouse/ClickHouse/pull/23301) ([tavplubix](https://github.com/tavplubix)).
* Исправлено очень редкое (распределённое) состояние гонки между созданием и удалением таблиц ReplicatedMergeTree. Оно могло вызывать исключения с сообщением `node doesn't exist` при попытке создать реплицированную таблицу. Исправляет [#21419](https://github.com/ClickHouse/ClickHouse/issues/21419). [#23294](https://github.com/ClickHouse/ClickHouse/pull/23294) ([tavplubix](https://github.com/tavplubix)).
* Исправлено создание словаря с простым ключом из DDL, если первичный ключ не является первым атрибутом. Исправляет [#23236](https://github.com/ClickHouse/ClickHouse/issues/23236). [#23262](https://github.com/ClickHouse/ClickHouse/pull/23262) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлено чтение из ODBC, если в таблице много длинных имён столбцов. Закрывает [#8853](https://github.com/ClickHouse/ClickHouse/issues/8853). [#23215](https://github.com/ClickHouse/ClickHouse/pull/23215) ([Kseniia Sumarokova](https://github.com/kssenii)).
* MaterializeMySQL (экспериментальная возможность): исправлена ошибка `Not found column` при выполнении запроса к `MaterializeMySQL` с условием по ключевому столбцу. Исправлено [#22432](https://github.com/ClickHouse/ClickHouse/issues/22432). [#23200](https://github.com/ClickHouse/ClickHouse/pull/23200) ([tavplubix](https://github.com/tavplubix)).
* Исправлена обработка алиасов, если подзапрос был оптимизирован до константы. Исправляет [#22924](https://github.com/ClickHouse/ClickHouse/issues/22924). Исправляет [#10401](https://github.com/ClickHouse/ClickHouse/issues/10401). [#23191](https://github.com/ClickHouse/ClickHouse/pull/23191) ([Maksim Kita](https://github.com/kitaisreal)).
* Сервер мог не запуститься, если настройка `data_type_default_nullable` была включена в профиле по умолчанию; теперь это исправлено. Исправлена проблема [#22573](https://github.com/ClickHouse/ClickHouse/issues/22573). [#23185](https://github.com/ClickHouse/ClickHouse/pull/23185) ([tavplubix](https://github.com/tavplubix)).
* Исправлен сбой при завершении работы сервера, происходивший из‑за ошибочного учета активных подключений. [#23154](https://github.com/ClickHouse/ClickHouse/pull/23154) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена ошибка `Table .inner_id... doesn't exist` при выполнении SELECT из материализованного представления после его отсоединения от базы данных Atomic и последующего повторного подключения. [#23047](https://github.com/ClickHouse/ClickHouse/pull/23047) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка `Cannot find column in ActionsDAG result`, которая могла возникать, если в подзапросе используется `untuple`. Исправляет [#22290](https://github.com/ClickHouse/ClickHouse/issues/22290). [#22991](https://github.com/ClickHouse/ClickHouse/pull/22991) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено использование константных столбцов типа `Map` со значениями, допускающими `NULL`. [#22939](https://github.com/ClickHouse/ClickHouse/pull/22939) ([Anton Popov](https://github.com/CurtizJ)).
* исправлена функция `formatDateTime()` для `DateTime64` и спецификатора формата &quot;%C&quot;, а также функция `toDateTime64()` для больших значений и ненулевого масштаба. [#22937](https://github.com/ClickHouse/ClickHouse/pull/22937) ([Vasily Nemkov](https://github.com/Enmk)).
* Исправлено падение при использовании `mannWhitneyUTest` и `rankCorr` с оконными функциями. Это исправляет [#22728](https://github.com/ClickHouse/ClickHouse/issues/22728). [#22876](https://github.com/ClickHouse/ClickHouse/pull/22876) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* LIVE VIEW (экспериментальная функция): исправлено возможное зависание при одновременном выполнении команд DROP/CREATE для TEMPORARY LIVE VIEW в `TemporaryLiveViewCleaner`, [см.](https://gist.github.com/vzakaznikov/0c03195960fc86b56bfe2bc73a90019e). [#22858](https://github.com/ClickHouse/ClickHouse/pull/22858) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено проталкивание `HAVING` в случае, когда фильтрующий столбец используется в агрегатной функции. [#22763](https://github.com/ClickHouse/ClickHouse/pull/22763) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены возможные зависания запросов к ZooKeeper при возникновении исключения OOM. Исправлено [#22438](https://github.com/ClickHouse/ClickHouse/issues/22438). [#22684](https://github.com/ClickHouse/ClickHouse/pull/22684) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен механизм ожидания завершения мутаций на нескольких репликах для движков таблиц ReplicatedMergeTree. Ранее запрос mutation/alter мог завершаться до фактического выполнения мутации на других репликах. [#22669](https://github.com/ClickHouse/ClickHouse/pull/22669) ([alesapin](https://github.com/alesapin)).
* Исправлено исключение для таблиц движка Log с вложенными типами при отсутствии столбцов в предложении SELECT. [#22654](https://github.com/ClickHouse/ClickHouse/pull/22654) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено бесконечное ожидание для вспомогательных запросов к AWS. [#22594](https://github.com/ClickHouse/ClickHouse/pull/22594) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Исправлена ошибка, приводившая к сбою при очень раннем закрытии соединения клиентом [#22579](https://github.com/ClickHouse/ClickHouse/issues/22579). [#22591](https://github.com/ClickHouse/ClickHouse/pull/22591) ([nvartolomei](https://github.com/nvartolomei)).
* Тип данных `Map` (экспериментальная возможность): исправлено неверное форматирование функции `map` в распределённых запросах. [#22588](https://github.com/ClickHouse/ClickHouse/pull/22588) ([foolchi](https://github.com/foolchi)).
* Исправлена десериализация пустой строки без завершающего перевода строки в формате TSV. Это закрывает [#20244](https://github.com/ClickHouse/ClickHouse/issues/20244). Возможный обходной путь без обновления версии: установить `input_format_null_as_default` в значение 0. В старых версиях оно по умолчанию было равно 0. [#22527](https://github.com/ClickHouse/ClickHouse/pull/22527) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено некорректное приведение типа столбца `LowCardinality` в алгоритме Merge Join. Закрывает [#22386](https://github.com/ClickHouse/ClickHouse/issues/22386), [#22388](https://github.com/ClickHouse/ClickHouse/issues/22388). [#22510](https://github.com/ClickHouse/ClickHouse/pull/22510) ([Vladimir](https://github.com/vdimir)).
* Переполнение буфера при чтении могло произойти в полнотекстовом индексе `tokenbf_v1`. Лишние байты не используются, но операция чтения в редких случаях могла приводить к аварийному завершению работы. Это закрывает [#19233](https://github.com/ClickHouse/ClickHouse/issues/19233). [#22421](https://github.com/ClickHouse/ClickHouse/pull/22421) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Не ограничивать размер HTTP-чанков. Исправляет [#21907](https://github.com/ClickHouse/ClickHouse/issues/21907). [#22322](https://github.com/ClickHouse/ClickHouse/pull/22322) ([Ivan](https://github.com/abyss7)).
* Исправлена ошибка, приводившая к недостаточной агрегации данных при включённом `optimize_aggregation_in_order` и большом количестве частей в таблице. Незначительно улучшена производительность агрегации при включённом `optimize_aggregation_in_order`. [#21889](https://github.com/ClickHouse/ClickHouse/pull/21889) ([Anton Popov](https://github.com/CurtizJ)).
* Проверка, используется ли представление табличной функции в качестве столбца. Дополнение к #20350. [#21465](https://github.com/ClickHouse/ClickHouse/pull/21465) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка &quot;unknown column&quot; для таблиц с движком `Merge` в запросах с `JOIN` и агрегацией. Закрыты [#18368](https://github.com/ClickHouse/ClickHouse/issues/18368) и [#22226](https://github.com/ClickHouse/ClickHouse/issues/22226). [#21370](https://github.com/ClickHouse/ClickHouse/pull/21370) ([Vladimir](https://github.com/vdimir)).
* Исправлены конфликты имён в оптимизации pushdown. Это приводило к некорректной фильтрации по условию `WHERE` после FULL JOIN. Закрыта [#20497](https://github.com/ClickHouse/ClickHouse/issues/20497). [#20622](https://github.com/ClickHouse/ClickHouse/pull/20622) ([Vladimir](https://github.com/vdimir)).
* Исправлена крайне редкая ошибка, при которой вставка с кворумом (quorum insert) при `quorum_parallel=1` на самом деле не является «кворумом» из‑за дедупликации. [#18215](https://github.com/ClickHouse/ClickHouse/pull/18215) ([filimonov](https://github.com/filimonov) — сообщил о проблеме, [alesapin](https://github.com/alesapin) — исправил).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-6}

* Запускать stateless-тесты в параллельном режиме в CI. [#22300](https://github.com/ClickHouse/ClickHouse/pull/22300) ([alesapin](https://github.com/alesapin)).
* Упростить пакеты Debian. Это исправляет [#21698](https://github.com/ClickHouse/ClickHouse/issues/21698). [#22976](https://github.com/ClickHouse/ClickHouse/pull/22976) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка сборки ClickHouse на Apple M1. [#21639](https://github.com/ClickHouse/ClickHouse/pull/21639) ([changvvb](https://github.com/changvvb)).
* Исправлена сборка ClickHouse Keeper для macOS. [#22860](https://github.com/ClickHouse/ClickHouse/pull/22860) ([alesapin](https://github.com/alesapin)).
* Исправлены некоторые тесты на платформе AArch64. [#22596](https://github.com/ClickHouse/ClickHouse/pull/22596) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлено выравнивание функций для потенциально более высокой производительности. [#21431](https://github.com/ClickHouse/ClickHouse/pull/21431) ([Danila Kutenin](https://github.com/danlark1)).
* Адаптированы некоторые тесты для вывода идентичных результатов на amd64 и aarch64 (qemu). Результат зависел от особенностей реализации поведения CPU. [#22590](https://github.com/ClickHouse/ClickHouse/pull/22590) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Разрешить профилирование запросов только на x86_64. См. [#15174](https://github.com/ClickHouse/ClickHouse/issues/15174#issuecomment-812954965) и [#15638](https://github.com/ClickHouse/ClickHouse/issues/15638#issuecomment-703805337). Это закрывает [#15638](https://github.com/ClickHouse/ClickHouse/issues/15638). [#22580](https://github.com/ClickHouse/ClickHouse/pull/22580) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Разрешить сборку с внешней библиотекой xz (lzma), используя опцию CMake `USE_INTERNAL_XZ_LIBRARY=OFF`. [#22571](https://github.com/ClickHouse/ClickHouse/pull/22571) ([Kfir Itzhak](https://github.com/mastertheknife)).
* Включить встроенный `openldap` на `ppc64le`. [#22487](https://github.com/ClickHouse/ClickHouse/pull/22487) ([Kfir Itzhak](https://github.com/mastertheknife)).
* Отключить несовместимые (обычно платформозависимые) библиотеки на `ppc64le`. [#22475](https://github.com/ClickHouse/ClickHouse/pull/22475) ([Kfir Itzhak](https://github.com/mastertheknife)).
* Добавить тест Jepsen в CI для ClickHouse Keeper. [#22373](https://github.com/ClickHouse/ClickHouse/pull/22373) ([alesapin](https://github.com/alesapin)).
* Собирать `jemalloc` с поддержкой [профилирования кучи (heap profiling)](https://github.com/jemalloc/jemalloc/wiki/Use-Case%3A-Heap-Profiling). [#22834](https://github.com/ClickHouse/ClickHouse/pull/22834) ([nvartolomei](https://github.com/nvartolomei)).
* Исключить неопределённое поведение (UB) в движках `*Log` при разблокировке rwlock из другого потока. [#22583](https://github.com/ClickHouse/ClickHouse/pull/22583) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено неопределённое поведение (UB) за счёт разблокировки rwlock TinyLog из того же потока. [#22560](https://github.com/ClickHouse/ClickHouse/pull/22560) ([Azat Khuzhin](https://github.com/azat)).

## Релиз ClickHouse 21.4 {#clickhouse-release-214}

### Релиз ClickHouse 21.4.1 2021-04-12 {#clickhouse-release-2141-2021-04-12}

#### Изменение, нарушающее обратную совместимость {#backward-incompatible-change-7}

* Функция `toStartOfIntervalFunction` теперь выравнивает часовые интервалы по полуночи (в предыдущих версиях они выравнивались по началу UNIX-эпохи). Например, `toStartOfInterval(x, INTERVAL 11 HOUR)` разобьёт каждый день на три интервала: `00:00:00..10:59:59`, `11:00:00..21:59:59` и `22:00:00..23:59:59`. Такое поведение лучше соответствует практическим потребностям. Это закрывает [#9510](https://github.com/ClickHouse/ClickHouse/issues/9510). [#22060](https://github.com/ClickHouse/ClickHouse/pull/22060) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `Age` и `Precision` в конфигурациях Graphite rollup должны увеличиваться от периода хранения к периоду хранения. Теперь это проверяется, и неправильная конфигурация приводит к выбросу исключения. [#21496](https://github.com/ClickHouse/ClickHouse/pull/21496) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Исправлена ошибка, из-за которой `cutToFirstSignificantSubdomainCustom()`/`firstSignificantSubdomainCustom()` возвращали неверный результат для доменов трёх и более уровней, присутствующих в пользовательском списке доменов верхнего уровня. Для входных доменов, совпадающих с этими пользовательскими доменами верхнего уровня, домен третьего уровня считался первым значимым. Сейчас это исправлено. Это изменение может привести к несовместимости, если функция используется, например, в ключе шардинга. [#21946](https://github.com/ClickHouse/ClickHouse/pull/21946) ([Azat Khuzhin](https://github.com/azat)).
* Столбец `keys` в таблице `system.dictionaries` был заменён на столбцы `key.names` и `key.types`. Столбцы `key.names`, `key.types`, `attribute.names`, `attribute.types` из таблицы `system.dictionaries` больше не требуют загрузки словаря. [#21884](https://github.com/ClickHouse/ClickHouse/pull/21884) ([Maksim Kita](https://github.com/kitaisreal)).
* Теперь реплики, обрабатывающие команду `ALTER TABLE ATTACH PART[ITION]`, сначала ищут части в своих папках `detached/` перед тем, как забирать данные с других реплик. В качестве детали реализации в реплицированном логе введена новая команда `ATTACH_PART`. Части ищутся и сравниваются по их контрольным суммам. [#18978](https://github.com/ClickHouse/ClickHouse/pull/18978) ([Mike Kot](https://github.com/myrrc)). **Примечание**:
  * Запросы `ATTACH PART[ITION]` могут не работать во время обновления кластера.
  * Невозможно откатиться к более старой версии ClickHouse после выполнения запроса `ALTER ... ATTACH` в новой версии, так как старые серверы не смогут обработать запись `ATTACH_PART` в реплицированном логе.
* В этой версии пустой `<remote_url_allow_hosts></remote_url_allow_hosts>` блокирует весь доступ к удалённым хостам, тогда как в предыдущих версиях он ничего не делал. Если вы хотите сохранить старое поведение и у вас есть пустой элемент `remote_url_allow_hosts` в файле конфигурации, удалите его. [#20058](https://github.com/ClickHouse/ClickHouse/pull/20058) ([Vladimir Chebotarev](https://github.com/excitoon)).

#### Новая функциональность {#new-feature-7}

* Расширен диапазон `DateTime64` для поддержки дат в диапазоне от 1925 до 2283 годов. Улучшена поддержка `DateTime` вокруг нулевой даты (`1970-01-01`). [#9404](https://github.com/ClickHouse/ClickHouse/pull/9404) ([alexey-milovidov](https://github.com/alexey-milovidov), [Vasily Nemkov](https://github.com/Enmk)). Не все функции работы с датой и временем корректно работают для расширенного диапазона дат.
* Добавлена поддержка Kerberos-аутентификации для предварительно настроенных пользователей и HTTP-запросов (GSS-SPNEGO). [#14995](https://github.com/ClickHouse/ClickHouse/pull/14995) ([Denis Glazachev](https://github.com/traceon)).
* Добавлена настройка `prefer_column_name_to_alias` для использования исходных имён столбцов вместо алиасов. Это необходимо для лучшей совместимости с распространёнными правилами задания алиасов в базах данных. Относится к [#9715](https://github.com/ClickHouse/ClickHouse/issues/9715) и [#9887](https://github.com/ClickHouse/ClickHouse/issues/9887). [#22044](https://github.com/ClickHouse/ClickHouse/pull/22044) ([Amos Bird](https://github.com/amosbird)).
* Добавлены функции `dictGetChildren(dictionary, key)`, `dictGetDescendants(dictionary, key, level)`. Функция `dictGetChildren` возвращает всех дочерних элементов в виде массива индексов. Это обратное преобразование к `dictGetHierarchy`. Функция `dictGetDescendants` возвращает всех потомков, как если бы `dictGetChildren` была применена рекурсивно `level` раз. Нулевое значение `level` эквивалентно бесконечности. Закрывает [#14656](https://github.com/ClickHouse/ClickHouse/issues/14656). [#22096](https://github.com/ClickHouse/ClickHouse/pull/22096) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлен источник словаря `executable_pool`. Закрыт тикет [#14528](https://github.com/ClickHouse/ClickHouse/issues/14528). [#21321](https://github.com/ClickHouse/ClickHouse/pull/21321) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена табличная функция `dictionary`. Она работает аналогично движку `Dictionary`. Закрывает [#21560](https://github.com/ClickHouse/ClickHouse/issues/21560). [#21910](https://github.com/ClickHouse/ClickHouse/pull/21910) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена поддержка типа `Nullable` для атрибута `PolygonDictionary`. [#21890](https://github.com/ClickHouse/ClickHouse/pull/21890) ([Maksim Kita](https://github.com/kitaisreal)).
* Функции `dictGet`, `dictHas` теперь используют имя текущей базы данных, если оно не указано для словарей, созданных с помощью DDL. Исправляет [#21632](https://github.com/ClickHouse/ClickHouse/issues/21632). [#21859](https://github.com/ClickHouse/ClickHouse/pull/21859) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена функция `dictGetOrNull`. Работает как `dictGet`, но возвращает `Null`, если ключ не найден в словаре. Закрывает [#22375](https://github.com/ClickHouse/ClickHouse/issues/22375). [#22413](https://github.com/ClickHouse/ClickHouse/pull/22413) ([Maksim Kita](https://github.com/kitaisreal)).
* Реализовано асинхронное обновление в словарях `ComplexKeyCache`, `SSDCache`, `SSDComplexKeyCache`. Добавлена поддержка типа `Nullable` в словарях `Cache`, `ComplexKeyCache`, `SSDCache`, `SSDComplexKeyCache`. Добавлена поддержка получения нескольких атрибутов с помощью функций `dictGet`, `dictGetOrDefault`. Исправлена ошибка [#21517](https://github.com/ClickHouse/ClickHouse/issues/21517). [#20595](https://github.com/ClickHouse/ClickHouse/pull/20595) ([Максим Кита](https://github.com/kitaisreal)).
* Добавлена поддержка функции `dictHas` для `RangeHashedDictionary`, что исправляет [#6680](https://github.com/ClickHouse/ClickHouse/issues/6680). [#19816](https://github.com/ClickHouse/ClickHouse/pull/19816) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена функция `timezoneOf`, которая возвращает имя часового пояса для типов данных `DateTime` или `DateTime64`. Это не закрывает issue [#9959](https://github.com/ClickHouse/ClickHouse/issues/9959). Исправлены несоответствия в названиях функций: добавлены псевдонимы `timezone`, `timeZone`, `toTimezone`, `toTimeZone`, `timezoneOf` и `timeZoneOf`. [#22001](https://github.com/ClickHouse/ClickHouse/pull/22001) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлено новое необязательное предложение `GRANTEES` для команд `CREATE/ALTER USER`. Оно указывает пользователей или роли, которым разрешено получать привилегии от этого пользователя при условии, что этому пользователю также выданы все необходимые права с опцией GRANT (grant option). По умолчанию используется `GRANTEES ANY`, что означает, что пользователь с опцией GRANT может выдавать права кому угодно. Синтаксис: `CREATE USER ... GRANTEES {user | role | ANY | NONE} [,...] [EXCEPT {user | role} [,...]]`. [#21641](https://github.com/ClickHouse/ClickHouse/pull/21641) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлен новый столбец `slowdowns_count` в `system.clusters`. При использовании запросов с подстраховкой (hedged requests) он показывает, сколько раз произошло переключение на другую реплику из‑за медленного ответа текущей реплики. Также теперь отображается фактическое значение `errors_count` в `system.clusters`. [#21480](https://github.com/ClickHouse/ClickHouse/pull/21480) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен виртуальный столбец `_partition_id` для движков семейства `MergeTree*`. Добавлена возможность отсекать партиции по `_partition_id`. Добавлена функция `partitionID()` для вычисления строкового идентификатора партиции. [#21401](https://github.com/ClickHouse/ClickHouse/pull/21401) ([Amos Bird](https://github.com/amosbird)).
* Добавлена функция `isIPAddressInRange` для проверки, входит ли IPv4- или IPv6-адрес в заданный сетевой префикс CIDR. [#21329](https://github.com/ClickHouse/ClickHouse/pull/21329) ([PHO](https://github.com/depressed-pho)).
* Добавлена новая SQL-команда `ALTER TABLE 'table_name' UNFREEZE [PARTITION 'part_expr'] WITH NAME 'backup_name'`. Эта команда необходима для корректного удаления «замороженных» партиций со всех дисков. [#21142](https://github.com/ClickHouse/ClickHouse/pull/21142) ([Pavel Kovalenko](https://github.com/Jokser)).
* Поддерживает неявное преобразование типа ключа для JOIN. [#19885](https://github.com/ClickHouse/ClickHouse/pull/19885) ([Vladimir](https://github.com/vdimir)).

#### Экспериментальная возможность {#experimental-feature-6}

* Поддержка фрейма `RANGE OFFSET` (для оконных функций) для типов с плавающей запятой. Реализованы оконные функции `lagInFrame`/`leadInFrame`, которые аналогичны `lag`/`lead`, но учитывают оконный фрейм. При фрейме `between unbounded preceding and unbounded following` они эквивалентны. Это закрывает [#5485](https://github.com/ClickHouse/ClickHouse/issues/5485). [#21895](https://github.com/ClickHouse/ClickHouse/pull/21895) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Репликация без копирования данных (zero-copy) для `ReplicatedMergeTree` поверх хранилища S3. [#16240](https://github.com/ClickHouse/ClickHouse/pull/16240) ([ianton-ru](https://github.com/ianton-ru)).
* Добавлена возможность мигрировать существующий диск S3 на схему с поддержкой резервного копирования и восстановления. [#22070](https://github.com/ClickHouse/ClickHouse/pull/22070) ([Pavel Kovalenko](https://github.com/Jokser)).

#### Повышение производительности {#performance-improvement-7}

* Добавлена поддержка параллельного форматирования в `clickhouse-local` и в остальных случаях. [#21630](https://github.com/ClickHouse/ClickHouse/pull/21630) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Поддержка параллельного парсинга для форматов `CSVWithNames` и `TSVWithNames`. Это закрывает [#21085](https://github.com/ClickHouse/ClickHouse/issues/21085). [#21149](https://github.com/ClickHouse/ClickHouse/pull/21149) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Включено чтение с использованием mmap IO для файловых диапазонов начиная с 64 MiB (настройка `min_bytes_to_use_mmap_io`). Это может привести к умеренному улучшению производительности. [#22326](https://github.com/ClickHouse/ClickHouse/pull/22326) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлен кэш для файлов, читаемых с использованием настройки `min_bytes_to_use_mmap_io`. Это даёт значительный (в 2 раза и более) прирост производительности, когда значение настройки небольшое, за счёт избегания частых вызовов mmap/munmap и последующих отказов страниц. Обратите внимание, что у mmap IO есть серьёзные недостатки, делающие его менее надёжным в продакшене (например, зависания или SIGBUS на неисправных дисках; менее контролируемое использование памяти). Тем не менее, он хорош в бенчмарках. [#22206](https://github.com/ClickHouse/ClickHouse/pull/22206) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исключено лишнее копирование данных при использовании кодека `NONE`. Обратите внимание, что кодек `NONE` в основном бесполезен — рекомендуется всегда использовать сжатие (по умолчанию — `LZ4`). Вопреки распространённому мнению, отключение сжатия может не улучшить производительность (возможен противоположный эффект). Кодек `NONE` полезен в некоторых случаях: — когда данные не поддаются сжатию; — для синтетических бенчмарков. [#22145](https://github.com/ClickHouse/ClickHouse/pull/22145) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Более быстрый `GROUP BY` с небольшим `max_rows_to_group_by` и `group_by_overflow_mode='any'`. [#21856](https://github.com/ClickHouse/ClickHouse/pull/21856) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Оптимизирована производительность запросов вида `SELECT ... FINAL ... WHERE`. Теперь в запросах с `FINAL` разрешено переносить в `PREWHERE` столбцы, которые входят в ключ сортировки. [#21830](https://github.com/ClickHouse/ClickHouse/pull/21830) ([foolchi](https://github.com/foolchi)).
* Улучшена производительность за счёт замены `memcpy` на другую реализацию. Это закрывает [#18583](https://github.com/ClickHouse/ClickHouse/issues/18583). [#21520](https://github.com/ClickHouse/ClickHouse/pull/21520) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Улучшена производительность агрегации по порядку ключа сортировки (при включённой настройке `optimize_aggregation_in_order`). [#19401](https://github.com/ClickHouse/ClickHouse/pull/19401) ([Anton Popov](https://github.com/CurtizJ)).

#### Улучшение {#improvement-7}

* Добавлен пул соединений для движка таблиц/баз данных PostgreSQL и для источника словаря. Должно исправить [#21444](https://github.com/ClickHouse/ClickHouse/issues/21444). [#21839](https://github.com/ClickHouse/ClickHouse/pull/21839) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Поддержка нестандартной схемы таблиц для хранилища/табличной функции `postgres`. Закрывает [#21701](https://github.com/ClickHouse/ClickHouse/issues/21701). [#21711](https://github.com/ClickHouse/ClickHouse/pull/21711) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Поддержан приоритет реплик для источника словаря PostgreSQL. [#21710](https://github.com/ClickHouse/ClickHouse/pull/21710) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена новая настройка таблиц MergeTree `min_bytes_to_rebalance_partition_over_jbod`, которая позволяет сбалансированно распределять новые части по разным дискам JBOD-тома. [#16481](https://github.com/ClickHouse/ClickHouse/pull/16481) ([Amos Bird](https://github.com/amosbird)).
* Добавлены значения `Grant`, `Revoke` и `System` в столбец `query_kind` для соответствующих запросов в `system.query_log`. [#21102](https://github.com/ClickHouse/ClickHouse/pull/21102) ([Vasily Nemkov](https://github.com/Enmk)).
* Добавлена возможность настраивать тайм‑ауты для HTTP‑подключений, используемых для репликации, независимо от других HTTP‑тайм‑аутов. [#20088](https://github.com/ClickHouse/ClickHouse/pull/20088) ([nvartolomei](https://github.com/nvartolomei)).
* Улучшено сообщение об исключении на стороне клиента при возникновении исключения во время записи блоков сервером. В предыдущих версиях клиент мог получать вводящее в заблуждение сообщение вроде `Data compressed with different methods`. [#22427](https://github.com/ClickHouse/ClickHouse/pull/22427) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка `Directory tmp_fetch_XXX already exists`, возникавшая после неудачной загрузки части. Временный каталог загрузки удаляется, если он уже существует. Исправлено [#14197](https://github.com/ClickHouse/ClickHouse/issues/14197). [#22411](https://github.com/ClickHouse/ClickHouse/pull/22411) ([nvartolomei](https://github.com/nvartolomei)).
* Исправлен отчёт MSan для функции `range` с аргументом `UInt256` (поддержка больших целых чисел — экспериментальная). Исправление закрывает [#22157](https://github.com/ClickHouse/ClickHouse/issues/22157). [#22387](https://github.com/ClickHouse/ClickHouse/pull/22387) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* В таблицу `system.processes` добавлен столбец `current_database`. Он содержит текущую базу данных запроса. [#22365](https://github.com/ClickHouse/ClickHouse/pull/22365) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Добавлены функции поиска и навигации по истории без учета регистра, а также перемещения по частям слов в `clickhouse-client`. [#22105](https://github.com/ClickHouse/ClickHouse/pull/22105) ([Amos Bird](https://github.com/amosbird)).
* Если кортеж из NULL-значений, например `(NULL, NULL)`, находится в левой части оператора `IN`, а в правой части находятся кортежи без NULL, например `SELECT (NULL, NULL) IN ((0, 0), (3, 1))`, теперь возвращается 0 вместо генерации исключения о несовместимых типах. Такое выражение также может появиться в результате оптимизации чего‑то вроде `SELECT (NULL, NULL) = (8, 0) OR (NULL, NULL) = (3, 2) OR (NULL, NULL) = (0, 0) OR (NULL, NULL) = (3, 1)`. Это закрывает [#22017](https://github.com/ClickHouse/ClickHouse/issues/22017). [#22063](https://github.com/ClickHouse/ClickHouse/pull/22063) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Обновлена используемая версия simdjson до 0.9.1, что исправляет [#21984](https://github.com/ClickHouse/ClickHouse/issues/21984). [#22057](https://github.com/ClickHouse/ClickHouse/pull/22057) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлены регистронезависимые псевдонимы для функций `CONNECTION_ID()` и `VERSION()`, что исправило [#22028](https://github.com/ClickHouse/ClickHouse/issues/22028). [#22042](https://github.com/ClickHouse/ClickHouse/pull/22042) ([Eugene Klimov](https://github.com/Slach)).
* Добавлена опция `strict_increase` в функцию `windowFunnel`, чтобы каждое событие учитывалось только один раз (решает [#21835](https://github.com/ClickHouse/ClickHouse/issues/21835)). [#22025](https://github.com/ClickHouse/ClickHouse/pull/22025) ([Vladimir](https://github.com/vdimir)).
* Если ключ партиционирования таблицы `MergeTree` не содержит столбцов типов `Date` или `DateTime`, но содержит ровно один столбец типа `DateTime64`, его значения отображаются в столбцах `min_time` и `max_time` в таблицах `system.parts` и `system.parts_columns`. Добавлены столбцы `min_time` и `max_time` в таблицу `system.parts_columns` (здесь была несогласованность с таблицей `system.parts`). Это закрывает [#18244](https://github.com/ClickHouse/ClickHouse/issues/18244). [#22011](https://github.com/ClickHouse/ClickHouse/pull/22011) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка настройки `replication_alter_partitions_sync=1` в `clickhouse-copier` для перемещения партиций из вспомогательной таблицы в целевую. Уменьшены значения таймаутов по умолчанию. Исправлена проблема [#21911](https://github.com/ClickHouse/ClickHouse/issues/21911). [#21912](https://github.com/ClickHouse/ClickHouse/pull/21912) ([turbo jason](https://github.com/songenjie)).
* Показывать в системных таблицах путь к каталогу данных таблиц `EmbeddedRocksDB`. [#21903](https://github.com/ClickHouse/ClickHouse/pull/21903) ([tavplubix](https://github.com/tavplubix)).
* Добавлено событие профиля `HedgedRequestsChangeReplica`, изменён тайм-аут чтения данных с секунд на миллисекунды. [#21886](https://github.com/ClickHouse/ClickHouse/pull/21886) ([Kruglov Pavel](https://github.com/Avogar)).
* DiskS3 (экспериментальная функция в разработке). Исправлена ошибка, из-за которой было невозможно переместить директорию, если целевой каталог не пуст и используется кэш-диск. [#21837](https://github.com/ClickHouse/ClickHouse/pull/21837) ([Pavel Kovalenko](https://github.com/Jokser)).
* Улучшено форматирование типов данных `Array` и `Map` в веб-интерфейсе. [#21798](https://github.com/ClickHouse/ClickHouse/pull/21798) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Обновляйте кластеры только если их конфигурации были изменены. [#21685](https://github.com/ClickHouse/ClickHouse/pull/21685) ([Kruglov Pavel](https://github.com/Avogar)).
* Распространение настроек запроса и сессии для распределённых DDL-запросов. Установите `distributed_ddl_entry_format_version` в 2, чтобы включить эту возможность. Добавлена настройка `distributed_ddl_output_mode`. Поддерживаемые режимы работы: `none`, `throw` (по умолчанию), `null_status_on_timeout` и `never_throw`. Различные исправления и улучшения для движка базы данных `Replicated`. [#21535](https://github.com/ClickHouse/ClickHouse/pull/21535) ([tavplubix](https://github.com/tavplubix)).
* Если `PODArray` был создан с размером элемента, который не является ни делителем, ни кратным 16, могло произойти переполнение буфера. В текущих релизах таких ошибок нет. [#21533](https://github.com/ClickHouse/ClickHouse/pull/21533) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлены столбцы `last_error_time`/`last_error_message`/`last_error_stacktrace`/`remote` в таблицу `system.errors`. [#21529](https://github.com/ClickHouse/ClickHouse/pull/21529) ([Azat Khuzhin](https://github.com/azat)).
* Добавлены псевдонимы `simpleJSONExtract/simpleJSONHas` к `visitParam/visitParamExtract{UInt, Int, Bool, Float, Raw, String}`. Исправлено #21383. [#21519](https://github.com/ClickHouse/ClickHouse/pull/21519) ([fastio](https://github.com/fastio)).
* Добавлена настройка `optimize_skip_unused_shards_limit` для ограничения числа значений ключа шардирования для `optimize_skip_unused_shards`. [#21512](https://github.com/ClickHouse/ClickHouse/pull/21512) ([Azat Khuzhin](https://github.com/azat)).
* Улучшен `clickhouse-format`, чтобы он не выбрасывал исключение при наличии лишних пробелов или комментариев после последнего запроса, а также чтобы он выдавал исключение как можно раньше с понятным сообщением при форматировании запроса `ASTInsertQuery` с данными. [#21311](https://github.com/ClickHouse/ClickHouse/pull/21311) ([flynn](https://github.com/ucasFL)).
* Улучшена поддержка целочисленных ключей в типе данных `Map`. [#21157](https://github.com/ClickHouse/ClickHouse/pull/21157) ([Anton Popov](https://github.com/CurtizJ)).
* MaterializeMySQL: попытка повторного подключения к MySQL при потере соединения. [#20961](https://github.com/ClickHouse/ClickHouse/pull/20961) ([Håvard Kvålen](https://github.com/havardk)).
* Поддерживается больше случаев преобразования `CROSS JOIN` в `INNER JOIN`. [#20392](https://github.com/ClickHouse/ClickHouse/pull/20392) ([Vladimir](https://github.com/vdimir)).
* Не создавать пустые парты при INSERT при включенной настройке `optimize_on_insert`. Исправляет [#20304](https://github.com/ClickHouse/ClickHouse/issues/20304). [#20387](https://github.com/ClickHouse/ClickHouse/pull/20387) ([Kruglov Pavel](https://github.com/Avogar)).
* `MaterializeMySQL`: добавлен индекс пропуска minmax для столбца `_version`. [#20382](https://github.com/ClickHouse/ClickHouse/pull/20382) ([Stig Bakken](https://github.com/stigsb)).
* Добавлена опция `--backslash` для `clickhouse-format`, добавляющая обратную косую черту в конец каждой строки форматированного запроса. [#21494](https://github.com/ClickHouse/ClickHouse/pull/21494) ([flynn](https://github.com/ucasFL)).
* Теперь ClickHouse не будет выбрасывать исключение `LOGICAL_ERROR`, когда мы пытаемся изменить уже ранее затронутую часть. Исправляет [#22013](https://github.com/ClickHouse/ClickHouse/issues/22013). [#22291](https://github.com/ClickHouse/ClickHouse/pull/22291) ([alesapin](https://github.com/alesapin)).

#### Исправление ошибки {#bug-fix-6}

* Удалён сокет из epoll перед отменой приёмника пакетов в `HedgedConnections`, чтобы предотвратить возможное состояние гонки. Исправляет [#22161](https://github.com/ClickHouse/ClickHouse/issues/22161). [#22443](https://github.com/ClickHouse/ClickHouse/pull/22443) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен недостающий учет памяти в параллельных процедурах парсинга. В предыдущих версиях могла возникать ошибка OOM, когда результирующий набор содержал очень большие блоки данных. Исправляет [#22008](https://github.com/ClickHouse/ClickHouse/issues/22008). [#22425](https://github.com/ClickHouse/ClickHouse/pull/22425) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено исключение, которое могло возникать при выполнении `SELECT` с константным условием `WHERE`, если в исходной таблице есть столбцы с именами, состоящими только из цифр. [#22270](https://github.com/ClickHouse/ClickHouse/pull/22270) ([LiuNeng](https://github.com/liuneng1994)).
* Исправлена проблема с отменой запросов при `use_hedged_requests=0` и `async_socket_for_remote=1`. [#22183](https://github.com/ClickHouse/ClickHouse/pull/22183) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено необработанное исключение в `InterserverIOHTTPHandler`. [#22146](https://github.com/ClickHouse/ClickHouse/pull/22146) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена точка входа Docker на случай, если `http_port` отсутствует в конфигурации. [#22132](https://github.com/ClickHouse/ClickHouse/pull/22132) ([Ewout](https://github.com/devwout)).
* Исправлена ошибка `Invalid number of rows in Chunk` в операции `JOIN` с `TOTALS` и `arrayJoin`. Закрывает [#19303](https://github.com/ClickHouse/ClickHouse/issues/19303). [#22129](https://github.com/ClickHouse/ClickHouse/pull/22129) ([Vladimir](https://github.com/vdimir)).
* Исправлено имя фонового пула потоков, который использовался для опроса сообщений из Kafka. Движок Kafka с неисправным пулом потоков не будет забирать сообщения из очереди сообщений. [#22122](https://github.com/ClickHouse/ClickHouse/pull/22122) ([fastio](https://github.com/fastio)).
* Исправлено ожидание выполнения запросов `OPTIMIZE` и `ALTER` для движков таблиц `ReplicatedMergeTree`. Теперь запрос не будет зависать, когда таблица была отсоединена или перезапущена. [#22118](https://github.com/ClickHouse/ClickHouse/pull/22118) ([alesapin](https://github.com/alesapin)).
* Отключены `async_socket_for_remote`/`use_hedged_requests` для проблемных версий ядра Linux. [#22109](https://github.com/ClickHouse/ClickHouse/pull/22109) ([Azat Khuzhin](https://github.com/azat)).
* Точка входа Docker: избегать выполнения `chown` для `.` в случае, когда `LOG_PATH` пуст. Закрывает [#22100](https://github.com/ClickHouse/ClickHouse/issues/22100). [#22102](https://github.com/ClickHouse/ClickHouse/pull/22102) ([filimonov](https://github.com/filimonov)).
* В функции `decrypt` отсутствовала проверка минимально допустимого размера данных, зашифрованных в режиме `AEAD`. Это закрывает [#21897](https://github.com/ClickHouse/ClickHouse/issues/21897). [#22064](https://github.com/ClickHouse/ClickHouse/pull/22064) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* В редких случаях слияние для `CollapsingMergeTree` может создать гранулу с количеством строк `index_granularity + 1`. Из‑за этого внутренняя проверка, добавленная в [#18928](https://github.com/ClickHouse/ClickHouse/issues/18928) (затрагивает версии 21.2 и 21.3), может завершиться с ошибкой `Incomplete granules are not allowed while blocks are granules size`. Эта ошибка не позволяла сливать части. [#21976](https://github.com/ClickHouse/ClickHouse/pull/21976) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Отменено изменение [#15454](https://github.com/ClickHouse/ClickHouse/issues/15454), которое могло привести к существенному росту потребления памяти при загрузке внешних словарей хешированного типа. Это закрывает проблему [#21935](https://github.com/ClickHouse/ClickHouse/issues/21935). [#21948](https://github.com/ClickHouse/ClickHouse/pull/21948) ([Maksim Kita](https://github.com/kitaisreal)).
* Предотвращены перекрытия хеджированных подключений (ошибка `Unknown packet 9 from server`). [#21941](https://github.com/ClickHouse/ClickHouse/pull/21941) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено чтение HTTP POST-запроса с типом содержимого «multipart/form-data» в ряде случаев. [#21936](https://github.com/ClickHouse/ClickHouse/pull/21936) ([Ivan](https://github.com/abyss7)).
* Исправлены некорректные результаты `ORDER BY` в запросах с оконными функциями при включённой оптимизации чтения в порядке первичного ключа. Исправление [#21828](https://github.com/ClickHouse/ClickHouse/issues/21828). [#21915](https://github.com/ClickHouse/ClickHouse/pull/21915) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Исправлено взаимоблокирование при первом запуске модели CatBoost. Закрывает [#13832](https://github.com/ClickHouse/ClickHouse/issues/13832). [#21844](https://github.com/ClickHouse/ClickHouse/pull/21844) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен некорректный результат выполнения запроса (и возможный сбой), который мог возникать, когда условие `WHERE` или `HAVING` проталкивалось перед `GROUP BY`. Исправляет [#21773](https://github.com/ClickHouse/ClickHouse/issues/21773). [#21841](https://github.com/ClickHouse/ClickHouse/pull/21841) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Улучшены обработка ошибок и логирование в `WriteBufferFromS3`. [#21836](https://github.com/ClickHouse/ClickHouse/pull/21836) ([Pavel Kovalenko](https://github.com/Jokser)).
* Исправлены возможные падения в агрегатных функциях с комбинатором `Distinct` при использовании двухуровневой агрегации. Это доработка исправления из [#18365](https://github.com/ClickHouse/ClickHouse/pull/18365). Ошибка воспроизводилась только в продакшн-среде. [#21818](https://github.com/ClickHouse/ClickHouse/pull/21818) ([Amos Bird](https://github.com/amosbird)).
* Исправлен анализ индекса скалярного подзапроса. Это исправляет [#21717](https://github.com/ClickHouse/ClickHouse/issues/21717), которая была внесена изменениями из [#18896](https://github.com/ClickHouse/ClickHouse/pull/18896). [#21766](https://github.com/ClickHouse/ClickHouse/pull/21766) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка для таблиц с движком `ReplicatedMerge`, из-за которой запрос `ALTER MODIFY COLUMN` не менял тип столбца `Decimal`, если его разрядность (32 бита или 64 бита) не изменялась. [#21728](https://github.com/ClickHouse/ClickHouse/pull/21728) ([alesapin](https://github.com/alesapin)).
* Исправлено возможное бесконечное ожидание при одновременном выполнении `OPTIMIZE` и `DROP` для `ReplicatedMergeTree`. [#21716](https://github.com/ClickHouse/ClickHouse/pull/21716) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа функции `arrayElement` с типом `Map` для константных целочисленных аргументов. [#21699](https://github.com/ClickHouse/ClickHouse/pull/21699) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка SIGSEGV при обращении к несуществующим атрибутам из `ip_trie` при использовании `access_to_key_from_attributes`. [#21692](https://github.com/ClickHouse/ClickHouse/pull/21692) ([Azат Khuzhin](https://github.com/azat)).
* Сервер теперь принимает подключения только после инициализации `DDLWorker` и словарей. [#21676](https://github.com/ClickHouse/ClickHouse/pull/21676) ([Azat Khuzhin](https://github.com/azat)).
* Добавлено преобразование типов для ключей таблиц типа `Join`, отсутствие которого ранее приводило к SIGSEGV. [#21646](https://github.com/ClickHouse/ClickHouse/pull/21646) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена отмена распределённых запросов (например, простого запроса SELECT из нескольких шардов с LIMIT, то есть `select * from remote('127.{2,3}', system.numbers) limit 100`) при `async_socket_for_remote=1`. [#21643](https://github.com/ClickHouse/ClickHouse/pull/21643) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен `fsync_part_directory` при горизонтальном слиянии. [#21642](https://github.com/ClickHouse/ClickHouse/pull/21642) ([Azat Khuzhin](https://github.com/azat)).
* Удалены неизвестные столбцы из присоединённой таблицы в условии `WHERE` для запросов к внешним движкам баз данных (MySQL, PostgreSQL). close [#14614](https://github.com/ClickHouse/ClickHouse/issues/14614), close [#19288](https://github.com/ClickHouse/ClickHouse/issues/19288) (дубликат), close [#19645](https://github.com/ClickHouse/ClickHouse/issues/19645) (дубликат). [#21640](https://github.com/ClickHouse/ClickHouse/pull/21640) ([Vladimir](https://github.com/vdimir)).
* `std::terminate` вызывалась при ошибке записи данных в S3. [#21624](https://github.com/ClickHouse/ClickHouse/pull/21624) ([Vladimir](https://github.com/vdimir)).
* Исправлена возможная ошибка `Cannot find column` при включённом `optimize_skip_unused_shards` и отсутствии шардов. [#21579](https://github.com/ClickHouse/ClickHouse/pull/21579) ([Azat Khuzhin](https://github.com/azat)).
* В случае если запрос содержит константное условие `WHERE` и включена настройка `optimize_skip_unused_shards`, все шарды могут быть пропущены, и запрос может вернуть некорректный пустой результат. [#21550](https://github.com/ClickHouse/ClickHouse/pull/21550) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка, из-за которой табличная функция `clusterAllReplicas` возвращала неверное значение `_shard_num`. Закрывает [#21481](https://github.com/ClickHouse/ClickHouse/issues/21481). [#21498](https://github.com/ClickHouse/ClickHouse/pull/21498) ([flynn](https://github.com/ucasFL)).
* Исправлена проблема, при которой таблица S3 продолжала использовать старые учетные данные после обновления конфигурации. [#21457](https://github.com/ClickHouse/ClickHouse/pull/21457) ([Grigory Pervakov](https://github.com/GrigoryPervakov)).
* Исправлено условие гонки для SSL-объекта внутри `SecureSocket` в Poco. [#21456](https://github.com/ClickHouse/ClickHouse/pull/21456) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлен разбор формата `Avro` для `Kafka`. Устраняет проблему [#21437](https://github.com/ClickHouse/ClickHouse/issues/21437). [#21438](https://github.com/ClickHouse/ClickHouse/pull/21438) ([Ilya Golshtein](https://github.com/ilejn)).
* Исправлены тайм-ауты на приём и отправку данных, а также неблокирующее чтение в защищённом сокете. [#21429](https://github.com/ClickHouse/ClickHouse/pull/21429) ([Kruglov Pavel](https://github.com/Avogar)).
* Флаг `force_drop_table` не работал для `MATERIALIZED VIEW`; ошибка была исправлена. Исправляет [#18943](https://github.com/ClickHouse/ClickHouse/issues/18943). [#20626](https://github.com/ClickHouse/ClickHouse/pull/20626) ([tavplubix](https://github.com/tavplubix)).
* Исправлены конфликты имён в `PredicateRewriteVisitor`. Это приводило к некорректной фильтрации в `WHERE` после полного соединения (FULL JOIN). Закрывает [#20497](https://github.com/ClickHouse/ClickHouse/issues/20497). [#20622](https://github.com/ClickHouse/ClickHouse/pull/20622) ([Vladimir](https://github.com/vdimir)).

#### Улучшения в сборке, тестировании и пакетировании {#buildtestingpackaging-improvement-7}

* Добавлены тесты [Jepsen](https://github.com/jepsen-io/jepsen) для ClickHouse Keeper. [#21677](https://github.com/ClickHouse/ClickHouse/pull/21677) ([alesapin](https://github.com/alesapin)).
* Запускать тесты без состояния параллельно в CI. Зависит от [#22181](https://github.com/ClickHouse/ClickHouse/issues/22181). [#22300](https://github.com/ClickHouse/ClickHouse/pull/22300) ([alesapin](https://github.com/alesapin)).
* Включена проверка статуса для запуска CI [SQLancer](https://github.com/sqlancer/sqlancer). [#22015](https://github.com/ClickHouse/ClickHouse/pull/22015) ([Ilya Yatsishin](https://github.com/qoega)).
* Несколько подготовительных изменений для сборок под PowerPC: включено использование встроенной openldap на `ppc64le`. [#22487](https://github.com/ClickHouse/ClickHouse/pull/22487) ([Kfir Itzhak](https://github.com/mastertheknife)). Включена поддержка компиляции на `ppc64le` с использованием Clang. [#22476](https://github.com/ClickHouse/ClickHouse/pull/22476) ([Kfir Itzhak](https://github.com/mastertheknife)). Исправлена компиляция Boost на `ppc64le`. [#22474](https://github.com/ClickHouse/ClickHouse/pull/22474) ([Kfir Itzhak](https://github.com/mastertheknife)). Исправлена ошибка CMake о том, что внутренняя переменная CMake `CMAKE_ASM_COMPILE_OBJECT` не установлена на `ppc64le`. [#22469](https://github.com/ClickHouse/ClickHouse/pull/22469) ([Kfir Itzhak](https://github.com/mastertheknife)). Исправлена проблема в Fedora/RHEL/CentOS с поиском `libclang_rt.builtins` на `ppc64le`. [#22458](https://github.com/ClickHouse/ClickHouse/pull/22458) ([Kfir Itzhak](https://github.com/mastertheknife)). Включена сборка с `jemalloc` на `ppc64le`. [#22447](https://github.com/ClickHouse/ClickHouse/pull/22447) ([Kfir Itzhak](https://github.com/mastertheknife)). Исправлено встраивание конфигурации ClickHouse и встраивание часовых поясов cctz на `ppc64le`. [#22445](https://github.com/ClickHouse/ClickHouse/pull/22445) ([Kfir Itzhak](https://github.com/mastertheknife)). Исправлена компиляция на `ppc64le` и настроено использование корректного регистра указателя инструкции на `ppc64le`. [#22430](https://github.com/ClickHouse/ClickHouse/pull/22430) ([Kfir Itzhak](https://github.com/mastertheknife)).
* Повторно включена библиотека S3 (AWS) на `aarch64`. [#22484](https://github.com/ClickHouse/ClickHouse/pull/22484) ([Kfir Itzhak](https://github.com/mastertheknife)).
* Добавлен пакет `tzdata` в Docker-контейнеры, так как он необходим для чтения формата `ORC`. Это закрывает [#14156](https://github.com/ClickHouse/ClickHouse/issues/14156). [#22000](https://github.com/ClickHouse/ClickHouse/pull/22000) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлены два аргумента для Dockerfile для образа `clickhouse-server`: `deb_location` и `single_binary_location`. [#21977](https://github.com/ClickHouse/ClickHouse/pull/21977) ([filimonov](https://github.com/filimonov)).
* Разрешить использование clang-tidy с релизными сборками путём включения assert-ов, если используется clang-tidy. [#21914](https://github.com/ClickHouse/ClickHouse/pull/21914) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлены имена исполняемых файлов llvm-12 в поиск в скриптах CMake. Добавлены неявные преобразования констант для подавления предупреждений clang. Обновлены подмодули для сборки с CMake 3.19. Подавлена рекурсия при раскрытии макросов в библиотеке `readpassphrase`. Устаревший флаг `-fuse-ld` заменён на `--ld-path` для clang. [#21597](https://github.com/ClickHouse/ClickHouse/pull/21597) ([Ilya Yatsishin](https://github.com/qoega)).
* Обновлён `docker/test/testflows/runner/dockerd-entrypoint.sh` для использования Yandex dockerhub-proxy, поскольку Docker Hub ввёл очень жёсткие лимиты на частоту запросов [#21551](https://github.com/ClickHouse/ClickHouse/pull/21551) ([vzakaznikov](https://github.com/vzakaznikov)).
* Исправлена сборка динамической библиотеки на macOS. [#20184](https://github.com/ClickHouse/ClickHouse/pull/20184) ([nvartolomei](https://github.com/nvartolomei)).
* Добавлена опция `ctime` в `zookeeper-dump-tree`. Она позволяет вывести время создания узла. [#21842](https://github.com/ClickHouse/ClickHouse/pull/21842) ([Ilya](https://github.com/HumanUser)).

## Релиз ClickHouse 21.3 (LTS) {#clickhouse-release-213-lts}

### Релиз ClickHouse v21.3, 2021-03-12 {#clickhouse-release-v213-2021-03-12}

#### Обратное несовместимое изменение {#backward-incompatible-change-8}

* Теперь создание таблиц MergeTree в старом синтаксисе с TTL таблицы не допускается, поскольку TTL просто игнорируется. Операция ATTACH старых таблиц по‑прежнему возможна. [#20282](https://github.com/ClickHouse/ClickHouse/pull/20282) ([alesapin](https://github.com/alesapin)).
* Теперь все имена функций с нечувствительностью к регистру будут переписаны в их каноническое представление. Это необходимо для маршрутизации запросов по проекциям (предстоящая функциональность). [#20174](https://github.com/ClickHouse/ClickHouse/pull/20174) ([Amos Bird](https://github.com/amosbird)).
* Исправлено создание `TTL` в случаях, когда его выражение является функцией и совпадает с ключом `ORDER BY`. Теперь разрешено задавать пользовательскую агрегацию для столбцов первичного ключа в `TTL` с `GROUP BY`. Обратная несовместимость: для столбцов первичного ключа, которые не входят в `GROUP BY` и не заданы явно, теперь при истечении TTL применяется функция `any` вместо `max`. Также, если вы используете TTL с `WHERE` или `GROUP BY`, вы можете сталкиваться с исключениями при слияниях во время поэтапного обновления. [#15450](https://github.com/ClickHouse/ClickHouse/pull/15450) ([Anton Popov](https://github.com/CurtizJ)).

#### Новая возможность {#new-feature-8}

* Добавлены настройки файлового движка: `engine_file_empty_if_not_exists` и `engine_file_truncate_on_insert`. [#20620](https://github.com/ClickHouse/ClickHouse/pull/20620) ([M0r64n](https://github.com/M0r64n)).
* Добавлена агрегатная функция `deltaSum` для суммирования разностей между последовательными строками. [#20057](https://github.com/ClickHouse/ClickHouse/pull/20057) ([Russ Frank](https://github.com/rf)).
* Новый столбец `event_time_microseconds` в таблице `system.part_log`. [#20027](https://github.com/ClickHouse/ClickHouse/pull/20027) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлена функция `timezoneOffset(datetime)`, которая возвращает смещение от UTC в секундах. Это закрывает [#issue:19850](https://github.com/ClickHouse/ClickHouse/issues/19850). [#19962](https://github.com/ClickHouse/ClickHouse/pull/19962) ([keenwolf](https://github.com/keen-wolf)).
* Добавлена настройка `insert_shard_id` для поддержки вставки данных в конкретный сегмент из распределённой таблицы. [#19961](https://github.com/ClickHouse/ClickHouse/pull/19961) ([flynn](https://github.com/ucasFL)).
* Функция `reinterpretAs` обновлена для поддержки больших целых чисел. Исправляет [#19691](https://github.com/ClickHouse/ClickHouse/issues/19691). [#19858](https://github.com/ClickHouse/ClickHouse/pull/19858) ([Maksim Kita](https://github.com/kitaisreal)).
* В клиенте S3 добавлена поддержка Server Side Encryption Customer Keys (заголовок `x-amz-server-side-encryption-customer-(key/md5)`). Подробнее см. по [ссылке](https://docs.aws.amazon.com/AmazonS3/latest/dev/ServerSideEncryptionCustomerKeys.html). Закрывает [#19428](https://github.com/ClickHouse/ClickHouse/issues/19428). [#19748](https://github.com/ClickHouse/ClickHouse/pull/19748) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Добавлена опция `implicit_key` для источника словаря `executable`. Позволяет не выводить ключ для каждой записи, если записи поступают в том же порядке, что и входные ключи. Реализует [#14527](https://github.com/ClickHouse/ClickHouse/issues/14527). [#19677](https://github.com/ClickHouse/ClickHouse/pull/19677) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлены типы квот `query_selects` и `query_inserts`. [#19603](https://github.com/ClickHouse/ClickHouse/pull/19603) ([JackyWoo](https://github.com/JackyWoo)).
* Добавлена функция `extractTextFromHTML`. [#19600](https://github.com/ClickHouse/ClickHouse/pull/19600) ([zlx19950903](https://github.com/zlx19950903)), ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Таблицы с движком `MergeTree*` теперь имеют две новые настройки на уровне таблицы для управления параллельным выполнением запросов. Настройка `max_concurrent_queries` ограничивает количество одновременно выполняемых запросов, связанных с этой таблицей. Настройка `min_marks_to_honor_max_concurrent_queries` указывает применять предыдущую настройку только если запрос читает как минимум указанное количество меток. [#19544](https://github.com/ClickHouse/ClickHouse/pull/19544) ([Amos Bird](https://github.com/amosbird)).
* Добавлена функция `file` для чтения файла из директории `user_files` как строки (String). Она отличается от табличной функции `file`. Реализует [#issue:18851](https://github.com/ClickHouse/ClickHouse/issues/18851). [#19204](https://github.com/ClickHouse/ClickHouse/pull/19204) ([keenwolf](https://github.com/keen-wolf)).

#### Экспериментальные возможности {#experimental-feature-7}

* Добавлен экспериментальный движок базы данных `Replicated`. Он реплицирует DDL‑запросы между несколькими узлами. [#16193](https://github.com/ClickHouse/ClickHouse/pull/16193) ([tavplubix](https://github.com/tavplubix)).
* Добавлена экспериментальная поддержка оконных функций, включаемая параметром `allow_experimental_window_functions = 1`. Это предварительная альфа‑версия, не предназначенная для использования в продуктиве и в будущих релизах изменяющаяся с нарушением обратной совместимости. См. [документацию](https://github.com/ClickHouse/ClickHouse/blob/master/docs/sql-reference/window-functions/index.md#experimental-window-functions) со списком поддерживаемых возможностей. [#20337](https://github.com/ClickHouse/ClickHouse/pull/20337) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Добавлена возможность создавать резервные копии и восстанавливать файлы метаданных для DiskS3. [#18377](https://github.com/ClickHouse/ClickHouse/pull/18377) ([Pavel Kovalenко](https://github.com/Jokser)).

#### Улучшение производительности {#performance-improvement-8}

* Хеджированные запросы при выполнении удалённых запросов. При включении параметра `use_hedged_requests` (по умолчанию отключён) можно устанавливать несколько соединений с разными репликами для одного запроса. Новое соединение создаётся, если ни одно из существующих соединений с репликой (репликами) не было установлено в течение `hedged_connection_timeout` или данные не были получены в течение `receive_data_timeout`. Запрос использует первое соединение, которое отправит непустой пакет прогресса (или пакет данных, если включён `allow_changing_replica_until_first_data_packet`); остальные соединения отменяются. Поддерживаются запросы с `max_parallel_replicas > 1`. [#19291](https://github.com/ClickHouse/ClickHouse/pull/19291) ([Kruglov Pavel](https://github.com/Avogar)). Это позволяет значительно снизить хвостовые задержки на очень больших кластерах.
* Добавлена поддержка `PREWHERE` (и включена соответствующая оптимизация) для таблиц, у которых заданы выражения построчной (row-level) безопасности. [#19576](https://github.com/ClickHouse/ClickHouse/pull/19576) ([Denis Glazachev](https://github.com/traceon)).
* Настройка `distributed_aggregation_memory_efficient` включена по умолчанию. Она снижает потребление памяти и улучшает производительность распределённых запросов. [#20599](https://github.com/ClickHouse/ClickHouse/pull/20599) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Улучшена производительность операций GROUP BY с несколькими ключами фиксированного размера. [#20472](https://github.com/ClickHouse/ClickHouse/pull/20472) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Улучшена производительность агрегатных функций за счёт более строгого соблюдения правил aliasing. [#19946](https://github.com/ClickHouse/ClickHouse/pull/19946) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Ускорено чтение из таблиц `Memory` в экстремальных случаях (когда скорость чтения достигает порядка 50 ГБ/с) за счёт упрощения конвейера и, как следствие, уменьшения конкуренции за блокировки при планировании конвейера. [#20468](https://github.com/ClickHouse/ClickHouse/pull/20468) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Частично переработан HTTP-сервер, чтобы уменьшить число копирований входящих и исходящих данных. Это даёт до 1,5-кратного роста производительности при вставке длинных записей по HTTP. [#19516](https://github.com/ClickHouse/ClickHouse/pull/19516) ([Ivan](https://github.com/abyss7)).
* Добавлена настройка `compress` для таблиц `Memory`. Если она включена, таблица будет использовать меньше оперативной памяти. На некоторых машинах и для некоторых наборов данных это также может работать быстрее при выполнении SELECT-запросов, но так бывает не всегда. Это закрывает [#20093](https://github.com/ClickHouse/ClickHouse/issues/20093). Примечание: есть причины, по которым таблицы Memory могут работать медленнее, чем MergeTree: (1) отсутствие сжатия, (2) фиксированный размер блоков, (3) отсутствие индексов и prewhere... [#20168](https://github.com/ClickHouse/ClickHouse/pull/20168) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Немного улучшен код агрегации. [#20978](https://github.com/ClickHouse/ClickHouse/pull/20978) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Вернуть специализации `intDiv`/`modulo` для повышения производительности. Это исправляет [#21293](https://github.com/ClickHouse/ClickHouse/issues/21293). Регрессия появилась в [https://github.com/ClickHouse/ClickHouse/pull/18145](https://github.com/ClickHouse/ClickHouse/pull/18145). [#21307](https://github.com/ClickHouse/ClickHouse/pull/21307) ([Amos Bird](https://github.com/amosbird)).
* Блоки больше не сжимаются слишком сильно в `INSERT SELECT`, если выполняется вставка в таблицу `Memory`. В предыдущих версиях после выполнения `INSERT SELECT` в таблице `Memory` создавалось неэффективное представление данных. Это закрывает [#13052](https://github.com/ClickHouse/ClickHouse/issues/13052). [#20169](https://github.com/ClickHouse/ClickHouse/pull/20169) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен как минимум один случай, когда парсер DataType мог иметь экспоненциальную сложность (обнаружено фаззером). Это закрывает [#20096](https://github.com/ClickHouse/ClickHouse/issues/20096). [#20132](https://github.com/ClickHouse/ClickHouse/pull/20132) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Параллелизовать SELECT с FINAL для одной части с уровнем &gt; 0, когда настройка `do_not_merge_across_partitions_select_final` имеет значение 1. [#19375](https://github.com/ClickHouse/ClickHouse/pull/19375) ([Kruglov Pavel](https://github.com/Avogar)).
* Заполнять только запрошенные столбцы при выполнении запросов к `system.parts` и `system.parts_columns`. Закрывает [#19570](https://github.com/ClickHouse/ClickHouse/issues/19570). [#21035](https://github.com/ClickHouse/ClickHouse/pull/21035) ([Anmol Arora](https://github.com/anmolarora)).
* Выполнены алгебраические оптимизации арифметических выражений внутри агрегатной функции `avg`. Закрыто [#20092](https://github.com/ClickHouse/ClickHouse/issues/20092). [#20183](https://github.com/ClickHouse/ClickHouse/pull/20183) ([flynn](https://github.com/ucasFL)).

#### Улучшение {#improvement-8}

* Методы сжатия, нечувствительные к регистру, для табличных функций. Также исправлен метод сжатия LZMA, который ранее проверялся только в верхнем регистре. [#21416](https://github.com/ClickHouse/ClickHouse/pull/21416) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Добавлены две настройки, позволяющие задерживать вставку или выбрасывать ошибку при слишком большом количестве неактивных частей. Это полезно, когда сервер не успевает достаточно быстро очищать части. [#20178](https://github.com/ClickHouse/ClickHouse/pull/20178) ([Amos Bird](https://github.com/amosbird)).
* Улучшена совместимость с клиентами MySQL. 1. MySQL JDBC 2. mycli. [#21367](https://github.com/ClickHouse/ClickHouse/pull/21367) ([Amos Bird](https://github.com/amosbird)).
* Запрещено удалять столбец, если он используется в материализованном представлении. Закрывает [#21164](https://github.com/ClickHouse/ClickHouse/issues/21164). [#21303](https://github.com/ClickHouse/ClickHouse/pull/21303) ([flynn](https://github.com/ucasFL)).
* Источник словаря MySQL теперь будет повторять попытки при неожиданных обрывах соединения (Lost connection to MySQL server during query), которые иногда происходят при SSL/TLS-подключениях. [#21237](https://github.com/ClickHouse/ClickHouse/pull/21237) ([Alexander Kazakov](https://github.com/Akazz)).
* Улучшение удобства использования: более последовательный разбор значений `DateTime64`: распознаётся случай, когда UNIX-метка времени с субсекундным разрешением задаётся как масштабированное целое число (например, `1111111111222` вместо `1111111111.222`). Это закрывает [#13194](https://github.com/ClickHouse/ClickHouse/issues/13194). [#21053](https://github.com/ClickHouse/ClickHouse/pull/21053) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* При включённой настройке distributed&#95;group&#95;by&#95;no&#95;merge выполняется только слияние отсортированных блоков на инициаторе. [#20882](https://github.com/ClickHouse/ClickHouse/pull/20882) ([Azat Khuzhin](https://github.com/azat)).
* При загрузке конфигурации для источника MySQL ClickHouse теперь будет случайным образом перемешивать список реплик с одинаковым приоритетом, чтобы обеспечить работу round-robin-алгоритма выбора endpoint MySQL. Это закрывает [#20629](https://github.com/ClickHouse/ClickHouse/issues/20629). [#20632](https://github.com/ClickHouse/ClickHouse/pull/20632) ([Alexander Kazakov](https://github.com/Akazz)).
* Функция &#39;reinterpretAs(x, Type)&#39; была переименована в &#39;reinterpret(x, Type)&#39;. [#20611](https://github.com/ClickHouse/ClickHouse/pull/20611) ([Maksim Kita](https://github.com/kitaisreal)).
* Поддержка vhost для движка RabbitMQ [#20576](https://github.com/ClickHouse/ClickHouse/issues/20576). [#20596](https://github.com/ClickHouse/ClickHouse/pull/20596) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Улучшена сериализация для составных типов данных Array и Tuple. Улучшено сопоставление перечислимых типов данных с перечислимыми типами protobuf. Исправлена сериализация типа данных `Map`. Пропущенные значения теперь задаются по умолчанию. [#20506](https://github.com/ClickHouse/ClickHouse/pull/20506) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена гонка между выполнением распределённых DDL‑задач и очисткой очереди DDL. Теперь DDL‑задача не может быть удалена из ZooKeeper, если ещё есть активные воркеры. Исправляет [#20016](https://github.com/ClickHouse/ClickHouse/issues/20016). [#20448](https://github.com/ClickHouse/ClickHouse/pull/20448) ([tavplubix](https://github.com/tavplubix)).
* Обеспечена корректная работа FQDN и других функций, связанных с DNS, в образах Alpine. [#20336](https://github.com/ClickHouse/ClickHouse/pull/20336) ([filimonov](https://github.com/filimonov)).
* Не допускается раннее свёртывание констант для явно запрещённых функций. [#20303](https://github.com/ClickHouse/ClickHouse/pull/20303) ([Azat Khuzhin](https://github.com/azat)).
* Неявное преобразование из целого числа в тип Decimal могло завершаться успешно, даже если целочисленное значение не входило в диапазон значений типа Decimal. Теперь в таком случае генерируется ошибка `ARGUMENT_OUT_OF_BOUND`. [#20232](https://github.com/ClickHouse/ClickHouse/pull/20232) ([tavplubix](https://github.com/tavplubix)).
* Неблокирующий `SYSTEM FLUSH DISTRIBUTED`. [#20215](https://github.com/ClickHouse/ClickHouse/pull/20215) ([Azat Khuzhin](https://github.com/azat)).
* Нормализовать выражения count(constant) и sum(1) до count(). Это необходимо для маршрутизации запросов с проекциями. [#20175](https://github.com/ClickHouse/ClickHouse/pull/20175) ([Amos Bird](https://github.com/amosbird)).
* Поддержка всех нативных целочисленных типов данных в bitmap-функциях. [#20171](https://github.com/ClickHouse/ClickHouse/pull/20171) ([Amos Bird](https://github.com/amosbird)).
* Обновлены `CacheDictionary`, `ComplexCacheDictionary`, `SSDCacheDictionary`, `SSDComplexKeyDictionary` для использования LRUHashMap в качестве базового индекса. [#20164](https://github.com/ClickHouse/ClickHouse/pull/20164) ([Maksim Kita](https://github.com/kitaisreal)).
* Настройку `access_management` теперь можно задавать при запуске через `CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT`; по умолчанию она отключена (`0`), как и ранее. [#20139](https://github.com/ClickHouse/ClickHouse/pull/20139) ([Marquitos](https://github.com/sonirico)).
* Исправлена `toDateTime64(toDate()/toDateTime())` для типа `DateTime64` — реализовано ограничение значений `DateTime64`, соответствующее поведению `DateTime`. [#20131](https://github.com/ClickHouse/ClickHouse/pull/20131) ([Azat Khuzhin](https://github.com/azat)).
* Улучшения квот: `SHOW TABLES` теперь считается одним запросом при расчёте квоты, а не двумя. Запросы `SYSTEM` теперь потребляют квоту. Исправлено вычисление конца интервала при потреблении квоты. [#20106](https://github.com/ClickHouse/ClickHouse/pull/20106) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена поддержка выражений `path IN (set)` для таблицы `system.zookeeper`. [#20105](https://github.com/ClickHouse/ClickHouse/pull/20105) ([小路](https://github.com/nicelulu)).
* Показывать полную информацию о таблицах `MaterializeMySQL` в `system.tables`. [#20051](https://github.com/ClickHouse/ClickHouse/pull/20051) ([Stig Bakken](https://github.com/stigsb)).
* Исправлена гонка данных в исполняемом словаре, которая возникала только при некорректном использовании (когда скрипт возвращает данные, игнорируя входные данные). [#20045](https://github.com/ClickHouse/ClickHouse/pull/20045) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Значением опции MYSQL&#95;OPT&#95;RECONNECT теперь можно управлять с помощью параметра &quot;opt&#95;reconnect&quot; в секции config реплики MySQL. [#19998](https://github.com/ClickHouse/ClickHouse/pull/19998) ([Alexander Kazakov](https://github.com/Akazz)).
* Если пользователь вызывает функцию `JSONExtract` с запрошенным типом `Float32`, теперь допускается неточное преобразование к результирующему типу. Например, число `0.1` в JSON имеет двойную точность и не может быть точно представлено в `Float32`, но пользователь всё равно хочет его получить. В предыдущих версиях возвращалось `0` для типа non-Nullable и `NULL` для типа Nullable, чтобы указать, что преобразование неточно. Логика была полностью корректной, но вызывала удивление у пользователей и приводила к вопросам. Это закрывает [#13962](https://github.com/ClickHouse/ClickHouse/issues/13962). [#19960](https://github.com/ClickHouse/ClickHouse/pull/19960) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлено преобразование структуры блока при INSERT в таблицы типа Distributed, если она не соответствует. [#19947](https://github.com/ClickHouse/ClickHouse/pull/19947) ([Azat Khuzhin](https://github.com/azat)).
* Улучшение для таблицы `system.distributed_ddl_queue`. Теперь MaxDDLEntryID инициализируется последним значением после перезапуска. До этого PR MaxDDLEntryID оставался равным нулю, пока не была обработана новая DDLTask. [#19924](https://github.com/ClickHouse/ClickHouse/pull/19924) ([Amos Bird](https://github.com/amosbird)).
* Показывать таблицы `MaterializeMySQL` в `system.parts`. [#19770](https://github.com/ClickHouse/ClickHouse/pull/19770) ([Stig Bakken](https://github.com/stigsb)).
* Добавлена отдельная директива конфигурации для профиля `Buffer`. [#19721](https://github.com/ClickHouse/ClickHouse/pull/19721) ([Azat Khuzhin](https://github.com/azat)).
* Перемещены условия, не относящиеся к JOIN, в предложение WHERE. [#18720](https://github.com/ClickHouse/ClickHouse/issues/18720). [#19685](https://github.com/ClickHouse/ClickHouse/pull/19685) ([hexiaoting](https://github.com/hexiaoting)).
* Добавлена возможность ограничивать скорость INSERT в Distributed в зависимости от объёма байтов, ожидающих асинхронной отправки (добавлены настройки `bytes_to_delay_insert`/`max_delay_to_insert` и `bytes_to_throw_insert` для движка `Distributed`). [#19673](https://github.com/ClickHouse/ClickHouse/pull/19673) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены редкие случаи, когда ошибки записи могли игнорироваться в деструкторах. [#19451](https://github.com/ClickHouse/ClickHouse/pull/19451) ([Azat Khuzhin](https://github.com/azat)).
* Выводить inline-кадры в трассировке стека для фатальных ошибок. [#19317](https://github.com/ClickHouse/ClickHouse/pull/19317) ([Ivan](https://github.com/abyss7)).

#### Исправление ошибки {#bug-fix-7}

* Исправлены лишние переподключения к ZooKeeper и возможность наличия двух активных сессий для одного сервера ClickHouse. Обе проблемы возникли в результате изменений в #14678. [#21264](https://github.com/ClickHouse/ClickHouse/pull/21264) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка `Bad cast from type ... to DB::ColumnLowCardinality`, возникавшая при вставке в таблицу со столбцом `LowCardinality` из формата `Values`. Исправление для #21140 [#21357](https://github.com/ClickHouse/ClickHouse/pull/21357) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен дедлок в мутациях `ALTER DELETE` для нереплицируемых движков таблиц MergeTree, возникающий, если в предикате используется эта же таблица. Исправляет [#20558](https://github.com/ClickHouse/ClickHouse/issues/20558). [#21477](https://github.com/ClickHouse/ClickHouse/pull/21477) ([alesapin](https://github.com/alesapin)).
* Исправлен SIGSEGV при сбоях в распределённых запросах. [#21434](https://github.com/ClickHouse/ClickHouse/pull/21434) ([Azat Khuzhin](https://github.com/azat)).
* Теперь запросы `ALTER MODIFY COLUMN` будут корректно вносить изменения в ключ партиционирования, пропускающие индексы, TTL и т. д. Исправляет проблему [#13675](https://github.com/ClickHouse/ClickHouse/issues/13675). [#21334](https://github.com/ClickHouse/ClickHouse/pull/21334) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка, связанная с `join_use_nulls` и объединением `TOTALS` из подзапросов. Это закрывает [#19362](https://github.com/ClickHouse/ClickHouse/issues/19362) и [#21137](https://github.com/ClickHouse/ClickHouse/issues/21137). [#21248](https://github.com/ClickHouse/ClickHouse/pull/21248) ([vdimir](https://github.com/vdimir)).
* Исправлена ошибка, приводившая к сбою `EXPLAIN` для запроса с `UNION`. Исправляет [#20876](https://github.com/ClickHouse/ClickHouse/issues/20876), [#21170](https://github.com/ClickHouse/ClickHouse/issues/21170). [#21246](https://github.com/ClickHouse/ClickHouse/pull/21246) ([flynn](https://github.com/ucasFL)).
* Теперь мутации допустимы только для движков таблиц, которые их поддерживают (семейство MergeTree, Memory, MaterializedView). Остальные движки будут сообщать более понятную ошибку. Исправляет [#21168](https://github.com/ClickHouse/ClickHouse/issues/21168). [#21183](https://github.com/ClickHouse/ClickHouse/pull/21183) ([alesapin](https://github.com/alesapin)).
* Исправляет [#21112](https://github.com/ClickHouse/ClickHouse/issues/21112). Исправлена ошибка, которая могла приводить к дубликатам при запросе `INSERT` (если один из обратных вызовов приходил с небольшим опозданием). [#21138](https://github.com/ClickHouse/ClickHouse/pull/21138) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена работа `input_format_null_as_default`, чтобы он вступал в силу для допускающих `NULL` типов. Это исправляет [#21116](https://github.com/ClickHouse/ClickHouse/issues/21116). [#21121](https://github.com/ClickHouse/ClickHouse/pull/21121) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка, связанная с приведением типа Tuple к типу Map. Закрывает [#21029](https://github.com/ClickHouse/ClickHouse/issues/21029). [#21120](https://github.com/ClickHouse/ClickHouse/pull/21120) ([hexiaoting](https://github.com/hexiaoting)).
* Исправлена утечка метаданных при удалении таблиц Replicated*MergeTree с пользовательским (нестандартным) кластером ZooKeeper. [#21119](https://github.com/ClickHouse/ClickHouse/pull/21119) ([fastio](https://github.com/fastio)).
* Исправлена ошибка несоответствия типов при использовании ключей LowCardinality в функции joinGet. Это исправляет [#21114](https://github.com/ClickHouse/ClickHouse/issues/21114). [#21117](https://github.com/ClickHouse/ClickHouse/pull/21117) ([Amos Bird](https://github.com/amosbird)).
* исправлено: значения default&#95;replica&#95;path и default&#95;replica&#95;name были бесполезны для движка Replicated(*)MergeTree, когда требовалось указать другие параметры движка. [#21060](https://github.com/ClickHouse/ClickHouse/pull/21060) ([mxzlxy](https://github.com/mxzlxy)).
* Был возможен выход за пределы памяти при форматировании специально сконструированного значения типа `DateTime64` вне допустимого диапазона. Устраняет [#20494](https://github.com/ClickHouse/ClickHouse/issues/20494). Устраняет [#20543](https://github.com/ClickHouse/ClickHouse/issues/20543). [#21023](https://github.com/ClickHouse/ClickHouse/pull/21023) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Блокировка параллельных вставок в хранилище JOIN. [#21009](https://github.com/ClickHouse/ClickHouse/pull/21009) ([vdimir](https://github.com/vdimir)).
* Исправлено поведение, при котором `ALTER MODIFY COLUMN` создавал мутацию, которая заведомо должна была завершиться ошибкой. [#21007](https://github.com/ClickHouse/ClickHouse/pull/21007) ([Anton Popov](https://github.com/CurtizJ)).
* Закрыт [#9969](https://github.com/ClickHouse/ClickHouse/issues/9969). Исправлена ошибка HTTP-сжатия Brotli, возникавшая для больших объёмов данных, слегка усложнённой структуры и при использовании формата вывода JSON. Обновлена библиотека Brotli до последней версии, чтобы включить «исправление редкого доступа к неинициализированным данным в кольцевом буфере». [#20991](https://github.com/ClickHouse/ClickHouse/pull/20991) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка &#39;Empty task was returned from async task queue&#39; при отмене запроса. [#20881](https://github.com/ClickHouse/ClickHouse/pull/20881) ([Azat Khuzhin](https://github.com/azat)).
* Запрос `USE database;` не работал при подключении к серверу ClickHouse с помощью клиента MySQL 5.7; проблема устранена. Исправлена [#18926](https://github.com/ClickHouse/ClickHouse/issues/18926). [#20878](https://github.com/ClickHouse/ClickHouse/pull/20878) ([tavplubix](https://github.com/tavplubix)).
* Исправлено использование комбинатора `-Distinct` совместно с комбинатором `-State` в агрегатных функциях. [#20866](https://github.com/ClickHouse/ClickHouse/pull/20866) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена работа подзапроса с `UNION DISTINCT` и предложением `LIMIT`. Закрыт [#20597](https://github.com/ClickHouse/ClickHouse/issues/20597). [#20610](https://github.com/ClickHouse/ClickHouse/pull/20610) ([flynn](https://github.com/ucasFL)).
* Исправлено неконсистентное поведение словаря в запросах, ищущих отсутствующие ключи в словаре. [#20578](https://github.com/ClickHouse/ClickHouse/pull/20578) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлено использование количества потоков для скалярных подзапросов и подзапросов по индексу (после [#19007](https://github.com/ClickHouse/ClickHouse/issues/19007) всегда использовался один поток). Исправлены [#20457](https://github.com/ClickHouse/ClickHouse/issues/20457), [#20512](https://github.com/ClickHouse/ClickHouse/issues/20512). [#20550](https://github.com/ClickHouse/ClickHouse/pull/20550) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, из‑за которой мог происходить сбой при получении неизвестного пакета от удалённого запроса (была внесена в [#17868](https://github.com/ClickHouse/ClickHouse/issues/17868)). [#20547](https://github.com/ClickHouse/ClickHouse/pull/20547) ([Azat Khuzhin](https://github.com/azat)).
* Добавлены корректные проверки при разборе имён каталогов для асинхронных операций INSERT (исправляет SIGSEGV). [#20498](https://github.com/ClickHouse/ClickHouse/pull/20498) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена некорректная работа функции `transform` для ключей с плавающей точкой. Закрывает [#20460](https://github.com/ClickHouse/ClickHouse/issues/20460). [#20479](https://github.com/ClickHouse/ClickHouse/pull/20479) ([flynn](https://github.com/ucasFL)).
* Исправлен бесконечный цикл, возникавший при распространении псевдонимов `WITH` на подзапросы. Это исправляет [#20388](https://github.com/ClickHouse/ClickHouse/issues/20388). [#20476](https://github.com/ClickHouse/ClickHouse/pull/20476) ([Amos Bird](https://github.com/amosbird)).
* Исправлено некорректное завершение работы сервера при отключении HTTP-клиента. [#20464](https://github.com/ClickHouse/ClickHouse/pull/20464) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка `LOGICAL_ERROR` при `join_use_nulls=1`, когда в JOIN используется константа из SELECT. [#20461](https://github.com/ClickHouse/ClickHouse/pull/20461) ([Azat Khuzhin](https://github.com/azat)).
* Проверять, используется ли табличная функция `view` в списке выражений, и в таком случае выбрасывать ошибку. Это исправляет [#20342](https://github.com/ClickHouse/ClickHouse/issues/20342). [#20350](https://github.com/ClickHouse/ClickHouse/pull/20350) ([Amos Bird](https://github.com/amosbird)).
* Предотвращено некорректное разыменование в словаре RANGE&#95;HASHED(). [#20345](https://github.com/ClickHouse/ClickHouse/pull/20345) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка разыменования null при `join_use_nulls=1`. [#20344](https://github.com/ClickHouse/ClickHouse/pull/20344) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, приводившая к некорректным результатам бинарных операций между двумя константными значениями типа `Decimal` с разным масштабом. Устраняет [#20283](https://github.com/ClickHouse/ClickHouse/issues/20283). [#20339](https://github.com/ClickHouse/ClickHouse/pull/20339) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена проблема слишком частых повторных запусков неудавшихся фоновых задач для семейства движков таблиц `ReplicatedMergeTree`. Это могло приводить к чрезмерному объёму логирования и повышенной нагрузке на CPU. Исправляет [#20203](https://github.com/ClickHouse/ClickHouse/issues/20203). [#20335](https://github.com/ClickHouse/ClickHouse/pull/20335) ([alesapin](https://github.com/alesapin)).
* Ограничены операции `DROP` и `RENAME` над столбцом версии в движках таблиц `*CollapsingMergeTree` и `ReplacingMergeTree`. [#20300](https://github.com/ClickHouse/ClickHouse/pull/20300) ([alesapin](https://github.com/alesapin)).
* Исправлено поведение, при котором в случае некорректного JSON предпринималась попытка прочитать весь файл в память, что приводило к выбросу исключения аллокатором. Исправлена [#19719](https://github.com/ClickHouse/ClickHouse/issues/19719). [#20286](https://github.com/ClickHouse/ClickHouse/pull/20286) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлено исключение, возникающее при вертикальном слиянии для семейства движков таблиц `MergeTree`, которые не поддерживают вертикальные слияния. Исправляет [#20259](https://github.com/ClickHouse/ClickHouse/issues/20259). [#20279](https://github.com/ClickHouse/ClickHouse/pull/20279) ([alesapin](https://github.com/alesapin)).
* Исправлено редкое падение сервера при перезагрузке конфигурации во время завершения работы. Исправлена ошибка [#19689](https://github.com/ClickHouse/ClickHouse/issues/19689). [#20224](https://github.com/ClickHouse/ClickHouse/pull/20224) ([alesapin](https://github.com/alesapin)).
* Исправлена работа CTE в INSERT SELECT. Это исправление закрывает [#20187](https://github.com/ClickHouse/ClickHouse/issues/20187) и [#20195](https://github.com/ClickHouse/ClickHouse/issues/20195). [#20211](https://github.com/ClickHouse/ClickHouse/pull/20211) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка [#19314](https://github.com/ClickHouse/ClickHouse/issues/19314). [#20156](https://github.com/ClickHouse/ClickHouse/pull/20156) ([Ivan](https://github.com/abyss7)).
* исправлена функция toMinute для корректной обработки особого часового пояса. [#20149](https://github.com/ClickHouse/ClickHouse/pull/20149) ([keenwolf](https://github.com/keen-wolf)).
* Исправлен сбой сервера после выполнения запроса с функцией `if`, в котором результат ветвей then/else имеет тип `Tuple`. Тип `Tuple` должен содержать `Array` или другой сложный тип. Исправляет [#18356](https://github.com/ClickHouse/ClickHouse/issues/18356). [#20133](https://github.com/ClickHouse/ClickHouse/pull/20133) ([alesapin](https://github.com/alesapin)).
* Движок таблицы `MongoDB` теперь устанавливает соединение только при чтении данных. `ATTACH TABLE` больше не будет пытаться подключаться. [#20110](https://github.com/ClickHouse/ClickHouse/pull/20110) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправление ошибки в StorageJoin. [#20079](https://github.com/ClickHouse/ClickHouse/pull/20079) ([vdimir](https://github.com/vdimir)).
* Исправлен случай, когда при вычислении остатка от деления отрицательного числа на небольшой делитель результирующий тип данных был недостаточно большим, чтобы вместить отрицательный результат. Это закрывает [#20052](https://github.com/ClickHouse/ClickHouse/issues/20052). [#20067](https://github.com/ClickHouse/ClickHouse/pull/20067) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* MaterializeMySQL: Исправлена репликация для запросов, которые обновляют несколько таблиц. [#20066](https://github.com/ClickHouse/ClickHouse/pull/20066) ([Håvard Kvålen](https://github.com/havardk)).
* Предотвращена ошибка «Connection refused» в Docker во время выполнения скрипта инициализации. [#20012](https://github.com/ClickHouse/ClickHouse/pull/20012) ([filimonov](https://github.com/filimonov)).
* `EmbeddedRocksDB` — экспериментальное хранилище. Исправлена проблема отсутствия корректной проверки типов. Код упрощён. Это закрывает [#19967](https://github.com/ClickHouse/ClickHouse/issues/19967). [#19972](https://github.com/ClickHouse/ClickHouse/pull/19972) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка в функции `fromModifiedJulianDay`, приводившая к segfault при использовании аргумента типа `Nullable(T)` для любых целочисленных типов, кроме Int32. [#19959](https://github.com/ClickHouse/ClickHouse/pull/19959) ([PHO](https://github.com/depressed-pho)).
* Исправлено падение при использовании индекса BloomFilter. Исправляет [#19757](https://github.com/ClickHouse/ClickHouse/issues/19757). [#19884](https://github.com/ClickHouse/ClickHouse/pull/19884) ([Maksim Kita](https://github.com/kitaisreal)).
* Могла возникать взаимоблокировка, если включен system.text&#95;log. Это исправляет [#19874](https://github.com/ClickHouse/ClickHouse/issues/19874). [#19875](https://github.com/ClickHouse/ClickHouse/pull/19875) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка запуска сервера с таблицами, имеющими выражения по умолчанию, содержащие dictGet(). Теперь можно определять возвращаемый тип функции dictGet() без загрузки словаря. [#19805](https://github.com/ClickHouse/ClickHouse/pull/19805) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена ошибка аварийного завершения работы `clickhouse-client` при выполнении только команды `SELECT`. [#19790](https://github.com/ClickHouse/ClickHouse/pull/19790) ([taiyang-li](https://github.com/taiyang-li)).
* Исправлена ошибка, из-за которой перенос частей в целевую таблицу мог завершаться с ошибкой при запуске нескольких экземпляров clickhouse-copier. [#19743](https://github.com/ClickHouse/ClickHouse/pull/19743) ([madianjun](https://github.com/mdianjun)).
* Фоновый поток, выполняющий запросы `ON CLUSTER`, мог зависать в ожидании действий от удалённой реплицируемой таблицы. Это исправлено. [#19684](https://github.com/ClickHouse/ClickHouse/pull/19684) ([yiguolei](https://github.com/yiguolei)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-8}

* Добавлена возможность собирать ClickHouse с глобально включённым AVX-2. Это даёт небольшое преимущество в производительности на современных CPU. Не рекомендуется для боевой эксплуатации и пока не будет официально поддерживаться. [#20180](https://github.com/ClickHouse/ClickHouse/pull/20180) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена часть проблем, найденных Coverity. См. [#19964](https://github.com/ClickHouse/ClickHouse/issues/19964). [#20010](https://github.com/ClickHouse/ClickHouse/pull/20010) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность запуска модифицированного исполняемого файла под gdb. В предыдущей версии, если вы ставили точку останова в gdb до запуска, сервер отказывался запускаться из-за неудачной проверки целостности. [#21258](https://github.com/ClickHouse/ClickHouse/pull/21258) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлен тест для различных методов сжатия в Kafka. [#21111](https://github.com/ClickHouse/ClickHouse/pull/21111) ([filimonov](https://github.com/filimonov)).
* Исправлен конфликт портов в тесте test_storage_kerberized_hdfs. [#19974](https://github.com/ClickHouse/ClickHouse/pull/19974) ([Ilya Yatsishin](https://github.com/qoega)).
* Добавлен вывод `stdout` и `stderr` в лог при неудачном запуске Docker в интеграционных тестах. До этого PR в таком случае выводилось очень короткое сообщение об ошибке, которое не помогало в расследовании проблем. [#20631](https://github.com/ClickHouse/ClickHouse/pull/20631) ([Vitaly Baranov](https://github.com/vitlibar)).

## Релиз ClickHouse 21.2 {#clickhouse-release-212}

### Релиз ClickHouse v21.2.2.8-stable, 2021-02-07 {#clickhouse-release-v21228-stable-2021-02-07}

#### Обратимо несовместимое изменение {#backward-incompatible-change-9}

* Побитовые функции (`bitAnd`, `bitOr` и т.д.) запрещены для аргументов с плавающей точкой. Теперь необходимо выполнять явное приведение к целому типу. [#19853](https://github.com/ClickHouse/ClickHouse/pull/19853) ([Azat Khuzhin](https://github.com/azat)).
* Функции `lcm`/`gcd` для чисел с плавающей точкой запрещены. [#19532](https://github.com/ClickHouse/ClickHouse/pull/19532) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено отслеживание использования памяти для `OPTIMIZE TABLE`/слияний; теперь также учитываются лимиты памяти запроса и семплирование для `OPTIMIZE TABLE`/слияний. [#18772](https://github.com/ClickHouse/ClickHouse/pull/18772) ([Azat Khuzhin](https://github.com/azat)).
* Запрещено использовать столбец с плавающей точкой в качестве ключа партиционирования, см. [#18421](https://github.com/ClickHouse/ClickHouse/issues/18421#event-4147046255). [#18464](https://github.com/ClickHouse/ClickHouse/pull/18464) ([hexiaoting](https://github.com/hexiaoting)).
* Избыточные скобки в определениях типов больше не поддерживаются, пример: `Array((UInt8))`.

#### Новая функциональность {#new-feature-9}

* Добавлен движок таблицы `PostgreSQL` (для SELECT и INSERT, с поддержкой многомерных массивов), а также в виде табличной функции. Добавлен источник словаря `PostgreSQL`. Добавлен движок базы данных `PostgreSQL`. [#18554](https://github.com/ClickHouse/ClickHouse/pull/18554) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Тип данных `Nested` теперь поддерживает произвольные уровни вложенности. Добавлены подстолбцы сложных типов, такие как `size0` в `Array`, `null` в `Nullable`, имена элементов `Tuple`, которые можно читать без чтения всего столбца. [#17310](https://github.com/ClickHouse/ClickHouse/pull/17310) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена поддержка типа `Nullable` для `FlatDictionary`, `HashedDictionary`, `ComplexKeyHashedDictionary`, `DirectDictionary`, `ComplexKeyDirectDictionary`, `RangeHashedDictionary`. [#18236](https://github.com/ClickHouse/ClickHouse/pull/18236) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавляет новую таблицу `system.distributed_ddl_queue`, которая отображает запросы в очереди обработчика DDL. [#17656](https://github.com/ClickHouse/ClickHouse/pull/17656) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлена поддержка сопоставления имён групп LDAP и, в целом, значений атрибутов с локальными ролями для пользователей из LDAP‑каталогов. [#17211](https://github.com/ClickHouse/ClickHouse/pull/17211) ([Denis Glazachev](https://github.com/traceon)).
* Добавлена поддержка вставки в табличную функцию `cluster`, а для обеих табличных функций `remote` и `cluster` — поддержка распределения данных по узлам на основе ключа шардирования. Закрывает [#16752](https://github.com/ClickHouse/ClickHouse/issues/16752). [#18264](https://github.com/ClickHouse/ClickHouse/pull/18264) ([flynn](https://github.com/ucasFL)).
* Добавлена функция `decodeXMLComponent` для декодирования символов в XML. Пример: `SELECT decodeXMLComponent('Hello,&quot;world&quot;!')` [#17659](https://github.com/ClickHouse/ClickHouse/issues/17659). [#18542](https://github.com/ClickHouse/ClickHouse/pull/18542) ([nauta](https://github.com/nautaa)).
* Добавлены функции `parseDateTimeBestEffortUSOrZero`, `parseDateTimeBestEffortUSOrNull`. [#19712](https://github.com/ClickHouse/ClickHouse/pull/19712) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена математическая функция `sign`. [#19527](https://github.com/ClickHouse/ClickHouse/pull/19527) ([flynn](https://github.com/ucasFL)).
* В system.query&#95;log добавлена информация об использованных возможностях (функциях, движках таблиц и т. д.). [#18495](https://github.com/ClickHouse/ClickHouse/issues/18495). [#19371](https://github.com/ClickHouse/ClickHouse/pull/19371) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Функция `formatDateTime` поддерживает модификатор `%Q` для форматирования даты в номер квартала. [#19224](https://github.com/ClickHouse/ClickHouse/pull/19224) ([Jianmei Zhang](https://github.com/zhangjmruc)).
* Добавлена поддержка сочетания клавиш MetaKey+Enter в интерфейсе Play UI. [#19012](https://github.com/ClickHouse/ClickHouse/pull/19012) ([sundyli](https://github.com/sundy-li)).
* Добавлены три функции для типа данных `Map`: 1. `mapContains(map, key)` — проверяет, содержит ли `map.keys` второй параметр `key`. 2. `mapKeys(map)` — возвращает все ключи в виде массива (`Array`). 3. `mapValues(map)` — возвращает все значения в виде массива (`Array`). [#18788](https://github.com/ClickHouse/ClickHouse/pull/18788) ([hexiaoting](https://github.com/hexiaoting)).
* Добавлена настройка `log_comment`, связанная с [#18494](https://github.com/ClickHouse/ClickHouse/issues/18494). [#18549](https://github.com/ClickHouse/ClickHouse/pull/18549) ([Zijie Lu](https://github.com/TszKitLo40)).
* Добавлена поддержка аргумента-кортежа в функциях `argMin` и `argMax`. [#17359](https://github.com/ClickHouse/ClickHouse/pull/17359) ([Ildus Kurbangaliev](https://github.com/ildus)).
* Добавлена поддержка синтаксиса `EXISTS VIEW`. [#18552](https://github.com/ClickHouse/ClickHouse/pull/18552) ([Du Chuan](https://github.com/spongedu)).
* Добавлен синтаксис `SELECT ALL`. Закрывает [#18706](https://github.com/ClickHouse/ClickHouse/issues/18706). [#18723](https://github.com/ClickHouse/ClickHouse/pull/18723) ([flynn](https://github.com/ucasFL)).

#### Повышение производительности {#performance-improvement-9}

* Ускорено удаление парций за счет уменьшения числа системных вызовов `stat`. Возвращена ранее существовавшая оптимизация. Интерфейс `IDisk` сделан более безопасным. Закрывает [#19065](https://github.com/ClickHouse/ClickHouse/issues/19065). [#19086](https://github.com/ClickHouse/ClickHouse/pull/19086) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Псевдонимы, объявленные в выражении `WITH`, корректно используются при анализе индексов. Запросы вида `WITH column AS alias SELECT ... WHERE alias = ...` теперь могут использовать индекс. [#18896](https://github.com/ClickHouse/ClickHouse/pull/18896) ([Amos Bird](https://github.com/amosbird)).
* Добавлен `optimize_alias_column_prediction` (включен по умолчанию), который будет: - Учитывать столбцы‑псевдонимы в WHERE при отсечении партиций и пропуске данных с помощью вторичных индексов; - Учитывать столбцы‑псевдонимы в WHERE для тривиальных запросов подсчета строк в optimize_trivial_count; - Учитывать столбцы‑псевдонимы в GROUP BY/ORDER BY для optimize_aggregation_in_order/optimize_read_in_order. [#16995](https://github.com/ClickHouse/ClickHouse/pull/16995) ([sundyli](https://github.com/sundy-li)).
* Ускорена агрегатная функция `sum`. Улучшение заметно только на синтетических бенчмарках и мало практично. [#19216](https://github.com/ClickHouse/ClickHouse/pull/19216) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Обновлен libc++ и используется другой ABI для повышения производительности. [#18914](https://github.com/ClickHouse/ClickHouse/pull/18914) ([Danila Kutenин](https://github.com/danlark1)).
* Функции `sumIf()` и `sum(if())` автоматически переписываются в `countIf()` в логически эквивалентных случаях. [#17041](https://github.com/ClickHouse/ClickHouse/pull/17041) ([flynn](https://github.com/ucasFL)).
* Используется пул подключений для соединений с S3, управляемый настройкой `s3_max_connections`. [#13405](https://github.com/ClickHouse/ClickHouse/pull/13405) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Добавлена поддержка опции `long` в zstd для более эффективного сжатия строковых столбцов и экономии места. [#17184](https://github.com/ClickHouse/ClickHouse/pull/17184) ([ygrek](https://github.com/ygrek)).
* Незначительно снижена задержка сервера за счет исключения обращения к конфигурации при каждом новом соединении. [#19863](https://github.com/ClickHouse/ClickHouse/pull/19863) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Снижена конкуренция за блокировки для нескольких уровней движка `Buffer`. [#19379](https://github.com/ClickHouse/ClickHouse/pull/19379) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка разбиения шага `Filter` в плане запроса на пару `Expression + Filter`. Совместно с оптимизацией объединения `Expression + Expression` ([#17458](https://github.com/ClickHouse/ClickHouse/issues/17458)) это может переносить вычисление некоторых выражений на шаг после `Filter`. [#19253](https://github.com/ClickHouse/ClickHouse/pull/19253) ([Nikolai Kochetов](https://github.com/KochetovNicolai)).

#### Улучшение {#improvement-9}

* `SELECT count() FROM table` теперь можно выполнить, если из `table` можно выбрать хотя бы один столбец. Этот PR исправляет [#10639](https://github.com/ClickHouse/ClickHouse/issues/10639). [#18233](https://github.com/ClickHouse/ClickHouse/pull/18233) ([Vitaly Baranov](https://github.com/vitlibar)).
* При взаимодействии с удалёнными серверами MySQL устанавливайте кодировку `utf8mb4`. Исправляет [#19795](https://github.com/ClickHouse/ClickHouse/issues/19795). [#19800](https://github.com/ClickHouse/ClickHouse/pull/19800) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Табличная функция `S3` теперь поддерживает режим сжатия `auto` (автоопределение типа сжатия). Это закрывает [#18754](https://github.com/ClickHouse/ClickHouse/issues/18754). [#19793](https://github.com/ClickHouse/ClickHouse/pull/19793) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Корректный вывод бесконечных аргументов функции `formatReadableTimeDelta`. В предыдущих версиях происходило неявное преобразование в целочисленное значение, зависящее от конкретной реализации. [#19791](https://github.com/ClickHouse/ClickHouse/pull/19791) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Табличная функция `S3` будет использовать глобальный регион, если его не удаётся определить однозначно. Это закрывает [#10998](https://github.com/ClickHouse/ClickHouse/issues/10998). [#19750](https://github.com/ClickHouse/ClickHouse/pull/19750) ([Vladimir Chebotarev](https://github.com/excitoon)).
* В распределённых запросах, если включена настройка `async_socket_for_remote`, мог происходить переполнение стека как минимум в отладочной конфигурации сборки при использовании в таблице очень глубоко вложенного типа данных (например, `Array(Array(Array(...more...)))`). Это исправляет [#19108](https://github.com/ClickHouse/ClickHouse/issues/19108). Это изменение вносит небольшую обратную несовместимость: избыточные скобки в определениях типов больше не поддерживаются, пример: `Array((UInt8))`. [#19736](https://github.com/ClickHouse/ClickHouse/pull/19736) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлен отдельный пул для брокеров сообщений (RabbitMQ и Kafka). [#19722](https://github.com/ClickHouse/ClickHouse/pull/19722) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена редкая ситуация превышения лимита `max_number_of_merges_with_ttl_in_pool` (могло назначаться больше слияний с TTL) для нереплицируемого MergeTree. [#19708](https://github.com/ClickHouse/ClickHouse/pull/19708) ([alesapin](https://github.com/alesapin)).
* Dictionary: улучшено сообщение об ошибке при разборе атрибутов. [#19678](https://github.com/ClickHouse/ClickHouse/pull/19678) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена настройка для отключения проверки контрольных сумм при чтении. Никогда не должна использоваться в продакшене. Пожалуйста, не ожидайте какой-либо выгоды от её отключения. Может использоваться только для экспериментов и бенчмарков. Настройка применима только к таблицам семейства MergeTree. Контрольные суммы всегда проверяются для других табличных движков и при приёме данных по сети. Согласно моим наблюдениям, разницы в производительности нет, либо она менее 0,5 %. [#19588](https://github.com/ClickHouse/ClickHouse/pull/19588) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка константного результата в функции `multiIf`. [#19533](https://github.com/ClickHouse/ClickHouse/pull/19533) ([Maksim Kita](https://github.com/kitaisreal)).
* Включена поддержка функций length, empty и notEmpty для типа данных Map, которые возвращают число ключей в Map. [#19530](https://github.com/ClickHouse/ClickHouse/pull/19530) ([taiyang-li](https://github.com/taiyang-li)).
* Добавлена опция `--reconnect` в `clickhouse-benchmark`. При указании этой опции клиент будет переподключаться перед каждым запросом. Это необходимо для тестирования. [#19872](https://github.com/ClickHouse/ClickHouse/pull/19872) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка нового расположения файла `.debug`. Исправляет [#19348](https://github.com/ClickHouse/ClickHouse/issues/19348). [#19520](https://github.com/ClickHouse/ClickHouse/pull/19520) ([Amos Bird](https://github.com/amosbird)).
* Функция `toIPv6` анализирует IP-адреса в формате `IPv4`. [#19518](https://github.com/ClickHouse/ClickHouse/pull/19518) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлено поле `http_referer` в `system.query_log`, `system.processes` и т. д., что закрывает [#19389](https://github.com/ClickHouse/ClickHouse/issues/19389). [#19390](https://github.com/ClickHouse/ClickHouse/pull/19390) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Улучшена совместимость с MySQL за счёт того, что больше функций стали нечувствительными к регистру, и добавления алиасов. [#19387](https://github.com/ClickHouse/ClickHouse/pull/19387) ([Daniil Kondratyev](https://github.com/dankondr)).
* Добавлены метрики для типов частей MergeTree (Wide/Compact/InMemory). [#19381](https://github.com/ClickHouse/ClickHouse/pull/19381) ([Azat Khuzhin](https://github.com/azat)).
* Разрешён запуск Docker с произвольным UID. [#19374](https://github.com/ClickHouse/ClickHouse/pull/19374) ([filimonov](https://github.com/filimonov)).
* Исправлено неверное выравнивание значений типа данных `IPv4` в форматах Pretty. Они выравнивались по правому краю вместо левого. Это закрывает [#19184](https://github.com/ClickHouse/ClickHouse/issues/19184). [#19339](https://github.com/ClickHouse/ClickHouse/pull/19339) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность изменять `max_server_memory_usage` без перезапуска. Это закрывает [#18154](https://github.com/ClickHouse/ClickHouse/issues/18154). [#19186](https://github.com/ClickHouse/ClickHouse/pull/19186) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исключение при вызове функции `bar` с определённым значением NaN в предыдущих версиях могло несколько вводить в заблуждение. Это исправляет [#19088](https://github.com/ClickHouse/ClickHouse/issues/19088). [#19107](https://github.com/ClickHouse/ClickHouse/pull/19107) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Явно установлены uid/gid пользователя и группы clickhouse на фиксированное значение 101 в образах clickhouse-server. [#19096](https://github.com/ClickHouse/ClickHouse/pull/19096) ([filimonov](https://github.com/filimonov)).
* Исправлена ошибка `PeekableReadBuffer: Memory limit exceed` при вставке данных, содержащих очень длинные строки. Исправляет [#18690](https://github.com/ClickHouse/ClickHouse/issues/18690). [#18979](https://github.com/ClickHouse/ClickHouse/pull/18979) ([tavplubix](https://github.com/tavplubix)).
* Docker-образ: несколько улучшений точки входа clickhouse-server. [#18954](https://github.com/ClickHouse/ClickHouse/pull/18954) ([filimonov](https://github.com/filimonov)).
* Добавлены `normalizeQueryKeepNames` и `normalizedQueryHashKeepNames`, чтобы нормализовать запросы без маскировки длинных имен с помощью `?`. Это помогает лучше анализировать сложные логи запросов. [#18910](https://github.com/ClickHouse/ClickHouse/pull/18910) ([Amos Bird](https://github.com/amosbird)).
* Проверять поблочные контрольные суммы распределённого батча на стороне отправителя перед отправкой (без повторного чтения файла — контрольные суммы проверяются в процессе чтения), что позволяет избежать «зависания» INSERT на стороне получателя (в случае усечённого .bin-файла на стороне отправителя). Не читать .bin-файлы дважды для пакетного INSERT (ранее это требовалось для вычисления числа строк/байт с учётом схлопывания, теперь эта информация включена в заголовок, при этом сохранена обратная совместимость). [#18853](https://github.com/ClickHouse/ClickHouse/pull/18853) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены проблемы с RIGHT и FULL JOIN таблиц с состояниями агрегатных функций. В предыдущих версиях выбрасывалось исключение, связанное с методом `cloneResized`. [#18818](https://github.com/ClickHouse/ClickHouse/pull/18818) ([templarzq](https://github.com/templarzq)).
* Добавлены настройки S3-эндпоинтов на основе префиксов. [#18812](https://github.com/ClickHouse/ClickHouse/pull/18812) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Добавлена поддержка типов аргументов [UInt8, UInt16, UInt32, UInt64] в функциях bitmapTransform, bitmapSubsetInRange, bitmapSubsetLimit, bitmapContains. Это закрывает [#18713](https://github.com/ClickHouse/ClickHouse/issues/18713). [#18791](https://github.com/ClickHouse/ClickHouse/pull/18791) ([sundyli](https://github.com/sundy-li)).
* Разрешить дополнительное использование псевдонимов для CTE (Common Table Expressions). Распространить CSE (устранение общих подвыражений, Common Subexpressions Elimination) на подзапросы того же уровня при `enable_global_with_statement = 1`. Это исправляет [#17378](https://github.com/ClickHouse/ClickHouse/issues/17378). Это также исправляет [https://github.com/ClickHouse/ClickHouse/pull/16575#issuecomment-753416235](https://github.com/ClickHouse/ClickHouse/pull/16575#issuecomment-753416235). [#18684](https://github.com/ClickHouse/ClickHouse/pull/18684) ([Amos Bird](https://github.com/amosbird)).
* Обновлена librdkafka до версии v1.6.0-RC2. Исправлена проблема [#18668](https://github.com/ClickHouse/ClickHouse/issues/18668). [#18671](https://github.com/ClickHouse/ClickHouse/pull/18671) ([filimonov](https://github.com/filimonov)).
* При возникновении неожиданных исключений автоматически перезапускать фоновый поток, который отвечает за выполнение распределённых DDL‑запросов. Исправляет [#17991](https://github.com/ClickHouse/ClickHouse/issues/17991). [#18285](https://github.com/ClickHouse/ClickHouse/pull/18285) ([徐炘](https://github.com/weeds085490)).
* Обновлён AWS C++ SDK для поддержки глобальных регионов в S3. [#17870](https://github.com/ClickHouse/ClickHouse/pull/17870) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Добавлена поддержка предложения `WITH ... [AND] [PERIODIC] REFRESH [interval_in_sec]` при создании таблиц типа `LIVE VIEW`. [#14822](https://github.com/ClickHouse/ClickHouse/pull/14822) ([vzakaznikov](https://github.com/vzakaznikov)).
* Ограничены запросы `MODIFY TTL` для таблиц `MergeTree`, созданных в старом синтаксисе. Ранее такой запрос успешно выполнялся, но фактически не оказывал никакого эффекта. [#19064](https://github.com/ClickHouse/ClickHouse/pull/19064) ([Anton Popov](https://github.com/CurtizJ)).

#### Исправление ошибки {#bug-fix-8}

* Исправлена ошибка в анализе индексов для бинарных функций с константным аргументом, приводившая к некорректным результатам запросов. Это исправляет [#18364](https://github.com/ClickHouse/ClickHouse/issues/18364). [#18373](https://github.com/ClickHouse/ClickHouse/pull/18373) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка запуска сервера при наличии таблиц с выражениями по умолчанию, содержащими dictGet(). Добавлена возможность получать тип возвращаемого значения dictGet() без загрузки словаря. [#19805](https://github.com/ClickHouse/ClickHouse/pull/19805) ([Vitaly Baranov](https://github.com/vitlibar)).
* Устранено падение сервера при выполнении запроса с функцией `if`, возвращающей тип `Tuple` в качестве результата ветвей then/else, когда `Tuple` содержит `Array` или другой сложный тип. Исправляет [#18356](https://github.com/ClickHouse/ClickHouse/issues/18356). [#20133](https://github.com/ClickHouse/ClickHouse/pull/20133) ([alesapin](https://github.com/alesapin)).
* `MaterializeMySQL` (экспериментальная возможность): исправлена репликация для запросов, обновляющих несколько таблиц. [#20066](https://github.com/ClickHouse/ClickHouse/pull/20066) ([Håvard Kvålen](https://github.com/havardk)).
* Предотвращена ошибка «Connection refused» в Docker во время выполнения инициализационного скрипта. [#20012](https://github.com/ClickHouse/ClickHouse/pull/20012) ([filimonov](https://github.com/filimonov)).
* `EmbeddedRocksDB` — экспериментальное хранилище. Исправлена проблема, связанная с отсутствием корректной проверки типов. Код упрощён. Это исправление закрывает [#19967](https://github.com/ClickHouse/ClickHouse/issues/19967). [#19972](https://github.com/ClickHouse/ClickHouse/pull/19972) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка сегментации в функции `fromModifiedJulianDay`, возникающая при типе аргумента `Nullable(T)` для любого целочисленного типа, отличного от Int32. [#19959](https://github.com/ClickHouse/ClickHouse/pull/19959) ([PHO](https://github.com/depressed-pho)).
* Функция `greatCircleAngle` в предыдущих версиях возвращала неточные значения. Это исправление закрывает [#19769](https://github.com/ClickHouse/ClickHouse/issues/19769). [#19789](https://github.com/ClickHouse/ClickHouse/pull/19789) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена редкая ошибка, из-за которой некоторые реплицируемые операции (такие как `mutation`) не могли обработать отдельные части после повреждения данных. Исправляет [#19593](https://github.com/ClickHouse/ClickHouse/issues/19593). [#19702](https://github.com/ClickHouse/ClickHouse/pull/19702) ([alesapin](https://github.com/alesapin)).
* Фоновый поток, выполняющий запросы `ON CLUSTER`, мог зависнуть, ожидая, что удалённая реплицируемая таблица выполнит какое-либо действие. Это исправлено. [#19684](https://github.com/ClickHouse/ClickHouse/pull/19684) ([yiguolei](https://github.com/yiguolei)).
* Исправлена некорректная десериализация описания столбцов. Она делала невозможным выполнение запроса INSERT в таблицу, содержащую столбец с именем `\`. [#19479](https://github.com/ClickHouse/ClickHouse/pull/19479) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Помечать распределённый пакет как повреждённый, если один из файлов содержит пустой блок данных. [#19449](https://github.com/ClickHouse/ClickHouse/pull/19449) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена крайне редкая ошибка, из-за которой мутация могла зависнуть после `DROP/DETACH/REPLACE/MOVE PARTITION`. Она была частично исправлена в [#15537](https://github.com/ClickHouse/ClickHouse/issues/15537) для большинства случаев. [#19443](https://github.com/ClickHouse/ClickHouse/pull/19443) ([tavplubix](https://github.com/tavplubix)).
* Исправлена потенциальная ошибка `Extremes transform was already added to pipeline`. Исправляет [#14100](https://github.com/ClickHouse/ClickHouse/issues/14100). [#19430](https://github.com/ClickHouse/ClickHouse/pull/19430) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено значение по умолчанию в типах JOIN с ненулевым значением по умолчанию (например, для некоторых Enum). Закрывает [#18197](https://github.com/ClickHouse/ClickHouse/issues/18197). [#19360](https://github.com/ClickHouse/ClickHouse/pull/19360) ([vdimir](https://github.com/vdimir)).
* Не помечать файл для распределённой отправки как повреждённый при достижении конца файла (EOF). [#19290](https://github.com/ClickHouse/ClickHouse/pull/19290) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена утечка файлового дескриптора канала (pipe) для `async_socket_for_remote`. [#19153](https://github.com/ClickHouse/ClickHouse/pull/19153) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено бесконечное чтение из файла в формате `ORC` (регрессия появилась в [#10580](https://github.com/ClickHouse/ClickHouse/issues/10580)). Устранена проблема [#19095](https://github.com/ClickHouse/ClickHouse/issues/19095). [#19134](https://github.com/ClickHouse/ClickHouse/pull/19134) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена проблема в модуле записи данных MergeTree, которая могла приводить к созданию меток большего размера, чем фиксированный размер гранулярности. Устраняет проблему [#18913](https://github.com/ClickHouse/ClickHouse/issues/18913). [#19123](https://github.com/ClickHouse/ClickHouse/pull/19123) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка при запуске, из-за которой ClickHouse не удавалось прочитать кодек сжатия из `LowCardinality(Nullable(...))`, что приводило к исключению `Attempt to read after EOF`. Исправляет [#18340](https://github.com/ClickHouse/ClickHouse/issues/18340). [#19101](https://github.com/ClickHouse/ClickHouse/pull/19101) ([alesapin](https://github.com/alesapin)).
* Упрощена реализация `tupleHammingDistance`. Добавлена поддержка кортежей произвольной, но одинаковой длины. Исправлена проблема [#19029](https://github.com/ClickHouse/ClickHouse/issues/19029). [#19084](https://github.com/ClickHouse/ClickHouse/pull/19084) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Теперь `groupUniqArray` возвращает корректный тип для аргумента типа Enum. Это закрывает [#17875](https://github.com/ClickHouse/ClickHouse/issues/17875). [#19019](https://github.com/ClickHouse/ClickHouse/pull/19019) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена возможная ошибка `Expected single dictionary argument for function` при использовании функции `ignore` с аргументом типа `LowCardinality`. Устраняет проблему [#14275](https://github.com/ClickHouse/ClickHouse/issues/14275). [#19016](https://github.com/ClickHouse/ClickHouse/pull/19016) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена проблема вставки столбца `LowCardinality` в таблицу с движком `TinyLog`. Устраняет [#18629](https://github.com/ClickHouse/ClickHouse/issues/18629). [#19010](https://github.com/ClickHouse/ClickHouse/pull/19010) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена небольшая проблема в операторе JOIN: он пытается материализовать константные столбцы, но наш код ожидает их в других местах. [#18982](https://github.com/ClickHouse/ClickHouse/pull/18982) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Отключена оптимизация `optimize_move_functions_out_of_any`, поскольку она не всегда корректна. Закрывает [#18051](https://github.com/ClickHouse/ClickHouse/issues/18051). Закрывает [#18973](https://github.com/ClickHouse/ClickHouse/issues/18973). [#18981](https://github.com/ClickHouse/ClickHouse/pull/18981) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Устранено возможное исключение `QueryPipeline stream: different number of columns`, возникавшее при объединении шагов `Expression` в плане запроса. Исправлено [#18190](https://github.com/ClickHouse/ClickHouse/issues/18190). [#18980](https://github.com/ClickHouse/ClickHouse/pull/18980) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена очень редкая взаимоблокировка при завершении работы. [#18977](https://github.com/ClickHouse/ClickHouse/pull/18977) ([tavplubix](https://github.com/tavplubix)).
* Исправлены редкие сбои при исчерпании оперативной памяти на сервере. [#18976](https://github.com/ClickHouse/ClickHouse/pull/18976) ([tavplubix](https://github.com/tavplubix)).
* Исправлено некорректное поведение, при котором запрос `ALTER TABLE ... DROP PART 'part_name'` приводил к удалению всех блоков дедупликации во всей партиции. Исправляет [#18874](https://github.com/ClickHouse/ClickHouse/issues/18874). [#18969](https://github.com/ClickHouse/ClickHouse/pull/18969) ([alesapin](https://github.com/alesapin)).
* Исправлена проблема [#18894](https://github.com/ClickHouse/ClickHouse/issues/18894): добавлена проверка, чтобы избежать исключения, когда длинный алиас столбца (в стиле &#39;table.column&#39;, обычно автоматически сгенерированный BI-инструментами вроде Looker) совпадает с длинным именем таблицы. [#18968](https://github.com/ClickHouse/ClickHouse/pull/18968) ([Daniel Qin](https://github.com/mathfool)).
* Исправлена ошибка `Task was not found in task queue` (которая могла возникать только для удалённых запросов при `async_socket_for_remote = 1`). [#18964](https://github.com/ClickHouse/ClickHouse/pull/18964) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, из-за которой мутация с некоторым экранированным текстом (например, `ALTER ... UPDATE e = CAST('foo', 'Enum8(\'foo\' = 1')`) сериализовывалась некорректно. Исправляет [#18878](https://github.com/ClickHouse/ClickHouse/issues/18878). [#18944](https://github.com/ClickHouse/ClickHouse/pull/18944) ([alesapin](https://github.com/alesapin)).
* ATTACH PARTITION теперь сбрасывает мутации. [#18804](https://github.com/ClickHouse/ClickHouse/issues/18804). [#18935](https://github.com/ClickHouse/ClickHouse/pull/18935) ([fastio](https://github.com/fastio)).
* Исправлена проблема с `bitmapOrCardinality`, которая могла приводить к разыменованию нулевого указателя. Это закрывает [#18911](https://github.com/ClickHouse/ClickHouse/issues/18911). [#18912](https://github.com/ClickHouse/ClickHouse/pull/18912) ([sundyli](https://github.com/sundy-li)).
* Исправлена ошибка `Attempt to read after eof` при попытке привести `NULL` из `Nullable(String)` к `Nullable(Decimal(P, S))`. Теперь функция `CAST` возвращает `NULL`, когда не может разобрать десятичное число из nullable-строки. Исправляет [#7690](https://github.com/ClickHouse/ClickHouse/issues/7690). [#18718](https://github.com/ClickHouse/ClickHouse/pull/18718) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена проблема преобразования типов данных для движка MySQL. [#18124](https://github.com/ClickHouse/ClickHouse/pull/18124) ([bo zeng](https://github.com/mis98zb)).
* Исправлено исключение, приводившее к аварийному завершению clickhouse-client при выполнении только `select`. [#19790](https://github.com/ClickHouse/ClickHouse/pull/19790) ([taiyang-li](https://github.com/taiyang-li)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-9}

* Запуск [SQLancer](https://twitter.com/RiggerManuel/status/1352345625480884228) (логический fuzzer SQL) в CI. [#19006](https://github.com/ClickHouse/ClickHouse/pull/19006) ([Ilya Yatsishin](https://github.com/qoega)).
* Query Fuzzer будет более активно выполнять фуззинг недавно добавленных тестов. Закрывает [#18916](https://github.com/ClickHouse/ClickHouse/issues/18916). [#19185](https://github.com/ClickHouse/ClickHouse/pull/19185) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Интеграция с [Big List of Naughty Strings](https://github.com/minimaxir/big-list-of-naughty-strings/) для улучшения фуззинга. [#19480](https://github.com/ClickHouse/ClickHouse/pull/19480) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлены интеграционные тесты, выполняемые с MSan. [#18974](https://github.com/ClickHouse/ClickHouse/pull/18974) ([alesapin](https://github.com/alesapin)).
* Исправлены ошибки MemorySanitizer в cyrus-sasl и musl. [#19821](https://github.com/ClickHouse/ClickHouse/pull/19821) ([Ilya Yatsishin](https://github.com/qoega)).
* Проверка на недостаточное количество аргументов в функции `positionCaseInsensitiveUTF8` вызывала срабатывание AddressSanitizer. [#19720](https://github.com/ClickHouse/ClickHouse/pull/19720) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Удалён параметр --project-directory для docker-compose в интеграционных тестах. Исправлено форматирование логов из docker-контейнера. [#19706](https://github.com/ClickHouse/ClickHouse/pull/19706) ([Ilya Yatsishin](https://github.com/qoega)).
* Упрощена генерация macros.xml для интеграционных тестов. Больше нет избыточного логирования из dicttoxml. Проект dicttoxml неактивен более 5 лет. [#19697](https://github.com/ClickHouse/ClickHouse/pull/19697) ([Ilya Yatsishin](https://github.com/qoega)).
* Добавлена возможность явно включать или отключать watchdog через переменную окружения `CLICKHOUSE_WATCHDOG_ENABLE`. По умолчанию он включён, если сервер не присоединён к терминалу. [#19522](https://github.com/ClickHouse/ClickHouse/pull/19522) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность собирать ClickHouse с поддержкой Kafka на arm64. [#19369](https://github.com/ClickHouse/ClickHouse/pull/19369) ([filimonov](https://github.com/filimonov)).
* Добавлена возможность собирать librdkafka без SSL. [#19337](https://github.com/ClickHouse/ClickHouse/pull/19337) ([filimonov](https://github.com/filimonov)).
* Восстановлена поддержка ввода из Kafka в сборках для FreeBSD. [#18924](https://github.com/ClickHouse/ClickHouse/pull/18924) ([Alexandre Snarskii](https://github.com/snar)).
* Исправлено потенциальное разыменование nullptr в табличной функции `VALUES`. [#19357](https://github.com/ClickHouse/ClickHouse/pull/19357) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Предотвращены срабатывания UBSan в функции `arrayElement`, а также в `substring` и `arraySum`. Исправляет [#19305](https://github.com/ClickHouse/ClickHouse/issues/19305). Исправляет [#19287](https://github.com/ClickHouse/ClickHouse/issues/19287). Закрывает [#19336](https://github.com/ClickHouse/ClickHouse/issues/19336). [#19347](https://github.com/ClickHouse/ClickHouse/pull/19347) ([alexey-milovidov](https://github.com/alexey-milovidov)).

## Релиз ClickHouse 21.1 {#clickhouse-release-211}

### Релиз ClickHouse v21.1.3.32-stable, 2021-02-03 {#clickhouse-release-v211332-stable-2021-02-03}

#### Исправление ошибок {#bug-fix-9}

* Исправлен сбой индекса BloomFilter. Исправляет [#19757](https://github.com/ClickHouse/ClickHouse/issues/19757). [#19884](https://github.com/ClickHouse/ClickHouse/pull/19884) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлено аварийное завершение при проталкивании предикатов в подзапрос с `UNION DISTINCT`. Это исправляет [#19855](https://github.com/ClickHouse/ClickHouse/issues/19855). [#19861](https://github.com/ClickHouse/ClickHouse/pull/19861) ([Amos Bird](https://github.com/amosbird)).
* Исправлена фильтрация по значениям типа UInt8, превышающим 127. [#19799](https://github.com/ClickHouse/ClickHouse/pull/19799) ([Anton Popov](https://github.com/CurtizJ)).
* В предыдущих версиях нестандартные аргументы для функции arrayEnumerateUniq могли приводить к аварийному завершению или бесконечному циклу. Это исправление закрывает [#19787](https://github.com/ClickHouse/ClickHouse/issues/19787). [#19788](https://github.com/ClickHouse/ClickHouse/pull/19788) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено переполнение стека при использовании точного сравнения арифметического типа со строковым типом. [#19773](https://github.com/ClickHouse/ClickHouse/pull/19773) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка, вызывавшая сбой при использовании имени вложенного столбца в `WHERE` или `PREWHERE`. Исправляет [#19755](https://github.com/ClickHouse/ClickHouse/issues/19755). [#19763](https://github.com/ClickHouse/ClickHouse/pull/19763) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка сегментации в функции `bitmapAndnot`. Исправлена проблема [#19668](https://github.com/ClickHouse/ClickHouse/issues/19668). [#19713](https://github.com/ClickHouse/ClickHouse/pull/19713) ([Maksim Kita](https://github.com/kitaisreal)).
* Некоторые функции, работающие с большими целыми числами, могут приводить к segfault. Большие целые числа — экспериментальная возможность. Это закрывает [#19667](https://github.com/ClickHouse/ClickHouse/issues/19667). [#19672](https://github.com/ClickHouse/ClickHouse/pull/19672) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена некорректная работа функции `neighbor` с аргументом `LowCardinality`. Исправляет [#10333](https://github.com/ClickHouse/ClickHouse/issues/10333). [#19617](https://github.com/ClickHouse/ClickHouse/pull/19617) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено использование освобождённого CompressedWriteBuffer в Connection после отключения. [#19599](https://github.com/ClickHouse/ClickHouse/pull/19599) ([Azat Khuzhin](https://github.com/azat)).
* Запрос `DROP/DETACH TABLE table ON CLUSTER cluster SYNC` мог зависать, теперь это исправлено. Исправление для [#19568](https://github.com/ClickHouse/ClickHouse/issues/19568). [#19572](https://github.com/ClickHouse/ClickHouse/pull/19572) ([tavplubix](https://github.com/tavplubix)).
* Исправлена обработка выражения id в запросе CREATE DICTIONARY. [#19571](https://github.com/ClickHouse/ClickHouse/pull/19571) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена ошибка SIGSEGV при значениях `merge_tree_min_rows_for_concurrent_read`/`merge_tree_min_bytes_for_concurrent_read`, равных 0/`UINT64_MAX`. [#19528](https://github.com/ClickHouse/ClickHouse/pull/19528) ([Azat Khuzhin](https://github.com/azat)).
* Переполнение буфера (при чтении из памяти) могло произойти, если функция `addMonth` вызывалась со специально подобранными аргументами. Это исправляет [#19441](https://github.com/ClickHouse/ClickHouse/issues/19441). Это исправляет [#19413](https://github.com/ClickHouse/ClickHouse/issues/19413). [#19472](https://github.com/ClickHouse/ClickHouse/pull/19472) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Было возможно чтение неинициализированной памяти в функциях encrypt/decrypt при передаче пустой строки в качестве IV (инициализационного вектора). Это закрывает [#19391](https://github.com/ClickHouse/ClickHouse/issues/19391). [#19397](https://github.com/ClickHouse/ClickHouse/pull/19397) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено потенциальное переполнение буфера в библиотеке Uber H3. См. [https://github.com/uber/h3/issues/392](https://github.com/uber/h3/issues/392). Это закрывает [#19219](https://github.com/ClickHouse/ClickHouse/issues/19219). [#19383](https://github.com/ClickHouse/ClickHouse/pull/19383) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен столбец system.parts&#95;state (ошибка LOGICAL&#95;ERROR при запросе этого столбца из-за некорректного порядка). [#19346](https://github.com/ClickHouse/ClickHouse/pull/19346) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено потенциальное получение некорректного результата или segfault при агрегации, если материализованное представление и его целевая таблица имеют разную структуру. Исправление для [#18063](https://github.com/ClickHouse/ClickHouse/issues/18063). [#19322](https://github.com/ClickHouse/ClickHouse/pull/19322) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка `Cannot convert column now64() because it is constant but values of constants are different in source and result`. Продолжение задачи [#7156](https://github.com/ClickHouse/ClickHouse/issues/7156). [#19316](https://github.com/ClickHouse/ClickHouse/pull/19316) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, из-за которой одновременные запросы `ALTER` и `DROP` могли зависать при обработке таблицы ReplicatedMergeTree. [#19237](https://github.com/ClickHouse/ClickHouse/pull/19237) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка `There is no checkpoint` при вставке данных через HTTP-интерфейс с использованием формата `Template` или `CustomSeparated`. Исправлено [#19021](https://github.com/ClickHouse/ClickHouse/issues/19021). [#19072](https://github.com/ClickHouse/ClickHouse/pull/19072) ([tavplubix](https://github.com/tavplubix)).
* Отключено свёртывание констант в подзапросах на этапе анализа, если результат не может быть вычислен. [#18446](https://github.com/ClickHouse/ClickHouse/pull/18446) ([Azat Khuzhin](https://github.com/azat)).
* Мутация могла зависать в ожидании несуществующей части после `MOVE` или `REPLACE PARTITION` или, в редких случаях, после `DETACH` или `DROP PARTITION`. Проблема исправлена. [#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix)).

### Релиз ClickHouse v21.1.2.15-stable 2021-01-18 {#clickhouse-release-v211215-stable-2021-01-18}

#### Обратно несовместимые изменения {#backward-incompatible-change-10}

* Настройка `input_format_null_as_default` включена по умолчанию. [#17525](https://github.com/ClickHouse/ClickHouse/pull/17525) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена проверка ограничений для настроек профилей из конфигурации. Сервер не запустится, если users.xml содержит настройки, которые не удовлетворяют соответствующим ограничениям. [#18486](https://github.com/ClickHouse/ClickHouse/pull/18486) ([tavplubix](https://github.com/tavplubix)).
* Ограничено использование `ALTER MODIFY SETTING` для изменения настроек хранения, влияющих на части данных (`write_final_mark` и `enable_mixed_granularity_parts`). [#18306](https://github.com/ClickHouse/ClickHouse/pull/18306) ([Amos Bird](https://github.com/amosbird)).
* Значение `insert_quorum_parallel` по умолчанию установлено в 1. Это значительно удобнее в использовании, чем «последовательные» кворумные вставки. Но если вы полагаетесь на последовательную согласованность, следует вернуть значение настройки обратно в ноль. [#17567](https://github.com/ClickHouse/ClickHouse/pull/17567) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Удалена функция `sumburConsistentHash`. Это закрывает [#18120](https://github.com/ClickHouse/ClickHouse/issues/18120). [#18656](https://github.com/ClickHouse/ClickHouse/pull/18656) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Удалены агрегатные функции `timeSeriesGroupSum`, `timeSeriesGroupRateSum`, потому что один мой знакомый сказал, что они никогда не работали. Это исправляет [#16869](https://github.com/ClickHouse/ClickHouse/issues/16869). Если вам всё же удалось успешно использовать эти функции, напишите письмо на feedback@clickhouse.com. [#17423](https://github.com/ClickHouse/ClickHouse/pull/17423) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Запрещён вызов `toUnixTimestamp(Date())` (раньше он просто возвращал представление Date в виде UInt16). [#17376](https://github.com/ClickHouse/ClickHouse/pull/17376) ([Azat Khuzhin](https://github.com/azat)).
* Разрешено использовать расширенные целочисленные типы (`Int128`, `Int256`, `UInt256`) в функциях `avg` и `avgWeighted`. Также разрешено использовать разные типы (целочисленный, десятичный, с плавающей запятой) для значения и для веса в функции `avgWeighted`. Это обратно несовместимое изменение: теперь функции `avg` и `avgWeighted` всегда возвращают `Float64` (как задокументировано). До этого изменения типом результата для аргументов типа `Decimal` также был `Decimal`. [#15419](https://github.com/ClickHouse/ClickHouse/pull/15419) ([Mike](https://github.com/myrrc)).
* Выражение `toUUID(N)` больше не работает. Замените его на `toUUID('00000000-0000-0000-0000-000000000000')`. Это изменение обусловлено неочевидными результатами `toUUID(N)`, где N не равно нулю.
* SSL-сертификаты с некорректным значением "key usage" отклоняются. В предыдущих версиях они продолжали работать. См. [#19262](https://github.com/ClickHouse/ClickHouse/issues/19262).
* Ссылки `incl` на файл подстановок (`/etc/metrika.xml`) были удалены из конфигурации по умолчанию (`<remote_servers>`, `<zookeeper>`, `<macros>`, `<compression>`, `<networks>`). Если вы использовали файл подстановок и полагались на эти неявные ссылки, вам следует добавить их обратно вручную и явно, добавив соответствующие секции с атрибутами `incl="..."` перед обновлением. См. [#18740](https://github.com/ClickHouse/ClickHouse/pull/18740) ([alexey-milovidov](https://github.com/alexey-milovidov)).

#### Новая функциональность {#new-feature-10}

* Реализована поддержка протокола gRPC в ClickHouse. [#15111](https://github.com/ClickHouse/ClickHouse/pull/15111) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена возможность использования нескольких кластеров ZooKeeper. [#17070](https://github.com/ClickHouse/ClickHouse/pull/17070) ([fastio](https://github.com/fastio)).
* Добавлена поддержка запросов `REPLACE TABLE` и `CREATE OR REPLACE TABLE`. [#18521](https://github.com/ClickHouse/ClickHouse/pull/18521) ([tavplubix](https://github.com/tavplubix)).
* Реализовать `UNION DISTINCT` и по умолчанию трактовать простой оператор `UNION` как `UNION DISTINCT`. Добавить настройку `union_default_mode`, которая позволяет рассматривать его как `UNION ALL` или требовать явного указания режима. [#16338](https://github.com/ClickHouse/ClickHouse/pull/16338) ([flynn](https://github.com/ucasFL)).
* Добавлена функция `accurateCastOrNull`. Это закрывает [#10290](https://github.com/ClickHouse/ClickHouse/issues/10290). Добавлены преобразования типов в выражениях вида `x IN (subquery)`. Это закрывает [#10266](https://github.com/ClickHouse/ClickHouse/issues/10266). [#16724](https://github.com/ClickHouse/ClickHouse/pull/16724) ([Maksim Kita](https://github.com/kitaisreal)).
* Словарь IP-адресов напрямую поддерживает типы `IPv4` / `IPv6`. [#17571](https://github.com/ClickHouse/ClickHouse/pull/17571) ([vdimir](https://github.com/vdimir)).
* Словарь IP теперь поддерживает выборку по ключам. Это исправляет [#18241](https://github.com/ClickHouse/ClickHouse/issues/18241). [#18480](https://github.com/ClickHouse/ClickHouse/pull/18480) ([vdimir](https://github.com/vdimir)).
* Добавлена поддержка сжатия и распаковки `*.zst` для импорта и экспорта данных. Теперь можно использовать `*.zst` в функции `file()` и `Content-encoding: zstd` в HTTP‑клиенте. Тем самым закрывается задача [#16791](https://github.com/ClickHouse/ClickHouse/issues/16791). [#17144](https://github.com/ClickHouse/ClickHouse/pull/17144) ([Abi Palagashvili](https://github.com/fibersel)).
* Добавлены агрегатные функции `mannWitneyUTest`, `studentTTest` и `welchTTest`. Немного отрефакторена функция `rankCorr`. [#16883](https://github.com/ClickHouse/ClickHouse/pull/16883) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлены функции `countMatches`/`countMatchesCaseInsensitive`. [#17459](https://github.com/ClickHouse/ClickHouse/pull/17459) ([Azat Khuzhin](https://github.com/azat)).
* Реализованы функции `countSubstrings()`/`countSubstringsCaseInsensitive()`/`countSubstringsCaseInsensitiveUTF8()` (подсчёт количества вхождений подстроки). [#17347](https://github.com/ClickHouse/ClickHouse/pull/17347) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена информация об используемых базах данных, таблицах и столбцах в таблице system.query&#95;log. Добавлены поля `query_kind` и `normalized_query_hash`. [#17726](https://github.com/ClickHouse/ClickHouse/pull/17726) ([Amos Bird](https://github.com/amosbird)).
* Добавлена настройка `optimize_on_insert`. При включении для вставляемого блока данных выполняется то же преобразование, как если бы над этим блоком было выполнено слияние (например, Replacing, Collapsing, Aggregating...). Эта настройка включена по умолчанию. Она может повлиять на поведение материализованных представлений и MaterializeMySQL (см. подробное описание). Тем самым закрывается [#10683](https://github.com/ClickHouse/ClickHouse/issues/10683). [#16954](https://github.com/ClickHouse/ClickHouse/pull/16954) ([Kruglov Pavel](https://github.com/Avogar)).
* Аутентификация по Kerberos для HDFS. [#16621](https://github.com/ClickHouse/ClickHouse/pull/16621) ([Ilya Golshtein](https://github.com/ilejn)).
* Добавлена поддержка оператора `SHOW SETTINGS` для вывода параметров из system.settings. Также поддерживаются оператор `SHOW CHANGED SETTINGS` и условие `LIKE/ILIKE`. [#18056](https://github.com/ClickHouse/ClickHouse/pull/18056) ([Jianmei Zhang](https://github.com/zhangjmruc)).
* Функция `position` теперь поддерживает синтаксис `POSITION(needle IN haystack)` для обеспечения совместимости с SQL. Это закрывает [#18701](https://github.com/ClickHouse/ClickHouse/issues/18701). ... [#18779](https://github.com/ClickHouse/ClickHouse/pull/18779) ([Jianmei Zhang](https://github.com/zhangjmruc)).
* Теперь для таблиц семейства MergeTree появилась новая настройка хранилища `max_partitions_to_read`. Она ограничивает максимальное число партиций, которые могут быть прочитаны в одном запросе. Также добавлена пользовательская настройка `force_max_partition_limit` для жёсткого применения этого ограничения. [#18712](https://github.com/ClickHouse/ClickHouse/pull/18712) ([Amos Bird](https://github.com/amosbird)).
* Добавлен столбец `query_id` в `system.part_log` для вставленных частей. Закрывает [#10097](https://github.com/ClickHouse/ClickHouse/issues/10097). [#18644](https://github.com/ClickHouse/ClickHouse/pull/18644) ([flynn](https://github.com/ucasFL)).
* Добавлена возможность использовать `CREATE TABLE AS SELECT` с явным указанием столбцов. Пример: `CREATE TABLE t1 (x String) ENGINE = Memory AS SELECT 1;`. [#18060](https://github.com/ClickHouse/ClickHouse/pull/18060) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлены агрегатные функции `arrayMin`, `arrayMax`, `arrayAvg`. [#18032](https://github.com/ClickHouse/ClickHouse/pull/18032) ([Maksim Kita](https://github.com/kitaisreal)).
* Реализован запрос `ATTACH TABLE name FROM 'path/to/data/' (col1 Type1, ...`. Он создаёт новую таблицу с указанной структурой и присоединяет к ней данные из указанного каталога в `user_files`. [#17903](https://github.com/ClickHouse/ClickHouse/pull/17903) ([tavplubix](https://github.com/tavplubix)).
* Добавлена поддержка мутаций для StorageMemory, что закрывает задачу [#9117](https://github.com/ClickHouse/ClickHouse/issues/9117). [#15127](https://github.com/ClickHouse/ClickHouse/pull/15127) ([flynn](https://github.com/ucasFL)).
* Поддерживается синтаксис `EXISTS DATABASE name`. [#18458](https://github.com/ClickHouse/ClickHouse/pull/18458) ([Du Chuan](https://github.com/spongedu)).
* Добавлена поддержка встроенных функций `isIPv4String` &amp;&amp; `isIPv6String`, как в [MySQL](https://github.com/ClickHouse/ClickHouse/compare/master...spongedu:support_is_ipv4?expand=1). [#18349](https://github.com/ClickHouse/ClickHouse/pull/18349) ([Du Chuan](https://github.com/spongedu)).
* Добавлена новая настройка `insert_distributed_one_random_shard = 1`, позволяющая выполнять вставку в многошардовую распределённую таблицу без распределяющего ключа. [#18294](https://github.com/ClickHouse/ClickHouse/pull/18294) ([Amos Bird](https://github.com/amosbird)).
* Добавлены настройки `min_compress_block_size` и `max_compress_block_size` в MergeTreeSettings, которые имеют приоритет над глобальными настройками и применяются при их установке. Закрывает [13890](https://github.com/ClickHouse/ClickHouse/issues/13890). [#17867](https://github.com/ClickHouse/ClickHouse/pull/17867) ([flynn](https://github.com/ucasFL)).
* Добавлена поддержка 64-битных roaring-битмапов. [#17858](https://github.com/ClickHouse/ClickHouse/pull/17858) ([Andy Yang](https://github.com/andyyzh)).
* Расширен синтаксис `OPTIMIZE ... DEDUPLICATE`, что позволяет задавать явный (или неявный с помощью звёздочки/трансформеров столбцов) список столбцов, по которым выполняется проверка на дубликаты. ... [#17846](https://github.com/ClickHouse/ClickHouse/pull/17846) ([Vasily Nemkov](https://github.com/Enmk)).
* Добавлены функции `toModifiedJulianDay`, `fromModifiedJulianDay`, `toModifiedJulianDayOrNull` и `fromModifiedJulianDayOrNull`. Эти функции преобразуют дату в пролептическом григорианском календаре в число модифицированного юлианского дня и обратно. [#17750](https://github.com/ClickHouse/ClickHouse/pull/17750) ([PHO](https://github.com/depressed-pho)).
* Добавлена возможность использовать пользовательский список доменов верхнего уровня (TLD): добавлены функции `firstSignificantSubdomainCustom`, `cutToFirstSignificantSubdomainCustom`. [#17748](https://github.com/ClickHouse/ClickHouse/pull/17748) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка протокола `PROXYv1` для инкапсуляции нативного TCP-интерфейса. Добавлена возможность привязывать квоты к IP-адресу, переданному прокси (применяется для адреса из `PROXYv1` и для `X-Forwarded-For` из HTTP-интерфейса). Это полезно, если вы предоставляете доступ к ClickHouse только через доверенный прокси (например, CloudFlare), но хотите учитывать потребление ресурсов пользователями по их исходным IP-адресам. Этим исправляется [#17268](https://github.com/ClickHouse/ClickHouse/issues/17268). [#17707](https://github.com/ClickHouse/ClickHouse/pull/17707) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Теперь clickhouse-client поддерживает открытие редактора, заданного в переменной окружения `EDITOR`, для редактирования команд. `Alt-Shift-E`. [#17665](https://github.com/ClickHouse/ClickHouse/pull/17665) ([Amos Bird](https://github.com/amosbird)).
* Добавлена функция `encodeXMLComponent` для экранирования символов при помещении строки в текстовый узел или атрибут XML. [#17659](https://github.com/ClickHouse/ClickHouse/pull/17659) ([nauta](https://github.com/nautaa)).
* Введён синтаксис `DETACH TABLE/VIEW ... PERMANENTLY`, чтобы после перезапуска таблица не появлялась снова автоматически (только по явному запросу). Таблицу по-прежнему можно снова присоединить, используя короткий синтаксис ATTACH TABLE. Реализует [#5555](https://github.com/ClickHouse/ClickHouse/issues/5555). Исправляет [#13850](https://github.com/ClickHouse/ClickHouse/issues/13850). [#17642](https://github.com/ClickHouse/ClickHouse/pull/17642) ([filimonov](https://github.com/filimonov)).
* Добавлены асинхронные метрики общего количества строк, байт и частей в таблицах MergeTree. Исправляет [#11714](https://github.com/ClickHouse/ClickHouse/issues/11714). [#17639](https://github.com/ClickHouse/ClickHouse/pull/17639) ([flynn](https://github.com/ucasFL)).
* Добавлены настройки `limit` и `offset` для пагинации вне SQL-запроса: [#16176](https://github.com/ClickHouse/ClickHouse/issues/16176). Они полезны для построения API. Эти две настройки будут влиять на запрос SELECT так, как если бы он выполнялся как `select * from (your_original_select_query) t limit xxx offset xxx;`. [#17633](https://github.com/ClickHouse/ClickHouse/pull/17633) ([hexiaoting](https://github.com/hexiaoting)).
* Добавлен новый комбинатор агрегатной функции: `-SimpleState` для построения типов `SimpleAggregateFunction` в запросе. Он полезен для определения MaterializedView движка AggregatingMergeTree и также будет полезен для проекций. [#16853](https://github.com/ClickHouse/ClickHouse/pull/16853) ([Amos Bird](https://github.com/amosbird)).
* Добавлен параметр `queries-file` для `clickhouse-client` и `clickhouse-local`. [#15930](https://github.com/ClickHouse/ClickHouse/pull/15930) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлен параметр `query` в утилиту `clickhouse-benchmark`. [#17832](https://github.com/ClickHouse/ClickHouse/pull/17832) ([Maksim Kita](https://github.com/kitaisreal)).
* `EXPLAIN AST` теперь поддерживает запросы не только типа `SELECT`. [#18136](https://github.com/ClickHouse/ClickHouse/pull/18136) ([taiyang-li](https://github.com/taiyang-li)).

#### Экспериментальные возможности {#experimental-feature-8}

* Добавлены функции для вычисления minHash и simHash текстовых n-грамм и шинглов. Они предназначены для поиска частичных дубликатов. Также добавлены функции `bitHammingDistance` и `tupleHammingDistance`. [#7649](https://github.com/ClickHouse/ClickHouse/pull/7649) ([flynn](https://github.com/ucasFL)).
* Добавлен новый тип данных `Map`. См. [#1841](https://github.com/ClickHouse/ClickHouse/issues/1841). Первая версия типа Map поддерживает только значения типа `String` в качестве ключей и значений. [#15806](https://github.com/ClickHouse/ClickHouse/pull/15806) ([hexiaoting](https://github.com/hexiaoting)).
* Реализован альтернативный SQL-парсер, основанный на ANTLR4 runtime и сгенерированный из EBNF-грамматики. [#11298](https://github.com/ClickHouse/ClickHouse/pull/11298) ([Ivan](https://github.com/abyss7)).

#### Улучшение производительности {#performance-improvement-10}

* Новая реализация словаря IP-адресов с меньшим потреблением памяти, улучшенной производительностью в некоторых случаях и исправленными ошибками. [#16804](https://github.com/ClickHouse/ClickHouse/pull/16804) ([vdimir](https://github.com/vdimir)).
* Параллельное форматирование при экспорте данных. [#11617](https://github.com/ClickHouse/ClickHouse/pull/11617) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Интеграция с LDAP: Добавлен параметр `verification_cooldown` в конфигурацию подключения к серверу LDAP, позволяющий кэшировать успешные операции `bind` на настраиваемый период времени. [#15988](https://github.com/ClickHouse/ClickHouse/pull/15988) ([Denis Glazachev](https://github.com/traceon)).
* Добавлена опция `--no-system-table` для `clickhouse-local` для запуска без системных таблиц. Это позволяет избежать инициализации `DateLUT`, которая при старте может занимать заметное время (десятки миллисекунд). [#18899](https://github.com/ClickHouse/ClickHouse/pull/18899) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Замените `PODArray` на `PODArrayWithStackMemory` в `AggregateFunctionWindowFunnelData`, чтобы повысить производительность функции `windowFunnel`. [#18817](https://github.com/ClickHouse/ClickHouse/pull/18817) ([flynn](https://github.com/ucasFL)).
* Не отправлять пустые блоки на шарды при синхронной вставке (INSERT) в таблицу типа Distributed. Это закрывает [#14571](https://github.com/ClickHouse/ClickHouse/issues/14571). [#18775](https://github.com/ClickHouse/ClickHouse/pull/18775) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Оптимизировано чтение в движке StorageMemory. [#18052](https://github.com/ClickHouse/ClickHouse/pull/18052) ([Maksim Kita](https://github.com/kitaisreal)).
* Для преобразования чисел с плавающей запятой в строки вместо ryu теперь используется алгоритм Dragonbox. Это значительно повышает производительность такого преобразования. [#17831](https://github.com/ClickHouse/ClickHouse/pull/17831) ([Maksim Kita](https://github.com/kitaisreal)).
* Ускорена реализация `IPv6CIDRToRange`. [#17569](https://github.com/ClickHouse/ClickHouse/pull/17569) ([vdimir](https://github.com/vdimir)).
* Добавлена настройка `remerge_sort_lowered_memory_bytes_ratio` (если использование памяти после повторной сортировки не снижается как минимум на этот коэффициент, повторная сортировка будет отключена). [#17539](https://github.com/ClickHouse/ClickHouse/pull/17539) ([Azat Khuzhin](https://github.com/azat)).
* Улучшена производительность AggregatingMergeTree с SimpleAggregateFunction(String) в составе первичного ключа. [#17109](https://github.com/ClickHouse/ClickHouse/pull/17109) ([Azat Khuzhin](https://github.com/azat)).
* Теперь комбинатор `-If` девиртуализирован, а `count` корректно векторизован. Эти изменения относятся к [этому PR](https://github.com/ClickHouse/ClickHouse/pull/17041). [#17043](https://github.com/ClickHouse/ClickHouse/pull/17043) ([Amos Bird](https://github.com/amosbird)).
* Исправлена проблема с производительностью чтения из таблиц `Merge` при работе с очень большим числом таблиц `MergeTree`. Исправляет [#7748](https://github.com/ClickHouse/ClickHouse/issues/7748). [#16988](https://github.com/ClickHouse/ClickHouse/pull/16988) ([Anton Popov](https://github.com/CurtizJ)).
* Улучшена производительность функции `repeat`. [#16937](https://github.com/ClickHouse/ClickHouse/pull/16937) ([satanson](https://github.com/satanson)).
* Незначительно улучшена производительность парсинга чисел с плавающей запятой. [#16809](https://github.com/ClickHouse/ClickHouse/pull/16809) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена возможность пропускать уже объединённые партиции для `OPTIMIZE TABLE ... FINAL`. [#15939](https://github.com/ClickHouse/ClickHouse/pull/15939) ([Kruglov Pavel](https://github.com/Avogar)).
* Интегрирована библиотека [fast&#95;float от Daniel Lemire](https://github.com/lemire/fast_float) для парсинга чисел с плавающей запятой. [#16787](https://github.com/ClickHouse/ClickHouse/pull/16787) ([Maksim Kita](https://github.com/kitaisreal)). Она не включена по умолчанию, так как её производительность всё ещё ниже, чем у базового парсера чисел с плавающей запятой в ClickHouse.
* Исправлена настройка max&#95;distributed&#95;connections (она влияет на `prefer_localhost_replica = 1` и `max_threads != max_distributed_connections`). [#17848](https://github.com/ClickHouse/ClickHouse/pull/17848) ([Azat Khuzhin](https://github.com/azat)).
* Адаптивный выбор загрузки данных в S3 одной или несколькими частями. Режим загрузки одной частью управляется новой настройкой `max_single_part_upload_size`. [#17934](https://github.com/ClickHouse/ClickHouse/pull/17934) ([Pavel Kovalenko](https://github.com/Jokser)).
* Поддержка асинхронных задач в `PipelineExecutor`. Базовая поддержка асинхронных сокетов для удалённых запросов. [#17868](https://github.com/ClickHouse/ClickHouse/pull/17868) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Позволяет использовать оптимизацию `optimize_move_to_prewhere` с компактными частями, когда размеры столбцов неизвестны. [#17330](https://github.com/ClickHouse/ClickHouse/pull/17330) ([Anton Popov](https://github.com/CurtizJ)).

#### Улучшение {#improvement-10}

* Избегает взаимоблокировки при выполнении операции `INSERT SELECT` в ту же таблицу с движками таблиц `TinyLog` или `Log`. Исправляет [#6802](https://github.com/ClickHouse/ClickHouse/issues/6802). Исправляет [#18691](https://github.com/ClickHouse/ClickHouse/issues/18691). Исправляет [#16812](https://github.com/ClickHouse/ClickHouse/issues/16812). Исправляет [#14570](https://github.com/ClickHouse/ClickHouse/issues/14570). [#15260](https://github.com/ClickHouse/ClickHouse/pull/15260) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка синтаксиса `SHOW CREATE VIEW name`, как в [MySQL](https://dev.mysql.com/doc/refman/5.7/en/show-create-view.html). [#18095](https://github.com/ClickHouse/ClickHouse/pull/18095) ([Du Chuan](https://github.com/spongedu)).
* Разрешены все запросы вида `Decimal * Float` и наоборот, включая агрегатные (например, `SELECT sum(decimal_field * 1.1)` или `SELECT dec_col * float_col`), результирующий тип — Float32 или Float64. [#18145](https://github.com/ClickHouse/ClickHouse/pull/18145) ([Mike](https://github.com/myrrc)).
* Улучшен минимальный веб-интерфейс: добавлена история; добавлена поддержка обмена (sharing); устранено состояние гонки между запросами; добавлены индикаторы выполняющегося и готового запроса; добавлен favicon; добавлено распознавание Ctrl+Enter, если текстовая область не в фокусе. [#17293](https://github.com/ClickHouse/ClickHouse/pull/17293) [#17770](https://github.com/ClickHouse/ClickHouse/pull/17770) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* clickhouse-server не отправлял запрос `close` на сервер ZooKeeper. [#16837](https://github.com/ClickHouse/ClickHouse/pull/16837) ([alesapin](https://github.com/alesapin)).
* Предотвращено аварийное завершение работы сервера при слишком низких лимитах памяти (`max_memory_usage = 1` / `max_untracked_memory = 1`). [#17453](https://github.com/ClickHouse/ClickHouse/pull/17453) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен недетерминированный результат функции `windowFunnel` при одинаковых метках времени для разных событий. [#18884](https://github.com/ClickHouse/ClickHouse/pull/18884) ([Fuwang Hu](https://github.com/fuwhu)).
* Docker: Явно задаёт UID/GID пользователя clickhouse и его группы равными фиксированному значению 101 в Docker-образах clickhouse-server. [#19096](https://github.com/ClickHouse/ClickHouse/pull/19096) ([filimonov](https://github.com/filimonov)).
* Асинхронные операции INSERT в таблицы `Distributed`: Добавлены две новые настройки (по аналогии с семейством MergeTree): - `fsync_after_insert` — выполнять fsync для каждой вставки. Снижает производительность вставок. - `fsync_directories` — выполнять fsync для временного каталога (используется только для асинхронных INSERT) после всех операций (записей, переименований и т. д.). [#18864](https://github.com/ClickHouse/ClickHouse/pull/18864) ([Azat Khuzhin](https://github.com/azat)).
* Команда `SYSTEM KILL` теперь работает в Docker. Это исправляет проблему [#18847](https://github.com/ClickHouse/ClickHouse/issues/18847). [#18848](https://github.com/ClickHouse/ClickHouse/pull/18848) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Раскрывать макросы в пути ZooKeeper при выполнении `FETCH PARTITION`. [#18839](https://github.com/ClickHouse/ClickHouse/pull/18839) ([fastio](https://github.com/fastio)).
* Примените `ALTER TABLE <replicated_table> ON CLUSTER MODIFY SETTING ...` ко всем репликам, так как мы не реплицируем такие команды ALTER. [#18789](https://github.com/ClickHouse/ClickHouse/pull/18789) ([Amos Bird](https://github.com/amosbird)).
* Разрешить трансформеру столбцов `EXCEPT` принимать строку в качестве шаблона регулярного выражения. Это устраняет [#18685](https://github.com/ClickHouse/ClickHouse/issues/18685). [#18699](https://github.com/ClickHouse/ClickHouse/pull/18699) ([Amos Bird](https://github.com/amosbird)).
* Исправлена работа SimpleAggregateFunction в SummingMergeTree. Теперь она работает как AggregateFunction. В предыдущих версиях значения просто суммировались, не учитывая агрегатную функцию. Это исправляет [#18564](https://github.com/ClickHouse/ClickHouse/issues/18564). [#8052](https://github.com/ClickHouse/ClickHouse/issues/8052). [#18637](https://github.com/ClickHouse/ClickHouse/pull/18637) ([Amos Bird](https://github.com/amosbird)). Ещё одно исправление использования `SimpleAggregateFunction` в `SummingMergeTree`. Это исправляет [#18676](https://github.com/ClickHouse/ClickHouse/issues/18676). [#18677](https://github.com/ClickHouse/ClickHouse/pull/18677) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка assert внутри аллокатора, когда последний аргумент функции bar равен NaN. Теперь выбрасывается обычное исключение ClickHouse. Это исправляет [#17876](https://github.com/ClickHouse/ClickHouse/issues/17876). [#18520](https://github.com/ClickHouse/ClickHouse/pull/18520) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена проблема с удобством использования: в некоторых инструментах после сообщения об исключении отсутствовал перевод строки. [#18444](https://github.com/ClickHouse/ClickHouse/pull/18444) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность изменять тип столбца первичного и ключа партиционирования с `LowCardinality(Type)` на `Type` и обратно. Также добавлена возможность изменять тип столбца первичного ключа с `EnumX` на тип `IntX`. Исправлена [#5604](https://github.com/ClickHouse/ClickHouse/issues/5604). [#18362](https://github.com/ClickHouse/ClickHouse/pull/18362) ([alesapin](https://github.com/alesapin)).
* Реализован доступ к полям с помощью `untuple`. [#18133](https://github.com/ClickHouse/ClickHouse/issues/18133). [#18309](https://github.com/ClickHouse/ClickHouse/pull/18309) ([hexiaoting](https://github.com/hexiaoting)).
* Разрешён разбор полей типа Array из CSV, если они представлены строкой, содержащей массив, сериализованный как вложенный CSV. Пример: `"[""Hello"", ""world"", ""42"""" TV""]"` будет разобран как `['Hello', 'world', '42" TV']`. Разрешён разбор массива в CSV в строке без окружающих квадратных скобок. Пример: `"'Hello', 'world', '42"" TV'"` будет разобран как `['Hello', 'world', '42" TV']`. [#18271](https://github.com/ClickHouse/ClickHouse/pull/18271) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Улучшен расчет адаптивной гранулярности для широких частей таблиц MergeTree. [#18223](https://github.com/ClickHouse/ClickHouse/pull/18223) ([alesapin](https://github.com/alesapin)).
* Теперь `clickhouse install` работает на Mac. Проблема заключалась в том, что на этой платформе нет procfs. [#18201](https://github.com/ClickHouse/ClickHouse/pull/18201) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Улучшены подсказки по синтаксису запросов `SHOW ...`. [#18183](https://github.com/ClickHouse/ClickHouse/pull/18183) ([Du Chuan](https://github.com/spongedu)).
* Поддержка агрегирования массивов функциями `arrayMin`, `arrayMax`, `arraySum`, `arrayAvg` для типов данных `Int128`, `Int256`, `UInt256`. [#18147](https://github.com/ClickHouse/ClickHouse/pull/18147) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлен параметр `disk` в настройки хранилища Set и Join. [#18112](https://github.com/ClickHouse/ClickHouse/pull/18112) ([Grigory Pervakov](https://github.com/GrigoryPervakov)).
* Управление доступом: теперь табличная функция `merge()` требует, чтобы у текущего пользователя была привилегия `SELECT` на каждую таблицу, из которой она получает данные. Этот PR исправляет [#16964](https://github.com/ClickHouse/ClickHouse/issues/16964). [#18104](https://github.com/ClickHouse/ClickHouse/pull/18104) [#17983](https://github.com/ClickHouse/ClickHouse/pull/17983) ([Vitaly Baranov](https://github.com/vitlibar)).
* Временные таблицы теперь видны в системных таблицах `system.tables` и `system.columns` только в той сессии, в которой они были созданы. Внутренняя база данных `_temporary_and_external_tables` теперь скрыта в этих системных таблицах; вместо этого временные таблицы отображаются как таблицы с пустым именем базы данных и установленным флагом `is_temporary`. [#18014](https://github.com/ClickHouse/ClickHouse/pull/18014) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена проблема с отображением в clickhouse-client при изменении размера окна терминала. [#18009](https://github.com/ClickHouse/ClickHouse/pull/18009) ([Amos Bird](https://github.com/amosbird)).
* Уменьшена детализация логов для событий при обрыве соединения клиентом: уровень логирования понижен с Warning до Information. [#18005](https://github.com/ClickHouse/ClickHouse/pull/18005) ([filimonov](https://github.com/filimonov)).
* Принудительное удаление пустых или некорректных файлов метаданных из файловой системы для DiskS3. S3 — экспериментальная возможность. [#17935](https://github.com/ClickHouse/ClickHouse/pull/17935) ([Pavel Kovalenko](https://github.com/Jokser)).
* Управление доступом: `allow_introspection_functions=0` запрещает использование функций интроспекции, но больше не запрещает выдачу привилегий на них (получателю привилегий нужно будет установить `allow_introspection_functions=1`, чтобы иметь возможность ими воспользоваться). Аналогично, `allow_ddl=0` запрещает использование DDL-команд, но больше не запрещает выдачу привилегий на них. [#17908](https://github.com/ClickHouse/ClickHouse/pull/17908) ([Vitaly Baranov](https://github.com/vitlibar)).
* Улучшение удобства работы: подсказки для названий столбцов. [#17112](https://github.com/ClickHouse/ClickHouse/issues/17112). [#17857](https://github.com/ClickHouse/ClickHouse/pull/17857) ([fastio](https://github.com/fastio)).
* Добавлена диагностическая информация при попытке двух таблиц движка Merge читать данные друг друга. [#17854](https://github.com/ClickHouse/ClickHouse/pull/17854) ([徐炘](https://github.com/weeds085490)).
* Добавлена возможность переопределять значение тайм-аута для выполняемого скрипта при использовании Docker-образа ClickHouse. [#17818](https://github.com/ClickHouse/ClickHouse/pull/17818) ([Guillaume Tassery](https://github.com/YiuRULE)).
* Проверяет синтаксис определения движка таблиц системных логов, чтобы предотвратить некоторые ошибки конфигурации. Отмечается, что эта проверка не является семантической, то есть такие ошибки, как несуществующие столбцы или функции в выражениях, будут обнаружены только при создании таблицы. [#17739](https://github.com/ClickHouse/ClickHouse/pull/17739) ([Du Chuan](https://github.com/spongedu)).
* Убрано выбрасывание исключения при инициализации таблицы `RabbitMQ` при отсутствии соединения (переподключение будет выполняться в фоновом режиме). [#17709](https://github.com/ClickHouse/ClickHouse/pull/17709) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Не игнорируйте ограничения памяти сервера при сбросе буфера. [#17646](https://github.com/ClickHouse/ClickHouse/pull/17646) ([Azat Khuzhin](https://github.com/azat)).
* Переход на пропатченную версию RocksDB (из ClickHouse-Extras) для исправления ошибки типа use-after-free. [#17643](https://github.com/ClickHouse/ClickHouse/pull/17643) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлено смещение в сообщение об исключении при параллельном парсинге. Это исправляет [#17457](https://github.com/ClickHouse/ClickHouse/issues/17457). [#17641](https://github.com/ClickHouse/ClickHouse/pull/17641) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Не выбрасывать ошибку &quot;Too many parts&quot; во время выполнения запроса INSERT. [#17566](https://github.com/ClickHouse/ClickHouse/pull/17566) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Разрешено использование параметров запроса в операторе UPDATE в запросе ALTER. Исправляет [#10976](https://github.com/ClickHouse/ClickHouse/issues/10976). [#17563](https://github.com/ClickHouse/ClickHouse/pull/17563) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Обфускатор запросов: предотвращает использование некоторых ключевых слов SQL в качестве имён идентификаторов. [#17526](https://github.com/ClickHouse/ClickHouse/pull/17526) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Экспортировать через серверную метрику идентификатор текущей максимальной DDL-записи, выполненной DDLWorker. Это полезно, чтобы проверить, не завис ли где-нибудь DDLWorker. [#17464](https://github.com/ClickHouse/ClickHouse/pull/17464) ([Amos Bird](https://github.com/amosbird)).
* Экспорт асинхронных метрик текущих потоков всех серверов. Это полезно для отладки проблем вроде [этой](https://github.com/ClickHouse-Extras/poco/pull/28). [#17463](https://github.com/ClickHouse/ClickHouse/pull/17463) ([Amos Bird](https://github.com/amosbird)).
* Теперь в запросы с подстановочным символом (`*`) включаются динамические столбцы, такие как MATERIALIZED и ALIAS, когда параметры `asterisk_include_materialized_columns` и `asterisk_include_alias_columns` включены. [#17462](https://github.com/ClickHouse/ClickHouse/pull/17462) ([Ken Chen](https://github.com/chenziliang)).
* Добавлена возможность задавать [TTL](/engines/table-engines/mergetree-family/mergetree/#mergetree-table-ttl) для удаления старых записей из [таблиц системного журнала](/operations/system-tables/), используя атрибут `<ttl>` в `config.xml`. [#17438](https://github.com/ClickHouse/ClickHouse/pull/17438) ([Du Chuan](https://github.com/spongedu)).
* Теперь запросы, приходящие на сервер по протоколам MySQL и PostgreSQL, имеют разные типы интерфейса (их можно увидеть в столбце `interface` таблицы `system.query_log`): `4` для MySQL и `5` для PostgreSQL, вместо ранее использовавшегося значения `1`, которое теперь используется только для нативного протокола. [#17437](https://github.com/ClickHouse/ClickHouse/pull/17437) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен разбор клаузы SETTINGS в запросе `INSERT ... SELECT ... SETTINGS`. [#17414](https://github.com/ClickHouse/ClickHouse/pull/17414) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен учёт памяти в RadixSort. [#17412](https://github.com/ClickHouse/ClickHouse/pull/17412) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлена проверка на eof в `receiveHello` на сервере, чтобы предотвратить исключение `Attempt to read after eof`. [#17365](https://github.com/ClickHouse/ClickHouse/pull/17365) ([Kruglov Pavel](https://github.com/Avogar)).
* Избежать возможного переполнения стека при преобразовании в bigint. Тип больших целых чисел носит экспериментальный характер. [#17269](https://github.com/ClickHouse/ClickHouse/pull/17269) ([flynn](https://github.com/ucasFL)).
* Теперь индексы типа `set` работают с `GLOBAL IN`. Это исправляет [#17232](https://github.com/ClickHouse/ClickHouse/issues/17232), [#5576](https://github.com/ClickHouse/ClickHouse/issues/5576). [#17253](https://github.com/ClickHouse/ClickHouse/pull/17253) ([Amos Bird](https://github.com/amosbird)).
* Добавлен предел числа HTTP‑перенаправлений в запросах к хранилищу S3 (`s3_max_redirects`). [#17220](https://github.com/ClickHouse/ClickHouse/pull/17220) ([ianton-ru](https://github.com/ianton-ru)).
* Когда комбинатор `-OrNull` используется вместе с комбинаторами `-If`, `-Merge`, `-MergeState`, `-State`, `-OrNull` следует указывать первым. [#16935](https://github.com/ClickHouse/ClickHouse/pull/16935) ([flynn](https://github.com/ucasFL)).
* Добавлена поддержка настройки HTTP‑прокси и HTTPS‑эндпоинта для S3. [#16861](https://github.com/ClickHouse/ClickHouse/pull/16861) ([Pavel Kovalenko](https://github.com/Jokser)).
* Добавлена корректная аутентификация через переменные окружения, `~/.aws` и `AssumeRole` для клиента S3. [#16856](https://github.com/ClickHouse/ClickHouse/pull/16856) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Добавлены дополнительные спаны OpenTelemetry. Добавлен пример экспорта данных спанов в Zipkin. [#16535](https://github.com/ClickHouse/ClickHouse/pull/16535) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Кэш-словари: полностью устранены обратные вызовы и блокировки при доступе к ним. Ключи не разделяются на «не найденные» и «просроченные», а хранятся в одной и той же карте во время выполнения запроса. [#14958](https://github.com/ClickHouse/ClickHouse/pull/14958) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлены неработающие `fsync_part_directory`/`fsync_after_insert`/`in_memory_parts_insert_sync` (экспериментальная функциональность). [#18845](https://github.com/ClickHouse/ClickHouse/pull/18845) ([Azat Khuzhin](https://github.com/azat)).
* Разрешено использование движка `Atomic` для вложенной базы данных движка `MaterializeMySQL`. [#14849](https://github.com/ClickHouse/ClickHouse/pull/14849) ([tavplubix](https://github.com/tavplubix)).

#### Исправление ошибки {#bug-fix-10}

* Исправлена проблема, из-за которой сервер в крайне редких случаях мог перестать принимать подключения. [#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) (Amos Bird, [alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен анализ индексов для бинарных функций с константным аргументом, приводивший к некорректным результатам запросов. Это исправление решает [#18364](https://github.com/ClickHouse/ClickHouse/issues/18364). [#18373](https://github.com/ClickHouse/ClickHouse/pull/18373) ([Amos Bird](https://github.com/amosbird)).
* Исправлен возможный некорректный анализ индекса, когда типы операндов при сравнении с индексом различаются. Это исправление закрывает [#17122](https://github.com/ClickHouse/ClickHouse/issues/17122). [#17145](https://github.com/ClickHouse/ClickHouse/pull/17145) ([Amos Bird](https://github.com/amosbird)).
* Отключена запись с AIO во время слияний, так как она в крайне редких случаях может приводить к повреждению данных в столбцах первичного ключа. [#18481](https://github.com/ClickHouse/ClickHouse/pull/18481) ([alesapin](https://github.com/alesapin)).
* Ограничено слияние широких частей в компактные. При вертикальном слиянии это приводило к повреждению результирующей части. [#18381](https://github.com/ClickHouse/ClickHouse/pull/18381) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена возможная неполнота результата запроса при чтении из `MergeTree*` в случае read backoff (сообщение `<Debug> MergeTreeReadPool: Will lower number of threads` в логах). Проблема была введена в [#16423](https://github.com/ClickHouse/ClickHouse/issues/16423). Исправляет [#18137](https://github.com/ClickHouse/ClickHouse/issues/18137). [#18216](https://github.com/ClickHouse/ClickHouse/pull/18216) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка использования после освобождения памяти (use-after-free) в библиотеке `rocksdb`. [#18862](https://github.com/ClickHouse/ClickHouse/pull/18862) ([sundyli](https://github.com/sundy-li)).
* Исправлено бесконечное чтение из файла в формате `ORC` (ошибка возникла в [#10580](https://github.com/ClickHouse/ClickHouse/issues/10580)). Исправлена [#19095](https://github.com/ClickHouse/ClickHouse/issues/19095). [#19134](https://github.com/ClickHouse/ClickHouse/pull/19134) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка в модуле записи данных MergeTree, которая могла приводить к созданию маркеров с размером больше фиксированного размера гранулы. Исправляет [#18913](https://github.com/ClickHouse/ClickHouse/issues/18913). [#19123](https://github.com/ClickHouse/ClickHouse/pull/19123) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка при запуске, из‑за которой ClickHouse не удавалось прочитать кодек сжатия из `LowCardinality(Nullable(...))` и выбрасывалось исключение `Attempt to read after EOF`. Исправляет [#18340](https://github.com/ClickHouse/ClickHouse/issues/18340). [#19101](https://github.com/ClickHouse/ClickHouse/pull/19101) ([alesapin](https://github.com/alesapin)).
* Ограничены запросы `MODIFY TTL` для таблиц `MergeTree`, созданных в старом синтаксисе. Ранее такие запросы выполнялись успешно, но фактически ни на что не влияли. [#19064](https://github.com/ClickHouse/ClickHouse/pull/19064) ([Anton Popov](https://github.com/CurtizJ)).
* Убедитесь, что `groupUniqArray` возвращает правильный тип для аргумента типа Enum. Это закрывает [#17875](https://github.com/ClickHouse/ClickHouse/issues/17875). [#19019](https://github.com/ClickHouse/ClickHouse/pull/19019) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена возможная ошибка `Expected single dictionary argument for function` при использовании функции `ignore` с аргументом типа `LowCardinality`. Устранена [#14275](https://github.com/ClickHouse/ClickHouse/issues/14275). [#19016](https://github.com/ClickHouse/ClickHouse/pull/19016) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена вставка столбца `LowCardinality` в таблицу с движком `TinyLog`, что устраняет [#18629](https://github.com/ClickHouse/ClickHouse/issues/18629). [#19010](https://github.com/ClickHouse/ClickHouse/pull/19010) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Операция JOIN пытается материализовать константные столбцы, но наш код ожидает их в других местах. [#18982](https://github.com/ClickHouse/ClickHouse/pull/18982) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Отключить настройку `optimize_move_functions_out_of_any`, так как эта оптимизация не всегда работает корректно. Это исправляет [#18051](https://github.com/ClickHouse/ClickHouse/issues/18051). Это исправляет [#18973](https://github.com/ClickHouse/ClickHouse/issues/18973). [#18981](https://github.com/ClickHouse/ClickHouse/pull/18981) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено возможное исключение `QueryPipeline stream: different number of columns`, возникавшее при слиянии шагов `Expression` в плане запроса. Исправляет [#18190](https://github.com/ClickHouse/ClickHouse/issues/18190). [#18980](https://github.com/ClickHouse/ClickHouse/pull/18980) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена крайне редкая взаимоблокировка при завершении работы. [#18977](https://github.com/ClickHouse/ClickHouse/pull/18977) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка, из-за которой запрос `ALTER TABLE ... DROP PART 'part_name'` удалял все блоки дедупликации во всей партиции. Исправляет [#18874](https://github.com/ClickHouse/ClickHouse/issues/18874). [#18969](https://github.com/ClickHouse/ClickHouse/pull/18969) ([alesapin](https://github.com/alesapin)).
* Операция ATTACH PARTITION должна сбрасывать мутацию. [#18804](https://github.com/ClickHouse/ClickHouse/issues/18804). [#18935](https://github.com/ClickHouse/ClickHouse/pull/18935) ([fastio](https://github.com/fastio)).
* Исправлена ошибка в `bitmapOrCardinality`, которая могла привести к разыменованию нулевого указателя (nullptr). Это закрывает [#18911](https://github.com/ClickHouse/ClickHouse/issues/18911). [#18912](https://github.com/ClickHouse/ClickHouse/pull/18912) ([sundyli](https://github.com/sundy-li)).
* Исправлено возможное зависание `clickhouse-local` при завершении работы. Это исправляет [#18891](https://github.com/ClickHouse/ClickHouse/issues/18891). [#18893](https://github.com/ClickHouse/ClickHouse/pull/18893) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Запросы к внешним базам данных (MySQL, ODBC, JDBC) некорректно переписывались, если содержали выражение вида `x IN table`. Это исправляет [#9756](https://github.com/ClickHouse/ClickHouse/issues/9756). [#18876](https://github.com/ClickHouse/ClickHouse/pull/18876) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен комбинатор *If с унарной функцией и типами Nullable. [#18806](https://github.com/ClickHouse/ClickHouse/pull/18806) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема, из-за которой асинхронные распределённые INSERT-запросы могли быть отклонены сервером, если параметр `network_compression_method` был глобально установлен в значение, отличающееся от значения по умолчанию. Это исправляет [#18741](https://github.com/ClickHouse/ClickHouse/issues/18741). [#18776](https://github.com/ClickHouse/ClickHouse/pull/18776) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка `Attempt to read after eof` при попытке привести `NULL` из `Nullable(String)` к `Nullable(Decimal(P, S))`. Теперь функция `CAST` возвращает `NULL`, если не может преобразовать десятичное число из строки типа `Nullable(String)`. Исправляет [#7690](https://github.com/ClickHouse/ClickHouse/issues/7690). [#18718](https://github.com/ClickHouse/ClickHouse/pull/18718) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена незначительная проблема с логированием. [#18717](https://github.com/ClickHouse/ClickHouse/pull/18717) ([sundyli](https://github.com/sundy-li)).
* Исправлена проблема удаления пустых кусков в таблицах `ReplicatedMergeTree`, созданных со старым синтаксисом. Исправляет ошибку [#18582](https://github.com/ClickHouse/ClickHouse/issues/18582). [#18614](https://github.com/ClickHouse/ClickHouse/pull/18614) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена предыдущая ошибка переполнения даты при различных значениях. Значение типа Date строго ограничено датой &quot;2106-02-07&quot;, приведение даты &gt; &quot;2106-02-07&quot; приводит к значению 0. [#18565](https://github.com/ClickHouse/ClickHouse/pull/18565) ([hexiaoting](https://github.com/hexiaoting)).
* Добавлена поддержка типа данных FixedString для репликации из MySQL. Репликация из MySQL — экспериментальная функция. Этот патч исправляет [#18450](https://github.com/ClickHouse/ClickHouse/issues/18450), а также [#6556](https://github.com/ClickHouse/ClickHouse/issues/6556). [#18553](https://github.com/ClickHouse/ClickHouse/pull/18553) ([awesomeleo](https://github.com/awesomeleo)).
* Исправлена потенциальная ошибка `Pipeline stuck` при использовании `ORDER BY` после подзапроса с соединением `RIGHT` или `FULL`. [#18550](https://github.com/ClickHouse/ClickHouse/pull/18550) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, которая могла приводить к зависанию запросов `ALTER` после принудительного завершения соответствующей мутации командой kill. Обнаружено с помощью thread fuzzer. [#18518](https://github.com/ClickHouse/ClickHouse/pull/18518) ([alesapin](https://github.com/alesapin)).
* Корректная поддержка значения 12AM в функции `parseDateTimeBestEffort`. Это исправляет [#18402](https://github.com/ClickHouse/ClickHouse/issues/18402). [#18449](https://github.com/ClickHouse/ClickHouse/pull/18449) ([vladimir-golovchenko](https://github.com/vladimir-golovchenko)).
* Исправлена ошибка `value is too short` при выполнении функций `toType(...)` (`toDate`, `toUInt32` и т. д.) с аргументом типа `Nullable(String)`. Теперь такие функции возвращают `NULL` при ошибке разбора вместо генерации исключения. Исправляет [#7673](https://github.com/ClickHouse/ClickHouse/issues/7673). [#18445](https://github.com/ClickHouse/ClickHouse/pull/18445) ([tavplubix](https://github.com/tavplubix)).
* Исправлено неожиданное поведение команды `SHOW TABLES`. [#18431](https://github.com/ClickHouse/ClickHouse/pull/18431) ([fastio](https://github.com/fastio)).
* Исправлено: комбинатор -SimpleState генерировал несовместимые тип аргумента и тип возвращаемого значения. [#18404](https://github.com/ClickHouse/ClickHouse/pull/18404) ([Amos Bird](https://github.com/amosbird)).
* Исправлено возможное состояние гонки при одновременном использовании таблиц `Set` или `Join` и выполнении запросов к `system.tables`. [#18385](https://github.com/ClickHouse/ClickHouse/pull/18385) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено заполнение таблицы `system.settings_profile_elements`. Этот PR исправляет [#18231](https://github.com/ClickHouse/ClickHouse/issues/18231). [#18379](https://github.com/ClickHouse/ClickHouse/pull/18379) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлены возможные падения в агрегатных функциях с комбинатором `Distinct` при использовании двухуровневой агрегации. Исправлена проблема [#17682](https://github.com/ClickHouse/ClickHouse/issues/17682). [#18365](https://github.com/ClickHouse/ClickHouse/pull/18365) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена проблема, из-за которой процесс `clickhouse-odbc-bridge` был недоступен серверу на машинах с двойным стеком IPv4/IPv6; исправлена проблема, из-за которой обновления словарей ODBC выполнялись с использованием некорректных запросов и/или приводили к аварийному завершению процесса `odbc-bridge`; возможно, закрывает [#14489](https://github.com/ClickHouse/ClickHouse/issues/14489). [#18278](https://github.com/ClickHouse/ClickHouse/pull/18278) ([Denis Glazachev](https://github.com/traceon)).
* Управление доступом: теперь запрос `SELECT count() FROM table` может быть выполнен, если у пользователя есть доступ как минимум к одному столбцу в таблице. Этот PR исправляет [#10639](https://github.com/ClickHouse/ClickHouse/issues/10639). [#18233](https://github.com/ClickHouse/ClickHouse/pull/18233) ([Vitaly Baranov](https://github.com/vitlibar)).
* Управление доступом: `SELECT JOIN` теперь требует наличия привилегии `SELECT` для каждой из присоединяемых таблиц. Этот PR исправляет [#17654](https://github.com/ClickHouse/ClickHouse/issues/17654). [#18232](https://github.com/ClickHouse/ClickHouse/pull/18232) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено сравнение ключей между типами Enum и Int. Исправляет [#17989](https://github.com/ClickHouse/ClickHouse/issues/17989). [#18214](https://github.com/ClickHouse/ClickHouse/pull/18214) ([Amos Bird](https://github.com/amosbird)).
* Репликация из MySQL (экспериментальная функция). Исправляет [#18186](https://github.com/ClickHouse/ClickHouse/issues/18186), исправляет [#16372](https://github.com/ClickHouse/ClickHouse/issues/16372). Исправлена проблема преобразования уникального ключа в движке базы данных MaterializeMySQL. [#18211](https://github.com/ClickHouse/ClickHouse/pull/18211) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена некорректная обработка запросов, использующих одновременно `WITH FILL` и `WITH TIES` [#17466](https://github.com/ClickHouse/ClickHouse/issues/17466). [#18188](https://github.com/ClickHouse/ClickHouse/pull/18188) ([hexiaoting](https://github.com/hexiaoting)).
* Исправлена вставка строки со значением по умолчанию в случае ошибки разбора в последнем столбце. Устраняет [#17712](https://github.com/ClickHouse/ClickHouse/issues/17712). [#18182](https://github.com/ClickHouse/ClickHouse/pull/18182) ([Jianmei Zhang](https://github.com/zhangjmruc)).
* Исправлена ошибка `Unknown setting profile` при попытке установить профиль настроек. [#18167](https://github.com/ClickHouse/ClickHouse/pull/18167) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка, из-за которой запрос `MODIFY COLUMN ... REMOVE TTL` фактически не удалял TTL столбца. [#18130](https://github.com/ClickHouse/ClickHouse/pull/18130) ([alesapin](https://github.com/alesapin)).
* Исправлено исключение `std::out_of_range: basic_string` при разборе URL-адресов S3. [#18059](https://github.com/ClickHouse/ClickHouse/pull/18059) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Исправлено сравнение `DateTime64` и `Date`. Исправлены ошибки [#13804](https://github.com/ClickHouse/ClickHouse/issues/13804) и [#11222](https://github.com/ClickHouse/ClickHouse/issues/11222). ... [#18050](https://github.com/ClickHouse/ClickHouse/pull/18050) ([Vasily Nemkov](https://github.com/Enmk)).
* Репликация из MySQL (экспериментальная функция): исправлены [#15187](https://github.com/ClickHouse/ClickHouse/issues/15187), [#17912](https://github.com/ClickHouse/ClickHouse/issues/17912), добавлена поддержка преобразования префиксного индекса MySQL для MaterializeMySQL. [#17944](https://github.com/ClickHouse/ClickHouse/pull/17944) ([Winter Zhang](https://github.com/zhang2014)).
* Когда ротация журналов сервера была настроена с использованием параметра `logger.size` с числовым значением больше 2^32, журналы не ротировались корректно. Ошибка исправлена. [#17905](https://github.com/ClickHouse/ClickHouse/pull/17905) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Тривиальная оптимизация запроса приводила к неверному результату, если запрос содержал ARRAY JOIN (то есть запрос на самом деле нетривиален). [#17887](https://github.com/ClickHouse/ClickHouse/pull/17887) ([sundyli](https://github.com/sundy-li)).
* Исправлена возможная ошибка сегментации в агрегатной функции `topK`. Это исправление закрывает [#17404](https://github.com/ClickHouse/ClickHouse/issues/17404). [#17845](https://github.com/ClickHouse/ClickHouse/pull/17845) ([Maksim Kita](https://github.com/kitaisreal)).
* WAL (экспериментальная функция): не восстанавливать части из WAL, если `in_memory_parts_enable_wal` отключён. [#17802](https://github.com/ClickHouse/ClickHouse/pull/17802) ([detailyang](https://github.com/detailyang)).
* Сообщение об исключении, связанном с максимальным размером удаляемой таблицы, отображалось некорректно. [#17764](https://github.com/ClickHouse/ClickHouse/pull/17764) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена возможная ошибка сегментации при недостатке места при вставке в таблицу `Distributed`. [#17737](https://github.com/ClickHouse/ClickHouse/pull/17737) ([tavplubix](https://github.com/tavplubix)).
* Исправлена проблема, при которой ClickHouse не удавалось возобновить соединение с серверами MySQL. [#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz)).
* Windows: Исправлена ошибка `Function not implemented` при выполнении запроса `RENAME` в базе данных `Atomic` при работе ClickHouse в подсистеме Windows для Linux (WSL). Исправлена [#17661](https://github.com/ClickHouse/ClickHouse/issues/17661). [#17664](https://github.com/ClickHouse/ClickHouse/pull/17664) ([tavplubix](https://github.com/tavplubix)).
* Могло некорректно определяться, является ли кластер кольцевым (перекрёстно реплицируемым), при выполнении запроса `ON CLUSTER` из‑за гонки при `pool_size` &gt; 1. Исправлено. [#17640](https://github.com/ClickHouse/ClickHouse/pull/17640) ([tavplubix](https://github.com/tavplubix)).
* Исправлена проблема с пустой таблицей `system.stack_trace` при работе сервера в режиме демона. [#17630](https://github.com/ClickHouse/ClickHouse/pull/17630) ([Amos Bird](https://github.com/amosbird)).
* Исключение `fmt::v7::format_error` может быть записано в лог в фоновом режиме для таблиц MergeTree. Это исправляет [#17613](https://github.com/ClickHouse/ClickHouse/issues/17613). [#17615](https://github.com/ClickHouse/ClickHouse/pull/17615) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* При использовании clickhouse-client в интерактивном режиме с многострочными запросами однострочный комментарий ошибочно считался продолжающимся до конца запроса. Это исправляет [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654). [#17565](https://github.com/ClickHouse/ClickHouse/pull/17565) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено зависание запроса ALTER, когда соответствующая мутация была остановлена на другой реплике. Исправлена проблема [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953). [#17499](https://github.com/ClickHouse/ClickHouse/pull/17499) ([alesapin](https://github.com/alesapin)).
* Исправлена проблема с учетом памяти, когда ClickHouse занижал размер кэша меток. Это могло происходить при большом количестве очень маленьких файлов с метками. [#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin)).
* Исправлена работа `ORDER BY` при включённой настройке `optimize_redundant_functions_in_order_by`. [#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены случаи появления дубликатов после `DISTINCT`, которые могли возникать из‑за некорректной оптимизации. Исправлено в [#17294](https://github.com/ClickHouse/ClickHouse/issues/17294). [#17296](https://github.com/ClickHouse/ClickHouse/pull/17296) ([li chengxiang](https://github.com/chengxianglibra)). [#17439](https://github.com/ClickHouse/ClickHouse/pull/17439) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена проблема высокой загрузки CPU фоновыми задачами таблиц *MergeTree. [#17416](https://github.com/ClickHouse/ClickHouse/pull/17416) ([tavplubix](https://github.com/tavplubix)).
* Исправлен возможный сбой при чтении из таблицы `JOIN` с типами `LowCardinality`. Устраняет проблему [#17228](https://github.com/ClickHouse/ClickHouse/issues/17228). [#17397](https://github.com/ClickHouse/ClickHouse/pull/17397) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Репликация из MySQL (экспериментальная функция): Исправление [#16835](https://github.com/ClickHouse/ClickHouse/issues/16835) — попытка устранить несоответствие заголовков выводу оператора MySQL SHOW. [#17366](https://github.com/ClickHouse/ClickHouse/pull/17366) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена работа с недетерминированными функциями в оптимизаторе предикатов. Исправлена проблема [#17244](https://github.com/ClickHouse/ClickHouse/issues/17244). [#17273](https://github.com/ClickHouse/ClickHouse/pull/17273) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена потенциальная ошибка `Unexpected packet Data received from client` при выполнении распределённых запросов с `LIMIT`. [#17254](https://github.com/ClickHouse/ClickHouse/pull/17254) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема с инвалидацией индекса множеств при наличии константных столбцов в подзапросе. Это исправляет [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246). [#17249](https://github.com/ClickHouse/ClickHouse/pull/17249) ([Amos Bird](https://github.com/amosbird)).
* clickhouse-copier: исправление обработки таблиц без партиционирования [#15235](https://github.com/ClickHouse/ClickHouse/issues/15235). [#17248](https://github.com/ClickHouse/ClickHouse/pull/17248) ([Qi Chen](https://github.com/kaka11chen)).
* Исправлены потенциальные проблемы с мутациями для частей, хранящихся на диске S3 (экспериментальная функция). [#17227](https://github.com/ClickHouse/ClickHouse/pull/17227) ([Pavel Kovalenko](https://github.com/Jokser)).
* Исправление ошибки в функции `fuzzBits`, связанный тикет: [#16980](https://github.com/ClickHouse/ClickHouse/issues/16980). [#17051](https://github.com/ClickHouse/ClickHouse/pull/17051) ([hexiaoting](https://github.com/hexiaoting)).
* Исправлена работа настройки `optimize_distributed_group_by_sharding_key` для запросов только с OFFSET. [#16996](https://github.com/ClickHouse/ClickHouse/pull/16996) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены запросы с JOIN из таблиц `Merge` к таблицам `Distributed`. [#16993](https://github.com/ClickHouse/ClickHouse/pull/16993) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена оптимизация ORDER BY с монотонными функциями. Исправлена ошибка [#16107](https://github.com/ClickHouse/ClickHouse/issues/16107). [#16956](https://github.com/ClickHouse/ClickHouse/pull/16956) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено некорректное сравнение типов `DateTime64` с разными степенями точности. Исправлены [#16655](https://github.com/ClickHouse/ClickHouse/issues/16655) ... [#16952](https://github.com/ClickHouse/ClickHouse/pull/16952) ([Vasily Nemkov](https://github.com/Enmk)).
* Исправлена оптимизация `GROUP BY` при включённой настройке `optimize_aggregators_of_group_by_keys` и использовании `JOIN`. Исправляет [#12604](https://github.com/ClickHouse/ClickHouse/issues/12604). [#16951](https://github.com/ClickHouse/ClickHouse/pull/16951) ([Anton Popov](https://github.com/CurtizJ)).
* Незначительное исправление в запросе SHOW ACCESS. [#16866](https://github.com/ClickHouse/ClickHouse/pull/16866) ([tavplubix](https://github.com/tavplubix)).
* Исправлено поведение настройки `optimize_trivial_count_query` при использовании предиката по партициям. [#16767](https://github.com/ClickHouse/ClickHouse/pull/16767) ([Azat Khuzhin](https://github.com/azat)).
* Возвращать количество затронутых строк для запросов INSERT по сетевому протоколу MySQL. Ранее ClickHouse всегда возвращал 0, теперь это исправлено. Исправляет [#16605](https://github.com/ClickHouse/ClickHouse/issues/16605). [#16715](https://github.com/ClickHouse/ClickHouse/pull/16715) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлено непоследовательное поведение, вызванное использованием `select_sequential_consistency` в оптимизированном простом запросе `COUNT` и в системных таблицах. [#16309](https://github.com/ClickHouse/ClickHouse/pull/16309) ([Hao Chen](https://github.com/haoch)).
* Выбрасывать ошибку, если трансформер столбца `REPLACE` применяется к несуществующему столбцу. [#16183](https://github.com/ClickHouse/ClickHouse/pull/16183) ([hexiaoting](https://github.com/hexiaoting)).
* Генерировать исключение в случае условия ON, не являющегося equi-join, в RIGHT или FULL JOIN. [#15162](https://github.com/ClickHouse/ClickHouse/pull/15162) ([Artem Zuikov](https://github.com/4ertus2)).

#### Улучшения сборки, тестирования и упаковки {#buildtestingpackaging-improvement-10}

* Добавлена простая проверка целостности бинарного файла ClickHouse. Она позволяет обнаруживать повреждение данных из‑за неисправного оборудования (битовая деградация на носителях данных или битовые сбои в ОЗУ). [#18811](https://github.com/ClickHouse/ClickHouse/pull/18811) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Заменён `OpenSSL` на `BoringSSL`. Это позволяет избежать проблем при использовании санитайзеров. Исправляет [#12490](https://github.com/ClickHouse/ClickHouse/issues/12490). Исправляет [#17502](https://github.com/ClickHouse/ClickHouse/issues/17502). Исправляет [#12952](https://github.com/ClickHouse/ClickHouse/issues/12952). [#18129](https://github.com/ClickHouse/ClickHouse/pull/18129) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Упростили init-скрипт `Sys/V`. Он не работал в Ubuntu 12.04 и более ранних версиях. [#17428](https://github.com/ClickHouse/ClickHouse/pull/17428) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* В скрипт `./clickhouse install` внесено несколько улучшений. [#17421](https://github.com/ClickHouse/ClickHouse/pull/17421) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Теперь ClickHouse может выступать в роли фиктивного ZooKeeper. В настоящее время реализация хранилища представляет собой просто хеш-таблицу в памяти, а сервер частично поддерживает протокол ZooKeeper. [#16877](https://github.com/ClickHouse/ClickHouse/pull/16877) ([alesapin](https://github.com/alesapin)).
* Устранена проблема с удалением неактивных наблюдателей списка для TestKeeperStorage (мок для ZooKeeper). [#18065](https://github.com/ClickHouse/ClickHouse/pull/18065) ([alesapin](https://github.com/alesapin)).
* Добавлена команда `SYSTEM SUSPEND` для инъекции сбоев. Она может использоваться для облегчения тестов отказоустойчивости. Тем самым закрывается [#15979](https://github.com/ClickHouse/ClickHouse/issues/15979). [#18850](https://github.com/ClickHouse/ClickHouse/pull/18850) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Генерировать идентификатор сборки при линковке ClickHouse с `lld`. Выяснилось, что `lld` по умолчанию его не генерирует на моей машине. Идентификатор сборки используется для отчётов о сбоях и интроспекции. [#18808](https://github.com/ClickHouse/ClickHouse/pull/18808) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены ошибки shellcheck в проверке стиля. [#18566](https://github.com/ClickHouse/ClickHouse/pull/18566) ([Ilya Yatsishin](https://github.com/qoega)).
* Обновлены данные о часовых поясах до версии 2020e. [#18531](https://github.com/ClickHouse/ClickHouse/pull/18531) ([alesapin](https://github.com/alesapin)).
* Исправлены предупреждения codespell. Проверки стиля разделены на отдельные этапы. Обновлён Docker-образ для проверок стиля. [#18463](https://github.com/ClickHouse/ClickHouse/pull/18463) ([Ilya Yatsishin](https://github.com/qoega)).
* Автоматическая проверка документации на наличие оставшихся маркеров конфликтов. [#18332](https://github.com/ClickHouse/ClickHouse/pull/18332) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Включён Thread Fuzzer для проверки нестабильных stateless-тестов. [#18299](https://github.com/ClickHouse/ClickHouse/pull/18299) ([alesapin](https://github.com/alesapin)).
* Не используйте непотокобезопасную функцию `strerror`. [#18204](https://github.com/ClickHouse/ClickHouse/pull/18204) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Обновлено действие рабочего процесса `anchore/scan-action@main` (перенесено с `master` на `main`). [#18192](https://github.com/ClickHouse/ClickHouse/pull/18192) ([Stig Bakken](https://github.com/stigsb)).
* Теперь `clickhouse-test` выполняет операции DROP/CREATE баз данных с тайм-аутом. [#18098](https://github.com/ClickHouse/ClickHouse/pull/18098) ([alesapin](https://github.com/alesapin)).
* Добавлена экспериментальная поддержка фреймворка Pytest для stateless-тестов. [#17902](https://github.com/ClickHouse/ClickHouse/pull/17902) ([Ivan](https://github.com/abyss7)).
* Теперь в интеграционных тестах используется актуальная версия Docker-демона. [#17671](https://github.com/ClickHouse/ClickHouse/pull/17671) ([alesapin](https://github.com/alesapin)).
* Отправлять сведения об официальной сборке, оперативной памяти, процессоре и свободном месте на диске в Sentry, если она включена. Sentry — это необязательная функция, помогающая разработчикам ClickHouse. Закрывает [#17279](https://github.com/ClickHouse/ClickHouse/issues/17279). [#17543](https://github.com/ClickHouse/ClickHouse/pull/17543) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* В коде clickhouse-copier была обнаружена неинициализированная переменная. [#17363](https://github.com/ClickHouse/ClickHouse/pull/17363) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлен [один отчёт MSan](https://clickhouse-test-reports.s3.yandex.net/17309/065cd002578f2e8228f12a2744bd40c970065e0c/stress_test_\(memory\)/stderr.log) из [#17309](https://github.com/ClickHouse/ClickHouse/issues/17309). [#17344](https://github.com/ClickHouse/ClickHouse/pull/17344) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправление проблемы с IPv6 в библиотеке Arrow Flight. Подробнее см. в [комментариях](https://github.com/ClickHouse/ClickHouse/pull/16243#issuecomment-720830294). [#16664](https://github.com/ClickHouse/ClickHouse/pull/16664) ([Zhanna](https://github.com/FawnD2)).
* Добавлена библиотека, которая заменяет некоторые функции `libc` на ловушки, завершающие процесс. [#16366](https://github.com/ClickHouse/ClickHouse/pull/16366) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Выводить диагностические сообщения в логи сервера при переполнении стека и отправлять сообщение об ошибке в clickhouse-client. Это закрывает [#14840](https://github.com/ClickHouse/ClickHouse/issues/14840). [#16346](https://github.com/ClickHouse/ClickHouse/pull/16346) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Теперь мы можем запускать почти все функциональные тесты без состояния параллельно. [#15236](https://github.com/ClickHouse/ClickHouse/pull/15236) ([alesapin](https://github.com/alesapin)).
* Исправлена порча данных при snappy-декомпрессии в `librdkafka` (проблема возникала только в сборках gcc10, но официальные сборки уже используют clang, поэтому, по крайней мере, недавние официальные релизы не затронуты). [#18053](https://github.com/ClickHouse/ClickHouse/pull/18053) ([Azat Khuzhin](https://github.com/azat)).
* Если сервер был убит OOM-killer&#39;ом, выводить сообщение в журнал. [#13516](https://github.com/ClickHouse/ClickHouse/pull/13516) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* PODArray: устранён вызов memcpy с аргументами (nullptr, 0) (исправление по отчёту UBSan). Это исправляет [#18525](https://github.com/ClickHouse/ClickHouse/issues/18525). [#18526](https://github.com/ClickHouse/ClickHouse/pull/18526) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Небольшое улучшение объединения путей Zookeeper внутри DDLWorker. [#17767](https://github.com/ClickHouse/ClickHouse/pull/17767) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлена возможность перезагружать символы из файла отладки. В этом PR также исправлена проблема с build-id. [#17637](https://github.com/ClickHouse/ClickHouse/pull/17637) ([Amos Bird](https://github.com/amosbird)).

## [История изменений за 2020 год](./2020.md) {#changelog-for-2020}