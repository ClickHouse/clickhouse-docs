---
slug: /whats-new/changelog/2021
sidebar_position: 6
sidebar_label: "2021"
title: "Журнал изменений 2021"
description: "Журнал изменений за 2021 год"
doc_type: "changelog"
keywords:
  [
    "ClickHouse 2021",
    "журнал изменений 2021",
    "примечания к выпуску",
    "история версий",
    "новые возможности"
  ]
---

### Выпуск ClickHouse v21.12, 2021-12-15 {#clickhouse-release-v2112-2021-12-15}

#### Обратно несовместимые изменения {#backward-incompatible-change}

- _Исправление функции, которая ранее имела нежелательное поведение._ Запрещён прямой запрос SELECT для Kafka/RabbitMQ/FileLog. Может быть включён с помощью настройки `stream_like_engine_allow_direct_select`. Прямой SELECT не будет разрешён, даже если включён настройкой, в случае наличия присоединённого материализованного представления. Для Kafka и RabbitMQ прямой SELECT, если разрешён, не будет фиксировать сообщения по умолчанию. Чтобы включить фиксацию при прямом SELECT, пользователь должен использовать настройку уровня хранилища `kafka{rabbitmq}_commit_on_select=1` (по умолчанию `0`). [#31053](https://github.com/ClickHouse/ClickHouse/pull/31053) ([Kseniia Sumarokova](https://github.com/kssenii)).
- _Небольшое изменение в поведении новой функции._ Возврат строки без кавычек в JSON_VALUE. Закрывает [#27965](https://github.com/ClickHouse/ClickHouse/issues/27965). [#31008](https://github.com/ClickHouse/ClickHouse/pull/31008) ([Kseniia Sumarokova](https://github.com/kssenii)).
- _Переименование настройки._ Добавлена поддержка пользовательского представления null для входных форматов TSV/CSV. Исправлена десериализация Nullable(String) во входных форматах TSV/CSV/JSONCompactStringsEachRow/JSONStringsEachRow. Настройки `output_format_csv_null_representation` и `output_format_tsv_null_representation` переименованы в `format_csv_null_representation` и `format_tsv_null_representation` соответственно. [#30497](https://github.com/ClickHouse/ClickHouse/pull/30497) ([Kruglov Pavel](https://github.com/Avogar)).
- _Дальнейшее устаревание уже неиспользуемого кода._ Это актуально только для пользователей версий ClickHouse старше 20.6. Механизм «выбора лидера» удалён из `ReplicatedMergeTree`, поскольку множественные лидеры поддерживаются с версии 20.6. Если вы обновляетесь со старой версии и какая-либо реплика со старой версией является лидером, то сервер не сможет запуститься после обновления. Остановите реплики со старой версией, чтобы запустить новую версию. После этого откат к версии старше 20.6 будет невозможен. [#32140](https://github.com/ClickHouse/ClickHouse/pull/32140) ([tavplubix](https://github.com/tavplubix)).

#### Новые возможности {#new-feature}


* Реализована поддержка большего числа команд ZooKeeper Four Letter Words в clickhouse-keeper: [https://zookeeper.apache.org/doc/r3.4.8/zookeeperAdmin.html#sc&#95;zkCommands](https://zookeeper.apache.org/doc/r3.4.8/zookeeperAdmin.html#sc_zkCommands). [#28981](https://github.com/ClickHouse/ClickHouse/pull/28981) ([JackyWoo](https://github.com/JackyWoo)). Теперь `clickhouse-keeper` функционально завершён.
* Поддержка типа данных `Bool`. [#31072](https://github.com/ClickHouse/ClickHouse/pull/31072) ([kevin wan](https://github.com/MaxWk)).
* Поддержка `PARTITION BY` в хранилищах File, URL, HDFS и для табличной функции `INSERT INTO`. Закрывает [#30273](https://github.com/ClickHouse/ClickHouse/issues/30273). [#30690](https://github.com/ClickHouse/ClickHouse/pull/30690) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена конструкция `CONSTRAINT ... ASSUME ...` (без проверки при выполнении `INSERT`). Добавлена трансформация запроса в КНФ ([https://github.com/ClickHouse/ClickHouse/issues/11749](https://github.com/ClickHouse/ClickHouse/issues/11749)) для более удобной оптимизации. Добавлено простое переписывание запроса с использованием ограничений (пока поддерживается только простое сопоставление; позже будет добавлена поддержка &lt;,=,&gt;...). Добавлена возможность заменять тяжёлые столбцы на лёгкие, если это возможно. [#18787](https://github.com/ClickHouse/ClickHouse/pull/18787) ([Nikita Vasilev](https://github.com/nikvas0)).
* Базовая HTTP-аутентификация для функций http/url. [#31648](https://github.com/ClickHouse/ClickHouse/pull/31648) ([michael1589](https://github.com/michael1589)).
* Добавлена поддержка типа `INTERVAL` в конструкции `STEP` для модификатора `WITH FILL`. [#30927](https://github.com/ClickHouse/ClickHouse/pull/30927) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена поддержка параллельного чтения из нескольких файлов и глоб-шаблонов в предложении `FROM INFILE`. [#30135](https://github.com/ClickHouse/ClickHouse/pull/30135) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* Добавлена поддержка параметров запроса для таблиц и баз данных типа `Identifier`. Закрывает [#27226](https://github.com/ClickHouse/ClickHouse/issues/27226). [#28668](https://github.com/ClickHouse/ClickHouse/pull/28668) ([Nikolay Degterinsky](https://github.com/evillique)).
* *Кратко: существенные улучшения полноты и согласованности текстовых форматов.* Рефакторинг форматов `TSV`, `TSVRaw`, `CSV` и `JSONCompactEachRow`, `JSONCompactStringsEachRow`, удаление дублирования кода, добавление базового интерфейса для форматов с суффиксами `-WithNames` и `-WithNamesAndTypes`. Добавлены форматы `CSVWithNamesAndTypes`, `TSVRawWithNames`, `TSVRawWithNamesAndTypes`, `JSONCompactEachRowWIthNames`, `JSONCompactStringsEachRowWIthNames`, `RowBinaryWithNames`. Добавлена поддержка параллельного парсинга для форматов `TSVWithNamesAndTypes`, `TSVRaw(WithNames/WIthNamesAndTypes)`, `CSVWithNamesAndTypes`, `JSONCompactEachRow(WithNames/WIthNamesAndTypes)`, `JSONCompactStringsEachRow(WithNames/WIthNamesAndTypes)`. Добавлена поддержка сопоставления столбцов и проверки типов для формата `RowBinaryWithNamesAndTypes`. Добавлена настройка `input_format_with_types_use_header`, которая указывает, нужно ли проверять, что типы, записанные в формате `<format_name>WIthNamesAndTypes`, совпадают со структурой таблицы. Добавлена настройка `input_format_csv_empty_as_default` и её использование в формате CSV вместо `input_format_defaults_for_omitted_fields` (так как эта настройка не должна управлять `csv_empty_as_default`). Исправлено использование настройки `input_format_defaults_for_omitted_fields` (она использовалась только как `csv_empty_as_default`, но должна управлять вычислением выражений по умолчанию для пропущенных полей). Исправлен ввод/вывод Nullable в формате `TSVRaw`, этот формат сделан полностью совместимым с вставкой в TSV. Исправлена вставка NULL в `LowCardinality(Nullable)` при включённой `input_format_null_as_default` (ранее вместо фактических NULL вставлялись значения по умолчанию). Исправлена десериализация строк в форматах `JSONStringsEachRow`/`JSONCompactStringsEachRow` (строки парсились только до первого &#39;\n&#39; или &#39;\t&#39;). Добавлена возможность использовать правило экранирования `Raw` во входном формате Template. Добавлена диагностическая информация для входного формата `JSONCompactEachRow(WithNames/WIthNamesAndTypes)`. Исправлена ошибка параллельного парсинга форматов `-WithNames` в случае, когда настройка `min_chunk_bytes_for_parallel_parsing` меньше, чем число байт в одной строке. [#30178](https://github.com/ClickHouse/ClickHouse/pull/30178) ([Kruglov Pavel](https://github.com/Avogar)). Добавлена возможность выводить и парсить имена и типы столбцов во входном/выходном формате `CustomSeparated`. Добавлены форматы `CustomSeparatedWithNames/WithNamesAndTypes`, аналогичные `TSVWithNames/WithNamesAndTypes`. [#31434](https://github.com/ClickHouse/ClickHouse/pull/31434) ([Kruglov Pavel](https://github.com/Avogar)).
* Поддержка хранилища Aliyun OSS. [#31286](https://github.com/ClickHouse/ClickHouse/pull/31286) ([cfcz48](https://github.com/cfcz48)).
* Все настройки глобального пула потоков теперь доступны в конфигурационном файле. [#31285](https://github.com/ClickHouse/ClickHouse/pull/31285) ([Tomáš Hromada](https://github.com/gyfis)).
* Добавлены оконные функции `exponentialTimeDecayedSum`, `exponentialTimeDecayedMax`, `exponentialTimeDecayedCount` и `exponentialTimeDecayedAvg`, которые для больших окон более эффективны, чем `exponentialMovingAverage`. Также охвачено больше вариантов использования. [#29799](https://github.com/ClickHouse/ClickHouse/pull/29799) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Добавлена возможность сжатия логов перед их записью в файл с использованием LZ4. Закрывает [#23860](https://github.com/ClickHouse/ClickHouse/issues/23860). [#29219](https://github.com/ClickHouse/ClickHouse/pull/29219) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена поддержка `JOIN ON 1 = 1` с семантикой CROSS JOIN. Это закрывает [#25578](https://github.com/ClickHouse/ClickHouse/issues/25578). [#25894](https://github.com/ClickHouse/ClickHouse/pull/25894) ([Vladimir C](https://github.com/vdimir)).
* Добавлен комбинатор Map для типа `Map`. — Старые функции `sum-, min-, max- Map` для отображённых массивов переименованы в `sum-, min-, max- MappedArrays`. [#24539](https://github.com/ClickHouse/ClickHouse/pull/24539) ([Ildus Kurbangaliev](https://github.com/ildus)).
* Сделать операции чтения по HTTP повторно выполняемыми. Закрывает [#29696](https://github.com/ClickHouse/ClickHouse/issues/29696). [#29894](https://github.com/ClickHouse/ClickHouse/pull/29894) ([Kseniia Sumarokova](https://github.com/kssenii)).

#### Экспериментальная функциональность {#experimental-feature}

- `WINDOW VIEW` для потоковой обработки данных в ClickHouse. [#8331](https://github.com/ClickHouse/ClickHouse/pull/8331) ([vxider](https://github.com/Vxider)).
- Прекращена поддержка использования баз данных типа Ordinary с `MaterializedMySQL`. [#31292](https://github.com/ClickHouse/ClickHouse/pull/31292) ([Stig Bakken](https://github.com/stigsb)).
- Реализованы команды BACKUP и RESTORE для семейства движков Log. Функциональность находится в разработке. [#30688](https://github.com/ClickHouse/ClickHouse/pull/30688) ([Vitaly Baranov](https://github.com/vitlibar)).

#### Улучшение производительности {#performance-improvement}


- Снижено потребление памяти при чтении форматов `Parquet`, `ORC`, `Arrow` с использованием `s3` / `url` / `hdfs` (управляется настройкой `input_format_allow_seeks`, включена по умолчанию). Также добавлена настройка `remote_read_min_bytes_for_seek` для управления операциями поиска. Закрывает [#10461](https://github.com/ClickHouse/ClickHouse/issues/10461). Закрывает [#16857](https://github.com/ClickHouse/ClickHouse/issues/16857). [#30936](https://github.com/ClickHouse/ClickHouse/pull/30936) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлены оптимизации для константных условий в JOIN ON, см. [#26928](https://github.com/ClickHouse/ClickHouse/issues/26928). [#27021](https://github.com/ClickHouse/ClickHouse/pull/27021) ([Vladimir C](https://github.com/vdimir)).
- Добавлена поддержка параллельного форматирования для всех текстовых форматов, за исключением `JSONEachRowWithProgress` и `PrettyCompactMonoBlock`. [#31489](https://github.com/ClickHouse/ClickHouse/pull/31489) ([Kruglov Pavel](https://github.com/Avogar)).
- Ускорен подсчёт по столбцам, допускающим NULL. [#31806](https://github.com/ClickHouse/ClickHouse/pull/31806) ([Raúl Marín](https://github.com/Algunenano)).
- Ускорены агрегатные функции `avg` и `sumCount`. [#31694](https://github.com/ClickHouse/ClickHouse/pull/31694) ([Raúl Marín](https://github.com/Algunenano)).
- Улучшена производительность выходных форматов JSON и XML. [#31673](https://github.com/ClickHouse/ClickHouse/pull/31673) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Улучшена производительность синхронизации данных с блочным устройством. Закрывает [#31181](https://github.com/ClickHouse/ClickHouse/issues/31181). [#31229](https://github.com/ClickHouse/ClickHouse/pull/31229) ([zhanglistar](https://github.com/zhanglistar)).
- Исправлена проблема производительности запросов в таблицах `LiveView`. Исправляет [#30831](https://github.com/ClickHouse/ClickHouse/issues/30831). [#31006](https://github.com/ClickHouse/ClickHouse/pull/31006) ([vzakaznikov](https://github.com/vzakaznikov)).
- Ускорен разбор запросов. [#31949](https://github.com/ClickHouse/ClickHouse/pull/31949) ([Raúl Marín](https://github.com/Algunenano)).
- Добавлена возможность разделения правил агрегации `GraphiteMergeTree` для обычных и тегированных метрик (необязательное поле `rule_type`). [#25122](https://github.com/ClickHouse/ClickHouse/pull/25122) ([Michail Safronov](https://github.com/msaf1980)).
- Устранены избыточные запросы `DESC TABLE` для `remote()` (в случае `remote('127.1', system.one)` (т. е. идентификатор в качестве db.table вместо строки) выполнялся избыточный запрос `DESC TABLE`). [#32019](https://github.com/ClickHouse/ClickHouse/pull/32019) ([Azat Khuzhin](https://github.com/azat)).
- Оптимизирована функция `tupleElement` для чтения подстолбца при включённой настройке `optimize_functions_to_subcolumns`. [#31261](https://github.com/ClickHouse/ClickHouse/pull/31261) ([Anton Popov](https://github.com/CurtizJ)).
- Оптимизирована функция `mapContains` для чтения подстолбца `key` при включённой настройке `optimize_functions_to_subcolumns`. [#31218](https://github.com/ClickHouse/ClickHouse/pull/31218) ([Anton Popov](https://github.com/CurtizJ)).
- Добавлены настройки `merge_tree_min_rows_for_concurrent_read_for_remote_filesystem` и `merge_tree_min_bytes_for_concurrent_read_for_remote_filesystem`. [#30970](https://github.com/ClickHouse/ClickHouse/pull/30970) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлен пропуск мутаций различных партиций в `StorageMergeTree`. [#21326](https://github.com/ClickHouse/ClickHouse/pull/21326) ([Vladimir Chebotarev](https://github.com/excitoon)).

#### Улучшения {#improvement}


* Запрещено удалять таблицу или словарь, если от них зависят другие таблицы или словари. [#30977](https://github.com/ClickHouse/ClickHouse/pull/30977) ([tavplubix](https://github.com/tavplubix)).
* Добавлена поддержка версионирования состояний агрегатных функций. Теперь мы можем вносить обратно-совместимые изменения в формат сериализации состояний агрегатных функций. Закрывает [#12552](https://github.com/ClickHouse/ClickHouse/issues/12552). [#24820](https://github.com/ClickHouse/ClickHouse/pull/24820) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка синтаксиса `ALTER MODIFY COLUMN` в стиле PostgreSQL. [#32003](https://github.com/ClickHouse/ClickHouse/pull/32003) ([SuperDJY](https://github.com/cmsxbc)).
* Добавлена поддержка `update_field` для словарей `RangeHashedDictionary` и `ComplexKeyRangeHashedDictionary`. [#32185](https://github.com/ClickHouse/ClickHouse/pull/32185) ([Maksim Kita](https://github.com/kitaisreal)).
* Функции `murmurHash3_128` и `sipHash128` теперь принимают произвольное количество аргументов. Это решает [#28774](https://github.com/ClickHouse/ClickHouse/issues/28774). [#28965](https://github.com/ClickHouse/ClickHouse/pull/28965) ([小路](https://github.com/nicelulu)).
* Добавлена поддержка выражения по умолчанию для хранилища `HDFS` и оптимизировано извлечение данных, когда источник имеет столбцевый формат. [#32256](https://github.com/ClickHouse/ClickHouse/pull/32256) ([李扬](https://github.com/taiyang-li)).
* Улучшено имя операции для span OpenTelemetry. [#32234](https://github.com/ClickHouse/ClickHouse/pull/32234) ([Frank Chen](https://github.com/FrankChen021)).
* Используйте `Content-Type: application/x-ndjson` ([http://ndjson.org/](http://ndjson.org/)) для формата результата `JSONEachRow`. [#32223](https://github.com/ClickHouse/ClickHouse/pull/32223) ([Dmitriy Dorofeev](https://github.com/deem0n)).
* Улучшен пропуск неизвестных полей при использовании правила экранирования в кавычках в форматах Template/CustomSeparated. Ранее можно было пропускать только строки в кавычках, теперь можно пропускать значения любого типа. [#32204](https://github.com/ClickHouse/ClickHouse/pull/32204) ([Kruglov Pavel](https://github.com/Avogar)).
* Теперь `clickhouse-keeper` не запускается и не применяет изменения конфигурации, если они содержат дублирующиеся идентификаторы или конечные точки. Исправляет [#31339](https://github.com/ClickHouse/ClickHouse/issues/31339). [#32121](https://github.com/ClickHouse/ClickHouse/pull/32121) ([alesapin](https://github.com/alesapin)).
* Установлен заголовок Content-Type в HTTP-пакетах, формируемых движком URL. [#32113](https://github.com/ClickHouse/ClickHouse/pull/32113) ([Frank Chen](https://github.com/FrankChen021)).
* Возвращать заголовок Content-Type со значением &#39;application/json&#39; для формата `JSONEachRow`, если включен `output_format_json_array_of_rows`. [#32112](https://github.com/ClickHouse/ClickHouse/pull/32112) ([Frank Chen](https://github.com/FrankChen021)).
* Разрешён разбор символа `+` перед значениями `Float32`/`Float64`. [#32079](https://github.com/ClickHouse/ClickHouse/pull/32079) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена возможность настройки пользователем параметра `hdfs_replication` для `DiskHDFS` и `StorageHDFS`. Закрывает [#32039](https://github.com/ClickHouse/ClickHouse/issues/32039). [#32049](https://github.com/ClickHouse/ClickHouse/pull/32049) ([leosunli](https://github.com/leosunli)).
* В журнал спанов OpenTelemetry добавлены поля ClickHouse `exception` и `exception_code`. [#32040](https://github.com/ClickHouse/ClickHouse/pull/32040) ([Frank Chen](https://github.com/FrankChen021)).
* Исправлена длительность логов span для OpenTelemetry — на уровне запроса она обнулялась при возникновении исключения в запросе. [#32038](https://github.com/ClickHouse/ClickHouse/pull/32038) ([Frank Chen](https://github.com/FrankChen021)).
* Исправлена проблема, из-за которой нельзя было создать тип `LowCardinality` для `Int256`. [#31832](https://github.com/ClickHouse/ClickHouse/pull/31832) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Воссоздать таблицы `system.*_log` при изменении движка/partition&#95;by. [#31824](https://github.com/ClickHouse/ClickHouse/pull/31824) ([Azat Khuzhin](https://github.com/azat)).
* `MaterializedMySQL`: Исправлена ошибка при работе с таблицей с именем &#39;table&#39;. [#31781](https://github.com/ClickHouse/ClickHouse/pull/31781) ([Håvard Kvålen](https://github.com/havardk)).
* Источник словаря ClickHouse: добавлена поддержка предопределённых подключений. Закрывает [#31705](https://github.com/ClickHouse/ClickHouse/issues/31705). [#31749](https://github.com/ClickHouse/ClickHouse/pull/31749) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Разрешить использование предопределённой конфигурации подключений для движков Kafka и RabbitMQ (так же, как для других интеграционных табличных движков). [#31691](https://github.com/ClickHouse/ClickHouse/pull/31691) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Всегда перерисовывать строку приглашения при навигации по истории в clickhouse-client. Это улучшит удобство работы с очень длинными запросами, которые не помещаются на экран. [#31675](https://github.com/ClickHouse/ClickHouse/pull/31675) ([alexey-milovidov](https://github.com/alexey-milovidov)) (автор: Amos Bird).
* Добавлены сочетания клавиш для перемещения по истории (вместо по строкам/истории). [#31641](https://github.com/ClickHouse/ClickHouse/pull/31641) ([Azat Khuzhin](https://github.com/azat)).
* Улучшены проверки ограничения `max_execution_time`. Исправлены некоторые случаи, когда проверки тайм-аута не выполнялись и запрос мог выполняться слишком долго. [#31636](https://github.com/ClickHouse/ClickHouse/pull/31636) ([Raúl Marín](https://github.com/Algunenano)).
* Улучшено сообщение об исключении, когда `users.xml` не может быть загружен из-за неверного хеша пароля. Это закрывает [#24126](https://github.com/ClickHouse/ClickHouse/issues/24126). [#31557](https://github.com/ClickHouse/ClickHouse/pull/31557) ([Vitaly Baranov](https://github.com/vitlibar)).
* Использовать имена шарда и реплики из аргументов базы данных `Replicated` при подстановке макросов в аргументах `ReplicatedMergeTree`, если эти макросы не определены в конфигурации. Закрывает [#31471](https://github.com/ClickHouse/ClickHouse/issues/31471). [#31488](https://github.com/ClickHouse/ClickHouse/pull/31488) ([tavplubix](https://github.com/tavplubix)).
* Улучшен анализ проекции `min/max/count`. Теперь при включённом `allow_experimental_projection_optimization` виртуальная проекция `min/max/count` может использоваться вместе со столбцами из ключа партиционирования. [#31474](https://github.com/ClickHouse/ClickHouse/pull/31474) ([Amos Bird](https://github.com/amosbird)).
* Добавлена поддержка параметра `--pager` для `clickhouse-local`. [#31457](https://github.com/ClickHouse/ClickHouse/pull/31457) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено ожидание завершения редактора при интерактивном редактировании запроса (`waitpid()` возвращает -1 при сигнале `SIGWINCH`, когда `EDITOR` и `clickhouse-local`/`clickhouse-client` работают одновременно). [#31456](https://github.com/ClickHouse/ClickHouse/pull/31456) ([Azat Khuzhin](https://github.com/azat)).
* Выбрасывать исключение, если после поля в формате `JSONCompactStrings(EachRow)` обнаруживаются лишние данные. [#31455](https://github.com/ClickHouse/ClickHouse/pull/31455) ([Kruglov Pavel](https://github.com/Avogar)).
* Значение по умолчанию параметров `http_send_timeout` и `http_receive_timeout` изменено с 1800 (30 минут) на 180 (3 минуты). [#31450](https://github.com/ClickHouse/ClickHouse/pull/31450) ([tavplubix](https://github.com/tavplubix)).
* `MaterializedMySQL` теперь обрабатывает DDL-запросы типа `CREATE TABLE ... LIKE ...`. [#31410](https://github.com/ClickHouse/ClickHouse/pull/31410) ([Stig Bakken](https://github.com/stigsb)).
* Возвращает искусственный запрос `CREATE` при выполнении запроса `SHOW CREATE TABLE` для системных таблиц. [#31391](https://github.com/ClickHouse/ClickHouse/pull/31391) ([SuperDJY](https://github.com/cmsxbc)).
* Ранее прогресс выполнения отображался только для табличной функции `numbers`. Теперь он также отображается для `numbers_mt`. [#31318](https://github.com/ClickHouse/ClickHouse/pull/31318) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исходные роли пользователя теперь используются для поиска политик доступа к строкам, см. [#31080](https://github.com/ClickHouse/ClickHouse/issues/31080). [#31262](https://github.com/ClickHouse/ClickHouse/pull/31262) ([Vitaly Baranov](https://github.com/vitlibar)).
* Если изменена какая-либо устаревшая настройка — выводить предупреждение в `system.warnings`. [#31252](https://github.com/ClickHouse/ClickHouse/pull/31252) ([tavplubix](https://github.com/tavplubix)).
* Улучшен механизм backoff для фоновых задач по очистке в `MergeTree`. Настройки `merge_tree_clear_old_temporary_directories_interval_seconds` и `merge_tree_clear_old_parts_interval_seconds` перенесены из пользовательских настроек в настройки `MergeTree`. [#31180](https://github.com/ClickHouse/ClickHouse/pull/31180) ([tavplubix](https://github.com/tavplubix)).
* Теперь каждая реплика отправляет клиенту только инкрементальные значения счётчиков событий профилирования. [#31155](https://github.com/ClickHouse/ClickHouse/pull/31155) ([Dmitry Novik](https://github.com/novikd)). Благодаря этому опция `--hardware_utilization` в `clickhouse-client` становится по-настоящему полезной.
* Включено многострочное редактирование в clickhouse-client по умолчанию. Это решает [#31121](https://github.com/ClickHouse/ClickHouse/issues/31121). [#31123](https://github.com/ClickHouse/ClickHouse/pull/31123) ([Amos Bird](https://github.com/amosbird)).
* Нормализация имён функций для запросов `ALTER`. Это помогает избежать несоответствия метаданных между созданием таблицы с индексами/проекциями и добавлением индексов/проекций с помощью команд `ALTER`. Это последующий PR к [https://github.com/ClickHouse/ClickHouse/pull/20174](https://github.com/ClickHouse/ClickHouse/pull/20174). Отмечено как улучшение, так как нет сообщений об ошибках, а соответствующий сценарий встречается довольно редко. [#31095](https://github.com/ClickHouse/ClickHouse/pull/31095) ([Amos Bird](https://github.com/amosbird)).
* Добавлена поддержка модификатора `IF EXISTS` для запроса `RENAME DATABASE`/`TABLE`/`DICTIONARY`. Если используется этот модификатор, ошибка не возникает, если переименовываемая база данных/таблица/словарь не существует. [#31081](https://github.com/ClickHouse/ClickHouse/pull/31081) ([victorgao](https://github.com/kafka1991)).
* Отменять вертикальные слияния при удалении партиции. Это продолжение [https://github.com/ClickHouse/ClickHouse/pull/25684](https://github.com/ClickHouse/ClickHouse/pull/25684) и [https://github.com/ClickHouse/ClickHouse/pull/30996](https://github.com/ClickHouse/ClickHouse/pull/30996). [#31057](https://github.com/ClickHouse/ClickHouse/pull/31057) ([Amos Bird](https://github.com/amosbird)).
* Локальная сессия внутри источника словаря ClickHouse больше не будет отправлять свои события в журнал сессий. Это устраняет возможную взаимоблокировку (предупреждение TSAN) при завершении работы. Также этот PR исправляет нестабильный тест `test_dictionaries_dependency_xml/`. [#31013](https://github.com/ClickHouse/ClickHouse/pull/31013) ([Vitaly Baranov](https://github.com/vitlibar)).
* Меньше блокировок в запросе ALTER. [#31010](https://github.com/ClickHouse/ClickHouse/pull/31010) ([Amos Bird](https://github.com/amosbird)).
* Исправлена опция `--verbose` в интерактивном режиме утилиты clickhouse-local и добавлена возможность логирования в файл. [#30881](https://github.com/ClickHouse/ClickHouse/pull/30881) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлены команды `\l`, `\d`, `\c` в `clickhouse-client`, как в MySQL и PostgreSQL. [#30876](https://github.com/ClickHouse/ClickHouse/pull/30876) ([Pavel Medvedev](https://github.com/pmed)).
* Для clickhouse-local или clickhouse-client: при использовании опции `--interactive` вместе с `--query` или `--queries-file` они сначала выполняются как при запуске в неинтерактивном режиме, а затем начинается интерактивный режим. [#30851](https://github.com/ClickHouse/ClickHouse/pull/30851) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена возможная ошибка &quot;The local set of parts of X doesn&#39;t look like the set of parts in ZooKeeper&quot; (если DROP завершается с ошибкой во время удаления узлов znode в ZooKeeper). [#30826](https://github.com/ClickHouse/ClickHouse/pull/30826) ([Azat Khuzhin](https://github.com/azat)).
* Формат Avro теперь работает с Kafka. Добавлена настройка `output_format_avro_rows_in_file`. [#30351](https://github.com/ClickHouse/ClickHouse/pull/30351) ([Ilya Golshtein](https://github.com/ilejn)).
* Добавлена возможность указывать одну или несколько схем PostgreSQL для одной базы данных `MaterializedPostgreSQL`. Закрывает [#28901](https://github.com/ClickHouse/ClickHouse/issues/28901). Закрывает [#29324](https://github.com/ClickHouse/ClickHouse/issues/29324). [#28933](https://github.com/ClickHouse/ClickHouse/pull/28933) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Изменены порты по умолчанию для внутреннего взаимодействия clickhouse-keeper с 44444 на 9234. Исправляет [#30879](https://github.com/ClickHouse/ClickHouse/issues/30879). [#31799](https://github.com/ClickHouse/ClickHouse/pull/31799) ([alesapin](https://github.com/alesapin)).
* Реализована функция transform с аргументами типа Decimal. [#31839](https://github.com/ClickHouse/ClickHouse/pull/31839) ([李帅](https://github.com/loneylee)).
* Исправлено аварийное завершение в debug-сервере и ошибка `DB::Exception: std::out_of_range: basic_string` в release-сервере при некорректном URL HDFS за счёт дополнительной проверки структуры URL HDFS. [#31042](https://github.com/ClickHouse/ClickHouse/pull/31042) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено возможное срабатывание `assert` в табличной функции/движке `hdfs`, добавлен тест. [#31036](https://github.com/ClickHouse/ClickHouse/pull/31036) ([Kruglov Pavel](https://github.com/Avogar)).

#### Исправления ошибок {#bug-fixes}


* Исправлена работа псевдонимов в `GROUP BY` / `ORDER BY` / `LIMIT BY` при включённых позиционных аргументах. Закрывает [#31173](https://github.com/ClickHouse/ClickHouse/issues/31173). [#31741](https://github.com/ClickHouse/ClickHouse/pull/31741) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено использование движка таблиц `Buffer` с типом `Map`. Исправлена проблема [#30546](https://github.com/ClickHouse/ClickHouse/issues/30546). [#31742](https://github.com/ClickHouse/ClickHouse/pull/31742) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено чтение из таблиц `MergeTree` при включённом параметре `use_uncompressed_cache`. [#31826](https://github.com/ClickHouse/ClickHouse/pull/31826) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено поведение, при котором мутации, не приводящие ни к каким изменениям, зависали (при включённой настройке `empty_result_for_aggregation_by_empty_set`). [#32358](https://github.com/ClickHouse/ClickHouse/pull/32358) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлен пропуск столбцов при записи в Protobuf. Этот PR исправляет [#31160](https://github.com/ClickHouse/ClickHouse/issues/31160), см. комментарий [#31160](https://github.com/ClickHouse/ClickHouse/issues/31160)#issuecomment-980595318. [#31988](https://github.com/ClickHouse/ClickHouse/pull/31988) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена ошибка при удалении ненужных столбцов в подзапросе. Если в запросе есть агрегатная функция без `GROUP BY`, не следует удалять её, даже если она считается ненужной. [#32289](https://github.com/ClickHouse/ClickHouse/pull/32289) ([dongyifeng](https://github.com/dyf6372)).
* Лимит квоты ещё не был достигнут, но считалось, что он превышен. Этот PR исправляет [#31174](https://github.com/ClickHouse/ClickHouse/issues/31174). [#31337](https://github.com/ClickHouse/ClickHouse/pull/31337) ([sunny](https://github.com/sunny19930321)).
* Исправлена работа `SHOW GRANTS` при частичном отзыве прав. Этот PR исправляет [#31138](https://github.com/ClickHouse/ClickHouse/issues/31138). [#31249](https://github.com/ClickHouse/ClickHouse/pull/31249) ([Vitaly Baranov](https://github.com/vitlibar)).
* Объем памяти неверно оценивался при запуске ClickHouse в контейнерах с ограничениями cgroup. [#31157](https://github.com/ClickHouse/ClickHouse/pull/31157) ([Pavel Medvedev](https://github.com/pmed)).
* Исправлены запросы `ALTER ... MATERIALIZE COLUMN ...` в случаях, когда тип данных выражения значения по умолчанию не совпадает с типом данных столбца. [#32348](https://github.com/ClickHouse/ClickHouse/pull/32348) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено аварийное завершение с SIGFPE в агрегатной функции `avgWeighted` с аргументом `Decimal`. Исправлена проблема [#32053](https://github.com/ClickHouse/ClickHouse/issues/32053). [#32303](https://github.com/ClickHouse/ClickHouse/pull/32303) ([tavplubix](https://github.com/tavplubix)).
* Сервер мог не запуститься с ошибкой `Cannot attach 1 tables due to cyclic dependencies`, если таблица `Dictionary` ссылается на XML-словарь с тем же именем; теперь это исправлено. Исправляет [#31315](https://github.com/ClickHouse/ClickHouse/issues/31315). [#32288](https://github.com/ClickHouse/ClickHouse/pull/32288) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка разбора при десериализации NaN для `Nullable(Float)` при использовании правила экранирования `Quoted`. [#32190](https://github.com/ClickHouse/ClickHouse/pull/32190) ([Kruglov Pavel](https://github.com/Avogar)).
* Словари XML: идентификатели, используемые в запросе создания таблицы, могут автоматически получать префикс `default_database` при обновлении до более новой версии. Закрывает [#31963](https://github.com/ClickHouse/ClickHouse/issues/31963). [#32187](https://github.com/ClickHouse/ClickHouse/pull/32187) ([Maksim Kita](https://github.com/kitaisreal)).
* Количество активных реплик могло определяться некорректно при вставке с кворумом, если параметр `replicated_can_become_leader` был отключен на некоторых репликах. Исправлено. [#32157](https://github.com/ClickHouse/ClickHouse/pull/32157) ([tavplubix](https://github.com/tavplubix)).
* Словари: исправлена проблема, при которой `{condition}` не работает в пользовательских запросах к базе данных. [#32117](https://github.com/ClickHouse/ClickHouse/pull/32117) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена операция `CAST` из `Nullable` при использовании `cast_keep_nullable` (ранее возникала ошибка `PARAMETER_OUT_OF_BOUND`, например для `toUInt32OrDefault(toNullable(toUInt32(1)))`). [#32080](https://github.com/ClickHouse/ClickHouse/pull/32080) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен оператор CREATE TABLE для хранилища Join в некоторых нетривиальных случаях. Закрывает [#31680](https://github.com/ClickHouse/ClickHouse/issues/31680). [#32066](https://github.com/ClickHouse/ClickHouse/pull/32066) ([SuperDJY](https://github.com/cmsxbc)).
* Исправлена ошибка `Directory ... already exists and is not empty` при отсоединении части. [#32063](https://github.com/ClickHouse/ClickHouse/pull/32063) ([tavplubix](https://github.com/tavplubix)).
* `MaterializedMySQL` (экспериментальная возможность): Исправлена неверная интерпретация данных `DECIMAL` из MySQL. [#31990](https://github.com/ClickHouse/ClickHouse/pull/31990) ([Håvard Kvålen](https://github.com/havardk)).
* Движок `FileLog` (экспериментальная возможность) излишне создавал каталог метаданных при неудачной попытке создания таблицы. Исправлено [#31962](https://github.com/ClickHouse/ClickHouse/issues/31962). [#31967](https://github.com/ClickHouse/ClickHouse/pull/31967) ([flynn](https://github.com/ucasfl)).
* Некоторые записи `GET_PART` могли зависать в очереди репликации, если часть была потеряна на всех репликах и в той же партиции не было других частей. Проблема исправлена в случаях, когда ключ партиции содержит только столбцы целочисленных типов или `Date[Time]`. Исправляет [#31485](https://github.com/ClickHouse/ClickHouse/issues/31485). [#31887](https://github.com/ClickHouse/ClickHouse/pull/31887) ([tavplubix](https://github.com/tavplubix)).
* Исправлены функции `empty` и `notEmpty` для аргументов типа `UUID`. Исправлено [#31819](https://github.com/ClickHouse/ClickHouse/issues/31819). [#31883](https://github.com/ClickHouse/ClickHouse/pull/31883) ([Anton Popov](https://github.com/CurtizJ)).
* Изменён путь конфигурационного параметра с `keeper_server.session_timeout_ms` на `keeper_server.coordination_settings.session_timeout_ms` при создании `KeeperTCPHandler`. То же самое для `operation_timeout`. [#31859](https://github.com/ClickHouse/ClickHouse/pull/31859) ([JackyWoo](https://github.com/JackyWoo)).
* Исправлено некорректное приведение типа `Nullable` при использовании допускающего `NULL` первичного ключа. (Допускающий `NULL` первичный ключ — нежелательная возможность, пожалуйста, не используйте её). Это исправляет [#31075](https://github.com/ClickHouse/ClickHouse/issues/31075). [#31823](https://github.com/ClickHouse/ClickHouse/pull/31823) ([Amos Bird](https://github.com/amosbird)).
* Исправлено падение при использовании рекурсивной UDF в SQL. Закрывает [#30856](https://github.com/ClickHouse/ClickHouse/issues/30856). [#31820](https://github.com/ClickHouse/ClickHouse/pull/31820) ([Maksim Kita](https://github.com/kitaisreal)).
* Устранено аварийное завершение при использовании функции `dictGet` с указанием типа для атрибута словаря типа `Nullable`. Исправляет [#30980](https://github.com/ClickHouse/ClickHouse/issues/30980). [#31800](https://github.com/ClickHouse/ClickHouse/pull/31800) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена ошибка, приводившая к сбою при пустом результате ODBC-запроса (с некоторыми ODBC-драйверами). Закрывает [#31465](https://github.com/ClickHouse/ClickHouse/issues/31465). [#31766](https://github.com/ClickHouse/ClickHouse/pull/31766) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проблема с отключением профилировщика запросов (в случае `query_profiler_real_time_period_ns>0`/`query_profiler_cpu_time_period_ns>0` профилировщик запросов мог оставаться включённым даже после завершения запроса). [#31740](https://github.com/ClickHouse/ClickHouse/pull/31740) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена редкая ошибка сегментирования при одновременных запросах `ATTACH PARTITION`. [#31738](https://github.com/ClickHouse/ClickHouse/pull/31738) ([tavplubix](https://github.com/tavplubix)).
* Исправлена гонка состояний в формате вывода JSONEachRowWithProgress, возникавшая при одновременном выводе данных и строк с прогрессом. [#31736](https://github.com/ClickHouse/ClickHouse/pull/31736) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка `there are no such cluster here` при выполнении запроса `ON CLUSTER`, если указанное имя кластера совпадает с именем базы данных `Replicated`. [#31723](https://github.com/ClickHouse/ClickHouse/pull/31723) ([tavplubix](https://github.com/tavplubix)).
* Исправлено исключение при некоторых вызовах функции `decrypt` для столбцов типа Nullable. Это закрывает [#31662](https://github.com/ClickHouse/ClickHouse/issues/31662). Это закрывает [#31426](https://github.com/ClickHouse/ClickHouse/issues/31426). [#31707](https://github.com/ClickHouse/ClickHouse/pull/31707) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена функция ngrams при наличии в строке символов UTF-8. [#31706](https://github.com/ClickHouse/ClickHouse/pull/31706) ([yandd](https://github.com/yandd)).
* Настройки `input_format_allow_errors_num` и `input_format_allow_errors_ratio` не работали при разборе доменных типов данных, таких как `IPv4`; проблема исправлена. Исправление для [#31686](https://github.com/ClickHouse/ClickHouse/issues/31686). [#31697](https://github.com/ClickHouse/ClickHouse/pull/31697) ([tavplubix](https://github.com/tavplubix)).
* Исправлено исключение нулевого указателя в `MATERIALIZE COLUMN`. [#31679](https://github.com/ClickHouse/ClickHouse/pull/31679) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Запрос `RENAME TABLE` работал некорректно при попытке переименовать словарь DDL в базе данных `Ordinary`, ошибка исправлена. [#31638](https://github.com/ClickHouse/ClickHouse/pull/31638) ([tavplubix](https://github.com/tavplubix)).
* Реализована агрегатная функция `sparkbar` так, как она изначально задумывалась, см.: [#26175](https://github.com/ClickHouse/ClickHouse/issues/26175)#issuecomment-960353867, [комментарий](https://github.com/ClickHouse/ClickHouse/issues/26175#issuecomment-961155065). [#31624](https://github.com/ClickHouse/ClickHouse/pull/31624) ([小路](https://github.com/nicelulu)).
* Исправлена ошибка генерации некорректного JSON, возникавшая, когда только имена столбцов содержали недопустимые последовательности UTF-8. [#31534](https://github.com/ClickHouse/ClickHouse/pull/31534) ([Kevin Michel](https://github.com/kmichel-aiven)).
* Отключите `partial_merge_join_left_table_buffer_bytes`, пока ошибка в этой оптимизации не будет исправлена. См. [#31009](https://github.com/ClickHouse/ClickHouse/issues/31009)). Удалите избыточный параметр `partial_merge_join_optimizations`. [#31528](https://github.com/ClickHouse/ClickHouse/pull/31528) ([Vladimir C](https://github.com/vdimir)).
* Исправлено отображение прогресса для коротких запросов `INSERT SELECT`. [#31510](https://github.com/ClickHouse/ClickHouse/pull/31510) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено некорректное поведение при использовании `GROUP BY` и позиционных аргументов. Закрывает [#31280](https://github.com/ClickHouse/ClickHouse/issues/31280)#issuecomment-968696186. [#31420](https://github.com/ClickHouse/ClickHouse/pull/31420) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проблема с `nullptr` в провайдере учетных данных STS для S3. [#31409](https://github.com/ClickHouse/ClickHouse/pull/31409) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Удалена функция `notLike` из анализа индексов, поскольку она работала некорректно. [#31169](https://github.com/ClickHouse/ClickHouse/pull/31169) ([sundyli](https://github.com/sundy-li)).
* Исправлена ошибка в Keeper, из-за которой он мог не запускаться в случае потери части coordination logs и наличия более свежего snapshot, чем последний log. [#31150](https://github.com/ClickHouse/ClickHouse/pull/31150) ([alesapin](https://github.com/alesapin)).
* Переписана обработка правой Distributed-таблицы в локальном JOIN. Исправляет [#25809](https://github.com/ClickHouse/ClickHouse/issues/25809). [#31105](https://github.com/ClickHouse/ClickHouse/pull/31105) ([abel-cheng](https://github.com/abel-cheng)).
* Исправлена работа таблицы `Merge` с псевдонимами и условием WHERE (ранее она совсем не работала). Закрывает [#28802](https://github.com/ClickHouse/ClickHouse/issues/28802). [#31044](https://github.com/ClickHouse/ClickHouse/pull/31044) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена работа JSON&#95;VALUE/JSON&#95;QUERY с идентификаторами, заключёнными в кавычки. Это позволяет использовать пробелы в JSON-пути. Закрывает [#30971](https://github.com/ClickHouse/ClickHouse/issues/30971). [#31003](https://github.com/ClickHouse/ClickHouse/pull/31003) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Использование функции `formatRow` с форматами, не ориентированными на строки, приводило к ошибке сегментации (segfault). Теперь использование этой функции с такими форматами запрещено (так как это не имеет смысла). [#31001](https://github.com/ClickHouse/ClickHouse/pull/31001) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка, из-за которой `SELECT`-запросы завершались с ошибкой, если они выполнялись после удаления материализованного представления. Ошибка обнаружена в [#30691](https://github.com/ClickHouse/ClickHouse/issues/30691). [#30997](https://github.com/ClickHouse/ClickHouse/pull/30997) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Пропускать проверку параметра `max_partition_size_to_drop` для операторов ATTACH PARTITION ... FROM и MOVE PARTITION ... [#30995](https://github.com/ClickHouse/ClickHouse/pull/30995) ([Amr Alaa](https://github.com/amralaa-MSFT)).
* Исправлены некоторые частные случаи с операторами `INTERSECT` и `EXCEPT`. Закрывает [#30803](https://github.com/ClickHouse/ClickHouse/issues/30803). [#30965](https://github.com/ClickHouse/ClickHouse/pull/30965) ([Kseniia Sumarokova](https://github.com/kssenii)).

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement}

- Исправлен некорректный результат фильтрации в сборках для архитектур, отличных от x86. Закрывает [#31417](https://github.com/ClickHouse/ClickHouse/issues/31417). Закрывает [#31524](https://github.com/ClickHouse/ClickHouse/issues/31524). [#31574](https://github.com/ClickHouse/ClickHouse/pull/31574) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Сборка ClickHouse теперь полностью воспроизводима (побайтово идентична на разных машинах). Закрывает [#22113](https://github.com/ClickHouse/ClickHouse/issues/22113). [#31899](https://github.com/ClickHouse/ClickHouse/pull/31899) ([alexey-milovidov](https://github.com/alexey-milovidov)). Удалён путь файловой системы к директории сборки из бинарных файлов для обеспечения воспроизводимых сборок. Необходимо для [#22113](https://github.com/ClickHouse/ClickHouse/issues/22113). [#31838](https://github.com/ClickHouse/ClickHouse/pull/31838) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Используются собственные CMakeLists для `zlib-ng`, `cassandra`, `mariadb-connector-c` и `xz`, `re2`, `sentry`, `gsasl`, `arrow`, `protobuf`. Необходимо для [#20151](https://github.com/ClickHouse/ClickHouse/issues/20151). Часть [#9226](https://github.com/ClickHouse/ClickHouse/issues/9226). Небольшой шаг к удалению ненужных элементов из системы сборки. [#30599](https://github.com/ClickHouse/ClickHouse/pull/30599) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Герметичные сборки: используется фиксированная версия libc, и обеспечивается отсутствие использования исходных или бинарных файлов из операционной системы хоста во время сборки. Закрывает [#27133](https://github.com/ClickHouse/ClickHouse/issues/27133). Закрывает [#21435](https://github.com/ClickHouse/ClickHouse/issues/21435). Закрывает [#30462](https://github.com/ClickHouse/ClickHouse/issues/30462). [#30011](https://github.com/ClickHouse/ClickHouse/pull/30011) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлена функция `getFuzzerData()` для упрощения фаззинг-тестирования отдельных функций. Закрывает [#23227](https://github.com/ClickHouse/ClickHouse/issues/23227). [#27526](https://github.com/ClickHouse/ClickHouse/pull/27526) ([Alexey Boykov](https://github.com/mathalex)).
- Более корректная настройка capabilities внутри Docker. [#31802](https://github.com/ClickHouse/ClickHouse/pull/31802) ([Constantine Peresypkin](https://github.com/pkit)).
- Включены опции компиляции clang `-fstrict-vtable-pointers`, `-fwhole-program-vtables`. [#20151](https://github.com/ClickHouse/ClickHouse/pull/20151) ([Maksim Kita](https://github.com/kitaisreal)).
- Исключена загрузка архивов toolchain для кросс-компиляции под FreeBSD. [#31672](https://github.com/ClickHouse/ClickHouse/pull/31672) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Начальная поддержка risc-v. См. development/build-cross-riscv для особенностей и протестированной команды сборки. [#31309](https://github.com/ClickHouse/ClickHouse/pull/31309) ([Vladimir Smirnov](https://github.com/Civil)).
- Поддержка компиляции на машинах arm с параметром "-DENABLE_TESTS=OFF". [#31007](https://github.com/ClickHouse/ClickHouse/pull/31007) ([zhanghuajie](https://github.com/zhanghuajieHIT)).

### Релиз ClickHouse v21.11, 2021-11-09 {#clickhouse-release-v2111-2021-11-09}

#### Обратно несовместимое изменение {#backward-incompatible-change-1}


- Изменён порядок аргументов json_path и json в функциях SQL/JSON (для соответствия стандарту). Закрывает [#30449](https://github.com/ClickHouse/ClickHouse/issues/30449). [#30474](https://github.com/ClickHouse/ClickHouse/pull/30474) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Удалена настройка таблицы `MergeTree` `write_final_mark`. Теперь она всегда имеет значение `true`. [#30455](https://github.com/ClickHouse/ClickHouse/pull/30455) ([Kseniia Sumarokova](https://github.com/kssenii)). Никаких действий не требуется, все таблицы совместимы с новой версией.
- Функция `bayesAB` удалена. Пожалуйста, помогите вернуть эту функцию в обновлённом виде. Закрывает [#26233](https://github.com/ClickHouse/ClickHouse/issues/26233). [#29934](https://github.com/ClickHouse/ClickHouse/pull/29934) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Это актуально только в том случае, если вы уже начали использовать экспериментальную поддержку `clickhouse-keeper`. Теперь снимки ClickHouse Keeper по умолчанию сжимаются кодеком `ZSTD` вместо пользовательского блочного сжатия ClickHouse LZ4. Это поведение можно отключить с помощью настройки координации `compress_snapshots_with_zstd_format` (должна быть одинаковой на всех репликах кворума). Обратная несовместимость встречается довольно редко и может возникнуть только в том случае, когда новый узел отправит снимок (происходит при восстановлении) старому узлу, который не может читать снимки в формате ZSTD. [#29417](https://github.com/ClickHouse/ClickHouse/pull/29417) ([alesapin](https://github.com/alesapin)).

#### Новая функциональность {#new-feature-1}


* Новый асинхронный режим INSERT позволяет накапливать вставляемые данные и сохранять их одним пакетом в фоновом режиме. На стороне клиента он может быть включен установкой `async_insert` для запросов `INSERT` с данными, встроенными в запрос, или передаваемыми в отдельном буфере (например, для запросов `INSERT` через протокол HTTP). Если `wait_for_async_insert` имеет значение true (по умолчанию), клиент будет ждать, пока данные не будут записаны в таблицу. На стороне сервера он управляется настройками `async_insert_threads`, `async_insert_max_data_size` и `async_insert_busy_timeout_ms`. Реализует [#18282](https://github.com/ClickHouse/ClickHouse/issues/18282). [#27537](https://github.com/ClickHouse/ClickHouse/pull/27537) ([Anton Popov](https://github.com/CurtizJ)). [#20557](https://github.com/ClickHouse/ClickHouse/pull/20557) ([Ivan](https://github.com/abyss7)). Замечания о производительности: с асинхронными вставками можно выполнять до примерно 10 000 отдельных запросов INSERT в секунду, поэтому по‑прежнему рекомендуется выполнять вставку пакетами, если вы хотите достичь производительности до миллионов вставляемых строк в секунду.
* Добавлен интерактивный режим для `clickhouse-local`. Теперь можно просто запустить `clickhouse-local`, чтобы получить интерфейс командной строки ClickHouse без подключения к серверу и обрабатывать данные из файлов и внешних источников. Также объединён код `clickhouse-client` и `clickhouse-local`. Закрывает [#7203](https://github.com/ClickHouse/ClickHouse/issues/7203). Закрывает [#25516](https://github.com/ClickHouse/ClickHouse/issues/25516). Закрывает [#22401](https://github.com/ClickHouse/ClickHouse/issues/22401). [#26231](https://github.com/ClickHouse/ClickHouse/pull/26231) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка исполняемых (скриптовых) пользовательских функций. Это UDF, которые могут быть написаны на любом языке программирования. [#28803](https://github.com/ClickHouse/ClickHouse/pull/28803) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена поддержка предопределённых подключений к внешним источникам данных. Это позволяет не указывать учётные данные или адреса при использовании внешних источников данных — вместо этого к ним можно обращаться по именам. Закрывает [#28367](https://github.com/ClickHouse/ClickHouse/issues/28367). [#28577](https://github.com/ClickHouse/ClickHouse/pull/28577) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена база данных `INFORMATION_SCHEMA` с представлениями `SCHEMATA`, `TABLES`, `VIEWS` и `COLUMNS`, соответствующими одноимённым таблицам в базе данных `system`. Закрывает [#9770](https://github.com/ClickHouse/ClickHouse/issues/9770). [#28691](https://github.com/ClickHouse/ClickHouse/pull/28691) ([tavplubix](https://github.com/tavplubix)).
* Добавлена поддержка `EXISTS (subquery)`. Закрывает [#6852](https://github.com/ClickHouse/ClickHouse/issues/6852). [#29731](https://github.com/ClickHouse/ClickHouse/pull/29731) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Журналирование сеансов для аудита. Запись всех успешных и неудачных попыток входа и выхода в новую таблицу `system.session_log`. [#22415](https://github.com/ClickHouse/ClickHouse/pull/22415) ([Vasily Nemkov](https://github.com/Enmk)) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена поддержка функций многомерного косинусного расстояния и евклидова расстояния, а также расстояний и норм L1, L2, Lp, Linf. Реализованы скалярное произведение над кортежами и различные арифметические операторы для кортежей. Это полностью закрывает [#4509](https://github.com/ClickHouse/ClickHouse/issues/4509) и даже больше. [#27933](https://github.com/ClickHouse/ClickHouse/pull/27933) ([Alexey Boykov](https://github.com/mathalex)).
* Добавлена поддержка сжатия и распаковки данных для `INTO OUTFILE` и `FROM INFILE` (с автоопределением или с дополнительным необязательным параметром). [#27135](https://github.com/ClickHouse/ClickHouse/pull/27135) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* Добавлена поддержка CORS (Cross-Origin Resource Sharing) с помощью HTTP-запроса `OPTIONS`. Это означает, что теперь Grafana сможет работать с бессерверными запросами без обходных решений. Закрывает [#18693](https://github.com/ClickHouse/ClickHouse/issues/18693). [#29155](https://github.com/ClickHouse/ClickHouse/pull/29155) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* Запросы с JOIN ON теперь поддерживают логические дизъюнкции (оператор OR). [#21320](https://github.com/ClickHouse/ClickHouse/pull/21320) ([Ilya Golshtein](https://github.com/ilejn)).
* Добавлена функция `tokens`, которая позволяет разбивать строку на токены, используя небуквенно-цифровые символы ASCII в качестве разделителей. [#29981](https://github.com/ClickHouse/ClickHouse/pull/29981) ([Maksim Kita](https://github.com/kitaisreal)). Добавлена функция `ngrams` для извлечения n-грамм из текста. Закрывает [#29699](https://github.com/ClickHouse/ClickHouse/issues/29699). [#29738](https://github.com/ClickHouse/ClickHouse/pull/29738) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлены функции нормализации Unicode: `normalizeUTF8NFC`, `normalizeUTF8NFD`, `normalizeUTF8NFKC`, `normalizeUTF8NFKD`. [#28633](https://github.com/ClickHouse/ClickHouse/pull/28633) ([darkkeks](https://github.com/darkkeks)).
* Потоковое потребление лог-файлов приложений в ClickHouse с помощью движка таблицы `FileLog`. Он аналогичен движкам `Kafka` или `RabbitMQ`, но предназначен для логов в локальной файловой системе, поддерживающих только добавление (append-only) и ротацию. Закрывает [#6953](https://github.com/ClickHouse/ClickHouse/issues/6953). [#25969](https://github.com/ClickHouse/ClickHouse/pull/25969) ([flynn](https://github.com/ucasfl)) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлен формат вывода `CapnProto`, переработан формат ввода `CapnProto`. [#29291](https://github.com/ClickHouse/ClickHouse/pull/29291) ([Kruglov Pavel](https://github.com/Avogar)).
* Разрешена запись чисел в запросах в виде двоичных литералов. Пример: `SELECT 0b001;`. [#29304](https://github.com/ClickHouse/ClickHouse/pull/29304) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлен тип словаря `hashed_array`. Он экономит память при работе со словарями с несколькими атрибутами. Закрывает [#30236](https://github.com/ClickHouse/ClickHouse/issues/30236). [#30242](https://github.com/ClickHouse/ClickHouse/pull/30242) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена функция `JSONExtractKeys`. [#30056](https://github.com/ClickHouse/ClickHouse/pull/30056) ([Vitaly](https://github.com/orloffv)).
* Добавлена функция `getOSKernelVersion`, которая возвращает строку с версией ядра ОС. [#29755](https://github.com/ClickHouse/ClickHouse/pull/29755) ([Memo](https://github.com/Joeywzr)).
* Добавлены функции `MD4` и `SHA384`. `MD4` — устаревшая и небезопасная хеш-функция, её следует использовать только в редких случаях, когда MD4 уже применяется в какой-либо легаси-системе и вам необходимо получить в точности тот же результат. [#29602](https://github.com/ClickHouse/ClickHouse/pull/29602) ([Nikita Tikhomirov](https://github.com/NSTikhomirov)).
* HSTS можно включить для HTTP-сервера ClickHouse, задав положительное значение параметра `hsts_max_age` в конфигурационном файле. [#29516](https://github.com/ClickHouse/ClickHouse/pull/29516) ([凌涛](https://github.com/lingtaolf)).
* Поддержка хранилища Huawei OBS. Закрывает [#24294](https://github.com/ClickHouse/ClickHouse/issues/24294). [#29511](https://github.com/ClickHouse/ClickHouse/pull/29511) ([kevin wan](https://github.com/MaxWk)).
* Новая функция `mapContainsKeyLike` для проверки, содержит ли map ключ, соответствующий простому регулярному выражению. [#29471](https://github.com/ClickHouse/ClickHouse/pull/29471) ([凌涛](https://github.com/lingtaolf)). Новая функция `mapExtractKeyLike` для получения map, в котором остаются только элементы с ключами, соответствующими заданному шаблону. [#30793](https://github.com/ClickHouse/ClickHouse/pull/30793) ([凌涛](https://github.com/lingtaolf)).
* Реализована поддержка `ALTER TABLE x MODIFY COMMENT`. [#29264](https://github.com/ClickHouse/ClickHouse/pull/29264) ([Vasily Nemkov](https://github.com/Enmk)).
* Добавляет функции анализа H3, которые отсутствуют в ClickHouse, но доступны через H3 API: [https://h3geo.org/docs/api/inspection](https://h3geo.org/docs/api/inspection). [#29209](https://github.com/ClickHouse/ClickHouse/pull/29209) ([Bharat Nallan](https://github.com/bharatnc)).
* Разрешить выполнение нереплицируемых ALTER TABLE FETCH и ATTACH в реплицируемых базах данных. [#29202](https://github.com/ClickHouse/ClickHouse/pull/29202) ([Kevin Michel](https://github.com/kmichel-aiven)).
* Добавлена настройка `output_format_csv_null_representation`: она аналогична `output_format_tsv_null_representation`, но предназначена для вывода в формате CSV. [#29123](https://github.com/ClickHouse/ClickHouse/pull/29123) ([PHO](https://github.com/depressed-pho)).
* Добавлена функция `zookeeperSessionUptime()`, которая возвращает время работы текущей сессии ZooKeeper в секундах. [#28983](https://github.com/ClickHouse/ClickHouse/pull/28983) ([tavplubix](https://github.com/tavplubix)).
* Реализована функция `h3ToGeoBoundary`. [#28952](https://github.com/ClickHouse/ClickHouse/pull/28952) ([Ivan Veselov](https://github.com/fuzzERot)).
* Добавлена агрегатная функция `exponentialMovingAverage`, которую можно использовать как оконную. Это решает проблему [#27511](https://github.com/ClickHouse/ClickHouse/issues/27511). [#28914](https://github.com/ClickHouse/ClickHouse/pull/28914) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Теперь можно включать подколонки столбцов таблицы в результат запроса `DESCRIBE` (включается настройкой `describe_include_subcolumns`). [#28905](https://github.com/ClickHouse/ClickHouse/pull/28905) ([Anton Popov](https://github.com/CurtizJ)).
* `Executable`, `ExecutablePool` добавлен параметр `send_chunk_header`. Если этот параметр имеет значение true, то перед чанком клиенту будет отправлено количество строк в чанке (rows&#95;count) с символом перевода строки. [#28833](https://github.com/ClickHouse/ClickHouse/pull/28833) ([Maksim Kita](https://github.com/kitaisreal)).
* `tokenbf_v1` и `ngram` поддерживают `Map` с ключом типа `String` или `FixedSring`. Это повышает эффективность пропуска данных при выполнении запроса с фильтром по ключу `Map`. `sql CREATE TABLE map_tokenbf ( row_id UInt32, map Map(String, String), INDEX map_tokenbf map TYPE ngrambf_v1(4,256,2,0) GRANULARITY 1 ) Engine=MergeTree() Order by id ` С приведённой выше таблицей запрос `select * from map_tokebf where map['K']='V'` будет пропускать гранулы, которые не содержат ключ `A`. Разумеется, то, сколько строк будет пропущено, зависит от значений `granularity` и `index_granularity`, которые вы задали. [#28511](https://github.com/ClickHouse/ClickHouse/pull/28511) ([凌涛](https://github.com/lingtaolf)).
* Добавлена отправка событий профилирования с сервера на клиент. Введён новый тип пакета `ProfileEvents`. Закрывает [#26177](https://github.com/ClickHouse/ClickHouse/issues/26177). [#28364](https://github.com/ClickHouse/ClickHouse/pull/28364) ([Dmitry Novik](https://github.com/novikd)).
* Операции побитового сдвига для типов данных `FixedString` и `String`. Это закрывает задачу [#27763](https://github.com/ClickHouse/ClickHouse/issues/27763). [#28325](https://github.com/ClickHouse/ClickHouse/pull/28325) ([小路](https://github.com/nicelulu)).
* Реализована возможность динамически добавлять и удалять таблицы из репликации из PostgreSQL в движке базы данных MaterializedPostgreSQL. Добавлена поддержка изменения настроек базы данных с помощью `ALTER`. Закрывает [#27573](https://github.com/ClickHouse/ClickHouse/issues/27573). [#28301](https://github.com/ClickHouse/ClickHouse/pull/28301) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена функция accurateCastOrDefault(x, T). Закрыта задача [#21330](https://github.com/ClickHouse/ClickHouse/issues/21330). Авторы: @taiyang-li. [#23028](https://github.com/ClickHouse/ClickHouse/pull/23028) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлены функции `toUUIDOrDefault`, `toUInt8/16/32/64/256OrDefault`, `toInt8/16/32/64/128/256OrDefault`, которые позволяют пользователю задавать значение по умолчанию (не `null`) при ошибке разбора строки. [#21330](https://github.com/ClickHouse/ClickHouse/pull/21330) ([taiyang-li](https://github.com/taiyang-li)).

#### Улучшение производительности {#performance-improvement-1}


* Фоновые слияния могут прерывать друг друга и планируются с соответствующими приоритетами. Теперь длительные слияния не будут препятствовать выполнению коротких. Это необходимо для более эффективного планирования и контроля выполнения слияний. Это снижает вероятность ошибки «too many parts». [#22381](https://github.com/ClickHouse/ClickHouse/issues/22381). [#25165](https://github.com/ClickHouse/ClickHouse/pull/25165) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)). Добавлена возможность выполнять больше слияний и мутаций, чем число потоков в пуле фоновых задач. Слияния и мутации будут выполняться поэтапно в соответствии с их размерами (меньший размер имеет более высокий приоритет). Соотношение числа задач к числу потоков для выполнения регулируется настройкой `background_merges_mutations_concurrency_ratio`, по умолчанию равно 2. [#29140](https://github.com/ClickHouse/ClickHouse/pull/29140) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Разрешено использовать асинхронное чтение для удалённых файловых систем. Уменьшено число операций позиционирования (seeks) при чтении из удалённых файловых систем. Это значительно повышает производительность и делает экспериментальные диски `web` и `s3` быстрее, чем EBS при определённых условиях. [#29205](https://github.com/ClickHouse/ClickHouse/pull/29205) ([Kseniia Sumarokova](https://github.com/kssenii)). При этом тип диска `web` (статический набор данных, размещённый на веб-сервере) выведен из экспериментального статуса и признан готовым к промышленной эксплуатации.
* Запросы с `INTO OUTFILE` в `clickhouse-client` теперь используют несколько потоков. Устранена проблема с мерцающей строкой прогресса при использовании `INTO OUTFILE`. Закрывает [#30873](https://github.com/ClickHouse/ClickHouse/issues/30873). Закрывает [#30872](https://github.com/ClickHouse/ClickHouse/issues/30872). [#30886](https://github.com/ClickHouse/ClickHouse/pull/30886) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Снижено количество избыточных сжатых данных, считываемых с диска для некоторых типов запросов `SELECT` (только для семейства движков `MergeTree`). [#30111](https://github.com/ClickHouse/ClickHouse/pull/30111) ([alesapin](https://github.com/alesapin)).
* Удалены некоторые лишние вызовы `seek` при чтении сжатых блоков в семействах движков таблиц MergeTree. [#29766](https://github.com/ClickHouse/ClickHouse/pull/29766) ([alesapin](https://github.com/alesapin)).
* Сделать табличную функцию `url` способной обрабатывать несколько URL параллельно. Тем самым закрываются [#29670](https://github.com/ClickHouse/ClickHouse/issues/29670) и [#29671](https://github.com/ClickHouse/ClickHouse/issues/29671). [#29673](https://github.com/ClickHouse/ClickHouse/pull/29673) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Улучшена производительность агрегации в порядке первичного ключа (при включённой настройке `optimize_aggregation_in_order`). [#30266](https://github.com/ClickHouse/ClickHouse/pull/30266) ([Anton Popov](https://github.com/CurtizJ)).
* Теперь ClickHouse использует DNS‑кэш при взаимодействии с внешним S3. [#29999](https://github.com/ClickHouse/ClickHouse/pull/29999) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка передачи (pushdown) условий `IS NULL`/`IS NOT NULL` во внешние базы данных (например, MySQL). [#29463](https://github.com/ClickHouse/ClickHouse/pull/29463) ([Azat Khuzhin](https://github.com/azat)). Добавлено преобразование `isNull`/`isNotNull` в `IS NULL`/`IS NOT NULL` (для внешних БД, например, MySQL). [#29446](https://github.com/ClickHouse/ClickHouse/pull/29446) ([Azat Khuzhin](https://github.com/azat)).
* Запросы SELECT к таблицам словарей будут выполняться с использованием нескольких потоков. [#30500](https://github.com/ClickHouse/ClickHouse/pull/30500) ([Maksim Kita](https://github.com/kitaisreal)).
* Повышена производительность фильтрации (операция WHERE) по столбцам с типом данных `Decimal`. [#30431](https://github.com/ClickHouse/ClickHouse/pull/30431) ([Jun Jin](https://github.com/vesslanjin)).
* В операции фильтрации удалён ветвящийся код и заменён более эффективной реализацией с использованием popcnt/ctz, которые обеспечивают лучшую производительность. [#29881](https://github.com/ClickHouse/ClickHouse/pull/29881) ([Jun Jin](https://github.com/vesslanjin)).
* Улучшен генератор байтовой маски фильтра (используемой для оператора WHERE) за счёт объединения всех реализаций в одну с использованием инструкций SSE/AVX2/AVX512. Обратите внимание, что по умолчанию ClickHouse использует только SSE, поэтому это актуально только для кастомных сборок. [#30014](https://github.com/ClickHouse/ClickHouse/pull/30014) ([jasperzhu](https://github.com/jinjunzh)). [#30670](https://github.com/ClickHouse/ClickHouse/pull/30670) ([jasperzhu](https://github.com/jinjunzh)).
* Улучшена производительность агрегатной функции SUM для чисел с плавающей запятой типа Nullable. [#28906](https://github.com/ClickHouse/ClickHouse/pull/28906) ([Raúl Marín](https://github.com/Algunenano)).
* Ускорена загрузка частей при использовании нескольких дисков. Идея схожа с [https://github.com/ClickHouse/ClickHouse/pull/16423](https://github.com/ClickHouse/ClickHouse/pull/16423). В продакшене зафиксировано улучшение: 24 мин -&gt; 16 мин. [#28363](https://github.com/ClickHouse/ClickHouse/pull/28363) ([Amos Bird](https://github.com/amosbird)).
* Уменьшён размер части по умолчанию при многосоставной (multipart) загрузке в S3 для снижения использования памяти. [#28679](https://github.com/ClickHouse/ClickHouse/pull/28679) ([ianton-ru](https://github.com/ianton-ru)).
* Повышена производительность функции `bitmapAnd`. [#28332](https://github.com/ClickHouse/ClickHouse/pull/28332) ([dddounaiking](https://github.com/OodounaikingoO)).
* Удалены неоптимальные уведомления о мутациях в `StorageMergeTree` во время выполнения слияний. [#27552](https://github.com/ClickHouse/ClickHouse/pull/27552) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Попытка повысить производительность сравнения строк. [#28767](https://github.com/ClickHouse/ClickHouse/pull/28767) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Индекс первичного ключа и фильтр по партиции могут работать в виде кортежей. [#29281](https://github.com/ClickHouse/ClickHouse/pull/29281) ([凌涛](https://github.com/lingtaolf)).
* Если запрос содержит несколько агрегатных функций квантиля с одинаковыми аргументами, но разным параметром уровня, они будут объединены и выполнены за один проход при включённой настройке `optimize_syntax_fuse_functions`. [#26657](https://github.com/ClickHouse/ClickHouse/pull/26657) ([hexiaoting](https://github.com/hexiaoting)).
* Теперь агрегация min-max по первому выражению первичного ключа оптимизирована с использованием проекции. Это сделано для [#329](https://github.com/ClickHouse/ClickHouse/issues/329). [#29918](https://github.com/ClickHouse/ClickHouse/pull/29918) ([Amos Bird](https://github.com/amosbird)).

#### Экспериментальная функциональность {#experimental-feature-1}

- Добавлена возможность изменения конфигурации узлов (в файле `.xml`) для ClickHouse Keeper. [#30372](https://github.com/ClickHouse/ClickHouse/pull/30372) ([alesapin](https://github.com/alesapin)).
- Добавлена агрегатная функция `sparkbar`. Закрывает issue [#26175](https://github.com/ClickHouse/ClickHouse/issues/26175). [#27481](https://github.com/ClickHouse/ClickHouse/pull/27481) ([小路](https://github.com/nicelulu)). Примечание: в этой функции имеется недостаток, поведение будет изменено в будущих версиях.

#### Улучшения {#improvement-1}


* Добавлена возможность изменять уровни логирования без перезапуска. [#29586](https://github.com/ClickHouse/ClickHouse/pull/29586) ([Nikolay Degterinsky](https://github.com/evillique)).
* Несколько улучшений для SQL UDF. Запросы для операций с пользовательскими SQL-функциями теперь поддерживают клаузу ON CLUSTER. Пример `CREATE FUNCTION test_function ON CLUSTER 'cluster' AS x -> x + 1;`. Закрывает [#30666](https://github.com/ClickHouse/ClickHouse/issues/30666). [#30734](https://github.com/ClickHouse/ClickHouse/pull/30734) ([Maksim Kita](https://github.com/kitaisreal)). Добавлена поддержка синтаксиса `CREATE OR REPLACE`, `CREATE IF NOT EXISTS`. [#30454](https://github.com/ClickHouse/ClickHouse/pull/30454) ([Maksim Kita](https://github.com/kitaisreal)). Добавлена поддержка DROP IF EXISTS. Пример `DROP FUNCTION IF EXISTS test_function`. [#30437](https://github.com/ClickHouse/ClickHouse/pull/30437) ([Maksim Kita](https://github.com/kitaisreal)). Добавлена поддержка лямбда-выражений. Пример `CREATE FUNCTION lambda_function AS x -> arrayMap(element -> element * 2, x);`. [#30435](https://github.com/ClickHouse/ClickHouse/pull/30435) ([Maksim Kita](https://github.com/kitaisreal)). Добавлена поддержка пользовательских SQL-функций для `clickhouse-local`. [#30179](https://github.com/ClickHouse/ClickHouse/pull/30179) ([Maksim Kita](https://github.com/kitaisreal)).
* Глобально включён профилировщик памяти на уровне отдельных запросов (значение `memory_profiler_step` установлено в 4 МиБ). [#29455](https://github.com/ClickHouse/ClickHouse/pull/29455) ([Azat Khuzhin](https://github.com/azat)).
* Добавлены столбцы `data_compressed_bytes`, `data_uncompressed_bytes`, `marks_bytes` в `system.data_skipping_indices`. Добавлены столбцы `secondary_indices_compressed_bytes`, `secondary_indices_uncompressed_bytes`, `secondary_indices_marks_bytes` в `system.parts`. Закрыта задача [#29697](https://github.com/ClickHouse/ClickHouse/issues/29697). [#29896](https://github.com/ClickHouse/ClickHouse/pull/29896) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлены псевдонимы `table` для system.tables и `database` для system.databases [#29677](https://github.com/ClickHouse/ClickHouse/issues/29677). [#29882](https://github.com/ClickHouse/ClickHouse/pull/29882) ([kevin wan](https://github.com/MaxWk)).
* Теперь взаимозависимости между таблицами корректно обрабатываются при запуске сервера. Закрывает [#8004](https://github.com/ClickHouse/ClickHouse/issues/8004) и [#15170](https://github.com/ClickHouse/ClickHouse/issues/15170). [#28373](https://github.com/ClickHouse/ClickHouse/pull/28373) ([tavplubix](https://github.com/tavplubix)).
* Исключена ошибка «Division by zero» при знаменателе типа Nullable в функциях `divide`, `intDiv` и `modulo`. Закрывает [#22621](https://github.com/ClickHouse/ClickHouse/issues/22621). [#28352](https://github.com/ClickHouse/ClickHouse/pull/28352) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена возможность разбора значений типа данных `Date` в текстовых форматах в виде `YYYYMMDD` в дополнение к `YYYY-MM-DD`. Это закрывает [#30870](https://github.com/ClickHouse/ClickHouse/issues/30870). [#30871](https://github.com/ClickHouse/ClickHouse/pull/30871) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Web UI: отрисовка столбиков в ячейках таблицы. [#29792](https://github.com/ClickHouse/ClickHouse/pull/29792) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Теперь можно создавать словари с комментариями: `CREATE DICTIONARY ... COMMENT 'vaue'` ... [#29899](https://github.com/ClickHouse/ClickHouse/pull/29899) ([Vasily Nemkov](https://github.com/Enmk)). Теперь можно задавать комментарии для баз данных в операторе `CREATE DATABASE` ... [#29429](https://github.com/ClickHouse/ClickHouse/pull/29429) ([Vasily Nemkov](https://github.com/Enmk)).
* Добавлена настройка `compiled_expression_cache_elements_size`. Если вы когда‑нибудь захотите воспользоваться этой настройкой, вы уже будете знать, что она делает. [#30667](https://github.com/ClickHouse/ClickHouse/pull/30667) ([Maksim Kita](https://github.com/kitaisreal)).
* clickhouse-format теперь поддерживает опцию `--query`. В предыдущих версиях приходилось передавать запрос через stdin. [#29325](https://github.com/ClickHouse/ClickHouse/pull/29325) ([凌涛](https://github.com/lingtaolf)).
* Добавлена поддержка `ALTER TABLE` для таблиц в базах данных `Memory`. Базы данных `Memory` используются в `clickhouse-local`. [#30866](https://github.com/ClickHouse/ClickHouse/pull/30866) ([tavplubix](https://github.com/tavplubix)).
* Функция `arrayStringConcat` теперь поддерживает массивы всех сериализуемых типов. [#30840](https://github.com/ClickHouse/ClickHouse/pull/30840) ([Nickita Taranov](https://github.com/nickitat)).
* ClickHouse теперь будет учитывать ограничения Docker/cgroups при определении объёма системной памяти. См. [#25662](https://github.com/ClickHouse/ClickHouse/issues/25662). [#30574](https://github.com/ClickHouse/ClickHouse/pull/30574) ([Pavel Medvedev](https://github.com/pmed)).
* Извлечение структуры таблиц из базы данных PostgreSQL стало более надёжным. [#30477](https://github.com/ClickHouse/ClickHouse/pull/30477) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Полная поддержка позиционных аргументов в GROUP BY и ORDER BY. [#30433](https://github.com/ClickHouse/ClickHouse/pull/30433) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Позволить извлекать нестроковые элементы в виде строки с помощью JSONExtractString. Это относится к [pull/25452#issuecomment-927123287](https://github.com/ClickHouse/ClickHouse/pull/25452#issuecomment-927123287). [#30426](https://github.com/ClickHouse/ClickHouse/pull/30426) ([Amos Bird](https://github.com/amosbird)).
* Добавлена возможность использовать ключевое слово FINAL в запросах SELECT к таблицам с движком `GraphiteMergeTree`. [#30360](https://github.com/ClickHouse/ClickHouse/pull/30360) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Незначительные улучшения в клонировании реплик и постановке в очередь операций получения повреждённых кусков, которые должны предотвратить крайне редкие зависания записей `GET_PART` в очереди репликации. [#30346](https://github.com/ClickHouse/ClickHouse/pull/30346) ([tavplubix](https://github.com/tavplubix)).
* Разрешена поддержка символьных ссылок на файлы в каталоге `user_files` для табличной функции `file`. [#30309](https://github.com/ClickHouse/ClickHouse/pull/30309) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено сравнение типа `Date32` с типами `Date`, `DateTime`, `DateTime64` и `String`. [#30219](https://github.com/ClickHouse/ClickHouse/pull/30219) ([liang.huang](https://github.com/lhuang09287750)).
* Добавлена возможность удалять выражение `SAMPLE BY` из таблиц `MergeTree` (`ALTER TABLE <table> REMOVE SAMPLE BY`). [#30180](https://github.com/ClickHouse/ClickHouse/pull/30180) ([Anton Popov](https://github.com/CurtizJ)).
* Теперь `Keeper` (в составе `clickhouse-server`) будет запускаться асинхронно, если сможет подключиться к другому узлу. [#30170](https://github.com/ClickHouse/ClickHouse/pull/30170) ([alesapin](https://github.com/alesapin)).
* Теперь `clickhouse-client` поддерживает встроенное многострочное редактирование. [#30143](https://github.com/ClickHouse/ClickHouse/pull/30143) ([Amos Bird](https://github.com/amosbird)).
* Словари `polygon` (обратное геокодирование): добавлена поддержка чтения содержимого словаря с помощью запроса SELECT при включении настройки `store_polygon_key_column` = true. Закрывает [#30090](https://github.com/ClickHouse/ClickHouse/issues/30090). [#30142](https://github.com/ClickHouse/ClickHouse/pull/30142) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлен логотип ClickHouse в интерфейс Play. [#29674](https://github.com/ClickHouse/ClickHouse/pull/29674) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Улучшено сообщение об исключении при чтении столбца из форматов, поддерживающих Arrow, таких как `Arrow`, `ArrowStream`, `Parquet` и `ORC`. Это закрывает [#29926](https://github.com/ClickHouse/ClickHouse/issues/29926). [#29927](https://github.com/ClickHouse/ClickHouse/pull/29927) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Устранена гонка данных между операциями flush и startup в таблицах движка `Buffer`. Она может проявляться в тестах. [#29930](https://github.com/ClickHouse/ClickHouse/pull/29930) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка `lock-order-inversion` между `DROP TABLE` для `DatabaseMemory` и `LiveView`. Live View — экспериментальная функция. База данных Memory используется в clickhouse-local. [#29929](https://github.com/ClickHouse/ClickHouse/pull/29929) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена инверсия порядка блокировок между периодической перезагрузкой словаря и перезагрузкой конфигурации. [#29928](https://github.com/ClickHouse/ClickHouse/pull/29928) ([Azat Khuzhin](https://github.com/azat)).
* Обновлены файлы zoneinfo до версии 2021c. [#29925](https://github.com/ClickHouse/ClickHouse/pull/29925) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность настраивать повторные попытки и задержки между ними для `clickhouse-copier`. [#29921](https://github.com/ClickHouse/ClickHouse/pull/29921) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена настройка сервера `shutdown_wait_unfinished_queries`, позволяющая при завершении работы ожидать выполнения запущенных запросов в течение времени, заданного параметром `shutdown_wait_unfinished`. Изменение связано с задачей [#24451](https://github.com/ClickHouse/ClickHouse/issues/24451). [#29914](https://github.com/ClickHouse/ClickHouse/pull/29914) ([Amos Bird](https://github.com/amosbird)).
* Добавлена возможность отслеживать пиковое потребление памяти (с новым типом трассировки `trace_type` — `MemoryPeak` в `system.trace_log`). [#29858](https://github.com/ClickHouse/ClickHouse/pull/29858) ([Azat Khuzhin](https://github.com/azat)).
* Внешние таблицы PostgreSQL: добавлен префикс разделённой таблицы &#39;p&#39; в запрос для получения индекса идентификации реплики. [#29828](https://github.com/ClickHouse/ClickHouse/pull/29828) ([Shoh Jahon](https://github.com/Shohjahon)).
* Применяйте `max_untracked_memory`/`memory_profiler_step`/`memory_profiler_sample_probability` при выполнении операций mutate/merge для профилирования использования памяти во время слияний. [#29681](https://github.com/ClickHouse/ClickHouse/pull/29681) ([Azat Khuzhin](https://github.com/azat)).
* Обфускатор запросов: `clickhouse-format --obfuscate` теперь работает с большим числом типов запросов. [#29672](https://github.com/ClickHouse/ClickHouse/pull/29672) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка, из-за которой `clickhouse-format --obfuscate` не обрабатывал запросы со встроенными словарями (функции `regionTo...`). [#29667](https://github.com/ClickHouse/ClickHouse/pull/29667) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена некорректная обработка Nullable в функциях JSON. Это устраняет проблему [#29615](https://github.com/ClickHouse/ClickHouse/issues/29615). Помечено как улучшение, так как [https://github.com/ClickHouse/ClickHouse/pull/28012](https://github.com/ClickHouse/ClickHouse/pull/28012) ещё не вошёл в релиз. [#29659](https://github.com/ClickHouse/ClickHouse/pull/29659) ([Amos Bird](https://github.com/amosbird)).
* Увеличено значение параметра `listen_backlog` по умолчанию (чтобы соответствовать значению по умолчанию в более новых версиях ядра Linux). [#29643](https://github.com/ClickHouse/ClickHouse/pull/29643) ([Azat Khuzhin](https://github.com/azat)).
* Перезагружать словари, модели и пользовательские исполняемые функции при изменении конфигураций сервера `dictionaries_config`, `models_config`, `user_defined_executable_functions_config`. Закрывает [#28142](https://github.com/ClickHouse/ClickHouse/issues/28142). [#29529](https://github.com/ClickHouse/ClickHouse/pull/29529) ([Maksim Kita](https://github.com/kitaisreal)).
* Снято бессмысленное ограничение на имя проекции. Теперь имя проекции может начинаться с `tmp_`. [#29520](https://github.com/ClickHouse/ClickHouse/pull/29520) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка `There is no query or query context has expired` при мутациях с вложенными подзапросами. Теперь подзапросы в мутациях не допускаются для реплицируемых таблиц, если настройка `allow_nondeterministic_mutations` отключена. [#29495](https://github.com/ClickHouse/ClickHouse/pull/29495) ([tavplubix](https://github.com/tavplubix)).
* Изменения параметра конфигурации `max_concurrent_queries` теперь применяются во время работы (без перезапуска). [#29414](https://github.com/ClickHouse/ClickHouse/pull/29414) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлена настройка `use_skip_indexes`. [#29405](https://github.com/ClickHouse/ClickHouse/pull/29405) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена поддержка операции `FREEZE` для частей в памяти (для резервного копирования). [#29376](https://github.com/ClickHouse/ClickHouse/pull/29376) ([Mo Xuan](https://github.com/mo-avatar)).
* Передаётся исходный идентификатор запроса `initial_query&#95;id` для `clickhouse-benchmark` (раньше при запуске удалённого запроса через `clickhouse-benchmark` запросы на шардах не связывались с исходным запросом по `initial_query&#95;id`). [#29364](https://github.com/ClickHouse/ClickHouse/pull/29364) ([Azat Khuzhin](https://github.com/azat)).
* Пропускающие индексы `tokenbf_v1` и `ngrambf_v1`: добавлена поддержка типа данных `Array` с элементами типа `String` или `FixedString`. [#29280](https://github.com/ClickHouse/ClickHouse/pull/29280) ([Maksim Kita](https://github.com/kitaisreal)). Пропускающие индексы `tokenbf_v1` и `ngrambf_v1`: добавлена поддержка типа данных `Map` с ключом типа `String` или `FixedString`. Автор @lingtaolf. [#29220](https://github.com/ClickHouse/ClickHouse/pull/29220) ([Maksim Kita](https://github.com/kitaisreal)).
* Функция `has`: добавлена поддержка типа данных `Map`. [#29267](https://github.com/ClickHouse/ClickHouse/pull/29267) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлены настройки `compress_logs` для clickhouse-keeper, которые позволяют сжимать логи clickhouse-keeper (для реплицированного автомата состояний) с помощью `ZSTD`. Реализация: [#26977](https://github.com/ClickHouse/ClickHouse/issues/26977). [#29223](https://github.com/ClickHouse/ClickHouse/pull/29223) ([alesapin](https://github.com/alesapin)).
* Добавлена настройка `external_table_strict_query` — при её использовании всё выражение WHERE в запросах будет принудительно передаваться во внешние базы данных, даже если оно с ними несовместимо. [#29206](https://github.com/ClickHouse/ClickHouse/pull/29206) ([Azat Khuzhin](https://github.com/azat)).
* Отключены проекции при использовании `ARRAY JOIN`. В предыдущих версиях анализ проекций мог нарушать алиасы в `ARRAY JOIN`. [#29139](https://github.com/ClickHouse/ClickHouse/pull/29139) ([Amos Bird](https://github.com/amosbird)).
* Добавлена поддержка большего количества типов в формате ввода/вывода `MsgPack`. [#29077](https://github.com/ClickHouse/ClickHouse/pull/29077) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена возможность ввода и вывода столбцов `LowCardinality` в формате `ORC`. [#29062](https://github.com/ClickHouse/ClickHouse/pull/29062) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка, из-за которой запрос `SELECT` к `system.distributed_ddl_queue` мог возвращать некорректные значения. [#29061](https://github.com/ClickHouse/ClickHouse/pull/29061) ([tavplubix](https://github.com/tavplubix)).
* Корректная обработка неизвестных методов HTTP-соединения. Исправляет [#29050](https://github.com/ClickHouse/ClickHouse/issues/29050). [#29057](https://github.com/ClickHouse/ClickHouse/pull/29057) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* `clickhouse-keeper`: Исправлена ошибка в `clickhouse-keeper-converter`, которая могла привести к потере части данных при восстановлении из журналов ZooKeeper (не из snapshot). [#29030](https://github.com/ClickHouse/ClickHouse/pull/29030) ([小路](https://github.com/nicelulu)). Исправлена ошибка в `clickhouse-keeper-converter`, которая могла привести к некорректной десериализации журналов ZooKeeper. [#29071](https://github.com/ClickHouse/ClickHouse/pull/29071) ([小路](https://github.com/nicelulu)).
* Применять настройки из запросов `CREATE ... AS SELECT` (исправление: [#28810](https://github.com/ClickHouse/ClickHouse/issues/28810)). [#28962](https://github.com/ClickHouse/ClickHouse/pull/28962) ([Azat Khuzhin](https://github.com/azat)).
* Учитывать базу данных по умолчанию для ALTER TABLE ... ON CLUSTER ... REPLACE/MOVE PARTITION FROM/TO ... [#28955](https://github.com/ClickHouse/ClickHouse/pull/28955) ([anneji-dev](https://github.com/anneji-dev)).
* Протокол gRPC: Добавлена возможность изменять сжатие на стороне сервера с клиента. [#28953](https://github.com/ClickHouse/ClickHouse/pull/28953) ([Vitaly Baranov](https://github.com/vitlibar)).
* Не выбрасывать исключение «no data» при чтении датчиков температуры для асинхронных метрик. Закрывает [#28852](https://github.com/ClickHouse/ClickHouse/issues/28852). [#28882](https://github.com/ClickHouse/ClickHouse/pull/28882) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено логическое состояние гонки, которое в редких случаях могло приводить к ошибке `Dictionary not found` для существующего словаря. [#28853](https://github.com/ClickHouse/ClickHouse/pull/28853) ([tavplubix](https://github.com/tavplubix)).
* Ослаблена проверка вложенных функций в If-комбинаторе (но вложенные одинаковые комбинаторы по-прежнему запрещены). [#28828](https://github.com/ClickHouse/ClickHouse/pull/28828) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена возможная проблема с необработанным исключением при завершении работы сервера. [#28761](https://github.com/ClickHouse/ClickHouse/pull/28761) ([Azat Khuzhin](https://github.com/azat)).
* Запрещена очистка временных директорий tmp, которые могут использоваться активной мутацией/слиянием, если мутация/слияние выполняется чрезвычайно долго. [#28760](https://github.com/ClickHouse/ClickHouse/pull/28760) ([Azat Khuzhin](https://github.com/azat)).
* Разрешена оптимизация `optimize_arithmetic_operations_in_aggregate_functions = 1` при использовании псевдонима. [#28746](https://github.com/ClickHouse/ClickHouse/pull/28746) ([Amos Bird](https://github.com/amosbird)).
* Реализована настройка `detach_not_byte_identical_parts` для `ReplicatedMergeTree`, которая вместо удаления будет отсоединять части, не являющиеся побайтно идентичными (после merge/mutate). [#28708](https://github.com/ClickHouse/ClickHouse/pull/28708) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена настройка `max_suspicious_broken_parts_bytes` для `MergeTree` (ограничивает общий размер всех повреждённых частей, значение по умолчанию — `1GiB`). [#28707](https://github.com/ClickHouse/ClickHouse/pull/28707) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена возможность разворачивания макросов в настройках таблицы `RabbitMQ`. [#28683](https://github.com/ClickHouse/ClickHouse/pull/28683) ([Vitaly Baranov](https://github.com/vitlibar)).
* Восстановлена возможность многопоточного чтения данных таблицы на движке `Log`. [#28125](https://github.com/ClickHouse/ClickHouse/pull/28125) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена некорректная обработка столбцов `NULL` в JSON-функциях. Это решает проблему [#27930](https://github.com/ClickHouse/ClickHouse/issues/27930). [#28012](https://github.com/ClickHouse/ClickHouse/pull/28012) ([Amos Bird](https://github.com/amosbird)).
* Добавлена возможность задавать размер кэша Mark/Uncompressed для индексов пропуска отдельно от столбцов. [#27961](https://github.com/ClickHouse/ClickHouse/pull/27961) ([Amos Bird](https://github.com/amosbird)).
* Добавлена возможность комбинировать JOIN с `USING` с другими типами JOIN. [#23881](https://github.com/ClickHouse/ClickHouse/pull/23881) ([darkkeks](https://github.com/darkkeks)).
* Обновлён подмодуль aws-sdk для ограничения скорости запросов (throttling) в S3 Yandex Cloud. [#30646](https://github.com/ClickHouse/ClickHouse/pull/30646) ([ianton-ru](https://github.com/ianton-ru)).
* Исправлено освобождение идентификатора запроса и идентификатора сеанса в конце обработки запроса при обработке gRPC-вызова. [#29954](https://github.com/ClickHouse/ClickHouse/pull/29954) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено завершение работы `AccessControlManager` для устранения флапающего теста. [#29951](https://github.com/ClickHouse/ClickHouse/pull/29951) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено падение по `assert` при чтении из `HDFS`. Обновлена библиотека libhdfs3, чтобы обеспечить запуск тестов в режиме отладки. Закрывает [#29251](https://github.com/ClickHouse/ClickHouse/issues/29251). Закрывает [#27814](https://github.com/ClickHouse/ClickHouse/issues/27814). [#29276](https://github.com/ClickHouse/ClickHouse/pull/29276) ([Kseniia Sumarokova](https://github.com/kssenii)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-1}

- Добавлена поддержка сборки FreeBSD для машин Aarch64. [#29952](https://github.com/ClickHouse/ClickHouse/pull/29952) ([MikaelUrankar](https://github.com/MikaelUrankar)).
- Рекурсивные подмодули больше не требуются для ClickHouse. [#30315](https://github.com/ClickHouse/ClickHouse/pull/30315) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- ClickHouse можно статически собрать с Musl. Это добавлено в качестве эксперимента, не поддерживается сборка `odbc-bridge`, `library-bridge`, интеграция с CatBoost и некоторыми библиотеками. [#30248](https://github.com/ClickHouse/ClickHouse/pull/30248) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Включены `Protobuf`, `Arrow`, `ORC`, `Parquet` для сборок `AArch64` и `Darwin` (macOS). Это закрывает [#29248](https://github.com/ClickHouse/ClickHouse/issues/29248). Это закрывает [#28018](https://github.com/ClickHouse/ClickHouse/issues/28018). [#30015](https://github.com/ClickHouse/ClickHouse/pull/30015) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлена кросс-сборка для PowerPC (powerpc64le). Это закрывает [#9589](https://github.com/ClickHouse/ClickHouse/issues/9589). Включена поддержка взаимодействия с MySQL для AArch64 и PowerPC. Это закрывает [#26301](https://github.com/ClickHouse/ClickHouse/issues/26301). [#30010](https://github.com/ClickHouse/ClickHouse/pull/30010) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Оставлены только необходимые файлы в инструментарии кросс-компиляции. Они включены как подмодули (ранее загружались как tar-архивы). [#29974](https://github.com/ClickHouse/ClickHouse/pull/29974) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Реализован структурно-ориентированный подход к фаззингу в ClickHouse для парсера оператора SELECT. [#30012](https://github.com/ClickHouse/ClickHouse/pull/30012) ([Paul](https://github.com/PaulCher)).
- Включен экспериментальный вычислитель constexpr-выражений для clang для ускорения компиляции шаблонного кода. [#29668](https://github.com/ClickHouse/ClickHouse/pull/29668) ([myrrc](https://github.com/myrrc)).
- Добавлена возможность компиляции с использованием более новой версии glibc без использования новых символов. [#29594](https://github.com/ClickHouse/ClickHouse/pull/29594) ([Azat Khuzhin](https://github.com/azat)).
- Уменьшен размер бинарного файла отладочной сборки с помощью опции оптимизации clang. [#28736](https://github.com/ClickHouse/ClickHouse/pull/28736) ([flynn](https://github.com/ucasfl)).
- Теперь все образы для CI будут размещены в отдельном репозитории DockerHub. [#28656](https://github.com/ClickHouse/ClickHouse/pull/28656) ([alesapin](https://github.com/alesapin)).
- Улучшена поддержка сборки с clang-13. [#28046](https://github.com/ClickHouse/ClickHouse/pull/28046) ([Sergei Semin](https://github.com/syominsergey)).
- Добавлена возможность вывода необработанных событий профилирования в `clickhouse-client` (это может быть полезно для отладки и тестирования). [#30064](https://github.com/ClickHouse/ClickHouse/pull/30064) ([Azat Khuzhin](https://github.com/azat)).
- Добавлена временная зависимость для юнита clickhouse-server (systemd и sysvinit init). [#28891](https://github.com/ClickHouse/ClickHouse/pull/28891) ([Azat Khuzhin](https://github.com/azat)).
- Перезагрузка кэша трассировки стека при перезагрузке символа. [#28137](https://github.com/ClickHouse/ClickHouse/pull/28137) ([Amos Bird](https://github.com/amosbird)).

#### Исправление ошибок {#bug-fix}


* Функции для поиска в UTF-8-строках без учета регистра, такие как `positionCaseInsensitiveUTF8` и `countSubstringsCaseInsensitiveUTF8`, в очень редких случаях могли находить подстроки, которые на самом деле не являются совпадениями; это исправлено. [#30663](https://github.com/ClickHouse/ClickHouse/pull/30663) ([tavplubix](https://github.com/tavplubix)).
* Исправлена проблема чтения из пустого файла на зашифрованном диске. [#30494](https://github.com/ClickHouse/ClickHouse/pull/30494) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено преобразование цепочек дизъюнкций в `IN` (управляется настройкой `optimize_min_equality_disjunction_chain_length`) в распределённых запросах с настройкой `legacy_column_name_of_tuple_literal = 0`. [#28658](https://github.com/ClickHouse/ClickHouse/pull/28658) ([Anton Popov](https://github.com/CurtizJ)).
* Разрешено использовать материализованный столбец в качестве ключа шардирования в распределённой таблице, даже если `insert_allow_materialized_columns=0`: [#28637](https://github.com/ClickHouse/ClickHouse/pull/28637) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена работа `ORDER BY ... WITH FILL` при заданных `FROM` и `TO` и пустом результирующем наборе. [#30888](https://github.com/ClickHouse/ClickHouse/pull/30888) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена проблема, из-за которой индекс множества не использовался в выражениях AND/OR, когда было более двух операндов. Это исправляет [#30416](https://github.com/ClickHouse/ClickHouse/issues/30416). [#30887](https://github.com/ClickHouse/ClickHouse/pull/30887) ([Amos Bird](https://github.com/amosbird)).
* Исправлено падение при материализации проекции с хеширующей функцией. Это исправляет [#30861](https://github.com/ClickHouse/ClickHouse/issues/30861). Проблема похожа на [https://github.com/ClickHouse/ClickHouse/pull/28560](https://github.com/ClickHouse/ClickHouse/pull/28560), где причиной было отсутствие корректного понимания инварианта «пустоты заголовка». [#30877](https://github.com/ClickHouse/ClickHouse/pull/30877) ([Amos Bird](https://github.com/amosbird)).
* Исправлена неоднозначность при извлечении вспомогательного имени ZooKeeper из пути в ZooKeeper в `ReplicatedMergeTree`. Ранее сервер мог не запуститься с ошибкой `Unknown auxiliary ZooKeeper name`, если путь в ZooKeeper содержал двоеточие. Исправляет [#29052](https://github.com/ClickHouse/ClickHouse/issues/29052). Ранее также было допустимо указывать путь в ZooKeeper, который не начинается со слеша, но теперь это объявлено устаревшим, и создание новых таблиц с таким путем запрещено. Вспомогательные имена ZooKeeper также не могут содержать слеши и двоеточия. [#30822](https://github.com/ClickHouse/ClickHouse/pull/30822) ([tavplubix](https://github.com/tavplubix)).
* Теперь временная директория очищается в случае неудачного выполнения `localBackup` по любой причине. [#30797](https://github.com/ClickHouse/ClickHouse/pull/30797) ([ianton-ru](https://github.com/ianton-ru)).
* Исправлено состояние гонки между `REPLACE/MOVE PARTITION` и фоновым слиянием в нереплицированном `MergeTree`, которое могло приводить к тому, что часть перемещённых или заменённых данных оставалась в партиции. Исправляет [#29327](https://github.com/ClickHouse/ClickHouse/issues/29327). [#30717](https://github.com/ClickHouse/ClickHouse/pull/30717) ([tavplubix](https://github.com/tavplubix)).
* Исправлена обработка PREWHERE вместе с WHERE в случае, когда условие PREWHERE всегда истинно. [#30668](https://github.com/ClickHouse/ClickHouse/pull/30668) ([Azat Khuzhin](https://github.com/azat)).
* Оптимизация Limit push down могла приводить к ошибке `Cannot find column`. Исправляет [#30438](https://github.com/ClickHouse/ClickHouse/issues/30438). [#30562](https://github.com/ClickHouse/ClickHouse/pull/30562) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлены недостающие скобки при преобразовании `isNotNull`/`isNull` в `IS [NOT] NULL` (исправляет запросы, содержащие выражения вроде `isNotNull(1)+isNotNull(2)`). [#30520](https://github.com/ClickHouse/ClickHouse/pull/30520) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена взаимоблокировка при выполнении `ALTER` со скалярным подзапросом к той же таблице, закрыт [#30461](https://github.com/ClickHouse/ClickHouse/issues/30461). [#30492](https://github.com/ClickHouse/ClickHouse/pull/30492) ([Vladimir C](https://github.com/vdimir)).
* Исправлена ошибка сегментации, которая могла возникать при истечении сессии во время выполнения REPLACE PARTITION. [#30432](https://github.com/ClickHouse/ClickHouse/pull/30432) ([tavplubix](https://github.com/tavplubix)).
* Запросы с условием вида `IN (subquery)` могли возвращать некорректный результат, если применялась агрегатная проекция. Исправлено создание множеств для проекций. [#30310](https://github.com/ClickHouse/ClickHouse/pull/30310) ([Amos Bird](https://github.com/amosbird)).
* Исправлено разрешение псевдонимов столбцов в JOIN-запросах при включённых проекциях. Это исправляет [#30146](https://github.com/ClickHouse/ClickHouse/issues/30146). [#30293](https://github.com/ClickHouse/ClickHouse/pull/30293) ([Amos Bird](https://github.com/amosbird)).
* Исправлен один из недостатков функции `replaceRegexpAll`. [#30292](https://github.com/ClickHouse/ClickHouse/pull/30292) ([Memo](https://github.com/Joeywzr)).
* Исправлена обработка опции `preallocate` из конфигурации layout в ComplexKeyHashedDictionary и ComplexKeySparseHashedDictionary. [#30246](https://github.com/ClickHouse/ClickHouse/pull/30246) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена работа функции `[I]LIKE`. Закрывает [#28661](https://github.com/ClickHouse/ClickHouse/issues/28661). [#30244](https://github.com/ClickHouse/ClickHouse/pull/30244) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена ошибка, приводившая к сбою при использовании `shortcircuit` и `LowCardinality` в `multiIf`. [#30243](https://github.com/ClickHouse/ClickHouse/pull/30243) ([Raúl Marín](https://github.com/Algunenano)).
* FlatDictionary, HashedDictionary: исправлен расчет bytes&#95;allocated при работе с атрибутами типа Nullable. [#30238](https://github.com/ClickHouse/ClickHouse/pull/30238) ([Maksim Kita](https://github.com/kitaisreal)).
* Разрешены идентификаторы, начинающиеся с цифр, в множественных JOIN-ах. [#30230](https://github.com/ClickHouse/ClickHouse/pull/30230) ([Vladimir C](https://github.com/vdimir)).
* Исправлено чтение из `MergeTree` с `max_read_buffer_size = 0` (если пользователь хочет выстрелить себе в ногу), что могло приводить к исключениям `Can't adjust last granule`, `LOGICAL_ERROR` или даже потере данных. [#30192](https://github.com/ClickHouse/ClickHouse/pull/30192) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа `pread_fake_async`/`pread_threadpool` с `min_bytes_to_use_direct_io`. [#30191](https://github.com/ClickHouse/ClickHouse/pull/30191) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, из-за которой `INSERT SELECT` некорректно заполнял `MATERIALIZED`-столбец на основе столбца типа `Nullable`. [#30189](https://github.com/ClickHouse/ClickHouse/pull/30189) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка аргументов, допускающих значение `NULL`, в функции `initializeAggregation`. [#30177](https://github.com/ClickHouse/ClickHouse/pull/30177) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка `Port is already connected` для запросов с `GLOBAL IN` и `WITH TOTALS`. Только для 21.9 и 21.10. [#30086](https://github.com/ClickHouse/ClickHouse/pull/30086) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Устранена гонка между `MOVE PARTITION` и объединениями/мутациями для `MergeTree`. [#30074](https://github.com/ClickHouse/ClickHouse/pull/30074) ([Azat Khuzhin](https://github.com/azat)).
* База данных `Memory`, удалённая ранее, могла снова появляться после перезапуска сервера — это исправлено ([#29795](https://github.com/ClickHouse/ClickHouse/issues/29795)). Также добавлена настройка `force_remove_data_recursively_on_drop` в качестве обходного решения ошибки `Directory not empty` при удалении базы данных типа `Ordinary` (поскольку в облачной среде невозможно вручную удалить оставшиеся данные). [#30054](https://github.com/ClickHouse/ClickHouse/pull/30054) ([tavplubix](https://github.com/tavplubix)).
* Исправлен краш в примере с `tuple()`, закрыта [#30004](https://github.com/ClickHouse/ClickHouse/issues/30004). [#30016](https://github.com/ClickHouse/ClickHouse/pull/30016) ([flynn](https://github.com/ucasfl)).
* попытка закрыть задачу: [#29965](https://github.com/ClickHouse/ClickHouse/issues/29965). [#29976](https://github.com/ClickHouse/ClickHouse/pull/29976) ([hexiaoting](https://github.com/hexiaoting)).
* Устранена возможная гонка данных между `FileChecker` и `StorageLog`/`StorageStripeLog`. [#29959](https://github.com/ClickHouse/ClickHouse/pull/29959) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена гонка данных между `LogSink::writeMarks()` и `LogSource` в `StorageLog`. [#29946](https://github.com/ClickHouse/ClickHouse/pull/29946) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена потенциальная утечка ресурсов при ограничении числа параллельных запросов для таблиц семейства MergeTree, возникшая в [https://github.com/ClickHouse/ClickHouse/pull/19544](https://github.com/ClickHouse/ClickHouse/pull/19544). [#29879](https://github.com/ClickHouse/ClickHouse/pull/29879) ([Amos Bird](https://github.com/amosbird)).
* Исправлена проверка пересоздания системных таблиц (не обнаруживала изменения в значениях `Enum`). [#29857](https://github.com/ClickHouse/ClickHouse/pull/29857) ([Azat Khuzhin](https://github.com/azat)).
* MaterializedMySQL: Исправлена ошибка, из‑за которой при потере соединения с MySQL могла обрабатываться только часть транзакции. [#29837](https://github.com/ClickHouse/ClickHouse/pull/29837) ([Håvard Kvålen](https://github.com/havardk)).
* Позволяет избежать ошибки `Timeout exceeded: elapsed 18446744073.709553 seconds`, которая может возникать в крайне редких случаях, предположительно из‑за ошибки в ядре. Исправляет [#29154](https://github.com/ClickHouse/ClickHouse/issues/29154). [#29811](https://github.com/ClickHouse/ClickHouse/pull/29811) ([tavplubix](https://github.com/tavplubix)).
* Исправлено некорректное приведение типов в запросе `ATTACH TABLE ... FROM 'path'`, возникающее при использовании литерала нестрокового типа вместо строкового пути. Это могло приводить к чтению неинициализированной памяти. [#29790](https://github.com/ClickHouse/ClickHouse/pull/29790) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен одновременный доступ к `LowCardinality` при выполнении `GROUP BY` (в сочетании с таблицами `Buffer` это могло приводить к проблемам). [#29782](https://github.com/ClickHouse/ClickHouse/pull/29782) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена некорректная работа `GROUP BY` (несколько строк с одинаковыми ключами в результате) в случае распределённого запроса, когда шарды работали на смешанных версиях `<= 21.3` и `>= 21.4`, ключ `GROUP BY` содержал несколько столбцов, все фиксированного размера, и была включена двухуровневая агрегация (см. `group_by_two_level_threshold` и `group_by_two_level_threshold_bytes`). Исправляет [#29580](https://github.com/ClickHouse/ClickHouse/issues/29580). [#29735](https://github.com/ClickHouse/ClickHouse/pull/29735) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Устранено некорректное поведение при установке параметра `materialized_postgresql_tables_list` при перезапуске сервера. Ошибка описана в [#28529](https://github.com/ClickHouse/ClickHouse/issues/28529). [#29686](https://github.com/ClickHouse/ClickHouse/pull/29686) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Условие в предикате фильтра могло быть потеряно после оптимизации push-down. [#29625](https://github.com/ClickHouse/ClickHouse/pull/29625) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена JIT-компиляция выражений с псевдонимами и ленивой (short-circuit) оценкой выражений. Закрывает [#29403](https://github.com/ClickHouse/ClickHouse/issues/29403). [#29574](https://github.com/ClickHouse/ClickHouse/pull/29574) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена редкая ошибка сегментации в запросе `ALTER MODIFY` при использовании некорректного идентификатора таблицы вида `x.y.z...` в выражении `DEFAULT`. Исправляет проблему [#29184](https://github.com/ClickHouse/ClickHouse/issues/29184). [#29573](https://github.com/ClickHouse/ClickHouse/pull/29573) ([alesapin](https://github.com/alesapin)).
* Исправлено разыменование нулевого указателя (`nullptr`) для `GROUP BY WITH TOTALS HAVING` (когда столбец из `HAVING` не был выбран). [#29553](https://github.com/ClickHouse/ClickHouse/pull/29553) ([Azat Khuzhin](https://github.com/azat)).
* Предотвращены взаимоблокировки при одновременном чтении и записи таблиц движка Join. [#29544](https://github.com/ClickHouse/ClickHouse/pull/29544) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена ошибка в проверке `pathStartsWith`, связанная с использованием `std::mismatch`: `The behavior is undefined if the second range is shorter than the first range.`. [#29531](https://github.com/ClickHouse/ClickHouse/pull/29531) ([Kseniia Sumarokova](https://github.com/kssenii)).
* В ODBC bridge добавлены повторные попытки при ошибке Invalid cursor state. Это ошибка, для которой допустим повторный запрос. Закрывает [#29473](https://github.com/ClickHouse/ClickHouse/issues/29473). [#29518](https://github.com/ClickHouse/ClickHouse/pull/29518) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен некорректный разбор имени таблицы при загрузке базы данных `Lazy`. Устраняет проблему [#29456](https://github.com/ClickHouse/ClickHouse/issues/29456). [#29476](https://github.com/ClickHouse/ClickHouse/pull/29476) ([tavplubix](https://github.com/tavplubix)).
* Исправлена возможная проблема `Block structure mismatch` для подзапросов с проталкиваемым вниз предикатом `HAVING`. Исправляет [#29010](https://github.com/ClickHouse/ClickHouse/issues/29010). [#29475](https://github.com/ClickHouse/ClickHouse/pull/29475) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена логическая ошибка `Cannot capture columns` в функциях greatest/least. Закрывает [#29334](https://github.com/ClickHouse/ClickHouse/issues/29334). [#29454](https://github.com/ClickHouse/ClickHouse/pull/29454) ([Kruglov Pavel](https://github.com/Avogar)).
* Табличный движок RocksDB: исправлена гонка при одновременном открытии нескольких БД (и возвращены некоторые тесты, которые выявляли проблему в CI). [#29393](https://github.com/ClickHouse/ClickHouse/pull/29393) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено некорректное завершение работы replicated access storage при ошибочной конфигурации. [#29388](https://github.com/ClickHouse/ClickHouse/pull/29388) ([Kevin Michel](https://github.com/kmichel-aiven)).
* Удалена оконная функция `nth_value`, так как она не является безопасной с точки зрения использования памяти. Это закрывает [#29347](https://github.com/ClickHouse/ClickHouse/issues/29347). [#29348](https://github.com/ClickHouse/ClickHouse/pull/29348) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены вертикальные слияния частей проекций. Тем самым исправляется [#29253](https://github.com/ClickHouse/ClickHouse/issues/29253). Этот PR также устраняет несколько проблем со слияниями и мутациями проекций, появившихся в [https://github.com/ClickHouse/ClickHouse/pull/25165](https://github.com/ClickHouse/ClickHouse/pull/25165). [#29337](https://github.com/ClickHouse/ClickHouse/pull/29337) ([Amos Bird](https://github.com/amosbird)).
* Исправлена проблема зависания DDL-запросов в реплицируемой базе данных при добавлении новой реплики. [#29328](https://github.com/ClickHouse/ClickHouse/pull/29328) ([Kevin Michel](https://github.com/kmichel-aiven)).
* Исправлены проблемы с тайм-аутами соединения (`send_timeout`/`receive_timeout`). [#29282](https://github.com/ClickHouse/ClickHouse/pull/29282) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено возможное исключение `Table columns structure in ZooKeeper is different from local table structure` при пересоздании или создании новых реплик `ReplicatedMergeTree`, если один из столбцов таблицы содержит выражения DEFAULT с регистронезависимыми функциями. [#29266](https://github.com/ClickHouse/ClickHouse/pull/29266) ([Anton Popov](https://github.com/CurtizJ)).
* Отправлять клиенту (через TCP) стандартную ошибку `Database doesn't exist` (`UNKNOWN_DATABASE`) вместо `Attempt to read after eof` (`ATTEMPT_TO_READ_AFTER_EOF`). [#29229](https://github.com/ClickHouse/ClickHouse/pull/29229) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка сегментации при вставке в столбец с типом LowCardinality(Nullable) в формате ввода Avro. [#29132](https://github.com/ClickHouse/ClickHouse/pull/29132) ([Kruglov Pavel](https://github.com/Avogar)).
* Запретить повторное использование ранее указанных учетных данных при использовании межсерверного секрета (до исправления, перед `INSERT` через `Buffer`/`Kafka` в таблицу `Distributed` с настроенным межсерверным секретом для этого кластера мог повторно использоваться ранее заданный пользователь для этого соединения). [#29060](https://github.com/ClickHouse/ClickHouse/pull/29060) ([Azat Khuzhin](https://github.com/azat)).
* Обработан `any_join_distinct_right_table_keys` при соединении (JOIN) со словарём, закрыт [#29007](https://github.com/ClickHouse/ClickHouse/issues/29007). [#29014](https://github.com/ClickHouse/ClickHouse/pull/29014) ([Vladimir C](https://github.com/vdimir)).
* Исправлена ошибка &quot;Not found column ... in block&quot;, возникавшая при соединении (`JOIN`) по столбцу-псевдониму; закрыта задача [#26980](https://github.com/ClickHouse/ClickHouse/issues/26980). [#29008](https://github.com/ClickHouse/ClickHouse/pull/29008) ([Vladimir C](https://github.com/vdimir)).
* Исправлено использование количества потоков в подзапросе `GLOBAL IN` (он выполнялся в одном потоке с момента исправления ошибки [#19414](https://github.com/ClickHouse/ClickHouse/issues/19414)). [#28997](https://github.com/ClickHouse/ClickHouse/pull/28997) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлены некорректные оптимизации ORDER BY, если в нём используется WITH FILL. Это закрывает [#28908](https://github.com/ClickHouse/ClickHouse/issues/28908). Это закрывает [#26049](https://github.com/ClickHouse/ClickHouse/issues/26049). [#28910](https://github.com/ClickHouse/ClickHouse/pull/28910) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены функции массивов высшего порядка при работе с константами (`SIGSEGV` для `arrayCompact`/`ILLEGAL_COLUMN` для `arrayDifference`/`arrayCumSumNonNegative`). [#28904](https://github.com/ClickHouse/ClickHouse/pull/28904) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено ожидание выполнения мутаций при `mutations_sync=2`. [#28889](https://github.com/ClickHouse/ClickHouse/pull/28889) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены запросы к внешним базам данных (например, MySQL) с оператором IN по нескольким столбцам (например, `(k,v) IN ((1, 2))`). [#28888](https://github.com/ClickHouse/ClickHouse/pull/28888) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка работы `LowCardinality` при вычислении функций с коротким замыканием. Закрывает [#28884](https://github.com/ClickHouse/ClickHouse/issues/28884). [#28887](https://github.com/ClickHouse/ClickHouse/pull/28887) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено чтение подстолбцов из компактных частей. [#28873](https://github.com/ClickHouse/ClickHouse/pull/28873) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена гонка между `DROP PART` и `REPLACE/MOVE PARTITION`, которая в редких случаях могла приводить к расхождению реплик. [#28864](https://github.com/ClickHouse/ClickHouse/pull/28864) ([tavplubix](https://github.com/tavplubix)).
* Исправлена компиляция выражений с использованием вычисления с коротким замыканием (short-circuit evaluation). [#28821](https://github.com/ClickHouse/ClickHouse/pull/28821) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен крайне редкий случай, когда реплики ReplicatedMergeTree могут разойтись после жёсткой перезагрузки всех реплик. Ошибка выглядит как `Part ... intersects (previous|next) part ...`. [#28817](https://github.com/ClickHouse/ClickHouse/pull/28817) ([alesapin](https://github.com/alesapin)).
* Следует дополнительно проверять работоспособность соединения и на всякий случай перехватывать любые исключения при завершении работы `RabbitMQ`. [#28797](https://github.com/ClickHouse/ClickHouse/pull/28797) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено безвредное состояние гонки в ReplicatedMergeTreeQueue. Не должно быть заметно пользователю, но может приводить к трудноуловимым ошибкам. [#28734](https://github.com/ClickHouse/ClickHouse/pull/28734) ([alesapin](https://github.com/alesapin)).
* Исправлено возможное падение при выполнении запроса `SELECT` над частично созданной агрегатной проекцией при возникновении исключения. [#28700](https://github.com/ClickHouse/ClickHouse/pull/28700) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка, приводившая к дампу памяти при создании распределённых таблиц при некорректно переданных параметрах. [#28686](https://github.com/ClickHouse/ClickHouse/pull/28686) ([Zhiyong Wang](https://github.com/ljcui)).
* Добавлены псевдонимы Settings.Names и Settings.Values для таблицы system.processes. [#28685](https://github.com/ClickHouse/ClickHouse/pull/28685) ([Vitaly](https://github.com/orloffv)).
* Поддержка библиотеки S2 Geometry: исправлено число аргументов, необходимых для функций `s2RectAdd` и `s2RectContains`. [#28663](https://github.com/ClickHouse/ClickHouse/pull/28663) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлено некорректное преобразование типа константы при использовании `Nullable` или `LowCardinality` в первичном ключе. [#28636](https://github.com/ClickHouse/ClickHouse/pull/28636) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка &quot;Column is not under aggregate function and not in GROUP BY&quot; с использованием PREWHERE (исправление: [#28461](https://github.com/ClickHouse/ClickHouse/issues/28461)). [#28502](https://github.com/ClickHouse/ClickHouse/pull/28502) ([Azat Khuzhin](https://github.com/azat)).

### Релиз ClickHouse v21.10, 2021-10-16 {#clickhouse-release-v2110-2021-10-16}

#### Обратно несовместимые изменения {#backward-incompatible-change-2}

- Теперь следующие настройки уровня таблицы MergeTree: `replicated_max_parallel_sends`, `replicated_max_parallel_sends_for_table`, `replicated_max_parallel_fetches`, `replicated_max_parallel_fetches_for_table` не действуют. Они никогда не работали корректно и были заменены на `max_replicated_fetches_network_bandwidth`, `max_replicated_sends_network_bandwidth` и `background_fetches_pool_size`. [#28404](https://github.com/ClickHouse/ClickHouse/pull/28404) ([alesapin](https://github.com/alesapin)).

#### Новые возможности {#new-feature-2}


- Добавлена возможность создания пользовательских функций (UDF) в виде лямбда-выражений. Синтаксис `CREATE FUNCTION {function_name} as ({parameters}) -> {function core}`. Пример `CREATE FUNCTION plus_one as (a) -> a + 1`. Авторы @Realist007. [#27796](https://github.com/ClickHouse/ClickHouse/pull/27796) ([Maksim Kita](https://github.com/kitaisreal)) [#23978](https://github.com/ClickHouse/ClickHouse/pull/23978) ([Realist007](https://github.com/Realist007)).
- Добавлен движок таблиц `Executable` и табличная функция `executable`. Позволяет обрабатывать данные с помощью внешних скриптов в потоковом режиме. [#28102](https://github.com/ClickHouse/ClickHouse/pull/28102) ([Maksim Kita](https://github.com/kitaisreal)) ([ruct](https://github.com/ruct)).
- Добавлен движок таблиц `ExecutablePool`. Аналогичен `Executable`, но использует пул долгоживущих процессов. [#28518](https://github.com/ClickHouse/ClickHouse/pull/28518) ([Maksim Kita](https://github.com/kitaisreal)).
- Добавлен запрос `ALTER TABLE ... MATERIALIZE COLUMN`. [#27038](https://github.com/ClickHouse/ClickHouse/pull/27038) ([Vladimir Chebotarev](https://github.com/excitoon)).
- Добавлена поддержка партиционированной записи в табличную функцию `s3`. [#23051](https://github.com/ClickHouse/ClickHouse/pull/23051) ([Vladimir Chebotarev](https://github.com/excitoon)).
- Добавлена поддержка формата сжатия `lz4` (в дополнение к `gz`, `bz2`, `xz`, `zstd`) для импорта и экспорта данных. [#25310](https://github.com/ClickHouse/ClickHouse/pull/25310) ([Bharat Nallan](https://github.com/bharatnc)).
- Добавлена возможность использования позиционных аргументов при включенной настройке `enable_positional_arguments`. Закрывает [#2592](https://github.com/ClickHouse/ClickHouse/issues/2592). [#27530](https://github.com/ClickHouse/ClickHouse/pull/27530) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлена возможность указывать пользовательские настройки, связанные с форматами файлов, в секции `SETTINGS` запроса `CREATE` для таблиц s3. Закрывает [#27580](https://github.com/ClickHouse/ClickHouse/issues/27580). [#28037](https://github.com/ClickHouse/ClickHouse/pull/28037) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Добавлена поддержка SSL-соединений для движка `RabbitMQ`. [#28365](https://github.com/ClickHouse/ClickHouse/pull/28365) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлена функция `getServerPort` для получения порта сервера. Если порт не используется сервером, выбрасывается исключение. [#27900](https://github.com/ClickHouse/ClickHouse/pull/27900) ([Amos Bird](https://github.com/amosbird)).
- Добавлены функции преобразования между "snowflake id" и типами `DateTime`, `DateTime64`. См. [#27058](https://github.com/ClickHouse/ClickHouse/issues/27058). [#27704](https://github.com/ClickHouse/ClickHouse/pull/27704) ([jasine](https://github.com/jasine)).
- Добавлена функция `SHA512`. [#27830](https://github.com/ClickHouse/ClickHouse/pull/27830) ([zhanglistar](https://github.com/zhanglistar)).
- Добавлена настройка `log_queries_probability`, позволяющая записывать в query_log только выборку запросов. Закрывает [#16609](https://github.com/ClickHouse/ClickHouse/issues/16609). [#27527](https://github.com/ClickHouse/ClickHouse/pull/27527) ([Nikolay Degterinsky](https://github.com/evillique)).

#### Экспериментальная функциональность {#experimental-feature-2}


- Тип дисков `web` для хранения таблиц только для чтения на веб-сервере в виде статических файлов. См. [#23982](https://github.com/ClickHouse/ClickHouse/issues/23982). [#25251](https://github.com/ClickHouse/ClickHouse/pull/25251) ([Kseniia Sumarokova](https://github.com/kssenii)). Это в основном необходимо для упрощения тестирования операций на общем хранилище и для удобного импорта наборов данных. Не рекомендуется использовать до выпуска версии 21.11.
- Добавлены новые команды `BACKUP` и `RESTORE`. [#21945](https://github.com/ClickHouse/ClickHouse/pull/21945) ([Vitaly Baranov](https://github.com/vitlibar)). Находится в разработке и не предназначено для использования в текущей версии.

#### Улучшение производительности {#performance-improvement-2}

- Ускорены агрегатные функции `sumIf` и `countIf`. [#28272](https://github.com/ClickHouse/ClickHouse/pull/28272) ([Raúl Marín](https://github.com/Algunenano)).
- Создана виртуальная проекция для индексов `minmax`. Теперь при включенной настройке `allow_experimental_projection_optimization` запросы будут использовать индекс minmax вместо чтения данных, когда это возможно. [#26286](https://github.com/ClickHouse/ClickHouse/pull/26286) ([Amos Bird](https://github.com/amosbird)).
- Введены две проверки в `sequenceMatch` и `sequenceCount`, которые позволяют досрочно завершить выполнение, когда некоторая детерминированная часть шаблона последовательности отсутствует в списке событий. Это изменение позволяет выполнять множество запросов, которые ранее завершались с ошибкой из-за достижения лимита операций, и в целом ускоряет конвейер обработки. [#27729](https://github.com/ClickHouse/ClickHouse/pull/27729) ([Jakub Kuklis](https://github.com/jkuklis)).
- Улучшен анализ первичного ключа с использованием информации о постоянной монотонности бинарных функций, в частности деления на ненулевую константу. [#28302](https://github.com/ClickHouse/ClickHouse/pull/28302) ([Amos Bird](https://github.com/amosbird)).
- Условие фильтра `hasAll` теперь использует индексы пропуска данных на основе фильтра Блума. [#27984](https://github.com/ClickHouse/ClickHouse/pull/27984) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM)).
- Ускорена загрузка частей данных за счет отложенного запуска таблиц. [#28313](https://github.com/ClickHouse/ClickHouse/pull/28313) ([Amos Bird](https://github.com/amosbird)).
- Исправлено возможное чрезмерное количество условий, перемещаемых из `WHERE` в `PREWHERE` (оптимизация управляется настройкой `optimize_move_to_prewhere`). [#28139](https://github.com/ClickHouse/ClickHouse/pull/28139) ([lthaooo](https://github.com/lthaooo)).
- Настройка `optimize_distributed_group_by_sharding_key` включена по умолчанию. [#28105](https://github.com/ClickHouse/ClickHouse/pull/28105) ([Azat Khuzhin](https://github.com/azat)).

#### Улучшения {#improvement-2}


* Проверять имя кластера перед созданием таблиц `Distributed`, не допускать создание таблиц с некорректным именем кластера. Исправлено [#27832](https://github.com/ClickHouse/ClickHouse/issues/27832). [#27927](https://github.com/ClickHouse/ClickHouse/pull/27927) ([tavplubix](https://github.com/tavplubix)).
* Добавлена агрегатная функция `quantileBFloat16Weighted` по аналогии с другими функциями quantile...Weighted. Это закрывает [#27745](https://github.com/ClickHouse/ClickHouse/issues/27745). [#27758](https://github.com/ClickHouse/ClickHouse/pull/27758) ([Ivan Novitskiy](https://github.com/RedClusive)).
* Добавлена возможность создавать словари с пустым списком атрибутов. [#27905](https://github.com/ClickHouse/ClickHouse/pull/27905) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена интерактивная справка в `clickhouse-client` о том, как сбросить пароль. Это полезно в ситуации, когда пользователь установил ClickHouse, задал пароль и сразу же его забыл. См. [#27750](https://github.com/ClickHouse/ClickHouse/issues/27750). [#27903](https://github.com/ClickHouse/ClickHouse/pull/27903) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка случая, когда данные находятся в массиве во входном формате `JSONAsString`. Закрывает [#25517](https://github.com/ClickHouse/ClickHouse/issues/25517). [#25633](https://github.com/ClickHouse/ClickHouse/pull/25633) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен новый столбец `last_queue_update_exception` в таблицу `system.replicas`. [#26843](https://github.com/ClickHouse/ClickHouse/pull/26843) ([nvartolomei](https://github.com/nvartolomei)).
* Добавлена поддержка повторных подключений при failover для таблиц `MaterializedPostgreSQL`. Закрывает [#28529](https://github.com/ClickHouse/ClickHouse/issues/28529). [#28614](https://github.com/ClickHouse/ClickHouse/pull/28614) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Генерировать уникальный UUID сервера при его первом запуске. [#20089](https://github.com/ClickHouse/ClickHouse/pull/20089) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлена настройка `connection_wait_timeout` (значение по умолчанию — 5 секунд, 0 — не ждать) для движка `MySQL`. [#28474](https://github.com/ClickHouse/ClickHouse/pull/28474) ([Azat Khuzhin](https://github.com/azat)).
* Запретить создание `MaterializedPostgreSQL` с некорректными аргументами. Закрывает [#28423](https://github.com/ClickHouse/ClickHouse/issues/28423). [#28430](https://github.com/ClickHouse/ClickHouse/pull/28430) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Используется реальный временный файл вместо предопределённого &quot;rows&#95;sources&quot; для вертикальных слияний. Это позволяет избежать создания лишних каталогов на tmp-дисках. [#28299](https://github.com/ClickHouse/ClickHouse/pull/28299) ([Amos Bird](https://github.com/amosbird)).
* В конфигурацию сервера добавлен параметр `libhdfs3_conf` вместо использования переменной окружения `LIBHDFS3_CONF`, экспортируемой в clickhouse-server.service. Это используется для настройки взаимодействия с HDFS. [#28268](https://github.com/ClickHouse/ClickHouse/pull/28268) ([Zhichang Yu](https://github.com/yuzhichang)).
* Исправлена обработка удаления частей в состоянии `Temporary`, которая могла приводить к неожиданному исключению (`Part %name% doesn't exist`). Исправляет [#23661](https://github.com/ClickHouse/ClickHouse/issues/23661). [#28221](https://github.com/ClickHouse/ClickHouse/pull/28221) [#28221](https://github.com/ClickHouse/ClickHouse/issues/28221)) ([Azat Khuzhin](https://github.com/azat)).
* Исправить `zookeeper_log.address` (до первого патча в этом PR адрес всегда был `::`) и уменьшить число вызовов `getpeername(2)` для этого столбца (так как при каждом добавлении записи в `zookeeper_log` вызывается `getpeername()`, нужно кэшировать этот адрес в клиенте ZooKeeper, чтобы избежать лишних вызовов). [#28212](https://github.com/ClickHouse/ClickHouse/pull/28212) ([Azat Khuzhin](https://github.com/azat)).
* Поддержаны неявные преобразования между индексом в операторе `[]` и ключом типа `Map` (например, между различными типами `Int`, а также `String` и `FixedString`). [#28096](https://github.com/ClickHouse/ClickHouse/pull/28096) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена поддержка предложения `ON CONFLICT` при вставке данных в движок таблицы PostgreSQL или табличную функцию. Закрывает [#27727](https://github.com/ClickHouse/ClickHouse/issues/27727). [#28081](https://github.com/ClickHouse/ClickHouse/pull/28081) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Снижены ограничения для типа данных `Enum`, чтобы разрешить присоединение совместимых данных. Закрывает [#26672](https://github.com/ClickHouse/ClickHouse/issues/26672). [#28028](https://github.com/ClickHouse/ClickHouse/pull/28028) ([Dmitry Novik](https://github.com/novikd)).
* Добавлена настройка `empty_result_for_aggregation_by_constant_keys_on_empty_set` для управления поведением группировки по константным ключам при пустом наборе данных. Это позволяет вернуть прежнее поведение из [#6842](https://github.com/ClickHouse/ClickHouse/issues/6842). [#27932](https://github.com/ClickHouse/ClickHouse/pull/27932) ([Amos Bird](https://github.com/amosbird)).
* Добавлена настройка `replication_wait_for_inactive_replica_timeout`. Она позволяет указать, как долго ждать выполнения запроса `ALTER`/`OPTIMZE`/`TRUNCATE` неактивными репликами (по умолчанию 120 секунд). Если `replication_alter_partitions_sync` установлено в 2 и некоторые реплики остаются неактивными дольше, чем `replication_wait_for_inactive_replica_timeout` секунд, будет выброшено исключение `UNFINISHED`. [#27931](https://github.com/ClickHouse/ClickHouse/pull/27931) ([tavplubix](https://github.com/tavplubix)).
* Добавлена поддержка лямбда-аргумента для трансформера столбцов `APPLY`, что даёт возможность применять функции с более чем одним аргументом. Реализация для [#27877](https://github.com/ClickHouse/ClickHouse/issues/27877). [#27901](https://github.com/ClickHouse/ClickHouse/pull/27901) ([Amos Bird](https://github.com/amosbird)).
* Включена `tcp_keep_alive_timeout` по умолчанию. [#27882](https://github.com/ClickHouse/ClickHouse/pull/27882) ([Azat Khuzhin](https://github.com/azat)).
* Улучшена отмена удалённых запросов (в случае аварийного завершения удалённого сервера). [#27881](https://github.com/ClickHouse/ClickHouse/pull/27881) ([Azat Khuzhin](https://github.com/azat)).
* Используйте многокомпонентную загрузку при копировании (Multipart copy upload) для крупных объектов S3. [#27858](https://github.com/ClickHouse/ClickHouse/pull/27858) ([ianton-ru](https://github.com/ianton-ru)).
* Разрешен переход по символьным ссылкам в пути к библиотеке словаря. [#27815](https://github.com/ClickHouse/ClickHouse/pull/27815) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Теперь операция `ALTER MODIFY COLUM` `T` на `Nullable(T)` больше не требует мутации. [#27787](https://github.com/ClickHouse/ClickHouse/pull/27787) ([victorgao](https://github.com/kafka1991)).
* Ошибки больше не игнорируются молча, а задержки не учитываются в `ReadBufferFromS3`. [#27484](https://github.com/ClickHouse/ClickHouse/pull/27484) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Улучшена команда `ALTER ... MATERIALIZE TTL` за счёт пересчёта только метаданных, без фактического выполнения действий TTL. [#27019](https://github.com/ClickHouse/ClickHouse/pull/27019) ([lthaooo](https://github.com/lthaooo)).
* Добавлена возможность чтения списка пользовательских доменов верхнего уровня без символа новой строки в конце файла. [#28213](https://github.com/ClickHouse/ClickHouse/pull/28213) ([Azat Khuzhin](https://github.com/azat)).

#### Исправление ошибок {#bug-fix-1}


* Исправлены случаи, когда при чтении сжатых данных из `carbon-clickhouse` возникала ошибка «attempt to read after end of file». Закрывает [#26149](https://github.com/ClickHouse/ClickHouse/issues/26149). [#28150](https://github.com/ClickHouse/ClickHouse/pull/28150) ([FArthur-cmd](https://github.com/FArthur-cmd)).
* Исправлена проверка прав доступа при выполнении оператора `GRANT WITH REPLACE` с предложением `ON CLUSTER`. Этот PR дополняет исправление [#27001](https://github.com/ClickHouse/ClickHouse/pull/27701). [#27983](https://github.com/ClickHouse/ClickHouse/pull/27983) ([Vitaly Baranov](https://github.com/vitlibar)).
* Разрешен выбор данных с `extremes = 1` из столбца типа `LowCardinality(UUID)`. [#27918](https://github.com/ClickHouse/ClickHouse/pull/27918) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена работа приведения типов в стиле PostgreSQL (оператор `::`) с отрицательными числами. [#27876](https://github.com/ClickHouse/ClickHouse/pull/27876) ([Anton Popov](https://github.com/CurtizJ)).
* После [#26864](https://github.com/ClickHouse/ClickHouse/pull/26864) было исправлено завершение работы `NamedSessionStorage`: контексты сессий, хранящиеся в `NamedSessionStorage`, теперь уничтожаются до уничтожения глобального контекста. [#27875](https://github.com/ClickHouse/ClickHouse/pull/27875) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправление ошибки в режиме &quot;strict&quot; функции `windowFunnel`. Исправляет [#27469](https://github.com/ClickHouse/ClickHouse/issues/27469). [#27563](https://github.com/ClickHouse/ClickHouse/pull/27563) ([achimbab](https://github.com/achimbab)).
* Исправлен бесконечный цикл при чтении усечённого архива `bzip2`. [#28543](https://github.com/ClickHouse/ClickHouse/pull/28543) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен конфликт UUID в `DROP TABLE` для внутренних DDL-операций из `MaterializedMySQL`. MaterializedMySQL — экспериментальная функциональность. [#28533](https://github.com/ClickHouse/ClickHouse/pull/28533) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка `There is no subcolumn`, возникавшая при выполнении запросов `SELECT` к таблицам, содержащим столбцы типа `Nested` и скалярные столбцы с точкой в имени и тем же префиксом, что и у столбцов `Nested` (например, `n.id UInt32, n.arr1 Array(UInt64), n.arr2 Array(UInt64)`). [#28531](https://github.com/ClickHouse/ClickHouse/pull/28531) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка, которая могла приводить к сообщению `Existing table metadata in ZooKeeper differs in sorting key expression.` после выполнения ALTER таблицы `ReplicatedVersionedCollapsingMergeTree`. Исправление для [#28515](https://github.com/ClickHouse/ClickHouse/issues/28515). [#28528](https://github.com/ClickHouse/ClickHouse/pull/28528) ([alesapin](https://github.com/alesapin)).
* Исправлена возможная утечка наблюдателей ZooKeeper (незначительная проблема) при фоновой обработке распределённой очереди DDL. Закрывает [#26036](https://github.com/ClickHouse/ClickHouse/issues/26036). [#28446](https://github.com/ClickHouse/ClickHouse/pull/28446) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка, из-за которой не ставились кавычки вокруг имён таблиц в движке `MaterializedPostgreSQL`. Закрывает [#28316](https://github.com/ClickHouse/ClickHouse/issues/28316). [#28433](https://github.com/ClickHouse/ClickHouse/pull/28433) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено некорректное поведение несоединённых строк из nullable-столбца. Закрывает [#27691](https://github.com/ClickHouse/ClickHouse/issues/27691). [#28349](https://github.com/ClickHouse/ClickHouse/pull/28349) ([vdimir](https://github.com/vdimir)).
* Исправлена ошибка в оптимизации индекса NOT IN при использовании не всех столбцов ключа, что исправляет [#28120](https://github.com/ClickHouse/ClickHouse/issues/28120). [#28315](https://github.com/ClickHouse/ClickHouse/pull/28315) ([Amos Bird](https://github.com/amosbird)).
* Исправлена проблема с пересекающимися частями из-за того, что новая часть была заменена пустой. [#28310](https://github.com/ClickHouse/ClickHouse/pull/28310) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены непоследовательные результаты выполнения запросов с `ORDER BY` для таблиц `Merge` при включённой настройке `optimize_read_in_order`. [#28266](https://github.com/ClickHouse/ClickHouse/pull/28266) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено возможное чтение неинициализированной памяти для запросов с типом `Nullable(LowCardinality)` и настройкой `extremes`, установленной в 1. Исправлена ошибка [#28165](https://github.com/ClickHouse/ClickHouse/issues/28165). [#28205](https://github.com/ClickHouse/ClickHouse/pull/28205) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Несколько мелких исправлений для проекций. Подробное описание см. в PR. [#28178](https://github.com/ClickHouse/ClickHouse/pull/28178) ([Amos Bird](https://github.com/amosbird)).
* Исправлены крайне редкие ошибки сегментации (segfault) при завершении работы из-за некорректного порядка остановки перезагрузчика context/config. [#28088](https://github.com/ClickHouse/ClickHouse/pull/28088) ([nvartolomei](https://github.com/nvartolomei)).
* Исправлена обработка значения `NULL` типа `Nullable(String)` в функции `JSONExtract`. Это устраняет проблемы [#27929](https://github.com/ClickHouse/ClickHouse/issues/27929) и [#27930](https://github.com/ClickHouse/ClickHouse/issues/27930). Ошибка была внесена в [https://github.com/ClickHouse/ClickHouse/pull/25452](https://github.com/ClickHouse/ClickHouse/pull/25452). [#27939](https://github.com/ClickHouse/ClickHouse/pull/27939) ([Amos Bird](https://github.com/amosbird)).
* Несколько исправлений для нового инструмента `clickhouse-keeper`. Исправлена редкая ошибка в `clickhouse-keeper`, когда клиент мог получить ответ на наблюдение (watch response) раньше ответа на запрос (request-response). [#28197](https://github.com/ClickHouse/ClickHouse/pull/28197) ([alesapin](https://github.com/alesapin)). Исправлено некорректное поведение в `clickhouse-keeper`, когда наблюдение за списком (`getChildren`) срабатывало при запросах `set` для дочерних элементов. [#28190](https://github.com/ClickHouse/ClickHouse/pull/28190) ([alesapin](https://github.com/alesapin)). Исправлен редкий случай, когда изменения настроек `clickhouse-keeper` могли приводить к потере логов и зависанию сервера. [#28360](https://github.com/ClickHouse/ClickHouse/pull/28360) ([alesapin](https://github.com/alesapin)). Исправлена ошибка в `clickhouse-keeper`, которая могла приводить к бесконечному логированию при уменьшении `rotate_logs_interval`. [#28152](https://github.com/ClickHouse/ClickHouse/pull/28152) ([alesapin](https://github.com/alesapin)).

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-2}

- Включён Thread Fuzzer в стресс-тестах. Thread Fuzzer — это функция ClickHouse, которая позволяет тестировать больше вариантов планирования потоков и обнаруживать больше потенциальных проблем. Закрывает [#9813](https://github.com/ClickHouse/ClickHouse/issues/9813). Закрывает [#9814](https://github.com/ClickHouse/ClickHouse/issues/9814). Закрывает [#9515](https://github.com/ClickHouse/ClickHouse/issues/9515). Закрывает [#9516](https://github.com/ClickHouse/ClickHouse/issues/9516). [#27538](https://github.com/ClickHouse/ClickHouse/pull/27538) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлен новый уровень логирования `test` для тестовых окружений. Он ещё более подробный, чем стандартный уровень `trace`. [#28559](https://github.com/ClickHouse/ClickHouse/pull/28559) ([alesapin](https://github.com/alesapin)).
- Вывод информации о статусе git на этапе конфигурирования CMake. [#28047](https://github.com/ClickHouse/ClickHouse/pull/28047) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM)).
- Временно переключён репозиторий ubuntu apt на зеркало ru.archive.ubuntu.com, так как основной репозиторий (archive.ubuntu.com) не отвечает из нашей системы CI. [#28016](https://github.com/ClickHouse/ClickHouse/pull/28016) ([Ilya Yatsishin](https://github.com/qoega)).

### Релиз ClickHouse v21.9, 2021-09-09 {#clickhouse-release-v219-2021-09-09}

#### Обратно несовместимые изменения {#backward-incompatible-change-3}


- Не выводить завершающие нули в текстовом представлении типов `Decimal`. Пример: для decimal с масштабом 6 будет выведено `1.23` вместо `1.230000`. Это закрывает [#15794](https://github.com/ClickHouse/ClickHouse/issues/15794). Это может привести к небольшой несовместимости, если ваши приложения каким-либо образом полагались на завершающие нули. Сериализацией в форматах вывода можно управлять с помощью настройки `output_format_decimal_trailing_zeros`. Реализация `toString` и приведения к String изменена безусловно. [#27680](https://github.com/ClickHouse/ClickHouse/pull/27680) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Запрещено применение параметрической агрегатной функции с комбинатором `-Merge` к состоянию агрегатной функции, если состояние было создано агрегатной функцией с другими параметрами. Например, состояние `fooState(42)(x)` не может быть финализировано с помощью `fooMerge(s)` или `fooMerge(123)(s)` — параметры должны быть указаны явно, например `fooMerge(42)(s)`, и должны совпадать. Это не влияет на некоторые специальные агрегатные функции, такие как `quantile` и `sequence*`, которые используют параметры только для финализации. [#26847](https://github.com/ClickHouse/ClickHouse/pull/26847) ([tavplubix](https://github.com/tavplubix)).
- В clickhouse-local локальные адреса с портом теперь всегда рассматриваются как удалённые. [#26736](https://github.com/ClickHouse/ClickHouse/pull/26736) ([Raúl Marín](https://github.com/Algunenano)).
- Исправлена проблема, при которой в некоторых сложных запросах с псевдонимами столбцов, идентичными именам выражений, могло происходить неправильное приведение типов. Это исправляет [#25447](https://github.com/ClickHouse/ClickHouse/issues/25447). Это исправляет [#26914](https://github.com/ClickHouse/ClickHouse/issues/26914). Это исправление может привести к обратной несовместимости: если существуют разные выражения с идентичными именами, будет выброшено исключение. Это может нарушить работу в некоторых редких случаях, когда установлена настройка `enable_optimize_predicate_expression`. [#26639](https://github.com/ClickHouse/ClickHouse/pull/26639) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Теперь скалярный подзапрос всегда возвращает результат типа `Nullable`, если его тип может быть `Nullable`. Это необходимо, поскольку в случае пустого подзапроса его результат должен быть `Null`. Ранее можно было получить ошибку о несовместимых типах (вывод типа не выполняет скалярный подзапрос и мог использовать тип, не допускающий null). Скалярный подзапрос с пустым результатом, который не может быть преобразован в `Nullable` (например, `Array` или `Tuple`), теперь выбрасывает ошибку. Исправляет [#25411](https://github.com/ClickHouse/ClickHouse/issues/25411). [#26423](https://github.com/ClickHouse/ClickHouse/pull/26423) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Введён синтаксис для heredoc-документов. Пример: `SELECT $doc$ VALUE $doc$`. [#26671](https://github.com/ClickHouse/ClickHouse/pull/26671) ([Maksim Kita](https://github.com/kitaisreal)). Это изменение обратно несовместимо, если в запросе есть идентификаторы, содержащие `$` [#28768](https://github.com/ClickHouse/ClickHouse/issues/28768).
- Теперь индексы могут обрабатывать типы Nullable, включая `isNull` и `isNotNull`. [#12433](https://github.com/ClickHouse/ClickHouse/pull/12433) и [#12455](https://github.com/ClickHouse/ClickHouse/pull/12455) ([Amos Bird](https://github.com/amosbird)) и [#27250](https://github.com/ClickHouse/ClickHouse/pull/27250) ([Azat Khuzhin](https://github.com/azat)). Однако это было сделано с изменениями формата на диске, и хотя новый сервер может читать старые данные, старый сервер не может. Кроме того, если у вас есть индексы пропуска данных `MINMAX`, вы можете получить ошибку `Data after mutation/merge is not byte-identical`, поскольку новый индекс будет иметь расширение `.idx2`, тогда как раньше это было `.idx`. Это означает, что не следует откладывать обновление всех существующих реплик, поскольку в противном случае, если старая реплика (&lt;21.9) загрузит данные с новой реплики версии 21.9+, она не сможет применить индекс для загруженной части.

#### Новая функциональность {#new-feature-3}


* Реализовано short-circuit (укороченное) вычисление функций, что закрывает [#12587](https://github.com/ClickHouse/ClickHouse/issues/12587). Добавлена настройка `short_circuit_function_evaluation` для управления укороченным вычислением функций. [#23367](https://github.com/ClickHouse/ClickHouse/pull/23367) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка операторов INTERSECT, EXCEPT, ANY и ALL. [#24757](https://github.com/ClickHouse/ClickHouse/pull/24757) ([Kirill Ershov](https://github.com/zdikov)). ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка шифрования на уровне виртуальной файловой системы (шифрование данных на диске) с использованием алгоритма AES-CTR. [#24206](https://github.com/ClickHouse/ClickHouse/pull/24206) ([Latysheva Alexandra](https://github.com/alexelex)). ([Vitaly Baranov](https://github.com/vitlibar)) [#26733](https://github.com/ClickHouse/ClickHouse/pull/26733) [#26377](https://github.com/ClickHouse/ClickHouse/pull/26377) [#26465](https://github.com/ClickHouse/ClickHouse/pull/26465).
* Добавлены функции обработки естественного языка (NLP), предназначенные для токенизации, стемминга, лемматизации и поиска по расширениям синонимов. [#24997](https://github.com/ClickHouse/ClickHouse/pull/24997) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена интеграция с геометрической библиотекой S2. [#24980](https://github.com/ClickHouse/ClickHouse/pull/24980) ([Andr0901](https://github.com/Andr0901)). ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлены движок таблицы SQLite, табличная функция и движок базы данных. [#24194](https://github.com/ClickHouse/ClickHouse/pull/24194) ([Arslan Gumerov](https://github.com/g-arslan)). ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка произвольных запросов для источников словаря `MySQL`, `PostgreSQL`, `ClickHouse`, `JDBC` и `Cassandra`. Закрывает [#1270](https://github.com/ClickHouse/ClickHouse/issues/1270). [#26995](https://github.com/ClickHouse/ClickHouse/pull/26995) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлено общее (реплицированное) хранилище для пользователей, ролей, политик на уровне строк, квот и профилей настроек через ZooKeeper. [#27426](https://github.com/ClickHouse/ClickHouse/pull/27426) ([Kevin Michel](https://github.com/kmichel-aiven)).
* Добавлена поддержка сжатия для `INTO OUTFILE`, автоматически выбирающая подходящий алгоритм сжатия. Закрывает [#3473](https://github.com/ClickHouse/ClickHouse/issues/3473). [#27134](https://github.com/ClickHouse/ClickHouse/pull/27134) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* Добавлена поддержка `INSERT ... FROM INFILE` по аналогии с `SELECT ... INTO OUTFILE`. [#27655](https://github.com/ClickHouse/ClickHouse/pull/27655) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* Добавлен словарь `complex_key_range_hashed`. Решает [#22029](https://github.com/ClickHouse/ClickHouse/issues/22029). [#27629](https://github.com/ClickHouse/ClickHouse/pull/27629) ([Maksim Kita](https://github.com/kitaisreal)).
* Поддержка выражений в секции JOIN ON. Закрыт [#21868](https://github.com/ClickHouse/ClickHouse/issues/21868). [#24420](https://github.com/ClickHouse/ClickHouse/pull/24420) ([Vladimir C](https://github.com/vdimir)).
* Когда клиент подключается к серверу, он получает информацию обо всех уже накопленных сервером предупреждениях (это можно отключить с помощью параметра `--no-warnings`). Добавлена таблица `system.warnings` для сбора предупреждений о конфигурации сервера. [#26246](https://github.com/ClickHouse/ClickHouse/pull/26246) ([Filatenkov Artur](https://github.com/FArthur-cmd)). [#26282](https://github.com/ClickHouse/ClickHouse/pull/26282) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* Добавлена возможность использования константных выражений из WITH и SELECT в параметрах агрегатных функций. Закрывает [#10945](https://github.com/ClickHouse/ClickHouse/issues/10945). [#27531](https://github.com/ClickHouse/ClickHouse/pull/27531) ([abel-cheng](https://github.com/abel-cheng)).
* Добавлена функция `tupleToNameValuePairs`, которая преобразует именованный кортеж в массив пар. [#27505](https://github.com/ClickHouse/ClickHouse/pull/27505) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM)).
* Добавлена поддержка метода сжатия `bzip2` для импорта и экспорта. Закрывает [#22428](https://github.com/ClickHouse/ClickHouse/issues/22428). [#27377](https://github.com/ClickHouse/ClickHouse/pull/27377) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена функция `bitmapSubsetOffsetLimit(bitmap, offset, cardinality_limit)`. Она создаёт подмножество bitmap, ограничивая результат `cardinality_limit` элементами, начиная со смещения `offset`. [#27234](https://github.com/ClickHouse/ClickHouse/pull/27234) ([DHBin](https://github.com/DHBin)).
* Добавлен столбец `default_database` в таблицу `system.users`. [#27054](https://github.com/ClickHouse/ClickHouse/pull/27054) ([kevin wan](https://github.com/MaxWk)).
* Добавлена поддержка макроса `cluster` внутри табличных функций &#39;cluster&#39; и &#39;clusterAllReplicas&#39;. [#26913](https://github.com/ClickHouse/ClickHouse/pull/26913) ([polyprogrammist](https://github.com/PolyProgrammist)).
* Добавлены новые функции `currentRoles()`, `enabledRoles()`, `defaultRoles()`. [#26780](https://github.com/ClickHouse/ClickHouse/pull/26780) ([Vitaly Baranov](https://github.com/vitlibar)).
* Новые функции `currentProfiles()`, `enabledProfiles()`, `defaultProfiles()`. [#26714](https://github.com/ClickHouse/ClickHouse/pull/26714) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлены функции, возвращающие (initial&#95;)query&#95;id текущего запроса, что закрывает [#23682](https://github.com/ClickHouse/ClickHouse/issues/23682). [#26410](https://github.com/ClickHouse/ClickHouse/pull/26410) ([Alexey Boykov](https://github.com/mathalex)).
* Добавлена возможность `REPLACE GRANT`. [#26384](https://github.com/ClickHouse/ClickHouse/pull/26384) ([Caspian](https://github.com/Cas-pian)).
* Запрос `EXPLAIN` теперь имеет режим `EXPLAIN ESTIMATE ...`, который показывает информацию о прочитанных строках, метках и частях таблиц MergeTree. Закрывает [#23941](https://github.com/ClickHouse/ClickHouse/issues/23941). [#26131](https://github.com/ClickHouse/ClickHouse/pull/26131) ([fastio](https://github.com/fastio)).
* Добавлена таблица `system.zookeeper_log`. В неё логируются все действия клиента ZooKeeper. Реализовано в [#25449](https://github.com/ClickHouse/ClickHouse/issues/25449). [#26129](https://github.com/ClickHouse/ClickHouse/pull/26129) ([tavplubix](https://github.com/tavplubix)).
* Репликация с нулевым копированием для `ReplicatedMergeTree` поверх хранилища `HDFS`. [#25918](https://github.com/ClickHouse/ClickHouse/pull/25918) ([Zhichang Yu](https://github.com/yuzhichang)).
* Добавлена возможность вставки типа Nested как массива структур во входных форматах `Arrow`, `ORC` и `Parquet`. [#25902](https://github.com/ClickHouse/ClickHouse/pull/25902) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен новый тип данных `Date32` (хранит значения как Int32), поддерживается тот же диапазон дат, что и у `DateTime64`, добавлена возможность загрузки Parquet date32 в ClickHouse `Date32`. Добавлена новая функция `toDate32`, аналогичная `toDate`. [#25774](https://github.com/ClickHouse/ClickHouse/pull/25774) ([LiuNeng](https://github.com/liuneng1994)).
* Добавлена возможность задавать базу данных по умолчанию для пользователей. [#25268](https://github.com/ClickHouse/ClickHouse/issues/25268). [#25687](https://github.com/ClickHouse/ClickHouse/pull/25687) ([kevin wan](https://github.com/MaxWk)).
* Добавлен необязательный параметр движка `MongoDB` для передачи параметров строки подключения и поддержки SSL-соединения. Закрывает [#21189](https://github.com/ClickHouse/ClickHouse/issues/21189). Закрывает [#21041](https://github.com/ClickHouse/ClickHouse/issues/21041). [#22045](https://github.com/ClickHouse/ClickHouse/pull/22045) ([Omar Bazaraa](https://github.com/OmarBazaraa)).

#### Экспериментальная функциональность {#experimental-feature-3}

- Добавлен кодек сжатия `AES_128_GCM_SIV`, который шифрует столбцы вместо их сжатия. [#19896](https://github.com/ClickHouse/ClickHouse/pull/19896) ([PHO](https://github.com/depressed-pho)). Будет переписан, не используйте.
- Переименование `MaterializeMySQL` в `MaterializedMySQL`. [#26822](https://github.com/ClickHouse/ClickHouse/pull/26822) ([tavplubix](https://github.com/tavplubix)).

#### Улучшение производительности {#performance-improvement-3}

- Улучшена производительность быстрых запросов при `max_execution_time = 0` за счёт сокращения количества системных вызовов `clock_gettime`. [#27325](https://github.com/ClickHouse/ClickHouse/pull/27325) ([filimonov](https://github.com/filimonov)).
- Специализация операций сравнения дат и времени для повышения производительности. Исправляет [#27083](https://github.com/ClickHouse/ClickHouse/issues/27083). [#27122](https://github.com/ClickHouse/ClickHouse/pull/27122) ([Amos Bird](https://github.com/amosbird)).
- Совместное использование файловых дескрипторов при параллельном чтении одних и тех же файлов. На Linux заметной разницы в производительности нет. Однако количество открытых файлов на типичных серверах будет значительно (в 10–100 раз) меньше, что упрощает операции. См. [#26214](https://github.com/ClickHouse/ClickHouse/issues/26214). [#26768](https://github.com/ClickHouse/ClickHouse/pull/26768) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Улучшена задержка коротких запросов, требующих чтения из таблиц с большим количеством столбцов. [#26371](https://github.com/ClickHouse/ClickHouse/pull/26371) ([Anton Popov](https://github.com/CurtizJ)).
- Отказ от построения множеств для индексов при анализе запроса. [#26365](https://github.com/ClickHouse/ClickHouse/pull/26365) ([Raúl Marín](https://github.com/Algunenano)).
- Векторизация SUM для целочисленных типов Nullable с нативным представлением ([David Manzanares](https://github.com/davidmanzanares), [Raúl Marín](https://github.com/Algunenano)). [#26248](https://github.com/ClickHouse/ClickHouse/pull/26248) ([Raúl Marín](https://github.com/Algunenano)).
- Компиляция выражений, включающих столбцы с типами `Enum`. [#26237](https://github.com/ClickHouse/ClickHouse/pull/26237) ([Maksim Kita](https://github.com/kitaisreal)).
- Компиляция агрегатных функций `groupBitOr`, `groupBitAnd`, `groupBitXor`. [#26161](https://github.com/ClickHouse/ClickHouse/pull/26161) ([Maksim Kita](https://github.com/kitaisreal)).
- Улучшено использование памяти за счёт более точного прогнозирования размера блока при чтении пустых столбцов DEFAULT. Закрывает [#17317](https://github.com/ClickHouse/ClickHouse/issues/17317). [#25917](https://github.com/ClickHouse/ClickHouse/pull/25917) ([Vladimir Chebotarev](https://github.com/excitoon)).
- Сокращено использование памяти и количество прочитанных строк в запросах с `ORDER BY primary_key`. [#25721](https://github.com/ClickHouse/ClickHouse/pull/25721) ([Anton Popov](https://github.com/CurtizJ)).
- Включение `distributed_push_down_limit` по умолчанию. [#27104](https://github.com/ClickHouse/ClickHouse/pull/27104) ([Azat Khuzhin](https://github.com/azat)).
- Обеспечение монотонности `toTimeZone` при константном значении timeZone для поддержки очистки партиций при использовании SQL вида:. [#26261](https://github.com/ClickHouse/ClickHouse/pull/26261) ([huangzhaowei](https://github.com/SaintBacchus)).

#### Улучшения {#improvement-3}


* Пометить оконные функции как готовые для общего использования. Удалить настройку `allow_experimental_window_functions`. [#27184](https://github.com/ClickHouse/ClickHouse/pull/27184) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Улучшена совместимость с часовыми поясами, имеющими смещения, не кратные целым минутам. [#27080](https://github.com/ClickHouse/ClickHouse/pull/27080) ([Raúl Marín](https://github.com/Algunenano)).
* Если файловый дескриптор в таблице `File` относится к обычному файлу, разрешить многократное чтение из него. Это позволяет `clickhouse-local` многократно читать из стандартного ввода (stdin) (с несколькими запросами SELECT или подзапросами), если stdin является обычным файлом, например: `clickhouse-local --query "SELECT * FROM table UNION ALL SELECT * FROM table" ... < file`. Это закрывает [#11124](https://github.com/ClickHouse/ClickHouse/issues/11124). В соавторстве с ([alexey-milovidov](https://github.com/alexey-milovidov)). [#25960](https://github.com/ClickHouse/ClickHouse/pull/25960) ([BoloniniD](https://github.com/BoloniniD)).
* Удалён повторный анализ индексов и устранены возможные некорректные проверки `LIMIT` во время анализа проекций. [#27742](https://github.com/ClickHouse/ClickHouse/pull/27742) ([Amos Bird](https://github.com/amosbird)).
* Добавлена возможность передавать параметры запроса в теле HTTP-запросов. [#27706](https://github.com/ClickHouse/ClickHouse/pull/27706) ([Hermano Lustosa](https://github.com/hllustosa)).
* Запрещено использовать `arrayJoin` в выражениях секционирования. [#27648](https://github.com/ClickHouse/ClickHouse/pull/27648) ([Raúl Marín](https://github.com/Algunenano)).
* Записывать в лог IP-адрес клиента при ошибке аутентификации. [#27514](https://github.com/ClickHouse/ClickHouse/pull/27514) ([Misko Lee](https://github.com/imiskolee)).
* Используйте байты вместо строк для двоичных данных в протоколе gRPC. [#27431](https://github.com/ClickHouse/ClickHouse/pull/27431) ([Vitaly Baranov](https://github.com/vitlibar)).
* Отправлять ответ с сообщением об ошибке, если порт HTTP не настроен, а пользователь пытается отправить HTTP-запрос на порт TCP. [#27385](https://github.com/ClickHouse/ClickHouse/pull/27385) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM)).
* Добавлена функция `_CAST` для внутреннего использования, которая не сохраняет признак `Nullable` у типа, тогда как обычная функция `cast` будет его сохранять в соответствии с настройкой `cast_keep_nullable`. Закрывает [#12636](https://github.com/ClickHouse/ClickHouse/issues/12636). [#27382](https://github.com/ClickHouse/ClickHouse/pull/27382) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена настройка `log_formatted_queries` для записи дополнительного форматированного представления запроса в `system.query_log`. Это полезно для анализа нормализованных запросов, потому что функции `normalizeQuery` и `normalizeQueryKeepNames` не выполняют разбор и форматирование запросов ради более высокой производительности. [#27380](https://github.com/ClickHouse/ClickHouse/pull/27380) ([Amos Bird](https://github.com/amosbird)).
* Добавлены две настройки `max_hyperscan_regexp_length` и `max_hyperscan_regexp_total_length` для предотвращения использования слишком больших регулярных выражений в функциях, связанных с hyperscan, таких как `multiMatchAny`. [#27378](https://github.com/ClickHouse/ClickHouse/pull/27378) ([Amos Bird](https://github.com/amosbird)).
* Память, потребляемая битовыми агрегатными функциями, теперь учитывается в лимитах памяти. Это закрывает [#26555](https://github.com/ClickHouse/ClickHouse/issues/26555). [#27252](https://github.com/ClickHouse/ClickHouse/pull/27252) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлено 10-секундное кэширование для резолвера прокси S3. [#27216](https://github.com/ClickHouse/ClickHouse/pull/27216) ([ianton-ru](https://github.com/ianton-ru)).
* Глобальный мьютекс разбит на отдельные мьютексы для построения регулярных выражений. Это помогает избежать ситуации, когда длительное построение регулярных выражений блокирует другие связанные потоки. [#27211](https://github.com/ClickHouse/ClickHouse/pull/27211) ([Amos Bird](https://github.com/amosbird)).
* Поддержка схемы в движке базы данных PostgreSQL. Закрывает [#27166](https://github.com/ClickHouse/ClickHouse/issues/27166). [#27198](https://github.com/ClickHouse/ClickHouse/pull/27198) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлено отслеживание использования памяти в clickhouse-client. [#27191](https://github.com/ClickHouse/ClickHouse/pull/27191) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* Пытаться записывать `query_kind` в `system.query_log`, даже если запрос не удалось запустить. [#27182](https://github.com/ClickHouse/ClickHouse/pull/27182) ([Amos Bird](https://github.com/amosbird)).
* В таблицу `system.replicas` добавлены столбцы `replica_is_active`, сопоставляющие имя реплики с её статусом активности. Закрывает [#27138](https://github.com/ClickHouse/ClickHouse/issues/27138). [#27180](https://github.com/ClickHouse/ClickHouse/pull/27180) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена возможность передавать настройки запроса через URI сервера в Web UI. [#27177](https://github.com/ClickHouse/ClickHouse/pull/27177) ([kolsys](https://github.com/kolsys)).
* Добавлена новая метрика с именем `MaxPushedDDLEntryID`, которая представляет собой максимальный идентификатор записи DDL, отправленный текущим узлом в ZooKeeper. [#27174](https://github.com/ClickHouse/ClickHouse/pull/27174) ([Fuwang Hu](https://github.com/fuwhu)).
* Улучшена проверка условия существования и проверка узла с пустой строкой при создании znode в `clickhouse-keeper`. [#27125](https://github.com/ClickHouse/ClickHouse/pull/27125) ([小路](https://github.com/nicelulu)).
* Merge JOIN корректно обрабатывает пустое множество в правой части. [#27078](https://github.com/ClickHouse/ClickHouse/pull/27078) ([Vladimir C](https://github.com/vdimir)).
* Теперь функции могут быть константами на уровне шарда, то есть если они выполняются в контексте распределённой таблицы, они формируют обычный столбец, а иначе возвращают константное значение. Наиболее примечательные функции: `hostName()`, `tcpPort()`, `version()`, `buildId()`, `uptime()` и др. [#27020](https://github.com/ClickHouse/ClickHouse/pull/27020) ([Amos Bird](https://github.com/amosbird)).
* Обновлена функция `extractAllGroupsHorizontal` — верхний предел количества совпадений в строке теперь можно задать с помощью необязательного третьего аргумента. [#26961](https://github.com/ClickHouse/ClickHouse/pull/26961) ([Vasily Nemkov](https://github.com/Enmk)).
* Сделать статистику `RocksDB` доступной через таблицу system.rocksdb. Чтение настроек RocksDB из конфигурации ClickHouse (ключи `rocksdb...`). Примечание: ClickHouse не зависит от RocksDB, это лишь один из дополнительных интеграционных движков хранения. [#26821](https://github.com/ClickHouse/ClickHouse/pull/26821) ([Azat Khuzhin](https://github.com/azat)).
* Менее многословные внутренние логи RocksDB. ПРИМЕЧАНИЕ: ClickHouse не зависит от RocksDB, это всего лишь один из дополнительных движков хранения для интеграции. Закрывает [#26252](https://github.com/ClickHouse/ClickHouse/issues/26252). [#26789](https://github.com/ClickHouse/ClickHouse/pull/26789) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Изменение ролей по умолчанию влияет только на новые сеансы. [#26759](https://github.com/ClickHouse/ClickHouse/pull/26759) ([Vitaly Baranov](https://github.com/vitlibar)).
* Watchdog по умолчанию отключен в Docker. Исправлена проблема, из-за которой не обрабатывался ctrl+c. [#26757](https://github.com/ClickHouse/ClickHouse/pull/26757) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* `SET PROFILE` теперь применяет и ограничения, если они заданы для указанного профиля. [#26730](https://github.com/ClickHouse/ClickHouse/pull/26730) ([Vitaly Baranov](https://github.com/vitlibar)).
* Улучшена обработка запросов `KILL QUERY`. [#26675](https://github.com/ClickHouse/ClickHouse/pull/26675) ([Raúl Marín](https://github.com/Algunenano)).
* Функция `mapPopulatesSeries` поддерживает тип данных `Map`. [#26663](https://github.com/ClickHouse/ClickHouse/pull/26663) ([Ildus Kurbangaliev](https://github.com/ildus)).
* Исправлено двукратное количество попыток подключения при использовании `skip_unavailable_shards`. [#26658](https://github.com/ClickHouse/ClickHouse/pull/26658) ([Azat Khuzhin](https://github.com/azat)).
* Не допускать зависания `clickhouse-benchmark` при ошибке подключения (например, EMFILE). [#26656](https://github.com/ClickHouse/ClickHouse/pull/26656) ([Azat Khuzhin](https://github.com/azat)).
* Разрешить движку Kafka использовать больше потоков. [#26642](https://github.com/ClickHouse/ClickHouse/pull/26642) ([feihengye](https://github.com/feihengye)).
* Добавлена поддержка режима round-robin для `clickhouse-benchmark` (не отличается от обычного запуска с несколькими хостами/портами, за исключением отчёта о статистике). [#26607](https://github.com/ClickHouse/ClickHouse/pull/26607) ([Azat Khuzhin](https://github.com/azat)).
* Исполняемые словари (`executable`, `executable_pool`) теперь можно создавать DDL-запросом в `clickhouse-local`. Закрывает [#22355](https://github.com/ClickHouse/ClickHouse/issues/22355). [#26510](https://github.com/ClickHouse/ClickHouse/pull/26510) ([Maksim Kita](https://github.com/kitaisreal)).
* Задан тип клиентского запроса для обработчиков протоколов совместимости `mysql` и `postgresql`. [#26498](https://github.com/ClickHouse/ClickHouse/pull/26498) ([anneji-dev](https://github.com/anneji-dev)).
* Применяйте `LIMIT` на шардах для запросов вида `SELECT * FROM dist ORDER BY key LIMIT 10` при `distributed_push_down_limit=1`. Избегайте выполнения этапов `DISTINCT`/`LIMIT BY` для запросов вида `SELECT DISTINCT shading_key FROM dist ORDER BY key`. Теперь `distributed_push_down_limit` учитывается оптимизацией `optimize_distributed_group_by_sharding_key`. [#26466](https://github.com/ClickHouse/ClickHouse/pull/26466) ([Azat Khuzhin](https://github.com/azat)).
* Обновлён protobuf до версии 3.17.3. Списки изменений доступны по адресу [https://github.com/protocolbuffers/protobuf/releases](https://github.com/protocolbuffers/protobuf/releases). [#26424](https://github.com/ClickHouse/ClickHouse/pull/26424) ([Ilya Yatsishin](https://github.com/qoega)).
* Включена настройка `use_hedged_requests`, позволяющая уменьшать хвостовые задержки на больших кластерах. [#26380](https://github.com/ClickHouse/ClickHouse/pull/26380) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Улучшено поведение при указании несуществующего хоста в списке разрешённых хостов пользователя. [#26368](https://github.com/ClickHouse/ClickHouse/pull/26368) ([ianton-ru](https://github.com/ianton-ru)).
* Добавлена возможность задавать настройки монитора директории `Distributed` через оператор CREATE TABLE (например, `CREATE TABLE dist (key Int) Engine=Distributed(cluster, db, table) SETTINGS monitor_batch_inserts=1` и т. п.). [#26336](https://github.com/ClickHouse/ClickHouse/pull/26336) ([Azat Khuzhin](https://github.com/azat)).
* Сохранять адрес сервера в URL в истории веб-интерфейса, если он отличается от origin веб-интерфейса. Это закрывает [#26044](https://github.com/ClickHouse/ClickHouse/issues/26044). [#26322](https://github.com/ClickHouse/ClickHouse/pull/26322) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлены события для профилирования вызовов функций `sleep` и `sleepEachRow`. [#26320](https://github.com/ClickHouse/ClickHouse/pull/26320) ([Raúl Marín](https://github.com/Algunenano)).
* Позволяет повторно использовать подключения к шардам между разными кластерами. Также предотвращает создание новых подключений при использовании табличной функции `cluster`. [#26318](https://github.com/ClickHouse/ClickHouse/pull/26318) ([Amos Bird](https://github.com/amosbird)).
* Управление периодичностью очистки старых временных директорий с помощью параметра со значением по умолчанию. [#26212](https://github.com/ClickHouse/ClickHouse/issues/26212). [#26313](https://github.com/ClickHouse/ClickHouse/pull/26313) ([fastio](https://github.com/fastio)).
* Добавлена настройка `function_range_max_elements_in_block` для задания порога безопасного объёма данных, генерируемых функцией `range`. Это закрывает [#26303](https://github.com/ClickHouse/ClickHouse/issues/26303). [#26305](https://github.com/ClickHouse/ClickHouse/pull/26305) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Проверка хеш-функции выполняется при создании таблицы, а не при семплировании. Добавлены настройки для MergeTree: если кто-то создаёт таблицу с некорректным столбцом семплирования, но семплирование никогда не используется, эти настройки можно отключить, чтобы сервер запускался без исключения. [#26256](https://github.com/ClickHouse/ClickHouse/pull/26256) ([zhaoyu](https://github.com/zxc111)).
* Добавлена настройка `output_format_avro_string_column_pattern` для сохранения указанных столбцов типа String в Avro в виде string вместо значения по умолчанию bytes. Реализует [#22414](https://github.com/ClickHouse/ClickHouse/issues/22414). [#26245](https://github.com/ClickHouse/ClickHouse/pull/26245) ([Ilya Golshtein](https://github.com/ilejn)).
* Добавлена информация о размерах столбцов в таблицу `system.columns` для таблиц `Log` и `TinyLog`. Это закрывает задачу [#9001](https://github.com/ClickHouse/ClickHouse/issues/9001). [#26241](https://github.com/ClickHouse/ClickHouse/pull/26241) ([Nikolay Degterinsky](https://github.com/evillique)).
* Не выбрасывать исключение при выполнении запроса к таблице `system.detached_parts`, если используется пользовательская конфигурация дисков и каталог `detached` отсутствует на некоторых дисках. Исправляет [#26078](https://github.com/ClickHouse/ClickHouse/issues/26078). [#26236](https://github.com/ClickHouse/ClickHouse/pull/26236) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена проверка на недетерминированные функции в ключах, включая константные выражения, такие как `now()`, `today()`. Исправление закрывает [#25875](https://github.com/ClickHouse/ClickHouse/issues/25875). Исправление закрывает [#11333](https://github.com/ClickHouse/ClickHouse/issues/11333). [#26235](https://github.com/ClickHouse/ClickHouse/pull/26235) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Преобразование типов данных timestamp и timestamptz в `DateTime64` в движке таблицы PostgreSQL. [#26234](https://github.com/ClickHouse/ClickHouse/pull/26234) ([jasine](https://github.com/jasine)).
* Для проекций применяется агрессивный анализ индекса IN, что позволяет лучше выбирать кандидатные проекции. [#26218](https://github.com/ClickHouse/ClickHouse/pull/26218) ([Amos Bird](https://github.com/amosbird)).
* Удалено ключевое слово GLOBAL для IN при передаче скалярной функции. В предыдущих версиях, если пользователь указывал `GLOBAL IN f(x)`, генерировалось исключение. [#26217](https://github.com/ClickHouse/ClickHouse/pull/26217) ([Amos Bird](https://github.com/amosbird)).
* Добавлен идентификатор ошибки (например, `BAD_ARGUMENTS`) в сообщения об исключениях. Это закрывает [#25862](https://github.com/ClickHouse/ClickHouse/issues/25862). [#26172](https://github.com/ClickHouse/ClickHouse/pull/26172) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен некорректный вывод с опцией --progress в clickhouse-local. Полоса прогресса будет очищаться после достижения 100% — как и в clickhouse-client. Закрывает [#17484](https://github.com/ClickHouse/ClickHouse/issues/17484). [#26128](https://github.com/ClickHouse/ClickHouse/pull/26128) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена настройка `merge_selecting_sleep_ms`. [#26120](https://github.com/ClickHouse/ClickHouse/pull/26120) ([lthaooo](https://github.com/lthaooo)).
* Удалено сложное использование Linux AIO с одноблочным опережающим чтением (readahead) и вместо него используется простой синхронный ввод-вывод с O&#95;DIRECT. В предыдущих версиях настройка `min_bytes_to_use_direct_io` могла работать некорректно, если `max_threads` больше единицы. Чтение с direct IO (которое по умолчанию отключено для запросов и по умолчанию включено для крупных слияний) работало менее эффективно. Это закрывает [#25997](https://github.com/ClickHouse/ClickHouse/issues/25997). [#26003](https://github.com/ClickHouse/ClickHouse/pull/26003) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Сбрасывать таблицу `Distributed` при выполнении запроса `REPLACE TABLE`. Исправляет [#24566](https://github.com/ClickHouse/ClickHouse/issues/24566) — не заменять (и не создавать) таблицу в запросе `[CREATE OR] REPLACE TABLE ... AS SELECT`, если вставка в новую таблицу завершается с ошибкой. Исправляет [#23175](https://github.com/ClickHouse/ClickHouse/issues/23175). [#25895](https://github.com/ClickHouse/ClickHouse/pull/25895) ([tavplubix](https://github.com/tavplubix)).
* Добавлен столбец `views` в `system.query&#95;log`, содержащий имена (материализованных или live‑представлений), выполняемых запросом. Добавлена новая таблица журнала (`system.query_views_log`), которая содержит информацию о каждом представлении, выполненном во время запроса. Изменено выполнение представлений: когда при выполнении представления возникает исключение, любое представление, которое уже было запущено, продолжит выполняться до завершения. Ранее такое поведение было только при `parallel&#95;view&#95;processing=true`, а теперь оно применяется всегда. Зависимые представления теперь передают контексту информацию о прогрессе чтения. [#25714](https://github.com/ClickHouse/ClickHouse/pull/25714) ([Raúl Marín](https://github.com/Algunenano)).
* Выполнять освобождение соединений асинхронно по завершении выполнения распределённых запросов. Добавлена новая серверная настройка `max_threads_for_connection_collector`, которая задаёт количество рабочих потоков для фонового освобождения соединений. Если пул заполнен, соединение будет освобождено синхронно, но немного иначе, чем раньше: оно освобождается после отправки EOS клиенту, запрос будет считаться успешно завершённым сразу после получения достаточного объёма данных, а любые исключения будут записаны в лог вместо пробрасывания клиенту. Добавлена настройка `drain_timeout` (по умолчанию 3 секунды). Освобождение соединения приведёт к разрыву соединения по истечении тайм-аута. [#25674](https://github.com/ClickHouse/ClickHouse/pull/25674) ([Amos Bird](https://github.com/amosbird)).
* Поддержка нескольких include в конфигурации. Теперь можно подключать конфигурацию пользователей и удалённых серверов из нескольких источников. Просто поместите элемент `<include />` с атрибутом `from_zk`, `from_env` или `incl`, и он будет заменён соответствующей подстановкой. [#24404](https://github.com/ClickHouse/ClickHouse/pull/24404) ([nvartolomei](https://github.com/nvartolomei)).
* Исправлена вставка нескольких блоков в распределённую таблицу при `insert_distributed_one_random_shard = 1`. Это редко используемая функциональность. Отмечено как улучшение. [#23140](https://github.com/ClickHouse/ClickHouse/pull/23140) ([Amos Bird](https://github.com/amosbird)).
* Поддерживаются ключи и значения типов `LowCardinality` и `FixedString` для типа `Map`. [#21543](https://github.com/ClickHouse/ClickHouse/pull/21543) ([hexiaoting](https://github.com/hexiaoting)).
* Добавлена поддержка перезагрузки конфигурации с локального диска. [#19526](https://github.com/ClickHouse/ClickHouse/pull/19526) ([taiyang-li](https://github.com/taiyang-li)).

#### Исправление ошибок {#bug-fix-2}


* Исправлены несколько ошибок, которые могли приводить к расхождению реплик. [#27808](https://github.com/ClickHouse/ClickHouse/pull/27808) ([tavplubix](https://github.com/tavplubix)).
* Исправлена редкая ошибка команды `DROP PART`, которая могла приводить к ошибке `Unexpected merged part intersects drop range`. [#27807](https://github.com/ClickHouse/ClickHouse/pull/27807) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка, из-за которой происходила аварийная остановка для некоторых форматов при поступлении из Kafka сообщения NULL (tombstone). Закрывает [#19255](https://github.com/ClickHouse/ClickHouse/issues/19255). [#27794](https://github.com/ClickHouse/ClickHouse/pull/27794) ([filimonov](https://github.com/filimonov)).
* Исправлена фильтрация по столбцам с UNION DISTINCT во вложенном запросе. Закрывает [#27578](https://github.com/ClickHouse/ClickHouse/issues/27578). [#27689](https://github.com/ClickHouse/ClickHouse/pull/27689) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено некорректное приведение типов при применении функций вроде `arrayHas` к массивам LowCardinality от Nullable с разными нечисловыми типами, такими как `DateTime` и `DateTime64`. В предыдущих версиях выполнялось некорректное приведение типов. В новой версии это будет приводить к исключению. Это исправление закрывает [#26330](https://github.com/ClickHouse/ClickHouse/issues/26330). [#27682](https://github.com/ClickHouse/ClickHouse/pull/27682) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена табличная функция postgresql, из-за которой подключения не закрывались. Закрыта задача [#26088](https://github.com/ClickHouse/ClickHouse/issues/26088). [#27662](https://github.com/ClickHouse/ClickHouse/pull/27662) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен ещё один случай ошибки `Unexpected merged part ... intersecting drop range ...`. [#27656](https://github.com/ClickHouse/ClickHouse/pull/27656) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка при работе со столбцом с псевдонимом в таблице `Distributed`. [#27652](https://github.com/ClickHouse/ClickHouse/pull/27652) ([Vladimir C](https://github.com/vdimir)).
* После задания `max_memory_usage*` ненулевого значения параметр было невозможно сбросить обратно на 0 (неограниченно). Исправлено. [#27638](https://github.com/ClickHouse/ClickHouse/pull/27638) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка с переполнением вниз значения времени при его конструировании из компонентов. Закрывает [#27193](https://github.com/ClickHouse/ClickHouse/issues/27193). [#27605](https://github.com/ClickHouse/ClickHouse/pull/27605) ([Vasily Nemkov](https://github.com/Enmk)).
* Исправлен сбой при материализации проекций, когда в некоторых частях отсутствуют столбцы. Устраняет [#27512](https://github.com/ClickHouse/ClickHouse/issues/27512). [#27528](https://github.com/ClickHouse/ClickHouse/pull/27528) ([Amos Bird](https://github.com/amosbird)).
* исправлена метрика `BackgroundMessageBrokerSchedulePoolTask`, возможно, в названии была опечатка. [#27452](https://github.com/ClickHouse/ClickHouse/pull/27452) ([Ben](https://github.com/benbiti)).
* Исправлена обработка распределённых запросов при нулевом числе шардов и агрегации. [#27427](https://github.com/ClickHouse/ClickHouse/pull/27427) ([Azat Khuzhin](https://github.com/azat)).
* Совместимость в случае, когда `/proc/meminfo` не содержит суффикса KB. [#27361](https://github.com/ClickHouse/ClickHouse/pull/27361) ([Mike Kot](https://github.com/myrrc)).
* Исправлен некорректный результат запроса с построчной безопасностью, PREWHERE и фильтром по LowCardinality. Исправляет [#27179](https://github.com/ClickHouse/ClickHouse/issues/27179). [#27329](https://github.com/ClickHouse/ClickHouse/pull/27329) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена некорректная проверка идентификатора партиции для таблиц MergeTree, созданных с использованием старого синтаксиса. [#27328](https://github.com/ClickHouse/ClickHouse/pull/27328) ([tavplubix](https://github.com/tavplubix)).
* Исправлен протокол MySQL при использовании параллельных форматов CSV/TSV. [#27326](https://github.com/ClickHouse/ClickHouse/pull/27326) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена ошибка `Cannot find column`, возникавшая в запросах с выборкой (sampling). Была допущена в [#24574](https://github.com/ClickHouse/ClickHouse/issues/24574). Исправляет [#26522](https://github.com/ClickHouse/ClickHouse/issues/26522). [#27301](https://github.com/ClickHouse/ClickHouse/pull/27301) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлены ошибки вида `Expected ColumnLowCardinality, gotUInt8` или `Bad cast from type DB::ColumnVector<char8_t> to DB::ColumnLowCardinality` для некоторых запросов с `LowCardinality` в `PREWHERE`. И что ещё важнее, устранено отсутствие пробела в сообщении об ошибке. Исправлена проблема [#23515](https://github.com/ClickHouse/ClickHouse/issues/23515). [#27298](https://github.com/ClickHouse/ClickHouse/pull/27298) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена работа `distributed_group_by_no_merge = 2` с `distributed_push_down_limit = 1` или `optimize_distributed_group_by_sharding_key = 1` с `LIMIT BY` и `LIMIT OFFSET`. [#27249](https://github.com/ClickHouse/ClickHouse/pull/27249) ([Azat Khuzhin](https://github.com/azat)). Это малоизвестные комбинации настроек, которые никто не использует.
* Исправлено зависание мутаций на некорректных партициях в нереплицированном MergeTree. [#27248](https://github.com/ClickHouse/ClickHouse/pull/27248) ([Azat Khuzhin](https://github.com/azat)).
* При неоднозначности лямбда-функции отдают предпочтение своим аргументам по сравнению с другими псевдонимами или идентификаторами. [#27235](https://github.com/ClickHouse/ClickHouse/pull/27235) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена структура столбцов в merge join, закрыт [#27091](https://github.com/ClickHouse/ClickHouse/issues/27091). [#27217](https://github.com/ClickHouse/ClickHouse/pull/27217) ([Vladimir C](https://github.com/vdimir)).
* В редких случаях таблица `system.detached_parts` могла содержать некорректную информацию о некоторых частях — ошибка исправлена. Исправление для [#27114](https://github.com/ClickHouse/ClickHouse/issues/27114). [#27183](https://github.com/ClickHouse/ClickHouse/pull/27183) ([tavplubix](https://github.com/tavplubix)).
* Исправлено использование неинициализированной памяти в функциях `multiSearch*` при обработке пустого массива, закрыта задача [#27169](https://github.com/ClickHouse/ClickHouse/issues/27169). [#27181](https://github.com/ClickHouse/ClickHouse/pull/27181) ([Vladimir C](https://github.com/vdimir)).
* Исправлена синхронизация в gRPCServer. Этот PR устраняет [#27024](https://github.com/ClickHouse/ClickHouse/issues/27024). [#27064](https://github.com/ClickHouse/ClickHouse/pull/27064) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен разбор конфигурации `cache`, `complex_key_cache`, `ssd_cache`, `complex_key_ssd_cache`. Параметры `allow_read_expired_keys`, `max_update_queue_size`, `update_queue_push_timeout_milliseconds`, `query_wait_timeout_milliseconds` не обрабатывались для словарей с типом, отличным от `cache`. [#27032](https://github.com/ClickHouse/ClickHouse/pull/27032) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена возможная некорректная работа стека мутаций при гонке с DROP&#95;RANGE. [#27002](https://github.com/ClickHouse/ClickHouse/pull/27002) ([Azat Khuzhin](https://github.com/azat)).
* Теперь идентификатор партиции в запросах типа `ALTER TABLE ... PARTITION ID xxx` проверяется на корректность. Исправлена ошибка [#25718](https://github.com/ClickHouse/ClickHouse/issues/25718). [#26963](https://github.com/ClickHouse/ClickHouse/pull/26963) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка «Unknown column name», возникавшая при использовании нескольких JOIN-ов в некоторых случаях, закрыт [#26899](https://github.com/ClickHouse/ClickHouse/issues/26899). [#26957](https://github.com/ClickHouse/ClickHouse/pull/26957) ([Vladimir C](https://github.com/vdimir)).
* Исправлено чтение пользовательских TLD, из-за которого обработка останавливалась при меньшем буфере или большем файле. [#26948](https://github.com/ClickHouse/ClickHouse/pull/26948) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка `Missing columns: 'xxx'`, возникающая, когда столбец с выражением `DEFAULT` ссылается на другой нематериализованный столбец без собственного выражения `DEFAULT`. Исправляет [#26591](https://github.com/ClickHouse/ClickHouse/issues/26591). [#26900](https://github.com/ClickHouse/ClickHouse/pull/26900) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка загрузки ключей словаря в `library-bridge` для источника словаря `library`. [#26834](https://github.com/ClickHouse/ClickHouse/pull/26834) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Параметры агрегатной функции могли теряться при применении некоторых комбинаторов, что вызывало исключения вида `Conversion from AggregateFunction(topKArray, Array(String)) to AggregateFunction(topKArray(10), Array(String)) is not supported`. Проблема исправлена. Исправляет [#26196](https://github.com/ClickHouse/ClickHouse/issues/26196) и [#26433](https://github.com/ClickHouse/ClickHouse/issues/26433). [#26814](https://github.com/ClickHouse/ClickHouse/pull/26814) ([tavplubix](https://github.com/tavplubix)).
* Добавлено значение `event_time_microseconds` для `REMOVE_PART` в таблице `system.part_log`. В предыдущих версиях оно не задавалось. [#26720](https://github.com/ClickHouse/ClickHouse/pull/26720) ([Azat Khuzhin](https://github.com/azat)).
* Не удаляйте данные при завершении работы таблицы ReplicatedMergeTree, чтобы избежать несоответствия между данными и метаданными. [#26716](https://github.com/ClickHouse/ClickHouse/pull/26716) ([nvartolomei](https://github.com/nvartolomei)).
* Иногда `SET ROLE` работал некорректно, этот PR устраняет проблему. [#26707](https://github.com/ClickHouse/ClickHouse/pull/26707) ([Vitaly Baranov](https://github.com/vitlibar)).
* Некоторые исправления в параллельном форматировании ([https://github.com/ClickHouse/ClickHouse/issues/26694](https://github.com/ClickHouse/ClickHouse/issues/26694)). [#26703](https://github.com/ClickHouse/ClickHouse/pull/26703) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена потенциальная ошибка разыменования nullptr в оконных функциях. Исправляет [#25276](https://github.com/ClickHouse/ClickHouse/issues/25276). [#26668](https://github.com/ClickHouse/ClickHouse/pull/26668) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Исправлено преобразование файла истории clickhouse-client (при обновлении с формата версии clickhouse-client трёхлетней давности), если файл пуст. [#26589](https://github.com/ClickHouse/ClickHouse/pull/26589) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены некорректные имена функций groupBitmapAnd/Or/Xor, которые в некоторых случаях отображались неправильно. Ошибка исправлена. [#26557](https://github.com/ClickHouse/ClickHouse/pull/26557) ([Amos Bird](https://github.com/amosbird)).
* Обновлена проверка команды `chown` в entrypoint Docker-образа `clickhouse-server`. Это исправляет ошибку, из-за которой перезапуск пода кластера в Kubernetes завершался с ошибкой (или по тайм-ауту). [#26545](https://github.com/ClickHouse/ClickHouse/pull/26545) ([Ky Li](https://github.com/Kylinrix)).
* Исправлено падение при завершении работы `RabbitMQ` в случае, если процедура настройки `RabbitMQ` не была запущена. Закрывает [#26504](https://github.com/ClickHouse/ClickHouse/issues/26504). [#26529](https://github.com/ClickHouse/ClickHouse/pull/26529) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлены проблемы с запросом `CREATE DICTIONARY`, возникавшие при взятии в кавычки имени словаря или имени базы данных. Закрывает [#26491](https://github.com/ClickHouse/ClickHouse/issues/26491). [#26508](https://github.com/ClickHouse/ClickHouse/pull/26508) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлено некорректное разрешение имён столбцов после переписывания алиасов столбцов. Исправлена ошибка [#26432](https://github.com/ClickHouse/ClickHouse/issues/26432). [#26475](https://github.com/ClickHouse/ClickHouse/pull/26475) ([Amos Bird](https://github.com/amosbird)).
* Исправлен один из сбоев msan, обнаруженный фаззингом. Исправляет [#22517](https://github.com/ClickHouse/ClickHouse/issues/22517). [#26428](https://github.com/ClickHouse/ClickHouse/pull/26428) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен бесконечный поток неприсоединённых блоков в `partial_merge_join`, закрывает [#26325](https://github.com/ClickHouse/ClickHouse/issues/26325). [#26374](https://github.com/ClickHouse/ClickHouse/pull/26374) ([Vladimir C](https://github.com/vdimir)).
* Исправлен возможный сбой при входе под удалённым пользователем. Этот PR исправляет [#26073](https://github.com/ClickHouse/ClickHouse/issues/26073). [#26363](https://github.com/ClickHouse/ClickHouse/pull/26363) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена работа настройки `optimize_distributed_group_by_sharding_key` для нескольких столбцов (ранее она могла приводить к некорректным результатам при `optimize_skip_unused_shards=1`/`allow_nondeterministic_optimize_skip_unused_shards=1` и использовании нескольких столбцов в выражении ключа шардирования). [#26353](https://github.com/ClickHouse/ClickHouse/pull/26353) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена редкая ошибка в механизме восстановления потерянной реплики, которая могла приводить к расхождению между репликами. [#26321](https://github.com/ClickHouse/ClickHouse/pull/26321) ([tavplubix](https://github.com/tavplubix)).
* Исправлена проблема с декомпрессией zstd (для импорта/экспорта во фреймовом формате zstd, не связанном с данными таблиц) в случае, когда в конце внутреннего буфера присутствуют escape-последовательности. Закрывает [#26013](https://github.com/ClickHouse/ClickHouse/issues/26013). [#26314](https://github.com/ClickHouse/ClickHouse/pull/26314) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена логическая ошибка в JOIN с TOTALS, закрыта задача [#26017](https://github.com/ClickHouse/ClickHouse/issues/26017). [#26250](https://github.com/ClickHouse/ClickHouse/pull/26250) ([Vladimir C](https://github.com/vdimir)).
* Удалён лишний перевод строки в столбце `thread_name` таблицы `system.stack_trace`. Это исправляет [#24124](https://github.com/ClickHouse/ClickHouse/issues/24124). [#26210](https://github.com/ClickHouse/ClickHouse/pull/26210) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена потенциальная ошибка падения при использовании более одного выражения `untuple`. [#26179](https://github.com/ClickHouse/ClickHouse/pull/26179) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Не выбрасывать исключение в `toString` для Nullable Enum, если в Enum нет значения для нуля, закрыта задача [#25806](https://github.com/ClickHouse/ClickHouse/issues/25806). [#26123](https://github.com/ClickHouse/ClickHouse/pull/26123) ([Vladimir C](https://github.com/vdimir)).
* Исправлен некорректный `sequence_id` в пакетах протокола MySQL, которые ClickHouse отправляет при возникновении исключения во время выполнения запроса. Это могло приводить к разрыву соединения MySQL-клиента с сервером ClickHouse. Исправляет [#21184](https://github.com/ClickHouse/ClickHouse/issues/21184). [#26051](https://github.com/ClickHouse/ClickHouse/pull/26051) ([tavplubix](https://github.com/tavplubix)).
* Исправлен случай, когда `cutToFirstSignificantSubdomainCustom()`/`cutToFirstSignificantSubdomainCustomWithWWW()`/`firstSignificantSubdomainCustom()` возвращают некорректный тип для констант, из-за чего `optimize_skip_unused_shards` не работает: [#26041](https://github.com/ClickHouse/ClickHouse/pull/26041) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено возможное несоответствие заголовка при использовании обычной проекции с `prewhere`. Это исправляет [#26020](https://github.com/ClickHouse/ClickHouse/issues/26020). [#26038](https://github.com/ClickHouse/ClickHouse/pull/26038) ([Amos Bird](https://github.com/amosbird)).
* Исправлена работа `sharding_key` из столбца без функции для `remote()` (раньше `select * from remote('127.1', system.one, dummy)` приводил к ошибке `Unknown column: dummy, there are only columns .`). [#25824](https://github.com/ClickHouse/ClickHouse/pull/25824) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены ошибки `Not found column ...` и `Missing column ...` при выборке из `MaterializeMySQL`. Исправляет [#23708](https://github.com/ClickHouse/ClickHouse/issues/23708), [#24830](https://github.com/ClickHouse/ClickHouse/issues/24830), [#25794](https://github.com/ClickHouse/ClickHouse/issues/25794). [#25822](https://github.com/ClickHouse/ClickHouse/pull/25822) ([tavplubix](https://github.com/tavplubix)).
* Исправлена работа `optimize_skip_unused_shards_rewrite_in` для типов данных, отличных от UInt64 (из-за этого могли выбираться неверные шарды или выбрасываться исключения `Cannot infer type of an empty tuple` или `Function tuple requires at least one argument`). [#25798](https://github.com/ClickHouse/ClickHouse/pull/25798) ([Azat Khuzhin](https://github.com/azat)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-3}

- Теперь stateful и stateless тесты запускаются в случайных часовых поясах. Исправляет [#12439](https://github.com/ClickHouse/ClickHouse/issues/12439). Чтение String как DateTime и запись DateTime как String в формате Protobuf теперь учитывают часовой пояс. Чтение UInt16 как DateTime в форматах Arrow и Parquet теперь обрабатывает его как Date, а затем преобразует в DateTime с учётом часового пояса DateTime, поскольку Date сериализуется в Arrow и Parquet как UInt16. GraphiteMergeTree теперь учитывает часовой пояс при округлении времени. Исправляет [#5098](https://github.com/ClickHouse/ClickHouse/issues/5098). Автор: @alexey-milovidov. [#15408](https://github.com/ClickHouse/ClickHouse/pull/15408) ([alesapin](https://github.com/alesapin)).
- `clickhouse-test` поддерживает SQL-тесты с шаблонами [Jinja2](https://jinja.palletsprojects.com/en/3.0.x/templates/#synopsis). [#26579](https://github.com/ClickHouse/ClickHouse/pull/26579) ([Vladimir C](https://github.com/vdimir)).
- Добавлена поддержка сборки с `clang-13`. Закрывает [#27705](https://github.com/ClickHouse/ClickHouse/issues/27705). [#27714](https://github.com/ClickHouse/ClickHouse/pull/27714) ([alexey-milovidov](https://github.com/alexey-milovidov)). [#27777](https://github.com/ClickHouse/ClickHouse/pull/27777) ([Sergei Semin](https://github.com/syominsergey))
- Добавлены опции CMake для сборки с определённым набором инструкций CPU или без него. Это для [#17469](https://github.com/ClickHouse/ClickHouse/issues/17469) и [#27509](https://github.com/ClickHouse/ClickHouse/issues/27509). [#27508](https://github.com/ClickHouse/ClickHouse/pull/27508) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Исправлена компоновка вспомогательных программ при использовании динамических библиотек. [#26958](https://github.com/ClickHouse/ClickHouse/pull/26958) ([Raúl Marín](https://github.com/Algunenano)).
- Обновление RocksDB до версии `2021-07-16` master. [#26411](https://github.com/ClickHouse/ClickHouse/pull/26411) ([alexey-milovidov](https://github.com/alexey-milovidov)).

### Релиз ClickHouse v21.8, 2021-08-12 {#clickhouse-release-v218-2021-08-12}

#### Примечания по обновлению {#upgrade-notes}

- Новая версия использует тип данных `Map` для таблиц системных логов (`system.query_log`, `system.query_thread_log`, `system.processes`, `system.opentelemetry_span_log`). Эти таблицы будут автоматически созданы с новыми типами данных. Виртуальные колонки создаются для поддержки старых запросов. Закрывает [#18698](https://github.com/ClickHouse/ClickHouse/issues/18698). [#23934](https://github.com/ClickHouse/ClickHouse/pull/23934), [#25773](https://github.com/ClickHouse/ClickHouse/pull/25773) ([hexiaoting](https://github.com/hexiaoting), [sundy-li](https://github.com/sundy-li), [Maksim Kita](https://github.com/kitaisreal)). Если вы хотите _откатиться_ с версии 21.8 на более старые версии, вам потребуется вручную очистить системные таблицы с логами. Смотрите `/var/lib/clickhouse/data/system/*_log`.

#### Новые возможности {#new-features}


- Добавлена поддержка части стандарта SQL/JSON. [#24148](https://github.com/ClickHouse/ClickHouse/pull/24148) ([l1tsolaiki](https://github.com/l1tsolaiki), [Kseniia Sumarokova](https://github.com/kssenii)).
- Сбор общих системных метрик (в `system.asynchronous_metrics` и `system.asynchronous_metric_log`) по использованию CPU, дисков, памяти, IO, сети, файлов, средней нагрузке, частотам CPU, температурным датчикам, счётчикам EDAC, времени работы системы; также добавлены метрики о джиттере планирования и времени, затраченном на сбор метрик. Работает аналогично `atop` в ClickHouse и позволяет получать доступ к данным мониторинга даже при отсутствии дополнительных инструментов. Закрывает [#9430](https://github.com/ClickHouse/ClickHouse/issues/9430). [#24416](https://github.com/ClickHouse/ClickHouse/pull/24416) ([alexey-milovidov](https://github.com/alexey-milovidov), [Yegor Levankov](https://github.com/elevankoff)).
- Добавлены движок таблиц MaterializedPostgreSQL и движок баз данных. Этот движок баз данных позволяет реплицировать целую базу данных или любое подмножество таблиц базы данных. [#20470](https://github.com/ClickHouse/ClickHouse/pull/20470) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлены новые функции `leftPad()`, `rightPad()`, `leftPadUTF8()`, `rightPadUTF8()`. [#26075](https://github.com/ClickHouse/ClickHouse/pull/26075) ([Vitaly Baranov](https://github.com/vitlibar)).
- Добавлено ключевое слово `FIRST` в команду `ADD INDEX` для возможности добавления индекса в начало списка индексов. [#25904](https://github.com/ClickHouse/ClickHouse/pull/25904) ([xjewer](https://github.com/xjewer)).
- Добавлена таблица `system.data_skipping_indices`, содержащая информацию о существующих индексах пропуска данных. Закрывает [#7659](https://github.com/ClickHouse/ClickHouse/issues/7659). [#25693](https://github.com/ClickHouse/ClickHouse/pull/25693) ([Dmitry Novik](https://github.com/novikd)).
- Добавлены функции `bin`/`unbin`. [#25609](https://github.com/ClickHouse/ClickHouse/pull/25609) ([zhaoyu](https://github.com/zxc111)).
- Добавлена поддержка типов `Map` и `UInt128`, `Int128`, `UInt256`, `Int256` в функциях `mapAdd` и `mapSubtract`. [#25596](https://github.com/ClickHouse/ClickHouse/pull/25596) ([Ildus Kurbangaliev](https://github.com/ildus)).
- Добавлена поддержка выражения `DISTINCT ON (columns)`, закрывает [#25404](https://github.com/ClickHouse/ClickHouse/issues/25404). [#25589](https://github.com/ClickHouse/ClickHouse/pull/25589) ([Zijie Lu](https://github.com/TszKitLo40)).
- Добавлена возможность сброса пользовательской настройки к значению по умолчанию и удаления её из метаданных таблицы. Это позволяет откатить изменение без знания значения по умолчанию в системе/конфигурации. Закрывает [#14449](https://github.com/ClickHouse/ClickHouse/issues/14449). [#17769](https://github.com/ClickHouse/ClickHouse/pull/17769) ([xjewer](https://github.com/xjewer)).
- Отображение конвейеров в виде графов в веб-интерфейсе при выполнении запроса `EXPLAIN PIPELINE graph = 1`. [#26067](https://github.com/ClickHouse/ClickHouse/pull/26067) ([alexey-milovidov](https://github.com/alexey-milovidov)).

#### Улучшения производительности {#performance-improvements}

- Компиляция агрегатных функций. Используйте опцию `compile_aggregate_expressions` для включения. [#24789](https://github.com/ClickHouse/ClickHouse/pull/24789) ([Maksim Kita](https://github.com/kitaisreal)).
- Улучшена задержка коротких запросов, требующих чтения из таблиц с большим количеством столбцов. [#26371](https://github.com/ClickHouse/ClickHouse/pull/26371) ([Anton Popov](https://github.com/CurtizJ)).

#### Улучшения {#improvements}


* Используйте тип данных `Map` для таблиц системных логов (`system.query_log`, `system.query_thread_log`, `system.processes`, `system.opentelemetry_span_log`). Эти таблицы будут автоматически созданы с новыми типами данных. Для обеспечения совместимости со старыми запросами создаются виртуальные столбцы. Закрывает [#18698](https://github.com/ClickHouse/ClickHouse/issues/18698). [#23934](https://github.com/ClickHouse/ClickHouse/pull/23934), [#25773](https://github.com/ClickHouse/ClickHouse/pull/25773) ([hexiaoting](https://github.com/hexiaoting), [sundy-li](https://github.com/sundy-li), [Maksim Kita](https://github.com/kitaisreal)).
* Для словаря со сложным ключом, содержащим только один атрибут, разрешено не оборачивать выражение ключа в `tuple` для функций `dictGet`, `dictHas`. [#26130](https://github.com/ClickHouse/ClickHouse/pull/26130) ([Maksim Kita](https://github.com/kitaisreal)).
* Функции `bin`/`hex` реализованы для состояний `AggregateFunction`. [#26094](https://github.com/ClickHouse/ClickHouse/pull/26094) ([zhaoyu](https://github.com/zxc111)).
* Добавлена поддержка аргументов типа `UUID` для функций `empty` и `notEmpty`. `UUID` считается пустым, если он целиком состоит из нулей (nil UUID). Закрывает [#3446](https://github.com/ClickHouse/ClickHouse/issues/3446). [#25974](https://github.com/ClickHouse/ClickHouse/pull/25974) ([zhaoyu](https://github.com/zxc111)).
* Добавлена поддержка команды `SET SQL_SELECT_LIMIT` для протокола MySQL. Закрывает [#17115](https://github.com/ClickHouse/ClickHouse/issues/17115). [#25972](https://github.com/ClickHouse/ClickHouse/pull/25972) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Больше инструментации для сетевого взаимодействия: добавлены счетчики для полученных/отправленных байт; добавлены gauge‑метрики для операций recv/send. Добавлена недостающая документация. Закрыт [#5897](https://github.com/ClickHouse/ClickHouse/issues/5897). [#25962](https://github.com/ClickHouse/ClickHouse/pull/25962) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена настройка `optimize_move_to_prewhere_if_final`. Если запрос содержит `FINAL`, оптимизация `move_to_prewhere` будет включена только при одновременном включении настроек `optimize_move_to_prewhere` и `optimize_move_to_prewhere_if_final`. Закрывает [#8684](https://github.com/ClickHouse/ClickHouse/issues/8684). [#25940](https://github.com/ClickHouse/ClickHouse/pull/25940) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Разрешить сложные заключённые в кавычки идентификаторы таблиц в JOIN. Закрывает [#17861](https://github.com/ClickHouse/ClickHouse/issues/17861). [#25924](https://github.com/ClickHouse/ClickHouse/pull/25924) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка компонентов в кодировке Юникод (например, китайских, кириллических) в типах данных `Nested`. Закрывает [#25594](https://github.com/ClickHouse/ClickHouse/issues/25594). [#25923](https://github.com/ClickHouse/ClickHouse/pull/25923) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Разрешена работа функций `quantiles*` с `aggregate_functions_null_for_empty`. Закрыта задача [#25892](https://github.com/ClickHouse/ClickHouse/issues/25892). [#25919](https://github.com/ClickHouse/ClickHouse/pull/25919) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Разрешает параметрам параметрических агрегатных функций быть произвольными константными выражениями (например, `1 + 2`), а не только литералами. Также позволяет использовать параметры запроса (в параметризованных запросах вида `{param:UInt8}`) внутри параметрических агрегатных функций. Закрывает [#11607](https://github.com/ClickHouse/ClickHouse/issues/11607). [#25910](https://github.com/ClickHouse/ClickHouse/pull/25910) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Корректно выбрасывать исключение при попытке разбора некорректного `Date`. Закрывает [#6481](https://github.com/ClickHouse/ClickHouse/issues/6481). [#25909](https://github.com/ClickHouse/ClickHouse/pull/25909) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Поддержка нескольких include в конфигурации. Теперь можно подключать конфигурации пользователей и удалённых серверов из разных источников. Достаточно поместить элемент `<include />` с атрибутом `from_zk`, `from_env` или `incl`, и он будет заменён результатом подстановки. [#24404](https://github.com/ClickHouse/ClickHouse/pull/24404) ([nvartolomei](https://github.com/nvartolomei)).
* Поддержка запросов с колонкой с именем `"null"` (его нужно указывать в обратных кавычках или двойных кавычках) и `ON CLUSTER`. Закрывает [#24035](https://github.com/ClickHouse/ClickHouse/issues/24035). [#25907](https://github.com/ClickHouse/ClickHouse/pull/25907) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Реализована поддержка типов `LowCardinality`, `Decimal` и `UUID` для `JSONExtract`. Закрывает [#24606](https://github.com/ClickHouse/ClickHouse/issues/24606). [#25900](https://github.com/ClickHouse/ClickHouse/pull/25900) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Преобразован файл истории из формата `readline` в формат `replxx`. [#25888](https://github.com/ClickHouse/ClickHouse/pull/25888) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема, которая могла приводить к появлению пересекающихся партиций после `DROP PART` или фонового удаления пустой партиции. [#25884](https://github.com/ClickHouse/ClickHouse/pull/25884) ([alesapin](https://github.com/alesapin)).
* Улучшена обработка потерянных частей данных для таблиц `ReplicatedMergeTree`. Исправлены редкие несогласованности в `ReplicationQueue`. Исправлена ошибка [#10368](https://github.com/ClickHouse/ClickHouse/issues/10368). [#25820](https://github.com/ClickHouse/ClickHouse/pull/25820) ([alesapin](https://github.com/alesapin)).
* Разрешен запуск clickhouse-client при недоступном рабочем каталоге. [#25817](https://github.com/ClickHouse/ClickHouse/pull/25817) ([ianton-ru](https://github.com/ianton-ru)).
* Исправлена ошибка «No available columns» для хранилища `Merge`. [#25801](https://github.com/ClickHouse/ClickHouse/pull/25801) ([Azat Khuzhin](https://github.com/azat)).
* MySQL Engine теперь поддерживает обмен комментариями к столбцам между MySQL и ClickHouse. [#25795](https://github.com/ClickHouse/ClickHouse/pull/25795) ([Storozhuk Kostiantyn](https://github.com/sand6255)).
* Исправлено непоследовательное поведение `GROUP BY` с константой на пустом наборе данных. Закрывает [#6842](https://github.com/ClickHouse/ClickHouse/issues/6842). [#25786](https://github.com/ClickHouse/ClickHouse/pull/25786) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отмена уже выполняющихся слияний в разделе при выполнении команд `DROP PARTITION` и `TRUNCATE` для таблиц `ReplicatedMergeTree`. Исправляет [#17151](https://github.com/ClickHouse/ClickHouse/issues/17151). [#25684](https://github.com/ClickHouse/ClickHouse/pull/25684) ([tavplubix](https://github.com/tavplubix)).
* Добавлена поддержка типа данных `ENUM` для MaterializeMySQL. [#25676](https://github.com/ClickHouse/ClickHouse/pull/25676) ([Storozhuk Kostiantyn](https://github.com/sand6255)).
* Реализована поддержка материализованных и алиасных столбцов в `JOIN`, закрыта задача [#13274](https://github.com/ClickHouse/ClickHouse/issues/13274). [#25634](https://github.com/ClickHouse/ClickHouse/pull/25634) ([Vladimir C](https://github.com/vdimir)).
* Исправлена возможная логическая гонка условий между `ALTER TABLE ... DETACH` и фоновыми слияниями. [#25605](https://github.com/ClickHouse/ClickHouse/pull/25605) ([Azat Khuzhin](https://github.com/azat)).
* Метрика `NetworkReceiveElapsedMicroseconds` теперь корректно учитывает время, затраченное на ожидание данных от клиента при выполнении `INSERT`. Закрывает [#9958](https://github.com/ClickHouse/ClickHouse/issues/9958). [#25602](https://github.com/ClickHouse/ClickHouse/pull/25602) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка `TRUNCATE TABLE` для S3 и HDFS. Закрывает [#25530](https://github.com/ClickHouse/ClickHouse/issues/25530). [#25550](https://github.com/ClickHouse/ClickHouse/pull/25550) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка динамической перезагрузки конфигурации для изменения числа потоков в пуле фонового выполнения задач (слияний, мутаций, загрузок). [#25548](https://github.com/ClickHouse/ClickHouse/pull/25548) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Разрешено извлечение элемента нестрокового типа как строки с помощью `JSONExtract`. Это относится к [#25414](https://github.com/ClickHouse/ClickHouse/issues/25414). [#25452](https://github.com/ClickHouse/ClickHouse/pull/25452) ([Amos Bird](https://github.com/amosbird)).
* Добавлена поддержка регулярных выражений в аргументе `Database` для `StorageMerge`. Закрывает [#776](https://github.com/ClickHouse/ClickHouse/issues/776). [#25064](https://github.com/ClickHouse/ClickHouse/pull/25064) ([flynn](https://github.com/ucasfl)).
* Веб-интерфейс: если значение похоже на URL, автоматически создавать ссылку. [#25965](https://github.com/ClickHouse/ClickHouse/pull/25965) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Обеспечить работу команды `sudo service clickhouse-server start` на системах с `systemd`, таких как CentOS 8. Закрывает [#14298](https://github.com/ClickHouse/ClickHouse/issues/14298). Закрывает [#17799](https://github.com/ClickHouse/ClickHouse/issues/17799). [#25921](https://github.com/ClickHouse/ClickHouse/pull/25921) ([alexey-milovidov](https://github.com/alexey-milovidov)).

#### Исправления ошибок {#bug-fixes-1}


* Исправлено некорректное поведение `SET ROLE` в некоторых случаях. [#26707](https://github.com/ClickHouse/ClickHouse/pull/26707) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено возможное разыменование `nullptr` в оконных функциях. Исправлена ошибка [#25276](https://github.com/ClickHouse/ClickHouse/issues/25276). [#26668](https://github.com/ClickHouse/ClickHouse/pull/26668) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Исправлены некорректные имена функций `groupBitmapAnd/Or/Xor`. Исправление [#26557](https://github.com/ClickHouse/ClickHouse/pull/26557) ([Amos Bird](https://github.com/amosbird)).
* Устранён сбой при завершении работы RabbitMQ, если RabbitMQ setup не был запущен. Закрывает [#26504](https://github.com/ClickHouse/ClickHouse/issues/26504). [#26529](https://github.com/ClickHouse/ClickHouse/pull/26529) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлены проблемы с запросом `CREATE DICTIONARY`, когда имя словаря или базы данных было заключено в кавычки. Закрывает [#26491](https://github.com/ClickHouse/ClickHouse/issues/26491). [#26508](https://github.com/ClickHouse/ClickHouse/pull/26508) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена некорректная работа разрешения имён после переписывания псевдонимов столбцов. Исправление [#26432](https://github.com/ClickHouse/ClickHouse/issues/26432). [#26475](https://github.com/ClickHouse/ClickHouse/pull/26475) ([Amos Bird](https://github.com/amosbird)).
* Исправлена проблема бесконечного потока неприсоединённых блоков в `partial_merge_join`, что закрывает [#26325](https://github.com/ClickHouse/ClickHouse/issues/26325). [#26374](https://github.com/ClickHouse/ClickHouse/pull/26374) ([Vladimir C](https://github.com/vdimir)).
* Исправлен возможный сбой при входе в систему под удалённым пользователем. Исправлено [#26073](https://github.com/ClickHouse/ClickHouse/issues/26073). [#26363](https://github.com/ClickHouse/ClickHouse/pull/26363) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена работа настройки `optimize_distributed_group_by_sharding_key` для случаев с несколькими столбцами (она приводила к некорректному результату при `optimize_skip_unused_shards=1`/`allow_nondeterministic_optimize_skip_unused_shards=1` и нескольких столбцах в выражении ключа шардирования). [#26353](https://github.com/ClickHouse/ClickHouse/pull/26353) ([Azat Khuzhin](https://github.com/azat)).
* `CAST` из `Date` в `DateTime` (или `DateTime64`) не учитывал часовой пояс типа `DateTime`. Это также могло влиять на сравнения между `Date` и `DateTime`. Определение общего типа для `Date` и `DateTime` также не использовало соответствующий часовой пояс. Это влияло на результаты функции `if` и построения массивов. Закрывает [#24128](https://github.com/ClickHouse/ClickHouse/issues/24128). [#24129](https://github.com/ClickHouse/ClickHouse/pull/24129) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена редкая ошибка в процессе восстановления потерянной реплики, которая могла приводить к расхождению реплик. [#26321](https://github.com/ClickHouse/ClickHouse/pull/26321) ([tavplubix](https://github.com/tavplubix)).
* Исправлена декомпрессия zstd в случае, если в конце внутреннего буфера имеются escape-последовательности. Закрывает [#26013](https://github.com/ClickHouse/ClickHouse/issues/26013). [#26314](https://github.com/ClickHouse/ClickHouse/pull/26314) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена логическая ошибка при JOIN с totals, закрыт [#26017](https://github.com/ClickHouse/ClickHouse/issues/26017). [#26250](https://github.com/ClickHouse/ClickHouse/pull/26250) ([Vladimir C](https://github.com/vdimir)).
* Удалён лишний перевод строки в столбце `thread_name` таблицы `system.stack_trace`. Исправлена проблема [#24124](https://github.com/ClickHouse/ClickHouse/issues/24124). [#26210](https://github.com/ClickHouse/ClickHouse/pull/26210) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена работа `joinGet` со столбцами `LowCardinality`, закрыта задача [#25993](https://github.com/ClickHouse/ClickHouse/issues/25993). [#26118](https://github.com/ClickHouse/ClickHouse/pull/26118) ([Vladimir C](https://github.com/vdimir)).
* Исправлен возможный краш функции `pointInPolygon`, если настройка `validate_polygons` выключена. [#26113](https://github.com/ClickHouse/ClickHouse/pull/26113) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено возникновение исключения при попытке итерации по несуществующему удалённому каталогу. [#26087](https://github.com/ClickHouse/ClickHouse/pull/26087) ([ianton-ru](https://github.com/ianton-ru)).
* Исправлен редкий аварийный сбой сервера из-за вызова `abort` в клиенте ZooKeeper. Исправляет [#25813](https://github.com/ClickHouse/ClickHouse/issues/25813). [#26079](https://github.com/ClickHouse/ClickHouse/pull/26079) ([alesapin](https://github.com/alesapin)).
* Исправлена неверная оценка количества потоков для соединения (JOIN) с правым подзапросом в некоторых случаях. Закрывает [#24075](https://github.com/ClickHouse/ClickHouse/issues/24075). [#26052](https://github.com/ClickHouse/ClickHouse/pull/26052) ([Vladimir C](https://github.com/vdimir)).
* Исправлен некорректный `sequence_id` в пакетах протокола MySQL, которые ClickHouse отправляет при возникновении исключения во время выполнения запроса. Это могло приводить к тому, что клиент MySQL сбрасывал соединение с сервером ClickHouse. Исправляет [#21184](https://github.com/ClickHouse/ClickHouse/issues/21184). [#26051](https://github.com/ClickHouse/ClickHouse/pull/26051) ([tavplubix](https://github.com/tavplubix)).
* Исправлена возможная проблема несоответствия заголовка при использовании обычной проекции с `PREWHERE`. Исправлено [#26020](https://github.com/ClickHouse/ClickHouse/issues/26020). [#26038](https://github.com/ClickHouse/ClickHouse/pull/26038) ([Amos Bird](https://github.com/amosbird)).
* Исправлено форматирование типа `Map` с целочисленными ключами при выводе в `JSON`. [#25982](https://github.com/ClickHouse/ClickHouse/pull/25982) ([Anton Popov](https://github.com/CurtizJ)).
* Устранена возможная взаимная блокировка при раскрутке стека профилировщика запросов. Исправление [#25968](https://github.com/ClickHouse/ClickHouse/issues/25968). [#25970](https://github.com/ClickHouse/ClickHouse/pull/25970) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлен сбой при вызове функции `dictGet()` с некорректными аргументами. [#25913](https://github.com/ClickHouse/ClickHouse/pull/25913) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена аутентификация с помощью `scram-sha-256` для движков PostgreSQL. Закрывает [#24516](https://github.com/ClickHouse/ClickHouse/issues/24516). [#25906](https://github.com/ClickHouse/ClickHouse/pull/25906) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено чрезмерно большое время ожидания (backoff) для фоновых задач при заполненном фоновом пуле. Исправляет [#25836](https://github.com/ClickHouse/ClickHouse/issues/25836). [#25893](https://github.com/ClickHouse/ClickHouse/pull/25893) ([alesapin](https://github.com/alesapin)).
* Исправлена обработка исключений на ARM при размере страницы, отличном от значения по умолчанию. Исправляет [#25512](https://github.com/ClickHouse/ClickHouse/issues/25512), [#25044](https://github.com/ClickHouse/ClickHouse/issues/25044), [#24901](https://github.com/ClickHouse/ClickHouse/issues/24901), [#23183](https://github.com/ClickHouse/ClickHouse/issues/23183), [#20221](https://github.com/ClickHouse/ClickHouse/issues/20221), [#19703](https://github.com/ClickHouse/ClickHouse/issues/19703), [#19028](https://github.com/ClickHouse/ClickHouse/issues/19028), [#18391](https://github.com/ClickHouse/ClickHouse/issues/18391), [#18121](https://github.com/ClickHouse/ClickHouse/issues/18121), [#17994](https://github.com/ClickHouse/ClickHouse/issues/17994), [#12483](https://github.com/ClickHouse/ClickHouse/issues/12483). [#25854](https://github.com/ClickHouse/ClickHouse/pull/25854) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена обработка `sharding_key`, заданного столбцом без функции, для `remote()` (раньше `select * from remote('127.1', system.one, dummy)` приводил к ошибке `Unknown column: dummy, there are only columns .`). [#25824](https://github.com/ClickHouse/ClickHouse/pull/25824) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены ошибки `Not found column ...` и `Missing column ...` при выборке из `MaterializeMySQL`. Исправлены [#23708](https://github.com/ClickHouse/ClickHouse/issues/23708), [#24830](https://github.com/ClickHouse/ClickHouse/issues/24830), [#25794](https://github.com/ClickHouse/ClickHouse/issues/25794). [#25822](https://github.com/ClickHouse/ClickHouse/pull/25822) ([tavplubix](https://github.com/tavplubix)).
* Исправлена работа `optimize_skip_unused_shards_rewrite_in` для типов, отличных от UInt64, что могло приводить к выбору неверных шардов или генерации исключений `Cannot infer type of an empty tuple` или `Function tuple requires at least one argument`. [#25798](https://github.com/ClickHouse/ClickHouse/pull/25798) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена редкая ошибка в запросе `DROP PART` для таблиц `ReplicatedMergeTree`, которая могла приводить к ошибке `Unexpected merged part intersecting drop range`. [#25783](https://github.com/ClickHouse/ClickHouse/pull/25783) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка в `TTL` с выражением `GROUP BY`, из-за которой `TTL` отказывался выполняться после первого выполнения в части. [#25743](https://github.com/ClickHouse/ClickHouse/pull/25743) ([alesapin](https://github.com/alesapin)).
* Разрешить движку StorageMerge доступ к таблицам с псевдонимами. Закрывает [#6051](https://github.com/ClickHouse/ClickHouse/issues/6051). [#25694](https://github.com/ClickHouse/ClickHouse/pull/25694) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена медленная работа dict join в некоторых случаях, закрыт [#24209](https://github.com/ClickHouse/ClickHouse/issues/24209). [#25618](https://github.com/ClickHouse/ClickHouse/pull/25618) ([Vladimir C](https://github.com/vdimir)).
* Исправлена работа `ALTER MODIFY COLUMN` для столбцов, участвующих в TTL-выражениях. [#25554](https://github.com/ClickHouse/ClickHouse/pull/25554) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка assert в `PREWHERE` для типа, отличного от `UInt8`, закрыта задача [#19589](https://github.com/ClickHouse/ClickHouse/issues/19589). [#25484](https://github.com/ClickHouse/ClickHouse/pull/25484) ([Vladimir C](https://github.com/vdimir)).
* Исправлено одно из падений под msan, выявленных фаззингом. Исправляет [#22517](https://github.com/ClickHouse/ClickHouse/issues/22517). [#26428](https://github.com/ClickHouse/ClickHouse/pull/26428) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Обновлена проверка выполнения команды `chown` во входной точке Docker-контейнера `clickhouse-server`. Это исправляет ошибку «cluster pod restart failed (or timeout)» в Kubernetes. [#26545](https://github.com/ClickHouse/ClickHouse/pull/26545) ([Ky Li](https://github.com/Kylinrix)).

### Релиз ClickHouse v21.7, 2021-07-09 {#clickhouse-release-v217-2021-07-09}

#### Обратно несовместимые изменения {#backward-incompatible-change-4}

- Улучшена производительность запросов с явно определёнными большими множествами. Добавлена настройка совместимости `legacy_column_name_of_tuple_literal`. Рекомендуется установить её в `true` при выполнении последовательного обновления кластера с версии ниже 21.7 до любой более поздней версии. В противном случае распределённые запросы с явно определёнными множествами в условии `IN` могут завершаться с ошибкой во время обновления. [#25371](https://github.com/ClickHouse/ClickHouse/pull/25371) ([Anton Popov](https://github.com/CurtizJ)).
- Прямое и обратное несовместимое изменение максимального размера буфера в clickhouse-keeper (экспериментальная альтернатива ZooKeeper). Лучше внести это изменение сейчас (до промышленной эксплуатации), чем позже. [#25421](https://github.com/ClickHouse/ClickHouse/pull/25421) ([alesapin](https://github.com/alesapin)).

#### Новая функциональность {#new-feature-4}


- Поддержка конфигурации в формате YAML в качестве альтернативы XML. Закрывает [#3607](https://github.com/ClickHouse/ClickHouse/issues/3607). [#21858](https://github.com/ClickHouse/ClickHouse/pull/21858) ([BoloniniD](https://github.com/BoloniniD)).
- Предоставляет способ восстановления реплицируемой таблицы, когда данные (возможно) присутствуют, но метаданные ZooKeeper утеряны. Решает [#13458](https://github.com/ClickHouse/ClickHouse/issues/13458). [#13652](https://github.com/ClickHouse/ClickHouse/pull/13652) ([Mike Kot](https://github.com/myrrc)).
- Поддержка структур и карт в форматах Arrow/Parquet/ORC и словарей в форматах ввода/вывода Arrow. Представлена новая настройка `output_format_arrow_low_cardinality_as_dictionary`. [#24341](https://github.com/ClickHouse/ClickHouse/pull/24341) ([Kruglov Pavel](https://github.com/Avogar)).
- Добавлена поддержка типа `Array` в словарях. [#25119](https://github.com/ClickHouse/ClickHouse/pull/25119) ([Maksim Kita](https://github.com/kitaisreal)).
- Добавлена функция `bitPositionsToArray`. Закрывает [#23792](https://github.com/ClickHouse/ClickHouse/issues/23792). Автор [Kevin Wan] (@MaxWk). [#25394](https://github.com/ClickHouse/ClickHouse/pull/25394) ([Maksim Kita](https://github.com/kitaisreal)).
- Добавлена функция `dateName` для возврата названий, таких как «Friday» или «April». Автор [Daniil Kondratyev] (@dankondr). [#25372](https://github.com/ClickHouse/ClickHouse/pull/25372) ([Maksim Kita](https://github.com/kitaisreal)).
- Добавлена функция `toJSONString` для сериализации столбцов в их JSON-представления. [#25164](https://github.com/ClickHouse/ClickHouse/pull/25164) ([Amos Bird](https://github.com/amosbird)).
- Теперь `query_log` имеет два новых столбца: `initial_query_start_time`, `initial_query_start_time_microsecond`, которые записывают время начала распределённого запроса, если таковой имеется. [#25022](https://github.com/ClickHouse/ClickHouse/pull/25022) ([Amos Bird](https://github.com/amosbird)).
- Добавлена агрегатная функция `segmentLengthSum`. [#24250](https://github.com/ClickHouse/ClickHouse/pull/24250) ([flynn](https://github.com/ucasfl)).
- Добавлена новая булева настройка `prefer_global_in_and_join`, которая по умолчанию делает все IN/JOIN глобальными GLOBAL IN/JOIN. [#23434](https://github.com/ClickHouse/ClickHouse/pull/23434) ([Amos Bird](https://github.com/amosbird)).
- Поддержка запросов `ALTER DELETE` для движка таблиц `Join`. [#23260](https://github.com/ClickHouse/ClickHouse/pull/23260) ([foolchi](https://github.com/foolchi)).
- Добавлена агрегатная функция `quantileBFloat16`, а также соответствующие `quantilesBFloat16` и `medianBFloat16`. Это очень простой и быстрый оценщик квантилей с относительной погрешностью не более 0,390625%. Закрывает [#16641](https://github.com/ClickHouse/ClickHouse/issues/16641). [#23204](https://github.com/ClickHouse/ClickHouse/pull/23204) ([Ivan Novitskiy](https://github.com/RedClusive)).
- Реализована функция `sequenceNextNode()`, полезная для анализа потоков. [#19766](https://github.com/ClickHouse/ClickHouse/pull/19766) ([achimbab](https://github.com/achimbab)).

#### Экспериментальная функциональность {#experimental-feature-4}

- Добавлена поддержка виртуальной файловой системы поверх HDFS. [#11058](https://github.com/ClickHouse/ClickHouse/pull/11058) ([overshov](https://github.com/overshov)) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Теперь clickhouse-keeper (экспериментальная альтернатива ZooKeeper) поддерживает ACL типа `digest`, аналогичные ZooKeeper. [#24448](https://github.com/ClickHouse/ClickHouse/pull/24448) ([alesapin](https://github.com/alesapin)).

#### Улучшение производительности {#performance-improvement-4}


- Добавлена оптимизация, которая преобразует некоторые функции в чтение подстолбцов для уменьшения объёма считываемых данных. Например, выражение `col IS NULL` преобразуется в чтение подстолбца `col.null`. Оптимизацию можно включить с помощью настройки `optimize_functions_to_subcolumns`, которая в настоящее время по умолчанию отключена. [#24406](https://github.com/ClickHouse/ClickHouse/pull/24406) ([Anton Popov](https://github.com/CurtizJ)).
- Переписано больше столбцов в возможные выражения-псевдонимы. Это может обеспечить более эффективную оптимизацию, например, проекции. [#24405](https://github.com/ClickHouse/ClickHouse/pull/24405) ([Amos Bird](https://github.com/amosbird)).
- Индекс типа `bloom_filter` теперь может использоваться для выражений с функцией `hasAny` с константными массивами. Закрывает: [#24291](https://github.com/ClickHouse/ClickHouse/issues/24291). [#24900](https://github.com/ClickHouse/ClickHouse/pull/24900) ([Vasily Nemkov](https://github.com/Enmk)).
- Добавлена экспоненциальная задержка для переноса попытки чтения в случае, если очереди RabbitMQ пусты. (ClickHouse поддерживает импорт данных из RabbitMQ). Закрывает [#24340](https://github.com/ClickHouse/ClickHouse/issues/24340). [#24415](https://github.com/ClickHouse/ClickHouse/pull/24415) ([Kseniia Sumarokova](https://github.com/kssenii)).

#### Улучшение {#improvement-4}


* Позволяет ограничивать пропускную способность для репликации. Добавлены две настройки Replicated*MergeTree: `max_replicated_fetches_network_bandwidth` и `max_replicated_sends_network_bandwidth`, которые позволяют ограничивать максимальную скорость выборок/отправок данных при репликации для таблицы. Добавлены две настройки на уровне сервера (в профиле пользователя `default`): `max_replicated_fetches_network_bandwidth_for_server` и `max_replicated_sends_network_bandwidth_for_server`, которые ограничивают максимальную скорость репликации для всех таблиц. Настройки не обеспечивают идеальной точности ограничения. По умолчанию отключены. Исправляет [#1821](https://github.com/ClickHouse/ClickHouse/issues/1821). [#24573](https://github.com/ClickHouse/ClickHouse/pull/24573) ([alesapin](https://github.com/alesapin)).
* Ограничение ресурсов и изоляция для мостов ODBC и Library. Используйте отдельные группу и пользователя `clickhouse-bridge` для процессов мостов. Установите `oom_score_adj`, чтобы мосты были первыми кандидатами на завершение OOM killer’ом. Установите максимальный размер RSS в 1 ГиБ. Закрывает [#23861](https://github.com/ClickHouse/ClickHouse/issues/23861). [#25280](https://github.com/ClickHouse/ClickHouse/pull/25280) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена отдельная символическая ссылка `clickhouse-keeper` на основной исполняемый файл `clickhouse`. Теперь можно запускать сервис координации без основного сервера ClickHouse. [#24059](https://github.com/ClickHouse/ClickHouse/pull/24059) ([alesapin](https://github.com/alesapin)).
* Использование глобальных настроек для запросов к `VIEW`. Исправлено поведение, при котором запросы к `VIEW` использовали локальные настройки, что приводило к ошибкам, если настройки при `CREATE VIEW` и `SELECT` отличались. Теперь `VIEW` не будет использовать эти изменённые настройки, но вы по-прежнему можете передавать дополнительные настройки в секции `SETTINGS` запроса `CREATE VIEW`. Закрывает [#20551](https://github.com/ClickHouse/ClickHouse/issues/20551). [#24095](https://github.com/ClickHouse/ClickHouse/pull/24095) ([Vladimir](https://github.com/vdimir)).
* При запуске сервера части с некорректным идентификатором партиции не будут удаляться, а всегда только отсоединяться. [#25070](https://github.com/ClickHouse/ClickHouse/issues/25070). [#25166](https://github.com/ClickHouse/ClickHouse/pull/25166) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Увеличен размер пула фонового планировщика до 128 (настройка `background_schedule_pool_size`). Это позволяет избежать подвисания очереди репликации при медленном соединении с ZooKeeper. [#25072](https://github.com/ClickHouse/ClickHouse/pull/25072) ([alesapin](https://github.com/alesapin)).
* Добавлена настройка MergeTree `max_parts_to_merge_at_once`, которая ограничивает количество частей, которые могут одновременно сливаться в фоновом режиме. Не влияет на запрос `OPTIMIZE FINAL`. Исправляет [#1820](https://github.com/ClickHouse/ClickHouse/issues/1820). [#24496](https://github.com/ClickHouse/ClickHouse/pull/24496) ([alesapin](https://github.com/alesapin)).
* Разрешено использовать оператор `NOT IN` для отсечения партиций. [#24894](https://github.com/ClickHouse/ClickHouse/pull/24894) ([Amos Bird](https://github.com/amosbird)).
* Распознавать IPv4‑адреса вида `127.0.1.1` как локальные. Это спорное изменение, которое закрывает задачу [#23504](https://github.com/ClickHouse/ClickHouse/issues/23504). Michael Filimonov протестирует эту возможность. [#24316](https://github.com/ClickHouse/ClickHouse/pull/24316) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* База данных ClickHouse, созданная с использованием MaterializeMySQL (это экспериментальная возможность), теперь содержит все комментарии к столбцам из материализованной базы данных MySQL. [#25199](https://github.com/ClickHouse/ClickHouse/pull/25199) ([Storozhuk Kostiantyn](https://github.com/sand6255)).
* Добавлены настройки (`connection_auto_close`/`connection_max_tries`/`connection_pool_size`) для движка MySQL. [#24146](https://github.com/ClickHouse/ClickHouse/pull/24146) ([Azat Khuzhin](https://github.com/azat)).
* Сокращено время запуска движка Distributed. [#25663](https://github.com/ClickHouse/ClickHouse/pull/25663) ([Azat Khuzhin](https://github.com/azat)).
* Улучшение для Distributed-таблиц. Реплики больше не включаются в `dirname` при `internal_replication=true` (это позволяет выполнять `INSERT` в Distributed-таблицу с кластером с любым количеством реплик; ранее поддерживалось только 15 реплик, при большем количестве возникала ошибка ENAMETOOLONG при создании директории для асинхронных блоков). [#25513](https://github.com/ClickHouse/ClickHouse/pull/25513) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка типа `Interval` для `LowCardinality`. Это необходимо для промежуточных значений некоторых выражений. Закрывает [#21730](https://github.com/ClickHouse/ClickHouse/issues/21730). [#25410](https://github.com/ClickHouse/ClickHouse/pull/25410) ([Vladimir](https://github.com/vdimir)).
* Добавлен оператор сравнения `==` во временных условиях для функций `sequenceMatch` и `sequenceCount`. Например: sequenceMatch(&#39;(?1)(?t==1)(?2)&#39;)(time, data = 1, data = 2). [#25299](https://github.com/ClickHouse/ClickHouse/pull/25299) ([Christophe Kalenzaga](https://github.com/mga-chka)).
* Добавлены настройки `http_max_fields`, `http_max_field_name_size`, `http_max_field_value_size`. [#25296](https://github.com/ClickHouse/ClickHouse/pull/25296) ([Ivan](https://github.com/abyss7)).
* Добавлена поддержка функции `if` с типами `Decimal` и `Int` в её ветвях. Закрывает [#20549](https://github.com/ClickHouse/ClickHouse/issues/20549). Закрывает [#10142](https://github.com/ClickHouse/ClickHouse/issues/10142). [#25283](https://github.com/ClickHouse/ClickHouse/pull/25283) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Обновлено приглашение в `clickhouse-client` и добавлен вывод сообщения при переподключении. Это закрывает [#10577](https://github.com/ClickHouse/ClickHouse/issues/10577). [#25281](https://github.com/ClickHouse/ClickHouse/pull/25281) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено отслеживание использования памяти в агрегатной функции `topK`. Это закрывает [#25259](https://github.com/ClickHouse/ClickHouse/issues/25259). [#25260](https://github.com/ClickHouse/ClickHouse/pull/25260) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена функция `topLevelDomain` для IDN-хостов (например, `example.рф`), ранее для таких хостов она возвращала пустую строку. [#25103](https://github.com/ClickHouse/ClickHouse/pull/25103) ([Azat Khuzhin](https://github.com/azat)).
* Определение версии ядра Linux во время выполнения (для работы вложенного epoll, который требуется для `async_socket_for_remote`/`use_hedged_requests`, иначе удалённые запросы могут зависать). [#25067](https://github.com/ClickHouse/ClickHouse/pull/25067) ([Azat Khuzhin](https://github.com/azat)).
* Для распределённого запроса при `optimize_skip_unused_shards=1` добавлена возможность пропускать шарды при условии вида `(sharding key) IN (one-element-tuple)`. (Кортежи с несколькими элементами уже поддерживались. Кортеж с одним элементом не работал, так как он разбирается как литерал). [#24930](https://github.com/ClickHouse/ClickHouse/pull/24930) ([Amos Bird](https://github.com/amosbird)).
* Улучшены сообщения в журнале об ошибках S3, больше нет двойных пробелов при пустых ключах и бакетах. [#24897](https://github.com/ClickHouse/ClickHouse/pull/24897) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Некоторые запросы требуют многошагового семантического анализа. В таком случае попробуйте повторно использовать уже построенные множества для `IN`. [#24874](https://github.com/ClickHouse/ClickHouse/pull/24874) ([Amos Bird](https://github.com/amosbird)).
* Учитывать `max_distributed_connections` для `insert_distributed_sync` (в противном случае на очень больших кластерах при синхронной вставке может быть превышен лимит `max_thread_pool_size`). [#24754](https://github.com/ClickHouse/ClickHouse/pull/24754) ([Azat Khuzhin](https://github.com/azat)).
* Не скрывайте ошибки, такие как `Limit for rows or bytes to read exceeded`, при выполнении скалярных подзапросов. [#24545](https://github.com/ClickHouse/ClickHouse/pull/24545) ([nvartolomei](https://github.com/nvartolomei)).
* Ужесточён парсер String-to-Int, чтобы `toInt64('+')` выбрасывал исключение. [#24475](https://github.com/ClickHouse/ClickHouse/pull/24475) ([Amos Bird](https://github.com/amosbird)).
* Если `SSD_CACHE` создаётся с помощью DDL-запроса, его можно создать только внутри директории `user_files`. [#24466](https://github.com/ClickHouse/ClickHouse/pull/24466) ([Maksim Kita](https://github.com/kitaisreal)).
* Поддержка синтаксиса PostgreSQL для указания схемы, отличной от схемы по умолчанию, в запросах `INSERT`. Закрывает [#24149](https://github.com/ClickHouse/ClickHouse/issues/24149). [#24413](https://github.com/ClickHouse/ClickHouse/pull/24413) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено разрешение IPv6-адресов (например, теперь корректно работает запрос `select * from remote('[::1]', system.one)`). [#24319](https://github.com/ClickHouse/ClickHouse/pull/24319) ([Azat Khuzhin](https://github.com/azat)).
* Исправляет пробелы в конце строк в предложении FROM с подзапросами в многострочном режиме, а также немного изменяет вывод результатов запросов, делая его более удобным для чтения. [#24151](https://github.com/ClickHouse/ClickHouse/pull/24151) ([Azat Khuzhin](https://github.com/azat)).
* Улучшение для распределённых таблиц. Добавлена возможность разбивать пакет при ошибках (например, из‑за ограничений по памяти или повреждённых данных) с помощью настройки `distributed_directory_monitor_split_batch_on_failure` (по умолчанию выключена). [#23864](https://github.com/ClickHouse/ClickHouse/pull/23864) ([Azat Khuzhin](https://github.com/azat)).
* Реализована обработка конфликтов имён столбцов для движка таблиц `Join`. Закрывает [#20309](https://github.com/ClickHouse/ClickHouse/issues/20309). [#23769](https://github.com/ClickHouse/ClickHouse/pull/23769) ([Vladimir](https://github.com/vdimir)).
* Показ прогресса для движка таблицы `File` в `clickhouse-local` и при выполнении запроса INSERT в `clickhouse-client`, когда данные передаются через стандартный ввод (stdin). Закрывает [#18209](https://github.com/ClickHouse/ClickHouse/issues/18209). [#23656](https://github.com/ClickHouse/ClickHouse/pull/23656) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправления ошибок и улучшения `clickhouse-copier`. Разрешено копирование таблиц с разными (но совместимыми) схемами. Закрывает [#9159](https://github.com/ClickHouse/ClickHouse/issues/9159). Добавлен тест для копирования ReplacingMergeTree. Закрывает [#22711](https://github.com/ClickHouse/ClickHouse/issues/22711). Поддержка TTL для столбцов и индексов пропуска данных (Data Skipping Indices). TTL и индексы пропуска данных просто удаляются при создании внутренней таблицы типа Distributed (базовая таблица при этом будет иметь TTL и индексы пропуска). Закрывает [#19384](https://github.com/ClickHouse/ClickHouse/issues/19384). Разрешено копирование столбцов MATERIALIZED и ALIAS. В некоторых случаях это может быть полезно (например, если этот столбец входит в PRIMARY KEY). Теперь это можно включить, установив свойство `allow_to_copy_alias_and_materialized_columns` в значение true в конфигурации задания. Закрывает [#9177](https://github.com/ClickHouse/ClickHouse/issues/9177). Закрывает [#11007] ([https://github.com/ClickHouse/ClickHouse/issues/11007](https://github.com/ClickHouse/ClickHouse/issues/11007)). Закрывает [#9514](https://github.com/ClickHouse/ClickHouse/issues/9514). Добавлено свойство `allow_to_drop_target_partitions` в конфигурации задания для удаления раздела в исходной таблице перед перемещением вспомогательных таблиц. Закрывает [#20957](https://github.com/ClickHouse/ClickHouse/issues/20957). Удалён запрос `OPTIMIZE DEDUPLICATE`. Этот хак был нужен, потому что `ALTER TABLE MOVE PARTITION` выполнялся многократно, а обычные таблицы MergeTree не поддерживают дедупликацию. Закрывает [#17966](https://github.com/ClickHouse/ClickHouse/issues/17966). Прогресс записывается в узел ZooKeeper по пути `task_path + /status` в формате JSON. Закрывает [#20955](https://github.com/ClickHouse/ClickHouse/issues/20955). Поддержка ReplicatedTables без аргументов. Закрывает [#24834](https://github.com/ClickHouse/ClickHouse/issues/24834) .[#23518](https://github.com/ClickHouse/ClickHouse/pull/23518) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлена пауза (sleep) с экспоненциальной задержкой между повторными попытками чтения из S3. [#23461](https://github.com/ClickHouse/ClickHouse/pull/23461) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Учитывать настройку `insert_allow_materialized_columns` (разрешает использование материализованных столбцов) при выполнении INSERT в таблицу `Distributed`. [#23349](https://github.com/ClickHouse/ClickHouse/pull/23349) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка проталкивания LIMIT для распределённых запросов. [#23027](https://github.com/ClickHouse/ClickHouse/pull/23027) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена zero-copy репликация при использовании нескольких томов S3 (исправляет [#22679](https://github.com/ClickHouse/ClickHouse/issues/22679)). [#22864](https://github.com/ClickHouse/ClickHouse/pull/22864) ([ianton-ru](https://github.com/ianton-ru)).
* Определять фактический номер порта, к которому выполнена привязка, когда пользователь запрашивает у операционной системы любой доступный порт, и выводить его в сообщении журнала. [#25569](https://github.com/ClickHouse/ClickHouse/pull/25569) ([bnaecker](https://github.com/bnaecker)).
* Исправлена ситуация, когда при преобразовании массивов Postgres иногда получался тип данных String вместо n-мерного массива, из‑за того что `attndims` в некоторых случаях работает некорректно. Закрывает [#24804](https://github.com/ClickHouse/ClickHouse/issues/24804). [#25538](https://github.com/ClickHouse/ClickHouse/pull/25538) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено преобразование `DateTime` с часовым поясом для MySQL, PostgreSQL и ODBC. Закрывает [#5057](https://github.com/ClickHouse/ClickHouse/issues/5057). [#25528](https://github.com/ClickHouse/ClickHouse/pull/25528) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Различать KILL MUTATION для разных таблиц (исправляет неожиданную ошибку `Cancelled mutating parts`). [#25025](https://github.com/ClickHouse/ClickHouse/pull/25025) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена возможность объявлять диск S3 в корне бакета (виртуальная файловая система S3 — экспериментальная функция, находящаяся в разработке). [#24898](https://github.com/ClickHouse/ClickHouse/pull/24898) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Добавлена возможность чтения подколонок (например, компонентов `Tuple`) в распределённых таблицах. [#24472](https://github.com/ClickHouse/ClickHouse/pull/24472) ([Anton Popov](https://github.com/CurtizJ)).
* Новая возможность для протокола совместимости с MySQL: функция `user` теперь возвращает корректный результат. Закрывает [#25697](https://github.com/ClickHouse/ClickHouse/pull/25697). [#25697](https://github.com/ClickHouse/ClickHouse/pull/25697) ([sundyli](https://github.com/sundy-li)).

#### Исправление ошибок {#bug-fix-3}


* Улучшена обратная совместимость: используется старая версия функции вычисления остатка от деления при использовании в ключе партиционирования. Закрывает [#23508](https://github.com/ClickHouse/ClickHouse/issues/23508). [#24157](https://github.com/ClickHouse/ClickHouse/pull/24157) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена крайне редкая ошибка на серверах с небольшим объемом памяти, которая могла приводить к невозможности выполнения слияний без перезапуска. Возможно, исправляет [#24603](https://github.com/ClickHouse/ClickHouse/issues/24603). [#24872](https://github.com/ClickHouse/ClickHouse/pull/24872) ([alesapin](https://github.com/alesapin)).
* Исправлена крайне редкая ошибка `Tagging already tagged part` в очереди репликации при одновременном выполнении `alter move/replace partition`. Возможно, она также устраняет проблему из [#22142](https://github.com/ClickHouse/ClickHouse/issues/22142). [#24961](https://github.com/ClickHouse/ClickHouse/pull/24961) ([alesapin](https://github.com/alesapin)).
* Исправлен потенциальный сбой при вычислении состояний агрегатных функций путём агрегации состояний агрегатных функций других агрегатных функций (непрактичный сценарий использования). См. [#24523](https://github.com/ClickHouse/ClickHouse/issues/24523). [#25015](https://github.com/ClickHouse/ClickHouse/pull/25015) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено поведение в случае, если запрос `SYSTEM RESTART REPLICA` или `SYSTEM SYNC REPLICA` не завершался. Это было обнаружено на сервере с крайне малым объёмом оперативной памяти. [#24457](https://github.com/ClickHouse/ClickHouse/pull/24457) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена ошибка, которая могла приводить к зависанию клиента ZooKeeper в clickhouse-server. [#24721](https://github.com/ClickHouse/ClickHouse/pull/24721) ([alesapin](https://github.com/alesapin)).
* Если соединение с ZooKeeper было потеряно, а реплика была клонирована после восстановления соединения, её очередь репликации могла содержать устаревшие записи. Исправлено падение по assert при наличии в очереди репликации пересекающихся виртуальных партов. Это может изредка происходить, если какая-то часть данных была потеряна. Теперь вместо завершения работы ошибка выводится в лог. [#24777](https://github.com/ClickHouse/ClickHouse/pull/24777) ([tavplubix](https://github.com/tavplubix)).
* Исправлена потеря условия `WHERE` в оптимизации планов запросов expression-push-down (по умолчанию установлено `query_plan_filter_push_down = 1`). Исправляет [#25368](https://github.com/ClickHouse/ClickHouse/issues/25368). [#25370](https://github.com/ClickHouse/ClickHouse/pull/25370) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, которая могла приводить к пересекающимся частям после слияний с TTL: `Part all_40_40_0 is covered by all_40_40_1 but should be merged into all_40_41_1. This shouldn't happen often.`. [#25549](https://github.com/ClickHouse/ClickHouse/pull/25549) ([alesapin](https://github.com/alesapin)).
* При потере соединения с ZooKeeper таблица `ReplicatedMergeTree` могла ожидать завершения фоновых операций перед попыткой переподключения. Это исправлено, теперь фоновые операции принудительно останавливаются. [#25306](https://github.com/ClickHouse/ClickHouse/pull/25306) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка `Key expression contains comparison between inconvertible types` для запросов с `ARRAY JOIN` в случае использования массива в первичном ключе. Устраняет [#8247](https://github.com/ClickHouse/ClickHouse/issues/8247). [#25546](https://github.com/ClickHouse/ClickHouse/pull/25546) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены некорректные итоги в запросах `WITH TOTALS` и `WITH FILL`. Исправляет [#20872](https://github.com/ClickHouse/ClickHouse/issues/20872). [#25539](https://github.com/ClickHouse/ClickHouse/pull/25539) ([Anton Popov](https://github.com/CurtizJ)).
* Устранена гонка данных при запросах к `system.clusters` во время перезагрузки конфигурации кластера. [#25737](https://github.com/ClickHouse/ClickHouse/pull/25737) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка `No such file or directory`, возникавшая при перемещении таблицы `Distributed` между базами данных. Исправлено [#24971](https://github.com/ClickHouse/ClickHouse/issues/24971). [#25667](https://github.com/ClickHouse/ClickHouse/pull/25667) ([tavplubix](https://github.com/tavplubix)).
* В редких случаях `REPLACE PARTITION` мог игнорироваться, если исходный раздел был пустым. Исправлено. Исправляет [#24869](https://github.com/ClickHouse/ClickHouse/issues/24869). [#25665](https://github.com/ClickHouse/ClickHouse/pull/25665) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка в движке базы данных `Replicated`, которая в редких случаях могла приводить к тому, что реплика пропускала поставленный в очередь DDL-запрос. [#24805](https://github.com/ClickHouse/ClickHouse/pull/24805) ([tavplubix](https://github.com/tavplubix)).
* Исправлено разыменование нулевого указателя в `EXPLAIN AST` без запроса. [#25631](https://github.com/ClickHouse/ClickHouse/pull/25631) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено ожидание автоматического удаления пустых частей. Это могло приводить к полному заполнению фонового пула и зависанию репликации. [#23315](https://github.com/ClickHouse/ClickHouse/pull/23315) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено восстановление таблицы, размещённой в виртуальной файловой системе S3 (экспериментальная функция, не готова к использованию в продакшене). [#25601](https://github.com/ClickHouse/ClickHouse/pull/25601) ([ianton-ru](https://github.com/ianton-ru)).
* Исправлена ошибка разыменования указателя `nullptr` в формате `Arrow` при использовании `Decimal256`. Добавлена поддержка `Decimal256` для формата `Arrow`. [#25531](https://github.com/ClickHouse/ClickHouse/pull/25531) ([Kruglov Pavel](https://github.com/Avogar)).
* Устранён лишний символ подчёркивания в именах предварительно обработанных файлов конфигурации. [#25431](https://github.com/ClickHouse/ClickHouse/pull/25431) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправление для инструмента `clickhouse-copier`: устранена ошибка сегментации при отсутствии `sharding_key` в конфигурации задачи копировщика. [#25419](https://github.com/ClickHouse/ClickHouse/pull/25419) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена работа трансформера столбцов `REPLACE` при использовании в DDL за счёт корректного заключения форматированного запроса в кавычки. Это исправляет [#23925](https://github.com/ClickHouse/ClickHouse/issues/23925). [#25391](https://github.com/ClickHouse/ClickHouse/pull/25391) ([Amos Bird](https://github.com/amosbird)).
* Устранена возможность недетерминированного поведения функции `quantileDeterministic` и аналогичных. Это закрывает [#20480](https://github.com/ClickHouse/ClickHouse/issues/20480). [#25313](https://github.com/ClickHouse/ClickHouse/pull/25313) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка `SimpleAggregateFunction(LowCardinality)` в `SummingMergeTree`. Исправляет [#25134](https://github.com/ClickHouse/ClickHouse/issues/25134). [#25300](https://github.com/ClickHouse/ClickHouse/pull/25300) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена логическая ошибка, приводившая к сообщению исключения &quot;Cannot sum Array/Tuple in min/maxMap&quot;. [#25298](https://github.com/ClickHouse/ClickHouse/pull/25298) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка `Bad cast from type DB::ColumnLowCardinality to DB::ColumnVector<char8_t>` для запросов, в которых аргумент `LowCardinality` использовался в операторе IN (эта ошибка появилась в 21.6). Исправляет [#25187](https://github.com/ClickHouse/ClickHouse/issues/25187). [#25290](https://github.com/ClickHouse/ClickHouse/pull/25290) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено некорректное поведение `joinGetOrNull` со столбцами, не допускающими NULL. Это исправляет [#24261](https://github.com/ClickHouse/ClickHouse/issues/24261). [#25288](https://github.com/ClickHouse/ClickHouse/pull/25288) ([Amos Bird](https://github.com/amosbird)).
* Исправлено некорректное поведение и отчёт UBSan при работе с целочисленными типами большой разрядности. В предыдущих версиях `CAST(1e19 AS UInt128)` возвращал ноль. [#25279](https://github.com/ClickHouse/ClickHouse/pull/25279) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка, возникавшая при вставке подмножества столбцов в формате CSVWithNames. Исправлено [#25129](https://github.com/ClickHouse/ClickHouse/issues/25129). [#25169](https://github.com/ClickHouse/ClickHouse/pull/25169) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Не используйте проекции таблицы в `SELECT` с `FINAL`. Это пока не поддерживается. [#25163](https://github.com/ClickHouse/ClickHouse/pull/25163) ([Amos Bird](https://github.com/amosbird)).
* Исправлена возможная потеря частей после обновления до 21.5 в случае, если в таблице в качестве ключа партиционирования использовался `UUID` (не рекомендуется использовать `UUID` в ключе партиционирования). Исправление для [#25070](https://github.com/ClickHouse/ClickHouse/issues/25070). [#25127](https://github.com/ClickHouse/ClickHouse/pull/25127) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено аварийное завершение при выполнении запроса с CROSS JOIN и `joined_subquery_requires_alias = 0`. Исправляет [#24011](https://github.com/ClickHouse/ClickHouse/issues/24011). [#25082](https://github.com/ClickHouse/ClickHouse/pull/25082) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка с константными картами в функции mapContains, приводившая к ошибке `empty column was returned by function mapContains`. Закрывает [#25077](https://github.com/ClickHouse/ClickHouse/issues/25077). [#25080](https://github.com/ClickHouse/ClickHouse/pull/25080) ([Kruglov Pavel](https://github.com/Avogar)).
* Удалена возможность создавать таблицы со столбцами, ссылающимися сами на себя, типа `a UInt32 ALIAS a + 1` или `b UInt32 MATERIALIZED b`. Исправлено [#24910](https://github.com/ClickHouse/ClickHouse/issues/24910), [#24292](https://github.com/ClickHouse/ClickHouse/issues/24292). [#25059](https://github.com/ClickHouse/ClickHouse/pull/25059) ([alesapin](https://github.com/alesapin)).
* Исправлен неверный результат при использовании агрегирующей проекции с *непустым* ключом `GROUP BY` при выполнении запроса с `GROUP BY` по *пустому* ключу. [#25055](https://github.com/ClickHouse/ClickHouse/pull/25055) ([Amos Bird](https://github.com/amosbird)).
* Исправлена сериализация разделённых вложенных сообщений в формате Protobuf. Этот PR исправляет [#24647](https://github.com/ClickHouse/ClickHouse/issues/24647). [#25000](https://github.com/ClickHouse/ClickHouse/pull/25000) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено использование параметров LIMIT/OFFSET для распределённых запросов: теперь они игнорируются на удалённых узлах. [#24940](https://github.com/ClickHouse/ClickHouse/pull/24940) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено возможное переполнение буфера кучи (heap-buffer-overflow) в формате `Arrow`. [#24922](https://github.com/ClickHouse/ClickHouse/pull/24922) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена возможная ошибка &#39;Cannot read from istream at offset 0&#39; при чтении файла с DiskS3 (виртуальная файловая система S3 является экспериментальной, находится в разработке и не должна использоваться в продакшене). [#24885](https://github.com/ClickHouse/ClickHouse/pull/24885) ([Pavel Kovalenko](https://github.com/Jokser)).
* Исправлена ошибка «Missing columns» при `JOIN` распределённого материализованного представления. [#24870](https://github.com/ClickHouse/ClickHouse/pull/24870) ([Azat Khuzhin](https://github.com/azat)).
* Разрешить значения `NULL` в протоколе совместимости с PostgreSQL. Закрывает [#22622](https://github.com/ClickHouse/ClickHouse/issues/22622). [#24857](https://github.com/ClickHouse/ClickHouse/pull/24857) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка, из-за которой исключение `Mutation was killed` могло выбрасываться клиенту при ожидании выполнения мутации, когда она ещё не была загружена в память. [#24809](https://github.com/ClickHouse/ClickHouse/pull/24809) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка в десериализации состояния генератора случайных чисел, которая могла приводить к недетерминированному поведению некоторых типов данных, например `AggregateFunction(groupArraySample(N), T))`. [#24538](https://github.com/ClickHouse/ClickHouse/pull/24538) ([tavplubix](https://github.com/tavplubix)).
* Запрещено строить uniqXXXXStates на основе других состояний агрегирования. [#24523](https://github.com/ClickHouse/ClickHouse/pull/24523) ([Raúl Marín](https://github.com/Algunenano)). Затем запрет был снят после устранения первопричины связанной проблемы. ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено использование кортежей в запросах `CREATE .. AS SELECT`. [#24464](https://github.com/ClickHouse/ClickHouse/pull/24464) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено вычисление общего объёма данных в байтах в таблице `Buffer`. В текущей версии ClickHouse счётчик total&#95;writes.bytes чрезмерно уменьшается во время сброса буфера. Это приводит к переполнению счётчика, и totalBytes через некоторое время после сброса начинает возвращать значение около 17.44 EB. [#24450](https://github.com/ClickHouse/ClickHouse/pull/24450) ([DimasKovas](https://github.com/DimasKovas)).
* Исправлена некорректная информация о монотонности функции toWeek. Это устраняет [#24422](https://github.com/ClickHouse/ClickHouse/issues/24422). Эта ошибка была внесена в [https://github.com/ClickHouse/ClickHouse/pull/5212](https://github.com/ClickHouse/ClickHouse/pull/5212) и позднее проявилась благодаря более интеллектуальному механизму отсечения партиций. [#24446](https://github.com/ClickHouse/ClickHouse/pull/24446) ([Amos Bird](https://github.com/amosbird)).
* При аутентификации пользователей через LDAP исправлена потенциальная взаимная блокировка, которая могла возникать во время переназначения LDAP-ролей, когда группа LDAP сопоставлялась с несуществующей локальной ролью. [#24431](https://github.com/ClickHouse/ClickHouse/pull/24431) ([Denis Glazachev](https://github.com/traceon)).
* В сообщениях с типом &quot;multipart/form-data&quot; CRLF, предшествующий границе, следует считать частью этой границы. Исправляет [#23905](https://github.com/ClickHouse/ClickHouse/issues/23905). [#24399](https://github.com/ClickHouse/ClickHouse/pull/24399) ([Ivan](https://github.com/abyss7)).
* Исправлено выполнение `DROP PARTITION` при пересечении с фиктивными частями. В редких случаях могли появляться части с версией мутации, превышающей текущий номер блока. [#24321](https://github.com/ClickHouse/ClickHouse/pull/24321) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка при переносе материализованного представления из базы данных Ordinary в Atomic с помощью запроса `RENAME TABLE`. Теперь внутренняя таблица переносится в новую базу данных вместе с материализованным представлением. Исправляет [#23926](https://github.com/ClickHouse/ClickHouse/issues/23926). [#24309](https://github.com/ClickHouse/ClickHouse/pull/24309) ([tavplubix](https://github.com/tavplubix)).
* Разрешена передача пустых HTTP-заголовков. Исправляет [#23901](https://github.com/ClickHouse/ClickHouse/issues/23901). [#24285](https://github.com/ClickHouse/ClickHouse/pull/24285) ([Ivan](https://github.com/abyss7)).
* Корректная обработка мутаций (ALTER UPDATE/DELETE) в таблицах типа Memory. Закрывает [#24274](https://github.com/ClickHouse/ClickHouse/issues/24274). [#24275](https://github.com/ClickHouse/ClickHouse/pull/24275) ([flynn](https://github.com/ucasfl)).
* Сделать свойство LowCardinality столбца в результате JOIN таким же, как у входного столбца, закрыть [#23351](https://github.com/ClickHouse/ClickHouse/issues/23351) и [#20315](https://github.com/ClickHouse/ClickHouse/issues/20315). [#24061](https://github.com/ClickHouse/ClickHouse/pull/24061) ([Vladimir](https://github.com/vdimir)).
* Исправление для таблиц Kafka. Исправлена ошибка в поведении при отказоустойчивом переключении (failover), когда Engine = Kafka не мог начать потребление, если у того же потребителя ранее было пустое назначение. Закрывает [#21118](https://github.com/ClickHouse/ClickHouse/issues/21118). [#21267](https://github.com/ClickHouse/ClickHouse/pull/21267) ([filimonov](https://github.com/filimonov)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-4}

- Добавлены сборки `darwin-aarch64` (Mac M1 / Apple Silicon) в CI [#25560](https://github.com/ClickHouse/ClickHouse/pull/25560) ([Ivan](https://github.com/abyss7)) и размещены ссылки в документации и на веб-сайте ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлено кроссплатформенное встраивание бинарных ресурсов в исполняемые файлы. Работает на Illumos. [#25146](https://github.com/ClickHouse/ClickHouse/pull/25146) ([bnaecker](https://github.com/bnaecker)).
- Добавлены опции, связанные с соединениями, в стресс-тесты для улучшения фаззинга. [#25200](https://github.com/ClickHouse/ClickHouse/pull/25200) ([Vladimir](https://github.com/vdimir)).
- Включена сборка с модулем s3 в macOS [#25217](https://github.com/ClickHouse/ClickHouse/issues/25217). [#25218](https://github.com/ClickHouse/ClickHouse/pull/25218) ([kevin wan](https://github.com/MaxWk)).
- Добавлены интеграционные тестовые сценарии для покрытия JDBC bridge. [#25047](https://github.com/ClickHouse/ClickHouse/pull/25047) ([Zhichun Wu](https://github.com/zhicwu)).
- Конфигурация интеграционных тестов имеет специальную обработку для словарей. Удалена оставшаяся ручная настройка словарей. [#24728](https://github.com/ClickHouse/ClickHouse/pull/24728) ([Ilya Yatsishin](https://github.com/qoega)).
- Добавлены тесты libfuzzer для класса YAMLParser. [#24480](https://github.com/ClickHouse/ClickHouse/pull/24480) ([BoloniniD](https://github.com/BoloniniD)).
- Для запуска интеграционных тестов теперь используется Ubuntu 20.04, версия docker-compose, используемая для запуска интеграционных тестов, обновлена до 1.28.2. Переменные окружения теперь применяются в docker-compose. Переработан тест test_dictionaries_all_layouts_separate_sources для возможности параллельного запуска. [#20393](https://github.com/ClickHouse/ClickHouse/pull/20393) ([Ilya Yatsishin](https://github.com/qoega)).
- Исправлена ошибка TOCTOU в скрипте установки. [#25277](https://github.com/ClickHouse/ClickHouse/pull/25277) ([alexey-milovidov](https://github.com/alexey-milovidov)).

### Релиз ClickHouse 21.6, 2021-06-05 {#clickhouse-release-216-2021-06-05}

#### Обратно несовместимые изменения {#backward-incompatible-change-5}

- uniqState / uniqHLL12State / uniqCombinedState / uniqCombined64State создают несовместимые состояния с типом `UUID`. [#33607](https://github.com/ClickHouse/ClickHouse/issues/33607).

#### Примечания по обновлению {#upgrade-notes-1}

- Библиотека сжатия `zstd` обновлена до версии v1.5.0. Вы можете получать сообщения о несоответствии контрольной суммы («checksum does not match») при репликации. Эти сообщения ожидаемы в связи с обновлением алгоритма сжатия, и вы можете их игнорировать. Эти сообщения носят информационный характер и не указывают на какое-либо нежелательное поведение.
- Настройка `compile_expressions` включена по умолчанию. Хотя она была тщательно протестирована в различных сценариях, если вы обнаружите нежелательное поведение на ваших серверах, вы можете попробовать отключить эту настройку.
- Значения типа `UUID` нельзя сравнивать с целыми числами. Например, вместо записи `uuid != 0` используйте `uuid != '00000000-0000-0000-0000-000000000000'`.

#### Новые возможности {#new-feature-5}


* Добавлен оператор приведения типа в стиле Postgres (`::`). Например: `[1, 2]::Array(UInt8)`, `0.1::Decimal(4, 4)`, `number::UInt16`. [#23871](https://github.com/ClickHouse/ClickHouse/pull/23871) ([Anton Popov](https://github.com/CurtizJ)).
* Подготовить большие целые числа к использованию в продакшене. Добавить поддержку типа данных `UInt128`. Исправить известные проблемы с типом данных `Decimal256`. Добавить поддержку больших целых чисел в словарях. Добавить поддержку функций `gcd`/`lcm` для больших целых чисел. Добавить поддержку больших целых чисел в функциях поиска по массивам и условных функциях. Добавить поддержку `LowCardinality(UUID)`. Добавить поддержку больших целых чисел в табличной функции `generateRandom` и в `clickhouse-obfuscator`. Исправить ошибку при возврате `UUID` из скалярных подзапросов. Это исправляет [#7834](https://github.com/ClickHouse/ClickHouse/issues/7834). Это исправляет [#23936](https://github.com/ClickHouse/ClickHouse/issues/23936). Это исправляет [#4176](https://github.com/ClickHouse/ClickHouse/issues/4176). Это исправляет [#24018](https://github.com/ClickHouse/ClickHouse/issues/24018). Обратно несовместимое изменение: значения типа `UUID` нельзя сравнивать с целыми числами. Например, вместо `uuid != 0` следует писать `uuid != '00000000-0000-0000-0000-000000000000'`. [#23631](https://github.com/ClickHouse/ClickHouse/pull/23631) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка типа данных `Array` при вставке и выборке данных в форматах `Arrow`, `Parquet` и `ORC`. [#21770](https://github.com/ClickHouse/ClickHouse/pull/21770) ([taylor12805](https://github.com/taylor12805)).
* Реализованы комментарии к таблицам. Закрывает [#23225](https://github.com/ClickHouse/ClickHouse/issues/23225). [#23548](https://github.com/ClickHouse/ClickHouse/pull/23548) ([flynn](https://github.com/ucasFL)).
* Реализована возможность создания словарей с помощью DDL-запросов в `clickhouse-local`. Закрывает [#22354](https://github.com/ClickHouse/ClickHouse/issues/22354). Добавлена поддержка `DETACH DICTIONARY PERMANENTLY`. Добавлена поддержка `EXCHANGE DICTIONARIES` для движка базы данных `Atomic`. Добавлена поддержка перемещения словарей между базами данных с помощью `RENAME DICTIONARY`. [#23436](https://github.com/ClickHouse/ClickHouse/pull/23436) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена агрегатная функция `uniqTheta` для поддержки [Theta Sketch](https://datasketches.apache.org/docs/Theta/ThetaSketchFramework.html) в ClickHouse. [#23894](https://github.com/ClickHouse/ClickHouse/pull/23894). [#22609](https://github.com/ClickHouse/ClickHouse/pull/22609) ([Ping Yu](https://github.com/pingyu)).
* Добавлена функция `splitByRegexp`. [#24077](https://github.com/ClickHouse/ClickHouse/pull/24077) ([abel-cheng](https://github.com/abel-cheng)).
* Добавлена функция `arrayProduct`, которая принимает массив в качестве аргумента и возвращает произведение всех элементов массива. Закрывает [#21613](https://github.com/ClickHouse/ClickHouse/issues/21613). [#23782](https://github.com/ClickHouse/ClickHouse/pull/23782) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлен столбец `thread_name` в таблицу `system.stack_trace`. Это закрывает [#23256](https://github.com/ClickHouse/ClickHouse/issues/23256). [#24124](https://github.com/ClickHouse/ClickHouse/pull/24124) ([abel-cheng](https://github.com/abel-cheng)).
* Если `insert_null_as_default` = 1, то в запросах `INSERT ... SELECT` и `INSERT ... SELECT ... UNION ALL ...` вместо NULL вставляются значения по умолчанию. Закрывает [#22832](https://github.com/ClickHouse/ClickHouse/issues/22832). [#23524](https://github.com/ClickHouse/ClickHouse/pull/23524) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка отображения прогресса в `clickhouse-local` с помощью опции `--progress`. [#23196](https://github.com/ClickHouse/ClickHouse/pull/23196) ([Egor Savin](https://github.com/Amesaru)).
* Добавлена поддержка HTTP-сжатия (определяемого HTTP-заголовком `Content-Encoding`) в источнике словаря `http`, что исправляет [#8912](https://github.com/ClickHouse/ClickHouse/issues/8912). [#23946](https://github.com/ClickHouse/ClickHouse/pull/23946) ([FArthur-cmd](https://github.com/FArthur-cmd)).
* Добавлены команды `SYSTEM QUERY RELOAD MODEL`, `SYSTEM QUERY RELOAD MODELS`. Закрыта задача [#18722](https://github.com/ClickHouse/ClickHouse/issues/18722). [#23182](https://github.com/ClickHouse/ClickHouse/pull/23182) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена настройка `json` (булевый параметр, по умолчанию — 0) для запроса `EXPLAIN PLAN`. При её включении вывод запроса будет содержать единственную строку в формате `JSON`. Рекомендуется использовать формат `TSVRaw`, чтобы избежать лишнего экранирования. [#23082](https://github.com/ClickHouse/ClickHouse/pull/23082) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлена настройка `indexes` (логический тип, по умолчанию отключена) в запрос `EXPLAIN PIPELINE`. При включении показывает используемые индексы, количество отфильтрованных кусков (parts) и гранул для каждого применённого индекса. Поддерживается для таблиц `MergeTree*`. [#22352](https://github.com/ClickHouse/ClickHouse/pull/22352) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* LDAP: реализована возможность определения DN пользователя при сопоставлении групп Active Directory с ролями ClickHouse. [#22228](https://github.com/ClickHouse/ClickHouse/pull/22228) ([Denis Glazachev](https://github.com/traceon)).
* Новая агрегатная функция `deltaSumTimestamp` для суммирования разностей между соседними строками с сохранением порядка при слиянии за счёт хранения меток времени. [#21888](https://github.com/ClickHouse/ClickHouse/pull/21888) ([Russ Frank](https://github.com/rf)).
* Добавлен менее безопасный провайдер учетных данных IMDS для S3, который корректно работает в Docker. [#21852](https://github.com/ClickHouse/ClickHouse/pull/21852) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Возвращена функция `indexHint`. Это для [#21238](https://github.com/ClickHouse/ClickHouse/issues/21238). Отменяет изменения из [#9542](https://github.com/ClickHouse/ClickHouse/pull/9542). Исправляет [#9540](https://github.com/ClickHouse/ClickHouse/issues/9540). [#21304](https://github.com/ClickHouse/ClickHouse/pull/21304) ([Amos Bird](https://github.com/amosbird)).

#### Экспериментальная функциональность {#experimental-feature-5}

- Добавлена поддержка `PROJECTION` для таблиц `MergeTree*`. [#20202](https://github.com/ClickHouse/ClickHouse/pull/20202) ([Amos Bird](https://github.com/amosbird)).

#### Улучшение производительности {#performance-improvement-5}

- Настройка `compile_expressions` включена по умолчанию. При включении этой настройки композиции простых функций и операторов компилируются в нативный код с помощью LLVM во время выполнения. [#8482](https://github.com/ClickHouse/ClickHouse/pull/8482) ([Maksim Kita](https://github.com/kitaisreal), [alexey-milovidov](https://github.com/alexey-milovidov)). Примечание: если возникнут проблемы, отключите эту опцию.
- Обновлена библиотека `re2`. Улучшена производительность сопоставления регулярных выражений. Также этот PR добавляет совместимость с gcc-11. [#24196](https://github.com/ClickHouse/ClickHouse/pull/24196) ([Raúl Marín](https://github.com/Algunenano)).
- Чтение входного формата ORC выполняется по полосам вместо загрузки всей таблицы в память за один раз, что позволяет экономить память при больших размерах файлов. [#23102](https://github.com/ClickHouse/ClickHouse/pull/23102) ([Chao Ma](https://github.com/godliness)).
- Объединение агрегатных функций `sum`, `count` и `avg` в запросе в одну агрегатную функцию. Оптимизация управляется настройкой `optimize_fuse_sum_count_avg`. Реализовано с помощью новой агрегатной функции `sumCount`. Эта функция возвращает кортеж из двух полей: `sum` и `count`. [#21337](https://github.com/ClickHouse/ClickHouse/pull/21337) ([hexiaoting](https://github.com/hexiaoting)).
- Обновлена библиотека `zstd` до версии v1.5.0. Производительность сжатия улучшена на несколько процентов. [#24135](https://github.com/ClickHouse/ClickHouse/pull/24135) ([Raúl Marín](https://github.com/Algunenano)). Примечание: при репликации могут появляться сообщения «checksum does not match». Эти сообщения ожидаемы из-за обновления алгоритма сжатия, и их можно игнорировать.
- Улучшена производительность таблиц `Buffer`: блокировка для total_bytes/total_rows не захватывается для движка `Buffer`. [#24066](https://github.com/ClickHouse/ClickHouse/pull/24066) ([Azat Khuzhin](https://github.com/azat)).
- Возвращена поддержка предварительного выделения памяти для словарей hashed/sparse_hashed. [#23979](https://github.com/ClickHouse/ClickHouse/pull/23979) ([Azat Khuzhin](https://github.com/azat)).
- Настройка `async_socket_for_remote` включена по умолчанию (уменьшено количество потоков при запросах к распределённым таблицам с большим разветвлением). [#23683](https://github.com/ClickHouse/ClickHouse/pull/23683) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).

#### Улучшения {#improvement-5}


* Добавлен виртуальный столбец `_partition_value` в семейство таблиц MergeTree. Его можно использовать для детерминированного отсечения разделов. Это необходимо для реализации механизма сопоставления разделов при мутациях. [#23673](https://github.com/ClickHouse/ClickHouse/pull/23673) ([Amos Bird](https://github.com/amosbird)).
* Добавлен параметр `region` для хранилища и диска S3. [#23846](https://github.com/ClickHouse/ClickHouse/pull/23846) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Позволяет настраивать различные уровни логирования для отдельных каналов логирования. Закрывает [#19569](https://github.com/ClickHouse/ClickHouse/issues/19569). [#23857](https://github.com/ClickHouse/ClickHouse/pull/23857) ([filimonov](https://github.com/filimonov)).
* Сохранять часовой пояс по умолчанию при операциях с `DateTime`, если он не был указан явно. Например, если вы прибавляете одну секунду к значению типа `DateTime` без часового пояса, оно останется `DateTime` без часового пояса. В предыдущих версиях значение часового пояса по умолчанию явно добавлялось к возвращаемому типу данных, и тип становился `DateTime('something')`. Это закрывает [#4854](https://github.com/ClickHouse/ClickHouse/issues/4854). [#23392](https://github.com/ClickHouse/ClickHouse/pull/23392) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Разрешено указывать пустую строку вместо имени базы данных для хранилища `MySQL`. Для запросов будет использоваться база данных по умолчанию. В предыдущих версиях это работало только для запросов SELECT; теперь добавлена поддержка и для INSERT. Это закрывает [#19281](https://github.com/ClickHouse/ClickHouse/issues/19281). Может быть полезно при работе с `Sphinx` или другими MySQL-совместимыми внешними базами данных. [#23319](https://github.com/ClickHouse/ClickHouse/pull/23319) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены `quantile(s)TDigest`. Добавлена специальная обработка одиночных центроидов в соответствии с tdunning/t-digest 3.2+. Также исправлена ошибка избыточного сжатия центроидов в реализации более ранней версии алгоритма. [#23314](https://github.com/ClickHouse/ClickHouse/pull/23314) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Функция `now64` теперь поддерживает необязательный аргумент часового пояса. [#24091](https://github.com/ClickHouse/ClickHouse/pull/24091) ([Vasily Nemkov](https://github.com/Enmk)).
* Исправлена ситуация, когда индикатор прогресса в интерактивном режиме clickhouse-client, появляясь среди выводимых данных, мог перезаписывать части уже отображённых в терминале данных. Это закрывает задачу [#19283](https://github.com/ClickHouse/ClickHouse/issues/19283). [#23050](https://github.com/ClickHouse/ClickHouse/pull/23050) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен сбой при невозможности выделения памяти в simdjson. [https://github.com/simdjson/simdjson/pull/1567](https://github.com/simdjson/simdjson/pull/1567). Помечено как улучшение, поскольку это очень редкая ошибка. [#24147](https://github.com/ClickHouse/ClickHouse/pull/24147) ([Amos Bird](https://github.com/amosbird)).
* Сохранять словари до остановки хранилища (это позволит избежать возможных ошибок `external dictionary 'DICT' not found` при остановке сервера во время окончательного сброса движка `Buffer`). [#24068](https://github.com/ClickHouse/ClickHouse/pull/24068) ([Azat Khuzhin](https://github.com/azat)).
* Перед остановкой таблиц (в пределах одной базы данных) сбрасывайте таблицы типа `Buffer`, чтобы избежать отбрасывания блоков, если базовая таблица уже была отсоединена (и появления в логе ошибки `Destination table default.a_data_01870 doesn't exist. Block of data is discarded`). [#24067](https://github.com/ClickHouse/ClickHouse/pull/24067) ([Azat Khuzhin](https://github.com/azat)).
* Теперь при `prefer_column_name_to_alias = 1` будут использоваться имена столбцов в `GROUP BY`, `HAVING` и `ORDER BY`. Это исправляет [#23882](https://github.com/ClickHouse/ClickHouse/issues/23882). [#24022](https://github.com/ClickHouse/ClickHouse/pull/24022) ([Amos Bird](https://github.com/amosbird)).
* Добавлена поддержка `ORDER BY WITH FILL` для `DateTime64`. [#24016](https://github.com/ClickHouse/ClickHouse/pull/24016) ([kevin wan](https://github.com/MaxWk)).
* Добавлена возможность использовать `DateTime64` в качестве колонки версии в `ReplacingMergeTree`. [#23992](https://github.com/ClickHouse/ClickHouse/pull/23992) ([kevin wan](https://github.com/MaxWk)).
* Логировать информацию о названии ОС, версии ядра и архитектуре процессора при запуске сервера. [#23988](https://github.com/ClickHouse/ClickHouse/pull/23988) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка указания схемы таблицы для источника словаря `postgresql`. Закрывает [#23958](https://github.com/ClickHouse/ClickHouse/issues/23958). [#23980](https://github.com/ClickHouse/ClickHouse/pull/23980) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлены подсказки для имён элементов `Enum` (предлагаются варианты имён при опечатках). Закрывает [#17112](https://github.com/ClickHouse/ClickHouse/issues/17112). [#23919](https://github.com/ClickHouse/ClickHouse/pull/23919) ([flynn](https://github.com/ucasFL)).
* Измерять долю найденных значений (процент записей, для которых значение найдено) для словарей (см. `found_rate` в `system.dictionaries`). [#23916](https://github.com/ClickHouse/ClickHouse/pull/23916) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена возможность задавать индивидуальные настройки очереди через параметр таблицы `rabbitmq_queue_settings_list`. (Закрывает [#23737](https://github.com/ClickHouse/ClickHouse/issues/23737) и [#23918](https://github.com/ClickHouse/ClickHouse/issues/23918)). Добавлена возможность пользователю управлять всеми аспектами конфигурации RabbitMQ: если параметр таблицы `rabbitmq_queue_consume` установлен в `1`, движок таблиц RabbitMQ будет только подключаться к указанной очереди и не будет выполнять никакой настройки на стороне потребителя RabbitMQ, такой как объявление обменников, очередей, привязок. (Закрывает [#21757](https://github.com/ClickHouse/ClickHouse/issues/21757)). Добавлена корректная очистка при удалении таблицы RabbitMQ — удаляются очереди, объявленные таблицей, и все привязанные обменники, если они были созданы таблицей. [#23887](https://github.com/ClickHouse/ClickHouse/pull/23887) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлены столбцы `broken_data_files`/`broken_data_compressed_bytes` в таблицу `system.distribution_queue`. Добавлена метрика числа файлов асинхронной вставки в таблицы Distributed, помеченных как повреждённые (`BrokenDistributedFilesToInsert`). [#23885](https://github.com/ClickHouse/ClickHouse/pull/23885) ([Azat Khuzhin](https://github.com/azat)).
* Запросы к `system.tables` больше не обращаются к ZooKeeper. [#23793](https://github.com/ClickHouse/ClickHouse/pull/23793) ([Fuwang Hu](https://github.com/fuwhu)).
* Учитывать параметр `lock_acquire_timeout_for_background_operations` в запросах `OPTIMIZE`. [#23623](https://github.com/ClickHouse/ClickHouse/pull/23623) ([Azat Khuzhin](https://github.com/azat)).
* Возможность изменять настройки диска `S3` во время работы с помощью новой SQL-команды `SYSTEM RESTART DISK`. [#23429](https://github.com/ClickHouse/ClickHouse/pull/23429) ([Pavel Kovalenko](https://github.com/Jokser)).
* Если пользователь по ошибке некорректно настроил `max_distributed_connections`, установив его значение в ноль, каждый запрос к таблице `Distributed` будет приводить к исключению с сообщением, содержащим &quot;logical error&quot;. Однако на самом деле это ожидаемое поведение, а не логическая ошибка, поэтому текст сообщения об исключении был немного некорректным. Это также вызывало срабатывание проверок в нашей CI-среде, которые гарантируют, что логические ошибки никогда не возникают. Вместо этого мы будем трактовать `max_distributed_connections`, ошибочно установленные в ноль, как минимально возможное значение (один). [#23348](https://github.com/ClickHouse/ClickHouse/pull/23348) ([Azat Khuzhin](https://github.com/azat)).
* Параметр `min_bytes_to_use_mmap_io` по умолчанию отключен. [#23322](https://github.com/ClickHouse/ClickHouse/pull/23322) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка NULL-допустимости `LowCardinality` при `join_use_nulls`, закрыт тикет [#15101](https://github.com/ClickHouse/ClickHouse/issues/15101). [#23237](https://github.com/ClickHouse/ClickHouse/pull/23237) ([vdimir](https://github.com/vdimir)).
* Добавлена возможность восстанавливать части `MergeTree` в каталог `detached` на диске `S3`. [#23112](https://github.com/ClickHouse/ClickHouse/pull/23112) ([Pavel Kovalenko](https://github.com/Jokser)).
* Повторные попытки при обрывах HTTP-соединения с S3. [#22988](https://github.com/ClickHouse/ClickHouse/pull/22988) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Добавлены настройки `external_storage_max_read_rows` и `external_storage_max_read_rows` для движка таблиц MySQL, источника словаря и небольших выборок данных в MaterializeMySQL. [#22697](https://github.com/ClickHouse/ClickHouse/pull/22697) ([TCeason](https://github.com/TCeason)).
* `MaterializeMySQL` (экспериментальная функция): ранее MySQL 5.7.9 не поддерживался из‑за несовместимости с SQL. Теперь проверка параметров MySQL возлагается на MaterializeMySQL. [#23413](https://github.com/ClickHouse/ClickHouse/pull/23413) ([TCeason](https://github.com/TCeason)).
* Добавлено чтение подколонок для распределённых таблиц. [#24472](https://github.com/ClickHouse/ClickHouse/pull/24472) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена обработка кортежей в запросах `CREATE .. AS SELECT`. [#24464](https://github.com/ClickHouse/ClickHouse/pull/24464) ([Anton Popov](https://github.com/CurtizJ)).
* Поддержка формата `Parquet` в таблицах `Kafka`. [#23412](https://github.com/ClickHouse/ClickHouse/pull/23412) ([Chao Ma](https://github.com/godliness)).

#### Исправление ошибок {#bug-fix-4}


* Использовать старую версию функции вычисления остатка от деления, когда она используется в ключе партиционирования и первичном ключе. Закрывает [#23508](https://github.com/ClickHouse/ClickHouse/issues/23508). [#24157](https://github.com/ClickHouse/ClickHouse/pull/24157) ([Kseniia Sumarokova](https://github.com/kssenii)). Это было причиной обратной несовместимости в предыдущих релизах.
* Исправлено поведение, при котором запрос `SYSTEM RESTART REPLICA` или `SYSTEM SYNC REPLICA` мог обрабатываться бесконечно долго. Проблема проявлялась на сервере с крайне небольшим объёмом оперативной памяти. [#24457](https://github.com/ClickHouse/ClickHouse/pull/24457) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена некорректная монотонность функции `toWeek`. Это исправление закрывает [#24422](https://github.com/ClickHouse/ClickHouse/issues/24422). Эта ошибка была допущена в [#5212](https://github.com/ClickHouse/ClickHouse/pull/5212) и позже проявилась из-за более интеллектуального механизма отсечения партиций. [#24446](https://github.com/ClickHouse/ClickHouse/pull/24446) ([Amos Bird](https://github.com/amosbird)).
* Исправлена операция удаления раздела с пересекающимися фиктивными частями. В редких случаях могли существовать части с версией мутации, превышающей текущий номер блока. [#24321](https://github.com/ClickHouse/ClickHouse/pull/24321) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка при переносе материализованного представления из базы данных типа Ordinary в базу данных типа Atomic с помощью запроса `RENAME TABLE`. Теперь внутренняя таблица переносится в новую базу данных вместе с материализованным представлением. Исправление для [#23926](https://github.com/ClickHouse/ClickHouse/issues/23926). [#24309](https://github.com/ClickHouse/ClickHouse/pull/24309) ([tavplubix](https://github.com/tavplubix)).
* Разрешены пустые HTTP-заголовки в клиентских запросах. Исправлена проблема [#23901](https://github.com/ClickHouse/ClickHouse/issues/23901). [#24285](https://github.com/ClickHouse/ClickHouse/pull/24285) ([Ivan](https://github.com/abyss7)).
* Установите `max_threads = 1`, чтобы устранить ошибку выполнения мутаций таблиц `Memory`. Закрывает [#24274](https://github.com/ClickHouse/ClickHouse/issues/24274). [#24275](https://github.com/ClickHouse/ClickHouse/pull/24275) ([flynn](https://github.com/ucasFL)).
* Исправлена опечатка в реализации таблиц `Memory`, эта ошибка появилась в [#15127](https://github.com/ClickHouse/ClickHouse/issues/15127). Закрывает [#24192](https://github.com/ClickHouse/ClickHouse/issues/24192). [#24193](https://github.com/ClickHouse/ClickHouse/pull/24193) ([张中南](https://github.com/plugine)).
* Исправлено аварийное завершение работы сервера при потере доступа к `HDFS` во время выполнения запроса. Закрывает [#24117](https://github.com/ClickHouse/ClickHouse/issues/24117). [#24191](https://github.com/ClickHouse/ClickHouse/pull/24191) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка, приводившая к сбою при обновлении столбца типа `Nested` с константным условием. [#24183](https://github.com/ClickHouse/ClickHouse/pull/24183) ([hexiaoting](https://github.com/hexiaoting)).
* Исправлена гонка состояний, которая могла возникать в RBAC при высокой нагрузке. Этот PR исправляет [#24090](https://github.com/ClickHouse/ClickHouse/issues/24090), [#24134](https://github.com/ClickHouse/ClickHouse/issues/24134), [#24176](https://github.com/ClickHouse/ClickHouse/pull/24176) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена редкая ошибка, которая могла привести к частично инициализированной таблице, способной обслуживать запросы на запись (insert/alter и т. п.). Теперь такие таблицы будут доступны только для чтения. [#24122](https://github.com/ClickHouse/ClickHouse/pull/24122) ([alesapin](https://github.com/alesapin)).
* Исправлена проблема: `EXPLAIN PIPELINE` при использовании с оператором `SELECT xxx FINAL` показывал неверный конвейер. ([hexiaoting](https://github.com/hexiaoting)).
* Исправлена обработка константного значения `DateTime` в `WHERE` при сравнении со столбцом `DateTime64`. [#24100](https://github.com/ClickHouse/ClickHouse/pull/24100) ([Vasily Nemkov](https://github.com/Enmk)).
* Исправлено аварийное завершение при выполнении merge JOIN, закрывающее [#24010](https://github.com/ClickHouse/ClickHouse/issues/24010). [#24013](https://github.com/ClickHouse/ClickHouse/pull/24013) ([vdimir](https://github.com/vdimir)).
* Некоторые запросы `ALTER PARTITION` могли приводить к появлению ошибок `Part A intersects previous part B` и `Unexpected merged part C intersecting drop range D` в очереди репликации. Проблема исправлена. Исправляет [#23296](https://github.com/ClickHouse/ClickHouse/issues/23296). [#23997](https://github.com/ClickHouse/ClickHouse/pull/23997) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка SIGSEGV при использовании внешнего GROUP BY и строки переполнения (т. е. в запросах вида `SELECT FROM GROUP BY WITH TOTALS SETTINGS max_bytes_before_external_group_by>0, max_rows_to_group_by>0, group_by_overflow_mode='any', totals_mode='before_having'`). [#23962](https://github.com/ClickHouse/ClickHouse/pull/23962) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен учет метрик ключей для `CACHE`-словаря с дубликатами в источнике (что приводило к переполнениям `DictCacheKeysRequestedMiss`). [#23929](https://github.com/ClickHouse/ClickHouse/pull/23929) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена реализация пула подключений движка `PostgreSQL`. Закрывает [#23897](https://github.com/ClickHouse/ClickHouse/issues/23897). [#23909](https://github.com/ClickHouse/ClickHouse/pull/23909) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена работа настройки `distributed_group_by_no_merge = 2` с `GROUP BY` и агрегатной функцией, обёрнутой в обычную функцию (поведение было нарушено в [#23546](https://github.com/ClickHouse/ClickHouse/issues/23546)). Теперь выбрасывается исключение при попытке использовать `distributed_group_by_no_merge = 2` с оконными функциями. Отключена настройка `optimize_distributed_group_by_sharding_key` для запросов с оконными функциями. [#23906](https://github.com/ClickHouse/ClickHouse/pull/23906) ([Azat Khuzhin](https://github.com/azat)).
* Исправление для табличной функции `s3`: улучшенная обработка HTTP-ошибок. Ранее тела ответов при HTTP-ошибках игнорировались. [#23844](https://github.com/ClickHouse/ClickHouse/pull/23844) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Исправление табличной функции `s3`: улучшена обработка URI. Устранена несовместимость с URL, содержащими символ `+`, ранее данные с такими ключами было невозможно прочитать. [#23822](https://github.com/ClickHouse/ClickHouse/pull/23822) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Исправлена ошибка `Can't initialize pipeline with empty pipe` для запросов с `GLOBAL IN/JOIN` и `use_hedged_requests`. Исправлено [#23431](https://github.com/ClickHouse/ClickHouse/issues/23431). [#23805](https://github.com/ClickHouse/ClickHouse/pull/23805) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено: `CLEAR COLUMN` не работал, когда на него ссылалось материализованное представление. Закрыта [#23764](https://github.com/ClickHouse/ClickHouse/issues/23764). [#23781](https://github.com/ClickHouse/ClickHouse/pull/23781) ([flynn](https://github.com/ucasFL)).
* Исправлена ошибка использования кучи после освобождения памяти при чтении из HDFS в формате `Values`. [#23761](https://github.com/ClickHouse/ClickHouse/pull/23761) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Устранена возможная ошибка «Cannot schedule a task» (в случае возникновения исключения) при выполнении INSERT в Distributed. [#23744](https://github.com/ClickHouse/ClickHouse/pull/23744) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка при восстановлении отставшей реплики `ReplicatedMergeTree`. Некоторые обновления метаданных могли игнорироваться отставшей репликой, если запрос `ALTER` был выполнен во время простоя реплики. [#23742](https://github.com/ClickHouse/ClickHouse/pull/23742) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка, связанная с `Join` и `WITH TOTALS`, закрыт [#17718](https://github.com/ClickHouse/ClickHouse/issues/17718). [#23549](https://github.com/ClickHouse/ClickHouse/pull/23549) ([vdimir](https://github.com/vdimir)).
* Исправлена потенциальная ошибка `Block structure mismatch` для запросов с `UNION`, которая могла возникнуть после оптимизации filter-pushdown. Исправляет [#23029](https://github.com/ClickHouse/ClickHouse/issues/23029). [#23359](https://github.com/ClickHouse/ClickHouse/pull/23359) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлено приведение типов при включённой настройке `optimize_skip_unused_shards_rewrite_in`, что исправляет отчёт MSan. [#23219](https://github.com/ClickHouse/ClickHouse/pull/23219) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена отсутствовавшая проверка при обновлении вложенных подстолбцов, закрыт тикет: [#22353](https://github.com/ClickHouse/ClickHouse/issues/22353). [#22503](https://github.com/ClickHouse/ClickHouse/pull/22503) ([hexiaoting](https://github.com/hexiaoting)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-5}

- Поддержка сборки на Illumos. [#24144](https://github.com/ClickHouse/ClickHouse/pull/24144). Добавлена поддержка сборки на операционных системах, производных от Solaris. [#23746](https://github.com/ClickHouse/ClickHouse/pull/23746) ([bnaecker](https://github.com/bnaecker)).
- Добавлены дополнительные бенчмарки для хеш-таблиц, включая Swiss Table от Google (которая оказалась медленнее хеш-таблицы ClickHouse в нашем конкретном сценарии использования). [#24111](https://github.com/ClickHouse/ClickHouse/pull/24111) ([Maksim Kita](https://github.com/kitaisreal)).
- Обновление librdkafka с версии 1.6.0-RC3 до 1.6.1. [#23874](https://github.com/ClickHouse/ClickHouse/pull/23874) ([filimonov](https://github.com/filimonov)).
- Явное включение `asynchronous-unwind-tables` во всех случаях. Это может исправить работу профилировщика запросов на AArch64. [#23602](https://github.com/ClickHouse/ClickHouse/pull/23602) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Устранена возможная зависимость сборки от локали и порядка файловой системы. Это обеспечивает воспроизводимость сборок. [#23600](https://github.com/ClickHouse/ClickHouse/pull/23600) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Устранён источник недетерминированности при сборке. Теперь сборки, выполненные в разное время, будут создавать побайтово идентичные бинарные файлы. Частично решена проблема [#22113](https://github.com/ClickHouse/ClickHouse/issues/22113). [#23559](https://github.com/ClickHouse/ClickHouse/pull/23559) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлен простой инструмент для бенчмаркинга (Zoo)Keeper. [#23038](https://github.com/ClickHouse/ClickHouse/pull/23038) ([alesapin](https://github.com/alesapin)).


## Релиз ClickHouse 21.5, 2021-05-20 {#clickhouse-release-215-2021-05-20}

#### Обратно несовместимое изменение {#backward-incompatible-change-6}

- Изменено сравнение целых чисел и чисел с плавающей точкой, когда целое число не может быть точно представлено в типе данных с плавающей точкой. В новой версии сравнение будет возвращать false, так как произойдет ошибка округления. Пример: `9223372036854775808.0 != 9223372036854775808`, потому что число `9223372036854775808` не может быть точно представлено как число с плавающей точкой (и `9223372036854775808.0` округляется до `9223372036854776000.0`). Но в предыдущей версии сравнение возвращало результат, что числа равны, потому что если число с плавающей точкой `9223372036854776000.0` преобразовать обратно в UInt64, оно даст `9223372036854775808`. Для справки, язык программирования Python также считает эти числа равными. Но это поведение зависело от модели процессора (разные результаты на AMD64 и AArch64 для некоторых чисел вне диапазона), поэтому мы сделали сравнение более точным. Теперь целые числа и числа с плавающей точкой будут считаться равными только если целое число точно представлено в типе с плавающей точкой. [#22595](https://github.com/ClickHouse/ClickHouse/pull/22595) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Удалена поддержка `argMin` и `argMax` для одного аргумента типа `Tuple`. Код не был безопасным с точки зрения работы с памятью. Функциональность была добавлена по ошибке и вводит пользователей в заблуждение. Эти функции могут быть повторно введены под другими именами позже. Это исправляет [#22384](https://github.com/ClickHouse/ClickHouse/issues/22384) и отменяет [#17359](https://github.com/ClickHouse/ClickHouse/issues/17359). [#23393](https://github.com/ClickHouse/ClickHouse/pull/23393) ([alexey-milovidov](https://github.com/alexey-milovidov)).

#### Новая функциональность {#new-feature-6}

- Добавлены функции `dictGetChildren(dictionary, key)`, `dictGetDescendants(dictionary, key, level)`. Функция `dictGetChildren` возвращает всех потомков в виде массива индексов. Это обратное преобразование для `dictGetHierarchy`. Функция `dictGetDescendants` возвращает всех потомков, как если бы `dictGetChildren` была применена `level` раз рекурсивно. Нулевое значение `level` эквивалентно бесконечности. Улучшена производительность функций `dictGetHierarchy`, `dictIsIn`. Закрывает [#14656](https://github.com/ClickHouse/ClickHouse/issues/14656). [#22096](https://github.com/ClickHouse/ClickHouse/pull/22096) ([Maksim Kita](https://github.com/kitaisreal)).
- Добавлена функция `dictGetOrNull`. Работает как `dictGet`, но возвращает `Null` в случае, если ключ не найден в словаре. Закрывает [#22375](https://github.com/ClickHouse/ClickHouse/issues/22375). [#22413](https://github.com/ClickHouse/ClickHouse/pull/22413) ([Maksim Kita](https://github.com/kitaisreal)).
- Добавлена табличная функция `s3Cluster`, которая позволяет обрабатывать файлы из `s3` параллельно на каждом узле указанного кластера. [#22012](https://github.com/ClickHouse/ClickHouse/pull/22012) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Добавлена поддержка реплик и шардов в движке таблиц MySQL/PostgreSQL и табличной функции. Можно писать `SELECT * FROM mysql('host{1,2}-{1|2}', ...)`. Закрывает [#20969](https://github.com/ClickHouse/ClickHouse/issues/20969). [#22217](https://github.com/ClickHouse/ClickHouse/pull/22217) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлен запрос `ALTER TABLE ... FETCH PART ...`. Он похож на `FETCH PARTITION`, но извлекает только один кусок данных. [#22706](https://github.com/ClickHouse/ClickHouse/pull/22706) ([turbo jason](https://github.com/songenjie)).
- Добавлена настройка `max_distributed_depth`, которая ограничивает глубину рекурсивных запросов к таблицам `Distributed`. Закрывает [#20229](https://github.com/ClickHouse/ClickHouse/issues/20229). [#21942](https://github.com/ClickHouse/ClickHouse/pull/21942) ([flynn](https://github.com/ucasFL)).


#### Улучшение производительности {#performance-improvement-6}

- Улучшена производительность `intDiv` за счёт динамической диспетчеризации для AVX2. Закрывает [#22314](https://github.com/ClickHouse/ClickHouse/issues/22314). [#23000](https://github.com/ClickHouse/ClickHouse/pull/23000) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Улучшена производительность чтения из входного формата `ArrowStream` для источников, отличных от локальных файлов (например, URL). [#22673](https://github.com/ClickHouse/ClickHouse/pull/22673) ([nvartolomei](https://github.com/nvartolomei)).
- По умолчанию отключено сжатие при взаимодействии с localhost (с clickhouse-client или между серверами при распределённых запросах) через нативный протокол. Это может улучшить производительность некоторых операций импорта/экспорта. Закрывает [#22234](https://github.com/ClickHouse/ClickHouse/issues/22234). [#22237](https://github.com/ClickHouse/ClickHouse/pull/22237) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Исключение значений, не принадлежащих шарду, из правой части секции IN для распределённых запросов (при использовании `optimize_skip_unused_shards_rewrite_in`, включено по умолчанию, так как по-прежнему требуется `optimize_skip_unused_shards`). [#21511](https://github.com/ClickHouse/ClickHouse/pull/21511) ([Azat Khuzhin](https://github.com/azat)).
- Улучшена производительность чтения подмножества столбцов с файловыми движками таблиц и столбцовыми форматами, такими как Parquet, Arrow или ORC. Закрывает [#issue:20129](https://github.com/ClickHouse/ClickHouse/issues/20129). [#21302](https://github.com/ClickHouse/ClickHouse/pull/21302) ([keenwolf](https://github.com/keen-wolf)).
- Разрешено перемещать больше условий в `PREWHERE`, как это было до версии 21.1 (корректировка внутренней эвристики). Недостаточное количество перемещённых условий могло приводить к снижению производительности. [#23397](https://github.com/ClickHouse/ClickHouse/pull/23397) ([Anton Popov](https://github.com/CurtizJ)).
- Улучшена производительность ODBC-соединений и исправлены все нерешённые проблемы из списка задач. Используется библиотека `nanodbc` вместо `Poco::ODBC`. Закрывает [#9678](https://github.com/ClickHouse/ClickHouse/issues/9678). Добавлена поддержка DateTime64 и Decimal\* для движка таблиц ODBC. Закрывает [#21961](https://github.com/ClickHouse/ClickHouse/issues/21961). Исправлена проблема с обрезанием кириллического текста. Закрывает [#16246](https://github.com/ClickHouse/ClickHouse/issues/16246). Добавлены пулы соединений для odbc bridge. [#21972](https://github.com/ClickHouse/ClickHouse/pull/21972) ([Kseniia Sumarokova](https://github.com/kssenii)).

#### Улучшение {#improvement-6}


* Размер `max_uri_size` (максимальный размер URL в HTTP-интерфейсе) по умолчанию увеличен до 1 МиБ. Это закрывает [#21197](https://github.com/ClickHouse/ClickHouse/issues/21197). [#22997](https://github.com/ClickHouse/ClickHouse/pull/22997) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Установите `background_fetches_pool_size` равным `8`, что лучше подходит для эксплуатации в продакшене с частыми небольшими вставками или медленным кластером ZooKeeper. [#22945](https://github.com/ClickHouse/ClickHouse/pull/22945) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* В FlatDictionary добавлены параметры `initial_array_size` и `max_array_size`. [#22521](https://github.com/ClickHouse/ClickHouse/pull/22521) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена новая настройка `non_replicated_deduplication_window` для дедупликации вставок в нереплицируемых таблицах MergeTree. [#22514](https://github.com/ClickHouse/ClickHouse/pull/22514) ([alesapin](https://github.com/alesapin)).
* Обновлены пути к конфигурациям модели `CatBoost` в механизме перезагрузки конфигурации. [#22434](https://github.com/ClickHouse/ClickHouse/pull/22434) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка типа `Decimal256` в словарях. `Decimal256` — экспериментальная возможность. Закрывает [#20979](https://github.com/ClickHouse/ClickHouse/issues/20979). [#22960](https://github.com/ClickHouse/ClickHouse/pull/22960) ([Maksim Kita](https://github.com/kitaisreal)).
* По умолчанию параметр `async_socket_for_remote` включён (для распределённых запросов используется меньше потоков ОС). [#23683](https://github.com/ClickHouse/ClickHouse/pull/23683) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлены `quantile(s)TDigest`. Добавлена специальная обработка одиночных центроидов в соответствии с tdunning/t-digest 3.2+. Также была исправлена ошибка с чрезмерным сжатием центроидов в реализации более ранней версии алгоритма. [#23314](https://github.com/ClickHouse/ClickHouse/pull/23314) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Имя функции `unhex` сделано регистронезависимым для совместимости с MySQL. [#23229](https://github.com/ClickHouse/ClickHouse/pull/23229) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Реализованы функции `arrayHasAny`, `arrayHasAll`, `has`, `indexOf`, `countEqual` для общего случая, когда типы элементов массива могут различаться. В предыдущих версиях функции `arrayHasAny`, `arrayHasAll` возвращали false, а `has`, `indexOf`, `countEqual` выбрасывали исключение. Также добавлена поддержка типов `Decimal` и больших целых чисел в функциях `has` и подобных. Это закрывает [#20272](https://github.com/ClickHouse/ClickHouse/issues/20272). [#23044](https://github.com/ClickHouse/ClickHouse/pull/23044) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Увеличен предел максимального числа совпадений в результате работы функции `extractAllGroupsHorizontal`. [#23036](https://github.com/ClickHouse/ClickHouse/pull/23036) ([Vasily Nemkov](https://github.com/Enmk)).
* Не выполняйте `optimize_skip_unused_shards` на кластере с одним узлом. [#22999](https://github.com/ClickHouse/ClickHouse/pull/22999) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена возможность запускать clickhouse-keeper (экспериментальную замену ZooKeeper, совместимую по интерфейсу) с SSL. Настройку `keeper_server.tcp_port_secure` можно использовать для защищённого взаимодействия клиента с keeper-сервером. `keeper_server.raft_configuration.secure` можно использовать для включения внутреннего защищённого взаимодействия между узлами. [#22992](https://github.com/ClickHouse/ClickHouse/pull/22992) ([alesapin](https://github.com/alesapin)).
* Добавлена возможность выполнять сброс буфера только в фоновом режиме для таблиц `Buffer`. [#22986](https://github.com/ClickHouse/ClickHouse/pull/22986) ([Azat Khuzhin](https://github.com/azat)).
* При выборке из таблицы MergeTree с `NULL` в условии `WHERE` в редких случаях возникало исключение. Это исправляет [#20019](https://github.com/ClickHouse/ClickHouse/issues/20019). [#22978](https://github.com/ClickHouse/ClickHouse/pull/22978) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена обработка ошибок HTTP-клиента Poco для AWS. [#22973](https://github.com/ClickHouse/ClickHouse/pull/22973) ([kreuzerkrieg](https://github.com/kreuzerkrieg)).
* Теперь параметр `max_part_removal_threads` учитывается для `ReplicatedMergeTree`. [#22971](https://github.com/ClickHouse/ClickHouse/pull/22971) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен неочевидный граничный случай в настройках MergeTree при сочетании `inactive_parts_to_throw_insert = 0` и `inactive_parts_to_delay_insert > 0`. [#22947](https://github.com/ClickHouse/ClickHouse/pull/22947) ([Azat Khuzhin](https://github.com/azat)).
* `dateDiff` теперь работает с аргументами `DateTime64` (даже для значений вне диапазона `DateTime`) [#22931](https://github.com/ClickHouse/ClickHouse/pull/22931) ([Vasily Nemkov](https://github.com/Enmk)).
* MaterializeMySQL (экспериментальная функциональность): добавлена возможность реплицировать базы данных MySQL, содержащие представления, без ошибок. Это достигается за счёт игнорирования представлений. [#22760](https://github.com/ClickHouse/ClickHouse/pull/22760) ([Christian](https://github.com/cfroystad)).
* Разрешено применение строковых политик RBAC через протокол PostgreSQL. Закрывает [#22658](https://github.com/ClickHouse/ClickHouse/issues/22658). Протокол PostgreSQL по умолчанию включен в конфигурации. [#22755](https://github.com/ClickHouse/ClickHouse/pull/22755) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена метрика, позволяющая отслеживать время ожидания блокировки слоя Buffer. [#22725](https://github.com/ClickHouse/ClickHouse/pull/22725) ([Azat Khuzhin](https://github.com/azat)).
* Разрешено использование CTE в определении представления (VIEW). Это закрывает задачу [#22491](https://github.com/ClickHouse/ClickHouse/issues/22491). [#22657](https://github.com/ClickHouse/ClickHouse/pull/22657) ([Amos Bird](https://github.com/amosbird)).
* Очищать оставшуюся часть экрана и показывать курсор в `clickhouse-client`, если предыдущая программа оставила в терминале мусор. Тем самым закрывается [#16518](https://github.com/ClickHouse/ClickHouse/issues/16518). [#22634](https://github.com/ClickHouse/ClickHouse/pull/22634) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Обеспечить единообразное поведение функции `round` на платформах, отличных от x86&#95;64. Используется округление половины к ближайшему чётному (банковское округление). [#22582](https://github.com/ClickHouse/ClickHouse/pull/22582) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена проверка структуры блоков данных, отправляемых таблицами Distributed. [#22325](https://github.com/ClickHouse/ClickHouse/pull/22325) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена возможность публиковать ошибки Kafka в виртуальный столбец движка Kafka; поведение контролируется настройкой `kafka_handle_error_mode`. [#21850](https://github.com/ClickHouse/ClickHouse/pull/21850) ([fastio](https://github.com/fastio)).
* Добавлены псевдонимы `simpleJSONExtract/simpleJSONHas` к `visitParam/visitParamExtract{UInt, Int, Bool, Float, Raw, String}`. Исправлено [#21383](https://github.com/ClickHouse/ClickHouse/issues/21383). [#21519](https://github.com/ClickHouse/ClickHouse/pull/21519) ([fastio](https://github.com/fastio)).
* Добавлен `clickhouse-library-bridge` для типа источника словаря `library`. Закрывает [#9502](https://github.com/ClickHouse/ClickHouse/issues/9502). [#21509](https://github.com/ClickHouse/ClickHouse/pull/21509) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Запрещено удалять столбец, если на него ссылается материализованное представление. Закрывает [#21164](https://github.com/ClickHouse/ClickHouse/issues/21164). [#21303](https://github.com/ClickHouse/ClickHouse/pull/21303) ([flynn](https://github.com/ucasFL)).
* Поддержка динамических учетных данных для межсерверного взаимодействия (ротация учетных данных без простоев). [#14113](https://github.com/ClickHouse/ClickHouse/pull/14113) ([johnskopis](https://github.com/johnskopis)).
* Добавлена поддержка хранилища Kafka с сообщениями в форматах `Arrow` и `ArrowStream`. [#23415](https://github.com/ClickHouse/ClickHouse/pull/23415) ([Chao Ma](https://github.com/godliness)).
* Исправлена пропущенная точка с запятой в сообщении об исключении. Пользователю это сообщение об исключении может показаться неприятным для чтения. [#23208](https://github.com/ClickHouse/ClickHouse/pull/23208) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено отсутствие пробелов в некоторых сообщениях об исключениях, связанных с типом `LowCardinality`. [#23207](https://github.com/ClickHouse/ClickHouse/pull/23207) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Ранее некоторые значения форматировались с выравниванием по центру в ячейках таблиц в формате `Markdown`. Теперь это исправлено. [#23096](https://github.com/ClickHouse/ClickHouse/pull/23096) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Из подсказок в clickhouse-client удалены несущественные детали. Это закрывает [#22158](https://github.com/ClickHouse/ClickHouse/issues/22158). [#23040](https://github.com/ClickHouse/ClickHouse/pull/23040) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен расчёт поля `bytes_allocated` в system.dictionaries для словарей sparse&#95;hashed. [#22867](https://github.com/ClickHouse/ClickHouse/pull/22867) ([Azat Khuzhin](https://github.com/azat)).
* Исправлён приблизительный подсчёт общего числа строк с учётом обратного чтения из MergeTree. [#22726](https://github.com/ClickHouse/ClickHouse/pull/22726) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена возможность настроить словарь с источником `clickhouse`, указывающим на сам себя, что приводило к бесконечному циклу. Закрывает [#14314](https://github.com/ClickHouse/ClickHouse/issues/14314). [#22479](https://github.com/ClickHouse/ClickHouse/pull/22479) ([Maksim Kita](https://github.com/kitaisreal)).

#### Исправление ошибок {#bug-fix-5}


* Несколько исправлений для хеджированных запросов. Исправлена ошибка `Can't initialize pipeline with empty pipe` для запросов с `GLOBAL IN/JOIN`, когда включена настройка `use_hedged_requests`. Исправляет [#23431](https://github.com/ClickHouse/ClickHouse/issues/23431). [#23805](https://github.com/ClickHouse/ClickHouse/pull/23805) ([Nikolai Kochetov](https://github.com/KochetovNicolai)). Исправлена гонка в хеджированных соединениях, приводившая к сбою. Это исправляет [#22161](https://github.com/ClickHouse/ClickHouse/issues/22161). [#22443](https://github.com/ClickHouse/ClickHouse/pull/22443) ([Kruglov Pavel](https://github.com/Avogar)). Исправлен возможный сбой в случае, если был получен `unknown packet` от удалённого запроса (при включённой настройке `async_socket_for_remote`). Исправляет [#21167](https://github.com/ClickHouse/ClickHouse/issues/21167). [#23309](https://github.com/ClickHouse/ClickHouse/pull/23309) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено поведение, из-за которого отключение настройки `input_format_with_names_use_header ` приводило к отбрасыванию всех входных данных в формате CSVWithNames. Это исправляет [#22406](https://github.com/ClickHouse/ClickHouse/issues/22406). [#23202](https://github.com/ClickHouse/ClickHouse/pull/23202) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена проблема с тайм-аутом подключения к удалённому JDBC bridge. Закрывает [#9609](https://github.com/ClickHouse/ClickHouse/issues/9609). [#23771](https://github.com/ClickHouse/ClickHouse/pull/23771) ([Maksim Kita](https://github.com/kitaisreal), [alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена логика начальной загрузки `complex_key_hashed` при указанном `update_field`. Закрывает [#23800](https://github.com/ClickHouse/ClickHouse/issues/23800). [#23824](https://github.com/ClickHouse/ClickHouse/pull/23824) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлен сбой, возникавший при одновременном применении `PREWHERE` и фильтра политики строк при пустом результате. [#23763](https://github.com/ClickHouse/ClickHouse/pull/23763) ([Amos Bird](https://github.com/amosbird)).
* Предотвращена возможная ошибка &quot;Cannot schedule a task&quot; (в случае возникновения исключения) при выполнении INSERT в Distributed. [#23744](https://github.com/ClickHouse/ClickHouse/pull/23744) ([Azat Khuzhin](https://github.com/azat)).
* Добавлено исключение на случай полностью совпадающих значений в обеих выборках в агрегатной функции `mannWhitneyUTest`. Это исправляет [#23646](https://github.com/ClickHouse/ClickHouse/issues/23646). [#23654](https://github.com/ClickHouse/ClickHouse/pull/23654) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена ошибка сервера, из-за которой при вставке данных через HTTP возникало исключение. Это исправляет [#23512](https://github.com/ClickHouse/ClickHouse/issues/23512). [#23643](https://github.com/ClickHouse/ClickHouse/pull/23643) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена неверная интерпретация некоторых выражений `LIKE` с escape-последовательностями. [#23610](https://github.com/ClickHouse/ClickHouse/pull/23610) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Устранено зависание команды перезапуска/остановки. Закрывает [#20214](https://github.com/ClickHouse/ClickHouse/issues/20214). [#23552](https://github.com/ClickHouse/ClickHouse/pull/23552) ([filimonov](https://github.com/filimonov)).
* Исправлен сопоставитель `COLUMNS` в случае нескольких операторов JOIN в запросе SELECT. Закрывает [#22736](https://github.com/ClickHouse/ClickHouse/issues/22736). [#23501](https://github.com/ClickHouse/ClickHouse/pull/23501) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена ошибка, приводившая к аварийному завершению при изменении значения по умолчанию столбца, когда сам столбец используется как параметр `ReplacingMergeTree`. [#23483](https://github.com/ClickHouse/ClickHouse/pull/23483) ([hexiaoting](https://github.com/hexiaoting)).
* Исправлены нестандартные случаи при вертикальных слияниях с `ReplacingMergeTree`. В редких ситуациях они могли приводить к аварийному завершению слияний с исключениями вида `Incomplete granules are not allowed while blocks are granules size`. [#23459](https://github.com/ClickHouse/ClickHouse/pull/23459) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка, из-за которой было невозможно выполнить приведение типа из пустого массива-литерала к массиву с числом измерений больше 1, например `CAST([] AS Array(Array(String)))`. Закрывает [#14476](https://github.com/ClickHouse/ClickHouse/issues/14476). [#23456](https://github.com/ClickHouse/ClickHouse/pull/23456) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена ошибка, при которой агрегатная функция `deltaSum` возвращала некорректный результат после сброса счётчика. [#23437](https://github.com/ClickHouse/ClickHouse/pull/23437) ([Russ Frank](https://github.com/rf)).
* Исправлена ошибка `Cannot unlink file` при неудачном создании таблицы ReplicatedMergeTree с многодисковой конфигурацией. Тем самым закрыта [#21755](https://github.com/ClickHouse/ClickHouse/issues/21755). [#23433](https://github.com/ClickHouse/ClickHouse/pull/23433) ([tavplubix](https://github.com/tavplubix)).
* Исправлена генерация несовместимых константных выражений при отсечении партиций на основе виртуальных столбцов. Тем самым исправлена проблема, описанная в [https://github.com/ClickHouse/ClickHouse/pull/21401#discussion&#95;r611888913](https://github.com/ClickHouse/ClickHouse/pull/21401#discussion_r611888913). [#23366](https://github.com/ClickHouse/ClickHouse/pull/23366) ([Amos Bird](https://github.com/amosbird)).
* Исправлен сбой при установке параметра `join&#95;algorithm` в значение &#39;auto&#39; и выполнении операции JOIN с Dictionary. Закрыт [#23002](https://github.com/ClickHouse/ClickHouse/issues/23002). [#23312](https://github.com/ClickHouse/ClickHouse/pull/23312) ([Vladimir](https://github.com/vdimir)).
* Не ослаблять условия NOT при отсечении партиций. Это исправляет [#23305](https://github.com/ClickHouse/ClickHouse/issues/23305) и [#21539](https://github.com/ClickHouse/ClickHouse/issues/21539). [#23310](https://github.com/ClickHouse/ClickHouse/pull/23310) ([Amos Bird](https://github.com/amosbird)).
* Исправлено крайне редкое состояние гонки при фоновом удалении старых блоков. Оно могло приводить к тому, что блок не дедуплицировался, если он находился слишком близко к концу окна дедупликации. [#23301](https://github.com/ClickHouse/ClickHouse/pull/23301) ([tavplubix](https://github.com/tavplubix)).
* Исправлено крайне редкое (распределённое) состояние гонки между созданием и удалением таблиц ReplicatedMergeTree. В результате могли возникать исключения вида `node doesn't exist` при попытке создать реплицируемую таблицу. Исправляет [#21419](https://github.com/ClickHouse/ClickHouse/issues/21419). [#23294](https://github.com/ClickHouse/ClickHouse/pull/23294) ([tavplubix](https://github.com/tavplubix)).
* Исправлено создание словаря с простым ключом на основе DDL, если первичный ключ не является первым атрибутом. Исправлена [#23236](https://github.com/ClickHouse/ClickHouse/issues/23236). [#23262](https://github.com/ClickHouse/ClickHouse/pull/23262) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлено чтение из ODBC при большом количестве длинных имён столбцов в таблице. Закрывает [#8853](https://github.com/ClickHouse/ClickHouse/issues/8853). [#23215](https://github.com/ClickHouse/ClickHouse/pull/23215) ([Kseniia Sumarokova](https://github.com/kssenii)).
* MaterializeMySQL (экспериментальная функция): исправлена ошибка `Not found column`, возникавшая при выполнении запроса к `MaterializeMySQL` с условием по ключевому столбцу, что исправляет [#22432](https://github.com/ClickHouse/ClickHouse/issues/22432). [#23200](https://github.com/ClickHouse/ClickHouse/pull/23200) ([tavplubix](https://github.com/tavplubix)).
* Исправлена обработка алиасов, если подзапрос оптимизируется до константы. Исправляет [#22924](https://github.com/ClickHouse/ClickHouse/issues/22924). Исправляет [#10401](https://github.com/ClickHouse/ClickHouse/issues/10401). [#23191](https://github.com/ClickHouse/ClickHouse/pull/23191) ([Maksim Kita](https://github.com/kitaisreal)).
* Сервер мог не запускаться, если настройка `data_type_default_nullable` была включена в профиле по умолчанию; это исправлено. Исправляет [#22573](https://github.com/ClickHouse/ClickHouse/issues/22573). [#23185](https://github.com/ClickHouse/ClickHouse/pull/23185) ([tavplubix](https://github.com/tavplubix)).
* Исправлен сбой при завершении работы, возникавший из-за некорректного учета активных соединений. [#23154](https://github.com/ClickHouse/ClickHouse/pull/23154) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена ошибка `Table .inner_id... doesn't exist` при выполнении запроса SELECT к материализованному представлению после его отсоединения от базы данных Atomic и последующего повторного присоединения. [#23047](https://github.com/ClickHouse/ClickHouse/pull/23047) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка `Cannot find column in ActionsDAG result`, которая могла возникать при использовании в подзапросе функции `untuple`. Исправляет [#22290](https://github.com/ClickHouse/ClickHouse/issues/22290). [#22991](https://github.com/ClickHouse/ClickHouse/pull/22991) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено использование константных столбцов типа `Map` со значениями, допускающими `NULL`. [#22939](https://github.com/ClickHouse/ClickHouse/pull/22939) ([Anton Popov](https://github.com/CurtizJ)).
* исправлена работа `formatDateTime()` с `DateTime64` и спецификатором формата &quot;%C&quot;, исправлен `toDateTime64()` для больших значений и ненулевого масштаба. [#22937](https://github.com/ClickHouse/ClickHouse/pull/22937) ([Vasily Nemkov](https://github.com/Enmk)).
* Исправлена ошибка, приводившая к аварийному завершению работы при использовании `mannWhitneyUTest` и `rankCorr` с оконными функциями. Это исправляет [#22728](https://github.com/ClickHouse/ClickHouse/issues/22728). [#22876](https://github.com/ClickHouse/ClickHouse/pull/22876) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* LIVE VIEW (экспериментальная функция): исправлено возможное зависание при одновременном выполнении `DROP`/`CREATE` временного `LIVE VIEW` в `TemporaryLiveViewCleaner`, [см.](https://gist.github.com/vzakaznikov/0c03195960fc86b56bfe2bc73a90019e). [#22858](https://github.com/ClickHouse/ClickHouse/pull/22858) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено проталкивание условия `HAVING` в случае, когда столбец фильтра используется в агрегатной функции. [#22763](https://github.com/ClickHouse/ClickHouse/pull/22763) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены возможные зависания запросов к ZooKeeper при возникновении исключения OOM. Исправляет [#22438](https://github.com/ClickHouse/ClickHouse/issues/22438). [#22684](https://github.com/ClickHouse/ClickHouse/pull/22684) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено ожидание завершения мутаций на нескольких репликах для движков таблиц ReplicatedMergeTree. Ранее запрос ALTER/MUTATION мог завершиться до фактического выполнения мутации на других репликах. [#22669](https://github.com/ClickHouse/ClickHouse/pull/22669) ([alesapin](https://github.com/alesapin)).
* Исправлено исключение для Log с вложенными типами при отсутствии столбцов в списке SELECT. [#22654](https://github.com/ClickHouse/ClickHouse/pull/22654) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема бесконечного ожидания вспомогательных запросов к AWS. [#22594](https://github.com/ClickHouse/ClickHouse/pull/22594) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Исправлено падение при слишком раннем закрытии соединения клиентом [#22579](https://github.com/ClickHouse/ClickHouse/issues/22579). [#22591](https://github.com/ClickHouse/ClickHouse/pull/22591) ([nvartolomei](https://github.com/nvartolomei)).
* Тип данных `Map` (экспериментальная возможность): исправлено некорректное форматирование функции `map` в распределённых запросах. [#22588](https://github.com/ClickHouse/ClickHouse/pull/22588) ([foolchi](https://github.com/foolchi)).
* Исправлена десериализация пустой строки без завершающего символа новой строки в формате TSV. Это закрывает [#20244](https://github.com/ClickHouse/ClickHouse/issues/20244). Возможный обходной путь без обновления версии: установить `input_format_null_as_default` в значение 0. В старых версиях этот параметр по умолчанию был равен 0. [#22527](https://github.com/ClickHouse/ClickHouse/pull/22527) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено некорректное приведение столбца типа `LowCardinality` в алгоритме Merge Join. Закрывает [#22386](https://github.com/ClickHouse/ClickHouse/issues/22386), закрывает [#22388](https://github.com/ClickHouse/ClickHouse/issues/22388). [#22510](https://github.com/ClickHouse/ClickHouse/pull/22510) ([Vladimir](https://github.com/vdimir)).
* Могло произойти переполнение буфера (при чтении) в полнотекстовом индексе `tokenbf_v1`. Избыточные байты не используются, однако операция чтения в редких случаях могла приводить к аварийному завершению. Это закрывает [#19233](https://github.com/ClickHouse/ClickHouse/issues/19233). [#22421](https://github.com/ClickHouse/ClickHouse/pull/22421) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Не ограничивать размер HTTP-чанка. Исправляет [#21907](https://github.com/ClickHouse/ClickHouse/issues/21907). [#22322](https://github.com/ClickHouse/ClickHouse/pull/22322) ([Ivan](https://github.com/abyss7)).
* Исправлена ошибка, приводившая к недостаточной агрегации данных при включённом `optimize_aggregation_in_order` и большом количестве частей в таблице. Незначительно улучшена производительность агрегации при включённом `optimize_aggregation_in_order`. [#21889](https://github.com/ClickHouse/ClickHouse/pull/21889) ([Anton Popov](https://github.com/CurtizJ)).
* Проверяет, используется ли табличная функция view в качестве столбца. Дополняет #20350. [#21465](https://github.com/ClickHouse/ClickHouse/pull/21465) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка &quot;unknown column&quot; для таблиц с движком `Merge` в запросах с `JOIN` и агрегацией. Закрывает [#18368](https://github.com/ClickHouse/ClickHouse/issues/18368), закрывает [#22226](https://github.com/ClickHouse/ClickHouse/issues/22226). [#21370](https://github.com/ClickHouse/ClickHouse/pull/21370) ([Vladimir](https://github.com/vdimir)).
* Исправлены конфликты имён в pushdown-оптимизации. Это приводило к некорректной фильтрации по условию `WHERE` после FULL JOIN. Закрыта [#20497](https://github.com/ClickHouse/ClickHouse/issues/20497). [#20622](https://github.com/ClickHouse/ClickHouse/pull/20622) ([Vladimir](https://github.com/vdimir)).
* Исправлена крайне редкая ошибка, при котором кворумная вставка с `quorum_parallel=1` фактически не обеспечивала «кворум» из-за дедупликации. [#18215](https://github.com/ClickHouse/ClickHouse/pull/18215) ([filimonov](https://github.com/filimonov) — сообщил, [alesapin](https://github.com/alesapin) — исправил).

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-6}

- Запуск stateless-тестов в параллельном режиме в CI. [#22300](https://github.com/ClickHouse/ClickHouse/pull/22300) ([alesapin](https://github.com/alesapin)).
- Упрощение debian-пакетов. Исправляет [#21698](https://github.com/ClickHouse/ClickHouse/issues/21698). [#22976](https://github.com/ClickHouse/ClickHouse/pull/22976) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлена поддержка сборки ClickHouse на Apple M1. [#21639](https://github.com/ClickHouse/ClickHouse/pull/21639) ([changvvb](https://github.com/changvvb)).
- Исправлена сборка ClickHouse Keeper для macOS. [#22860](https://github.com/ClickHouse/ClickHouse/pull/22860) ([alesapin](https://github.com/alesapin)).
- Исправлены некоторые тесты на платформе AArch64. [#22596](https://github.com/ClickHouse/ClickHouse/pull/22596) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлено выравнивание функций для возможного повышения производительности. [#21431](https://github.com/ClickHouse/ClickHouse/pull/21431) ([Danila Kutenin](https://github.com/danlark1)).
- Корректировка некоторых тестов для вывода идентичных результатов на amd64 и aarch64 (qemu). Результат зависел от специфичного для реализации поведения процессора. [#22590](https://github.com/ClickHouse/ClickHouse/pull/22590) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Разрешено профилирование запросов только на x86_64. См. [#15174](https://github.com/ClickHouse/ClickHouse/issues/15174#issuecomment-812954965) и [#15638](https://github.com/ClickHouse/ClickHouse/issues/15638#issuecomment-703805337). Закрывает [#15638](https://github.com/ClickHouse/ClickHouse/issues/15638). [#22580](https://github.com/ClickHouse/ClickHouse/pull/22580) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Разрешена сборка с внешней библиотекой xz (lzma) с использованием опции CMake `USE_INTERNAL_XZ_LIBRARY=OFF`. [#22571](https://github.com/ClickHouse/ClickHouse/pull/22571) ([Kfir Itzhak](https://github.com/mastertheknife)).
- Включена встроенная библиотека `openldap` на `ppc64le` [#22487](https://github.com/ClickHouse/ClickHouse/pull/22487) ([Kfir Itzhak](https://github.com/mastertheknife)).
- Отключены несовместимые библиотеки (обычно специфичные для платформы) на `ppc64le` [#22475](https://github.com/ClickHouse/ClickHouse/pull/22475) ([Kfir Itzhak](https://github.com/mastertheknife)).
- Добавлен Jepsen-тест в CI для ClickHouse Keeper. [#22373](https://github.com/ClickHouse/ClickHouse/pull/22373) ([alesapin](https://github.com/alesapin)).
- Сборка `jemalloc` с поддержкой [профилирования кучи](https://github.com/jemalloc/jemalloc/wiki/Use-Case%3A-Heap-Profiling). [#22834](https://github.com/ClickHouse/ClickHouse/pull/22834) ([nvartolomei](https://github.com/nvartolomei)).
- Устранено неопределённое поведение в движках `*Log` при разблокировке rwlock из другого потока. [#22583](https://github.com/ClickHouse/ClickHouse/pull/22583) ([Azat Khuzhin](https://github.com/azat)).
- Исправлено неопределённое поведение путём разблокировки rwlock TinyLog из того же потока. [#22560](https://github.com/ClickHouse/ClickHouse/pull/22560) ([Azat Khuzhin](https://github.com/azat)).


## Релиз ClickHouse 21.4 {#clickhouse-release-214}

### Релиз ClickHouse 21.4.1 2021-04-12 {#clickhouse-release-2141-2021-04-12}

#### Обратно несовместимые изменения {#backward-incompatible-change-7}

- Функция `toStartOfIntervalFunction` теперь выравнивает часовые интервалы по полуночи (в предыдущих версиях они выравнивались по началу эпохи Unix). Например, `toStartOfInterval(x, INTERVAL 11 HOUR)` будет разделять каждый день на три интервала: `00:00:00..10:59:59`, `11:00:00..21:59:59` и `22:00:00..23:59:59`. Такое поведение лучше соответствует практическим потребностям. Закрывает issue [#9510](https://github.com/ClickHouse/ClickHouse/issues/9510). [#22060](https://github.com/ClickHouse/ClickHouse/pull/22060) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Параметры `Age` и `Precision` в конфигурациях свёртки graphite должны возрастать от одного периода хранения к другому. Теперь это проверяется, и некорректная конфигурация вызывает исключение. [#21496](https://github.com/ClickHouse/ClickHouse/pull/21496) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Исправлена ошибка в функциях `cutToFirstSignificantSubdomainCustom()`/`firstSignificantSubdomainCustom()`, возвращавших неверный результат для доменов третьего уровня и выше, присутствующих в пользовательском списке доменов верхнего уровня. Для входных доменов, соответствующих этим пользовательским доменам верхнего уровня, домен третьего уровня считался первым значимым. Теперь это исправлено. Это изменение может привести к несовместимости, если функция используется, например, в ключе шардирования. [#21946](https://github.com/ClickHouse/ClickHouse/pull/21946) ([Azat Khuzhin](https://github.com/azat)).
- Столбец `keys` в таблице `system.dictionaries` заменён на столбцы `key.names` и `key.types`. Столбцы `key.names`, `key.types`, `attribute.names`, `attribute.types` из таблицы `system.dictionaries` не требуют загрузки словаря. [#21884](https://github.com/ClickHouse/ClickHouse/pull/21884) ([Maksim Kita](https://github.com/kitaisreal)).
- Теперь реплики, обрабатывающие команду `ALTER TABLE ATTACH PART[ITION]`, сначала ищут данные в своих папках `detached/`, прежде чем получать их от других реплик. В качестве детали реализации в реплицируемый лог добавлена новая команда `ATTACH_PART`. Части ищутся и сравниваются по контрольным суммам. [#18978](https://github.com/ClickHouse/ClickHouse/pull/18978) ([Mike Kot](https://github.com/myrrc)). **Примечание**:
  - Запросы `ATTACH PART[ITION]` могут не работать во время обновления кластера.
  - Невозможно откатиться к более старой версии ClickHouse после выполнения запроса `ALTER ... ATTACH` в новой версии, так как старые серверы не смогут обработать запись `ATTACH_PART` в реплицируемом логе.
- В этой версии пустой элемент `<remote_url_allow_hosts></remote_url_allow_hosts>` будет блокировать весь доступ к удалённым хостам, тогда как в предыдущих версиях он ничего не делал. Если вы хотите сохранить старое поведение и у вас есть пустой элемент `remote_url_allow_hosts` в файле конфигурации, удалите его. [#20058](https://github.com/ClickHouse/ClickHouse/pull/20058) ([Vladimir Chebotarev](https://github.com/excitoon)).

#### Новые возможности {#new-feature-7}


* Расширен диапазон значений `DateTime64` для поддержки дат с 1925 по 2283 год. Улучшена поддержка `DateTime` в окрестности нулевой даты (`1970-01-01`). [#9404](https://github.com/ClickHouse/ClickHouse/pull/9404) ([alexey-milovidov](https://github.com/alexey-milovidov), [Vasily Nemkov](https://github.com/Enmk)). Не все функции работы с датой и временем корректно работают в расширенном диапазоне дат.
* Добавлена поддержка аутентификации Kerberos для предварительно настроенных пользователей и HTTP‑запросов (GSS-SPNEGO). [#14995](https://github.com/ClickHouse/ClickHouse/pull/14995) ([Denis Glazachev](https://github.com/traceon)).
* Добавлена настройка `prefer_column_name_to_alias` для использования оригинальных имён столбцов вместо их псевдонимов. Это необходимо для большей совместимости с правилами задания псевдонимов в распространённых СУБД. Относится к [#9715](https://github.com/ClickHouse/ClickHouse/issues/9715) и [#9887](https://github.com/ClickHouse/ClickHouse/issues/9887). [#22044](https://github.com/ClickHouse/ClickHouse/pull/22044) ([Amos Bird](https://github.com/amosbird)).
* Добавлены функции `dictGetChildren(dictionary, key)`, `dictGetDescendants(dictionary, key, level)`. Функция `dictGetChildren` возвращает всех дочерних элементов в виде массива индексов. Это операция, обратная `dictGetHierarchy`. Функция `dictGetDescendants` возвращает всех потомков так, как если бы `dictGetChildren` была применена рекурсивно `level` раз. Нулевое значение `level` эквивалентно бесконечности. Закрывает [#14656](https://github.com/ClickHouse/ClickHouse/issues/14656). [#22096](https://github.com/ClickHouse/ClickHouse/pull/22096) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлен источник словаря `executable_pool`. Закрыта задача [#14528](https://github.com/ClickHouse/ClickHouse/issues/14528). [#21321](https://github.com/ClickHouse/ClickHouse/pull/21321) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена табличная функция `dictionary`. Она работает аналогично движку `Dictionary`. Закрывает [#21560](https://github.com/ClickHouse/ClickHouse/issues/21560). [#21910](https://github.com/ClickHouse/ClickHouse/pull/21910) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена поддержка типа данных `Nullable` для атрибута `PolygonDictionary`. [#21890](https://github.com/ClickHouse/ClickHouse/pull/21890) ([Maksim Kita](https://github.com/kitaisreal)).
* Функции `dictGet`, `dictHas` используют текущее имя базы данных, если для словарей, созданных с помощью DDL, не указано имя базы данных. Закрывает [#21632](https://github.com/ClickHouse/ClickHouse/issues/21632). [#21859](https://github.com/ClickHouse/ClickHouse/pull/21859) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена функция `dictGetOrNull`. Она работает как `dictGet`, но возвращает `Null`, если ключ не был найден в словаре. Закрывает [#22375](https://github.com/ClickHouse/ClickHouse/issues/22375). [#22413](https://github.com/ClickHouse/ClickHouse/pull/22413) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлено асинхронное обновление в словари `ComplexKeyCache`, `SSDCache`, `SSDComplexKeyCache`. Добавлена поддержка типа `Nullable` в словарях `Cache`, `ComplexKeyCache`, `SSDCache`, `SSDComplexKeyCache`. Добавлена поддержка выборки нескольких атрибутов с помощью функций `dictGet`, `dictGetOrDefault`. Исправлена ошибка [#21517](https://github.com/ClickHouse/ClickHouse/issues/21517). [#20595](https://github.com/ClickHouse/ClickHouse/pull/20595) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена поддержка функции `dictHas` для `RangeHashedDictionary`. Исправлена [#6680](https://github.com/ClickHouse/ClickHouse/issues/6680). [#19816](https://github.com/ClickHouse/ClickHouse/pull/19816) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена функция `timezoneOf`, возвращающая имя часового пояса для типов данных `DateTime` или `DateTime64`. При этом не закрывается задача [#9959](https://github.com/ClickHouse/ClickHouse/issues/9959). Исправлены несоответствия в именах функций: добавлены алиасы `timezone` и `timeZone`, а также `toTimezone` и `toTimeZone`, `timezoneOf` и `timeZoneOf`. [#22001](https://github.com/ClickHouse/ClickHouse/pull/22001) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлен новый необязательный параметр `GRANTEES` для команд `CREATE/ALTER USER`. Он задает пользователей или роли, которым разрешено получать права от этого пользователя при условии, что у этого пользователя также есть все необходимые права, выданные с опцией делегирования (grant option). По умолчанию используется `GRANTEES ANY`, что означает, что пользователь с опцией делегирования может выдавать права кому угодно. Синтаксис: `CREATE USER ... GRANTEES {user | role | ANY | NONE} [,...] [EXCEPT {user | role} [,...]]`. [#21641](https://github.com/ClickHouse/ClickHouse/pull/21641) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлен новый столбец `slowdowns_count` в таблицу `system.clusters`. При использовании hedged‑запросов он показывает, сколько раз происходило переключение на другую реплику из‑за медленного ответа текущей реплики. Также в `system.clusters` теперь отображается фактическое значение `errors_count`. [#21480](https://github.com/ClickHouse/ClickHouse/pull/21480) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен виртуальный столбец `_partition_id` для движков семейства `MergeTree*`. Добавлена возможность отбрасывать партиции по `_partition_id`. Добавлена функция `partitionID()` для вычисления строкового идентификатора партиции. [#21401](https://github.com/ClickHouse/ClickHouse/pull/21401) ([Amos Bird](https://github.com/amosbird)).
* Добавлена функция `isIPAddressInRange`, которая проверяет, входит ли IPv4- или IPv6-адрес в указанный префикс сети CIDR. [#21329](https://github.com/ClickHouse/ClickHouse/pull/21329) ([PHO](https://github.com/depressed-pho)).
* Добавлена новая команда SQL `ALTER TABLE 'table_name' UNFREEZE [PARTITION 'part_expr'] WITH NAME 'backup_name'`. Эта команда необходима для корректного удаления &#39;freezed&#39; (замороженных) разделов со всех дисков. [#21142](https://github.com/ClickHouse/ClickHouse/pull/21142) ([Pavel Kovalenko](https://github.com/Jokser)).
* Добавлена поддержка неявного преобразования типа ключа для JOIN. [#19885](https://github.com/ClickHouse/ClickHouse/pull/19885) ([Vladimir](https://github.com/vdimir)).

#### Экспериментальная функциональность {#experimental-feature-6}

- Поддержка фрейма `RANGE OFFSET` (для оконных функций) для типов с плавающей точкой. Реализованы оконные функции `lagInFrame`/`leadInFrame`, которые аналогичны `lag`/`lead`, но учитывают границы окна. Они идентичны, когда фрейм задан как `between unbounded preceding and unbounded following`. Закрывает [#5485](https://github.com/ClickHouse/ClickHouse/issues/5485). [#21895](https://github.com/ClickHouse/ClickHouse/pull/21895) ([Alexander Kuzmenkov](https://github.com/akuzm)).
- Репликация без копирования для `ReplicatedMergeTree` при использовании хранилища S3. [#16240](https://github.com/ClickHouse/ClickHouse/pull/16240) ([ianton-ru](https://github.com/ianton-ru)).
- Добавлена возможность миграции существующего диска S3 на схему с поддержкой резервного копирования и восстановления. [#22070](https://github.com/ClickHouse/ClickHouse/pull/22070) ([Pavel Kovalenko](https://github.com/Jokser)).

#### Улучшение производительности {#performance-improvement-7}

- Поддержка параллельного форматирования в `clickhouse-local` и других компонентах. [#21630](https://github.com/ClickHouse/ClickHouse/pull/21630) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Поддержка параллельного разбора для форматов `CSVWithNames` и `TSVWithNames`. Закрывает [#21085](https://github.com/ClickHouse/ClickHouse/issues/21085). [#21149](https://github.com/ClickHouse/ClickHouse/pull/21149) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Включено чтение с использованием mmap IO для диапазонов файлов от 64 МиБ (настройка `min_bytes_to_use_mmap_io`). Это может привести к умеренному улучшению производительности. [#22326](https://github.com/ClickHouse/ClickHouse/pull/22326) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлен кеш для файлов, читаемых с настройкой `min_bytes_to_use_mmap_io`. Это обеспечивает значительное (в 2 раза и более) улучшение производительности при малом значении настройки за счет предотвращения частых вызовов mmap/munmap и последующих ошибок страниц. Обратите внимание, что mmap IO имеет существенные недостатки, которые делают его менее надежным в промышленной эксплуатации (например, зависание или SIGBUS на неисправных дисках; менее контролируемое использование памяти). Тем не менее, он хорошо показывает себя в бенчмарках. [#22206](https://github.com/ClickHouse/ClickHouse/pull/22206) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Устранено ненужное копирование данных при использовании кодека `NONE`. Обратите внимание, что кодек `NONE` в основном бесполезен — рекомендуется всегда использовать сжатие (`LZ4` используется по умолчанию). Вопреки распространенному мнению, отключение сжатия может не улучшить производительность (возможен обратный эффект). Кодек `NONE` полезен в некоторых случаях: когда данные несжимаемы; для синтетических бенчмарков. [#22145](https://github.com/ClickHouse/ClickHouse/pull/22145) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Ускорена работа `GROUP BY` с малым значением `max_rows_to_group_by` и `group_by_overflow_mode='any'`. [#21856](https://github.com/ClickHouse/ClickHouse/pull/21856) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Оптимизирована производительность запросов вида `SELECT ... FINAL ... WHERE`. Теперь в запросах с `FINAL` разрешено перемещать в `PREWHERE` столбцы, которые входят в ключ сортировки. [#21830](https://github.com/ClickHouse/ClickHouse/pull/21830) ([foolchi](https://github.com/foolchi)).
- Улучшена производительность путем замены `memcpy` на другую реализацию. Закрывает [#18583](https://github.com/ClickHouse/ClickHouse/issues/18583). [#21520](https://github.com/ClickHouse/ClickHouse/pull/21520) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Улучшена производительность агрегации в порядке ключа сортировки (при включенной настройке `optimize_aggregation_in_order`). [#19401](https://github.com/ClickHouse/ClickHouse/pull/19401) ([Anton Popov](https://github.com/CurtizJ)).

#### Улучшение {#improvement-7}


* Добавлен пул подключений для движка таблицы/базы данных PostgreSQL и источника словаря. Должно исправить [#21444](https://github.com/ClickHouse/ClickHouse/issues/21444). [#21839](https://github.com/ClickHouse/ClickHouse/pull/21839) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка нестандартной схемы таблицы для хранилища `postgres` и табличной функции. Закрывает [#21701](https://github.com/ClickHouse/ClickHouse/issues/21701). [#21711](https://github.com/ClickHouse/ClickHouse/pull/21711) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка приоритета реплик для источника словаря Postgres. [#21710](https://github.com/ClickHouse/ClickHouse/pull/21710) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Введена новая настройка merge tree `min_bytes_to_rebalance_partition_over_jbod`, которая позволяет сбалансированно распределять новые части по разным дискам тома JBOD. [#16481](https://github.com/ClickHouse/ClickHouse/pull/16481) ([Amos Bird](https://github.com/amosbird)).
* В `system.query_log` для соответствующих запросов добавлены значения `Grant`, `Revoke` и `System` столбца `query_kind`. [#21102](https://github.com/ClickHouse/ClickHouse/pull/21102) ([Vasily Nemkov](https://github.com/Enmk)).
* Добавлена возможность настраивать таймауты HTTP‑соединений, используемых для репликации, независимо от других HTTP‑таймаутов. [#20088](https://github.com/ClickHouse/ClickHouse/pull/20088) ([nvartolomei](https://github.com/nvartolomei)).
* Улучшено сообщение об исключении в клиенте в случае возникновения исключения во время записи блоков сервером. В предыдущих версиях клиент мог получать вводящее в заблуждение сообщение вида `Data compressed with different methods`. [#22427](https://github.com/ClickHouse/ClickHouse/pull/22427) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка `Directory tmp_fetch_XXX already exists`, которая могла возникать после неудачной операции fetch части. Временный каталог fetch удаляется, если он уже существует. Исправляет [#14197](https://github.com/ClickHouse/ClickHouse/issues/14197). [#22411](https://github.com/ClickHouse/ClickHouse/pull/22411) ([nvartolomei](https://github.com/nvartolomei)).
* Исправлен отчёт инструмента MSan для функции `range` с аргументом `UInt256` (поддержка больших целых чисел пока является экспериментальной). Закрывает [#22157](https://github.com/ClickHouse/ClickHouse/issues/22157). [#22387](https://github.com/ClickHouse/ClickHouse/pull/22387) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлен столбец `current_database` в таблицу `system.processes`. Он содержит текущую базу данных, к которой относится запрос. [#22365](https://github.com/ClickHouse/ClickHouse/pull/22365) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Добавлены регистронезависимые поиск и навигация по истории, а также перемещение по частям слов в `clickhouse-client`. [#22105](https://github.com/ClickHouse/ClickHouse/pull/22105) ([Amos Bird](https://github.com/amosbird)).
* Если кортеж, состоящий из NULL-значений, например `(NULL, NULL)`, находится слева от оператора `IN`, а справа находятся кортежи без NULL, например `SELECT (NULL, NULL) IN ((0, 0), (3, 1))`, то возвращается 0 вместо генерации исключения о несовместимых типах. Такое выражение также может появиться в результате оптимизации запроса вида `SELECT (NULL, NULL) = (8, 0) OR (NULL, NULL) = (3, 2) OR (NULL, NULL) = (0, 0) OR (NULL, NULL) = (3, 1)`. Это закрывает [#22017](https://github.com/ClickHouse/ClickHouse/issues/22017). [#22063](https://github.com/ClickHouse/ClickHouse/pull/22063) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Обновлена используемая версия simdjson до 0.9.1, что исправило [#21984](https://github.com/ClickHouse/ClickHouse/issues/21984). [#22057](https://github.com/ClickHouse/ClickHouse/pull/22057) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлены регистронезависимые псевдонимы для функций `CONNECTION_ID()` и `VERSION()`, что решает проблему [#22028](https://github.com/ClickHouse/ClickHouse/issues/22028). [#22042](https://github.com/ClickHouse/ClickHouse/pull/22042) ([Eugene Klimov](https://github.com/Slach)).
* Добавлена опция `strict_increase` в функцию `windowFunnel`, чтобы учитывать каждое событие только один раз (решение [#21835](https://github.com/ClickHouse/ClickHouse/issues/21835)). [#22025](https://github.com/ClickHouse/ClickHouse/pull/22025) ([Vladimir](https://github.com/vdimir)).
* Если ключ партиционирования таблицы `MergeTree` не включает столбцы типов `Date` или `DateTime`, но включает ровно один столбец типа `DateTime64`, значения этого столбца отображаются в столбцах `min_time` и `max_time` таблиц `system.parts` и `system.parts_columns`. В таблицу `system.parts_columns` добавлены столбцы `min_time` и `max_time` (ранее имелось несоответствие с таблицей `system.parts`). Это закрывает [#18244](https://github.com/ClickHouse/ClickHouse/issues/18244). [#22011](https://github.com/ClickHouse/ClickHouse/pull/22011) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка настройки `replication_alter_partitions_sync=1` в `clickhouse-copier` для переноса партиций из вспомогательной таблицы в целевую таблицу. Уменьшены значения таймаутов по умолчанию. Исправлена проблема [#21911](https://github.com/ClickHouse/ClickHouse/issues/21911). [#21912](https://github.com/ClickHouse/ClickHouse/pull/21912) ([turbo jason](https://github.com/songenjie)).
* Отображать путь к каталогу данных таблиц `EmbeddedRocksDB` в системных таблицах. [#21903](https://github.com/ClickHouse/ClickHouse/pull/21903) ([tavplubix](https://github.com/tavplubix)).
* Добавлено событие профиля `HedgedRequestsChangeReplica`, таймаут чтения данных изменён с секунд на миллисекунды. [#21886](https://github.com/ClickHouse/ClickHouse/pull/21886) ([Kruglov Pavel](https://github.com/Avogar)).
* DiskS3 (экспериментальная функция, находится в разработке). Исправлена ошибка, из-за которой было невозможно переместить каталог, если каталог назначения не пуст и используется диск‑кэш. [#21837](https://github.com/ClickHouse/ClickHouse/pull/21837) ([Pavel Kovalenko](https://github.com/Jokser)).
* Улучшено форматирование типов данных `Array` и `Map` в веб-интерфейсе. [#21798](https://github.com/ClickHouse/ClickHouse/pull/21798) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Обновлять кластеры только если их конфигурации были изменены. [#21685](https://github.com/ClickHouse/ClickHouse/pull/21685) ([Kruglov Pavel](https://github.com/Avogar)).
* Реализовано распространение настроек запроса и сессии для распределённых DDL-запросов. Установите `distributed_ddl_entry_format_version` в значение 2, чтобы включить это. Добавлена настройка `distributed_ddl_output_mode`. Поддерживаемые режимы: `none`, `throw` (по умолчанию), `null_status_on_timeout` и `never_throw`. Прочие исправления и улучшения для движка базы данных `Replicated`. [#21535](https://github.com/ClickHouse/ClickHouse/pull/21535) ([tavplubix](https://github.com/tavplubix)).
* Если `PODArray` был создан с размером элемента, который не является ни делителем 16, ни кратным 16, это могло привести к переполнению буфера. В текущих релизах такой ошибки нет. [#21533](https://github.com/ClickHouse/ClickHouse/pull/21533) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлены столбцы `last_error_time`/`last_error_message`/`last_error_stacktrace`/`remote` для `system.errors`. [#21529](https://github.com/ClickHouse/ClickHouse/pull/21529) ([Azat Khuzhin](https://github.com/azat)).
* Добавлены псевдонимы `simpleJSONExtract/simpleJSONHas` для `visitParam/visitParamExtract{UInt, Int, Bool, Float, Raw, String}`. Исправлена ошибка #21383. [#21519](https://github.com/ClickHouse/ClickHouse/pull/21519) ([fastio](https://github.com/fastio)).
* Добавлена настройка `optimize_skip_unused_shards_limit` для ограничения числа значений ключа шардинга в `optimize_skip_unused_shards`. [#21512](https://github.com/ClickHouse/ClickHouse/pull/21512) ([Azat Khuzhin](https://github.com/azat)).
* Улучшен `clickhouse-format`, чтобы он не выбрасывал исключение при наличии лишних пробелов или комментария после последнего запроса, а также чтобы при форматировании `ASTInsertQuery` с данными он заблаговременно выбрасывал исключение с понятным сообщением. [#21311](https://github.com/ClickHouse/ClickHouse/pull/21311) ([flynn](https://github.com/ucasFL)).
* Улучшена поддержка целочисленных ключей для типа данных `Map`. [#21157](https://github.com/ClickHouse/ClickHouse/pull/21157) ([Anton Popov](https://github.com/CurtizJ)).
* MaterializeMySQL: попытка повторного подключения к MySQL при обрыве соединения. [#20961](https://github.com/ClickHouse/ClickHouse/pull/20961) ([Håvard Kvålen](https://github.com/havardk)).
* Расширена поддержка преобразования `CROSS JOIN` в `INNER JOIN` для большего числа случаев. [#20392](https://github.com/ClickHouse/ClickHouse/pull/20392) ([Vladimir](https://github.com/vdimir)).
* Не создавать пустые части данных при выполнении INSERT при включённой настройке `optimize_on_insert`. Исправляет [#20304](https://github.com/ClickHouse/ClickHouse/issues/20304). [#20387](https://github.com/ClickHouse/ClickHouse/pull/20387) ([Kruglov Pavel](https://github.com/Avogar)).
* `MaterializeMySQL`: добавлен minmax-индекс пропуска для столбца `_version`. [#20382](https://github.com/ClickHouse/ClickHouse/pull/20382) ([Stig Bakken](https://github.com/stigsb)).
* Добавлена опция `--backslash` для `clickhouse-format`, которая добавляет обратную косую черту в конец каждой строки форматированного запроса. [#21494](https://github.com/ClickHouse/ClickHouse/pull/21494) ([flynn](https://github.com/ucasFL)).
* Теперь ClickHouse не будет выбрасывать исключение `LOGICAL_ERROR` при попытке выполнить мутацию уже обработанной части. Исправляет [#22013](https://github.com/ClickHouse/ClickHouse/issues/22013). [#22291](https://github.com/ClickHouse/ClickHouse/pull/22291) ([alesapin](https://github.com/alesapin)).

#### Исправление ошибок {#bug-fix-6}


* Сокет удалён из epoll перед отменой приёмника пакетов в `HedgedConnections`, чтобы предотвратить возможное состояние гонки. Исправляет [#22161](https://github.com/ClickHouse/ClickHouse/issues/22161). [#22443](https://github.com/ClickHouse/ClickHouse/pull/22443) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен ранее отсутствовавший учёт памяти в процедурах параллельного разбора. В предыдущих версиях могло происходить переполнение памяти (OOM), когда результирующий набор данных содержал очень большие блоки. Закрывает [#22008](https://github.com/ClickHouse/ClickHouse/issues/22008). [#22425](https://github.com/ClickHouse/ClickHouse/pull/22425) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка, из-за которой могло возникать исключение, если в запросе `SELECT` используется константное условие `WHERE`, а в исходной таблице есть столбцы с именами, состоящими из одних цифр. [#22270](https://github.com/ClickHouse/ClickHouse/pull/22270) ([LiuNeng](https://github.com/liuneng1994)).
* Исправлена проблема с отменой запросов при `use_hedged_requests=0` и `async_socket_for_remote=1`. [#22183](https://github.com/ClickHouse/ClickHouse/pull/22183) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, приводившая к необработанному исключению в `InterserverIOHTTPHandler`. [#22146](https://github.com/ClickHouse/ClickHouse/pull/22146) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена точка входа Docker на случай, когда `http_port` не задан в конфигурации. [#22132](https://github.com/ClickHouse/ClickHouse/pull/22132) ([Ewout](https://github.com/devwout)).
* Исправлена ошибка `Invalid number of rows in Chunk` при использовании `JOIN` с `TOTALS` и `arrayJoin`. Закрывает [#19303](https://github.com/ClickHouse/ClickHouse/issues/19303). [#22129](https://github.com/ClickHouse/ClickHouse/pull/22129) ([Vladimir](https://github.com/vdimir)).
* Исправлено имя пула фоновых потоков, который использовался для опроса сообщений из Kafka. Движок Kafka с некорректным пулом потоков не будет забирать сообщения из очереди. [#22122](https://github.com/ClickHouse/ClickHouse/pull/22122) ([fastio](https://github.com/fastio)).
* Исправлена работа ожидания выполнения запросов `OPTIMIZE` и `ALTER` для табличных движков `ReplicatedMergeTree`. Теперь запрос не будет зависать, если таблица была отсоединена или произошёл перезапуск. [#22118](https://github.com/ClickHouse/ClickHouse/pull/22118) ([alesapin](https://github.com/alesapin)).
* Отключены `async_socket_for_remote`/`use_hedged_requests` для проблемных ядер Linux. [#22109](https://github.com/ClickHouse/ClickHouse/pull/22109) ([Azat Khuzhin](https://github.com/azat)).
* Docker entrypoint: не выполнять chown для `.` если `LOG_PATH` пустой. Закрывает [#22100](https://github.com/ClickHouse/ClickHouse/issues/22100). [#22102](https://github.com/ClickHouse/ClickHouse/pull/22102) ([filimonov](https://github.com/filimonov)).
* В функции `decrypt` отсутствовала проверка минимального размера данных, зашифрованных в режиме `AEAD`. Это устраняет проблему, описанную в [#21897](https://github.com/ClickHouse/ClickHouse/issues/21897). [#22064](https://github.com/ClickHouse/ClickHouse/pull/22064) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* В редких случаях операция слияния (merge) для `CollapsingMergeTree` может создать гранулу размером `index_granularity + 1` строк. Из‑за этого внутренняя проверка, добавленная в [#18928](https://github.com/ClickHouse/ClickHouse/issues/18928) (затрагивает версии 21.2 и 21.3), может завершиться ошибкой `Incomplete granules are not allowed while blocks are granules size`. Эта ошибка не позволяла выполнять слияние частей. [#21976](https://github.com/ClickHouse/ClickHouse/pull/21976) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Отменены изменения из [#15454](https://github.com/ClickHouse/ClickHouse/issues/15454), которые могли приводить к значительному росту использования памяти при загрузке внешних хешированных словарей. Это закрывает [#21935](https://github.com/ClickHouse/ClickHouse/issues/21935). [#21948](https://github.com/ClickHouse/ClickHouse/pull/21948) ([Maksim Kita](https://github.com/kitaisreal)).
* Предотвращено пересечение подстраховывающих подключений (ошибка `Unknown packet 9 from server`). [#21941](https://github.com/ClickHouse/ClickHouse/pull/21941) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено чтение HTTP POST-запроса с типом контента &quot;multipart/form-data&quot; в ряде случаев. [#21936](https://github.com/ClickHouse/ClickHouse/pull/21936) ([Ivan](https://github.com/abyss7)).
* Исправлены некорректные результаты `ORDER BY`, возникавшие, если запрос содержал оконные функции и была задействована оптимизация чтения в порядке первичного ключа. Исправлена ошибка [#21828](https://github.com/ClickHouse/ClickHouse/issues/21828). [#21915](https://github.com/ClickHouse/ClickHouse/pull/21915) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Исправлена взаимоблокировка при первом выполнении модели CatBoost. Закрывает [#13832](https://github.com/ClickHouse/ClickHouse/issues/13832). [#21844](https://github.com/ClickHouse/ClickHouse/pull/21844) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка, которая могла приводить к некорректным результатам запроса (и возможному сбою) при проталкивании условия `WHERE` или `HAVING` перед `GROUP BY`. Исправляет [#21773](https://github.com/ClickHouse/ClickHouse/issues/21773). [#21841](https://github.com/ClickHouse/ClickHouse/pull/21841) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Улучшена обработка ошибок и логирование в `WriteBufferFromS3`. [#21836](https://github.com/ClickHouse/ClickHouse/pull/21836) ([Pavel Kovalenko](https://github.com/Jokser)).
* Исправлены возможные падения агрегатных функций с комбинатором `Distinct` при использовании двухуровневой агрегации. Это дополнительное исправление к [#18365](https://github.com/ClickHouse/ClickHouse/pull/18365). Проблему можно было воспроизвести только в production-среде. [#21818](https://github.com/ClickHouse/ClickHouse/pull/21818) ([Amos Bird](https://github.com/amosbird)).
* Исправлен анализ индексов скалярных подзапросов. Тем самым устранена проблема [#21717](https://github.com/ClickHouse/ClickHouse/issues/21717), возникшая в [#18896](https://github.com/ClickHouse/ClickHouse/pull/18896). [#21766](https://github.com/ClickHouse/ClickHouse/pull/21766) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка для движков таблиц `ReplicatedMerge` при которой запрос `ALTER MODIFY COLUMN` не изменял тип столбца `Decimal`, если его размер (32 бита или 64 бита) не менялся. [#21728](https://github.com/ClickHouse/ClickHouse/pull/21728) ([alesapin](https://github.com/alesapin)).
* Исправлено потенциальное бесконечное ожидание при одновременном запуске `OPTIMIZE` и `DROP` для `ReplicatedMergeTree`. [#21716](https://github.com/ClickHouse/ClickHouse/pull/21716) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа функции `arrayElement` с типом `Map` для целочисленных константных аргументов. [#21699](https://github.com/ClickHouse/ClickHouse/pull/21699) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка SIGSEGV при обращении к отсутствующим атрибутам из `ip_trie` с `access_to_key_from_attributes`. [#21692](https://github.com/ClickHouse/ClickHouse/pull/21692) ([Azat Khuzhin](https://github.com/azat)).
* Сервер теперь начинает принимать подключения только после инициализации `DDLWorker` и словарей. [#21676](https://github.com/ClickHouse/ClickHouse/pull/21676) ([Azat Khuzhin](https://github.com/azat)).
* Добавлено преобразование типов для ключей таблиц типа `Join` (без него ранее возникал SIGSEGV). [#21646](https://github.com/ClickHouse/ClickHouse/pull/21646) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена отмена распределённых запросов (например, простого `SELECT` с `LIMIT` по нескольким шардам, то есть `select * from remote('127.{2,3}', system.numbers) limit 100`) при `async_socket_for_remote=1`. [#21643](https://github.com/ClickHouse/ClickHouse/pull/21643) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа `fsync_part_directory` при горизонтальном слиянии. [#21642](https://github.com/ClickHouse/ClickHouse/pull/21642) ([Azat Khuzhin](https://github.com/azat)).
* Удалены неизвестные столбцы из присоединённой таблицы в условии `WHERE` для запросов к внешним движкам баз данных (MySQL, PostgreSQL). close [#14614](https://github.com/ClickHouse/ClickHouse/issues/14614), close [#19288](https://github.com/ClickHouse/ClickHouse/issues/19288) (dup), close [#19645](https://github.com/ClickHouse/ClickHouse/issues/19645) (dup). [#21640](https://github.com/ClickHouse/ClickHouse/pull/21640) ([Vladimir](https://github.com/vdimir)).
* Вызывалась функция `std::terminate` при возникновении ошибки записи данных в S3. [#21624](https://github.com/ClickHouse/ClickHouse/pull/21624) ([Vladimir](https://github.com/vdimir)).
* Исправлена возможная ошибка `Cannot find column` при включённом `optimize_skip_unused_shards` и отсутствии шардов. [#21579](https://github.com/ClickHouse/ClickHouse/pull/21579) ([Azat Khuzhin](https://github.com/azat)).
* Если запрос содержит константное условие в секции `WHERE`, а настройка `optimize_skip_unused_shards` включена, все шарды могут быть пропущены, и запрос может вернуть некорректный пустой результат. [#21550](https://github.com/ClickHouse/ClickHouse/pull/21550) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка в табличной функции `clusterAllReplicas`, из-за которой возвращалось неверное значение `_shard_num`. Закрыто [#21481](https://github.com/ClickHouse/ClickHouse/issues/21481). [#21498](https://github.com/ClickHouse/ClickHouse/pull/21498) ([flynn](https://github.com/ucasFL)).
* Исправлена проблема, при которой таблица S3 продолжала использовать старые учетные данные после обновления конфигурации. [#21457](https://github.com/ClickHouse/ClickHouse/pull/21457) ([Grigory Pervakov](https://github.com/GrigoryPervakov)).
* Исправлено состояние гонки объекта SSL внутри `SecureSocket` в библиотеке Poco. [#21456](https://github.com/ClickHouse/ClickHouse/pull/21456) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлен разбор формата `Avro` для `Kafka`. Устранена проблема [#21437](https://github.com/ClickHouse/ClickHouse/issues/21437). [#21438](https://github.com/ClickHouse/ClickHouse/pull/21438) ([Ilya Golshtein](https://github.com/ilejn)).
* Исправлены тайм-ауты на приём и отправку, а также неблокирующее чтение в защищённом сокете. [#21429](https://github.com/ClickHouse/ClickHouse/pull/21429) ([Kruglov Pavel](https://github.com/Avogar)).
* Флаг `force_drop_table` не работал для `MATERIALIZED VIEW`; теперь это исправлено. Исправляет [#18943](https://github.com/ClickHouse/ClickHouse/issues/18943). [#20626](https://github.com/ClickHouse/ClickHouse/pull/20626) ([tavplubix](https://github.com/tavplubix)).
* Исправлен конфликт имён в `PredicateRewriteVisitor`. Он вызывал некорректную фильтрацию по условию `WHERE` после полного соединения (FULL JOIN). Закрыта [#20497](https://github.com/ClickHouse/ClickHouse/issues/20497). [#20622](https://github.com/ClickHouse/ClickHouse/pull/20622) ([Vladimir](https://github.com/vdimir)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-7}


* Добавлены тесты [Jepsen](https://github.com/jepsen-io/jepsen) для ClickHouse Keeper. [#21677](https://github.com/ClickHouse/ClickHouse/pull/21677) ([alesapin](https://github.com/alesapin)).
* Запуск stateless-тестов параллельно в CI. Зависит от [#22181](https://github.com/ClickHouse/ClickHouse/issues/22181). [#22300](https://github.com/ClickHouse/ClickHouse/pull/22300) ([alesapin](https://github.com/alesapin)).
* Включена проверка статуса для CI-прогонов [SQLancer](https://github.com/sqlancer/sqlancer). [#22015](https://github.com/ClickHouse/ClickHouse/pull/22015) ([Ilya Yatsishin](https://github.com/qoega)).
* Несколько подготовительных изменений для сборок под PowerPC: включено использование встроенной openldap на `ppc64le`. [#22487](https://github.com/ClickHouse/ClickHouse/pull/22487) ([Kfir Itzhak](https://github.com/mastertheknife)). Включена возможность компиляции на `ppc64le` с помощью Clang. [#22476](https://github.com/ClickHouse/ClickHouse/pull/22476) ([Kfir Itzhak](https://github.com/mastertheknife)). Исправлена сборка Boost на `ppc64le`. [#22474](https://github.com/ClickHouse/ClickHouse/pull/22474) ([Kfir Itzhak](https://github.com/mastertheknife)). Исправлена ошибка CMake, связанная с внутренней переменной CMake `CMAKE_ASM_COMPILE_OBJECT`, не установленной на `ppc64le`. [#22469](https://github.com/ClickHouse/ClickHouse/pull/22469) ([Kfir Itzhak](https://github.com/mastertheknife)). Исправлена проблема, из-за которой Fedora/RHEL/CentOS не находили `libclang_rt.builtins` на `ppc64le`. [#22458](https://github.com/ClickHouse/ClickHouse/pull/22458) ([Kfir Itzhak](https://github.com/mastertheknife)). Включена сборка с использованием `jemalloc` на `ppc64le`. [#22447](https://github.com/ClickHouse/ClickHouse/pull/22447) ([Kfir Itzhak](https://github.com/mastertheknife)). Исправлено встраивание конфигурации ClickHouse и встраивание часовых поясов cctz на `ppc64le`. [#22445](https://github.com/ClickHouse/ClickHouse/pull/22445) ([Kfir Itzhak](https://github.com/mastertheknife)). Исправлена компиляция на `ppc64le` и задействован корректный регистр указателя команд на `ppc64le`. [#22430](https://github.com/ClickHouse/ClickHouse/pull/22430) ([Kfir Itzhak](https://github.com/mastertheknife)).
* Библиотека S3 (AWS) вновь включена для `aarch64`. [#22484](https://github.com/ClickHouse/ClickHouse/pull/22484) ([Kfir Itzhak](https://github.com/mastertheknife)).
* Пакет `tzdata` добавлен в Docker-контейнеры, поскольку для чтения формата `ORC` он необходим. Это закрывает [#14156](https://github.com/ClickHouse/ClickHouse/issues/14156). [#22000](https://github.com/ClickHouse/ClickHouse/pull/22000) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* В Dockerfile образа `clickhouse-server` добавлены два аргумента: `deb_location` и `single_binary_location`. [#21977](https://github.com/ClickHouse/ClickHouse/pull/21977) ([filimonov](https://github.com/filimonov)).
* Добавлена возможность использовать clang-tidy с релизными сборками путём включения assert-проверок при его использовании. [#21914](https://github.com/ClickHouse/ClickHouse/pull/21914) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлено имя бинарных файлов llvm-12 в поиск в CMake-скриптах. Неявные преобразования констант для подавления предупреждений clang. Обновлены подмодули для сборки с CMake 3.19. Подавлена рекурсия при расширении макросов в библиотеке `readpassphrase`. Устаревший флаг `-fuse-ld` заменён на `--ld-path` для clang. [#21597](https://github.com/ClickHouse/ClickHouse/pull/21597) ([Ilya Yatsishin](https://github.com/qoega)).
* Обновлён `docker/test/testflows/runner/dockerd-entrypoint.sh` для использования Yandex dockerhub-proxy, так как Docker Hub ввёл очень жёсткие ограничения на частоту запросов [#21551](https://github.com/ClickHouse/ClickHouse/pull/21551) ([vzakaznikov](https://github.com/vzakaznikov)).
* Исправлена сборка динамической библиотеки на macOS. [#20184](https://github.com/ClickHouse/ClickHouse/pull/20184) ([nvartolomei](https://github.com/nvartolomei)).
* Добавлена опция `ctime` в `zookeeper-dump-tree`. Она позволяет выгружать время создания узла. [#21842](https://github.com/ClickHouse/ClickHouse/pull/21842) ([Ilya](https://github.com/HumanUser)).





## Релиз ClickHouse 21.3 (LTS) {#clickhouse-release-213-lts}

### Релиз ClickHouse v21.3, 2021-03-12 {#clickhouse-release-v213-2021-03-12}

#### Обратно несовместимые изменения {#backward-incompatible-change-8}

- Теперь запрещено создавать таблицы MergeTree в старом синтаксисе с TTL таблицы, поскольку он просто игнорируется. Подключение старых таблиц по-прежнему возможно. [#20282](https://github.com/ClickHouse/ClickHouse/pull/20282) ([alesapin](https://github.com/alesapin)).
- Теперь все регистронезависимые имена функций будут переписаны в их канонические представления. Это необходимо для маршрутизации запросов проекций (предстоящая возможность). [#20174](https://github.com/ClickHouse/ClickHouse/pull/20174) ([Amos Bird](https://github.com/amosbird)).
- Исправлено создание `TTL` в случаях, когда его выражение является функцией и совпадает с ключом `ORDER BY`. Теперь разрешается устанавливать пользовательскую агрегацию для столбцов первичного ключа в `TTL` с `GROUP BY`. Обратно несовместимо: для столбцов первичного ключа, которые не входят в `GROUP BY` и не заданы явно, теперь применяется функция `any` вместо `max` при истечении TTL. Также при использовании TTL с `WHERE` или `GROUP BY` вы можете столкнуться с исключениями при слияниях во время выполнения последовательного обновления. [#15450](https://github.com/ClickHouse/ClickHouse/pull/15450) ([Anton Popov](https://github.com/CurtizJ)).

#### Новые возможности {#new-feature-8}


- Добавлены настройки движка File: `engine_file_empty_if_not_exists` и `engine_file_truncate_on_insert`. [#20620](https://github.com/ClickHouse/ClickHouse/pull/20620) ([M0r64n](https://github.com/M0r64n)).
- Добавлена агрегатная функция `deltaSum` для суммирования разностей между последовательными строками. [#20057](https://github.com/ClickHouse/ClickHouse/pull/20057) ([Russ Frank](https://github.com/rf)).
- Новый столбец `event_time_microseconds` в таблице `system.part_log`. [#20027](https://github.com/ClickHouse/ClickHouse/pull/20027) ([Bharat Nallan](https://github.com/bharatnc)).
- Добавлена функция `timezoneOffset(datetime)`, которая возвращает смещение от UTC в секундах. Закрывает [#issue:19850](https://github.com/ClickHouse/ClickHouse/issues/19850). [#19962](https://github.com/ClickHouse/ClickHouse/pull/19962) ([keenwolf](https://github.com/keen-wolf)).
- Добавлена настройка `insert_shard_id` для поддержки вставки данных в конкретный шард распределённой таблицы. [#19961](https://github.com/ClickHouse/ClickHouse/pull/19961) ([flynn](https://github.com/ucasFL)).
- Функция `reinterpretAs` обновлена для поддержки больших целых чисел. Исправляет [#19691](https://github.com/ClickHouse/ClickHouse/issues/19691). [#19858](https://github.com/ClickHouse/ClickHouse/pull/19858) ([Maksim Kita](https://github.com/kitaisreal)).
- Добавлена поддержка пользовательских ключей шифрования на стороне сервера (заголовок `x-amz-server-side-encryption-customer-(key/md5)`) в клиенте S3. См. [ссылку](https://docs.aws.amazon.com/AmazonS3/latest/dev/ServerSideEncryptionCustomerKeys.html). Закрывает [#19428](https://github.com/ClickHouse/ClickHouse/issues/19428). [#19748](https://github.com/ClickHouse/ClickHouse/pull/19748) ([Vladimir Chebotarev](https://github.com/excitoon)).
- Добавлена опция `implicit_key` для источника словаря `executable`. Она позволяет не выводить ключ для каждой записи, если записи поступают в том же порядке, что и входные ключи. Реализует [#14527](https://github.com/ClickHouse/ClickHouse/issues/14527). [#19677](https://github.com/ClickHouse/ClickHouse/pull/19677) ([Maksim Kita](https://github.com/kitaisreal)).
- Добавлены типы квот `query_selects` и `query_inserts`. [#19603](https://github.com/ClickHouse/ClickHouse/pull/19603) ([JackyWoo](https://github.com/JackyWoo)).
- Добавлена функция `extractTextFromHTML` [#19600](https://github.com/ClickHouse/ClickHouse/pull/19600) ([zlx19950903](https://github.com/zlx19950903)), ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Таблицы с движком `MergeTree*` теперь имеют две новые настройки на уровне таблицы для управления параллелизмом запросов. Настройка `max_concurrent_queries` ограничивает количество одновременно выполняемых запросов, связанных с этой таблицей. Настройка `min_marks_to_honor_max_concurrent_queries` указывает применять предыдущую настройку только в том случае, если запрос читает как минимум указанное количество засечек. [#19544](https://github.com/ClickHouse/ClickHouse/pull/19544) ([Amos Bird](https://github.com/amosbird)).
- Добавлена функция `file` для чтения файла из директории user_files в виде строки. Это отличается от табличной функции `file`. Реализует [#issue:18851](https://github.com/ClickHouse/ClickHouse/issues/18851). [#19204](https://github.com/ClickHouse/ClickHouse/pull/19204) ([keenwolf](https://github.com/keen-wolf)).

#### Экспериментальная функциональность {#experimental-feature-7}


- Добавлен экспериментальный движок баз данных `Replicated`. Он реплицирует DDL-запросы между несколькими хостами. [#16193](https://github.com/ClickHouse/ClickHouse/pull/16193) ([tavplubix](https://github.com/tavplubix)).
- Введена экспериментальная поддержка оконных функций, включается параметром `allow_experimental_window_functions = 1`. Это предварительная реализация альфа-качества, которая не подходит для использования в production и будет изменена несовместимым образом в будущих релизах. Список поддерживаемых возможностей см. в [документации](https://github.com/ClickHouse/ClickHouse/blob/master/docs/sql-reference/window-functions/index.md#experimental-window-functions). [#20337](https://github.com/ClickHouse/ClickHouse/pull/20337) ([Alexander Kuzmenkov](https://github.com/akuzm)).
- Добавлена возможность резервного копирования и восстановления файлов метаданных для DiskS3. [#18377](https://github.com/ClickHouse/ClickHouse/pull/18377) ([Pavel Kovalenko](https://github.com/Jokser)).

#### Улучшение производительности {#performance-improvement-8}


* Хеджированные запросы при выполнении удалённых запросов. При включении параметра `use_hedged_requests` (по умолчанию выключен) можно устанавливать несколько подключений к разным репликам для одного запроса. Новое подключение создаётся в том случае, если существующее подключение (подключения) к репликам не было установлено в течение `hedged_connection_timeout` или данные не были получены в течение `receive_data_timeout`. Запрос использует первое подключение, которое отправит непустой пакет прогресса (или пакет с данными, если включён параметр `allow_changing_replica_until_first_data_packet`); остальные подключения отменяются. Поддерживаются запросы с `max_parallel_replicas > 1`. [#19291](https://github.com/ClickHouse/ClickHouse/pull/19291) ([Kruglov Pavel](https://github.com/Avogar)). Это позволяет значительно снизить задержки в хвосте распределения на очень больших кластерах.
* Добавлена поддержка `PREWHERE` (и включена соответствующая оптимизация) для таблиц, в которых заданы выражения безопасности на уровне строк. [#19576](https://github.com/ClickHouse/ClickHouse/pull/19576) ([Denis Glazachev](https://github.com/traceon)).
* Настройка `distributed_aggregation_memory_efficient` включена по умолчанию. Она снижает потребление памяти и улучшает производительность распределённых запросов. [#20599](https://github.com/ClickHouse/ClickHouse/pull/20599) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Повышена производительность GROUP BY по нескольким ключам фиксированного размера. [#20472](https://github.com/ClickHouse/ClickHouse/pull/20472) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Улучшена производительность агрегатных функций за счет более строгого соблюдения правил aliasing. [#19946](https://github.com/ClickHouse/ClickHouse/pull/19946) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Ускорено чтение из таблиц `Memory` в экстремальных случаях (когда скорость чтения порядка 50 ГБ/с) за счёт упрощения конвейера и, как следствие, снижения конкуренции за блокировки при планировании конвейера. [#20468](https://github.com/ClickHouse/ClickHouse/pull/20468) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Частично переработан HTTP-сервер, чтобы сократить количество копирований входящих и исходящих данных. Это даёт до 1,5-кратного прироста производительности при вставке длинных записей через HTTP. [#19516](https://github.com/ClickHouse/ClickHouse/pull/19516) ([Ivan](https://github.com/abyss7)).
* Добавлена настройка `compress` для таблиц `Memory`. Если она включена, таблица будет использовать меньше оперативной памяти. На некоторых машинах и для некоторых наборов данных она также может работать быстрее при выполнении SELECT, но так бывает не всегда. Это закрывает [#20093](https://github.com/ClickHouse/ClickHouse/issues/20093). Примечание: есть причины, по которым таблицы `Memory` могут работать медленнее, чем `MergeTree`: (1) отсутствие сжатия; (2) фиксированный размер блоков; (3) отсутствие индексов и prewhere... [#20168](https://github.com/ClickHouse/ClickHouse/pull/20168) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Незначительно улучшен код агрегации. [#20978](https://github.com/ClickHouse/ClickHouse/pull/20978) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Вернуть специализации `intDiv`/`modulo` для повышения производительности. Это исправляет [#21293](https://github.com/ClickHouse/ClickHouse/issues/21293). Регрессия была внесена в [https://github.com/ClickHouse/ClickHouse/pull/18145](https://github.com/ClickHouse/ClickHouse/pull/18145). [#21307](https://github.com/ClickHouse/ClickHouse/pull/21307) ([Amos Bird](https://github.com/amosbird)).
* Не выполнять слишком сильное сжатие блоков в INSERT SELECT при вставке в таблицу Memory. В предыдущих версиях после INSERT SELECT в таблице Memory создавалось неэффективное представление данных. Это закрывает [#13052](https://github.com/ClickHouse/ClickHouse/issues/13052). [#20169](https://github.com/ClickHouse/ClickHouse/pull/20169) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен как минимум один случай, когда парсер DataType мог работать с экспоненциальной сложностью (обнаружен фуззером). Это закрывает [#20096](https://github.com/ClickHouse/ClickHouse/issues/20096). [#20132](https://github.com/ClickHouse/ClickHouse/pull/20132) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Параллелизировать `SELECT` с `FINAL` для одного парта с уровнем &gt; 0, когда настройка `do_not_merge_across_partitions_select_final` равна 1. [#19375](https://github.com/ClickHouse/ClickHouse/pull/19375) ([Kruglov Pavel](https://github.com/Avogar)).
* Заполнять только запрошенные столбцы при выполнении запросов к `system.parts` и `system.parts_columns`. Закрывает [#19570](https://github.com/ClickHouse/ClickHouse/issues/19570). [#21035](https://github.com/ClickHouse/ClickHouse/pull/21035) ([Anmol Arora](https://github.com/anmolarora)).
* Выполнены алгебраические оптимизации арифметических выражений внутри агрегатной функции `avg`. Закрыт [#20092](https://github.com/ClickHouse/ClickHouse/issues/20092). [#20183](https://github.com/ClickHouse/ClickHouse/pull/20183) ([flynn](https://github.com/ucasFL)).

#### Улучшение {#improvement-8}


* Методы сжатия для табличных функций, не зависящие от регистра. Также исправлен метод сжатия LZMA, который распознавался только в верхнем регистре. [#21416](https://github.com/ClickHouse/ClickHouse/pull/21416) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Добавлены два параметра, позволяющие задерживать вставку или генерировать ошибку при вставке, когда существует слишком много неактивных частей. Это полезно, когда сервер не успевает достаточно быстро очищать части. [#20178](https://github.com/ClickHouse/ClickHouse/pull/20178) ([Amos Bird](https://github.com/amosbird)).
* Обеспечена более высокая совместимость с клиентами MySQL: 1. MySQL JDBC 2. mycli. [#21367](https://github.com/ClickHouse/ClickHouse/pull/21367) ([Amos Bird](https://github.com/amosbird)).
* Запрещено удалять столбец, если на него ссылается материализованное представление. Закрывает [#21164](https://github.com/ClickHouse/ClickHouse/issues/21164). [#21303](https://github.com/ClickHouse/ClickHouse/pull/21303) ([flynn](https://github.com/ucasFL)).
* Источник словаря MySQL теперь будет повторять попытку подключения при неожиданных сбоях (Lost connection to MySQL server during query), которые иногда происходят при соединениях по SSL/TLS. [#21237](https://github.com/ClickHouse/ClickHouse/pull/21237) ([Alexander Kazakov](https://github.com/Akazz)).
* Улучшение удобства использования: более единообразный разбор `DateTime64`: распознаётся случай, когда Unix timestamp с субсекундным разрешением задан как масштабированное целое число (например, `1111111111222` вместо `1111111111.222`). Это закрывает [#13194](https://github.com/ClickHouse/ClickHouse/issues/13194). [#21053](https://github.com/ClickHouse/ClickHouse/pull/21053) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Выполнять слияние отсортированных блоков только на инициаторе при использовании distributed&#95;group&#95;by&#95;no&#95;merge. [#20882](https://github.com/ClickHouse/ClickHouse/pull/20882) ([Azat Khuzhin](https://github.com/azat)).
* При загрузке конфигурации для источника MySQL ClickHouse теперь будет случайным образом перемешивать список реплик с одинаковым приоритетом, чтобы обеспечить round-robin‑логику выбора MySQL endpoint. Это закрывает [#20629](https://github.com/ClickHouse/ClickHouse/issues/20629). [#20632](https://github.com/ClickHouse/ClickHouse/pull/20632) ([Alexander Kazakov](https://github.com/Akazz)).
* Функция &#39;reinterpretAs(x, Type)&#39; была переименована в &#39;reinterpret(x, Type)&#39;. [#20611](https://github.com/ClickHouse/ClickHouse/pull/20611) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена поддержка vhost для движка RabbitMQ [#20576](https://github.com/ClickHouse/ClickHouse/issues/20576). [#20596](https://github.com/ClickHouse/ClickHouse/pull/20596) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Улучшена сериализация составных типов данных из `Array` и `Tuple`. Улучшено сопоставление типов данных Enum с типом enum в Protobuf. Исправлена сериализация типа данных `Map`. Пропущенным значениям теперь автоматически присваивается значение по умолчанию. [#20506](https://github.com/ClickHouse/ClickHouse/pull/20506) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено состояние гонки между выполнением распределённых DDL‑задач и очисткой очереди DDL. Теперь DDL‑задача не может быть удалена из ZooKeeper при наличии активных воркеров. Исправляет [#20016](https://github.com/ClickHouse/ClickHouse/issues/20016). [#20448](https://github.com/ClickHouse/ClickHouse/pull/20448) ([tavplubix](https://github.com/tavplubix)).
* Обеспечена корректная работа FQDN и других функций, связанных с DNS, в образах Alpine Linux. [#20336](https://github.com/ClickHouse/ClickHouse/pull/20336) ([filimonov](https://github.com/filimonov)).
* Не допускать раннего свёртывания констант для явно запрещённых функций. [#20303](https://github.com/ClickHouse/ClickHouse/pull/20303) ([Azat Khuzhin](https://github.com/azat)).
* Неявное преобразование из целого типа в тип Decimal могло выполняться успешно, даже если целое значение выходило за допустимые границы для типа Decimal. Теперь в таком случае генерируется `ARGUMENT_OUT_OF_BOUND`. [#20232](https://github.com/ClickHouse/ClickHouse/pull/20232) ([tavplubix](https://github.com/tavplubix)).
* Неблокирующая команда `SYSTEM FLUSH DISTRIBUTED`. [#20215](https://github.com/ClickHouse/ClickHouse/pull/20215) ([Azat Khuzhin](https://github.com/azat)).
* Нормализованы выражения вида count(constant) и sum(1) к count(). Это необходимо для маршрутизации запросов с использованием проекций. [#20175](https://github.com/ClickHouse/ClickHouse/pull/20175) ([Amos Bird](https://github.com/amosbird)).
* Поддержка всех встроенных целочисленных типов в bitmap‑функциях. [#20171](https://github.com/ClickHouse/ClickHouse/pull/20171) ([Amos Bird](https://github.com/amosbird)).
* Обновлены `CacheDictionary`, `ComplexCacheDictionary`, `SSDCacheDictionary`, `SSDComplexKeyDictionary` для использования LRUHashMap в качестве базового индекса. [#20164](https://github.com/ClickHouse/ClickHouse/pull/20164) ([Maksim Kita](https://github.com/kitaisreal)).
* Настройку `access_management` теперь можно задавать при запуске с помощью переменной `CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT`; по умолчанию она отключена (`0`), как и раньше. [#20139](https://github.com/ClickHouse/ClickHouse/pull/20139) ([Marquitos](https://github.com/sonirico)).
* Исправление `toDateTime64(toDate()/toDateTime())` для `DateTime64` — реализовано ограничение значений `DateTime64`, соответствующее поведению `DateTime`. [#20131](https://github.com/ClickHouse/ClickHouse/pull/20131) ([Azat Khuzhin](https://github.com/azat)).
* Улучшения работы с квотами: `SHOW TABLES` теперь учитывается как один запрос при расчёте квоты, а не два. Запросы `SYSTEM` теперь потребляют квоту. Исправлен расчёт конца интервала при вычислении потребления квоты. [#20106](https://github.com/ClickHouse/ClickHouse/pull/20106) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена поддержка выражений `path IN (set)` в таблице `system.zookeeper`. [#20105](https://github.com/ClickHouse/ClickHouse/pull/20105) ([小路](https://github.com/nicelulu)).
* Отображать полную информацию о таблицах `MaterializeMySQL` в `system.tables`. [#20051](https://github.com/ClickHouse/ClickHouse/pull/20051) ([Stig Bakken](https://github.com/stigsb)).
* Исправлена гонка данных в исполняемом словаре, которая могла возникать только при неправильном использовании (когда скрипт возвращает данные, игнорируя свой вход). [#20045](https://github.com/ClickHouse/ClickHouse/pull/20045) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Значением опции MYSQL&#95;OPT&#95;RECONNECT теперь можно управлять с помощью параметра &quot;opt&#95;reconnect&quot; в секции config реплики MySQL. [#19998](https://github.com/ClickHouse/ClickHouse/pull/19998) ([Alexander Kazakov](https://github.com/Akazz)).
* Если пользователь вызывает функцию `JSONExtract` с запрошенным типом `Float32`, допускается неточное преобразование к результирующему типу. Например, число `0.1` в JSON имеет двойную точность и не может быть представлено в `Float32`, но пользователь всё равно хочет его получить. В предыдущих версиях возвращалось 0 для не-Nullable типа и NULL для Nullable-типа, чтобы указать, что преобразование неточно. Логика была на 100% корректной, но это удивляло пользователей и вызывало вопросы. Это закрывает [#13962](https://github.com/ClickHouse/ClickHouse/issues/13962). [#19960](https://github.com/ClickHouse/ClickHouse/pull/19960) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлено преобразование структуры блоков при INSERT в таблицы Distributed, если она не совпадает. [#19947](https://github.com/ClickHouse/ClickHouse/pull/19947) ([Azat Khuzhin](https://github.com/azat)).
* Улучшение для таблицы `system.distributed_ddl_queue`. Инициализировать MaxDDLEntryID последним значением после перезапуска. До этого PR значение MaxDDLEntryID оставалось нулевым, пока не обрабатывалась новая задача DDL. [#19924](https://github.com/ClickHouse/ClickHouse/pull/19924) ([Amos Bird](https://github.com/amosbird)).
* Отображать таблицы `MaterializeMySQL` в таблице `system.parts`. [#19770](https://github.com/ClickHouse/ClickHouse/pull/19770) ([Stig Bakken](https://github.com/stigsb)).
* Добавлена отдельная директива конфигурации для профиля `Buffer`. [#19721](https://github.com/ClickHouse/ClickHouse/pull/19721) ([Azat Khuzhin](https://github.com/azat)).
* Перенесены условия, не относящиеся к JOIN, в предложение WHERE. [#18720](https://github.com/ClickHouse/ClickHouse/issues/18720). [#19685](https://github.com/ClickHouse/ClickHouse/pull/19685) ([hexiaoting](https://github.com/hexiaoting)).
* Добавлена возможность ограничивать скорость операций INSERT в `Distributed` на основе объёма байт в очереди на асинхронную отправку (для движка `Distributed` добавлены настройки `bytes_to_delay_insert`/`max_delay_to_insert` и `bytes_to_throw_insert`). [#19673](https://github.com/ClickHouse/ClickHouse/pull/19673) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены редкие случаи, когда ошибки записи могли быть проигнорированы в деструкторах. [#19451](https://github.com/ClickHouse/ClickHouse/pull/19451) ([Azat Khuzhin](https://github.com/azat)).
* Выводить inline-фреймы в трассировках стека для фатальных ошибок. [#19317](https://github.com/ClickHouse/ClickHouse/pull/19317) ([Ivan](https://github.com/abyss7)).

#### Исправление ошибок {#bug-fix-7}


* Исправлены избыточные переподключения к ZooKeeper, а также возможность одновременного существования двух активных сессий для одного сервера ClickHouse. Обе проблемы появились в #14678. [#21264](https://github.com/ClickHouse/ClickHouse/pull/21264) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка `Bad cast from type ... to DB::ColumnLowCardinality` при вставке данных в таблицу со столбцом `LowCardinality` из формата `Values`. Исправление для #21140 [#21357](https://github.com/ClickHouse/ClickHouse/pull/21357) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена взаимоблокировка в мутациях `ALTER DELETE` для нереплицируемых движков таблиц MergeTree, когда предикат ссылается на эту же таблицу. Исправляет [#20558](https://github.com/ClickHouse/ClickHouse/issues/20558). [#21477](https://github.com/ClickHouse/ClickHouse/pull/21477) ([alesapin](https://github.com/alesapin)).
* Исправлено возникновение SIGSEGV при сбоях в распределённых запросах. [#21434](https://github.com/ClickHouse/ClickHouse/pull/21434) ([Azat Khuzhin](https://github.com/azat)).
* Теперь запросы `ALTER MODIFY COLUMN` будут корректно применять изменения к ключу партиционирования, пропускающим индексам, TTL и т. д. Исправляет [#13675](https://github.com/ClickHouse/ClickHouse/issues/13675). [#21334](https://github.com/ClickHouse/ClickHouse/pull/21334) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка при использовании `join_use_nulls` и при соединении `TOTALS` из подзапросов. Это закрывает [#19362](https://github.com/ClickHouse/ClickHouse/issues/19362) и [#21137](https://github.com/ClickHouse/ClickHouse/issues/21137). [#21248](https://github.com/ClickHouse/ClickHouse/pull/21248) ([vdimir](https://github.com/vdimir)).
* Исправлено падение `EXPLAIN` для запроса с `UNION`. Исправлены [#20876](https://github.com/ClickHouse/ClickHouse/issues/20876), [#21170](https://github.com/ClickHouse/ClickHouse/issues/21170). [#21246](https://github.com/ClickHouse/ClickHouse/pull/21246) ([flynn](https://github.com/ucasFL)).
* Теперь мутации разрешены только для движков таблиц, которые их поддерживают (семейство MergeTree, Memory, MaterializedView). Остальные движки будут выдавать более понятную ошибку. Исправляет [#21168](https://github.com/ClickHouse/ClickHouse/issues/21168). [#21183](https://github.com/ClickHouse/ClickHouse/pull/21183) ([alesapin](https://github.com/alesapin)).
* Исправление [#21112](https://github.com/ClickHouse/ClickHouse/issues/21112). Исправлена ошибка, из-за которой могли появляться дубликаты при выполнении запроса `INSERT` (если один из callback-ов срабатывал слишком поздно). [#21138](https://github.com/ClickHouse/ClickHouse/pull/21138) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено, чтобы `input_format_null_as_default` корректно применялся к nullable-типам. Это исправляет [#21116](https://github.com/ClickHouse/ClickHouse/issues/21116). [#21121](https://github.com/ClickHouse/ClickHouse/pull/21121) ([Amos Bird](https://github.com/amosbird)).
* исправлена ошибка, связанная с приведением типа `Tuple` к `Map`. Закрывает [#21029](https://github.com/ClickHouse/ClickHouse/issues/21029). [#21120](https://github.com/ClickHouse/ClickHouse/pull/21120) ([hexiaoting](https://github.com/hexiaoting)).
* Исправлена утечка метаданных при удалении таблицы Replicated*MergeTree с нестандартным (не по умолчанию) кластером ZooKeeper. [#21119](https://github.com/ClickHouse/ClickHouse/pull/21119) ([fastio](https://github.com/fastio)).
* Исправлена ошибка несоответствия типов при использовании ключей LowCardinality в функции joinGet. Она устраняет [#21114](https://github.com/ClickHouse/ClickHouse/issues/21114). [#21117](https://github.com/ClickHouse/ClickHouse/pull/21117) ([Amos Bird](https://github.com/amosbird)).
* Исправлена проблема, из-за которой значения default&#95;replica&#95;path и default&#95;replica&#95;name не использовались в движке Replicated(*)MergeTree, если требовалось указывать другие параметры двигателя. [#21060](https://github.com/ClickHouse/ClickHouse/pull/21060) ([mxzlxy](https://github.com/mxzlxy)).
* Был возможен выход за пределы памяти при форматировании специально подобранного значения типа `DateTime64`, выходящего за допустимый диапазон. Это закрывает [#20494](https://github.com/ClickHouse/ClickHouse/issues/20494). Это закрывает [#20543](https://github.com/ClickHouse/ClickHouse/issues/20543). [#21023](https://github.com/ClickHouse/ClickHouse/pull/21023) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Запрещены параллельные вставки в хранилище Join. [#21009](https://github.com/ClickHouse/ClickHouse/pull/21009) ([vdimir](https://github.com/vdimir)).
* Исправлено поведение, при котором `ALTER MODIFY COLUMN` создавал мутацию, заведомо завершающуюся ошибкой. [#21007](https://github.com/ClickHouse/ClickHouse/pull/21007) ([Anton Popov](https://github.com/CurtizJ)).
* Закрывает [#9969](https://github.com/ClickHouse/ClickHouse/issues/9969). Исправлена ошибка HTTP-сжатия Brotli, которая воспроизводилась для больших объёмов данных со слегка сложной структурой и при использовании формата вывода JSON. Brotli обновлён до последней версии, включающей «исправление редкого обращения к неинициализированным данным в кольцевом буфере». [#20991](https://github.com/ClickHouse/ClickHouse/pull/20991) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка «Empty task was returned from async task queue», возникающая при отмене запроса. [#20881](https://github.com/ClickHouse/ClickHouse/pull/20881) ([Azat Khuzhin](https://github.com/azat)).
* Запрос `USE database;` не работал при подключении к серверу ClickHouse с помощью клиента MySQL 5.7; проблема исправлена. Исправлена [#18926](https://github.com/ClickHouse/ClickHouse/issues/18926). [#20878](https://github.com/ClickHouse/ClickHouse/pull/20878) ([tavplubix](https://github.com/tavplubix)).
* Исправлено использование комбинатора `-Distinct` совместно с комбинатором `-State` в агрегатных функциях. [#20866](https://github.com/ClickHouse/ClickHouse/pull/20866) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен подзапрос с `UNION DISTINCT` и оператором `LIMIT`. Закрыт [#20597](https://github.com/ClickHouse/ClickHouse/issues/20597). [#20610](https://github.com/ClickHouse/ClickHouse/pull/20610) ([flynn](https://github.com/ucasFL)).
* Исправлено непоследовательное поведение словаря в запросах, в которых выполняется поиск отсутствующих ключей. [#20578](https://github.com/ClickHouse/ClickHouse/pull/20578) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлено число потоков для скалярных подзапросов и подзапросов по индексу (после [#19007](https://github.com/ClickHouse/ClickHouse/issues/19007) всегда использовался один поток). Исправляет [#20457](https://github.com/ClickHouse/ClickHouse/issues/20457), [#20512](https://github.com/ClickHouse/ClickHouse/issues/20512). [#20550](https://github.com/ClickHouse/ClickHouse/pull/20550) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, из-за которой при получении неизвестного пакета от удалённого запроса мог происходить сбой (ошибка была внесена в [#17868](https://github.com/ClickHouse/ClickHouse/issues/17868)). [#20547](https://github.com/ClickHouse/ClickHouse/pull/20547) ([Azat Khuzhin](https://github.com/azat)).
* Добавлены корректные проверки при разборе имён каталогов для асинхронного INSERT, что исправляет SIGSEGV. [#20498](https://github.com/ClickHouse/ClickHouse/pull/20498) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена некорректная работа функции `transform` для ключей с плавающей запятой. Закрывает [#20460](https://github.com/ClickHouse/ClickHouse/issues/20460). [#20479](https://github.com/ClickHouse/ClickHouse/pull/20479) ([flynn](https://github.com/ucasFL)).
* Исправлен бесконечный цикл при распространении псевдонимов `WITH` на подзапросы. Исправляет [#20388](https://github.com/ClickHouse/ClickHouse/issues/20388). [#20476](https://github.com/ClickHouse/ClickHouse/pull/20476) ([Amos Bird](https://github.com/amosbird)).
* Исправлено аварийное завершение работы сервера при отключении HTTP-клиента. [#20464](https://github.com/ClickHouse/ClickHouse/pull/20464) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка `LOGICAL_ERROR` при `join_use_nulls=1`, возникавшая, когда оператор JOIN содержит константу из SELECT. [#20461](https://github.com/ClickHouse/ClickHouse/pull/20461) ([Azat Khuzhin](https://github.com/azat)).
* Проверять, используется ли табличная функция `view` в списке выражений, и в таком случае выдавать ошибку. Это исправляет [#20342](https://github.com/ClickHouse/ClickHouse/issues/20342). [#20350](https://github.com/ClickHouse/ClickHouse/pull/20350) ([Amos Bird](https://github.com/amosbird)).
* Исключено некорректное разыменование в словаре RANGE&#95;HASHED(). [#20345](https://github.com/ClickHouse/ClickHouse/pull/20345) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено разыменование нулевого указателя при `join_use_nulls=1`. [#20344](https://github.com/ClickHouse/ClickHouse/pull/20344) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен некорректный результат бинарных операций между двумя константными десятичными числами с разным масштабом. Исправляет [#20283](https://github.com/ClickHouse/ClickHouse/issues/20283). [#20339](https://github.com/ClickHouse/ClickHouse/pull/20339) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлены слишком частые повторные попытки выполнения неудачных фоновых задач для семейства движков таблиц `ReplicatedMergeTree`. Это могло приводить к избыточному логированию и повышенной загрузке CPU. Исправление [#20203](https://github.com/ClickHouse/ClickHouse/issues/20203). [#20335](https://github.com/ClickHouse/ClickHouse/pull/20335) ([alesapin](https://github.com/alesapin)).
* Ограничены операции со столбцом версии в движках таблиц `*CollapsingMergeTree` и `ReplacingMergeTree`: теперь допускаются только `DROP` и `RENAME`. [#20300](https://github.com/ClickHouse/ClickHouse/pull/20300) ([alesapin](https://github.com/alesapin)).
* Исправлено поведение, при котором в случае повреждённого JSON мы пытались считать весь файл в память, что приводило к исключению, генерируемому аллокатором. Исправляет [#19719](https://github.com/ClickHouse/ClickHouse/issues/19719). [#20286](https://github.com/ClickHouse/ClickHouse/pull/20286) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлено исключение, возникавшее при вертикальном слиянии для семейства движков таблиц `MergeTree`, которые не поддерживают вертикальные слияния. Исправляет [#20259](https://github.com/ClickHouse/ClickHouse/issues/20259). [#20279](https://github.com/ClickHouse/ClickHouse/pull/20279) ([alesapin](https://github.com/alesapin)).
* Устранён редкий сбой сервера при перезагрузке конфигурации во время завершения работы. Решает [#19689](https://github.com/ClickHouse/ClickHouse/issues/19689). [#20224](https://github.com/ClickHouse/ClickHouse/pull/20224) ([alesapin](https://github.com/alesapin)).
* Исправлена работа CTE при использовании в INSERT SELECT. Исправляет [#20187](https://github.com/ClickHouse/ClickHouse/issues/20187), исправляет [#20195](https://github.com/ClickHouse/ClickHouse/issues/20195). [#20211](https://github.com/ClickHouse/ClickHouse/pull/20211) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка [#19314](https://github.com/ClickHouse/ClickHouse/issues/19314). [#20156](https://github.com/ClickHouse/ClickHouse/pull/20156) ([Ivan](https://github.com/abyss7)).
* Исправлена функция toMinute для корректной обработки специального часового пояса. [#20149](https://github.com/ClickHouse/ClickHouse/pull/20149) ([keenwolf](https://github.com/keen-wolf)).
* Исправлено падение сервера после выполнения запроса с функцией `if` и типом `Tuple` в результирующих ветвях then/else. Тип `Tuple` должен содержать `Array` или другой составной тип. Исправляет [#18356](https://github.com/ClickHouse/ClickHouse/issues/18356). [#20133](https://github.com/ClickHouse/ClickHouse/pull/20133) ([alesapin](https://github.com/alesapin)).
* Движок таблицы `MongoDB` теперь устанавливает соединение только при чтении данных. `ATTACH TABLE` больше не будет пытаться устанавливать соединение. [#20110](https://github.com/ClickHouse/ClickHouse/pull/20110) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправление ошибки в StorageJoin. [#20079](https://github.com/ClickHouse/ClickHouse/pull/20079) ([vdimir](https://github.com/vdimir)).
* Исправлен случай, когда при вычислении остатка от деления отрицательного числа на небольшой делитель результирующий тип данных был недостаточно широким, чтобы представить отрицательный результат. Это закрывает [#20052](https://github.com/ClickHouse/ClickHouse/issues/20052). [#20067](https://github.com/ClickHouse/ClickHouse/pull/20067) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* MaterializeMySQL: Исправлена репликация для операторов, которые обновляют несколько таблиц. [#20066](https://github.com/ClickHouse/ClickHouse/pull/20066) ([Håvard Kvålen](https://github.com/havardk)).
* Предотвращена ошибка «Connection refused» в Docker во время выполнения скрипта инициализации. [#20012](https://github.com/ClickHouse/ClickHouse/pull/20012) ([filimonov](https://github.com/filimonov)).
* `EmbeddedRocksDB` — экспериментальное хранилище. Исправлена проблема, связанная с отсутствием корректной проверки типов. Код упрощён. Тем самым закрывается [#19967](https://github.com/ClickHouse/ClickHouse/issues/19967). [#19972](https://github.com/ClickHouse/ClickHouse/pull/19972) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка сегментации в функции `fromModifiedJulianDay`, возникавшая, когда тип аргумента — `Nullable(T)` для любых целочисленных типов, отличных от Int32. [#19959](https://github.com/ClickHouse/ClickHouse/pull/19959) ([PHO](https://github.com/depressed-pho)).
* Исправление падения при использовании индекса BloomFilter. Устраняет [#19757](https://github.com/ClickHouse/ClickHouse/issues/19757). [#19884](https://github.com/ClickHouse/ClickHouse/pull/19884) ([Maksim Kita](https://github.com/kitaisreal)).
* Могла возникать взаимоблокировка, если включен `system.text_log`. Это исправляет [#19874](https://github.com/ClickHouse/ClickHouse/issues/19874). [#19875](https://github.com/ClickHouse/ClickHouse/pull/19875) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена проблема с запуском сервера с таблицами, имеющими выражения по умолчанию, содержащие dictGet(). Добавлена возможность получать тип возвращаемого значения dictGet() без загрузки словаря. [#19805](https://github.com/ClickHouse/ClickHouse/pull/19805) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено исключение, приводившее к аварийному завершению clickhouse-client при выполнении только запросов `SELECT`. [#19790](https://github.com/ClickHouse/ClickHouse/pull/19790) ([taiyang-li](https://github.com/taiyang-li)).
* Исправлена ошибка, из‑за которой перемещение частей в целевую таблицу могло завершаться неудачей при запуске нескольких экземпляров clickhouse-copier. [#19743](https://github.com/ClickHouse/ClickHouse/pull/19743) ([madianjun](https://github.com/mdianjun)).
* Фоновый поток, который выполняет запросы `ON CLUSTER`, мог зависать, ожидая каких-либо действий от удалённой реплицируемой таблицы. Это исправлено. [#19684](https://github.com/ClickHouse/ClickHouse/pull/19684) ([yiguolei](https://github.com/yiguolei)).

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-8}

- Добавлена возможность сборки ClickHouse с глобально включённым AVX-2. Это даёт небольшой прирост производительности на современных процессорах. Не рекомендуется для production-окружений и пока не будет поддерживаться в качестве официальной сборки. [#20180](https://github.com/ClickHouse/ClickHouse/pull/20180) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Исправлены некоторые проблемы, обнаруженные Coverity. См. [#19964](https://github.com/ClickHouse/ClickHouse/issues/19964). [#20010](https://github.com/ClickHouse/ClickHouse/pull/20010) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлена возможность запуска с модифицированным бинарным файлом под gdb. В предыдущей версии, если установить точку останова в gdb перед запуском, сервер отказывался запускаться из-за неудачной проверки целостности. [#21258](https://github.com/ClickHouse/ClickHouse/pull/21258) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлен тест для различных методов сжатия в Kafka. [#21111](https://github.com/ClickHouse/ClickHouse/pull/21111) ([filimonov](https://github.com/filimonov)).
- Исправлен конфликт портов в тесте test_storage_kerberized_hdfs. [#19974](https://github.com/ClickHouse/ClickHouse/pull/19974) ([Ilya Yatsishin](https://github.com/qoega)).
- Добавлен вывод `stdout` и `stderr` в лог при неудачном запуске docker в интеграционных тестах. До этого PR в таком случае выводилось очень короткое сообщение об ошибке, которое не помогало в расследовании проблем. [#20631](https://github.com/ClickHouse/ClickHouse/pull/20631) ([Vitaly Baranov](https://github.com/vitlibar)).


## Релиз ClickHouse 21.2 {#clickhouse-release-212}

### Релиз ClickHouse v21.2.2.8-stable, 2021-02-07 {#clickhouse-release-v21228-stable-2021-02-07}

#### Обратно несовместимые изменения {#backward-incompatible-change-9}

- Побитовые функции (`bitAnd`, `bitOr` и т.д.) запрещены для аргументов с плавающей точкой. Теперь необходимо выполнять явное приведение к целочисленному типу. [#19853](https://github.com/ClickHouse/ClickHouse/pull/19853) ([Azat Khuzhin](https://github.com/azat)).
- Запрещено использование функций `lcm`/`gcd` для чисел с плавающей точкой. [#19532](https://github.com/ClickHouse/ClickHouse/pull/19532) ([Azat Khuzhin](https://github.com/azat)).
- Исправлено отслеживание памяти для `OPTIMIZE TABLE`/слияний; учитываются ограничения памяти запросов и сэмплирование для `OPTIMIZE TABLE`/слияний. [#18772](https://github.com/ClickHouse/ClickHouse/pull/18772) ([Azat Khuzhin](https://github.com/azat)).
- Запрещено использование столбцов с плавающей точкой в качестве ключа партиционирования, см. [#18421](https://github.com/ClickHouse/ClickHouse/issues/18421#event-4147046255). [#18464](https://github.com/ClickHouse/ClickHouse/pull/18464) ([hexiaoting](https://github.com/hexiaoting)).
- Избыточные скобки в определениях типов больше не поддерживаются, например: `Array((UInt8))`.

#### Новые возможности {#new-feature-9}


* Добавлен движок таблицы `PostgreSQL` (для операций SELECT/INSERT с поддержкой многомерных массивов), а также реализованный как табличная функция. Добавлен источник словаря `PostgreSQL`. Добавлен движок базы данных `PostgreSQL`. [#18554](https://github.com/ClickHouse/ClickHouse/pull/18554) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Тип данных `Nested` теперь поддерживает произвольные уровни вложенности. Добавлены подстолбцы сложных типов, таких как `size0` в `Array`, `null` в `Nullable`, имена элементов `Tuple`, которые можно читать, не считывая весь столбец. [#17310](https://github.com/ClickHouse/ClickHouse/pull/17310) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена поддержка типа `Nullable` для `FlatDictionary`, `HashedDictionary`, `ComplexKeyHashedDictionary`, `DirectDictionary`, `ComplexKeyDirectDictionary`, `RangeHashedDictionary`. [#18236](https://github.com/ClickHouse/ClickHouse/pull/18236) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена новая таблица `system.distributed_ddl_queue`, которая отображает запросы в очереди обработчика DDL. [#17656](https://github.com/ClickHouse/ClickHouse/pull/17656) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлена поддержка сопоставления имён LDAP-групп и, в целом, значений атрибутов с локальными ролями для пользователей из LDAP-директорий. [#17211](https://github.com/ClickHouse/ClickHouse/pull/17211) ([Denis Glazachev](https://github.com/traceon)).
* Реализована поддержка оператора `INSERT INTO` для табличной функции `cluster`, а также для табличных функций `remote` и `cluster` добавлена возможность распределять данные по узлам с указанием ключа шардинга. Закрыто [#16752](https://github.com/ClickHouse/ClickHouse/issues/16752). [#18264](https://github.com/ClickHouse/ClickHouse/pull/18264) ([flynn](https://github.com/ucasFL)).
* Добавлена функция `decodeXMLComponent` для декодирования специальных символов в XML. Пример: `SELECT decodeXMLComponent('Hello,&quot;world&quot;!')` [#17659](https://github.com/ClickHouse/ClickHouse/issues/17659). [#18542](https://github.com/ClickHouse/ClickHouse/pull/18542) ([nauta](https://github.com/nautaa)).
* Добавлены функции `parseDateTimeBestEffortUSOrZero`, `parseDateTimeBestEffortUSOrNull`. [#19712](https://github.com/ClickHouse/ClickHouse/pull/19712) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена математическая функция `sign`. [#19527](https://github.com/ClickHouse/ClickHouse/pull/19527) ([flynn](https://github.com/ucasFL)).
* В system.query&#95;log добавлена информация об используемых возможностях (функциях, движках таблиц и т. п.). [#18495](https://github.com/ClickHouse/ClickHouse/issues/18495). [#19371](https://github.com/ClickHouse/ClickHouse/pull/19371) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Функция `formatDateTime` поддерживает модификатор `%Q` для форматирования даты в квартал. [#19224](https://github.com/ClickHouse/ClickHouse/pull/19224) ([Jianmei Zhang](https://github.com/zhangjmruc)).
* Добавлена поддержка привязки сочетания клавиш Meta+Enter в интерфейсе Play. [#19012](https://github.com/ClickHouse/ClickHouse/pull/19012) ([sundyli](https://github.com/sundy-li)).
* Добавлены три функции для типа данных Map: 1. `mapContains(map, key)` — проверяет, содержит ли множество ключей карты (`map.keys`) ключ, переданный вторым аргументом. 2. `mapKeys(map)` — возвращает все ключи в виде массива (Array). 3. `mapValues(map)` — возвращает все значения в виде массива (Array). [#18788](https://github.com/ClickHouse/ClickHouse/pull/18788) ([hexiaoting](https://github.com/hexiaoting)).
* Добавлена настройка `log_comment`, связанная с задачей [#18494](https://github.com/ClickHouse/ClickHouse/issues/18494). [#18549](https://github.com/ClickHouse/ClickHouse/pull/18549) ([Zijie Lu](https://github.com/TszKitLo40)).
* Добавлена поддержка аргумента типа кортеж для функций `argMin` и `argMax`. [#17359](https://github.com/ClickHouse/ClickHouse/pull/17359) ([Ildus Kurbangaliev](https://github.com/ildus)).
* Добавлена поддержка синтаксиса `EXISTS VIEW`. [#18552](https://github.com/ClickHouse/ClickHouse/pull/18552) ([Du Chuan](https://github.com/spongedu)).
* Добавлен синтаксис `SELECT ALL`. Закрывает [#18706](https://github.com/ClickHouse/ClickHouse/issues/18706). [#18723](https://github.com/ClickHouse/ClickHouse/pull/18723) ([flynn](https://github.com/ucasFL)).

#### Улучшение производительности {#performance-improvement-9}

- Ускорено удаление частей за счёт уменьшения количества системных вызовов `stat`. Это возвращает оптимизацию, которая существовала некоторое время назад. Более безопасный интерфейс `IDisk`. Закрывает [#19065](https://github.com/ClickHouse/ClickHouse/issues/19065). [#19086](https://github.com/ClickHouse/ClickHouse/pull/19086) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Псевдонимы, объявленные в операторе `WITH`, теперь корректно используются при анализе индексов. Запросы вида `WITH column AS alias SELECT ... WHERE alias = ...` теперь могут использовать индекс. [#18896](https://github.com/ClickHouse/ClickHouse/pull/18896) ([Amos Bird](https://github.com/amosbird)).
- Добавлена настройка `optimize_alias_column_prediction` (включена по умолчанию), которая: - Учитывает столбцы с псевдонимами в WHERE при отсечении партиций и пропуске данных с использованием вторичных индексов; - Учитывает столбцы с псевдонимами в WHERE для тривиальных запросов подсчёта при optimize_trivial_count; - Учитывает столбцы с псевдонимами в GROUP BY/ORDER BY для optimize_aggregation_in_order/optimize_read_in_order. [#16995](https://github.com/ClickHouse/ClickHouse/pull/16995) ([sundyli](https://github.com/sundy-li)).
- Ускорена агрегатная функция `sum`. Улучшение заметно только на синтетических тестах и не имеет большого практического значения. [#19216](https://github.com/ClickHouse/ClickHouse/pull/19216) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Обновлена библиотека libc++ и используется другой ABI для повышения производительности. [#18914](https://github.com/ClickHouse/ClickHouse/pull/18914) ([Danila Kutenin](https://github.com/danlark1)).
- Функции `sumIf()` и `sum(if())` переписываются в функцию `countIf()`, когда это логически эквивалентно. [#17041](https://github.com/ClickHouse/ClickHouse/pull/17041) ([flynn](https://github.com/ucasFL)).
- Используется пул соединений для подключений к S3, управляемый настройкой `s3_max_connections`. [#13405](https://github.com/ClickHouse/ClickHouse/pull/13405) ([Vladimir Chebotarev](https://github.com/excitoon)).
- Добавлена поддержка опции zstd long для улучшенного сжатия строковых столбцов с целью экономии места. [#17184](https://github.com/ClickHouse/ClickHouse/pull/17184) ([ygrek](https://github.com/ygrek)).
- Незначительно улучшена задержка сервера за счёт устранения обращения к конфигурации при каждом подключении. [#19863](https://github.com/ClickHouse/ClickHouse/pull/19863) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Снижена конкуренция за блокировки для нескольких уровней движка `Buffer`. [#19379](https://github.com/ClickHouse/ClickHouse/pull/19379) ([Azat Khuzhin](https://github.com/azat)).
- Добавлена поддержка разделения шага `Filter` плана запроса на пару `Expression + Filter`. Вместе с оптимизацией слияния `Expression + Expression` ([#17458](https://github.com/ClickHouse/ClickHouse/issues/17458)) это может отложить выполнение некоторых выражений после шага `Filter`. [#19253](https://github.com/ClickHouse/ClickHouse/pull/19253) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).

#### Улучшение {#improvement-9}


* `SELECT count() FROM table` теперь может выполняться, если из `table` можно выбрать хотя бы один произвольный столбец. Этот PR исправляет [#10639](https://github.com/ClickHouse/ClickHouse/issues/10639). [#18233](https://github.com/ClickHouse/ClickHouse/pull/18233) ([Vitaly Baranov](https://github.com/vitlibar)).
* Устанавливается кодировка `utf8mb4` при взаимодействии с удалёнными серверами MySQL. Исправляет [#19795](https://github.com/ClickHouse/ClickHouse/issues/19795). [#19800](https://github.com/ClickHouse/ClickHouse/pull/19800) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Табличная функция `S3` теперь поддерживает режим сжатия `auto` (автоопределение). Это закрывает [#18754](https://github.com/ClickHouse/ClickHouse/issues/18754). [#19793](https://github.com/ClickHouse/ClickHouse/pull/19793) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Корректно выводить бесконечные аргументы для функции `formatReadableTimeDelta`. В предыдущих версиях происходило неявное преобразование в зависящее от реализации значение целочисленного типа. [#19791](https://github.com/ClickHouse/ClickHouse/pull/19791) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Табличная функция `S3` будет использовать глобальный регион, если регион не может быть определён однозначно. Это закрывает [#10998](https://github.com/ClickHouse/ClickHouse/issues/10998). [#19750](https://github.com/ClickHouse/ClickHouse/pull/19750) ([Vladimir Chebotarev](https://github.com/excitoon)).
* В распределённых запросах, если настройка `async_socket_for_remote` включена, могло происходить переполнение стека как минимум в отладочной сборке, если в таблице используется очень глубоко вложенный тип данных (например, `Array(Array(Array(...more...)))`). Это исправляет [#19108](https://github.com/ClickHouse/ClickHouse/issues/19108). Это изменение вносит небольшую обратную несовместимость: избыточные скобки в определениях типов больше не поддерживаются, пример: `Array((UInt8))`. [#19736](https://github.com/ClickHouse/ClickHouse/pull/19736) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлен отдельный пул для брокеров сообщений (RabbitMQ и Kafka). [#19722](https://github.com/ClickHouse/ClickHouse/pull/19722) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено редкое превышение лимита `max_number_of_merges_with_ttl_in_pool` (могло назначаться больше слияний с TTL) в нереплицируемом MergeTree. [#19708](https://github.com/ClickHouse/ClickHouse/pull/19708) ([alesapin](https://github.com/alesapin)).
* Dictionary: улучшено сообщение об ошибке при разборе атрибутов. [#19678](https://github.com/ClickHouse/ClickHouse/pull/19678) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена настройка для отключения проверки контрольных сумм при чтении. Её нельзя использовать в продуктивной среде. Не стоит ожидать каких-либо преимуществ от её отключения. Может использоваться только для экспериментов и бенчмарков. Настройка применима только к таблицам семейства MergeTree. Контрольные суммы всегда проверяются для других табличных движков и при получении данных по сети. По моим наблюдениям, разницы в производительности нет, либо она менее 0,5%. [#19588](https://github.com/ClickHouse/ClickHouse/pull/19588) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка константного результата в функции `multiIf`. [#19533](https://github.com/ClickHouse/ClickHouse/pull/19533) ([Maksim Kita](https://github.com/kitaisreal)).
* Включена поддержка функций length/empty/notEmpty для типа данных Map, которые возвращают количество ключей. [#19530](https://github.com/ClickHouse/ClickHouse/pull/19530) ([taiyang-li](https://github.com/taiyang-li)).
* Добавлена опция `--reconnect` в утилиту `clickhouse-benchmark`. При использовании этой опции будет выполняться переподключение перед каждым запросом. Это необходимо для тестирования. [#19872](https://github.com/ClickHouse/ClickHouse/pull/19872) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка нового расположения файла `.debug`. Исправляет [#19348](https://github.com/ClickHouse/ClickHouse/issues/19348). [#19520](https://github.com/ClickHouse/ClickHouse/pull/19520) ([Amos Bird](https://github.com/amosbird)).
* Функция `toIPv6` разбирает адреса `IPv4`. [#19518](https://github.com/ClickHouse/ClickHouse/pull/19518) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлено поле `http_referer` в `system.query_log`, `system.processes` и др. Это закрывает [#19389](https://github.com/ClickHouse/ClickHouse/issues/19389). [#19390](https://github.com/ClickHouse/ClickHouse/pull/19390) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Улучшена совместимость с MySQL за счёт того, что больше функций стали регистронезависимыми и добавлены их псевдонимы. [#19387](https://github.com/ClickHouse/ClickHouse/pull/19387) ([Daniil Kondratyev](https://github.com/dankondr)).
* Добавлены метрики для типов партиций MergeTree (Wide/Compact/InMemory). [#19381](https://github.com/ClickHouse/ClickHouse/pull/19381) ([Azat Khuzhin](https://github.com/azat)).
* Разрешить запуск Docker с произвольным UID. [#19374](https://github.com/ClickHouse/ClickHouse/pull/19374) ([filimonov](https://github.com/filimonov)).
* Исправлено неверное выравнивание значений типа данных `IPv4` в форматах Pretty. Ранее они выравнивались по правому краю, а не по левому. Это закрывает [#19184](https://github.com/ClickHouse/ClickHouse/issues/19184). [#19339](https://github.com/ClickHouse/ClickHouse/pull/19339) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Разрешено изменять `max_server_memory_usage` без перезапуска сервера. Это закрывает [#18154](https://github.com/ClickHouse/ClickHouse/issues/18154). [#19186](https://github.com/ClickHouse/ClickHouse/pull/19186) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исключение, возникающее при вызове функции `bar` с некоторыми значениями NaN, в предыдущих версиях могло немного вводить в заблуждение. Это исправляет [#19088](https://github.com/ClickHouse/ClickHouse/issues/19088). [#19107](https://github.com/ClickHouse/ClickHouse/pull/19107) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* В образах clickhouse-server явно установлены UID/GID пользователя и группы clickhouse на фиксированное значение 101. [#19096](https://github.com/ClickHouse/ClickHouse/pull/19096) ([filimonov](https://github.com/filimonov)).
* Исправлена ошибка `PeekableReadBuffer: Memory limit exceed`, возникавшая при вставке данных, содержащих очень длинные строки. Устраняет [#18690](https://github.com/ClickHouse/ClickHouse/issues/18690). [#18979](https://github.com/ClickHouse/ClickHouse/pull/18979) ([tavplubix](https://github.com/tavplubix)).
* Docker-образ: несколько улучшений для точки входа `clickhouse-server`. [#18954](https://github.com/ClickHouse/ClickHouse/pull/18954) ([filimonov](https://github.com/filimonov)).
* Добавлены `normalizeQueryKeepNames` и `normalizedQueryHashKeepNames` для нормализации запросов без замены длинных имён символом `?`. Это помогает более эффективно анализировать сложные журналы запросов. [#18910](https://github.com/ClickHouse/ClickHouse/pull/18910) ([Amos Bird](https://github.com/amosbird)).
* Перед отправкой проверять контрольную сумму каждого блока распределённого батча на стороне отправителя (без повторного чтения файла: контрольные суммы будут проверяться по мере чтения), что позволит избежать зависания INSERT на стороне получателя (в случае усечённого .bin-файла на отправителе). Исключено повторное чтение .bin-файлов при пакетном INSERT (ранее это требовалось для вычисления числа строк/байт с учётом сквошинга, теперь эта информация включена в заголовок, при этом обратная совместимость сохранена). [#18853](https://github.com/ClickHouse/ClickHouse/pull/18853) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены проблемы с операциями RIGHT и FULL JOIN над таблицами с состояниями агрегатных функций. В предыдущих версиях выбрасывалось исключение, связанное с методом `cloneResized`. [#18818](https://github.com/ClickHouse/ClickHouse/pull/18818) ([templarzq](https://github.com/templarzq)).
* Добавлены префиксные настройки S3-эндпоинтов. [#18812](https://github.com/ClickHouse/ClickHouse/pull/18812) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Добавлена поддержка типов аргументов [UInt8, UInt16, UInt32, UInt64] в функциях bitmapTransform, bitmapSubsetInRange, bitmapSubsetLimit, bitmapContains. Это закрывает [#18713](https://github.com/ClickHouse/ClickHouse/issues/18713). [#18791](https://github.com/ClickHouse/ClickHouse/pull/18791) ([sundyli](https://github.com/sundy-li)).
* Разрешить дополнительное присваивание псевдонимов для CTE (Common Table Expressions). Распространить CSE (Common Subexpression Elimination) на подзапросы на том же уровне, если `enable_global_with_statement = 1`. Исправляет [#17378](https://github.com/ClickHouse/ClickHouse/issues/17378). Исправляет [https://github.com/ClickHouse/ClickHouse/pull/16575#issuecomment-753416235](https://github.com/ClickHouse/ClickHouse/pull/16575#issuecomment-753416235). [#18684](https://github.com/ClickHouse/ClickHouse/pull/18684) ([Amos Bird](https://github.com/amosbird)).
* Обновлена библиотека `librdkafka` до версии v1.6.0-RC2. Исправлена проблема [#18668](https://github.com/ClickHouse/ClickHouse/issues/18668). [#18671](https://github.com/ClickHouse/ClickHouse/pull/18671) ([filimonov](https://github.com/filimonov)).
* В случае неожиданных исключений автоматически перезапускается фоновый поток, отвечающий за выполнение распределённых DDL‑запросов. Исправляет [#17991](https://github.com/ClickHouse/ClickHouse/issues/17991). [#18285](https://github.com/ClickHouse/ClickHouse/pull/18285) ([徐炘](https://github.com/weeds085490)).
* Обновлён AWS C++ SDK для использования глобальных регионов S3. [#17870](https://github.com/ClickHouse/ClickHouse/pull/17870) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Добавлена поддержка конструкции `WITH ... [AND] [PERIODIC] REFRESH [interval_in_sec]` при создании таблиц `LIVE VIEW`. [#14822](https://github.com/ClickHouse/ClickHouse/pull/14822) ([vzakaznikov](https://github.com/vzakaznikov)).
* Ограничены запросы `MODIFY TTL` для таблиц `MergeTree`, созданных в устаревшем синтаксисе. Ранее такие запросы выполнялись успешно, но фактически не оказывали никакого эффекта. [#19064](https://github.com/ClickHouse/ClickHouse/pull/19064) ([Anton Popov](https://github.com/CurtizJ)).

#### Исправление ошибок {#bug-fix-8}


* Исправлена ошибка в анализе индексов для бинарных функций с константным аргументом, приводившая к неверным результатам запросов. Это исправляет [#18364](https://github.com/ClickHouse/ClickHouse/issues/18364). [#18373](https://github.com/ClickHouse/ClickHouse/pull/18373) ([Amos Bird](https://github.com/amosbird)).
* Исправлена проблема с запуском сервера с таблицами, имеющими выражения по умолчанию с dictGet(). Добавлена возможность получать тип возвращаемого значения dictGet() без загрузки словаря. [#19805](https://github.com/ClickHouse/ClickHouse/pull/19805) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена ошибка, приводившая к падению сервера после выполнения запроса с функцией `if`, когда результатом веток then/else был тип `Tuple`. Тип `Tuple` должен содержать `Array` или другой составной тип. Исправляет [#18356](https://github.com/ClickHouse/ClickHouse/issues/18356). [#20133](https://github.com/ClickHouse/ClickHouse/pull/20133) ([alesapin](https://github.com/alesapin)).
* `MaterializeMySQL` (экспериментальная возможность): Исправлена репликация для запросов, которые обновляют несколько таблиц. [#20066](https://github.com/ClickHouse/ClickHouse/pull/20066) ([Håvard Kvålen](https://github.com/havardk)).
* Предотвращена ошибка «Connection refused» в Docker во время выполнения скрипта инициализации. [#20012](https://github.com/ClickHouse/ClickHouse/pull/20012) ([filimonov](https://github.com/filimonov)).
* `EmbeddedRocksDB` — это экспериментальное хранилище. Исправлена проблема, связанная с отсутствием корректной проверки типов. Код упрощён. Это закрывает [#19967](https://github.com/ClickHouse/ClickHouse/issues/19967). [#19972](https://github.com/ClickHouse/ClickHouse/pull/19972) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен сбой сегментации в функции `fromModifiedJulianDay`, возникавший при использовании типа аргумента `Nullable(T)` для любых целочисленных типов, отличных от Int32. [#19959](https://github.com/ClickHouse/ClickHouse/pull/19959) ([PHO](https://github.com/depressed-pho)).
* Функция `greatCircleAngle` в предыдущих версиях возвращала неточные результаты. Этим исправлением закрывается задача [#19769](https://github.com/ClickHouse/ClickHouse/issues/19769). [#19789](https://github.com/ClickHouse/ClickHouse/pull/19789) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена редкая ошибка, из-за которой некоторые реплицируемые операции (например, `mutation`) не могли обработать часть данных после их повреждения. Исправляет [#19593](https://github.com/ClickHouse/ClickHouse/issues/19593). [#19702](https://github.com/ClickHouse/ClickHouse/pull/19702) ([alesapin](https://github.com/alesapin)).
* Фоновый поток, выполняющий запросы `ON CLUSTER`, мог зависать в ожидании каких-либо действий от удалённой реплицируемой таблицы. Это исправлено. [#19684](https://github.com/ClickHouse/ClickHouse/pull/19684) ([yiguolei](https://github.com/yiguolei)).
* Исправлена некорректная десериализация описаний столбцов. Она делала невозможным выполнение операции INSERT в таблицу со столбцом с именем `\`. [#19479](https://github.com/ClickHouse/ClickHouse/pull/19479) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Помечать распределённый пакет как повреждённый, если один из файлов содержит пустой блок данных. [#19449](https://github.com/ClickHouse/ClickHouse/pull/19449) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена очень редкая ошибка, которая могла приводить к зависанию мутации после выполнения операций `DROP/DETACH/REPLACE/MOVE PARTITION`. Эта ошибка была частично исправлена в [#15537](https://github.com/ClickHouse/ClickHouse/issues/15537) в большинстве случаев. [#19443](https://github.com/ClickHouse/ClickHouse/pull/19443) ([tavplubix](https://github.com/tavplubix)).
* Исправлена возможная ошибка `Extremes transform was already added to pipeline`. Устраняет [#14100](https://github.com/ClickHouse/ClickHouse/issues/14100). [#19430](https://github.com/ClickHouse/ClickHouse/pull/19430) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено значение по умолчанию для типов JOIN с ненулевым значением по умолчанию (например, для некоторых Enum). Закрывает [#18197](https://github.com/ClickHouse/ClickHouse/issues/18197). [#19360](https://github.com/ClickHouse/ClickHouse/pull/19360) ([vdimir](https://github.com/vdimir)).
* Не помечать файл для распределённой отправки как повреждённый при достижении EOF. [#19290](https://github.com/ClickHouse/ClickHouse/pull/19290) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена утечка дескриптора файлового канала (pipe) для `async_socket_for_remote`. [#19153](https://github.com/ClickHouse/ClickHouse/pull/19153) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено бесконечное чтение из файла в формате `ORC` (ошибка была внесена в [#10580](https://github.com/ClickHouse/ClickHouse/issues/10580)). Исправлена ошибка [#19095](https://github.com/ClickHouse/ClickHouse/issues/19095). [#19134](https://github.com/ClickHouse/ClickHouse/pull/19134) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена проблема в подсистеме записи данных MergeTree, которая могла приводить к созданию меток с размером, превышающим заданный размер фиксированной гранулы. Исправляет [#18913](https://github.com/ClickHouse/ClickHouse/issues/18913). [#19123](https://github.com/ClickHouse/ClickHouse/pull/19123) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка запуска, из-за которой ClickHouse не удавалось прочитать кодек сжатия из `LowCardinality(Nullable(...))` и выбрасывалось исключение `Attempt to read after EOF`. Исправляет [#18340](https://github.com/ClickHouse/ClickHouse/issues/18340). [#19101](https://github.com/ClickHouse/ClickHouse/pull/19101) ([alesapin](https://github.com/alesapin)).
* Упрощена реализация `tupleHammingDistance`. Добавлена поддержка кортежей произвольной, но одинаковой длины. Исправляет [#19029](https://github.com/ClickHouse/ClickHouse/issues/19029). [#19084](https://github.com/ClickHouse/ClickHouse/pull/19084) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Теперь `groupUniqArray` возвращает корректный тип для аргумента типа Enum. Это закрывает [#17875](https://github.com/ClickHouse/ClickHouse/issues/17875). [#19019](https://github.com/ClickHouse/ClickHouse/pull/19019) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена возможная ошибка `Expected single dictionary argument for function` при использовании функции `ignore` с аргументом типа `LowCardinality`. Исправление для [#14275](https://github.com/ClickHouse/ClickHouse/issues/14275). [#19016](https://github.com/ClickHouse/ClickHouse/pull/19016) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена проблема вставки столбца `LowCardinality` в таблицу с движком `TinyLog`. Устранена ошибка [#18629](https://github.com/ClickHouse/ClickHouse/issues/18629). [#19010](https://github.com/ClickHouse/ClickHouse/pull/19010) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена небольшая проблема в операторе JOIN: JOIN пытается материализовать константные столбцы, но остальная часть кода ожидает их в других местах. [#18982](https://github.com/ClickHouse/ClickHouse/pull/18982) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Отключена настройка `optimize_move_functions_out_of_any`, так как эта оптимизация не всегда работает корректно. Тем самым закрыта задача [#18051](https://github.com/ClickHouse/ClickHouse/issues/18051). Тем самым закрыта задача [#18973](https://github.com/ClickHouse/ClickHouse/issues/18973). [#18981](https://github.com/ClickHouse/ClickHouse/pull/18981) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено возможное исключение `QueryPipeline stream: different number of columns`, возникающее при слиянии шагов `Expression` в плане запроса. Исправляет [#18190](https://github.com/ClickHouse/ClickHouse/issues/18190). [#18980](https://github.com/ClickHouse/ClickHouse/pull/18980) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено крайне редкое взаимоблокирование при завершении работы. [#18977](https://github.com/ClickHouse/ClickHouse/pull/18977) ([tavplubix](https://github.com/tavplubix)).
* Исправлены редкие сбои при исчерпании памяти на сервере. [#18976](https://github.com/ClickHouse/ClickHouse/pull/18976) ([tavplubix](https://github.com/tavplubix)).
* Исправлено некорректное поведение, при котором запрос `ALTER TABLE ... DROP PART 'part_name'` удалял все блоки дедупликации во всей партиции. Исправляет [#18874](https://github.com/ClickHouse/ClickHouse/issues/18874). [#18969](https://github.com/ClickHouse/ClickHouse/pull/18969) ([alesapin](https://github.com/alesapin)).
* Исправлена проблема [#18894](https://github.com/ClickHouse/ClickHouse/issues/18894): добавлена проверка во избежание исключения в случае, когда длинный псевдоним столбца (в формате &#39;table.column&#39;, обычно автоматически генерируемый BI-инструментами, такими как Looker) совпадает с длинным именем таблицы. [#18968](https://github.com/ClickHouse/ClickHouse/pull/18968) ([Daniel Qin](https://github.com/mathfool)).
* Исправлена ошибка `Task was not found in task queue` (которая могла возникать только для удалённых запросов при `async_socket_for_remote = 1`). [#18964](https://github.com/ClickHouse/ClickHouse/pull/18964) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, приводившая к тому, что мутация с экранированным текстом (например, `ALTER ... UPDATE e = CAST('foo', 'Enum8(\'foo\' = 1')`) сериализовалась некорректно. Исправляет [#18878](https://github.com/ClickHouse/ClickHouse/issues/18878). [#18944](https://github.com/ClickHouse/ClickHouse/pull/18944) ([alesapin](https://github.com/alesapin)).
* ATTACH PARTITION теперь сбрасывает мутации. [#18804](https://github.com/ClickHouse/ClickHouse/issues/18804). [#18935](https://github.com/ClickHouse/ClickHouse/pull/18935) ([fastio](https://github.com/fastio)).
* Исправлена ошибка в `bitmapOrCardinality`, которая могла приводить к разыменованию указателя nullptr. Закрывает [#18911](https://github.com/ClickHouse/ClickHouse/issues/18911). [#18912](https://github.com/ClickHouse/ClickHouse/pull/18912) ([sundyli](https://github.com/sundy-li)).
* Исправлена ошибка `Attempt to read after eof` при попытке выполнить `CAST` значения `NULL` из типа `Nullable(String)` в `Nullable(Decimal(P, S))`. Теперь функция `CAST` возвращает `NULL`, если не может разобрать десятичное число из значения типа `Nullable(String)`. Исправляет [#7690](https://github.com/ClickHouse/ClickHouse/issues/7690). [#18718](https://github.com/ClickHouse/ClickHouse/pull/18718) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена ошибка преобразования типов данных в движке MySQL. [#18124](https://github.com/ClickHouse/ClickHouse/pull/18124) ([bo zeng](https://github.com/mis98zb)).
* Исправлено исключение `abort` в `clickhouse-client` при выполнении только запросов `SELECT`. [#19790](https://github.com/ClickHouse/ClickHouse/pull/19790) ([taiyang-li](https://github.com/taiyang-li)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-9}

- Запуск [SQLancer](https://twitter.com/RiggerManuel/status/1352345625480884228) (логический SQL-фаззер) в CI. [#19006](https://github.com/ClickHouse/ClickHouse/pull/19006) ([Ilya Yatsishin](https://github.com/qoega)).
- Query Fuzzer будет более интенсивно тестировать вновь добавленные тесты. Закрывает [#18916](https://github.com/ClickHouse/ClickHouse/issues/18916). [#19185](https://github.com/ClickHouse/ClickHouse/pull/19185) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Интеграция с [Big List of Naughty Strings](https://github.com/minimaxir/big-list-of-naughty-strings/) для улучшенного фаззинга. [#19480](https://github.com/ClickHouse/ClickHouse/pull/19480) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлен запуск интеграционных тестов с MSan. [#18974](https://github.com/ClickHouse/ClickHouse/pull/18974) ([alesapin](https://github.com/alesapin)).
- Исправлены ошибки MemorySanitizer в cyrus-sasl и musl. [#19821](https://github.com/ClickHouse/ClickHouse/pull/19821) ([Ilya Yatsishin](https://github.com/qoega)).
- Недостаточная проверка аргументов в функции `positionCaseInsensitiveUTF8` вызывала срабатывание address sanitizer. [#19720](https://github.com/ClickHouse/ClickHouse/pull/19720) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Удален параметр --project-directory для docker-compose в интеграционном тесте. Исправлено форматирование логов из docker-контейнера. [#19706](https://github.com/ClickHouse/ClickHouse/pull/19706) ([Ilya Yatsishin](https://github.com/qoega)).
- Упрощена генерация macros.xml для интеграционных тестов. Устранено избыточное логирование от dicttoxml. Проект dicttoxml неактивен более 5 лет. [#19697](https://github.com/ClickHouse/ClickHouse/pull/19697) ([Ilya Yatsishin](https://github.com/qoega)).
- Добавлена возможность явно включать или отключать watchdog через переменную окружения `CLICKHOUSE_WATCHDOG_ENABLE`. По умолчанию он включен, если сервер не подключен к терминалу. [#19522](https://github.com/ClickHouse/ClickHouse/pull/19522) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлена возможность сборки ClickHouse с поддержкой Kafka на arm64. [#19369](https://github.com/ClickHouse/ClickHouse/pull/19369) ([filimonov](https://github.com/filimonov)).
- Добавлена возможность сборки librdkafka без ssl. [#19337](https://github.com/ClickHouse/ClickHouse/pull/19337) ([filimonov](https://github.com/filimonov)).
- Восстановлен ввод Kafka в сборках FreeBSD. [#18924](https://github.com/ClickHouse/ClickHouse/pull/18924) ([Alexandre Snarskii](https://github.com/snar)).
- Исправлено потенциальное разыменование nullptr в табличной функции `VALUES`. [#19357](https://github.com/ClickHouse/ClickHouse/pull/19357) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Устранены срабатывания UBSan в функциях `arrayElement`, `substring` и `arraySum`. Исправляет [#19305](https://github.com/ClickHouse/ClickHouse/issues/19305). Исправляет [#19287](https://github.com/ClickHouse/ClickHouse/issues/19287). Закрывает [#19336](https://github.com/ClickHouse/ClickHouse/issues/19336). [#19347](https://github.com/ClickHouse/ClickHouse/pull/19347) ([alexey-milovidov](https://github.com/alexey-milovidov)).


## Релиз ClickHouse 21.1 {#clickhouse-release-211}

### Релиз ClickHouse v21.1.3.32-stable, 2021-02-03 {#clickhouse-release-v211332-stable-2021-02-03}

#### Исправление ошибок {#bug-fix-9}


* Исправлено падение при использовании индекса BloomFilter. Исправляет [#19757](https://github.com/ClickHouse/ClickHouse/issues/19757). [#19884](https://github.com/ClickHouse/ClickHouse/pull/19884) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлено аварийное завершение при проталкивании предикатов в подзапрос с `UNION DISTINCT`. Это устраняет [#19855](https://github.com/ClickHouse/ClickHouse/issues/19855). [#19861](https://github.com/ClickHouse/ClickHouse/pull/19861) ([Amos Bird](https://github.com/amosbird)).
* Исправлена фильтрация по UInt8 для значений больше 127. [#19799](https://github.com/ClickHouse/ClickHouse/pull/19799) ([Anton Popov](https://github.com/CurtizJ)).
* В предыдущих версиях нетипичные аргументы функции arrayEnumerateUniq могли приводить к сбою или бесконечному циклу. Это закрывает [#19787](https://github.com/ClickHouse/ClickHouse/issues/19787). [#19788](https://github.com/ClickHouse/ClickHouse/pull/19788) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено переполнение стека при использовании точного сравнения арифметического типа со строковым типом. [#19773](https://github.com/ClickHouse/ClickHouse/pull/19773) ([tavplubix](https://github.com/tavplubix)).
* Исправлен сбой, возникавший при использовании имени вложенного столбца в `WHERE` или `PREWHERE`. Исправляет ошибку [#19755](https://github.com/ClickHouse/ClickHouse/issues/19755). [#19763](https://github.com/ClickHouse/ClickHouse/pull/19763) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка сегментации в функции `bitmapAndnot`. Закрывает [#19668](https://github.com/ClickHouse/ClickHouse/issues/19668). [#19713](https://github.com/ClickHouse/ClickHouse/pull/19713) ([Maksim Kita](https://github.com/kitaisreal)).
* Некоторые функции, работающие с большими целыми числами, могут приводить к ошибке сегментации (segfault). Поддержка больших целых чисел — экспериментальная функциональность. Это закрывает задачу [#19667](https://github.com/ClickHouse/ClickHouse/issues/19667). [#19672](https://github.com/ClickHouse/ClickHouse/pull/19672) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен неверный результат работы функции `neighbor` для аргумента `LowCardinality`. Исправлена ошибка [#10333](https://github.com/ClickHouse/ClickHouse/issues/10333). [#19617](https://github.com/ClickHouse/ClickHouse/pull/19617) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено использование после освобождения памяти (`use-after-free`) объекта `CompressedWriteBuffer` в `Connection` после отключения. [#19599](https://github.com/ClickHouse/ClickHouse/pull/19599) ([Azat Khuzhin](https://github.com/azat)).
* Запрос `DROP/DETACH TABLE table ON CLUSTER cluster SYNC` мог зависать; эта проблема исправлена. Исправляет [#19568](https://github.com/ClickHouse/ClickHouse/issues/19568). [#19572](https://github.com/ClickHouse/ClickHouse/pull/19572) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка в выражении `id` в запросе CREATE DICTIONARY. [#19571](https://github.com/ClickHouse/ClickHouse/pull/19571) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлено возникновение SIGSEGV при значениях merge&#95;tree&#95;min&#95;rows&#95;for&#95;concurrent&#95;read/merge&#95;tree&#95;min&#95;bytes&#95;for&#95;concurrent&#95;read=0/UINT64&#95;MAX. [#19528](https://github.com/ClickHouse/ClickHouse/pull/19528) ([Azat Khuzhin](https://github.com/azat)).
* Переполнение буфера (при чтении из памяти) могло произойти, если функция `addMonth` вызывалась со специально подготовленными аргументами. Это исправляет [#19441](https://github.com/ClickHouse/ClickHouse/issues/19441). Это исправляет [#19413](https://github.com/ClickHouse/ClickHouse/issues/19413). [#19472](https://github.com/ClickHouse/ClickHouse/pull/19472) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* В функциях encrypt/decrypt могло происходить чтение неинициализированной памяти, если в качестве IV была передана пустая строка. Это закрывает [#19391](https://github.com/ClickHouse/ClickHouse/issues/19391). [#19397](https://github.com/ClickHouse/ClickHouse/pull/19397) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено возможное переполнение буфера в библиотеке Uber H3. См. [https://github.com/uber/h3/issues/392](https://github.com/uber/h3/issues/392). Тем самым закрыта задача [#19219](https://github.com/ClickHouse/ClickHouse/issues/19219). [#19383](https://github.com/ClickHouse/ClickHouse/pull/19383) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен столбец system.parts&#95;state (LOGICAL&#95;ERROR при запросе к этому столбцу из-за некорректного порядка). [#19346](https://github.com/ClickHouse/ClickHouse/pull/19346) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено возможное получение неверного результата или сегфолт при агрегации, когда материализованное представление и его целевая таблица имеют разную структуру. Исправляет [#18063](https://github.com/ClickHouse/ClickHouse/issues/18063). [#19322](https://github.com/ClickHouse/ClickHouse/pull/19322) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка: `Cannot convert column now64() because it is constant but values of constants are different in source and result`. Продолжение [#7156](https://github.com/ClickHouse/ClickHouse/issues/7156). [#19316](https://github.com/ClickHouse/ClickHouse/pull/19316) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, из-за которой одновременные запросы `ALTER` и `DROP` могли зависать при обработке таблицы ReplicatedMergeTree. [#19237](https://github.com/ClickHouse/ClickHouse/pull/19237) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка `There is no checkpoint` при вставке данных через HTTP-интерфейс с использованием форматов `Template` или `CustomSeparated`. Исправляет [#19021](https://github.com/ClickHouse/ClickHouse/issues/19021). [#19072](https://github.com/ClickHouse/ClickHouse/pull/19072) ([tavplubix](https://github.com/tavplubix)).
* Отключена свёртка констант в подзапросах на стадии анализа, когда результат не может быть вычислен. [#18446](https://github.com/ClickHouse/ClickHouse/pull/18446) ([Azat Khuzhin](https://github.com/azat)).
* Мутация могла зависать в ожидании несуществующей части после операций `MOVE` или `REPLACE PARTITION`, а в редких случаях — после `DETACH` или `DROP PARTITION`. Исправлено. [#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix)).

### ClickHouse release v21.1.2.15-stable 2021-01-18 {#clickhouse-release-v211215-stable-2021-01-18}

#### Обратно несовместимые изменения {#backward-incompatible-change-10}

- Настройка `input_format_null_as_default` включена по умолчанию. [#17525](https://github.com/ClickHouse/ClickHouse/pull/17525) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Проверка ограничений настроек для параметров профиля из конфигурации. Сервер не запустится, если users.xml содержит настройки, не соответствующие установленным ограничениям. [#18486](https://github.com/ClickHouse/ClickHouse/pull/18486) ([tavplubix](https://github.com/tavplubix)).
- Ограничено использование `ALTER MODIFY SETTING` для изменения настроек хранения, влияющих на части данных (`write_final_mark` и `enable_mixed_granularity_parts`). [#18306](https://github.com/ClickHouse/ClickHouse/pull/18306) ([Amos Bird](https://github.com/amosbird)).
- Значение `insert_quorum_parallel` установлено равным 1 по умолчанию. Это значительно удобнее в использовании, чем «последовательные» вставки с кворумом. Однако если вы полагаетесь на последовательную согласованность, следует вернуть значение настройки к нулю. [#17567](https://github.com/ClickHouse/ClickHouse/pull/17567) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Удалена функция `sumburConsistentHash`. Это закрывает [#18120](https://github.com/ClickHouse/ClickHouse/issues/18120). [#18656](https://github.com/ClickHouse/ClickHouse/pull/18656) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Удалены агрегатные функции `timeSeriesGroupSum`, `timeSeriesGroupRateSum`, поскольку один из коллег сообщил, что они никогда не работали. Это исправляет [#16869](https://github.com/ClickHouse/ClickHouse/issues/16869). Если вам удавалось успешно использовать эти функции, напишите письмо на адрес feedback@clickhouse.com. [#17423](https://github.com/ClickHouse/ClickHouse/pull/17423) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Запрещено использование toUnixTimestamp(Date()) (ранее возвращало представление Date в виде UInt16). [#17376](https://github.com/ClickHouse/ClickHouse/pull/17376) ([Azat Khuzhin](https://github.com/azat)).
- Разрешено использование расширенных целочисленных типов (`Int128`, `Int256`, `UInt256`) в функциях `avg` и `avgWeighted`. Также разрешено использование различных типов (целочисленных, десятичных, с плавающей точкой) для значения и веса в функции `avgWeighted`. Это обратно несовместимое изменение: теперь функции `avg` и `avgWeighted` всегда возвращают `Float64` (как указано в документации). До этого изменения тип возвращаемого значения для аргументов `Decimal` также был `Decimal`. [#15419](https://github.com/ClickHouse/ClickHouse/pull/15419) ([Mike](https://github.com/myrrc)).
- Выражение `toUUID(N)` больше не работает. Замените на `toUUID('00000000-0000-0000-0000-000000000000')`. Это изменение обусловлено неочевидными результатами `toUUID(N)`, где N не равно нулю.
- SSL-сертификаты с некорректным «key usage» отклоняются. В предыдущих версиях они работали. См. [#19262](https://github.com/ClickHouse/ClickHouse/issues/19262).
- Ссылки `incl` на файл подстановок (`/etc/metrika.xml`) удалены из конфигурации по умолчанию (`<remote_servers>`, `<zookeeper>`, `<macros>`, `<compression>`, `<networks>`). Если вы использовали файл подстановок и полагались на эти неявные ссылки, вам следует вернуть их вручную и явно, добавив соответствующие секции с атрибутами `incl="..."` перед обновлением. См. [#18740](https://github.com/ClickHouse/ClickHouse/pull/18740) ([alexey-milovidov](https://github.com/alexey-milovidov)).

#### Новые возможности {#new-feature-10}


* Реализована поддержка протокола gRPC в ClickHouse. [#15111](https://github.com/ClickHouse/ClickHouse/pull/15111) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена возможность использовать несколько кластеров ZooKeeper. [#17070](https://github.com/ClickHouse/ClickHouse/pull/17070) ([fastio](https://github.com/fastio)).
* Реализованы запросы `REPLACE TABLE` и `CREATE OR REPLACE TABLE`. [#18521](https://github.com/ClickHouse/ClickHouse/pull/18521) ([tavplubix](https://github.com/tavplubix)).
* Реализовать `UNION DISTINCT` и по умолчанию интерпретировать обычный оператор `UNION` как `UNION DISTINCT`. Добавить настройку `union_default_mode`, которая позволяет интерпретировать его как `UNION ALL` или требовать явного указания режима. [#16338](https://github.com/ClickHouse/ClickHouse/pull/16338) ([flynn](https://github.com/ucasFL)).
* Добавлена функция `accurateCastOrNull`, чем закрыта задача [#10290](https://github.com/ClickHouse/ClickHouse/issues/10290). Добавлены преобразования типов в выражениях `x IN (subquery)`, чем закрыта задача [#10266](https://github.com/ClickHouse/ClickHouse/issues/10266). [#16724](https://github.com/ClickHouse/ClickHouse/pull/16724) ([Maksim Kita](https://github.com/kitaisreal)).
* IP Dictionary напрямую поддерживает типы `IPv4` и `IPv6`. [#17571](https://github.com/ClickHouse/ClickHouse/pull/17571) ([vdimir](https://github.com/vdimir)).
* Словарь IP поддерживает получение по ключу. Исправляет [#18241](https://github.com/ClickHouse/ClickHouse/issues/18241). [#18480](https://github.com/ClickHouse/ClickHouse/pull/18480) ([vdimir](https://github.com/vdimir)).
* Добавлена поддержка сжатия и распаковки `*.zst` для импорта и экспорта данных. Это позволяет использовать файлы `*.zst` в функции `file()` и заголовок `Content-encoding: zstd` в HTTP‑клиенте. Закрывает [#16791 ](https://github.com/ClickHouse/ClickHouse/issues/16791). [#17144](https://github.com/ClickHouse/ClickHouse/pull/17144) ([Abi Palagashvili](https://github.com/fibersel)).
* Добавлены агрегатные функции `mannWitneyUTest`, `studentTTest` и `welchTTest`. Функция `rankCorr` немного переработана. [#16883](https://github.com/ClickHouse/ClickHouse/pull/16883) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлены функции `countMatches` и `countMatchesCaseInsensitive`. [#17459](https://github.com/ClickHouse/ClickHouse/pull/17459) ([Azat Khuzhin](https://github.com/azat)).
* Реализованы функции `countSubstrings()`/`countSubstringsCaseInsensitive()`/`countSubstringsCaseInsensitiveUTF8()` (подсчет количества вхождений подстроки). [#17347](https://github.com/ClickHouse/ClickHouse/pull/17347) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена информация об используемых базах данных, таблицах и столбцах в system.query&#95;log. Добавлены поля `query_kind` и `normalized_query_hash`. [#17726](https://github.com/ClickHouse/ClickHouse/pull/17726) ([Amos Bird](https://github.com/amosbird)).
* Добавлена настройка `optimize_on_insert`. При включении к вставляемому (INSERT) блоку данных применяется то же преобразование, как если бы над этим блоком был выполнен merge (например, Replacing, Collapsing, Aggregating...). Эта настройка включена по умолчанию. Она может повлиять на поведение materialized view и MaterializeMySQL (см. подробное описание). Исправляет [#10683](https://github.com/ClickHouse/ClickHouse/issues/10683). [#16954](https://github.com/ClickHouse/ClickHouse/pull/16954) ([Kruglov Pavel](https://github.com/Avogar)).
* Аутентификация в Kerberos для HDFS. [#16621](https://github.com/ClickHouse/ClickHouse/pull/16621) ([Ilya Golshtein](https://github.com/ilejn)).
* Добавлена поддержка оператора `SHOW SETTINGS` для отображения параметров в system.settings. Также поддерживаются `SHOW CHANGED SETTINGS` и оператор `LIKE/ILIKE`. [#18056](https://github.com/ClickHouse/ClickHouse/pull/18056) ([Jianmei Zhang](https://github.com/zhangjmruc)).
* Функция `position` теперь поддерживает синтаксис `POSITION(needle IN haystack)` для обеспечения совместимости с SQL. Это закрывает [#18701](https://github.com/ClickHouse/ClickHouse/issues/18701). ... [#18779](https://github.com/ClickHouse/ClickHouse/pull/18779) ([Jianmei Zhang](https://github.com/zhangjmruc)).
* Теперь доступна новая настройка хранилища `max_partitions_to_read` для таблиц семейства MergeTree. Она ограничивает максимальное количество разделов, к которым можно получить доступ в одном запросе. Также добавлена пользовательская настройка `force_max_partition_limit` для принудительного применения этого ограничения. [#18712](https://github.com/ClickHouse/ClickHouse/pull/18712) ([Amos Bird](https://github.com/amosbird)).
* Добавлен столбец `query_id` в `system.part_log` для вставленных частей. Закрывает [#10097](https://github.com/ClickHouse/ClickHouse/issues/10097). [#18644](https://github.com/ClickHouse/ClickHouse/pull/18644) ([flynn](https://github.com/ucasFL)).
* Теперь допускается создание таблицы через `CREATE TABLE ... AS SELECT` с явным указанием столбцов. Пример: `CREATE TABLE t1 (x String) ENGINE = Memory AS SELECT 1;`. [#18060](https://github.com/ClickHouse/ClickHouse/pull/18060) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлены агрегирующие функции `arrayMin`, `arrayMax`, `arrayAvg`. [#18032](https://github.com/ClickHouse/ClickHouse/pull/18032) ([Maksim Kita](https://github.com/kitaisreal)).
* Реализован запрос `ATTACH TABLE name FROM 'path/to/data/' (col1 Type1, ...`, который создаёт новую таблицу с заданной структурой и подключает к ней данные из указанного каталога в `user_files`. [#17903](https://github.com/ClickHouse/ClickHouse/pull/17903) ([tavplubix](https://github.com/tavplubix)).
* Добавлена поддержка мутаций для StorageMemory. Тем самым закрывается задача [#9117](https://github.com/ClickHouse/ClickHouse/issues/9117). [#15127](https://github.com/ClickHouse/ClickHouse/pull/15127) ([flynn](https://github.com/ucasFL)).
* Добавлена поддержка синтаксиса `EXISTS DATABASE name`. [#18458](https://github.com/ClickHouse/ClickHouse/pull/18458) ([Du Chuan](https://github.com/spongedu)).
* Добавлена поддержка встроенных функций `isIPv4String` и `isIPv6String` по аналогии с [MySQL](https://github.com/ClickHouse/ClickHouse/compare/master...spongedu:support_is_ipv4?expand=1). [#18349](https://github.com/ClickHouse/ClickHouse/pull/18349) ([Du Chuan](https://github.com/spongedu)).
* Добавлена новая настройка `insert_distributed_one_random_shard = 1`, позволяющая выполнять вставку в распределённую таблицу с несколькими шардами без ключа распределения. [#18294](https://github.com/ClickHouse/ClickHouse/pull/18294) ([Amos Bird](https://github.com/amosbird)).
* Добавлены настройки `min_compress_block_size` и `max_compress_block_size` в MergeTreeSettings, которые имеют более высокий приоритет по сравнению с глобальными настройками и применяются, когда заданы. Закрывает [13890](https://github.com/ClickHouse/ClickHouse/issues/13890). [#17867](https://github.com/ClickHouse/ClickHouse/pull/17867) ([flynn](https://github.com/ucasFL)).
* Добавлена поддержка 64-битных битмапов Roaring. [#17858](https://github.com/ClickHouse/ClickHouse/pull/17858) ([Andy Yang](https://github.com/andyyzh)).
* Расширен синтаксис `OPTIMIZE ... DEDUPLICATE`, чтобы разрешить явное (или неявное с использованием звёздочки/преобразователей столбцов) указание списка столбцов, по которым выполняется проверка на дубликаты. ... [#17846](https://github.com/ClickHouse/ClickHouse/pull/17846) ([Vasily Nemkov](https://github.com/Enmk)).
* Добавлены функции `toModifiedJulianDay`, `fromModifiedJulianDay`, `toModifiedJulianDayOrNull` и `fromModifiedJulianDayOrNull`. Эти функции преобразуют дату в пролептическом григорианском календаре в число модифицированного юлианского дня (Modified Julian Day) и обратно. [#17750](https://github.com/ClickHouse/ClickHouse/pull/17750) ([PHO](https://github.com/depressed-pho)).
* Добавлена возможность использовать пользовательский список доменов верхнего уровня (TLD): добавлены функции `firstSignificantSubdomainCustom`, `cutToFirstSignificantSubdomainCustom`. [#17748](https://github.com/ClickHouse/ClickHouse/pull/17748) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка протокола `PROXYv1` для обёртки нативного TCP-интерфейса. Разрешено использовать квоты, привязанные к IP-адресу, переданному через прокси (применяется для адреса из `PROXYv1` и для `X-Forwarded-For` из HTTP-интерфейса). Это полезно, когда вы предоставляете доступ к ClickHouse только через доверенный прокси (например, CloudFlare), но хотите учитывать использование ресурсов пользователями по их исходным IP-адресам. Это исправляет [#17268](https://github.com/ClickHouse/ClickHouse/issues/17268). [#17707](https://github.com/ClickHouse/ClickHouse/pull/17707) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Теперь clickhouse-client поддерживает открытие `EDITOR` для редактирования команд с помощью `Alt-Shift-E`. [#17665](https://github.com/ClickHouse/ClickHouse/pull/17665) ([Amos Bird](https://github.com/amosbird)).
* Добавлена функция `encodeXMLComponent` для экранирования символов при помещении строки в текстовый узел XML или атрибут. [#17659](https://github.com/ClickHouse/ClickHouse/pull/17659) ([nauta](https://github.com/nautaa)).
* Введён синтаксис `DETACH TABLE/VIEW ... PERMANENTLY`, при котором после перезапуска таблица не появляется автоматически (её можно вернуть только по явному запросу). Таблицу по-прежнему можно присоединить обратно с помощью краткого синтаксиса ATTACH TABLE. Реализует [#5555](https://github.com/ClickHouse/ClickHouse/issues/5555). Исправляет [#13850](https://github.com/ClickHouse/ClickHouse/issues/13850). [#17642](https://github.com/ClickHouse/ClickHouse/pull/17642) ([filimonov](https://github.com/filimonov)).
* Добавлены асинхронные метрики общего числа строк, байт и кусков в таблицах MergeTree. Исправляет [#11714](https://github.com/ClickHouse/ClickHouse/issues/11714). [#17639](https://github.com/ClickHouse/ClickHouse/pull/17639) ([flynn](https://github.com/ucasFL)).
* Добавлены настройки `limit` и `offset` для пагинации вне самого SQL-запроса: [#16176](https://github.com/ClickHouse/ClickHouse/issues/16176) Они полезны при построении API. Эти две настройки будут влиять на запрос SELECT так, как если бы он был изменён следующим образом: `select * from (your_original_select_query) t limit xxx offset xxx;`. [#17633](https://github.com/ClickHouse/ClickHouse/pull/17633) ([hexiaoting](https://github.com/hexiaoting)).
* Добавлен новый комбинатор агрегатных функций: `-SimpleState` для построения типов `SimpleAggregateFunction` в запросах. Он полезен при определении `MaterializedView` с движком `AggregatingMergeTree`, а также будет полезен для проекций. [#16853](https://github.com/ClickHouse/ClickHouse/pull/16853) ([Amos Bird](https://github.com/amosbird)).
* Добавлен параметр `queries-file` для `clickhouse-client` и `clickhouse-local`. [#15930](https://github.com/ClickHouse/ClickHouse/pull/15930) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлен параметр `query` для `clickhouse-benchmark`. [#17832](https://github.com/ClickHouse/ClickHouse/pull/17832) ([Maksim Kita](https://github.com/kitaisreal)).
* `EXPLAIN AST` теперь поддерживает не только запросы `SELECT`. [#18136](https://github.com/ClickHouse/ClickHouse/pull/18136) ([taiyang-li](https://github.com/taiyang-li)).

#### Экспериментальная функциональность {#experimental-feature-8}

- Добавлены функции для вычисления minHash и simHash текстовых n-грамм и шинглов. Они предназначены для поиска полудубликатов. Также добавлены функции `bitHammingDistance` и `tupleHammingDistance`. [#7649](https://github.com/ClickHouse/ClickHouse/pull/7649) ([flynn](https://github.com/ucasFL)).
- Добавлен новый тип данных `Map`. См. [#1841](https://github.com/ClickHouse/ClickHouse/issues/1841). Первая версия Map поддерживает только тип `String` для ключей и значений. [#15806](https://github.com/ClickHouse/ClickHouse/pull/15806) ([hexiaoting](https://github.com/hexiaoting)).
- Реализован альтернативный парсер SQL на основе среды выполнения ANTLR4, сгенерированный из грамматики EBNF. [#11298](https://github.com/ClickHouse/ClickHouse/pull/11298) ([Ivan](https://github.com/abyss7)).

#### Улучшение производительности {#performance-improvement-10}


* Новая реализация IP Dictionary с меньшим потреблением памяти, улучшенной производительностью в некоторых сценариях и исправленными ошибками. [#16804](https://github.com/ClickHouse/ClickHouse/pull/16804) ([vdimir](https://github.com/vdimir)).
* Параллельное форматирование для экспорта данных. [#11617](https://github.com/ClickHouse/ClickHouse/pull/11617) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Интеграция с LDAP: добавлен параметр `verification_cooldown` в конфигурацию подключения к серверу LDAP, позволяющий кэшировать успешные попытки &quot;bind&quot; в течение настраиваемого периода времени. [#15988](https://github.com/ClickHouse/ClickHouse/pull/15988) ([Denis Glazachev](https://github.com/traceon)).
* Добавлена опция `--no-system-table` для `clickhouse-local`, позволяющая запускать его без системных таблиц. Это позволяет избежать инициализации `DateLUT`, которая при старте может занимать заметное время (десятки миллисекунд). [#18899](https://github.com/ClickHouse/ClickHouse/pull/18899) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Заменили `PODArray` на `PODArrayWithStackMemory` в `AggregateFunctionWindowFunnelData` для повышения производительности функции `windowFunnel`. [#18817](https://github.com/ClickHouse/ClickHouse/pull/18817) ([flynn](https://github.com/ucasFL)).
* Не отправлять пустые блоки на шарды при синхронном выполнении INSERT в таблицу Distributed. Закрывает [#14571](https://github.com/ClickHouse/ClickHouse/issues/14571). [#18775](https://github.com/ClickHouse/ClickHouse/pull/18775) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Оптимизировано чтение из StorageMemory. [#18052](https://github.com/ClickHouse/ClickHouse/pull/18052) ([Maksim Kita](https://github.com/kitaisreal)).
* Использование алгоритма Dragonbox для преобразования `float` в строку вместо ryu. Это значительно повышает производительность преобразования `float` в строку. [#17831](https://github.com/ClickHouse/ClickHouse/pull/17831) ([Maksim Kita](https://github.com/kitaisreal)).
* Ускорена реализация функции `IPv6CIDRToRange`. [#17569](https://github.com/ClickHouse/ClickHouse/pull/17569) ([vdimir](https://github.com/vdimir)).
* Добавлена настройка `remerge_sort_lowered_memory_bytes_ratio` (если использование памяти после повторного слияния не уменьшается как минимум на этот коэффициент, повторное слияние будет отключено). [#17539](https://github.com/ClickHouse/ClickHouse/pull/17539) ([Azat Khuzhin](https://github.com/azat)).
* Повышена производительность AggregatingMergeTree с SimpleAggregateFunction(String) в PK. [#17109](https://github.com/ClickHouse/ClickHouse/pull/17109) ([Azat Khuzhin](https://github.com/azat)).
* Теперь комбинатор `-If` девиртуализирован, а `count` корректно векторизуется. Это сделано в рамках [этого PR](https://github.com/ClickHouse/ClickHouse/pull/17041). [#17043](https://github.com/ClickHouse/ClickHouse/pull/17043) ([Amos Bird](https://github.com/amosbird)).
* Исправлена проблема с производительностью чтения из таблиц `Merge` при работе с очень большим числом таблиц `MergeTree`. Исправляет [#7748](https://github.com/ClickHouse/ClickHouse/issues/7748). [#16988](https://github.com/ClickHouse/ClickHouse/pull/16988) ([Anton Popov](https://github.com/CurtizJ)).
* Улучшена производительность функции `repeat`. [#16937](https://github.com/ClickHouse/ClickHouse/pull/16937) ([satanson](https://github.com/satanson)).
* Незначительно улучшена производительность разбора чисел с плавающей запятой. [#16809](https://github.com/ClickHouse/ClickHouse/pull/16809) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена возможность пропускать уже объединённые партиции при выполнении `OPTIMIZE TABLE ... FINAL`. [#15939](https://github.com/ClickHouse/ClickHouse/pull/15939) ([Kruglov Pavel](https://github.com/Avogar)).
* Интеграция с [fast&#95;float от Daniel Lemire](https://github.com/lemire/fast_float) для разбора чисел с плавающей запятой. [#16787](https://github.com/ClickHouse/ClickHouse/pull/16787) ([Maksim Kita](https://github.com/kitaisreal)). Она не включена, так как её производительность всё ещё ниже, чем у встроенного простого парсера чисел с плавающей запятой в ClickHouse.
* Исправлен параметр `max_distributed_connections` (влияет на `prefer_localhost_replica = 1` и случай, когда `max_threads != max_distributed_connections`). [#17848](https://github.com/ClickHouse/ClickHouse/pull/17848) ([Azat Khuzhin](https://github.com/azat)).
* Адаптивный выбор между загрузкой одним фрагментом и многочастичной загрузкой при отправке данных в S3. Однофрагментная загрузка настраивается с помощью нового параметра `max_single_part_upload_size`. [#17934](https://github.com/ClickHouse/ClickHouse/pull/17934) ([Pavel Kovalenko](https://github.com/Jokser)).
* Поддержка асинхронных задач в `PipelineExecutor`. Базовая поддержка асинхронных сокетов для удалённых запросов. [#17868](https://github.com/ClickHouse/ClickHouse/pull/17868) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Разрешили использовать оптимизацию `optimize_move_to_prewhere` для компактных частей, если размеры столбцов неизвестны. [#17330](https://github.com/ClickHouse/ClickHouse/pull/17330) ([Anton Popov](https://github.com/CurtizJ)).

#### Улучшение {#improvement-10}


* Избежание взаимной блокировки при выполнении `INSERT SELECT` в ту же таблицу с движками таблиц `TinyLog` или `Log`. Это закрывает [#6802](https://github.com/ClickHouse/ClickHouse/issues/6802). Это закрывает [#18691](https://github.com/ClickHouse/ClickHouse/issues/18691). Это закрывает [#16812](https://github.com/ClickHouse/ClickHouse/issues/16812). Это закрывает [#14570](https://github.com/ClickHouse/ClickHouse/issues/14570). [#15260](https://github.com/ClickHouse/ClickHouse/pull/15260) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка синтаксиса `SHOW CREATE VIEW name`, как в [MySQL](https://dev.mysql.com/doc/refman/5.7/en/show-create-view.html). [#18095](https://github.com/ClickHouse/ClickHouse/pull/18095) ([Du Chuan](https://github.com/spongedu)).
* Разрешены все запросы типа `Decimal * Float` и наоборот, включая агрегатные (например, `SELECT sum(decimal_field * 1.1)` или `SELECT dec_col * float_col`), тип результата — Float32 или Float64. [#18145](https://github.com/ClickHouse/ClickHouse/pull/18145) ([Mike](https://github.com/myrrc)).
* Улучшен минимальный веб‑интерфейс: добавлена история; добавлена поддержка совместного использования; устранена гонка состояний при выполнении разных запросов; добавлены индикаторы выполняющегося и готового запроса; добавлен фавикон; добавлено распознавание нажатия Ctrl+Enter, когда фокус не в textarea. [#17293](https://github.com/ClickHouse/ClickHouse/pull/17293) [#17770](https://github.com/ClickHouse/ClickHouse/pull/17770) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* clickhouse-server не отправлял запрос `close` на сервер ZooKeeper. [#16837](https://github.com/ClickHouse/ClickHouse/pull/16837) ([alesapin](https://github.com/alesapin)).
* Предотвращено аварийное завершение работы сервера при слишком низких лимитах памяти (`max_memory_usage = 1` / `max_untracked_memory = 1`). [#17453](https://github.com/ClickHouse/ClickHouse/pull/17453) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен недетерминированный результат функции `windowFunnel` при совпадении временных меток у разных событий. [#18884](https://github.com/ClickHouse/ClickHouse/pull/18884) ([Fuwang Hu](https://github.com/fuwhu)).
* Docker: Явно установить uid/gid пользователя и группы clickhouse на фиксированное значение 101 в Docker-образах clickhouse-server. [#19096](https://github.com/ClickHouse/ClickHouse/pull/19096) ([filimonov](https://github.com/filimonov)).
* Асинхронные INSERT в таблицы `Distributed`: Добавлены два новых параметра настройки (по аналогии с семейством MergeTree): - `fsync_after_insert` — выполнять fsync после каждой вставки. Снижает производительность вставок. - `fsync_directories` — выполнять fsync для временного каталога (используется только для асинхронных INSERT) после завершения всех операций (записи, переименования и т. д.). [#18864](https://github.com/ClickHouse/ClickHouse/pull/18864) ([Azat Khuzhin](https://github.com/azat)).
* Команда `SYSTEM KILL` теперь работает в Docker, что закрывает [#18847](https://github.com/ClickHouse/ClickHouse/issues/18847). [#18848](https://github.com/ClickHouse/ClickHouse/pull/18848) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Разворачивать макросы в пути ZooKeeper при выполнении `FETCH PARTITION`. [#18839](https://github.com/ClickHouse/ClickHouse/pull/18839) ([fastio](https://github.com/fastio)).
* Примените `ALTER TABLE <replicated_table> ON CLUSTER MODIFY SETTING ...` ко всем репликам, поскольку мы не реплицируем такие операторы ALTER. [#18789](https://github.com/ClickHouse/ClickHouse/pull/18789) ([Amos Bird](https://github.com/amosbird)).
* Позволить преобразователю столбцов `EXCEPT` принимать строку в качестве шаблона регулярного выражения. Это решает [#18685](https://github.com/ClickHouse/ClickHouse/issues/18685). [#18699](https://github.com/ClickHouse/ClickHouse/pull/18699) ([Amos Bird](https://github.com/amosbird)).
* Исправлена работа SimpleAggregateFunction в SummingMergeTree. Теперь он работает как AggregateFunction. В предыдущих версиях значения просто суммировались, игнорируя агрегатную функцию. Это исправляет [#18564](https://github.com/ClickHouse/ClickHouse/issues/18564). [#8052](https://github.com/ClickHouse/ClickHouse/issues/8052). [#18637](https://github.com/ClickHouse/ClickHouse/pull/18637) ([Amos Bird](https://github.com/amosbird)). Дополнительно исправлено использование `SimpleAggregateFunction` в `SummingMergeTree`. Это исправляет [#18676](https://github.com/ClickHouse/ClickHouse/issues/18676). [#18677](https://github.com/ClickHouse/ClickHouse/pull/18677) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка assert внутри аллокатора, возникавшая, если последний аргумент функции bar был NaN. Теперь выбрасывается обычное исключение ClickHouse. Это исправляет [#17876](https://github.com/ClickHouse/ClickHouse/issues/17876). [#18520](https://github.com/ClickHouse/ClickHouse/pull/18520) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена проблема с удобством использования: в некоторых инструментах после сообщения об исключении отсутствовал символ новой строки. [#18444](https://github.com/ClickHouse/ClickHouse/pull/18444) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность изменять тип столбца первичного ключа и ключа партиционирования с `LowCardinality(Type)` на `Type` и обратно. Также добавлена возможность изменять тип столбца первичного ключа с `EnumX` на `IntX`. Исправление для [#5604](https://github.com/ClickHouse/ClickHouse/issues/5604). [#18362](https://github.com/ClickHouse/ClickHouse/pull/18362) ([alesapin](https://github.com/alesapin)).
* Реализован доступ к полям через `untuple`. [#18133](https://github.com/ClickHouse/ClickHouse/issues/18133). [#18309](https://github.com/ClickHouse/ClickHouse/pull/18309) ([hexiaoting](https://github.com/hexiaoting)).
* Добавлена возможность разбирать поля типа Array из CSV, если они представлены в виде строки, содержащей массив, сериализованный как вложенный CSV. Пример: `"[""Hello"", ""world"", ""42"""" TV""]"` будет разобран как `['Hello', 'world', '42" TV']`. Добавлена возможность разбирать массив в CSV, представленный строкой без окружающих квадратных скобок. Пример: `"'Hello', 'world', '42"" TV'"` будет разобран как `['Hello', 'world', '42" TV']`. [#18271](https://github.com/ClickHouse/ClickHouse/pull/18271) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Улучшен расчёт адаптивной гранулярности для широких частей MergeTree. [#18223](https://github.com/ClickHouse/ClickHouse/pull/18223) ([alesapin](https://github.com/alesapin)).
* Теперь `clickhouse install` работает на macOS. Проблема заключалась в том, что на этой платформе отсутствует procfs. [#18201](https://github.com/ClickHouse/ClickHouse/pull/18201) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Улучшены подсказки по синтаксису запросов `SHOW ...`. [#18183](https://github.com/ClickHouse/ClickHouse/pull/18183) ([Du Chuan](https://github.com/spongedu)).
* Агрегирующие функции для массивов `arrayMin`, `arrayMax`, `arraySum`, `arrayAvg` теперь поддерживают типы `Int128`, `Int256`, `UInt256`. [#18147](https://github.com/ClickHouse/ClickHouse/pull/18147) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлен параметр `disk` в настройки хранилищ Set и Join. [#18112](https://github.com/ClickHouse/ClickHouse/pull/18112) ([Grigory Pervakov](https://github.com/GrigoryPervakov)).
* Управление доступом: теперь табличная функция `merge()` требует, чтобы у текущего пользователя было право `SELECT` для каждой таблицы, из которой она читает данные. Этот PR исправляет [#16964](https://github.com/ClickHouse/ClickHouse/issues/16964). [#18104](https://github.com/ClickHouse/ClickHouse/pull/18104) [#17983](https://github.com/ClickHouse/ClickHouse/pull/17983) ([Vitaly Baranov](https://github.com/vitlibar)).
* Временные таблицы теперь видны в системных таблицах `system.tables` и `system.columns` только в тех сессиях, в которых они были созданы. Внутренняя база данных `_temporary_and_external_tables` больше не отображается в этих системных таблицах; вместо этого временные таблицы показываются как таблицы с пустым именем базы данных и установленным флагом `is_temporary`. [#18014](https://github.com/ClickHouse/ClickHouse/pull/18014) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена проблема с отображением clickhouse-client при изменении размера окна терминала. [#18009](https://github.com/ClickHouse/ClickHouse/pull/18009) ([Amos Bird](https://github.com/amosbird)).
* Уменьшен уровень детализации логирования событий, когда клиент разрывает соединение: уровень снижен с Warning до Information. [#18005](https://github.com/ClickHouse/ClickHouse/pull/18005) ([filimonov](https://github.com/filimonov)).
* Принудительное удаление пустых или некорректных файлов метаданных из файловой системы для диска S3 (DiskS3). S3 — экспериментальная возможность. [#17935](https://github.com/ClickHouse/ClickHouse/pull/17935) ([Pavel Kovalenko](https://github.com/Jokser)).
* Управление доступом: `allow_introspection_functions=0` запрещает использование функций интроспекции, но больше не запрещает выдачу прав на них (получателю прав потребуется установить у себя `allow_introspection_functions=1`, чтобы иметь возможность пользоваться этими правами). Аналогично, `allow_ddl=0` запрещает использование DDL-команд, но больше не запрещает выдачу прав на них. [#17908](https://github.com/ClickHouse/ClickHouse/pull/17908) ([Vitaly Baranov](https://github.com/vitlibar)).
* Повышение удобства использования: подсказки для названий столбцов. [#17112](https://github.com/ClickHouse/ClickHouse/issues/17112). [#17857](https://github.com/ClickHouse/ClickHouse/pull/17857) ([fastio](https://github.com/fastio)).
* Добавлена диагностическая информация для случая, когда две таблицы Merge пытаются читать данные друг друга. [#17854](https://github.com/ClickHouse/ClickHouse/pull/17854) ([徐炘](https://github.com/weeds085490)).
* Добавлена возможность переопределять значение тайм‑аута для выполняемого скрипта при использовании образа ClickHouse для Docker. [#17818](https://github.com/ClickHouse/ClickHouse/pull/17818) ([Guillaume Tassery](https://github.com/YiuRULE)).
* Проверяется синтаксис определения движков системных таблиц логов, чтобы предотвратить часть ошибок конфигурации. Следует учитывать, что эта проверка касается только синтаксиса: такие ошибки, как обращение к несуществующим столбцам или функциям, будут обнаружены лишь при создании таблицы. [#17739](https://github.com/ClickHouse/ClickHouse/pull/17739) ([Du Chuan](https://github.com/spongedu)).
* Удалено выбрасывание исключения при инициализации таблицы `RabbitMQ` при отсутствии соединения (теперь переподключение выполняется в фоновом режиме). [#17709](https://github.com/ClickHouse/ClickHouse/pull/17709) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Не игнорировать лимиты памяти сервера при сбросе Buffer. [#17646](https://github.com/ClickHouse/ClickHouse/pull/17646) ([Azat Khuzhin](https://github.com/azat)).
* Переход на исправленную версию RocksDB (из ClickHouse-Extras) для устранения ошибки типа use-after-free. [#17643](https://github.com/ClickHouse/ClickHouse/pull/17643) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлено смещение в текст сообщения об исключении при параллельном парсинге. Это исправляет [#17457](https://github.com/ClickHouse/ClickHouse/issues/17457). [#17641](https://github.com/ClickHouse/ClickHouse/pull/17641) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Не выбрасывать ошибку &quot;Too many parts&quot; во время выполнения запроса INSERT. [#17566](https://github.com/ClickHouse/ClickHouse/pull/17566) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Разрешено использовать параметры запроса в операторе UPDATE в запросе ALTER. Исправление [#10976](https://github.com/ClickHouse/ClickHouse/issues/10976). [#17563](https://github.com/ClickHouse/ClickHouse/pull/17563) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Обфускатор запросов: позволяет избежать использования некоторых ключевых слов SQL в качестве имён идентификаторов. [#17526](https://github.com/ClickHouse/ClickHouse/pull/17526) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Экспортировать текущую максимальную запись DDL, выполненную DDLWorker, через серверную метрику. Это полезно для проверки, не завис ли где-нибудь DDLWorker. [#17464](https://github.com/ClickHouse/ClickHouse/pull/17464) ([Amos Bird](https://github.com/amosbird)).
* Экспорт асинхронных метрик текущих потоков на всех серверах. Это полезно для диагностики проблем, подобных [этой](https://github.com/ClickHouse-Extras/poco/pull/28). [#17463](https://github.com/ClickHouse/ClickHouse/pull/17463) ([Amos Bird](https://github.com/amosbird)).
* Динамические столбцы, такие как MATERIALIZED / ALIAS, теперь включаются в запросы с подстановочным символом, если настройки `asterisk_include_materialized_columns` и `asterisk_include_alias_columns` включены. [#17462](https://github.com/ClickHouse/ClickHouse/pull/17462) ([Ken Chen](https://github.com/chenziliang)).
* Добавлена возможность указывать [TTL](/engines/table-engines/mergetree-family/mergetree/#mergetree-table-ttl) для удаления старых записей из [таблиц системных логов](/operations/system-tables/) с помощью атрибута `<ttl>` в `config.xml`. [#17438](https://github.com/ClickHouse/ClickHouse/pull/17438) ([Du Chuan](https://github.com/spongedu)).
* Теперь запросы, поступающие на сервер по протоколам MySQL и PostgreSQL, имеют отдельные типы интерфейсов (их можно увидеть в столбце `interface` таблицы `system.query_log`): `4` для MySQL и `5` для PostgreSQL, вместо ранее использовавшегося значения `1`, которое теперь применяется только для нативного протокола. [#17437](https://github.com/ClickHouse/ClickHouse/pull/17437) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен разбор клаузы SETTINGS в запросе `INSERT ... SELECT ... SETTINGS`. [#17414](https://github.com/ClickHouse/ClickHouse/pull/17414) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен учет памяти в RadixSort. [#17412](https://github.com/ClickHouse/ClickHouse/pull/17412) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлена проверка на EOF в `receiveHello` на сервере, чтобы предотвратить исключение `Attempt to read after eof`. [#17365](https://github.com/ClickHouse/ClickHouse/pull/17365) ([Kruglov Pavel](https://github.com/Avogar)).
* Предотвращено возможное переполнение стека при преобразовании в bigint. Поддержка больших целых чисел носит экспериментальный характер. [#17269](https://github.com/ClickHouse/ClickHouse/pull/17269) ([flynn](https://github.com/ucasFL)).
* Теперь индексы `set` работают с `GLOBAL IN`. Исправлены ошибки [#17232](https://github.com/ClickHouse/ClickHouse/issues/17232), [#5576](https://github.com/ClickHouse/ClickHouse/issues/5576). [#17253](https://github.com/ClickHouse/ClickHouse/pull/17253) ([Amos Bird](https://github.com/amosbird)).
* Добавлен лимит на количество HTTP-перенаправлений в запросах к хранилищу S3 (`s3_max_redirects`). [#17220](https://github.com/ClickHouse/ClickHouse/pull/17220) ([ianton-ru](https://github.com/ianton-ru)).
* При совместном использовании комбинатора `-OrNull` с комбинаторами `-If`, `-Merge`, `-MergeState`, `-State` следует ставить `-OrNull` перед ними. [#16935](https://github.com/ClickHouse/ClickHouse/pull/16935) ([flynn](https://github.com/ucasFL)).
* Поддержка настройки HTTP‑прокси и HTTPS‑конечной точки S3. [#16861](https://github.com/ClickHouse/ClickHouse/pull/16861) ([Pavel Kovalenko](https://github.com/Jokser)).
* Добавлена корректная аутентификация через переменные окружения, файл `~/.aws` и механизм `AssumeRole` для клиента S3. [#16856](https://github.com/ClickHouse/ClickHouse/pull/16856) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Добавлены дополнительные спаны OpenTelemetry. Добавлен пример экспорта данных спанов в Zipkin. [#16535](https://github.com/ClickHouse/ClickHouse/pull/16535) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Кэш-словари: полностью устранены колбэки и блокировки при их получении. Ключи не разделяются на «not found» и «expired», а хранятся в одной и той же map в ходе выполнения запроса. [#14958](https://github.com/ClickHouse/ClickHouse/pull/14958) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлены никогда не работавшие параметры `fsync_part_directory`/`fsync_after_insert`/`in_memory_parts_insert_sync` (экспериментальная функция). [#18845](https://github.com/ClickHouse/ClickHouse/pull/18845) ([Azat Khuzhin](https://github.com/azat)).
* Разрешено использовать движок `Atomic` для внутренней базы данных движка `MaterializeMySQL`. [#14849](https://github.com/ClickHouse/ClickHouse/pull/14849) ([tavplubix](https://github.com/tavplubix)).

#### Исправление ошибок {#bug-fix-10}


* Исправлена ошибка, из-за которой сервер в крайне редких случаях мог перестать принимать подключения. [#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) (Amos Bird, [alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен анализ индексов бинарных функций с константным аргументом, который приводил к некорректным результатам запросов. Это исправление закрывает [#18364](https://github.com/ClickHouse/ClickHouse/issues/18364). [#18373](https://github.com/ClickHouse/ClickHouse/pull/18373) ([Amos Bird](https://github.com/amosbird)).
* Исправлен возможный неверный анализ индекса при сравнении значений разных типов. Это исправляет [#17122](https://github.com/ClickHouse/ClickHouse/issues/17122). [#17145](https://github.com/ClickHouse/ClickHouse/pull/17145) ([Amos Bird](https://github.com/amosbird)).
* Отключено использование AIO для записи во время слияний, так как это может приводить к крайне редкой порче данных в столбцах первичного ключа при слиянии. [#18481](https://github.com/ClickHouse/ClickHouse/pull/18481) ([alesapin](https://github.com/alesapin)).
* Ограничены операции слияния из широких частей в компактные. В случае вертикального слияния это приводило к некорректной результирующей части. [#18381](https://github.com/ClickHouse/ClickHouse/pull/18381) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена возможная неполнота результата запроса при чтении из `MergeTree*` в случае read backoff (сообщение `<Debug> MergeTreeReadPool: Will lower number of threads` в логах). Проблема была внесена в [#16423](https://github.com/ClickHouse/ClickHouse/issues/16423). Исправляет [#18137](https://github.com/ClickHouse/ClickHouse/issues/18137). [#18216](https://github.com/ClickHouse/ClickHouse/pull/18216) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка типа use-after-free в библиотеке `rocksdb`. [#18862](https://github.com/ClickHouse/ClickHouse/pull/18862) ([sundyli](https://github.com/sundy-li)).
* Исправлена проблема бесконечного чтения из файла в формате `ORC` (ошибка была допущена в [#10580](https://github.com/ClickHouse/ClickHouse/issues/10580)). Исправляет [#19095](https://github.com/ClickHouse/ClickHouse/issues/19095). [#19134](https://github.com/ClickHouse/ClickHouse/pull/19134) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка записи данных в MergeTree, которая могла приводить к созданию меток большего размера, чем фиксированный размер гранулярности. Исправляет [#18913](https://github.com/ClickHouse/ClickHouse/issues/18913). [#19123](https://github.com/ClickHouse/ClickHouse/pull/19123) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка при запуске, из-за которой ClickHouse не удавалось прочитать кодек сжатия из `LowCardinality(Nullable(...))` и выбрасывалось исключение `Attempt to read after EOF`. Исправляет [#18340](https://github.com/ClickHouse/ClickHouse/issues/18340). [#19101](https://github.com/ClickHouse/ClickHouse/pull/19101) ([alesapin](https://github.com/alesapin)).
* Ограничено выполнение запросов `MODIFY TTL` для таблиц `MergeTree`, созданных с использованием старого синтаксиса. Ранее такие запросы выполнялись успешно, но фактически не оказывали никакого эффекта. [#19064](https://github.com/ClickHouse/ClickHouse/pull/19064) ([Anton Popov](https://github.com/CurtizJ)).
* Теперь `groupUniqArray` возвращает корректный тип для аргумента типа Enum. Это закрывает [#17875](https://github.com/ClickHouse/ClickHouse/issues/17875). [#19019](https://github.com/ClickHouse/ClickHouse/pull/19019) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена возможная ошибка `Expected single dictionary argument for function` при использовании функции `ignore` с аргументом типа `LowCardinality`. Исправлено [#14275](https://github.com/ClickHouse/ClickHouse/issues/14275). [#19016](https://github.com/ClickHouse/ClickHouse/pull/19016) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена проблема вставки столбца `LowCardinality` в таблицу с движком `TinyLog`. Исправляет [#18629](https://github.com/ClickHouse/ClickHouse/issues/18629). [#19010](https://github.com/ClickHouse/ClickHouse/pull/19010) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Операция JOIN пытается материализовать константные столбцы, но наш код ожидает их в других местах. [#18982](https://github.com/ClickHouse/ClickHouse/pull/18982) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Отключена настройка `optimize_move_functions_out_of_any`, поскольку эта оптимизация не всегда корректна. Это закрывает [#18051](https://github.com/ClickHouse/ClickHouse/issues/18051). Это закрывает [#18973](https://github.com/ClickHouse/ClickHouse/issues/18973). [#18981](https://github.com/ClickHouse/ClickHouse/pull/18981) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено возможное исключение `QueryPipeline stream: different number of columns`, возникавшее при объединении шагов типа `Expression` в плане запроса. Исправление для [#18190](https://github.com/ClickHouse/ClickHouse/issues/18190). [#18980](https://github.com/ClickHouse/ClickHouse/pull/18980) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена крайне редкая взаимоблокировка при завершении работы. [#18977](https://github.com/ClickHouse/ClickHouse/pull/18977) ([tavplubix](https://github.com/tavplubix)).
* Исправлено некорректное поведение, из-за которого запрос `ALTER TABLE ... DROP PART 'part_name'` удалял все блоки дедупликации для всего раздела. Устраняет проблему [#18874](https://github.com/ClickHouse/ClickHouse/issues/18874). [#18969](https://github.com/ClickHouse/ClickHouse/pull/18969) ([alesapin](https://github.com/alesapin)).
* Операция `ATTACH PARTITION` должна сбрасывать мутацию. [#18804](https://github.com/ClickHouse/ClickHouse/issues/18804). [#18935](https://github.com/ClickHouse/ClickHouse/pull/18935) ([fastio](https://github.com/fastio)).
* Исправлена ошибка в `bitmapOrCardinality`, которая могла приводить к разыменованию нулевого указателя. Это закрывает [#18911](https://github.com/ClickHouse/ClickHouse/issues/18911). [#18912](https://github.com/ClickHouse/ClickHouse/pull/18912) ([sundyli](https://github.com/sundy-li)).
* Исправлено возможное зависание при завершении работы `clickhouse-local`. Это исправляет [#18891](https://github.com/ClickHouse/ClickHouse/issues/18891). [#18893](https://github.com/ClickHouse/ClickHouse/pull/18893) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Запросы к внешним базам данных (MySQL, ODBC, JDBC) некорректно переписывались, если содержали выражение вида `x IN table`. Это исправляет [#9756](https://github.com/ClickHouse/ClickHouse/issues/9756). [#18876](https://github.com/ClickHouse/ClickHouse/pull/18876) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен комбинатор *If с унарной функцией и типами Nullable. [#18806](https://github.com/ClickHouse/ClickHouse/pull/18806) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема, из-за которой асинхронные распределённые INSERT-запросы могли отклоняться сервером, если настройка `network_compression_method` глобально установлена в значение, отличное от значения по умолчанию. Это исправляет [#18741](https://github.com/ClickHouse/ClickHouse/issues/18741). [#18776](https://github.com/ClickHouse/ClickHouse/pull/18776) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка `Attempt to read after eof` при попытке выполнить `CAST` значения `NULL` из `Nullable(String)` в `Nullable(Decimal(P, S))`. Теперь функция `CAST` возвращает `NULL`, когда не может разобрать десятичное число из строки типа `Nullable(String)`. Исправляет [#7690](https://github.com/ClickHouse/ClickHouse/issues/7690). [#18718](https://github.com/ClickHouse/ClickHouse/pull/18718) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена незначительная проблема с логированием. [#18717](https://github.com/ClickHouse/ClickHouse/pull/18717) ([sundyli](https://github.com/sundy-li)).
* Исправлено удаление пустых частей в таблицах `ReplicatedMergeTree`, созданных по старому синтаксису. Исправлена ошибка [#18582](https://github.com/ClickHouse/ClickHouse/issues/18582). [#18614](https://github.com/ClickHouse/ClickHouse/pull/18614) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена предыдущая ошибка при переполнении даты с различными значениями. Значение типа Date строго ограничено датой «2106-02-07», даты &gt; «2106-02-07» приводятся к значению 0. [#18565](https://github.com/ClickHouse/ClickHouse/pull/18565) ([hexiaoting](https://github.com/hexiaoting)).
* Добавлена поддержка типа данных FixedString для репликации из MySQL. Репликация из MySQL является экспериментальной функцией. Этот патч исправляет [#18450](https://github.com/ClickHouse/ClickHouse/issues/18450), а также [#6556](https://github.com/ClickHouse/ClickHouse/issues/6556). [#18553](https://github.com/ClickHouse/ClickHouse/pull/18553) ([awesomeleo](https://github.com/awesomeleo)).
* Исправлена возможная ошибка `Pipeline stuck` при использовании `ORDER BY` после подзапроса с `RIGHT`- или `FULL`-соединением. [#18550](https://github.com/ClickHouse/ClickHouse/pull/18550) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, которая могла приводить к зависанию запросов `ALTER` после принудительного завершения соответствующей мутации. Найдена thread fuzzer-ом. [#18518](https://github.com/ClickHouse/ClickHouse/pull/18518) ([alesapin](https://github.com/alesapin)).
* Обеспечена корректная поддержка значения 12AM в функции `parseDateTimeBestEffort`. Исправляет [#18402](https://github.com/ClickHouse/ClickHouse/issues/18402). [#18449](https://github.com/ClickHouse/ClickHouse/pull/18449) ([vladimir-golovchenko](https://github.com/vladimir-golovchenko)).
* Исправлена ошибка `value is too short` при выполнении функций `toType(...)` (`toDate`, `toUInt32` и т. д.) с аргументом типа `Nullable(String)`. Теперь такие функции возвращают `NULL` при ошибках разбора вместо выбрасывания исключения. Исправляет [#7673](https://github.com/ClickHouse/ClickHouse/issues/7673). [#18445](https://github.com/ClickHouse/ClickHouse/pull/18445) ([tavplubix](https://github.com/tavplubix)).
* Исправлено неожиданное поведение `SHOW TABLES`. [#18431](https://github.com/ClickHouse/ClickHouse/pull/18431) ([fastio](https://github.com/fastio)).
* Исправлено: комбинатор -SimpleState генерировал несовместимые типы аргумента и возвращаемого значения. [#18404](https://github.com/ClickHouse/ClickHouse/pull/18404) ([Amos Bird](https://github.com/amosbird)).
* Исправлена возможная гонка при одновременном использовании таблиц `Set` или `Join` и выполнении выборок из `system.tables`. [#18385](https://github.com/ClickHouse/ClickHouse/pull/18385) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено заполнение таблицы `system.settings_profile_elements`. Этот PR устраняет [#18231](https://github.com/ClickHouse/ClickHouse/issues/18231). [#18379](https://github.com/ClickHouse/ClickHouse/pull/18379) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлены возможные аварийные завершения агрегатных функций с комбинатором `Distinct` при использовании двухуровневой агрегации. Исправлено [#17682](https://github.com/ClickHouse/ClickHouse/issues/17682). [#18365](https://github.com/ClickHouse/ClickHouse/pull/18365) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена проблема, из-за которой процесс `clickhouse-odbc-bridge` был недоступен серверу на машинах с двойным стеком IPv4/IPv6; исправлена проблема, при которой обновления ODBC-словарей выполнялись с использованием некорректных запросов и/или приводили к сбоям процесса odbc-bridge; возможно, закрывает [#14489](https://github.com/ClickHouse/ClickHouse/issues/14489). [#18278](https://github.com/ClickHouse/ClickHouse/pull/18278) ([Denis Glazachev](https://github.com/traceon)).
* Управление доступом: теперь запрос `SELECT count() FROM table` можно выполнить, если у пользователя есть доступ хотя бы к одному столбцу таблицы. Этот PR исправляет [#10639](https://github.com/ClickHouse/ClickHouse/issues/10639). [#18233](https://github.com/ClickHouse/ClickHouse/pull/18233) ([Vitaly Baranov](https://github.com/vitlibar)).
* Управление доступом: `SELECT JOIN` теперь требует наличия привилегии `SELECT` для каждой из таблиц, участвующих в соединении. Этот PR исправляет [#17654](https://github.com/ClickHouse/ClickHouse/issues/17654). [#18232](https://github.com/ClickHouse/ClickHouse/pull/18232) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено сравнение ключей между типами Enum и Int. Это устраняет проблему [#17989](https://github.com/ClickHouse/ClickHouse/issues/17989). [#18214](https://github.com/ClickHouse/ClickHouse/pull/18214) ([Amos Bird](https://github.com/amosbird)).
* Репликация из MySQL (экспериментальная функция). Исправлены [#18186](https://github.com/ClickHouse/ClickHouse/issues/18186) и [#16372](https://github.com/ClickHouse/ClickHouse/issues/16372). Исправлена проблема с преобразованием уникального ключа в движке базы данных MaterializeMySQL. [#18211](https://github.com/ClickHouse/ClickHouse/pull/18211) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена несогласованность в запросах, использующих одновременно `WITH FILL` и `WITH TIES` [#17466](https://github.com/ClickHouse/ClickHouse/issues/17466). [#18188](https://github.com/ClickHouse/ClickHouse/pull/18188) ([hexiaoting](https://github.com/hexiaoting)).
* Исправлена проблема с вставкой строки со значением по умолчанию в случае ошибки разбора в последнем столбце. Исправляет [#17712](https://github.com/ClickHouse/ClickHouse/issues/17712). [#18182](https://github.com/ClickHouse/ClickHouse/pull/18182) ([Jianmei Zhang](https://github.com/zhangjmruc)).
* Исправлена ошибка `Unknown setting profile` при попытке установить профиль настроек. [#18167](https://github.com/ClickHouse/ClickHouse/pull/18167) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка, из-за которой запрос `MODIFY COLUMN ... REMOVE TTL` фактически не удалял TTL столбца. [#18130](https://github.com/ClickHouse/ClickHouse/pull/18130) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка `std::out_of_range: basic_string` при разборе URL-адреса S3. [#18059](https://github.com/ClickHouse/ClickHouse/pull/18059) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Исправлено сравнение типов `DateTime64` и `Date`. Исправляет [#13804](https://github.com/ClickHouse/ClickHouse/issues/13804) и [#11222](https://github.com/ClickHouse/ClickHouse/issues/11222). ... [#18050](https://github.com/ClickHouse/ClickHouse/pull/18050) ([Vasily Nemkov](https://github.com/Enmk)).
* Репликация из MySQL (экспериментальная функция): исправляет [#15187](https://github.com/ClickHouse/ClickHouse/issues/15187), исправляет [#17912](https://github.com/ClickHouse/ClickHouse/issues/17912), добавляет поддержку преобразования префиксных индексов MySQL для MaterializeMySQL. [#17944](https://github.com/ClickHouse/ClickHouse/pull/17944) ([Winter Zhang](https://github.com/zhang2014)).
* При настройке ротации серверных логов с использованием параметра `logger.size` со значением, превышающим 2^32, логи не ротировались должным образом. Это исправлено. [#17905](https://github.com/ClickHouse/ClickHouse/pull/17905) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Тривиальная оптимизация запроса приводила к неверным результатам, если запрос содержал ARRAY JOIN (то есть фактически был нетривиальным). [#17887](https://github.com/ClickHouse/ClickHouse/pull/17887) ([sundyli](https://github.com/sundy-li)).
* Исправлен возможный segфолт в агрегатной функции `topK`. Это закрывает [#17404](https://github.com/ClickHouse/ClickHouse/issues/17404). [#17845](https://github.com/ClickHouse/ClickHouse/pull/17845) ([Maksim Kita](https://github.com/kitaisreal)).
* WAL (экспериментальная возможность): не восстанавливать парты из WAL, если `in_memory_parts_enable_wal` отключён. [#17802](https://github.com/ClickHouse/ClickHouse/pull/17802) ([detailyang](https://github.com/detailyang)).
* Сообщение об исключении, связанное с максимальным размером таблицы для удаления, отображалось некорректно. [#17764](https://github.com/ClickHouse/ClickHouse/pull/17764) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена возможная ошибка сегментации при недостатке свободного места при вставке в таблицу `Distributed`. [#17737](https://github.com/ClickHouse/ClickHouse/pull/17737) ([tavplubix](https://github.com/tavplubix)).
* Исправлена проблема, из-за которой ClickHouse не удавалось возобновить соединение с серверами MySQL. [#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz)).
* Windows: Исправлена ошибка `Function not implemented` при выполнении запроса `RENAME` в базе данных `Atomic`, когда ClickHouse запущен в Windows Subsystem for Linux. Устраняет проблему [#17661](https://github.com/ClickHouse/ClickHouse/issues/17661). [#17664](https://github.com/ClickHouse/ClickHouse/pull/17664) ([tavplubix](https://github.com/tavplubix)).
* При выполнении запроса `ON CLUSTER` из-за гонки состояний при `pool_size` &gt; 1 могло быть некорректно определено, является ли кластер кольцево (перекрёстно) реплицированным или нет. Исправлено. [#17640](https://github.com/ClickHouse/ClickHouse/pull/17640) ([tavplubix](https://github.com/tavplubix)).
* Исправлена проблема, из-за которой таблица `system.stack_trace` была пустой при запуске сервера в режиме демона. [#17630](https://github.com/ClickHouse/ClickHouse/pull/17630) ([Amos Bird](https://github.com/amosbird)).
* Исключение `fmt::v7::format_error` может записываться в лог в фоновом режиме для таблиц MergeTree. Это исправляет [#17613](https://github.com/ClickHouse/ClickHouse/issues/17613). [#17615](https://github.com/ClickHouse/ClickHouse/pull/17615) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* При использовании clickhouse-client в интерактивном режиме с многострочными запросами однострочный комментарий ошибочно распространялся до конца запроса. Это исправляет [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654). [#17565](https://github.com/ClickHouse/ClickHouse/pull/17565) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено зависание запроса ALTER, когда соответствующая мутация была убита на другой реплике. Исправляет [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953). [#17499](https://github.com/ClickHouse/ClickHouse/pull/17499) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка учета памяти, возникавшая, когда ClickHouse недооценивал размер кэша меток. Она могла проявляться при наличии большого количества очень небольших файлов с метками. [#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin)).
* Исправлена работа `ORDER BY` при включённой настройке `optimize_redundant_functions_in_order_by`. [#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* Устранены дубликаты после `DISTINCT`, которые могли возникать из-за некорректной оптимизации. Исправлена ошибка [#17294](https://github.com/ClickHouse/ClickHouse/issues/17294). [#17296](https://github.com/ClickHouse/ClickHouse/pull/17296) ([li chengxiang](https://github.com/chengxianglibra)). [#17439](https://github.com/ClickHouse/ClickHouse/pull/17439) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено повышенное использование CPU в фоновых задачах таблиц семейства *MergeTree. [#17416](https://github.com/ClickHouse/ClickHouse/pull/17416) ([tavplubix](https://github.com/tavplubix)).
* Исправлен возможный сбой при чтении из таблицы `JOIN` с типами `LowCardinality`. Исправление для [#17228](https://github.com/ClickHouse/ClickHouse/issues/17228). [#17397](https://github.com/ClickHouse/ClickHouse/pull/17397) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Репликация из MySQL (экспериментальная функция): исправление [#16835](https://github.com/ClickHouse/ClickHouse/issues/16835) — попытка устранить несоответствие заголовков результату оператора MySQL SHOW. [#17366](https://github.com/ClickHouse/ClickHouse/pull/17366) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена работа оптимизатора предикатов с недетерминированными функциями. Устранена проблема [#17244](https://github.com/ClickHouse/ClickHouse/issues/17244). [#17273](https://github.com/ClickHouse/ClickHouse/pull/17273) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена возможная ошибка `Unexpected packet Data received from client` для распределённых запросов с оператором `LIMIT`. [#17254](https://github.com/ClickHouse/ClickHouse/pull/17254) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена инвалидация индекса множества при наличии константных столбцов в подзапросе, что исправляет [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246). [#17249](https://github.com/ClickHouse/ClickHouse/pull/17249) ([Amos Bird](https://github.com/amosbird)).
* clickhouse-copier: Исправление для таблиц без партиционирования [#15235](https://github.com/ClickHouse/ClickHouse/issues/15235). [#17248](https://github.com/ClickHouse/ClickHouse/pull/17248) ([Qi Chen](https://github.com/kaka11chen)).
* Исправлены возможные случаи некорректной работы мутаций для кусков, хранящихся на диске S3 (экспериментальная функциональность). [#17227](https://github.com/ClickHouse/ClickHouse/pull/17227) ([Pavel Kovalenko](https://github.com/Jokser)).
* Исправление ошибки в функции `fuzzBits`, связанная задача: [#16980](https://github.com/ClickHouse/ClickHouse/issues/16980). [#17051](https://github.com/ClickHouse/ClickHouse/pull/17051) ([hexiaoting](https://github.com/hexiaoting)).
* Исправлен `optimize_distributed_group_by_sharding_key` для запросов только с OFFSET. [#16996](https://github.com/ClickHouse/ClickHouse/pull/16996) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены запросы к таблицам `Merge` поверх таблиц `Distributed` с операцией JOIN. [#16993](https://github.com/ClickHouse/ClickHouse/pull/16993) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена оптимизация `ORDER BY` с монотонными функциями. Исправляет [#16107](https://github.com/ClickHouse/ClickHouse/issues/16107). [#16956](https://github.com/ClickHouse/ClickHouse/pull/16956) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено некорректное сравнение типов `DateTime64` с разными масштабами. Исправлены [#16655](https://github.com/ClickHouse/ClickHouse/issues/16655) ... [#16952](https://github.com/ClickHouse/ClickHouse/pull/16952) ([Vasily Nemkov](https://github.com/Enmk)).
* Исправлена оптимизация `GROUP BY` при включённой настройке `optimize_aggregators_of_group_by_keys` и использовании соединений (JOIN). Исправляет [#12604](https://github.com/ClickHouse/ClickHouse/issues/12604). [#16951](https://github.com/ClickHouse/ClickHouse/pull/16951) ([Anton Popov](https://github.com/CurtizJ)).
* Незначительное исправление в запросе SHOW ACCESS. [#16866](https://github.com/ClickHouse/ClickHouse/pull/16866) ([tavplubix](https://github.com/tavplubix)).
* Исправлено поведение при включённой настройке `optimize_trivial_count_query` в сочетании с предикатом по партициям. [#16767](https://github.com/ClickHouse/ClickHouse/pull/16767) ([Azat Khuzhin](https://github.com/azat)).
* Возвращать количество изменённых строк для запросов INSERT через протокол MySQL. Ранее ClickHouse всегда возвращал 0, теперь это исправлено. Исправляет [#16605](https://github.com/ClickHouse/ClickHouse/issues/16605). [#16715](https://github.com/ClickHouse/ClickHouse/pull/16715) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлено непоследовательное поведение, вызванное `select_sequential_consistency`, для оптимизированного тривиального запроса COUNT и для системных таблиц. [#16309](https://github.com/ClickHouse/ClickHouse/pull/16309) ([Hao Chen](https://github.com/haoch)).
* Вызывать ошибку, если преобразователь столбца `REPLACE` применяется к несуществующему столбцу. [#16183](https://github.com/ClickHouse/ClickHouse/pull/16183) ([hexiaoting](https://github.com/hexiaoting)).
* Генерировать исключение при использовании не-equi-join выражения в условии ON в RIGH|FULL JOIN. [#15162](https://github.com/ClickHouse/ClickHouse/pull/15162) ([Artem Zuikov](https://github.com/4ertus2)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-10}


* Добавлена простая проверка целостности бинарника ClickHouse. Она позволяет обнаруживать повреждения данных, вызванные аппаратными неисправностями (битовая порча данных на носителях хранения или сбои битов в оперативной памяти). [#18811](https://github.com/ClickHouse/ClickHouse/pull/18811) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Заменили `OpenSSL` на `BoringSSL`. Это позволяет избежать проблем при работе с санитайзерами. Исправляет [#12490](https://github.com/ClickHouse/ClickHouse/issues/12490). Исправляет [#17502](https://github.com/ClickHouse/ClickHouse/issues/17502). Исправляет [#12952](https://github.com/ClickHouse/ClickHouse/issues/12952). [#18129](https://github.com/ClickHouse/ClickHouse/pull/18129) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Упрощён инициализационный скрипт `Sys/V`. Он не работал в Ubuntu 12.04 и более ранних версиях. [#17428](https://github.com/ClickHouse/ClickHouse/pull/17428) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Несколько улучшений в скрипте `./clickhouse install`. [#17421](https://github.com/ClickHouse/ClickHouse/pull/17421) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Теперь ClickHouse может выдавать себя за «фиктивный» ZooKeeper. В настоящее время реализация хранилища представляет собой хеш-таблицу в оперативной памяти, а сервер частично поддерживает протокол ZooKeeper. [#16877](https://github.com/ClickHouse/ClickHouse/pull/16877) ([alesapin](https://github.com/alesapin)).
* Исправлено удаление «мертвых» наблюдателей списков в TestKeeperStorage (заглушка для ZooKeeper). [#18065](https://github.com/ClickHouse/ClickHouse/pull/18065) ([alesapin](https://github.com/alesapin)).
* Добавлена команда `SYSTEM SUSPEND` для инъекции отказов. Она может использоваться для упрощения тестирования сценариев отказа и переключения (failover). Это закрывает [#15979](https://github.com/ClickHouse/ClickHouse/issues/15979). [#18850](https://github.com/ClickHouse/ClickHouse/pull/18850) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Генерация идентификатора сборки при линковке ClickHouse с `lld`. Выяснилось, что `lld` по умолчанию его не генерирует на моей машине. Идентификатор сборки используется для отчётов о сбоях и интроспекции. [#18808](https://github.com/ClickHouse/ClickHouse/pull/18808) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены ошибки ShellCheck при проверке стиля. [#18566](https://github.com/ClickHouse/ClickHouse/pull/18566) ([Ilya Yatsishin](https://github.com/qoega)).
* Обновлены данные о часовых поясах до версии 2020e. [#18531](https://github.com/ClickHouse/ClickHouse/pull/18531) ([alesapin](https://github.com/alesapin)).
* Исправлены предупреждения codespell. Проверки стиля разбиты на отдельные части. Обновлён Docker-образ для проверок стиля. [#18463](https://github.com/ClickHouse/ClickHouse/pull/18463) ([Ilya Yatsishin](https://github.com/qoega)).
* Автоматическая проверка документации на наличие оставшихся маркеров конфликтов. [#18332](https://github.com/ClickHouse/ClickHouse/pull/18332) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Включён Thread Fuzzer для проверки нестабильности stateless-тестов. [#18299](https://github.com/ClickHouse/ClickHouse/pull/18299) ([alesapin](https://github.com/alesapin)).
* Не использовать непотокобезопасную функцию `strerror`. [#18204](https://github.com/ClickHouse/ClickHouse/pull/18204) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Обновлено действие workflow `anchore/scan-action@main` (переведено с `master` на `main`). [#18192](https://github.com/ClickHouse/ClickHouse/pull/18192) ([Stig Bakken](https://github.com/stigsb)).
* Теперь `clickhouse-test` выполняет операции DROP/CREATE баз данных с таймаутом. [#18098](https://github.com/ClickHouse/ClickHouse/pull/18098) ([alesapin](https://github.com/alesapin)).
* Включена экспериментальная поддержка фреймворка Pytest для стейтлес‑тестов. [#17902](https://github.com/ClickHouse/ClickHouse/pull/17902) ([Ivan](https://github.com/abyss7)).
* Теперь в интеграционных тестах используется актуальная версия демона Docker. [#17671](https://github.com/ClickHouse/ClickHouse/pull/17671) ([alesapin](https://github.com/alesapin)).
* Отправлять информацию об официальной сборке, памяти, CPU и свободном дисковом пространстве в Sentry, если он включён. Sentry — это опциональная возможность, помогающая разработчикам ClickHouse. Закрывает [#17279](https://github.com/ClickHouse/ClickHouse/issues/17279). [#17543](https://github.com/ClickHouse/ClickHouse/pull/17543) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* В коде clickhouse-copier использовалась неинициализированная переменная. [#17363](https://github.com/ClickHouse/ClickHouse/pull/17363) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлен [один отчёт MSan](https://clickhouse-test-reports.s3.yandex.net/17309/065cd002578f2e8228f12a2744bd40c970065e0c/stress_test_\(memory\)/stderr.log) из задачи [#17309](https://github.com/ClickHouse/ClickHouse/issues/17309). [#17344](https://github.com/ClickHouse/ClickHouse/pull/17344) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправление ошибки с IPv6 в библиотеке Arrow Flight. Подробности см. [в комментариях](https://github.com/ClickHouse/ClickHouse/pull/16243#issuecomment-720830294). [#16664](https://github.com/ClickHouse/ClickHouse/pull/16664) ([Zhanna](https://github.com/FawnD2)).
* Добавлена библиотека, подменяющая некоторые функции `libc` на трапы, приводящие к завершению процесса. [#16366](https://github.com/ClickHouse/ClickHouse/pull/16366) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* В случае переполнения стека в серверные логи выводится диагностическая информация, а сообщение об ошибке отправляется в clickhouse-client. Это закрывает [#14840](https://github.com/ClickHouse/ClickHouse/issues/14840). [#16346](https://github.com/ClickHouse/ClickHouse/pull/16346) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Теперь мы можем выполнять почти все stateless‑функциональные тесты параллельно. [#15236](https://github.com/ClickHouse/ClickHouse/pull/15236) ([alesapin](https://github.com/alesapin)).
* Исправлена порча данных при snappy-декомпрессии в `librdkafka` (проблема возникала только в сборках gcc10, однако официальные сборки уже используют clang, так что по крайней мере последние официальные релизы этой проблеме не подвержены). [#18053](https://github.com/ClickHouse/ClickHouse/pull/18053) ([Azat Khuzhin](https://github.com/azat)).
* Если сервер был завершён OOM killer&#39;ом, вывести сообщение в лог. [#13516](https://github.com/ClickHouse/ClickHouse/pull/13516) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* PODArray: предотвращён вызов функции memcpy с аргументами (nullptr, 0) (исправлено сообщение UBSan). Это исправляет [#18525](https://github.com/ClickHouse/ClickHouse/issues/18525). [#18526](https://github.com/ClickHouse/ClickHouse/pull/18526) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Незначительное улучшение объединения путей ZooKeeper в DDLWorker. [#17767](https://github.com/ClickHouse/ClickHouse/pull/17767) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлена возможность повторной загрузки символов из отладочного файла. В этом PR также исправлена проблема с build-id. [#17637](https://github.com/ClickHouse/ClickHouse/pull/17637) ([Amos Bird](https://github.com/amosbird)).





## [Журнал изменений за 2020 год](./2020.md) {#changelog-for-2020}
