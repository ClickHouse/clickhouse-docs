---
slug: /whats-new/changelog/2019
sidebar_position: 8
sidebar_label: '2019'
title: 'Журнал изменений за 2019 год'
description: 'Журнал изменений за 2019 год'
doc_type: 'changelog'
keywords: ['ClickHouse 2019', 'changelog 2019', 'release notes', 'version history', 'legacy releases']
---



## Релиз ClickHouse 19.17 {#clickhouse-release-v19-17}

### Релиз ClickHouse 19.17.6.36, 2019-12-27 {#clickhouse-release-v19-17-6-36-2019-12-27}

#### Исправление ошибок {#bug-fix}


* Исправлено потенциальное переполнение буфера в `decompress`. Злоумышленник мог передать поддельные сжатые данные, что могло привести к чтению за пределами буфера. Проблема была обнаружена Эльдаром Зайтовым из команды информационной безопасности Yandex. [#8404](https://github.com/ClickHouse/ClickHouse/pull/8404) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлено возможное аварийное завершение работы сервера (`std::terminate`), когда сервер не может отправить или записать данные в формате JSON или XML со значениями типа String (которые требуют проверки корректности UTF-8), а также при сжатии результирующих данных алгоритмом Brotli и в некоторых других редких случаях. [#8384](https://github.com/ClickHouse/ClickHouse/pull/8384) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлены словари с источником из clickhouse `VIEW`, теперь чтение таких словарей больше не приводит к ошибке `There is no query`. [#8351](https://github.com/ClickHouse/ClickHouse/pull/8351) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Исправлена проверка того, разрешён ли клиентский хост по шаблону `host_regexp`, указанному в `users.xml`. [#8241](https://github.com/ClickHouse/ClickHouse/pull/8241), [#8342](https://github.com/ClickHouse/ClickHouse/pull/8342) ([Vitaly Baranov](https://github.com/vitlibar))
* `RENAME TABLE` для распределённой таблицы теперь переименовывает каталог, содержащий вставленные данные, перед отправкой их на шарды. Это исправляет проблему с последовательными переименованиями `tableA->tableB`, `tableC->tableA`. [#8306](https://github.com/ClickHouse/ClickHouse/pull/8306) ([tavplubix](https://github.com/tavplubix))
* `range_hashed` внешние словари, создаваемые DDL-запросами, теперь поддерживают диапазоны чисел произвольных типов. [#8275](https://github.com/ClickHouse/ClickHouse/pull/8275) ([alesapin](https://github.com/alesapin))
* Исправлена табличная функция в запросе `INSERT INTO table SELECT ... FROM mysql(...)`. [#8234](https://github.com/ClickHouse/ClickHouse/pull/8234) ([tavplubix](https://github.com/tavplubix))
* Исправлена ошибка сегментации в `INSERT INTO TABLE FUNCTION file()` при вставке в несуществующий файл. Теперь в этом случае файл будет создаваться, после чего вставка будет выполняться. [#8177](https://github.com/ClickHouse/ClickHouse/pull/8177) ([Olga Khvostikova](https://github.com/stavrolia))
* Исправлена ошибка в `bitmapAnd` при пересечении агрегированного и скалярного bitmap. [#8082](https://github.com/ClickHouse/ClickHouse/pull/8082) ([Yue Huang](https://github.com/moon03432))
* Исправлена ошибка сегфолта, возникавшая при использовании запроса `EXISTS` без указания `TABLE` или `DICTIONARY`, как в `EXISTS t`. [#8213](https://github.com/ClickHouse/ClickHouse/pull/8213) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлен тип возвращаемого значения для функций `rand` и `randConstant` в случае nullable-аргумента. Теперь функции всегда возвращают `UInt32` и никогда `Nullable(UInt32)`. [#8204](https://github.com/ClickHouse/ClickHouse/pull/8204) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Исправлена команда `DROP DICTIONARY IF EXISTS db.dict`, теперь она не генерирует исключение, если `db` не существует. [#8185](https://github.com/ClickHouse/ClickHouse/pull/8185) ([Vitaly Baranov](https://github.com/vitlibar))
* Если таблица не была полностью удалена из-за сбоя сервера, сервер попытается её восстановить и загрузить [#8176](https://github.com/ClickHouse/ClickHouse/pull/8176) ([tavplubix](https://github.com/tavplubix))
* Исправлен тривиальный запрос `count` для распределённой таблицы, если существует более двух локальных таблиц в шарде. [#8164](https://github.com/ClickHouse/ClickHouse/pull/8164) ([小路](https://github.com/nicelulu))
* Исправлена ошибка, приводившая к гонке данных в DB::BlockStreamProfileInfo::calculateRowsBeforeLimit() [#8143](https://github.com/ClickHouse/ClickHouse/pull/8143) ([Alexander Kazakov](https://github.com/Akazz))
* Исправлено выполнение `ALTER table MOVE part` сразу после слияния указанной части, что могло приводить к перемещению части, в которую была слита указанная часть. Теперь корректно перемещается именно указанная часть. [#8104](https://github.com/ClickHouse/ClickHouse/pull/8104) ([Vladimir Chebotarev](https://github.com/excitoon))
* Выражения для словарей теперь могут задаваться в виде строк. Это полезно для вычисления атрибутов при извлечении данных из сторонних источников, поскольку позволяет использовать синтаксис, отличный от ClickHouse, для этих выражений. [#8098](https://github.com/ClickHouse/ClickHouse/pull/8098) ([alesapin](https://github.com/alesapin))
* Исправлена крайне редкая гонка в `clickhouse-copier` из-за переполнения ZXid. [#8088](https://github.com/ClickHouse/ClickHouse/pull/8088) ([Ding Xiang Fei](https://github.com/dingxiangfei2009))
* Исправлена ошибка, при которой после неудачного выполнения запроса (например, из-за «Too many simultaneous queries») не считывалась информация о внешних таблицах, и следующий запрос интерпретировал её как начало нового запроса, что приводило к ошибке вида `Unknown packet from client`. [#8084](https://github.com/ClickHouse/ClickHouse/pull/8084) ([Azat Khuzhin](https://github.com/azat))
* Избежание разыменования нулевого указателя после сообщения «Unknown packet X from server» [#8071](https://github.com/ClickHouse/ClickHouse/pull/8071) ([Azat Khuzhin](https://github.com/azat))
* Восстановлена поддержка всех ICU-локалей, добавлена возможность применять правила сортировки (collations) для константных выражений и добавлено имя языка в таблицу system.collations. [#8051](https://github.com/ClickHouse/ClickHouse/pull/8051) ([alesapin](https://github.com/alesapin))
* Количество потоков для чтения из `StorageFile` и `StorageHDFS` теперь ограничено, чтобы избежать превышения лимита памяти. [#7981](https://github.com/ClickHouse/ClickHouse/pull/7981) ([alesapin](https://github.com/alesapin))
* Исправлен запрос `CHECK TABLE` для таблиц `*MergeTree` без ключа. [#7979](https://github.com/ClickHouse/ClickHouse/pull/7979) ([alesapin](https://github.com/alesapin))
* Удалён номер мутации из имени части в случае отсутствия мутаций. Это улучшило совместимость со старыми версиями. [#8250](https://github.com/ClickHouse/ClickHouse/pull/8250) ([alesapin](https://github.com/alesapin))
* Исправлена ошибка, из-за которой мутации пропускались для некоторых присоединённых кусков, так как их `data_version` была больше версии мутации таблицы. [#7812](https://github.com/ClickHouse/ClickHouse/pull/7812) ([Zhichang Yu](https://github.com/yuzhichang))
* Разрешён запуск сервера с избыточными копиями парций после их перемещения на другое устройство. [#7810](https://github.com/ClickHouse/ClickHouse/pull/7810) ([Vladimir Chebotarev](https://github.com/excitoon))
* Исправлена ошибка «Sizes of columns does not match», которая могла возникать при использовании столбцов с агрегатными функциями. [#7790](https://github.com/ClickHouse/ClickHouse/pull/7790) ([Boris Granveaud](https://github.com/bgranvea))
* Теперь при использовании WITH TIES вместе с LIMIT BY будет выбрасываться исключение. Также теперь можно использовать TOP с LIMIT BY. [#7637](https://github.com/ClickHouse/ClickHouse/pull/7637) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
* Исправлена перезагрузка словаря с `invalidate_query`, из‑за которого останавливались обновления и возникали исключения при предыдущих попытках обновления. [#8029](https://github.com/ClickHouse/ClickHouse/pull/8029) ([alesapin](https://github.com/alesapin))

### ClickHouse Release 19.17.4.11, 2019-11-22 {#clickhouse-release-v19-17-4-11-2019-11-22}

#### Обратно несовместимое изменение {#backward-incompatible-change}

- Использование столбца вместо AST для хранения результатов скалярных подзапросов с целью повышения производительности. Настройка `enable_scalar_subquery_optimization` была добавлена в версии 19.17 и включена по умолчанию. Это приводит к ошибкам, подобным [этой](https://github.com/ClickHouse/ClickHouse/issues/7851), при обновлении до версий 19.17.2 или 19.17.3 с предыдущих версий. Эта настройка была отключена по умолчанию в версии 19.17.4, чтобы обеспечить возможность обновления с версий 19.16 и более старых без ошибок. [#7392](https://github.com/ClickHouse/ClickHouse/pull/7392) ([Amos Bird](https://github.com/amosbird))

#### Новая функциональность {#new-feature}

- Добавлена возможность создания словарей с помощью DDL-запросов. [#7360](https://github.com/ClickHouse/ClickHouse/pull/7360) ([alesapin](https://github.com/alesapin))
- Добавлена поддержка типов `LowCardinality` и `Nullable` для индекса типа `bloom_filter` [#7363](https://github.com/ClickHouse/ClickHouse/issues/7363) [#7561](https://github.com/ClickHouse/ClickHouse/pull/7561) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Добавлена функция `isValidJSON` для проверки, что переданная строка является корректным JSON. [#5910](https://github.com/ClickHouse/ClickHouse/issues/5910) [#7293](https://github.com/ClickHouse/ClickHouse/pull/7293) ([Vdimir](https://github.com/Vdimir))
- Реализована функция `arrayCompact` [#7328](https://github.com/ClickHouse/ClickHouse/pull/7328) ([Memo](https://github.com/Joeywzr))
- Создана функция `hex` для чисел типа Decimal. Она работает как `hex(reinterpretAsString())`, но не удаляет последние нулевые байты. [#7355](https://github.com/ClickHouse/ClickHouse/pull/7355) ([Mikhail Korotov](https://github.com/millb))
- Добавлены функции `arrayFill` и `arrayReverseFill`, которые заменяют элементы другими элементами, находящимися перед ними или после них в массиве. [#7380](https://github.com/ClickHouse/ClickHouse/pull/7380) ([hcz](https://github.com/hczhcz))
- Добавлена поддержка `CRC32IEEE()`/`CRC64()` [#7480](https://github.com/ClickHouse/ClickHouse/pull/7480) ([Azat Khuzhin](https://github.com/azat))
- Реализована функция `char`, аналогичная функции в [mysql](https://dev.mysql.com/doc/refman/8.0/en/string-functions.html#function_char) [#7486](https://github.com/ClickHouse/ClickHouse/pull/7486) ([sundyli](https://github.com/sundy-li))
- Добавлена функция `bitmapTransform`. Она преобразует массив значений в битовой карте в другой массив значений, результатом является новая битовая карта [#7598](https://github.com/ClickHouse/ClickHouse/pull/7598) ([Zhichang Yu](https://github.com/yuzhichang))
- Реализована функция `javaHashUTF16LE()` [#7651](https://github.com/ClickHouse/ClickHouse/pull/7651) ([achimbab](https://github.com/achimbab))
- Добавлен виртуальный столбец `_shard_num` для движка Distributed [#7624](https://github.com/ClickHouse/ClickHouse/pull/7624) ([Azat Khuzhin](https://github.com/azat))

#### Экспериментальная функциональность {#experimental-feature}

- Поддержка процессоров (нового конвейера выполнения запросов) в `MergeTree`. [#7181](https://github.com/ClickHouse/ClickHouse/pull/7181) ([Nikolai Kochetov](https://github.com/KochetovNicolai))

#### Исправление ошибок {#bug-fix-1}


* Исправлено некорректное разборе чисел с плавающей запятой в `Values` [#7817](https://github.com/ClickHouse/ClickHouse/issues/7817) [#7870](https://github.com/ClickHouse/ClickHouse/pull/7870) ([tavplubix](https://github.com/tavplubix))
* Исправлена редкая взаимоблокировка, которая могла возникать при включённом `trace_log`. [#7838](https://github.com/ClickHouse/ClickHouse/pull/7838) ([filimonov](https://github.com/filimonov))
* Предотвращено дублирование сообщений при записи в Kafka-таблицу, если из неё выбирают какие-либо материализованные представления [#7265](https://github.com/ClickHouse/ClickHouse/pull/7265) ([Ivan](https://github.com/abyss7))
* Поддержка `Array(LowCardinality(Nullable(String)))` в `IN`. Исправляет [#7364](https://github.com/ClickHouse/ClickHouse/issues/7364) [#7366](https://github.com/ClickHouse/ClickHouse/pull/7366) ([achimbab](https://github.com/achimbab))
* Добавлена обработка `SQL_TINYINT` и `SQL_BIGINT`, а также исправлена обработка типов источника данных `SQL_FLOAT` в ODBC Bridge. [#7491](https://github.com/ClickHouse/ClickHouse/pull/7491) ([Denis Glazachev](https://github.com/traceon))
* Исправлена агрегация (`avg` и quantiles) над пустыми столбцами типа Decimal [#7431](https://github.com/ClickHouse/ClickHouse/pull/7431) ([Andrey Konyaev](https://github.com/akonyaev90))
* Исправлена операция `INSERT` в Distributed с `MATERIALIZED` столбцами [#7377](https://github.com/ClickHouse/ClickHouse/pull/7377) ([Azat Khuzhin](https://github.com/azat))
* Обеспечить работу `MOVE PARTITION`, если некоторые парты раздела уже находятся на целевом диске или томе [#7434](https://github.com/ClickHouse/ClickHouse/pull/7434) ([Vladimir Chebotarev](https://github.com/excitoon))
* Исправлена ошибка, из-за которой не удавалось создать жёсткие ссылки (hardlinks) во время мутаций в `ReplicatedMergeTree` в конфигурациях с несколькими дисками. [#7558](https://github.com/ClickHouse/ClickHouse/pull/7558) ([Vladimir Chebotarev](https://github.com/excitoon))
* Исправлена ошибка с мутацией в `MergeTree`, когда целая часть остаётся неизменной, а оптимальное место находится на другом диске [#7602](https://github.com/ClickHouse/ClickHouse/pull/7602) ([Vladimir Chebotarev](https://github.com/excitoon))
* Исправлена ошибка, из-за которой `keep_free_space_ratio` не читался из конфигурации дисков [#7645](https://github.com/ClickHouse/ClickHouse/pull/7645) ([Vladimir Chebotarev](https://github.com/excitoon))
* Исправлена ошибка с таблицей, содержащей только столбцы типа `Tuple` или столбцы со сложными путями. Исправлено в [7541](https://github.com/ClickHouse/ClickHouse/issues/7541). [#7545](https://github.com/ClickHouse/ClickHouse/pull/7545) ([alesapin](https://github.com/alesapin))
* Не учитывать использование памяти движком Buffer при ограничении max&#95;memory&#95;usage [#7552](https://github.com/ClickHouse/ClickHouse/pull/7552) ([Azat Khuzhin](https://github.com/azat))
* Исправлено использование финальной отметки в таблицах `MergeTree`, упорядоченных по `tuple()`. В редких случаях это могло приводить к ошибке `Can't adjust last granule` при выполнении запроса `SELECT`. [#7639](https://github.com/ClickHouse/ClickHouse/pull/7639) ([Anton Popov](https://github.com/CurtizJ))
* Исправлена ошибка в мутациях, у которых предикат содержит действия, требующие контекста (например, функции для JSON), что могло приводить к падениям или странным исключениям. [#7664](https://github.com/ClickHouse/ClickHouse/pull/7664) ([alesapin](https://github.com/alesapin))
* Исправлено несоответствие в экранировании имен баз данных и таблиц в директориях `data/` и `shadow/` [#7575](https://github.com/ClickHouse/ClickHouse/pull/7575) ([Alexander Burmak](https://github.com/Alex-Burmak))
* Поддержка дублирующихся ключей в операциях RIGHT|FULL JOIN, например `ON t.x = u.x AND t.x = u.y`. Исправлен сбой в этом случае. [#7586](https://github.com/ClickHouse/ClickHouse/pull/7586) ([Artem Zuikov](https://github.com/4ertus2))
* Исправлена ошибка `Not found column &lt;expression&gt; in block` при соединении по выражению с RIGHT или FULL JOIN. [#7641](https://github.com/ClickHouse/ClickHouse/pull/7641) ([Artem Zuikov](https://github.com/4ertus2))
* Ещё одна попытка исправить бесконечный цикл в формате `PrettySpace` [#7591](https://github.com/ClickHouse/ClickHouse/pull/7591) ([Olga Khvостикова](https://github.com/stavrolia))
* Исправлена ошибка в функции `concat`, возникавшая, когда все аргументы были типа `FixedString` одинакового размера. [#7635](https://github.com/ClickHouse/ClickHouse/pull/7635) ([alesapin](https://github.com/alesapin))
* Исправлено исключение при использовании одного аргумента при определении хранилищ S3, URL и HDFS. [#7618](https://github.com/ClickHouse/ClickHouse/pull/7618) ([Vladimir Chebotarev](https://github.com/excitoon))
* Исправлена область действия `InterpreterSelectQuery` для представлений с запросами [#7601](https://github.com/ClickHouse/ClickHouse/pull/7601) ([Azat Khuzhin](https://github.com/azat))

#### Улучшения {#improvement}

- Столбцы `Nullable` корректно распознаются, а NULL-значения правильно обрабатываются ODBC-мостом [#7402](https://github.com/ClickHouse/ClickHouse/pull/7402) ([Vasily Nemkov](https://github.com/Enmk))
- Атомарная запись текущего пакета для распределённой отправки [#7600](https://github.com/ClickHouse/ClickHouse/pull/7600) ([Azat Khuzhin](https://github.com/azat))
- Генерируется исключение, если невозможно определить таблицу для имени столбца в запросе. [#7358](https://github.com/ClickHouse/ClickHouse/pull/7358) ([Artem Zuikov](https://github.com/4ertus2))
- Добавлена настройка `merge_max_block_size` в `MergeTreeSettings` [#7412](https://github.com/ClickHouse/ClickHouse/pull/7412) ([Artem Zuikov](https://github.com/4ertus2))
- Запросы с `HAVING` и без `GROUP BY` предполагают группировку по константе. Таким образом, `SELECT 1 HAVING 1` теперь возвращает результат. [#7496](https://github.com/ClickHouse/ClickHouse/pull/7496) ([Amos Bird](https://github.com/amosbird))
- Поддержка разбора `(X,)` как кортежа аналогично Python. [#7501](https://github.com/ClickHouse/ClickHouse/pull/7501), [#7562](https://github.com/ClickHouse/ClickHouse/pull/7562) ([Amos Bird](https://github.com/amosbird))
- Поведение функции `range` приближено к Python-версии. [#7518](https://github.com/ClickHouse/ClickHouse/pull/7518) ([sundyli](https://github.com/sundy-li))
- Добавлен столбец `constraints` в таблицу `system.settings` [#7553](https://github.com/ClickHouse/ClickHouse/pull/7553) ([Vitaly Baranov](https://github.com/vitlibar))
- Улучшен формат Null для TCP-обработчика, что позволяет использовать `select ignore(<expression>) from table format Null` для измерения производительности через clickhouse-client [#7606](https://github.com/ClickHouse/ClickHouse/pull/7606) ([Amos Bird](https://github.com/amosbird))
- Запросы вида `CREATE TABLE ... AS (SELECT (1, 2))` корректно разбираются [#7542](https://github.com/ClickHouse/ClickHouse/pull/7542) ([hcz](https://github.com/hczhcz))

#### Улучшения производительности {#performance-improvement}

- Улучшена производительность агрегации по коротким строковым ключам. [#6243](https://github.com/ClickHouse/ClickHouse/pull/6243) ([Alexander Kuzmenkov](https://github.com/akuzm), [Amos Bird](https://github.com/amosbird))
- Выполняется дополнительный проход синтаксического и семантического анализа для получения потенциальных оптимизаций после свёртки константных предикатов. [#7497](https://github.com/ClickHouse/ClickHouse/pull/7497) ([Amos Bird](https://github.com/amosbird))
- Использование метаинформации хранилища для вычисления тривиальных запросов `SELECT count() FROM table;` [#7510](https://github.com/ClickHouse/ClickHouse/pull/7510) ([Amos Bird](https://github.com/amosbird), [alexey-milovidov](https://github.com/alexey-milovidov))
- Векторизована обработка `arrayReduce` аналогично `addBatch` агрегатора. [#7608](https://github.com/ClickHouse/ClickHouse/pull/7608) ([Amos Bird](https://github.com/amosbird))
- Незначительные улучшения производительности потребления данных из `Kafka` [#7475](https://github.com/ClickHouse/ClickHouse/pull/7475) ([Ivan](https://github.com/abyss7))

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement}


- Добавлена поддержка кросс-компиляции для архитектуры процессора AARCH64. Рефакторинг скрипта упаковщика. [#7370](https://github.com/ClickHouse/ClickHouse/pull/7370) [#7539](https://github.com/ClickHouse/ClickHouse/pull/7539) ([Ivan](https://github.com/abyss7))
- Распаковка тулчейнов darwin-x86_64 и linux-aarch64 в смонтированный том Docker при сборке пакетов [#7534](https://github.com/ClickHouse/ClickHouse/pull/7534) ([Ivan](https://github.com/abyss7))
- Обновлён образ Docker для упаковщика бинарных файлов [#7474](https://github.com/ClickHouse/ClickHouse/pull/7474) ([Ivan](https://github.com/abyss7))
- Исправлены ошибки компиляции на macOS Catalina [#7585](https://github.com/ClickHouse/ClickHouse/pull/7585) ([Ernest Poletaev](https://github.com/ernestp))
- Рефакторинг логики анализа запросов: разделение сложного класса на несколько простых. [#7454](https://github.com/ClickHouse/ClickHouse/pull/7454) ([Artem Zuikov](https://github.com/4ertus2))
- Исправлена сборка без подмодулей [#7295](https://github.com/ClickHouse/ClickHouse/pull/7295) ([proller](https://github.com/proller))
- Улучшен `add_globs` в файлах CMake [#7418](https://github.com/ClickHouse/ClickHouse/pull/7418) ([Amos Bird](https://github.com/amosbird))
- Удалены жёстко заданные пути в цели `unwind` [#7460](https://github.com/ClickHouse/ClickHouse/pull/7460) ([Konstantin Podshumok](https://github.com/podshumok))
- Разрешено использование формата mysql без SSL [#7524](https://github.com/ClickHouse/ClickHouse/pull/7524) ([proller](https://github.com/proller))

#### Прочее {#other}

- Добавлена грамматика ANTLR4 для SQL-диалекта ClickHouse [#7595](https://github.com/ClickHouse/ClickHouse/issues/7595) [#7596](https://github.com/ClickHouse/ClickHouse/pull/7596) ([alexey-milovidov](https://github.com/alexey-milovidov))


## Релиз ClickHouse 19.16 {#clickhouse-release-v19-16}

#### Релиз ClickHouse 19.16.14.65, 2020-03-25 {#clickhouse-release-v19-16-14-65-2020-03-25}

- Исправлена ошибка в пакетных вычислениях тернарных логических операций для множественных аргументов (более 10). [#8718](https://github.com/ClickHouse/ClickHouse/pull/8718) ([Alexander Kazakov](https://github.com/Akazz)) Это исправление было портировано в версию 19.16 по специальному запросу компании Altinity.

#### Релиз ClickHouse 19.16.14.65, 2020-03-05 {#clickhouse-release-v19-16-14-65-2020-03-05}

- Исправлена несовместимость распределённых подзапросов со старыми версиями ClickHouse. Исправляет [#7851](https://github.com/ClickHouse/ClickHouse/issues/7851)
  [(tabplubix)](https://github.com/tavplubix)
- При выполнении запроса `CREATE` выполняется свёртка константных выражений в аргументах движка хранения. Пустое имя базы данных заменяется на текущую базу данных. Исправляет [#6508](https://github.com/ClickHouse/ClickHouse/issues/6508), [#3492](https://github.com/ClickHouse/ClickHouse/issues/3492). Также исправлена проверка локального адреса в `ClickHouseDictionarySource`.
  [#9262](https://github.com/ClickHouse/ClickHouse/pull/9262) [(tabplubix)](https://github.com/tavplubix)
- Теперь фоновые слияния в семействе движков таблиц `*MergeTree` более точно сохраняют порядок томов политики хранения.
  [#8549](https://github.com/ClickHouse/ClickHouse/pull/8549) ([Vladimir Chebotarev](https://github.com/excitoon))
- Предотвращена потеря данных в `Kafka` в редких случаях, когда исключение возникает после чтения суффикса, но до фиксации изменений. Исправляет [#9378](https://github.com/ClickHouse/ClickHouse/issues/9378). Связано: [#7175](https://github.com/ClickHouse/ClickHouse/issues/7175)
  [#9507](https://github.com/ClickHouse/ClickHouse/pull/9507) [(filimonov)](https://github.com/filimonov)
- Исправлена ошибка, приводящая к завершению работы сервера при попытке использовать или удалить таблицу `Kafka`, созданную с неправильными параметрами. Исправляет [#9494](https://github.com/ClickHouse/ClickHouse/issues/9494). Включает [#9507](https://github.com/ClickHouse/ClickHouse/issues/9507).
  [#9513](https://github.com/ClickHouse/ClickHouse/pull/9513) [(filimonov)](https://github.com/filimonov)
- Разрешено использование `MaterializedView` с подзапросами над таблицами `Kafka`.
  [#8197](https://github.com/ClickHouse/ClickHouse/pull/8197) ([filimonov](https://github.com/filimonov))

#### Новая функциональность {#new-feature-1}

- Добавлена опция `deduplicate_blocks_in_dependent_materialized_views` для управления поведением идемпотентных вставок в таблицы с материализованными представлениями. Эта новая функциональность была добавлена в релиз с исправлениями по специальному запросу компании Altinity.
  [#9070](https://github.com/ClickHouse/ClickHouse/pull/9070) [(urykhy)](https://github.com/urykhy)

### Релиз ClickHouse 19.16.2.2, 2019-10-30 {#clickhouse-release-v19-16-2-2-2019-10-30}

#### Обратно несовместимое изменение {#backward-incompatible-change-1}

- Добавлена отсутствующая проверка арности для count/countIf.
  [#7095](https://github.com/ClickHouse/ClickHouse/issues/7095)
  [#7298](https://github.com/ClickHouse/ClickHouse/pull/7298) ([Vdimir](https://github.com/Vdimir))
- Удалена устаревшая настройка `asterisk_left_columns_only` (она была отключена по умолчанию).
  [#7335](https://github.com/ClickHouse/ClickHouse/pull/7335) ([Artem
  Zuikov](https://github.com/4ertus2))
- Строки форматирования для формата данных Template теперь указываются в файлах.
  [#7118](https://github.com/ClickHouse/ClickHouse/pull/7118)
  ([tavplubix](https://github.com/tavplubix))

#### Новая функциональность {#new-feature-2}


- Добавлена функция uniqCombined64() для вычисления мощности множества, превышающей UINT_MAX.
  [#7213](https://github.com/ClickHouse/ClickHouse/pull/7213),
  [#7222](https://github.com/ClickHouse/ClickHouse/pull/7222) ([Azat
  Khuzhin](https://github.com/azat))
- Добавлена поддержка индексов Bloom filter для столбцов типа Array.
  [#6984](https://github.com/ClickHouse/ClickHouse/pull/6984)
  ([achimbab](https://github.com/achimbab))
- Добавлена функция `getMacro(name)`, которая возвращает строку со значением соответствующего `<macros>`
  из конфигурации сервера. [#7240](https://github.com/ClickHouse/ClickHouse/pull/7240)
  ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлены два параметра конфигурации для словаря на основе HTTP-источника: `credentials` и
  `http-headers`. [#7092](https://github.com/ClickHouse/ClickHouse/pull/7092) ([Guillaume
  Tassery](https://github.com/YiuRULE))
- Добавлено новое событие ProfileEvent `Merge`, которое подсчитывает количество запущенных фоновых слияний.
  [#7093](https://github.com/ClickHouse/ClickHouse/pull/7093) ([Mikhail
  Korotov](https://github.com/millb))
- Добавлена функция fullHostName, которая возвращает полное доменное имя (FQDN).
  [#7263](https://github.com/ClickHouse/ClickHouse/issues/7263)
  [#7291](https://github.com/ClickHouse/ClickHouse/pull/7291) ([sundyli](https://github.com/sundy-li))
- Добавлены функции `arraySplit` и `arrayReverseSplit`, которые разделяют массив по условиям «отсечения». Они полезны при обработке временных последовательностей.
  [#7294](https://github.com/ClickHouse/ClickHouse/pull/7294) ([hcz](https://github.com/hczhcz))
- Добавлены новые функции, которые возвращают массив всех совпавших индексов в семействе функций multiMatch.
  [#7299](https://github.com/ClickHouse/ClickHouse/pull/7299) ([Danila
  Kutenin](https://github.com/danlark1))
- Добавлен новый движок баз данных `Lazy`, оптимизированный для хранения большого количества небольших таблиц семейства -Log.
  [#7171](https://github.com/ClickHouse/ClickHouse/pull/7171) ([Nikita
  Vasilev](https://github.com/nikvas0))
- Добавлены агрегатные функции groupBitmapAnd, -Or, -Xor для столбцов типа bitmap. [#7109](https://github.com/ClickHouse/ClickHouse/pull/7109) ([Zhichang
  Yu](https://github.com/yuzhichang))
- Добавлены комбинаторы агрегатных функций -OrNull и -OrDefault, которые возвращают null
  или значения по умолчанию, когда нечего агрегировать.
  [#7331](https://github.com/ClickHouse/ClickHouse/pull/7331)
  ([hcz](https://github.com/hczhcz))
- Добавлен формат данных CustomSeparated, который поддерживает пользовательские правила экранирования и
  разделителей. [#7118](https://github.com/ClickHouse/ClickHouse/pull/7118)
  ([tavplubix](https://github.com/tavplubix))
- Добавлена поддержка Redis в качестве источника внешнего словаря. [#4361](https://github.com/ClickHouse/ClickHouse/pull/4361) [#6962](https://github.com/ClickHouse/ClickHouse/pull/6962) ([comunodi](https://github.com/comunodi), [Anton
  Popov](https://github.com/CurtizJ))

#### Исправление ошибок {#bug-fix-2}


- Исправлен неверный результат запроса при наличии секции `WHERE IN (SELECT ...)` и использовании `optimize_read_in_order`. [#7371](https://github.com/ClickHouse/ClickHouse/pull/7371) ([Anton
  Popov](https://github.com/CurtizJ))
- Отключен плагин аутентификации MariaDB, зависящий от файлов вне проекта.
  [#7140](https://github.com/ClickHouse/ClickHouse/pull/7140) ([Yuriy
  Baranov](https://github.com/yurriy))
- Исправлено исключение `Cannot convert column ... because it is constant but values of constants are different in source and result`, которое могло редко возникать при использовании функций `now()`, `today()`,
  `yesterday()`, `randConstant()`.
  [#7156](https://github.com/ClickHouse/ClickHouse/pull/7156) ([Nikolai
  Kochetov](https://github.com/KochetovNicolai))
- Исправлена проблема использования таймаута HTTP keep-alive вместо таймаута TCP keep-alive.
  [#7351](https://github.com/ClickHouse/ClickHouse/pull/7351) ([Vasily
  Nemkov](https://github.com/Enmk))
- Исправлена ошибка сегментации в groupBitmapOr (issue [#7109](https://github.com/ClickHouse/ClickHouse/issues/7109)).
  [#7289](https://github.com/ClickHouse/ClickHouse/pull/7289) ([Zhichang
  Yu](https://github.com/yuzhichang))
- Для материализованных представлений коммит для Kafka теперь вызывается после записи всех данных.
  [#7175](https://github.com/ClickHouse/ClickHouse/pull/7175) ([Ivan](https://github.com/abyss7))
- Исправлено неверное значение `duration_ms` в таблице `system.part_log`. Оно было завышено в десять раз.
  [#7172](https://github.com/ClickHouse/ClickHouse/pull/7172) ([Vladimir
  Chebotarev](https://github.com/excitoon))
- Быстрое исправление для устранения сбоя в таблице LIVE VIEW и повторного включения всех тестов LIVE VIEW.
  [#7201](https://github.com/ClickHouse/ClickHouse/pull/7201)
  ([vzakaznikov](https://github.com/vzakaznikov))
- Корректная сериализация значений NULL в индексах min/max частей MergeTree.
  [#7234](https://github.com/ClickHouse/ClickHouse/pull/7234) ([Alexander
  Kuzmenkov](https://github.com/akuzm))
- Виртуальные столбцы больше не добавляются в метаданные .sql при создании таблицы с помощью `CREATE TABLE AS`.
  [#7183](https://github.com/ClickHouse/ClickHouse/pull/7183) ([Ivan](https://github.com/abyss7))
- Исправлена ошибка сегментации в запросе `ATTACH PART`.
  [#7185](https://github.com/ClickHouse/ClickHouse/pull/7185)
  ([alesapin](https://github.com/alesapin))
- Исправлен неверный результат для некоторых запросов, вызванный оптимизацией пустых подзапросов IN и пустых
  INNER/RIGHT JOIN. [#7284](https://github.com/ClickHouse/ClickHouse/pull/7284) ([Nikolai
  Kochetov](https://github.com/KochetovNicolai))
- Исправлена ошибка AddressSanitizer в методе getHeader() LIVE VIEW.
  [#7271](https://github.com/ClickHouse/ClickHouse/pull/7271)
  ([vzakaznikov](https://github.com/vzakaznikov))

#### Улучшения {#improvement-1}


- Добавлено сообщение в случае ожидания queue_wait_max_ms.
  [#7390](https://github.com/ClickHouse/ClickHouse/pull/7390) ([Azat
  Khuzhin](https://github.com/azat))
- Настройка `s3_min_upload_part_size` теперь задаётся на уровне таблицы.
  [#7059](https://github.com/ClickHouse/ClickHouse/pull/7059) ([Vladimir
  Chebotarev](https://github.com/excitoon))
- Проверка TTL в StorageFactory. [#7304](https://github.com/ClickHouse/ClickHouse/pull/7304)
  ([sundyli](https://github.com/sundy-li))
- Сжатие левых блоков в частичном слиянии при соединении (оптимизация).
  [#7122](https://github.com/ClickHouse/ClickHouse/pull/7122) ([Artem
  Zuikov](https://github.com/4ertus2))
- Запрещено использование недетерминированных функций в мутациях движков реплицируемых таблиц, поскольку это
  может привести к несогласованности между репликами.
  [#7247](https://github.com/ClickHouse/ClickHouse/pull/7247) ([Alexander
  Kazakov](https://github.com/Akazz))
- Отключён трекер памяти при преобразовании трассировки стека исключений в строку. Это предотвращает потерю
  сообщений об ошибках типа `Memory limit exceeded` на сервере, которые вызывали исключение `Attempt to read after eof` на клиенте. [#7264](https://github.com/ClickHouse/ClickHouse/pull/7264)
  ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Различные улучшения форматов. Решает
  [#6033](https://github.com/ClickHouse/ClickHouse/issues/6033),
  [#2633](https://github.com/ClickHouse/ClickHouse/issues/2633),
  [#6611](https://github.com/ClickHouse/ClickHouse/issues/6611),
  [#6742](https://github.com/ClickHouse/ClickHouse/issues/6742)
  [#7215](https://github.com/ClickHouse/ClickHouse/pull/7215)
  ([tavplubix](https://github.com/tavplubix))
- ClickHouse игнорирует значения в правой части оператора IN, которые не могут быть преобразованы к типу
  левой части. Реализована корректная работа для составных типов — Array и Tuple.
  [#7283](https://github.com/ClickHouse/ClickHouse/pull/7283) ([Alexander
  Kuzmenkov](https://github.com/akuzm))
- Поддержка недостающих операторов неравенства для ASOF JOIN. Теперь возможно использовать варианты меньше-или-равно и строгие
  варианты больше и меньше для столбца ASOF в синтаксисе ON.
  [#7282](https://github.com/ClickHouse/ClickHouse/pull/7282) ([Artem
  Zuikov](https://github.com/4ertus2))
- Оптимизация частичного слияния при соединении. [#7070](https://github.com/ClickHouse/ClickHouse/pull/7070)
  ([Artem Zuikov](https://github.com/4ertus2))
- Ограничено использование памяти в функциях uniqCombined до 98 КБ.
  [#7236](https://github.com/ClickHouse/ClickHouse/pull/7236),
  [#7270](https://github.com/ClickHouse/ClickHouse/pull/7270) ([Azat
  Khuzhin](https://github.com/azat))
- Сброс частей правой таблицы соединения на диск в PartialMergeJoin (если недостаточно
  памяти). Загрузка данных обратно при необходимости. [#7186](https://github.com/ClickHouse/ClickHouse/pull/7186)
  ([Artem Zuikov](https://github.com/4ertus2))

#### Улучшения производительности {#performance-improvement-1}

- Ускорение joinGet с константными аргументами за счёт избежания дублирования данных.
  [#7359](https://github.com/ClickHouse/ClickHouse/pull/7359) ([Amos
  Bird](https://github.com/amosbird))
- Ранний возврат, если подзапрос пуст.
  [#7007](https://github.com/ClickHouse/ClickHouse/pull/7007) ([小路](https://github.com/nicelulu))
- Оптимизация парсинга SQL-выражений в Values.
  [#6781](https://github.com/ClickHouse/ClickHouse/pull/6781)
  ([tavplubix](https://github.com/tavplubix))

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-1}


* Отключены некоторые contrib-библиотеки для кросс-компиляции под Mac OS.
  [#7101](https://github.com/ClickHouse/ClickHouse/pull/7101) ([Ivan](https://github.com/abyss7))
* Добавлена недостающая линковка с PocoXML для clickhouse&#95;common&#95;io.
  [#7200](https://github.com/ClickHouse/ClickHouse/pull/7200) ([Azat
  Khuzhin](https://github.com/azat))
* Добавлена поддержка нескольких аргументов фильтра тестов в clickhouse-test.
  [#7226](https://github.com/ClickHouse/ClickHouse/pull/7226) ([Alexander
  Kuzmenkov](https://github.com/akuzm))
* Включена поддержка musl и jemalloc на ARM. [#7300](https://github.com/ClickHouse/ClickHouse/pull/7300)
  ([Amos Bird](https://github.com/amosbird))
* Добавлен параметр `--client-option` в `clickhouse-test` для передачи дополнительных параметров в клиент.
  [#7277](https://github.com/ClickHouse/ClickHouse/pull/7277) ([Nikolai
  Kochetov](https://github.com/KochetovNicolai))
* Сохранять существующие конфигурации при обновлении пакета rpm.
  [#7103](https://github.com/ClickHouse/ClickHouse/pull/7103)
  ([filimonov](https://github.com/filimonov))
* Исправлены ошибки, обнаруженные PVS. [#7153](https://github.com/ClickHouse/ClickHouse/pull/7153) ([Artem
  Zuikov](https://github.com/4ertus2))
* Исправлена сборка под Darwin. [#7149](https://github.com/ClickHouse/ClickHouse/pull/7149)
  ([Ivan](https://github.com/abyss7))
* Совместимость с glibc 2.29. [#7142](https://github.com/ClickHouse/ClickHouse/pull/7142) ([Amos
  Bird](https://github.com/amosbird))
* Убедитесь, что dh&#95;clean не затрагивает потенциальные исходные файлы.
  [#7205](https://github.com/ClickHouse/ClickHouse/pull/7205) ([Amos
  Bird](https://github.com/amosbird))
* Попытка избежать конфликта при обновлении с altinity rpm — файл конфигурации вынесен в отдельный пакет
  clickhouse-server-common. [#7073](https://github.com/ClickHouse/ClickHouse/pull/7073)
  ([filimonov](https://github.com/filimonov))
* Оптимизированы некоторые заголовочные файлы для ускорения пересборки.
  [#7212](https://github.com/ClickHouse/ClickHouse/pull/7212),
  [#7231](https://github.com/ClickHouse/ClickHouse/pull/7231) ([Alexander
  Kuzmenkov](https://github.com/akuzm))
* Добавлены тесты производительности для `Date` и `DateTime`. [#7332](https://github.com/ClickHouse/ClickHouse/pull/7332) ([Vasily
  Nemkov](https://github.com/Enmk))
* Исправлены некоторые тесты, содержавшие недетерминированные изменения.
  [#7132](https://github.com/ClickHouse/ClickHouse/pull/7132) ([Alexander
  Kazakov](https://github.com/Akazz))
* Добавлена сборка с MemorySanitizer в CI. [#7066](https://github.com/ClickHouse/ClickHouse/pull/7066)
  ([Alexander Kuzmenkov](https://github.com/akuzm))
* Исключено использование неинициализированных значений в MetricsTransmitter.
  [#7158](https://github.com/ClickHouse/ClickHouse/pull/7158) ([Azat
  Khuzhin](https://github.com/azat))
* Исправлены некоторые проблемы с Fields, обнаруженные MemorySanitizer.
  [#7135](https://github.com/ClickHouse/ClickHouse/pull/7135),
  [#7179](https://github.com/ClickHouse/ClickHouse/pull/7179) ([Alexander
  Kuzmenkov](https://github.com/akuzm)), [#7376](https://github.com/ClickHouse/ClickHouse/pull/7376)
  ([Amos Bird](https://github.com/amosbird))
* Исправлено неопределённое поведение в `murmurhash32`. [#7388](https://github.com/ClickHouse/ClickHouse/pull/7388) ([Amos
  Bird](https://github.com/amosbird))
* Исправлено неопределённое поведение в `StoragesInfoStream`. [#7384](https://github.com/ClickHouse/ClickHouse/pull/7384)
  ([tavplubix](https://github.com/tavplubix))
* Исправлена свёртка константных выражений для внешних движков баз данных (MySQL, ODBC, JDBC). В предыдущих версиях она не работала для нескольких константных выражений и вовсе не работала для типов Date, DateTime и UUID. Это исправляет [#7245](https://github.com/ClickHouse/ClickHouse/issues/7245)
  [#7252](https://github.com/ClickHouse/ClickHouse/pull/7252)
  ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена ошибка гонки данных, обнаруженная ThreadSanitizer, в LIVE VIEW при доступе к переменной no&#95;users&#95;thread.
  [#7353](https://github.com/ClickHouse/ClickHouse/pull/7353)
  ([vzakaznikov](https://github.com/vzakaznikov))
* Удалены символы `malloc` в `libcommon`
  [#7134](https://github.com/ClickHouse/ClickHouse/pull/7134),
  [#7065](https://github.com/ClickHouse/ClickHouse/pull/7065) ([Amos
  Bird](https://github.com/amosbird))
* Добавлен глобальный флаг ENABLE&#95;LIBRARIES для отключения всех библиотек.
  [#7063](https://github.com/ClickHouse/ClickHouse/pull/7063)
  ([proller](https://github.com/proller))

#### Очистка кода {#code-cleanup}

- Обобщение репозитория конфигурации для подготовки к DDL для словарей. [#7155](https://github.com/ClickHouse/ClickHouse/pull/7155)
  ([alesapin](https://github.com/alesapin))
- Парсер для DDL словарей без семантики.
  [#7209](https://github.com/ClickHouse/ClickHouse/pull/7209)
  ([alesapin](https://github.com/alesapin))
- Разделение ParserCreateQuery на несколько более мелких парсеров.
  [#7253](https://github.com/ClickHouse/ClickHouse/pull/7253)
  ([alesapin](https://github.com/alesapin))
- Небольшой рефакторинг и переименование в области внешних словарей.
  [#7111](https://github.com/ClickHouse/ClickHouse/pull/7111)
  ([alesapin](https://github.com/alesapin))
- Рефакторинг части кода для подготовки к управлению доступом на основе ролей. [#7235](https://github.com/ClickHouse/ClickHouse/pull/7235) ([Vitaly
  Baranov](https://github.com/vitlibar))
- Некоторые улучшения в коде DatabaseOrdinary.
  [#7086](https://github.com/ClickHouse/ClickHouse/pull/7086) ([Nikita
  Vasilev](https://github.com/nikvas0))
- Отказ от использования итераторов в методах find() и emplace() хеш-таблиц.
  [#7026](https://github.com/ClickHouse/ClickHouse/pull/7026) ([Alexander
  Kuzmenkov](https://github.com/akuzm))
- Исправление getMultipleValuesFromConfig в случае, когда параметр root не пустой. [#7374](https://github.com/ClickHouse/ClickHouse/pull/7374)
  ([Mikhail Korotov](https://github.com/millb))
- Удаление дублирования кода (TemporaryFile и TemporaryFileStream)
  [#7166](https://github.com/ClickHouse/ClickHouse/pull/7166) ([Artem
  Zuikov](https://github.com/4ertus2))
- Небольшое улучшение читаемости кода (`MergeTreeData::getActiveContainingPart`).
  [#7361](https://github.com/ClickHouse/ClickHouse/pull/7361) ([Vladimir
  Chebotarev](https://github.com/excitoon))
- Ожидание завершения всех запланированных задач, использующих локальные объекты, если `ThreadPool::schedule(...)` выбрасывает
  исключение. Переименование `ThreadPool::schedule(...)` в `ThreadPool::scheduleOrThrowOnError(...)` и
  исправление комментариев для явного указания на возможность выброса исключения.
  [#7350](https://github.com/ClickHouse/ClickHouse/pull/7350)
  ([tavplubix](https://github.com/tavplubix))


## Релиз ClickHouse 19.15 {#clickhouse-release-19-15}

### Релиз ClickHouse 19.15.4.10, 2019-10-31 {#clickhouse-release-19-15-4-10-2019-10-31}

#### Исправление ошибок {#bug-fix-3}

- Добавлена обработка типов данных SQL_TINYINT и SQL_BIGINT, исправлена обработка типа данных SQL_FLOAT в ODBC Bridge.
  [#7491](https://github.com/ClickHouse/ClickHouse/pull/7491) ([Denis Glazachev](https://github.com/traceon))
- Разрешено размещение некоторых частей на целевом диске или томе в MOVE PARTITION.
  [#7434](https://github.com/ClickHouse/ClickHouse/pull/7434) ([Vladimir Chebotarev](https://github.com/excitoon))
- Исправлена обработка NULL-значений в nullable-столбцах через ODBC-bridge.
  [#7402](https://github.com/ClickHouse/ClickHouse/pull/7402) ([Vasily Nemkov](https://github.com/Enmk))
- Исправлен INSERT в нелокальный узел Distributed с MATERIALIZED-столбцами.
  [#7377](https://github.com/ClickHouse/ClickHouse/pull/7377) ([Azat Khuzhin](https://github.com/azat))
- Исправлена функция getMultipleValuesFromConfig.
  [#7374](https://github.com/ClickHouse/ClickHouse/pull/7374) ([Mikhail Korotov](https://github.com/millb))
- Исправлена проблема использования HTTP keep alive timeout вместо TCP keep alive timeout.
  [#7351](https://github.com/ClickHouse/ClickHouse/pull/7351) ([Vasily Nemkov](https://github.com/Enmk))
- Ожидание завершения всех задач при возникновении исключения (исправляет редкие segfault).
  [#7350](https://github.com/ClickHouse/ClickHouse/pull/7350) ([tavplubix](https://github.com/tavplubix))
- Отключена отправка данных в материализованные представления при вставке в таблицу Kafka.
  [#7265](https://github.com/ClickHouse/ClickHouse/pull/7265) ([Ivan](https://github.com/abyss7))
- Отключен трекер памяти для стека исключений.
  [#7264](https://github.com/ClickHouse/ClickHouse/pull/7264) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Исправлен некорректный код при преобразовании запроса для внешней базы данных.
  [#7252](https://github.com/ClickHouse/ClickHouse/pull/7252) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Предотвращено использование неинициализированных значений в MetricsTransmitter.
  [#7158](https://github.com/ClickHouse/ClickHouse/pull/7158) ([Azat Khuzhin](https://github.com/azat))
- Добавлен пример конфигурации с макросами для тестов ([alexey-milovidov](https://github.com/alexey-milovidov))

### Релиз ClickHouse 19.15.3.6, 2019-10-09 {#clickhouse-release-19-15-3-6-2019-10-09}

#### Исправление ошибок {#bug-fix-4}

- Исправлена ошибка bad_variant в хешированном словаре.
  ([alesapin](https://github.com/alesapin))
- Исправлена ошибка с segmentation fault в запросе ATTACH PART.
  ([alesapin](https://github.com/alesapin))
- Исправлен расчет времени в `MergeTreeData`.
  ([Vladimir Chebotarev](https://github.com/excitoon))
- Явный коммит в Kafka после завершения записи.
  [#7175](https://github.com/ClickHouse/ClickHouse/pull/7175) ([Ivan](https://github.com/abyss7))
- Исправлена сериализация NULL-значений в min/max индексах частей MergeTree.
  [#7234](https://github.com/ClickHouse/ClickHouse/pull/7234) ([Alexander Kuzmenkov](https://github.com/akuzm))

### Релиз ClickHouse 19.15.2.2, 2019-10-01 {#clickhouse-release-19-15-2-2-2019-10-01}

#### Новая возможность {#new-feature-3}


- Многоуровневое хранение: поддержка использования нескольких томов хранения для таблиц с движком MergeTree. Можно хранить свежие данные на SSD и автоматически перемещать старые данные на HDD. ([пример](https://clickhouse.github.io/clickhouse-presentations/meetup30/new_features/#12)). [#4918](https://github.com/ClickHouse/ClickHouse/pull/4918) ([Igr](https://github.com/ObjatieGroba)) [#6489](https://github.com/ClickHouse/ClickHouse/pull/6489) ([alesapin](https://github.com/alesapin))
- Добавлена табличная функция `input` для чтения входящих данных в запросе `INSERT SELECT`. [#5450](https://github.com/ClickHouse/ClickHouse/pull/5450) ([palasonic1](https://github.com/palasonic1)) [#6832](https://github.com/ClickHouse/ClickHouse/pull/6832) ([Anton Popov](https://github.com/CurtizJ))
- Добавлен layout словаря `sparse_hashed`, который функционально эквивалентен layout `hashed`, но более эффективен по памяти. Он использует примерно в два раза меньше памяти за счёт более медленного извлечения значений. [#6894](https://github.com/ClickHouse/ClickHouse/pull/6894) ([Azat Khuzhin](https://github.com/azat))
- Реализована возможность определения списка пользователей для доступа к словарям. Используется только текущая подключённая база данных. [#6907](https://github.com/ClickHouse/ClickHouse/pull/6907) ([Guillaume Tassery](https://github.com/YiuRULE))
- Добавлена опция `LIMIT` для запроса `SHOW`. [#6944](https://github.com/ClickHouse/ClickHouse/pull/6944) ([Philipp Malkovsky](https://github.com/malkfilipp))
- Добавлена функция `bitmapSubsetLimit(bitmap, range_start, limit)`, которая возвращает подмножество из наименьших `limit` значений в наборе, которые не меньше `range_start`. [#6957](https://github.com/ClickHouse/ClickHouse/pull/6957) ([Zhichang Yu](https://github.com/yuzhichang))
- Добавлены функции `bitmapMin` и `bitmapMax`. [#6970](https://github.com/ClickHouse/ClickHouse/pull/6970) ([Zhichang Yu](https://github.com/yuzhichang))
- Добавлена функция `repeat`, связанная с [issue-6648](https://github.com/ClickHouse/ClickHouse/issues/6648) [#6999](https://github.com/ClickHouse/ClickHouse/pull/6999) ([flynn](https://github.com/ucasFL))

#### Экспериментальная функциональность {#experimental-feature-1}

- Реализован вариант Merge Join (в памяти), который не изменяет текущий конвейер. Результат частично отсортирован по ключу слияния. Установите `partial_merge_join = 1` для использования этой функции. Merge Join всё ещё находится в разработке. [#6940](https://github.com/ClickHouse/ClickHouse/pull/6940) ([Artem Zuikov](https://github.com/4ertus2))
- Добавлены движок `S3` и табличная функция. Всё ещё находится в разработке (поддержка аутентификации пока отсутствует). [#5596](https://github.com/ClickHouse/ClickHouse/pull/5596) ([Vladimir Chebotarev](https://github.com/excitoon))

#### Улучшения {#improvement-2}


- Каждое сообщение, прочитанное из Kafka, вставляется атомарно. Это решает почти все известные проблемы с движком Kafka. [#6950](https://github.com/ClickHouse/ClickHouse/pull/6950) ([Ivan](https://github.com/abyss7))
- Улучшения отказоустойчивости распределённых запросов. Сокращено время восстановления, также теперь это настраивается и отображается в `system.clusters`. [#6399](https://github.com/ClickHouse/ClickHouse/pull/6399) ([Vasily Nemkov](https://github.com/Enmk))
- Поддержка числовых значений для Enum непосредственно в секции `IN`. #6766 [#6941](https://github.com/ClickHouse/ClickHouse/pull/6941) ([dimarub2000](https://github.com/dimarub2000))
- Поддержка (опциональная, по умолчанию отключена) перенаправлений в движке URL. [#6914](https://github.com/ClickHouse/ClickHouse/pull/6914) ([maqroll](https://github.com/maqroll))
- Добавлено информационное сообщение при подключении клиента со старой версией к серверу. [#6893](https://github.com/ClickHouse/ClickHouse/pull/6893) ([Philipp Malkovsky](https://github.com/malkfilipp))
- Удалено ограничение максимального времени ожидания при отправке данных в распределённые таблицы [#6895](https://github.com/ClickHouse/ClickHouse/pull/6895) ([Azat Khuzhin](https://github.com/azat))
- Добавлена возможность отправки событий профилирования (счётчиков) с накопительными значениями в graphite. Это можно включить в параметре `<events_cumulative>` в серверном `config.xml`. [#6969](https://github.com/ClickHouse/ClickHouse/pull/6969) ([Azat Khuzhin](https://github.com/azat))
- Добавлено автоматическое приведение типа `T` к `LowCardinality(T)` при вставке данных в столбец типа `LowCardinality(T)` в формате Native через HTTP. [#6891](https://github.com/ClickHouse/ClickHouse/pull/6891) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Добавлена возможность использования функции `hex` без применения `reinterpretAsString` для `Float32`, `Float64`. [#7024](https://github.com/ClickHouse/ClickHouse/pull/7024) ([Mikhail Korotov](https://github.com/millb))

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-2}

- Добавлен gdb-index в бинарный файл clickhouse с отладочной информацией. Это ускорит время запуска `gdb`. [#6947](https://github.com/ClickHouse/ClickHouse/pull/6947) ([alesapin](https://github.com/alesapin))
- Ускорена упаковка deb с помощью модифицированного dpkg-deb, использующего `pigz`. [#6960](https://github.com/ClickHouse/ClickHouse/pull/6960) ([alesapin](https://github.com/alesapin))
- Установка `enable_fuzzing = 1` включает инструментирование libfuzzer для всего кода проекта. [#7042](https://github.com/ClickHouse/ClickHouse/pull/7042) ([kyprizel](https://github.com/kyprizel))
- Добавлен smoke-тест раздельной сборки в CI. [#7061](https://github.com/ClickHouse/ClickHouse/pull/7061) ([alesapin](https://github.com/alesapin))
- Добавлена сборка с MemorySanitizer в CI. [#7066](https://github.com/ClickHouse/ClickHouse/pull/7066) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Замена `libsparsehash` на `sparsehash-c11` [#6965](https://github.com/ClickHouse/ClickHouse/pull/6965) ([Azat Khuzhin](https://github.com/azat))

#### Исправление ошибок {#bug-fix-5}


- Исправлено снижение производительности анализа индексов по составным ключам в больших таблицах. Исправляет #6924. [#7075](https://github.com/ClickHouse/ClickHouse/pull/7075) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена логическая ошибка, приводящая к segfault при выборке из пустого топика Kafka. [#6909](https://github.com/ClickHouse/ClickHouse/pull/6909) ([Ivan](https://github.com/abyss7))
- Исправлено слишком раннее закрытие соединения MySQL в `MySQLBlockInputStream.cpp`. [#6882](https://github.com/ClickHouse/ClickHouse/pull/6882) ([Clément Rodriguez](https://github.com/clemrodriguez))
- Возвращена поддержка очень старых ядер Linux (исправляет [#6841](https://github.com/ClickHouse/ClickHouse/issues/6841)) [#6853](https://github.com/ClickHouse/ClickHouse/pull/6853) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена возможная потеря данных в запросе `insert select` при наличии пустого блока во входном потоке. #6834 #6862 [#6911](https://github.com/ClickHouse/ClickHouse/pull/6911) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Исправлена работа функции `АrrayEnumerateUniqRanked` с пустыми массивами в параметрах [#6928](https://github.com/ClickHouse/ClickHouse/pull/6928) ([proller](https://github.com/proller))
- Исправлены сложные запросы с array join и глобальными подзапросами. [#6934](https://github.com/ClickHouse/ClickHouse/pull/6934) ([Ivan](https://github.com/abyss7))
- Исправлена ошибка `Unknown identifier` в ORDER BY и GROUP BY при использовании нескольких JOIN [#7022](https://github.com/ClickHouse/ClickHouse/pull/7022) ([Artem Zuikov](https://github.com/4ertus2))
- Исправлено предупреждение `MSan` при выполнении функции с аргументом типа `LowCardinality`. [#7062](https://github.com/ClickHouse/ClickHouse/pull/7062) ([Nikolai Kochetov](https://github.com/KochetovNicolai))

#### Обратно несовместимые изменения {#backward-incompatible-change-2}

- Изменен формат сериализации состояний агрегатных функций bitmap\* для повышения производительности. Сериализованные состояния bitmap\* из предыдущих версий не могут быть прочитаны. [#6908](https://github.com/ClickHouse/ClickHouse/pull/6908) ([Zhichang Yu](https://github.com/yuzhichang))


## Релиз ClickHouse 19.14 {#clickhouse-release-19-14}

### Релиз ClickHouse 19.14.7.15, 2019-10-02 {#clickhouse-release-19-14-7-15-2019-10-02}

#### Исправление ошибок {#bug-fix-6}

- Этот релиз также содержит все исправления ошибок из версии 19.11.12.69.
- Исправлена совместимость распределённых запросов между версией 19.14 и более ранними версиями. Исправляет [#7068](https://github.com/ClickHouse/ClickHouse/issues/7068). [#7069](https://github.com/ClickHouse/ClickHouse/pull/7069) ([alexey-milovidov](https://github.com/alexey-milovidov))

### Релиз ClickHouse 19.14.6.12, 2019-09-19 {#clickhouse-release-19-14-6-12-2019-09-19}

#### Исправление ошибок {#bug-fix-7}

- Исправлена работа функции `АrrayEnumerateUniqRanked` с пустыми массивами в параметрах. [#6928](https://github.com/ClickHouse/ClickHouse/pull/6928) ([proller](https://github.com/proller))
- Исправлено имя подзапроса в запросах с `ARRAY JOIN` и `GLOBAL IN subquery` с псевдонимом. Псевдоним подзапроса используется для имени внешней таблицы, если он указан. [#6934](https://github.com/ClickHouse/ClickHouse/pull/6934) ([Ivan](https://github.com/abyss7))

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-3}

- Исправлен [нестабильный](<https://clickhouse-test-reports.s3.yandex.net/6944/aab95fd5175a513413c7395a73a82044bdafb906/functional_stateless_tests_(debug).html>) тест `00715_fetch_merged_or_mutated_part_zookeeper` путём переписывания его в виде shell-скрипта, так как необходимо дождаться применения мутаций. [#6977](https://github.com/ClickHouse/ClickHouse/pull/6977) ([Alexander Kazakov](https://github.com/Akazz))
- Исправлена ошибка UBSan и MemSan в функции `groupUniqArray` с пустым массивом в качестве аргумента. Ошибка была вызвана размещением пустого `PaddedPODArray` в нулевую ячейку хеш-таблицы, так как конструктор для значения нулевой ячейки не вызывался. [#6937](https://github.com/ClickHouse/ClickHouse/pull/6937) ([Amos Bird](https://github.com/amosbird))

### Релиз ClickHouse 19.14.3.3, 2019-09-10 {#clickhouse-release-19-14-3-3-2019-09-10}

#### Новая возможность {#new-feature-4}


* Модификатор `WITH FILL` для `ORDER BY` (продолжение [#5069](https://github.com/ClickHouse/ClickHouse/issues/5069)) [#6610](https://github.com/ClickHouse/ClickHouse/pull/6610) ([Anton Popov](https://github.com/CurtizJ))
* Модификатор `WITH TIES` для `LIMIT` (продолжение [#5069](https://github.com/ClickHouse/ClickHouse/issues/5069)) [#6610](https://github.com/ClickHouse/ClickHouse/pull/6610) ([Anton Popov](https://github.com/CurtizJ))
* Разбирать некавыченный литерал `NULL` как значение NULL (если установлено `format_csv_unquoted_null_literal_as_null=1`). Инициализировать поля со значением NULL значениями по умолчанию, если тип данных этого поля не допускает NULL (если установлено `input_format_null_as_default=1`). [#5990](https://github.com/ClickHouse/ClickHouse/issues/5990) [#6055](https://github.com/ClickHouse/ClickHouse/pull/6055) ([tavplubix](https://github.com/tavplubix))
* Поддержка подстановочных символов в путях табличных функций `file` и `hdfs`. Если путь содержит подстановочные символы, таблица будет доступна только для чтения. Пример использования: `select * from hdfs('hdfs://hdfs1:9000/some_dir/another_dir/*/file{0..9}{0..9}')` и `select * from file('some_dir/{some_file,another_file,yet_another}.tsv', 'TSV', 'value UInt32')`. [#6092](https://github.com/ClickHouse/ClickHouse/pull/6092) ([Olga Khvostikova](https://github.com/stavrolia))
* Новая таблица `system.metric_log`, которая сохраняет значения из `system.events` и `system.metrics` с заданным временным интервалом. [#6363](https://github.com/ClickHouse/ClickHouse/issues/6363) [#6467](https://github.com/ClickHouse/ClickHouse/pull/6467) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)) [#6530](https://github.com/ClickHouse/ClickHouse/pull/6530) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Добавлена возможность записи текстовых логов ClickHouse в таблицу `system.text_log`. [#6037](https://github.com/ClickHouse/ClickHouse/issues/6037) [#6103](https://github.com/ClickHouse/ClickHouse/pull/6103) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)) [#6164](https://github.com/ClickHouse/ClickHouse/pull/6164) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Показ приватных символов в трассировках стека (осуществляется путём разбора таблиц символов ELF‑файлов). Добавлена информация о файле и номере строки в трассировках стека, если присутствует отладочная информация. Ускорен поиск имён символов за счёт индексации символов, присутствующих в программе. Добавлены новые SQL‑функции для интроспекции: `demangle` и `addressToLine`. Функция `symbolizeAddress` переименована в `addressToSymbol` для единообразия. Функция `addressToSymbol` по соображениям производительности будет возвращать «запутанное» (mangled) имя, и вам нужно самостоятельно применять `demangle`. Добавлена настройка `allow_introspection_functions`, которая по умолчанию выключена. [#6201](https://github.com/ClickHouse/ClickHouse/pull/6201) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Табличная функция `values` (имя регистронезависимо). Она позволяет читать данные из списка `VALUES`, предложенного в [#5984](https://github.com/ClickHouse/ClickHouse/issues/5984). Пример: `SELECT * FROM VALUES('a UInt64, s String', (1, 'one'), (2, 'two'), (3, 'three'))`. [#6217](https://github.com/ClickHouse/ClickHouse/issues/6217). [#6209](https://github.com/ClickHouse/ClickHouse/pull/6209) ([dimarub2000](https://github.com/dimarub2000))
* Добавлена возможность изменять настройки хранения. Синтаксис: `ALTER TABLE <table> MODIFY SETTING <setting> = <value>`. [#6366](https://github.com/ClickHouse/ClickHouse/pull/6366) [#6669](https://github.com/ClickHouse/ClickHouse/pull/6669) [#6685](https://github.com/ClickHouse/ClickHouse/pull/6685) ([alesapin](https://github.com/alesapin))
* Поддержка удаления отсоединённых партиций. Синтаксис: `ALTER TABLE <table_name> DROP DETACHED PART '<part_id>'`. [#6158](https://github.com/ClickHouse/ClickHouse/pull/6158) ([tavplubix](https://github.com/tavplubix))
* Ограничения таблиц. Позволяют добавить ограничение в определение таблицы, которое будет проверяться при выполнении `INSERT`. [#5273](https://github.com/ClickHouse/ClickHouse/pull/5273) ([Gleb Novikov](https://github.com/NanoBjorn)) [#6652](https://github.com/ClickHouse/ClickHouse/pull/6652) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Поддержка каскадных материализованных представлений. [#6324](https://github.com/ClickHouse/ClickHouse/pull/6324) ([Amos Bird](https://github.com/amosbird))
* Включить профилировщик запросов по умолчанию, чтобы выбирать образцы из каждого потока выполнения запроса раз в секунду. [#6283](https://github.com/ClickHouse/ClickHouse/pull/6283) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Формат импорта `ORC`. [#6454](https://github.com/ClickHouse/ClickHouse/pull/6454) [#6703](https://github.com/ClickHouse/ClickHouse/pull/6703) ([akonyaev90](https://github.com/akonyaev90))
* Добавлены две новые функции: `sigmoid` и `tanh` (полезные для задач машинного обучения). [#6254](https://github.com/ClickHouse/ClickHouse/pull/6254) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Функции `hasToken(haystack, token)`, `hasTokenCaseInsensitive(haystack, token)` проверяют, содержится ли заданный token в haystack. Token — это подстрока максимальной длины между двумя неалфавитно-цифровыми ASCII-символами (или границами haystack). Token должен быть константной строкой. Поддерживается специализацией индекса tokenbf&#95;v1. [#6596](https://github.com/ClickHouse/ClickHouse/pull/6596), [#6662](https://github.com/ClickHouse/ClickHouse/pull/6662) ([Vasily Nemkov](https://github.com/Enmk))
* Новая функция `neighbor(value, offset[, default_value])`. Позволяет получить предыдущее/следующее значение в столбце в пределах блока данных. [#5925](https://github.com/ClickHouse/ClickHouse/pull/5925) ([Alex Krash](https://github.com/alex-krash)) [6685365ab8c5b74f9650492c88a012596eb1b0c6](https://github.com/ClickHouse/ClickHouse/commit/6685365ab8c5b74f9650492c88a012596eb1b0c6) [341e2e4587a18065c2da1ca888c73389f48ce36c](https://github.com/ClickHouse/ClickHouse/commit/341e2e4587a18065c2da1ca888c73389f48ce36c) [Alexey Milovidov](https://github.com/alexey-milovidov)
* Добавлена функция `currentUser()`, возвращающая логин авторизованного пользователя. Добавлен псевдоним `user()` для совместимости с MySQL. [#6470](https://github.com/ClickHouse/ClickHouse/pull/6470) ([Alex Krash](https://github.com/alex-krash))
* Новые агрегатные функции `quantilesExactInclusive` и `quantilesExactExclusive`, предложенные в [#5885](https://github.com/ClickHouse/ClickHouse/issues/5885). [#6477](https://github.com/ClickHouse/ClickHouse/pull/6477) ([dimarub2000](https://github.com/dimarub2000))
* Функция `bitmapRange(bitmap, range_begin, range_end)`, которая возвращает новый набор со значениями из указанного диапазона (не включая `range_end`). [#6314](https://github.com/ClickHouse/ClickHouse/pull/6314) ([Zhichang Yu](https://github.com/yuzhichang))
* Функция `geohashesInBox(longitude_min, latitude_min, longitude_max, latitude_max, precision)`, создающая массив строк длины `precision`, соответствующих geohash-ячейкам, покрывающим заданную область. [#6127](https://github.com/ClickHouse/ClickHouse/pull/6127) ([Vasily Nemkov](https://github.com/Enmk))
* Реализована поддержка запроса `INSERT` для таблиц `Kafka`. [#6012](https://github.com/ClickHouse/ClickHouse/pull/6012) ([Ivan](https://github.com/abyss7))
* Добавлена поддержка виртуальных столбцов `_partition` и `_timestamp` в движке Kafka. [#6400](https://github.com/ClickHouse/ClickHouse/pull/6400) ([Ivan](https://github.com/abyss7))
* Появилась возможность удалять конфиденциальные данные из `query_log`, серверных логов и списка процессов с помощью правил на основе регулярных выражений. [#5710](https://github.com/ClickHouse/ClickHouse/pull/5710) ([filimonov](https://github.com/filimonov))

#### Экспериментальная функциональность {#experimental-feature-2}

- Формат входных и выходных данных `Template`. Позволяет указать пользовательскую строку формата для ввода и вывода. [#4354](https://github.com/ClickHouse/ClickHouse/issues/4354) [#6727](https://github.com/ClickHouse/ClickHouse/pull/6727) ([tavplubix](https://github.com/tavplubix))
- Реализация таблиц `LIVE VIEW`, которые были первоначально предложены в [#2898](https://github.com/ClickHouse/ClickHouse/pull/2898), подготовлены в [#3925](https://github.com/ClickHouse/ClickHouse/issues/3925), а затем обновлены в [#5541](https://github.com/ClickHouse/ClickHouse/issues/5541). Подробное описание см. в [#5541](https://github.com/ClickHouse/ClickHouse/issues/5541). [#5541](https://github.com/ClickHouse/ClickHouse/issues/5541) ([vzakaznikov](https://github.com/vzakaznikov)) [#6425](https://github.com/ClickHouse/ClickHouse/pull/6425) ([Nikolai Kochetov](https://github.com/KochetovNicolai)) [#6656](https://github.com/ClickHouse/ClickHouse/pull/6656) ([vzakaznikov](https://github.com/vzakaznikov)) Обратите внимание, что функциональность `LIVE VIEW` может быть удалена в следующих версиях.

#### Исправление ошибок {#bug-fix-8}


* Этот релиз также включает все исправления ошибок из версий 19.13 и 19.11.
* Исправлена ошибка сегментации при наличии в таблице пропускающих индексов во время вертикального объединения. [#6723](https://github.com/ClickHouse/ClickHouse/pull/6723) ([alesapin](https://github.com/alesapin))
* Исправлена работа TTL на уровне столбцов с нетривиальными значениями по умолчанию. Ранее в случае принудительного выполнения TTL-слияния с запросом `OPTIMIZE ... FINAL` просроченные значения заменялись типовыми значениями по умолчанию вместо заданных пользователем значений по умолчанию для столбца. [#6796](https://github.com/ClickHouse/ClickHouse/pull/6796) ([Anton Popov](https://github.com/CurtizJ))
* Исправлена проблема дублирования сообщений Kafka при штатной перезагрузке сервера. [#6597](https://github.com/ClickHouse/ClickHouse/pull/6597) ([Ivan](https://github.com/abyss7))
* Исправлен бесконечный цикл при чтении сообщений Kafka. Полностью отключено приостановление/возобновление consumer при подписке — иначе в некоторых сценариях он мог оставаться приостановленным бесконечно. [#6354](https://github.com/ClickHouse/ClickHouse/pull/6354) ([Ivan](https://github.com/abyss7))
* Исправлено исключение `Key expression contains comparison between inconvertible types` в функции `bitmapContains`. [#6136](https://github.com/ClickHouse/ClickHouse/issues/6136) [#6146](https://github.com/ClickHouse/ClickHouse/issues/6146) [#6156](https://github.com/ClickHouse/ClickHouse/pull/6156) ([dimarub2000](https://github.com/dimarub2000))
* Исправлен сбой сегментации при включённом `optimize_skip_unused_shards` и отсутствующем ключе шардинга. [#6384](https://github.com/ClickHouse/ClickHouse/pull/6384) ([Anton Popov](https://github.com/CurtizJ))
* Исправлен некорректный код в мутациях, который мог приводить к повреждению памяти. Исправлена ошибка сегментирования при чтении адреса `0x14c0`, которая могла происходить из‑за одновременного выполнения `DROP TABLE` и `SELECT` из `system.parts` или `system.parts_columns`. Исправлена гонка при подготовке запросов мутаций. Исправлена взаимная блокировка, вызванная `OPTIMIZE` реплицируемых таблиц и одновременными операциями модификации, такими как `ALTER`. [#6514](https://github.com/ClickHouse/ClickHouse/pull/6514) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Удалено излишне подробное логирование в интерфейсе MySQL [#6389](https://github.com/ClickHouse/ClickHouse/pull/6389) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Вернули возможность разбирать булевые настройки из `true` и `false` в конфигурационном файле. [#6278](https://github.com/ClickHouse/ClickHouse/pull/6278) ([alesapin](https://github.com/alesapin))
* Исправлен сбой в функциях `quantile` и `median` при работе с `Nullable(Decimal128)`. [#6378](https://github.com/ClickHouse/ClickHouse/pull/6378) ([Artem Zuikov](https://github.com/4ertus2))
* Исправлена возможная неполнота результата, возвращаемого запросом `SELECT` с условием `WHERE` по первичному ключу, содержащему преобразование к типу Float. Ошибка была вызвана некорректной проверкой монотонности в функции `toFloat`. [#6248](https://github.com/ClickHouse/ClickHouse/issues/6248) [#6374](https://github.com/ClickHouse/ClickHouse/pull/6374) ([dimarub2000](https://github.com/dimarub2000))
* Проверьте настройку `max_expanded_ast_elements` для мутаций. Очищайте мутации после `TRUNCATE TABLE`. [#6205](https://github.com/ClickHouse/ClickHouse/pull/6205) ([Winter Zhang](https://github.com/zhang2014))
* Исправлены результаты JOIN для ключевых столбцов при использовании `join_use_nulls`: вместо значений по умолчанию для столбцов теперь подставляются значения Null. [#6249](https://github.com/ClickHouse/ClickHouse/pull/6249) ([Artem Zuikov](https://github.com/4ertus2))
* Исправление skip-индексов при вертикальных слияниях и операциях ALTER. Исправление исключения `Bad size of marks file`. [#6594](https://github.com/ClickHouse/ClickHouse/issues/6594) [#6713](https://github.com/ClickHouse/ClickHouse/pull/6713) ([alesapin](https://github.com/alesapin))
* Исправлен редкий сбой в `ALTER MODIFY COLUMN` и вертикальном слиянии, когда одна из сливаемых/изменяемых частей пуста (0 строк) [#6746](https://github.com/ClickHouse/ClickHouse/issues/6746) [#6780](https://github.com/ClickHouse/ClickHouse/pull/6780) ([alesapin](https://github.com/alesapin))
* Исправлена ошибка в преобразовании типов `LowCardinality` в `AggregateFunctionFactory`. Исправляет [#6257](https://github.com/ClickHouse/ClickHouse/issues/6257). [#6281](https://github.com/ClickHouse/ClickHouse/pull/6281) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Исправлено некорректное поведение и возможные сбои (segfault) в агрегатных функциях `topK` и `topKWeighted`. [#6404](https://github.com/ClickHouse/ClickHouse/pull/6404) ([Anton Popov](https://github.com/CurtizJ))
* Исправлен небезопасный код, связанный с функцией `getIdentifier`. [#6401](https://github.com/ClickHouse/ClickHouse/issues/6401) [#6409](https://github.com/ClickHouse/ClickHouse/pull/6409) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена ошибка в протоколе MySQL wire (используется при подключении к ClickHouse из клиента MySQL). Ошибка была вызвана переполнением буфера кучи (`heap buffer overflow`) в `PacketPayloadWriteBuffer`. [#6212](https://github.com/ClickHouse/ClickHouse/pull/6212) ([Yuriy Baranov](https://github.com/yurriy))
* Исправлена утечка памяти в функции `bitmapSubsetInRange`. [#6819](https://github.com/ClickHouse/ClickHouse/pull/6819) ([Zhichang Yu](https://github.com/yuzhichang))
* Исправлена редкая ошибка, возникавшая при выполнении мутации после изменения размера гранул. [#6816](https://github.com/ClickHouse/ClickHouse/pull/6816) ([alesapin](https://github.com/alesapin))
* Разрешить protobuf-сообщения со всеми полями по умолчанию. [#6132](https://github.com/ClickHouse/ClickHouse/pull/6132) ([Vitaly Baranov](https://github.com/vitlibar))
* Исправлена ошибка в функции `nullIf`, возникавшая при передаче значения `NULL` во второй аргумент. [#6446](https://github.com/ClickHouse/ClickHouse/pull/6446) ([Guillaume Tassery](https://github.com/YiuRULE))
* Исправлена редкая ошибка некорректного выделения/освобождения памяти в кэш-словарях с составным ключом и строковыми полями, которая приводила к неограниченному потреблению памяти (выглядело как утечка памяти). Ошибка воспроизводилась, когда длина строки была степенью двойки, начиная с восьми (8, 16, 32 и т. д.). [#6447](https://github.com/ClickHouse/ClickHouse/pull/6447) ([alesapin](https://github.com/alesapin))
* Исправлено кодирование Gorilla для коротких последовательностей, из‑за которых возникало исключение `Cannot write after end of buffer`. [#6398](https://github.com/ClickHouse/ClickHouse/issues/6398) [#6444](https://github.com/ClickHouse/ClickHouse/pull/6444) ([Vasily Nemkov](https://github.com/Enmk))
* Разрешено использовать не nullable-типы в `JOIN` при включённом `join_use_nulls`. [#6705](https://github.com/ClickHouse/ClickHouse/pull/6705) ([Artem Zuikov](https://github.com/4ertus2))
* Отключить подстановки `Poco::AbstractConfiguration` в запросах в `clickhouse-client`. [#6706](https://github.com/ClickHouse/ClickHouse/pull/6706) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Предотвращена взаимоблокировка в `REPLACE PARTITION`. [#6677](https://github.com/ClickHouse/ClickHouse/pull/6677) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Использование `arrayReduce` с константными аргументами может приводить к ошибке сегментации (segfault). [#6242](https://github.com/ClickHouse/ClickHouse/issues/6242) [#6326](https://github.com/ClickHouse/ClickHouse/pull/6326) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлены неконсистентные партиции, которые могли появляться, если реплика была восстановлена после `DROP PARTITION`. [#6522](https://github.com/ClickHouse/ClickHouse/issues/6522) [#6523](https://github.com/ClickHouse/ClickHouse/pull/6523) ([tavplubix](https://github.com/tavplubix))
* Исправлено зависание в функции `JSONExtractRaw`. [#6195](https://github.com/ClickHouse/ClickHouse/issues/6195) [#6198](https://github.com/ClickHouse/ClickHouse/pull/6198) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена ошибка некорректной сериализации skip-индексов и агрегации с адаптивной гранулярностью. [#6594](https://github.com/ClickHouse/ClickHouse/issues/6594). [#6748](https://github.com/ClickHouse/ClickHouse/pull/6748) ([alesapin](https://github.com/alesapin))
* Исправлены модификаторы `WITH ROLLUP` и `WITH CUBE` оператора `GROUP BY` при двухуровневой агрегации. [#6225](https://github.com/ClickHouse/ClickHouse/pull/6225) ([Anton Popov](https://github.com/CurtizJ))
* Исправлена ошибка записи меток вторичных индексов с адаптивной гранулярностью. [#6126](https://github.com/ClickHouse/ClickHouse/pull/6126) ([alesapin](https://github.com/alesapin))
* Исправлен порядок инициализации при запуске сервера. Поскольку `StorageMergeTree::background_task_handle` инициализируется в `startup()`, `MergeTreeBlockOutputStream::write()` мог попытаться использовать его до инициализации. Добавлена проверка на инициализацию. [#6080](https://github.com/ClickHouse/ClickHouse/pull/6080) ([Ivan](https://github.com/abyss7))
* Очистка буфера данных после предыдущей операции чтения, завершившейся ошибкой. [#6026](https://github.com/ClickHouse/ClickHouse/pull/6026) ([Nikolay](https://github.com/bopohaa))
* Исправлена ошибка, связанная с включением адаптивной гранулярности при создании новой реплики таблицы Replicated*MergeTree. [#6394](https://github.com/ClickHouse/ClickHouse/issues/6394) [#6452](https://github.com/ClickHouse/ClickHouse/pull/6452) ([alesapin](https://github.com/alesapin))
* Исправлена возможная аварийная остановка во время запуска сервера в случае возникновения исключения в `libunwind` при обработке исключения, возникшего при доступе к неинициализированной структуре `ThreadStatus`. [#6456](https://github.com/ClickHouse/ClickHouse/pull/6456) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
* Исправлен сбой в функции `yandexConsistentHash`. Обнаружено фаззинг-тестом. [#6304](https://github.com/ClickHouse/ClickHouse/issues/6304) [#6305](https://github.com/ClickHouse/ClickHouse/pull/6305) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена проблема с зависанием запросов при перегрузке сервера и почти полном заполнении глобального пула потоков. Это с большей вероятностью может происходить в кластерах с большим числом шардов (сотни), поскольку распределённые запросы выделяют по одному потоку на соединение с каждым шардом. Например, эта проблема может проявляться, если кластер из 330 шардов обрабатывает 30 параллельных распределённых запросов. Эта проблема затрагивает все версии, начиная с 19.2. [#6301](https://github.com/ClickHouse/ClickHouse/pull/6301) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена логика функции `arrayEnumerateUniqRanked`. [#6423](https://github.com/ClickHouse/ClickHouse/pull/6423) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена ошибка сегментации при декодировании таблицы символов. [#6603](https://github.com/ClickHouse/ClickHouse/pull/6603) ([Amos Bird](https://github.com/amosbird))
* Исправлено некорректное исключение при приведении `LowCardinality(Nullable)` к не-Nullable столбцу в случае, когда он не содержит значений Null (например, в запросе `SELECT CAST(CAST('Hello' AS LowCardinality(Nullable(String))) AS String)`. [#6094](https://github.com/ClickHouse/ClickHouse/issues/6094) [#6119](https://github.com/ClickHouse/ClickHouse/pull/6119) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Удалено избыточное экранирование описания в таблице `system.settings`. [#6696](https://github.com/ClickHouse/ClickHouse/issues/6696) [#6699](https://github.com/ClickHouse/ClickHouse/pull/6699) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Избежано возможное взаимоблокирование при выполнении `TRUNCATE` реплицированной таблицы. [#6695](https://github.com/ClickHouse/ClickHouse/pull/6695) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлено чтение в порядке ключа сортировки. [#6189](https://github.com/ClickHouse/ClickHouse/pull/6189) ([Anton Popov](https://github.com/CurtizJ))
* Исправлена работа запроса `ALTER TABLE ... UPDATE` для таблиц с `enable_mixed_granularity_parts=1`. [#6543](https://github.com/ClickHouse/ClickHouse/pull/6543) ([alesapin](https://github.com/alesapin))
* Исправлена ошибка из [#4405](https://github.com/ClickHouse/ClickHouse/pull/4405) (начиная с 19.4.0). Воспроизводится в запросах к таблицам `Distributed` поверх таблиц `MergeTree`, когда не запрашиваются какие-либо столбцы (`SELECT 1`). [#6236](https://github.com/ClickHouse/ClickHouse/pull/6236) ([alesapin](https://github.com/alesapin))
* Исправлено переполнение при целочисленном делении значения знакового типа на значение беззнакового типа. Поведение было точно таким же, как в языках C и C++ (правила целочисленного продвижения типов), что может быть неожиданным. Обратите внимание, что переполнение по-прежнему возможно при делении большого знакового числа на большое беззнаковое число или наоборот (но этот случай менее типичен). Проблема существовала во всех версиях сервера. [#6214](https://github.com/ClickHouse/ClickHouse/issues/6214) [#6233](https://github.com/ClickHouse/ClickHouse/pull/6233) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Ограничено максимальное время ожидания при `throttling`, когда установлены `max_execution_speed` или `max_execution_speed_bytes`. Исправлены ложные ошибки вида `Estimated query execution time (inf seconds) is too long`. [#5547](https://github.com/ClickHouse/ClickHouse/issues/5547) [#6232](https://github.com/ClickHouse/ClickHouse/pull/6232) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлены проблемы, связанные с использованием столбцов `MATERIALIZED` и псевдонимов в `MaterializedView`. [#448](https://github.com/ClickHouse/ClickHouse/issues/448) [#3484](https://github.com/ClickHouse/ClickHouse/issues/3484) [#3450](https://github.com/ClickHouse/ClickHouse/issues/3450) [#2878](https://github.com/ClickHouse/ClickHouse/issues/2878) [#2285](https://github.com/ClickHouse/ClickHouse/issues/2285) [#3796](https://github.com/ClickHouse/ClickHouse/pull/3796) ([Amos Bird](https://github.com/amosbird)) [#6316](https://github.com/ClickHouse/ClickHouse/pull/6316) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлено поведение `FormatFactory` для входных потоков, которые не реализованы как процессоры. [#6495](https://github.com/ClickHouse/ClickHouse/pull/6495) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Исправлена опечатка. [#6631](https://github.com/ClickHouse/ClickHouse/pull/6631) ([Alex Ryndin](https://github.com/alexryndin))
* Опечатка в сообщении об ошибке (is → are). [#6839](https://github.com/ClickHouse/ClickHouse/pull/6839) ([Denis Zhuravlev](https://github.com/den-crane))
* Исправлена ошибка при разборе списка столбцов из строки, если тип содержал запятую (эта проблема была актуальна для хранилищ `File`, `URL`, `HDFS`) [#6217](https://github.com/ClickHouse/ClickHouse/issues/6217). [#6209](https://github.com/ClickHouse/ClickHouse/pull/6209) ([dimarub2000](https://github.com/dimarub2000))

#### Исправления безопасности {#security-fix}

- Этот релиз также содержит все исправления уязвимостей безопасности из версий 19.13 и 19.11.
- Исправлена возможность вызвать сбой сервера с помощью специально сформированного запроса из-за переполнения стека в SQL-парсере. Исправлена возможность переполнения стека в таблицах Merge и Distributed, материализованных представлениях и условиях row-level security, использующих подзапросы. [#6433](https://github.com/ClickHouse/ClickHouse/pull/6433) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### Улучшения {#improvement-3}


* Корректная реализация трёхзначной логики для `AND/OR`. [#6048](https://github.com/ClickHouse/ClickHouse/pull/6048) ([Alexander Kazakov](https://github.com/Akazz))
* Теперь значения и строки с истёкшим TTL будут удаляться после запроса `OPTIMIZE ... FINAL` из старых кусков без информации о TTL или с устаревшей информацией о TTL, например после запроса `ALTER ... MODIFY TTL`. Добавлены запросы `SYSTEM STOP/START TTL MERGES` для запрета/разрешения назначения слияний с TTL и фильтрации значений с истёкшим сроком действия во всех слияниях. [#6274](https://github.com/ClickHouse/ClickHouse/pull/6274) ([Anton Popov](https://github.com/CurtizJ))
* Возможность изменить расположение файла истории клиента ClickHouse с помощью переменной окружения `CLICKHOUSE_HISTORY_FILE`. [#6840](https://github.com/ClickHouse/ClickHouse/pull/6840) ([filimonov](https://github.com/filimonov))
* Удалён флаг `dry_run` из `InterpreterSelectQuery`. ... [#6375](https://github.com/ClickHouse/ClickHouse/pull/6375) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Поддержка `ASOF JOIN` с использованием секции `ON`. [#6211](https://github.com/ClickHouse/ClickHouse/pull/6211) ([Artem Zuikov](https://github.com/4ertus2))
* Улучшена поддержка skip-индексов для мутаций и репликации. Добавлена поддержка запроса `MATERIALIZE/CLEAR INDEX ... IN PARTITION`. `UPDATE x = x` пересчитывает все индексы, которые используют столбец `x`. [#5053](https://github.com/ClickHouse/ClickHouse/pull/5053) ([Nikita Vasilev](https://github.com/nikvas0))
* Разрешить `ATTACH` live views (например, при запуске сервера) независимо от настройки `allow_experimental_live_view`. [#6754](https://github.com/ClickHouse/ClickHouse/pull/6754) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Для трассировок стека, собранных профилировщиком запросов, не включать кадры стека, порождённые самим профилировщиком запросов. [#6250](https://github.com/ClickHouse/ClickHouse/pull/6250) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Теперь табличные функции `values`, `file`, `url`, `hdfs` поддерживают столбцы типа ALIAS. [#6255](https://github.com/ClickHouse/ClickHouse/pull/6255) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Генерировать исключение, если файл `config.d` не содержит того же корневого элемента, что и основной конфигурационный файл. [#6123](https://github.com/ClickHouse/ClickHouse/pull/6123) ([dimarub2000](https://github.com/dimarub2000))
* Выводить дополнительную информацию в сообщении об исключении для ошибки `no space left on device`. [#6182](https://github.com/ClickHouse/ClickHouse/issues/6182), [#6252](https://github.com/ClickHouse/ClickHouse/issues/6252) [#6352](https://github.com/ClickHouse/ClickHouse/pull/6352) ([tavplubix](https://github.com/tavplubix))
* При определении шардов таблицы `Distributed`, которые должны быть задействованы запросом на чтение (при `optimize_skip_unused_shards` = 1), ClickHouse теперь учитывает условия как из секции `prewhere`, так и из секции `where` оператора SELECT. [#6521](https://github.com/ClickHouse/ClickHouse/pull/6521) ([Alexander Kazakov](https://github.com/Akazz))
* Включена поддержка `SIMDJSON` для машин без AVX2, но с набором инструкций SSE 4.2 и PCLMUL. [#6285](https://github.com/ClickHouse/ClickHouse/issues/6285) [#6320](https://github.com/ClickHouse/ClickHouse/pull/6320) ([alexey-milovidov](https://github.com/alexey-milovidov))
* ClickHouse может работать с файловыми системами без поддержки `O_DIRECT` (таких как ZFS и BtrFS) без дополнительной настройки. [#4449](https://github.com/ClickHouse/ClickHouse/issues/4449) [#6730](https://github.com/ClickHouse/ClickHouse/pull/6730) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Добавлена поддержка проталкивания предикатов для подзапроса с `FINAL`. [#6120](https://github.com/ClickHouse/ClickHouse/pull/6120) ([TCeason](https://github.com/TCeason)) [#6162](https://github.com/ClickHouse/ClickHouse/pull/6162) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Более эффективное извлечение ключей `JOIN ON` [#6131](https://github.com/ClickHouse/ClickHouse/pull/6131) ([Artem Zuikov](https://github.com/4ertus2))
* Обновлён `SIMDJSON`. [#6285](https://github.com/ClickHouse/ClickHouse/issues/6285). [#6306](https://github.com/ClickHouse/ClickHouse/pull/6306) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Оптимизирован выбор самого маленького столбца для запроса `SELECT count()`. [#6344](https://github.com/ClickHouse/ClickHouse/pull/6344) ([Amos Bird](https://github.com/amosbird))
* Добавлен параметр `strict` в `windowFunnel()`. При установленном `strict` функция `windowFunnel()` применяет условия только к уникальным значениям. [#6548](https://github.com/ClickHouse/ClickHouse/pull/6548) ([achimbab](https://github.com/achimbab))
* Более безопасный интерфейс для `mysqlxx::Pool`. [#6150](https://github.com/ClickHouse/ClickHouse/pull/6150) ([avasiliev](https://github.com/avasiliev))
* Длина строки параметров при выполнении с опцией `--help` теперь соответствует размеру терминала. [#6590](https://github.com/ClickHouse/ClickHouse/pull/6590) ([dimarub2000](https://github.com/dimarub2000))
* Отключена оптимизация «read in order» для агрегации без ключей. [#6599](https://github.com/ClickHouse/ClickHouse/pull/6599) ([Anton Popov](https://github.com/CurtizJ))
* HTTP статус-код для ошибок `INCORRECT_DATA` и `TYPE_MISMATCH` был изменён с значения по умолчанию `500 Internal Server Error` на `400 Bad Request`. [#6271](https://github.com/ClickHouse/ClickHouse/pull/6271) ([Alexander Rodin](https://github.com/a-rodin))
* Объект Join перенесён из `ExpressionAction` в `AnalyzedJoin`. `ExpressionAnalyzer` и `ExpressionAction` больше не знают о классе `Join`, его логика скрыта за интерфейсом `AnalyzedJoin`. [#6801](https://github.com/ClickHouse/ClickHouse/pull/6801) ([Artem Zuikov](https://github.com/4ertus2))
* Исправлена потенциальная взаимоблокировка распределённых запросов, возникающая, когда один из шардов — `localhost`, но запрос отправлен по сетевому соединению. [#6759](https://github.com/ClickHouse/ClickHouse/pull/6759) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Изменена семантика `RENAME` для нескольких таблиц, чтобы избежать возможных дедлоков. [#6757](https://github.com/ClickHouse/ClickHouse/issues/6757). [#6756](https://github.com/ClickHouse/ClickHouse/pull/6756) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Переписан сервер совместимости с MySQL, чтобы не загружать в память весь полезный нагрузочный пакет целиком. Потребление памяти на каждое соединение снижено до примерно `2 * DBMS_DEFAULT_BUFFER_SIZE` (буферы чтения и записи). [#5811](https://github.com/ClickHouse/ClickHouse/pull/5811) ([Yuriy Baranov](https://github.com/yurriy))
* Логика интерпретации псевдонимов AST вынесена из парсера, которому не нужно ничего знать о семантике запроса. [#6108](https://github.com/ClickHouse/ClickHouse/pull/6108) ([Artem Zuikov](https://github.com/4ertus2))
* Более безопасный разбор `NamesAndTypesList`. [#6408](https://github.com/ClickHouse/ClickHouse/issues/6408). [#6410](https://github.com/ClickHouse/ClickHouse/pull/6410) ([alexey-milovidov](https://github.com/alexey-milovidov))
* `clickhouse-copier`: Разрешено использовать `where_condition` из конфигурации с псевдонимом `partition_key` в запросе для проверки существования партиции (ранее он использовался только в запросах на чтение данных). [#6577](https://github.com/ClickHouse/ClickHouse/pull/6577) ([proller](https://github.com/proller))
* В функцию `throwIf` добавлен необязательный аргумент для сообщения. ([#5772](https://github.com/ClickHouse/ClickHouse/issues/5772)) [#6329](https://github.com/ClickHouse/ClickHouse/pull/6329) ([Vdimir](https://github.com/Vdimir))
* Исключение сервера, возникшее при отправке данных для вставки, теперь обрабатывается и на клиенте. [#5891](https://github.com/ClickHouse/ClickHouse/issues/5891) [#6711](https://github.com/ClickHouse/ClickHouse/pull/6711) ([dimarub2000](https://github.com/dimarub2000))
* Добавлена метрика `DistributedFilesToInsert`, которая показывает общее количество файлов в файловой системе, выбранных для отправки на удалённые серверы таблицами типа Distributed. Число суммируется по всем шардам. [#6600](https://github.com/ClickHouse/ClickHouse/pull/6600) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Большая часть логики подготовки JOIN перенесена из `ExpressionAction/ExpressionAnalyzer` в `AnalyzedJoin`. [#6785](https://github.com/ClickHouse/ClickHouse/pull/6785) ([Artem Zuikov](https://github.com/4ertus2))
* Исправлено предупреждение TSan [&#39;lock-order-inversion&#39;](https://clickhouse-test-reports.s3.yandex.net/6399/c1c1d1daa98e199e620766f1bd06a5921050a00d/functional_stateful_tests_\(thread\).html). [#6740](https://github.com/ClickHouse/ClickHouse/pull/6740) ([Vasily Nemkov](https://github.com/Enmk))
* Улучшены информационные сообщения об отсутствии Linux capabilities. Фатальные ошибки записываются с уровнем «fatal», что упрощает их поиск в `system.text_log`. [#6441](https://github.com/ClickHouse/ClickHouse/pull/6441) ([alexey-milovidov](https://github.com/alexey-milovidov))
* При включении сброса временных данных на диск для ограничения использования памяти во время `GROUP BY`, `ORDER BY` не проверялось наличие свободного места на диске. Исправление добавляет новый параметр `min_free_disk_space`, и если свободное место на диске меньше указанного порога, выполнение запроса будет прервано с ошибкой `ErrorCodes::NOT_ENOUGH_SPACE`. [#6678](https://github.com/ClickHouse/ClickHouse/pull/6678) ([Weiqing Xu](https://github.com/weiqxu)) [#6691](https://github.com/ClickHouse/ClickHouse/pull/6691) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Удалён рекурсивный `rwlock` по потоку. В этом нет смысла, потому что потоки переиспользуются между запросами. Запрос `SELECT` может захватить блокировку в одном потоке, удерживать блокировку, полученную из другого потока, и завершиться в первом потоке. В это же время первый поток может быть переиспользован запросом `DROP`. Это приведёт к ложным сообщениям «Attempt to acquire exclusive lock recursively». [#6771](https://github.com/ClickHouse/ClickHouse/pull/6771) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Разделена функция `ExpressionAnalyzer.appendJoin()`. Подготовлено место в `ExpressionAnalyzer` для `MergeJoin`. [#6524](https://github.com/ClickHouse/ClickHouse/pull/6524) ([Artem Zuikov](https://github.com/4ertus2))
* Добавлен плагин аутентификации `mysql_native_password` в сервер совместимости с MySQL. [#6194](https://github.com/ClickHouse/ClickHouse/pull/6194) ([Yuriy Baranov](https://github.com/yurriy))
* Снижено количество вызовов `clock_gettime`; исправлена ABI-совместимость между debug/release в `Allocator` (незначительная проблема). [#6197](https://github.com/ClickHouse/ClickHouse/pull/6197) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Перемещена функция `collectUsedColumns` из `ExpressionAnalyzer` в `SyntaxAnalyzer`. Теперь `SyntaxAnalyzer` самостоятельно формирует `required_source_columns`. [#6416](https://github.com/ClickHouse/ClickHouse/pull/6416) ([Artem Zuikov](https://github.com/4ertus2))
* Добавлена настройка `joined_subquery_requires_alias`, которая требует указывать псевдонимы для подзапросов и табличных функций в секции `FROM`, когда в запросе участвует более одной таблицы (т.е. для запросов с JOIN). [#6733](https://github.com/ClickHouse/ClickHouse/pull/6733) ([Artem Zuikov](https://github.com/4ertus2))
* Выделен класс `GetAggregatesVisitor` из `ExpressionAnalyzer`. [#6458](https://github.com/ClickHouse/ClickHouse/pull/6458) ([Artem Zuikov](https://github.com/4ertus2))
* `system.query_log`: изменить тип данных столбца `type` на `Enum`. [#6265](https://github.com/ClickHouse/ClickHouse/pull/6265) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
* Статическая компоновка плагина аутентификации `sha256_password`. [#6512](https://github.com/ClickHouse/ClickHouse/pull/6512) ([Yuriy Baranov](https://github.com/yurriy))
* Устранена лишняя зависимость, требуемая для работы настройки `compile`. В предыдущих версиях пользователь мог получать ошибки вида `cannot open crti.o`, `unable to find library -lc` и т. д. [#6309](https://github.com/ClickHouse/ClickHouse/pull/6309) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Усилена проверка входных данных, которые могут поступать от вредоносной реплики. [#6303](https://github.com/ClickHouse/ClickHouse/pull/6303) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Теперь файл `clickhouse-obfuscator` входит в пакет `clickhouse-client`. В предыдущих версиях он поставлялся как `clickhouse obfuscator` (с пробелом). [#5816](https://github.com/ClickHouse/ClickHouse/issues/5816) [#6609](https://github.com/ClickHouse/ClickHouse/pull/6609) ([dimarub2000](https://github.com/dimarub2000))
* Исправлена взаимная блокировка, возникающая при наличии как минимум двух запросов, читающих как минимум две таблицы в разном порядке, и ещё одного запроса, выполняющего DDL-операцию над одной из этих таблиц. Исправлена ещё одна крайне редкая взаимная блокировка. [#6764](https://github.com/ClickHouse/ClickHouse/pull/6764) ([alexey-milovidov](https://github.com/alexey-milovidov))
* В таблицы `system.processes` и `system.query_log` добавлен столбец `os_thread_ids` для расширения возможностей отладки. [#6763](https://github.com/ClickHouse/ClickHouse/pull/6763) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Временное решение для ошибок расширения PHP mysqlnd, которые возникают, когда `sha256_password` используется в качестве плагина аутентификации по умолчанию (описано в [#6031](https://github.com/ClickHouse/ClickHouse/issues/6031)). [#6113](https://github.com/ClickHouse/ClickHouse/pull/6113) ([Yuriy Baranov](https://github.com/yurriy))
* Удалён ненужный участок кода с изменённой нуллируемостью столбцов. [#6693](https://github.com/ClickHouse/ClickHouse/pull/6693) ([Artem Zuikov](https://github.com/4ertus2))
* Значение по умолчанию для `queue_max_wait_ms` установлено в ноль, поскольку текущее значение (пять секунд) не имеет смысла. Есть редкие случаи, когда этот параметр вообще может быть полезен. Добавлены настройки `replace_running_query_max_wait_ms`, `kafka_max_wait_ms` и `connection_pool_max_wait_ms` для устранения неоднозначности. [#6692](https://github.com/ClickHouse/ClickHouse/pull/6692) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Выделить `SelectQueryExpressionAnalyzer` из `ExpressionAnalyzer`. Оставить последний для запросов, отличных от `SELECT`. [#6499](https://github.com/ClickHouse/ClickHouse/pull/6499) ([Artem Zuikov](https://github.com/4ertus2))
* Удалены дублирующиеся форматы ввода и вывода. [#6239](https://github.com/ClickHouse/ClickHouse/pull/6239) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Разрешить пользователю переопределять параметры `poll_interval` и `idle_connection_timeout` при установлении соединения. [#6230](https://github.com/ClickHouse/ClickHouse/pull/6230) ([alexey-milovidov](https://github.com/alexey-milovidov))
* У `MergeTree` появился дополнительный параметр `ttl_only_drop_parts` (по умолчанию отключён), который позволяет избежать частичного удаления партиций и полностью удалять их только тогда, когда все строки в партиции истекли по TTL. [#6191](https://github.com/ClickHouse/ClickHouse/pull/6191) ([Sergi Vladykin](https://github.com/svladykin))
* Проверка типов для функций set-индексов. Выбрасывать исключение, если функция получает тип аргумента, отличный от ожидаемого. Это исправляет fuzz-тест с UBSan. [#6511](https://github.com/ClickHouse/ClickHouse/pull/6511) ([Nikita Vasilev](https://github.com/nikvas0))

#### Улучшение производительности {#performance-improvement-2}

- Оптимизация запросов с конструкцией `ORDER BY expressions`, где `expressions` имеют совпадающий префикс с ключом сортировки в таблицах `MergeTree`. Эта оптимизация управляется настройкой `optimize_read_in_order`. [#6054](https://github.com/ClickHouse/ClickHouse/pull/6054) [#6629](https://github.com/ClickHouse/ClickHouse/pull/6629) ([Anton Popov](https://github.com/CurtizJ))
- Возможность использования нескольких потоков при загрузке и удалении кусков данных. [#6372](https://github.com/ClickHouse/ClickHouse/issues/6372) [#6074](https://github.com/ClickHouse/ClickHouse/issues/6074) [#6438](https://github.com/ClickHouse/ClickHouse/pull/6438) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Реализован пакетный вариант обновления состояний агрегатных функций. Это может привести к повышению производительности. [#6435](https://github.com/ClickHouse/ClickHouse/pull/6435) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Использование библиотеки `FastOps` для функций `exp`, `log`, `sigmoid`, `tanh`. FastOps — это быстрая библиотека векторной математики от Михаила Парахина (технический директор Яндекса). Производительность функций `exp` и `log` улучшена более чем в 6 раз. Функции `exp` и `log` с аргументом типа `Float32` теперь возвращают `Float32` (в предыдущих версиях они всегда возвращали `Float64`). Теперь `exp(nan)` может возвращать `inf`. Результат функций `exp` и `log` может не быть ближайшим машинно-представимым числом к истинному значению. [#6254](https://github.com/ClickHouse/ClickHouse/pull/6254) ([alexey-milovidov](https://github.com/alexey-milovidov)) Использование варианта Данилы Кутенина для обеспечения работы fastops [#6317](https://github.com/ClickHouse/ClickHouse/pull/6317) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Отключение оптимизации последовательных ключей для `UInt8/16`. [#6298](https://github.com/ClickHouse/ClickHouse/pull/6298) [#6701](https://github.com/ClickHouse/ClickHouse/pull/6701) ([akuzm](https://github.com/akuzm))
- Улучшена производительность библиотеки `simdjson` за счёт устранения динамического выделения памяти в `ParsedJson::Iterator`. [#6479](https://github.com/ClickHouse/ClickHouse/pull/6479) ([Vitaly Baranov](https://github.com/vitlibar))
- Предварительная подкачка страниц при выделении памяти с помощью `mmap()`. [#6667](https://github.com/ClickHouse/ClickHouse/pull/6667) ([akuzm](https://github.com/akuzm))
- Исправлена ошибка производительности при сравнении типов `Decimal`. [#6380](https://github.com/ClickHouse/ClickHouse/pull/6380) ([Artem Zuikov](https://github.com/4ertus2))

#### Улучшение сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-4}


* Удалён Compiler (runtime template instantiation), так как мы превзошли его по производительности. [#6646](https://github.com/ClickHouse/ClickHouse/pull/6646) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Добавлен тест производительности, который более изолированно показывает деградацию производительности в gcc-9. [#6302](https://github.com/ClickHouse/ClickHouse/pull/6302) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Добавлена табличная функция `numbers_mt` — многопоточная версия `numbers`. Обновлены тесты производительности с использованием хеш-функций. [#6554](https://github.com/ClickHouse/ClickHouse/pull/6554) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Режим сравнения в `clickhouse-benchmark` [#6220](https://github.com/ClickHouse/ClickHouse/issues/6220) [#6343](https://github.com/ClickHouse/ClickHouse/pull/6343) ([dimarub2000](https://github.com/dimarub2000))
* Лучшее приближение к корректному выводу трассировок стека. Также добавлен `SIGPROF` как отладочный сигнал для вывода стека выполняющегося потока. [#6529](https://github.com/ClickHouse/ClickHouse/pull/6529) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Каждая функция в отдельном файле, часть 10. [#6321](https://github.com/ClickHouse/ClickHouse/pull/6321) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Удалён дублирующийся константный флаг `TABLE_IS_READ_ONLY`. [#6566](https://github.com/ClickHouse/ClickHouse/pull/6566) ([filimonov](https://github.com/filimonov))
* Изменение форматирования для `StringHashMap` в PR [#5417](https://github.com/ClickHouse/ClickHouse/issues/5417). [#6700](https://github.com/ClickHouse/ClickHouse/pull/6700) ([akuzm](https://github.com/akuzm))
* Улучшен подзапрос для создания соединений `JOIN` в `ExpressionAnalyzer`. [#6824](https://github.com/ClickHouse/ClickHouse/pull/6824) ([Artem Zuikov](https://github.com/4ertus2))
* Удалено лишнее условие (обнаружено PVS Studio). [#6775](https://github.com/ClickHouse/ClickHouse/pull/6775) ([akuzm](https://github.com/akuzm))
* Выделен отдельный интерфейс хеш-таблицы для `ReverseIndex`. [#6672](https://github.com/ClickHouse/ClickHouse/pull/6672) ([akuzm](https://github.com/akuzm))
* Рефакторинг параметров настроек. [#6689](https://github.com/ClickHouse/ClickHouse/pull/6689) ([alesapin](https://github.com/alesapin))
* Добавлены комментарии к функциям индекса `set`. [#6319](https://github.com/ClickHouse/ClickHouse/pull/6319) ([Nikita Vasilev](https://github.com/nikvas0))
* Увеличен приоритет завершения по OOM в отладочной версии на Linux. [#6152](https://github.com/ClickHouse/ClickHouse/pull/6152) ([akuzm](https://github.com/akuzm))
* HDFS HA теперь работает в отладочной сборке. [#6650](https://github.com/ClickHouse/ClickHouse/pull/6650) ([Weiqing Xu](https://github.com/weiqxu))
* Добавлен тест в `transform_query_for_external_database`. [#6388](https://github.com/ClickHouse/ClickHouse/pull/6388) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Добавлен тест для нескольких материализованных представлений таблицы Kafka. [#6509](https://github.com/ClickHouse/ClickHouse/pull/6509) ([Ivan](https://github.com/abyss7))
* Улучшена схема сборки. [#6500](https://github.com/ClickHouse/ClickHouse/pull/6500) ([Ivan](https://github.com/abyss7))
* Исправлена интеграция `test_external_dictionaries` в случае, когда она выполнялась не от пользователя root. [#6507](https://github.com/ClickHouse/ClickHouse/pull/6507) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Ошибка воспроизводится, когда общий размер записываемых пакетов превышает `DBMS_DEFAULT_BUFFER_SIZE`. [#6204](https://github.com/ClickHouse/ClickHouse/pull/6204) ([Yuriy Baranov](https://github.com/yurriy))
* Добавлен тест на состояние гонки при `RENAME` таблицы [#6752](https://github.com/ClickHouse/ClickHouse/pull/6752) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Устранена гонка данных при работе с Settings в `KILL QUERY`. [#6753](https://github.com/ClickHouse/ClickHouse/pull/6753) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Добавлен интеграционный тест обработки ошибок в кэш-словаре. [#6755](https://github.com/ClickHouse/ClickHouse/pull/6755) ([Vitaly Baranov](https://github.com/vitlibar))
* Отключён разбор ELF-объектных файлов в Mac OS, так как это не имеет смысла. [#6578](https://github.com/ClickHouse/ClickHouse/pull/6578) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Попытка улучшить генератор списка изменений. [#6327](https://github.com/ClickHouse/ClickHouse/pull/6327) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Добавлен флаг `-Wshadow` для GCC. [#6325](https://github.com/ClickHouse/ClickHouse/pull/6325) ([kreuzerkrieg](https://github.com/kreuzerkrieg))
* Удалён устаревший код для поддержки `mimalloc`. [#6715](https://github.com/ClickHouse/ClickHouse/pull/6715) ([alexey-milovidov](https://github.com/alexey-milovidov))
* `zlib-ng` определяет возможности x86 и сохраняет эту информацию в глобальные переменные. Это выполняется при вызове deflateInit, который может выполняться разными потоками одновременно. Чтобы избежать одновременной записи из нескольких потоков, выполняйте это при инициализации библиотеки. [#6141](https://github.com/ClickHouse/ClickHouse/pull/6141) ([akuzm](https://github.com/akuzm))
* Регрессионный тест для бага в `JOIN`, который был исправлен в [#5192](https://github.com/ClickHouse/ClickHouse/issues/5192). [#6147](https://github.com/ClickHouse/ClickHouse/pull/6147) ([Bakhtiyor Ruziev](https://github.com/theruziev))
* Исправлен отчёт MSan. [#6144](https://github.com/ClickHouse/ClickHouse/pull/6144) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлен «флапающий» тест TTL. [#6782](https://github.com/ClickHouse/ClickHouse/pull/6782) ([Anton Popov](https://github.com/CurtizJ))
* Исправлена ложноположительная гонка данных в поле `MergeTreeDataPart::is_frozen`. [#6583](https://github.com/ClickHouse/ClickHouse/pull/6583) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлены тайм-ауты во fuzz-тесте. В предыдущей версии он находил ложное зависание в запросе `SELECT * FROM numbers_mt(gccMurmurHash(''))`. [#6582](https://github.com/ClickHouse/ClickHouse/pull/6582) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Добавлены отладочные проверки для `static_cast` столбцов. [#6581](https://github.com/ClickHouse/ClickHouse/pull/6581) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Поддержка Oracle Linux в официальных RPM-пакетах. [#6356](https://github.com/ClickHouse/ClickHouse/issues/6356) [#6585](https://github.com/ClickHouse/ClickHouse/pull/6585) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Изменен тип json perftests с `once` на `loop`. [#6536](https://github.com/ClickHouse/ClickHouse/pull/6536) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* `odbc-bridge.cpp` определяет `main()`, поэтому он не должен входить в состав `clickhouse-lib`. [#6538](https://github.com/ClickHouse/ClickHouse/pull/6538) ([Orivej Desh](https://github.com/orivej))
* Тест на падение в `FULL|RIGHT JOIN` при `NULL` в ключах правой таблицы. [#6362](https://github.com/ClickHouse/ClickHouse/pull/6362) ([Artem Zuikov](https://github.com/4ertus2))
* Добавлен тест на ограничение развёртывания алиасов на всякий случай. [#6442](https://github.com/ClickHouse/ClickHouse/pull/6442) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Перешли с `boost::filesystem` на `std::filesystem` там, где это было уместно. [#6253](https://github.com/ClickHouse/ClickHouse/pull/6253) [#6385](https://github.com/ClickHouse/ClickHouse/pull/6385) ([alexey-milovidov](https://github.com/alexey-milovidov))
* На сайт добавлены RPM-пакеты. [#6251](https://github.com/ClickHouse/ClickHouse/pull/6251) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Добавлен тест для исправленной ошибки `Unknown identifier` в секции `IN`. [#6708](https://github.com/ClickHouse/ClickHouse/pull/6708) ([Artem Zuikov](https://github.com/4ertus2))
* Упростили `shared_ptr_helper`, так как пользователи испытывали трудности с его пониманием. [#6675](https://github.com/ClickHouse/ClickHouse/pull/6675) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Добавлены тесты производительности для исправленных кодеков Gorilla и DoubleDelta. [#6179](https://github.com/ClickHouse/ClickHouse/pull/6179) ([Vasily Nemkov](https://github.com/Enmk))
* Интеграционный тест `test_dictionaries` разбит на 4 отдельных теста. [#6776](https://github.com/ClickHouse/ClickHouse/pull/6776) ([Vitaly Baranov](https://github.com/vitlibar))
* Исправлено предупреждение PVS-Studio в `PipelineExecutor`. [#6777](https://github.com/ClickHouse/ClickHouse/pull/6777) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Разрешено использовать источник словаря `library` с ASan. [#6482](https://github.com/ClickHouse/ClickHouse/pull/6482) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Добавлена возможность генерировать журнал изменений из списка PR. [#6350](https://github.com/ClickHouse/ClickHouse/pull/6350) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Блокировать хранилище `TinyLog` на время чтения. [#6226](https://github.com/ClickHouse/ClickHouse/pull/6226) ([akuzm](https://github.com/akuzm))
* Проверка битых символических ссылок в CI. [#6634](https://github.com/ClickHouse/ClickHouse/pull/6634) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Увеличен таймаут для теста «stack overflow», так как в debug-сборке он может выполняться очень долго. [#6637](https://github.com/ClickHouse/ClickHouse/pull/6637) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Добавлена проверка на двойные пробелы. [#6643](https://github.com/ClickHouse/ClickHouse/pull/6643) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлено отслеживание выделения памяти через `new/delete` при сборке с санитайзерами. Логика отслеживания остается неочевидной. Изменение лишь предотвращает исключения по превышению лимита памяти в тестах. [#6450](https://github.com/ClickHouse/ClickHouse/pull/6450) ([Artem Zuikov](https://github.com/4ertus2))
* Повторно включена проверка неопределённых символов при линковке. [#6453](https://github.com/ClickHouse/ClickHouse/pull/6453) ([Ivan](https://github.com/abyss7))
* Не пересобирайте `hyperscan` каждый день. [#6307](https://github.com/ClickHouse/ClickHouse/pull/6307) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлен отчёт UBSan в `ProtobufWriter`. [#6163](https://github.com/ClickHouse/ClickHouse/pull/6163) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Не позволять использовать профилировщик запросов с санитайзерами, так как они несовместимы. [#6769](https://github.com/ClickHouse/ClickHouse/pull/6769) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Добавлен тест для перезагрузки словаря по таймеру после ошибки. [#6114](https://github.com/ClickHouse/ClickHouse/pull/6114) ([Vitaly Baranov](https://github.com/vitlibar))
* Исправлено несоответствие типа аргумента в `PipelineExecutor::prepareProcessor`. [#6494](https://github.com/ClickHouse/ClickHouse/pull/6494) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Добавлен тест для некорректных URI. [#6493](https://github.com/ClickHouse/ClickHouse/pull/6493) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Добавлены дополнительные проверки в функцию `CAST`. Это должно дать больше информации о сбое сегментации в fuzz-тесте. [#6346](https://github.com/ClickHouse/ClickHouse/pull/6346) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Добавлена поддержка `gcc-9` в контейнере `docker/builder`, который локально собирает образ. [#6333](https://github.com/ClickHouse/ClickHouse/pull/6333) ([Gleb Novikov](https://github.com/NanoBjorn))
* Тест первичного ключа с `LowCardinality(String)`. [#5044](https://github.com/ClickHouse/ClickHouse/issues/5044) [#6219](https://github.com/ClickHouse/ClickHouse/pull/6219) ([dimarub2000](https://github.com/dimarub2000))
* Исправлены тесты, на которые влиял медленный вывод стеков вызовов. [#6315](https://github.com/ClickHouse/ClickHouse/pull/6315) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Добавлен тест для сбоя в `groupUniqArray`, исправленного в [#6029](https://github.com/ClickHouse/ClickHouse/pull/6029). [#4402](https://github.com/ClickHouse/ClickHouse/issues/4402) [#6129](https://github.com/ClickHouse/ClickHouse/pull/6129) ([akuzm](https://github.com/akuzm))
* Исправлены тесты мутаций для фиксированных индексов. [#6645](https://github.com/ClickHouse/ClickHouse/pull/6645) ([Nikita Vasilev](https://github.com/nikvas0))
* В тестах производительности не читать журнал запросов для запросов, которые мы не запускали. [#6427](https://github.com/ClickHouse/ClickHouse/pull/6427) ([akuzm](https://github.com/akuzm))
* Материализованное представление теперь можно создавать с любыми типами с низкой кардинальностью, независимо от настройки, связанной с подозрительными типами с низкой кардинальностью. [#6428](https://github.com/ClickHouse/ClickHouse/pull/6428) ([Olga Khvostikova](https://github.com/stavrolia))
* Обновлены тесты для параметра `send_logs_level`. [#6207](https://github.com/ClickHouse/ClickHouse/pull/6207) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Исправлена сборка с gcc-8.2. [#6196](https://github.com/ClickHouse/ClickHouse/pull/6196) ([Max Akhmedов](https://github.com/zlobober))
* Исправлена сборка с внутренней libc++. [#6724](https://github.com/ClickHouse/ClickHouse/pull/6724) ([Ivan](https://github.com/abyss7))
* Исправлена сборка общей библиотеки с `rdkafka` [#6101](https://github.com/ClickHouse/ClickHouse/pull/6101) ([Ivan](https://github.com/abyss7))
* Исправления сборки под Mac OS (неполные). [#6390](https://github.com/ClickHouse/ClickHouse/pull/6390) ([alexey-milovidov](https://github.com/alexey-milovidov)) [#6429](https://github.com/ClickHouse/ClickHouse/pull/6429) ([alex-zaitsev](https://github.com/alex-zaitsev))
* Исправлена «расщеплённая» сборка. [#6618](https://github.com/ClickHouse/ClickHouse/pull/6618) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Другие исправления сборочного процесса: [#6186](https://github.com/ClickHouse/ClickHouse/pull/6186) ([Amos Bird](https://github.com/amosbird)) [#6486](https://github.com/ClickHouse/ClickHouse/pull/6486) [#6348](https://github.com/ClickHouse/ClickHouse/pull/6348) ([vxider](https://github.com/Vxider)) [#6744](https://github.com/ClickHouse/ClickHouse/pull/6744) ([Ivan](https://github.com/abyss7)) [#6016](https://github.com/ClickHouse/ClickHouse/pull/6016) [#6421](https://github.com/ClickHouse/ClickHouse/pull/6421) [#6491](https://github.com/ClickHouse/ClickHouse/pull/6491) ([proller](https://github.com/proller))

#### Обратно несовместимые изменения {#backward-incompatible-change-3}

- Удалены редко используемые табличная функция `catBoostPool` и движок `CatBoostPool`. Если вы использовали эту табличную функцию, напишите на адрес `feedback@clickhouse.com`. Обратите внимание, что интеграция с CatBoost сохраняется и будет поддерживаться. [#6279](https://github.com/ClickHouse/ClickHouse/pull/6279) ([alexey-milovidov](https://github.com/alexey-milovidov))
- По умолчанию отключены `ANY RIGHT JOIN` и `ANY FULL JOIN`. Для их включения установите настройку `any_join_distinct_right_table_keys`. [#5126](https://github.com/ClickHouse/ClickHouse/issues/5126) [#6351](https://github.com/ClickHouse/ClickHouse/pull/6351) ([Artem Zuikov](https://github.com/4ertus2))


## Релиз ClickHouse 19.13 {#clickhouse-release-19-13}

### Релиз ClickHouse 19.13.6.51, 2019-10-02 {#clickhouse-release-19-13-6-51-2019-10-02}

#### Исправление ошибок {#bug-fix-9}

- Этот релиз также содержит все исправления ошибок из версии 19.11.12.69.

### Релиз ClickHouse 19.13.5.44, 2019-09-20 {#clickhouse-release-19-13-5-44-2019-09-20}

#### Исправление ошибок {#bug-fix-10}

- Этот релиз также содержит все исправления ошибок из версии 19.14.6.12.
- Исправлено возможное несогласованное состояние таблицы при выполнении запроса `DROP` для реплицируемой таблицы при недоступности zookeeper. [#6045](https://github.com/ClickHouse/ClickHouse/issues/6045) [#6413](https://github.com/ClickHouse/ClickHouse/pull/6413) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Исправлено состояние гонки данных в StorageMerge [#6717](https://github.com/ClickHouse/ClickHouse/pull/6717) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена ошибка в профилировщике запросов, которая приводила к бесконечному recv из сокета. [#6386](https://github.com/ClickHouse/ClickHouse/pull/6386) ([alesapin](https://github.com/alesapin))
- Исправлено чрезмерное использование CPU при выполнении функции `JSONExtractRaw` над булевым значением. [#6208](https://github.com/ClickHouse/ClickHouse/pull/6208) ([Vitaly Baranov](https://github.com/vitlibar))
- Исправлена регрессия при записи в материализованное представление. [#6415](https://github.com/ClickHouse/ClickHouse/pull/6415) ([Ivan](https://github.com/abyss7))
- Табличная функция `url` имела уязвимость, позволявшую злоумышленнику внедрять произвольные HTTP-заголовки в запрос. Эта проблема была обнаружена [Nikita Tikhomirov](https://github.com/NSTikhomirov). [#6466](https://github.com/ClickHouse/ClickHouse/pull/6466) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена бесполезная проверка `AST` в индексе Set. [#6510](https://github.com/ClickHouse/ClickHouse/issues/6510) [#6651](https://github.com/ClickHouse/ClickHouse/pull/6651) ([Nikita Vasilev](https://github.com/nikvas0))
- Исправлен разбор значений `AggregateFunction`, встроенных в запрос. [#6575](https://github.com/ClickHouse/ClickHouse/issues/6575) [#6773](https://github.com/ClickHouse/ClickHouse/pull/6773) ([Zhichang Yu](https://github.com/yuzhichang))
- Исправлено неправильное поведение семейства функций `trim`. [#6647](https://github.com/ClickHouse/ClickHouse/pull/6647) ([alexey-milovidov](https://github.com/alexey-milovidov))

### Релиз ClickHouse 19.13.4.32, 2019-09-10 {#clickhouse-release-19-13-4-32-2019-09-10}

#### Исправление ошибок {#bug-fix-11}


- Этот релиз также содержит все исправления ошибок безопасности из версий 19.11.9.52 и 19.11.10.54.
- Исправлено состояние гонки данных в таблице `system.parts` и запросе `ALTER`. [#6245](https://github.com/ClickHouse/ClickHouse/issues/6245) [#6513](https://github.com/ClickHouse/ClickHouse/pull/6513) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлено несоответствие заголовков в потоках, возникавшее при чтении из пустой распределённой таблицы с использованием sample и prewhere. [#6167](https://github.com/ClickHouse/ClickHouse/issues/6167) ([Lixiang Qian](https://github.com/fancyqlx)) [#6823](https://github.com/ClickHouse/ClickHouse/pull/6823) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Исправлено аварийное завершение при использовании условия `IN` с подзапросом, содержащим кортеж. [#6125](https://github.com/ClickHouse/ClickHouse/issues/6125) [#6550](https://github.com/ClickHouse/ClickHouse/pull/6550) ([tavplubix](https://github.com/tavplubix))
- Исправлен случай с одинаковыми именами столбцов в секции `GLOBAL JOIN ON`. [#6181](https://github.com/ClickHouse/ClickHouse/pull/6181) ([Artem Zuikov](https://github.com/4ertus2))
- Исправлено аварийное завершение при приведении к типу `Decimal` типов, которые не поддерживают такое преобразование. Теперь вместо этого выбрасывается исключение. [#6297](https://github.com/ClickHouse/ClickHouse/pull/6297) ([Artem Zuikov](https://github.com/4ertus2))
- Исправлено аварийное завершение в функции `extractAll()`. [#6644](https://github.com/ClickHouse/ClickHouse/pull/6644) ([Artem Zuikov](https://github.com/4ertus2))
- Преобразование запросов для табличных функций `MySQL`, `ODBC`, `JDBC` теперь корректно работает для запросов `SELECT WHERE` с несколькими выражениями `AND`. [#6381](https://github.com/ClickHouse/ClickHouse/issues/6381) [#6676](https://github.com/ClickHouse/ClickHouse/pull/6676) ([dimarub2000](https://github.com/dimarub2000))
- Добавлены проверки предыдущих объявлений для интеграции с MySQL 8. [#6569](https://github.com/ClickHouse/ClickHouse/pull/6569) ([Rafael David Tinoco](https://github.com/rafaeldtinoco))

#### Исправление безопасности {#security-fix-1}

- Исправлены две уязвимости в кодеках на этапе декомпрессии (злоумышленник может создать сжатые данные, которые приведут к переполнению буфера при декомпрессии). [#6670](https://github.com/ClickHouse/ClickHouse/pull/6670) ([Artem Zuikov](https://github.com/4ertus2))

### Релиз ClickHouse 19.13.3.26, 2019-08-22 {#clickhouse-release-19-13-3-26-2019-08-22}

#### Исправление ошибок {#bug-fix-12}


- Исправлен запрос `ALTER TABLE ... UPDATE` для таблиц с `enable_mixed_granularity_parts=1`. [#6543](https://github.com/ClickHouse/ClickHouse/pull/6543) ([alesapin](https://github.com/alesapin))
- Исправлено исключение NPE при использовании условия IN с подзапросом, содержащим кортеж. [#6125](https://github.com/ClickHouse/ClickHouse/issues/6125) [#6550](https://github.com/ClickHouse/ClickHouse/pull/6550) ([tavplubix](https://github.com/tavplubix))
- Исправлена проблема, при которой устаревшая реплика после восстановления могла содержать куски данных, удалённые командой DROP PARTITION. [#6522](https://github.com/ClickHouse/ClickHouse/issues/6522) [#6523](https://github.com/ClickHouse/ClickHouse/pull/6523) ([tavplubix](https://github.com/tavplubix))
- Исправлена проблема с разбором CSV. [#6426](https://github.com/ClickHouse/ClickHouse/issues/6426) [#6559](https://github.com/ClickHouse/ClickHouse/pull/6559) ([tavplubix](https://github.com/tavplubix))
- Исправлено состояние гонки в таблице system.parts и запросе ALTER. Это исправляет [#6245](https://github.com/ClickHouse/ClickHouse/issues/6245). [#6513](https://github.com/ClickHouse/ClickHouse/pull/6513) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлен некорректный код в мутациях, который мог приводить к повреждению памяти. Исправлена ошибка segfault при чтении адреса `0x14c0`, которая могла происходить из-за одновременного выполнения `DROP TABLE` и `SELECT` из `system.parts` или `system.parts_columns`. Исправлено состояние гонки при подготовке запросов мутаций. Исправлена взаимная блокировка, вызванная выполнением `OPTIMIZE` реплицируемых таблиц и одновременными операциями модификации, такими как ALTER. [#6514](https://github.com/ClickHouse/ClickHouse/pull/6514) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена возможная потеря данных после запроса `ALTER DELETE` для таблицы с индексом пропуска. [#6224](https://github.com/ClickHouse/ClickHouse/issues/6224) [#6282](https://github.com/ClickHouse/ClickHouse/pull/6282) ([Nikita Vasilev](https://github.com/nikvas0))

#### Исправление безопасности {#security-fix-2}

- Если злоумышленник имеет доступ на запись в ZooKeeper и может запустить собственный сервер, доступный из сети, где работает ClickHouse, он может создать специально созданный вредоносный сервер, который будет выступать в роли реплики ClickHouse и зарегистрировать его в ZooKeeper. Когда другая реплика попытается получить кусок данных от вредоносной реплики, это может заставить clickhouse-server записывать данные по произвольному пути в файловой системе. Обнаружено Эльдаром Зайтовым, команда информационной безопасности Яндекса. [#6247](https://github.com/ClickHouse/ClickHouse/pull/6247) ([alexey-milovidov](https://github.com/alexey-milovidov))

### Релиз ClickHouse 19.13.2.19, 2019-08-14 {#clickhouse-release-19-13-2-19-2019-08-14}

#### Новая возможность {#new-feature-5}


- Профилировщик выборки на уровне запросов. [Пример](https://gist.github.com/alexey-milovidov/92758583dd41c24c360fdb8d6a4da194). [#4247](https://github.com/ClickHouse/ClickHouse/issues/4247) ([laplab](https://github.com/laplab)) [#6124](https://github.com/ClickHouse/ClickHouse/pull/6124) ([alexey-milovidov](https://github.com/alexey-milovidov)) [#6250](https://github.com/ClickHouse/ClickHouse/pull/6250) [#6283](https://github.com/ClickHouse/ClickHouse/pull/6283) [#6386](https://github.com/ClickHouse/ClickHouse/pull/6386)
- Возможность указать список столбцов с помощью выражения `COLUMNS('regexp')`, которое работает как более продвинутый вариант символа `*`. [#5951](https://github.com/ClickHouse/ClickHouse/pull/5951) ([mfridental](https://github.com/mfridental)), ([alexey-milovidov](https://github.com/alexey-milovidov))
- Теперь возможно использование `CREATE TABLE AS table_function()` [#6057](https://github.com/ClickHouse/ClickHouse/pull/6057) ([dimarub2000](https://github.com/dimarub2000))
- Оптимизатор Adam для стохастического градиентного спуска используется по умолчанию в агрегатных функциях `stochasticLinearRegression()` и `stochasticLogisticRegression()`, поскольку он показывает хорошее качество практически без какой-либо настройки. [#6000](https://github.com/ClickHouse/ClickHouse/pull/6000) ([Quid37](https://github.com/Quid37))
- Добавлены функции для работы с пользовательским номером недели [#5212](https://github.com/ClickHouse/ClickHouse/pull/5212) ([Andy Yang](https://github.com/andyyzh))
- Запросы `RENAME` теперь работают со всеми движками хранения. [#5953](https://github.com/ClickHouse/ClickHouse/pull/5953) ([Ivan](https://github.com/abyss7))
- Теперь клиент получает логи с сервера с любым желаемым уровнем, устанавливая `send_logs_level`, независимо от уровня логирования, указанного в настройках сервера. [#5964](https://github.com/ClickHouse/ClickHouse/pull/5964) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))

#### Обратно несовместимые изменения {#backward-incompatible-change-4}

- Настройка `input_format_defaults_for_omitted_fields` включена по умолчанию. Для вставок в распределённые таблицы эта настройка должна быть одинаковой на всём кластере (её необходимо установить перед последовательным обновлением). Она включает вычисление сложных выражений по умолчанию для пропущенных полей в форматах `JSONEachRow` и `CSV*`. Это ожидаемое поведение, но может привести к незначительной разнице в производительности. [#6043](https://github.com/ClickHouse/ClickHouse/pull/6043) ([Artem Zuikov](https://github.com/4ertus2)), [#5625](https://github.com/ClickHouse/ClickHouse/pull/5625) ([akuzm](https://github.com/akuzm))

#### Экспериментальные возможности {#experimental-features}

- Новый конвейер обработки запросов. Используйте опцию `experimental_use_processors=1` для его включения. Используйте на свой страх и риск. [#4914](https://github.com/ClickHouse/ClickHouse/pull/4914) ([Nikolai Kochetov](https://github.com/KochetovNicolai))

#### Исправление ошибок {#bug-fix-13}

- Интеграция с Kafka исправлена в этой версии.
- Исправлено кодирование `DoubleDelta` для `Int64` при больших значениях `DoubleDelta`, улучшено кодирование `DoubleDelta` для случайных данных типа `Int32`. [#5998](https://github.com/ClickHouse/ClickHouse/pull/5998) ([Vasily Nemkov](https://github.com/Enmk))
- Исправлена переоценка `max_rows_to_read`, если настройка `merge_tree_uniform_read_distribution` установлена в 0. [#6019](https://github.com/ClickHouse/ClickHouse/pull/6019) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### Улучшения {#improvement-4}

- Выбрасывается исключение, если файл `config.d` не имеет соответствующего корневого элемента, как в конфигурационном файле [#6123](https://github.com/ClickHouse/ClickHouse/pull/6123) ([dimarub2000](https://github.com/dimarub2000))


#### Улучшение производительности {#performance-improvement-3}

- Оптимизирована функция `count()`. Теперь она использует наименьший столбец (если возможно). [#6028](https://github.com/ClickHouse/ClickHouse/pull/6028) ([Amos Bird](https://github.com/amosbird))

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-5}

- Добавлен отчет об использовании памяти в тестах производительности. [#5899](https://github.com/ClickHouse/ClickHouse/pull/5899) ([akuzm](https://github.com/akuzm))
- Исправлена сборка с внешней библиотекой `libcxx`. [#6010](https://github.com/ClickHouse/ClickHouse/pull/6010) ([Ivan](https://github.com/abyss7))
- Исправлена сборка с разделяемой библиотекой `rdkafka`. [#6101](https://github.com/ClickHouse/ClickHouse/pull/6101) ([Ivan](https://github.com/abyss7))


## Релиз ClickHouse 19.11 {#clickhouse-release-19-11}

### Релиз ClickHouse 19.11.13.74, 2019-11-01 {#clickhouse-release-19-11-13-74-2019-11-01}

#### Исправление ошибок {#bug-fix-14}

- Исправлено редкое падение в `ALTER MODIFY COLUMN` и при вертикальном слиянии, когда одна из объединяемых/изменяемых частей пуста (0 строк). [#6780](https://github.com/ClickHouse/ClickHouse/pull/6780) ([alesapin](https://github.com/alesapin))
- Ручное обновление `SIMDJSON`. Это исправляет возможное переполнение файлов stderr ложными диагностическими сообщениями json. [#7548](https://github.com/ClickHouse/ClickHouse/pull/7548) ([Alexander Kazakov](https://github.com/Akazz))
- Исправлена ошибка с расширением файла `mrk` для мутаций ([alesapin](https://github.com/alesapin))

### Релиз ClickHouse 19.11.12.69, 2019-10-02 {#clickhouse-release-19-11-12-69-2019-10-02}

#### Исправление ошибок {#bug-fix-15}

- Исправлено снижение производительности анализа индексов по составным ключам на больших таблицах. Это исправляет [#6924](https://github.com/ClickHouse/ClickHouse/issues/6924). [#7075](https://github.com/ClickHouse/ClickHouse/pull/7075) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Предотвращён редкий SIGSEGV при отправке данных в таблицах с движком Distributed (`Failed to send batch: file with index XXXXX is absent`). [#7032](https://github.com/ClickHouse/ClickHouse/pull/7032) ([Azat Khuzhin](https://github.com/azat))
- Исправлена ошибка `Unknown identifier` при множественных соединениях. Это исправляет [#5254](https://github.com/ClickHouse/ClickHouse/issues/5254). [#7022](https://github.com/ClickHouse/ClickHouse/pull/7022) ([Artem Zuikov](https://github.com/4ertus2))

### Релиз ClickHouse 19.11.11.57, 2019-09-13 {#clickhouse-release-19-11-11-57-2019-09-13}

- Исправлена логическая ошибка, вызывающая segfault при выборке из пустого топика Kafka. [#6902](https://github.com/ClickHouse/ClickHouse/issues/6902) [#6909](https://github.com/ClickHouse/ClickHouse/pull/6909) ([Ivan](https://github.com/abyss7))
- Исправление для функции `АrrayEnumerateUniqRanked` с пустыми массивами в параметрах. [#6928](https://github.com/ClickHouse/ClickHouse/pull/6928) ([proller](https://github.com/proller))

### Релиз ClickHouse 19.11.10.54, 2019-09-10 {#clickhouse-release-19-11-10-54-2019-09-10}

#### Исправление ошибок {#bug-fix-16}

- Смещения для сообщений Kafka теперь сохраняются вручную, чтобы можно было зафиксировать их все сразу для всех партиций. Исправляет потенциальное дублирование в сценарии «один потребитель — много партиций». [#6872](https://github.com/ClickHouse/ClickHouse/pull/6872) ([Ivan](https://github.com/abyss7))

### Релиз ClickHouse 19.11.9.52, 2019-09-6 {#clickhouse-release-19-11-9-52-2019-09-6}


- Улучшена обработка ошибок в кеш-словарях. [#6737](https://github.com/ClickHouse/ClickHouse/pull/6737) ([Vitaly Baranov](https://github.com/vitlibar))
- Исправлена ошибка в функции `arrayEnumerateUniqRanked`. [#6779](https://github.com/ClickHouse/ClickHouse/pull/6779) ([proller](https://github.com/proller))
- Исправлена функция `JSONExtract` при извлечении `Tuple` из JSON. [#6718](https://github.com/ClickHouse/ClickHouse/pull/6718) ([Vitaly Baranov](https://github.com/vitlibar))
- Исправлена возможная потеря данных после запроса `ALTER DELETE` на таблице с индексом пропуска. [#6224](https://github.com/ClickHouse/ClickHouse/issues/6224) [#6282](https://github.com/ClickHouse/ClickHouse/pull/6282) ([Nikita Vasilev](https://github.com/nikvas0))
- Исправлен тест производительности. [#6392](https://github.com/ClickHouse/ClickHouse/pull/6392) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Parquet: Исправлено чтение булевых столбцов. [#6579](https://github.com/ClickHouse/ClickHouse/pull/6579) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлено неправильное поведение функции `nullIf` для константных аргументов. [#6518](https://github.com/ClickHouse/ClickHouse/pull/6518) ([Guillaume Tassery](https://github.com/YiuRULE)) [#6580](https://github.com/ClickHouse/ClickHouse/pull/6580) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена проблема дублирования сообщений Kafka при обычном перезапуске сервера. [#6597](https://github.com/ClickHouse/ClickHouse/pull/6597) ([Ivan](https://github.com/abyss7))
- Исправлена проблема, когда длительные операции `ALTER UPDATE` или `ALTER DELETE` могут препятствовать выполнению обычных слияний. Предотвращено выполнение мутаций при недостаточном количестве свободных потоков. [#6502](https://github.com/ClickHouse/ClickHouse/issues/6502) [#6617](https://github.com/ClickHouse/ClickHouse/pull/6617) ([tavplubix](https://github.com/tavplubix))
- Исправлена ошибка обработки параметра «timezone» в конфигурационном файле сервера. [#6709](https://github.com/ClickHouse/ClickHouse/pull/6709) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлены тесты Kafka. [#6805](https://github.com/ClickHouse/ClickHouse/pull/6805) ([Ivan](https://github.com/abyss7))

#### Исправление безопасности {#security-fix-3}

- Если злоумышленник имеет доступ на запись к ZooKeeper и может запустить пользовательский сервер, доступный из сети, где работает ClickHouse, он может создать специально созданный вредоносный сервер, который будет действовать как реплика ClickHouse, и зарегистрировать его в ZooKeeper. Когда другая реплика будет получать часть данных от вредоносной реплики, это может заставить clickhouse-server записывать данные по произвольному пути в файловой системе. Обнаружено Эльдаром Зайтовым из команды информационной безопасности Яндекса. [#6247](https://github.com/ClickHouse/ClickHouse/pull/6247) ([alexey-milovidov](https://github.com/alexey-milovidov))

### Релиз ClickHouse 19.11.8.46, 2019-08-22 {#clickhouse-release-19-11-8-46-2019-08-22}

#### Исправление ошибок {#bug-fix-17}


- Исправлен запрос `ALTER TABLE ... UPDATE` для таблиц с `enable_mixed_granularity_parts=1`. [#6543](https://github.com/ClickHouse/ClickHouse/pull/6543) ([alesapin](https://github.com/alesapin))
- Исправлено исключение NPE при использовании условия IN с подзапросом, содержащим кортеж. [#6125](https://github.com/ClickHouse/ClickHouse/issues/6125) [#6550](https://github.com/ClickHouse/ClickHouse/pull/6550) ([tavplubix](https://github.com/tavplubix))
- Исправлена проблема, при которой устаревшая реплика после восстановления могла содержать куски данных, удалённые командой DROP PARTITION. [#6522](https://github.com/ClickHouse/ClickHouse/issues/6522) [#6523](https://github.com/ClickHouse/ClickHouse/pull/6523) ([tavplubix](https://github.com/tavplubix))
- Исправлена проблема с разбором CSV. [#6426](https://github.com/ClickHouse/ClickHouse/issues/6426) [#6559](https://github.com/ClickHouse/ClickHouse/pull/6559) ([tavplubix](https://github.com/tavplubix))
- Исправлено состояние гонки в таблице system.parts и запросе ALTER. Это исправляет [#6245](https://github.com/ClickHouse/ClickHouse/issues/6245). [#6513](https://github.com/ClickHouse/ClickHouse/pull/6513) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлен некорректный код в мутациях, который мог приводить к повреждению памяти. Исправлена ошибка сегментации при чтении адреса `0x14c0`, которая могла происходить из-за одновременного выполнения `DROP TABLE` и `SELECT` из `system.parts` или `system.parts_columns`. Исправлено состояние гонки при подготовке запросов мутаций. Исправлена взаимная блокировка, вызванная выполнением `OPTIMIZE` реплицируемых таблиц и одновременными операциями модификации, такими как ALTER. [#6514](https://github.com/ClickHouse/ClickHouse/pull/6514) ([alexey-milovidov](https://github.com/alexey-milovidov))

### Релиз ClickHouse 19.11.7.40, 2019-08-14 {#clickhouse-release-19-11-7-40-2019-08-14}

#### Исправление ошибок {#bug-fix-18}


- Исправлена интеграция с Kafka в этой версии.
- Исправлена ошибка сегментации при использовании `arrayReduce` с константными аргументами. [#6326](https://github.com/ClickHouse/ClickHouse/pull/6326) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена монотонность `toFloat()`. [#6374](https://github.com/ClickHouse/ClickHouse/pull/6374) ([dimarub2000](https://github.com/dimarub2000))
- Исправлена ошибка сегментации при включенной настройке `optimize_skip_unused_shards` и отсутствующем ключе шардирования. [#6384](https://github.com/ClickHouse/ClickHouse/pull/6384) ([CurtizJ](https://github.com/CurtizJ))
- Исправлена логика функции `arrayEnumerateUniqRanked`. [#6423](https://github.com/ClickHouse/ClickHouse/pull/6423) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Удалено избыточное подробное логирование из обработчика MySQL. [#6389](https://github.com/ClickHouse/ClickHouse/pull/6389) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлено неправильное поведение и возможные ошибки сегментации в агрегатных функциях `topK` и `topKWeighted`. [#6404](https://github.com/ClickHouse/ClickHouse/pull/6404) ([CurtizJ](https://github.com/CurtizJ))
- Виртуальные столбцы больше не отображаются в таблице `system.columns`. Это необходимо для обратной совместимости. [#6406](https://github.com/ClickHouse/ClickHouse/pull/6406) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена ошибка выделения памяти для строковых полей в кэш-словаре со сложным ключом. [#6447](https://github.com/ClickHouse/ClickHouse/pull/6447) ([alesapin](https://github.com/alesapin))
- Исправлена ошибка включения адаптивной гранулярности при создании новой реплики для таблицы `Replicated*MergeTree`. [#6452](https://github.com/ClickHouse/ClickHouse/pull/6452) ([alesapin](https://github.com/alesapin))
- Исправлен бесконечный цикл при чтении сообщений Kafka. [#6354](https://github.com/ClickHouse/ClickHouse/pull/6354) ([abyss7](https://github.com/abyss7))
- Устранена возможность вызвать сбой сервера специально сформированным запросом из-за переполнения стека в SQL-парсере, а также возможность переполнения стека в таблицах `Merge` и `Distributed`. [#6433](https://github.com/ClickHouse/ClickHouse/pull/6433) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена ошибка кодирования Gorilla на малых последовательностях. [#6444](https://github.com/ClickHouse/ClickHouse/pull/6444) ([Enmk](https://github.com/Enmk))

#### Улучшение {#improvement-5}

- Разрешено пользователю переопределять настройки `poll_interval` и `idle_connection_timeout` при подключении. [#6230](https://github.com/ClickHouse/ClickHouse/pull/6230) ([alexey-milovidov](https://github.com/alexey-milovidov))

### Релиз ClickHouse 19.11.5.28, 2019-08-05 {#clickhouse-release-19-11-5-28-2019-08-05}

#### Исправление ошибок {#bug-fix-19}


- Исправлена возможность зависания запросов при перегрузке сервера. [#6301](https://github.com/ClickHouse/ClickHouse/pull/6301) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена ошибка FPE в функции yandexConsistentHash. Это исправляет [#6304](https://github.com/ClickHouse/ClickHouse/issues/6304). [#6126](https://github.com/ClickHouse/ClickHouse/pull/6126) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена ошибка в преобразовании типов `LowCardinality` в `AggregateFunctionFactory`. Это исправляет [#6257](https://github.com/ClickHouse/ClickHouse/issues/6257). [#6281](https://github.com/ClickHouse/ClickHouse/pull/6281) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Исправлен разбор настроек `bool` из строк `true` и `false` в конфигурационных файлах. [#6278](https://github.com/ClickHouse/ClickHouse/pull/6278) ([alesapin](https://github.com/alesapin))
- Исправлена редкая ошибка с несовместимыми заголовками потоков в запросах к таблице `Distributed` поверх таблицы `MergeTree`, когда часть `WHERE` перемещается в `PREWHERE`. [#6236](https://github.com/ClickHouse/ClickHouse/pull/6236) ([alesapin](https://github.com/alesapin))
- Исправлено переполнение при целочисленном делении знакового типа на беззнаковый тип. Это исправляет [#6214](https://github.com/ClickHouse/ClickHouse/issues/6214). [#6233](https://github.com/ClickHouse/ClickHouse/pull/6233) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### Обратно несовместимое изменение {#backward-incompatible-change-5}

- `Kafka` всё ещё не работает.

### Релиз ClickHouse 19.11.4.24, 2019-08-01 {#clickhouse-release-19-11-4-24-2019-08-01}

#### Исправление ошибок {#bug-fix-20}


- Исправлена ошибка при записи меток вторичных индексов с адаптивной гранулярностью. [#6126](https://github.com/ClickHouse/ClickHouse/pull/6126) ([alesapin](https://github.com/alesapin))
- Исправлены модификаторы `WITH ROLLUP` и `WITH CUBE` для `GROUP BY` с двухуровневой агрегацией. [#6225](https://github.com/ClickHouse/ClickHouse/pull/6225) ([Anton Popov](https://github.com/CurtizJ))
- Исправлено зависание в функции `JSONExtractRaw`. Исправлено [#6195](https://github.com/ClickHouse/ClickHouse/issues/6195) [#6198](https://github.com/ClickHouse/ClickHouse/pull/6198) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена ошибка сегментации в ExternalLoader::reloadOutdated(). [#6082](https://github.com/ClickHouse/ClickHouse/pull/6082) ([Vitaly Baranov](https://github.com/vitlibar))
- Исправлен случай, когда сервер мог закрыть прослушивающие сокеты, но не завершить работу и продолжить обслуживание оставшихся запросов. Это могло привести к одновременной работе двух процессов clickhouse-server. Иногда сервер мог возвращать ошибку `bad_function_call` для оставшихся запросов. [#6231](https://github.com/ClickHouse/ClickHouse/pull/6231) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлено бесполезное и некорректное условие для поля обновления при начальной загрузке внешних словарей через ODBC, MySQL, ClickHouse и HTTP. Это исправляет [#6069](https://github.com/ClickHouse/ClickHouse/issues/6069) [#6083](https://github.com/ClickHouse/ClickHouse/pull/6083) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлено некорректное исключение при приведении `LowCardinality(Nullable)` к не-Nullable столбцу в случае, если он не содержит значений Null (например, в запросе вида `SELECT CAST(CAST('Hello' AS LowCardinality(Nullable(String))) AS String)`. [#6094](https://github.com/ClickHouse/ClickHouse/issues/6094) [#6119](https://github.com/ClickHouse/ClickHouse/pull/6119) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Исправлен недетерминированный результат агрегатной функции "uniq" в крайне редких случаях. Ошибка присутствовала во всех версиях ClickHouse. [#6058](https://github.com/ClickHouse/ClickHouse/pull/6058) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Ошибка сегментации при указании слишком большого значения CIDR в функции `IPv6CIDRToRange`. [#6068](https://github.com/ClickHouse/ClickHouse/pull/6068) ([Guillaume Tassery](https://github.com/YiuRULE))
- Исправлена небольшая утечка памяти при генерации сервером множества исключений из различных контекстов. [#6144](https://github.com/ClickHouse/ClickHouse/pull/6144) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена ситуация, когда потребитель приостанавливался перед подпиской и не возобновлялся после. [#6075](https://github.com/ClickHouse/ClickHouse/pull/6075) ([Ivan](https://github.com/abyss7)) Обратите внимание, что Kafka не работает в этой версии.
- Очистка буфера данных Kafka от предыдущей операции чтения, завершившейся с ошибкой [#6026](https://github.com/ClickHouse/ClickHouse/pull/6026) ([Nikolay](https://github.com/bopohaa)) Обратите внимание, что Kafka не работает в этой версии.
- Поскольку `StorageMergeTree::background_task_handle` инициализируется в `startup()`, `MergeTreeBlockOutputStream::write()` может попытаться использовать его до инициализации. Добавлена проверка инициализации. [#6080](https://github.com/ClickHouse/ClickHouse/pull/6080) ([Ivan](https://github.com/abyss7))

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-6}


- Добавлены официальные пакеты `rpm`. [#5740](https://github.com/ClickHouse/ClickHouse/pull/5740) ([proller](https://github.com/proller)) ([alesapin](https://github.com/alesapin))
- Добавлена возможность сборки пакетов `.rpm` и `.tgz` с помощью скрипта `packager`. [#5769](https://github.com/ClickHouse/ClickHouse/pull/5769) ([alesapin](https://github.com/alesapin))
- Исправления для системы сборки "Arcadia". [#6223](https://github.com/ClickHouse/ClickHouse/pull/6223) ([proller](https://github.com/proller))

#### Обратно несовместимое изменение {#backward-incompatible-change-6}

- `Kafka` не работает в этой версии.

### Релиз ClickHouse 19.11.3.11, 2019-07-18 {#clickhouse-release-19-11-3-11-2019-07-18}

#### Новая функциональность {#new-feature-6}

- Добавлена поддержка подготовленных запросов. [#5331](https://github.com/ClickHouse/ClickHouse/pull/5331/) ([Alexander](https://github.com/sanych73)) [#5630](https://github.com/ClickHouse/ClickHouse/pull/5630) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Кодеки столбцов `DoubleDelta` и `Gorilla` [#5600](https://github.com/ClickHouse/ClickHouse/pull/5600) ([Vasily Nemkov](https://github.com/Enmk))
- Добавлена настройка `os_thread_priority`, которая позволяет управлять значением "nice" потоков обработки запросов, используемым операционной системой для настройки динамического приоритета планирования. Для работы требуются привилегии `CAP_SYS_NICE`. Это реализует [#5858](https://github.com/ClickHouse/ClickHouse/issues/5858) [#5909](https://github.com/ClickHouse/ClickHouse/pull/5909) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Реализованы столбцы `_topic`, `_offset`, `_key` для движка Kafka [#5382](https://github.com/ClickHouse/ClickHouse/pull/5382) ([Ivan](https://github.com/abyss7)) Обратите внимание, что Kafka не работает в этой версии.
- Добавлен комбинатор агрегатных функций `-Resample` [#5590](https://github.com/ClickHouse/ClickHouse/pull/5590) ([hcz](https://github.com/hczhcz))
- Агрегатные функции `groupArrayMovingSum(win_size)(x)` и `groupArrayMovingAvg(win_size)(x)`, которые вычисляют скользящую сумму/среднее с ограничением размера окна или без него. [#5595](https://github.com/ClickHouse/ClickHouse/pull/5595) ([inv2004](https://github.com/inv2004))
- Добавлен синоним `arrayFlatten` \<-\> `flatten` [#5764](https://github.com/ClickHouse/ClickHouse/pull/5764) ([hcz](https://github.com/hczhcz))
- Интегрирована функция H3 `geoToH3` от Uber. [#4724](https://github.com/ClickHouse/ClickHouse/pull/4724) ([Remen Ivan](https://github.com/BHYCHIK)) [#5805](https://github.com/ClickHouse/ClickHouse/pull/5805) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### Исправление ошибок {#bug-fix-21}


* Реализовано кэширование DNS с асинхронным обновлением. Отдельный поток разрешает все хосты и с заданным периодом (настройка `dns_cache_update_period`) обновляет DNS-кэш. Это должно помочь в случаях, когда IP-адреса хостов часто меняются. [#5857](https://github.com/ClickHouse/ClickHouse/pull/5857) ([Anton Popov](https://github.com/CurtizJ))
* Исправлен сбой (segfault) в кодеке `Delta`, который затрагивал столбцы со значениями размером менее 32 бит. Ошибка приводила к случайному повреждению памяти. [#5786](https://github.com/ClickHouse/ClickHouse/pull/5786) ([alesapin](https://github.com/alesapin))
* Исправлена ошибка сегментации (segfault) при слиянии по TTL с нефизическими столбцами в блоке. [#5819](https://github.com/ClickHouse/ClickHouse/pull/5819) ([Anton Popov](https://github.com/CurtizJ))
* Исправлена редкая ошибка при проверке парта с колонкой `LowCardinality`. Ранее `checkDataPart` всегда завершался с ошибкой для парта с колонкой `LowCardinality`. [#5832](https://github.com/ClickHouse/ClickHouse/pull/5832) ([alesapin](https://github.com/alesapin))
* Избежать зависания подключений, когда пул потоков сервера заполнен. Это важно для подключений из табличной функции `remote` или подключений к шарду без реплик при большом тайм-ауте установления соединения. Это исправляет [#5878](https://github.com/ClickHouse/ClickHouse/issues/5878) [#5881](https://github.com/ClickHouse/ClickHouse/pull/5881) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Поддержка константных аргументов в функции `evalMLModel`. Это исправляет [#5817](https://github.com/ClickHouse/ClickHouse/issues/5817) [#5820](https://github.com/ClickHouse/ClickHouse/pull/5820) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена проблема, из-за которой ClickHouse определял часовой пояс по умолчанию как `UCT` вместо `UTC`. Это исправляет [#5804](https://github.com/ClickHouse/ClickHouse/issues/5804). [#5828](https://github.com/ClickHouse/ClickHouse/pull/5828) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена ошибка выхода за пределы буфера в `visitParamExtractRaw`. Это исправляет [#5901](https://github.com/ClickHouse/ClickHouse/issues/5901) [#5902](https://github.com/ClickHouse/ClickHouse/pull/5902) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Теперь распределённые запросы `DROP/ALTER/TRUNCATE/OPTIMIZE ON CLUSTER` будут выполняться напрямую на ведущей реплике. [#5757](https://github.com/ClickHouse/ClickHouse/pull/5757) ([alesapin](https://github.com/alesapin))
* Исправлен `coalesce` для `ColumnConst` с `ColumnNullable` и внесены связанные изменения. [#5755](https://github.com/ClickHouse/ClickHouse/pull/5755) ([Artem Zuikov](https://github.com/4ertus2))
* Исправлен `ReadBufferFromKafkaConsumer`, чтобы он продолжал читать новые сообщения после `commit()`, даже если до этого был остановлен [#5852](https://github.com/ClickHouse/ClickHouse/pull/5852) ([Ivan](https://github.com/abyss7))
* Исправлены результаты `FULL` и `RIGHT` JOIN при соединении по ключам типа `Nullable` в правой таблице. [#5859](https://github.com/ClickHouse/ClickHouse/pull/5859) ([Artem Zuikov](https://github.com/4ertus2))
* Возможное исправление бесконечной «спячки» низкоприоритетных запросов. [#5842](https://github.com/ClickHouse/ClickHouse/pull/5842) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена гонка, из-за которой некоторые запросы могли не появляться в `query_log` после выполнения `SYSTEM FLUSH LOGS`. [#5456](https://github.com/ClickHouse/ClickHouse/issues/5456) [#5685](https://github.com/ClickHouse/ClickHouse/pull/5685) ([Anton Popov](https://github.com/CurtizJ))
* Исправлено предупреждение ASan `heap-use-after-free` в ClusterCopier, вызванное наблюдателем (watch), который пытался использовать уже удалённый объект copier. [#5871](https://github.com/ClickHouse/ClickHouse/pull/5871) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Исправлен неверный указатель `StringRef`, возвращаемый некоторыми реализациями `IColumn::deserializeAndInsertFromArena`. Эта ошибка затрагивала только юнит-тесты. [#5973](https://github.com/ClickHouse/ClickHouse/pull/5973) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Предотвращено маскирование одноимённых столбцов столбцами `ARRAY JOIN` из исходной и промежуточной таблиц. [#5941](https://github.com/ClickHouse/ClickHouse/pull/5941) ([Artem Zuиков](https://github.com/4ertus2))
* Исправлены запросы `INSERT` и `SELECT` к движку `MySQL` с использованием стиля экранирования идентификаторов, принятого в MySQL. [#5704](https://github.com/ClickHouse/ClickHouse/pull/5704) ([Winter Zhang](https://github.com/zhang2014))
* Теперь запрос `CHECK TABLE` может работать с семейством движков MergeTree. Для каждой партиции (или файла в случае более простых движков) он возвращает статус проверки и, при наличии, сообщение. Также исправлена ошибка при получении повреждённой партиции. [#5865](https://github.com/ClickHouse/ClickHouse/pull/5865) ([alesapin](https://github.com/alesapin))
* Исправлена работа SPLIT&#95;SHARED&#95;LIBRARIES во время выполнения программы [#5793](https://github.com/ClickHouse/ClickHouse/pull/5793) ([Danila Kutenin](https://github.com/danlark1))
* Исправлена инициализация часового пояса, когда `/etc/localtime` является относительной символьной ссылкой, например `../usr/share/zoneinfo/Asia/Istanbul` [#5922](https://github.com/ClickHouse/ClickHouse/pull/5922) ([alexey-milovidov](https://github.com/alexey-milovidov))
* clickhouse-copier: Исправлена ошибка use-after free при завершении работы [#5752](https://github.com/ClickHouse/ClickHouse/pull/5752) ([proller](https://github.com/proller))
* Обновлён `simdjson`. Исправлена ошибка, из-за которой некоторые некорректные JSON с нулевыми байтами успешно разбирались. [#5938](https://github.com/ClickHouse/ClickHouse/pull/5938) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлено завершение работы SystemLogs [#5802](https://github.com/ClickHouse/ClickHouse/pull/5802) ([Anton Popov](https://github.com/CurtizJ))
* Исправлено зависание, если условие в `invalidate_query` зависит от словаря. [#6011](https://github.com/ClickHouse/ClickHouse/pull/6011) ([Vitaly Baranov](https://github.com/vitlibar))

#### Улучшение {#improvement-6}


* Разрешены неразрешимые адреса в конфигурации кластера. Они будут считаться недоступными и повторно определяться при каждой попытке подключения. Это особенно полезно для Kubernetes. Исправляет [#5714](https://github.com/ClickHouse/ClickHouse/issues/5714) [#5924](https://github.com/ClickHouse/ClickHouse/pull/5924) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Закрывать неактивные TCP‑соединения (по умолчанию с тайм-аутом в один час). Это особенно важно для крупных кластеров с несколькими распределёнными таблицами на каждом сервере, потому что каждый сервер может поддерживать пул соединений с каждым другим сервером, и после прохождения пикового значения одновременности запросов соединения будут простаивать. Это исправляет [#5879](https://github.com/ClickHouse/ClickHouse/issues/5879) [#5880](https://github.com/ClickHouse/ClickHouse/pull/5880) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Повышено качество работы функции `topK`. Изменено поведение множества SavingSpace: теперь последний элемент удаляется, если новый элемент имеет больший вес. [#5833](https://github.com/ClickHouse/ClickHouse/issues/5833) [#5850](https://github.com/ClickHouse/ClickHouse/pull/5850) ([Guillaume Tassery](https://github.com/YiuRULE))
* Функции работы с доменами в URL теперь могут обрабатывать неполные URL без схемы [#5725](https://github.com/ClickHouse/ClickHouse/pull/5725) ([alesapin](https://github.com/alesapin))
* В таблицу `system.parts_columns` добавлены контрольные суммы. [#5874](https://github.com/ClickHouse/ClickHouse/pull/5874) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
* Добавлен тип данных `Enum` как синоним `Enum8` или `Enum16`. [#5886](https://github.com/ClickHouse/ClickHouse/pull/5886) ([dimarub2000](https://github.com/dimarub2000))
* Полный вариант побитовой транспозиции для кодека `T64`. Может приводить к лучшему сжатию с `zstd`. [#5742](https://github.com/ClickHouse/ClickHouse/pull/5742) ([Artem Zuikov](https://github.com/4ertus2))
* Условие с функцией `startsWith` теперь может использовать первичный ключ. Это исправляет [#5310](https://github.com/ClickHouse/ClickHouse/issues/5310), [#5882](https://github.com/ClickHouse/ClickHouse/issues/5882) и [#5919](https://github.com/ClickHouse/ClickHouse/pull/5919) ([dimarub2000](https://github.com/dimarub2000))
* Разрешено использовать `clickhouse-copier` с топологией кластера с перекрёстной репликацией, допускающей пустое имя базы данных. [#5745](https://github.com/ClickHouse/ClickHouse/pull/5745) ([nvartolomei](https://github.com/nvartolomei))
* Использовать `UTC` в качестве часового пояса по умолчанию в системе без `tzdata` (например, в «голом» Docker-контейнере). До этого исправления выводилось сообщение об ошибке `Could not determine local time zone`, и сервер или клиент не запускались. [#5827](https://github.com/ClickHouse/ClickHouse/pull/5827) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Возвращена поддержка аргумента с плавающей точкой в функции `quantileTiming` для обеспечения обратной совместимости. [#5911](https://github.com/ClickHouse/ClickHouse/pull/5911) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Показывать в сообщениях об ошибках, в какой таблице отсутствует столбец. [#5768](https://github.com/ClickHouse/ClickHouse/pull/5768) ([Ivan](https://github.com/abyss7))
* Запрещён запуск запроса с одинаковым query&#95;id для разных пользователей [#5430](https://github.com/ClickHouse/ClickHouse/pull/5430) ([proller](https://github.com/proller))
* Более надёжный код для отправки метрик в Graphite. Он будет работать даже во время продолжительных массовых операций `RENAME TABLE`. [#5875](https://github.com/ClickHouse/ClickHouse/pull/5875) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Теперь при невозможности планирования задачи для выполнения в `ThreadPool` будут выводиться более информативные сообщения об ошибках. Это исправляет [#5305](https://github.com/ClickHouse/ClickHouse/issues/5305) [#5801](https://github.com/ClickHouse/ClickHouse/pull/5801) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Инверсия `ngramSearch` для более интуитивного поведения [#5807](https://github.com/ClickHouse/ClickHouse/pull/5807) ([Danila Kutenin](https://github.com/danlark1))
* Добавлен разбор параметра пользователя в конструкторе движка HDFS [#5946](https://github.com/ClickHouse/ClickHouse/pull/5946) ([akonyaev90](https://github.com/akonyaev90))
* Обновлено значение по умолчанию параметра `max_ast_elements` [#5933](https://github.com/ClickHouse/ClickHouse/pull/5933) ([Artem Konovalov](https://github.com/izebit))
* Добавлено понятие устаревших настроек. Устаревшая настройка `allow_experimental_low_cardinality_type` может использоваться, но не оказывает никакого эффекта. [0f15c01c6802f7ce1a1494c12c846be8c98944cd](https://github.com/ClickHouse/ClickHouse/commit/0f15c01c6802f7ce1a1494c12c846be8c98944cd) [Alexey Milovidov](https://github.com/alexey-milovidov)

#### Улучшение производительности {#performance-improvement-4}

- Увеличено количество потоков для SELECT из таблицы Merge для более равномерного распределения нагрузки между потоками. Добавлена настройка `max_streams_multiplier_for_merge_tables`. Исправляет [#5797](https://github.com/ClickHouse/ClickHouse/issues/5797) [#5915](https://github.com/ClickHouse/ClickHouse/pull/5915) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### Улучшение сборки/тестирования/упаковки {#buildtestingpackaging-improvement-7}


* Добавлен тест обратной совместимости для взаимодействия клиент–сервер между разными версиями ClickHouse. [#5868](https://github.com/ClickHouse/ClickHouse/pull/5868) ([alesapin](https://github.com/alesapin))
* Информация о покрытии тестами в каждом коммите и pull request&#39;е. [#5896](https://github.com/ClickHouse/ClickHouse/pull/5896) ([alesapin](https://github.com/alesapin))
* Реализовано взаимодействие с AddressSanitizer для поддержки наших пользовательских аллокаторов (`Arena` и `ArenaWithFreeLists`) с целью улучшения отладки ошибок «use-after-free». [#5728](https://github.com/ClickHouse/ClickHouse/pull/5728) ([akuzm](https://github.com/akuzm))
* Переход на [реализацию LLVM libunwind](https://github.com/llvm-mirror/libunwind) для обработки исключений C++ и вывода трассировок стека [#4828](https://github.com/ClickHouse/ClickHouse/pull/4828) ([Nikita Lapkov](https://github.com/laplab))
* Добавлены ещё два предупреждения от -Weverything [#5923](https://github.com/ClickHouse/ClickHouse/pull/5923) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Добавлена возможность собирать ClickHouse с использованием Memory Sanitizer. [#3949](https://github.com/ClickHouse/ClickHouse/pull/3949) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлен отчет UBSan о функции `bitTest` в fuzz-тесте. [#5943](https://github.com/ClickHouse/ClickHouse/pull/5943) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Docker: добавлена возможность инициализировать экземпляр ClickHouse, для которого требуется аутентификация. [#5727](https://github.com/ClickHouse/ClickHouse/pull/5727) ([Korviakov Andrey](https://github.com/shurshun))
* Обновление librdkafka до версии 1.1.0 [#5872](https://github.com/ClickHouse/ClickHouse/pull/5872) ([Ivan](https://github.com/abyss7))
* Добавлен глобальный тайм-аут для интеграционных тестов и отключена часть из них в коде тестов. [#5741](https://github.com/ClickHouse/ClickHouse/pull/5741) ([alesapin](https://github.com/alesapin))
* Исправлены некоторые ошибки ThreadSanitizer. [#5854](https://github.com/ClickHouse/ClickHouse/pull/5854) ([akuzm](https://github.com/akuzm))
* Опция `--no-undefined` заставляет компоновщик проверять существование всех внешних имён во время компоновки. Она очень полезна для отслеживания реальных зависимостей между библиотеками в режиме раздельной сборки. [#5855](https://github.com/ClickHouse/ClickHouse/pull/5855) ([Ivan](https://github.com/abyss7))
* Добавлен тест производительности для [#5797](https://github.com/ClickHouse/ClickHouse/issues/5797) [#5914](https://github.com/ClickHouse/ClickHouse/pull/5914) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена совместимость с gcc-7. [#5840](https://github.com/ClickHouse/ClickHouse/pull/5840) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Добавлена поддержка gcc-9. Это исправляет [#5717](https://github.com/ClickHouse/ClickHouse/issues/5717) [#5774](https://github.com/ClickHouse/ClickHouse/pull/5774) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена ошибка, из-за которой `libunwind` мог быть некорректно связан. [#5948](https://github.com/ClickHouse/ClickHouse/pull/5948) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлены несколько предупреждений, обнаруженных PVS-Studio. [#5921](https://github.com/ClickHouse/ClickHouse/pull/5921) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Добавлена базовая поддержка статического анализатора `clang-tidy`. [#5806](https://github.com/ClickHouse/ClickHouse/pull/5806) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Преобразование макросов порядка байт BSD/Linux (&#39;be64toh&#39; и &#39;htobe64&#39;) в эквиваленты для Mac OS X [#5785](https://github.com/ClickHouse/ClickHouse/pull/5785) ([Fu Chen](https://github.com/fredchenbj))
* Улучшено руководство по интеграционным тестам. [#5796](https://github.com/ClickHouse/ClickHouse/pull/5796) ([Vladimir Chebotarev](https://github.com/excitoon))
* Исправлена сборка на macOS + GCC 9 [#5822](https://github.com/ClickHouse/ClickHouse/pull/5822) ([filimonov](https://github.com/filimonov))
* Исправлена малозаметная опечатка: aggreAGte -&gt; aggregate. [#5753](https://github.com/ClickHouse/ClickHouse/pull/5753) ([akuzm](https://github.com/akuzm))
* Исправлена сборка под FreeBSD [#5760](https://github.com/ClickHouse/ClickHouse/pull/5760) ([proller](https://github.com/proller))
* Добавлена ссылка на экспериментальный канал YouTube на веб-сайт [#5845](https://github.com/ClickHouse/ClickHouse/pull/5845) ([Ivan Blinkov](https://github.com/blinkov))
* CMake: добавлена опция флагов покрытия: WITH&#95;COVERAGE [#5776](https://github.com/ClickHouse/ClickHouse/pull/5776) ([proller](https://github.com/proller))
* Исправлен начальный размер некоторых встроенных массивов `PODArray`. [#5787](https://github.com/ClickHouse/ClickHouse/pull/5787) ([akuzm](https://github.com/akuzm))
* clickhouse-server.postinst: исправлено определение ОС для CentOS 6 [#5788](https://github.com/ClickHouse/ClickHouse/pull/5788) ([proller](https://github.com/proller))
* Добавлена сборка пакетов для Arch Linux. [#5719](https://github.com/ClickHouse/ClickHouse/pull/5719) ([Vladimir Chebotarev](https://github.com/excitoon))
* Разделение Common/config.h по библиотекам (dbms) [#5715](https://github.com/ClickHouse/ClickHouse/pull/5715) ([proller](https://github.com/proller))
* Исправления для платформы сборки «Arcadia» [#5795](https://github.com/ClickHouse/ClickHouse/pull/5795) ([proller](https://github.com/proller))
* Исправления для нетипичной сборки (gcc9, без подмодулей) [#5792](https://github.com/ClickHouse/ClickHouse/pull/5792) ([proller](https://github.com/proller))
* Требовать явного указания типа в unalignedStore, так как было показано, что это склонно к возникновению ошибок [#5791](https://github.com/ClickHouse/ClickHouse/pull/5791) ([akuzm](https://github.com/akuzm))
* Исправлена сборка для macOS [#5830](https://github.com/ClickHouse/ClickHouse/pull/5830) ([filimonov](https://github.com/filimonov))
* Тест производительности новой функции JIT на более крупном наборе данных, как запрошено здесь [#5263](https://github.com/ClickHouse/ClickHouse/issues/5263) [#5887](https://github.com/ClickHouse/ClickHouse/pull/5887) ([Guillaume Tassery](https://github.com/YiuRULE))
* Запуск stateful-тестов в стресс-тесте [12693e568722f11e19859742f56428455501fd2a](https://github.com/ClickHouse/ClickHouse/commit/12693e568722f11e19859742f56428455501fd2a) ([alesapin](https://github.com/alesapin))

#### Обратно несовместимые изменения {#backward-incompatible-change-7}

- `Kafka` не работает в этой версии.
- По умолчанию для новых таблиц `MergeTree` включена настройка `adaptive_index_granularity` = 10MB. Если вы создали новые таблицы MergeTree на версии 19.11+, откат на версии ниже 19.6 будет невозможен. [#5628](https://github.com/ClickHouse/ClickHouse/pull/5628) ([alesapin](https://github.com/alesapin))
- Удалены устаревшие недокументированные встроенные словари, которые использовались в Яндекс.Метрике. Функции `OSIn`, `SEIn`, `OSToRoot`, `SEToRoot`, `OSHierarchy`, `SEHierarchy` больше недоступны. Если вы используете эти функции, напишите на адрес clickhouse-feedback@yandex-team.com. Примечание: в последний момент мы решили оставить эти функции ещё на некоторое время. [#5780](https://github.com/ClickHouse/ClickHouse/pull/5780) ([alexey-milovidov](https://github.com/alexey-milovidov))


## Релиз ClickHouse 19.10 {#clickhouse-release-19-10}

### Релиз ClickHouse 19.10.1.5, 2019-07-12 {#clickhouse-release-19-10-1-5-2019-07-12}

#### Новая функциональность {#new-feature-7}

- Добавлен новый кодек столбцов: `T64`. Предназначен для столбцов типов (U)IntX/EnumX/Data(Time)/DecimalX. Хорошо подходит для столбцов с постоянными значениями или значениями из небольшого диапазона. Кодек позволяет увеличивать или уменьшать тип данных без повторного сжатия. [#5557](https://github.com/ClickHouse/ClickHouse/pull/5557) ([Artem Zuikov](https://github.com/4ertus2))
- Добавлен движок баз данных `MySQL`, который позволяет просматривать все таблицы на удалённом сервере MySQL [#5599](https://github.com/ClickHouse/ClickHouse/pull/5599) ([Winter Zhang](https://github.com/zhang2014))
- Реализована функция `bitmapContains`. Она в 2 раза быстрее, чем `bitmapHasAny`, если второй битовый массив содержит один элемент. [#5535](https://github.com/ClickHouse/ClickHouse/pull/5535) ([Zhichang Yu](https://github.com/yuzhichang))
- Добавлена поддержка функции `crc32` (с поведением, идентичным MySQL или PHP). Не используйте её, если вам нужна хеш-функция. [#5661](https://github.com/ClickHouse/ClickHouse/pull/5661) ([Remen Ivan](https://github.com/BHYCHIK))
- Реализованы запросы `SYSTEM START/STOP DISTRIBUTED SENDS` для управления асинхронными вставками в таблицы `Distributed`. [#4935](https://github.com/ClickHouse/ClickHouse/pull/4935) ([Winter Zhang](https://github.com/zhang2014))

#### Исправление ошибок {#bug-fix-22}

- Игнорируются ограничения на выполнение запросов и максимальный размер кусков для ограничений слияния при выполнении мутаций. [#5659](https://github.com/ClickHouse/ClickHouse/pull/5659) ([Anton Popov](https://github.com/CurtizJ))
- Исправлена ошибка, которая могла приводить к дедупликации обычных блоков (крайне редко) и вставке дублирующихся блоков (чаще). [#5549](https://github.com/ClickHouse/ClickHouse/pull/5549) ([alesapin](https://github.com/alesapin))
- Исправлена функция `arrayEnumerateUniqRanked` для аргументов с пустыми массивами [#5559](https://github.com/ClickHouse/ClickHouse/pull/5559) ([proller](https://github.com/proller))
- Отключена подписка на топики Kafka без намерения опрашивать сообщения. [#5698](https://github.com/ClickHouse/ClickHouse/pull/5698) ([Ivan](https://github.com/abyss7))
- Настройка `join_use_nulls` теперь не оказывает эффекта для типов, которые не могут находиться внутри Nullable [#5700](https://github.com/ClickHouse/ClickHouse/pull/5700) ([Olga Khvostikova](https://github.com/stavrolia))
- Исправлены ошибки `Incorrect size of index granularity` [#5720](https://github.com/ClickHouse/ClickHouse/pull/5720) ([coraxster](https://github.com/coraxster))
- Исправлено переполнение при преобразовании Float в Decimal [#5607](https://github.com/ClickHouse/ClickHouse/pull/5607) ([coraxster](https://github.com/coraxster))
- Буфер сбрасывается при вызове деструктора `WriteBufferFromHDFS`. Это исправляет запись в `HDFS`. [#5684](https://github.com/ClickHouse/ClickHouse/pull/5684) ([Xindong Peng](https://github.com/eejoin))

#### Улучшения {#improvement-7}


- Обработка пустых ячеек в `CSV` как значений по умолчанию при включенной настройке `input_format_defaults_for_omitted_fields`. [#5625](https://github.com/ClickHouse/ClickHouse/pull/5625) ([akuzm](https://github.com/akuzm))
- Неблокирующая загрузка внешних словарей. [#5567](https://github.com/ClickHouse/ClickHouse/pull/5567) ([Vitaly Baranov](https://github.com/vitlibar))
- Сетевые таймауты теперь могут динамически изменяться для уже установленных соединений в соответствии с настройками. [#4558](https://github.com/ClickHouse/ClickHouse/pull/4558) ([Konstantin Podshumok](https://github.com/podshumok))
- Использование "public_suffix_list" для функций `firstSignificantSubdomain`, `cutToFirstSignificantSubdomain`. Используется совершенная хеш-таблица, сгенерированная `gperf`, со списком из файла: https://publicsuffix.org/list/public_suffix_list.dat (например, теперь домен `ac.uk` распознается как незначимый). [#5030](https://github.com/ClickHouse/ClickHouse/pull/5030) ([Guillaume Tassery](https://github.com/YiuRULE))
- Внедрен тип данных `IPv6` в системные таблицы; унифицированы столбцы информации о клиенте в `system.processes` и `system.query_log`. [#5640](https://github.com/ClickHouse/ClickHouse/pull/5640) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Использование сессий для соединений с протоколом совместимости MySQL. #5476 [#5646](https://github.com/ClickHouse/ClickHouse/pull/5646) ([Yuriy Baranov](https://github.com/yurriy))
- Поддержка большего количества запросов `ALTER` с `ON CLUSTER`. [#5593](https://github.com/ClickHouse/ClickHouse/pull/5593) [#5613](https://github.com/ClickHouse/ClickHouse/pull/5613) ([sundyli](https://github.com/sundy-li))
- Поддержка секции `<logger>` в конфигурационном файле `clickhouse-local`. [#5540](https://github.com/ClickHouse/ClickHouse/pull/5540) ([proller](https://github.com/proller))
- Возможность выполнения запросов с табличной функцией `remote` в `clickhouse-local`. [#5627](https://github.com/ClickHouse/ClickHouse/pull/5627) ([proller](https://github.com/proller))

#### Улучшения производительности {#performance-improvement-5}

- Добавлена возможность записи финальной метки в конце столбцов MergeTree. Это позволяет избежать бесполезных чтений для ключей, находящихся за пределами диапазона данных таблицы. Включается только при использовании адаптивной гранулярности индекса. [#5624](https://github.com/ClickHouse/ClickHouse/pull/5624) ([alesapin](https://github.com/alesapin))
- Улучшена производительность таблиц MergeTree на очень медленных файловых системах за счет сокращения количества системных вызовов `stat`. [#5648](https://github.com/ClickHouse/ClickHouse/pull/5648) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена деградация производительности при чтении из таблиц MergeTree, появившаяся в версии 19.6. Исправляет #5631. [#5633](https://github.com/ClickHouse/ClickHouse/pull/5633) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-8}


- Реализован `TestKeeper` как реализация интерфейса ZooKeeper, используемая для тестирования [#5643](https://github.com/ClickHouse/ClickHouse/pull/5643) ([alexey-milovidov](https://github.com/alexey-milovidov)) ([levushkin aleksej](https://github.com/alexey-milovidov))
- Начиная с этого момента `.sql`-тесты могут выполняться изолированно на уровне сервера, параллельно, со случайно выбранной базой данных. Это позволяет запускать их быстрее, добавлять новые тесты с пользовательскими конфигурациями сервера и быть уверенным, что разные тесты не влияют друг на друга. [#5554](https://github.com/ClickHouse/ClickHouse/pull/5554) ([Ivan](https://github.com/abyss7))
- Удалены `<name>` и `<metrics>` из тестов производительности [#5672](https://github.com/ClickHouse/ClickHouse/pull/5672) ([Olga Khvostikova](https://github.com/stavrolia))
- Исправлен тест производительности `select_format` для форматов `Pretty` [#5642](https://github.com/ClickHouse/ClickHouse/pull/5642) ([alexey-milovidov](https://github.com/alexey-milovidov))



## Релиз ClickHouse 19.9 {#clickhouse-release-19-9}

### Релиз ClickHouse 19.9.3.31, 2019-07-05 {#clickhouse-release-19-9-3-31-2019-07-05}

#### Исправление ошибок {#bug-fix-23}

- Исправлена ошибка сегментации в кодеке Delta, которая затрагивала столбцы со значениями размером менее 32 бит. Ошибка приводила к случайному повреждению памяти. [#5786](https://github.com/ClickHouse/ClickHouse/pull/5786) ([alesapin](https://github.com/alesapin))
- Исправлена редкая ошибка при проверке части данных со столбцом LowCardinality. [#5832](https://github.com/ClickHouse/ClickHouse/pull/5832) ([alesapin](https://github.com/alesapin))
- Исправлена ошибка сегментации при слиянии TTL с нефизическими столбцами в блоке. [#5819](https://github.com/ClickHouse/ClickHouse/pull/5819) ([Anton Popov](https://github.com/CurtizJ))
- Исправлена потенциальная бесконечная приостановка запросов с низким приоритетом. [#5842](https://github.com/ClickHouse/ClickHouse/pull/5842) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлено определение временной зоны по умолчанию в ClickHouse как UCT вместо UTC. [#5828](https://github.com/ClickHouse/ClickHouse/pull/5828) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена ошибка выполнения распределённых запросов DROP/ALTER/TRUNCATE/OPTIMIZE ON CLUSTER на реплике-последователе до реплики-лидера. Теперь они выполняются непосредственно на реплике-лидере. [#5757](https://github.com/ClickHouse/ClickHouse/pull/5757) ([alesapin](https://github.com/alesapin))
- Исправлено состояние гонки, из-за которого некоторые запросы могли не появляться в query_log сразу после выполнения запроса SYSTEM FLUSH LOGS. [#5685](https://github.com/ClickHouse/ClickHouse/pull/5685) ([Anton Popov](https://github.com/CurtizJ))
- Добавлена отсутствующая поддержка константных аргументов для функции `evalMLModel`. [#5820](https://github.com/ClickHouse/ClickHouse/pull/5820) ([alexey-milovidov](https://github.com/alexey-milovidov))

### Релиз ClickHouse 19.9.2.4, 2019-06-24 {#clickhouse-release-19-9-2-4-2019-06-24}

#### Новая функциональность {#new-feature-8}

- Вывод информации о замороженных частях данных в таблице `system.parts`. [#5471](https://github.com/ClickHouse/ClickHouse/pull/5471) ([proller](https://github.com/proller))
- Запрос пароля клиента при запуске clickhouse-client в терминале, если он не указан в аргументах. [#5092](https://github.com/ClickHouse/ClickHouse/pull/5092) ([proller](https://github.com/proller))
- Реализованы функции `dictGet` и `dictGetOrDefault` для типов Decimal. [#5394](https://github.com/ClickHouse/ClickHouse/pull/5394) ([Artem Zuikov](https://github.com/4ertus2))

#### Улучшение {#improvement-8}

- Debian init: добавлен таймаут остановки сервиса. [#5522](https://github.com/ClickHouse/ClickHouse/pull/5522) ([proller](https://github.com/proller))
- Добавлена настройка, запрещающая по умолчанию создание таблиц с подозрительными типами для LowCardinality. [#5448](https://github.com/ClickHouse/ClickHouse/pull/5448) ([Olga Khvostikova](https://github.com/stavrolia))
- Регрессионные функции возвращают веса модели, когда не используются как State в функции `evalMLMethod`. [#5411](https://github.com/ClickHouse/ClickHouse/pull/5411) ([Quid37](https://github.com/Quid37))
- Переименованы и улучшены методы регрессии. [#5492](https://github.com/ClickHouse/ClickHouse/pull/5492) ([Quid37](https://github.com/Quid37))
- Более понятные интерфейсы для поиска по строкам. [#5586](https://github.com/ClickHouse/ClickHouse/pull/5586) ([Danila Kutenin](https://github.com/danlark1))

#### Исправление ошибок {#bug-fix-24}


* Исправлена потенциальная утечка данных в Kafka [#5445](https://github.com/ClickHouse/ClickHouse/pull/5445) ([Ivan](https://github.com/abyss7))
* Исправлена потенциальная бесконечная петля в формате `PrettySpace` при вызове с нулевым числом столбцов [#5560](https://github.com/ClickHouse/ClickHouse/pull/5560) ([Olga Khvostikova](https://github.com/stavrolia))
* Исправлена ошибка переполнения UInt32 в линейных моделях. Разрешён вызов ML-модели с неконстантным аргументом модели. [#5516](https://github.com/ClickHouse/ClickHouse/pull/5516) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* `ALTER TABLE ... DROP INDEX IF EXISTS ...` не должно вызывать исключение, если указанный индекс не существует [#5524](https://github.com/ClickHouse/ClickHouse/pull/5524) ([Gleb Novikov](https://github.com/NanoBjorn))
* Исправлен сбой сегментации (segfault) при использовании `bitmapHasAny` в скалярном подзапросе [#5528](https://github.com/ClickHouse/ClickHouse/pull/5528) ([Zhichang Yu](https://github.com/yuzhichang))
* Исправлена ошибка, из-за которой пул соединений репликации не пытался повторно разрешить имя хоста, даже после сброса DNS-кэша. [#5534](https://github.com/ClickHouse/ClickHouse/pull/5534) ([alesapin](https://github.com/alesapin))
* Исправлена работа `ALTER ... MODIFY TTL` для ReplicatedMergeTree. [#5539](https://github.com/ClickHouse/ClickHouse/pull/5539) ([Anton Popov](https://github.com/CurtizJ))
* Исправлена операция INSERT в распределённую таблицу с MATERIALIZED-колонкой [#5429](https://github.com/ClickHouse/ClickHouse/pull/5429) ([Azat Khuzhin](https://github.com/azat))
* Исправлена ошибка bad&#95;alloc при выполнении TRUNCATE для хранилища Join [#5437](https://github.com/ClickHouse/ClickHouse/pull/5437) ([TCeason](https://github.com/TCeason))
* В последних версиях пакета tzdata некоторые файлы теперь являются симлинками. Текущий механизм определения часового пояса по умолчанию перестаёт корректно работать и возвращает неверные имена для некоторых часовых поясов. Теперь, по крайней мере, мы принудительно устанавливаем имя часового пояса в значение переменной TZ, если оно задано. [#5443](https://github.com/ClickHouse/ClickHouse/pull/5443) ([Ivan](https://github.com/abyss7))
* Исправлены некоторые крайне редкие случаи в поисковом алгоритме MultiVolnitsky, когда суммарная длина константных «needles» составляла не менее 16 КБ. Алгоритм пропускал или перезаписывал предыдущие результаты, что могло приводить к некорректному результату `multiSearchAny`. [#5588](https://github.com/ClickHouse/ClickHouse/pull/5588) ([Danila Kutenin](https://github.com/danlark1))
* Исправлена проблема, из-за которой настройки для запросов ExternalData не могли использовать настройки ClickHouse. Кроме того, пока настройки `date_time_input_format` и `low_cardinality_allow_in_native_format` не могут использоваться из-за неоднозначности их названий (во внешних данных они могут интерпретироваться как формат таблицы, а в запросе — как настройка). [#5455](https://github.com/ClickHouse/ClickHouse/pull/5455) ([Danila Kutenin](https://github.com/danlark1))
* Исправлена ошибка, при которой части данных удалялись только из файловой системы, но не из Zookeeper. [#5520](https://github.com/ClickHouse/ClickHouse/pull/5520) ([alesapin](https://github.com/alesapin))
* Удалена отладочная запись в журнал для протокола MySQL [#5478](https://github.com/ClickHouse/ClickHouse/pull/5478) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Пропуск ZNONODE при обработке DDL-запросов [#5489](https://github.com/ClickHouse/ClickHouse/pull/5489) ([Azat Khuzhin](https://github.com/azat))
* Исправлен тип столбца в результате `UNION ALL`. В некоторых случаях данные и типы столбцов в результирующих столбцах были несогласованны. [#5503](https://github.com/ClickHouse/ClickHouse/pull/5503) ([Artem Zuikov](https://github.com/4ertus2))
* Выбрасывать исключение при неверных целых числах в функциях `dictGetT` вместо аварийного завершения. [#5446](https://github.com/ClickHouse/ClickHouse/pull/5446) ([Artem Zuikov](https://github.com/4ertus2))
* Исправлены некорректные значения `element_count` и `load_factor` для хешированного словаря в таблице `system.dictionaries`. [#5440](https://github.com/ClickHouse/ClickHouse/pull/5440) ([Azat Khuzhin](https://github.com/azat))

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-9}

- Исправлена сборка без поддержки HTTP-сжатия `Brotli` (переменная cmake `ENABLE_BROTLI=OFF`). [#5521](https://github.com/ClickHouse/ClickHouse/pull/5521) ([Anton Yuzhaninov](https://github.com/citrin))
- Включение roaring.h как roaring/roaring.h [#5523](https://github.com/ClickHouse/ClickHouse/pull/5523) ([Orivej Desh](https://github.com/orivej))
- Исправлены предупреждения gcc9 в hyperscan (директива #line — зло!) [#5546](https://github.com/ClickHouse/ClickHouse/pull/5546) ([Danila Kutenin](https://github.com/danlark1))
- Исправлены все предупреждения при компиляции с gcc-9. Исправлены некоторые проблемы в contrib. Исправлена внутренняя ошибка компилятора gcc9 и отправлена в bugzilla. [#5498](https://github.com/ClickHouse/ClickHouse/pull/5498) ([Danila Kutenin](https://github.com/danlark1))
- Исправлена линковка с lld [#5477](https://github.com/ClickHouse/ClickHouse/pull/5477) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Удалены неиспользуемые специализации в словарях [#5452](https://github.com/ClickHouse/ClickHouse/pull/5452) ([Artem Zuikov](https://github.com/4ertus2))
- Улучшены тесты производительности для форматирования и парсинга таблиц различных типов файлов [#5497](https://github.com/ClickHouse/ClickHouse/pull/5497) ([Olga Khvostikova](https://github.com/stavrolia))
- Исправления для параллельного запуска тестов [#5506](https://github.com/ClickHouse/ClickHouse/pull/5506) ([proller](https://github.com/proller))
- Docker: использование конфигураций из clickhouse-test [#5531](https://github.com/ClickHouse/ClickHouse/pull/5531) ([proller](https://github.com/proller))
- Исправлена компиляция для FreeBSD [#5447](https://github.com/ClickHouse/ClickHouse/pull/5447) ([proller](https://github.com/proller))
- Обновление boost до версии 1.70 [#5570](https://github.com/ClickHouse/ClickHouse/pull/5570) ([proller](https://github.com/proller))
- Исправлена сборка ClickHouse как подмодуля [#5574](https://github.com/ClickHouse/ClickHouse/pull/5574) ([proller](https://github.com/proller))
- Улучшены тесты производительности JSONExtract [#5444](https://github.com/ClickHouse/ClickHouse/pull/5444) ([Vitaly Baranov](https://github.com/vitlibar))


## Релиз ClickHouse 19.8 {#clickhouse-release-19-8}

### Релиз ClickHouse 19.8.3.8, 2019-06-11 {#clickhouse-release-19-8-3-8-2019-06-11}

#### Новые функции {#new-features}


* Добавлены функции для работы с JSON [#4686](https://github.com/ClickHouse/ClickHouse/pull/4686) ([hcz](https://github.com/hczhcz)), [#5124](https://github.com/ClickHouse/ClickHouse/pull/5124). ([Виталий Баранов](https://github.com/vitlibar))
* Добавлена функция basename с поведением, аналогичным одноимённой функции, которая существует во многих языках (`os.path.basename` в Python, `basename` в PHP и т. д.). Работает как с путями в стиле UNIX, так и с путями Windows. [#5136](https://github.com/ClickHouse/ClickHouse/pull/5136) ([Guillaume Tassery](https://github.com/YiuRULE))
* Добавлен синтаксис `LIMIT n, m BY` или `LIMIT m OFFSET n BY` для задания смещения n в конструкции LIMIT BY. [#5138](https://github.com/ClickHouse/ClickHouse/pull/5138) ([Anton Popov](https://github.com/CurtizJ))
* Добавлен новый тип данных `SimpleAggregateFunction`, который позволяет использовать в `AggregatingMergeTree` столбцы с «лёгкой» агрегацией. Он может применяться только с простыми функциями, такими как `any`, `anyLast`, `sum`, `min`, `max`. [#4629](https://github.com/ClickHouse/ClickHouse/pull/4629) ([Boris Granveaud](https://github.com/bgranvea))
* Добавлена поддержка неконстантных аргументов в функции `ngramDistance` [#5198](https://github.com/ClickHouse/ClickHouse/pull/5198) ([Danila Kutenin](https://github.com/danlark1))
* Добавлены функции `skewPop`, `skewSamp`, `kurtPop` и `kurtSamp` для вычисления, соответственно, асимметрии генеральной совокупности, асимметрии выборки, эксцесса и эксцесса выборки. [#5200](https://github.com/ClickHouse/ClickHouse/pull/5200) ([hcz](https://github.com/hczhcz))
* Добавлена поддержка операции переименования для хранилища `MaterializedView`. [#5209](https://github.com/ClickHouse/ClickHouse/pull/5209) ([Guillaume Tassery](https://github.com/YiuRULE))
* Добавлен сервер, позволяющий подключаться к ClickHouse с помощью MySQL-клиента. [#4715](https://github.com/ClickHouse/ClickHouse/pull/4715) ([Yuriy Baranov](https://github.com/yurriy))
* Добавлены функции `toDecimal*OrZero` и `toDecimal*OrNull`. [#5291](https://github.com/ClickHouse/ClickHouse/pull/5291) ([Artem Zuikov](https://github.com/4ertus2))
* Поддержка типов Decimal в функциях `quantile`, `quantiles`, `median`, `quantileExactWeighted`, `quantilesExactWeighted`, `medianExactWeighted`. [#5304](https://github.com/ClickHouse/ClickHouse/pull/5304) ([Artem Zuikov](https://github.com/4ertus2))
* Добавлена функция `toValidUTF8`, которая заменяет все некорректные символы UTF-8 на символ замены � (U+FFFD). [#5322](https://github.com/ClickHouse/ClickHouse/pull/5322) ([Danila Kutenin](https://github.com/danlark1))
* Добавлена функция `format`. Форматирование константного шаблона (упрощённый шаблон формата Python) с использованием строк, переданных в аргументах. [#5330](https://github.com/ClickHouse/ClickHouse/pull/5330) ([Danila Kutenin](https://github.com/danlark1))
* Добавлена таблица `system.detached_parts`, содержащая информацию об отсоединённых партах таблиц `MergeTree`. [#5353](https://github.com/ClickHouse/ClickHouse/pull/5353) ([akuzm](https://github.com/akuzm))
* Добавлена функция `ngramSearch` для вычисления несимметричной разности между шаблоном (needle) и текстом (haystack). [#5418](https://github.com/ClickHouse/ClickHouse/pull/5418)[#5422](https://github.com/ClickHouse/ClickHouse/pull/5422) ([Danila Kutenin](https://github.com/danlark1))
* Реализация базовых методов машинного обучения (стохастическая линейная регрессия и логистическая регрессия) с использованием интерфейса агрегатных функций. Поддерживает различные стратегии обновления весов модели (простой градиентный спуск, метод момента, метод Нестерова). Также поддерживает мини-батчи произвольного размера. [#4943](https://github.com/ClickHouse/ClickHouse/pull/4943) ([Quid37](https://github.com/Quid37))
* Реализация функций `geohashEncode` и `geohashDecode`. [#5003](https://github.com/ClickHouse/ClickHouse/pull/5003) ([Vasily Nemkov](https://github.com/Enmk))
* Добавлена агрегатная функция `timeSeriesGroupSum`, которая может агрегировать различные временные ряды с невыровненными метками времени. Для этого используется линейная интерполяция между двумя точками выборки по времени, после чего временные ряды суммируются. Добавлена агрегатная функция `timeSeriesGroupRateSum`, которая вычисляет скорость изменения (rate) временных рядов, а затем суммирует эти скорости. [#4542](https://github.com/ClickHouse/ClickHouse/pull/4542) ([Yangkuan Liu](https://github.com/LiuYangkuan))
* Добавлены функции `IPv4CIDRtoIPv4Range` и `IPv6CIDRtoIPv6Range` для вычисления нижней и верхней границ IP-адресов в подсети по CIDR. [#5095](https://github.com/ClickHouse/ClickHouse/pull/5095) ([Guillaume Tassery](https://github.com/YiuRULE))
* Добавлен заголовок X-ClickHouse-Summary при отправке запроса по HTTP с включённой настройкой `send_progress_in_http_headers`. Возвращает ту же информацию, что и X-ClickHouse-Progress, а также дополнительные данные о том, сколько строк и байт было вставлено в ходе выполнения запроса. [#5116](https://github.com/ClickHouse/ClickHouse/pull/5116) ([Guillaume Tassery](https://github.com/YiuRULE))

#### Улучшения {#improvements}


* Добавлена настройка `max_parts_in_total` для семейства таблиц MergeTree (значение по умолчанию: 100 000), которая предотвращает небезопасное указание ключа партиционирования #5166. [#5171](https://github.com/ClickHouse/ClickHouse/pull/5171) ([alexey-milovidov](https://github.com/alexey-milovidov))
* `clickhouse-obfuscator`: выводить начальное значение (seed) для отдельных столбцов, комбинируя исходный seed с именем столбца, а не с его позицией. Это нужно для преобразования наборов данных с несколькими связанными таблицами, чтобы таблицы оставались пригодными для выполнения JOIN после преобразования. [#5178](https://github.com/ClickHouse/ClickHouse/pull/5178) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Добавлены функции `JSONExtractRaw`, `JSONExtractKeyAndValues`. Переименованы функции `jsonExtract<type>` в `JSONExtract<type>`. При ошибках эти функции возвращают соответствующие значения, а не `NULL`. Изменена функция `JSONExtract`: теперь она получает тип возвращаемого значения из своего последнего параметра и не делает тип nullable. Реализован переход на RapidJSON в случае отсутствия инструкций AVX2. Библиотека simdjson обновлена до новой версии. [#5235](https://github.com/ClickHouse/ClickHouse/pull/5235) ([Vitaly Baranov](https://github.com/vitlibar))
* Теперь функции `if` и `multiIf` опираются не на `Nullable` условия, а на ветви, для совместимости с SQL. [#5238](https://github.com/ClickHouse/ClickHouse/pull/5238) ([Jian Wu](https://github.com/janplus))
* Предикат `In` теперь возвращает результат `Null` для входного значения `Null`, как и функция `Equal`. [#5152](https://github.com/ClickHouse/ClickHouse/pull/5152) ([Jian Wu](https://github.com/janplus))
* Проверять ограничение по времени каждые (flush&#95;interval / poll&#95;timeout) строк, читаемых из Kafka. Это позволяет чаще прерывать чтение из потребителя Kafka и проверять ограничения по времени для потоков верхнего уровня [#5249](https://github.com/ClickHouse/ClickHouse/pull/5249) ([Ivan](https://github.com/abyss7))
* Собрать rdkafka со встроенным SASL. Это должно позволить использовать аутентификацию SASL SCRAM [#5253](https://github.com/ClickHouse/ClickHouse/pull/5253) ([Ivan](https://github.com/abyss7))
* Пакетная версия `RowRefList` для `ALL JOIN`. [#5267](https://github.com/ClickHouse/ClickHouse/pull/5267) ([Artem Zuikov](https://github.com/4ertus2))
* clickhouse-server: более информативные сообщения об ошибках при прослушивании порта. [#5268](https://github.com/ClickHouse/ClickHouse/pull/5268) ([proller](https://github.com/proller))
* Поддержка словарей в clickhouse-copier для функций в `<sharding_key>` [#5270](https://github.com/ClickHouse/ClickHouse/pull/5270) ([proller](https://github.com/proller))
* Добавлена новая настройка `kafka_commit_every_batch` для регулирования политики фиксации (commit) в Kafka.
  Она позволяет задать режим фиксации: после обработки каждого батча сообщений или после записи всего блока в хранилище. Это компромисс между риском потерять некоторые сообщения и риском прочитать их дважды в отдельных крайних ситуациях. [#5308](https://github.com/ClickHouse/ClickHouse/pull/5308) ([Ivan](https://github.com/abyss7))
* Добавлена поддержка других беззнаковых целочисленных типов для `windowFunnel`. [#5320](https://github.com/ClickHouse/ClickHouse/pull/5320) ([sundyli](https://github.com/sundy-li))
* Разрешено переопределение виртуального столбца `_table` в движке Merge. [#5325](https://github.com/ClickHouse/ClickHouse/pull/5325) ([Ivan](https://github.com/abyss7))
* Реализована поддержка других беззнаковых целочисленных типов в агрегатных функциях `sequenceMatch` [#5339](https://github.com/ClickHouse/ClickHouse/pull/5339) ([sundyli](https://github.com/sundy-li))
* Улучшены сообщения об ошибках на случай, когда несоответствие `checksum` с наибольшей вероятностью вызвано сбоями оборудования. [#5355](https://github.com/ClickHouse/ClickHouse/pull/5355) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Проверка, что базовые таблицы поддерживают выборку (sampling) для `StorageMerge` [#5366](https://github.com/ClickHouse/ClickHouse/pull/5366) ([Ivan](https://github.com/abyss7))
* Закрывать соединения MySQL после их использования во внешних словарях. Связано с задачей #893. [#5395](https://github.com/ClickHouse/ClickHouse/pull/5395) ([Clément Rodriguez](https://github.com/clemrodriguez))
* Улучшения протокола MySQL Wire. Изменено название формата на MySQLWire. Используется RAII для вызова RSA&#95;free. SSL отключается, если не удаётся создать контекст. [#5419](https://github.com/ClickHouse/ClickHouse/pull/5419) ([Yuriy Baranov](https://github.com/yurriy))
* clickhouse-client: позволяет запускаться при недоступном файле истории (только для чтения, нет свободного места на диске, файл — директория и т. п.). [#5431](https://github.com/ClickHouse/ClickHouse/pull/5431) ([proller](https://github.com/proller))
* Учитывать настройки запроса при асинхронных `INSERT` в таблицы `Distributed`. [#4936](https://github.com/ClickHouse/ClickHouse/pull/4936) ([TCeason](https://github.com/TCeason))
* Переименованы функции `leastSqr` в `simpleLinearRegression`, `LinearRegression` в `linearRegression`, `LogisticRegression` в `logisticRegression`. [#5391](https://github.com/ClickHouse/ClickHouse/pull/5391) ([Nikolai Kochetov](https://github.com/KochetovNicolai))

#### Улучшения производительности {#performance-improvements}

- Параллельная обработка частей нереплицируемых таблиц MergeTree в запросе ALTER MODIFY. [#4639](https://github.com/ClickHouse/ClickHouse/pull/4639) ([Ivan Kush](https://github.com/IvanKush))
- Оптимизация извлечения регулярных выражений. [#5193](https://github.com/ClickHouse/ClickHouse/pull/5193) [#5191](https://github.com/ClickHouse/ClickHouse/pull/5191) ([Danila Kutenin](https://github.com/danlark1))
- Столбец ключа правого соединения больше не добавляется в результат соединения, если он используется только в секции join on. [#5260](https://github.com/ClickHouse/ClickHouse/pull/5260) ([Artem Zuikov](https://github.com/4ertus2))
- Заморозка буфера Kafka после первого пустого ответа. Это позволяет избежать множественных вызовов `ReadBuffer::next()` для пустого результата в некоторых потоках парсинга строк. [#5283](https://github.com/ClickHouse/ClickHouse/pull/5283) ([Ivan](https://github.com/abyss7))
- Оптимизация функции `concat` для нескольких аргументов. [#5357](https://github.com/ClickHouse/ClickHouse/pull/5357) ([Danila Kutenin](https://github.com/danlark1))
- Оптимизация запросов. Разрешено проталкивание выражения IN при переписывании comma/cross join во внутреннее соединение. [#5396](https://github.com/ClickHouse/ClickHouse/pull/5396) ([Artem Zuikov](https://github.com/4ertus2))
- Обновление реализации LZ4 до эталонной версии для более быстрой декомпрессии. [#5070](https://github.com/ClickHouse/ClickHouse/pull/5070) ([Danila Kutenin](https://github.com/danlark1))
- Реализована поразрядная сортировка MSD (на основе kxsort) и частичная сортировка. [#5129](https://github.com/ClickHouse/ClickHouse/pull/5129) ([Evgenii Pravda](https://github.com/kvinty))

#### Исправления ошибок {#bug-fixes}

- Исправлено проталкивание требуемых столбцов с соединением [#5192](https://github.com/ClickHouse/ClickHouse/pull/5192) ([Winter Zhang](https://github.com/zhang2014))
- Исправлена ошибка, при которой команда `sudo service clickhouse-server forcerestart` не работала должным образом, когда ClickHouse запускался через systemd. [#5204](https://github.com/ClickHouse/ClickHouse/pull/5204) ([proller](https://github.com/proller))
- Исправлены коды ошибок HTTP в DataPartsExchange (межсерверный HTTP-сервер на порту 9009 всегда возвращал код 200, даже при ошибках). [#5216](https://github.com/ClickHouse/ClickHouse/pull/5216) ([proller](https://github.com/proller))
- Исправлена SimpleAggregateFunction для строк длиннее MAX_SMALL_STRING_SIZE [#5311](https://github.com/ClickHouse/ClickHouse/pull/5311) ([Azat Khuzhin](https://github.com/azat))
- Исправлена ошибка преобразования `Decimal` в `Nullable(Decimal)` в операторе IN. Добавлена поддержка других преобразований Decimal в Decimal (включая различные масштабы). [#5350](https://github.com/ClickHouse/ClickHouse/pull/5350) ([Artem Zuikov](https://github.com/4ertus2))
- Исправлено повреждение FPU в библиотеке simdjson, которое приводило к неправильному вычислению агрегатных функций `uniqHLL` и `uniqCombined`, а также математических функций, таких как `log`. [#5354](https://github.com/ClickHouse/ClickHouse/pull/5354) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена обработка смешанных const/nonconst случаев в функциях JSON. [#5435](https://github.com/ClickHouse/ClickHouse/pull/5435) ([Vitaly Baranov](https://github.com/vitlibar))
- Исправлена функция `retention`. Теперь все условия, которые выполняются в строке данных, добавляются в состояние данных. [#5119](https://github.com/ClickHouse/ClickHouse/pull/5119) ([小路](https://github.com/nicelulu))
- Исправлен тип результата для `quantileExact` с типами Decimal. [#5304](https://github.com/ClickHouse/ClickHouse/pull/5304) ([Artem Zuikov](https://github.com/4ertus2))

#### Документация {#documentation}


- Перевод документации по `CollapsingMergeTree` на китайский язык. [#5168](https://github.com/ClickHouse/ClickHouse/pull/5168) ([张风啸](https://github.com/AlexZFX))
- Перевод части документации о движках таблиц на китайский язык.
  [#5134](https://github.com/ClickHouse/ClickHouse/pull/5134)
  [#5328](https://github.com/ClickHouse/ClickHouse/pull/5328)
  ([never lee](https://github.com/neverlee))

#### Улучшения сборки, тестирования и упаковки {#buildtestingpackaging-improvements}

- Исправлены отчёты санитайзеров, указывающие на вероятное обращение к освобождённой памяти.[#5139](https://github.com/ClickHouse/ClickHouse/pull/5139) [#5143](https://github.com/ClickHouse/ClickHouse/pull/5143) [#5393](https://github.com/ClickHouse/ClickHouse/pull/5393) ([Ivan](https://github.com/abyss7))
- Тесты производительности перенесены из отдельных директорий для удобства. [#5158](https://github.com/ClickHouse/ClickHouse/pull/5158) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлены некорректные тесты производительности. [#5255](https://github.com/ClickHouse/ClickHouse/pull/5255) ([alesapin](https://github.com/alesapin))
- Добавлен инструмент для вычисления контрольных сумм при битовых искажениях для отладки аппаратных проблем. [#5334](https://github.com/ClickHouse/ClickHouse/pull/5334) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Улучшено удобство использования скрипта запуска. [#5340](https://github.com/ClickHouse/ClickHouse/pull/5340)[#5360](https://github.com/ClickHouse/ClickHouse/pull/5360) ([filimonov](https://github.com/filimonov))
- Добавлена краткая инструкция по написанию тестов производительности. [#5408](https://github.com/ClickHouse/ClickHouse/pull/5408) ([alesapin](https://github.com/alesapin))
- Добавлена возможность выполнять подстановки в запросах create, fill и drop в тестах производительности [#5367](https://github.com/ClickHouse/ClickHouse/pull/5367) ([Olga Khvostikova](https://github.com/stavrolia))


## Релиз ClickHouse 19.7 {#clickhouse-release-19-7}

### Релиз ClickHouse 19.7.5.29, 2019-07-05 {#clickhouse-release-19-7-5-29-2019-07-05}

#### Исправление ошибки {#bug-fix-25}

- Исправлена регрессия производительности в некоторых запросах с JOIN. [#5192](https://github.com/ClickHouse/ClickHouse/pull/5192) ([Winter Zhang](https://github.com/zhang2014))

### Релиз ClickHouse 19.7.5.27, 2019-06-09 {#clickhouse-release-19-7-5-27-2019-06-09}

#### Новые возможности {#new-features-1}

- Добавлены функции для работы с битовыми картами `bitmapHasAny` и `bitmapHasAll`, аналогичные функциям `hasAny` и `hasAll` для массивов. [#5279](https://github.com/ClickHouse/ClickHouse/pull/5279) ([Sergi Vladykin](https://github.com/svladykin))

#### Исправления ошибок {#bug-fixes-1}


- Исправлена ошибка сегментации при использовании индекса `minmax` со значением Null. [#5246](https://github.com/ClickHouse/ClickHouse/pull/5246) ([Никита Васильев](https://github.com/nikvas0))
- Все входные столбцы в LIMIT BY теперь помечаются как обязательные для вывода. Это исправляет ошибку 'Not found column' в некоторых распределённых запросах. [#5407](https://github.com/ClickHouse/ClickHouse/pull/5407) ([Константин С. Пан](https://github.com/kvap))
- Исправлена ошибка "Column '0' already exists" в запросах `SELECT .. PREWHERE` для столбцов с DEFAULT [#5397](https://github.com/ClickHouse/ClickHouse/pull/5397) ([proller](https://github.com/proller))
- Исправлен запрос `ALTER MODIFY TTL` для таблиц `ReplicatedMergeTree`. [#5539](https://github.com/ClickHouse/ClickHouse/pull/5539/commits) ([Антон Попов](https://github.com/CurtizJ))
- Сервер больше не завершается аварийно при сбое запуска потребителей Kafka. [#5285](https://github.com/ClickHouse/ClickHouse/pull/5285) ([Иван](https://github.com/abyss7))
- Исправлена ошибка, при которой функции для работы с битовыми картами возвращали неверный результат. [#5359](https://github.com/ClickHouse/ClickHouse/pull/5359) ([Энди Янг](https://github.com/andyyzh))
- Исправлен подсчёт element_count для хешированных словарей (дубликаты больше не учитываются) [#5440](https://github.com/ClickHouse/ClickHouse/pull/5440) ([Азат Хужин](https://github.com/azat))
- Содержимое переменной окружения TZ теперь используется в качестве имени часового пояса. Это помогает корректно определять часовой пояс по умолчанию в некоторых случаях.[#5443](https://github.com/ClickHouse/ClickHouse/pull/5443) ([Иван](https://github.com/abyss7))
- Функции `dictGetT` больше не пытаются преобразовывать целые числа, поскольку это работает некорректно. Вместо этого выбрасывается исключение. [#5446](https://github.com/ClickHouse/ClickHouse/pull/5446) ([Артём Зуйков](https://github.com/4ertus2))
- Исправлены настройки в HTTP-запросах ExternalData. [#5455](https://github.com/ClickHouse/ClickHouse/pull/5455) ([Данила
  Кутенин](https://github.com/danlark1))
- Исправлена ошибка, при которой куски данных удалялись только из файловой системы без удаления из Zookeeper. [#5520](https://github.com/ClickHouse/ClickHouse/pull/5520) ([alesapin](https://github.com/alesapin))
- Исправлена ошибка сегментации в функции `bitmapHasAny`. [#5528](https://github.com/ClickHouse/ClickHouse/pull/5528) ([Жичан Ю](https://github.com/yuzhichang))
- Исправлена ошибка, при которой пул соединений репликации не повторял попытку разрешения имени хоста даже после очистки DNS-кеша. [#5534](https://github.com/ClickHouse/ClickHouse/pull/5534) ([alesapin](https://github.com/alesapin))
- Исправлен запрос `DROP INDEX IF EXISTS`. Теперь запрос `ALTER TABLE ... DROP INDEX IF EXISTS ...` не вызывает исключение, если указанный индекс не существует. [#5524](https://github.com/ClickHouse/ClickHouse/pull/5524) ([Глеб Новиков](https://github.com/NanoBjorn))
- Исправлена обработка супертипов столбцов в union all. Устранены случаи несогласованности данных и типов столбцов в результирующих столбцах. [#5503](https://github.com/ClickHouse/ClickHouse/pull/5503) ([Артём Зуйков](https://github.com/4ertus2))
- Ошибка ZNONODE теперь игнорируется при обработке DDL-запросов. Ранее, если другой узел удалял znode из очереди задач, узел, который ещё не обработал его, но уже получил список дочерних элементов, завершал поток DDLWorker. [#5489](https://github.com/ClickHouse/ClickHouse/pull/5489) ([Азат Хужин](https://github.com/azat))
- Исправлена операция INSERT в таблицы Distributed() со столбцами MATERIALIZED. [#5429](https://github.com/ClickHouse/ClickHouse/pull/5429) ([Азат Хужин](https://github.com/azat))

### Релиз ClickHouse 19.7.3.9, 2019-05-30 {#clickhouse-release-19-7-3-9-2019-05-30}

#### Новые возможности {#new-features-2}


- Возможность ограничения диапазона значений настройки, которую может указать пользователь.
  Эти ограничения можно задать в профиле пользовательских настроек.
  [#4931](https://github.com/ClickHouse/ClickHouse/pull/4931) ([Vitaly
  Baranov](https://github.com/vitlibar))
- Добавлена вторая версия функции `groupUniqArray` с необязательным
  параметром `max_size`, ограничивающим размер результирующего массива. Это
  поведение аналогично функции `groupArray(max_size)(x)`.
  [#5026](https://github.com/ClickHouse/ClickHouse/pull/5026) ([Guillaume
  Tassery](https://github.com/YiuRULE))
- Для входных форматов файлов TSVWithNames/CSVWithNames порядок столбцов теперь можно
  определить из заголовка файла. Это управляется
  параметром `input_format_with_names_use_header`.
  [#5081](https://github.com/ClickHouse/ClickHouse/pull/5081)
  ([Alexander](https://github.com/Akazz))

#### Исправления ошибок {#bug-fixes-2}

- Сбой при использовании uncompressed_cache + JOIN во время слияния (#5197)
  [#5133](https://github.com/ClickHouse/ClickHouse/pull/5133) ([Danila
  Kutenin](https://github.com/danlark1))
- Ошибка сегментации при запросе clickhouse-client к системным таблицам. #5066
  [#5127](https://github.com/ClickHouse/ClickHouse/pull/5127)
  ([Ivan](https://github.com/abyss7))
- Потеря данных при высокой нагрузке через KafkaEngine (#4736)
  [#5080](https://github.com/ClickHouse/ClickHouse/pull/5080)
  ([Ivan](https://github.com/abyss7))
- Исправлено очень редкое состояние гонки данных, которое могло возникать при выполнении запроса с UNION ALL, включающего как минимум два SELECT из system.columns, system.tables, system.parts, system.parts_tables или таблиц семейства Merge, при одновременном выполнении ALTER столбцов связанных таблиц. [#5189](https://github.com/ClickHouse/ClickHouse/pull/5189) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### Улучшения производительности {#performance-improvements-1}

- Использование поразрядной сортировки для сортировки по одному числовому столбцу в `ORDER BY` без
  `LIMIT`. [#5106](https://github.com/ClickHouse/ClickHouse/pull/5106),
  [#4439](https://github.com/ClickHouse/ClickHouse/pull/4439)
  ([Evgenii Pravda](https://github.com/kvinty),
  [alexey-milovidov](https://github.com/alexey-milovidov))

#### Документация {#documentation-1}

- Перевод документации для некоторых движков таблиц на китайский язык.
  [#5107](https://github.com/ClickHouse/ClickHouse/pull/5107),
  [#5094](https://github.com/ClickHouse/ClickHouse/pull/5094),
  [#5087](https://github.com/ClickHouse/ClickHouse/pull/5087)
  ([张风啸](https://github.com/AlexZFX)),
  [#5068](https://github.com/ClickHouse/ClickHouse/pull/5068) ([never
  lee](https://github.com/neverlee))

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvements-1}


- Корректный вывод символов UTF-8 в `clickhouse-test`.
    [#5084](https://github.com/ClickHouse/ClickHouse/pull/5084)
    ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлен параметр командной строки для clickhouse-client для постоянной загрузки
    данных подсказок. [#5102](https://github.com/ClickHouse/ClickHouse/pull/5102)
    ([alexey-milovidov](https://github.com/alexey-milovidov))
- Устранена часть предупреждений PVS-Studio.
    [#5082](https://github.com/ClickHouse/ClickHouse/pull/5082)
    ([alexey-milovidov](https://github.com/alexey-milovidov))
- Обновлён LZ4 [#5040](https://github.com/ClickHouse/ClickHouse/pull/5040) ([Danila
    Kutenin](https://github.com/danlark1))
- Добавлен gperf в зависимости для сборки для предстоящего pull request #5030.
    [#5110](https://github.com/ClickHouse/ClickHouse/pull/5110)
    ([proller](https://github.com/proller))



## Релиз ClickHouse 19.6 {#clickhouse-release-19-6}

### Релиз ClickHouse 19.6.3.18, 2019-06-13 {#clickhouse-release-19-6-3-18-2019-06-13}

#### Исправления ошибок {#bug-fixes-3}

- Исправлено проталкивание условия IN для запросов из табличных функций `mysql` и `odbc` и соответствующих движков таблиц. Это исправляет #3540 и #2384. [#5313](https://github.com/ClickHouse/ClickHouse/pull/5313) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена взаимоблокировка в Zookeeper. [#5297](https://github.com/ClickHouse/ClickHouse/pull/5297) ([github1youlc](https://github.com/github1youlc))
- Разрешены десятичные числа в кавычках в CSV. [#5284](https://github.com/ClickHouse/ClickHouse/pull/5284) ([Artem Zuikov](https://github.com/4ertus2)
- Запрещено преобразование из float Inf/NaN в Decimals (выбрасывается исключение). [#5282](https://github.com/ClickHouse/ClickHouse/pull/5282) ([Artem Zuikov](https://github.com/4ertus2))
- Исправлено состояние гонки в запросе rename. [#5247](https://github.com/ClickHouse/ClickHouse/pull/5247) ([Winter Zhang](https://github.com/zhang2014))
- Временно отключен LFAlloc. Использование LFAlloc может привести к большому количеству MAP_FAILED при выделении UncompressedCache и, как следствие, к сбоям запросов на серверах с высокой нагрузкой. [cfdba93](https://github.com/ClickHouse/ClickHouse/commit/cfdba938ce22f16efeec504f7f90206a515b1280)([Danila Kutenin](https://github.com/danlark1))

### Релиз ClickHouse 19.6.2.11, 2019-05-13 {#clickhouse-release-19-6-2-11-2019-05-13}

#### Новые возможности {#new-features-3}

- Выражения TTL для столбцов и таблиц. [#4212](https://github.com/ClickHouse/ClickHouse/pull/4212) ([Anton Popov](https://github.com/CurtizJ))
- Добавлена поддержка сжатия `brotli` для HTTP-ответов (Accept-Encoding: br) [#4388](https://github.com/ClickHouse/ClickHouse/pull/4388) ([Mikhail](https://github.com/fandyushin))
- Добавлена новая функция `isValidUTF8` для проверки корректности кодирования набора байтов в utf-8. [#4934](https://github.com/ClickHouse/ClickHouse/pull/4934) ([Danila Kutenin](https://github.com/danlark1))
- Добавлена новая политика балансировки нагрузки `first_or_random`, которая отправляет запросы на первый указанный хост, а если он недоступен — на случайные хосты шарда. Полезна для настройки топологии с перекрестной репликацией. [#5012](https://github.com/ClickHouse/ClickHouse/pull/5012) ([nvartolomei](https://github.com/nvartolomei))

#### Экспериментальные возможности {#experimental-features-1}

- Добавлена настройка `index_granularity_bytes` (адаптивная гранулярность индекса) для семейства таблиц MergeTree\*. [#4826](https://github.com/ClickHouse/ClickHouse/pull/4826) ([alesapin](https://github.com/alesapin))

#### Улучшения {#improvements-1}


- Добавлена поддержка неконстантных и отрицательных аргументов размера и длины для функции `substringUTF8`. [#4989](https://github.com/ClickHouse/ClickHouse/pull/4989) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Отключено проталкивание предикатов в правую таблицу при left join, в левую таблицу при right join и в обе таблицы при full join. Это исправляет неверные результаты JOIN в некоторых случаях. [#4846](https://github.com/ClickHouse/ClickHouse/pull/4846) ([Ivan](https://github.com/abyss7))
- `clickhouse-copier`: автоматическая загрузка конфигурации задачи из опции `--task-file` [#4876](https://github.com/ClickHouse/ClickHouse/pull/4876) ([proller](https://github.com/proller))
- Добавлен обработчик опечаток для фабрики движков таблиц и фабрики табличных функций. [#4891](https://github.com/ClickHouse/ClickHouse/pull/4891) ([Danila Kutenin](https://github.com/danlark1))
- Добавлена поддержка звёздочек и квалифицированных звёздочек для множественных соединений без подзапросов [#4898](https://github.com/ClickHouse/ClickHouse/pull/4898) ([Artem Zuikov](https://github.com/4ertus2))
- Сообщение об ошибке отсутствующего столбца сделано более понятным для пользователя. [#4915](https://github.com/ClickHouse/ClickHouse/pull/4915) ([Artem Zuikov](https://github.com/4ertus2))

#### Улучшения производительности {#performance-improvements-2}

- Значительное ускорение ASOF JOIN [#4924](https://github.com/ClickHouse/ClickHouse/pull/4924) ([Martijn Bakker](https://github.com/Gladdy))

#### Обратно несовместимые изменения {#backward-incompatible-changes}

- HTTP-заголовок `Query-Id` переименован в `X-ClickHouse-Query-Id` для единообразия. [#4972](https://github.com/ClickHouse/ClickHouse/pull/4972) ([Mikhail](https://github.com/fandyushin))

#### Исправления ошибок {#bug-fixes-4}

- Исправлено потенциальное разыменование нулевого указателя в `clickhouse-copier`. [#4900](https://github.com/ClickHouse/ClickHouse/pull/4900) ([proller](https://github.com/proller))
- Исправлена ошибка в запросах с JOIN + ARRAY JOIN [#4938](https://github.com/ClickHouse/ClickHouse/pull/4938) ([Artem Zuikov](https://github.com/4ertus2))
- Исправлено зависание при запуске сервера, когда словарь зависит от другого словаря через базу данных с движком Dictionary. [#4962](https://github.com/ClickHouse/ClickHouse/pull/4962) ([Vitaly Baranov](https://github.com/vitlibar))
- Частичное исправление distributed_product_mode = local. Теперь возможно использовать столбцы локальных таблиц в where/having/order by/... через алиасы таблиц. Выбрасывается исключение, если таблица не имеет алиаса. Доступ к столбцам без алиасов таблиц пока невозможен. [#4986](https://github.com/ClickHouse/ClickHouse/pull/4986) ([Artem Zuikov](https://github.com/4ertus2))
- Исправлен потенциально неверный результат для `SELECT DISTINCT` с `JOIN` [#5001](https://github.com/ClickHouse/ClickHouse/pull/5001) ([Artem Zuikov](https://github.com/4ertus2))
- Исправлено очень редкое состояние гонки данных, которое могло возникнуть при выполнении запроса с UNION ALL, включающего как минимум два SELECT из system.columns, system.tables, system.parts, system.parts_tables или таблиц семейства Merge, при одновременном выполнении ALTER столбцов связанных таблиц. [#5189](https://github.com/ClickHouse/ClickHouse/pull/5189) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvements-2}


- Исправлены падения тестов при запуске clickhouse-server на другом хосте [#4713](https://github.com/ClickHouse/ClickHouse/pull/4713) ([Vasily Nemkov](https://github.com/Enmk))
- clickhouse-test: отключены управляющие последовательности цвета в среде без tty. [#4937](https://github.com/ClickHouse/ClickHouse/pull/4937) ([alesapin](https://github.com/alesapin))
- clickhouse-test: разрешено использовать любую тестовую базу данных (удалена квалификация `test.` там, где это возможно) [#5008](https://github.com/ClickHouse/ClickHouse/pull/5008) ([proller](https://github.com/proller))
- Исправлены ошибки ubsan [#5037](https://github.com/ClickHouse/ClickHouse/pull/5037) ([Vitaly Baranov](https://github.com/vitlibar))
- В ClickHouse добавлен Yandex LFAlloc для выделения данных MarkCache и UncompressedCache разными способами, чтобы надёжнее отлавливать segfault-ы [#4995](https://github.com/ClickHouse/ClickHouse/pull/4995) ([Danila Kutenin](https://github.com/danlark1))
- Утилита на Python для помощи с бэкпортами и списками изменений. [#4949](https://github.com/ClickHouse/ClickHouse/pull/4949) ([Ivan](https://github.com/abyss7))



## Релиз ClickHouse 19.5 {#clickhouse-release-19-5}

### Релиз ClickHouse 19.5.4.22, 2019-05-13 {#clickhouse-release-19-5-4-22-2019-05-13}

#### Исправления ошибок {#bug-fixes-5}

- Исправлено возможное аварийное завершение работы в функциях bitmap\* [#5220](https://github.com/ClickHouse/ClickHouse/pull/5220) [#5228](https://github.com/ClickHouse/ClickHouse/pull/5228) ([Andy Yang](https://github.com/andyyzh))
- Исправлено очень редкое состояние гонки данных, которое могло возникать при выполнении запроса с UNION ALL, включающего как минимум два SELECT из system.columns, system.tables, system.parts, system.parts_tables или таблиц семейства Merge, и одновременном выполнении ALTER столбцов связанных таблиц. [#5189](https://github.com/ClickHouse/ClickHouse/pull/5189) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена ошибка `Set for IN is not created yet in case of using single LowCardinality column in the left part of IN`. Эта ошибка возникала, если столбец LowCardinality являлся частью первичного ключа. #5031 [#5154](https://github.com/ClickHouse/ClickHouse/pull/5154) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Изменение функции retention: если строка удовлетворяла как первому, так и N-му условию, в состояние данных добавлялось только первое выполненное условие. Теперь все условия, которые выполняются для строки данных, добавляются в состояние данных. [#5119](https://github.com/ClickHouse/ClickHouse/pull/5119) ([小路](https://github.com/nicelulu))

### Релиз ClickHouse 19.5.3.8, 2019-04-18 {#clickhouse-release-19-5-3-8-2019-04-18}

#### Исправления ошибок {#bug-fixes-6}

- Исправлен тип настройки `max_partitions_per_insert_block` с boolean на UInt64. [#5028](https://github.com/ClickHouse/ClickHouse/pull/5028) ([Mohammad Hossein Sekhavat](https://github.com/mhsekhavat))

### Релиз ClickHouse 19.5.2.6, 2019-04-15 {#clickhouse-release-19-5-2-6-2019-04-15}

#### Новые возможности {#new-features-4}


- [Hyperscan](https://github.com/intel/hyperscan) добавлено сопоставление с несколькими регулярными выражениями (функции `multiMatchAny`, `multiMatchAnyIndex`, `multiFuzzyMatchAny`, `multiFuzzyMatchAnyIndex`). [#4780](https://github.com/ClickHouse/ClickHouse/pull/4780), [#4841](https://github.com/ClickHouse/ClickHouse/pull/4841) ([Danila Kutenin](https://github.com/danlark1))
- Добавлена функция `multiSearchFirstPosition`. [#4780](https://github.com/ClickHouse/ClickHouse/pull/4780) ([Danila Kutenin](https://github.com/danlark1))
- Реализован предопределённый фильтр выражений для каждой строки таблицы. [#4792](https://github.com/ClickHouse/ClickHouse/pull/4792) ([Ivan](https://github.com/abyss7))
- Новый тип индексов пропуска данных на основе фильтров Блума (может использоваться для функций `equal`, `in` и `like`). [#4499](https://github.com/ClickHouse/ClickHouse/pull/4499) ([Nikita Vasilev](https://github.com/nikvas0))
- Добавлен `ASOF JOIN`, который позволяет выполнять запросы с объединением по последнему известному значению. [#4774](https://github.com/ClickHouse/ClickHouse/pull/4774) [#4867](https://github.com/ClickHouse/ClickHouse/pull/4867) [#4863](https://github.com/ClickHouse/ClickHouse/pull/4863) [#4875](https://github.com/ClickHouse/ClickHouse/pull/4875) ([Martijn Bakker](https://github.com/Gladdy), [Artem Zuikov](https://github.com/4ertus2))
- Переписывание множественных `COMMA JOIN` в `CROSS JOIN`. Затем переписывание их в `INNER JOIN`, если это возможно. [#4661](https://github.com/ClickHouse/ClickHouse/pull/4661) ([Artem Zuikov](https://github.com/4ertus2))

#### Улучшения {#improvement-9}


- `topK` и `topKWeighted` теперь поддерживают настраиваемый `loadFactor` (исправляет проблему [#4252](https://github.com/ClickHouse/ClickHouse/issues/4252)). [#4634](https://github.com/ClickHouse/ClickHouse/pull/4634) ([Kirill Danshin](https://github.com/kirillDanshin))
- Разрешено использование `parallel_replicas_count > 1` даже для таблиц без сэмплирования (для них эта настройка просто игнорируется). В предыдущих версиях это приводило к исключению. [#4637](https://github.com/ClickHouse/ClickHouse/pull/4637) ([Alexey Elymanov](https://github.com/digitalist))
- Поддержка `CREATE OR REPLACE VIEW`. Позволяет создать представление или задать новое определение в одном операторе. [#4654](https://github.com/ClickHouse/ClickHouse/pull/4654) ([Boris Granveaud](https://github.com/bgranvea))
- Движок таблиц `Buffer` теперь поддерживает `PREWHERE`. [#4671](https://github.com/ClickHouse/ClickHouse/pull/4671) ([Yangkuan Liu](https://github.com/LiuYangkuan))
- Добавлена возможность запуска реплицируемой таблицы без метаданных в zookeeper в режиме `readonly`. [#4691](https://github.com/ClickHouse/ClickHouse/pull/4691) ([alesapin](https://github.com/alesapin))
- Исправлено мерцание индикатора прогресса в clickhouse-client. Проблема была наиболее заметна при использовании `FORMAT Null` с потоковыми запросами. [#4811](https://github.com/ClickHouse/ClickHouse/pull/4811) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлена возможность отключения функций с библиотекой `hyperscan` для отдельных пользователей с целью ограничения потенциально чрезмерного и неконтролируемого использования ресурсов. [#4816](https://github.com/ClickHouse/ClickHouse/pull/4816) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлено логирование номера версии во всех ошибках. [#4824](https://github.com/ClickHouse/ClickHouse/pull/4824) ([proller](https://github.com/proller))
- Добавлено ограничение для функций `multiMatch`, требующее, чтобы размер строки помещался в `unsigned int`. Также добавлено ограничение на количество аргументов для функций `multiSearch`. [#4834](https://github.com/ClickHouse/ClickHouse/pull/4834) ([Danila Kutenin](https://github.com/danlark1))
- Улучшено использование временного пространства и обработка ошибок в Hyperscan. [#4866](https://github.com/ClickHouse/ClickHouse/pull/4866) ([Danila Kutenin](https://github.com/danlark1))
- Заполнение `system.graphite_detentions` из конфигурации таблиц движка `*GraphiteMergeTree`. [#4584](https://github.com/ClickHouse/ClickHouse/pull/4584) ([Mikhail f. Shiryaev](https://github.com/Felixoid))
- Переименование функции `trigramDistance` в `ngramDistance` и добавление дополнительных функций с `CaseInsensitive` и `UTF`. [#4602](https://github.com/ClickHouse/ClickHouse/pull/4602) ([Danila Kutenin](https://github.com/danlark1))
- Улучшен расчет индексов пропуска данных. [#4640](https://github.com/ClickHouse/ClickHouse/pull/4640) ([Nikita Vasilev](https://github.com/nikvas0))
- Обычные столбцы, `DEFAULT`, `MATERIALIZED` и `ALIAS` теперь хранятся в едином списке (исправляет проблему [#2867](https://github.com/ClickHouse/ClickHouse/issues/2867)). [#4707](https://github.com/ClickHouse/ClickHouse/pull/4707) ([Alex Zatelepin](https://github.com/ztlpn))

#### Исправление ошибок {#bug-fix-26}


* Избегается вызов `std::terminate` при ошибке выделения памяти. Теперь, как и ожидается, выбрасывается исключение `std::bad_alloc`. [#4665](https://github.com/ClickHouse/ClickHouse/pull/4665) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлено чтение `capnproto` из буфера. Иногда файлы не удавалось загрузить по HTTP. [#4674](https://github.com/ClickHouse/ClickHouse/pull/4674) ([Vladislav](https://github.com/smirnov-vs))
* Исправлена ошибка `Unknown log entry type: 0`, возникающая после выполнения запроса `OPTIMIZE TABLE FINAL`. [#4683](https://github.com/ClickHouse/ClickHouse/pull/4683) ([Amos Bird](https://github.com/amosbird))
* Неправильные аргументы функций `hasAny` или `hasAll` могут привести к ошибке сегментации (segfault). [#4698](https://github.com/ClickHouse/ClickHouse/pull/4698) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Во время выполнения запроса `DROP DATABASE dictionary` может возникнуть взаимная блокировка. [#4701](https://github.com/ClickHouse/ClickHouse/pull/4701) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлено неопределённое поведение функций `median` и `quantile`. [#4702](https://github.com/ClickHouse/ClickHouse/pull/4702) ([hcz](https://github.com/hczhcz))
* Исправлено определение уровня сжатия, когда `network_compression_method` указан в нижнем регистре. Сломано в v19.1. [#4706](https://github.com/ClickHouse/ClickHouse/pull/4706) ([proller](https://github.com/proller))
* Исправлено игнорирование настройки `<timezone>UTC</timezone>` (устраняет проблему [#4658](https://github.com/ClickHouse/ClickHouse/issues/4658)). [#4718](https://github.com/ClickHouse/ClickHouse/pull/4718) ([proller](https://github.com/proller))
* Исправлено поведение функции `histogram` для таблиц `Distributed`. [#4741](https://github.com/ClickHouse/ClickHouse/pull/4741) ([olegkv](https://github.com/olegkv))
* Исправлено предупреждение tsan `destroy of a locked mutex`. [#4742](https://github.com/ClickHouse/ClickHouse/pull/4742) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлен отчёт TSan при завершении работы из-за гонки при использовании системных логов. Исправлено потенциальное use-after-free при завершении работы, когда включён `part_log`. [#4758](https://github.com/ClickHouse/ClickHouse/pull/4758) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена повторная проверка частей в `ReplicatedMergeTreeAlterThread` в случае ошибки. [#4772](https://github.com/ClickHouse/ClickHouse/pull/4772) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Арифметические операции над промежуточными состояниями агрегатных функций не работали для константных аргументов (например, результатов подзапросов). [#4776](https://github.com/ClickHouse/ClickHouse/pull/4776) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Всегда заключайте имена столбцов в обратные кавычки в метаданных. Иначе невозможно создать таблицу со столбцом с именем `index` (сервер не перезапустится из‑за некорректного запроса `ATTACH` в метаданных). [#4782](https://github.com/ClickHouse/ClickHouse/pull/4782) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлен сбой при выполнении `ALTER ... MODIFY ORDER BY` для таблицы `Distributed`. [#4790](https://github.com/ClickHouse/ClickHouse/pull/4790) ([TCeason](https://github.com/TCeason))
* Исправлена ошибка сегментации в `JOIN ON` при включённом параметре `enable_optimize_predicate_expression`. [#4794](https://github.com/ClickHouse/ClickHouse/pull/4794) ([Winter Zhang](https://github.com/zhang2014))
* Исправлена ошибка, из-за которой после обработки protobuf‑сообщения из Kafka добавлялась лишняя строка. [#4808](https://github.com/ClickHouse/ClickHouse/pull/4808) ([Vitaly Baranov](https://github.com/vitlibar))
* Исправлен сбой `JOIN` при сравнении not-nullable и nullable столбцов. Исправлена обработка значений `NULL` в правых ключах в `ANY JOIN` при включённом `join_use_nulls`. [#4815](https://github.com/ClickHouse/ClickHouse/pull/4815) ([Artem Zuikov](https://github.com/4ertus2))
* Исправлена ошибка сегментации в `clickhouse-copier`. [#4835](https://github.com/ClickHouse/ClickHouse/pull/4835) ([proller](https://github.com/proller))
* Исправлена гонка при выполнении `SELECT` из `system.tables`, если таблица одновременно переименовывается или модифицируется. [#4836](https://github.com/ClickHouse/ClickHouse/pull/4836) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена гонка данных при выборке части данных, которая уже устарела. [#4839](https://github.com/ClickHouse/ClickHouse/pull/4839) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена редкая гонка данных, которая могла возникать при выполнении `RENAME` таблицы семейства MergeTree. [#4844](https://github.com/ClickHouse/ClickHouse/pull/4844) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена ошибка сегментации в функции `arrayIntersect`. Ошибка могла возникать, если функция вызывалась с сочетанием константных и обычных аргументов. [#4847](https://github.com/ClickHouse/ClickHouse/pull/4847) ([Lixiang Qian](https://github.com/fancyqlx))
* Исправлено чтение из столбца типа `Array(LowCardinality)` в редком случае, когда он содержал длинную последовательность пустых массивов. [#4850](https://github.com/ClickHouse/ClickHouse/pull/4850) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Исправлен сбой в `FULL/RIGHT JOIN` при соединении nullable и non-nullable столбцов. [#4855](https://github.com/ClickHouse/ClickHouse/pull/4855) ([Artem Zuikov](https://github.com/4ertus2))
* Исправлена ошибка `No message received` при получении кусков между репликами. [#4856](https://github.com/ClickHouse/ClickHouse/pull/4856) ([alesapin](https://github.com/alesapin))
* Исправлен неверный результат функции `arrayIntersect` при наличии нескольких повторяющихся значений в одном массиве. [#4871](https://github.com/ClickHouse/ClickHouse/pull/4871) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Исправлено состояние гонки при одновременном выполнении запросов `ALTER COLUMN`, которое могло приводить к сбою сервера (исправляет проблему [#3421](https://github.com/ClickHouse/ClickHouse/issues/3421)). [#4592](https://github.com/ClickHouse/ClickHouse/pull/4592) ([Alex Zatelepin](https://github.com/ztlpn))
* Исправлен некорректный результат в `FULL/RIGHT JOIN` с константным столбцом. [#4723](https://github.com/ClickHouse/ClickHouse/pull/4723) ([Artem Zuikov](https://github.com/4ertus2))
* Исправлено устранение дубликатов в `GLOBAL JOIN` при использовании звёздочки. [#4705](https://github.com/ClickHouse/ClickHouse/pull/4705) ([Artem Zuikov](https://github.com/4ertus2))
* Исправлена дедукция параметров в `ALTER MODIFY` столбца `CODEC`, когда тип столбца не указан. [#4883](https://github.com/ClickHouse/ClickHouse/pull/4883) ([alesapin](https://github.com/alesapin))
* Функции `cutQueryStringAndFragment()` и `queryStringAndFragment()` теперь корректно работают, когда `URL` содержит фрагмент, но не содержит строки запроса. [#4894](https://github.com/ClickHouse/ClickHouse/pull/4894) ([Vitaly Baranov](https://github.com/vitlibar))
* Исправлена редкая ошибка при `min_bytes_to_use_direct_io` больше нуля, которая возникает, когда потоку необходимо выполнить обратное перемещение (seek backward) в файловом столбце. [#4897](https://github.com/ClickHouse/ClickHouse/pull/4897) ([alesapin](https://github.com/alesapin))
* Исправлены некорректные типы аргументов для агрегатных функций с аргументами `LowCardinality` (исправляет проблему [#4919](https://github.com/ClickHouse/ClickHouse/issues/4919)). [#4922](https://github.com/ClickHouse/ClickHouse/pull/4922) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Исправлена некорректная квалификация имени в `GLOBAL JOIN`. [#4969](https://github.com/ClickHouse/ClickHouse/pull/4969) ([Artem Zuikov](https://github.com/4ertus2))
* Исправлен результат работы функции `toISOWeek` для 1970 года. [#4988](https://github.com/ClickHouse/ClickHouse/pull/4988) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлено дублирование запросов `DROP`, `TRUNCATE` и `OPTIMIZE` при выполнении с `ON CLUSTER` для семейства таблиц `ReplicatedMergeTree*`. [#4991](https://github.com/ClickHouse/ClickHouse/pull/4991) ([alesapin](https://github.com/alesapin))

#### Обратно несовместимые изменения {#backward-incompatible-change-8}

- Настройка `insert_sample_with_metadata` переименована в `input_format_defaults_for_omitted_fields`. [#4771](https://github.com/ClickHouse/ClickHouse/pull/4771) ([Artem Zuikov](https://github.com/4ertus2))
- Добавлена настройка `max_partitions_per_insert_block` (по умолчанию 100). Если вставляемый блок содержит больше партиций, выбрасывается исключение. Установите значение 0, чтобы снять ограничение (не рекомендуется). [#4845](https://github.com/ClickHouse/ClickHouse/pull/4845) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Функции множественного поиска переименованы (`multiPosition` в `multiSearchAllPositions`, `multiSearch` в `multiSearchAny`, `firstMatch` в `multiSearchFirstIndex`). [#4780](https://github.com/ClickHouse/ClickHouse/pull/4780) ([Danila Kutenin](https://github.com/danlark1))

#### Улучшения производительности {#performance-improvement-6}

- Оптимизирован алгоритм поиска Volnitsky за счет встраивания функций, что дает прирост производительности поиска примерно на 5-10% для запросов с большим количеством искомых подстрок или похожих биграмм. [#4862](https://github.com/ClickHouse/ClickHouse/pull/4862) ([Danila Kutenin](https://github.com/danlark1))
- Исправлена проблема производительности при значении настройки `use_uncompressed_cache` больше нуля, которая возникала, когда все читаемые данные находились в кеше. [#4913](https://github.com/ClickHouse/ClickHouse/pull/4913) ([alesapin](https://github.com/alesapin))

#### Улучшения сборки, тестирования и пакетирования {#buildtestingpackaging-improvement-10}


- Ужесточённая отладочная сборка: более детализированные отображения памяти и ASLR; добавлена защита памяти для кэша меток и индекса. Это позволяет находить больше ошибок порчи памяти в случаях, когда ASan и MSan не могут этого сделать. [#4632](https://github.com/ClickHouse/ClickHouse/pull/4632) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлена поддержка переменных CMake `ENABLE_PROTOBUF`, `ENABLE_PARQUET` и `ENABLE_BROTLI`, что позволяет включать/выключать перечисленные выше возможности (так же, как это можно делать для librdkafka, MySQL и т. д.). [#4669](https://github.com/ClickHouse/ClickHouse/pull/4669) ([Silviu Caragea](https://github.com/silviucpp))
- Добавлена возможность выводить список процессов и stacktrace всех потоков, если какие‑то запросы зависли после выполнения теста. [#4675](https://github.com/ClickHouse/ClickHouse/pull/4675) ([alesapin](https://github.com/alesapin))
- Добавлены повторные попытки при ошибке `Connection loss` в `clickhouse-test`. [#4682](https://github.com/ClickHouse/ClickHouse/pull/4682) ([alesapin](https://github.com/alesapin))
- В скрипт сборки пакетов добавлена сборка для FreeBSD с использованием Vagrant и сборка с Thread Sanitizer. [#4712](https://github.com/ClickHouse/ClickHouse/pull/4712) [#4748](https://github.com/ClickHouse/ClickHouse/pull/4748) ([alesapin](https://github.com/alesapin))
- Теперь во время установки у пользователя запрашивается пароль для пользователя `'default'`. [#4725](https://github.com/ClickHouse/ClickHouse/pull/4725) ([proller](https://github.com/proller))
- Подавлено предупреждение в библиотеке `rdkafka`. [#4740](https://github.com/ClickHouse/ClickHouse/pull/4740) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлена возможность собирать без SSL. [#4750](https://github.com/ClickHouse/ClickHouse/pull/4750) ([proller](https://github.com/proller))
- Добавлена возможность запускать образ clickhouse-server от произвольного пользователя. [#4753](https://github.com/ClickHouse/ClickHouse/pull/4753) ([Mikhail f. Shiryaev](https://github.com/Felixoid))
- Обновлён contrib boost до версии 1.69. [#4793](https://github.com/ClickHouse/ClickHouse/pull/4793) ([proller](https://github.com/proller))
- Отключено использование `mremap` при компиляции с Thread Sanitizer. Как ни странно, TSan не перехватывает `mremap` (хотя перехватывает `mmap`, `munmap`), что приводило к ложным срабатываниям. Исправлен отчёт TSan в stateful‑тестах. [#4859](https://github.com/ClickHouse/ClickHouse/pull/4859) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлен тест, проверяющий использование format schema через HTTP‑интерфейс. [#4864](https://github.com/ClickHouse/ClickHouse/pull/4864) ([Vitaly Baranov](https://github.com/vitlibar))



## Релиз ClickHouse 19.4 {#clickhouse-release-19-4}

### Релиз ClickHouse 19.4.4.33, 2019-04-17 {#clickhouse-release-19-4-4-33-2019-04-17}

#### Исправление ошибок {#bug-fixes-7}


* Избегайте вызова `std::terminate` в случае ошибки выделения памяти. Теперь исключение `std::bad_alloc` генерируется, как и ожидалось. [#4665](https://github.com/ClickHouse/ClickHouse/pull/4665) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлено чтение `capnproto` из буфера. Иногда файлы не удавалось загрузить по HTTP. [#4674](https://github.com/ClickHouse/ClickHouse/pull/4674) ([Vladislav](https://github.com/smirnov-vs))
* Исправлена ошибка `Unknown log entry type: 0`, возникавшая после выполнения запроса `OPTIMIZE TABLE FINAL`. [#4683](https://github.com/ClickHouse/ClickHouse/pull/4683) ([Amos Bird](https://github.com/amosbird))
* Неверные аргументы функций `hasAny` или `hasAll` могут привести к segfault. [#4698](https://github.com/ClickHouse/ClickHouse/pull/4698) ([alexey-milovidov](https://github.com/alexey-milovidov))
* При выполнении запроса `DROP DATABASE dictionary` может произойти взаимоблокировка. [#4701](https://github.com/ClickHouse/ClickHouse/pull/4701) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлено неопределённое поведение в функциях `median` и `quantile`. [#4702](https://github.com/ClickHouse/ClickHouse/pull/4702) ([hcz](https://github.com/hczhcz))
* Исправлено определение уровня сжатия, когда `network_compression_method` указан в нижнем регистре. Ошибка появилась в v19.1. [#4706](https://github.com/ClickHouse/ClickHouse/pull/4706) ([proller](https://github.com/proller))
* Исправлено игнорирование настройки `<timezone>UTC</timezone>` (устраняет проблему [#4658](https://github.com/ClickHouse/ClickHouse/issues/4658)). [#4718](https://github.com/ClickHouse/ClickHouse/pull/4718) ([proller](https://github.com/proller))
* Исправлено поведение функции `histogram` с таблицами `Distributed`. [#4741](https://github.com/ClickHouse/ClickHouse/pull/4741) ([olegkv](https://github.com/olegkv))
* Исправлено сообщение tsan `destroy of a locked mutex`. [#4742](https://github.com/ClickHouse/ClickHouse/pull/4742) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлен отчёт TSan при завершении работы из-за гонки при использовании системных логов. Исправлено потенциальное use-after-free при завершении работы, когда включён `part_log`. [#4758](https://github.com/ClickHouse/ClickHouse/pull/4758) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена повторная перепроверка партиций в `ReplicatedMergeTreeAlterThread` в случае ошибки. [#4772](https://github.com/ClickHouse/ClickHouse/pull/4772) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Арифметические операции над промежуточными состояниями агрегатных функций не работали для константных аргументов (например, результатов подзапросов). [#4776](https://github.com/ClickHouse/ClickHouse/pull/4776) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Всегда заключайте имена столбцов в обратные кавычки в метаданных. В противном случае невозможно создать таблицу со столбцом с именем `index` (сервер не перезапустится из‑за некорректного запроса `ATTACH` в метаданных). [#4782](https://github.com/ClickHouse/ClickHouse/pull/4782) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлен сбой при выполнении `ALTER ... MODIFY ORDER BY` на таблице `Distributed`. [#4790](https://github.com/ClickHouse/ClickHouse/pull/4790) ([TCeason](https://github.com/TCeason))
* Исправлена ошибка сегментации в `JOIN ON` при включённом параметре `enable_optimize_predicate_expression`. [#4794](https://github.com/ClickHouse/ClickHouse/pull/4794) ([Winter Zhang](https://github.com/zhang2014))
* Исправлена ошибка с добавлением лишней строки после чтения protobuf‑сообщения из Kafka. [#4808](https://github.com/ClickHouse/ClickHouse/pull/4808) ([Vitaly Baranov](https://github.com/vitlibar))
* Исправлен сбой из-за ошибки сегментации в `clickhouse-copier`. [#4835](https://github.com/ClickHouse/ClickHouse/pull/4835) ([proller](https://github.com/proller))
* Исправлена гонка состояний в `SELECT` из `system.tables`, возникавшая при одновременном переименовании или изменении таблицы. [#4836](https://github.com/ClickHouse/ClickHouse/pull/4836) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлено состояние гонки при выборке части данных, которая уже устарела. [#4839](https://github.com/ClickHouse/ClickHouse/pull/4839) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена редкая гонка данных, которая могла произойти во время операции `RENAME` таблицы семейства MergeTree. [#4844](https://github.com/ClickHouse/ClickHouse/pull/4844) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена ошибка сегментации в функции `arrayIntersect`. Ошибка сегментации могла возникать, если функция вызывалась с сочетанием константных и обычных аргументов. [#4847](https://github.com/ClickHouse/ClickHouse/pull/4847) ([Lixiang Qian](https://github.com/fancyqlx))
* Исправлено чтение из столбца `Array(LowCardinality)` в редком случае, когда столбец содержал длинную последовательность пустых массивов. [#4850](https://github.com/ClickHouse/ClickHouse/pull/4850) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Исправлено исключение `No message received` при получении партиций между репликами. [#4856](https://github.com/ClickHouse/ClickHouse/pull/4856) ([alesapin](https://github.com/alesapin))
* Исправлен неверный результат функции `arrayIntersect` при наличии нескольких повторяющихся значений в одном массиве. [#4871](https://github.com/ClickHouse/ClickHouse/pull/4871) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Исправлена гонка при одновременном выполнении запросов `ALTER COLUMN`, которая могла приводить к сбою сервера (исправлена проблема [#3421](https://github.com/ClickHouse/ClickHouse/issues/3421)). [#4592](https://github.com/ClickHouse/ClickHouse/pull/4592) ([Alex Zatelepin](https://github.com/ztlpn))
* Исправлено определение параметров в `ALTER MODIFY` для кодека столбца (`CODEC`), когда тип столбца не указан. [#4883](https://github.com/ClickHouse/ClickHouse/pull/4883) ([alesapin](https://github.com/alesapin))
* Функции `cutQueryStringAndFragment()` и `queryStringAndFragment()` теперь корректно работают, когда `URL` содержит фрагмент, но не содержит строки запроса. [#4894](https://github.com/ClickHouse/ClickHouse/pull/4894) ([Vitaly Baranov](https://github.com/vitlibar))
* Исправлена редкая ошибка при установке `min_bytes_to_use_direct_io` больше нуля, которая проявлялась, когда потоку требовалось перейти назад в файловом столбце. [#4897](https://github.com/ClickHouse/ClickHouse/pull/4897) ([alesapin](https://github.com/alesapin))
* Исправлены некорректные типы аргументов агрегатных функций с аргументами `LowCardinality` (исправляет проблему [#4919](https://github.com/ClickHouse/ClickHouse/issues/4919)). [#4922](https://github.com/ClickHouse/ClickHouse/pull/4922) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Исправлен результат функции `toISOWeek` для 1970 года. [#4988](https://github.com/ClickHouse/ClickHouse/pull/4988) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлено дублирование запросов `DROP`, `TRUNCATE` и `OPTIMIZE` при выполнении с `ON CLUSTER` для семейства таблиц `ReplicatedMergeTree*`. [#4991](https://github.com/ClickHouse/ClickHouse/pull/4991) ([alesapin](https://github.com/alesapin))

#### Улучшения {#improvements-2}

- Хранение обычных столбцов, а также столбцов `DEFAULT`, `MATERIALIZED` и `ALIAS` в едином списке (исправляет проблему [#2867](https://github.com/ClickHouse/ClickHouse/issues/2867)). [#4707](https://github.com/ClickHouse/ClickHouse/pull/4707) ([Alex Zatelepin](https://github.com/ztlpn))

### Релиз ClickHouse 19.4.3.11, 2019-04-02 {#clickhouse-release-19-4-3-11-2019-04-02}

#### Исправления ошибок {#bug-fixes-8}

- Исправлено падение в `FULL/RIGHT JOIN` при соединении nullable и not nullable столбцов. [#4855](https://github.com/ClickHouse/ClickHouse/pull/4855) ([Artem Zuikov](https://github.com/4ertus2))
- Исправлена ошибка сегментации в `clickhouse-copier`. [#4835](https://github.com/ClickHouse/ClickHouse/pull/4835) ([proller](https://github.com/proller))

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-11}

- Добавлена возможность запуска образа clickhouse-server от имени произвольного пользователя. [#4753](https://github.com/ClickHouse/ClickHouse/pull/4753) ([Mikhail f. Shiryaev](https://github.com/Felixoid))

### Релиз ClickHouse 19.4.2.7, 2019-03-30 {#clickhouse-release-19-4-2-7-2019-03-30}

#### Исправления ошибок {#bug-fixes-9}

- Исправлено чтение из столбца `Array(LowCardinality)` в редких случаях, когда столбец содержал длинную последовательность пустых массивов. [#4850](https://github.com/ClickHouse/ClickHouse/pull/4850) ([Nikolai Kochetov](https://github.com/KochetovNicolai))

### Релиз ClickHouse 19.4.1.3, 2019-03-19 {#clickhouse-release-19-4-1-3-2019-03-19}

#### Исправления ошибок {#bug-fixes-10}

- Исправлены удалённые запросы, содержащие одновременно `LIMIT BY` и `LIMIT`. Ранее, если в удалённом запросе использовались `LIMIT BY` и `LIMIT`, `LIMIT` мог выполняться до `LIMIT BY`, что приводило к избыточной фильтрации результата. [#4708](https://github.com/ClickHouse/ClickHouse/pull/4708) ([Constantin S. Pan](https://github.com/kvap))

### Релиз ClickHouse 19.4.0.49, 2019-03-09 {#clickhouse-release-19-4-0-49-2019-03-09}

#### Новые возможности {#new-features-5}


- Добавлена полная поддержка формата `Protobuf` (ввод и вывод, вложенные структуры данных). [#4174](https://github.com/ClickHouse/ClickHouse/pull/4174) [#4493](https://github.com/ClickHouse/ClickHouse/pull/4493) ([Vitaly Baranov](https://github.com/vitlibar))
- Добавлены функции для работы с битовыми картами на основе Roaring Bitmaps. [#4207](https://github.com/ClickHouse/ClickHouse/pull/4207) ([Andy Yang](https://github.com/andyyzh)) [#4568](https://github.com/ClickHouse/ClickHouse/pull/4568) ([Vitaly Baranov](https://github.com/vitlibar))
- Поддержка формата Parquet. [#4448](https://github.com/ClickHouse/ClickHouse/pull/4448) ([proller](https://github.com/proller))
- Добавлено расстояние N-грамм для нечёткого сравнения строк. Аналогично метрикам q-gram в языке R. [#4466](https://github.com/ClickHouse/ClickHouse/pull/4466) ([Danila Kutenin](https://github.com/danlark1))
- Объединение правил свёртки graphite из выделенных шаблонов агрегации и хранения. [#4426](https://github.com/ClickHouse/ClickHouse/pull/4426) ([Mikhail f. Shiryaev](https://github.com/Felixoid))
- Добавлены настройки `max_execution_speed` и `max_execution_speed_bytes` для ограничения использования ресурсов. Добавлена настройка `min_execution_speed_bytes` в дополнение к `min_execution_speed`. [#4430](https://github.com/ClickHouse/ClickHouse/pull/4430) ([Winter Zhang](https://github.com/zhang2014))
- Реализована функция `flatten`. [#4555](https://github.com/ClickHouse/ClickHouse/pull/4555) [#4409](https://github.com/ClickHouse/ClickHouse/pull/4409) ([alexey-milovidov](https://github.com/alexey-milovidov), [kzon](https://github.com/kzon))
- Добавлены функции `arrayEnumerateDenseRanked` и `arrayEnumerateUniqRanked` (аналогично `arrayEnumerateUniq`, но позволяют точно настроить глубину массива для анализа многомерных массивов). [#4475](https://github.com/ClickHouse/ClickHouse/pull/4475) ([proller](https://github.com/proller)) [#4601](https://github.com/ClickHouse/ClickHouse/pull/4601) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Множественные JOIN с некоторыми ограничениями: без звёздочек, без сложных псевдонимов в ON/WHERE/GROUP BY/… [#4462](https://github.com/ClickHouse/ClickHouse/pull/4462) ([Artem Zuikov](https://github.com/4ertus2))

#### Исправления ошибок {#bug-fixes-11}


* Этот релиз также включает все исправления ошибок из версий 19.3 и 19.1.
* Исправлена ошибка в индексах пропуска данных: порядок гранул после INSERT был некорректным. [#4407](https://github.com/ClickHouse/ClickHouse/pull/4407) ([Nikita Vasilev](https://github.com/nikvas0))
* Исправлен индекс `set` для столбцов типов `Nullable` и `LowCardinality`. Ранее индекс `set` для столбца типа `Nullable` или `LowCardinality` приводил к ошибке `Data type must be deserialized with multiple streams` при выполнении запроса `SELECT`. [#4594](https://github.com/ClickHouse/ClickHouse/pull/4594) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
* Корректное выставление update&#95;time при полном обновлении словаря типа `executable`. [#4551](https://github.com/ClickHouse/ClickHouse/pull/4551) ([Tema Novikov](https://github.com/temoon))
* Исправлена некорректная работа индикатора прогресса в версии 19.3. [#4627](https://github.com/ClickHouse/ClickHouse/pull/4627) ([filimonov](https://github.com/filimonov))
* Исправлены некорректные значения `MemoryTracker` при уменьшении области памяти в отдельных случаях. [#4619](https://github.com/ClickHouse/ClickHouse/pull/4619) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлено неопределённое поведение в `ThreadPool`. [#4612](https://github.com/ClickHouse/ClickHouse/pull/4612) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлен крайне редкий сбой с сообщением `mutex lock failed: Invalid argument`, который мог произойти при одновременном удалении таблицы MergeTree и выполнении запроса SELECT. [#4608](https://github.com/ClickHouse/ClickHouse/pull/4608) ([Alex Zatelepin](https://github.com/ztlpn))
* Совместимость ODBC-драйвера с типом данных `LowCardinality`. [#4381](https://github.com/ClickHouse/ClickHouse/pull/4381) ([proller](https://github.com/proller))
* FreeBSD: Исправление ошибки `AIOcontextPool: Found io_event with unknown id 0`. [#4438](https://github.com/ClickHouse/ClickHouse/pull/4438) ([urgordeadbeef](https://github.com/urgordeadbeef))
* Таблица `system.part_log` создавалась независимо от настроек. [#4483](https://github.com/ClickHouse/ClickHouse/pull/4483) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлено неопределённое поведение функции `dictIsIn` для кэш-словарей. [#4515](https://github.com/ClickHouse/ClickHouse/pull/4515) ([alesapin](https://github.com/alesapin))
* Исправлена взаимоблокировка, возникавшая, когда запрос SELECT несколько раз блокировал одну и ту же таблицу (например, из разных потоков или при выполнении нескольких подзапросов) при одновременном выполнении DDL‑запроса. [#4535](https://github.com/ClickHouse/ClickHouse/pull/4535) ([Alex Zatelepin](https://github.com/ztlpn))
* Отключить `compile_expressions` по умолчанию, пока у нас не появится собственный `llvm` в `contrib` и мы не сможем протестировать его с `clang` и `asan`. [#4579](https://github.com/ClickHouse/ClickHouse/pull/4579) ([alesapin](https://github.com/alesapin))
* Предотвращён вызов `std::terminate`, когда `invalidate_query` для внешнего словаря с источником `clickhouse` возвращал некорректный набор результатов (пустой, с более чем одной строкой или более чем одним столбцом). Исправлена проблема, при которой `invalidate_query` выполнялся каждые пять секунд независимо от значения `lifetime`. [#4583](https://github.com/ClickHouse/ClickHouse/pull/4583) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Избегается взаимная блокировка, когда `invalidate_query` для словаря с источником `clickhouse` затрагивал таблицу `system.dictionaries` или базу данных `Dictionaries` (редкий случай). [#4599](https://github.com/ClickHouse/ClickHouse/pull/4599) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправления для CROSS JOIN с пустым условием WHERE. [#4598](https://github.com/ClickHouse/ClickHouse/pull/4598) ([Artem Zuikov](https://github.com/4ertus2))
* Исправлена ошибка сегментации (segfault) в функции &quot;replicate&quot; при передаче константного аргумента. [#4603](https://github.com/ClickHouse/ClickHouse/pull/4603) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена работа оптимизатора предикатов с лямбда-функциями. [#4408](https://github.com/ClickHouse/ClickHouse/pull/4408) ([Winter Zhang](https://github.com/zhang2014))
* Множественные JOIN, множественные исправления. [#4595](https://github.com/ClickHouse/ClickHouse/pull/4595) ([Artem Zuikov](https://github.com/4ertus2))

#### Улучшения {#improvements-3}

- Поддержка псевдонимов в секции JOIN ON для столбцов правой таблицы. [#4412](https://github.com/ClickHouse/ClickHouse/pull/4412) ([Artem Zuikov](https://github.com/4ertus2))
- Результат множественных JOIN требует корректных имён результатов для использования в подзапросах. Замена плоских псевдонимов исходными именами в результате. [#4474](https://github.com/ClickHouse/ClickHouse/pull/4474) ([Artem Zuikov](https://github.com/4ertus2))
- Улучшена логика проталкивания предикатов для соединённых выражений. [#4387](https://github.com/ClickHouse/ClickHouse/pull/4387) ([Ivan](https://github.com/abyss7))

#### Улучшения производительности {#performance-improvements-3}

- Улучшена эвристика оптимизации «перемещение в PREWHERE». [#4405](https://github.com/ClickHouse/ClickHouse/pull/4405) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Использование корректных таблиц поиска, использующих API HashTable для 8-битных и 16-битных ключей. [#4536](https://github.com/ClickHouse/ClickHouse/pull/4536) ([Amos Bird](https://github.com/amosbird))
- Улучшена производительность сравнения строк. [#4564](https://github.com/ClickHouse/ClickHouse/pull/4564) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Очистка очереди распределённых DDL в отдельном потоке, чтобы не замедлять основной цикл обработки распределённых DDL-задач. [#4502](https://github.com/ClickHouse/ClickHouse/pull/4502) ([Alex Zatelepin](https://github.com/ztlpn))
- Когда `min_bytes_to_use_direct_io` установлен в 1, не каждый файл открывался в режиме O_DIRECT, поскольку размер данных для чтения иногда недооценивался на размер одного сжатого блока. [#4526](https://github.com/ClickHouse/ClickHouse/pull/4526) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-12}


- Добавлена поддержка clang-9 [#4604](https://github.com/ClickHouse/ClickHouse/pull/4604) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлены неверные инструкции `__asm__` (снова) [#4621](https://github.com/ClickHouse/ClickHouse/pull/4621) ([Konstantin Podshumok](https://github.com/podshumok))
- Добавлена возможность задавать настройки для `clickhouse-performance-test` из командной строки. [#4437](https://github.com/ClickHouse/ClickHouse/pull/4437) ([alesapin](https://github.com/alesapin))
- Добавлены тесты словарей в интеграционные тесты. [#4477](https://github.com/ClickHouse/ClickHouse/pull/4477) ([alesapin](https://github.com/alesapin))
- Добавлены запросы из бенчмарка на сайте в автоматические тесты производительности. [#4496](https://github.com/ClickHouse/ClickHouse/pull/4496) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `xxhash.h` отсутствует во внешнем lz4, потому что это деталь реализации, и его символы помещены в отдельное пространство имён с помощью макроса `XXH_NAMESPACE`. Когда lz4 используется как внешняя библиотека, xxHash также должен быть внешним, и зависящие от него компоненты должны линкуются с ним отдельно. [#4495](https://github.com/ClickHouse/ClickHouse/pull/4495) ([Orivej Desh](https://github.com/orivej))
- Исправлен случай, когда агрегатная функция `quantileTiming` могла вызываться с отрицательным или вещественным аргументом (это исправляет fuzz-тест с sanitizer неопределённого поведения). [#4506](https://github.com/ClickHouse/ClickHouse/pull/4506) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена орфографическая ошибка. [#4531](https://github.com/ClickHouse/ClickHouse/pull/4531) ([sdk2](https://github.com/sdk2))
- Исправлена компиляция на Mac. [#4371](https://github.com/ClickHouse/ClickHouse/pull/4371) ([Vitaly Baranov](https://github.com/vitlibar))
- Исправления сборки для FreeBSD и различных нетипичных конфигураций сборки. [#4444](https://github.com/ClickHouse/ClickHouse/pull/4444) ([proller](https://github.com/proller))



## Релиз ClickHouse 19.3 {#clickhouse-release-19-3}

### Релиз ClickHouse 19.3.9.1, 2019-04-02 {#clickhouse-release-19-3-9-1-2019-04-02}

#### Исправления ошибок {#bug-fixes-12}

- Исправлено падение в `FULL/RIGHT JOIN` при соединении nullable и not nullable столбцов. [#4855](https://github.com/ClickHouse/ClickHouse/pull/4855) ([Artem Zuikov](https://github.com/4ertus2))
- Исправлена ошибка сегментации в `clickhouse-copier`. [#4835](https://github.com/ClickHouse/ClickHouse/pull/4835) ([proller](https://github.com/proller))
- Исправлено чтение из столбца `Array(LowCardinality)` в редком случае, когда столбец содержал длинную последовательность пустых массивов. [#4850](https://github.com/ClickHouse/ClickHouse/pull/4850) ([Nikolai Kochetov](https://github.com/KochetovNicolai))

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-13}

- Добавлена возможность запуска образа clickhouse-server от имени произвольного пользователя [#4753](https://github.com/ClickHouse/ClickHouse/pull/4753) ([Mikhail f. Shiryaev](https://github.com/Felixoid))

### Релиз ClickHouse 19.3.7, 2019-03-12 {#clickhouse-release-19-3-7-2019-03-12}

#### Исправления ошибок {#bug-fixes-13}

- Исправлена ошибка в #3920. Эта ошибка проявлялась как случайное повреждение кеша (сообщения `Unknown codec family code`, `Cannot seek through file`) и ошибки сегментации. Эта ошибка впервые появилась в версии 19.1 и присутствует в версиях до 19.1.10 и 19.3.6 включительно. [#4623](https://github.com/ClickHouse/ClickHouse/pull/4623) ([alexey-milovidov](https://github.com/alexey-milovidov))

### Релиз ClickHouse 19.3.6, 2019-03-02 {#clickhouse-release-19-3-6-2019-03-02}

#### Исправления ошибок {#bug-fixes-14}

- Когда в пуле потоков более 1000 потоков, может произойти `std::terminate` при завершении потока. [Azat Khuzhin](https://github.com/azat) [#4485](https://github.com/ClickHouse/ClickHouse/pull/4485) [#4505](https://github.com/ClickHouse/ClickHouse/pull/4505) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Теперь возможно создавать таблицы `ReplicatedMergeTree*` с комментариями к столбцам без значений по умолчанию и таблицы со столбцами с кодеками без комментариев и значений по умолчанию. Также исправлено сравнение кодеков. [#4523](https://github.com/ClickHouse/ClickHouse/pull/4523) ([alesapin](https://github.com/alesapin))
- Исправлено падение при JOIN с массивом или кортежем. [#4552](https://github.com/ClickHouse/ClickHouse/pull/4552) ([Artem Zuikov](https://github.com/4ertus2))
- Исправлено падение в clickhouse-copier с сообщением `ThreadStatus not created`. [#4540](https://github.com/ClickHouse/ClickHouse/pull/4540) ([Artem Zuikov](https://github.com/4ertus2))
- Исправлено зависание при остановке сервера, если использовались распределённые DDL. [#4472](https://github.com/ClickHouse/ClickHouse/pull/4472) ([Alex Zatelepin](https://github.com/ztlpn))
- Неправильные номера столбцов выводились в сообщении об ошибке парсинга текстового формата для столбцов с номером больше 10. [#4484](https://github.com/ClickHouse/ClickHouse/pull/4484) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvements-3}


- Исправлена сборка с включённым AVX. [#4527](https://github.com/ClickHouse/ClickHouse/pull/4527) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Включён расширенный учёт и учёт операций ввода-вывода на основе известной корректной версии вместо версии ядра, под которым выполняется компиляция. [#4541](https://github.com/ClickHouse/ClickHouse/pull/4541) ([nvartolomei](https://github.com/nvartolomei))
- Разрешён пропуск установки core_dump.size_limit, выдаётся предупреждение вместо исключения при неудачной установке лимита. [#4473](https://github.com/ClickHouse/ClickHouse/pull/4473) ([proller](https://github.com/proller))
- Удалены теги `inline` у `void readBinary(...)` в `Field.cpp`. Также объединены избыточные блоки `namespace DB`. [#4530](https://github.com/ClickHouse/ClickHouse/pull/4530) ([hcz](https://github.com/hczhcz))

### Релиз ClickHouse 19.3.5, 2019-02-21 {#clickhouse-release-19-3-5-2019-02-21}

#### Исправления ошибок {#bug-fixes-15}

- Исправлена ошибка при обработке больших HTTP-запросов вставки данных. [#4454](https://github.com/ClickHouse/ClickHouse/pull/4454) ([alesapin](https://github.com/alesapin))
- Исправлена обратная несовместимость со старыми версиями из-за неправильной реализации настройки `send_logs_level`. [#4445](https://github.com/ClickHouse/ClickHouse/pull/4445) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена обратная несовместимость табличной функции `remote`, возникшая при добавлении комментариев к столбцам. [#4446](https://github.com/ClickHouse/ClickHouse/pull/4446) ([alexey-milovidov](https://github.com/alexey-milovidov))

### Релиз ClickHouse 19.3.4, 2019-02-16 {#clickhouse-release-19-3-4-2019-02-16}

#### Улучшения {#improvements-4}

- Размер индекса таблицы не учитывается в лимитах памяти при выполнении запроса `ATTACH TABLE`. Устранена возможность того, что таблица не может быть присоединена после отсоединения. [#4396](https://github.com/ClickHouse/ClickHouse/pull/4396) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Немного увеличен лимит на максимальный размер строк и массивов, получаемых от ZooKeeper. Это позволяет продолжать работу с увеличенным размером `CLIENT_JVMFLAGS=-Djute.maxbuffer=...` в ZooKeeper. [#4398](https://github.com/ClickHouse/ClickHouse/pull/4398) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Разрешено восстановление заброшенной реплики, даже если в её очереди уже находится огромное количество узлов. [#4399](https://github.com/ClickHouse/ClickHouse/pull/4399) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлен один обязательный аргумент к индексу `SET` (максимальное количество сохраняемых строк). [#4386](https://github.com/ClickHouse/ClickHouse/pull/4386) ([Nikita Vasilev](https://github.com/nikvas0))

#### Исправления ошибок {#bug-fixes-16}

- Исправлен результат `WITH ROLLUP` для группировки по одному ключу типа `LowCardinality`. [#4384](https://github.com/ClickHouse/ClickHouse/pull/4384) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Исправлена ошибка в индексе set (удаление гранулы, если она содержит более `max_rows` строк). [#4386](https://github.com/ClickHouse/ClickHouse/pull/4386) ([Nikita Vasilev](https://github.com/nikvas0))
- Множество исправлений сборки для FreeBSD. [#4397](https://github.com/ClickHouse/ClickHouse/pull/4397) ([proller](https://github.com/proller))
- Исправлена подстановка псевдонимов в запросах с подзапросом, содержащим тот же псевдоним (проблема [#4110](https://github.com/ClickHouse/ClickHouse/issues/4110)). [#4351](https://github.com/ClickHouse/ClickHouse/pull/4351) ([Artem Zuikov](https://github.com/4ertus2))


#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvements-4}

- Добавлена возможность запуска `clickhouse-server` для stateless-тестов в docker-образе. [#4347](https://github.com/ClickHouse/ClickHouse/pull/4347) ([Vasily Nemkov](https://github.com/Enmk))

### Релиз ClickHouse 19.3.3, 2019-02-13 {#clickhouse-release-19-3-3-2019-02-13}

#### Новые возможности {#new-features-6}


- Добавлен оператор `KILL MUTATION`, позволяющий удалять зависшие мутации. Добавлены поля `latest_failed_part`, `latest_fail_time`, `latest_fail_reason` в таблицу `system.mutations` для упрощения диагностики. [#4287](https://github.com/ClickHouse/ClickHouse/pull/4287) ([Alex Zatelepin](https://github.com/ztlpn))
- Добавлена агрегатная функция `entropy`, вычисляющая энтропию Шеннона. [#4238](https://github.com/ClickHouse/ClickHouse/pull/4238) ([Quid37](https://github.com/Quid37))
- Добавлена возможность отправлять запросы `INSERT INTO tbl VALUES (....` на сервер без разделения на части `query` и `data`. [#4301](https://github.com/ClickHouse/ClickHouse/pull/4301) ([alesapin](https://github.com/alesapin))
- Добавлена универсальная реализация функции `arrayWithConstant`. [#4322](https://github.com/ClickHouse/ClickHouse/pull/4322) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Реализован оператор сравнения `NOT BETWEEN`. [#4228](https://github.com/ClickHouse/ClickHouse/pull/4228) ([Dmitry Naumov](https://github.com/nezed))
- Реализована функция `sumMapFiltered` для ограничения количества ключей, по которым будут суммироваться значения в `sumMap`. [#4129](https://github.com/ClickHouse/ClickHouse/pull/4129) ([Léo Ercolanelli](https://github.com/ercolanelli-leo))
- Добавлена поддержка типов `Nullable` в табличной функции `mysql`. [#4198](https://github.com/ClickHouse/ClickHouse/pull/4198) ([Emmanuel Donin de Rosière](https://github.com/edonin))
- Добавлена поддержка произвольных константных выражений в секции `LIMIT`. [#4246](https://github.com/ClickHouse/ClickHouse/pull/4246) ([k3box](https://github.com/k3box))
- Добавлена агрегатная функция `topKWeighted`, принимающая дополнительный аргумент с весом (беззнаковое целое число). [#4245](https://github.com/ClickHouse/ClickHouse/pull/4245) ([Andrew Golman](https://github.com/andrewgolman))
- `StorageJoin` теперь поддерживает настройку `join_any_take_last_row`, позволяющую перезаписывать существующие значения для одного и того же ключа. [#3973](https://github.com/ClickHouse/ClickHouse/pull/3973) ([Amos Bird](https://github.com/amosbird)
- Добавлена функция `toStartOfInterval`. [#4304](https://github.com/ClickHouse/ClickHouse/pull/4304) ([Vitaly Baranov](https://github.com/vitlibar))
- Добавлен формат `RowBinaryWithNamesAndTypes`. [#4200](https://github.com/ClickHouse/ClickHouse/pull/4200) ([Oleg V. Kozlyuk](https://github.com/DarkWanderer))
- Добавлены типы данных `IPv4` и `IPv6`. Более эффективные реализации функций `IPv*`. [#3669](https://github.com/ClickHouse/ClickHouse/pull/3669) ([Vasily Nemkov](https://github.com/Enmk))
- Добавлена функция `toStartOfTenMinutes()`. [#4298](https://github.com/ClickHouse/ClickHouse/pull/4298) ([Vitaly Baranov](https://github.com/vitlibar))
- Добавлен формат вывода `Protobuf`. [#4005](https://github.com/ClickHouse/ClickHouse/pull/4005) [#4158](https://github.com/ClickHouse/ClickHouse/pull/4158) ([Vitaly Baranov](https://github.com/vitlibar))
- Добавлена поддержка brotli для HTTP-интерфейса при импорте данных (INSERTs). [#4235](https://github.com/ClickHouse/ClickHouse/pull/4235) ([Mikhail](https://github.com/fandyushin))
- Добавлены подсказки при опечатках в именах функций или типах в клиенте командной строки. [#4239](https://github.com/ClickHouse/ClickHouse/pull/4239) ([Danila Kutenin](https://github.com/danlark1))
- Добавлен заголовок `Query-Id` в HTTP-ответ сервера. [#4231](https://github.com/ClickHouse/ClickHouse/pull/4231) ([Mikhail](https://github.com/fandyushin))

#### Экспериментальные возможности {#experimental-features-2}


- Добавлены индексы пропуска данных `minmax` и `set` для семейства движков таблиц MergeTree. [#4143](https://github.com/ClickHouse/ClickHouse/pull/4143) ([Nikita Vasilev](https://github.com/nikvas0))
- Добавлено преобразование `CROSS JOIN` в `INNER JOIN`, если это возможно. [#4221](https://github.com/ClickHouse/ClickHouse/pull/4221) [#4266](https://github.com/ClickHouse/ClickHouse/pull/4266) ([Artem Zuikov](https://github.com/4ertus2))

#### Исправления ошибок {#bug-fixes-17}


* Исправлена ошибка `Not found column` для дублирующихся столбцов в секции `JOIN ON`. [#4279](https://github.com/ClickHouse/ClickHouse/pull/4279) ([Artem Zuikov](https://github.com/4ertus2))
* Сделать так, чтобы команда `START REPLICATED SENDS` запускала реплицируемые отправления. [#4229](https://github.com/ClickHouse/ClickHouse/pull/4229) ([nvartolomei](https://github.com/nvartolomei))
* Исправлено выполнение агрегатных функций с аргументами типа `Array(LowCardinality)`. [#4055](https://github.com/ClickHouse/ClickHouse/pull/4055) ([KochetovNicolai](https://github.com/KochetovNicolai))
* Исправлено некорректное поведение при выполнении запроса `INSERT ... SELECT ... FROM file(...)`, когда файл имеет формат `CSVWithNames` или `TSVWithNames`, а первая строка данных отсутствует. [#4297](https://github.com/ClickHouse/ClickHouse/pull/4297) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлено падение при перезагрузке словаря, если словарь недоступен. Эта ошибка появилась в версии 19.1.6. [#4188](https://github.com/ClickHouse/ClickHouse/pull/4188) ([proller](https://github.com/proller))
* Исправлен `ALL JOIN` при наличии дубликатов в правой таблице. [#4184](https://github.com/ClickHouse/ClickHouse/pull/4184) ([Artem Zuikov](https://github.com/4ertus2))
* Исправлено падение с ошибкой сегментации при `use_uncompressed_cache=1` и исключение при некорректном размере несжатых данных. Эта ошибка появилась в 19.1.6. [#4186](https://github.com/ClickHouse/ClickHouse/pull/4186) ([alesapin](https://github.com/alesapin))
* Исправлена ошибка в `compile_expressions` при сравнении больших (больше чем int16) дат. [#4341](https://github.com/ClickHouse/ClickHouse/pull/4341) ([alesapin](https://github.com/alesapin))
* Исправлена бесконечная петля при выполнении запроса к табличной функции `numbers(0)`. [#4280](https://github.com/ClickHouse/ClickHouse/pull/4280) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Временно отключена оптимизация предикатов для `ORDER BY`. [#3890](https://github.com/ClickHouse/ClickHouse/pull/3890) ([Winter Zhang](https://github.com/zhang2014))
* Исправлена ошибка `Illegal instruction` при использовании функций base64 на старых процессорах. Она воспроизводилась только в случаях, когда ClickHouse был скомпилирован с gcc-8. [#4275](https://github.com/ClickHouse/ClickHouse/pull/4275) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена ошибка `No message received` при работе с PostgreSQL ODBC Driver через TLS-соединение. Также исправлено падение с ошибкой сегментации при использовании MySQL ODBC Driver. [#4170](https://github.com/ClickHouse/ClickHouse/pull/4170) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлен некорректный результат при использовании аргументов `Date` и `DateTime` в ветвях условного оператора (функция `if`). Добавлен универсальный вариант функции `if`. [#4243](https://github.com/ClickHouse/ClickHouse/pull/4243) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Словари ClickHouse теперь загружаются внутри процесса `clickhouse`. [#4166](https://github.com/ClickHouse/ClickHouse/pull/4166) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена взаимная блокировка при повторном выполнении `SELECT` из таблицы с движком `File` после ошибки `No such file or directory`. [#4161](https://github.com/ClickHouse/ClickHouse/pull/4161) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена гонка, из-за которой при запросе к `system.tables` могла возникать ошибка `table does not exist`. [#4313](https://github.com/ClickHouse/ClickHouse/pull/4313) ([alexey-milovidov](https://github.com/alexey-milovidov))
* `clickhouse-client` может аварийно завершиться (segfault) при выходе, если в интерактивном режиме в этот момент загружаются данные для подсказок командной строки. [#4317](https://github.com/ClickHouse/ClickHouse/pull/4317) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена ошибка, из-за которой выполнение мутаций с операторами `IN` приводило к некорректным результатам. [#4099](https://github.com/ClickHouse/ClickHouse/pull/4099) ([Alex Zatelepin](https://github.com/ztlpn))
* Исправлена ошибка: если есть база данных с движком `Dictionary`, все словари принудительно загружаются при старте сервера, и если среди них есть словарь с источником ClickHouse с localhost, этот словарь не может загрузиться. [#4255](https://github.com/ClickHouse/ClickHouse/pull/4255) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена ошибка, возникавшая при повторном создании системных журналов при завершении работы сервера. [#4254](https://github.com/ClickHouse/ClickHouse/pull/4254) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Корректно возвращать правильный тип и корректно обрабатывать блокировки в функции `joinGet`. [#4153](https://github.com/ClickHouse/ClickHouse/pull/4153) ([Amos Bird](https://github.com/amosbird))
* Добавлена функция `sumMapWithOverflow`. [#4151](https://github.com/ClickHouse/ClickHouse/pull/4151) ([Léo Ercolanelli](https://github.com/ercolanelli-leo))
* Исправлена ошибка сегментации (segfault) при использовании `allow_experimental_multiple_joins_emulation`. [52de2c](https://github.com/ClickHouse/ClickHouse/commit/52de2cd927f7b5257dd67e175f0a5560a48840d0) ([Artem Zuikov](https://github.com/4ertus2))
* Исправлена ошибка некорректного сравнения `Date` и `DateTime`. [#4237](https://github.com/ClickHouse/ClickHouse/pull/4237) ([valexey](https://github.com/valexey))
* Исправлен fuzz-тест под undefined behavior sanitizer: добавлена проверка типов параметров для семейства функций `quantile*Weighted`. [#4145](https://github.com/ClickHouse/ClickHouse/pull/4145) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена редкая гонка, из-за которой удаление старых кусков данных могло завершаться ошибкой `File not found`. [#4378](https://github.com/ClickHouse/ClickHouse/pull/4378) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлен установочный пакет, в котором отсутствовал `/etc/clickhouse-server/config.xml`. [#4343](https://github.com/ClickHouse/ClickHouse/pull/4343) ([proller](https://github.com/proller))

#### Улучшения сборки, тестирования и пакетирования {#buildtestingpackaging-improvements-5}

- Пакет Debian: исправлена ссылка /etc/clickhouse-server/preprocessed в соответствии с конфигурацией. [#4205](https://github.com/ClickHouse/ClickHouse/pull/4205) ([proller](https://github.com/proller))
- Различные исправления сборки для FreeBSD. [#4225](https://github.com/ClickHouse/ClickHouse/pull/4225) ([proller](https://github.com/proller))
- Добавлена возможность создавать, заполнять и удалять таблицы в perftest. [#4220](https://github.com/ClickHouse/ClickHouse/pull/4220) ([alesapin](https://github.com/alesapin))
- Добавлен скрипт для проверки дублирующихся включений. [#4326](https://github.com/ClickHouse/ClickHouse/pull/4326) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлена возможность выполнять запросы по индексу в тесте производительности. [#4264](https://github.com/ClickHouse/ClickHouse/pull/4264) ([alesapin](https://github.com/alesapin))
- Рекомендуется установить пакет с отладочными символами. [#4274](https://github.com/ClickHouse/ClickHouse/pull/4274) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Рефакторинг performance-test. Улучшено логирование и обработка сигналов. [#4171](https://github.com/ClickHouse/ClickHouse/pull/4171) ([alesapin](https://github.com/alesapin))
- Добавлена документация к анонимизированным наборам данных Яндекс.Метрики. [#4164](https://github.com/ClickHouse/ClickHouse/pull/4164) ([alesapin](https://github.com/alesapin))
- Добавлен инструмент для преобразования старых партиций по месяцам в формат пользовательских партиций. [#4195](https://github.com/ClickHouse/ClickHouse/pull/4195) ([Alex Zatelepin](https://github.com/ztlpn))
- Добавлена документация о двух наборах данных в S3. [#4144](https://github.com/ClickHouse/ClickHouse/pull/4144) ([alesapin](https://github.com/alesapin))
- Добавлен скрипт, который создаёт changelog из описаний pull request'ов. [#4169](https://github.com/ClickHouse/ClickHouse/pull/4169) [#4173](https://github.com/ClickHouse/ClickHouse/pull/4173) ([KochetovNicolai](https://github.com/KochetovNicolai)) ([KochetovNicolai](https://github.com/KochetovNicolai))
- Добавлен модуль Puppet для ClickHouse. [#4182](https://github.com/ClickHouse/ClickHouse/pull/4182) ([Maxim Fedotov](https://github.com/MaxFedotov))
- Добавлена документация для группы недокументированных функций. [#4168](https://github.com/ClickHouse/ClickHouse/pull/4168) ([Winter Zhang](https://github.com/zhang2014))
- Исправления сборки для ARM. [#4210](https://github.com/ClickHouse/ClickHouse/pull/4210)[#4306](https://github.com/ClickHouse/ClickHouse/pull/4306) [#4291](https://github.com/ClickHouse/ClickHouse/pull/4291) ([proller](https://github.com/proller)) ([proller](https://github.com/proller))
- Тесты словарей теперь можно запускать из `ctest`. [#4189](https://github.com/ClickHouse/ClickHouse/pull/4189) ([proller](https://github.com/proller))
- Теперь `/etc/ssl` используется как директория по умолчанию для SSL-сертификатов. [#4167](https://github.com/ClickHouse/ClickHouse/pull/4167) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлена проверка инструкций SSE и AVX при запуске. [#4234](https://github.com/ClickHouse/ClickHouse/pull/4234) ([Igr](https://github.com/igron99))
- Скрипт инициализации будет ожидать запуска сервера. [#4281](https://github.com/ClickHouse/ClickHouse/pull/4281) ([proller](https://github.com/proller))

#### Обратно несовместимые изменения {#backward-incompatible-changes-1}


- Удалена настройка `allow_experimental_low_cardinality_type`. Типы данных `LowCardinality` готовы к использованию в production. [#4323](https://github.com/ClickHouse/ClickHouse/pull/4323) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Размер кеша меток и кеша несжатых данных уменьшен в соответствии с доступным объемом памяти. [#4240](https://github.com/ClickHouse/ClickHouse/pull/4240) ([Lopatin Konstantin](https://github.com/k-lopatin)
- Добавлено ключевое слово `INDEX` в запрос `CREATE TABLE`. Столбец с именем `index` должен быть заключен в обратные кавычки или двойные кавычки: `` `index` ``. [#4143](https://github.com/ClickHouse/ClickHouse/pull/4143) ([Nikita Vasilev](https://github.com/nikvas0))
- `sumMap` теперь повышает тип результата вместо переполнения. Старое поведение `sumMap` можно получить с помощью функции `sumMapWithOverflow`. [#4151](https://github.com/ClickHouse/ClickHouse/pull/4151) ([Léo Ercolanelli](https://github.com/ercolanelli-leo))

#### Улучшения производительности {#performance-improvements-4}

- `std::sort` заменен на `pdqsort` для запросов без `LIMIT`. [#4236](https://github.com/ClickHouse/ClickHouse/pull/4236) ([Evgenii Pravda](https://github.com/kvinty))
- Теперь сервер повторно использует потоки из глобального пула потоков. Это влияет на производительность в некоторых крайних случаях. [#4150](https://github.com/ClickHouse/ClickHouse/pull/4150) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### Улучшения {#improvements-5}


- Реализована поддержка AIO для FreeBSD. [#4305](https://github.com/ClickHouse/ClickHouse/pull/4305) ([urgordeadbeef](https://github.com/urgordeadbeef))
- `SELECT * FROM a JOIN b USING a, b` теперь возвращает столбцы `a` и `b` только из левой таблицы. [#4141](https://github.com/ClickHouse/ClickHouse/pull/4141) ([Artem Zuikov](https://github.com/4ertus2))
- Для клиентской опции `-C` разрешено работать так же, как опция `-c`. [#4232](https://github.com/ClickHouse/ClickHouse/pull/4232) ([syominsergey](https://github.com/syominsergey))
- Теперь опция `--password`, используемая без значения, запрашивает пароль из stdin. [#4230](https://github.com/ClickHouse/ClickHouse/pull/4230) ([BSD_Conqueror](https://github.com/bsd-conqueror))
- Добавлена подсветка неэкранированных метасимволов в строковых литералах, содержащих выражения `LIKE` или регулярные выражения. [#4327](https://github.com/ClickHouse/ClickHouse/pull/4327) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлена отмена HTTP‑запросов только на чтение, если клиентский сокет отключается. [#4213](https://github.com/ClickHouse/ClickHouse/pull/4213) ([nvartolomei](https://github.com/nvartolomei))
- Теперь сервер сообщает прогресс, чтобы поддерживать активность клиентских подключений. [#4215](https://github.com/ClickHouse/ClickHouse/pull/4215) ([Ivan](https://github.com/abyss7))
- Незначительно улучшено сообщение с причиной для запроса OPTIMIZE при включённой настройке `optimize_throw_if_noop`. [#4294](https://github.com/ClickHouse/ClickHouse/pull/4294) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлена поддержка опции `--version` для сервера clickhouse. [#4251](https://github.com/ClickHouse/ClickHouse/pull/4251) ([Lopatin Konstantin](https://github.com/k-lopatin))
- Добавлена опция `--help/-h` для `clickhouse-server`. [#4233](https://github.com/ClickHouse/ClickHouse/pull/4233) ([Yuriy Baranov](https://github.com/yurriy))
- Добавлена поддержка скалярных подзапросов с результатом в виде состояния агрегатной функции. [#4348](https://github.com/ClickHouse/ClickHouse/pull/4348) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Снижено время завершения работы сервера и ожидания завершения ALTER‑запросов. [#4372](https://github.com/ClickHouse/ClickHouse/pull/4372) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлена информация о настройке replicated_can_become_leader в system.replicas и логирование, если реплика не будет пытаться становиться лидером. [#4379](https://github.com/ClickHouse/ClickHouse/pull/4379) ([Alex Zatelepin](https://github.com/ztlpn))



## Релиз ClickHouse 19.1 {#clickhouse-release-19-1}

### Релиз ClickHouse 19.1.14, 2019-03-14 {#clickhouse-release-19-1-14-2019-03-14}

- Исправлена ошибка `Column ... queried more than once`, которая могла возникать при установке настройки `asterisk_left_columns_only` в значение 1 в случае использования `GLOBAL JOIN` с `SELECT *` (редкий случай). Проблема отсутствует в версиях 19.3 и выше. [6bac7d8d](https://github.com/ClickHouse/ClickHouse/pull/4692/commits/6bac7d8d11a9b0d6de0b32b53c47eb2f6f8e7062) ([Artem Zuikov](https://github.com/4ertus2))

### Релиз ClickHouse 19.1.13, 2019-03-12 {#clickhouse-release-19-1-13-2019-03-12}

Этот релиз содержит тот же набор исправлений, что и 19.3.7.

### Релиз ClickHouse 19.1.10, 2019-03-03 {#clickhouse-release-19-1-10-2019-03-03}

Этот релиз содержит тот же набор исправлений, что и 19.3.6.


## Релиз ClickHouse 19.1 {#clickhouse-release-19-1-1}

### Релиз ClickHouse 19.1.9, 2019-02-21 {#clickhouse-release-19-1-9-2019-02-21}

#### Исправления ошибок {#bug-fixes-18}

- Исправлена обратная несовместимость со старыми версиями из-за неправильной реализации настройки `send_logs_level`. [#4445](https://github.com/ClickHouse/ClickHouse/pull/4445) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена обратная несовместимость табличной функции `remote`, возникшая при добавлении комментариев к столбцам. [#4446](https://github.com/ClickHouse/ClickHouse/pull/4446) ([alexey-milovidov](https://github.com/alexey-milovidov))

### Релиз ClickHouse 19.1.8, 2019-02-16 {#clickhouse-release-19-1-8-2019-02-16}

#### Исправления ошибок {#bug-fixes-19}

- Исправлена проблема с установочным пакетом, в котором отсутствовал файл /etc/clickhouse-server/config.xml. [#4343](https://github.com/ClickHouse/ClickHouse/pull/4343) ([proller](https://github.com/proller))


## Релиз ClickHouse 19.1 {#clickhouse-release-19-1-2}

### Релиз ClickHouse 19.1.7, 2019-02-15 {#clickhouse-release-19-1-7-2019-02-15}

#### Исправление ошибок {#bug-fixes-20}


* Корректно возвращать нужный тип и корректно обрабатывать блокировки в функции `joinGet`. [#4153](https://github.com/ClickHouse/ClickHouse/pull/4153) ([Amos Bird](https://github.com/amosbird))
* Исправлена ошибка, возникавшая при повторном создании системных логов во время завершения работы сервера. [#4254](https://github.com/ClickHouse/ClickHouse/pull/4254) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена ошибка: если существует база данных с движком `Dictionary`, все словари принудительно загружаются при запуске сервера, и если среди них есть словарь с источником ClickHouse с `localhost`, этот словарь не может быть загружен. [#4255](https://github.com/ClickHouse/ClickHouse/pull/4255) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена ошибка, из-за которой выполнение мутаций, содержащих оператор `IN`, приводило к некорректным результатам. [#4099](https://github.com/ClickHouse/ClickHouse/pull/4099) ([Alex Zatelepin](https://github.com/ztlpn))
* `clickhouse-client` может аварийно завершаться при выходе из программы во время загрузки данных для подсказок командной строки, если он был запущен в интерактивном режиме. [#4317](https://github.com/ClickHouse/ClickHouse/pull/4317) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена гонка, из-за которой при выборке из `system.tables` могла возникать ошибка `table does not exist`. [#4313](https://github.com/ClickHouse/ClickHouse/pull/4313) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена взаимоблокировка, возникавшая при повторном выполнении `SELECT` из таблицы с движком `File` после ошибки «No such file or directory». [#4161](https://github.com/ClickHouse/ClickHouse/pull/4161) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена проблема: локальные словари ClickHouse загружались по TCP, хотя должны загружаться внутри процесса. [#4166](https://github.com/ClickHouse/ClickHouse/pull/4166) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена ошибка `No message received` при взаимодействии с PostgreSQL ODBC Driver по TLS-соединению. Также устранена ошибка сегментации при использовании MySQL ODBC Driver. [#4170](https://github.com/ClickHouse/ClickHouse/pull/4170) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Временно отключена оптимизация предикатов для `ORDER BY`. [#3890](https://github.com/ClickHouse/ClickHouse/pull/3890) ([Winter Zhang](https://github.com/zhang2014))
* Исправлен бесконечный цикл при выборке из табличной функции `numbers(0)`. [#4280](https://github.com/ClickHouse/ClickHouse/pull/4280) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена ошибка в `compile_expressions` при сравнении больших дат (выходящих за пределы int16). [#4341](https://github.com/ClickHouse/ClickHouse/pull/4341) ([alesapin](https://github.com/alesapin))
* Исправлена ошибка «segmentation fault» при `uncompressed_cache=1` и исключение при некорректном несжатом размере. [#4186](https://github.com/ClickHouse/ClickHouse/pull/4186) ([alesapin](https://github.com/alesapin))
* Исправлен `ALL JOIN` при наличии дубликатов в правой таблице. [#4184](https://github.com/ClickHouse/ClickHouse/pull/4184) ([Artem Zuikov](https://github.com/4ertus2))
* Исправлено некорректное поведение при выполнении запроса `INSERT ... SELECT ... FROM file(...)`, когда файл имеет формат `CSVWithNames` или `TSVWithNames`, а первая строка с данными отсутствует. [#4297](https://github.com/ClickHouse/ClickHouse/pull/4297) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлено выполнение агрегатных функций с аргументами типа `Array(LowCardinality)`. [#4055](https://github.com/ClickHouse/ClickHouse/pull/4055) ([KochetovNicolai](https://github.com/KochetovNicolai))
* Пакет Debian: исправлена ссылка /etc/clickhouse-server/preprocessed в соответствии с конфигом. [#4205](https://github.com/ClickHouse/ClickHouse/pull/4205) ([proller](https://github.com/proller))
* Исправлен fuzz-тест под санитайзером неопределённого поведения (undefined behavior sanitizer): добавлена проверка типа параметра для семейства функций `quantile*Weighted`. [#4145](https://github.com/ClickHouse/ClickHouse/pull/4145) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Сделать так, чтобы команда `START REPLICATED SENDS` запускала реплицированные отправки. [#4229](https://github.com/ClickHouse/ClickHouse/pull/4229) ([nvartolomei](https://github.com/nvartolomei))
* Исправлена ошибка `Not found column` при наличии дублирующихся столбцов в секции JOIN ON. [#4279](https://github.com/ClickHouse/ClickHouse/pull/4279) ([Artem Zuikov](https://github.com/4ertus2))
* Теперь каталогом по умолчанию для SSL-сертификатов используется `/etc/ssl`. [#4167](https://github.com/ClickHouse/ClickHouse/pull/4167) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлено падение при перезагрузке словаря, если тот недоступен. [#4188](https://github.com/ClickHouse/ClickHouse/pull/4188) ([proller](https://github.com/proller))
* Исправлена ошибка некорректного сравнения `Date` и `DateTime`. [#4237](https://github.com/ClickHouse/ClickHouse/pull/4237) ([valexey](https://github.com/valexey))
* Исправлен некорректный результат при использовании аргументов `Date` и `DateTime` в ветвях условного оператора (функции `if`). Добавлен обобщённый случай для функции `if`. [#4243](https://github.com/ClickHouse/ClickHouse/pull/4243) ([alexey-milovidov](https://github.com/alexey-milovidov))

### ClickHouse Release 19.1.6, 2019-01-24 {#clickhouse-release-19-1-6-2019-01-24}

#### Новые возможности {#new-features-7}

- Пользовательские кодеки сжатия для отдельных столбцов таблиц. [#3899](https://github.com/ClickHouse/ClickHouse/pull/3899) [#4111](https://github.com/ClickHouse/ClickHouse/pull/4111) ([alesapin](https://github.com/alesapin), [Winter Zhang](https://github.com/zhang2014), [Anatoly](https://github.com/Sindbag))
- Добавлен кодек сжатия `Delta`. [#4052](https://github.com/ClickHouse/ClickHouse/pull/4052) ([alesapin](https://github.com/alesapin))
- Добавлена возможность изменять кодеки сжатия с помощью `ALTER`. [#4054](https://github.com/ClickHouse/ClickHouse/pull/4054) ([alesapin](https://github.com/alesapin))
- Добавлены функции `left`, `right`, `trim`, `ltrim`, `rtrim`, `timestampadd`, `timestampsub` для совместимости со стандартом SQL. [#3826](https://github.com/ClickHouse/ClickHouse/pull/3826) ([Ivan Blinkov](https://github.com/blinkov))
- Поддержка записи в таблицы `HDFS` и табличную функцию `hdfs`. [#4084](https://github.com/ClickHouse/ClickHouse/pull/4084) ([alesapin](https://github.com/alesapin))
- Добавлены функции для поиска нескольких константных строк в большом массиве данных: `multiPosition`, `multiSearch`, `firstMatch`, а также их варианты с суффиксами `-UTF8`, `-CaseInsensitive` и `-CaseInsensitiveUTF8`. [#4053](https://github.com/ClickHouse/ClickHouse/pull/4053) ([Danila Kutenin](https://github.com/danlark1))
- Исключение неиспользуемых шардов, если запрос `SELECT` фильтрует данные по ключу шардирования (настройка `optimize_skip_unused_shards`). [#3851](https://github.com/ClickHouse/ClickHouse/pull/3851) ([Gleb Kanterov](https://github.com/kanterov), [Ivan](https://github.com/abyss7))
- Движок `Kafka` теперь может игнорировать определённое количество ошибок парсинга на блок. [#4094](https://github.com/ClickHouse/ClickHouse/pull/4094) ([Ivan](https://github.com/abyss7))
- Добавлена поддержка оценки многоклассовых моделей `CatBoost`. Функция `modelEvaluate` возвращает кортеж с необработанными предсказаниями для каждого класса в многоклассовых моделях. Библиотека `libcatboostmodel.so` должна быть собрана с [#607](https://github.com/catboost/catboost/pull/607). [#3959](https://github.com/ClickHouse/ClickHouse/pull/3959) ([KochetovNicolai](https://github.com/KochetovNicolai))
- Добавлены функции `filesystemAvailable`, `filesystemFree`, `filesystemCapacity`. [#4097](https://github.com/ClickHouse/ClickHouse/pull/4097) ([Boris Granveaud](https://github.com/bgranvea))
- Добавлены хеш-функции `xxHash64` и `xxHash32`. [#3905](https://github.com/ClickHouse/ClickHouse/pull/3905) ([filimonov](https://github.com/filimonov))
- Добавлена хеш-функция `gccMurmurHash` (вариант Murmur hash в стиле GCC), которая использует то же начальное значение хеша, что и [gcc](https://github.com/gcc-mirror/gcc/blob/41d6b10e96a1de98e90a7c0378437c3255814b16/libstdc%2B%2B-v3/include/bits/functional_hash.h#L191) [#4000](https://github.com/ClickHouse/ClickHouse/pull/4000) ([sundyli](https://github.com/sundy-li))
- Добавлены хеш-функции `javaHash`, `hiveHash`. [#3811](https://github.com/ClickHouse/ClickHouse/pull/3811) ([shangshujie365](https://github.com/shangshujie365))
- Добавлена табличная функция `remoteSecure`. Функция работает как `remote`, но использует защищённое соединение. [#4088](https://github.com/ClickHouse/ClickHouse/pull/4088) ([proller](https://github.com/proller))

#### Экспериментальные возможности {#experimental-features-3}


- Добавлена эмуляция множественных JOIN (настройка `allow_experimental_multiple_joins_emulation`). [#3946](https://github.com/ClickHouse/ClickHouse/pull/3946) ([Artem Zuikov](https://github.com/4ertus2))

#### Исправления ошибок {#bug-fixes-21}


* Сделать настройку `compiled_expression_cache_size` по умолчанию ограниченной, чтобы снизить потребление памяти. [#4041](https://github.com/ClickHouse/ClickHouse/pull/4041) ([alesapin](https://github.com/alesapin))
* Исправлена ошибка, приводившая к зависаниям в потоках, выполняющих `ALTER` реплицируемых таблиц, и в потоке, обновляющем конфигурацию из ZooKeeper. [#2947](https://github.com/ClickHouse/ClickHouse/issues/2947) [#3891](https://github.com/ClickHouse/ClickHouse/issues/3891) [#3934](https://github.com/ClickHouse/ClickHouse/pull/3934) ([Alex Zatelepin](https://github.com/ztlpn))
* Исправлена гонка при выполнении распределённой задачи `ALTER`. Из‑за неё более одной реплики пытались выполнить задачу, и все реплики, кроме одной, завершались с ошибкой ZooKeeper. [#3904](https://github.com/ClickHouse/ClickHouse/pull/3904) ([Alex Zatelepin](https://github.com/ztlpn))
* Исправлена ошибка, из-за которой элементы конфигурации `from_zk` не обновлялись после тайм-аута запроса к ZooKeeper. [#2947](https://github.com/ClickHouse/ClickHouse/issues/2947) [#3947](https://github.com/ClickHouse/ClickHouse/pull/3947) ([Alex Zatelepin](https://github.com/ztlpn))
* Исправлена ошибка с неверным префиксом масок подсетей IPv4. [#3945](https://github.com/ClickHouse/ClickHouse/pull/3945) ([alesapin](https://github.com/alesapin))
* Исправлен крах (`std::terminate`) в редких случаях, когда новый поток не удаётся создать из-за исчерпания ресурсов. [#3956](https://github.com/ClickHouse/ClickHouse/pull/3956) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена ошибка при выполнении табличной функции `remote`, когда для `getStructureOfRemoteTable` использовались некорректные ограничения. [#4009](https://github.com/ClickHouse/ClickHouse/pull/4009) ([alesapin](https://github.com/alesapin))
* Исправлена утечка сокетов netlink. Они помещались в пул, из которого никогда не удалялись, и новые сокеты создавались при запуске нового потока, когда все имеющиеся сокеты уже были заняты. [#4017](https://github.com/ClickHouse/ClickHouse/pull/4017) ([Alex Zatelepin](https://github.com/ztlpn))
* Исправлена ошибка, из-за которой директория `/proc/self/fd` закрывалась раньше, чем все дескрипторы файлов были прочитаны из `/proc` после форка подпроцесса `odbc-bridge`. [#4120](https://github.com/ClickHouse/ClickHouse/pull/4120) ([alesapin](https://github.com/alesapin))
* Исправлено монотонное преобразование FixedString в UInt при использовании String в первичном ключе. [#3870](https://github.com/ClickHouse/ClickHouse/pull/3870) ([Winter Zhang](https://github.com/zhang2014))
* Исправлена ошибка при вычислении монотонности функции целочисленного преобразования. [#3921](https://github.com/ClickHouse/ClickHouse/pull/3921) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена ошибка сегментирования в функциях `arrayEnumerateUniq`, `arrayEnumerateDense`, возникавшая при некоторых некорректных аргументах. [#3909](https://github.com/ClickHouse/ClickHouse/pull/3909) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлен UB в StorageMerge. [#3910](https://github.com/ClickHouse/ClickHouse/pull/3910) ([Amos Bird](https://github.com/amosbird))
* Исправлена ошибка segfault в функциях `addDays`, `subtractDays`. [#3913](https://github.com/ClickHouse/ClickHouse/pull/3913) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена ошибка: функции `round`, `floor`, `trunc`, `ceil` могли возвращать неверный результат при выполнении с целочисленным аргументом и большим отрицательным масштабом. [#3914](https://github.com/ClickHouse/ClickHouse/pull/3914) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена ошибка, вызванная командой &#39;kill query sync&#39;, которая приводила к аварийному дампу (core dump). [#3916](https://github.com/ClickHouse/ClickHouse/pull/3916) ([muVulDeePecker](https://github.com/fancyqlx))
* Исправлена ошибка с большой задержкой после опустошения очереди репликации. [#3928](https://github.com/ClickHouse/ClickHouse/pull/3928) [#3932](https://github.com/ClickHouse/ClickHouse/pull/3932) ([alesapin](https://github.com/alesapin))
* Исправлено избыточное потребление памяти при вставке в таблицу с первичным ключом `LowCardinality`. [#3955](https://github.com/ClickHouse/ClickHouse/pull/3955) ([KochetovNicolai](https://github.com/KochetovNicolai))
* Исправлена сериализация типа данных `LowCardinality` для формата `Native` в случае пустых массивов. [#3907](https://github.com/ClickHouse/ClickHouse/issues/3907) [#4011](https://github.com/ClickHouse/ClickHouse/pull/4011) ([KochetovNicolai](https://github.com/KochetovNicolai))
* Исправлен некорректный результат при использовании DISTINCT по одному числовому столбцу типа LowCardinality. [#3895](https://github.com/ClickHouse/ClickHouse/issues/3895) [#4012](https://github.com/ClickHouse/ClickHouse/pull/4012) ([Kochetов Николай](https://github.com/KochetovNicolai))
* Исправлена специализированная агрегация с ключом LowCardinality (при включённой настройке `compile`). [#3886](https://github.com/ClickHouse/ClickHouse/pull/3886) ([KochetovNicolai](https://github.com/KochetovNicolai))
* Исправлена переадресация пользователя и пароля для запросов к реплицированным таблицам. [#3957](https://github.com/ClickHouse/ClickHouse/pull/3957) ([alesapin](https://github.com/alesapin)) ([小路](https://github.com/nicelulu))
* Исправлена очень редкая гонка, которая могла возникать при перечислении таблиц в базе данных Dictionary во время перезагрузки словарей. [#3970](https://github.com/ClickHouse/ClickHouse/pull/3970) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена некорректная выдача при использовании HAVING с ROLLUP или CUBE. [#3756](https://github.com/ClickHouse/ClickHouse/issues/3756) [#3837](https://github.com/ClickHouse/ClickHouse/pull/3837) ([Sam Chou](https://github.com/reflection))
* Исправлены псевдонимы столбцов для запросов с синтаксисом `JOIN ON` и распределённых таблиц. [#3980](https://github.com/ClickHouse/ClickHouse/pull/3980) ([Winter Zhang](https://github.com/zhang2014))
* Исправлена ошибка во внутренней реализации `quantileTDigest` (обнаружена Artem Vakhrushev). Эта ошибка никогда не проявлялась в ClickHouse и была актуальна только для тех, кто использует кодовую базу ClickHouse напрямую как библиотеку. [#3935](https://github.com/ClickHouse/ClickHouse/pull/3935) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### Улучшения {#improvements-6}

- Поддержка `IF NOT EXISTS` в операторах `ALTER TABLE ADD COLUMN` и `IF EXISTS` в `DROP/MODIFY/CLEAR/COMMENT COLUMN`. [#3900](https://github.com/ClickHouse/ClickHouse/pull/3900) ([Boris Granveaud](https://github.com/bgranvea))
- Функция `parseDateTimeBestEffort`: поддержка форматов `DD.MM.YYYY`, `DD.MM.YY`, `DD-MM-YYYY`, `DD-Mon-YYYY`, `DD/Month/YYYY` и подобных. [#3922](https://github.com/ClickHouse/ClickHouse/pull/3922) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `CapnProtoInputStream` теперь поддерживает неоднородные структуры. [#4063](https://github.com/ClickHouse/ClickHouse/pull/4063) ([Odin Hultgren Van Der Horst](https://github.com/Miniwoffer))
- Улучшение удобства использования: добавлена проверка того, что процесс сервера запускается от имени владельца каталога данных. Запрещён запуск сервера от имени root, если данные принадлежат пользователю, отличному от root. [#3785](https://github.com/ClickHouse/ClickHouse/pull/3785) ([sergey-v-galtsev](https://github.com/sergey-v-galtsev))
- Улучшена логика проверки необходимых столбцов при анализе запросов с JOIN. [#3930](https://github.com/ClickHouse/ClickHouse/pull/3930) ([Artem Zuikov](https://github.com/4ertus2))
- Уменьшено количество соединений при большом числе Distributed-таблиц на одном сервере. [#3726](https://github.com/ClickHouse/ClickHouse/pull/3726) ([Winter Zhang](https://github.com/zhang2014))
- Добавлена поддержка строки итогов для запроса `WITH TOTALS` в драйвере ODBC. [#3836](https://github.com/ClickHouse/ClickHouse/pull/3836) ([Maksim Koritckiy](https://github.com/nightweb))
- Разрешено использование `Enum` в качестве целых чисел внутри функции if. [#3875](https://github.com/ClickHouse/ClickHouse/pull/3875) ([Ivan](https://github.com/abyss7))
- Добавлена настройка `low_cardinality_allow_in_native_format`. Если отключена, тип `LowCardinality` не используется в формате `Native`. [#3879](https://github.com/ClickHouse/ClickHouse/pull/3879) ([KochetovNicolai](https://github.com/KochetovNicolai))
- Удалены некоторые избыточные объекты из кеша скомпилированных выражений для снижения потребления памяти. [#4042](https://github.com/ClickHouse/ClickHouse/pull/4042) ([alesapin](https://github.com/alesapin))
- Добавлена проверка того, что запрос `SET send_logs_level = 'value'` принимает допустимое значение. [#3873](https://github.com/ClickHouse/ClickHouse/pull/3873) ([Sabyanin Maxim](https://github.com/s-mx))
- Исправлена проверка типов данных в функциях преобразования типов. [#3896](https://github.com/ClickHouse/ClickHouse/pull/3896) ([Winter Zhang](https://github.com/zhang2014))

#### Улучшения производительности {#performance-improvements-5}


- Добавлена настройка MergeTree `use_minimalistic_part_header_in_zookeeper`. При включении реплицируемые таблицы будут хранить компактные метаданные кусков в одном znode куска. Это может значительно уменьшить размер снимка ZooKeeper (особенно если таблицы содержат много столбцов). Обратите внимание, что после включения этой настройки вы не сможете откатиться на версию, которая её не поддерживает. [#3960](https://github.com/ClickHouse/ClickHouse/pull/3960) ([Alex Zatelepin](https://github.com/ztlpn))
- Добавлена реализация на основе DFA для функций `sequenceMatch` и `sequenceCount` в случае, когда шаблон не содержит времени. [#4004](https://github.com/ClickHouse/ClickHouse/pull/4004) ([Léo Ercolanelli](https://github.com/ercolanelli-leo))
- Улучшена производительность сериализации целых чисел. [#3968](https://github.com/ClickHouse/ClickHouse/pull/3968) ([Amos Bird](https://github.com/amosbird))
- Добавлено нулевое заполнение слева для PODArray, чтобы элемент -1 всегда был валидным и обнулённым. Используется для безветвленного вычисления смещений. [#3920](https://github.com/ClickHouse/ClickHouse/pull/3920) ([Amos Bird](https://github.com/amosbird))
- Откачена версия `jemalloc`, которая приводила к снижению производительности. [#4018](https://github.com/ClickHouse/ClickHouse/pull/4018) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### Обратно несовместимые изменения {#backward-incompatible-changes-2}

- Удалена недокументированная возможность `ALTER MODIFY PRIMARY KEY`, поскольку она была заменена командой `ALTER MODIFY ORDER BY`. [#3887](https://github.com/ClickHouse/ClickHouse/pull/3887) ([Alex Zatelepin](https://github.com/ztlpn))
- Удалена функция `shardByHash`. [#3833](https://github.com/ClickHouse/ClickHouse/pull/3833) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Запрещено использование скалярных подзапросов с результатом типа `AggregateFunction`. [#3865](https://github.com/ClickHouse/ClickHouse/pull/3865) ([Ivan](https://github.com/abyss7))

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvements-6}


* Добавлена поддержка сборки под PowerPC (`ppc64le`). [#4132](https://github.com/ClickHouse/ClickHouse/pull/4132) ([Danila Kutenin](https://github.com/danlark1))
* Функциональные тесты с сохранением состояния выполняются на общедоступном наборе данных. [#3969](https://github.com/ClickHouse/ClickHouse/pull/3969) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлена ошибка, из-за которой сервер не мог запускаться с сообщением `bash: /usr/bin/clickhouse-extract-from-config: Operation not permitted` в Docker или systemd-nspawn. [#4136](https://github.com/ClickHouse/ClickHouse/pull/4136) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Обновлена библиотека `rdkafka` до v1.0.0-RC5. Вместо низкоуровневого C-интерфейса использован cppkafka. [#4025](https://github.com/ClickHouse/ClickHouse/pull/4025) ([Ivan](https://github.com/abyss7))
* Обновлена библиотека `mariadb-client`. Исправлена одна из проблем, обнаруженных UBSan. [#3924](https://github.com/ClickHouse/ClickHouse/pull/3924) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Несколько исправлений для сборок с UBSan. [#3926](https://github.com/ClickHouse/ClickHouse/pull/3926) [#3021](https://github.com/ClickHouse/ClickHouse/pull/3021) [#3948](https://github.com/ClickHouse/ClickHouse/pull/3948) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Добавлены прогоны тестов на сборке UBSan для каждого коммита.
* Добавлены проверки статическим анализатором PVS-Studio, выполняемые при каждом коммите.
* Исправлены ошибки, обнаруженные PVS-Studio. [#4013](https://github.com/ClickHouse/ClickHouse/pull/4013) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлены проблемы совместимости с glibc. [#4100](https://github.com/ClickHouse/ClickHouse/pull/4100) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Обновить Docker-образы до версии 18.10 и добавить файл совместимости для glibc &gt;= 2.28 [#3965](https://github.com/ClickHouse/ClickHouse/pull/3965) ([alesapin](https://github.com/alesapin))
* Добавлена переменная окружения для случаев, когда пользователь не хочет изменять владельца директорий (`chown`) в серверном Docker-образе. [#3967](https://github.com/ClickHouse/ClickHouse/pull/3967) ([alesapin](https://github.com/alesapin))
* Включена большая часть предупреждений из `-Weverything` в clang. Включен `-Wpedantic`. [#3986](https://github.com/ClickHouse/ClickHouse/pull/3986) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Добавлено ещё несколько предупреждений, доступных только в clang 8. [#3993](https://github.com/ClickHouse/ClickHouse/pull/3993) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Линковаться с `libLLVM`, а не с отдельными библиотеками LLVM при динамической линковке. [#3989](https://github.com/ClickHouse/ClickHouse/pull/3989) ([Orivej Desh](https://github.com/orivej))
* Добавлены переменные санитайзеров для тестовых образов. [#4072](https://github.com/ClickHouse/ClickHouse/pull/4072) ([alesapin](https://github.com/alesapin))
* Пакет `clickhouse-server` для Debian теперь будет рекомендовать пакет `libcap2-bin` для использования утилиты `setcap` для назначения capability. Это необязательно. [#4093](https://github.com/ClickHouse/ClickHouse/pull/4093) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Ускорена компиляция, исправлены include-файлы. [#3898](https://github.com/ClickHouse/ClickHouse/pull/3898) ([proller](https://github.com/proller))
* Добавлены тесты производительности для хеш-функций. [#3918](https://github.com/ClickHouse/ClickHouse/pull/3918) ([filimonov](https://github.com/filimonov))
* Исправлены циклические зависимости библиотек. [#3958](https://github.com/ClickHouse/ClickHouse/pull/3958) ([proller](https://github.com/proller))
* Улучшена компиляция при малом объёме доступной памяти. [#4030](https://github.com/ClickHouse/ClickHouse/pull/4030) ([proller](https://github.com/proller))
* Добавлен тестовый скрипт для воспроизведения снижения производительности в `jemalloc`. [#4036](https://github.com/ClickHouse/ClickHouse/pull/4036) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Исправлены опечатки в комментариях и строковых литералах в `dbms`. [#4122](https://github.com/ClickHouse/ClickHouse/pull/4122) ([maiha](https://github.com/maiha))
* Исправлены опечатки в комментариях. [#4089](https://github.com/ClickHouse/ClickHouse/pull/4089) ([Evgenii Pravda](https://github.com/kvinty))





## [Журнал изменений за 2018 год](./2018.md) {#changelog-for-2018}
