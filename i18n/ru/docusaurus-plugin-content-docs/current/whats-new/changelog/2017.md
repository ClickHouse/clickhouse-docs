---
slug: /whats-new/changelog/2017
sidebar_position: 10
sidebar_label: "2017"
title: "Журнал изменений 2017"
description: "Журнал изменений за 2017 год"
doc_type: "changelog"
keywords:
  [
    "ClickHouse 2017",
    "журнал изменений 2017",
    "примечания к выпуску",
    "история версий",
    "ранние выпуски"
  ]
---

### Выпуск ClickHouse 1.1.54327, 2017-12-21 {#clickhouse-release-1-1-54327-2017-12-21}

Этот выпуск содержит исправления ошибок для предыдущего выпуска 1.1.54318:

- Исправлена ошибка с возможным состоянием гонки в репликации, которая могла привести к потере данных. Эта проблема затрагивает версии 1.1.54310 и 1.1.54318. Если вы используете одну из этих версий с реплицируемыми таблицами, настоятельно рекомендуется обновление. Эта проблема проявляется в логах в виде предупреждающих сообщений типа `Part ... from own log does not exist.` Проблема актуальна, даже если вы не видите эти сообщения в логах.

### Выпуск ClickHouse 1.1.54318, 2017-11-30 {#clickhouse-release-1-1-54318-2017-11-30}

Этот выпуск содержит исправления ошибок для предыдущего выпуска 1.1.54310:

- Исправлено некорректное удаление строк при слияниях в движке SummingMergeTree
- Исправлена утечка памяти в нереплицируемых движках MergeTree
- Исправлена деградация производительности при частых вставках в движках MergeTree
- Исправлена проблема, которая приводила к остановке очереди репликации
- Исправлена ротация и архивирование логов сервера

### Выпуск ClickHouse 1.1.54310, 2017-11-01 {#clickhouse-release-1-1-54310-2017-11-01}

#### Новые возможности: {#new-features}

- Пользовательский ключ партиционирования для семейства табличных движков MergeTree.
- Табличный движок [Kafka](/engines/table-engines/integrations/kafka).
- Добавлена поддержка загрузки моделей [CatBoost](https://yandex.com/dev/catboost/) и их применения к данным, хранящимся в ClickHouse.
- Добавлена поддержка часовых поясов с нецелочисленными смещениями от UTC.
- Добавлена поддержка арифметических операций с временными интервалами.
- Диапазон значений для типов Date и DateTime расширен до 2105 года.
- Добавлен запрос `CREATE MATERIALIZED VIEW x TO y` (указывает существующую таблицу для хранения данных материализованного представления).
- Добавлен запрос `ATTACH TABLE` без аргументов.
- Логика обработки вложенных столбцов с именами, заканчивающимися на -Map, в таблице SummingMergeTree была выделена в агрегатную функцию sumMap. Теперь можно указывать такие столбцы явно.
- Максимальный размер IP trie словаря увеличен до 128 миллионов записей.
- Добавлена функция getSizeOfEnumType.
- Добавлена агрегатная функция sumWithOverflow.
- Добавлена поддержка входного формата Cap'n Proto.
- Теперь можно настраивать уровень сжатия при использовании алгоритма zstd.

#### Обратно несовместимые изменения: {#backward-incompatible-changes}

- Создание временных таблиц с движком, отличным от Memory, не разрешено.
- Явное создание таблиц с движком View или MaterializedView не разрешено.
- При создании таблицы новая проверка верифицирует, что выражение ключа сэмплирования включено в первичный ключ.

#### Исправления ошибок: {#bug-fixes}

- Исправлены зависания при синхронной вставке в распределённую таблицу.
- Исправлено неатомарное добавление и удаление кусков в реплицируемых таблицах.
- Данные, вставленные в материализованное представление, больше не подвергаются ненужной дедупликации.
- Выполнение запроса к распределённой таблице, для которой локальная реплика отстаёт, а удалённые реплики недоступны, больше не приводит к ошибке.
- Пользователям больше не требуются права доступа к базе данных `default` для создания временных таблиц.
- Исправлено падение при указании типа Array без аргументов.
- Исправлены зависания, когда дисковый том, содержащий логи сервера, заполнен.
- Исправлено переполнение в функции toRelativeWeekNum для первой недели эпохи Unix.

#### Улучшения сборки: {#build-improvements}

- Несколько сторонних библиотек (в частности, Poco) были обновлены и преобразованы в git-подмодули.

### Выпуск ClickHouse 1.1.54304, 2017-10-19 {#clickhouse-release-1-1-54304-2017-10-19}

#### Новые возможности: {#new-features-1}

- Поддержка TLS в нативном протоколе (для включения установите `tcp_ssl_port` в `config.xml`).

#### Исправления ошибок: {#bug-fixes-1}


- `ALTER` для реплицируемых таблиц теперь пытается начать выполнение как можно раньше.
- Исправлено падение при чтении данных с настройкой `preferred_block_size_bytes=0.`
- Исправлены падения `clickhouse-client` при нажатии `Page Down`
- Корректная интерпретация некоторых сложных запросов с `GLOBAL IN` и `UNION ALL`
- `FREEZE PARTITION` теперь всегда работает атомарно.
- Пустые POST-запросы теперь возвращают ответ с кодом 411.
- Исправлены ошибки интерпретации для выражений вида `CAST(1 AS Nullable(UInt8)).`
- Исправлена ошибка при чтении столбцов `Array(Nullable(String))` из таблиц `MergeTree`.
- Исправлено падение при разборе запросов вида `SELECT dummy AS dummy, dummy AS b`
- Пользователи корректно обновляются при некорректном `users.xml`
- Корректная обработка случая, когда исполняемый словарь возвращает ненулевой код ответа.

### Релиз ClickHouse 1.1.54292, 2017-09-20 {#clickhouse-release-1-1-54292-2017-09-20}

#### Новые возможности: {#new-features-2}

- Добавлена функция `pointInPolygon` для работы с координатами на координатной плоскости.
- Добавлена агрегатная функция `sumMap` для вычисления суммы массивов, аналогично `SummingMergeTree`.
- Добавлена функция `trunc`. Улучшена производительность функций округления (`round`, `floor`, `ceil`, `roundToExp2`) и исправлена логика их работы. Изменена логика функции `roundToExp2` для дробных и отрицательных чисел.
- Исполняемый файл ClickHouse теперь менее зависим от версии libc. Один и тот же исполняемый файл ClickHouse может работать на широком спектре систем Linux. Зависимость всё ещё существует при использовании скомпилированных запросов (с настройкой `compile = 1`, которая не используется по умолчанию).
- Сокращено время, необходимое для динамической компиляции запросов.

#### Исправления ошибок: {#bug-fixes-2}

- Исправлена ошибка, которая иногда приводила к сообщениям `part ... intersects previous part` и ослабляла консистентность реплик.
- Исправлена ошибка, которая приводила к зависанию сервера, если ZooKeeper был недоступен во время завершения работы.
- Удалено избыточное логирование при восстановлении реплик.
- Исправлена ошибка в реализации UNION ALL.
- Исправлена ошибка в функции concat, которая возникала, если первый столбец в блоке имеет тип Array.
- Прогресс теперь корректно отображается в таблице system.merges.

### Релиз ClickHouse 1.1.54289, 2017-09-13 {#clickhouse-release-1-1-54289-2017-09-13}

#### Новые возможности: {#new-features-3}

- Запросы `SYSTEM` для администрирования сервера: `SYSTEM RELOAD DICTIONARY`, `SYSTEM RELOAD DICTIONARIES`, `SYSTEM DROP DNS CACHE`, `SYSTEM SHUTDOWN`, `SYSTEM KILL`.
- Добавлены функции для работы с массивами: `concat`, `arraySlice`, `arrayPushBack`, `arrayPushFront`, `arrayPopBack`, `arrayPopFront`.
- Добавлены параметры `root` и `identity` для конфигурации ZooKeeper. Это позволяет изолировать отдельных пользователей в одном кластере ZooKeeper.
- Добавлены агрегатные функции `groupBitAnd`, `groupBitOr` и `groupBitXor` (для совместимости они также доступны под именами `BIT_AND`, `BIT_OR` и `BIT_XOR`).
- Внешние словари могут загружаться из MySQL путём указания сокета в файловой системе.
- Внешние словари могут загружаться из MySQL через SSL (параметры `ssl_cert`, `ssl_key`, `ssl_ca`).
- Добавлена настройка `max_network_bandwidth_for_user` для ограничения общего использования пропускной способности для запросов на одного пользователя.
- Поддержка `DROP TABLE` для временных таблиц.
- Поддержка чтения значений `DateTime` в формате Unix timestamp из форматов `CSV` и `JSONEachRow`.
- Отстающие реплики в распределённых запросах теперь исключаются по умолчанию (порог по умолчанию составляет 5 минут).
- Во время ALTER используется блокировка FIFO: запрос ALTER не блокируется бесконечно для непрерывно выполняющихся запросов.
- Возможность установки `umask` в конфигурационном файле.
- Улучшена производительность для запросов с `DISTINCT`.

#### Исправления ошибок: {#bug-fixes-3}


- Улучшен процесс удаления старых узлов в ZooKeeper. Ранее старые узлы иногда не удалялись при очень частых вставках, что приводило, помимо прочего, к медленному завершению работы сервера.
- Исправлена рандомизация при выборе хостов для подключения к ZooKeeper.
- Исправлено исключение отстающих реплик в распределённых запросах, если реплика является localhost.
- Исправлена ошибка, при которой часть данных в таблице `ReplicatedMergeTree` могла быть повреждена после выполнения `ALTER MODIFY` для элемента в структуре `Nested`.
- Исправлена ошибка, которая могла приводить к «зависанию» запросов SELECT.
- Улучшения распределённых DDL-запросов.
- Исправлен запрос `CREATE TABLE ... AS <materialized view>`.
- Устранена взаимоблокировка в запросе `ALTER ... CLEAR COLUMN IN PARTITION` для таблиц `Buffer`.
- Исправлено неверное значение по умолчанию для `Enum` (0 вместо минимального) при использовании форматов `JSONEachRow` и `TSKV`.
- Устранено появление процессов-зомби при использовании словаря с источником `executable`.
- Исправлена ошибка segfault для запроса HEAD.

#### Улучшенный рабочий процесс разработки и сборки ClickHouse: {#improved-workflow-for-developing-and-assembling-clickhouse}

- Для сборки ClickHouse можно использовать `pbuilder`.
- Для сборки на Linux можно использовать `libc++` вместо `libstdc++`.
- Добавлены инструкции по использованию инструментов статического анализа кода: `Coverage`, `clang-tidy`, `cppcheck`.

#### Обратите внимание при обновлении: {#please-note-when-upgrading}

- Теперь установлено более высокое значение по умолчанию для настройки MergeTree `max_bytes_to_merge_at_max_space_in_pool` (максимальный общий размер частей данных для слияния в байтах): оно увеличено со 100 ГиБ до 150 ГиБ. Это может привести к выполнению крупных слияний после обновления сервера, что может вызвать повышенную нагрузку на дисковую подсистему. Если свободное место на сервере меньше, чем удвоенный общий объём выполняющихся слияний, это приведёт к остановке всех остальных слияний, включая слияния небольших частей данных. В результате запросы INSERT будут завершаться с ошибкой «Merges are processing significantly slower than inserts». Используйте запрос `SELECT * FROM system.merges` для мониторинга ситуации. Также можно проверить метрику `DiskSpaceReservedForMerge` в таблице `system.metrics` или в Graphite. Вам не нужно ничего делать для исправления этой ситуации, так как проблема разрешится сама после завершения крупных слияний. Если это неприемлемо, вы можете восстановить предыдущее значение настройки `max_bytes_to_merge_at_max_space_in_pool`. Для этого перейдите в раздел `<merge_tree>` в config.xml, установите `<merge_tree>``<max_bytes_to_merge_at_max_space_in_pool>107374182400</max_bytes_to_merge_at_max_space_in_pool>` и перезапустите сервер.

### Релиз ClickHouse 1.1.54284, 2017-08-29 {#clickhouse-release-1-1-54284-2017-08-29}

- Это релиз с исправлениями ошибок для предыдущего релиза 1.1.54282. Он устраняет утечки в директории частей в ZooKeeper.

### Релиз ClickHouse 1.1.54282, 2017-08-23 {#clickhouse-release-1-1-54282-2017-08-23}

Этот релиз содержит исправления ошибок для предыдущего релиза 1.1.54276:

- Исправлена ошибка `DB::Exception: Assertion violation: !_path.empty()` при вставке в распределённую таблицу.
- Исправлен парсинг при вставке в формате RowBinary, если входные данные начинаются с «;».
- Ошибки при компиляции во время выполнения некоторых агрегатных функций (например, `groupArray()`).

### Релиз ClickHouse 1.1.54276, 2017-08-16 {#clickhouse-release-1-1-54276-2017-08-16}

#### Новые возможности: {#new-features-4}


- Добавлена опциональная секция WITH для запроса SELECT. Пример запроса: `WITH 1+1 AS a SELECT a, a*a`
- INSERT может выполняться синхронно в распределённой таблице: OK возвращается только после того, как все данные сохранены на всех шардах. Активируется настройкой insert_distributed_sync=1.
- Добавлен тип данных UUID для работы с 16-байтовыми идентификаторами.
- Добавлены псевдонимы типов CHAR, FLOAT и других для совместимости с Tableau.
- Добавлены функции toYYYYMM, toYYYYMMDD и toYYYYMMDDhhmmss для преобразования времени в числа.
- Можно использовать IP-адреса (вместе с именем хоста) для идентификации серверов при выполнении кластерных DDL-запросов.
- Добавлена поддержка неконстантных аргументов и отрицательных смещений в функции `substring(str, pos, len).`
- Добавлен параметр max_size для агрегатной функции `groupArray(max_size)(column)` и оптимизирована её производительность.

#### Основные изменения: {#main-changes}

- Улучшения безопасности: все файлы сервера создаются с правами доступа 0640 (можно изменить через параметр конфигурации `<umask>`).
- Улучшены сообщения об ошибках для запросов с некорректным синтаксисом.
- Значительно снижено потребление памяти и улучшена производительность при слиянии больших секций данных MergeTree.
- Значительно повышена производительность слияния данных для движка ReplacingMergeTree.
- Улучшена производительность асинхронных вставок из распределённой таблицы путём объединения нескольких исходных вставок. Для включения этой функциональности используйте настройку distributed_directory_monitor_batch_inserts=1.

#### Обратно несовместимые изменения: {#backward-incompatible-changes-1}

- Изменён бинарный формат агрегатных состояний функций `groupArray(array_column)` для массивов.

#### Полный список изменений: {#complete-list-of-changes}

- Добавлена настройка `output_format_json_quote_denormals`, которая включает вывод значений nan и inf в формате JSON.
- Оптимизировано выделение потоков при чтении из распределённой таблицы.
- Настройки могут быть сконфигурированы в режиме readonly, если значение не изменяется.
- Добавлена возможность извлечения нецелых гранул движка MergeTree для соблюдения ограничений на размер блока, указанный в настройке preferred_block_size_bytes. Цель — снизить потребление оперативной памяти и повысить локальность кэша при обработке запросов из таблиц с большими столбцами.
- Эффективное использование индексов, содержащих выражения вида `toStartOfHour(x)`, для условий вида `toStartOfHour(x) op constexpr.`
- Добавлены новые настройки для движков MergeTree (секция merge_tree в config.xml):
  - replicated_deduplication_window_seconds задаёт количество секунд, разрешённых для дедупликации вставок в реплицируемых таблицах.
  - cleanup_delay_period задаёт, как часто запускать очистку для удаления устаревших данных.
  - replicated_can_become_leader может предотвратить превращение реплики в лидера (и назначение слияний).
- Ускорена очистка для удаления устаревших данных из ZooKeeper.
- Множественные улучшения и исправления для кластерных DDL-запросов. Особый интерес представляет новая настройка distributed_ddl_task_timeout, которая ограничивает время ожидания ответа от серверов в кластере. Если DDL-запрос не был выполнен на всех хостах, ответ будет содержать ошибку таймаута, и запрос будет выполнен в асинхронном режиме.
- Улучшено отображение трассировок стека в логах сервера.
- Добавлено значение «none» для метода сжатия.
- Можно использовать несколько секций dictionaries_config в config.xml.
- Возможно подключение к MySQL через сокет в файловой системе.
- Таблица system.parts имеет новый столбец с информацией о размере меток в байтах.

#### Исправления ошибок: {#bug-fixes-4}


- Распределённые таблицы, использующие таблицу Merge, теперь корректно работают для запроса SELECT с условием на поле `_table`.
- Исправлено редкое состояние гонки в ReplicatedMergeTree при проверке кусков данных.
- Исправлено возможное зависание при «выборе лидера» во время запуска сервера.
- Настройка max_replica_delay_for_distributed_queries игнорировалась при использовании локальной реплики источника данных. Это исправлено.
- Исправлено некорректное поведение `ALTER TABLE CLEAR COLUMN IN PARTITION` при попытке очистить несуществующий столбец.
- Исправлено исключение в функции multiIf при использовании пустых массивов или строк.
- Исправлены избыточные выделения памяти при десериализации формата Native.
- Исправлено некорректное автоматическое обновление словарей Trie.
- Исправлено исключение при выполнении запросов с предложением GROUP BY из таблицы Merge при использовании SAMPLE.
- Исправлено падение GROUP BY при использовании distributed_aggregation_memory_efficient=1.
- Теперь можно указывать database.table в правой части IN и JOIN.
- Для параллельной агрегации использовалось слишком много потоков. Это исправлено.
- Исправлена работа функции «if» с аргументами FixedString.
- SELECT работал некорректно из распределённой таблицы для шардов с весом 0. Это исправлено.
- Выполнение `CREATE VIEW IF EXISTS` больше не вызывает падений.
- Исправлено некорректное поведение при установке input_format_skip_unknown_fields=1 и наличии отрицательных чисел.
- Исправлен бесконечный цикл в функции `dictGetHierarchy()` при наличии некорректных данных в словаре.
- Исправлены ошибки `Syntax error: unexpected (...)` при выполнении распределённых запросов с подзапросами в предложении IN или JOIN и таблицами Merge.
- Исправлена некорректная интерпретация запроса SELECT из таблиц Dictionary.
- Исправлена ошибка «Cannot mremap» при использовании массивов в предложениях IN и JOIN с более чем 2 миллиардами элементов.
- Исправлено переключение при отказе для словарей с MySQL в качестве источника.

#### Улучшенный рабочий процесс разработки и сборки ClickHouse: {#improved-workflow-for-developing-and-assembling-clickhouse-1}

- Сборки можно выполнять в Arcadia.
- Можно использовать gcc 7 для компиляции ClickHouse.
- Параллельные сборки с использованием ccache+distcc теперь выполняются быстрее.

### Релиз ClickHouse 1.1.54245, 2017-07-04 {#clickhouse-release-1-1-54245-2017-07-04}

#### Новые возможности: {#new-features-5}

- Распределённый DDL (например, `CREATE TABLE ON CLUSTER`)
- Реплицируемый запрос `ALTER TABLE CLEAR COLUMN IN PARTITION.`
- Движок для таблиц Dictionary (доступ к данным словаря в виде таблицы).
- Движок базы данных Dictionary (этот тип базы данных автоматически предоставляет таблицы Dictionary для всех подключённых внешних словарей).
- Можно проверять обновления словаря, отправляя запрос к источнику.
- Квалифицированные имена столбцов
- Заключение идентификаторов в двойные кавычки.
- Сессии в HTTP-интерфейсе.
- Запрос OPTIMIZE для реплицируемой таблицы может выполняться не только на лидере.

#### Обратно несовместимые изменения: {#backward-incompatible-changes-2}

- Удалён SET GLOBAL.

#### Незначительные изменения: {#minor-changes}

- Теперь после срабатывания оповещения в лог выводится полная трассировка стека.
- Ослаблена проверка количества повреждённых/лишних кусков данных при запуске (было слишком много ложных срабатываний).

#### Исправления ошибок: {#bug-fixes-5}

- Исправлено «зависание» плохого соединения при вставке в распределённую таблицу.
- GLOBAL IN теперь работает для запроса из таблицы Merge, обращающегося к распределённой таблице.
- На виртуальной машине Google Compute Engine определялось неверное количество ядер. Это исправлено.
- Изменения в работе исполняемого источника кешируемых внешних словарей.
- Исправлено сравнение строк, содержащих нулевые символы.
- Исправлено сравнение полей первичного ключа Float32 с константами.
- Ранее некорректная оценка размера поля могла приводить к чрезмерно большим выделениям памяти.
- Исправлено падение при запросе к столбцу Nullable, добавленному в таблицу с помощью ALTER.
- Исправлено падение при сортировке по столбцу Nullable, если количество строк меньше LIMIT.
- Исправлен подзапрос ORDER BY, состоящий только из константных значений.
- Ранее реплицируемая таблица могла оставаться в недопустимом состоянии после неудачного DROP TABLE.
- Псевдонимы для скалярных подзапросов с пустыми результатами больше не теряются.
- Теперь запрос, использующий компиляцию, не завершается с ошибкой, если файл .so повреждён.
