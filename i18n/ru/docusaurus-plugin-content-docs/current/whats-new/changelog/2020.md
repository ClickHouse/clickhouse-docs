---
slug: /whats-new/changelog/2020
sidebar_position: 7
sidebar_label: "2020"
title: "Список изменений за 2020 год"
description: "Список изменений за 2020 год"
doc_type: "changelog"
keywords:
  [
    "ClickHouse 2020",
    "changelog 2020",
    "информация о релизах",
    "история версий",
    "исправления ошибок"
  ]
---

### Релиз ClickHouse 20.12 {#clickhouse-release-2012}

### Релиз ClickHouse v20.12.5.14-stable, 2020-12-28 {#clickhouse-release-v2012514-stable-2020-12-28}

#### Исправления ошибок {#bug-fix}

- Отключена запись с AIO во время слияний, так как это может приводить к крайне редкой порче данных в столбцах первичного ключа при слиянии. [#18481](https://github.com/ClickHouse/ClickHouse/pull/18481) ([alesapin](https://github.com/alesapin)).
- Исправлена ошибка `value is too short` при выполнении функций `toType(...)` (`toDate`, `toUInt32` и т. д.) с аргументом типа `Nullable(String)`. Теперь при ошибках разбора такие функции возвращают `NULL` вместо генерации исключения. Исправляет [#7673](https://github.com/ClickHouse/ClickHouse/issues/7673). [#18445](https://github.com/ClickHouse/ClickHouse/pull/18445) ([tavplubix](https://github.com/tavplubix)).
- Ограничены слияния из широких частей в компактные. В случае вертикального слияния это приводило к повреждению результирующей части. [#18381](https://github.com/ClickHouse/ClickHouse/pull/18381) ([Anton Popov](https://github.com/CurtizJ)).
- Исправлено заполнение таблицы `system.settings_profile_elements`. Этот PR исправляет [#18231](https://github.com/ClickHouse/ClickHouse/issues/18231). [#18379](https://github.com/ClickHouse/ClickHouse/pull/18379) ([Vitaly Baranov](https://github.com/vitlibar)).
- Исправлены возможные сбои в агрегатных функциях с комбинатором `Distinct` при использовании двухуровневой агрегации. Исправляет [#17682](https://github.com/ClickHouse/ClickHouse/issues/17682). [#18365](https://github.com/ClickHouse/ClickHouse/pull/18365) ([Anton Popov](https://github.com/CurtizJ)).
- Исправлена ошибка, при которой запрос `MODIFY COLUMN ... REMOVE TTL` фактически не удалял TTL столбца. [#18130](https://github.com/ClickHouse/ClickHouse/pull/18130) ([alesapin](https://github.com/alesapin)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement}

- Обновлена информация о часовых поясах до версии 2020e. [#18531](https://github.com/ClickHouse/ClickHouse/pull/18531) ([alesapin](https://github.com/alesapin)).

### Релиз ClickHouse v20.12.4.5-stable, 2020-12-24 {#clickhouse-release-v201245-stable-2020-12-24}

#### Исправления ошибок {#bug-fix-1}


- Исправлена проблема, когда процесс `clickhouse-odbc-bridge` недоступен для сервера на машинах с двойным стеком IPv4/IPv6; - Исправлена проблема, когда обновления ODBC-словарей выполняются с использованием некорректных запросов и/или вызывают сбои; Возможно, закрывает [#14489](https://github.com/ClickHouse/ClickHouse/issues/14489). [#18278](https://github.com/ClickHouse/ClickHouse/pull/18278) ([Denis Glazachev](https://github.com/traceon)).
- Исправлено сравнение ключей между типами Enum и Int. Это исправляет [#17989](https://github.com/ClickHouse/ClickHouse/issues/17989). [#18214](https://github.com/ClickHouse/ClickHouse/pull/18214) ([Amos Bird](https://github.com/amosbird)).
- Исправлен сбой при преобразовании уникального ключа в движке базы данных `MaterializeMySQL`. Это исправляет [#18186](https://github.com/ClickHouse/ClickHouse/issues/18186) и исправляет [#16372](https://github.com/ClickHouse/ClickHouse/issues/16372) [#18211](https://github.com/ClickHouse/ClickHouse/pull/18211) ([Winter Zhang](https://github.com/zhang2014)).
- Исправлена ошибка `std::out_of_range: basic_string` при парсинге URL S3. [#18059](https://github.com/ClickHouse/ClickHouse/pull/18059) ([Vladimir Chebotarev](https://github.com/excitoon)).
- Исправлена проблема, когда некоторые таблицы не синхронизировались в ClickHouse из MySQL из-за того, что преобразование префиксного индекса MySQL не поддерживалось для MaterializeMySQL. Это исправляет [#15187](https://github.com/ClickHouse/ClickHouse/issues/15187) и исправляет [#17912](https://github.com/ClickHouse/ClickHouse/issues/17912) [#17944](https://github.com/ClickHouse/ClickHouse/pull/17944) ([Winter Zhang](https://github.com/zhang2014)).
- Исправлена проблема, когда оптимизация запроса давала неверный результат, если запрос содержит `ARRAY JOIN`. [#17887](https://github.com/ClickHouse/ClickHouse/pull/17887) ([sundyli](https://github.com/sundy-li)).
- Исправлен возможный segfault в агрегатной функции `topK`. Это закрывает [#17404](https://github.com/ClickHouse/ClickHouse/issues/17404). [#17845](https://github.com/ClickHouse/ClickHouse/pull/17845) ([Maksim Kita](https://github.com/kitaisreal)).
- Исправлена пустая таблица `system.stack_trace`, когда сервер работает в режиме демона. [#17630](https://github.com/ClickHouse/ClickHouse/pull/17630) ([Amos Bird](https://github.com/amosbird)).

### Релиз ClickHouse v20.12.3.3-stable, 2020-12-13 {#clickhouse-release-v201233-stable-2020-12-13}

#### Обратно несовместимое изменение {#backward-incompatible-change}

- Включена настройка `use_compact_format_in_distributed_parts_names` по умолчанию (см. документацию для справки). [#16728](https://github.com/ClickHouse/ClickHouse/pull/16728) ([Azat Khuzhin](https://github.com/azat)).
- Принимаются пользовательские настройки, связанные с форматами файлов (например, `format_csv_delimiter`), в секции `SETTINGS` при создании таблицы, использующей движок `File`, и эти настройки используются во всех операциях `INSERT` и `SELECT`. Настройки формата файла, измененные в текущей пользовательской сессии или в секции `SETTINGS` самого DML-запроса, больше не влияют на запрос. [#16591](https://github.com/ClickHouse/ClickHouse/pull/16591) ([Alexander Kuzmenkov](https://github.com/akuzm)).

#### Новая функциональность {#new-feature}


- добавлена поддержка сжатия/распаковки `*.xz`. Это позволяет использовать `*.xz` в функции `file()`. Закрывает [#8828](https://github.com/ClickHouse/ClickHouse/issues/8828). [#16578](https://github.com/ClickHouse/ClickHouse/pull/16578) ([Abi Palagashvili](https://github.com/fibersel)).
- добавлен запрос `ALTER TABLE ... DROP|DETACH PART 'part_name'`. [#15511](https://github.com/ClickHouse/ClickHouse/pull/15511) ([nvartolomei](https://github.com/nvartolomei)).
- добавлен новый синтаксис ALTER UPDATE/DELETE IN PARTITION. [#13403](https://github.com/ClickHouse/ClickHouse/pull/13403) ([Vladimir Chebotarev](https://github.com/excitoon)).
- добавлена возможность форматирования именованных кортежей как JSON-объектов при использовании форматов ввода/вывода JSON. Управляется настройкой `output_format_json_named_tuples_as_objects`, по умолчанию отключена. [#17175](https://github.com/ClickHouse/ClickHouse/pull/17175) ([Alexander Kuzmenkov](https://github.com/akuzm)).
- добавлена возможность ввода значения enum по его идентификатору в форматах TSV и CSV по умолчанию. [#16834](https://github.com/ClickHouse/ClickHouse/pull/16834) ([Kruglov Pavel](https://github.com/Avogar)).
- добавлена поддержка COLLATE для типов Nullable, LowCardinality, Array и Tuple, где вложенный тип — String. Также выполнен рефакторинг кода, связанного с сопоставлениями, в ColumnString.cpp. [#16273](https://github.com/ClickHouse/ClickHouse/pull/16273) ([Kruglov Pavel](https://github.com/Avogar)).
- новая функция `tcpPort` возвращает TCP-порт, прослушиваемый сервером. [#17134](https://github.com/ClickHouse/ClickHouse/pull/17134) ([Ivan](https://github.com/abyss7)).
- добавлены новые математические функции: `acosh`, `asinh`, `atan2`, `atanh`, `cosh`, `hypot`, `log1p`, `sinh`. [#16636](https://github.com/ClickHouse/ClickHouse/pull/16636) ([Konstantin Malanchev](https://github.com/hombit)).
- добавлена возможность распределения слияний между различными репликами. Введена настройка MergeTree `execute_merges_on_single_replica_time_threshold`. [#16424](https://github.com/ClickHouse/ClickHouse/pull/16424) ([filimonov](https://github.com/filimonov)).
- добавлена настройка `aggregate_functions_null_for_empty` для совместимости со стандартом SQL. Эта опция перезаписывает все агрегатные функции в запросе, добавляя к ним суффикс -OrNull. Реализует [10273](https://github.com/ClickHouse/ClickHouse/issues/10273). [#16123](https://github.com/ClickHouse/ClickHouse/pull/16123) ([flynn](https://github.com/ucasFL)).
- обновлён парсинг DateTime и DateTime64 для поддержки строкового формата литерала Date. [#16040](https://github.com/ClickHouse/ClickHouse/pull/16040) ([Maksim Kita](https://github.com/kitaisreal)).
- добавлена возможность изменения пути к файлу истории в `clickhouse-client` с помощью параметра `--history_file`. [#15960](https://github.com/ClickHouse/ClickHouse/pull/15960) ([Maksim Kita](https://github.com/kitaisreal)).

#### Исправление ошибок {#bug-fix-2}


* Исправлена проблема, из-за которой сервер в крайне редких случаях мог переставать принимать подключения. [#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка `Function not implemented` при выполнении запроса `RENAME` в базе данных `Atomic` при запуске ClickHouse в Windows Subsystem for Linux. Исправлена [#17661](https://github.com/ClickHouse/ClickHouse/issues/17661). [#17664](https://github.com/ClickHouse/ClickHouse/pull/17664) ([tavplubix](https://github.com/tavplubix)).
* Не восстанавливать парты из WAL, если `in_memory_parts_enable_wal` отключён. [#17802](https://github.com/ClickHouse/ClickHouse/pull/17802) ([detailyang](https://github.com/detailyang)).
* исправлена некорректная инициализация `max_compress_block_size` в MergeTreeWriterSettings значением `min_compress_block_size`. [#17833](https://github.com/ClickHouse/ClickHouse/pull/17833) ([flynn](https://github.com/ucasFL)).
* Сообщение об исключении о максимальном размере удаляемой таблицы отображалось некорректно. [#17764](https://github.com/ClickHouse/ClickHouse/pull/17764) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена возможная ошибка сегментации при недостатке места во время вставки в таблицу `Distributed`. [#17737](https://github.com/ClickHouse/ClickHouse/pull/17737) ([tavplubix](https://github.com/tavplubix)).
* Исправлена проблема, из-за которой ClickHouse не удавалось восстановить подключение к серверам MySQL. [#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz)).
* Могло некорректно определяться, является ли кластер кольцево (кросс-) реплицированным при выполнении запроса `ON CLUSTER` из-за состояния гонки при значении `pool_size` &gt; 1. Исправлено. [#17640](https://github.com/ClickHouse/ClickHouse/pull/17640) ([tavplubix](https://github.com/tavplubix)).
* Исключение `fmt::v7::format_error` может логироваться в фоновом режиме для таблиц MergeTree. Это исправляет [#17613](https://github.com/ClickHouse/ClickHouse/issues/17613). [#17615](https://github.com/ClickHouse/ClickHouse/pull/17615) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Когда `clickhouse-client` использовался в интерактивном режиме с многострочными запросами, однострочный комментарий ошибочно считался продолжающимся до конца всего запроса. Это исправляет [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654). [#17565](https://github.com/ClickHouse/ClickHouse/pull/17565) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено зависание запроса ALTER, когда соответствующая мутация была прервана на другой реплике. Исправляет [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953). [#17499](https://github.com/ClickHouse/ClickHouse/pull/17499) ([alesapin](https://github.com/alesapin)).
* Исправлена проблема, из-за которой ClickHouse занижал размер кэша меток. Это могло происходить при большом количестве очень маленьких файлов с метками. [#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin)).
* Исправлена работа `ORDER BY` при включённой настройке `optimize_redundant_functions_in_order_by`. [#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены дубликаты после `DISTINCT`, которые возникали из-за некорректной оптимизации. Исправляет [#17294](https://github.com/ClickHouse/ClickHouse/issues/17294). [#17296](https://github.com/ClickHouse/ClickHouse/pull/17296) ([li chengxiang](https://github.com/chengxianglibra)). [#17439](https://github.com/ClickHouse/ClickHouse/pull/17439) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен сбой при чтении из таблицы `JOIN` с типами `LowCardinality`. Исправление для [#17228](https://github.com/ClickHouse/ClickHouse/issues/17228). [#17397](https://github.com/ClickHouse/ClickHouse/pull/17397) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* исправлен stack overflow в `toInt256(inf)`. Int256 — экспериментальная возможность. Закрыто [#17235](https://github.com/ClickHouse/ClickHouse/issues/17235). [#17257](https://github.com/ClickHouse/ClickHouse/pull/17257) ([flynn](https://github.com/ucasFL)).
* Исправлена возможная ошибка `Unexpected packet Data received from client`, которая записывалась в лог для распределённых запросов с `LIMIT`. [#17254](https://github.com/ClickHouse/ClickHouse/pull/17254) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена инвалидация индекса множества при наличии константных столбцов в подзапросе. Это исправляет [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246). [#17249](https://github.com/ClickHouse/ClickHouse/pull/17249) ([Amos Bird](https://github.com/amosbird)).
* Исправлен возможный некорректный анализ индекса, когда типы операндов в сравнении с индексом различаются. Это исправляет [#17122](https://github.com/ClickHouse/ClickHouse/issues/17122). [#17145](https://github.com/ClickHouse/ClickHouse/pull/17145) ([Amos Bird](https://github.com/amosbird)).
* Исправлено сравнение ColumnConst, приводившее к сбою. Это устранило [#17088](https://github.com/ClickHouse/ClickHouse/issues/17088). [#17135](https://github.com/ClickHouse/ClickHouse/pull/17135) ([Amos Bird](https://github.com/amosbird)).
* Несколько исправлений для MaterializeMySQL (экспериментальная функциональность). Исправляет [#16923](https://github.com/ClickHouse/ClickHouse/issues/16923) Исправляет [#15883](https://github.com/ClickHouse/ClickHouse/issues/15883) Исправлена ошибка сбоя синхронизации MaterializeMySQL при изменении параметра MySQL `binlog_checksum`. [#17091](https://github.com/ClickHouse/ClickHouse/pull/17091) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена ошибка, из-за которой запросы с `ON CLUSTER` могли зависать навсегда на не-лидерных таблицах ReplicatedMergeTree. [#17089](https://github.com/ClickHouse/ClickHouse/pull/17089) ([alesapin](https://github.com/alesapin)).
* Исправлено падение при выполнении запроса `CREATE TABLE ... AS some_table`, когда `some_table` была создана с помощью `AS table_function()`. Исправляет [#16944](https://github.com/ClickHouse/ClickHouse/issues/16944). [#17072](https://github.com/ClickHouse/ClickHouse/pull/17072) ([tavplubix](https://github.com/tavplubix)).
* Исправлена незавершённая реализация функции fuzzBits, связанное issue: [#16980](https://github.com/ClickHouse/ClickHouse/issues/16980). [#17051](https://github.com/ClickHouse/ClickHouse/pull/17051) ([hexiaoting](https://github.com/hexiaoting)).
* Исправлена библиотека LLVM libunwind для случая, когда регистром CFA является RAX. Это [ошибка](https://bugs.llvm.org/show_bug.cgi?id=48186) в [LLVM libunwind](https://github.com/llvm/llvm-project/tree/master/libunwind). У нас уже есть обходные решения для этой ошибки. [#17046](https://github.com/ClickHouse/ClickHouse/pull/17046) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Избегайте лишних сетевых ошибок для удалённых запросов, которые могут быть отменены во время выполнения, например запросов с `LIMIT`. [#17006](https://github.com/ClickHouse/ClickHouse/pull/17006) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена настройка `optimize_distributed_group_by_sharding_key` (по умолчанию отключена) для запросов только с OFFSET. [#16996](https://github.com/ClickHouse/ClickHouse/pull/16996) ([Azat Khuzhin](https://github.com/azat)).
* Исправление работы Merge-таблиц поверх Distributed-таблиц с JOIN. [#16993](https://github.com/ClickHouse/ClickHouse/pull/16993) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка вычисления больших целых чисел (128 и 256 бит) при приведении из `double`. Поддержка больших целых чисел является экспериментальной. [#16986](https://github.com/ClickHouse/ClickHouse/pull/16986) ([Mike](https://github.com/myrrc)).
* Исправлен возможный сбой сервера после выполнения `ALTER TABLE ... MODIFY COLUMN ... NewType`, когда запрос `SELECT` содержит условие `WHERE` по изменяемому столбцу, а операция `ALTER` ещё не завершена. [#16968](https://github.com/ClickHouse/ClickHouse/pull/16968) ([Amos Bird](https://github.com/amosbird)).
* Информация blame была рассчитана некорректно в `clickhouse-git-import`. [#16959](https://github.com/ClickHouse/ClickHouse/pull/16959) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена оптимизация ORDER BY с монотонными функциями. Исправляет [#16107](https://github.com/ClickHouse/ClickHouse/issues/16107). [#16956](https://github.com/ClickHouse/ClickHouse/pull/16956) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена оптимизация `GROUP BY` при включённой настройке `optimize_aggregators_of_group_by_keys` и при использовании `JOIN`. Исправляет [#12604](https://github.com/ClickHouse/ClickHouse/issues/12604). [#16951](https://github.com/ClickHouse/ClickHouse/pull/16951) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена возможная ошибка `Illegal type of argument` в запросах с `ORDER BY`. Исправляет [#16580](https://github.com/ClickHouse/ClickHouse/issues/16580). [#16928](https://github.com/ClickHouse/ClickHouse/pull/16928) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен некорректный код в InterpreterShowAccessQuery. [#16866](https://github.com/ClickHouse/ClickHouse/pull/16866) ([tavplubix](https://github.com/tavplubix)).
* Предотвращены сбои сервера ClickHouse при использовании функции `timeSeriesGroupSum`. Функция удалена из новых версий ClickHouse. [#16865](https://github.com/ClickHouse/ClickHouse/pull/16865) ([filimonov](https://github.com/filimonov)).
* Исправлены редкие «тихие» (без сообщений) сбои при включённом профилировщике запросов, когда ClickHouse установлен в ОС с версией glibc, в которой (предположительно) некорректно работают асинхронные таблицы развёртки для некоторых функций. Это исправляет [#15301](https://github.com/ClickHouse/ClickHouse/issues/15301). Это исправляет [#13098](https://github.com/ClickHouse/ClickHouse/issues/13098). [#16846](https://github.com/ClickHouse/ClickHouse/pull/16846) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено падение при использовании `any` без аргументов. Для [#16803](https://github.com/ClickHouse/ClickHouse/issues/16803). cc @azat. [#16826](https://github.com/ClickHouse/ClickHouse/pull/16826) ([Amos Bird](https://github.com/amosbird)).
* Если при записи метаданных таблицы на диск не удаётся выделить память, может быть создан повреждённый файл метаданных. [#16772](https://github.com/ClickHouse/ClickHouse/pull/16772) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена тривиальная оптимизация запроса с предикатом партиции. [#16767](https://github.com/ClickHouse/ClickHouse/pull/16767) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа оператора `IN` над несколькими столбцами и кортежами при включённой настройке `transform_null_in`. Исправляет [#15310](https://github.com/ClickHouse/ClickHouse/issues/15310). [#16722](https://github.com/ClickHouse/ClickHouse/pull/16722) ([Anton Popov](https://github.com/CurtizJ)).
* Возвращает количество затронутых строк для запросов INSERT по протоколу MySQL. Ранее ClickHouse всегда возвращал 0, теперь это исправлено. Исправляет [#16605](https://github.com/ClickHouse/ClickHouse/issues/16605). [#16715](https://github.com/ClickHouse/ClickHouse/pull/16715) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлен сбой удалённого запроса при использовании агрегатной функции с суффиксом `if`. Исправлены [#16574](https://github.com/ClickHouse/ClickHouse/issues/16574) [#16231](https://github.com/ClickHouse/ClickHouse/issues/16231) [#16610](https://github.com/ClickHouse/ClickHouse/pull/16610) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлено неконсистентное поведение, вызванное `select_sequential_consistency` для оптимизированного тривиального запроса `count` и `system.tables`. [#16309](https://github.com/ClickHouse/ClickHouse/pull/16309) ([Hao Chen](https://github.com/haoch)).

#### Улучшение {#improvement}


* Удалены пустые части после их удаления с помощью TTL, мутаций или алгоритма объединения с коллапсированием. [#16895](https://github.com/ClickHouse/ClickHouse/pull/16895) ([Anton Popov](https://github.com/CurtizJ)).
* Включён компактный формат каталогов для асинхронной отправки в таблицах `Distributed`: параметр `use_compact_format_in_distributed_parts_names` по умолчанию установлен в значение 1. [#16788](https://github.com/ClickHouse/ClickHouse/pull/16788) ([Azat Khuzhin](https://github.com/azat)).
* Прерывать многокомпонентную загрузку, если в S3 не было записано никаких данных. [#16840](https://github.com/ClickHouse/ClickHouse/pull/16840) ([Pavel Kovalenko](https://github.com/Jokser)).
* Повторно определять IP-адрес `format_avro_schema_registry_url` в случае ошибок. [#16985](https://github.com/ClickHouse/ClickHouse/pull/16985) ([filimonov](https://github.com/filimonov)).
* Замаскирован пароль в data&#95;path в system.distribution&#95;queue. [#16727](https://github.com/ClickHouse/ClickHouse/pull/16727) ([Azat Khuzhin](https://github.com/azat)).
* Выдавать ошибку при использовании `column transformer` для замены несуществующего столбца. [#16183](https://github.com/ClickHouse/ClickHouse/pull/16183) ([hexiaoting](https://github.com/hexiaoting)).
* Отключайте параллельный парсинг, если недостаточно памяти для одновременной работы всех потоков. Также возможны исключения вроде «Memory limit exceeded», когда кто-то попытается вставить чрезвычайно большие строки (&gt; min&#95;chunk&#95;bytes&#95;for&#95;parallel&#95;parsing), потому что каждый фрагмент для парсинга должен быть независимым набором строк (одной или нескольких). [#16721](https://github.com/ClickHouse/ClickHouse/pull/16721) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Скрипт установки всегда должен создавать подкаталоги в каталогах конфигурации. Это относится только к Docker-сборке с пользовательской конфигурацией. [#16936](https://github.com/ClickHouse/ClickHouse/pull/16936) ([filimonov](https://github.com/filimonov)).
* Исправлена грамматика сообщения об ошибке во входных форматах JSONEachRow, JSONCompactEachRow и RegexpRow. [#17205](https://github.com/ClickHouse/ClickHouse/pull/17205) ([nico piderman](https://github.com/sneako)).
* По умолчанию параметры `host` и `port` для `SOURCE(CLICKHOUSE(...))` теперь указывают на текущий экземпляр, а значение параметра `user` по умолчанию установлено в `'default'`. [#16997](https://github.com/ClickHouse/ClickHouse/pull/16997) ([vdimir](https://github.com/vdimir)).
* Выбрасывать информативное сообщение об ошибке при выполнении `ATTACH/DETACH TABLE <DICTIONARY>`. До этого PR `DETACH TABLE <dict>` выполнялась, но приводила к некорректным метаданным в памяти. [#16885](https://github.com/ClickHouse/ClickHouse/pull/16885) ([Amos Bird](https://github.com/amosbird)).
* Добавлена функция cutToFirstSignificantSubdomainWithWWW(). [#16845](https://github.com/ClickHouse/ClickHouse/pull/16845) ([Azat Khuzhin](https://github.com/azat)).
* Сервер не запускался и выдавал исключение, если был задан неверный конфиг (отсутствовал `metric_log`.`collect_interval_milliseconds`). [#16815](https://github.com/ClickHouse/ClickHouse/pull/16815) ([Ivan](https://github.com/abyss7)).
* Более понятное сообщение об исключении при отсутствии конфигурации для распределённого DDL. Это исправляет [#5075](https://github.com/ClickHouse/ClickHouse/issues/5075). [#16769](https://github.com/ClickHouse/ClickHouse/pull/16769) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Улучшение удобства использования: более информативные подсказки в сообщении об ошибке синтаксиса, когда выражение `CODEC` некорректно размещено в запросе `CREATE TABLE`. Исправляет [#12493](https://github.com/ClickHouse/ClickHouse/issues/12493). [#16768](https://github.com/ClickHouse/ClickHouse/pull/16768) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Удаление пустых каталогов для асинхронных INSERT при запуске движка Distributed. [#16729](https://github.com/ClickHouse/ClickHouse/pull/16729) ([Azat Khuzhin](https://github.com/azat)).
* Обходное решение для использования S3 с сервером nginx в качестве прокси. В текущей версии nginx не принимает URL с пустым путем, например `http://domain.com?delete`, тогда как стандартный aws-sdk-cpp генерирует URL именно в таком виде. Этот коммит использует исправленную версию aws-sdk-cpp, которая в таких случаях формирует URL с путём &quot;/&quot;, например `http://domain.com/?delete`. [#16709](https://github.com/ClickHouse/ClickHouse/pull/16709) ([ianton-ru](https://github.com/ianton-ru)).
* Разрешить функциям `reinterpretAs*` работать с целыми и вещественными числами одного размера. Реализует [16640](https://github.com/ClickHouse/ClickHouse/issues/16640). [#16657](https://github.com/ClickHouse/ClickHouse/pull/16657) ([flynn](https://github.com/ucasFL)).
* Теперь конфигурацию `<auxiliary_zookeepers>` в `config.xml` можно изменять и применять без перезапуска сервера. [#16627](https://github.com/ClickHouse/ClickHouse/pull/16627) ([Amos Bird](https://github.com/amosbird)).
* Реализована поддержка SNI в HTTPS-подключениях к удалённым ресурсам. Это позволяет подключаться к серверам Cloudflare, которые требуют SNI. Исправляет [#10055](https://github.com/ClickHouse/ClickHouse/issues/10055). [#16252](https://github.com/ClickHouse/ClickHouse/pull/16252) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Реализована поддержка подключения к защищённой конечной точке `clickhouse-server`, которая требует SNI. Это возможно, когда `clickhouse-server` размещён за TLS‑прокси. [#16938](https://github.com/ClickHouse/ClickHouse/pull/16938) ([filimonov](https://github.com/filimonov)).
* Исправлено возможное переполнение стека при создании цикла материализованных представлений. Это закрывает [#15732](https://github.com/ClickHouse/ClickHouse/issues/15732). [#16048](https://github.com/ClickHouse/ClickHouse/pull/16048) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Упростить реализацию обработки фоновых задач для семейства движков таблиц MergeTree. Для пользователя не должно быть заметных изменений. [#15983](https://github.com/ClickHouse/ClickHouse/pull/15983) ([alesapin](https://github.com/alesapin)).
* Улучшение для MaterializeMySQL (экспериментальная функция). Генерировать исключение с указанием требуемых привилегий синхронизации, если у MySQL-пользователя для синхронизации заданы неверные привилегии. [#15977](https://github.com/ClickHouse/ClickHouse/pull/15977) ([TCeason](https://github.com/TCeason)).
* Функция `indexOf()` теперь использует BloomFilter. [#14977](https://github.com/ClickHouse/ClickHouse/pull/14977) ([achimbab](https://github.com/achimbab)).

#### Улучшение производительности {#performance-improvement}

- Использован алгоритм Флойда-Ривеста, который является оптимальным для задачи частичной сортировки в ClickHouse. Результаты тестирования доступны на https://github.com/danlark1/miniselect и [здесь](https://drive.google.com/drive/folders/1DHEaeXgZuX6AJ9eByeZ8iQVQv0ueP8XM). [#16825](https://github.com/ClickHouse/ClickHouse/pull/16825) ([Danila Kutenin](https://github.com/danlark1)).
- Теперь семейство движков `ReplicatedMergeTree` использует отдельный пул потоков для репликационных загрузок. Размер пула ограничен настройкой `background_fetches_pool_size`, которая может быть изменена при перезапуске сервера. Значение по умолчанию равно 3, что означает максимальное количество параллельных загрузок, равное 3 (это позволяет эффективно использовать сеть 10G). Исправляет #520. [#16390](https://github.com/ClickHouse/ClickHouse/pull/16390) ([alesapin](https://github.com/alesapin)).
- Исправлен неконтролируемый рост состояния `quantileTDigest`. [#16680](https://github.com/ClickHouse/ClickHouse/pull/16680) ([hrissan](https://github.com/hrissan)).
- Добавлено описание подзапросов `VIEW` в `EXPLAIN`. Оптимизация проталкивания ограничений для `VIEW`. Добавлены локальные реплики `Distributed` в план запроса. [#14936](https://github.com/ClickHouse/ClickHouse/pull/14936) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Исправлена работа optimize_read_in_order/optimize_aggregation_in_order при max_threads > 0 и выражении в ORDER BY. [#16637](https://github.com/ClickHouse/ClickHouse/pull/16637) ([Azat Khuzhin](https://github.com/azat)).
- Исправлена производительность чтения из таблиц `Merge` при большом количестве таблиц `MergeTree`. Исправляет [#7748](https://github.com/ClickHouse/ClickHouse/issues/7748). [#16988](https://github.com/ClickHouse/ClickHouse/pull/16988) ([Anton Popov](https://github.com/CurtizJ)).
- Теперь можно безопасно отсекать партиции при точном совпадении. Полезный случай: предположим, таблица партиционирована по `intHash64(x) % 100`, и запрос содержит условие на `intHash64(x) % 100` в явном виде, а не на x. [#16253](https://github.com/ClickHouse/ClickHouse/pull/16253) ([Amos Bird](https://github.com/amosbird)).

#### Экспериментальная функциональность {#experimental-feature}

- Добавлен движок таблиц `EmbeddedRocksDB` (может использоваться для словарей). [#15073](https://github.com/ClickHouse/ClickHouse/pull/15073) ([sundyli](https://github.com/sundy-li)).

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-1}


* Улучшено тестовое покрытие при сборке образов. [#17233](https://github.com/ClickHouse/ClickHouse/pull/17233) ([alesapin](https://github.com/alesapin)).
* Обновлены встроенные данные часовых поясов до версии 2020d (также обновлён `cctz` до актуального `master`). [#17204](https://github.com/ClickHouse/ClickHouse/pull/17204) ([filimonov](https://github.com/filimonov)).
* Исправлен отчёт UBSan в Poco. Исправление закрывает [#12719](https://github.com/ClickHouse/ClickHouse/issues/12719). [#16765](https://github.com/ClickHouse/ClickHouse/pull/16765) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Отключена инструментализация сторонних библиотек с помощью UBSan. [#16764](https://github.com/ClickHouse/ClickHouse/pull/16764) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен отчёт UBSan в кэш-словарях. Исправление закрывает [#12641](https://github.com/ClickHouse/ClickHouse/issues/12641). [#16763](https://github.com/ClickHouse/ClickHouse/pull/16763) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен отчёт UBSan при попытке преобразовать бесконечное число с плавающей запятой в целое. Исправление закрывает [#14190](https://github.com/ClickHouse/ClickHouse/issues/14190). [#16677](https://github.com/ClickHouse/ClickHouse/pull/16677) ([alexey-milovidov](https://github.com/alexey-milovidov)).



## Релиз ClickHouse 20.11 {#clickhouse-release-2011}

### Релиз ClickHouse v20.11.7.16-stable, 2021-03-02 {#clickhouse-release-v2011716-stable-2021-03-02}

#### Улучшения {#improvement-1}

- Явно заданы uid / gid пользователя и группы clickhouse в фиксированные значения (101) в образах clickhouse-server. [#19096](https://github.com/ClickHouse/ClickHouse/pull/19096) ([filimonov](https://github.com/filimonov)).

#### Исправление ошибок {#bug-fix-3}


* Исправление сбоя индекса BloomFilter. Устраняет проблему [#19757](https://github.com/ClickHouse/ClickHouse/issues/19757). [#19884](https://github.com/ClickHouse/ClickHouse/pull/19884) ([Maksim Kita](https://github.com/kitaisreal)).
* При включённом `system.text_log` могла возникать взаимоблокировка. Это исправляет [#19874](https://github.com/ClickHouse/ClickHouse/issues/19874). [#19875](https://github.com/ClickHouse/ClickHouse/pull/19875) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* В предыдущих версиях нестандартные аргументы функции arrayEnumerateUniq могли приводить к сбою или зацикливанию. Это исправляет [#19787](https://github.com/ClickHouse/ClickHouse/issues/19787). [#19788](https://github.com/ClickHouse/ClickHouse/pull/19788) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено переполнение стека при использовании точного сравнения арифметического типа со строковым. [#19773](https://github.com/ClickHouse/ClickHouse/pull/19773) ([tavplubix](https://github.com/tavplubix)).
* Исправлено «падение» (segmentation fault) в функции `bitmapAndnot`. Исправляет [#19668](https://github.com/ClickHouse/ClickHouse/issues/19668). [#19713](https://github.com/ClickHouse/ClickHouse/pull/19713) ([Maksim Kita](https://github.com/kitaisreal)).
* Некоторые функции с большими целыми числами могут приводить к сбою (segfault). Большие целые числа — экспериментальная возможность. Это исправляет [#19667](https://github.com/ClickHouse/ClickHouse/issues/19667). [#19672](https://github.com/ClickHouse/ClickHouse/pull/19672) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен некорректный результат работы функции `neighbor` для аргумента типа `LowCardinality`. Устранена ошибка [#10333](https://github.com/ClickHouse/ClickHouse/issues/10333). [#19617](https://github.com/ClickHouse/ClickHouse/pull/19617) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка «use-after-free» для `CompressedWriteBuffer` в `Connection` после отключения. [#19599](https://github.com/ClickHouse/ClickHouse/pull/19599) ([Azat Khuzhin](https://github.com/azat)).
* Запрос `DROP/DETACH TABLE table ON CLUSTER cluster SYNC` мог зависать, это исправлено. Исправление [#19568](https://github.com/ClickHouse/ClickHouse/issues/19568). [#19572](https://github.com/ClickHouse/ClickHouse/pull/19572) ([tavplubix](https://github.com/tavplubix)).
* Исправлена обработка выражения `id` в запросе `CREATE DICTIONARY`. [#19571](https://github.com/ClickHouse/ClickHouse/pull/19571) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлен SIGSEGV при `merge_tree_min_rows_for_concurrent_read`/`merge_tree_min_bytes_for_concurrent_read` = 0/`UINT64_MAX`. [#19528](https://github.com/ClickHouse/ClickHouse/pull/19528) ([Azat Khuzhin](https://github.com/azat)).
* Переполнение буфера (при чтении из памяти) было возможно, если функция `addMonth` вызывалась с специально подобранными аргументами. Это исправляет [#19441](https://github.com/ClickHouse/ClickHouse/issues/19441). Это исправляет [#19413](https://github.com/ClickHouse/ClickHouse/issues/19413). [#19472](https://github.com/ClickHouse/ClickHouse/pull/19472) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Помечать распределённый пакет как повреждённый, если один из файлов содержит пустой блок данных. [#19449](https://github.com/ClickHouse/ClickHouse/pull/19449) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено потенциальное переполнение буфера в библиотеке Uber H3. См. [https://github.com/uber/h3/issues/392](https://github.com/uber/h3/issues/392). Закрывает [#19219](https://github.com/ClickHouse/ClickHouse/issues/19219). [#19383](https://github.com/ClickHouse/ClickHouse/pull/19383) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен столбец system.parts &#95;state (LOGICAL&#95;ERROR при запросе этого столбца из-за некорректного порядка). [#19346](https://github.com/ClickHouse/ClickHouse/pull/19346) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка `Cannot convert column now64() because it is constant but values of constants are different in source and result`. Продолжение [#7156](https://github.com/ClickHouse/ClickHouse/issues/7156). [#19316](https://github.com/ClickHouse/ClickHouse/pull/19316) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, из-за которой параллельные запросы `ALTER` и `DROP` могли зависать при обработке таблицы ReplicatedMergeTree. [#19237](https://github.com/ClickHouse/ClickHouse/pull/19237) ([alesapin](https://github.com/alesapin)).
* Исправлено бесконечное чтение из файла в формате `ORC` (ошибка была внесена в [#10580](https://github.com/ClickHouse/ClickHouse/issues/10580)). Исправлена [#19095](https://github.com/ClickHouse/ClickHouse/issues/19095). [#19134](https://github.com/ClickHouse/ClickHouse/pull/19134) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка при запуске, из‑за которой ClickHouse не мог прочитать кодек сжатия из `LowCardinality(Nullable(...))` и выбрасывал исключение `Attempt to read after EOF`. Исправляет [#18340](https://github.com/ClickHouse/ClickHouse/issues/18340). [#19101](https://github.com/ClickHouse/ClickHouse/pull/19101) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка `There is no checkpoint` при вставке данных через HTTP‑интерфейс с использованием форматов `Template` или `CustomSeparated`. Исправление для [#19021](https://github.com/ClickHouse/ClickHouse/issues/19021). [#19072](https://github.com/ClickHouse/ClickHouse/pull/19072) ([tavplubix](https://github.com/tavplubix)).
* Ограничены запросы `MODIFY TTL` для таблиц `MergeTree`, созданных со старым синтаксисом. Ранее такие запросы успешно выполнялись, но фактически не оказывали никакого эффекта. [#19064](https://github.com/ClickHouse/ClickHouse/pull/19064) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена работа `groupUniqArray`, чтобы он возвращал корректный тип для аргумента типа Enum. Это закрывает [#17875](https://github.com/ClickHouse/ClickHouse/issues/17875). [#19019](https://github.com/ClickHouse/ClickHouse/pull/19019) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена возможная ошибка `Expected single dictionary argument for function` при использовании функции `ignore` с аргументом типа `LowCardinality`. Исправлена проблема [#14275](https://github.com/ClickHouse/ClickHouse/issues/14275). [#19016](https://github.com/ClickHouse/ClickHouse/pull/19016) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена вставка столбца типа `LowCardinality` в таблицу с движком `TinyLog`. Исправляет проблему [#18629](https://github.com/ClickHouse/ClickHouse/issues/18629). [#19010](https://github.com/ClickHouse/ClickHouse/pull/19010) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Отключена настройка `optimize_move_functions_out_of_any`, так как эта оптимизация не всегда работает корректно. Закрыта задача [#18051](https://github.com/ClickHouse/ClickHouse/issues/18051). Закрыта задача [#18973](https://github.com/ClickHouse/ClickHouse/issues/18973). [#18981](https://github.com/ClickHouse/ClickHouse/pull/18981) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена крайне редкая взаимная блокировка при завершении работы. [#18977](https://github.com/ClickHouse/ClickHouse/pull/18977) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка, из-за которой мутация с экранированным текстом (например, `ALTER ... UPDATE e = CAST('foo', 'Enum8(\'foo\' = 1')`) сериализовывалась некорректно. Исправление для [#18878](https://github.com/ClickHouse/ClickHouse/issues/18878). [#18944](https://github.com/ClickHouse/ClickHouse/pull/18944) ([alesapin](https://github.com/alesapin)).
* Операция ATTACH PARTITION должна сбрасывать мутацию. [#18804](https://github.com/ClickHouse/ClickHouse/issues/18804). [#18935](https://github.com/ClickHouse/ClickHouse/pull/18935) ([fastio](https://github.com/fastio)).
* Исправлено возможное зависание при завершении работы clickhouse-local. Это исправляет [#18891](https://github.com/ClickHouse/ClickHouse/issues/18891). [#18893](https://github.com/ClickHouse/ClickHouse/pull/18893) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен комбинатор *If с унарной функцией и типами Nullable. [#18806](https://github.com/ClickHouse/ClickHouse/pull/18806) ([Azat Khuzhin](https://github.com/azat)).
* Асинхронные распределённые INSERT могут быть отклонены сервером, если настройка `network_compression_method` глобально установлена в отличное от значения по умолчанию значение. Это исправляет [#18741](https://github.com/ClickHouse/ClickHouse/issues/18741). [#18776](https://github.com/ClickHouse/ClickHouse/pull/18776) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка `Attempt to read after eof` при попытке выполнить `CAST` значения `NULL` из типа `Nullable(String)` в `Nullable(Decimal(P, S))`. Теперь функция `CAST` возвращает `NULL`, когда не может разобрать десятичное число из значения типа `Nullable(String)`. Исправляет [#7690](https://github.com/ClickHouse/ClickHouse/issues/7690). [#18718](https://github.com/ClickHouse/ClickHouse/pull/18718) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлен `Logger` с несоответствующим количеством аргументов. [#18717](https://github.com/ClickHouse/ClickHouse/pull/18717) ([sundyli](https://github.com/sundy-li)).
* Добавлена поддержка типа данных FixedString. При репликации данных из MySQL в ClickHouse возникало исключение «Code: 50, e.displayText() = DB::Exception: Unsupported type FixedString(1)». Этот патч исправляет ошибку [#18450](https://github.com/ClickHouse/ClickHouse/issues/18450), а также [#6556](https://github.com/ClickHouse/ClickHouse/issues/6556). [#18553](https://github.com/ClickHouse/ClickHouse/pull/18553) ([awesomeleo](https://github.com/awesomeleo)).
* Исправлена возможная ошибка «Pipeline stuck» при использовании `ORDER BY` после подзапроса с соединением `RIGHT` или `FULL`. [#18550](https://github.com/ClickHouse/ClickHouse/pull/18550) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, из-за которой запросы `ALTER` могли зависать после завершения соответствующей мутации командой KILL. Обнаружено thread fuzzer. [#18518](https://github.com/ClickHouse/ClickHouse/pull/18518) ([alesapin](https://github.com/alesapin)).
* Отключена запись с использованием AIO во время слияний, так как это может приводить к крайне редкой порче данных в столбцах первичного ключа во время слияния. [#18481](https://github.com/ClickHouse/ClickHouse/pull/18481) ([alesapin](https://github.com/alesapin)).
* Отключена свёртка констант для подзапросов на стадии анализа, когда результат не может быть вычислен. [#18446](https://github.com/ClickHouse/ClickHouse/pull/18446) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка `value is too short` при выполнении функций `toType(...)` (`toDate`, `toUInt32` и т. д.) с аргументом типа `Nullable(String)`. Теперь такие функции возвращают `NULL` при ошибках разбора вместо выброса исключения. Исправляет [#7673](https://github.com/ClickHouse/ClickHouse/issues/7673). [#18445](https://github.com/ClickHouse/ClickHouse/pull/18445) ([tavplubix](https://github.com/tavplubix)).
* Ограничено выполнение слияний из широких частей в компактные. В случае вертикального слияния это приводило к повреждённой результирующей части. [#18381](https://github.com/ClickHouse/ClickHouse/pull/18381) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено заполнение таблицы `system.settings_profile_elements`. Этот PR устраняет [#18231](https://github.com/ClickHouse/ClickHouse/issues/18231). [#18379](https://github.com/ClickHouse/ClickHouse/pull/18379) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен анализ индекса для бинарных функций с константным аргументом, который приводил к некорректным результатам запроса. Это исправляет [#18364](https://github.com/ClickHouse/ClickHouse/issues/18364). [#18373](https://github.com/ClickHouse/ClickHouse/pull/18373) ([Amos Bird](https://github.com/amosbird)).
* Исправлены возможные аварийные завершения работы агрегатных функций с комбинатором `Distinct` при использовании двухуровневой агрегации. Исправлено в [#17682](https://github.com/ClickHouse/ClickHouse/issues/17682). [#18365](https://github.com/ClickHouse/ClickHouse/pull/18365) ([Anton Popov](https://github.com/CurtizJ)).
* `SELECT count() FROM table` теперь может быть выполнен, если из `table` можно выбрать хотя бы один столбец любого типа. Этот PR исправляет [#10639](https://github.com/ClickHouse/ClickHouse/issues/10639). [#18233](https://github.com/ClickHouse/ClickHouse/pull/18233) ([Vitaly Baranov](https://github.com/vitlibar)).
* `SELECT JOIN` теперь требует привилегии `SELECT` для каждой из таблиц, участвующих в соединении. Этот PR исправляет [#17654](https://github.com/ClickHouse/ClickHouse/issues/17654). [#18232](https://github.com/ClickHouse/ClickHouse/pull/18232) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена возможная неполнота результата запроса при чтении из `MergeTree*` в случае отката чтения (`read backoff`, сообщение `<Debug> MergeTreeReadPool: Will lower number of threads` в логах). Ошибка была внесена в [#16423](https://github.com/ClickHouse/ClickHouse/issues/16423). Исправляет [#18137](https://github.com/ClickHouse/ClickHouse/issues/18137). [#18216](https://github.com/ClickHouse/ClickHouse/pull/18216) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, из-за которой запрос `MODIFY COLUMN ... REMOVE TTL` на самом деле не удалял TTL столбца. [#18130](https://github.com/ClickHouse/ClickHouse/pull/18130) ([alesapin](https://github.com/alesapin)).
* Исправлены недетерминированные функции в оптимизаторе предикатов. Это исправляет [#17244](https://github.com/ClickHouse/ClickHouse/issues/17244). [#17273](https://github.com/ClickHouse/ClickHouse/pull/17273) ([Winter Zhang](https://github.com/zhang2014)).
* Мутация могла зависать в ожидании несуществующей части после `MOVE` или `REPLACE PARTITION` или, в редких случаях, после `DETACH` или `DROP PARTITION`. Ошибка исправлена. [#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-2}

- Обновлена информация о часовых поясах до версии 2020e. [#18531](https://github.com/ClickHouse/ClickHouse/pull/18531) ([alesapin](https://github.com/alesapin)).

### ClickHouse релиз v20.11.6.6-stable, 2020-12-24 {#clickhouse-release-v201166-stable-2020-12-24}

#### Исправление ошибок {#bug-fix-4}


* Исправлена проблема, из‑за которой процесс `clickhouse-odbc-bridge` был недоступен серверу на машинах с двойным стеком `IPv4/IPv6`, а также проблема, из‑за которой обновления словарей ODBC выполнялись с использованием некорректных запросов и/или приводили к сбоям. Это, возможно, закрывает [#14489](https://github.com/ClickHouse/ClickHouse/issues/14489). [#18278](https://github.com/ClickHouse/ClickHouse/pull/18278) ([Denis Glazachev](https://github.com/traceon)).
* Исправлено сравнение ключей между типами Enum и Int. Это исправляет [#17989](https://github.com/ClickHouse/ClickHouse/issues/17989). [#18214](https://github.com/ClickHouse/ClickHouse/pull/18214) ([Amos Bird](https://github.com/amosbird)).
* Исправлен сбой при преобразовании уникального ключа в движке базы данных `MaterializeMySQL`. Это исправление закрывает [#18186](https://github.com/ClickHouse/ClickHouse/issues/18186) и [#16372](https://github.com/ClickHouse/ClickHouse/issues/16372)  [#18211](https://github.com/ClickHouse/ClickHouse/pull/18211) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена ошибка `std::out_of_range: basic_string` при разборе URL-адресов S3. [#18059](https://github.com/ClickHouse/ClickHouse/pull/18059) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Исправлена проблема, из-за которой некоторые таблицы не синхронизировались в ClickHouse из MySQL из‑за того, что преобразование префиксных индексов MySQL не поддерживалось в MaterializeMySQL. Это исправляет [#15187](https://github.com/ClickHouse/ClickHouse/issues/15187), [#17912](https://github.com/ClickHouse/ClickHouse/issues/17912) и [#17944](https://github.com/ClickHouse/ClickHouse/pull/17944) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена ошибка, из-за которой оптимизация запроса приводила к неверному результату, если запрос содержал `ARRAY JOIN`. [#17887](https://github.com/ClickHouse/ClickHouse/pull/17887) ([sundyli](https://github.com/sundy-li)).
* Исправлена возможная ошибка сегментации в агрегатной функции `topK`. Закрывает [#17404](https://github.com/ClickHouse/ClickHouse/issues/17404). [#17845](https://github.com/ClickHouse/ClickHouse/pull/17845) ([Maksim Kita](https://github.com/kitaisreal)).
* Не восстанавливать части из WAL, если параметр `in_memory_parts_enable_wal` отключён. [#17802](https://github.com/ClickHouse/ClickHouse/pull/17802) ([detailyang](https://github.com/detailyang)).
* Исправлена проблема, из-за которой ClickHouse не удавалось восстановить соединение с серверами MySQL. [#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz)).
* Исправлено непоследовательное поведение `optimize_trivial_count_query` с предикатом по партиции. [#17644](https://github.com/ClickHouse/ClickHouse/pull/17644) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема с пустой таблицей `system.stack_trace` при запуске сервера в режиме демона. [#17630](https://github.com/ClickHouse/ClickHouse/pull/17630) ([Amos Bird](https://github.com/amosbird)).
* Исправлено поведение, из-за которого исключение `fmt::v7::format_error` могло логироваться в фоне для таблиц MergeTree. Это исправляет [#17613](https://github.com/ClickHouse/ClickHouse/issues/17613). [#17615](https://github.com/ClickHouse/ClickHouse/pull/17615) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено поведение clickhouse-client в интерактивном режиме при работе с многострочными запросами, когда однострочный комментарий ошибочно считался продолжающимся до конца всего запроса. Это исправляет [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654). [#17565](https://github.com/ClickHouse/ClickHouse/pull/17565) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена проблема, из-за которой сервер в крайне редких случаях мог переставать принимать подключения. [#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено зависание запроса `ALTER`, когда соответствующая мутация была убита на другой реплике. Это исправление для [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953). [#17499](https://github.com/ClickHouse/ClickHouse/pull/17499) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка, из-за которой ClickHouse занижал размер кеша меток. Это могло происходить, когда было много очень маленьких файлов с метками. [#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin)).
* Исправлена работа `ORDER BY` при включённой настройке `optimize_redundant_functions_in_order_by`. [#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены дубликаты после `DISTINCT`, которые могли возникать из-за некорректной оптимизации. Это исправляет [#17294](https://github.com/ClickHouse/ClickHouse/issues/17294). [#17296](https://github.com/ClickHouse/ClickHouse/pull/17296) ([li chengxiang](https://github.com/chengxianglibra)). [#17439](https://github.com/ClickHouse/ClickHouse/pull/17439) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен сбой при чтении из таблицы `JOIN` с типами `LowCardinality`. Это решает проблему [#17228](https://github.com/ClickHouse/ClickHouse/issues/17228). [#17397](https://github.com/ClickHouse/ClickHouse/pull/17397) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена некорректная инвалидация индекса фиксированного набора при наличии константных столбцов во вложенном запросе. Это исправляет [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246). [#17249](https://github.com/ClickHouse/ClickHouse/pull/17249) ([Amos Bird](https://github.com/amosbird)).
* Исправлен возможный неверный анализ индекса, когда типы операндов в сравнении с индексом различаются. Это исправляет [#17122](https://github.com/ClickHouse/ClickHouse/issues/17122). [#17145](https://github.com/ClickHouse/ClickHouse/pull/17145) ([Amos Bird](https://github.com/amosbird)).
* Исправлено сравнение `ColumnConst`, приводившее к аварийному завершению. Это исправляет [#17088](https://github.com/ClickHouse/ClickHouse/issues/17088). [#17135](https://github.com/ClickHouse/ClickHouse/pull/17135) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка, из-за которой запросы `ON CLUSTER` могли зависать навсегда на репликах `ReplicatedMergeTreeTables`, не являющихся лидерами. [#17089](https://github.com/ClickHouse/ClickHouse/pull/17089) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка, обнаруженная фаззером в функции `fuzzBits`. Это исправляет [#16980](https://github.com/ClickHouse/ClickHouse/issues/16980). [#17051](https://github.com/ClickHouse/ClickHouse/pull/17051) ([hexiaoting](https://github.com/hexiaoting)).
* Избегайте лишних сетевых ошибок для удалённых запросов, которые могут быть отменены во время выполнения, например запросов с `LIMIT`. [#17006](https://github.com/ClickHouse/ClickHouse/pull/17006) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен неверный результат для больших целых чисел (128, 256 бит) при преобразовании из double. [#16986](https://github.com/ClickHouse/ClickHouse/pull/16986) ([Mike](https://github.com/myrrc)).
* Повторно определять IP-адрес `format_avro_schema_registry_url` в случае ошибок. [#16985](https://github.com/ClickHouse/ClickHouse/pull/16985) ([filimonov](https://github.com/filimonov)).
* Исправлен возможный сбой сервера после `ALTER TABLE ... MODIFY COLUMN ... NewType`, когда запрос `SELECT` с условием `WHERE` по изменяемому столбцу выполнялся до завершения операции `ALTER`. [#16968](https://github.com/ClickHouse/ClickHouse/pull/16968) ([Amos Bird](https://github.com/amosbird)).
* Информация о blame рассчитывалась некорректно в `clickhouse-git-import`. [#16959](https://github.com/ClickHouse/ClickHouse/pull/16959) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена оптимизация `ORDER BY` с монотонными функциями. Исправляет [#16107](https://github.com/ClickHouse/ClickHouse/issues/16107). [#16956](https://github.com/ClickHouse/ClickHouse/pull/16956) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена оптимизация `GROUP BY` с включённой настройкой `optimize_aggregators_of_group_by_keys` при использовании соединений (`JOIN`). Это исправляет [#12604](https://github.com/ClickHouse/ClickHouse/issues/12604). [#16951](https://github.com/ClickHouse/ClickHouse/pull/16951) ([Anton Popov](https://github.com/CurtizJ)).
* Скрипт установки всегда должен создавать подкаталоги в конфигурационных каталогах. Это актуально только для Docker-сборки с пользовательской конфигурацией. [#16936](https://github.com/ClickHouse/ClickHouse/pull/16936) ([filimonov](https://github.com/filimonov)).
* Исправлена возможная ошибка `Illegal type of argument` в запросах с `ORDER BY`. Это исправляет [#16580](https://github.com/ClickHouse/ClickHouse/issues/16580). [#16928](https://github.com/ClickHouse/ClickHouse/pull/16928) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Прерывать многочастичную загрузку, если в WriteBufferFromS3 не было записано данных. [#16840](https://github.com/ClickHouse/ClickHouse/pull/16840) ([Pavel Kovalenko](https://github.com/Jokser)).
* Исправлена ошибка, приводившая к сбою при использовании `any` без аргументов. Это исправляет [#16803](https://github.com/ClickHouse/ClickHouse/issues/16803). [#16826](https://github.com/ClickHouse/ClickHouse/pull/16826) ([Amos Bird](https://github.com/amosbird)).
* Исправлено поведение, при котором ClickHouse всегда возвращал 0 вместо числа затронутых строк для запросов `INSERT` через протокол MySQL. Это исправляет [#16605](https://github.com/ClickHouse/ClickHouse/issues/16605). [#16715](https://github.com/ClickHouse/ClickHouse/pull/16715) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлен неконтролируемый рост TDigest. [#16680](https://github.com/ClickHouse/ClickHouse/pull/16680) ([hrissan](https://github.com/hrissan)).
* Исправлен сбой удалённого запроса при использовании суффикса `if` в агрегатной функции. Это исправляет [#16574](https://github.com/ClickHouse/ClickHouse/issues/16574), [#16231](https://github.com/ClickHouse/ClickHouse/issues/16231), [#16610](https://github.com/ClickHouse/ClickHouse/pull/16610) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлено некорректное поведение, вызываемое `select_sequential_consistency` для оптимизированного тривиального запроса `count` и `system.tables`. [#16309](https://github.com/ClickHouse/ClickHouse/pull/16309) ([Hao Chen](https://github.com/haoch)).
* Вызывать ошибку при использовании ColumnTransformer для замены несуществующего столбца. [#16183](https://github.com/ClickHouse/ClickHouse/pull/16183) ([hexiaoting](https://github.com/hexiaoting)).

### Релиз ClickHouse v20.11.3.3-stable, 2020-11-13 {#clickhouse-release-v201133-stable-2020-11-13}

#### Исправление ошибок {#bug-fix-5}

- Исправлены редкие незаметные сбои при включенном профилировщике запросов, когда ClickHouse установлен в ОС с версией glibc, в которой (предположительно) повреждены таблицы асинхронной раскрутки стека для некоторых функций. Исправляет [#15301](https://github.com/ClickHouse/ClickHouse/issues/15301). Исправляет [#13098](https://github.com/ClickHouse/ClickHouse/issues/13098). [#16846](https://github.com/ClickHouse/ClickHouse/pull/16846) ([alexey-milovidov](https://github.com/alexey-milovidov)).

### Релиз ClickHouse v20.11.2.1, 2020-11-11 {#clickhouse-release-v201121-2020-11-11}

#### Обратно несовместимые изменения {#backward-incompatible-change-1}

- Если в секции конфигурации `distributed_ddl` был указан какой-либо `profile`, то этот профиль мог перезаписывать настройки профиля `default` при запуске сервера. Это исправлено, теперь настройки распределенных DDL-запросов не влияют на глобальные настройки сервера. [#16635](https://github.com/ClickHouse/ClickHouse/pull/16635) ([tavplubix](https://github.com/tavplubix)).
- Ограничено использование несравнимых типов данных (таких как `AggregateFunction`) в ключах (ключ сортировки, первичный ключ, ключ партиционирования и т. д.). [#16601](https://github.com/ClickHouse/ClickHouse/pull/16601) ([alesapin](https://github.com/alesapin)).
- Удалены запросы `ANALYZE` и `AST`, настройка `enable_debug_queries` объявлена устаревшей, поскольку теперь это часть полнофункционального запроса `EXPLAIN`. [#16536](https://github.com/ClickHouse/ClickHouse/pull/16536) ([Ivan](https://github.com/abyss7)).
- Агрегатные функции `boundingRatio`, `rankCorr`, `retention`, `timeSeriesGroupSum`, `timeSeriesGroupRateSum`, `windowFunnel` были ошибочно сделаны нечувствительными к регистру. Теперь их имена чувствительны к регистру, как и было задумано. Только функции, указанные в стандарте SQL, созданные для совместимости с другими СУБД или аналогичные им, должны быть нечувствительны к регистру. [#16407](https://github.com/ClickHouse/ClickHouse/pull/16407) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Функция `rankCorr` теперь возвращает nan при недостаточном количестве данных [#16124](https://github.com/ClickHouse/ClickHouse/issues/16124). [#16135](https://github.com/ClickHouse/ClickHouse/pull/16135) ([hexiaoting](https://github.com/hexiaoting)).
- При обновлении с версий старше 20.5, если выполняется последовательное обновление и кластер содержит как версии 20.5 или новее, так и версии старше 20.5, при перезапуске узлов ClickHouse со старыми версиями в присутствии новых версий может возникнуть ошибка `Part ... intersects previous part`. Чтобы предотвратить эту ошибку, сначала установите новые пакеты clickhouse-server на всех узлах кластера, а затем выполните перезапуск (таким образом, при перезапуске clickhouse-server будет запущен с новой версией).

#### Новая функциональность {#new-feature-1}


* Добавлена поддержка LDAP как пользовательского справочника для локально не существующих пользователей. [#12736](https://github.com/ClickHouse/ClickHouse/pull/12736) ([Denis Glazachev](https://github.com/traceon)).
* Добавлена таблица `system.replicated_fetches`, которая показывает текущие фоновые операции загрузки данных. [#16428](https://github.com/ClickHouse/ClickHouse/pull/16428) ([alesapin](https://github.com/alesapin)).
* Добавлен параметр `date_time_output_format`. [#15845](https://github.com/ClickHouse/ClickHouse/pull/15845) ([Maksim Kita](https://github.com/kitaisreal)).
* В ClickHouse добавлен минимальный веб-интерфейс. [#16158](https://github.com/ClickHouse/ClickHouse/pull/16158) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Позволяет читать и записывать отдельное сообщение protobuf целиком (без разделителей длины). [#15199](https://github.com/ClickHouse/ClickHouse/pull/15199) ([filimonov](https://github.com/filimonov)).
* Добавлена начальная поддержка OpenTelemetry. ClickHouse теперь принимает заголовки OpenTelemetry traceparent по протоколам Native и HTTP и в некоторых случаях передаёт их далее. Спаны трассировки для выполненных запросов сохраняются в таблицу `system.opentelemetry_span_log`. [#14195](https://github.com/ClickHouse/ClickHouse/pull/14195) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Разрешено указывать первичный ключ в списке столбцов в запросе `CREATE TABLE`. Это необходимо для совместимости с другими диалектами SQL. [#15823](https://github.com/ClickHouse/ClickHouse/pull/15823) ([Maksim Kita](https://github.com/kitaisreal)).
* Реализована конструкция `OFFSET offset_row_count {ROW | ROWS} FETCH {FIRST | NEXT} fetch_row_count {ROW | ROWS} {ONLY | WITH TIES}` в запросе SELECT с ORDER BY. Это стандартный для SQL способ задать `LIMIT`. [#15855](https://github.com/ClickHouse/ClickHouse/pull/15855) ([hexiaoting](https://github.com/hexiaoting)).
* Функция `errorCodeToName` — возвращает символьное имя ошибки (полезно для анализа `query_log` и подобных таблиц). Таблица `system.errors` — показывает, сколько раз возникали ошибки (учитывает `system_events_show_zero_values`). [#16438](https://github.com/ClickHouse/ClickHouse/pull/16438) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена специальная функция `untuple`, которая позволяет добавлять новые столбцы в список SELECT путём развёртывания именованного кортежа. [#16242](https://github.com/ClickHouse/ClickHouse/pull/16242) ([Nikolai Kochetov](https://github.com/KochetovNicolai), [Amos Bird](https://github.com/amosbird)).
* Теперь можно передавать идентификаторы через параметры запроса. Эти параметры могут использоваться как объекты таблицы или столбцы. [#16594](https://github.com/ClickHouse/ClickHouse/pull/16594) ([Amos Bird](https://github.com/amosbird)).
* Добавлена поддержка типов данных больших целых чисел (UInt256, Int128, Int256) и UUID для индекса BloomFilter в MergeTree. Большие целые числа — экспериментальная функциональность. [#16642](https://github.com/ClickHouse/ClickHouse/pull/16642) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена функция `farmFingerprint64` (некриптографическое хэширование строк). [#16570](https://github.com/ClickHouse/ClickHouse/pull/16570) ([Jacob Hayes](https://github.com/JacobHayes)).
* Добавлен параметр `log_queries_min_query_duration_ms`: в `query_log`/`query_thread_log` будут попадать только запросы, выполняющиеся дольше указанного значения (аналог `slow_query_log` в MySQL). [#16529](https://github.com/ClickHouse/ClickHouse/pull/16529) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена возможность собирать Docker-образ на основе `Alpine`. Использует предварительно скомпилированный бинарник и компоненты glibc из Ubuntu 20.04. [#16479](https://github.com/ClickHouse/ClickHouse/pull/16479) ([filimonov](https://github.com/filimonov)).
* Добавлены функции приведения `toUUIDOrNull` и `toUUIDOrZero`. [#16337](https://github.com/ClickHouse/ClickHouse/pull/16337) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена настройка `max_concurrent_queries_for_all_users`, варианты использования см. в [#6636](https://github.com/ClickHouse/ClickHouse/issues/6636). [#16154](https://github.com/ClickHouse/ClickHouse/pull/16154) ([nvartolomei](https://github.com/nvartolomei)).
* Добавлена новая опция `print_query_id` в clickhouse-client. Она позволяет генерировать произвольные строки с использованием текущего идентификатора запроса, сформированного клиентом. Также по умолчанию в clickhouse-client выводится идентификатор запроса. [#15809](https://github.com/ClickHouse/ClickHouse/pull/15809) ([Amos Bird](https://github.com/amosbird)).
* Добавлены функции `tid` и `logTrace`. Это закрывает [#9434](https://github.com/ClickHouse/ClickHouse/issues/9434). [#15803](https://github.com/ClickHouse/ClickHouse/pull/15803) ([flynn](https://github.com/ucasFL)).
* Добавлена функция `formatReadableTimeDelta`, которая преобразует разницу во времени в удобочитаемую строку ... [#15497](https://github.com/ClickHouse/ClickHouse/pull/15497) ([Filipe Caixeta](https://github.com/filipecaixeta)).
* Добавлена опция `disable_merges` для томов в конфигурации с несколькими дисками. [#13956](https://github.com/ClickHouse/ClickHouse/pull/13956) ([Vladimir Chebotarev](https://github.com/excitoon)).

#### Экспериментальная функциональность {#experimental-feature-1}

- Новые функции `encrypt`, `aes_encrypt_mysql`, `decrypt`, `aes_decrypt_mysql`. Эти функции работают медленно, поэтому мы рассматриваем их как экспериментальную функциональность. [#11844](https://github.com/ClickHouse/ClickHouse/pull/11844) ([Vasily Nemkov](https://github.com/Enmk)).

#### Исправление ошибок {#bug-fix-6}


* Маскировать пароль в `data_path` в `system.distribution_queue`. [#16727](https://github.com/ClickHouse/ClickHouse/pull/16727) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа оператора `IN` для нескольких столбцов и кортежей при включённой настройке `transform_null_in`. Исправляет [#15310](https://github.com/ClickHouse/ClickHouse/issues/15310). [#16722](https://github.com/ClickHouse/ClickHouse/pull/16722) ([Anton Popov](https://github.com/CurtizJ)).
* Настройка `max_parallel_replicas` работала некорректно, если в запрашиваемой таблице не было семплирования. Это исправляет проблему [#5733](https://github.com/ClickHouse/ClickHouse/issues/5733). [#16675](https://github.com/ClickHouse/ClickHouse/pull/16675) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена работа `optimize_read_in_order`/`optimize_aggregation_in_order` при `max_threads` &gt; 0 и наличии выражения в ORDER BY. [#16637](https://github.com/ClickHouse/ClickHouse/pull/16637) ([Azat Khuzhin](https://github.com/azat)).
* Вычисление выражений `DEFAULT` могло приводить к потенциальным конфликтам имён (что на практике было крайне маловероятно). Это исправляет [#9359](https://github.com/ClickHouse/ClickHouse/issues/9359). [#16612](https://github.com/ClickHouse/ClickHouse/pull/16612) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена единица измерения для `query_thread_log.query_duration_ms`. [#16563](https://github.com/ClickHouse/ClickHouse/pull/16563) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка при использовании схемы MySQL Master -&gt; MySQL Slave -&gt; ClickHouse движок MaterializeMySQL. `MaterializeMySQL` — экспериментальная функция. [#16504](https://github.com/ClickHouse/ClickHouse/pull/16504) ([TCeason](https://github.com/TCeason)).
* Специально подобранный аргумент функции `round` с типом `Decimal` приводил к целочисленному делению на ноль. Исправляет [#13338](https://github.com/ClickHouse/ClickHouse/issues/13338). [#16451](https://github.com/ClickHouse/ClickHouse/pull/16451) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена работа `DROP TABLE` для `Distributed` (условие гонки с `INSERT`). [#16409](https://github.com/ClickHouse/ClickHouse/pull/16409) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена обработка очень больших записей в очереди репликации. Такие записи могут появляться в запросах ALTER, если структура таблицы чрезвычайно велика (порядка 1 МБ). Это исправляет [#16307](https://github.com/ClickHouse/ClickHouse/issues/16307). [#16332](https://github.com/ClickHouse/ClickHouse/pull/16332) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено некорректное поведение, при котором часть возвращаемых данных могла быть отброшена из‑за того, что множество для их фильтрации не было создано. [#16308](https://github.com/ClickHouse/ClickHouse/pull/16308) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлен `dictGet` в `sharding_key` (и в аналогичных случаях, т. е. когда контекст функции хранится постоянно). [#16205](https://github.com/ClickHouse/ClickHouse/pull/16205) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено исключение, возникавшее в `clickhouse-local` при попытке выполнить команду `OPTIMIZE`. Исправляет [#16076](https://github.com/ClickHouse/ClickHouse/issues/16076). [#16192](https://github.com/ClickHouse/ClickHouse/pull/16192) ([filimonov](https://github.com/filimonov)).
* Исправляет регрессию [#15780](https://github.com/ClickHouse/ClickHouse/issues/15780): например, выражение `indexOf([1, 2, 3], toLowCardinality(1))` сейчас запрещено, хотя не должно быть. [#16038](https://github.com/ClickHouse/ClickHouse/pull/16038) ([Mike](https://github.com/myrrc)).
* Исправлена ошибка при работе с базой данных MySQL. Когда MySQL-сервер, используемый как движок базы данных, недоступен, некоторые запросы выбрасывают исключение `Exception`, потому что пытаются получить таблицы с отключённого сервера, хотя в этом нет необходимости. Например, запрос `SELECT ... FROM system.parts` должен работать только с таблицами `MergeTree` и вовсе не обращаться к базе данных MySQL. [#16032](https://github.com/ClickHouse/ClickHouse/pull/16032) ([Kruglov Pavel](https://github.com/Avogar)).
* Теперь при выполнении `ALTER MODIFY COLUMN ... DEFAULT ...` с несовместимым со типом столбца значением по умолчанию будет выбрасываться исключение. Исправляет [#15854](https://github.com/ClickHouse/ClickHouse/issues/15854). [#15858](https://github.com/ClickHouse/ClickHouse/pull/15858) ([alesapin](https://github.com/alesapin)).
* Исправлены функции IPv4CIDRToRange/IPv6CIDRToRange, чтобы они принимали значения константных IP-столбцов. [#15856](https://github.com/ClickHouse/ClickHouse/pull/15856) ([vladimir-golovchenko](https://github.com/vladimir-golovchenko)).

#### Улучшение {#improvement-2}


* Обрабатывать `INTERVAL '1 hour'` как эквивалент `INTERVAL 1 HOUR` для совместимости с Postgres и аналогичными системами. Это исправляет [#15637](https://github.com/ClickHouse/ClickHouse/issues/15637). [#15978](https://github.com/ClickHouse/ClickHouse/pull/15978) ([flynn](https://github.com/ucasFL)).
* Добавлен разбор значений enum по их числовым идентификаторам для входных форматов CSV, TSV и JSON. [#15685](https://github.com/ClickHouse/ClickHouse/pull/15685) ([vivarum](https://github.com/vivarum)).
* Улучшено планирование задач чтения для архитектуры JBOD и хранилища `MergeTree`. Добавлена новая настройка `read_backoff_min_concurrency`, которая задаёт нижнюю границу числа потоков чтения. [#16423](https://github.com/ClickHouse/ClickHouse/pull/16423) ([Amos Bird](https://github.com/amosbird)).
* Добавлена недостающая поддержка `LowCardinality` в формате `Avro`. [#16521](https://github.com/ClickHouse/ClickHouse/pull/16521) ([Mike](https://github.com/myrrc)).
* Обходное решение для использования `S3` с сервером nginx в качестве прокси. Nginx в текущей версии не принимает URL с пустым путем, например `http://domain.com?delete`, тогда как стандартный aws-sdk-cpp генерирует URL именно такого вида. В этом коммите используется модифицированная версия aws-sdk-cpp, которая в таких случаях формирует URL с «/» в качестве пути, например `http://domain.com/?delete`. [#16814](https://github.com/ClickHouse/ClickHouse/pull/16814) ([ianton-ru](https://github.com/ianton-ru)).
* Улучшена диагностика ошибок разбора входных данных. В сообщениях об ошибке `Cannot read all data` теперь указывается номер строки. [#16644](https://github.com/ClickHouse/ClickHouse/pull/16644) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Поведение `minMap` и `maxMap` сделано более предсказуемым: нулевые значения больше не пропускаются в результате. Исправляет [#16087](https://github.com/ClickHouse/ClickHouse/issues/16087). [#16631](https://github.com/ClickHouse/ClickHouse/pull/16631) ([Ildus Kurbangaliev](https://github.com/ildus)).
* Улучшено динамическое обновление конфигурации ZooKeeper. [#16630](https://github.com/ClickHouse/ClickHouse/pull/16630) ([sundyli](https://github.com/sundy-li)).
* Применяйте предложение SETTINGS как можно раньше — это позволит задать больше настроек в запросе. Исправляет [#3178](https://github.com/ClickHouse/ClickHouse/issues/3178). [#16619](https://github.com/ClickHouse/ClickHouse/pull/16619) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Теперь поле `event_time_microseconds` хранится в типе Decimal64, а не UInt64. [#16617](https://github.com/ClickHouse/ClickHouse/pull/16617) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Теперь параметризуемые функции можно использовать в преобразователе столбцов `APPLY`. [#16589](https://github.com/ClickHouse/ClickHouse/pull/16589) ([Amos Bird](https://github.com/amosbird)).
* Улучшено планирование фоновой задачи, удаляющей данные удалённых таблиц в базах данных `Atomic`. Базы данных `Atomic` больше не создают битую символьную ссылку на каталог данных таблицы, если у таблицы фактически нет каталога данных. [#16584](https://github.com/ClickHouse/ClickHouse/pull/16584) ([tavplubix](https://github.com/tavplubix)).
* Подзапросы в секции `WITH` (CTE) могут по имени ссылаться на предыдущие подзапросы в секции `WITH`. [#16575](https://github.com/ClickHouse/ClickHouse/pull/16575) ([Amos Bird](https://github.com/amosbird)).
* Добавлен `current&#95;database` в `system.query_thread_log`. [#16558](https://github.com/ClickHouse/ClickHouse/pull/16558) ([Azat Khuzhin](https://github.com/azat)).
* Разрешить загружать части, которые уже зафиксированы или считаются устаревшими в текущем экземпляре, в каталог `detached`. Это полезно при миграции таблиц из другого кластера при отображении N шардов в 1. Это также согласуется с текущей реализацией `fetchPartition`. [#16538](https://github.com/ClickHouse/ClickHouse/pull/16538) ([Amos Bird](https://github.com/amosbird)).
* Несколько улучшений для `RabbitMQ`: исправлена ошибка [#16263](https://github.com/ClickHouse/ClickHouse/issues/16263). Также сокращён срок жизни цикла обработки событий. Добавлена более эффективная конфигурация очередей. [#16426](https://github.com/ClickHouse/ClickHouse/pull/16426) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена отладочная проверка в функции `quantileDeterministic`. В предыдущей версии она могла передавать по сети до двух раз больше данных, хотя фактической ошибки не было. Это исправляет [#15683](https://github.com/ClickHouse/ClickHouse/issues/15683). [#16410](https://github.com/ClickHouse/ClickHouse/pull/16410) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена метрика `TablesToDropQueueSize`. Она показывает количество удалённых таблиц, ожидающих фонового удаления данных. [#16364](https://github.com/ClickHouse/ClickHouse/pull/16364) ([tavplubix](https://github.com/tavplubix)).
* Улучшена диагностика в случае, когда клиент разрывает соединение. В предыдущих версиях исключения `Attempt to read after EOF` и `Broken pipe` записывались в лог сервера. В новой версии это информационное сообщение: `Client has dropped the connection, cancel the query.`. [#16329](https://github.com/ClickHouse/ClickHouse/pull/16329) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка total&#95;rows/total&#95;bytes (из system.tables) для движков таблиц Set и Join. [#16306](https://github.com/ClickHouse/ClickHouse/pull/16306) ([Azat Khuzhin](https://github.com/azat)).
* Теперь для семейства движков таблиц MergeTree можно указывать `PRIMARY KEY` без `ORDER BY`. Исправляет [#15591](https://github.com/ClickHouse/ClickHouse/issues/15591). [#16284](https://github.com/ClickHouse/ClickHouse/pull/16284) ([alesapin](https://github.com/alesapin)).
* Если в системе нет каталога tmp (chroot, некорректная конфигурация и т. д.), `clickhouse-local` создаст временный подкаталог в текущем каталоге. [#16280](https://github.com/ClickHouse/ClickHouse/pull/16280) ([filimonov](https://github.com/filimonov)).
* Добавлена поддержка вложенных типов данных (таких как именованный кортеж) в качестве подтипов. Исправляет [#15587](https://github.com/ClickHouse/ClickHouse/issues/15587). [#16262](https://github.com/ClickHouse/ClickHouse/pull/16262) ([Ivan](https://github.com/abyss7)).
* Поддержка параметров `database_atomic_wait_for_drop_and_detach_synchronously`/`NO DELAY`/`SYNC` для `DROP DATABASE`. [#16127](https://github.com/ClickHouse/ClickHouse/pull/16127) ([Azat Khuzhin](https://github.com/azat)).
* Добавлен параметр `allow_nondeterministic_optimize_skip_unused_shards` (позволяет использовать недетерминированные функции, такие как `rand()` или `dictGet()`, в ключе шардинга). [#16105](https://github.com/ClickHouse/ClickHouse/pull/16105) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены `memory_profiler_step`/`max_untracked_memory` для запросов по HTTP (добавлен тест). Исправлена проблема, при которой глобальное изменение этого значения в xml‑конфигурации также не помогало, поскольку эти настройки всё равно не применялись, и использовалось только значение по умолчанию (4MB), как [здесь](https://github.com/ClickHouse/ClickHouse/blob/17731245336d8c84f75e4c0894c5797ed7732190/src/Common/ThreadStatus.h#L104). Исправлен `query_id` для самого верхнего (root) ThreadStatus HTTP‑запроса (путём инициализации QueryScope после чтения query&#95;id). [#16101](https://github.com/ClickHouse/ClickHouse/pull/16101) ([Azat Khuzhin](https://github.com/azat)).
* Теперь можно выполнять запросы `ALTER ... ON CLUSTER` независимо от настройки `<internal_replication>` в конфигурации кластера. [#16075](https://github.com/ClickHouse/ClickHouse/pull/16075) ([alesapin](https://github.com/alesapin)).
* Исправлена редкая проблема, из-за которой `clickhouse-client` мог аварийно завершаться при выходе при загрузке подсказок. Это исправляет [#16035](https://github.com/ClickHouse/ClickHouse/issues/16035). [#16047](https://github.com/ClickHouse/ClickHouse/pull/16047) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка типа размещения `cache` для словарей `Redis` со сложным ключом. [#15985](https://github.com/ClickHouse/ClickHouse/pull/15985) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено зависание запроса (бесконечный цикл) при неправильной конфигурации (`connections_with_failover_max_tries` установлено в 0). [#15876](https://github.com/ClickHouse/ClickHouse/pull/15876) ([Azat Khuzhin](https://github.com/azat)).
* Изменён уровень части сообщений журнала с информационного на отладочный, чтобы информационные сообщения не появлялись при каждом запросе. Это закрывает [#5293](https://github.com/ClickHouse/ClickHouse/issues/5293). [#15816](https://github.com/ClickHouse/ClickHouse/pull/15816) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Удалены метрики `MemoryTrackingInBackground*`, чтобы избежать потенциально некорректных результатов. Исправляет [#15684](https://github.com/ClickHouse/ClickHouse/issues/15684). [#15813](https://github.com/ClickHouse/ClickHouse/pull/15813) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлено повторное подключение в утилиту `zookeeper-dump-tree`. [#15711](https://github.com/ClickHouse/ClickHouse/pull/15711) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность явно задавать список столбцов в запросе `CREATE TABLE table AS table_function(...)`. Исправляет [#9249](https://github.com/ClickHouse/ClickHouse/issues/9249), исправляет [#14214](https://github.com/ClickHouse/ClickHouse/issues/14214). [#14295](https://github.com/ClickHouse/ClickHouse/pull/14295) ([tavplubix](https://github.com/tavplubix)).

#### Улучшение производительности {#performance-improvement-1}

- Отключено слияние кусков данных между партициями в SELECT FINAL. [#15938](https://github.com/ClickHouse/ClickHouse/pull/15938) ([Kruglov Pavel](https://github.com/Avogar)).
- Улучшена производительность агрегатных функций `-OrNull` и `-OrDefault`. [#16661](https://github.com/ClickHouse/ClickHouse/pull/16661) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Улучшена производительность `quantileMerge`. В предыдущих версиях функция работала неприемлемо медленно. Исправляет [#1463](https://github.com/ClickHouse/ClickHouse/issues/1463). [#16643](https://github.com/ClickHouse/ClickHouse/pull/16643) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Незначительно улучшена производительность логических функций. [#16347](https://github.com/ClickHouse/ClickHouse/pull/16347) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Улучшена производительность назначения слияний в движках таблиц семейства MergeTree. Изменение не должно быть заметно для пользователя. [#16191](https://github.com/ClickHouse/ClickHouse/pull/16191) ([alesapin](https://github.com/alesapin)).
- Ускорена загрузка словарей типа hashed/sparse_hashed за счёт предварительного выделения памяти для хеш-таблицы. [#15454](https://github.com/ClickHouse/ClickHouse/pull/15454) ([Azat Khuzhin](https://github.com/azat)).
- Оптимизация тривиального подсчёта теперь стала немного менее тривиальной. Предикаты, содержащие точное выражение партиции, теперь также могут быть оптимизированы. Также исправляет [#11092](https://github.com/ClickHouse/ClickHouse/issues/11092), который возвращал неверное количество при `max_parallel_replicas > 1`. [#15074](https://github.com/ClickHouse/ClickHouse/pull/15074) ([Amos Bird](https://github.com/amosbird)).

#### Улучшение сборки, тестирования и упаковки {#buildtestingpackaging-improvement-3}


* Добавлена проверка на нестабильность для stateless-тестов. Она позволит заранее обнаруживать потенциально нестабильные функциональные тесты до их слияния. [#16238](https://github.com/ClickHouse/ClickHouse/pull/16238) ([alesapin](https://github.com/alesapin)).
* Используется корректная версия `croaring` вместо амальгамированной сборки. [#16285](https://github.com/ClickHouse/ClickHouse/pull/16285) ([sundyli](https://github.com/sundy-li)).
* Улучшена генерация файлов сборки для системы `ya.make` (Arcadia). [#16700](https://github.com/ClickHouse/ClickHouse/pull/16700) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлен инструмент проверки файлов MySQL BinLog для движка базы данных `MaterializeMySQL`. `MaterializeMySQL` — экспериментальная функциональность. [#16223](https://github.com/ClickHouse/ClickHouse/pull/16223) ([Winter Zhang](https://github.com/zhang2014)).
* Добавлена проверка бита исполняемости для неисполняемых файлов. Пользователи часто по ошибке коммитят исполняемые файлы из Windows. [#15843](https://github.com/ClickHouse/ClickHouse/pull/15843) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена проверка наличия `#pragma once` в заголовках. [#15818](https://github.com/ClickHouse/ClickHouse/pull/15818) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен некорректный стиль кода `&vector[idx]` в libhdfs3. Это исправляет отладочную сборку с libcxx. См. также https://github.com/ClickHouse-Extras/libhdfs3/pull/8. [#15815](https://github.com/ClickHouse/ClickHouse/pull/15815) ([Amos Bird](https://github.com/amosbird)).
* Исправлена сборка одной вспомогательной утилиты-примера на Mac OS. Обратите внимание, что мы не собираем примеры на Mac OS в нашем CI (мы собираем только бинарник ClickHouse), поэтому нет никаких гарантий, что это снова не сломается. Это исправляет [#15804](https://github.com/ClickHouse/ClickHouse/issues/15804). [#15808](https://github.com/ClickHouse/ClickHouse/pull/15808) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Упрощён скрипт инициализации Sys/V. [#14135](https://github.com/ClickHouse/ClickHouse/pull/14135) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* В `db_generator` добавлен `boost::program_options` для повышения удобства его использования. Это закрывает [#15940](https://github.com/ClickHouse/ClickHouse/issues/15940). [#15973](https://github.com/ClickHouse/ClickHouse/pull/15973) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).



## Релиз ClickHouse 20.10 {#clickhouse-release-2010}

### Релиз ClickHouse v20.10.7.4-stable, 2020-12-24 {#clickhouse-release-v201074-stable-2020-12-24}

#### Исправление ошибок {#bug-fix-7}


* Исправлена проблема, из-за которой процесс `clickhouse-odbc-bridge` был недоступен серверу на машинах с двойным стеком `IPv4/IPv6`, а также проблема, из-за которой обновления ODBC-словарей выполнялись с использованием некорректных запросов и/или приводили к сбоям. Это, возможно, закрывает [#14489](https://github.com/ClickHouse/ClickHouse/issues/14489). [#18278](https://github.com/ClickHouse/ClickHouse/pull/18278) ([Denis Glazachev](https://github.com/traceon)).
* Исправлено сравнение ключей между типами Enum и Int. Это устраняет [#17989](https://github.com/ClickHouse/ClickHouse/issues/17989). [#18214](https://github.com/ClickHouse/ClickHouse/pull/18214) ([Amos Bird](https://github.com/amosbird)).
* Исправлен сбой при преобразовании уникального ключа в движке базы данных `MaterializeMySQL`. Это исправляет [#18186](https://github.com/ClickHouse/ClickHouse/issues/18186) и [#16372](https://github.com/ClickHouse/ClickHouse/issues/16372)  [#18211](https://github.com/ClickHouse/ClickHouse/pull/18211) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена ошибка `std::out_of_range: basic_string` при разборе URL-адресов S3. [#18059](https://github.com/ClickHouse/ClickHouse/pull/18059) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Исправлена проблема, из-за которой некоторые таблицы не синхронизировались в ClickHouse из MySQL, возникшая из-за того, что преобразование префиксного индекса MySQL не поддерживалось в MaterializeMySQL. Это исправляет [#15187](https://github.com/ClickHouse/ClickHouse/issues/15187), [#17912](https://github.com/ClickHouse/ClickHouse/issues/17912) и [#17944](https://github.com/ClickHouse/ClickHouse/pull/17944) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена возможная ошибка сегментации в агрегатной функции `topK`. Это закрывает [#17404](https://github.com/ClickHouse/ClickHouse/issues/17404). [#17845](https://github.com/ClickHouse/ClickHouse/pull/17845) ([Maksim Kita](https://github.com/kitaisreal)).
* Не восстанавливать чанки из `WAL`, если `in_memory_parts_enable_wal` отключён. [#17802](https://github.com/ClickHouse/ClickHouse/pull/17802) ([detailyang](https://github.com/detailyang)).
* Исправлена проблема, из-за которой ClickHouse не мог восстановить соединение с серверами MySQL. [#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz)).
* Исправлена проблема, из‑за которой таблица `system.stack_trace` оставалась пустой при запуске сервера в режиме демона. [#17630](https://github.com/ClickHouse/ClickHouse/pull/17630) ([Amos Bird](https://github.com/amosbird)).
* Исправлено поведение `clickhouse-client` в интерактивном режиме при многострочных запросах, когда однострочный комментарий ошибочно распространялся до конца запроса. Это исправляет [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654). [#17565](https://github.com/ClickHouse/ClickHouse/pull/17565) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена проблема, из-за которой сервер в очень редких случаях мог переставать принимать подключения. [#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено зависание запроса `ALTER`, когда соответствующая мутация была завершена на другой реплике. Это исправляет [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953). [#17499](https://github.com/ClickHouse/ClickHouse/pull/17499) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка, из-за которой ClickHouse занижал размер кэша меток. Это могло происходить, когда было много очень маленьких файлов с метками. [#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin)).
* Исправлена работа `ORDER BY` при включённой настройке `optimize_redundant_functions_in_order_by`. [#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены дубликаты после `DISTINCT`, которые могли возникать из-за некорректной оптимизации. Исправлено [#17294](https://github.com/ClickHouse/ClickHouse/issues/17294). [#17296](https://github.com/ClickHouse/ClickHouse/pull/17296) ([li chengxiang](https://github.com/chengxianglibra)). [#17439](https://github.com/ClickHouse/ClickHouse/pull/17439) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, приводившая к сбою при чтении из таблицы `JOIN` с типами `LowCardinality`. Это исправляет [#17228](https://github.com/ClickHouse/ClickHouse/issues/17228). [#17397](https://github.com/ClickHouse/ClickHouse/pull/17397) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена инвалидация индекса фиксированного множества при наличии константных столбцов в подзапросе. Это исправляет [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246). [#17249](https://github.com/ClickHouse/ClickHouse/pull/17249) ([Amos Bird](https://github.com/amosbird)).
* Исправлено сравнение `ColumnConst`, из‑за которого происходил сбой. Это исправило [#17088](https://github.com/ClickHouse/ClickHouse/issues/17088). [#17135](https://github.com/ClickHouse/ClickHouse/pull/17135) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка, из-за которой запросы с `ON CLUSTER` могли зависать навсегда на не-лидирующих `ReplicatedMergeTreeTables`. [#17089](https://github.com/ClickHouse/ClickHouse/pull/17089) ([alesapin](https://github.com/alesapin)).
* Исправлена обнаруженная фаззером ошибка в функции `fuzzBits`. Это устраняет [#16980](https://github.com/ClickHouse/ClickHouse/issues/16980). [#17051](https://github.com/ClickHouse/ClickHouse/pull/17051) ([hexiaoting](https://github.com/hexiaoting)).
* Избегайте лишних сетевых ошибок для удалённых запросов, которые могут быть отменены в процессе выполнения, например запросов с `LIMIT`. [#17006](https://github.com/ClickHouse/ClickHouse/pull/17006) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен некорректный результат для больших целых чисел (128, 256 бит) при приведении типа из double. [#16986](https://github.com/ClickHouse/ClickHouse/pull/16986) ([Mike](https://github.com/myrrc)).
* Повторно определять IP-адрес `format_avro_schema_registry_url` в случае ошибок. [#16985](https://github.com/ClickHouse/ClickHouse/pull/16985) ([filimonov](https://github.com/filimonov)).
* Исправлен возможный сбой сервера после выполнения `ALTER TABLE ... MODIFY COLUMN ... NewType`, когда запрос `SELECT` содержит условие `WHERE` по изменяемому столбцу, а операция изменения еще не завершена. [#16968](https://github.com/ClickHouse/ClickHouse/pull/16968) ([Amos Bird](https://github.com/amosbird)).
* Информация для blame была вычислена некорректно в `clickhouse-git-import`. [#16959](https://github.com/ClickHouse/ClickHouse/pull/16959) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена оптимизация фиксированного `ORDER BY` с монотонными функциями. Это устраняет [#16107](https://github.com/ClickHouse/ClickHouse/issues/16107). [#16956](https://github.com/ClickHouse/ClickHouse/pull/16956) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена оптимизация `GROUP BY` при включённой настройке `optimize_aggregators_of_group_by_keys` и при наличии `JOIN`. Это исправляет [#12604](https://github.com/ClickHouse/ClickHouse/issues/12604). [#16951](https://github.com/ClickHouse/ClickHouse/pull/16951) ([Anton Popov](https://github.com/CurtizJ)).
* Скрипт установки всегда должен создавать подкаталоги в каталогах конфигурации. Это относится только к сборке Docker с пользовательской конфигурацией. [#16936](https://github.com/ClickHouse/ClickHouse/pull/16936) ([filimonov](https://github.com/filimonov)).
* Исправлена возможная ошибка `Illegal type of argument` в запросах с `ORDER BY`. Это устраняет [#16580](https://github.com/ClickHouse/ClickHouse/issues/16580). [#16928](https://github.com/ClickHouse/ClickHouse/pull/16928) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Прерывать многочастичную загрузку, если в `WriteBufferFromS3` не было записано никаких данных. [#16840](https://github.com/ClickHouse/ClickHouse/pull/16840) ([Pavel Kovalenko](https://github.com/Jokser)).
* Исправлен сбой при использовании `any` без аргументов. Это исправляет [#16803](https://github.com/ClickHouse/ClickHouse/issues/16803). [#16826](https://github.com/ClickHouse/ClickHouse/pull/16826) ([Amos Bird](https://github.com/amosbird)).
* Исправлено поведение, при котором ClickHouse всегда возвращал 0 вместо числа затронутых строк для запросов `INSERT` через протокол MySQL. Это исправляет [#16605](https://github.com/ClickHouse/ClickHouse/issues/16605). [#16715](https://github.com/ClickHouse/ClickHouse/pull/16715) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлен неконтролируемый рост `TDigest`. [#16680](https://github.com/ClickHouse/ClickHouse/pull/16680) ([hrissan](https://github.com/hrissan)).
* Исправлена ошибка выполнения удалённого запроса при использовании суффикса `if` в агрегатной функции. Это исправление закрывает [#16574](https://github.com/ClickHouse/ClickHouse/issues/16574), [#16231](https://github.com/ClickHouse/ClickHouse/issues/16231), [#16610](https://github.com/ClickHouse/ClickHouse/pull/16610) ([Winter Zhang](https://github.com/zhang2014)).

### Релиз ClickHouse v20.10.4.1-stable, 2020-11-13 {#clickhouse-release-v201041-stable-2020-11-13}

#### Исправление ошибок {#bug-fix-8}

- Исправлены редкие незаметные сбои при включенном профилировщике запросов, когда ClickHouse установлен в ОС с версией glibc, имеющей (предположительно) поврежденные таблицы асинхронной раскрутки стека для некоторых функций. Исправляет [#15301](https://github.com/ClickHouse/ClickHouse/issues/15301). Исправляет [#13098](https://github.com/ClickHouse/ClickHouse/issues/13098). [#16846](https://github.com/ClickHouse/ClickHouse/pull/16846) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Исправлен оператор `IN` для нескольких столбцов и кортежей при включенной настройке `transform_null_in`. Исправляет [#15310](https://github.com/ClickHouse/ClickHouse/issues/15310). [#16722](https://github.com/ClickHouse/ClickHouse/pull/16722) ([Anton Popov](https://github.com/CurtizJ)).
- Исправлена работа optimize_read_in_order/optimize_aggregation_in_order при max_threads>0 и выражении в ORDER BY. [#16637](https://github.com/ClickHouse/ClickHouse/pull/16637) ([Azat Khuzhin](https://github.com/azat)).
- Теперь при парсинге AVRO из входных данных LowCardinality удаляется из типа. Исправляет [#16188](https://github.com/ClickHouse/ClickHouse/issues/16188). [#16521](https://github.com/ClickHouse/ClickHouse/pull/16521) ([Mike](https://github.com/myrrc)).
- Исправлен быстрый рост метаданных при использовании схемы MySQL Master -> MySQL Slave -> ClickHouse MaterializeMySQL Engine с включенным `slave_parallel_worker` на MySQL Slave путем корректного сжатия наборов GTID. Исправляет [#15951](https://github.com/ClickHouse/ClickHouse/issues/15951). [#16504](https://github.com/ClickHouse/ClickHouse/pull/16504) ([TCeason](https://github.com/TCeason)).
- Исправлен DROP TABLE для Distributed (состояние гонки с INSERT). [#16409](https://github.com/ClickHouse/ClickHouse/pull/16409) ([Azat Khuzhin](https://github.com/azat)).
- Исправлена обработка очень больших записей в очереди репликации. Очень большие записи могут появляться в запросах ALTER, если структура таблицы чрезвычайно велика (около 1 МБ). Исправляет [#16307](https://github.com/ClickHouse/ClickHouse/issues/16307). [#16332](https://github.com/ClickHouse/ClickHouse/pull/16332) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Исправлена ошибка с базой данных MySQL. Когда сервер MySQL, используемый в качестве движка базы данных, недоступен, некоторые запросы вызывают исключение, поскольку пытаются получить таблицы с отключенного сервера, хотя это не требуется. Например, запрос `SELECT ... FROM system.parts` должен работать только с таблицами MergeTree и вообще не обращаться к базе данных MySQL. [#16032](https://github.com/ClickHouse/ClickHouse/pull/16032) ([Kruglov Pavel](https://github.com/Avogar)).

#### Улучшение {#improvement-3}

- Обходное решение для использования S3 с сервером nginx в качестве прокси. Nginx в настоящее время не принимает URL с пустым путем, такие как http://domain.com?delete, но стандартная версия aws-sdk-cpp генерирует именно такие URL. В этом коммите используется исправленная версия aws-sdk-cpp, которая в таких случаях создает URL с "/" в качестве пути, например http://domain.com/?delete. [#16813](https://github.com/ClickHouse/ClickHouse/pull/16813) ([ianton-ru](https://github.com/ianton-ru)).

### Релиз ClickHouse v20.10.3.30, 2020-10-28 {#clickhouse-release-v2010330-2020-10-28}

#### Обратно несовместимое изменение {#backward-incompatible-change-2}


- Настройка `multiple_joins_rewriter_version` объявлена устаревшей. Удалена первая версия переписывателя соединений. [#15472](https://github.com/ClickHouse/ClickHouse/pull/15472) ([Артём Зуйков](https://github.com/4ertus2)).
- Изменено значение по умолчанию настройки `format_regexp_escaping_rule` (относится к формату `Regexp`) на `Raw` (означает чтение всего подшаблона как значения), чтобы поведение больше соответствовало ожиданиям пользователей. [#15426](https://github.com/ClickHouse/ClickHouse/pull/15426) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлена поддержка вложенных многострочных комментариев `/* comment /* comment */ */` в SQL. Это соответствует стандарту SQL. [#14655](https://github.com/ClickHouse/ClickHouse/pull/14655) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлены настройки MergeTree (`max_replicated_merges_with_ttl_in_queue` и `max_number_of_merges_with_ttl_in_pool`) для управления количеством слияний с TTL в фоновом пуле и очереди репликации. Это изменение нарушает совместимость со старыми версиями только при использовании delete TTL. В остальных случаях репликация останется совместимой. Вы можете избежать проблем несовместимости, если обновите все реплики шарда одновременно или выполните `SYSTEM STOP TTL MERGES` до завершения обновления всех реплик. Если в очереди репликации появится несовместимая запись, сначала выполните `SYSTEM STOP TTL MERGES`, а затем `ALTER TABLE ... DETACH PARTITION ...` для партиции, где было назначено несовместимое слияние TTL. Присоедините её обратно на одной реплике. [#14490](https://github.com/ClickHouse/ClickHouse/pull/14490) ([alesapin](https://github.com/alesapin)).
- При обновлении с версий старше 20.5, если выполняется последовательное обновление и кластер содержит как версии 20.5 или новее, так и версии младше 20.5, перезапуск узлов ClickHouse со старыми версиями в присутствии новых версий может привести к ошибкам `Part ... intersects previous part`. Чтобы предотвратить эту ошибку, сначала установите новые пакеты clickhouse-server на всех узлах кластера, а затем выполните перезапуски (таким образом, при перезапуске clickhouse-server запустится с новой версией).

#### Новые возможности {#new-feature-2}


* Фоновая перекомпрессия данных. Добавлена возможность задавать `TTL ... RECOMPRESS codec_name` для семейства движков таблиц MergeTree. [#14494](https://github.com/ClickHouse/ClickHouse/pull/14494) ([alesapin](https://github.com/alesapin)).
* Добавлены параллельные вставки с кворумом. Исправление закрывает [#15601](https://github.com/ClickHouse/ClickHouse/issues/15601). [#15601](https://github.com/ClickHouse/ClickHouse/pull/15601) ([Latysheva Alexandra](https://github.com/alexelex)).
* Настройки для дополнительного обеспечения надежности хранения данных. Полезно для нереплицируемых конфигураций. [#11948](https://github.com/ClickHouse/ClickHouse/pull/11948) ([Anton Popov](https://github.com/CurtizJ)).
* Когда дублирующийся блок записывается на реплику, где он локально отсутствует (ещё не был получен с реплик), не следует его игнорировать, а нужно записывать локально, чтобы добиться того же эффекта, как если бы репликация прошла успешно. [#11684](https://github.com/ClickHouse/ClickHouse/pull/11684) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Теперь поддерживается конструкция `WITH <identifier> AS (subquery) ... ` для объявления именованных подзапросов в контексте запроса. Это закрывает [#2416](https://github.com/ClickHouse/ClickHouse/issues/2416). Это закрывает [#4967](https://github.com/ClickHouse/ClickHouse/issues/4967). [#14771](https://github.com/ClickHouse/ClickHouse/pull/14771) ([Amos Bird](https://github.com/amosbird)).
* Добавлена настройка `enable_global_with_statement`, которая распространяет выражения `WITH` из первого запроса `SELECT` на другие запросы `SELECT` на том же уровне и делает псевдонимы из `WITH` видимыми во вложенных подзапросах. [#15451](https://github.com/ClickHouse/ClickHouse/pull/15451) ([Amos Bird](https://github.com/amosbird)).
* Безопасное выполнение межкластерных запросов (с `initial_user` в роли текущего пользователя запроса). [#13156](https://github.com/ClickHouse/ClickHouse/pull/13156) ([Azat Khuzhin](https://github.com/azat)). [#15551](https://github.com/ClickHouse/ClickHouse/pull/15551) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена возможность удалять свойства столбцов и TTL таблиц. Добавлены запросы `ALTER TABLE MODIFY COLUMN col_name REMOVE what_to_remove` и `ALTER TABLE REMOVE TTL`. Обе операции легковесны и выполняются на уровне метаданных. [#14742](https://github.com/ClickHouse/ClickHouse/pull/14742) ([alesapin](https://github.com/alesapin)).
* Добавлен формат `RawBLOB`. Он предназначен для ввода или вывода одного значения без какого-либо экранирования и разделителей. Исправляет [#15349](https://github.com/ClickHouse/ClickHouse/issues/15349). [#15364](https://github.com/ClickHouse/ClickHouse/pull/15364) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена функция `reinterpretAsUUID`, которая позволяет преобразовать строку байт в формате big-endian в UUID. [#15480](https://github.com/ClickHouse/ClickHouse/pull/15480) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Реализована настройка `force_data_skipping_indices`. [#15642](https://github.com/ClickHouse/ClickHouse/pull/15642) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена настройка `output_format_pretty_row_numbers` для нумерации результатов в форматах Pretty. Это закрывает [#15350](https://github.com/ClickHouse/ClickHouse/issues/15350). [#15443](https://github.com/ClickHouse/ClickHouse/pull/15443) ([flynn](https://github.com/ucasFL)).
* Добавлен инструмент обфускации запросов. Он позволяет делиться большим количеством запросов для более тщательного тестирования. Это закрывает [#15268](https://github.com/ClickHouse/ClickHouse/issues/15268). [#15321](https://github.com/ClickHouse/ClickHouse/pull/15321) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена функция таблицы `null('structure')`. [#14797](https://github.com/ClickHouse/ClickHouse/pull/14797) ([vxider](https://github.com/Vxider)).
* Добавлена функция `formatReadableQuantity`. Она упрощает чтение больших чисел человеком. [#14725](https://github.com/ClickHouse/ClickHouse/pull/14725) ([Artem Hnilov](https://github.com/BooBSD)).
* Добавлен формат `LineAsString`, который принимает последовательность строк, разделённых символами перевода строки; каждая строка целиком интерпретируется как одно поле типа String. [#14703](https://github.com/ClickHouse/ClickHouse/pull/14703) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)), [#13846](https://github.com/ClickHouse/ClickHouse/pull/13846) ([hexiaoting](https://github.com/hexiaoting)).
* Добавлен формат `JSONStrings`, который выводит данные в виде массивов строк. [#14333](https://github.com/ClickHouse/ClickHouse/pull/14333) ([hcz](https://github.com/hczhcz)).
* Добавлена поддержка формата столбца «Raw» для формата `Regexp`. Это позволяет извлекать подпаттерны целиком без каких-либо правил экранирования. [#15363](https://github.com/ClickHouse/ClickHouse/pull/15363) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Разрешено настраивать представление `NULL` для формата вывода `TSV`. Оно задаётся настройкой `output_format_tsv_null_representation`, которая по умолчанию имеет значение `\N`. Это закрывает [#9375](https://github.com/ClickHouse/ClickHouse/issues/9375). Обратите внимание, что настройка влияет только на формат вывода, и `\N` — единственное поддерживаемое представление `NULL` для формата ввода `TSV`. [#14586](https://github.com/ClickHouse/ClickHouse/pull/14586) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка типа данных Decimal для `MaterializeMySQL`. `MaterializeMySQL` — экспериментальная возможность. [#14535](https://github.com/ClickHouse/ClickHouse/pull/14535) ([Winter Zhang](https://github.com/zhang2014)).
* Добавлена новая функция: `SHOW DATABASES LIKE 'xxx'`. [#14521](https://github.com/ClickHouse/ClickHouse/pull/14521) ([hexiaoting](https://github.com/hexiaoting)).
* Добавлен скрипт для импорта произвольного репозитория Git в ClickHouse в качестве примера набора данных. [#14471](https://github.com/ClickHouse/ClickHouse/pull/14471) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Теперь операторы INSERT могут использовать звёздочку (и её варианты) с трансформерами столбцов в списке столбцов. [#14453](https://github.com/ClickHouse/ClickHouse/pull/14453) ([Amos Bird](https://github.com/amosbird)).
* Новые настройки ограничения сложности запроса `max_rows_to_read_leaf`, `max_bytes_to_read_leaf` для распределённых запросов, ограничивающие максимальное число строк/объём данных, читаемых на конечных узлах. Ограничение применяется только к локальным операциям чтения, *не включая* финальную стадию слияния на корневом узле. [#14221](https://github.com/ClickHouse/ClickHouse/pull/14221) ([Roman Khavronenko](https://github.com/hagen1778)).
* Разрешено указывать настройки для хранилищ `ReplicatedMergeTree*` в разделе `<replicated_merge_tree>` конфигурационного файла. Это работает аналогично разделу `<merge_tree>`. Для хранилищ `ReplicatedMergeTree*` настройки из `<merge_tree>` и `<replicated_merge_tree>` применяются совместно, но настройки из `<replicated_merge_tree>` имеют более высокий приоритет. Добавлена таблица `system.replicated_merge_tree_settings`. [#13573](https://github.com/ClickHouse/ClickHouse/pull/13573) ([Amos Bird](https://github.com/amosbird)).
* Добавлена функция `mapPopulateSeries`. [#13166](https://github.com/ClickHouse/ClickHouse/pull/13166) ([Ildus Kurbangaliev](https://github.com/ildus)).
* Поддержка типов MySQL: `decimal` (как ClickHouse `Decimal`) и `datetime` с точностью до долей секунды (как `DateTime64`). [#11512](https://github.com/ClickHouse/ClickHouse/pull/11512) ([Vasily Nemkov](https://github.com/Enmk)).
* Добавлено поле `event_time_microseconds` в таблицы `system.text_log`, `system.trace_log`, `system.query_log` и `system.query_thread_log`. [#14760](https://github.com/ClickHouse/ClickHouse/pull/14760) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлен столбец `event_time_microseconds` в таблицы `system.asynchronous_metric_log` и `system.metric_log`. [#14514](https://github.com/ClickHouse/ClickHouse/pull/14514) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлено поле `query_start_time_microseconds` в таблицы `system.query_log` и `system.query_thread_log`. [#14252](https://github.com/ClickHouse/ClickHouse/pull/14252) ([Bharat Nallan](https://github.com/bharatnc)).

#### Исправление ошибок {#bug-fix-9}


* Исправлен случай, когда память могла перераспределяться сверх лимита. Это закрывает [#14560](https://github.com/ClickHouse/ClickHouse/issues/14560). [#16206](https://github.com/ClickHouse/ClickHouse/pull/16206) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено зависание источника словаря `executable`. В предыдущих версиях при использовании некоторых форматов (например, `JSONEachRow`) данные не передавались во внутренний процесс, пока он не выводил хотя бы что‑нибудь. Исправляет [#1697](https://github.com/ClickHouse/ClickHouse/issues/1697). Исправляет [#2455](https://github.com/ClickHouse/ClickHouse/issues/2455). [#14525](https://github.com/ClickHouse/ClickHouse/pull/14525) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено повторное освобождение памяти в случае возникновения исключения в функции `dictGet`. Это могло произойти, если словарь был загружен с ошибкой. [#16429](https://github.com/ClickHouse/ClickHouse/pull/16429) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена работа `GROUP BY` с модификаторами `WITH TOTALS`/`ROLLUP`/`CUBE` и функциями `min`/`max` по ключам группировки. Исправлено [#16393](https://github.com/ClickHouse/ClickHouse/issues/16393). [#16397](https://github.com/ClickHouse/ClickHouse/pull/16397) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена асинхронная вставка в Distributed с prefer&#95;localhost&#95;replica=0 и internal&#95;replication. [#16358](https://github.com/ClickHouse/ClickHouse/pull/16358) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен некорректный код в реализации TwoLevelStringHashTable, который мог приводить к утечке памяти. [#16264](https://github.com/ClickHouse/ClickHouse/pull/16264) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка сегментации в некоторых случаях некорректного использования агрегирования в лямбда-функциях. [#16082](https://github.com/ClickHouse/ClickHouse/pull/16082) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено зависание запроса `ALTER MODIFY ... ORDER BY` для `ReplicatedVersionedCollapsingMergeTree`. Это решает проблему [#15980](https://github.com/ClickHouse/ClickHouse/issues/15980). [#16011](https://github.com/ClickHouse/ClickHouse/pull/16011) ([alesapin](https://github.com/alesapin)).
* `MaterializeMySQL` (экспериментальная функция): Исправлен парсер имени сортировки (`collate`) и имени кодировки (`charset`), а также добавлена поддержка `length = 0` для строкового типа. [#16008](https://github.com/ClickHouse/ClickHouse/pull/16008) ([Winter Zhang](https://github.com/zhang2014)).
* Разрешено использовать формат `direct` для словарей со сложными ключами. [#16007](https://github.com/ClickHouse/ClickHouse/pull/16007) ([Anton Popov](https://github.com/CurtizJ)).
* Предотвращена «зависания» реплики на 5–10 минут при возникновении ошибки репликации после периода простоя. [#15987](https://github.com/ClickHouse/ClickHouse/pull/15987) ([filimonov](https://github.com/filimonov)).
* Исправлены редкие сегфолты при вставке в `MaterializedView` или выборке из него при одновременном удалении целевой таблицы (для движка базы данных `Atomic`). [#15984](https://github.com/ClickHouse/ClickHouse/pull/15984) ([tavplubix](https://github.com/tavplubix)).
* Устранена неоднозначность при разборе профилей настроек: `CREATE USER ... SETTINGS profile readonly` теперь интерпретируется как использование профиля с именем `readonly`, а не настройки с именем `profile` с ограничением `readonly`. Исправляет [#15628](https://github.com/ClickHouse/ClickHouse/issues/15628). [#15982](https://github.com/ClickHouse/ClickHouse/pull/15982) ([Vitaly Baranov](https://github.com/vitlibar)).
* `MaterializeMySQL` (экспериментальная функция): Исправлено падение при неудачной попытке создания базы данных. [#15954](https://github.com/ClickHouse/ClickHouse/pull/15954) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена ошибка, из-за которой `DROP TABLE IF EXISTS` завершался с сообщением `Table ... does not exist` при одновременном переименовании таблицы (для движка базы данных Atomic). Исправлена редкая взаимоблокировка при одновременном выполнении некоторых DDL‑запросов, затрагивающих несколько таблиц (например, `DROP DATABASE` и `RENAME TABLE`). Исправлена ошибка `DROP/DETACH DATABASE` с сообщением `Table ... does not exist` при одновременном выполнении `DROP/DETACH TABLE`. [#15934](https://github.com/ClickHouse/ClickHouse/pull/15934) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка, из-за которой запрос к таблице `Distributed` с условиями `WHERE`, `PREWHERE` и `GLOBAL IN` возвращал пустой результат. Исправляет [#15792](https://github.com/ClickHouse/ClickHouse/issues/15792). [#15933](https://github.com/ClickHouse/ClickHouse/pull/15933) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправляет [#12513](https://github.com/ClickHouse/ClickHouse/issues/12513): выражения с вычитанием и одинаковым псевдонимом при повторном анализе запроса. [#15886](https://github.com/ClickHouse/ClickHouse/pull/15886) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлены возможные, но крайне редкие взаимоблокировки в реализации RBAC. [#15875](https://github.com/ClickHouse/ClickHouse/pull/15875) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено исключение `Block structure mismatch` в запросах `SELECT ... ORDER BY DESC`, которые выполнялись после запроса `ALTER MODIFY COLUMN`. Исправляет [#15800](https://github.com/ClickHouse/ClickHouse/issues/15800). [#15852](https://github.com/ClickHouse/ClickHouse/pull/15852) ([alesapin](https://github.com/alesapin)).
* `MaterializeMySQL` (экспериментальная функция): Исправлена неточность в результате `select count()`. [#15767](https://github.com/ClickHouse/ClickHouse/pull/15767) ([tavplubix](https://github.com/tavplubix)).
* Исправлены некоторые случаи запросов, в которых выбирались только виртуальные столбцы. Ранее могла возникать ошибка `Not found column _nothing in block`. Исправляет [#12298](https://github.com/ClickHouse/ClickHouse/issues/12298). [#15756](https://github.com/ClickHouse/ClickHouse/pull/15756) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено удаление материализованного представления с внутренней таблицей в базе данных Atomic (все последующие DROP TABLE зависали из‑за зависания рабочего потока, вызванного рекурсивным DROP TABLE для внутренней таблицы материализованного представления). [#15743](https://github.com/ClickHouse/ClickHouse/pull/15743) ([Azat Khuzhin](https://github.com/azat)).
* Возможность перенести партицию на другой диск/том, если первая попытка завершилась неудачей. [#15723](https://github.com/ClickHouse/ClickHouse/pull/15723) ([Pavel Kovalenko](https://github.com/Jokser)).
* Исправлена ошибка `Cannot find column`, которая могла возникать при вставке в `MATERIALIZED VIEW`, если запрос для `MV` содержит `ARRAY JOIN`. [#15717](https://github.com/ClickHouse/ClickHouse/pull/15717) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено слишком низкое значение по умолчанию настройки `max_replicated_logs_to_keep`, из‑за которого реплики могли слишком часто теряться. Улучшен процесс восстановления потерянной реплики за счёт выбора для клонирования наиболее актуальной реплики. Также старые части на потерянной реплике больше не удаляются, а отсоединяются. [#15701](https://github.com/ClickHouse/ClickHouse/pull/15701) ([tavplubix](https://github.com/tavplubix)).
* Исправлена редкая гонка в словарях и таблицах из MySQL. [#15686](https://github.com/ClickHouse/ClickHouse/pull/15686) ([alesapin](https://github.com/alesapin)).
* Исправлено (безвредное) состояние гонки в AMQP-CPP. [#15667](https://github.com/ClickHouse/ClickHouse/pull/15667) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка `Cannot add simple transform to empty Pipe`, возникавшая при чтении из таблицы `Buffer`, структура которой отличалась от структуры целевой таблицы. Она возникала, если целевая таблица возвращала пустой результат для запроса. Исправляет [#15529](https://github.com/ClickHouse/ClickHouse/issues/15529). [#15662](https://github.com/ClickHouse/ClickHouse/pull/15662) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Корректная обработка ошибок при вставке в MergeTree с использованием S3. MergeTree поверх S3 — экспериментальная функция. [#15657](https://github.com/ClickHouse/ClickHouse/pull/15657) ([Pavel Kovalenko](https://github.com/Jokser)).
* Исправлена ошибка в табличной функции S3: регион из URL не применялся к конфигурации клиента S3. [#15646](https://github.com/ClickHouse/ClickHouse/pull/15646) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Исправлен порядок освобождения ресурсов на шаге `ReadFromStorage` в плане запроса. В редких случаях это могло приводить к сбоям. Возможно, связано с [#15610](https://github.com/ClickHouse/ClickHouse/issues/15610). [#15645](https://github.com/ClickHouse/ClickHouse/pull/15645) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* При отсоединении таблиц только для чтения теперь уменьшается значение метрики `ReadonlyReplica`. [#15592](https://github.com/ClickHouse/ClickHouse/pull/15592) ([sundyli](https://github.com/sundy-li)).
* Исправлена ошибка `Element ... is not a constant expression`, возникавшая при использовании результата функции `JSON*` в `VALUES`, `LIMIT` или в правой части оператора `IN`. [#15589](https://github.com/ClickHouse/ClickHouse/pull/15589) ([tavplubix](https://github.com/tavplubix)).
* Запрос будет завершаться быстрее при возникновении исключения. Отмена выполнения на удалённых репликах при возникновении исключения. [#15578](https://github.com/ClickHouse/ClickHouse/pull/15578) ([Azat Khuzhin](https://github.com/azat)).
* Исключена возможность появления сообщения об ошибке `Could not calculate available disk space (statvfs), errno: 4, strerror: Interrupted system call`. Это исправляет [#15541](https://github.com/ClickHouse/ClickHouse/issues/15541). [#15557](https://github.com/ClickHouse/ClickHouse/pull/15557) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено сообщение об ошибке `Database <db> does not exist.` в запросах с IN и таблицей Distributed, когда на инициаторе нет базы данных. [#15538](https://github.com/ClickHouse/ClickHouse/pull/15538) ([Artem Zuikov](https://github.com/4ertus2)).
* Мутация могла зависать в ожидании несуществующей части после `MOVE` или `REPLACE PARTITION` или, в редких случаях, после `DETACH` или `DROP PARTITION`. Исправлено. [#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка, из-за которой оператор `ILIKE` переставал быть регистронезависимым, если выполнялся `LIKE` с тем же шаблоном. [#15536](https://github.com/ClickHouse/ClickHouse/pull/15536) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка `Missing columns`, возникавшая при выборе столбцов, отсутствующих в данных, но зависящих от других столбцов, которые также отсутствуют в данных. Исправляет [#15530](https://github.com/ClickHouse/ClickHouse/issues/15530). [#15532](https://github.com/ClickHouse/ClickHouse/pull/15532) ([alesapin](https://github.com/alesapin)).
* Выдавать ошибку, если в `ReplicatedMergeTree` передан единственный параметр, вместо того чтобы игнорировать его. [#15516](https://github.com/ClickHouse/ClickHouse/pull/15516) ([nvartolomei](https://github.com/nvartolomei)).
* Исправлена ошибка с подпиской на события в `DDLWorker`, которая в редких случаях могла приводить к зависанию запросов с `ON CLUSTER`. Ошибка появилась в [#13450](https://github.com/ClickHouse/ClickHouse/issues/13450). [#15477](https://github.com/ClickHouse/ClickHouse/pull/15477) ([alesapin](https://github.com/alesapin)).
* Выдавать корректное сообщение об ошибке, если второй аргумент агрегатной функции `boundingRatio` имеет неверный тип. [#15407](https://github.com/ClickHouse/ClickHouse/pull/15407) ([detailyang](https://github.com/detailyang)).
* Исправление [#15365](https://github.com/ClickHouse/ClickHouse/issues/15365): при ATTACH базы данных с движком MySQL выбрасывается исключение (нет контекста запроса). [#15384](https://github.com/ClickHouse/ClickHouse/pull/15384) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлен случай с несколькими вхождениями преобразователей столбцов в запросе SELECT. [#15378](https://github.com/ClickHouse/ClickHouse/pull/15378) ([Amos Bird](https://github.com/amosbird)).
* Исправлена работа сжатия в хранилище `S3`. [#15376](https://github.com/ClickHouse/ClickHouse/pull/15376) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Исправлена ошибка, из-за которой запросы вида `SELECT toStartOfDay(today())` завершались с сообщением о пустом аргументе time&#95;zone. [#15319](https://github.com/ClickHouse/ClickHouse/pull/15319) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлена гонка при переименовании таблицы MergeTree и фоновом очистке. [#15304](https://github.com/ClickHouse/ClickHouse/pull/15304) ([alesapin](https://github.com/alesapin)).
* Исправлено редкое состояние гонки при запуске сервера при включённых системных логах. [#15300](https://github.com/ClickHouse/ClickHouse/pull/15300) ([alesapin](https://github.com/alesapin)).
* Исправлено зависание запросов с большим количеством подзапросов к одной и той же таблице движка `MySQL`. Ранее, если в запросе было более 16 подзапросов к одной и той же таблице `MySQL`, он зависал навсегда. [#15299](https://github.com/ClickHouse/ClickHouse/pull/15299) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено сообщение MSan в QueryLog: для поля `memory_usage` могла использоваться неинициализированная память. [#15258](https://github.com/ClickHouse/ClickHouse/pull/15258) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка &#39;Unknown identifier&#39; в GROUP BY при выполнении запроса с JOIN над таблицей Merge. [#15242](https://github.com/ClickHouse/ClickHouse/pull/15242) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлено падение экземпляра при использовании `joinGet` с типами `LowCardinality`. Исправляет [#15214](https://github.com/ClickHouse/ClickHouse/issues/15214). [#15220](https://github.com/ClickHouse/ClickHouse/pull/15220) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка в движке таблиц `Buffer`, из-за которой после запроса `ALTER` было невозможно вставить в `Buffer` данные новой структуры. Исправляет [#15117](https://github.com/ClickHouse/ClickHouse/issues/15117). [#15192](https://github.com/ClickHouse/ClickHouse/pull/15192) ([alesapin](https://github.com/alesapin)).
* Изменён размер поля Decimal в пакете определения столбца MySQL. [#15152](https://github.com/ClickHouse/ClickHouse/pull/15152) ([maqroll](https://github.com/maqroll)).
* Исправлена ошибка `Data compressed with different methods` при `join_algorithm='auto'`. Сохранён тип LowCardinality для ключа соединения в левой таблице при `join_algorithm='partial_merge'`. [#15088](https://github.com/ClickHouse/ClickHouse/pull/15088) ([Artem Zuikov](https://github.com/4ertus2)).
* Обновлён `jemalloc` для исправления `percpu_arena` при использовании маски аффинности. [#15035](https://github.com/ClickHouse/ClickHouse/pull/15035) ([Azat Khuzhin](https://github.com/azat)). [#14957](https://github.com/ClickHouse/ClickHouse/pull/14957) ([Azat Khuzhin](https://github.com/azat)).
* Мы уже используем выровненное (padded) сравнение между String и FixedString ([https://github.com/ClickHouse/ClickHouse/blob/master/src/Functions/FunctionsComparison.h#L333](https://github.com/ClickHouse/ClickHouse/blob/master/src/Functions/FunctionsComparison.h#L333)). Этот PR распространяет ту же логику на сравнение полей, что корректирует использование FixedString в качестве первичных ключей. Это исправляет [#14908](https://github.com/ClickHouse/ClickHouse/issues/14908). [#15033](https://github.com/ClickHouse/ClickHouse/pull/15033) ([Amos Bird](https://github.com/amosbird)).
* Если функцию `bar` вызвать со специально подобранными аргументами, возможно переполнение буфера. Это закрывает [#13926](https://github.com/ClickHouse/ClickHouse/issues/13926). [#15028](https://github.com/ClickHouse/ClickHouse/pull/15028) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка `Cannot rename ... errno: 22, strerror: Invalid argument`, возникающая при выполнении DDL-запросов в базе данных Atomic при запуске clickhouse-server в Docker на macOS. [#15024](https://github.com/ClickHouse/ClickHouse/pull/15024) ([tavplubix](https://github.com/tavplubix)).
* Исправлен сбой в RIGHT или FULL JOIN с `join&#95;algorith=&#39;auto&#39;` при превышении лимита памяти, когда требуется заменить HashJoin на MergeJoin. [#15002](https://github.com/ClickHouse/ClickHouse/pull/15002) ([Artem Zuikov](https://github.com/4ertus2)).
* Теперь параметры `number_of_free_entries_in_pool_to_execute_mutation` и `number_of_free_entries_in_pool_to_lower_max_size_of_merge` могут быть равны `background_pool_size`. [#14975](https://github.com/ClickHouse/ClickHouse/pull/14975) ([alesapin](https://github.com/alesapin)).
* Исправление, позволяющее выполнять проталкивание предикатов, когда подзапрос содержит функцию `finalizeAggregation`. Исправляет [#14847](https://github.com/ClickHouse/ClickHouse/issues/14847). [#14937](https://github.com/ClickHouse/ClickHouse/pull/14937) ([filimonov](https://github.com/filimonov)).
* Публикация частот CPU по каждому логическому ядру в `system.asynchronous_metrics`. Это исправляет [#14923](https://github.com/ClickHouse/ClickHouse/issues/14923). [#14924](https://github.com/ClickHouse/ClickHouse/pull/14924) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* `MaterializeMySQL` (экспериментальная функция): исправлена ошибка `.metadata.tmp File exists`. [#14898](https://github.com/ClickHouse/ClickHouse/pull/14898) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена проблема, из-за которой некоторые вызовы функции `extractAllGroups` могли приводить к ошибке «Memory limit exceeded». Это исправляет [#13383](https://github.com/ClickHouse/ClickHouse/issues/13383). [#14889](https://github.com/ClickHouse/ClickHouse/pull/14889) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен SIGSEGV при попытке выполнить INSERT в StorageFile с файловым дескриптором. [#14887](https://github.com/ClickHouse/ClickHouse/pull/14887) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка сегментации (segfault) в словаре `cache` [#14837](https://github.com/ClickHouse/ClickHouse/issues/14837). [#14879](https://github.com/ClickHouse/ClickHouse/pull/14879) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* `MaterializeMySQL` (экспериментальная функция): Исправлена ошибка при разборе событий MySQL binlog, приводившая к сообщениям `Attempt to read after eof` и `Packet payload is not fully read` в движке базы данных `MaterializeMySQL`. [#14852](https://github.com/ClickHouse/ClickHouse/pull/14852) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена редкая ошибка в запросах `SELECT`, когда запрашиваемый столбец имеет выражение `DEFAULT`, зависящее от другого столбца, у которого тоже есть `DEFAULT`, который при этом не указан в запросе `SELECT` и отсутствует на диске. Частично исправляет [#14531](https://github.com/ClickHouse/ClickHouse/issues/14531). [#14845](https://github.com/ClickHouse/ClickHouse/pull/14845) ([alesapin](https://github.com/alesapin)).
* Исправлена проблема, из-за которой сервер мог зависать при запуске во время взаимодействия с ZooKeeper, если файлы конфигурации нужно было получать из ZK (с использованием опции include `from_zk`). Это исправляет [#14814](https://github.com/ClickHouse/ClickHouse/issues/14814). [#14843](https://github.com/ClickHouse/ClickHouse/pull/14843) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Исправлено некорректное определение монотонности для сужающего приведения типов `Int -> Int` для знаковых типов. Это могло приводить к некорректному результату запроса. Ошибка была выявлена в [#14513](https://github.com/ClickHouse/ClickHouse/issues/14513). [#14783](https://github.com/ClickHouse/ClickHouse/pull/14783) ([Amos Bird](https://github.com/amosbird)).
* Трансформер столбцов `Replace` должен заменять идентификаторы клонированными AST. Это исправляет проблему [#14695](https://github.com/ClickHouse/ClickHouse/issues/14695). [#14734](https://github.com/ClickHouse/ClickHouse/pull/14734) ([Amos Bird](https://github.com/amosbird)).
* Исправлено отсутствие имени базы данных по умолчанию в метаданных материализованного представления при выполнении команды `ALTER ... MODIFY QUERY`. [#14664](https://github.com/ClickHouse/ClickHouse/pull/14664) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка, при которой мутация `ALTER UPDATE` с колонкой `Nullable` в выражении присваивания и константным значением (например, `UPDATE x = 42`) приводила к некорректному значению в колонке или к сбою (segfault). Исправляет [#13634](https://github.com/ClickHouse/ClickHouse/issues/13634), [#14045](https://github.com/ClickHouse/ClickHouse/issues/14045). [#14646](https://github.com/ClickHouse/ClickHouse/pull/14646) ([alesapin](https://github.com/alesapin)).
* Исправлен неверный результат умножения `Decimal`, вызванный неправильным масштабом десятичных знаков в результирующем столбце. [#14603](https://github.com/ClickHouse/ClickHouse/pull/14603) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлена работа функции `has` с типом `LowCardinality(Nullable(...))`. [#14591](https://github.com/ClickHouse/ClickHouse/pull/14591) ([Mike](https://github.com/myrrc)).
* Очистка каталога данных после исключений Zookeeper во время `CREATE`-запроса для движка `StorageReplicatedMergeTree`. [#14563](https://github.com/ClickHouse/ClickHouse/pull/14563) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлены редкие сбои (segfault) в функциях с комбинатором `-Resample`, которые могли возникать из‑за переполнения при очень больших значениях параметров. [#14562](https://github.com/ClickHouse/ClickHouse/pull/14562) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка при преобразовании `Nullable(String)` в Enum. Она была внесена в [#12745](https://github.com/ClickHouse/ClickHouse/pull/12745). Это исправление закрывает [#14435](https://github.com/ClickHouse/ClickHouse/issues/14435). [#14530](https://github.com/ClickHouse/ClickHouse/pull/14530) ([Amos Bird](https://github.com/amosbird)).
* Исправлен некорректный порядок сортировки столбца типа `Nullable`. Это исправляет [#14344](https://github.com/ClickHouse/ClickHouse/issues/14344). [#14495](https://github.com/ClickHouse/ClickHouse/pull/14495) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена ошибка, из-за которой функцию `currentDatabase()` нельзя было использовать в DDL‑запросе с `ON CLUSTER`. [#14211](https://github.com/ClickHouse/ClickHouse/pull/14211) ([Winter Zhang](https://github.com/zhang2014)).
* `MaterializeMySQL` (экспериментальная функция): Исправлена ошибка `Packet payload is not fully read` в движке баз данных `MaterializeMySQL`. [#14696](https://github.com/ClickHouse/ClickHouse/pull/14696) ([BohuTANG](https://github.com/BohuTANG)).

#### Улучшение {#improvement-4}


* Включить движок базы данных `Atomic` по умолчанию для новых баз данных. [#15003](https://github.com/ClickHouse/ClickHouse/pull/15003) ([tavplubix](https://github.com/tavplubix)).
* Добавлена возможность указывать специализированные кодеки, такие как `Delta`, `T64` и т. д., для столбцов с подтипами. Реализует [#12551](https://github.com/ClickHouse/ClickHouse/issues/12551), исправляет [#11397](https://github.com/ClickHouse/ClickHouse/issues/11397) и [#4609](https://github.com/ClickHouse/ClickHouse/issues/4609). [#15089](https://github.com/ClickHouse/ClickHouse/pull/15089) ([alesapin](https://github.com/alesapin)).
* Динамическая перезагрузка конфигурации ZooKeeper. [#14678](https://github.com/ClickHouse/ClickHouse/pull/14678) ([sundyli](https://github.com/sundy-li)).
* Теперь разрешено выполнять запросы `ALTER ... ON CLUSTER` независимо от параметра `<internal_replication>` в конфигурации кластера. [#16075](https://github.com/ClickHouse/ClickHouse/pull/16075) ([alesapin](https://github.com/alesapin)).
* Теперь `joinGet` поддерживает поиск по составному ключу. Продолжение [#12418](https://github.com/ClickHouse/ClickHouse/issues/12418). [#13015](https://github.com/ClickHouse/ClickHouse/pull/13015) ([Amos Bird](https://github.com/amosbird)).
* Дождаться полного завершения `DROP/DETACH TABLE`, если для базы данных `Atomic` указано `NO DELAY` или `SYNC`. [#15448](https://github.com/ClickHouse/ClickHouse/pull/15448) ([tavplubix](https://github.com/tavplubix)).
* Теперь можно изменять тип версионного столбца для `VersionedCollapsingMergeTree` с помощью запроса `ALTER`. [#15442](https://github.com/ClickHouse/ClickHouse/pull/15442) ([alesapin](https://github.com/alesapin)).
* Разворачивать макросы `{database}`, `{table}` и `{uuid}` в `zookeeper_path` при создании реплицированной таблицы. Запретить `RENAME TABLE`, если он может привести к некорректному `zookeeper_path` после перезапуска сервера. Исправляет [#6917](https://github.com/ClickHouse/ClickHouse/issues/6917). [#15348](https://github.com/ClickHouse/ClickHouse/pull/15348) ([tavplubix](https://github.com/tavplubix)).
* Функция `now` теперь принимает аргумент с часовым поясом. Это закрывает [15264](https://github.com/ClickHouse/ClickHouse/issues/15264). [#15285](https://github.com/ClickHouse/ClickHouse/pull/15285) ([flynn](https://github.com/ucasFL)).
* Не разрешать подключения к серверу ClickHouse, пока не будут выполнены все скрипты в `/docker-entrypoint-initdb.d/`. [#15244](https://github.com/ClickHouse/ClickHouse/pull/15244) ([Aleksei Kozharin](https://github.com/alekseik1)).
* Добавлена настройка `optimize` для запроса `EXPLAIN PLAN`. При её включении применяются оптимизации на уровне плана запроса. По умолчанию включена. [#15201](https://github.com/ClickHouse/ClickHouse/pull/15201) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено сообщение об исключении при неверном количестве аргументов у функции CAST. Закрывает [#13992](https://github.com/ClickHouse/ClickHouse/issues/13992). [#15029](https://github.com/ClickHouse/ClickHouse/pull/15029) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена опция для отключения перемещения по TTL при вставке парта данных. [#15000](https://github.com/ClickHouse/ClickHouse/pull/15000) ([Pavel Kovalenko](https://github.com/Jokser)).
* Игнорировать ограничения ключей при выполнении мутаций. Без этого pull request&#39;а невозможно выполнять мутации, когда `force_index_by_date = 1` или `force_primary_key = 1`. [#14973](https://github.com/ClickHouse/ClickHouse/pull/14973) ([Amos Bird](https://github.com/amosbird)).
* Разрешено удалять реплицируемую таблицу, если предыдущая попытка удаления завершилась неудачей из‑за истечения сессии ZooKeeper. Это исправляет [#11891](https://github.com/ClickHouse/ClickHouse/issues/11891). [#14926](https://github.com/ClickHouse/ClickHouse/pull/14926) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена некорректная ошибка превышения ограничений настроек при выполнении SELECT с SETTINGS из распределённой таблицы. [#14876](https://github.com/ClickHouse/ClickHouse/pull/14876) ([Amos Bird](https://github.com/amosbird)).
* Добавлена настройка запроса `load_balancing_first_offset` для явного указания первой реплики. Она используется вместе со стратегией балансировки нагрузки `FIRST_OR_RANDOM`, которая позволяет управлять нагрузкой на реплики. [#14867](https://github.com/ClickHouse/ClickHouse/pull/14867) ([Amos Bird](https://github.com/amosbird)).
* Отображать подзапросы для `SET` и `JOIN` в результате `EXPLAIN`. [#14856](https://github.com/ClickHouse/ClickHouse/pull/14856) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Разрешено использовать многотомную конфигурацию хранилища в движке `Distributed`. [#14839](https://github.com/ClickHouse/ClickHouse/pull/14839) ([Pavel Kovalenko](https://github.com/Jokser)).
* Поля `query_start_time` и `query_start_time_microseconds` теперь формируются из одной и той же спецификации времени. [#14831](https://github.com/ClickHouse/ClickHouse/pull/14831) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлена поддержка отключения постоянного хранения данных для `StorageJoin` и `StorageSet`; эта возможность управляется настройкой `disable_set_and_join_persistency`. Этот PR решил проблему [#6318](https://github.com/ClickHouse/ClickHouse/issues/6318). [#14776](https://github.com/ClickHouse/ClickHouse/pull/14776) ([vxider](https://github.com/Vxider)).
* Теперь `COLUMNS` можно использовать для обёртки списка столбцов с последующим применением к ним преобразователей. [#14775](https://github.com/ClickHouse/ClickHouse/pull/14775) ([Amos Bird](https://github.com/amosbird)).
* Добавлен `merge_algorithm` в таблицу `system.merges` для улучшения анализа слияний. [#14705](https://github.com/ClickHouse/ClickHouse/pull/14705) ([Amos Bird](https://github.com/amosbird)).
* Исправлена потенциальная утечка памяти, вызванная наблюдением `zookeeper exists`. [#14693](https://github.com/ClickHouse/ClickHouse/pull/14693) ([hustnn](https://github.com/hustnn)).
* Разрешено параллельное выполнение распределённого DDL. [#14684](https://github.com/ClickHouse/ClickHouse/pull/14684) ([Azat Khuzhin](https://github.com/azat)).
* Добавлен счётчик события `QueryMemoryLimitExceeded`. Исправляет [#14589](https://github.com/ClickHouse/ClickHouse/issues/14589). [#14647](https://github.com/ClickHouse/ClickHouse/pull/14647) ([fastio](https://github.com/fastio)).
* Исправлены некоторые завершающие пробелы в форматировании запросов. [#14595](https://github.com/ClickHouse/ClickHouse/pull/14595) ([Azat Khuzhin](https://github.com/azat)).
* ClickHouse обрабатывает `partition expr` и `key expr` по‑разному. `partition expr` используется для построения minmax‑индекса, содержащего соответствующие столбцы, тогда как выражение первичного ключа `primary key expr` хранится как есть. Иногда пользователь может задавать более крупные партиции, например `partition by i / 1000`. Однако бинарные операторы не являются монотонными, и этот PR пытается это исправить. Это также может быть полезно и для других сценариев использования. [#14513](https://github.com/ClickHouse/ClickHouse/pull/14513) ([Amos Bird](https://github.com/amosbird)).
* Добавлена возможность пропускать проверки доступа для `DiskS3`. Диск `s3` является экспериментальной функцией. [#14497](https://github.com/ClickHouse/ClickHouse/pull/14497) ([Pavel Kovalenko](https://github.com/Jokser)).
* Ускорено завершение работы сервера при наличии выполняющихся запросов к S3. [#14496](https://github.com/ClickHouse/ClickHouse/pull/14496) ([Pavel Kovalenko](https://github.com/Jokser)).
* `SYSTEM RELOAD CONFIG` теперь генерирует исключение, если не удалось выполнить перезагрузку, и продолжает использовать предыдущий users.xml. Фоновая периодическая перезагрузка в случае неудачи также продолжает использовать предыдущий users.xml. [#14492](https://github.com/ClickHouse/ClickHouse/pull/14492) ([Vitaly Baranov](https://github.com/vitlibar)).
* Для операций INSERT со встроенными данными в формате VALUES в скриптовом режиме `clickhouse-client` добавлена поддержка точки с запятой в качестве терминатора данных, в дополнение к символу новой строки. Закрывает [#12288](https://github.com/ClickHouse/ClickHouse/issues/12288). [#13192](https://github.com/ClickHouse/ClickHouse/pull/13192) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Поддержка пользовательских кодеков в компактных партициях. [#12183](https://github.com/ClickHouse/ClickHouse/pull/12183) ([Anton Popov](https://github.com/CurtizJ)).

#### Улучшение производительности {#performance-improvement-2}

- Компактные части теперь включены по умолчанию для небольших частей. Это позволяет обрабатывать частые вставки немного эффективнее (в 4–100 раз). [#11913](https://github.com/ClickHouse/ClickHouse/pull/11913) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Улучшена производительность `quantileTDigest`. Это исправляет [#2668](https://github.com/ClickHouse/ClickHouse/issues/2668). [#15542](https://github.com/ClickHouse/ClickHouse/pull/15542) ([Kruglov Pavel](https://github.com/Avogar)).
- Значительно снижено потребление памяти в AggregatingInOrderTransform/optimize_aggregation_in_order. [#15543](https://github.com/ClickHouse/ClickHouse/pull/15543) ([Azat Khuzhin](https://github.com/azat)).
- Ускорено 256-битное умножение. [#15418](https://github.com/ClickHouse/ClickHouse/pull/15418) ([Artem Zuikov](https://github.com/4ertus2)).
- Улучшена производительность 256-битных типов за счёт использования (u)int64_t в качестве базового типа для широких целых чисел. Исходные широкие целые числа используют 8-битные типы в качестве базовых. [#14859](https://github.com/ClickHouse/ClickHouse/pull/14859) ([Artem Zuikov](https://github.com/4ertus2)).
- Явное использование временного диска для хранения временных данных вертикального слияния. [#15639](https://github.com/ClickHouse/ClickHouse/pull/15639) ([Grigory Pervakov](https://github.com/GrigoryPervakov)).
- Использование одного запроса S3 DeleteObjects вместо множественных DeleteObject в цикле. Функциональность не изменилась, поэтому покрывается существующими тестами, такими как integration/test_log_family_s3. [#15238](https://github.com/ClickHouse/ClickHouse/pull/15238) ([ianton-ru](https://github.com/ianton-ru)).
- Исправлен ошибочный выбор медленной обобщённой реализации для `DateTime <op> DateTime`. Это исправляет [#15153](https://github.com/ClickHouse/ClickHouse/issues/15153). [#15178](https://github.com/ClickHouse/ClickHouse/pull/15178) ([Amos Bird](https://github.com/amosbird)).
- Улучшена производительность ключа GROUP BY типа `FixedString`. [#15034](https://github.com/ClickHouse/ClickHouse/pull/15034) ([Amos Bird](https://github.com/amosbird)).
- При запуске clickhouse-server блокируется в памяти только сегмент кода с помощью `mlock`. В предыдущих версиях все отображённые области блокировались в памяти, включая отладочную информацию. Отладочная информация обычно выделяется в отдельный файл, но если этого не происходит, это приводило к дополнительному потреблению памяти в +2–3 ГиБ. [#14929](https://github.com/ClickHouse/ClickHouse/pull/14929) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Бинарный файл ClickHouse стал меньше благодаря оптимизации времени компоновки.

#### Улучшение сборки/тестирования/упаковки {#buildtestingpackaging-improvement-4}


* Теперь для Production-сборки ClickHouse мы используем clang-11. [#15239](https://github.com/ClickHouse/ClickHouse/pull/15239) ([alesapin](https://github.com/alesapin)).
* Теперь для сборки ClickHouse в CI мы используем clang-11. [#14846](https://github.com/ClickHouse/ClickHouse/pull/14846) ([alesapin](https://github.com/alesapin)).
* Переключены бинарные сборки (Linux, Darwin, AArch64, FreeDSD) на clang-11. [#15622](https://github.com/ClickHouse/ClickHouse/pull/15622) ([Ilya Yatsishin](https://github.com/qoega)).
* Теперь все тестовые образы используют `llvm-symbolizer-11`. [#15069](https://github.com/ClickHouse/ClickHouse/pull/15069) ([alesapin](https://github.com/alesapin)).
* Добавлена возможность сборки с llvm-11. [#15366](https://github.com/ClickHouse/ClickHouse/pull/15366) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Переход с `clang-tidy-10` на `clang-tidy-11`. [#14922](https://github.com/ClickHouse/ClickHouse/pull/14922) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* По умолчанию используется экспериментальный менеджер проходов LLVM. [#15608](https://github.com/ClickHouse/ClickHouse/pull/15608) ([Danila Kutenin](https://github.com/danlark1)).
* Не позволять ни одному модулю трансляции C++ компилироваться дольше 10 минут или использовать больше 10 ГБ памяти. Это исправляет [#14925](https://github.com/ClickHouse/ClickHouse/issues/14925). [#15060](https://github.com/ClickHouse/ClickHouse/pull/15060) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Тест производительности стал более стабильным и показательным за счёт разделения прогонов тестов и прогонов профилирования. [#15027](https://github.com/ClickHouse/ClickHouse/pull/15027) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Попытка сделать тест производительности более надёжным. Это достигается за счёт динамического переназначения исполняемой памяти процесса с помощью `madvise` с использованием прозрачных huge pages — это может уменьшить количество промахов iTLB, которые являются основным источником нестабильности в тестах производительности. [#14685](https://github.com/ClickHouse/ClickHouse/pull/14685) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Переход на python3. Закрывает [#14886](https://github.com/ClickHouse/ClickHouse/issues/14886). [#15007](https://github.com/ClickHouse/ClickHouse/pull/15007) ([Azat Khuzhin](https://github.com/azat)).
* Раннее завершение функциональных тестов, если сервер не ответил. Это закрывает [#15262](https://github.com/ClickHouse/ClickHouse/issues/15262). [#15267](https://github.com/ClickHouse/ClickHouse/pull/15267) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Разрешен запуск AArch64-версии clickhouse-server без конфигурационных файлов. Это упрощает решение задачи [#15174](https://github.com/ClickHouse/ClickHouse/issues/15174). [#15266](https://github.com/ClickHouse/ClickHouse/pull/15266) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Улучшения в Docker-образах для CI: отказ от ZooKeeper и единый скрипт для установки тестовых конфигураций. [#15215](https://github.com/ClickHouse/ClickHouse/pull/15215) ([alesapin](https://github.com/alesapin)).
* Исправлена передача опций CMake в скрипте быстрых тестов. Устранена ошибка из [#14711](https://github.com/ClickHouse/ClickHouse/issues/14711). [#15155](https://github.com/ClickHouse/ClickHouse/pull/15155) ([alesapin](https://github.com/alesapin)).
* Добавлен скрипт для выполнения тестирования оборудования одной командой. [#15115](https://github.com/ClickHouse/ClickHouse/pull/15115) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Большой тест `test_dictionaries_all_layouts_and_sources` разбит на несколько меньших. [#15110](https://github.com/ClickHouse/ClickHouse/pull/15110) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Возможное исправление отчёта MSan в base64 (на серверах с AVX-512). Исправляет [#14006](https://github.com/ClickHouse/ClickHouse/issues/14006). [#15030](https://github.com/ClickHouse/ClickHouse/pull/15030) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Переформатирован и приведён в порядок код во всех файлах интеграционных тестов *.py. [#14864](https://github.com/ClickHouse/ClickHouse/pull/14864) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлен нестабильный тестовый сценарий с пустой транзакцией в MaterializeMySQL, выявленный в CI. [#14854](https://github.com/ClickHouse/ClickHouse/pull/14854) ([Winter Zhang](https://github.com/zhang2014)).
* Попытка немного ускорить сборку. [#14808](https://github.com/ClickHouse/ClickHouse/pull/14808) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Незначительное ускорение сборки за счёт удаления неиспользуемых заголовков. [#14714](https://github.com/ClickHouse/ClickHouse/pull/14714) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка сборки в OS X. [#14761](https://github.com/ClickHouse/ClickHouse/pull/14761) ([Winter Zhang](https://github.com/zhang2014)).
* Включать ccache по умолчанию в CMake, если он найден в ОС. [#14575](https://github.com/ClickHouse/ClickHouse/pull/14575) ([alesapin](https://github.com/alesapin)).
* Управление конфигурацией сборок CI в репозитории ClickHouse. [#14547](https://github.com/ClickHouse/ClickHouse/pull/14547) ([alesapin](https://github.com/alesapin)).
* В файлах CMake: - Часть описаний некоторых опций перенесена в комментарии выше. - Заменены значения по умолчанию для `option`: 0 -&gt; `OFF`, 1 -&gt; `ON`. - Добавлены дополнительные описания и ссылки на документацию к опциям. - Заменена опция `FUZZER` (существует другая опция `ENABLE_FUZZING`, которая включает ту же функциональность). - Удалена опция `ENABLE_GTEST_LIBRARY`, так как есть `ENABLE_TESTS`. Полное описание см. в PR: [#14711](https://github.com/ClickHouse/ClickHouse/pull/14711) ([Mike](https://github.com/myrrc)).
* Уменьшен размер бинарного файла (~50 МБ для отладочной версии). [#14555](https://github.com/ClickHouse/ClickHouse/pull/14555) ([Artem Zuikov](https://github.com/4ertus2)).
* Используйте std::filesystem::path в ConfigProcessor для объединения путей к файлам. [#14558](https://github.com/ClickHouse/ClickHouse/pull/14558) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлена отладочная проверка (debug assertion) в `bitShiftLeft()` при вызове с отрицательным целым числом большого размера. [#14697](https://github.com/ClickHouse/ClickHouse/pull/14697) ([Artem Zuikov](https://github.com/4ertus2)).





## Релиз ClickHouse 20.9 {#clickhouse-release-209}

### Релиз ClickHouse v20.9.7.11-stable, 2020-12-07 {#clickhouse-release-v209711-stable-2020-12-07}

#### Улучшение производительности {#performance-improvement-3}

- Исправлена производительность чтения из таблиц `Merge` при большом количестве таблиц `MergeTree`. Исправляет [#7748](https://github.com/ClickHouse/ClickHouse/issues/7748). [#16988](https://github.com/ClickHouse/ClickHouse/pull/16988) ([Anton Popov](https://github.com/CurtizJ)).

#### Исправление ошибок {#bug-fix-10}


* Не восстанавливать парты из WAL, если `in_memory_parts_enable_wal` отключён. [#17802](https://github.com/ClickHouse/ClickHouse/pull/17802) ([detailyang](https://github.com/detailyang)).
* Исправлено падение с ошибкой сегментации при недостатке места при вставке в таблицу `Distributed`. [#17737](https://github.com/ClickHouse/ClickHouse/pull/17737) ([tavplubix](https://github.com/tavplubix)).
* Исправлена проблема, из-за которой ClickHouse не удавалось возобновить соединение с серверами MySQL. [#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz)).
* Исправлена ошибка `Function not implemented` при выполнении запроса `RENAME` в базе данных `Atomic` при запуске ClickHouse в Windows Subsystem for Linux. Исправлена [#17661](https://github.com/ClickHouse/ClickHouse/issues/17661). [#17664](https://github.com/ClickHouse/ClickHouse/pull/17664) ([tavplubix](https://github.com/tavplubix)).
* При использовании clickhouse-client в интерактивном режиме с многострочными запросами однострочный комментарий ошибочно распространялся до конца запроса. Это исправляет [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654). [#17565](https://github.com/ClickHouse/ClickHouse/pull/17565) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена проблема, из-за которой сервер в крайне редких случаях мог переставать принимать подключения. [#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено зависание запроса `ALTER`, когда соответствующая мутация была прервана на другой реплике. Исправляет [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953). [#17499](https://github.com/ClickHouse/ClickHouse/pull/17499) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка, из-за которой ClickHouse занижал размер кэша меток (mark cache). Она могла возникать, когда было много очень маленьких файлов с метками. [#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin)).
* Исправлен `ORDER BY` при включённой настройке `optimize_redundant_functions_in_order_by`. [#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены дубликаты после `DISTINCT`, которые могли возникать из‑за некорректной оптимизации. Исправляет [#17294](https://github.com/ClickHouse/ClickHouse/issues/17294). [#17296](https://github.com/ClickHouse/ClickHouse/pull/17296) ([li chengxiang](https://github.com/chengxianglibra)). [#17439](https://github.com/ClickHouse/ClickHouse/pull/17439) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено падение при чтении из таблицы `JOIN` с типами `LowCardinality`. Исправляет [#17228](https://github.com/ClickHouse/ClickHouse/issues/17228). [#17397](https://github.com/ClickHouse/ClickHouse/pull/17397) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена некорректная инвалидация индекса `set`, когда в подзапросе есть константные столбцы. Это исправляет [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246). [#17249](https://github.com/ClickHouse/ClickHouse/pull/17249) ([Amos Bird](https://github.com/amosbird)).
* Исправлено сравнение `ColumnConst`, приводившее к сбою. Это исправило [#17088](https://github.com/ClickHouse/ClickHouse/issues/17088). [#17135](https://github.com/ClickHouse/ClickHouse/pull/17135) ([Amos Bird](https://github.com/amosbird)).
* Исправлено падение при выполнении запроса `CREATE TABLE ... AS some_table`, если таблица `some_table` была создана с помощью `AS table_function()`. Исправляет [#16944](https://github.com/ClickHouse/ClickHouse/issues/16944). [#17072](https://github.com/ClickHouse/ClickHouse/pull/17072) ([tavplubix](https://github.com/tavplubix)).
* Исправление ошибки в функции `fuzzBits`, связанной с задачей: [#16980](https://github.com/ClickHouse/ClickHouse/issues/16980). [#17051](https://github.com/ClickHouse/ClickHouse/pull/17051) ([hexiaoting](https://github.com/hexiaoting)).
* Избегайте лишних сетевых ошибок для удалённых запросов, которые могут быть отменены в ходе выполнения, например запросов с `LIMIT`. [#17006](https://github.com/ClickHouse/ClickHouse/pull/17006) ([Azat Khuzhin](https://github.com/azat)).
* TODO. [#16866](https://github.com/ClickHouse/ClickHouse/pull/16866) ([tavplubix](https://github.com/tavplubix)).
* Возвращать количество затронутых строк для запросов INSERT по протоколу MySQL. Ранее ClickHouse всегда возвращал 0, теперь это исправлено. Исправлено [#16605](https://github.com/ClickHouse/ClickHouse/issues/16605). [#16715](https://github.com/ClickHouse/ClickHouse/pull/16715) ([Winter Zhang](https://github.com/zhang2014)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-5}

- Обновлены встроенные данные часовых поясов до версии 2020d (также обновлена библиотека cctz до последней версии master). [#17204](https://github.com/ClickHouse/ClickHouse/pull/17204) ([filimonov](https://github.com/filimonov)).

### Релиз ClickHouse v20.9.6.14-stable, 2020-11-20 {#clickhouse-release-v209614-stable-2020-11-20}

#### Улучшения {#improvement-5}

- Добавлена возможность подключения к защищённой конечной точке `clickhouse-server`, требующей SNI. Это возможно, когда `clickhouse-server` размещён за TLS-прокси. [#16938](https://github.com/ClickHouse/ClickHouse/pull/16938) ([filimonov](https://github.com/filimonov)).
- Условные агрегатные функции (например: `avgIf`, `sumIf`, `maxIf`) теперь возвращают `NULL` при отсутствии строк и использовании nullable-аргументов. [#13964](https://github.com/ClickHouse/ClickHouse/pull/13964) ([Winter Zhang](https://github.com/zhang2014)).

#### Исправления ошибок {#bug-fix-11}

- Исправлена ошибка, при которой запросы `ON CLUSTER` могли зависать навсегда для таблиц ReplicatedMergeTree, не являющихся лидерами. [#17089](https://github.com/ClickHouse/ClickHouse/pull/17089) ([alesapin](https://github.com/alesapin)).
- Добавлено повторное разрешение IP-адреса `format_avro_schema_registry_url` в случае ошибок. [#16985](https://github.com/ClickHouse/ClickHouse/pull/16985) ([filimonov](https://github.com/filimonov)).
- Исправлено возможное падение сервера после выполнения `ALTER TABLE ... MODIFY COLUMN ... NewType`, когда запрос `SELECT` содержит выражение `WHERE` для изменяемого столбца, а операция изменения ещё не завершена. [#16968](https://github.com/ClickHouse/ClickHouse/pull/16968) ([Amos Bird](https://github.com/amosbird)).
- Скрипт установки теперь всегда создаёт подкаталоги в папках конфигурации. Это актуально только для сборки Docker с пользовательской конфигурацией. [#16936](https://github.com/ClickHouse/ClickHouse/pull/16936) ([filimonov](https://github.com/filimonov)).
- Исправлена возможная ошибка `Illegal type of argument` для запросов с `ORDER BY`. Исправляет [#16580](https://github.com/ClickHouse/ClickHouse/issues/16580). [#16928](https://github.com/ClickHouse/ClickHouse/pull/16928) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Прерывание составной загрузки, если данные не были записаны в WriteBufferFromS3. [#16840](https://github.com/ClickHouse/ClickHouse/pull/16840) ([Pavel Kovalenko](https://github.com/Jokser)).
- Исправлено падение при использовании `any` без аргументов. Для [#16803](https://github.com/ClickHouse/ClickHouse/issues/16803). cc @azat. [#16826](https://github.com/ClickHouse/ClickHouse/pull/16826) ([Amos Bird](https://github.com/amosbird)).
- Исправлен оператор `IN` для нескольких столбцов и кортежей при включённой настройке `transform_null_in`. Исправляет [#15310](https://github.com/ClickHouse/ClickHouse/issues/15310). [#16722](https://github.com/ClickHouse/ClickHouse/pull/16722) ([Anton Popov](https://github.com/CurtizJ)).
- Исправлена работа optimize_read_in_order/optimize_aggregation_in_order при max_threads>0 и выражении в ORDER BY. [#16637](https://github.com/ClickHouse/ClickHouse/pull/16637) ([Azat Khuzhin](https://github.com/azat)).
- Исправляет [#16574](https://github.com/ClickHouse/ClickHouse/issues/16574), исправляет [#16231](https://github.com/ClickHouse/ClickHouse/issues/16231) — исправлен сбой удалённого запроса при использовании агрегатной функции с суффиксом 'if'. [#16610](https://github.com/ClickHouse/ClickHouse/pull/16610) ([Winter Zhang](https://github.com/zhang2014)).
- Запрос завершается быстрее в случае исключения. Отменяется выполнение на удалённых репликах при возникновении исключения. [#15578](https://github.com/ClickHouse/ClickHouse/pull/15578) ([Azat Khuzhin](https://github.com/azat)).


### ClickHouse release v20.9.5.5-stable, 2020-11-13 {#clickhouse-release-v20955-stable-2020-11-13}

#### Исправление ошибок {#bug-fix-12}

- Исправлены редкие незаметные сбои при включенном профилировщике запросов, когда ClickHouse установлен в ОС с версией glibc, в которой (предположительно) повреждены таблицы асинхронной раскрутки стека для некоторых функций. Исправляет [#15301](https://github.com/ClickHouse/ClickHouse/issues/15301). Исправляет [#13098](https://github.com/ClickHouse/ClickHouse/issues/13098). [#16846](https://github.com/ClickHouse/ClickHouse/pull/16846) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Теперь при парсинге AVRO из входных данных модификатор LowCardinality удаляется из типа. Исправляет [#16188](https://github.com/ClickHouse/ClickHouse/issues/16188). [#16521](https://github.com/ClickHouse/ClickHouse/pull/16521) ([Mike](https://github.com/myrrc)).
- Исправлен быстрый рост метаданных при использовании схемы MySQL Master -> MySQL Slave -> ClickHouse MaterializeMySQL Engine с включенным параметром `slave_parallel_worker` на MySQL Slave путем корректного сжатия наборов GTID. Исправляет [#15951](https://github.com/ClickHouse/ClickHouse/issues/15951). [#16504](https://github.com/ClickHouse/ClickHouse/pull/16504) ([TCeason](https://github.com/TCeason)).
- Исправлена операция DROP TABLE для таблиц Distributed (состояние гонки с INSERT). [#16409](https://github.com/ClickHouse/ClickHouse/pull/16409) ([Azat Khuzhin](https://github.com/azat)).
- Исправлена обработка очень больших записей в очереди репликации. Очень большие записи могут появляться в запросах ALTER, если структура таблицы чрезвычайно велика (около 1 МБ). Исправляет [#16307](https://github.com/ClickHouse/ClickHouse/issues/16307). [#16332](https://github.com/ClickHouse/ClickHouse/pull/16332) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Исправлено непоследовательное поведение, при котором часть возвращаемых данных могла быть отброшена из-за того, что набор для их фильтрации не был создан. [#16308](https://github.com/ClickHouse/ClickHouse/pull/16308) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Исправлена ошибка с базой данных MySQL. Когда сервер MySQL, используемый в качестве движка базы данных, недоступен, некоторые запросы вызывают исключение, поскольку они пытаются получить таблицы с отключенного сервера, хотя это не требуется. Например, запрос `SELECT ... FROM system.parts` должен работать только с таблицами MergeTree и вообще не обращаться к базе данных MySQL. [#16032](https://github.com/ClickHouse/ClickHouse/pull/16032) ([Kruglov Pavel](https://github.com/Avogar)).

### ClickHouse release v20.9.4.76-stable (2020-10-29) {#clickhouse-release-v209476-stable-2020-10-29}

#### Исправление ошибок {#bug-fix-13}


* Исправлено двойное освобождение памяти при возникновении исключения в функции `dictGet`. Оно могло произойти, если словарь был загружен с ошибкой. [#16429](https://github.com/ClickHouse/ClickHouse/pull/16429) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена работа `GROUP BY` с модификаторами `WITH TOTALS`/`WITH ROLLUP`/`WITH CUBE` и функциями `min`/`max` по ключам группировки. Исправление для [#16393](https://github.com/ClickHouse/ClickHouse/issues/16393). [#16397](https://github.com/ClickHouse/ClickHouse/pull/16397) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена асинхронная вставка INSERT в таблицы типа Distributed с `prefer_localhost_replica=0` и внутренней репликацией. [#16358](https://github.com/ClickHouse/ClickHouse/pull/16358) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен сильно ошибочный код в реализации TwoLevelStringHashTable, который мог приводить к утечке памяти. Я удивлён, как этот баг мог так долго оставаться незамеченным... [#16264](https://github.com/ClickHouse/ClickHouse/pull/16264) ([Amos Bird](https://github.com/amosbird)).
* Исправлен случай, когда память могла выделяться сверх лимита. Закрывает [#14560](https://github.com/ClickHouse/ClickHouse/issues/14560). [#16206](https://github.com/ClickHouse/ClickHouse/pull/16206) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено зависание запроса `ALTER MODIFY ... ORDER BY` для таблиц на движке `ReplicatedVersionedCollapsingMergeTree`. Это исправляет [#15980](https://github.com/ClickHouse/ClickHouse/issues/15980). [#16011](https://github.com/ClickHouse/ClickHouse/pull/16011) ([alesapin](https://github.com/alesapin)).
* Исправлен парсер имен `collate` и `charset`, а также добавлена поддержка `length = 0` для строкового типа. [#16008](https://github.com/ClickHouse/ClickHouse/pull/16008) ([Winter Zhang](https://github.com/zhang2014)).
* Разрешено использовать прямой layout для словарей со сложными ключами. [#16007](https://github.com/ClickHouse/ClickHouse/pull/16007) ([Anton Popov](https://github.com/CurtizJ)).
* Предотвращено зависание реплики на 5–10 минут при возникновении ошибки репликации после периода бездействия. [#15987](https://github.com/ClickHouse/ClickHouse/pull/15987) ([filimonov](https://github.com/filimonov)).
* Исправлены редкие сбои сегментации при вставке в `MaterializedView` или выборке из него при одновременном удалении целевой таблицы (для движка базы данных `Atomic`). [#15984](https://github.com/ClickHouse/ClickHouse/pull/15984) ([tavplubix](https://github.com/tavplubix)).
* Устранена неоднозначность при разборе профилей настроек: `CREATE USER ... SETTINGS profile readonly` теперь интерпретируется как использование профиля с именем `readonly`, а не настройки с именем `profile` с ограничением readonly. Это исправляет [#15628](https://github.com/ClickHouse/ClickHouse/issues/15628). [#15982](https://github.com/ClickHouse/ClickHouse/pull/15982) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен сбой при ошибке создания базы данных. [#15954](https://github.com/ClickHouse/ClickHouse/pull/15954) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена ошибка `DROP TABLE IF EXISTS` с сообщением `Table ... does not exist`, возникавшая при одновременном переименовании таблицы (для движка базы данных Atomic). Исправлена редкая взаимная блокировка при одновременном выполнении некоторых DDL-запросов с участием нескольких таблиц (таких как `DROP DATABASE` и `RENAME TABLE`). Исправлена ошибка `DROP/DETACH DATABASE` с сообщением `Table ... does not exist` при одновременном выполнении `DROP/DETACH TABLE`. [#15934](https://github.com/ClickHouse/ClickHouse/pull/15934) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка, из-за которой запрос к таблице `Distributed` с условиями `WHERE`, `PREWHERE` и `GLOBAL IN` мог возвращать пустой результат. Исправляет [#15792](https://github.com/ClickHouse/ClickHouse/issues/15792). [#15933](https://github.com/ClickHouse/ClickHouse/pull/15933) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлены возможные взаимные блокировки в RBAC. [#15875](https://github.com/ClickHouse/ClickHouse/pull/15875) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено исключение `Block structure mismatch` в запросах `SELECT ... ORDER BY DESC`, которые выполнялись после запроса `ALTER MODIFY COLUMN`. Исправляет [#15800](https://github.com/ClickHouse/ClickHouse/issues/15800). [#15852](https://github.com/ClickHouse/ClickHouse/pull/15852) ([alesapin](https://github.com/alesapin)).
* Исправлена некорректная работа `select count()` для MaterializeMySQL. [#15767](https://github.com/ClickHouse/ClickHouse/pull/15767) ([tavplubix](https://github.com/tavplubix)).
* Исправлены некоторые случаи запросов, в которых выбирались только виртуальные столбцы. Ранее могла возникать ошибка `Not found column _nothing in block`. Исправлено [#12298](https://github.com/ClickHouse/ClickHouse/issues/12298). [#15756](https://github.com/ClickHouse/ClickHouse/pull/15756) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено слишком низкое значение по умолчанию настройки `max_replicated_logs_to_keep`, которое могло приводить к слишком частой потере реплик. Улучшен процесс восстановления потерянной реплики за счёт выбора для клонирования наиболее актуальной реплики. Также старые парты на потерянной реплике больше не удаляются, а отсоединяются. [#15701](https://github.com/ClickHouse/ClickHouse/pull/15701) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка `Cannot add simple transform to empty Pipe`, возникавшая при чтении из таблицы `Buffer`, структура которой отличалась от структуры целевой таблицы. Она могла проявляться, если целевая таблица возвращала пустой результат на запрос. Исправляет [#15529](https://github.com/ClickHouse/ClickHouse/issues/15529). [#15662](https://github.com/ClickHouse/ClickHouse/pull/15662) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка при использовании шаблонов (`globs`) в `S3 table function`: регион из URL не применялся к конфигурации клиента S3. [#15646](https://github.com/ClickHouse/ClickHouse/pull/15646) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Уменьшать значение метрики `ReadonlyReplica` при отсоединении таблиц только для чтения. Это исправляет [#15598](https://github.com/ClickHouse/ClickHouse/issues/15598). [#15592](https://github.com/ClickHouse/ClickHouse/pull/15592) ([sundyli](https://github.com/sundy-li)).
* Выдавать ошибку при передаче одного параметра в ReplicatedMergeTree, вместо того чтобы игнорировать его. [#15516](https://github.com/ClickHouse/ClickHouse/pull/15516) ([nvartolomei](https://github.com/nvartolomei)).

#### Улучшение {#improvement-6}

- Теперь можно выполнять запросы `ALTER ... ON CLUSTER` независимо от настройки `<internal_replication>` в конфигурации кластера. [#16075](https://github.com/ClickHouse/ClickHouse/pull/16075) ([alesapin](https://github.com/alesapin)).
- Добавлено раскрытие макросов `{database}`, `{table}` и `{uuid}` в аргументах `ReplicatedMergeTree` при создании таблицы. [#16160](https://github.com/ClickHouse/ClickHouse/pull/16160) ([tavplubix](https://github.com/tavplubix)).

### Релиз ClickHouse v20.9.3.45-stable (2020-10-09) {#clickhouse-release-v209345-stable-2020-10-09}

#### Исправление ошибок {#bug-fix-14}


* Исправлена ошибка `Cannot find column`, которая могла возникать при вставке в `MATERIALIZED VIEW`, если запрос для `MV` содержал `ARRAY JOIN`. [#15717](https://github.com/ClickHouse/ClickHouse/pull/15717) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправить состояние гонки в AMQP-CPP. [#15667](https://github.com/ClickHouse/ClickHouse/pull/15667) ([alesapin](https://github.com/alesapin)).
* Исправлен порядок освобождения ресурсов в шаге `ReadFromStorage` плана запроса. В редких случаях это могло приводить к сбоям. Возможна связь с [#15610](https://github.com/ClickHouse/ClickHouse/issues/15610). [#15645](https://github.com/ClickHouse/ClickHouse/pull/15645) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка `Element ... is not a constant expression` при использовании результата функций `JSON*` в `VALUES`, `LIMIT` или правой части оператора `IN`. [#15589](https://github.com/ClickHouse/ClickHouse/pull/15589) ([tavplubix](https://github.com/tavplubix)).
* Исключена возможность появления сообщения об ошибке `Could not calculate available disk space (statvfs), errno: 4, strerror: Interrupted system call`. Это исправляет [#15541](https://github.com/ClickHouse/ClickHouse/issues/15541). [#15557](https://github.com/ClickHouse/ClickHouse/pull/15557) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Значительно снижено потребление памяти в AggregatingInOrderTransform/optimize&#95;aggregation&#95;in&#95;order. [#15543](https://github.com/ClickHouse/ClickHouse/pull/15543) ([Azat Khuzhin](https://github.com/azat)).
* Мутация могла зависать в ожидании несуществующей части после `MOVE` или `REPLACE PARTITION` или, в редких случаях, после `DETACH` или `DROP PARTITION`. Это исправлено. [#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка, из-за которой оператор `ILIKE` переставал быть регистронезависимым, если выполнялся `LIKE` с тем же шаблоном. [#15536](https://github.com/ClickHouse/ClickHouse/pull/15536) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка `Missing columns`, возникавшая при выборе столбцов, отсутствующих в данных, но зависящих от других столбцов, которые также отсутствуют в данных. Исправляет [#15530](https://github.com/ClickHouse/ClickHouse/issues/15530). [#15532](https://github.com/ClickHouse/ClickHouse/pull/15532) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка с подпиской на события в DDLWorker, которая в редких случаях могла приводить к зависанию запросов с `ON CLUSTER`. Ошибка появилась в [#13450](https://github.com/ClickHouse/ClickHouse/issues/13450). [#15477](https://github.com/ClickHouse/ClickHouse/pull/15477) ([alesapin](https://github.com/alesapin)).
* Исправлена выдача ошибки при неправильном типе второго аргумента агрегатной функции `boundingRatio`. [#15407](https://github.com/ClickHouse/ClickHouse/pull/15407) ([detailyang](https://github.com/detailyang)).
* Исправлена ошибка, из-за которой запросы вида `SELECT toStartOfDay(today())` завершались с сообщением об отсутствии аргумента time&#95;zone. [#15319](https://github.com/ClickHouse/ClickHouse/pull/15319) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлена гонка при переименовании таблицы MergeTree и во время фоновой очистки. [#15304](https://github.com/ClickHouse/ClickHouse/pull/15304) ([alesapin](https://github.com/alesapin)).
* Исправлено редкое состояние гонки при запуске сервера, когда включены system.logs. [#15300](https://github.com/ClickHouse/ClickHouse/pull/15300) ([alesapin](https://github.com/alesapin)).
* Исправлен отчёт MSan в `QueryLog`: для поля `memory_usage` могла использоваться неинициализированная память. [#15258](https://github.com/ClickHouse/ClickHouse/pull/15258) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена аварийная остановка экземпляра при использовании joinGet с типами LowCardinality. Это исправляет [#15214](https://github.com/ClickHouse/ClickHouse/issues/15214). [#15220](https://github.com/ClickHouse/ClickHouse/pull/15220) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка в табличном движке `Buffer`, из-за которой после запроса `ALTER` было невозможно вставлять в `Buffer` данные с новой структурой. Исправляет [#15117](https://github.com/ClickHouse/ClickHouse/issues/15117). [#15192](https://github.com/ClickHouse/ClickHouse/pull/15192) ([alesapin](https://github.com/alesapin)).
* Изменен размер поля для десятичных чисел в пакете определения столбца MySQL. [#15152](https://github.com/ClickHouse/ClickHouse/pull/15152) ([maqroll](https://github.com/maqroll)).
* Исправлена ошибка `Cannot rename ... errno: 22, strerror: Invalid argument` при выполнении DDL-запроса в базе данных Atomic при запуске clickhouse-server в Docker на macOS. [#15024](https://github.com/ClickHouse/ClickHouse/pull/15024) ([tavplubix](https://github.com/tavplubix)).
* Исправление, позволяющее проталкиванию предикатов работать, когда подзапрос содержит функцию finalizeAggregation. Исправляет [#14847](https://github.com/ClickHouse/ClickHouse/issues/14847). [#14937](https://github.com/ClickHouse/ClickHouse/pull/14937) ([filimonov](https://github.com/filimonov)).
* Исправлена проблема, из-за которой сервер мог зависать при запуске во время взаимодействия с ZooKeeper, если файлы конфигурации нужно было получать из ZK (через директиву include `from_zk`). Исправляет [#14814](https://github.com/ClickHouse/ClickHouse/issues/14814). [#14843](https://github.com/ClickHouse/ClickHouse/pull/14843) ([Alexander Kuzmenkov](https://github.com/akuzm)).

#### Улучшение {#improvement-7}

- Теперь можно изменить тип столбца версии для `VersionedCollapsingMergeTree` с помощью запроса `ALTER`. [#15442](https://github.com/ClickHouse/ClickHouse/pull/15442) ([alesapin](https://github.com/alesapin)).

### Релиз ClickHouse v20.9.2.20, 2020-09-22 {#clickhouse-release-v209220-2020-09-22}

#### Обратно несовместимое изменение {#backward-incompatible-change-3}

- При обновлении с версий старше 20.5, если выполняется последовательное обновление и кластер содержит как версии 20.5 или новее, так и версии младше 20.5, перезапуск узлов ClickHouse со старыми версиями в присутствии более новых версий может привести к ошибкам `Part ... intersects previous part`. Чтобы предотвратить эту ошибку, сначала установите более новые пакеты clickhouse-server на всех узлах кластера, а затем выполните перезапуски (таким образом, при перезапуске clickhouse-server будет запущена новая версия).

#### Новая функциональность {#new-feature-3}

- Добавлены трансформеры столбцов `EXCEPT`, `REPLACE`, `APPLY`, которые можно применять к списку выбранных столбцов (после `*` или `COLUMNS(...)`). Например, можно написать `SELECT * EXCEPT(URL) REPLACE(number + 1 AS number)`. Другой пример: `select * apply(length) apply(max) from wide_string_table` для определения максимальной длины всех строковых столбцов. [#14233](https://github.com/ClickHouse/ClickHouse/pull/14233) ([Amos Bird](https://github.com/amosbird)).
- Добавлена агрегатная функция `rankCorr`, которая вычисляет коэффициент ранговой корреляции. [#11769](https://github.com/ClickHouse/ClickHouse/pull/11769) ([antikvist](https://github.com/antikvist)) [#14411](https://github.com/ClickHouse/ClickHouse/pull/14411) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Добавлена табличная функция `view`, которая преобразует подзапрос в табличный объект. Это упрощает передачу запросов. Например, её можно использовать в табличных функциях remote/cluster. [#12567](https://github.com/ClickHouse/ClickHouse/pull/12567) ([Amos Bird](https://github.com/amosbird)).

#### Исправление ошибок {#bug-fix-15}


* Исправлена ошибка, из-за которой мутация `ALTER UPDATE` с Nullable-столбцом в выражении присваивания и константным значением (например, `UPDATE x = 42`) приводила к некорректному значению в столбце или к ошибке segfault. Исправляет [#13634](https://github.com/ClickHouse/ClickHouse/issues/13634), [#14045](https://github.com/ClickHouse/ClickHouse/issues/14045). [#14646](https://github.com/ClickHouse/ClickHouse/pull/14646) ([alesapin](https://github.com/alesapin)).
* Исправлен неверный результат умножения `Decimal`, вызванный некорректным масштабом в результирующем столбце. [#14603](https://github.com/ClickHouse/ClickHouse/pull/14603) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлен неверный порядок сортировки столбца типа `Nullable`. Это исправляет [#14344](https://github.com/ClickHouse/ClickHouse/issues/14344). [#14495](https://github.com/ClickHouse/ClickHouse/pull/14495) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлено некорректное сравнение с первичным ключом типа `FixedString` при анализе индексов, если его сравнивали со строкой меньшей длины. Это исправляет [#14908](https://github.com/ClickHouse/ClickHouse/issues/14908). [#15033](https://github.com/ClickHouse/ClickHouse/pull/15033) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка, приводившая к некорректному назначению слияний, если таблица содержит партиции с единственной частью. [#14444](https://github.com/ClickHouse/ClickHouse/pull/14444) ([alesapin](https://github.com/alesapin)).
* Если функцию `bar` вызывали со специально подобранными аргументами, могло произойти переполнение буфера. Это закрывает [#13926](https://github.com/ClickHouse/ClickHouse/issues/13926). [#15028](https://github.com/ClickHouse/ClickHouse/pull/15028) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Публикация частот CPU по каждому логическому ядру в `system.asynchronous_metrics`. Исправление [#14923](https://github.com/ClickHouse/ClickHouse/issues/14923). [#14924](https://github.com/ClickHouse/ClickHouse/pull/14924) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Исправлена ошибка `.metadata.tmp File exists` при использовании движка базы данных `MaterializeMySQL`. [#14898](https://github.com/ClickHouse/ClickHouse/pull/14898) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена проблема, из-за которой некоторые вызовы функции `extractAllGroups` могли приводить к ошибке «Memory limit exceeded». Это исправляет [#13383](https://github.com/ClickHouse/ClickHouse/issues/13383). [#14889](https://github.com/ClickHouse/ClickHouse/pull/14889) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен SIGSEGV при попытке выполнить INSERT в StorageFile(fd). [#14887](https://github.com/ClickHouse/ClickHouse/pull/14887) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена редкая ошибка в запросах `SELECT`, возникавшая, когда запрашиваемый столбец имеет выражение `DEFAULT`, зависящее от другого столбца, который также имеет `DEFAULT`, не участвует в запросе `SELECT` и отсутствует на диске. Частично исправляет [#14531](https://github.com/ClickHouse/ClickHouse/issues/14531). [#14845](https://github.com/ClickHouse/ClickHouse/pull/14845) ([alesapin](https://github.com/alesapin)).
* Исправлено некорректное определение монотонности для сужающего приведения типов `Int -> Int` для знаковых типов. Это могло приводить к некорректным результатам запроса. Ошибка была выявлена в [#14513](https://github.com/ClickHouse/ClickHouse/issues/14513). [#14783](https://github.com/ClickHouse/ClickHouse/pull/14783) ([Amos Bird](https://github.com/amosbird)).
* Исправлена проблема с отсутствующим именем базы данных по умолчанию в метаданных материализованного представления при выполнении `ALTER ... MODIFY QUERY`. [#14664](https://github.com/ClickHouse/ClickHouse/pull/14664) ([tavplubix](https://github.com/tavplubix)).
* Исправлена возможная некорректная работа функции `has` при использовании типов LowCardinality и Nullable. [#14591](https://github.com/ClickHouse/ClickHouse/pull/14591) ([Mike](https://github.com/myrrc)).
* Очистка каталога данных после исключений ZooKeeper во время выполнения запроса CREATE для таблиц с движком ReplicatedMergeTree. [#14563](https://github.com/ClickHouse/ClickHouse/pull/14563) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлены редкие сегфолты в функциях с комбинатором `-Resample`, которые могли возникать из‑за переполнения при очень больших значениях параметров. [#14562](https://github.com/ClickHouse/ClickHouse/pull/14562) ([Anton Popov](https://github.com/CurtizJ)).
* Проверка на переполнение размера массива в агрегатной функции `topK`. Без этой проверки пользователь может отправить запрос с тщательно подобранными параметрами, который приведёт к сбою сервера. Это закрывает [#14452](https://github.com/ClickHouse/ClickHouse/issues/14452). [#14467](https://github.com/ClickHouse/ClickHouse/pull/14467) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Проксирование команд restart/start/stop/reload от SysVinit к systemd (если используется). [#14460](https://github.com/ClickHouse/ClickHouse/pull/14460) ([Azat Khuzhin](https://github.com/azat)).
* Останавливать выполнение запроса, если исключение произошло в самом `PipelineExecutor`. Это позволяет предотвратить редкие случаи зависания запроса. [#14334](https://github.com/ClickHouse/ClickHouse/pull/14334) [#14402](https://github.com/ClickHouse/ClickHouse/pull/14402) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен сбой при выполнении запроса `ALTER` для таблицы, созданной с помощью `AS table_function`. Исправляет [#14212](https://github.com/ClickHouse/ClickHouse/issues/14212). [#14326](https://github.com/ClickHouse/ClickHouse/pull/14326) ([alesapin](https://github.com/alesapin)).
* Исправлено исключение, возникавшее при выполнении запроса `ALTER LIVE VIEW` с командой `REFRESH`. `LIVE VIEW` — экспериментальная функция. [#14320](https://github.com/ClickHouse/ClickHouse/pull/14320) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлено время жизни `QueryPlan` (для `EXPLAIN PIPELINE graph=1`) в запросах с вложенным интерпретатором. [#14315](https://github.com/ClickHouse/ClickHouse/pull/14315) ([Azat Khuzhin](https://github.com/azat)).
* Улучшена проверка размера кортежа в SSD-кэше внешних словарей со сложными ключами. Исправляет [#13981](https://github.com/ClickHouse/ClickHouse/issues/13981). [#14313](https://github.com/ClickHouse/ClickHouse/pull/14313) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Запрещает использование `CODEC` для столбцов типа `ALIAS`. Исправление [#13911](https://github.com/ClickHouse/ClickHouse/issues/13911). [#14263](https://github.com/ClickHouse/ClickHouse/pull/14263) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлена работа оператора GRANT ALL при выполнении на неглобальном уровне. [#13987](https://github.com/ClickHouse/ClickHouse/pull/13987) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен захват `arrayJoin()` в лямбда-выражении (выбрасывалось исключение с сообщением о логической ошибке). [#13792](https://github.com/ClickHouse/ClickHouse/pull/13792) ([Azat Khuzhin](https://github.com/azat)).

#### Экспериментальная функциональность {#experimental-feature-2}

- Добавлен инструмент `db-generator` для генерации случайной базы данных на основе заданных SELECT-запросов. Это может упростить воспроизведение проблем, когда от пользователя получен только неполный отчёт об ошибке. [#14442](https://github.com/ClickHouse/ClickHouse/pull/14442) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)) [#10973](https://github.com/ClickHouse/ClickHouse/issues/10973) ([ZeDRoman](https://github.com/ZeDRoman)).

#### Улучшения {#improvement-8}

- Разрешено использование многотомной конфигурации хранилища в движке Distributed. [#14839](https://github.com/ClickHouse/ClickHouse/pull/14839) ([Pavel Kovalenko](https://github.com/Jokser)).
- Запрещён пустой аргумент time_zone в функциях типа `toStartOf*`. [#14509](https://github.com/ClickHouse/ClickHouse/pull/14509) ([Bharat Nallan](https://github.com/bharatnc)).
- Обработчик MySQL возвращает `OK` для запросов вида `SET @@var = value`. Такие выражения игнорируются. Это необходимо, поскольку некоторые драйверы MySQL отправляют запрос `SET @@` для настройки после рукопожатия https://github.com/ClickHouse/ClickHouse/issues/9336#issuecomment-686222422 . [#14469](https://github.com/ClickHouse/ClickHouse/pull/14469) ([BohuTANG](https://github.com/BohuTANG)).
- Теперь TTL применяются во время слияния, если они не были материализованы ранее. [#14438](https://github.com/ClickHouse/ClickHouse/pull/14438) ([alesapin](https://github.com/alesapin)).
- Теперь `clickhouse-obfuscator` поддерживает тип UUID, как предложено в [#13163](https://github.com/ClickHouse/ClickHouse/issues/13163). [#14409](https://github.com/ClickHouse/ClickHouse/pull/14409) ([dimarub2000](https://github.com/dimarub2000)).
- Добавлена новая настройка `system_events_show_zero_values`, как предложено в [#11384](https://github.com/ClickHouse/ClickHouse/issues/11384). [#14404](https://github.com/ClickHouse/ClickHouse/pull/14404) ([dimarub2000](https://github.com/dimarub2000)).
- Неявное преобразование первичного ключа в NOT NULL в `MaterializeMySQL` (аналогично `MySQL`). Исправляет [#14114](https://github.com/ClickHouse/ClickHouse/issues/14114). [#14397](https://github.com/ClickHouse/ClickHouse/pull/14397) ([Winter Zhang](https://github.com/zhang2014)).
- Замена широких целых чисел (256 бит) из boost multiprecision на реализацию из https://github.com/cerevra/int. 256-битные целые числа являются экспериментальными. [#14229](https://github.com/ClickHouse/ClickHouse/pull/14229) ([Artem Zuikov](https://github.com/4ertus2)).
- Добавлен кодек сжатия по умолчанию для кусков данных в `system.part_log` с именем `default_compression_codec`. [#14116](https://github.com/ClickHouse/ClickHouse/pull/14116) ([alesapin](https://github.com/alesapin)).
- Добавлен аргумент точности для типа `DateTime`. Это позволяет использовать имя `DateTime` вместо `DateTime64`. [#13761](https://github.com/ClickHouse/ClickHouse/pull/13761) ([Winter Zhang](https://github.com/zhang2014)).
- Добавлена авторизация requirepass для внешнего словаря `Redis`. [#13688](https://github.com/ClickHouse/ClickHouse/pull/13688) ([Ivan Torgashov](https://github.com/it1804)).
- Улучшения в движке `RabbitMQ`: добавлена обработка сбоев соединений и каналов, корректные коммиты, обработка ошибок вставки, улучшенные обменники, устойчивость очередей и возможность возобновления очередей, новые настройки очередей. Исправлены тесты. [#12761](https://github.com/ClickHouse/ClickHouse/pull/12761) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Поддержка пользовательских кодеков в компактных кусках данных. [#12183](https://github.com/ClickHouse/ClickHouse/pull/12183) ([Anton Popov](https://github.com/CurtizJ)).

#### Улучшения производительности {#performance-improvement-4}


- Оптимизация запросов с LIMIT/LIMIT BY/ORDER BY для распределённых таблиц с GROUP BY sharding_key (при включённых настройках `optimize_skip_unused_shards` и `optimize_distributed_group_by_sharding_key`). [#10373](https://github.com/ClickHouse/ClickHouse/pull/10373) ([Azat Khuzhin](https://github.com/azat)).
- Параллельное создание множеств для нескольких операций `JOIN` и `IN`. Может незначительно улучшить производительность запросов с несколькими различными выражениями `IN subquery`. [#14412](https://github.com/ClickHouse/ClickHouse/pull/14412) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Улучшение производительности движка Kafka за счёт выделения независимого потока для каждого потребителя. Отдельный пул потоков для потоковых движков (таких как Kafka). [#13939](https://github.com/ClickHouse/ClickHouse/pull/13939) ([fastio](https://github.com/fastio)).

#### Улучшения сборки, тестирования и пакетирования {#buildtestingpackaging-improvement-6}

- Уменьшение размера бинарного файла в отладочной сборке путём удаления отладочной информации из `Functions`. Это необходимо только для одного внутреннего проекта в Яндексе, использующего очень старый компоновщик. [#14549](https://github.com/ClickHouse/ClickHouse/pull/14549) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Подготовка к сборке с clang 11. [#14455](https://github.com/ClickHouse/ClickHouse/pull/14455) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Исправление логики в скрипте бэкпорта. В предыдущих версиях он срабатывал для любых меток с 100% красным цветом. Это было странно. [#14433](https://github.com/ClickHouse/ClickHouse/pull/14433) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Интеграционные тесты используют базовую конфигурацию по умолчанию. Все изменения конфигурации явно задаются через параметры main_configs, user_configs и dictionaries для экземпляра. [#13647](https://github.com/ClickHouse/ClickHouse/pull/13647) ([Ilya Yatsishin](https://github.com/qoega)).


## Релиз ClickHouse 20.8 {#clickhouse-release-208}

### Релиз ClickHouse v20.8.12.2-lts, 2021-01-16 {#clickhouse-release-v208122-lts-2021-01-16}

#### Исправление ошибок {#bug-fix-16}

- Исправлен комбинатор \*If с унарной функцией и типами Nullable. [#18806](https://github.com/ClickHouse/ClickHouse/pull/18806) ([Azat Khuzhin](https://github.com/azat)).
- Ограничены слияния из широких частей в компактные. В случае вертикального слияния это приводило к повреждённой результирующей части. [#18381](https://github.com/ClickHouse/ClickHouse/pull/18381) ([Anton Popov](https://github.com/CurtizJ)).

### Релиз ClickHouse v20.8.11.17-lts, 2020-12-25 {#clickhouse-release-v2081117-lts-2020-12-25}

#### Исправление ошибок {#bug-fix-17}

- Отключена запись с использованием AIO во время слияний, так как это может приводить к крайне редким повреждениям данных в столбцах первичного ключа при слиянии. [#18481](https://github.com/ClickHouse/ClickHouse/pull/18481) ([alesapin](https://github.com/alesapin)).
- Исправлена ошибка `value is too short` при выполнении функций `toType(...)` (`toDate`, `toUInt32` и т. д.) с аргументом типа `Nullable(String)`. Теперь такие функции возвращают `NULL` при ошибках парсинга вместо выбрасывания исключения. Исправляет [#7673](https://github.com/ClickHouse/ClickHouse/issues/7673). [#18445](https://github.com/ClickHouse/ClickHouse/pull/18445) ([tavplubix](https://github.com/tavplubix)).
- Исправлены возможные падения агрегатных функций с комбинатором `Distinct` при использовании двухуровневой агрегации. Исправляет [#17682](https://github.com/ClickHouse/ClickHouse/issues/17682). [#18365](https://github.com/ClickHouse/ClickHouse/pull/18365) ([Anton Popov](https://github.com/CurtizJ)).

### Релиз ClickHouse v20.8.10.13-lts, 2020-12-24 {#clickhouse-release-v2081013-lts-2020-12-24}

#### Исправление ошибок {#bug-fix-18}


* Когда ротация серверных логов была настроена с использованием параметра `logger.size` с числовым значением больше 2^32, логи некорректно ротировались. [#17905](https://github.com/ClickHouse/ClickHouse/pull/17905) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Исправлена некорректная инициализация `max_compress_block_size` в MergeTreeWriterSettings значением `min_compress_block_size`. [#17833](https://github.com/ClickHouse/ClickHouse/pull/17833) ([flynn](https://github.com/ucasFL)).
* Исправлена проблема, из-за которой ClickHouse не удавалось восстановить подключение к серверам MySQL. [#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz)).
* Исправлено зависание запроса `ALTER`, когда соответствующая мутация была уничтожена на другой реплике. Исправляет [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953). [#17499](https://github.com/ClickHouse/ClickHouse/pull/17499) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка, из-за которой ClickHouse занижал размер кэша меток. Это могло происходить, когда было много мелких файлов с метками. [#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin)).
* Исправлена работа `ORDER BY` при включённой настройке `optimize_redundant_functions_in_order_by`. [#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено сравнение `ColumnConst`, приводившее к сбою. Тем самым исправлена проблема [#17088](https://github.com/ClickHouse/ClickHouse/issues/17088). [#17135](https://github.com/ClickHouse/ClickHouse/pull/17135) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка, из-за которой запросы с `ON CLUSTER` могли бесконечно зависать на не-лидирующих таблицах ReplicatedMergeTree. [#17089](https://github.com/ClickHouse/ClickHouse/pull/17089) ([alesapin](https://github.com/alesapin)).
* Избегайте лишних сетевых ошибок для удалённых запросов, которые могут быть отменены в ходе выполнения, например запросов с `LIMIT`. [#17006](https://github.com/ClickHouse/ClickHouse/pull/17006) ([Azat Khuzhin](https://github.com/azat)).
* Повторно выполнять определение IP-адреса для `format_avro_schema_registry_url` в случае ошибок. [#16985](https://github.com/ClickHouse/ClickHouse/pull/16985) ([filimonov](https://github.com/filimonov)).
* Исправлена возможная аварийная остановка сервера после `ALTER TABLE ... MODIFY COLUMN ... NewType`, когда запрос `SELECT` содержит выражение `WHERE` по изменяемому столбцу, а операция `ALTER` ещё не завершилась. [#16968](https://github.com/ClickHouse/ClickHouse/pull/16968) ([Amos Bird](https://github.com/amosbird)).
* Скрипт установки всегда должен создавать подкаталоги в каталогах конфигурации. Это актуально только для сборки Docker с пользовательской конфигурацией. [#16936](https://github.com/ClickHouse/ClickHouse/pull/16936) ([filimonov](https://github.com/filimonov)).
* Исправлена возможная ошибка `Illegal type of argument` для запросов с `ORDER BY`. Исправлено [#16580](https://github.com/ClickHouse/ClickHouse/issues/16580). [#16928](https://github.com/ClickHouse/ClickHouse/pull/16928) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Прерывать многочастичную загрузку, если в WriteBufferFromS3 не было записано никаких данных. [#16840](https://github.com/ClickHouse/ClickHouse/pull/16840) ([Pavel Kovalenko](https://github.com/Jokser)).
* Исправлено падение при использовании `any` без аргументов. Это исправляет [#16803](https://github.com/ClickHouse/ClickHouse/issues/16803). [#16826](https://github.com/ClickHouse/ClickHouse/pull/16826) ([Amos Bird](https://github.com/amosbird)).
* Исправлена работа оператора `IN` над несколькими столбцами и кортежами при включённой настройке `transform_null_in`. Исправляет [#15310](https://github.com/ClickHouse/ClickHouse/issues/15310). [#16722](https://github.com/ClickHouse/ClickHouse/pull/16722) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено непоследовательное поведение `optimize_read_in_order/optimize_aggregation_in_order` при max&#95;threads &gt; 0 и наличии выражения в ORDER BY. [#16637](https://github.com/ClickHouse/ClickHouse/pull/16637) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, из-за которой оптимизация запроса приводила к неверному результату, если запрос содержал `ARRAY JOIN`. [#17887](https://github.com/ClickHouse/ClickHouse/pull/17887) ([sundyli](https://github.com/sundy-li)).
* Запрос завершается быстрее в случае возникновения исключения. При возникновении исключения выполнение на удалённых репликах отменяется. [#15578](https://github.com/ClickHouse/ClickHouse/pull/15578) ([Azat Khuzhin](https://github.com/azat)).

### ClickHouse release v20.8.6.6-lts, 2020-11-13 {#clickhouse-release-v20866-lts-2020-11-13}

#### Исправление ошибок {#bug-fix-19}

- Исправлены редкие незаметные сбои при включенном профилировщике запросов, когда ClickHouse установлен в ОС с версией glibc, в которой (предположительно) повреждены таблицы асинхронной раскрутки стека для некоторых функций. Исправляет [#15301](https://github.com/ClickHouse/ClickHouse/issues/15301). Исправляет [#13098](https://github.com/ClickHouse/ClickHouse/issues/13098). [#16846](https://github.com/ClickHouse/ClickHouse/pull/16846) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Теперь при парсинге AVRO из входных данных тип LowCardinality удаляется. Исправляет [#16188](https://github.com/ClickHouse/ClickHouse/issues/16188). [#16521](https://github.com/ClickHouse/ClickHouse/pull/16521) ([Mike](https://github.com/myrrc)).
- Исправлен быстрый рост метаданных при использовании схемы MySQL Master -> MySQL Slave -> ClickHouse MaterializeMySQL Engine с включенным параметром `slave_parallel_worker` на MySQL Slave путем корректного сжатия наборов GTID. Исправляет [#15951](https://github.com/ClickHouse/ClickHouse/issues/15951). [#16504](https://github.com/ClickHouse/ClickHouse/pull/16504) ([TCeason](https://github.com/TCeason)).
- Исправлена операция DROP TABLE для таблиц Distributed (состояние гонки с INSERT). [#16409](https://github.com/ClickHouse/ClickHouse/pull/16409) ([Azat Khuzhin](https://github.com/azat)).
- Исправлена обработка очень больших записей в очереди репликации. Очень большие записи могут появляться в запросах ALTER, если структура таблицы чрезвычайно велика (около 1 МБ). Исправляет [#16307](https://github.com/ClickHouse/ClickHouse/issues/16307). [#16332](https://github.com/ClickHouse/ClickHouse/pull/16332) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Исправлено непоследовательное поведение, при котором часть возвращаемых данных могла быть отброшена из-за того, что набор для их фильтрации не был создан. [#16308](https://github.com/ClickHouse/ClickHouse/pull/16308) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Исправлена ошибка с базой данных MySQL. Когда сервер MySQL, используемый в качестве движка базы данных, недоступен, некоторые запросы вызывают исключение, поскольку они пытаются получить таблицы с отключенного сервера, хотя это не требуется. Например, запрос `SELECT ... FROM system.parts` должен работать только с таблицами MergeTree и вообще не обращаться к базе данных MySQL. [#16032](https://github.com/ClickHouse/ClickHouse/pull/16032) ([Kruglov Pavel](https://github.com/Avogar)).

### ClickHouse release v20.8.5.45-lts, 2020-10-29 {#clickhouse-release-v208545-lts-2020-10-29}

#### Исправление ошибок {#bug-fix-20}


* Исправлено двойное освобождение памяти в случае возникновения исключения в функции `dictGet`. Это могло происходить, если словарь загружался с ошибкой. [#16429](https://github.com/ClickHouse/ClickHouse/pull/16429) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена работа `GROUP BY` с модификаторами `WITH TOTALS`/`ROLLUP`/`CUBE` и функциями `min`/`max` по ключам группировки. Исправление для [#16393](https://github.com/ClickHouse/ClickHouse/issues/16393). [#16397](https://github.com/ClickHouse/ClickHouse/pull/16397) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена асинхронная вставка в таблицы `Distributed` с `prefer_localhost_replica=0` и внутренней репликацией. [#16358](https://github.com/ClickHouse/ClickHouse/pull/16358) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена возможная утечка памяти при выполнении `GROUP BY` со строковыми ключами, вызванная ошибкой в реализации `TwoLevelStringHashTable`. [#16264](https://github.com/ClickHouse/ClickHouse/pull/16264) ([Amos Bird](https://github.com/amosbird)).
* Исправлен случай, когда память могла выделяться сверх лимита. Это закрывает [#14560](https://github.com/ClickHouse/ClickHouse/issues/14560). [#16206](https://github.com/ClickHouse/ClickHouse/pull/16206) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено зависание запроса `ALTER MODIFY ... ORDER BY` для `ReplicatedVersionedCollapsingMergeTree`. Исправляет [#15980](https://github.com/ClickHouse/ClickHouse/issues/15980). [#16011](https://github.com/ClickHouse/ClickHouse/pull/16011) ([alesapin](https://github.com/alesapin)).
* Исправлен парсер имени сортировки (`collate`) и имени набора символов, а также добавлена поддержка `length = 0` для строкового типа. [#16008](https://github.com/ClickHouse/ClickHouse/pull/16008) ([Winter Zhang](https://github.com/zhang2014)).
* Разрешено использовать прямое размещение для словарей со сложными ключами. [#16007](https://github.com/ClickHouse/ClickHouse/pull/16007) ([Anton Popov](https://github.com/CurtizJ)).
* Предотвращено зависание реплики на 5–10 минут при возникновении ошибки репликации после периода бездействия. [#15987](https://github.com/ClickHouse/ClickHouse/pull/15987) ([filimonov](https://github.com/filimonov)).
* Исправлены редкие сбои (segfault) при вставке в `MaterializedView` или выборе из него при одновременном удалении целевой таблицы (для движка базы данных `Atomic`). [#15984](https://github.com/ClickHouse/ClickHouse/pull/15984) ([tavplubix](https://github.com/tavplubix)).
* Исправлена неоднозначность при разборе профилей настроек: `CREATE USER ... SETTINGS profile readonly` теперь интерпретируется как использование профиля с именем `readonly`, а не настройки с именем `profile` с ограничением readonly. Это исправляет [#15628](https://github.com/ClickHouse/ClickHouse/issues/15628). [#15982](https://github.com/ClickHouse/ClickHouse/pull/15982) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено падение при ошибке создания базы данных. [#15954](https://github.com/ClickHouse/ClickHouse/pull/15954) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена ошибка выполнения `DROP TABLE IF EXISTS` с сообщением `Table ... does not exist`, возникавшая при одновременном переименовании таблицы (для движка базы данных Atomic). Исправлен редкий дедлок при одновременном выполнении некоторых DDL‑запросов над несколькими таблицами (таких как `DROP DATABASE` и `RENAME TABLE`). Исправлена ошибка выполнения `DROP/DETACH DATABASE` с сообщением `Table ... does not exist` при одновременном выполнении `DROP/DETACH TABLE`. [#15934](https://github.com/ClickHouse/ClickHouse/pull/15934) ([tavplubix](https://github.com/tavplubix)).
* Исправлена некорректная пустая выборка для запроса к таблице `Distributed`, если запрос содержит `WHERE`, `PREWHERE` и `GLOBAL IN`. Исправляет [#15792](https://github.com/ClickHouse/ClickHouse/issues/15792). [#15933](https://github.com/ClickHouse/ClickHouse/pull/15933) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлены потенциальные взаимоблокировки в RBAC. [#15875](https://github.com/ClickHouse/ClickHouse/pull/15875) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено исключение `Block structure mismatch` в запросах `SELECT ... ORDER BY DESC`, которые выполнялись после запроса `ALTER MODIFY COLUMN`. Исправление [#15800](https://github.com/ClickHouse/ClickHouse/issues/15800). [#15852](https://github.com/ClickHouse/ClickHouse/pull/15852) ([alesapin](https://github.com/alesapin)).
* Исправлены некоторые случаи запросов, в которых выбирались только виртуальные столбцы. Ранее могла возникать ошибка `Not found column _nothing in block`. Исправляет [#12298](https://github.com/ClickHouse/ClickHouse/issues/12298). [#15756](https://github.com/ClickHouse/ClickHouse/pull/15756) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка `Cannot find column`, которая могла возникать при вставке в `MATERIALIZED VIEW`, если запрос для `MV` содержал `ARRAY JOIN`. [#15717](https://github.com/ClickHouse/ClickHouse/pull/15717) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено слишком низкое значение по умолчанию настройки `max_replicated_logs_to_keep`, которое могло приводить к слишком частой потере реплик. Улучшен процесс восстановления потерянной реплики за счет выбора наиболее актуальной реплики для клонирования. Также старые парты на потерянной реплике больше не удаляются, а отсоединяются. [#15701](https://github.com/ClickHouse/ClickHouse/pull/15701) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка `Cannot add simple transform to empty Pipe`, возникавшая при чтении из таблицы `Buffer`, структура которой отличалась от структуры таблицы-приёмника. Она могла проявляться, если таблица-приёмник возвращала пустой результат запроса. Исправляет [#15529](https://github.com/ClickHouse/ClickHouse/issues/15529). [#15662](https://github.com/ClickHouse/ClickHouse/pull/15662) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка с шаблонами (`globs`) в функции таблицы S3: регион из URL не применялся к конфигурации клиента S3. [#15646](https://github.com/ClickHouse/ClickHouse/pull/15646) ([Vladimir Chebotarev](https://github.com/excitoon)).
* При отсоединении таблиц только для чтения уменьшается значение метрики `ReadonlyReplica`. Исправляет [#15598](https://github.com/ClickHouse/ClickHouse/issues/15598). [#15592](https://github.com/ClickHouse/ClickHouse/pull/15592) ([sundyli](https://github.com/sundy-li)).
* Вызывать ошибку, если в `ReplicatedMergeTree` передан единственный параметр, вместо того чтобы игнорировать его. [#15516](https://github.com/ClickHouse/ClickHouse/pull/15516) ([nvartolomei](https://github.com/nvartolomei)).

#### Улучшение {#improvement-9}

- Теперь разрешено выполнять запросы `ALTER ... ON CLUSTER` независимо от настройки `<internal_replication>` в конфигурации кластера. [#16075](https://github.com/ClickHouse/ClickHouse/pull/16075) ([alesapin](https://github.com/alesapin)).
- Раскрытие макросов `{database}`, `{table}` и `{uuid}` в аргументах `ReplicatedMergeTree` при создании таблицы. [#16159](https://github.com/ClickHouse/ClickHouse/pull/16159) ([tavplubix](https://github.com/tavplubix)).

### Релиз ClickHouse v20.8.4.11-lts, 2020-10-09 {#clickhouse-release-v208411-lts-2020-10-09}

#### Исправление ошибок {#bug-fix-21}


* Исправлен порядок уничтожения ресурсов на шаге `ReadFromStorage` плана запроса. В редких случаях это могло приводить к сбоям. Возможно, связано с [#15610](https://github.com/ClickHouse/ClickHouse/issues/15610). [#15645](https://github.com/ClickHouse/ClickHouse/pull/15645) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка `Element ... is not a constant expression` при использовании результата функции `JSON*` в `VALUES`, `LIMIT` или в правой части оператора `IN`. [#15589](https://github.com/ClickHouse/ClickHouse/pull/15589) ([tavplubix](https://github.com/tavplubix)).
* Исключена возможность появления сообщения об ошибке `Could not calculate available disk space (statvfs), errno: 4, strerror: Interrupted system call`. Исправляет [#15541](https://github.com/ClickHouse/ClickHouse/issues/15541). [#15557](https://github.com/ClickHouse/ClickHouse/pull/15557) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Существенно снижено потребление памяти в AggregatingInOrderTransform/optimize&#95;aggregation&#95;in&#95;order. [#15543](https://github.com/ClickHouse/ClickHouse/pull/15543) ([Azat Khuzhin](https://github.com/azat)).
* Мутация могла «зависнуть» в ожидании несуществующей части после `MOVE` или `REPLACE PARTITION` или, в редких случаях, после `DETACH` или `DROP PARTITION`. Исправлено. [#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка, из-за которой оператор `ILIKE` переставал быть регистронезависимым, если выполнялся `LIKE` с тем же шаблоном. [#15536](https://github.com/ClickHouse/ClickHouse/pull/15536) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка `Missing columns` при выборе столбцов, которые отсутствуют в данных, но зависят от других столбцов, также отсутствующих в данных. Исправлено в [#15530](https://github.com/ClickHouse/ClickHouse/issues/15530). [#15532](https://github.com/ClickHouse/ClickHouse/pull/15532) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка с подпиской на события в `DDLWorker`, которая в редких случаях могла приводить к зависанию запросов с `ON CLUSTER`. Ошибка была внесена в [#13450](https://github.com/ClickHouse/ClickHouse/issues/13450). [#15477](https://github.com/ClickHouse/ClickHouse/pull/15477) ([alesapin](https://github.com/alesapin)).
* Исправлена выдача ошибки при неверном типе второго аргумента агрегатной функции `boundingRatio`. [#15407](https://github.com/ClickHouse/ClickHouse/pull/15407) ([detailyang](https://github.com/detailyang)).
* Исправлена гонка во время переименования таблицы MergeTree и фоновой очистки. [#15304](https://github.com/ClickHouse/ClickHouse/pull/15304) ([alesapin](https://github.com/alesapin)).
* Исправлено редкое состояние гонки при запуске сервера при включённых system.logs. [#15300](https://github.com/ClickHouse/ClickHouse/pull/15300) ([alesapin](https://github.com/alesapin)).
* Исправлен отчёт MSan в QueryLog. Для поля `memory_usage` могла использоваться неинициализированная память. [#15258](https://github.com/ClickHouse/ClickHouse/pull/15258) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен сбой экземпляра при использовании joinGet с типами LowCardinality. Это исправляет [#15214](https://github.com/ClickHouse/ClickHouse/issues/15214). [#15220](https://github.com/ClickHouse/ClickHouse/pull/15220) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка в движке таблиц `Buffer`, из‑за которой после запроса `ALTER` нельзя было вставлять в `Buffer` данные новой структуры. Исправление для [#15117](https://github.com/ClickHouse/ClickHouse/issues/15117). [#15192](https://github.com/ClickHouse/ClickHouse/pull/15192) ([alesapin](https://github.com/alesapin)).
* Изменен размер поля для количества знаков после запятой в пакете определения столбца MySQL. [#15152](https://github.com/ClickHouse/ClickHouse/pull/15152) ([maqroll](https://github.com/maqroll)).
* Мы уже используем сравнение строк с выравниванием (padded comparison) между String и FixedString ([https://github.com/ClickHouse/ClickHouse/blob/master/src/Functions/FunctionsComparison.h#L333](https://github.com/ClickHouse/ClickHouse/blob/master/src/Functions/FunctionsComparison.h#L333)). Этот PR распространяет ту же логику на сравнение полей, что исправляет использование FixedString в качестве первичных ключей. Это решает проблему [#14908](https://github.com/ClickHouse/ClickHouse/issues/14908). [#15033](https://github.com/ClickHouse/ClickHouse/pull/15033) ([Amos Bird](https://github.com/amosbird)).
* Если функция `bar` вызывалась со специально подобранными аргументами, могло произойти переполнение буфера. Это закрывает [#13926](https://github.com/ClickHouse/ClickHouse/issues/13926). [#15028](https://github.com/ClickHouse/ClickHouse/pull/15028) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка `Cannot rename ... errno: 22, strerror: Invalid argument` при выполнении DDL-запросов в базе данных Atomic при запуске clickhouse-server в Docker на macOS. [#15024](https://github.com/ClickHouse/ClickHouse/pull/15024) ([tavplubix](https://github.com/tavplubix)).
* Теперь параметры `number_of_free_entries_in_pool_to_execute_mutation` и `number_of_free_entries_in_pool_to_lower_max_size_of_merge` могут быть равны `background_pool_size`. [#14975](https://github.com/ClickHouse/ClickHouse/pull/14975) ([alesapin](https://github.com/alesapin)).
* Исправление, позволяющее использовать проталкивание предикатов, когда подзапрос содержит функцию finalizeAggregation. Исправляет [#14847](https://github.com/ClickHouse/ClickHouse/issues/14847). [#14937](https://github.com/ClickHouse/ClickHouse/pull/14937) ([filimonov](https://github.com/filimonov)).
* Публикация частот CPU по каждому логическому ядру в `system.asynchronous_metrics`. Это исправляет [#14923](https://github.com/ClickHouse/ClickHouse/issues/14923). [#14924](https://github.com/ClickHouse/ClickHouse/pull/14924) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Исправлена ошибка `.metadata.tmp File exists` при использовании движка базы данных `MaterializeMySQL`. [#14898](https://github.com/ClickHouse/ClickHouse/pull/14898) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена проблема, из-за которой сервер мог зависать при запуске во время взаимодействия с ZooKeeper, если файлы конфигурации нужно было получать из ZK (с использованием опции include `from_zk`). Исправляет [#14814](https://github.com/ClickHouse/ClickHouse/issues/14814). [#14843](https://github.com/ClickHouse/ClickHouse/pull/14843) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Исправлено некорректное определение монотонности при сужающем приведении типов `Int -> Int` для знаковых типов. Это могло приводить к неверному результату запроса. Ошибка была обнаружена в [#14513](https://github.com/ClickHouse/ClickHouse/issues/14513). [#14783](https://github.com/ClickHouse/ClickHouse/pull/14783) ([Amos Bird](https://github.com/amosbird)).
* Исправлен некорректный порядок сортировки столбца типа `Nullable`. Это исправляет [#14344](https://github.com/ClickHouse/ClickHouse/issues/14344). [#14495](https://github.com/ClickHouse/ClickHouse/pull/14495) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).

#### Улучшение {#improvement-10}

- Теперь можно изменить тип колонки версии для `VersionedCollapsingMergeTree` с помощью запроса `ALTER`. [#15442](https://github.com/ClickHouse/ClickHouse/pull/15442) ([alesapin](https://github.com/alesapin)).

### Релиз ClickHouse v20.8.3.18-stable, 2020-09-18 {#clickhouse-release-v208318-stable-2020-09-18}

#### Исправления ошибок {#bug-fix-22}

- Исправлена проблема, при которой некоторые вызовы функции `extractAllGroups` могли приводить к ошибке «Memory limit exceeded». Исправляет [#13383](https://github.com/ClickHouse/ClickHouse/issues/13383). [#14889](https://github.com/ClickHouse/ClickHouse/pull/14889) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Исправлен SIGSEGV при попытке выполнить INSERT в StorageFile(fd). [#14887](https://github.com/ClickHouse/ClickHouse/pull/14887) ([Azat Khuzhin](https://github.com/azat)).
- Исправлена редкая ошибка в запросах `SELECT`, когда запрашиваемая колонка имеет выражение `DEFAULT`, зависящее от другой колонки, которая также имеет `DEFAULT`, отсутствует в запросе `SELECT` и не существует на диске. Частично исправляет [#14531](https://github.com/ClickHouse/ClickHouse/issues/14531). [#14845](https://github.com/ClickHouse/ClickHouse/pull/14845) ([alesapin](https://github.com/alesapin)).
- Исправлено отсутствие имени базы данных по умолчанию в метаданных материализованного представления при выполнении `ALTER ... MODIFY QUERY`. [#14664](https://github.com/ClickHouse/ClickHouse/pull/14664) ([tavplubix](https://github.com/tavplubix)).
- Исправлена ошибка, когда мутация `ALTER UPDATE` с Nullable-колонкой в выражении присваивания и константным значением (например, `UPDATE x = 42`) приводила к некорректному значению в колонке или сегфолту. Исправляет [#13634](https://github.com/ClickHouse/ClickHouse/issues/13634), [#14045](https://github.com/ClickHouse/ClickHouse/issues/14045). [#14646](https://github.com/ClickHouse/ClickHouse/pull/14646) ([alesapin](https://github.com/alesapin)).
- Исправлен некорректный результат умножения Decimal, вызванный неверным масштабом десятичной части результирующей колонки. [#14603](https://github.com/ClickHouse/ClickHouse/pull/14603) ([Artem Zuиков](https://github.com/4ertus2)).
- Добавлена проверка, так как ни вызов `lc->isNullable()`, ни вызов `ls->getDictionaryPtr()->isNullable()` не возвращали корректный результат. [#14591](https://github.com/ClickHouse/ClickHouse/pull/14591) ([myrrc](https://github.com/myrrc)).
- Очищается директория с данными после исключений Zookeeper во время выполнения CreateQuery для движка StorageReplicatedMergeTree. [#14563](https://github.com/ClickHouse/ClickHouse/pull/14563) ([Bharat Nallan](https://github.com/bharatnc)).
- Исправлены редкие сегфолты в функциях с комбинатором -Resample, которые могли возникать из‑за переполнения при очень больших параметрах. [#14562](https://github.com/ClickHouse/ClickHouse/pull/14562) ([Anton Popov](https://github.com/CurtizJ)).

#### Улучшение {#improvement-11}

- Ускорен процесс остановки сервера, если выполняются запросы к S3. [#14858](https://github.com/ClickHouse/ClickHouse/pull/14858) ([Pavel Kovalenко](https://github.com/Jokser)).
- Разрешено использовать многотомную конфигурацию хранилища в движке Distributed. [#14839](https://github.com/ClickHouse/ClickHouse/pull/14839) ([Pavel Kovalenko](https://github.com/Jokser)).
- Ускорен процесс остановки сервера, если выполняются запросы к S3. [#14496](https://github.com/ClickHouse/ClickHouse/pull/14496) ([Pavel Kovalenко](https://github.com/Jokser)).
- Добавлена поддержка пользовательских кодеков в компактных частях. [#12183](https://github.com/ClickHouse/ClickHouse/pull/12183) ([Anton Popov](https://github.com/CurtizJ)).

### Релиз ClickHouse v20.8.2.3-stable, 2020-09-08 {#clickhouse-release-v20823-stable-2020-09-08}

#### Обратная несовместимая смена поведения {#backward-incompatible-change-4}


- Теперь запрос `OPTIMIZE FINAL` не пересчитывает TTL для частей, добавленных до создания TTL. Используйте `ALTER TABLE ... MATERIALIZE TTL` один раз для их вычисления, после чего `OPTIMIZE FINAL` будет правильно обрабатывать TTL. Это поведение никогда не работало для реплицируемых таблиц. [#14220](https://github.com/ClickHouse/ClickHouse/pull/14220) ([alesapin](https://github.com/alesapin)).
- Расширена настройка `parallel_distributed_insert_select` с добавлением возможности выполнения `INSERT` в локальную таблицу. Тип настройки изменён с `Bool` на `UInt64`, поэтому значения `false` и `true` больше не поддерживаются. Если эти значения присутствуют в конфигурации сервера, сервер не запустится. Замените их на `0` и `1` соответственно. [#14060](https://github.com/ClickHouse/ClickHouse/pull/14060) ([Azat Khuzhin](https://github.com/azat)).
- Удалена поддержка формата ввода/вывода `ODBCDriver`. Это устаревший формат, который ранее использовался для взаимодействия с ODBC-драйвером ClickHouse и давно заменён форматом `ODBCDriver2`. Решает [#13629](https://github.com/ClickHouse/ClickHouse/issues/13629). [#13847](https://github.com/ClickHouse/ClickHouse/pull/13847) ([hexiaoting](https://github.com/hexiaoting)).
- При обновлении с версий старше 20.5, если выполняется последовательное обновление и в кластере присутствуют как версии 20.5 или новее, так и версии младше 20.5, перезапуск узлов ClickHouse со старыми версиями при наличии более новых версий может привести к ошибкам `Part ... intersects previous part`. Чтобы предотвратить эту ошибку, сначала установите новые пакеты clickhouse-server на всех узлах кластера, а затем выполните перезапуск (таким образом, при перезапуске clickhouse-server запустится с новой версией).

#### Новые возможности {#new-feature-4}


- Добавлена возможность указания кодека сжатия `Default` для столбцов, соответствующих настройкам из `config.xml`. Реализует: [#9074](https://github.com/ClickHouse/ClickHouse/issues/9074). [#14049](https://github.com/ClickHouse/ClickHouse/pull/14049) ([alesapin](https://github.com/alesapin)).
- Добавлена поддержка аутентификации Kerberos в Kafka с использованием библиотек `krb5` и `cyrus-sasl`. [#12771](https://github.com/ClickHouse/ClickHouse/pull/12771) ([Ilya Golshtein](https://github.com/ilejn)).
- Добавлена функция `normalizeQuery`, которая заменяет литералы, последовательности литералов и сложные псевдонимы на заполнители. Добавлена функция `normalizedQueryHash`, которая возвращает идентичные 64-битные хеш-значения для похожих запросов. Это помогает анализировать журнал запросов. Закрывает [#11271](https://github.com/ClickHouse/ClickHouse/issues/11271). [#13816](https://github.com/ClickHouse/ClickHouse/pull/13816) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлена таблица `time_zones`. [#13880](https://github.com/ClickHouse/ClickHouse/pull/13880) ([Bharat Nallan](https://github.com/bharatnc)).
- Добавлена функция `defaultValueOfTypeName`, которая возвращает значение по умолчанию для указанного типа. [#13877](https://github.com/ClickHouse/ClickHouse/pull/13877) ([hcz](https://github.com/hczhcz)).
- Добавлена функция `countDigits(x)`, которая подсчитывает количество десятичных цифр в целочисленном или десятичном столбце. Добавлена функция `isDecimalOverflow(d, [p])`, которая проверяет, выходит ли значение в столбце Decimal за пределы его (или указанной) точности. [#14151](https://github.com/ClickHouse/ClickHouse/pull/14151) ([Artem Zuikov](https://github.com/4ertus2)).
- Добавлены реализации `quantileExactLow` и `quantileExactHigh` с соответствующими псевдонимами `medianExactLow` и `medianExactHigh`. [#13818](https://github.com/ClickHouse/ClickHouse/pull/13818) ([Bharat Nallan](https://github.com/bharatnc)).
- Добавлена функция `date_trunc`, которая усекает значение даты/времени до указанной части даты/времени. [#13888](https://github.com/ClickHouse/ClickHouse/pull/13888) ([Vladimir Golovchenko](https://github.com/vladimir-golovchenko)).
- Добавлена новая необязательная секция `<user_directories>` в основной конфигурационный файл. [#13425](https://github.com/ClickHouse/ClickHouse/pull/13425) ([Vitaly Baranov](https://github.com/vitlibar)).
- Добавлена инструкция `ALTER SAMPLE BY`, которая позволяет изменять условие сэмплирования таблицы. [#13280](https://github.com/ClickHouse/ClickHouse/pull/13280) ([Amos Bird](https://github.com/amosbird)).
- Функция `position` теперь поддерживает необязательный аргумент `start_pos`. [#13237](https://github.com/ClickHouse/ClickHouse/pull/13237) ([vdimir](https://github.com/vdimir)).

#### Исправление ошибок {#bug-fix-23}


* Исправлено видимое перекрытие выводимых данных индикатором прогресса в клиенте в интерактивном режиме. Это исправляет [#12562](https://github.com/ClickHouse/ClickHouse/issues/12562), [#13369](https://github.com/ClickHouse/ClickHouse/issues/13369), [#13584](https://github.com/ClickHouse/ClickHouse/issues/13584) и [#12964](https://github.com/ClickHouse/ClickHouse/issues/12964). [#13691](https://github.com/ClickHouse/ClickHouse/pull/13691) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен некорректный порядок сортировки столбца `LowCardinality` при сортировке по нескольким столбцам. Это исправляет [#13958](https://github.com/ClickHouse/ClickHouse/issues/13958). [#14223](https://github.com/ClickHouse/ClickHouse/pull/14223) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлена проверка на переполнение размера массива в агрегатной функции `topK`. Без этой проверки пользователь может отправить запрос с тщательно подобранными параметрами, который приведёт к сбою сервера. Это закрывает [#14452](https://github.com/ClickHouse/ClickHouse/issues/14452). [#14467](https://github.com/ClickHouse/ClickHouse/pull/14467) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка, которая могла приводить к некорректному распределению слияний, если в таблице есть партиции с одной частью. [#14444](https://github.com/ClickHouse/ClickHouse/pull/14444) ([alesapin](https://github.com/alesapin)).
* Останавливать выполнение запроса, если исключение произошло в самом `PipelineExecutor`. Это может предотвратить редкие зависания запроса. Продолжение задачи [#14334](https://github.com/ClickHouse/ClickHouse/issues/14334). [#14402](https://github.com/ClickHouse/ClickHouse/pull/14402) [#14334](https://github.com/ClickHouse/ClickHouse/pull/14334) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено падение при выполнении запроса `ALTER` для таблицы, созданной с помощью `AS table_function`. Исправляет [#14212](https://github.com/ClickHouse/ClickHouse/issues/14212). [#14326](https://github.com/ClickHouse/ClickHouse/pull/14326) ([alesapin](https://github.com/alesapin)).
* Исправлено исключение при выполнении запроса `ALTER LIVE VIEW` с командой `REFRESH`. `LIVE VIEW` — экспериментальная функция. [#14320](https://github.com/ClickHouse/ClickHouse/pull/14320) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлена продолжительность жизни QueryPlan (для EXPLAIN PIPELINE graph=1) для запросов с вложенным интерпретатором. [#14315](https://github.com/ClickHouse/ClickHouse/pull/14315) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено падение `clickhouse-odbc-bridge` (segfault) при получении схемы из некоторых внешних источников. Этот PR закрывает [#13861](https://github.com/ClickHouse/ClickHouse/issues/13861). [#14267](https://github.com/ClickHouse/ClickHouse/pull/14267) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено падение при поиске включения меток, внесённое изменением [#12277](https://github.com/ClickHouse/ClickHouse/pull/12277). [#14225](https://github.com/ClickHouse/ClickHouse/pull/14225) ([Amos Bird](https://github.com/amosbird)).
* Исправлено создание таблиц с именованными кортежами. Это устраняет [#13027](https://github.com/ClickHouse/ClickHouse/issues/13027). [#14143](https://github.com/ClickHouse/ClickHouse/pull/14143) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено форматирование минимальных отрицательных десятичных чисел. Это устраняет [#14111](https://github.com/ClickHouse/ClickHouse/issues/14111). [#14119](https://github.com/ClickHouse/ClickHouse/pull/14119) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Исправлена метрика `DistributedFilesToInsert` (обнулялась, когда этого не должно было происходить). [#14095](https://github.com/ClickHouse/ClickHouse/pull/14095) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа `pointInPolygon` с константным двумерным массивом, используемым в качестве полигона. [#14079](https://github.com/ClickHouse/ClickHouse/pull/14079) ([Alexey Ilyukhov](https://github.com/livace)).
* Исправлена некорректная точка монтирования в дополнительной информации для `Poco::Exception: no space left on device`. [#14050](https://github.com/ClickHouse/ClickHouse/pull/14050) ([tavplubix](https://github.com/tavplubix)).
* Исправлена работа оператора GRANT ALL при выполнении не на глобальном уровне. [#13987](https://github.com/ClickHouse/ClickHouse/pull/13987) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен парсер, чтобы запрещать `CREATE TABLE AS table function` с указанием `ENGINE`. [#13940](https://github.com/ClickHouse/ClickHouse/pull/13940) ([hcz](https://github.com/hczhcz)).
* Исправлены некорректные результаты в запросах `SELECT` с ключевым словом `DISTINCT` и подзапросами с `UNION ALL` при включённой настройке `optimize_duplicate_order_by_and_distinct`. [#13925](https://github.com/ClickHouse/ClickHouse/pull/13925) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлена потенциальная взаимоблокировка при переименовании таблицы `Distributed`. [#13922](https://github.com/ClickHouse/ClickHouse/pull/13922) ([tavplubix](https://github.com/tavplubix)).
* Исправлена некорректная сортировка столбцов типа `FixedString` при сортировке по нескольким столбцам. Исправляет [#13182](https://github.com/ClickHouse/ClickHouse/issues/13182). [#13887](https://github.com/ClickHouse/ClickHouse/pull/13887) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен потенциально неточный результат слияния `topK`/`topKWeighted` (с нестандартными параметрами). [#13817](https://github.com/ClickHouse/ClickHouse/pull/13817) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка чтения из таблицы MergeTree с индексом типа SET при сравнении с NULL. Это исправляет [#13686](https://github.com/ClickHouse/ClickHouse/issues/13686). [#13793](https://github.com/ClickHouse/ClickHouse/pull/13793) ([Amos Bird](https://github.com/amosbird)).
* Исправлен захват `arrayJoin` в лямбда-выражении (LOGICAL&#95;ERROR). [#13792](https://github.com/ClickHouse/ClickHouse/pull/13792) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена проверка переполнения шага в функции `range`. [#13790](https://github.com/ClickHouse/ClickHouse/pull/13790) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка `Directory not empty`, возникавшая при одновременном выполнении `DROP DATABASE` и `CREATE TABLE`. [#13756](https://github.com/ClickHouse/ClickHouse/pull/13756) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена проверка диапазона для функции `h3KRing`. Это исправляет проблему [#13633](https://github.com/ClickHouse/ClickHouse/issues/13633). [#13752](https://github.com/ClickHouse/ClickHouse/pull/13752) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено состояние гонки между `DETACH` и фоновыми слияниями. Части могли «воскресать» после `DETACH`. Это продолжение [#8602](https://github.com/ClickHouse/ClickHouse/issues/8602), который не устранил проблему, а лишь добавил тест, в очень редких случаях начинавший падать и тем самым демонстрировавший проблему. [#13746](https://github.com/ClickHouse/ClickHouse/pull/13746) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено логирование Settings.Names/Values при log&#95;queries&#95;min&#95;type &gt; QUERY&#95;START. [#13737](https://github.com/ClickHouse/ClickHouse/pull/13737) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен код состояния ответа эндпоинта `/replicas_status` при verbose=1. [#13722](https://github.com/ClickHouse/ClickHouse/pull/13722) ([javi santana](https://github.com/javisantana)).
* Исправлено некорректное сообщение в `clickhouse-server.init` при проверке пользователя и группы. [#13711](https://github.com/ClickHouse/ClickHouse/pull/13711) ([ylchou](https://github.com/ylchou)).
* Не выполнять оптимизацию any(arrayJoin()) → arrayJoin() при включённой настройке `optimize_move_functions_out_of_any`. [#13681](https://github.com/ClickHouse/ClickHouse/pull/13681) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен сбой в JOIN с StorageMerge и `set enable_optimize_predicate_expression=1`. [#13679](https://github.com/ClickHouse/ClickHouse/pull/13679) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлена опечатка в сообщении об ошибке о параметре `The value of 'number_of_free_entries_in_pool_to_lower_max_size_of_merge' setting`. [#13678](https://github.com/ClickHouse/ClickHouse/pull/13678) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Параллельные запросы `ALTER ... REPLACE/MOVE PARTITION ...` могли приводить к взаимной блокировке. Ошибка исправлена. [#13626](https://github.com/ClickHouse/ClickHouse/pull/13626) ([tavplubix](https://github.com/tavplubix)).
* Исправлено поведение, при котором словарь типа `cache` иногда возвращал значение по умолчанию вместо имеющегося значения из источника. [#13624](https://github.com/ClickHouse/ClickHouse/pull/13624) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлено повреждение вторичных индексов в компактных частях. Компактные части — экспериментальная функция. [#13538](https://github.com/ClickHouse/ClickHouse/pull/13538) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены преждевременные тайм-ауты `ON CLUSTER` для запросов, которые должны выполняться на одной реплике. Исправление для [#6704](https://github.com/ClickHouse/ClickHouse/issues/6704), [#7228](https://github.com/ClickHouse/ClickHouse/issues/7228), [#13361](https://github.com/ClickHouse/ClickHouse/issues/13361), [#11884](https://github.com/ClickHouse/ClickHouse/issues/11884). [#13450](https://github.com/ClickHouse/ClickHouse/pull/13450) ([alesapin](https://github.com/alesapin)).
* Исправлен некорректный код в функции `netloc`. Это устраняет проблему [#13335](https://github.com/ClickHouse/ClickHouse/issues/13335). [#13446](https://github.com/ClickHouse/ClickHouse/pull/13446) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена возможная гонка данных в `StorageMemory`. [#13416](https://github.com/ClickHouse/ClickHouse/pull/13416) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлены отсутствующие или избыточные заголовки в форматах `TSV/CSVWithNames` в HTTP-протоколе. Это исправляет [#12504](https://github.com/ClickHouse/ClickHouse/issues/12504). [#13343](https://github.com/ClickHouse/ClickHouse/pull/13343) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен разбор политик по строкам из users.xml, когда имена баз данных или таблиц содержат точки. Это исправляет [#5779](https://github.com/ClickHouse/ClickHouse/issues/5779), [#12527](https://github.com/ClickHouse/ClickHouse/issues/12527). [#13199](https://github.com/ClickHouse/ClickHouse/pull/13199) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен доступ к словарю `redis` после однократного разрыва соединения. Это могло происходить с типами компоновки словарей `cache` и `direct`. [#13082](https://github.com/ClickHouse/ClickHouse/pull/13082) ([Anton Popov](https://github.com/CurtizJ)).
* Удалена некорректная проверка авторизации при использовании ClickHouseDictionarySource для запросов к удалённым таблицам. [#12756](https://github.com/ClickHouse/ClickHouse/pull/12756) ([sundyli](https://github.com/sundy-li)).
* Корректно различать подзапросы в некоторых случаях для устранения общих подвыражений. [#8333](https://github.com/ClickHouse/ClickHouse/issues/8333). [#8367](https://github.com/ClickHouse/ClickHouse/pull/8367) ([Amos Bird](https://github.com/amosbird)).

#### Улучшение {#improvement-12}


* Запрещено использование `CODEC` для столбцов типа `ALIAS`. Исправляет [#13911](https://github.com/ClickHouse/ClickHouse/issues/13911). [#14263](https://github.com/ClickHouse/ClickHouse/pull/14263) ([Bharat Nallan](https://github.com/bharatnc)).
* При ожидании завершения обновления словаря используйте таймаут, заданный настройкой `query_wait_timeout_milliseconds`, вместо жестко зашитого значения. [#14105](https://github.com/ClickHouse/ClickHouse/pull/14105) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлена настройка `min_index_granularity_bytes`, которая защищает от случайного создания таблицы со слишком малым значением `index_granularity_bytes`. [#14139](https://github.com/ClickHouse/ClickHouse/pull/14139) ([Bharat Nallan](https://github.com/bharatnc)).
* Теперь можно получать партиции из кластеров, которые используют другой ZooKeeper: `ALTER TABLE table_name FETCH PARTITION partition_expr FROM 'zk-name:/path-in-zookeeper'`. Это полезно для передачи данных в новые кластеры. [#14155](https://github.com/ClickHouse/ClickHouse/pull/14155) ([Amos Bird](https://github.com/amosbird)).
* Незначительно повышена производительность таблицы Memory, если она была построена из огромного количества очень маленьких блоков (что маловероятно). Автор идеи: [Mark Papadakis](https://github.com/markpapadakis). Исправляет [#14043](https://github.com/ClickHouse/ClickHouse/issues/14043). [#14056](https://github.com/ClickHouse/ClickHouse/pull/14056) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Условные агрегатные функции (например, `avgIf`, `sumIf`, `maxIf`) должны возвращать `NULL` при отсутствии строк и использовать аргументы типа Nullable. [#13964](https://github.com/ClickHouse/ClickHouse/pull/13964) ([Winter Zhang](https://github.com/zhang2014)).
* Увеличен лимит в комбинаторе -Resample до 1 млн. [#13947](https://github.com/ClickHouse/ClickHouse/pull/13947) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Исправлена ошибка в формате AvroConfluent, из-за которой движок таблиц Kafka прекращал обработку сообщений при получении аномально короткого, некорректно сформированного сообщения. [#13941](https://github.com/ClickHouse/ClickHouse/pull/13941) ([Gervasio Varela](https://github.com/gervarela)).
* Исправлена некорректная обработка длинных запросов. Для корректного запроса можно было получить синтаксическую ошибку, отличную от `Max query size exceeded`. [#13928](https://github.com/ClickHouse/ClickHouse/pull/13928) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Улучшено сообщение об ошибке для значения NULL в формате `TabSeparated`. [#13906](https://github.com/ClickHouse/ClickHouse/pull/13906) ([jiang tao](https://github.com/tomjiang1987)).
* Функция `arrayCompact` будет сравнивать значения NaN побитово, если тип элементов массива — Float32/Float64. В предыдущих версиях значения NaN всегда считались неравными, если тип элементов массива — Float32/Float64, и всегда равными, если тип более сложный, например Nullable(Float64). Это закрывает [#13857](https://github.com/ClickHouse/ClickHouse/issues/13857). [#13868](https://github.com/ClickHouse/ClickHouse/pull/13868) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена гонка данных в функции `lgamma`. Эта гонка обнаруживалась только в `tsan`, никаких реальных побочных эффектов не было. [#13842](https://github.com/ClickHouse/ClickHouse/pull/13842) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Избегать слишком медленных запросов при работе с массивами как с полями. Вместо этого выбрасывать исключение. [#13753](https://github.com/ClickHouse/ClickHouse/pull/13753) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка авторизации Redis `requirepass` (для источника словаря `redis`). [#13688](https://github.com/ClickHouse/ClickHouse/pull/13688) ([Ivan Torgashov](https://github.com/it1804)).
* Добавлен инструмент дампа журнала предзаписи (Write-Ahead Log, WAL) для MergeTree. WAL — экспериментальная функциональность. [#13640](https://github.com/ClickHouse/ClickHouse/pull/13640) ([BohuTANG](https://github.com/BohuTANG)).
* В предыдущих версиях функция `lcm` могла приводить к срабатыванию проверки (assertion) в отладочной сборке при вызове с специально сформированными аргументами. Исправляет [#13368](https://github.com/ClickHouse/ClickHouse/issues/13368). [#13510](https://github.com/ClickHouse/ClickHouse/pull/13510) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Обеспечена монотонность для функций `toDate/toDateTime` в большем числе случаев. Информация о монотонности используется для анализа индексов (что позволяет использовать индекс в более сложных запросах). Теперь входные аргументы «насыщаются» более естественным образом, что обеспечивает лучшую монотонность. [#13497](https://github.com/ClickHouse/ClickHouse/pull/13497) ([Amos Bird](https://github.com/amosbird)).
* Поддержка составных идентификаторов для пользовательских настроек. Пользовательские настройки — это точка интеграции кодовой базы ClickHouse с другими кодовыми базами (без преимуществ для самого ClickHouse) [#13496](https://github.com/ClickHouse/ClickHouse/pull/13496) ([Vitaly Baranov](https://github.com/vitlibar)).
* Переносить части с DiskLocal на DiskS3 параллельно. `DiskS3` — экспериментальная возможность. [#13459](https://github.com/ClickHouse/ClickHouse/pull/13459) ([Pavel Kovalenko](https://github.com/Jokser)).
* Включено использование кусков со смешанной гранулярностью по умолчанию. [#13449](https://github.com/ClickHouse/ClickHouse/pull/13449) ([alesapin](https://github.com/alesapin)).
* Корректная проверка удалённого хоста при редиректах S3 (в целях безопасности). [#13404](https://github.com/ClickHouse/ClickHouse/pull/13404) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Добавлены счетчики `QueryTimeMicroseconds`, `SelectQueryTimeMicroseconds` и `InsertQueryTimeMicroseconds` в system.events. [#13336](https://github.com/ClickHouse/ClickHouse/pull/13336) ([ianton-ru](https://github.com/ianton-ru)).
* Исправлена отладочная проверка для `Decimal` со слишком большим отрицательным показателем степени. Исправляет [#13188](https://github.com/ClickHouse/ClickHouse/issues/13188). [#13228](https://github.com/ClickHouse/ClickHouse/pull/13228) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлен слой кэша для DiskS3 (кэширование файлов меток и индексов на локальный диск). `DiskS3` — экспериментальная функция. [#13076](https://github.com/ClickHouse/ClickHouse/pull/13076) ([Pavel Kovalenko](https://github.com/Jokser)).
* Исправлен `readline`, чтобы он теперь сохранял историю в файл. [#13600](https://github.com/ClickHouse/ClickHouse/pull/13600) ([Amos Bird](https://github.com/amosbird)).
* Создана база данных `system` с движком `Atomic` по умолчанию (подготовка к использованию движка баз данных `Atomic` по умолчанию во всех случаях). [#13680](https://github.com/ClickHouse/ClickHouse/pull/13680) ([tavplubix](https://github.com/tavplubix)).

#### Улучшение производительности {#performance-improvement-5}

- Небольшая оптимизация очень коротких запросов с `LowCardinality`. [#14129](https://github.com/ClickHouse/ClickHouse/pull/14129) ([Anton Popov](https://github.com/CurtizJ)).
- Включена параллельная вставка (INSERT) для движков таблиц `Null`, `Memory`, `Distributed` и `Buffer` при установленной настройке `max_insert_threads`. [#14120](https://github.com/ClickHouse/ClickHouse/pull/14120) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Быстрое завершение при превышении лимита `max_rows_to_read` во время сканирования кусков данных. Цель этого изменения — пропустить сканирование диапазонов для всех выбранных кусков, если очевидно, что `max_rows_to_read` уже превышен. Изменение особенно заметно для запросов с большим количеством кусков. [#13677](https://github.com/ClickHouse/ClickHouse/pull/13677) ([Roman Khavronenko](https://github.com/hagen1778)).
- Небольшое улучшение производительности агрегации по ключам UInt8/UInt16. [#13099](https://github.com/ClickHouse/ClickHouse/pull/13099) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Оптимизация функций `has()`, `indexOf()` и `countEqual()` для `Array(LowCardinality(T))` и константных правых аргументов. [#12550](https://github.com/ClickHouse/ClickHouse/pull/12550) ([myrrc](https://github.com/myrrc)).
- При выполнении тривиальных запросов `INSERT SELECT` автоматически устанавливается `max_threads` в 1 или `max_insert_threads`, а `max_block_size` — в `min_insert_block_size_rows`. Связано с [#5907](https://github.com/ClickHouse/ClickHouse/issues/5907). [#12195](https://github.com/ClickHouse/ClickHouse/pull/12195) ([flynn](https://github.com/ucasFL)).

#### Экспериментальная функциональность {#experimental-feature-3}

- ClickHouse может работать как реплика MySQL — это реализовано движком баз данных `MaterializeMySQL`. Реализует [#4006](https://github.com/ClickHouse/ClickHouse/issues/4006). [#10851](https://github.com/ClickHouse/ClickHouse/pull/10851) ([Winter Zhang](https://github.com/zhang2014)).
- Добавлены типы `Int128`, `Int256`, `UInt256` и связанные с ними функции. Расширение Decimals типом Decimal256 (точность до 76 цифр). Новые типы доступны при включенной настройке `allow_experimental_bigint_types`. Работает крайне медленно и плохо. Реализация неполная. Пожалуйста, не используйте эту функциональность. [#13097](https://github.com/ClickHouse/ClickHouse/pull/13097) ([Artem Zuikov](https://github.com/4ertus2)).

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-7}


* Добавлен скрипт `clickhouse install`, который удобен, если у вас есть только один бинарный файл. [#13528](https://github.com/ClickHouse/ClickHouse/pull/13528) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность запускать бинарный файл `clickhouse` без конфигурации. [#13515](https://github.com/ClickHouse/ClickHouse/pull/13515) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Включена проверка кода на опечатки с помощью `codespell`. [#13513](https://github.com/ClickHouse/ClickHouse/pull/13513) [#13511](https://github.com/ClickHouse/ClickHouse/pull/13511) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Включена проверка Shellcheck в CI в качестве линтера для тестов на .sh. Это закрывает [#13168](https://github.com/ClickHouse/ClickHouse/issues/13168). [#13530](https://github.com/ClickHouse/ClickHouse/pull/13530) [#13529](https://github.com/ClickHouse/ClickHouse/pull/13529) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена опция CMake, из‑за которой конфигурирование завершается с ошибкой вместо автоматической переконфигурации; по умолчанию включена. [#13687](https://github.com/ClickHouse/ClickHouse/pull/13687) ([Konstantin](https://github.com/podshumok)).
* Опубликована версия встроенного tzdata через TZDATA&#95;VERSION в system.build&#95;options. [#13648](https://github.com/ClickHouse/ClickHouse/pull/13648) ([filimonov](https://github.com/filimonov)).
* Улучшена генерация таблицы system.time&#95;zones при сборке. Закрывает [#14209](https://github.com/ClickHouse/ClickHouse/issues/14209). [#14215](https://github.com/ClickHouse/ClickHouse/pull/14215) ([filimonov](https://github.com/filimonov)).
* Собирать ClickHouse с актуальными `tzdata` из репозитория пакетов. [#13623](https://github.com/ClickHouse/ClickHouse/pull/13623) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность использовать комментарии в стиле JS в skip&#95;list.json. [#14159](https://github.com/ClickHouse/ClickHouse/pull/14159) ([alesapin](https://github.com/alesapin)).
* Убедитесь, что в коде нет фрагментов, скопированных из проектов под лицензией GPL. [#13514](https://github.com/ClickHouse/ClickHouse/pull/13514) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Docker-образы для тестов переключены на использование родительского образа test-base. [#14167](https://github.com/ClickHouse/ClickHouse/pull/14167) ([Ilya Yatsishin](https://github.com/qoega)).
* Добавлена логика повторных попыток при запуске кластера в docker-compose; увеличено значение COMPOSE&#95;HTTP&#95;TIMEOUT. [#14112](https://github.com/ClickHouse/ClickHouse/pull/14112) ([vzakaznikov](https://github.com/vzakaznikov)).
* Включён `system.text_log` в стресс-тесте для поиска большего числа багов. [#13855](https://github.com/ClickHouse/ClickHouse/pull/13855) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Модуль Testflows LDAP: добавление отсутствующих сертификатов и dhparam.pem для openldap4. [#13780](https://github.com/ClickHouse/ClickHouse/pull/13780) ([vzakaznikov](https://github.com/vzakaznikov)).
* ZooKeeper не может надёжно работать в модульных тестах в CI-инфраструктуре. Использовать модульные тесты для проверки взаимодействия с ZooKeeper через реальный ZooKeeper — изначально плохая идея (модульные тесты не предназначены для проверки сложных распределённых систем). Для этой цели мы уже используем интеграционные тесты, и они лучше подходят. [#13745](https://github.com/ClickHouse/ClickHouse/pull/13745) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлен Docker-образ для проверки стиля. Добавлена проверка стиля, которая гарантирует, что все файлы Docker и Docker Compose находятся в директории `docker`. [#13724](https://github.com/ClickHouse/ClickHouse/pull/13724) ([Ilya Yatsishin](https://github.com/qoega)).
* Исправлена сборка cassandra на macOS. [#13708](https://github.com/ClickHouse/ClickHouse/pull/13708) ([Ilya Yatsishin](https://github.com/qoega)).
* Исправлена ошибка линковки при сборке с разделяемыми библиотеками. [#13700](https://github.com/ClickHouse/ClickHouse/pull/13700) ([Amos Bird](https://github.com/amosbird)).
* Обновление набора механизмов аутентификации пользователей LDAP для проверки работы с RBAC. [#13656](https://github.com/ClickHouse/ClickHouse/pull/13656) ([vzakaznikov](https://github.com/vzakaznikov)).
* Удалён флаг `-DENABLE_CURL_CLIENT` для `contrib/aws`. [#13628](https://github.com/ClickHouse/ClickHouse/pull/13628) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Увеличены тайм-ауты health-check для узлов ClickHouse и добавлена поддержка выгрузки логов docker-compose при обнаружении проблемных контейнеров. [#13612](https://github.com/ClickHouse/ClickHouse/pull/13612) ([vzakaznikov](https://github.com/vzakaznikov)).
* Убедиться, что [#10977](https://github.com/ClickHouse/ClickHouse/issues/10977) более не актуален. [#13539](https://github.com/ClickHouse/ClickHouse/pull/13539) ([Amos Bird](https://github.com/amosbird)).
* Пропускать PR от robot-clickhouse. [#13489](https://github.com/ClickHouse/ClickHouse/pull/13489) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Dockerfile для интеграционных тестов перемещены в директорию `docker/test`. Файлы docker&#95;compose доступны в docker-контейнере `runner`. Docker-образы теперь собираются в CI, а не в интеграционных тестах. [#13448](https://github.com/ClickHouse/ClickHouse/pull/13448) ([Ilya Yatsishin](https://github.com/qoega)).





## Релиз ClickHouse 20.7 {#clickhouse-release-207}

### Релиз ClickHouse v20.7.2.30-stable, 2020-08-31 {#clickhouse-release-v207230-stable-2020-08-31}

#### Обратно несовместимые изменения {#backward-incompatible-change-5}

- Функция `modulo` (оператор `%`) с хотя бы одним аргументом с плавающей точкой теперь вычисляет остаток от деления непосредственно на числах с плавающей точкой без преобразования обоих аргументов в целые числа. Это делает поведение совместимым с большинством СУБД. Также применимо к типам данных Date и DateTime. Добавлен псевдоним `mod`. Закрывает [#7323](https://github.com/ClickHouse/ClickHouse/issues/7323). [#12585](https://github.com/ClickHouse/ClickHouse/pull/12585) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Упразднен специальный вывод нулевых значений Date/DateTime в виде `0000-00-00` и `0000-00-00 00:00:00`. [#12442](https://github.com/ClickHouse/ClickHouse/pull/12442) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Функция `groupArrayMoving*` не работала для распределенных запросов. Её результат вычислялся с неправильным типом данных (без повышения до наибольшего типа). Функция `groupArrayMovingAvg` возвращала целое число, что было несовместимо с функцией `avg`. Исправляет [#12568](https://github.com/ClickHouse/ClickHouse/issues/12568). [#12622](https://github.com/ClickHouse/ClickHouse/pull/12622) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлена проверка корректности настроек MergeTree. Если настройки некорректны, сервер откажется запускаться или создавать таблицу, выводя подробное объяснение пользователю. [#13153](https://github.com/ClickHouse/ClickHouse/pull/13153) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлена защита от случаев, когда пользователь может установить `background_pool_size` в значение меньше, чем `number_of_free_entries_in_pool_to_execute_mutation` или `number_of_free_entries_in_pool_to_lower_max_size_of_merge`. В таких случаях операции ALTER не будут работать или максимальный размер слияния будет слишком ограничен. Будет выброшено исключение с объяснением необходимых действий. Закрывает [#10897](https://github.com/ClickHouse/ClickHouse/issues/10897). [#12728](https://github.com/ClickHouse/ClickHouse/pull/12728) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- При обновлении с версий старше 20.5, если выполняется последовательное обновление и кластер содержит как версии 20.5 или новее, так и версии младше 20.5, перезапуск узлов ClickHouse со старыми версиями в присутствии более новых версий может привести к ошибкам `Part ... intersects previous part`. Чтобы предотвратить эту ошибку, сначала установите более новые пакеты clickhouse-server на всех узлах кластера, а затем выполните перезапуски (таким образом, при перезапуске clickhouse-server будет запущена новая версия).

#### Новые возможности {#new-feature-5}


- Тип словаря Polygon, обеспечивающий эффективный поиск методом "обратного геокодирования" — определение региона по координатам в словаре из множества полигонов (карта мира). Использует тщательно оптимизированный алгоритм с рекурсивными сетками для минимизации нагрузки на CPU и потребления памяти. [#9278](https://github.com/ClickHouse/ClickHouse/pull/9278) ([achulkov2](https://github.com/achulkov2)).
- Добавлена поддержка LDAP-аутентификации для предварительно настроенных пользователей (метод "Simple Bind"). [#11234](https://github.com/ClickHouse/ClickHouse/pull/11234) ([Denis Glazachev](https://github.com/traceon)).
- Введена настройка `alter_partition_verbose_result`, которая выводит информацию о затронутых частях для некоторых типов запросов `ALTER TABLE ... PARTITION ...` (в настоящее время `ATTACH` и `FREEZE`). Закрывает [#8076](https://github.com/ClickHouse/ClickHouse/issues/8076). [#13017](https://github.com/ClickHouse/ClickHouse/pull/13017) ([alesapin](https://github.com/alesapin)).
- Добавлена функция `bayesAB` для байесовского A/B-тестирования. [#12327](https://github.com/ClickHouse/ClickHouse/pull/12327) ([achimbab](https://github.com/achimbab)).
- Добавлена таблица `system.crash_log`, в которую собираются трассировки стека для фатальных ошибок. Эта таблица должна быть пустой. [#12316](https://github.com/ClickHouse/ClickHouse/pull/12316) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлены HTTP-заголовки `X-ClickHouse-Database` и `X-ClickHouse-Format`, которые могут использоваться для установки базы данных по умолчанию и формата вывода. [#12981](https://github.com/ClickHouse/ClickHouse/pull/12981) ([hcz](https://github.com/hczhcz)).
- Добавлена поддержка функций `minMap` и `maxMap` для `SimpleAggregateFunction`. [#12662](https://github.com/ClickHouse/ClickHouse/pull/12662) ([Ildus Kurbangaliev](https://github.com/ildus)).
- Добавлена настройка `allow_non_metadata_alters`, которая ограничивает выполнение запросов `ALTER`, изменяющих данные на диске. По умолчанию отключена. Закрывает [#11547](https://github.com/ClickHouse/ClickHouse/issues/11547). [#12635](https://github.com/ClickHouse/ClickHouse/pull/12635) ([alesapin](https://github.com/alesapin)).
- Добавлена функция `formatRow` для преобразования произвольных выражений в строку с использованием заданного формата. Полезна для манипуляций с выводом SQL и весьма универсальна в сочетании с функцией `columns`. [#12574](https://github.com/ClickHouse/ClickHouse/pull/12574) ([Amos Bird](https://github.com/amosbird)).
- Добавлена функция `FROM_UNIXTIME` для совместимости с MySQL, связано с [12149](https://github.com/ClickHouse/ClickHouse/issues/12149). [#12484](https://github.com/ClickHouse/ClickHouse/pull/12484) ([flynn](https://github.com/ucasFL)).
- Разрешено использование типов Nullable в качестве ключей в таблицах MergeTree, если включена настройка таблицы `allow_nullable_key`. Закрывает [#5319](https://github.com/ClickHouse/ClickHouse/issues/5319). [#12433](https://github.com/ClickHouse/ClickHouse/pull/12433) ([Amos Bird](https://github.com/amosbird)).
- Интеграция с [COS](https://intl.cloud.tencent.com/product/cos). [#12386](https://github.com/ClickHouse/ClickHouse/pull/12386) ([fastio](https://github.com/fastio)).
- Добавлены функции `mapAdd` и `mapSubtract` для сложения/вычитания значений с ключами. [#11735](https://github.com/ClickHouse/ClickHouse/pull/11735) ([Ildus Kurbangaliev](https://github.com/ildus)).

#### Исправление ошибок {#bug-fix-24}


* Исправлены преждевременные таймауты `ON CLUSTER` для запросов, которые должны выполняться на одной реплике. Исправляет [#6704](https://github.com/ClickHouse/ClickHouse/issues/6704), [#7228](https://github.com/ClickHouse/ClickHouse/issues/7228), [#13361](https://github.com/ClickHouse/ClickHouse/issues/13361), [#11884](https://github.com/ClickHouse/ClickHouse/issues/11884). [#13450](https://github.com/ClickHouse/ClickHouse/pull/13450) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка, приводившая к сбою при поиске включения меток, появившаяся в [#12277](https://github.com/ClickHouse/ClickHouse/pull/12277). [#14225](https://github.com/ClickHouse/ClickHouse/pull/14225) ([Amos Bird](https://github.com/amosbird)).
* Исправлена гонка во внешних словарях с типом `cache`, которая могла приводить к сбою сервера. [#12566](https://github.com/ClickHouse/ClickHouse/pull/12566) ([alesapin](https://github.com/alesapin)).
* Исправлено заметное искажение выводимых данных индикатором прогресса в клиенте в интерактивном режиме. Это исправляет [#12562](https://github.com/ClickHouse/ClickHouse/issues/12562), [#13369](https://github.com/ClickHouse/ClickHouse/issues/13369), [#13584](https://github.com/ClickHouse/ClickHouse/issues/13584) и [#12964](https://github.com/ClickHouse/ClickHouse/issues/12964). [#13691](https://github.com/ClickHouse/ClickHouse/pull/13691) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен некорректный порядок сортировки для столбцов типа `LowCardinality` при использовании ORDER BY по нескольким столбцам. Это исправляет проблему [#13958](https://github.com/ClickHouse/ClickHouse/issues/13958). [#14223](https://github.com/ClickHouse/ClickHouse/pull/14223) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Удалён жёстко заданный тайм-аут, который ошибочно имел приоритет над настройкой `query_wait_timeout_milliseconds` для cache-dictionary. [#14105](https://github.com/ClickHouse/ClickHouse/pull/14105) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена неверная точка монтирования в дополнительной информации для `Poco::Exception: no space left on device`. [#14050](https://github.com/ClickHouse/ClickHouse/pull/14050) ([tavplubix](https://github.com/tavplubix)).
* Исправлена некорректная оптимизация запросов `SELECT` с ключевым словом `DISTINCT`, когда подзапросы также содержат `DISTINCT`, при включённой настройке `optimize_duplicate_order_by_and_distinct`. [#13925](https://github.com/ClickHouse/ClickHouse/pull/13925) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлена потенциальная взаимная блокировка при переименовании таблицы `Distributed`. [#13922](https://github.com/ClickHouse/ClickHouse/pull/13922) ([tavplubix](https://github.com/tavplubix)).
* Исправлена некорректная сортировка для столбцов типа `FixedString` при использовании ORDER BY по нескольким столбцам. Исправление для [#13182](https://github.com/ClickHouse/ClickHouse/issues/13182). [#13887](https://github.com/ClickHouse/ClickHouse/pull/13887) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена потенциально заниженная точность агрегаций `topK`/`topKWeighted` (с нестандартными параметрами). [#13817](https://github.com/ClickHouse/ClickHouse/pull/13817) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено чтение из таблицы MergeTree с индексом типа SET при сравнении с NULL. Это исправляет [#13686](https://github.com/ClickHouse/ClickHouse/issues/13686). [#13793](https://github.com/ClickHouse/ClickHouse/pull/13793) ([Amos Bird](https://github.com/amosbird)).
* Исправлено переполнение параметра шага в функции `range()`. [#13790](https://github.com/ClickHouse/ClickHouse/pull/13790) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка `Directory not empty` при параллельном выполнении `DROP DATABASE` и `CREATE TABLE`. [#13756](https://github.com/ClickHouse/ClickHouse/pull/13756) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена проверка допустимого диапазона для функции `h3KRing`. Это исправляет [#13633](https://github.com/ClickHouse/ClickHouse/issues/13633). [#13752](https://github.com/ClickHouse/ClickHouse/pull/13752) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена гонка между `DETACH` и фоновыми слияниями. Части могли «возрождаться» после `DETACH`. Это продолжение [#8602](https://github.com/ClickHouse/ClickHouse/issues/8602), который не устранил проблему, а добавил тест, начинавший падать в очень редких случаях и демонстрирующий проблему. [#13746](https://github.com/ClickHouse/ClickHouse/pull/13746) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено логирование Settings.Names/Values, когда `log_queries_min_type` больше `QUERY_START`. [#13737](https://github.com/ClickHouse/ClickHouse/pull/13737) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено неверное сообщение в `clickhouse-server.init` при проверке пользователя и группы. [#13711](https://github.com/ClickHouse/ClickHouse/pull/13711) ([ylchou](https://github.com/ylchou)).
* Не оптимизировать `any(arrayJoin())` в `arrayJoin()` при включённой настройке `optimize_move_functions_out_of_any`. [#13681](https://github.com/ClickHouse/ClickHouse/pull/13681) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена возможная взаимная блокировка при одновременном выполнении запросов `ALTER ... REPLACE/MOVE PARTITION ...`. [#13626](https://github.com/ClickHouse/ClickHouse/pull/13626) ([tavplubix](https://github.com/tavplubix)).
* Исправлено поведение, из-за которого словарь типа `cache` иногда возвращал значение по умолчанию вместо имеющегося значения из источника. [#13624](https://github.com/ClickHouse/ClickHouse/pull/13624) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлено повреждение вторичных индексов в компактных частях (компактные части — экспериментальная функция). [#13538](https://github.com/ClickHouse/ClickHouse/pull/13538) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен некорректный код в функции `netloc`. Это устраняет [#13335](https://github.com/ClickHouse/ClickHouse/issues/13335). [#13446](https://github.com/ClickHouse/ClickHouse/pull/13446) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка в функции `parseDateTimeBestEffort`, возникавшая при передаче Unix‑timestamp в качестве аргумента. Это исправляет [#13362](https://github.com/ClickHouse/ClickHouse/issues/13362). [#13441](https://github.com/ClickHouse/ClickHouse/pull/13441) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен неверный возвращаемый тип при сравнении кортежей с элементами `NULL`. Исправление для [#12461](https://github.com/ClickHouse/ClickHouse/issues/12461). [#13420](https://github.com/ClickHouse/ClickHouse/pull/13420) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена некорректная оптимизация, приводившая к ошибке `aggregate function any(x) is found inside another aggregate function in query` при использовании `SET optimize_move_functions_out_of_any = 1` и псевдонимов внутри `any()`. [#13419](https://github.com/ClickHouse/ClickHouse/pull/13419) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлена возможная гонка данных в `StorageMemory`. [#13416](https://github.com/ClickHouse/ClickHouse/pull/13416) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ситуация с пустым выводом для форматов `Arrow` и `Parquet` в случае, когда запрос возвращает ноль строк. Это сделано, потому что пустой вывод недопустим для этих форматов. [#13399](https://github.com/ClickHouse/ClickHouse/pull/13399) ([hcz](https://github.com/hczhcz)).
* Исправлены запросы SELECT с константными столбцами и префиксом первичного ключа в предложении `ORDER BY`. [#13396](https://github.com/ClickHouse/ClickHouse/pull/13396) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен `PrettyCompactMonoBlock` для clickhouse-local. Исправлена работа extremes/totals с `PrettyCompactMonoBlock`. Исправляет [#7746](https://github.com/ClickHouse/ClickHouse/issues/7746). [#13394](https://github.com/ClickHouse/ClickHouse/pull/13394) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена взаимная блокировка в `system.text_log`. [#12452](https://github.com/ClickHouse/ClickHouse/pull/12452) ([alexey-milovidov](https://github.com/alexey-milovidov)). Это часть [#12339](https://github.com/ClickHouse/ClickHouse/issues/12339). Это исправляет [#12325](https://github.com/ClickHouse/ClickHouse/issues/12325). [#13386](https://github.com/ClickHouse/ClickHouse/pull/13386) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлен `File(TSVWithNames*)` (заголовок записывался несколько раз), исправлен `clickhouse-local --format CSVWithNames*` (отсутствовал заголовок, сломалось после [#12197](https://github.com/ClickHouse/ClickHouse/issues/12197)), исправлен `clickhouse-local --format CSVWithNames*` с нулём строк (отсутствовал заголовок). [#13343](https://github.com/ClickHouse/ClickHouse/pull/13343) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка сегментации при десериализации пустого состояния функцией `groupArrayMovingSum`. Исправление для [#13339](https://github.com/ClickHouse/ClickHouse/issues/13339). [#13341](https://github.com/ClickHouse/ClickHouse/pull/13341) ([alesapin](https://github.com/alesapin)).
* Вызывать ошибку при использовании функции `arrayJoin()` в секции `JOIN ON`. [#13330](https://github.com/ClickHouse/ClickHouse/pull/13330) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлена ошибка, вызывавшая сбой в `LEFT ASOF JOIN` при `join_use_nulls=1`. [#13291](https://github.com/ClickHouse/ClickHouse/pull/13291) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлена возможная ошибка `Totals having transform was already added to pipeline` при выполнении запроса с отложенной реплики. [#13290](https://github.com/ClickHouse/ClickHouse/pull/13290) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Сервер мог аварийно завершать работу, если пользователь передавал специально сформированные аргументы функции `h3ToChildren`. Это исправляет [#13275](https://github.com/ClickHouse/ClickHouse/issues/13275). [#13277](https://github.com/ClickHouse/ClickHouse/pull/13277) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены потенциально низкая производительность и слегка некорректные результаты для агрегатных функций `uniqExact`, `topK`, `sumDistinct` и подобных, вызываемых для типов Float со значениями `NaN`. Это также вызывало `assert` в debug-сборке. Исправляет [#12491](https://github.com/ClickHouse/ClickHouse/issues/12491). [#13254](https://github.com/ClickHouse/ClickHouse/pull/13254) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено падение assert в `KeyCondition`, когда первичный ключ содержит выражение с монотонной функцией, а запрос содержит сравнение с константой другого типа. Это исправляет [#12465](https://github.com/ClickHouse/ClickHouse/issues/12465). [#13251](https://github.com/ClickHouse/ClickHouse/pull/13251) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Возвращать переданное число для значений с установленным старшим битом в функции roundUpToPowerOfTwoOrZero(). Это предотвращает потенциальные ошибки в случае переполнения размеров массивов. [#13234](https://github.com/ClickHouse/ClickHouse/pull/13234) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена функция if с nullable constexpr в качестве cond, когда оно не равно литералу NULL. Исправлено [#12463](https://github.com/ClickHouse/ClickHouse/issues/12463). [#13226](https://github.com/ClickHouse/ClickHouse/pull/13226) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена проверка `assert` в функции `arrayElement` в случае, когда элементы массива имеют тип Nullable и индекс массива также имеет тип Nullable. Это исправляет [#12172](https://github.com/ClickHouse/ClickHouse/issues/12172). [#13224](https://github.com/ClickHouse/ClickHouse/pull/13224) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены функции преобразования `DateTime64` с постоянным аргументом. [#13205](https://github.com/ClickHouse/ClickHouse/pull/13205) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен разбор политик на строки из users.xml, когда имена баз данных или таблиц содержат точки. Это исправляет [#5779](https://github.com/ClickHouse/ClickHouse/issues/5779), [#12527](https://github.com/ClickHouse/ClickHouse/issues/12527). [#13199](https://github.com/ClickHouse/ClickHouse/pull/13199) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен доступ к словарю `redis` после однократного разрыва соединения. Это могло происходить с размещениями словаря `cache` и `direct`. [#13082](https://github.com/ClickHouse/ClickHouse/pull/13082) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен некорректный анализ индекса с функциями. Это могло приводить к пропуску некоторых кусков данных при чтении из таблиц `MergeTree`. Исправляет [#13060](https://github.com/ClickHouse/ClickHouse/issues/13060). Исправляет [#12406](https://github.com/ClickHouse/ClickHouse/issues/12406). [#13081](https://github.com/ClickHouse/ClickHouse/pull/13081) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка `Cannot convert column because it is constant but values of constants are different in source and result` для удалённых запросов, которые используют функции, детерминированные в пределах одного запроса, но недетерминированные между разными запросами, такие как `now()`, `now64()`, `randConstant()`. Исправление [#11327](https://github.com/ClickHouse/ClickHouse/issues/11327). [#13075](https://github.com/ClickHouse/ClickHouse/pull/13075) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен возможный сбой для запросов с `ORDER BY` по кортежу и небольшим `LIMIT`. Исправляет [#12623](https://github.com/ClickHouse/ClickHouse/issues/12623). [#13009](https://github.com/ClickHouse/ClickHouse/pull/13009) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка `Block structure mismatch` для запросов с `UNION` и `JOIN`. Исправляет [#12602](https://github.com/ClickHouse/ClickHouse/issues/12602). [#12989](https://github.com/ClickHouse/ClickHouse/pull/12989) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена логика `merge_with_ttl_timeout`, которая работала некорректно, когда истечение срока действия затрагивало более одного раздела в пределах одного временного интервала. (Автор @excitoon). [#12982](https://github.com/ClickHouse/ClickHouse/pull/12982) ([Alexander Kazakov](https://github.com/Akazz)).
* Исправлено дублирование столбцов для range hashed dictionary, созданного DDL-запросом. Это исправление закрывает [#10605](https://github.com/ClickHouse/ClickHouse/issues/10605). [#12857](https://github.com/ClickHouse/ClickHouse/pull/12857) ([alesapin](https://github.com/alesapin)).
* Исправлено избыточное ограничение числа потоков для выборок с локальной реплики. [#12840](https://github.com/ClickHouse/ClickHouse/pull/12840) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена редкая ошибка, возникающая при одновременном выполнении запросов `ALTER DELETE` и `ALTER MODIFY COLUMN` в рамках одной мутации. Ошибка приводила к некорректному количеству строк в `count.txt` и, как следствие, к некорректным данным в парте. Также исправлена небольшая ошибка при одновременном выполнении `ALTER RENAME COLUMN` и `ALTER ADD COLUMN`. [#12760](https://github.com/ClickHouse/ClickHouse/pull/12760) ([alesapin](https://github.com/alesapin)).
* Исправлена проблема с использованием неверных учетных данных при использовании источника словаря `clickhouse` для запросов к удалённым таблицам. [#12756](https://github.com/ClickHouse/ClickHouse/pull/12756) ([sundyli](https://github.com/sundy-li)).
* Исправлена работа `CAST(Nullable(String), Enum())`. [#12745](https://github.com/ClickHouse/ClickHouse/pull/12745) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена производительность при работе с большими кортежами (`tuple`), которые в секции `IN` интерпретируются как функции. Это относится к случаю, когда пользователь по какой‑то непонятной причине пишет `WHERE x IN tuple(1, 2, ...)` вместо `WHERE x IN (1, 2, ...)`. [#12700](https://github.com/ClickHouse/ClickHouse/pull/12700) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено отслеживание использования памяти для `input_format_parallel_parsing` (за счёт присоединения потока к группе). [#12672](https://github.com/ClickHouse/ClickHouse/pull/12672) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена некорректная оптимизация `optimize_move_functions_out_of_any=1` в случае `any(func(<lambda>))`. [#12664](https://github.com/ClickHouse/ClickHouse/pull/12664) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлено: [#10572](https://github.com/ClickHouse/ClickHouse/issues/10572) — исправлен индекс фильтра Блума с `const`-выражением. [#12659](https://github.com/ClickHouse/ClickHouse/pull/12659) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлено возникновение SIGSEGV в StorageKafka при недоступности брокера (и не только). [#12658](https://github.com/ClickHouse/ClickHouse/pull/12658) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка функции `if` с аргументами типа `Array(UUID)`. Это исправляет проблему [#11066](https://github.com/ClickHouse/ClickHouse/issues/11066). [#12648](https://github.com/ClickHouse/ClickHouse/pull/12648) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* CREATE USER IF NOT EXISTS теперь не выбрасывает исключение, если пользователь уже существует. Это исправляет [#12507](https://github.com/ClickHouse/ClickHouse/issues/12507). [#12646](https://github.com/ClickHouse/ClickHouse/pull/12646) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исключение `There is no supertype...` могло возникать во время `ALTER ... UPDATE` в неожиданных случаях (например, при вычитании из столбца UInt64). Это исправляет [#7306](https://github.com/ClickHouse/ClickHouse/issues/7306). Это исправляет [#4165](https://github.com/ClickHouse/ClickHouse/issues/4165). [#12633](https://github.com/ClickHouse/ClickHouse/pull/12633) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена возможная ошибка `Pipeline stuck` для запросов с внешней сортировкой. Исправляет [#12617](https://github.com/ClickHouse/ClickHouse/issues/12617). [#12618](https://github.com/ClickHouse/ClickHouse/pull/12618) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка `Output of TreeExecutor is not sorted` для `OPTIMIZE DEDUPLICATE`. Исправление для [#11572](https://github.com/ClickHouse/ClickHouse/issues/11572). [#12613](https://github.com/ClickHouse/ClickHouse/pull/12613) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена проблема, из‑за которой алиас результата функции `any` мог теряться во время оптимизации запроса. [#12593](https://github.com/ClickHouse/ClickHouse/pull/12593) ([Anton Popov](https://github.com/CurtizJ)).
* Удалять данные Distributed-таблиц (блоки из асинхронных `INSERT`) при выполнении `DROP TABLE`. [#12556](https://github.com/ClickHouse/ClickHouse/pull/12556) ([Azat Khuzhin](https://github.com/azat)).
* Теперь ClickHouse будет пересчитывать контрольные суммы для кусочков, если файл `checksums.txt` отсутствует. Не работало, начиная с [#9827](https://github.com/ClickHouse/ClickHouse/issues/9827). [#12545](https://github.com/ClickHouse/ClickHouse/pull/12545) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка, из-за которой старые парты повреждались после запроса `ALTER DELETE`, когда `enable_mixed_granularity_parts=1`. Исправляет [#12536](https://github.com/ClickHouse/ClickHouse/issues/12536). [#12543](https://github.com/ClickHouse/ClickHouse/pull/12543) ([alesapin](https://github.com/alesapin)).
* Исправлена состояние гонки в таблицах LIVE VIEW, которое могло приводить к дублированию данных. LIVE VIEW — экспериментальная функция. [#12519](https://github.com/ClickHouse/ClickHouse/pull/12519) ([vzakaznikov](https://github.com/vzakaznikov)).
* Исправлена обратная совместимость бинарного формата значений `AggregateFunction(avg, ...)`. Это исправляет [#12342](https://github.com/ClickHouse/ClickHouse/issues/12342). [#12486](https://github.com/ClickHouse/ClickHouse/pull/12486) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен сбой в `JOIN` со словарём, когда выполняется соединение по выражению над ключом словаря: `t JOIN dict ON expr(dict.id) = t.id`. Для этого случая отключена оптимизация соединения со словарём. [#12458](https://github.com/ClickHouse/ClickHouse/pull/12458) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлено переполнение при указании очень большого LIMIT или OFFSET. Это исправило [#10470](https://github.com/ClickHouse/ClickHouse/issues/10470). Это исправило [#11372](https://github.com/ClickHouse/ClickHouse/issues/11372). [#12427](https://github.com/ClickHouse/ClickHouse/pull/12427) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* kafka: исправлено возникновение SIGSEGV при наличии сообщения с ошибкой в середине батча. [#12302](https://github.com/ClickHouse/ClickHouse/pull/12302) ([Azat Khuzhin](https://github.com/azat)).

#### Улучшение {#improvement-13}


* Храните меньший объём логов в ZooKeeper. Избегайте чрезмерного роста узлов ZooKeeper в случае офлайн‑реплик при большом количестве серверов/таблиц/операций вставки. [#13100](https://github.com/ClickHouse/ClickHouse/pull/13100) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Теперь исключения передаются клиенту, если произошла ошибка во время `ALTER` или мутации. Закрывает [#11329](https://github.com/ClickHouse/ClickHouse/issues/11329). [#12666](https://github.com/ClickHouse/ClickHouse/pull/12666) ([alesapin](https://github.com/alesapin)).
* Добавлены `QueryTimeMicroseconds`, `SelectQueryTimeMicroseconds` и `InsertQueryTimeMicroseconds` в `system.events`, а также в `system.metrics`, `processes`, `query_log` и т. д. [#13028](https://github.com/ClickHouse/ClickHouse/pull/13028) ([ianton-ru](https://github.com/ianton-ru)).
* Добавлены `SelectedRows` и `SelectedBytes` в `system.events`, а также в `system.metrics`, `processes`, `query_log` и т. д. [#12638](https://github.com/ClickHouse/ClickHouse/pull/12638) ([ianton-ru](https://github.com/ianton-ru)).
* Добавлена информация о `current_database` в `system.query_log`. [#12652](https://github.com/ClickHouse/ClickHouse/pull/12652) ([Amos Bird](https://github.com/amosbird)).
* Разрешён формат `TabSeparatedRaw` для ввода. [#12009](https://github.com/ClickHouse/ClickHouse/pull/12009) ([hcz](https://github.com/hczhcz)).
* Теперь `joinGet` поддерживает поиск по составному ключу. [#12418](https://github.com/ClickHouse/ClickHouse/pull/12418) ([Amos Bird](https://github.com/amosbird)).
* Позволить агрегатным функциям `*Map` работать с массивами, содержащими NULL. Исправляет [#13157](https://github.com/ClickHouse/ClickHouse/issues/13157). [#13225](https://github.com/ClickHouse/ClickHouse/pull/13225) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Избежать переполнения при разборе значений DateTime, которое приводит к отрицательному Unix‑timestamp в их часовом поясе (например, `1970-01-01 00:00:00` в Москве). Вместо этого обнулять значение. Это исправляет [#3470](https://github.com/ClickHouse/ClickHouse/issues/3470). Это исправляет [#4172](https://github.com/ClickHouse/ClickHouse/issues/4172). [#12443](https://github.com/ClickHouse/ClickHouse/pull/12443) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* AvroConfluent: Пропускать tombstone-записи Kafka — поддержка пропуска повреждённых записей [#13203](https://github.com/ClickHouse/ClickHouse/pull/13203) ([Andrew Onyshchuk](https://github.com/oandrew)).
* Исправлена некорректная ошибка для длинных запросов. Можно было получить синтаксическую ошибку, отличную от `Max query size exceeded`, для корректного запроса. [#13928](https://github.com/ClickHouse/ClickHouse/pull/13928) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена гонка данных в функции `lgamma`. Она проявлялась только при проверке с помощью `tsan`, фактических побочных эффектов не было. [#13842](https://github.com/ClickHouse/ClickHouse/pull/13842) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено форматирование интервала &#39;Week&#39; в операторах ATTACH/ALTER/CREATE QUOTA. [#13417](https://github.com/ClickHouse/ClickHouse/pull/13417) ([vladimir-golovchenko](https://github.com/vladimir-golovchenko)).
* Теперь повреждённые парты также регистрируются при их обнаружении во время обработки компактных партов. Компактные парты — экспериментальная функция. [#13282](https://github.com/ClickHouse/ClickHouse/pull/13282) ([Amos Bird](https://github.com/amosbird)).
* Исправлена проверка `assert` в `geohashesInBox`. Это исправляет проблему [#12554](https://github.com/ClickHouse/ClickHouse/issues/12554). [#13229](https://github.com/ClickHouse/ClickHouse/pull/13229) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена проверка `assert` в `parseDateTimeBestEffort`. Это устраняет проблему [#12649](https://github.com/ClickHouse/ClickHouse/issues/12649). [#13227](https://github.com/ClickHouse/ClickHouse/pull/13227) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Незначительная оптимизация в Processors/PipelineExecutor: выход из цикла там, где это имеет смысл. [#13058](https://github.com/ClickHouse/ClickHouse/pull/13058) ([Mark Papadakis](https://github.com/markpapadakis)).
* Поддержка оператора TRUNCATE без использования ключевого слова TABLE. [#12653](https://github.com/ClickHouse/ClickHouse/pull/12653) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлено поведение по умолчанию, при котором формат вывода запроса `EXPLAIN` перезаписывался. Это исправляет [#12541](https://github.com/ClickHouse/ClickHouse/issues/12432). [#12541](https://github.com/ClickHouse/ClickHouse/pull/12541) ([BohuTANG](https://github.com/BohuTANG)).
* Разрешено задавать вид и тип JOIN более стандартным способом: `LEFT SEMI JOIN` вместо `SEMI LEFT JOIN`. Пока что оба варианта корректны. [#12520](https://github.com/ClickHouse/ClickHouse/pull/12520) ([Artem Zuikov](https://github.com/4ertus2)).
* Изменяет значение по умолчанию для `multiple_joins_rewriter_version` на 2. Это включает новый переписыватель множественных соединений, который учитывает имена столбцов. [#12469](https://github.com/ClickHouse/ClickHouse/pull/12469) ([Artem Zuikov](https://github.com/4ertus2)).
* Добавлено несколько метрик для запросов к хранилищам S3. [#12464](https://github.com/ClickHouse/ClickHouse/pull/12464) ([ianton-ru](https://github.com/ianton-ru)).
* Использовать правильный стандартный защищённый порт для clickhouse-benchmark при использовании аргумента `--secure`. Это исправляет [#11044](https://github.com/ClickHouse/ClickHouse/issues/11044). [#12440](https://github.com/ClickHouse/ClickHouse/pull/12440) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Откат ошибок вставки в движках `Log`, `TinyLog`, `StripeLog`. В предыдущих версиях ошибка вставки приводила к неконсистентному состоянию таблицы (это соответствует документации и является нормальным для этих движков таблиц). Это исправляет [#12402](https://github.com/ClickHouse/ClickHouse/issues/12402). [#12426](https://github.com/ClickHouse/ClickHouse/pull/12426) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Реализованы `RENAME DATABASE` и `RENAME DICTIONARY` для движка базы данных `Atomic` — добавлен неявный макрос `{uuid}`, который можно использовать в пути ZooKeeper для `ReplicatedMergeTree`. Он работает с запросами `CREATE ... ON CLUSTER ...`. Установите `show_table_uuid_in_table_create_query_if_not_nil` в `true`, чтобы его использовать. — Аргументы движка `ReplicatedMergeTree` сделаны необязательными, по умолчанию используются `/clickhouse/tables/{uuid}/{shard}/` и `{replica}`. Закрывает [#12135](https://github.com/ClickHouse/ClickHouse/issues/12135). — Незначительные исправления. — Эти изменения нарушают обратную совместимость движка базы данных `Atomic`. Ранее созданные базы данных `Atomic` необходимо вручную конвертировать в новый формат. Движок базы данных `Atomic` является экспериментальной функцией. [#12343](https://github.com/ClickHouse/ClickHouse/pull/12343) ([tavplubix](https://github.com/tavplubix)).
* `AWSAuthV4Signer` выделен в отдельный логгер, из сообщений журнала удалено избыточное `AWSClient: AWSClient`. [#12320](https://github.com/ClickHouse/ClickHouse/pull/12320) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Улучшено сообщение об исключении при работе с дисковым хранилищем. [#12625](https://github.com/ClickHouse/ClickHouse/pull/12625) ([alesapin](https://github.com/alesapin)).
* Улучшено сообщение об ошибке для функции `in` при неверном количестве аргументов. [#12529](https://github.com/ClickHouse/ClickHouse/pull/12529) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено сообщение об ошибке, связанной с адаптивной грануляцией. [#12624](https://github.com/ClickHouse/ClickHouse/pull/12624) ([alesapin](https://github.com/alesapin)).
* Исправлена обработка SETTINGS после FORMAT. [#12480](https://github.com/ClickHouse/ClickHouse/pull/12480) ([Azat Khuzhin](https://github.com/azat)).
* Если таблица MergeTree не содержит `ORDER BY` или `PARTITION BY`, можно было выполнить запрос `ALTER` с `CLEAR` для всех столбцов, и `ALTER` зависал. Исправлено [#7941](https://github.com/ClickHouse/ClickHouse/issues/7941). [#12382](https://github.com/ClickHouse/ClickHouse/pull/12382) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Не выполнять повторную загрузку автодополнения из файла истории после каждого запроса (чтобы избежать пересечения истории с другими клиентскими сессиями). [#13086](https://github.com/ClickHouse/ClickHouse/pull/13086) ([Azat Khuzhin](https://github.com/azat)).

#### Улучшение производительности {#performance-improvement-6}

- Снижено потребление памяти для некоторых операций до 2 раз. [#12424](https://github.com/ClickHouse/ClickHouse/pull/12424) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Оптимизирован поиск по первичному ключу для запросов, которые соответствуют точному диапазону первичного ключа. [#12277](https://github.com/ClickHouse/ClickHouse/pull/12277) ([Ivan Babrou](https://github.com/bobrik)).
- Незначительная оптимизация очень коротких запросов с `LowCardinality`. [#14129](https://github.com/ClickHouse/ClickHouse/pull/14129) ([Anton Popov](https://github.com/CurtizJ)).
- Незначительное улучшение производительности агрегации по ключам UInt8/UInt16. [#13091](https://github.com/ClickHouse/ClickHouse/pull/13091) и [#13055](https://github.com/ClickHouse/ClickHouse/pull/13055) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Проталкивание шага `LIMIT` для плана запроса (внутри подзапросов). [#13016](https://github.com/ClickHouse/ClickHouse/pull/13016) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Параллельный поиск по первичному ключу и этапы пропуска индексов на частях, как описано в [#11564](https://github.com/ClickHouse/ClickHouse/issues/11564). [#12589](https://github.com/ClickHouse/ClickHouse/pull/12589) ([Ivan Babrou](https://github.com/bobrik)).
- Преобразование аргументов типа String функций "if" и "transform" в enum при `set optimize_if_transform_strings_to_enum = 1`. [#12515](https://github.com/ClickHouse/ClickHouse/pull/12515) ([Artem Zuikov](https://github.com/4ertus2)).
- Замена монотонных функций их аргументом в `ORDER BY` при `set optimize_monotonous_functions_in_order_by=1`. [#12467](https://github.com/ClickHouse/ClickHouse/pull/12467) ([Artem Zuikov](https://github.com/4ertus2)).
- Добавлена оптимизация сортировки, которая переписывает `ORDER BY x, f(x)` как `ORDER BY x` при `set optimize_redundant_functions_in_order_by = 1`. [#12404](https://github.com/ClickHouse/ClickHouse/pull/12404) ([Artem Zuikov](https://github.com/4ertus2)).
- Разрешено проталкивание предиката, когда подзапрос содержит предложение `WITH`. Это исправляет [#12293](https://github.com/ClickHouse/ClickHouse/issues/12293) [#12663](https://github.com/ClickHouse/ClickHouse/pull/12663) ([Winter Zhang](https://github.com/zhang2014)).
- Улучшена производительность чтения из компактных частей. Компактные части — это экспериментальная функция. [#12492](https://github.com/ClickHouse/ClickHouse/pull/12492) ([Anton Popov](https://github.com/CurtizJ)).
- Попытка реализации потоковой оптимизации в `DiskS3`. DiskS3 — это экспериментальная функция. [#12434](https://github.com/ClickHouse/ClickHouse/pull/12434) ([Vladimir Chebotarev](https://github.com/excitoon)).

#### Улучшение сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-8}


* Использовать `shellcheck` для анализа sh-тестов. [#13200](https://github.com/ClickHouse/ClickHouse/pull/13200) [#13207](https://github.com/ClickHouse/ClickHouse/pull/13207) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлен скрипт, который устанавливает метки для pull request&#39;ов в GitHub-хуке. [#13183](https://github.com/ClickHouse/ClickHouse/pull/13183) ([alesapin](https://github.com/alesapin)).
* Удалена часть рекурсивных подмодулей. См. [#13378](https://github.com/ClickHouse/ClickHouse/issues/13378). [#13379](https://github.com/ClickHouse/ClickHouse/pull/13379) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Убедитесь, что все подмодули используют корректные URL. Продолжение [#13379](https://github.com/ClickHouse/ClickHouse/issues/13379). Исправляет [#13378](https://github.com/ClickHouse/ClickHouse/issues/13378). [#13397](https://github.com/ClickHouse/ClickHouse/pull/13397) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка пользовательских настроек, которые могут использоваться внутри запросов. Это необходимо, когда движок ClickHouse используется как компонент другой системы. [#13013](https://github.com/ClickHouse/ClickHouse/pull/13013) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлено тестирование RBAC-функциональности для привилегии INSERT в TestFlows. Расширен набор таблиц, на которых выполняется тестирование SELECT. Добавлены требования (Requirements) для соответствия новым тестам движка таблиц. [#13340](https://github.com/ClickHouse/ClickHouse/pull/13340) ([MyroTk](https://github.com/MyroTk)).
* Исправлена ошибка тайм‑аута при перезапуске сервера в стресс‑тесте. [#13321](https://github.com/ClickHouse/ClickHouse/pull/13321) ([alesapin](https://github.com/alesapin)).
* Теперь быстрый тест будет дожидаться сервера с повторами попыток. [#13284](https://github.com/ClickHouse/ClickHouse/pull/13284) ([alesapin](https://github.com/alesapin)).
* Функция `materialize()` (функция для тестирования ClickHouse) теперь корректно работает с `NULL`, преобразуя его в неконстантный столбец. [#13212](https://github.com/ClickHouse/ClickHouse/pull/13212) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена сборка libunwind на AArch64. Тем самым исправлена проблема [#13204](https://github.com/ClickHouse/ClickHouse/issues/13204). [#13208](https://github.com/ClickHouse/ClickHouse/pull/13208) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Еще больше повторных попыток в gtest для `zkutil`, чтобы снизить нестабильность тестов. [#13165](https://github.com/ClickHouse/ClickHouse/pull/13165) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Небольшие исправления в TestFlows для RBAC. [#13152](https://github.com/ClickHouse/ClickHouse/pull/13152) ([vzakaznikov](https://github.com/vzakaznikov)).
* Исправление теста `00960_live_view_watch_events_live.py`. [#13108](https://github.com/ClickHouse/ClickHouse/pull/13108) ([vzakaznikov](https://github.com/vzakaznikov)).
* Улучшена очистка кеша в скрипте деплоя документации. [#13107](https://github.com/ClickHouse/ClickHouse/pull/13107) ([alesapin](https://github.com/alesapin)).
* Часть «осиротевших» тестов переписана на gtest. Из тестов удалены лишние директивы include. [#13073](https://github.com/ClickHouse/ClickHouse/pull/13073) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлены тесты для функциональности RBAC-права `SELECT` в TestFlows. [#13061](https://github.com/ClickHouse/ClickHouse/pull/13061) ([Ritaank Tiwari](https://github.com/ritaank)).
* Повторный запуск части тестов в режиме быстрой проверки. [#12992](https://github.com/ClickHouse/ClickHouse/pull/12992) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка MSan в библиотеке `rdkafka`. Это закрывает [#12990](https://github.com/ClickHouse/ClickHouse/issues/12990). Обновлён `rdkafka` до версии 1.5 (master). [#12991](https://github.com/ClickHouse/ClickHouse/pull/12991) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен отчёт UBSan в base64 при запуске тестов на сервере с AVX-512. Это исправляет [#12318](https://github.com/ClickHouse/ClickHouse/issues/12318). Автор: @qoega. [#12441](https://github.com/ClickHouse/ClickHouse/pull/12441) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен отчёт UBSan в библиотеке HDFS. Это закрывает [#12330](https://github.com/ClickHouse/ClickHouse/issues/12330). [#12453](https://github.com/ClickHouse/ClickHouse/pull/12453) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Проверена возможность восстановления резервной копии из старой версии в новую. Это закрывает [#8979](https://github.com/ClickHouse/ClickHouse/issues/8979). [#12959](https://github.com/ClickHouse/ClickHouse/pull/12959) ([alesapin](https://github.com/alesapin)).
* Не собирайте образ helper&#95;container внутри интеграционных тестов. Собирайте Docker-контейнер в CI и используйте предварительно собранный helper&#95;container в интеграционных тестах. [#12953](https://github.com/ClickHouse/ClickHouse/pull/12953) ([Ilya Yatsishin](https://github.com/qoega)).
* Добавлен тест для запроса `ALTER TABLE CLEAR COLUMN` для столбцов первичного ключа. [#12951](https://github.com/ClickHouse/ClickHouse/pull/12951) ([alesapin](https://github.com/alesapin)).
* Увеличены тайм-ауты в тестах TestFlows. [#12949](https://github.com/ClickHouse/ClickHouse/pull/12949) ([vzakaznikov](https://github.com/vzakaznikov)).
* Исправлена сборка теста под Mac OS X. Исправление закрывает [#12767](https://github.com/ClickHouse/ClickHouse/issues/12767). [#12772](https://github.com/ClickHouse/ClickHouse/pull/12772) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Connector-ODBC обновлен до mysql-connector-odbc-8.0.21. [#12739](https://github.com/ClickHouse/ClickHouse/pull/12739) ([Ilya Yatsishin](https://github.com/qoega)).
* Добавлены синтаксические тесты для RBAC в TestFlows. [#12642](https://github.com/ClickHouse/ClickHouse/pull/12642) ([vzakaznikov](https://github.com/vzakaznikov)).
* Улучшена производительность TestKeeper, что ускорит тесты с интенсивным использованием реплицированных таблиц. [#12505](https://github.com/ClickHouse/ClickHouse/pull/12505) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Теперь мы проверяем, что сервер можно запустить после проведения стресс‑тестов. Это исправляет [#12473](https://github.com/ClickHouse/ClickHouse/issues/12473). [#12496](https://github.com/ClickHouse/ClickHouse/pull/12496) ([alesapin](https://github.com/alesapin)).
* Обновлена fmtlib до версии master (7.0.1). [#12446](https://github.com/ClickHouse/ClickHouse/pull/12446) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлен образ Docker для быстрых тестов. [#12294](https://github.com/ClickHouse/ClickHouse/pull/12294) ([alesapin](https://github.com/alesapin)).
* Переработаны пути к конфигурационным файлам для интеграционных тестов. [#12285](https://github.com/ClickHouse/ClickHouse/pull/12285) ([Ilya Yatsishin](https://github.com/qoega)).
* Добавлена опция компилятора для контроля того, чтобы размер кадров стека не был слишком большим. Это поможет запускать код в фиберах с небольшим размером стека. [#11524](https://github.com/ClickHouse/ClickHouse/pull/11524) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Обновлены файлы .gitignore. [#13447](https://github.com/ClickHouse/ClickHouse/pull/13447) ([vladimir-golovchenko](https://github.com/vladimir-golovchenko)).





## Релиз ClickHouse 20.6 {#clickhouse-release-206}

### Релиз ClickHouse v20.6.3.28-stable {#clickhouse-release-v206328-stable}

#### Обратно несовместимое изменение {#backward-incompatible-change-6}

- При обновлении с версий старше 20.5, если выполняется последовательное обновление и в кластере присутствуют как версии 20.5 и новее, так и версии младше 20.5, перезапуск узлов ClickHouse со старыми версиями при наличии более новых версий может привести к ошибкам `Part ... intersects previous part`. Чтобы предотвратить эту ошибку, сначала установите новые пакеты clickhouse-server на всех узлах кластера, а затем выполните перезапуск (таким образом, при перезапуске clickhouse-server будет запущена новая версия).

#### Новая функциональность {#new-feature-6}

- Добавлена начальная реализация запроса `EXPLAIN`. Синтаксис: `EXPLAIN SELECT ...`. Исправляет [#1118](https://github.com/ClickHouse/ClickHouse/issues/1118). [#11873](https://github.com/ClickHouse/ClickHouse/pull/11873) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Добавлен движок таблиц `RabbitMQ`. [#11069](https://github.com/ClickHouse/ClickHouse/pull/11069) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Реализован оператор `ILIKE` в стиле PostgreSQL для [#11710](https://github.com/ClickHouse/ClickHouse/issues/11710). [#12125](https://github.com/ClickHouse/ClickHouse/pull/12125) ([Mike](https://github.com/myrrc)).
- Добавлена поддержка RIGHT и FULL JOIN с `SET join_algorithm = 'partial_merge'`. Разрешена только строгость ALL (ANY, SEMI, ANTI, ASOF не поддерживаются). [#12118](https://github.com/ClickHouse/ClickHouse/pull/12118) ([Artem Zuikov](https://github.com/4ertus2)).
- Добавлена функция `initializeAggregation` для инициализации агрегации на основе одного значения. [#12109](https://github.com/ClickHouse/ClickHouse/pull/12109) ([Guillaume Tassery](https://github.com/YiuRULE)).
- Добавлена поддержка `ALTER TABLE ... [ADD|MODIFY] COLUMN ... FIRST` [#4006](https://github.com/ClickHouse/ClickHouse/issues/4006). [#12073](https://github.com/ClickHouse/ClickHouse/pull/12073) ([Winter Zhang](https://github.com/zhang2014)).
- Добавлена функция `parseDateTimeBestEffortUS`. [#12028](https://github.com/ClickHouse/ClickHouse/pull/12028) ([flynn](https://github.com/ucasFL)).
- Добавлена поддержка формата `ORC` для вывода (ранее поддерживался только для ввода). [#11662](https://github.com/ClickHouse/ClickHouse/pull/11662) ([Kruglov Pavel](https://github.com/Avogar)).

#### Исправление ошибок {#bug-fix-25}


* Исправлена ошибка `aggregate function any(x) is found inside another aggregate function in query`, возникавшая при использовании `SET optimize_move_functions_out_of_any = 1` и псевдонимов внутри `any()`. [#13419](https://github.com/ClickHouse/ClickHouse/pull/13419) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлен `PrettyCompactMonoBlock` для clickhouse-local. Исправлены extremes/totals при использовании `PrettyCompactMonoBlock`. Это исправляет [#7746](https://github.com/ClickHouse/ClickHouse/issues/7746). [#13394](https://github.com/ClickHouse/ClickHouse/pull/13394) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена возможная ошибка `Totals having transform was already added to pipeline` при выполнении запроса с отложенной реплики. [#13290](https://github.com/ClickHouse/ClickHouse/pull/13290) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Сервер мог аварийно завершить работу, если пользователь передал специально сформированные аргументы функции `h3ToChildren`. Это исправляет [#13275](https://github.com/ClickHouse/ClickHouse/issues/13275). [#13277](https://github.com/ClickHouse/ClickHouse/pull/13277) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены потенциально низкая производительность и слегка некорректные результаты для агрегатных функций `uniqExact`, `topK`, `sumDistinct` и аналогичных, вызываемых для типов Float со значениями NaN. Это также приводило к срабатыванию assert в debug-сборке. Исправляет [#12491](https://github.com/ClickHouse/ClickHouse/issues/12491). [#13254](https://github.com/ClickHouse/ClickHouse/pull/13254) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена функция if с nullable constexpr в качестве условия cond, которое не является литералом NULL. Исправляет [#12463](https://github.com/ClickHouse/ClickHouse/issues/12463). [#13226](https://github.com/ClickHouse/ClickHouse/pull/13226) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена проверка (`assert`) в функции `arrayElement` в случае, когда элементы массива имеют тип Nullable и индекс массива также имеет тип Nullable. Это исправляет [#12172](https://github.com/ClickHouse/ClickHouse/issues/12172). [#13224](https://github.com/ClickHouse/ClickHouse/pull/13224) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены функции преобразования `DateTime64` с константным аргументом. [#13205](https://github.com/ClickHouse/ClickHouse/pull/13205) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен некорректный анализ индексов с функциями. Это могло приводить к отсечению неверных частей при чтении из таблиц `MergeTree`. Исправляет [#13060](https://github.com/ClickHouse/ClickHouse/issues/13060). Исправляет [#12406](https://github.com/ClickHouse/ClickHouse/issues/12406). [#13081](https://github.com/ClickHouse/ClickHouse/pull/13081) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка `Cannot convert column because it is constant but values of constants are different in source and result` для удалённых запросов, которые используют детерминированные функции в контексте одного запроса, но не детерминированы между разными запросами, такие как `now()`, `now64()`, `randConstant()`. Исправляет [#11327](https://github.com/ClickHouse/ClickHouse/issues/11327). [#13075](https://github.com/ClickHouse/ClickHouse/pull/13075) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено ненужное ограничение количества потоков для `SELECT`-запросов с локальной реплики. [#12840](https://github.com/ClickHouse/ClickHouse/pull/12840) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена редкая ошибка, из-за которой запросы `ALTER DELETE` и `ALTER MODIFY COLUMN` могли выполняться одновременно как одна мутация. Ошибка приводила к некорректному количеству строк в `count.txt` и, как следствие, к некорректным данным в части. Также исправлена небольшая ошибка при одновременном выполнении `ALTER RENAME COLUMN` и `ALTER ADD COLUMN`. [#12760](https://github.com/ClickHouse/ClickHouse/pull/12760) ([alesapin](https://github.com/alesapin)).
* Исправлена работа `CAST(Nullable(String), Enum())`. [#12745](https://github.com/ClickHouse/ClickHouse/pull/12745) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема с производительностью для больших кортежей, которые интерпретируются как функции в секции `IN`. Это случай, когда пользователь по какой-то непонятной причине пишет `WHERE x IN tuple(1, 2, ...)` вместо `WHERE x IN (1, 2, ...)`. [#12700](https://github.com/ClickHouse/ClickHouse/pull/12700) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено отслеживание памяти для `input_format_parallel_parsing` (за счёт присоединения потока к группе). [#12672](https://github.com/ClickHouse/ClickHouse/pull/12672) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен индекс блум-фильтра при использовании константного выражения. Это исправляет [#10572](https://github.com/ClickHouse/ClickHouse/issues/10572). [#12659](https://github.com/ClickHouse/ClickHouse/pull/12659) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена ошибка `SIGSEGV` в `StorageKafka`, возникающая при недоступности брокера (и не только). [#12658](https://github.com/ClickHouse/ClickHouse/pull/12658) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка функции `if` с аргументами типа `Array(UUID)`. Это исправляет [#11066](https://github.com/ClickHouse/ClickHouse/issues/11066). [#12648](https://github.com/ClickHouse/ClickHouse/pull/12648) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `CREATE USER IF NOT EXISTS` теперь не генерирует исключение, если пользователь уже существует. Это исправляет [#12507](https://github.com/ClickHouse/ClickHouse/issues/12507). [#12646](https://github.com/ClickHouse/ClickHouse/pull/12646) ([Vitaly Baranov](https://github.com/vitlibar)).
* Более информативное сообщение об исключении при доступе к дисковому хранилищу. [#12625](https://github.com/ClickHouse/ClickHouse/pull/12625) ([alesapin](https://github.com/alesapin)).
* Функция `groupArrayMoving*` не работала для распределённых запросов. Её результат вычислялся в некорректном типе данных (без приведения к максимально возможному типу). Функция `groupArrayMovingAvg` возвращала целое число, что было несогласовано с функцией `avg`. Это исправляет [#12568](https://github.com/ClickHouse/ClickHouse/issues/12568). [#12622](https://github.com/ClickHouse/ClickHouse/pull/12622) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено отсутствие псевдонимов у функции `any`. [#12593](https://github.com/ClickHouse/ClickHouse/pull/12593) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена гонка в внешних словарях с типом размещения `cache`, которая могла приводить к падению сервера. [#12566](https://github.com/ClickHouse/ClickHouse/pull/12566) ([alesapin](https://github.com/alesapin)).
* Удаление данных для таблиц `Distributed` (блоков из асинхронных `INSERT`) при выполнении `DROP TABLE`. [#12556](https://github.com/ClickHouse/ClickHouse/pull/12556) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, приводившая к повреждению старых партиций после запроса `ALTER DELETE`, когда `enable_mixed_granularity_parts=1`. Исправляет [#12536](https://github.com/ClickHouse/ClickHouse/issues/12536). [#12543](https://github.com/ClickHouse/ClickHouse/pull/12543) ([alesapin](https://github.com/alesapin)).
* Улучшено сообщение об ошибке для функции `in` при неверном количестве аргументов. [#12529](https://github.com/ClickHouse/ClickHouse/pull/12529) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена гонка состояний в таблицах live view, которая могла приводить к дублированию данных. [#12519](https://github.com/ClickHouse/ClickHouse/pull/12519) ([vzakaznikov](https://github.com/vzakaznikov)).
* Исправлена проблема с производительностью при чтении из компактных частей. [#12492](https://github.com/ClickHouse/ClickHouse/pull/12492) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена обратная совместимость бинарного формата значений `AggregateFunction(avg, ...)`. Это исправляет [#12342](https://github.com/ClickHouse/ClickHouse/issues/12342). [#12486](https://github.com/ClickHouse/ClickHouse/pull/12486) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен разбор `SETTINGS` после `FORMAT`. [#12480](https://github.com/ClickHouse/ClickHouse/pull/12480) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена взаимоблокировка при включенном `text_log`. [#12452](https://github.com/ClickHouse/ClickHouse/pull/12452) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено переполнение при указании очень большого значения `LIMIT` или `OFFSET`. Исправляет [#10470](https://github.com/ClickHouse/ClickHouse/issues/10470). Исправляет [#11372](https://github.com/ClickHouse/ClickHouse/issues/11372). [#12427](https://github.com/ClickHouse/ClickHouse/pull/12427) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена возможная ошибка сегментации в `StorageMerge`. Это исправление закрывает [#12054](https://github.com/ClickHouse/ClickHouse/issues/12054). [#12401](https://github.com/ClickHouse/ClickHouse/pull/12401) ([tavplubix](https://github.com/tavplubix)).
* Отменено изменение, внесённое в [#11079](https://github.com/ClickHouse/ClickHouse/issues/11079), для исправления [#12098](https://github.com/ClickHouse/ClickHouse/issues/12098). [#12397](https://github.com/ClickHouse/ClickHouse/pull/12397) ([Mike](https://github.com/myrrc)).
* Дополнительная проверка аргументов индекса блум-фильтра. Это исправляет [#11408](https://github.com/ClickHouse/ClickHouse/issues/11408). [#12388](https://github.com/ClickHouse/ClickHouse/pull/12388) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Избегает возникновения исключения при использовании отрицательной или вещественной константы в условии WHERE для индексированных таблиц. Исправляет [#11905](https://github.com/ClickHouse/ClickHouse/issues/11905). [#12384](https://github.com/ClickHouse/ClickHouse/pull/12384) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Разрешено выполнять `CLEAR` для столбца, даже если от него зависят выражения `DEFAULT`. Это исправляет [#12333](https://github.com/ClickHouse/ClickHouse/issues/12333). [#12378](https://github.com/ClickHouse/ClickHouse/pull/12378) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена работа `TOTALS/ROLLUP/CUBE` для агрегатных функций с аргументами `-State` и `Nullable`. Это исправляет [#12163](https://github.com/ClickHouse/ClickHouse/issues/12163). [#12376](https://github.com/ClickHouse/ClickHouse/pull/12376) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены сообщения об ошибках и коды возврата для запросов `ALTER RENAME COLUMN`, когда `RENAME` не разрешён. Исправлены [#12301](https://github.com/ClickHouse/ClickHouse/issues/12301) и [#12303](https://github.com/ClickHouse/ClickHouse/issues/12303). [#12335](https://github.com/ClickHouse/ClickHouse/pull/12335) ([alesapin](https://github.com/alesapin)).
* Исправлено крайне редкое состояние гонки в `ReplicatedMergeTreeQueue`. [#12315](https://github.com/ClickHouse/ClickHouse/pull/12315) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* При использовании кодека `Delta` или `DoubleDelta` с типами непостоянной ширины вместо исключения с кодом `BAD_ARGUMENTS` возвращалось исключение с кодом `LOGICAL_ERROR` (мы гарантируем, что исключения с кодом `LOGICAL_ERROR` никогда не возникают). Это исправляет [#12110](https://github.com/ClickHouse/ClickHouse/issues/12110). [#12308](https://github.com/ClickHouse/ClickHouse/pull/12308) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен порядок столбцов в модификаторе `WITH FILL`. Ранее порядок столбцов в операторе `ORDER BY` не соблюдался. [#12306](https://github.com/ClickHouse/ClickHouse/pull/12306) ([Anton Popov](https://github.com/CurtizJ)).
* Избежать возникновения исключения «bad cast» в случае, когда есть выражение, фильтрующее данные по виртуальным столбцам (таким как `_table` в таблицах `Merge`) или по столбцам «index» в системных таблицах, например при фильтрации по имени базы данных при запросе к `system.tables`, и это выражение возвращает тип `Nullable`. Это исправляет [#12166](https://github.com/ClickHouse/ClickHouse/issues/12166). [#12305](https://github.com/ClickHouse/ClickHouse/pull/12305) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена обработка `TTL` после переименования столбца, от которого зависит TTL-выражение. [#12304](https://github.com/ClickHouse/ClickHouse/pull/12304) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка SIGSEGV, возникавшая при наличии сообщения с ошибкой в середине батча в движке `Kafka`. [#12302](https://github.com/ClickHouse/ClickHouse/pull/12302) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема, из-за которой некоторые потоки могли случайным образом зависать на несколько секунд во время обновления кеша `DNS`. [#12296](https://github.com/ClickHouse/ClickHouse/pull/12296) ([tavplubix](https://github.com/tavplubix)).
* Исправлена опечатка в названии настройки. [#12292](https://github.com/ClickHouse/ClickHouse/pull/12292) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Показывать ошибку после сбоя загрузки `TrieDictionary`. [#12290](https://github.com/ClickHouse/ClickHouse/pull/12290) ([Vitaly Baranov](https://github.com/vitlibar)).
* Функция `arrayFill` работала некорректно для пустых массивов, что могло приводить к аварийному завершению работы. Это исправляет [#12263](https://github.com/ClickHouse/ClickHouse/issues/12263). [#12279](https://github.com/ClickHouse/ClickHouse/pull/12279) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Реализованы преобразования к общему типу для типов `LowCardinality`. Это позволяет выполнять UNION ALL для таблиц с колонками типа LowCardinality и другими колонками. Исправлено [#8212](https://github.com/ClickHouse/ClickHouse/issues/8212). Исправлено [#4342](https://github.com/ClickHouse/ClickHouse/issues/4342). [#12275](https://github.com/ClickHouse/ClickHouse/pull/12275) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено поведение при достижении предела перенаправлений в запросе к хранилищу `S3`. [#12256](https://github.com/ClickHouse/ClickHouse/pull/12256) ([ianton-ru](https://github.com/ianton-ru)).
* Исправлено поведение, при котором при нескольких последовательных вставках в `StorageFile` заголовок для некоторых специальных типов записывался более одного раза. Это исправило [#6155](https://github.com/ClickHouse/ClickHouse/issues/6155). [#12197](https://github.com/ClickHouse/ClickHouse/pull/12197) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена работа логических функций для значений типа UInt8, отличных от 0 и 1. [#12196](https://github.com/ClickHouse/ClickHouse/pull/12196) ([Alexander Kazakov](https://github.com/Akazz)).
* Лимиты max&#95;memory&#95;usage* ограничены размером резидентной памяти процесса. [#12182](https://github.com/ClickHouse/ClickHouse/pull/12182) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проверка аргументов `dictGet` при устранении инъективных функций в секции `GROUP BY`. [#12179](https://github.com/ClickHouse/ClickHouse/pull/12179) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено поведение, при котором движок `SummingMergeTree` суммировал столбцы из ключа партиционирования. Добавлено исключение на случай, когда явно заданные для суммирования столбцы пересекаются со столбцами ключа партиционирования. Это исправляет [#7867](https://github.com/ClickHouse/ClickHouse/issues/7867). [#12173](https://github.com/ClickHouse/ClickHouse/pull/12173) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Не разделяйте имя таблицы источника словаря на схему и имя таблицы, если ODBC-подключение не поддерживает схемы. [#12165](https://github.com/ClickHouse/ClickHouse/pull/12165) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена неверная логика в `ALTER DELETE`, из-за которой записи удалялись, когда результат условия был NULL. Исправляет [#9088](https://github.com/ClickHouse/ClickHouse/issues/9088). Закрывает [#12106](https://github.com/ClickHouse/ClickHouse/issues/12106). [#12153](https://github.com/ClickHouse/ClickHouse/pull/12153) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено преобразование запроса, отправляемого во внешние СУБД (например, MySQL, ODBC) при наличии псевдонимов. Это исправляет проблему [#12032](https://github.com/ClickHouse/ClickHouse/issues/12032). [#12151](https://github.com/ClickHouse/ClickHouse/pull/12151) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен некорректный код в оптимизации лишнего ORDER BY. Ошибка была внесена в [#10067](https://github.com/ClickHouse/ClickHouse/issues/10067). [#12148](https://github.com/ClickHouse/ClickHouse/pull/12148) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено потенциальное переполнение при целочисленном делении. Это исправляет [#12119](https://github.com/ClickHouse/ClickHouse/issues/12119). [#12140](https://github.com/ClickHouse/ClickHouse/pull/12140) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена потенциальная бесконечная бесконечная цикл в `greatCircleDistance`, `geoDistance`. Это устраняет [#12117](https://github.com/ClickHouse/ClickHouse/issues/12117). [#12137](https://github.com/ClickHouse/ClickHouse/pull/12137) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Нормализована обработка pid-файла. В предыдущих версиях сервер мог не запускаться, если он был завершён принудительно без корректного завершения работы и уже существовал другой процесс с тем же pid, что и у ранее запущенного сервера. Также pid-файл мог быть удалён при неудачной попытке запуска сервера, даже если другой сервер уже работал. Это исправляет [#3501](https://github.com/ClickHouse/ClickHouse/issues/3501). [#12133](https://github.com/ClickHouse/ClickHouse/pull/12133) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка, приводившая к некорректным метаданным таблиц в ZooKeeper для таблиц ReplicatedVersionedCollapsingMergeTree. Исправляет [#12093](https://github.com/ClickHouse/ClickHouse/issues/12093). [#12121](https://github.com/ClickHouse/ClickHouse/pull/12121) ([alesapin](https://github.com/alesapin)).
* Избегайте исключения «There is no query» для материализованных представлений с `JOIN`-ами или подзапросами, привязанных к системным логам (`system.query_log`, `metric_log` и т. д.) или к базовой таблице с движком `Buffer`. [#12120](https://github.com/ClickHouse/ClickHouse/pull/12120) ([filimonov](https://github.com/filimonov)).
* Исправлена обработка зависимости таблицы с ENGINE=Dictionary от словаря. Это исправляет [#10994](https://github.com/ClickHouse/ClickHouse/issues/10994). Это исправляет [#10397](https://github.com/ClickHouse/ClickHouse/issues/10397). [#12116](https://github.com/ClickHouse/ClickHouse/pull/12116) ([Vitaly Baranov](https://github.com/vitlibar)).
* Формат `Parquet` теперь корректно работает с типами `LowCardinality` и `LowCardinality(Nullable)`. Исправлены [#12086](https://github.com/ClickHouse/ClickHouse/issues/12086), [#8406](https://github.com/ClickHouse/ClickHouse/issues/8406). [#12108](https://github.com/ClickHouse/ClickHouse/pull/12108) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена производительность запросов с `UNION`, страдавшая из‑за неверного лимита на общее количество потоков. Исправляет [#12030](https://github.com/ClickHouse/ClickHouse/issues/12030). [#12103](https://github.com/ClickHouse/ClickHouse/pull/12103) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка сегментации (segfault) с комбинаторами `-StateResample`. [#12092](https://github.com/ClickHouse/ClickHouse/pull/12092) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены пустые метрики `result_rows` и `result_bytes` в `system.quey_log` для запросов SELECT. Исправляет [#11595](https://github.com/ClickHouse/ClickHouse/issues/11595). [#12089](https://github.com/ClickHouse/ClickHouse/pull/12089) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено ненужное ограничение числа потоков для запросов `SELECT` из `VIEW`. Исправляет [#11937](https://github.com/ClickHouse/ClickHouse/issues/11937). [#12085](https://github.com/ClickHouse/ClickHouse/pull/12085) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено падение с SIGSEGV в StorageKafka при выполнении DROP TABLE. [#12075](https://github.com/ClickHouse/ClickHouse/pull/12075) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен возможный сбой при использовании некорректного типа для `PREWHERE`. Исправлены [#12053](https://github.com/ClickHouse/ClickHouse/issues/12053), [#12060](https://github.com/ClickHouse/ClickHouse/issues/12060). [#12060](https://github.com/ClickHouse/ClickHouse/pull/12060) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка `Cannot capture column` для функций высшего порядка с аргументом типа `Tuple(LowCardinality)`. Устраняет [#9766](https://github.com/ClickHouse/ClickHouse/issues/9766). [#12055](https://github.com/ClickHouse/ClickHouse/pull/12055) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена проверка ограничений: теперь она проверяет, является ли ограничение константным выражением. Это исправляет [#11360](https://github.com/ClickHouse/ClickHouse/issues/11360). [#12042](https://github.com/ClickHouse/ClickHouse/pull/12042) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены неверный результат и потенциальный сбой при вызове функции `if` с аргументами типа `FixedString` разного размера. Это исправляет [#11362](https://github.com/ClickHouse/ClickHouse/issues/11362). [#12021](https://github.com/ClickHouse/ClickHouse/pull/12021) ([alexey-milovidov](https://github.com/alexey-milovidov)).

#### Улучшения {#improvement-14}

- Добавлена возможность указывать тип и вид `JOIN` в более стандартной форме: `LEFT SEMI JOIN` вместо `SEMI LEFT JOIN`. На данный момент оба варианта корректны. [#12520](https://github.com/ClickHouse/ClickHouse/pull/12520) ([Artem Zuikov](https://github.com/4ertus2)).
- Добавлены метрики lifetime_rows/lifetime_bytes для движка Buffer. [#12421](https://github.com/ClickHouse/ClickHouse/pull/12421) ([Azat Khuzhin](https://github.com/azat)).
- Детальное сообщение об исключении теперь отправляется клиенту вместо 'MySQL server has gone away'. [#12383](https://github.com/ClickHouse/ClickHouse/pull/12383) ([BohuTANG](https://github.com/BohuTANG)).
- Добавлена возможность изменять кодировку, используемую для отображения границ таблиц. Доступные кодировки: UTF-8, ASCII. Настройка `output_format_pretty_grid_charset` включает эту функцию. [#12372](https://github.com/ClickHouse/ClickHouse/pull/12372) ([Sabyanin Maxim](https://github.com/s-mx)).
- Добавлена поддержка MySQL-запроса 'SELECT DATABASE()' [#9336](https://github.com/ClickHouse/ClickHouse/issues/9336) 2. Добавлен интеграционный тест для замены MySQL-запросов. [#12314](https://github.com/ClickHouse/ClickHouse/pull/12314) ([BohuTANG](https://github.com/BohuTANG)).
- Добавлена команда `KILL QUERY [connection_id]` для MySQL-клиента/драйвера для отмены длительных запросов, issue [#12038](https://github.com/ClickHouse/ClickHouse/issues/12038). [#12152](https://github.com/ClickHouse/ClickHouse/pull/12152) ([BohuTANG](https://github.com/BohuTANG)).
- Добавлена поддержка подстановок `%g` (двузначный год ISO) и `%G` (четырёхзначный год ISO) в функции `formatDateTime`. [#12136](https://github.com/ClickHouse/ClickHouse/pull/12136) ([vivarum](https://github.com/vivarum)).
- Добавлен столбец 'type' в таблицу system.disks. [#12115](https://github.com/ClickHouse/ClickHouse/pull/12115) ([ianton-ru](https://github.com/ianton-ru)).
- Улучшена команда `REVOKE`: теперь она требует опцию grant/admin только для тех прав доступа, которые будут отозваны. Например, для выполнения `REVOKE ALL ON *.* FROM user1` теперь не требуется иметь полные права доступа с опцией grant. Добавлена команда `REVOKE ALL FROM user1` — она отзывает все назначенные роли у `user1`. [#12083](https://github.com/ClickHouse/ClickHouse/pull/12083) ([Vitaly Baranov](https://github.com/vitlibar)).
- Добавлен приоритет реплик для load_balancing (для ручной приоритизации балансировки нагрузки). [#11995](https://github.com/ClickHouse/ClickHouse/pull/11995) ([Azat Khuzhin](https://github.com/azat)).
- Пути в метаданных S3 переведены на относительные, что упрощает работу с S3-объектами. [#11892](https://github.com/ClickHouse/ClickHouse/pull/11892) ([Vladimir Chebotarev](https://github.com/excitoon)).

#### Улучшения производительности {#performance-improvement-7}


- Улучшена производительность `ORDER BY` и `GROUP BY` по префиксу ключа сортировки (включается настройкой `optimize_aggregation_in_order`, по умолчанию отключено). [#11696](https://github.com/ClickHouse/ClickHouse/pull/11696) ([Anton Popov](https://github.com/CurtizJ)).
- Удалены инъективные функции внутри `uniq*()` при `set optimize_injective_functions_inside_uniq=1`. [#12337](https://github.com/ClickHouse/ClickHouse/pull/12337) ([Ruslan Kamalov](https://github.com/kamalov-ruslan)).
- Индекс не использовался для оператора IN с литералами, регрессия производительности появилась примерно в v19.3. Это исправляет [#10574](https://github.com/ClickHouse/ClickHouse/issues/10574). [#12062](https://github.com/ClickHouse/ClickHouse/pull/12062) ([nvartolomei](https://github.com/nvartolomei)).
- Реализована загрузка одиночных частей для DiskS3 (экспериментальная функция). [#12026](https://github.com/ClickHouse/ClickHouse/pull/12026) ([Vladimir Chebotarev](https://github.com/excitoon)).

#### Экспериментальная функция {#experimental-feature-4}

- Добавлен новый формат хранения частей в памяти для таблиц семейства `MergeTree`, который хранит данные в памяти. Части записываются на диск при первом слиянии. Часть будет создана в формате in-memory, если её размер в строках или байтах ниже пороговых значений `min_rows_for_compact_part` и `min_bytes_for_compact_part`. Также доступна опциональная поддержка журнала упреждающей записи (Write-Ahead-Log), которая включена по умолчанию и управляется настройкой `in_memory_parts_enable_wal`. [#10697](https://github.com/ClickHouse/ClickHouse/pull/10697) ([Anton Popov](https://github.com/CurtizJ)).

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-9}


* Реализован режим фаззинга запросов на основе AST для `clickhouse-client`. См. [этот label](https://github.com/ClickHouse/ClickHouse/issues?q=label%3Afuzz+is%3Aissue) для списка задач, которые мы недавно нашли с помощью фаззинга. Большинство из них были найдены этим инструментом, а несколько — SQLancer и `00746_sql_fuzzy.pl`. [#12111](https://github.com/ClickHouse/ClickHouse/pull/12111) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Добавлен новый тип тестов на основе фреймворка Testflows. [#12090](https://github.com/ClickHouse/ClickHouse/pull/12090) ([vzakaznikov](https://github.com/vzakaznikov)).
* Добавлен интеграционный тест S3 HTTPS. [#12412](https://github.com/ClickHouse/ClickHouse/pull/12412) ([Pavel Kovalenko](https://github.com/Jokser)).
* Логируются сообщения trap'ов sanitizer'а из отдельного потока. Это предотвратит возможный дедлок под thread sanitizer. [#12313](https://github.com/ClickHouse/ClickHouse/pull/12313) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Теперь функциональные и стресс‑тесты могут запускаться со старой версией скрипта `clickhouse-test`. [#12287](https://github.com/ClickHouse/ClickHouse/pull/12287) ([alesapin](https://github.com/alesapin)).
* Удалено странное создание файлов во время сборки в `orc`. [#12258](https://github.com/ClickHouse/ClickHouse/pull/12258) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Общие файлы docker compose помещены в интеграционный docker‑контейнер. [#12168](https://github.com/ClickHouse/ClickHouse/pull/12168) ([Ilya Yatsishin](https://github.com/qoega)).
* Исправлены предупреждения от CodeQL. `CodeQL` — это ещё один статический анализатор, который мы будем использовать вместе с уже используемыми `clang-tidy` и `PVS-Studio`. [#12138](https://github.com/ClickHouse/ClickHouse/pull/12138) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Небольшие исправления CMake для сборки UNBUNDLED. [#12131](https://github.com/ClickHouse/ClickHouse/pull/12131) ([Matwey V. Kornilov](https://github.com/matwey)).
* Добавлен демонстрационный пример минимального Docker‑образа без использования какой‑либо Linux‑дистрибуции. [#12126](https://github.com/ClickHouse/ClickHouse/pull/12126) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Выполнено обновление системных пакетов в Docker‑образе `clickhouse-server`. [#12124](https://github.com/ClickHouse/ClickHouse/pull/12124) ([Ivan Blinkov](https://github.com/blinkov)).
* Добавлен флаг `UNBUNDLED` в таблицу `system.build_options`. Списки пропуска для `clickhouse-test` перенесены в репозиторий ClickHouse. [#12107](https://github.com/ClickHouse/ClickHouse/pull/12107) ([alesapin](https://github.com/alesapin)).
* Настроена регулярная проверка средствами инструмента анализа безопасности [Anchore Container Analysis](https://docs.anchore.com), который ищет [CVE](https://cve.mitre.org/) в Docker‑образе `clickhouse-server`. Также подтверждает, что `Dockerfile` можно собрать. Запускается ежедневно на `master` и на pull‑requests к `Dockerfile`. [#12102](https://github.com/ClickHouse/ClickHouse/pull/12102) ([Ivan Blinkov](https://github.com/blinkov)).
* Настроена ежедневная проверка инструментом анализа безопасности [GitHub CodeQL](https://securitylab.github.com/tools/codeql), который ищет [CWE](https://cwe.mitre.org/). [#12101](https://github.com/ClickHouse/ClickHouse/pull/12101) ([Ivan Blinkov](https://github.com/blinkov)).
* Установка `ca-certificates` перед первым `apt-get update` в Dockerfile. [#12095](https://github.com/ClickHouse/ClickHouse/pull/12095) ([Ivan Blinkov](https://github.com/blinkov)).



## Релиз ClickHouse 20.5 {#clickhouse-release-205}

### Релиз ClickHouse v20.5.4.40-stable, 2020-08-10 {#clickhouse-release-v205440-stable-2020-08-10}

#### Исправление ошибок {#bug-fix-26}


* Исправлен некорректный анализ индекса с функциями. Это могло приводить к отсечению неверных частей при чтении из таблиц `MergeTree`. Исправляет [#13060](https://github.com/ClickHouse/ClickHouse/issues/13060). Исправляет [#12406](https://github.com/ClickHouse/ClickHouse/issues/12406). [#13081](https://github.com/ClickHouse/ClickHouse/pull/13081) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено избыточное ограничение числа потоков для запросов SELECT с локальной реплики. [#12840](https://github.com/ClickHouse/ClickHouse/pull/12840) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена производительность при работе с большими кортежами, которые в разделе `IN` интерпретируются как функции. Речь о случае, когда пользователь по какой-то непонятной причине пишет `WHERE x IN tuple(1, 2, ...)` вместо `WHERE x IN (1, 2, ...)`. [#12700](https://github.com/ClickHouse/ClickHouse/pull/12700) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено отслеживание памяти для input&#95;format&#95;parallel&#95;parsing (за счёт присоединения потока к группе). [#12672](https://github.com/ClickHouse/ClickHouse/pull/12672) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен индекс bloom-фильтра с константным выражением. Это устраняет [#10572](https://github.com/ClickHouse/ClickHouse/issues/10572). [#12659](https://github.com/ClickHouse/ClickHouse/pull/12659) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена ошибка `SIGSEGV` в `StorageKafka`, возникавшая при недоступности брокера (и не только). [#12658](https://github.com/ClickHouse/ClickHouse/pull/12658) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка функции `if` с аргументами типа `Array(UUID)`. Это исправляет [#11066](https://github.com/ClickHouse/ClickHouse/issues/11066). [#12648](https://github.com/ClickHouse/ClickHouse/pull/12648) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено отсутствие псевдонимов у функции `any`. [#12593](https://github.com/ClickHouse/ClickHouse/pull/12593) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена гонка в внешних словарях с типом `cache`, которая могла приводить к сбою сервера. [#12566](https://github.com/ClickHouse/ClickHouse/pull/12566) ([alesapin](https://github.com/alesapin)).
* Удалено хранение данных (блоков из асинхронных `INSERT`) для таблиц `Distributed` при выполнении `DROP TABLE`. [#12556](https://github.com/ClickHouse/ClickHouse/pull/12556) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, приводившая к повреждению старых кусков данных после запроса `ALTER DELETE`, когда `enable_mixed_granularity_parts=1`. Исправляет [#12536](https://github.com/ClickHouse/ClickHouse/issues/12536). [#12543](https://github.com/ClickHouse/ClickHouse/pull/12543) ([alesapin](https://github.com/alesapin)).
* Улучшено сообщение об исключении для функции `in` при недопустимом количестве аргументов. [#12529](https://github.com/ClickHouse/ClickHouse/pull/12529) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена гонка в таблицах `LIVE VIEW`, которая могла приводить к дублированию данных. [#12519](https://github.com/ClickHouse/ClickHouse/pull/12519) ([vzakaznikov](https://github.com/vzakaznikov)).
* Исправлена проблема с производительностью при чтении из компактных парций. [#12492](https://github.com/ClickHouse/ClickHouse/pull/12492) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена обратная совместимость бинарного формата значений `AggregateFunction(avg, ...)`. Это исправляет [#12342](https://github.com/ClickHouse/ClickHouse/issues/12342). [#12486](https://github.com/ClickHouse/ClickHouse/pull/12486) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена взаимная блокировка при включённом `text_log`. [#12452](https://github.com/ClickHouse/ClickHouse/pull/12452) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено переполнение при указании очень большого LIMIT или OFFSET. Это исправляет [#10470](https://github.com/ClickHouse/ClickHouse/issues/10470). Это исправляет [#11372](https://github.com/ClickHouse/ClickHouse/issues/11372). [#12427](https://github.com/ClickHouse/ClickHouse/pull/12427) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена возможная ошибка сегментации в `StorageMerge`. Закрывает [#12054](https://github.com/ClickHouse/ClickHouse/issues/12054). [#12401](https://github.com/ClickHouse/ClickHouse/pull/12401) ([tavplubix](https://github.com/tavplubix)).
* Отменяет изменение, внесённое в [#11079](https://github.com/ClickHouse/ClickHouse/issues/11079), чтобы решить проблему [#12098](https://github.com/ClickHouse/ClickHouse/issues/12098). [#12397](https://github.com/ClickHouse/ClickHouse/pull/12397) ([Mike](https://github.com/myrrc)).
* Избегает возникновения исключения при использовании отрицательной или числа с плавающей запятой в условии WHERE для индексированных таблиц. Это исправляет [#11905](https://github.com/ClickHouse/ClickHouse/issues/11905). [#12384](https://github.com/ClickHouse/ClickHouse/pull/12384) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Разрешено выполнять CLEAR для столбца, даже если существуют зависящие от него выражения DEFAULT. Это исправляет [#12333](https://github.com/ClickHouse/ClickHouse/issues/12333). [#12378](https://github.com/ClickHouse/ClickHouse/pull/12378) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена работа `TOTALS`/`ROLLUP`/`CUBE` для агрегатных функций с аргументами `-State` и `Nullable`. Это исправляет [#12163](https://github.com/ClickHouse/ClickHouse/issues/12163). [#12376](https://github.com/ClickHouse/ClickHouse/pull/12376) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка SIGSEGV, возникавшая при наличии сообщения с ошибкой в середине пакета в `Kafka` Engine. [#12302](https://github.com/ClickHouse/ClickHouse/pull/12302) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено поведение в случае, когда движок `SummingMergeTree` суммирует столбцы из ключа партиционирования. Добавлено исключение на случай, когда явно указанные для суммирования столбцы пересекаются со столбцами ключа партиционирования. Это исправляет [#7867](https://github.com/ClickHouse/ClickHouse/issues/7867). [#12173](https://github.com/ClickHouse/ClickHouse/pull/12173) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлено преобразование запроса, отправляемого во внешние СУБД (например, MySQL, ODBC) при наличии псевдонимов. Это устраняет проблему [#12032](https://github.com/ClickHouse/ClickHouse/issues/12032). [#12151](https://github.com/ClickHouse/ClickHouse/pull/12151) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка, приводившая к некорректным метаданным таблиц в ZooKeeper для таблиц ReplicatedVersionedCollapsingMergeTree. Исправляет [#12093](https://github.com/ClickHouse/ClickHouse/issues/12093). [#12121](https://github.com/ClickHouse/ClickHouse/pull/12121) ([alesapin](https://github.com/alesapin)).
* Исправлено излишнее ограничение числа потоков для запросов `SELECT` из `VIEW`. Исправляет [#11937](https://github.com/ClickHouse/ClickHouse/issues/11937). [#12085](https://github.com/ClickHouse/ClickHouse/pull/12085) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено падение при выполнении `JOIN` с типом `LowCardinality` и `join_algorithm=partial_merge`. [#12035](https://github.com/ClickHouse/ClickHouse/pull/12035) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлен неверный результат работы `if()` при использовании NULL в условии. [#11807](https://github.com/ClickHouse/ClickHouse/pull/11807) ([Artem Zuikov](https://github.com/4ertus2)).

#### Улучшение производительности {#performance-improvement-8}

- Индекс не использовался для оператора IN с литералами, регрессия производительности введена в версии v19.3. Исправляет [#10574](https://github.com/ClickHouse/ClickHouse/issues/10574). [#12062](https://github.com/ClickHouse/ClickHouse/pull/12062) ([nvartolomei](https://github.com/nvartolomei)).

#### Улучшение сборки/тестирования/упаковки {#buildtestingpackaging-improvement-10}

- Установка `ca-certificates` перед первым выполнением `apt-get update` в Dockerfile. [#12095](https://github.com/ClickHouse/ClickHouse/pull/12095) ([Ivan Blinkov](https://github.com/blinkov)).

### Релиз ClickHouse v20.5.2.7-stable 2020-07-02 {#clickhouse-release-v20527-stable-2020-07-02}

#### Обратно несовместимое изменение {#backward-incompatible-change-7}

- Возврат не-Nullable результата из COUNT(DISTINCT) и семейства агрегатных функций `uniq`. Если все переданные значения NULL, возвращается ноль. Это улучшает совместимость с SQL. [#11661](https://github.com/ClickHouse/ClickHouse/pull/11661) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлена проверка для случая, когда пользовательская настройка указана в неправильном месте. Пользовательские настройки должны быть указаны в `users.xml` внутри секции `<profile>` для конкретного профиля пользователя (или в `<default>` для настроек по умолчанию). Сервер не запустится и выведет сообщение об исключении в лог. Исправляет [#9051](https://github.com/ClickHouse/ClickHouse/issues/9051). Если вы хотите пропустить проверку, можно либо переместить настройки в соответствующее место, либо добавить `<skip_check_for_incorrect_settings>1</skip_check_for_incorrect_settings>` в config.xml. [#11449](https://github.com/ClickHouse/ClickHouse/pull/11449) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Настройка `input_format_with_names_use_header` включена по умолчанию. Это повлияет на парсинг входных форматов `-WithNames` и `-WithNamesAndTypes`. [#10937](https://github.com/ClickHouse/ClickHouse/pull/10937) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Удалена настройка `experimental_use_processors`. Она включена по умолчанию. [#10924](https://github.com/ClickHouse/ClickHouse/pull/10924) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Обновление `zstd` до версии 1.4.4. Включает незначительные улучшения производительности и степени сжатия. Если вы запускаете реплики с разными версиями ClickHouse, могут появиться информативные сообщения об ошибках `Data after merge is not byte-identical to data on another replicas.` с пояснением. Эти сообщения нормальны, беспокоиться не стоит. Изменение обратно совместимо, но мы указываем его здесь в журнале изменений на случай, если вы будете задаваться вопросом об этих сообщениях. [#10663](https://github.com/ClickHouse/ClickHouse/pull/10663) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлена проверка на бессмысленные кодеки и настройка `allow_suspicious_codecs` для управления этой проверкой. Закрывает [#4966](https://github.com/ClickHouse/ClickHouse/issues/4966). [#10645](https://github.com/ClickHouse/ClickHouse/pull/10645) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Несколько настроек Kafka изменили свои значения по умолчанию. См. [#11388](https://github.com/ClickHouse/ClickHouse/pull/11388).
- При обновлении с версий старше 20.5, если выполняется последовательное обновление и кластер содержит как версии 20.5 или выше, так и версии ниже 20.5, перезапуск узлов ClickHouse со старыми версиями в присутствии более новых версий может привести к ошибкам `Part ... intersects previous part`. Чтобы предотвратить эту ошибку, сначала установите более новые пакеты clickhouse-server на всех узлах кластера, а затем выполните перезапуски (таким образом, при перезапуске clickhouse-server запустится с новой версией).

#### Новая функциональность {#new-feature-7}


* `TTL DELETE WHERE` и `TTL GROUP BY` для автоматического укрупнения данных и роллапа в таблицах. [#10537](https://github.com/ClickHouse/ClickHouse/pull/10537) ([expl0si0nn](https://github.com/expl0si0nn)).
* Реализация протокола взаимодействия PostgreSQL. [#10242](https://github.com/ClickHouse/ClickHouse/pull/10242) ([Movses](https://github.com/MovElb)).
* Добавлены системные таблицы для пользователей, ролей, привилегий, профилей настроек, квот, политик строк; добавлены команды SHOW USER, SHOW [CURRENT|ENABLED] ROLES, SHOW SETTINGS PROFILES. [#10387](https://github.com/ClickHouse/ClickHouse/pull/10387) ([Vitaly Baranov](https://github.com/vitlibar)).
* Запись поддерживается в функции таблицы ODBC [#10554](https://github.com/ClickHouse/ClickHouse/pull/10554) ([ageraab](https://github.com/ageraab)). [#10901](https://github.com/ClickHouse/ClickHouse/pull/10901) ([tavplubix](https://github.com/tavplubix)).
* Добавлены метрики производительности запросов на основе Linux `perf_events` (эти метрики вычисляются с использованием аппаратных счетчиков ЦП и счетчиков операционной системы). Это необязательная возможность; для её использования требуется задать `CAP_SYS_ADMIN` для бинарного файла clickhouse. [#9545](https://github.com/ClickHouse/ClickHouse/pull/9545) [Andrey Skobtsov](https://github.com/And42). [#11226](https://github.com/ClickHouse/ClickHouse/pull/11226) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Теперь в запросе `CREATE` поддерживаются модификаторы `NULL` и `NOT NULL` для типов данных. [#11057](https://github.com/ClickHouse/ClickHouse/pull/11057) ([Павел Потемкин](https://github.com/Potya)).
* Добавлены форматы ввода и вывода `ArrowStream`. [#11088](https://github.com/ClickHouse/ClickHouse/pull/11088) ([hcz](https://github.com/hczhcz)).
* Добавлена поддержка Cassandra в качестве внешнего источника словарей. [#4978](https://github.com/ClickHouse/ClickHouse/pull/4978) ([favstovol](https://github.com/favstovol)).
* Добавлен новый макет `direct`, который загружает все данные напрямую из источника для каждого запроса, без сохранения или кеширования. [#10622](https://github.com/ClickHouse/ClickHouse/pull/10622) ([Artem Streltsov](https://github.com/kekekekule)).
* Добавлена новая схема `complex_key_direct` для словарей, которая не хранит данные локально во время выполнения запроса. [#10850](https://github.com/ClickHouse/ClickHouse/pull/10850) ([Artem Streltsov](https://github.com/kekekekule)).
* Добавлена поддержка синтаксиса глобальных переменных в стиле MySQL (пока в виде заглушки). Это необходимо для совместимости с протоколом MySQL. [#11832](https://github.com/ClickHouse/ClickHouse/pull/11832) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена подсветка синтаксиса в `clickhouse-client` с помощью `replxx`. [#11422](https://github.com/ClickHouse/ClickHouse/pull/11422) ([Tagir Kuskarov](https://github.com/kuskarov)).
* Добавлены функции `minMap` и `maxMap`. [#11603](https://github.com/ClickHouse/ClickHouse/pull/11603) ([Ildus Kurbangaliev](https://github.com/ildus)).
* Добавлена таблица `system.asynchronous_metric_log`, в которую записываются исторические метрики из `system.asynchronous_metrics`. [#11588](https://github.com/ClickHouse/ClickHouse/pull/11588) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Добавлены функции `extractAllGroupsHorizontal(haystack, re)` и `extractAllGroupsVertical(haystack, re)`. [#11554](https://github.com/ClickHouse/ClickHouse/pull/11554) ([Vasily Nemkov](https://github.com/Enmk)).
* Добавлены запросы SHOW CLUSTER(S). [#11467](https://github.com/ClickHouse/ClickHouse/pull/11467) ([hexiaoting](https://github.com/hexiaoting)).
* Добавлена функция `netloc` для извлечения сетевого расположения, аналогично `urlparse(url)`, полю `netloc` в Python. [#11356](https://github.com/ClickHouse/ClickHouse/pull/11356) ([Guillaume Tassery](https://github.com/YiuRULE)).
* Добавлены ещё два виртуальных столбца для `engine=Kafka` для доступа к заголовкам сообщений. [#11283](https://github.com/ClickHouse/ClickHouse/pull/11283) ([filimonov](https://github.com/filimonov)).
* Добавлен виртуальный столбец `_timestamp_ms` для движка Kafka (тип — `Nullable(DateTime64(3))`). [#11260](https://github.com/ClickHouse/ClickHouse/pull/11260) ([filimonov](https://github.com/filimonov)).
* Добавлена функция `randomFixedString`. [#10866](https://github.com/ClickHouse/ClickHouse/pull/10866) ([Andrei Nekrashevich](https://github.com/xolm)).
* Добавлена функция `fuzzBits`, которая случайным образом меняет биты в строке с заданной вероятностью. [#11237](https://github.com/ClickHouse/ClickHouse/pull/11237) ([Andrei Nekrashevich](https://github.com/xolm)).
* Разрешено сравнение чисел с константной строкой в операторах сравнения, а также в секциях IN и VALUES. [#11647](https://github.com/ClickHouse/ClickHouse/pull/11647) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлен режим балансировки нагрузки `round_robin`. [#11645](https://github.com/ClickHouse/ClickHouse/pull/11645) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена настройка `cast_keep_nullable`. Если она включена, `CAST(something_nullable AS Type)` возвращает `Nullable(Type)`. [#11733](https://github.com/ClickHouse/ClickHouse/pull/11733) ([Artem Zuikov](https://github.com/4ertus2)).
* Добавлен столбец `position` в таблицу `system.columns` и столбец `column_position` в таблицу `system.parts_columns`. Он содержит порядковый номер столбца в таблице, начиная с 1. Это закрывает [#7744](https://github.com/ClickHouse/ClickHouse/issues/7744). [#11655](https://github.com/ClickHouse/ClickHouse/pull/11655) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Поддержка ON CLUSTER для команд SYSTEM `{FLUSH DISTRIBUTED, STOP/START DISTRIBUTED SEND}`. [#11415](https://github.com/ClickHouse/ClickHouse/pull/11415) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена таблица `system.distribution_queue`. [#11394](https://github.com/ClickHouse/ClickHouse/pull/11394) ([Azat Khuzhin](https://github.com/azat)).
* Поддержка всех настроек формата в Kafka, часть настроек доступна на уровне таблицы, значения по умолчанию скорректированы для повышения производительности. [#11388](https://github.com/ClickHouse/ClickHouse/pull/11388) ([filimonov](https://github.com/filimonov)).
* Добавлена функция `port` (для извлечения номера порта из URL). [#11120](https://github.com/ClickHouse/ClickHouse/pull/11120) ([Azat Khuzhin](https://github.com/azat)).
* Теперь функции `dictGet*` принимают названия таблиц. [#11050](https://github.com/ClickHouse/ClickHouse/pull/11050) ([Vitaly Baranov](https://github.com/vitlibar)).
* Утилита `clickhouse-format` теперь умеет форматировать несколько запросов при использовании аргумента `-n`. [#10852](https://github.com/ClickHouse/ClickHouse/pull/10852) ([Darío](https://github.com/dgrr)).
* Добавлена возможность настраивать proxy-resolver для DiskS3. [#10744](https://github.com/ClickHouse/ClickHouse/pull/10744) ([Pavel Kovalenko](https://github.com/Jokser)).
* Функция `pointInPolygon` теперь поддерживает неконстантные полигоны. PointInPolygon теперь может принимать в качестве второго аргумента Array(Array(Tuple(..., ...))) — массив, описывающий полигон и его отверстия. [#10623](https://github.com/ClickHouse/ClickHouse/pull/10623) ([Alexey Ilyukhov](https://github.com/livace)) [#11421](https://github.com/ClickHouse/ClickHouse/pull/11421) ([Alexey Ilyukhov](https://github.com/livace)).
* В `system.parts` добавлено поле `move_ttl_info`, позволяющее просматривать состояние механизма move TTL. [#10591](https://github.com/ClickHouse/ClickHouse/pull/10591) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Возможность работы с S3 через прокси. [#10576](https://github.com/ClickHouse/ClickHouse/pull/10576) ([Pavel Kovalenko](https://github.com/Jokser)).
* Добавлены синонимы типов данных `NCHAR` и `NVARCHAR`. [#11025](https://github.com/ClickHouse/ClickHouse/pull/11025) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Решена задача [#7224](https://github.com/ClickHouse/ClickHouse/issues/7224): в таблицу `system.events` добавлены метрики `FailedQuery`, `FailedSelectQuery` и `FailedInsertQuery`. [#11151](https://github.com/ClickHouse/ClickHouse/pull/11151) ([Nikita Orlov](https://github.com/naorlov)).
* Добавлены дополнительные показатели `jemalloc` в `system.asynchronous_metrics` и гарантировано отображение их актуальных значений. [#11748](https://github.com/ClickHouse/ClickHouse/pull/11748) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Добавлена возможность задавать учетные данные S3 по умолчанию и пользовательские заголовки аутентификации. [#11134](https://github.com/ClickHouse/ClickHouse/pull/11134) ([Grigory Pervakov](https://github.com/GrigoryPervakov)).
* Добавлены новые функции для импорта и экспорта `DateTime64` как `Int64` с различной точностью: `to-/fromUnixTimestamp64Milli/-Micro/-Nano`. [#10923](https://github.com/ClickHouse/ClickHouse/pull/10923) ([Vasily Nemkov](https://github.com/Enmk)).
* Добавлена возможность указывать URI `mongodb://` для словарей MongoDB. [#10915](https://github.com/ClickHouse/ClickHouse/pull/10915) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Ключевое слово OFFSET теперь можно использовать без связанного с ним предложения LIMIT. [#10802](https://github.com/ClickHouse/ClickHouse/pull/10802) ([Guillaume Tassery](https://github.com/YiuRULE)).
* Добавлена таблица `system.licenses`. Эта таблица содержит лицензии сторонних библиотек, которые находятся в каталоге `contrib`. Этот коммит закрывает [#2890](https://github.com/ClickHouse/ClickHouse/issues/2890). [#10795](https://github.com/ClickHouse/ClickHouse/pull/10795) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Новая функция toStartOfSecond(DateTime64) -&gt; DateTime64, которая обнуляет долю секунды в значении DateTime64. [#10722](https://github.com/ClickHouse/ClickHouse/pull/10722) ([Vasily Nemkov](https://github.com/Enmk)).
* Добавлен новый формат ввода `JSONAsString`, который принимает последовательность JSON-объектов, разделённых переводами строк, пробелами и/или запятыми. [#10607](https://github.com/ClickHouse/ClickHouse/pull/10607) ([Kruglov Pavel](https://github.com/Avogar)).
* Разрешена профилировка памяти с более мелким шагом, чем 4 MiB. Добавлен выборочный профилировщик памяти для отслеживания случайных выделений и освобождений. [#10598](https://github.com/ClickHouse/ClickHouse/pull/10598) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `SimpleAggregateFunction` теперь также поддерживает `sumMap`. [#10000](https://github.com/ClickHouse/ClickHouse/pull/10000) ([Ildus Kurbangaliev](https://github.com/ildus)).
* Реализована поддержка `ALTER RENAME COLUMN` для движка Distributed. Продолжение [#10727](https://github.com/ClickHouse/ClickHouse/issues/10727). Исправляет [#10747](https://github.com/ClickHouse/ClickHouse/issues/10747). [#10887](https://github.com/ClickHouse/ClickHouse/pull/10887) ([alesapin](https://github.com/alesapin)).

#### Исправление ошибок {#bug-fix-27}


* Исправлен отчёт UBSan при разборе Decimal. Это исправляет [#7540](https://github.com/ClickHouse/ClickHouse/issues/7540). [#10512](https://github.com/ClickHouse/ClickHouse/pull/10512) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена потенциальная ошибка вычислений с плавающей запятой при разборе DateTime64. Это устраняет [#11374](https://github.com/ClickHouse/ClickHouse/issues/11374). [#11875](https://github.com/ClickHouse/ClickHouse/pull/11875) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен редкий сбой, возникавший при использовании столбца типа `Nullable` в условии PREWHERE. [#11895](https://github.com/ClickHouse/ClickHouse/pull/11895) [#11608](https://github.com/ClickHouse/ClickHouse/issues/11608) [#11869](https://github.com/ClickHouse/ClickHouse/pull/11869) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Запрещён вызов `arrayJoin` внутри функций высшего порядка. Это приводило к нарушению синхронизации протокола. Исправляет [#3933](https://github.com/ClickHouse/ClickHouse/issues/3933). [#11846](https://github.com/ClickHouse/ClickHouse/pull/11846) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен неверный результат сравнения `FixedString` с константой типа `String`. Это исправляет [#11393](https://github.com/ClickHouse/ClickHouse/issues/11393). Эта ошибка появилась в версии 20.4. [#11828](https://github.com/ClickHouse/ClickHouse/pull/11828) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен неверный результат функции `if` при использовании NULL в условии. [#11807](https://github.com/ClickHouse/ClickHouse/pull/11807) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлена ошибка с чрезмерным использованием потоков при выполнении запросов. [#11788](https://github.com/ClickHouse/ClickHouse/pull/11788) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено исключение `Scalar does not exist` при использовании `WITH &lt;scalar subquery&gt; ...` в `SELECT ... FROM merge_tree_table ...` [#11621](https://github.com/ClickHouse/ClickHouse/issues/11621). [#11767](https://github.com/ClickHouse/ClickHouse/pull/11767) ([Amos Bird](https://github.com/amosbird)).
* Исправлено некорректное поведение запросов вроде `SELECT *, xyz.*`, которые выполнялись успешно, хотя должна была возвращаться ошибка. [#11753](https://github.com/ClickHouse/ClickHouse/pull/11753) ([hexiaoting](https://github.com/hexiaoting)).
* Теперь реплицированные выборки будут отменяться во время изменения метаданных. [#11744](https://github.com/ClickHouse/ClickHouse/pull/11744) ([alesapin](https://github.com/alesapin)).
* Разбирать метаданные, хранящиеся в ZooKeeper, перед проверкой на равенство. [#11739](https://github.com/ClickHouse/ClickHouse/pull/11739) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка LOGICAL&#95;ERROR, вызванная некорректным выводом типа сложных литералов во входном формате Values. [#11732](https://github.com/ClickHouse/ClickHouse/pull/11732) ([tavplubix](https://github.com/tavplubix)).
* Исправлена работа `ORDER BY ... WITH FILL` с константными столбцами. [#11697](https://github.com/ClickHouse/ClickHouse/pull/11697) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено крайне редкое состояние гонки в `SYSTEM SYNC REPLICA`. Если реплицируемая таблица создаётся и в то же самое время из отдельного соединения другой клиент выполняет команду `SYSTEM SYNC REPLICA` для этой таблицы (что маловероятно, потому что другой клиент должен знать, что таблица создаётся), возможно разыменование нулевого указателя. [#11691](https://github.com/ClickHouse/ClickHouse/pull/11691) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Передавать корректные значения таймаутов при обмене данными с XDBC bridge. Ранее таймауты не учитывались при проверке работоспособности bridge и получении метаинформации. [#11690](https://github.com/ClickHouse/ClickHouse/pull/11690) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена работа `LIMIT n WITH TIES` при использовании с оператором `ORDER BY`, который содержит псевдонимы. [#11689](https://github.com/ClickHouse/ClickHouse/pull/11689) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена возможная ситуация «Pipeline stuck» для запросов `SELECT` с параллельным `FINAL`. Исправлено [#11636](https://github.com/ClickHouse/ClickHouse/issues/11636). [#11682](https://github.com/ClickHouse/ClickHouse/pull/11682) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, приводившая к некорректному состоянию `system.mutations`. Она могла показывать, что вся мутация уже завершена, хотя на сервере всё ещё есть задачи `MUTATE_PART` в очереди репликации, и он продолжает пытаться их выполнить. Это исправляет [#11611](https://github.com/ClickHouse/ClickHouse/issues/11611). [#11681](https://github.com/ClickHouse/ClickHouse/pull/11681) ([alesapin](https://github.com/alesapin)).
* Исправлена подсветка синтаксиса в запросе CREATE USER. [#11664](https://github.com/ClickHouse/ClickHouse/pull/11664) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка регулярных выражений с флагами, не учитывающими регистр. Это исправляет [#11101](https://github.com/ClickHouse/ClickHouse/issues/11101) и [#11506](https://github.com/ClickHouse/ClickHouse/issues/11506). [#11649](https://github.com/ClickHouse/ClickHouse/pull/11649) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Удалена оптимизация тривиальных запросов `count`, если настроена построчная (row-level) безопасность. В предыдущих версиях пользователь получал общее количество записей в таблице вместо отфильтрованного. Исправляет [#11352](https://github.com/ClickHouse/ClickHouse/issues/11352). [#11644](https://github.com/ClickHouse/ClickHouse/pull/11644) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены bloom-фильтры для `String` (индексы пропуска данных). [#11638](https://github.com/ClickHouse/ClickHouse/pull/11638) ([Azat Khuzhin](https://github.com/azat)).
* Без опции `-q` база данных не создаётся при запуске. [#11604](https://github.com/ClickHouse/ClickHouse/pull/11604) ([giordyb](https://github.com/giordyb)).
* Исправлена ошибка `Block structure mismatch` для запросов с выборкой (`SAMPLE`), читающих из таблицы `Buffer`. [#11602](https://github.com/ClickHouse/ClickHouse/pull/11602) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен некорректный код выхода `clickhouse-client` при `exception.code() % 256 == 0`. [#11601](https://github.com/ClickHouse/ClickHouse/pull/11601) ([filimonov](https://github.com/filimonov)).
* Исправлены состояния гонки при `CREATE`/`DROP` разных реплик `ReplicatedMergeTree`. Сервер продолжает работу, даже если таблица была не полностью удалена из ZooKeeper или не была успешно создана. Это исправление для [#11432](https://github.com/ClickHouse/ClickHouse/issues/11432). [#11592](https://github.com/ClickHouse/ClickHouse/pull/11592) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена тривиальная ошибка в сообщении журнала «Mark cache size was lowered» при запуске сервера. Закрывает [#11399](https://github.com/ClickHouse/ClickHouse/issues/11399). [#11589](https://github.com/ClickHouse/ClickHouse/pull/11589) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка `Size of offsets does not match size of column` в запросах с `PREWHERE column in (subquery)` и `ARRAY JOIN`. [#11580](https://github.com/ClickHouse/ClickHouse/pull/11580) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен редкий segfault в `SHOW CREATE TABLE`. Исправляет [#11490](https://github.com/ClickHouse/ClickHouse/issues/11490). [#11579](https://github.com/ClickHouse/ClickHouse/pull/11579) ([tavplubix](https://github.com/tavplubix)).
* Все запросы в HTTP-сессии имели один и тот же `query_id`. Ошибка исправлена. [#11578](https://github.com/ClickHouse/ClickHouse/pull/11578) ([tavplubix](https://github.com/tavplubix)).
* Теперь Docker-контейнер clickhouse-server будет предпочитать IPv6 при проверке доступности сервера. [#11550](https://github.com/ClickHouse/ClickHouse/pull/11550) ([Ivan Starkov](https://github.com/istarkov)).
* Исправлена ошибка `Data compressed with different methods`, которая могла возникать при включённом `min_bytes_to_use_direct_io`, активном PREWHERE и использовании SAMPLE или большого числа потоков. Это исправляет [#11539](https://github.com/ClickHouse/ClickHouse/issues/11539). [#11540](https://github.com/ClickHouse/ClickHouse/pull/11540) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены shard&#95;num/replica&#95;num для `<node>` (это нарушало работу use&#95;compact&#95;format&#95;in&#95;distributed&#95;parts&#95;names). [#11528](https://github.com/ClickHouse/ClickHouse/pull/11528) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена асинхронная вставка (INSERT) в Distributed для prefer&#95;localhost&#95;replica=0 и без internal&#95;replication. [#11527](https://github.com/ClickHouse/ClickHouse/pull/11527) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена утечка памяти при возникновении исключения в середине агрегации с функциями `-State`. Это исправляет [#8995](https://github.com/ClickHouse/ClickHouse/issues/8995). [#11496](https://github.com/ClickHouse/ClickHouse/pull/11496) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено исключение `Pipeline stuck` для `INSERT SELECT FINAL`, когда у `SELECT` (`max_threads`&gt;1) несколько потоков, а у `INSERT` только один (`max_insert_threads`==0). [#11455](https://github.com/ClickHouse/ClickHouse/pull/11455) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен некорректный результат в запросах вида `select count() from t, u`. [#11454](https://github.com/ClickHouse/ClickHouse/pull/11454) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлено возвращаемое значение размера сжатых данных для кодеков. [#11448](https://github.com/ClickHouse/ClickHouse/pull/11448) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено падение сервера, возникавшее при использовании у столбца кодека сжатия с нелитеральными аргументами. Исправляет [#11365](https://github.com/ClickHouse/ClickHouse/issues/11365). [#11431](https://github.com/ClickHouse/ClickHouse/pull/11431) ([alesapin](https://github.com/alesapin)).
* Исправлено потенциальное чтение неинициализированной памяти при завершении работы MergeTree, если таблицу не удалось создать. [#11420](https://github.com/ClickHouse/ClickHouse/pull/11420) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено падение при выполнении JOIN над `LowCarinality(T)` и `Nullable(T)`. [#11380](https://github.com/ClickHouse/ClickHouse/issues/11380). [#11414](https://github.com/ClickHouse/ClickHouse/pull/11414) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлен код ошибки для некорректного ключа `USING`. [#11373](https://github.com/ClickHouse/ClickHouse/issues/11373). [#11404](https://github.com/ClickHouse/ClickHouse/pull/11404) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлена функция `geohashesInBox` при аргументах вне допустимого диапазона широты/долготы. [#11403](https://github.com/ClickHouse/ClickHouse/pull/11403) ([Vasily Nemkov](https://github.com/Enmk)).
* Улучшены сообщения об ошибках для функции `joinGet()`. [#11389](https://github.com/ClickHouse/ClickHouse/pull/11389) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлена возможная ошибка `Pipeline stuck` для запросов с внешней сортировкой и LIMIT. Исправление для [#11359](https://github.com/ClickHouse/ClickHouse/issues/11359). [#11366](https://github.com/ClickHouse/ClickHouse/pull/11366) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Удалена избыточная блокировка при отправке кусков в ReplicatedMergeTree. [#11354](https://github.com/ClickHouse/ClickHouse/pull/11354) ([alesapin](https://github.com/alesapin)).
* Исправлена поддержка `\G` (вертикального вывода) в clickhouse-client в многострочном режиме. Это закрывает [#9933](https://github.com/ClickHouse/ClickHouse/issues/9933). [#11350](https://github.com/ClickHouse/ClickHouse/pull/11350) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена потенциальная ошибка сегментации при использовании базы данных `Lazy`. [#11348](https://github.com/ClickHouse/ClickHouse/pull/11348) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен сбой при прямых запросах к движку таблиц `Join` (без JOIN) и некорректная NULL-ность. [#11340](https://github.com/ClickHouse/ClickHouse/pull/11340) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлена ошибка, приводившая к сбою в `quantilesExactWeightedArray`. [#11337](https://github.com/ClickHouse/ClickHouse/pull/11337) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Теперь слияния останавливаются до изменения метаданных в запросах `ALTER`. [#11335](https://github.com/ClickHouse/ClickHouse/pull/11335) ([alesapin](https://github.com/alesapin)).
* Снова сделать запись в `MATERIALIZED VIEW` с настройкой `parallel_view_processing = 1` параллельной. Исправляет [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241). [#11330](https://github.com/ClickHouse/ClickHouse/pull/11330) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен `visitParamExtractRaw` для случая, когда извлечённый JSON содержит строки с несбалансированными &#123; или [. [#11318](https://github.com/ClickHouse/ClickHouse/pull/11318) ([Ewout](https://github.com/devwout)).
* Исправлена крайне редкая гонка данных в `ThreadPool`. [#11314](https://github.com/ClickHouse/ClickHouse/pull/11314) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена незначительная гонка данных в `clickhouse-copier`. Найдена интеграционными тестами. [#11313](https://github.com/ClickHouse/ClickHouse/pull/11313) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена потенциальная проблема с неинициализированной памятью при конвертации. Пример: `SELECT toIntervalSecond(now64())`. [#11311](https://github.com/ClickHouse/ClickHouse/pull/11311) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена проблема, из-за которой анализ индексов не работал, если в первичный ключ таблицы входил столбец типа Array и запрос фильтровал по этому столбцу с помощью функций `empty` или `notEmpty`. Исправляет [#11286](https://github.com/ClickHouse/ClickHouse/issues/11286). [#11303](https://github.com/ClickHouse/ClickHouse/pull/11303) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка, из-за которой оценка скорости выполнения запроса могла быть некорректной, и ограничение `min_execution_speed` могло не работать или работать неправильно, если запрос ограничивается настройками `max_network_bandwidth`, `max_execution_speed` или `priority`. Значение по умолчанию для `timeout_before_checking_execution_speed` изменено на ненулевое, потому что в противном случае настройки `min_execution_speed` и `max_execution_speed` не оказывают никакого эффекта. Это исправляет [#11297](https://github.com/ClickHouse/ClickHouse/issues/11297). Это исправляет [#5732](https://github.com/ClickHouse/ClickHouse/issues/5732). Это исправляет [#6228](https://github.com/ClickHouse/ClickHouse/issues/6228). Улучшение удобства использования: исключена конкатенация сообщения об исключении с индикатором прогресса в `clickhouse-client`. [#11296](https://github.com/ClickHouse/ClickHouse/pull/11296) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен сбой при вызове `SET DEFAULT ROLE` с некорректными аргументами. Это исправляет [#10586](https://github.com/ClickHouse/ClickHouse/issues/10586). [#11278](https://github.com/ClickHouse/ClickHouse/pull/11278) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен сбой при чтении некорректных данных в формате `Protobuf`. Исправляет [#5957](https://github.com/ClickHouse/ClickHouse/issues/5957), исправляет [#11203](https://github.com/ClickHouse/ClickHouse/issues/11203). [#11258](https://github.com/ClickHouse/ClickHouse/pull/11258) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена ошибка, при которой словарь `cache` мог возвращать значение по умолчанию вместо ожидаемого (когда есть только просроченные ключи). Это касается только строковых полей. [#11233](https://github.com/ClickHouse/ClickHouse/pull/11233) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена ошибка `Block structure mismatch in QueryPipeline` при чтении из `VIEW` с константами во внутреннем запросе. Исправляет [#11181](https://github.com/ClickHouse/ClickHouse/issues/11181). [#11205](https://github.com/ClickHouse/ClickHouse/pull/11205) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено возможное исключение `Invalid status for associated output`. [#11200](https://github.com/ClickHouse/ClickHouse/pull/11200) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Теперь `primary.idx` будет проверяться, если он указан в запросе `CREATE`. [#11199](https://github.com/ClickHouse/ClickHouse/pull/11199) ([alesapin](https://github.com/alesapin)).
* Исправлена возможная ошибка `Cannot capture column` для функций высшего порядка с захваченным аргументом типа `Array(Array(LowCardinality))`. [#11185](https://github.com/ClickHouse/ClickHouse/pull/11185) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена работа `S3` globbing, которая могла завершаться с ошибкой при наличии более чем 1000 ключей и некоторых бэкендов. [#11179](https://github.com/ClickHouse/ClickHouse/pull/11179) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Если индекс пропуска данных зависит от столбцов, которые будут изменены во время фонового слияния (для `SummingMergeTree`, `AggregatingMergeTree`, а также для `TTL GROUP BY`), он вычислялся некорректно. Эта проблема исправлена переносом вычисления индекса на этап после слияния, чтобы индекс рассчитывался по уже объединённым данным. [#11162](https://github.com/ClickHouse/ClickHouse/pull/11162) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено зависание, которое иногда происходило при выполнении `DROP` таблицы с движком `Kafka` (или при перезапуске сервера). [#11145](https://github.com/ClickHouse/ClickHouse/pull/11145) ([filimonov](https://github.com/filimonov)).
* Исправлено чрезмерное резервирование потоков для простых запросов (оптимизация по снижению числа потоков, частично сломанная после изменений в конвейере). [#11114](https://github.com/ClickHouse/ClickHouse/pull/11114) ([Azat Khuzhin](https://github.com/azat)).
* Удалено логирование при финализации мутаций, если в результате ничего не было финализировано. [#11109](https://github.com/ClickHouse/ClickHouse/pull/11109) ([alesapin](https://github.com/alesapin)).
* Исправлена взаимоблокировка при запуске сервера после обновления, изменяющего структуру таблиц системных логов. [#11106](https://github.com/ClickHouse/ClickHouse/pull/11106) ([alesapin](https://github.com/alesapin)).
* Исправлена утечка памяти в registerDiskS3. [#11074](https://github.com/ClickHouse/ClickHouse/pull/11074) ([Pavel Kovalenko](https://github.com/Jokser)).
* Исправлена ошибка `No such name in Block::erase()` при использовании JOIN с PREWHERE или когда `optimize_move_to_prewhere` переносит условие из WHERE в PREWHERE. [#11051](https://github.com/ClickHouse/ClickHouse/pull/11051) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлена потенциальная потеря данных при завершении работы таблицы движка Kafka. [#11048](https://github.com/ClickHouse/ClickHouse/pull/11048) ([filimonov](https://github.com/filimonov)).
* Исправлены ошибки разрешения аргументов функции parseDateTime64BestEffort. [#10925](https://github.com/ClickHouse/ClickHouse/issues/10925). [#11038](https://github.com/ClickHouse/ClickHouse/pull/11038) ([Vasily Nemkov](https://github.com/Enmk)).
* Теперь можно выполнять операции `ADD/DROP` и `RENAME` над одним и тем же столбцом в одном запросе `ALTER`. Сообщение об ошибке при одновременных операциях `MODIFY` и `RENAME` стало более понятным. Частично исправляет [#10669](https://github.com/ClickHouse/ClickHouse/issues/10669). [#11037](https://github.com/ClickHouse/ClickHouse/pull/11037) ([alesapin](https://github.com/alesapin)).
* Исправлен разбор URL-адресов S3. [#11036](https://github.com/ClickHouse/ClickHouse/pull/11036) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Исправлено отслеживание расхода памяти для двухуровневого `GROUP BY` при наличии `LIMIT`. [#11022](https://github.com/ClickHouse/ClickHouse/pull/11022) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена крайне редкая потенциальная ошибка use-after-free в MergeTree, возникающая в случае, если таблица не была успешно создана. [#10986](https://github.com/ClickHouse/ClickHouse/pull/10986) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена обработка метаданных (относительный путь при `RENAME`) и данных (относительный путь для `symlink`) в базе данных `Atomic`. [#10980](https://github.com/ClickHouse/ClickHouse/pull/10980) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен сбой сервера при одновременном выполнении запросов `ALTER` и `DROP DATABASE` в базе данных с движком `Atomic`. [#10968](https://github.com/ClickHouse/ClickHouse/pull/10968) ([tavplubix](https://github.com/tavplubix)).
* Исправлен некорректный размер «сырых» данных в методе getRawData(). [#10964](https://github.com/ClickHouse/ClickHouse/pull/10964) ([Igr](https://github.com/ObjatieGroba)).
* Исправлена несовместимость двухуровневой агрегации между версиями 20.1 и более ранними. Эта несовместимость возникает, когда на инициирующем узле и удалённых узлах используются разные версии ClickHouse, размер результата GROUP BY велик, а агрегация выполняется по одному полю типа String. Это приводит к нескольким неслиянным строкам для одного ключа в результате. [#10952](https://github.com/ClickHouse/ClickHouse/pull/10952) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Избегать отправки частично записанных файлов через DistributedBlockOutputStream. [#10940](https://github.com/ClickHouse/ClickHouse/pull/10940) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен сбой в `SELECT count(notNullIn(NULL, []))`. [#10920](https://github.com/ClickHouse/ClickHouse/pull/10920) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено зависание, которое иногда происходило при выполнении DROP таблицы с движком `Kafka` (или при перезапуске сервера). [#10910](https://github.com/ClickHouse/ClickHouse/pull/10910) ([filimonov](https://github.com/filimonov)).
* Теперь можно выполнять несколько операторов `ALTER RENAME`, например `a TO b, c TO a`. [#10895](https://github.com/ClickHouse/ClickHouse/pull/10895) ([alesapin](https://github.com/alesapin)).
* Исправлена возможная гонка, которая могла возникать при получении результата из состояния агрегатной функции из нескольких потоков для одного и того же столбца. Единственный сценарий (который мне удалось найти), при котором это может произойти, — использование функции `finalizeAggregation` при чтении из таблицы с движком `Memory`, который хранит состояние `AggregateFunction` для функции `quanite*`. [#10890](https://github.com/ClickHouse/ClickHouse/pull/10890) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена обратная совместимость с кортежами в распределённых таблицах. [#10889](https://github.com/ClickHouse/ClickHouse/pull/10889) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка SIGSEGV в StringHashTable (если такой ключ отсутствует). [#10870](https://github.com/ClickHouse/ClickHouse/pull/10870) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены зависания `WATCH` после удаления из базы данных таблицы `LiveView` с движком `Atomic`. [#10859](https://github.com/ClickHouse/ClickHouse/pull/10859) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка в `ReplicatedMergeTree`, из‑за которой некоторые запросы `ALTER` с `OPTIMIZE` могли зависать в ожидании реплики после того, как она становилась неактивной. [#10849](https://github.com/ClickHouse/ClickHouse/pull/10849) ([tavplubix](https://github.com/tavplubix)).
* Теперь ограничения обновляются, если столбец, участвующий в выражении `CONSTRAINT`, был переименован. Исправление для [#10844](https://github.com/ClickHouse/ClickHouse/issues/10844). [#10847](https://github.com/ClickHouse/ClickHouse/pull/10847) ([alesapin](https://github.com/alesapin)).
* Исправлено потенциальное чтение неинициализированной памяти в кэш-словаре. [#10834](https://github.com/ClickHouse/ClickHouse/pull/10834) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен порядок столбцов после Block::sortColumns() (также добавлен тест, показывающий, что это влияет на реальный сценарий использования — движок Buffer). [#10826](https://github.com/ClickHouse/ClickHouse/pull/10826) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема с ODBC bridge, возникавшая при отключённом экранировании идентификаторов. Это исправляет [#7984](https://github.com/ClickHouse/ClickHouse/issues/7984). [#10821](https://github.com/ClickHouse/ClickHouse/pull/10821) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены отчёты UBSan и MSan в DateLUT. [#10798](https://github.com/ClickHouse/ClickHouse/pull/10798) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Используйте `src_type` для корректного преобразования типов в условиях по ключу. Исправляет [#6287](https://github.com/ClickHouse/ClickHouse/issues/6287). [#10791](https://github.com/ClickHouse/ClickHouse/pull/10791) ([Andrew Onyshchuk](https://github.com/oandrew)).
* Удалены старые патчи для libunwind. [https://github.com/ClickHouse-Extras/libunwind/commit/500aa227911bd185a94bfc071d68f4d3b03cb3b1#r39048012](https://github.com/ClickHouse-Extras/libunwind/commit/500aa227911bd185a94bfc071d68f4d3b03cb3b1#r39048012) Это позволяет отключить `-fno-omit-frame-pointer` в сборках `clang`, что в среднем повышает производительность как минимум на 1%. [#10761](https://github.com/ClickHouse/ClickHouse/pull/10761) ([Amos Bird](https://github.com/amosbird)).
* Исправлена работа функции avgWeighted при использовании вещественных весов на нескольких шардах. [#10758](https://github.com/ClickHouse/ClickHouse/pull/10758) ([Baudouin Giard](https://github.com/bgiard)).
* Исправлено поведение `parallel_view_processing`. Теперь все вставки в `MATERIALIZED VIEW` в любом случае должны завершаться, даже если произошло исключение. Исправляет [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241). [#10757](https://github.com/ClickHouse/ClickHouse/pull/10757) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлены комбинаторы -OrNull и -OrDefault при использовании вместе с -State. [#10741](https://github.com/ClickHouse/ClickHouse/pull/10741) ([hcz](https://github.com/hczhcz)).
* Исправлено падение в `generateRandom` при работе с вложенными типами. Исправление для [#10583](https://github.com/ClickHouse/ClickHouse/issues/10583). [#10734](https://github.com/ClickHouse/ClickHouse/pull/10734) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена порча данных в ключевом столбце `LowCardinality(FixedString)` в `SummingMergeTree`, которая могла возникать после слияния. Исправляет [#10489](https://github.com/ClickHouse/ClickHouse/issues/10489). [#10721](https://github.com/ClickHouse/ClickHouse/pull/10721) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена работа с первичным ключом, обёрнутым в функцию, при использовании модификатора &#39;FINAL&#39; и оптимизации &#39;ORDER BY&#39;. [#10715](https://github.com/ClickHouse/ClickHouse/pull/10715) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена возможная переполнения буфера в функции `h3EdgeAngle`. [#10711](https://github.com/ClickHouse/ClickHouse/pull/10711) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено исчезновение totals. Totals могли отфильтровываться, если запрос содержал `JOIN` или подзапрос с внешним условием `WHERE`. Исправлена ошибка [#10674](https://github.com/ClickHouse/ClickHouse/issues/10674). [#10698](https://github.com/ClickHouse/ClickHouse/pull/10698) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена атомарность HTTP-вставки. Это исправляет [#9666](https://github.com/ClickHouse/ClickHouse/issues/9666). [#10687](https://github.com/ClickHouse/ClickHouse/pull/10687) ([Andrew Onyshchuk](https://github.com/oandrew)).
* Исправлена многократная проверка оператором `IN` с одним и тем же набором значений в рамках одного запроса. [#10686](https://github.com/ClickHouse/ClickHouse/pull/10686) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка, из-за которой HTTP-запросы зависали при закрытии клиента, когда `readonly=2` и `cancel_http_readonly_queries_on_client_close=1`. Исправлены [#7939](https://github.com/ClickHouse/ClickHouse/issues/7939), [#7019](https://github.com/ClickHouse/ClickHouse/issues/7019), [#7736](https://github.com/ClickHouse/ClickHouse/issues/7736), [#7091](https://github.com/ClickHouse/ClickHouse/issues/7091). [#10684](https://github.com/ClickHouse/ClickHouse/pull/10684) ([tavplubix](https://github.com/tavplubix)).
* Исправлен порядок параметров в конструкторе AggregateTransform. [#10667](https://github.com/ClickHouse/ClickHouse/pull/10667) ([palasonic1](https://github.com/palasonic1)).
* Исправлено отсутствие параллельного выполнения удалённых запросов при включённом параметре `distributed_aggregation_memory_efficient`. Исправляет [#10655](https://github.com/ClickHouse/ClickHouse/issues/10655). [#10664](https://github.com/ClickHouse/ClickHouse/pull/10664) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена возможная некорректность количества строк в результатах запросов с `LIMIT`. Исправлены [#10566](https://github.com/ClickHouse/ClickHouse/issues/10566), [#10709](https://github.com/ClickHouse/ClickHouse/issues/10709). [#10660](https://github.com/ClickHouse/ClickHouse/pull/10660) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, из-за которой блокировались параллельные операции `ALTER`, когда таблица содержит много кусков. [#10659](https://github.com/ClickHouse/ClickHouse/pull/10659) ([alesapin](https://github.com/alesapin)).
* Исправлена разыменовка nullptr в StorageBuffer, возникавшая при остановке сервера до запуска таблицы. [#10641](https://github.com/ClickHouse/ClickHouse/pull/10641) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена оптимизация предикатов для распределённых запросов (`enable_optimize_predicate_expression=1`) для запросов с секцией `HAVING` (т. е. когда требуется фильтрация на сервере-инициаторе) путём сохранения порядка выражений (чего достаточно для устранения проблемы), а также принудительного использования агрегатором имён столбцов вместо индексов. Исправления: [#10613](https://github.com/ClickHouse/ClickHouse/issues/10613), [#11413](https://github.com/ClickHouse/ClickHouse/issues/11413). [#10621](https://github.com/ClickHouse/ClickHouse/pull/10621) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа `optimize_skip_unused_shards` с `LowCardinality`. [#10611](https://github.com/ClickHouse/ClickHouse/pull/10611) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка сегментации в StorageBuffer при возникновении исключения во время запуска сервера. Исправляет [#10550](https://github.com/ClickHouse/ClickHouse/issues/10550). [#10609](https://github.com/ClickHouse/ClickHouse/pull/10609) ([tavplubix](https://github.com/tavplubix)).
* Запрос `SYSTEM DROP DNS CACHE` также удаляет кэши, используемые для проверки, разрешено ли пользователю подключаться с определённых IP-адресов. [#10608](https://github.com/ClickHouse/ClickHouse/pull/10608) ([tavplubix](https://github.com/tavplubix)).
* Исправлены некорректные скалярные результаты во внутреннем запросе `MATERIALIZED VIEW` в случае, когда этот запрос содержал зависимую таблицу. [#10603](https://github.com/ClickHouse/ClickHouse/pull/10603) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена работа condition variable для синхронных мутаций. В некоторых случаях сигналы этой condition variable могли теряться. [#10588](https://github.com/ClickHouse/ClickHouse/pull/10588) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Исправлено возможное падение при вызове `createDictionary()` до завершения выполнения `loadStoredObject()`. [#10587](https://github.com/ClickHouse/ClickHouse/pull/10587) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена ошибка «the BloomFilter false positive must be a double number between 0 and 1» [#10551](https://github.com/ClickHouse/ClickHouse/issues/10551). [#10569](https://github.com/ClickHouse/ClickHouse/pull/10569) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлен `SELECT` столбца с псевдонимом (`ALIAS`), у которого тип выражения по умолчанию отличался от типа столбца. [#10563](https://github.com/ClickHouse/ClickHouse/pull/10563) ([Azat Khuzhin](https://github.com/azat)).
* Реализовано сравнение между значениями `DateTime64` и `String` (как и для `DateTime`). [#10560](https://github.com/ClickHouse/ClickHouse/pull/10560) ([Vasily Nemkov](https://github.com/Enmk)).
* Исправлена порча индекса, которая в некоторых случаях могла возникать после слияния компактных частей в другую компактную часть. [#10531](https://github.com/ClickHouse/ClickHouse/pull/10531) ([Anton Popov](https://github.com/CurtizJ)).
* По умолчанию отключена оптимизация GROUP BY по sharding&#95;key (`optimize_distributed_group_by_sharding_key` была добавлена и по умолчанию выключена из‑за сложности анализа sharding&#95;key, простой пример — использование `if` в ключе шардирования), а также исправлена работа WITH ROLLUP/CUBE/TOTALS. [#10516](https://github.com/ClickHouse/ClickHouse/pull/10516) ([Azat Khuzhin](https://github.com/azat)).
* Исправления: [#10263](https://github.com/ClickHouse/ClickHouse/issues/10263) (после того PR отправка данных по Distributed через INSERT откладывалась при каждом INSERT). Исправления: [#8756](https://github.com/ClickHouse/ClickHouse/issues/8756) (тот PR ломает отправку по Distributed при одновременном выполнении всех следующих условий (на данный момент, полагаю, маловероятная конфигурация): `internal_replication == false`, несколько локальных шардов (активирует код с `hardlink`) и `distributed_storage_policy` (приводит к ошибке `EXDEV` при вызове `link(2)`)). [#10486](https://github.com/ClickHouse/ClickHouse/pull/10486) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, связанная с лимитом &quot;max&#95;rows&#95;to&#95;sort&quot;. [#10268](https://github.com/ClickHouse/ClickHouse/pull/10268) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Словарь запрашивается и проверка прав доступа выполняется только один раз для каждого вызова любой функции чтения внешних словарей. [#10928](https://github.com/ClickHouse/ClickHouse/pull/10928) ([Vitaly Baranov](https://github.com/vitlibar)).

#### Улучшения {#improvement-15}


* Применять `TTL` к старым данным после выполнения запроса `ALTER MODIFY TTL`. Это поведение управляется настройкой `materialize_ttl_after_modify`, которая включена по умолчанию. [#11042](https://github.com/ClickHouse/ClickHouse/pull/11042) ([Anton Popov](https://github.com/CurtizJ)).
* При разборе C‑подобных escape‑последовательностей с обратным слешем в строковых литералах, `VALUES` и различных текстовых форматах (это расширение стандарта SQL, характерное для ClickHouse и MySQL), следует сохранять обратный слеш, если обнаружена неизвестная escape‑последовательность (например, `\%` или `\w`). Это делает использование `LIKE` и регулярных выражений `match` более удобным (достаточно написать `name LIKE 'used\_cars'` вместо `name LIKE 'used\\_cars'`) и одновременно повышает совместимость. Это исправляет [#10922](https://github.com/ClickHouse/ClickHouse/issues/10922). [#11208](https://github.com/ClickHouse/ClickHouse/pull/11208) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* При чтении значения Decimal лишние цифры после десятичной точки отбрасываются. Такое поведение более совместимо с MySQL и PostgreSQL. Это исправляет [#10202](https://github.com/ClickHouse/ClickHouse/issues/10202). [#11831](https://github.com/ClickHouse/ClickHouse/pull/11831) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Разрешено выполнять DROP для реплицированной таблицы, если метаданные в ZooKeeper уже были удалены и больше не существуют (в том числе при использовании TestKeeper для тестирования и после перезапуска сервера). Разрешено выполнять RENAME для реплицированной таблицы, даже если возникла ошибка при взаимодействии с ZooKeeper. Это исправляет [#10720](https://github.com/ClickHouse/ClickHouse/issues/10720). [#11652](https://github.com/ClickHouse/ClickHouse/pull/11652) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Незначительно улучшена диагностика при чтении `Decimal` из строки. Исправляет [#10202](https://github.com/ClickHouse/ClickHouse/issues/10202). [#11829](https://github.com/ClickHouse/ClickHouse/pull/11829) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен вызов `sleep` в обработчике сигналов — он приостанавливал выполнение на меньшее время, чем ожидалось. [#11825](https://github.com/ClickHouse/ClickHouse/pull/11825) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* (Только Linux) Метрики производительности ОС (для CPU и I/O) будут работать даже без привилегии `CAP_NET_ADMIN`. [#10544](https://github.com/ClickHouse/ClickHouse/pull/10544) ([Alexander Kazakov](https://github.com/Akazz)).
* Добавлен псевдоним `hostname` для функции `hostName`. Эта возможность была предложена Виктором Тарнавским из Яндекс.Метрики. [#11821](https://github.com/ClickHouse/ClickHouse/pull/11821) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка распределённого `DDL` (update/delete/drop partition) в кластерах с кросс-репликацией. [#11703](https://github.com/ClickHouse/ClickHouse/pull/11703) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Выводить предупреждение вместо ошибки в серверный лог при старте, если не удаётся открыть один из `listen`‑адресов (например, IPv6 недоступен внутри Docker). Обратите внимание, что если серверу не удаётся открыть все указанные адреса, он, как и раньше, не запустится. Это исправляет [#4406](https://github.com/ClickHouse/ClickHouse/issues/4406). [#11687](https://github.com/ClickHouse/ClickHouse/pull/11687) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Создание пользователя и базы данных по умолчанию при запуске Docker-образа. [#10637](https://github.com/ClickHouse/ClickHouse/pull/10637) ([Paramtamtam](https://github.com/tarampampam)).
* Когда многострочный запрос выводится в серверный лог, строки склеиваются. Обеспечена корректная работа для многострочных строковых литералов, идентификаторов и однострочных комментариев. Исправляет [#3853](https://github.com/ClickHouse/ClickHouse/issues/3853). [#11686](https://github.com/ClickHouse/ClickHouse/pull/11686) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Теперь в командах разрешено указывать сразу несколько имён: CREATE USER, CREATE ROLE, ALTER USER, SHOW CREATE USER, SHOW GRANTS и так далее. [#11670](https://github.com/ClickHouse/ClickHouse/pull/11670) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена поддержка распределённого DDL (`UPDATE/DELETE/DROP PARTITION`) в кластерах с перекрёстной репликацией. [#11508](https://github.com/ClickHouse/ClickHouse/pull/11508) ([frank lee](https://github.com/etah000)).
* Очищается пароль в командной строке в `clickhouse-client` и `clickhouse-benchmark`, если пользователь указал его явным значением. Это предотвращает утечку пароля через `ps` и аналогичные инструменты. [#11665](https://github.com/ClickHouse/ClickHouse/pull/11665) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Не использовать отладочную информацию из ELF-файла, если она не соответствует выполняемому бинарному файлу. Это нужно, чтобы избежать вывода неверных имён функций и мест в исходном коде в трассировках стека. Исправляет [#7514](https://github.com/ClickHouse/ClickHouse/issues/7514). [#11657](https://github.com/ClickHouse/ClickHouse/pull/11657) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Возвращать NULL/ноль, если значение не удалось полностью разобрать в функциях parseDateTimeBestEffortOrNull/Zero. Это исправляет [#7876](https://github.com/ClickHouse/ClickHouse/issues/7876). [#11653](https://github.com/ClickHouse/ClickHouse/pull/11653) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Пропускать пустые параметры в запрашиваемом URL. Они могут появляться при использовании `http://localhost:8123/?&a=b` или `http://localhost:8123/?a=b&&c=d`. Это закрывает [#10749](https://github.com/ClickHouse/ClickHouse/issues/10749). [#11651](https://github.com/ClickHouse/ClickHouse/pull/11651) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Разрешено использование `groupArrayArray` и `groupUniqArrayArray` в качестве `SimpleAggregateFunction`. [#11650](https://github.com/ClickHouse/ClickHouse/pull/11650) ([Volodymyr Kuznetsov](https://github.com/ksvladimir)).
* Разрешено сравнение с константными строками за счёт неявных преобразований при анализе условий индекса для других типов. Это может закрыть [#11630](https://github.com/ClickHouse/ClickHouse/issues/11630). [#11648](https://github.com/ClickHouse/ClickHouse/pull/11648) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* [https://github.com/ClickHouse/ClickHouse/pull/7572#issuecomment-642815377](https://github.com/ClickHouse/ClickHouse/pull/7572#issuecomment-642815377) Поддержка конфигурации HTTP-обработчиков по умолчанию. [#11628](https://github.com/ClickHouse/ClickHouse/pull/11628) ([Winter Zhang](https://github.com/zhang2014)).
* Добавлено больше форматов ввода для работы с движком Kafka. Исправлена проблема с преждевременными сбросами. Исправлена проблема с производительностью, когда `kafka_num_consumers` больше количества партиций в топике. [#11599](https://github.com/ClickHouse/ClickHouse/pull/11599) ([filimonov](https://github.com/filimonov)).
* Улучшена логика `multiple_joins_rewriter_version=2`. Исправлена ошибка «unknown columns» для алиасов в лямбда-выражениях. [#11587](https://github.com/ClickHouse/ClickHouse/pull/11587) ([Artem Zuikov](https://github.com/4ertus2)).
* Улучшено сообщение об исключении, возникающем при невозможности разобрать список объявлений столбцов. Исправляет [#10403](https://github.com/ClickHouse/ClickHouse/issues/10403). [#11537](https://github.com/ClickHouse/ClickHouse/pull/11537) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Улучшена логика `enable_optimize_predicate_expression=1` для представлений (VIEW). [#11513](https://github.com/ClickHouse/ClickHouse/pull/11513) ([Artem Zuikov](https://github.com/4ertus2)).
* Добавлена поддержка PREWHERE в таблицах типа live view. [#11495](https://github.com/ClickHouse/ClickHouse/pull/11495) ([vzakaznikov](https://github.com/vzakaznikov)).
* Автоматически обновлять кэш DNS, который используется для проверки, разрешено ли пользователю подключаться с данного адреса. [#11487](https://github.com/ClickHouse/ClickHouse/pull/11487) ([tavplubix](https://github.com/tavplubix)).
* OPTIMIZE FINAL будет принудительно выполнять слияние, даже если выполняются параллельные слияния. Это закрывает задачи [#11309](https://github.com/ClickHouse/ClickHouse/issues/11309) и [#11322](https://github.com/ClickHouse/ClickHouse/issues/11322). [#11346](https://github.com/ClickHouse/ClickHouse/pull/11346) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Подавлен вывод результатов отменённых запросов в clickhouse-client. В предыдущих версиях результат мог продолжать выводиться в терминал даже после нажатия Ctrl+C для отмены запроса. Это закрывает [#9473](https://github.com/ClickHouse/ClickHouse/issues/9473). [#11342](https://github.com/ClickHouse/ClickHouse/pull/11342) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Теперь файл истории обновляется после каждого запроса, и больше нет состояния гонки, если несколько клиентов используют один файл истории. Это исправляет [#9897](https://github.com/ClickHouse/ClickHouse/issues/9897). [#11453](https://github.com/ClickHouse/ClickHouse/pull/11453) ([Tagir Kuskarov](https://github.com/kuskarov)).
* Более информативные сообщения в журнале при перезагрузке конфигурации. [#11341](https://github.com/ClickHouse/ClickHouse/pull/11341) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* В некоторых случаях убраны конечные пробелы в форматированных запросах в `clickhouse-client` и `clickhouse-format`. [#11325](https://github.com/ClickHouse/ClickHouse/pull/11325) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена настройка &quot;output&#95;format&#95;pretty&#95;max&#95;value&#95;width&quot;. Если значение длиннее, оно будет обрезано, чтобы избежать вывода слишком длинных значений в терминал. Это закрывает [#11140](https://github.com/ClickHouse/ClickHouse/issues/11140). [#11324](https://github.com/ClickHouse/ClickHouse/pull/11324) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Улучшено сообщение об исключении в случае нехватки сопоставлений памяти (memory mappings). Это закрывает [#11027](https://github.com/ClickHouse/ClickHouse/issues/11027). [#11316](https://github.com/ClickHouse/ClickHouse/pull/11316) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Поддержка (U)Int8, (U)Int16 и Date в ASOF JOIN. [#11301](https://github.com/ClickHouse/ClickHouse/pull/11301) ([Artem Zuikov](https://github.com/4ertus2)).
* Добавлена поддержка параметра kafka&#95;client&#95;id для таблиц Kafka. Также изменено значение по умолчанию параметра `client.id`, используемого ClickHouse при взаимодействии с Kafka, чтобы оно было более информативным и удобным. [#11252](https://github.com/ClickHouse/ClickHouse/pull/11252) ([filimonov](https://github.com/filimonov)).
* Сохранять значение метрики `DistributedFilesToInsert` при возникновении исключений. В предыдущих версиях значение устанавливалось, когда мы собирались отправить какие‑то файлы, но становилось нулевым, если происходило исключение и некоторые файлы всё ещё ожидали отправки. Теперь оно соответствует количеству файлов, ожидающих обработки в файловой системе. [#11220](https://github.com/ClickHouse/ClickHouse/pull/11220) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка многословных названий типов данных (таких как `DOUBLE PRECISION` и `CHAR VARYING`) для лучшей совместимости с SQL. [#11214](https://github.com/ClickHouse/ClickHouse/pull/11214) ([Павел Потемкин](https://github.com/Potya)).
* Добавлены синонимы для некоторых типов данных. [#10856](https://github.com/ClickHouse/ClickHouse/pull/10856) ([Павел Потемкин](https://github.com/Potya)).
* Журнал запросов теперь включён по умолчанию. [#11184](https://github.com/ClickHouse/ClickHouse/pull/11184) ([Ivan Blinkov](https://github.com/blinkov)).
* Отображать тип аутентификации в таблице system.users и при выполнении запроса SHOW CREATE USER. [#11080](https://github.com/ClickHouse/ClickHouse/pull/11080) ([Vitaly Baranov](https://github.com/vitlibar)).
* Удалено хранение данных при явном `DROP DATABASE` для движка базы данных `Memory`. Исправляет [#10557](https://github.com/ClickHouse/ClickHouse/issues/10557). [#11021](https://github.com/ClickHouse/ClickHouse/pull/11021) ([tavplubix](https://github.com/tavplubix)).
* Установлены имена для внутренних потоков библиотеки rdkafka. Логи из rdkafka теперь доступны в серверных логах. [#10983](https://github.com/ClickHouse/ClickHouse/pull/10983) ([Azat Khuzhin](https://github.com/azat)).
* Поддержка пробельных символов Unicode в запросах. Это помогает, когда запросы копируются из Word или с веб‑страницы. Это исправляет [#10896](https://github.com/ClickHouse/ClickHouse/issues/10896). [#10903](https://github.com/ClickHouse/ClickHouse/pull/10903) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Разрешено использование больших типов UInt в качестве индекса в функции `tupleElement`. [#10874](https://github.com/ClickHouse/ClickHouse/pull/10874) ([hcz](https://github.com/hczhcz)).
* Учитывать prefer&#95;localhost&#95;replica/load&#95;balancing при выполнении INSERT в Distributed. [#10867](https://github.com/ClickHouse/ClickHouse/pull/10867) ([Azat Khuzhin](https://github.com/azat)).
* Добавлены настройки `min_insert_block_size_rows_for_materialized_views`, `min_insert_block_size_bytes_for_materialized_views`. Эти настройки аналогичны `min_insert_block_size_rows` и `min_insert_block_size_bytes`, но применяются только к блокам, вставляемым в `MATERIALIZED VIEW`. Они помогают контролировать укрупнение блоков при записи в материальные представления и избегать избыточного потребления памяти. [#10858](https://github.com/ClickHouse/ClickHouse/pull/10858) ([Azat Khuzhin](https://github.com/azat)).
* Устранено исключение из реплицируемой очереди при остановке сервера. Исправляет [#10819](https://github.com/ClickHouse/ClickHouse/issues/10819). [#10841](https://github.com/ClickHouse/ClickHouse/pull/10841) ([alesapin](https://github.com/alesapin)).
* Обеспечивает, что `varSamp`, `varPop` не могут возвращать отрицательные результаты из‑за численных ошибок и что `stddevSamp`, `stddevPop` не могут вычисляться из отрицательной дисперсии. Это исправляет [#10532](https://github.com/ClickHouse/ClickHouse/issues/10532). [#10829](https://github.com/ClickHouse/ClickHouse/pull/10829) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Улучшено сообщение об исключении DNS. Исправляет проблему [#10813](https://github.com/ClickHouse/ClickHouse/issues/10813). [#10828](https://github.com/ClickHouse/ClickHouse/pull/10828) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Изменён HTTP-код ответа на 400 Bad Request при некоторых ошибках парсинга. Это исправляет [#10636](https://github.com/ClickHouse/ClickHouse/issues/10636). [#10640](https://github.com/ClickHouse/ClickHouse/pull/10640) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Выводить сообщение, если версия `clickhouse-client` новее, чем версия `clickhouse-server`. [#10627](https://github.com/ClickHouse/ClickHouse/pull/10627) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка запроса `INSERT INTO [db.]table WATCH`. [#10498](https://github.com/ClickHouse/ClickHouse/pull/10498) ([vzakaznikov](https://github.com/vzakaznikov)).
* Разрешена передача параметра quota&#95;key в clickhouse-client. Это закрывает [#10227](https://github.com/ClickHouse/ClickHouse/issues/10227). [#10270](https://github.com/ClickHouse/ClickHouse/pull/10270) ([alexey-milovidov](https://github.com/alexey-milovidov)).

#### Улучшение производительности {#performance-improvement-9}


* Позволяет нескольким репликам параллельно назначать слияния, мутации, удаление, перемещение и замену разделов. Это закрывает [#10367](https://github.com/ClickHouse/ClickHouse/issues/10367). [#11639](https://github.com/ClickHouse/ClickHouse/pull/11639) ([alexey-milovidov](https://github.com/alexey-milovidov)) [#11795](https://github.com/ClickHouse/ClickHouse/pull/11795) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Оптимизация `GROUP BY` с учётом ключа сортировки таблицы, включаемая настройкой `optimize_aggregation_in_order`. [#9113](https://github.com/ClickHouse/ClickHouse/pull/9113) ([dimarub2000](https://github.com/dimarub2000)).
* Запросы `SELECT ... FINAL` выполняются параллельно. Добавлена настройка `max_final_threads` для ограничения числа потоков. [#10463](https://github.com/ClickHouse/ClickHouse/pull/10463) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Улучшена производительность запросов INSERT через `INSERT SELECT` или INSERT с помощью clickhouse-client, когда генерируются небольшие блоки (типичный случай при параллельном разборе). Исправлена ошибка [#11275](https://github.com/ClickHouse/ClickHouse/issues/11275). Исправлена проблема, из-за которой CONSTRAINT не работали для полей с DEFAULT. Исправлена ошибка [#11273](https://github.com/ClickHouse/ClickHouse/issues/11273). Исправлена проблема, из-за которой CONSTRAINTS игнорировались для временных таблиц. Исправлена ошибка [#11274](https://github.com/ClickHouse/ClickHouse/issues/11274). [#11276](https://github.com/ClickHouse/ClickHouse/pull/11276) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Оптимизация, устраняющая агрегаторы min/max/any для ключей GROUP BY в секции SELECT, включается настройкой `optimize_aggregators_of_group_by_keys`. [#11667](https://github.com/ClickHouse/ClickHouse/pull/11667) ([xPoSx](https://github.com/xPoSx)). [#11806](https://github.com/ClickHouse/ClickHouse/pull/11806) ([Azat Khuzhin](https://github.com/azat)).
* Новая оптимизация, которая выносит все операции из функции `any`; включается настройкой `optimize_move_functions_out_of_any` [#11529](https://github.com/ClickHouse/ClickHouse/pull/11529) ([Ruslan](https://github.com/kamalov-ruslan)).
* Улучшена производительность `clickhouse-client` в интерактивном режиме при использовании Pretty-форматов. В предыдущих версиях заметная часть времени могла тратиться на вычисление видимой ширины строки в кодировке UTF-8. Это закрывает [#11323](https://github.com/ClickHouse/ClickHouse/issues/11323). [#11323](https://github.com/ClickHouse/ClickHouse/pull/11323) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Повышена производительность запросов с `ORDER BY` и небольшим `LIMIT` (меньше `max_block_size`). [#11171](https://github.com/ClickHouse/ClickHouse/pull/11171) ([Albert Kidrachev](https://github.com/Provet)).
* Добавлено определение возможностей CPU во время выполнения для выбора и использования наилучшей реализации функции. Добавлена поддержка генерации кода для нескольких целевых платформ. Закрывает [#1017](https://github.com/ClickHouse/ClickHouse/issues/1017). [#10058](https://github.com/ClickHouse/ClickHouse/pull/10058) ([DimasKovas](https://github.com/DimasKovas)).
* По умолчанию включено использование `mlock` для бинарного файла clickhouse. Это предотвращает выгрузку исполняемого файла clickhouse из памяти при высокой нагрузке на ввод-вывод. [#11139](https://github.com/ClickHouse/ClickHouse/pull/11139) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Запросы с агрегатной функцией `sum` без ключей GROUP BY выполняются в несколько раз быстрее. [#10992](https://github.com/ClickHouse/ClickHouse/pull/10992) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Улучшена поразрядная сортировка (используется в `ORDER BY` с простыми ключами) за счёт устранения некоторых избыточных перемещений данных. [#10981](https://github.com/ClickHouse/ClickHouse/pull/10981) ([Arslan Gumerov](https://github.com/g-arslan)).
* Сортировать более крупные части левой таблицы в MergeJoin. Буферизовать левые блоки в памяти. Добавлена настройка `partial_merge_join_left_table_buffer_bytes` для управления размерами буферов левых блоков. [#10601](https://github.com/ClickHouse/ClickHouse/pull/10601) ([Artem Zuikov](https://github.com/4ertus2)).
* Удалено дублирование `ORDER BY` и `DISTINCT` в подзапросах; эта оптимизация включается с помощью `optimize_duplicate_order_by_and_distinct` [#10067](https://github.com/ClickHouse/ClickHouse/pull/10067) ([Mikhail Malafeev](https://github.com/demo-99)).
* Эта функция устраняет использование других функций ключей в секции GROUP BY и включается с помощью `optimize_group_by_function_keys` [#10051](https://github.com/ClickHouse/ClickHouse/pull/10051) ([xPoSx](https://github.com/xPoSx)).
* Новая оптимизация, которая выносит арифметические операции из агрегатных функций, включается настройкой `optimize_arithmetic_operations_in_aggregate_functions` [#10047](https://github.com/ClickHouse/ClickHouse/pull/10047) ([Ruslan](https://github.com/kamalov-ruslan)).
* Использовать HTTP‑клиент для S3 на базе Poco вместо curl. Это улучшит производительность и снизит потребление памяти для хранилищ s3 и табличных функций. [#11230](https://github.com/ClickHouse/ClickHouse/pull/11230) ([Pavel Kovalenko](https://github.com/Jokser)).
* Исправлена проблема с производительностью Kafka, связанная с пересозданием расписания на основе лимитов, которые всегда применялись. [#11149](https://github.com/ClickHouse/ClickHouse/pull/11149) ([filimonov](https://github.com/filimonov)).
* Включена настройка percpu&#95;arena:percpu для jemalloc (это уменьшит фрагментацию памяти из‑за пула потоков). [#11084](https://github.com/ClickHouse/ClickHouse/pull/11084) ([Azat Khuzhin](https://github.com/azat)).
* Оптимизировано использование памяти при чтении ответа HTTP‑клиента S3. [#11561](https://github.com/ClickHouse/ClickHouse/pull/11561) ([Pavel Kovalenko](https://github.com/Jokser)).
* Изменены значения настроек Kafka по умолчанию для улучшения производительности. [#11388](https://github.com/ClickHouse/ClickHouse/pull/11388) ([filimonov](https://github.com/filimonov)).

#### Экспериментальная функциональность {#experimental-feature-5}

- Добавлены типы данных `Point` (Tuple(Float64, Float64)) и `Polygon` (Array(Array(Tuple(Float64, Float64))). [#10678](https://github.com/ClickHouse/ClickHouse/pull/10678) ([Alexey Ilyukhov](https://github.com/livace)).
- Добавлена функция `hasSubstr`, позволяющая искать подпоследовательности в массивах. Примечание: эта функция может быть переименована без предварительного уведомления. [#11071](https://github.com/ClickHouse/ClickHouse/pull/11071) ([Ryad Zenine](https://github.com/r-zenine)).
- Добавлена поддержка OpenCL и алгоритм битонической сортировки, который можно использовать для сортировки целочисленных данных в одном столбце. Требуется сборка с флагом `-DENABLE_OPENCL=1`. Для использования алгоритма битонической сортировки вместо других необходимо установить значение `bitonic_sort` для параметра `special_sort` и убедиться в доступности OpenCL. Данная функциональность не улучшает производительность и не предоставляет других преимуществ — она добавлена исключительно в качестве примера и для демонстрационных целей. Вероятно, она будет удалена в ближайшем будущем при отсутствии дальнейшей разработки в этом направлении. [#10232](https://github.com/ClickHouse/ClickHouse/pull/10232) ([Ri](https://github.com/margaritiko)).

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-11}


* Включена поддержка clang-tidy для программ и утилит. [#10991](https://github.com/ClickHouse/ClickHouse/pull/10991) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Убрана зависимость от `tzdata`: ClickHouse больше не завершает работу с ошибкой, если каталог `/usr/share/zoneinfo` не существует. Обратите внимание, что все часовые пояса в ClickHouse работают даже без установленного в системе tzdata. [#11827](https://github.com/ClickHouse/ClickHouse/pull/11827) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлены стресс‑тесты с MSan и UBSan. Обратите внимание, что у нас уже есть MSan и UBSan для функциональных тестов, а «stress»‑тест — это другой тип тестов. [#10871](https://github.com/ClickHouse/ClickHouse/pull/10871) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Выводит идентификатор сборки компилятора в сообщениях о сбоях. Это позволит нам быть немного более уверенными в том, какой бинарный файл аварийно завершился. Добавлена новая функция `buildId`. [#11824](https://github.com/ClickHouse/ClickHouse/pull/11824) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлен тест, проверяющий, что мутации продолжают работать после запроса FREEZE. [#11820](https://github.com/ClickHouse/ClickHouse/pull/11820) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Не допускайте тестов с подстрокой &quot;fail&quot; в их именах, потому что это делает просмотр результатов тестов в браузере менее удобным, когда вы нажимаете Ctrl+F и ищете &quot;fail&quot;. [#11817](https://github.com/ClickHouse/ClickHouse/pull/11817) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Удалены неиспользуемые импорты из HTTPHandlerFactory. [#11660](https://github.com/ClickHouse/ClickHouse/pull/11660) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлена рандомизация запусков copier, чтобы избежать ошибки `Too many simultaneous queries`. Также увеличен таймаут и снижена вероятность отказа. [#11573](https://github.com/ClickHouse/ClickHouse/pull/11573) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлено пропущенное подключение. [#11525](https://github.com/ClickHouse/ClickHouse/pull/11525) ([Matwey V. Kornilov](https://github.com/matwey)).
* Сборка ускорена за счёт удаления старых примеров программ. Также обнаружен один осиротевший функциональный тест. [#11486](https://github.com/ClickHouse/ClickHouse/pull/11486) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Увеличен размер ccache для сборок в CI. [#11450](https://github.com/ClickHouse/ClickHouse/pull/11450) ([alesapin](https://github.com/alesapin)).
* В deb-сборке оставлены только unit&#95;tests&#95;dbms. [#11429](https://github.com/ClickHouse/ClickHouse/pull/11429) ([Ilya Yatsishin](https://github.com/qoega)).
* Обновлена версия librdkafka до [1.4.2](https://github.com/edenhill/librdkafka/releases/tag/v1.4.2). [#11256](https://github.com/ClickHouse/ClickHouse/pull/11256) ([filimonov](https://github.com/filimonov)).
* Рефакторинг файлов сборки на CMake. [#11390](https://github.com/ClickHouse/ClickHouse/pull/11390) ([Ivan](https://github.com/abyss7)).
* Исправлены несколько «флапающих» интеграционных тестов. [#11355](https://github.com/ClickHouse/ClickHouse/pull/11355) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка модульных тестов, запускаемых с UBSan. [#11345](https://github.com/ClickHouse/ClickHouse/pull/11345) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Удалён лишний `timeout` из интеграционного теста `test_insertion_sync_fails_with_timeout`. [#11343](https://github.com/ClickHouse/ClickHouse/pull/11343) ([alesapin](https://github.com/alesapin)).
* Улучшена проверка висящих запросов в clickhouse-test. [#11321](https://github.com/ClickHouse/ClickHouse/pull/11321) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Выводить предупреждение, если сервер был собран в режиме `debug` или с санитайзерами. [#11304](https://github.com/ClickHouse/ClickHouse/pull/11304) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Теперь clickhouse-test проверяет, что сервер доступен, перед запуском тестов. [#11285](https://github.com/ClickHouse/ClickHouse/pull/11285) ([alesapin](https://github.com/alesapin)).
* Исправлен потенциально нестабильный тест `00731_long_merge_tree_select_opened_files.sh`. Он падает нечасто, но при экспериментировании с ThreadFuzzer в нём была обнаружена потенциальная гонка: [#9814](https://github.com/ClickHouse/ClickHouse/issues/9814) См. [ссылку](https://clickhouse-test-reports.s3.yandex.net/9814/40e3023e215df22985d275bf85f4d2290897b76b/functional_stateless_tests_\(unbundled\).html#fail1) для примера. [#11270](https://github.com/ClickHouse/ClickHouse/pull/11270) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Повторять тест в CI, если вызов `curl` завершился по таймауту. Это может происходить из-за зависаний системы на 10+ секунд, которые типичны для нашей CI-инфраструктуры. Исправляет [#11267](https://github.com/ClickHouse/ClickHouse/issues/11267). [#11268](https://github.com/ClickHouse/ClickHouse/pull/11268) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлен тест для движка таблиц Join от @donmikel. Закрывает [#9158](https://github.com/ClickHouse/ClickHouse/issues/9158). [#11265](https://github.com/ClickHouse/ClickHouse/pull/11265) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено несколько незначительных ошибок в модульных тестах. [#11262](https://github.com/ClickHouse/ClickHouse/pull/11262) ([alesapin](https://github.com/alesapin)).
* Теперь части команды компоновки для библиотеки `cctz` не будут перемешиваться с другими библиотеками. [#11213](https://github.com/ClickHouse/ClickHouse/pull/11213) ([alesapin](https://github.com/alesapin)).
* Директорию /programs/server разделили на собственно программу и библиотеку. [#11186](https://github.com/ClickHouse/ClickHouse/pull/11186) ([Ivan](https://github.com/abyss7)).
* Улучшены скрипты сборки для Protobuf и gRPC. [#11172](https://github.com/ClickHouse/ClickHouse/pull/11172) ([Vitaly Baranov](https://github.com/vitlibar)).
* Включен ранее не работавший тест производительности. [#11158](https://github.com/ClickHouse/ClickHouse/pull/11158) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Создайте корневой бакет S3 для тестов до запуска любого экземпляра ClickHouse. [#11142](https://github.com/ClickHouse/ClickHouse/pull/11142) ([Pavel Kovalenko](https://github.com/Jokser)).
* Добавлен тест производительности для непостоянных многоугольников. [#11141](https://github.com/ClickHouse/ClickHouse/pull/11141) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправление теста `00979_live_view_watch_continuous_aggregates`. [#11024](https://github.com/ClickHouse/ClickHouse/pull/11024) ([vzakaznikov](https://github.com/vzakaznikov)).
* Добавлена возможность запускать ZooKeeper в интеграционных тестах поверх tmpfs. [#11002](https://github.com/ClickHouse/ClickHouse/pull/11002) ([alesapin](https://github.com/alesapin)).
* Ожидание `odbc-bridge` с экспоненциальным бэкoффом. Предыдущее время ожидания 200 мс оказалось недостаточным в нашей CI-среде. [#10990](https://github.com/ClickHouse/ClickHouse/pull/10990) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен недетерминируемый тест. [#10989](https://github.com/ClickHouse/ClickHouse/pull/10989) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлен тест для пустых внешних данных. [#10926](https://github.com/ClickHouse/ClickHouse/pull/10926) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* База данных пересоздаётся для каждого теста. Это улучшает изоляцию тестов. [#10902](https://github.com/ClickHouse/ClickHouse/pull/10902) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* В код колонок добавлено больше assert-ов. [#10833](https://github.com/ClickHouse/ClickHouse/pull/10833) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Улучшено взаимодействие с санитайзерами. Выводится информация о `query_id` в сообщении об ошибке санитайзера. [#10832](https://github.com/ClickHouse/ClickHouse/pull/10832) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена очевидная гонка в проверке «Split build smoke test». [#10820](https://github.com/ClickHouse/ClickHouse/pull/10820) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен (ложноположительный) отчёт MSan в MergeTreeIndexFullText. Проблема впервые проявилась в [#9968](https://github.com/ClickHouse/ClickHouse/issues/9968). [#10801](https://github.com/ClickHouse/ClickHouse/pull/10801) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлено подавление MSan для клиентской библиотеки MariaDB. [#10800](https://github.com/ClickHouse/ClickHouse/pull/10800) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `GRPC make` не мог найти файлы `protobuf`, `Makefile` изменён с добавлением правильной ссылки. [#10794](https://github.com/ClickHouse/ClickHouse/pull/10794) ([mnkonkova](https://github.com/mnkonkova)).
* Включить дополнительные предупреждения (`-Weverything`) для base, utils, programs. Обратите внимание, что они уже используются для большей части кода. [#10779](https://github.com/ClickHouse/ClickHouse/pull/10779) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Подавление предупреждений из библиотек по ошибке было объявлено публичным в [#10396](https://github.com/ClickHouse/ClickHouse/issues/10396). [#10776](https://github.com/ClickHouse/ClickHouse/pull/10776) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Восстановлен патч, случайно удалённый в [#10396](https://github.com/ClickHouse/ClickHouse/issues/10396). [#10774](https://github.com/ClickHouse/ClickHouse/pull/10774) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены ошибки в тестах производительности, часть 2. [#10773](https://github.com/ClickHouse/ClickHouse/pull/10773) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены ошибки в тестах производительности. [#10766](https://github.com/ClickHouse/ClickHouse/pull/10766) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Обновлены кросс-сборки для использования компилятора clang-10. [#10724](https://github.com/ClickHouse/ClickHouse/pull/10724) ([Ivan](https://github.com/abyss7)).
* Обновлена инструкция по установке RPM-пакетов. Изменение предложено Denis (TG-логин @ldviolet) и реализовано Arkady Shejn. [#10707](https://github.com/ClickHouse/ClickHouse/pull/10707) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Попытка исправить тест `tests/queries/0_stateless/01246_insert_into_watch_live_view.py`. [#10670](https://github.com/ClickHouse/ClickHouse/pull/10670) ([vzakaznikov](https://github.com/vzakaznikov)).
* Исправлен и снова включен тест 00979&#95;live&#95;view&#95;watch&#95;continuous&#95;aggregates.py. [#10658](https://github.com/ClickHouse/ClickHouse/pull/10658) ([vzakaznikov](https://github.com/vzakaznikov)).
* Исправлен OOM в стресс‑тесте под ASan. [#10646](https://github.com/ClickHouse/ClickHouse/pull/10646) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен отчёт UBSan (сложение нуля с nullptr) в `HashTable`, появившийся после перехода на clang-10. [#10638](https://github.com/ClickHouse/ClickHouse/pull/10638) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Удалён внешний вызов линковщика `ld` (bfd) при обработке tzdata во время компиляции. [#10634](https://github.com/ClickHouse/ClickHouse/pull/10634) ([alesapin](https://github.com/alesapin)).
* Разрешено использовать `lld` для линковки блобов (ресурсов). [#10632](https://github.com/ClickHouse/ClickHouse/pull/10632) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено предупреждение UBSan в библиотеке `LZ4`. [#10631](https://github.com/ClickHouse/ClickHouse/pull/10631) ([alexey-milovidov](https://github.com/alexey-milovidov)). См. также [https://github.com/lz4/lz4/issues/857](https://github.com/lz4/lz4/issues/857)
* Обновлён LZ4 до последней dev-ветки. [#10630](https://github.com/ClickHouse/ClickHouse/pull/10630) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлен автоматически сгенерированный машиночитаемый файл со списком стабильных версий. [#10628](https://github.com/ClickHouse/ClickHouse/pull/10628) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена проверка версии `capnproto` для `capnp::UnalignedFlatArrayMessageReader`. [#10618](https://github.com/ClickHouse/ClickHouse/pull/10618) ([Matwey V. Kornilov](https://github.com/matwey)).
* Снижено использование памяти в тестах. [#10617](https://github.com/ClickHouse/ClickHouse/pull/10617) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправление жестко заданных таймаутов в новых тестах live view. [#10604](https://github.com/ClickHouse/ClickHouse/pull/10604) ([vzakaznikov](https://github.com/vzakaznikov)).
* Увеличен таймаут при открытии клиента в tests/queries/0&#95;stateless/helpers/client.py. [#10599](https://github.com/ClickHouse/ClickHouse/pull/10599) ([vzakaznikov](https://github.com/vzakaznikov)).
* Включён ThinLTO для сборок clang, продолжение [#10435](https://github.com/ClickHouse/ClickHouse/pull/10435). [#10585](https://github.com/ClickHouse/ClickHouse/pull/10585) ([Amos Bird](https://github.com/amosbird)).
* Добавлены фаззеры и выполнена подготовка к интеграции с oss-fuzz. [#10546](https://github.com/ClickHouse/ClickHouse/pull/10546) ([kyprizel](https://github.com/kyprizel)).
* Исправлена сборка на FreeBSD. [#10150](https://github.com/ClickHouse/ClickHouse/pull/10150) ([Ivan](https://github.com/abyss7)).
* Добавлена новая сборка для тестирования запросов с использованием фреймворка pytest. [#10039](https://github.com/ClickHouse/ClickHouse/pull/10039) ([Ivan](https://github.com/abyss7)).





## ClickHouse release v20.4 {#clickhouse-release-v204}

### ClickHouse release v20.4.8.99-stable 2020-08-10 {#clickhouse-release-v204899-stable-2020-08-10}

#### Исправление ошибок {#bug-fix-28}


* Исправлена ошибка в функции `parseDateTimeBestEffort`, возникавшая при передаче Unix timestamp в качестве аргумента. Это исправляет [#13362](https://github.com/ClickHouse/ClickHouse/issues/13362). [#13441](https://github.com/ClickHouse/ClickHouse/pull/13441) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена потенциально низкая производительность и немного некорректный результат для агрегатных функций `uniqExact`, `topK`, `sumDistinct` и подобных, вызываемых для типов Float со значениями NaN. Это также приводило к срабатыванию assert в debug-сборке. Исправляет [#12491](https://github.com/ClickHouse/ClickHouse/issues/12491). [#13254](https://github.com/ClickHouse/ClickHouse/pull/13254) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена работа функции if с nullable constexpr в качестве условия, не являющегося литералом NULL. Исправляет [#12463](https://github.com/ClickHouse/ClickHouse/issues/12463). [#13226](https://github.com/ClickHouse/ClickHouse/pull/13226) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена проверка `assert` в функции `arrayElement` в случае, когда элементы массива имеют тип Nullable, а индекс массива также имеет тип Nullable. Это исправляет [#12172](https://github.com/ClickHouse/ClickHouse/issues/12172). [#13224](https://github.com/ClickHouse/ClickHouse/pull/13224) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен некорректный анализ индекса с функциями. Это могло приводить к отсечению неверных частей при чтении из таблиц `MergeTree`. Исправляет [#13060](https://github.com/ClickHouse/ClickHouse/issues/13060). Исправляет [#12406](https://github.com/ClickHouse/ClickHouse/issues/12406). [#13081](https://github.com/ClickHouse/ClickHouse/pull/13081) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено излишнее ограничение числа потоков при выборках с локальной реплики. [#12840](https://github.com/ClickHouse/ClickHouse/pull/12840) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено возможное появление лишней строки переполнения в данных для запросов `WITH TOTALS`. [#12747](https://github.com/ClickHouse/ClickHouse/pull/12747) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена производительность при работе с большими кортежами, которые интерпретируются как функции в секции `IN`. Это относится к случаю, когда пользователь по какой-то непонятной причине пишет `WHERE x IN tuple(1, 2, ...)` вместо `WHERE x IN (1, 2, ...)`. [#12700](https://github.com/ClickHouse/ClickHouse/pull/12700) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено отслеживание памяти для `input_format_parallel_parsing` (за счёт привязки потока к группе). [#12672](https://github.com/ClickHouse/ClickHouse/pull/12672) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено [#12293](https://github.com/ClickHouse/ClickHouse/issues/12293): разрешено проталкивание предиката, когда подзапрос содержит конструкцию `WITH`. [#12663](https://github.com/ClickHouse/ClickHouse/pull/12663) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена [#10572](https://github.com/ClickHouse/ClickHouse/issues/10572): проблема с индексом Bloom Filter при использовании константного выражения. [#12659](https://github.com/ClickHouse/ClickHouse/pull/12659) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлено возникновение `SIGSEGV` в `StorageKafka`, когда брокер недоступен (и не только). [#12658](https://github.com/ClickHouse/ClickHouse/pull/12658) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка функции `if` с аргументами типа `Array(UUID)`. Это исправляет проблему [#11066](https://github.com/ClickHouse/ClickHouse/issues/11066). [#12648](https://github.com/ClickHouse/ClickHouse/pull/12648) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена гонка во внешних словарях с кеширующей схемой, которая могла приводить к сбою сервера. [#12566](https://github.com/ClickHouse/ClickHouse/pull/12566) ([alesapin](https://github.com/alesapin)).
* При выполнении `DROP TABLE` теперь удаляются данные для таблиц `Distributed` (блоки из асинхронных `INSERT`). [#12556](https://github.com/ClickHouse/ClickHouse/pull/12556) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, которая приводила к повреждению старых партиций после запроса `ALTER DELETE`, когда `enable_mixed_granularity_parts=1`. Исправляет [#12536](https://github.com/ClickHouse/ClickHouse/issues/12536). [#12543](https://github.com/ClickHouse/ClickHouse/pull/12543) ([alesapin](https://github.com/alesapin)).
* Улучшено сообщение об ошибке для функции `in` при неверном количестве аргументов. [#12529](https://github.com/ClickHouse/ClickHouse/pull/12529) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена проблема с производительностью при чтении из компактных частей. [#12492](https://github.com/ClickHouse/ClickHouse/pull/12492) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено падение в `JOIN` со словарём, когда выполняется соединение по выражению над ключом словаря: `t JOIN dict ON expr(dict.id) = t.id`. Для этого случая отключена оптимизация `JOIN` со словарём. [#12458](https://github.com/ClickHouse/ClickHouse/pull/12458) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлена возможная ошибка сегментации памяти в `StorageMerge`. Закрывает [#12054](https://github.com/ClickHouse/ClickHouse/issues/12054). [#12401](https://github.com/ClickHouse/ClickHouse/pull/12401) ([tavplubix](https://github.com/tavplubix)).
* Исправлен порядок столбцов в модификаторе `WITH FILL`. Ранее порядок столбцов в операторе `ORDER BY` не соблюдался. [#12306](https://github.com/ClickHouse/ClickHouse/pull/12306) ([Anton Popov](https://github.com/CurtizJ)).
* Избегайте возникновения исключения «bad cast», когда используется выражение, фильтрующее данные по виртуальным столбцам (например, `_table` в таблицах `Merge`) или по столбцам «index» в системных таблицах, например при фильтрации по имени базы данных при запросе к `system.tables`, и это выражение возвращает тип `Nullable`. Это исправляет [#12166](https://github.com/ClickHouse/ClickHouse/issues/12166). [#12305](https://github.com/ClickHouse/ClickHouse/pull/12305) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Показывать ошибку после сбоя загрузки TrieDictionary. [#12290](https://github.com/ClickHouse/ClickHouse/pull/12290) ([Vitaly Baranov](https://github.com/vitlibar)).
* Функция `arrayFill` работала некорректно для пустых массивов, что могло приводить к сбою. Исправляет [#12263](https://github.com/ClickHouse/ClickHouse/issues/12263). [#12279](https://github.com/ClickHouse/ClickHouse/pull/12279) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Реализованы преобразования к общему типу для типов `LowCardinality`. Это позволяет выполнять UNION ALL таблиц со столбцами типа LowCardinality и столбцами других типов. Исправлено [#8212](https://github.com/ClickHouse/ClickHouse/issues/8212). Исправлено [#4342](https://github.com/ClickHouse/ClickHouse/issues/4342). [#12275](https://github.com/ClickHouse/ClickHouse/pull/12275) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено поведение, при котором при нескольких последовательных вставках в `StorageFile` заголовок для некоторых специальных типов записывался более одного раза. Это устранило [#6155](https://github.com/ClickHouse/ClickHouse/issues/6155). [#12197](https://github.com/ClickHouse/ClickHouse/pull/12197) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлено поведение логических функций для значений типа UInt8, отличных от 0 и 1. [#12196](https://github.com/ClickHouse/ClickHouse/pull/12196) ([Alexander Kazakov](https://github.com/Akazz)).
* Значения max&#95;memory&#95;usage* ограничены размером резидентной памяти процесса. [#12182](https://github.com/ClickHouse/ClickHouse/pull/12182) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проверка аргументов `dictGet` при удалении инъективных функций в GROUP BY. [#12179](https://github.com/ClickHouse/ClickHouse/pull/12179) ([Azat Khuzhin](https://github.com/azat)).
* Не разделяйте имя таблицы источника словаря на схему и имя таблицы, если ODBC-подключение не поддерживает схемы. [#12165](https://github.com/ClickHouse/ClickHouse/pull/12165) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена неверная логика в `ALTER DELETE`, которая приводила к удалению записей, когда результат условия был `NULL`. Это исправляет [#9088](https://github.com/ClickHouse/ClickHouse/issues/9088). Это закрывает [#12106](https://github.com/ClickHouse/ClickHouse/issues/12106). [#12153](https://github.com/ClickHouse/ClickHouse/pull/12153) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено преобразование запроса, отправляемого во внешние СУБД (например, MySQL, ODBC), при наличии псевдонимов. Это исправляет [#12032](https://github.com/ClickHouse/ClickHouse/issues/12032). [#12151](https://github.com/ClickHouse/ClickHouse/pull/12151) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено потенциальное переполнение при целочисленном делении. Это исправляет [#12119](https://github.com/ClickHouse/ClickHouse/issues/12119). [#12140](https://github.com/ClickHouse/ClickHouse/pull/12140) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена потенциальная бесконечная петля в `greatCircleDistance`, `geoDistance`. Это исправляет [#12117](https://github.com/ClickHouse/ClickHouse/issues/12117). [#12137](https://github.com/ClickHouse/ClickHouse/pull/12137) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Нормализована обработка файла pid. В предыдущих версиях сервер мог не запускаться, если был завершён принудительно без корректного выключения и если существовал другой процесс с тем же pid, что и у ранее запущенного сервера. Также pid-файл мог быть удалён при неудачном запуске сервера, даже если уже работал другой сервер. Это исправляет [#3501](https://github.com/ClickHouse/ClickHouse/issues/3501). [#12133](https://github.com/ClickHouse/ClickHouse/pull/12133) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена обработка зависимости таблицы с ENGINE=Dictionary от словаря. Это исправляет [#10994](https://github.com/ClickHouse/ClickHouse/issues/10994). Это исправляет [#10397](https://github.com/ClickHouse/ClickHouse/issues/10397). [#12116](https://github.com/ClickHouse/ClickHouse/pull/12116) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена производительность запросов `SELECT` с `UNION`, страдавшая из‑за неверного ограничения на общее количество потоков. Исправляет [#12030](https://github.com/ClickHouse/ClickHouse/issues/12030). [#12103](https://github.com/ClickHouse/ClickHouse/pull/12103) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено возникновение ошибки сегментации при использовании комбинаторов `-StateResample`. [#12092](https://github.com/ClickHouse/ClickHouse/pull/12092) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены пустые метрики `result_rows` и `result_bytes` в `system.quey_log` для запросов `SELECT`. Исправлена ошибка [#11595](https://github.com/ClickHouse/ClickHouse/issues/11595). [#12089](https://github.com/ClickHouse/ClickHouse/pull/12089) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено ненужное ограничение числа потоков при выполнении запросов `SELECT` из `VIEW`. Исправляет [#11937](https://github.com/ClickHouse/ClickHouse/issues/11937). [#12085](https://github.com/ClickHouse/ClickHouse/pull/12085) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен возможный сбой при использовании некорректного типа для `PREWHERE`. Исправляет [#12053](https://github.com/ClickHouse/ClickHouse/issues/12053), [#12060](https://github.com/ClickHouse/ClickHouse/issues/12060). [#12060](https://github.com/ClickHouse/ClickHouse/pull/12060) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка `Expected single dictionary argument for function` в функции `defaultValueOfArgumentType` с типом `LowCardinality`. Исправляет [#11808](https://github.com/ClickHouse/ClickHouse/issues/11808). [#12056](https://github.com/ClickHouse/ClickHouse/pull/12056) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка `Cannot capture column` для функций высшего порядка с аргументом `Tuple(LowCardinality)`. Исправляет [#9766](https://github.com/ClickHouse/ClickHouse/issues/9766). [#12055](https://github.com/ClickHouse/ClickHouse/pull/12055) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Параллельный разбор метаданных таблиц при загрузке базы данных. Это устраняет медленный запуск сервера при большом числе таблиц. [#12045](https://github.com/ClickHouse/ClickHouse/pull/12045) ([tavplubix](https://github.com/tavplubix)).
* Агрегатная функция `topK` для типов Enum теперь возвращает Enum. Это исправляет [#3740](https://github.com/ClickHouse/ClickHouse/issues/3740). [#12043](https://github.com/ClickHouse/ClickHouse/pull/12043) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена проверка ограничений на то, является ли ограничение константным выражением. Это исправляет [#11360](https://github.com/ClickHouse/ClickHouse/issues/11360). [#12042](https://github.com/ClickHouse/ClickHouse/pull/12042) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено некорректное сравнение кортежей со столбцами типа `Nullable`. Исправляет [#11985](https://github.com/ClickHouse/ClickHouse/issues/11985). [#12039](https://github.com/ClickHouse/ClickHouse/pull/12039) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен расчёт прав доступа при allow&#95;introspection&#95;functions=0. [#12031](https://github.com/ClickHouse/ClickHouse/pull/12031) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен неверный результат и потенциальный сбой при вызове функции `if` с аргументами типа `FixedString` разного размера. Это исправляет [#11362](https://github.com/ClickHouse/ClickHouse/issues/11362). [#12021](https://github.com/ClickHouse/ClickHouse/pull/12021) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Запрос, в котором функция `neighbor` является единственным возвращаемым выражением, может возвращать пустой результат, если функция вызывается со смещением `-9223372036854775808`. Это исправляет [#11367](https://github.com/ClickHouse/ClickHouse/issues/11367). [#12019](https://github.com/ClickHouse/ClickHouse/pull/12019) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен расчёт прав доступа при allow&#95;ddl=0. [#12015](https://github.com/ClickHouse/ClickHouse/pull/12015) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено потенциальное переполнение размера массива в generateRandom, которое могло привести к сбою. Это исправляет [#11371](https://github.com/ClickHouse/ClickHouse/issues/11371). [#12013](https://github.com/ClickHouse/ClickHouse/pull/12013) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено потенциальное исключение при работе с числами с плавающей точкой. Это закрывает [#11378](https://github.com/ClickHouse/ClickHouse/issues/11378). [#12005](https://github.com/ClickHouse/ClickHouse/pull/12005) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено некорректное имя настройки в сообщении журнала при запуске сервера. [#11997](https://github.com/ClickHouse/ClickHouse/pull/11997) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка `Query parameter was not set` в формате `Values`. Исправление для [#11918](https://github.com/ClickHouse/ClickHouse/issues/11918). [#11936](https://github.com/ClickHouse/ClickHouse/pull/11936) ([tavplubix](https://github.com/tavplubix)).
* Сохранять алиасы для подстановок в запросе (параметризованные запросы). Это исправляет [#11914](https://github.com/ClickHouse/ClickHouse/issues/11914). [#11916](https://github.com/ClickHouse/ClickHouse/pull/11916) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка, из-за которой при смене политики хранения с политики по умолчанию не выполнялись перемещения данных. [#11893](https://github.com/ClickHouse/ClickHouse/pull/11893) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Исправлено потенциальное исключение при работе с числами с плавающей запятой при разборе `DateTime64`. Это исправляет [#11374](https://github.com/ClickHouse/ClickHouse/issues/11374). [#11875](https://github.com/ClickHouse/ClickHouse/pull/11875) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен учет памяти через HTTP-интерфейс (особенно заметно при `wait_end_of_query=1`). [#11840](https://github.com/ClickHouse/ClickHouse/pull/11840) ([Azat Khuzhin](https://github.com/azat)).
* Разбирать метаданные, хранящиеся в ZooKeeper, перед проверкой на равенство. [#11739](https://github.com/ClickHouse/ClickHouse/pull/11739) ([Azat Khuzhin](https://github.com/azat)).

#### Улучшение производительности {#performance-improvement-10}

- Индекс не использовался для оператора IN с литералами, регрессия производительности введена в версии v19.3. Исправляет [#10574](https://github.com/ClickHouse/ClickHouse/issues/10574). [#12062](https://github.com/ClickHouse/ClickHouse/pull/12062) ([nvartolomei](https://github.com/nvartolomei)).

#### Улучшение сборки/тестирования/упаковки {#buildtestingpackaging-improvement-12}

- Установка `ca-certificates` перед первым выполнением `apt-get update` в Dockerfile. [#12095](https://github.com/ClickHouse/ClickHouse/pull/12095) ([Ivan Blinkov](https://github.com/blinkov)).

### Релиз ClickHouse v20.4.6.53-stable 2020-06-25 {#clickhouse-release-v204653-stable-2020-06-25}

#### Исправление ошибок {#bug-fix-29}


* Исправлено редкое падение, вызванное использованием столбца `Nullable` в условии PREWHERE. Продолжение [#11608](https://github.com/ClickHouse/ClickHouse/issues/11608). [#11869](https://github.com/ClickHouse/ClickHouse/pull/11869) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Запрещено использовать arrayJoin внутри функций высшего порядка. Это приводило к нарушению синхронизации протокола. Исправляет [#3933](https://github.com/ClickHouse/ClickHouse/issues/3933). [#11846](https://github.com/ClickHouse/ClickHouse/pull/11846) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена некорректная работа сравнения `FixedString` с константным `String`. Это исправляет [#11393](https://github.com/ClickHouse/ClickHouse/issues/11393). Ошибка появилась в версии 20.4. [#11828](https://github.com/ClickHouse/ClickHouse/pull/11828) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен неверный результат функции `if()` при наличии NULL в условии. [#11807](https://github.com/ClickHouse/ClickHouse/pull/11807) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлена проблема с использованием слишком большого числа потоков для запросов. [#11788](https://github.com/ClickHouse/ClickHouse/pull/11788) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено неожиданное поведение запросов вида `SELECT *, xyz.*`, которые выполнялись успешно, хотя ожидалась ошибка. [#11753](https://github.com/ClickHouse/ClickHouse/pull/11753) ([hexiaoting](https://github.com/hexiaoting)).
* Теперь выборки реплик будут отменяться во время изменения метаданных. [#11744](https://github.com/ClickHouse/ClickHouse/pull/11744) ([alesapin](https://github.com/alesapin)).
* Исправлена LOGICAL&#95;ERROR, вызванная некорректным определением типа для сложных литералов во входном формате Values. [#11732](https://github.com/ClickHouse/ClickHouse/pull/11732) ([tavplubix](https://github.com/tavplubix)).
* Исправлена работа `ORDER BY ... WITH FILL` с константными столбцами. [#11697](https://github.com/ClickHouse/ClickHouse/pull/11697) ([Anton Popov](https://github.com/CurtizJ)).
* Передавать корректные тайм-ауты при взаимодействии с XDBC bridge. Ранее тайм-ауты не соблюдались при проверке доступности bridge и получении метаинформации. [#11690](https://github.com/ClickHouse/ClickHouse/pull/11690) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена работа `LIMIT n WITH TIES` при совместном использовании с оператором `ORDER BY`, в котором используются псевдонимы. [#11689](https://github.com/ClickHouse/ClickHouse/pull/11689) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка, приводившая к некорректному состоянию `system.mutations`. В нём могло отображаться, что вся мутация уже завершена, хотя на сервере всё ещё оставались задачи `MUTATE_PART` в очереди репликации, и он продолжал пытаться их выполнить. Это исправляет [#11611](https://github.com/ClickHouse/ClickHouse/issues/11611). [#11681](https://github.com/ClickHouse/ClickHouse/pull/11681) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка регулярных выражений с флагами, не учитывающими регистр. Это исправляет [#11101](https://github.com/ClickHouse/ClickHouse/issues/11101) и [#11506](https://github.com/ClickHouse/ClickHouse/issues/11506). [#11649](https://github.com/ClickHouse/ClickHouse/pull/11649) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Удалена оптимизация тривиальных запросов `count`, если настроена построчная безопасность. В предыдущих версиях пользователь получал общее количество строк в таблице, а не количество строк после фильтрации. Это исправляет [#11352](https://github.com/ClickHouse/ClickHouse/issues/11352). [#11644](https://github.com/ClickHouse/ClickHouse/pull/11644) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены bloom-фильтры для `String` (индексы пропуска данных). [#11638](https://github.com/ClickHouse/ClickHouse/pull/11638) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен редкий сбой, вызванный использованием колонки `Nullable` в условии PREWHERE. (Вероятно, это как‑то связано с [#11572](https://github.com/ClickHouse/ClickHouse/issues/11572)). [#11608](https://github.com/ClickHouse/ClickHouse/pull/11608) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка `Block structure mismatch` для запросов с выборкой (`SAMPLE`), читающих из таблицы `Buffer`. [#11602](https://github.com/ClickHouse/ClickHouse/pull/11602) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен некорректный код выхода `clickhouse-client`, когда `exception.code() % 256 = 0`. [#11601](https://github.com/ClickHouse/ClickHouse/pull/11601) ([filimonov](https://github.com/filimonov)).
* Исправлена тривиальная ошибка в сообщении журнала о снижении размера кэша меток при запуске сервера. Это закрывает [#11399](https://github.com/ClickHouse/ClickHouse/issues/11399). [#11589](https://github.com/ClickHouse/ClickHouse/pull/11589) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка `Size of offsets does not match size of column` для запросов с `PREWHERE column IN (subquery)` и `ARRAY JOIN`. [#11580](https://github.com/ClickHouse/ClickHouse/pull/11580) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен редкий сбой (segfault) в `SHOW CREATE TABLE`. Исправляет [#11490](https://github.com/ClickHouse/ClickHouse/issues/11490). [#11579](https://github.com/ClickHouse/ClickHouse/pull/11579) ([tavplubix](https://github.com/tavplubix)).
* Все запросы в HTTP-сессии имели одинаковый `query_id`. Это исправлено. [#11578](https://github.com/ClickHouse/ClickHouse/pull/11578) ([tavplubix](https://github.com/tavplubix)).
* Теперь Docker-контейнер clickhouse-server будет отдавать предпочтение IPv6 при проверке работоспособности сервера. [#11550](https://github.com/ClickHouse/ClickHouse/pull/11550) ([Ivan Starkov](https://github.com/istarkov)).
* Исправлены shard&#95;num/replica&#95;num для `<node>` (исправлена работа use&#95;compact&#95;format&#95;in&#95;distributed&#95;parts&#95;names). [#11528](https://github.com/ClickHouse/ClickHouse/pull/11528) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена гонка, которая могла приводить к исключению при удалении таблицы. Случай немного хитрый, но совершенно не опасный. Если вам нужно объяснение, просто напишите мне в Telegram. [#11523](https://github.com/ClickHouse/ClickHouse/pull/11523) ([alesapin](https://github.com/alesapin)).
* Исправлена утечка памяти при возникновении исключения в середине агрегации с функциями `-State`. Это исправляет [#8995](https://github.com/ClickHouse/ClickHouse/issues/8995). [#11496](https://github.com/ClickHouse/ClickHouse/pull/11496) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Если индекс пропуска данных зависит от столбцов, которые будут изменяться во время фонового слияния (для `SummingMergeTree`, `AggregatingMergeTree`, а также для `TTL GROUP BY`), он рассчитывался некорректно. Эта проблема исправлена переносом вычисления индекса на этап после слияния, чтобы индекс рассчитывался уже по слитым данным. [#11162](https://github.com/ClickHouse/ClickHouse/pull/11162) ([Azat Khuzhin](https://github.com/azat)).
* Удалены устаревшие патчи для libunwind. [https://github.com/ClickHouse-Extras/libunwind/commit/500aa227911bd185a94bfc071d68f4d3b03cb3b1#r39048012](https://github.com/ClickHouse-Extras/libunwind/commit/500aa227911bd185a94bfc071d68f4d3b03cb3b1#r39048012) Это позволяет отключить `-fno-omit-frame-pointer` в сборках `clang`, что в среднем улучшает производительность как минимум на 1%. [#10761](https://github.com/ClickHouse/ClickHouse/pull/10761) ([Amos Bird](https://github.com/amosbird)).
* Исправлена работа первичного ключа, обёрнутого в функцию, с модификатором &#39;FINAL&#39; и оптимизацией &#39;ORDER BY&#39;. [#10715](https://github.com/ClickHouse/ClickHouse/pull/10715) ([Anton Popov](https://github.com/CurtizJ)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-13}

- Исправлено несколько незначительных ошибок в модульных тестах. [#11262](https://github.com/ClickHouse/ClickHouse/pull/11262) ([alesapin](https://github.com/alesapin)).
- Исправлен ложный отчёт MSan в MergeTreeIndexFullText. Проблема впервые появилась в [#9968](https://github.com/ClickHouse/ClickHouse/issues/9968). [#10801](https://github.com/ClickHouse/ClickHouse/pull/10801) ([alexey-milovidov](https://github.com/alexey-milovidov)).

### Релиз ClickHouse v20.4.5.36-stable 2020-06-10 {#clickhouse-release-v204536-stable-2020-06-10}

#### Исправление ошибок {#bug-fix-30}


* Исправлена ошибка `Data compressed with different methods`, которая могла возникать при включённом `min_bytes_to_use_direct_io`, активном PREWHERE и использовании SAMPLE или большого числа потоков. Это исправляет [#11539](https://github.com/ClickHouse/ClickHouse/issues/11539). [#11540](https://github.com/ClickHouse/ClickHouse/pull/11540) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено возвращаемое сжатое значение размера для кодеков. [#11448](https://github.com/ClickHouse/ClickHouse/pull/11448) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено падение сервера, когда у столбца используется кодек сжатия с нелитеральными аргументами. Исправляет [#11365](https://github.com/ClickHouse/ClickHouse/issues/11365). [#11431](https://github.com/ClickHouse/ClickHouse/pull/11431) ([alesapin](https://github.com/alesapin)).
* Исправлена функция pointInPolygon при использовании nan в качестве точки. Исправляет [#11375](https://github.com/ClickHouse/ClickHouse/issues/11375). [#11421](https://github.com/ClickHouse/ClickHouse/pull/11421) ([Alexey Ilyukhov](https://github.com/livace)).
* Исправлено потенциальное чтение неинициализированной памяти при завершении работы MergeTree, если таблица не была успешно создана. [#11420](https://github.com/ClickHouse/ClickHouse/pull/11420) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена работа функции geohashesInBox с аргументами вне допустимого диапазона широты/долготы. [#11403](https://github.com/ClickHouse/ClickHouse/pull/11403) ([Vasily Nemkov](https://github.com/Enmk)).
* Исправлена возможная ошибка `Pipeline stuck` для запросов с внешней сортировкой и `LIMIT`. Исправлено [#11359](https://github.com/ClickHouse/ClickHouse/issues/11359). [#11366](https://github.com/ClickHouse/ClickHouse/pull/11366) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Удалена избыточная блокировка при отправке кусков в `ReplicatedMergeTree`. [#11354](https://github.com/ClickHouse/ClickHouse/pull/11354) ([alesapin](https://github.com/alesapin)).
* Исправлена поддержка `\G` (вертикальный вывод) в clickhouse-client в многострочном режиме. Закрывает [#9933](https://github.com/ClickHouse/ClickHouse/issues/9933). [#11350](https://github.com/ClickHouse/ClickHouse/pull/11350) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен потенциальный сбой сегментации при использовании базы данных `Lazy`. [#11348](https://github.com/ClickHouse/ClickHouse/pull/11348) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка, приводившая к сбою в `quantilesExactWeightedArray`. [#11337](https://github.com/ClickHouse/ClickHouse/pull/11337) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Теперь слияния останавливаются до изменения метаданных в запросах `ALTER`. [#11335](https://github.com/ClickHouse/ClickHouse/pull/11335) ([alesapin](https://github.com/alesapin)).
* Запись в `MATERIALIZED VIEW` при установленной настройке `parallel_view_processing = 1` снова выполняется параллельно. Исправляет [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241). [#11330](https://github.com/ClickHouse/ClickHouse/pull/11330) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена функция visitParamExtractRaw для случая, когда извлечённый JSON содержит строки с несбалансированными &#123; или [. [#11318](https://github.com/ClickHouse/ClickHouse/pull/11318) ([Ewout](https://github.com/devwout)).
* Исправлена крайне редкая гонка в `ThreadPool`. [#11314](https://github.com/ClickHouse/ClickHouse/pull/11314) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена малозначимая гонка данных в clickhouse-copier, обнаруженная интеграционными тестами. [#11313](https://github.com/ClickHouse/ClickHouse/pull/11313) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено потенциальное использование неинициализированной памяти при преобразовании. Пример: `SELECT toIntervalSecond(now64())`. [#11311](https://github.com/ClickHouse/ClickHouse/pull/11311) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена проблема, из‑за которой анализ индексов не работал, если в таблице в первичном ключе есть столбец типа `Array`, а запрос фильтрует по этому столбцу с использованием функций `empty` или `notEmpty`. Это исправляет [#11286](https://github.com/ClickHouse/ClickHouse/issues/11286). [#11303](https://github.com/ClickHouse/ClickHouse/pull/11303) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка, из-за которой оценка скорости выполнения запроса могла быть некорректной, и ограничение `min_execution_speed` могло не работать или работать неправильно, если запрос ограничивается настройками `max_network_bandwidth`, `max_execution_speed` или `priority`. Значение по умолчанию для `timeout_before_checking_execution_speed` изменено на ненулевое, потому что иначе настройки `min_execution_speed` и `max_execution_speed` не оказывают никакого эффекта. Исправляет [#11297](https://github.com/ClickHouse/ClickHouse/issues/11297). Исправляет [#5732](https://github.com/ClickHouse/ClickHouse/issues/5732). Исправляет [#6228](https://github.com/ClickHouse/ClickHouse/issues/6228). Улучшение удобства использования: устранено склеивание сообщения об исключении с индикатором прогресса в `clickhouse-client`. [#11296](https://github.com/ClickHouse/ClickHouse/pull/11296) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено падение при вызове SET DEFAULT ROLE с некорректными аргументами. Это исправляет [#10586](https://github.com/ClickHouse/ClickHouse/issues/10586). [#11278](https://github.com/ClickHouse/ClickHouse/pull/11278) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен сбой при чтении некорректных данных в формате Protobuf. Исправляет [#5957](https://github.com/ClickHouse/ClickHouse/issues/5957), исправляет [#11203](https://github.com/ClickHouse/ClickHouse/issues/11203). [#11258](https://github.com/ClickHouse/ClickHouse/pull/11258) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена ошибка, из-за которой `cache-dictionary` мог возвращать значение по умолчанию вместо обычного (когда есть только просроченные ключи). Это затрагивает только строковые поля. [#11233](https://github.com/ClickHouse/ClickHouse/pull/11233) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена ошибка `Block structure mismatch in QueryPipeline` при чтении из `VIEW` с константами во внутреннем запросе. Исправляет [#11181](https://github.com/ClickHouse/ClickHouse/issues/11181). [#11205](https://github.com/ClickHouse/ClickHouse/pull/11205) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено возможное исключение `Invalid status for associated output`. [#11200](https://github.com/ClickHouse/ClickHouse/pull/11200) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена потенциальная ошибка `Cannot capture column` для функций высшего порядка с захваченным аргументом типа `Array(Array(LowCardinality))`. [#11185](https://github.com/ClickHouse/ClickHouse/pull/11185) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена работа globbing в `S3`, который мог давать сбои при наличии более 1000 ключей и с некоторыми бэкендами. [#11179](https://github.com/ClickHouse/ClickHouse/pull/11179) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Если индекс пропуска данных (`data skipping index`) зависит от столбцов, которые будут изменены во время фонового слияния (в `SummingMergeTree`, `AggregatingMergeTree`, а также при `TTL GROUP BY`), он вычислялся некорректно. Эта проблема исправлена переносом вычисления индекса на этап после слияния, чтобы индекс вычислялся уже по слитым данным. [#11162](https://github.com/ClickHouse/ClickHouse/pull/11162) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема с производительностью Kafka, связанная с повторным планированием на основе лимитов, которые всегда применялись. [#11149](https://github.com/ClickHouse/ClickHouse/pull/11149) ([filimonov](https://github.com/filimonov)).
* Исправлена проблема с зависанием, которое иногда происходило при выполнении `DROP` таблицы с движком `Kafka` (или при перезапуске сервера). [#11145](https://github.com/ClickHouse/ClickHouse/pull/11145) ([filimonov](https://github.com/filimonov)).
* Исправлено чрезмерное резервирование потоков для простых запросов (оптимизация по снижению числа потоков, частично сломанная после изменений в конвейере). [#11114](https://github.com/ClickHouse/ClickHouse/pull/11114) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена оптимизация предикатов для распределённых запросов (`enable_optimize_predicate_expression=1`) для запросов с разделом `HAVING` (то есть когда требуется фильтрация на сервере-инициаторе) за счёт сохранения порядка выражений (и этого достаточно для исправления), а также принудительного использования агрегатором имён столбцов вместо индексов. Исправления: [#10613](https://github.com/ClickHouse/ClickHouse/issues/10613), [#11413](https://github.com/ClickHouse/ClickHouse/issues/11413). [#10621](https://github.com/ClickHouse/ClickHouse/pull/10621) ([Azat Khuzhin](https://github.com/azat)).

#### Улучшение сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-14}

- Исправлено несколько нестабильных интеграционных тестов. [#11355](https://github.com/ClickHouse/ClickHouse/pull/11355) ([alesapin](https://github.com/alesapin)).

### ClickHouse релиз v20.4.4.18-stable 2020-05-26 {#clickhouse-release-v204418-stable-2020-05-26}

Нет изменений по сравнению с v20.4.3.16-stable.

### ClickHouse релиз v20.4.3.16-stable 2020-05-23 {#clickhouse-release-v204316-stable-2020-05-23}

#### Исправление ошибок {#bug-fix-31}


* Удалено логирование в задаче финализации мутации, если ничего не было финализировано. [#11109](https://github.com/ClickHouse/ClickHouse/pull/11109) ([alesapin](https://github.com/alesapin)).
* Исправлена утечка памяти в registerDiskS3. [#11074](https://github.com/ClickHouse/ClickHouse/pull/11074) ([Pavel Kovalenko](https://github.com/Jokser)).
* Исправлена потенциальная потеря данных при остановке таблицы движка Kafka. [#11048](https://github.com/ClickHouse/ClickHouse/pull/11048) ([filimonov](https://github.com/filimonov)).
* Исправлены ошибки определения аргументов в `parseDateTime64BestEffort`. [#11038](https://github.com/ClickHouse/ClickHouse/pull/11038) ([Vasily Nemkov](https://github.com/Enmk)).
* Исправлена крайне редкая потенциальная ошибка типа use-after-free в `MergeTree`, возникавшая при некорректном создании таблицы. [#10986](https://github.com/ClickHouse/ClickHouse/pull/10986), [#10970](https://github.com/ClickHouse/ClickHouse/pull/10970) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена обработка метаданных (относительный путь для `rename`) и данных (относительный путь для `symlink`) в базе данных `Atomic`. [#10980](https://github.com/ClickHouse/ClickHouse/pull/10980) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен сбой сервера при одновременном выполнении запросов `ALTER` и `DROP DATABASE` для базы данных с движком `Atomic`. [#10968](https://github.com/ClickHouse/ClickHouse/pull/10968) ([tavplubix](https://github.com/tavplubix)).
* Исправлен некорректный размер «сырых» данных в методе `getRawData()`. [#10964](https://github.com/ClickHouse/ClickHouse/pull/10964) ([Igr](https://github.com/ObjatieGroba)).
* Исправлена несовместимость двухуровневой агрегации между версиями 20.1 и более ранними. Эта несовместимость возникает, когда на инициирующем узле и удалённых узлах используются разные версии ClickHouse, размер результата GROUP BY велик, а агрегация выполняется по единственному полю типа String. Это приводит к появлению в результате нескольких непроагрегированных строк для одного ключа. [#10952](https://github.com/ClickHouse/ClickHouse/pull/10952) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена отправка частично записанных файлов через `DistributedBlockOutputStream`. [#10940](https://github.com/ClickHouse/ClickHouse/pull/10940) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен сбой при выполнении `SELECT count(notNullIn(NULL, []))`. [#10920](https://github.com/ClickHouse/ClickHouse/pull/10920) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено зависание, которое иногда происходило при `DROP` таблиц с движком `Kafka` (или при перезапусках сервера). [#10910](https://github.com/ClickHouse/ClickHouse/pull/10910) ([filimonov](https://github.com/filimonov)).
* Исправлена ошибка, из‑за которой было невозможно выполнить несколько `ALTER RENAME`, например `a TO b, c TO a`. [#10895](https://github.com/ClickHouse/ClickHouse/pull/10895) ([alesapin](https://github.com/alesapin)).
* Исправлена возможная гонка, которая могла возникать при получении результата из состояния агрегатной функции из нескольких потоков для одного и того же столбца. Возникнуть она могла только при использовании функции `finalizeAggregation` при чтении из таблицы с движком `Memory`, в которой состояние `AggregateFunction` хранится для функции `quantile*`. [#10890](https://github.com/ClickHouse/ClickHouse/pull/10890) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена обратная совместимость с кортежами в таблицах `Distributed`. [#10889](https://github.com/ClickHouse/ClickHouse/pull/10889) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка `SIGSEGV` в `StringHashTable`, возникающая при отсутствии такого ключа. [#10870](https://github.com/ClickHouse/ClickHouse/pull/10870) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено зависание `WATCH` после удаления таблицы `LiveView` из базы данных с движком `Atomic`. [#10859](https://github.com/ClickHouse/ClickHouse/pull/10859) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка в `ReplicatedMergeTree`, из-за которой некоторые запросы `ALTER` при выполнении `OPTIMIZE` могли зависать в ожидании реплики после того, как она становилась неактивной. [#10849](https://github.com/ClickHouse/ClickHouse/pull/10849) ([tavplubix](https://github.com/tavplubix)).
* Теперь ограничения обновляются, если столбец, участвующий в выражении `CONSTRAINT`, был переименован. Исправляет [#10844](https://github.com/ClickHouse/ClickHouse/issues/10844). [#10847](https://github.com/ClickHouse/ClickHouse/pull/10847) ([alesapin](https://github.com/alesapin)).
* Исправлено потенциальное чтение неинициализированной памяти в `cache-dictionary`. [#10834](https://github.com/ClickHouse/ClickHouse/pull/10834) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен порядок столбцов после вызова `Block::sortColumns()`. [#10826](https://github.com/ClickHouse/ClickHouse/pull/10826) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема с `ODBC`-мостом, возникавшая при отключённом кавычении идентификаторов. Исправляет [#7984](https://github.com/ClickHouse/ClickHouse/issues/7984). [#10821](https://github.com/ClickHouse/ClickHouse/pull/10821) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены отчёты `UBSan` и `MSan` в `DateLUT`. [#10798](https://github.com/ClickHouse/ClickHouse/pull/10798) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено некорректное преобразование типов в условиях по ключу. Исправляет [#6287](https://github.com/ClickHouse/ClickHouse/issues/6287). [#10791](https://github.com/ClickHouse/ClickHouse/pull/10791) ([Andrew Onyshchuk](https://github.com/oandrew)).
* Исправлено поведение `parallel_view_processing`. Теперь все вставки в `MATERIALIZED VIEW` в любом случае будут завершены даже при возникновении исключения. Исправляет [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241). [#10757](https://github.com/ClickHouse/ClickHouse/pull/10757) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена работа комбинаторов `-OrNull` и `-OrDefault` при совместном использовании с `-State`. [#10741](https://github.com/ClickHouse/ClickHouse/pull/10741) ([hcz](https://github.com/hczhcz)).
* Исправлено возможное переполнение буфера в функции `h3EdgeAngle`. [#10711](https://github.com/ClickHouse/ClickHouse/pull/10711) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка, из-за которой блокировались параллельные операции `ALTER`, когда у таблицы было много партиций. [#10659](https://github.com/ClickHouse/ClickHouse/pull/10659) ([alesapin](https://github.com/alesapin)).
* Исправлено разыменование `nullptr` в `StorageBuffer`, если сервер был остановлен до запуска таблицы. [#10641](https://github.com/ClickHouse/ClickHouse/pull/10641) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена работа `optimize_skip_unused_shards` с `LowCardinality`. [#10611](https://github.com/ClickHouse/ClickHouse/pull/10611) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена обработка переменной условия для синхронных мутаций. В некоторых случаях сигналы для этой переменной условия могли теряться. [#10588](https://github.com/ClickHouse/ClickHouse/pull/10588) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Исправлено возможное падение при вызове `createDictionary()` до завершения `loadStoredObject()`. [#10587](https://github.com/ClickHouse/ClickHouse/pull/10587) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено выполнение `SELECT` по столбцу `ALIAS`, у которого тип выражения по умолчанию отличается от типа столбца. [#10563](https://github.com/ClickHouse/ClickHouse/pull/10563) ([Azat Khuzhin](https://github.com/azat)).
* Реализовано сравнение значений типов DateTime64 и String. [#10560](https://github.com/ClickHouse/ClickHouse/pull/10560) ([Vasily Nemkov](https://github.com/Enmk)).
* По умолчанию отключить оптимизацию `GROUP BY` по ключу шардирования (`optimize_distributed_group_by_sharding_key` был добавлен и по умолчанию отключён из‑за сложности анализа ключа шардирования, простой пример — использование `if` в ключе шардирования) и исправить её для `WITH ROLLUP/CUBE/TOTALS`. [#10516](https://github.com/ClickHouse/ClickHouse/pull/10516) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка [#10263](https://github.com/ClickHouse/ClickHouse/issues/10263). [#10486](https://github.com/ClickHouse/ClickHouse/pull/10486) ([Azat Khuzhin](https://github.com/azat)).
* Добавлены тесты для настройки `max_rows_to_sort`. [#10268](https://github.com/ClickHouse/ClickHouse/pull/10268) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена обратная совместимость для создания индекса Bloom-фильтра. [#10551](https://github.com/ClickHouse/ClickHouse/issues/10551). [#10569](https://github.com/ClickHouse/ClickHouse/pull/10569) ([Winter Zhang](https://github.com/zhang2014)).

### ClickHouse release v20.4.2.9, 2020-05-12 {#clickhouse-release-v20429-2020-05-12}

#### Обратно несовместимые изменения {#backward-incompatible-change-8}

- Системные таблицы (например, system.query_log, system.trace_log, system.metric_log) используют компактный формат кусков данных для кусков размером менее 10 МиБ. Компактный формат кусков данных поддерживается начиная с версии 20.3. Если вы планируете откатиться на версию ниже 20.3, необходимо вручную удалить данные таблиц системных логов в `/var/lib/clickhouse/data/system/`.
- При сравнении строк с участием FixedString, когда сравниваемые аргументы имеют разные размеры, сравнение выполняется так, как если бы меньшая строка была дополнена пробелами до длины большей. Это сделано для совместимости с SQL, если представить, что тип данных FixedString соответствует SQL CHAR. Закрывает [#9272](https://github.com/ClickHouse/ClickHouse/issues/9272). [#10363](https://github.com/ClickHouse/ClickHouse/pull/10363) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Вывод SHOW CREATE TABLE теперь многострочный. Это делает его более читаемым и похожим на MySQL. [#10049](https://github.com/ClickHouse/ClickHouse/pull/10049) ([Azat Khuzhin](https://github.com/azat))
- Добавлена настройка `validate_polygons`, которая используется в функции `pointInPolygon` и включена по умолчанию. [#9857](https://github.com/ClickHouse/ClickHouse/pull/9857) ([alexey-milovidov](https://github.com/alexey-milovidov))


#### Новые возможности {#new-feature-8}

- Добавлена поддержка защищённого соединения от ClickHouse к Zookeeper [#10184](https://github.com/ClickHouse/ClickHouse/pull/10184) ([Konstantin Lebedev](https://github.com/xzkostyan))
- Поддержка пользовательских HTTP-обработчиков. См. описание в [#5436](https://github.com/ClickHouse/ClickHouse/issues/5436). [#7572](https://github.com/ClickHouse/ClickHouse/pull/7572) ([Winter Zhang](https://github.com/zhang2014))
- Добавлен формат ввода/вывода MessagePack. [#9889](https://github.com/ClickHouse/ClickHouse/pull/9889) ([Kruglov Pavel](https://github.com/Avogar))
- Добавлен формат ввода Regexp. [#9196](https://github.com/ClickHouse/ClickHouse/pull/9196) ([Kruglov Pavel](https://github.com/Avogar))
- Добавлен формат вывода `Markdown` для встраивания таблиц в markdown-документы. [#10317](https://github.com/ClickHouse/ClickHouse/pull/10317) ([Kruglov Pavel](https://github.com/Avogar))
- Добавлена поддержка секции пользовательских настроек в словарях. Также исправлена проблема [#2829](https://github.com/ClickHouse/ClickHouse/issues/2829). [#10137](https://github.com/ClickHouse/ClickHouse/pull/10137) ([Artem Streltsov](https://github.com/kekekekule))
- Добавлена поддержка пользовательских настроек в DDL-запросах для `CREATE DICTIONARY` [#10465](https://github.com/ClickHouse/ClickHouse/pull/10465) ([Artem Streltsov](https://github.com/kekekekule))
- Добавлен простой общесерверный профилировщик памяти, который собирает контексты выделения памяти, когда использование памяти сервером превышает следующий порог выделения. [#10444](https://github.com/ClickHouse/ClickHouse/pull/10444) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлена настройка `always_fetch_merged_part`, которая запрещает реплике объединять куски самостоятельно и всегда предпочитает загрузку с других реплик. [#10379](https://github.com/ClickHouse/ClickHouse/pull/10379) ([alesapin](https://github.com/alesapin))
- Добавлена функция `JSONExtractKeysAndValuesRaw`, которая извлекает необработанные данные из JSON-объектов [#10378](https://github.com/ClickHouse/ClickHouse/pull/10378) ([hcz](https://github.com/hczhcz))
- Добавлены метрики использования памяти из ОС в `system.asynchronous_metrics`. [#10361](https://github.com/ClickHouse/ClickHouse/pull/10361) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлены универсальные варианты функций `least` и `greatest`. Теперь они работают с произвольным количеством аргументов произвольных типов. Это исправляет [#4767](https://github.com/ClickHouse/ClickHouse/issues/4767) [#10318](https://github.com/ClickHouse/ClickHouse/pull/10318) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Теперь ClickHouse контролирует таймауты источников словарей на своей стороне. В конфигурацию кэширующего словаря добавлены две новые настройки: `strict_max_lifetime_seconds`, которая по умолчанию равна `max_lifetime`, и `query_wait_timeout_milliseconds`, которая по умолчанию равна одной минуте. Первая настройка также полезна вместе с настройкой `allow_read_expired_keys` (для запрета чтения сильно устаревших ключей). [#10337](https://github.com/ClickHouse/ClickHouse/pull/10337) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Добавлена настройка log_queries_min_type для фильтрации записей, которые будут записаны в query_log [#10053](https://github.com/ClickHouse/ClickHouse/pull/10053) ([Azat Khuzhin](https://github.com/azat))
- Добавлена функция `isConstant`. Эта функция проверяет, является ли её аргумент константным выражением, и возвращает 1 или 0. Она предназначена для целей разработки, отладки и демонстрации. [#10198](https://github.com/ClickHouse/ClickHouse/pull/10198) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлена функция joinGetOrNull для возврата NULL, когда ключ отсутствует, вместо возврата значения по умолчанию. [#10094](https://github.com/ClickHouse/ClickHouse/pull/10094) ([Amos Bird](https://github.com/amosbird))
- Значение `NULL` считается равным `NULL` в операторе `IN`, если установлена опция `transform_null_in`. [#10085](https://github.com/ClickHouse/ClickHouse/pull/10085) ([achimbab](https://github.com/achimbab))
- Добавлена команда `ALTER TABLE ... RENAME COLUMN` для семейства движков таблиц MergeTree. [#9948](https://github.com/ClickHouse/ClickHouse/pull/9948) ([alesapin](https://github.com/alesapin))
- Поддержка параллельного распределённого INSERT SELECT. [#9759](https://github.com/ClickHouse/ClickHouse/pull/9759) ([vxider](https://github.com/Vxider))
- Добавлена возможность запросов к Distributed поверх Distributed (без `distributed_group_by_no_merge`) ... [#9923](https://github.com/ClickHouse/ClickHouse/pull/9923) ([Azat Khuzhin](https://github.com/azat))
- Добавлена функция `arrayReduceInRanges`, которая агрегирует элементы массива в заданных диапазонах. [#9598](https://github.com/ClickHouse/ClickHouse/pull/9598) ([hcz](https://github.com/hczhcz))
- Добавлен статус словарей в prometheus exporter. [#9622](https://github.com/ClickHouse/ClickHouse/pull/9622) ([Guillaume Tassery](https://github.com/YiuRULE))
- Добавлена функция `arrayAUC` [#8698](https://github.com/ClickHouse/ClickHouse/pull/8698) ([taiyang-li](https://github.com/taiyang-li))
- Поддержка оператора `DROP VIEW` для лучшей совместимости с TPC-H. [#9831](https://github.com/ClickHouse/ClickHouse/pull/9831) ([Amos Bird](https://github.com/amosbird))
- Добавлена опция 'strict_order' для функции windowFunnel() [#9773](https://github.com/ClickHouse/ClickHouse/pull/9773) ([achimbab](https://github.com/achimbab))
- Поддержка SQL-операторов `DATE` и `TIMESTAMP`, например `SELECT date '2001-01-01'` [#9691](https://github.com/ClickHouse/ClickHouse/pull/9691) ([Artem Zuikov](https://github.com/4ertus2))

#### Экспериментальная функциональность {#experimental-feature-6}

- Добавлен экспериментальный движок баз данных Atomic. Он поддерживает неблокирующие запросы `DROP` и `RENAME TABLE`, а также атомарный запрос `EXCHANGE TABLES t1 AND t2` [#7512](https://github.com/ClickHouse/ClickHouse/pull/7512) ([tavplubix](https://github.com/tavplubix))
- Добавлена начальная поддержка ReplicatedMergeTree поверх S3 (работает неоптимально) [#10126](https://github.com/ClickHouse/ClickHouse/pull/10126) ([Pavel Kovalenko](https://github.com/Jokser))


#### Исправление ошибок {#bug-fix-32}

- Fixed incorrect scalar results inside inner query of `MATERIALIZED VIEW` in case if this query contained dependent table [#10603](https://github.com/ClickHouse/ClickHouse/pull/10603) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed bug, which caused HTTP requests to get stuck on client closing connection when `readonly=2` and `cancel_http_readonly_queries_on_client_close=1`. [#10684](https://github.com/ClickHouse/ClickHouse/pull/10684) ([tavplubix](https://github.com/tavplubix))
- Fix segfault in StorageBuffer when exception is thrown on server startup. Fixes [#10550](https://github.com/ClickHouse/ClickHouse/issues/10550) [#10609](https://github.com/ClickHouse/ClickHouse/pull/10609) ([tavplubix](https://github.com/tavplubix))
- The query`SYSTEM DROP DNS CACHE` now also drops caches used to check if user is allowed to connect from some IP addresses [#10608](https://github.com/ClickHouse/ClickHouse/pull/10608) ([tavplubix](https://github.com/tavplubix))
- Fix usage of multiple `IN` operators with an identical set in one query. Fixes [#10539](https://github.com/ClickHouse/ClickHouse/issues/10539) [#10686](https://github.com/ClickHouse/ClickHouse/pull/10686) ([Anton Popov](https://github.com/CurtizJ))
- Fix crash in `generateRandom` with nested types. Fixes [#10583](https://github.com/ClickHouse/ClickHouse/issues/10583). [#10734](https://github.com/ClickHouse/ClickHouse/pull/10734) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix data corruption for `LowCardinality(FixedString)` key column in `SummingMergeTree` which could have happened after merge. Fixes [#10489](https://github.com/ClickHouse/ClickHouse/issues/10489). [#10721](https://github.com/ClickHouse/ClickHouse/pull/10721) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix logic for aggregation_memory_efficient_merge_threads setting. [#10667](https://github.com/ClickHouse/ClickHouse/pull/10667) ([palasonic1](https://github.com/palasonic1))
- Fix disappearing totals. Totals could have being filtered if query had `JOIN` or subquery with external `WHERE` condition. Fixes [#10674](https://github.com/ClickHouse/ClickHouse/issues/10674) [#10698](https://github.com/ClickHouse/ClickHouse/pull/10698) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix the lack of parallel execution of remote queries with `distributed_aggregation_memory_efficient` enabled. Fixes [#10655](https://github.com/ClickHouse/ClickHouse/issues/10655) [#10664](https://github.com/ClickHouse/ClickHouse/pull/10664) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix possible incorrect number of rows for queries with `LIMIT`. Fixes [#10566](https://github.com/ClickHouse/ClickHouse/issues/10566), [#10709](https://github.com/ClickHouse/ClickHouse/issues/10709) [#10660](https://github.com/ClickHouse/ClickHouse/pull/10660) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix index corruption, which may occur in some cases after merging compact parts into another compact part. [#10531](https://github.com/ClickHouse/ClickHouse/pull/10531) ([Anton Popov](https://github.com/CurtizJ))
- Fix the situation, when mutation finished all parts, but hung up in `is_done=0`. [#10526](https://github.com/ClickHouse/ClickHouse/pull/10526) ([alesapin](https://github.com/alesapin))
- Fix overflow at beginning of unix epoch for timezones with fractional offset from UTC. Fixes [#9335](https://github.com/ClickHouse/ClickHouse/issues/9335). [#10513](https://github.com/ClickHouse/ClickHouse/pull/10513) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Better diagnostics for input formats. Fixes [#10204](https://github.com/ClickHouse/ClickHouse/issues/10204) [#10418](https://github.com/ClickHouse/ClickHouse/pull/10418) ([tavplubix](https://github.com/tavplubix))
- Fix numeric overflow in `simpleLinearRegression()` over large integers [#10474](https://github.com/ClickHouse/ClickHouse/pull/10474) ([hcz](https://github.com/hczhcz))
- Fix use-after-free in Distributed shutdown, avoid waiting for sending all batches [#10491](https://github.com/ClickHouse/ClickHouse/pull/10491) ([Azat Khuzhin](https://github.com/azat))
- Add CA certificates to clickhouse-server docker image [#10476](https://github.com/ClickHouse/ClickHouse/pull/10476) ([filimonov](https://github.com/filimonov))
- Fix a rare endless loop that might have occurred when using the `addressToLine` function or AggregateFunctionState columns. [#10466](https://github.com/ClickHouse/ClickHouse/pull/10466) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Handle zookeeper "no node error" during distributed query [#10050](https://github.com/ClickHouse/ClickHouse/pull/10050) ([Daniel Chen](https://github.com/Phantomape))
- Fix bug when server cannot attach table after column's default was altered. [#10441](https://github.com/ClickHouse/ClickHouse/pull/10441) ([alesapin](https://github.com/alesapin))
- Implicitly cast the default expression type to the column type for the ALIAS columns [#10563](https://github.com/ClickHouse/ClickHouse/pull/10563) ([Azat Khuzhin](https://github.com/azat))
- Don't remove metadata directory if `ATTACH DATABASE` fails [#10442](https://github.com/ClickHouse/ClickHouse/pull/10442) ([Winter Zhang](https://github.com/zhang2014))
- Avoid dependency on system tzdata. Fixes loading of `Africa/Casablanca` timezone on CentOS 8. Fixes [#10211](https://github.com/ClickHouse/ClickHouse/issues/10211) [#10425](https://github.com/ClickHouse/ClickHouse/pull/10425) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix some issues if data is inserted with quorum and then gets deleted (DROP PARTITION, TTL, etc.). It led to stuck of INSERTs or false-positive exceptions in SELECTs. Fixes [#9946](https://github.com/ClickHouse/ClickHouse/issues/9946) [#10188](https://github.com/ClickHouse/ClickHouse/pull/10188) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Check the number and type of arguments when creating BloomFilter index [#9623](https://github.com/ClickHouse/ClickHouse/issues/9623) [#10431](https://github.com/ClickHouse/ClickHouse/pull/10431) ([Winter Zhang](https://github.com/zhang2014))
- Prefer `fallback_to_stale_replicas` over `skip_unavailable_shards`, otherwise when both settings specified and there are no up-to-date replicas the query will fail (patch from @alex-zaitsev ) [#10422](https://github.com/ClickHouse/ClickHouse/pull/10422) ([Azat Khuzhin](https://github.com/azat))
- Fix the issue when a query with ARRAY JOIN, ORDER BY and LIMIT may return incomplete result. Fixes [#10226](https://github.com/ClickHouse/ClickHouse/issues/10226). [#10427](https://github.com/ClickHouse/ClickHouse/pull/10427) ([Vadim Plakhtinskiy](https://github.com/VadimPlh))
- Add database name to dictionary name after DETACH/ATTACH. Fixes system.dictionaries table and `SYSTEM RELOAD` query [#10415](https://github.com/ClickHouse/ClickHouse/pull/10415) ([Azat Khuzhin](https://github.com/azat))
- Fix possible incorrect result for extremes in processors pipeline. [#10131](https://github.com/ClickHouse/ClickHouse/pull/10131) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix possible segfault when the setting `distributed_group_by_no_merge` is enabled (introduced in 20.3.7.46 by [#10131](https://github.com/ClickHouse/ClickHouse/issues/10131)). [#10399](https://github.com/ClickHouse/ClickHouse/pull/10399) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix wrong flattening of `Array(Tuple(...))` data types. Fixes [#10259](https://github.com/ClickHouse/ClickHouse/issues/10259) [#10390](https://github.com/ClickHouse/ClickHouse/pull/10390) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix column names of constants inside JOIN that may clash with names of constants outside of JOIN [#9950](https://github.com/ClickHouse/ClickHouse/pull/9950) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Fix order of columns after Block::sortColumns() [#10826](https://github.com/ClickHouse/ClickHouse/pull/10826) ([Azat Khuzhin](https://github.com/azat))
- Fix possible `Pipeline stuck` error in `ConcatProcessor` which may happen in remote query. [#10381](https://github.com/ClickHouse/ClickHouse/pull/10381) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Don't make disk reservations for aggregations. Fixes [#9241](https://github.com/ClickHouse/ClickHouse/issues/9241) [#10375](https://github.com/ClickHouse/ClickHouse/pull/10375) ([Azat Khuzhin](https://github.com/azat))
- Fix wrong behaviour of datetime functions for timezones that has altered between positive and negative offsets from UTC (e.g. Pacific/Kiritimati). Fixes [#7202](https://github.com/ClickHouse/ClickHouse/issues/7202) [#10369](https://github.com/ClickHouse/ClickHouse/pull/10369) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Avoid infinite loop in `dictIsIn` function. Fixes #515 [#10365](https://github.com/ClickHouse/ClickHouse/pull/10365) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Disable GROUP BY sharding_key optimization by default and fix it for WITH ROLLUP/CUBE/TOTALS [#10516](https://github.com/ClickHouse/ClickHouse/pull/10516) ([Azat Khuzhin](https://github.com/azat))
- Check for error code when checking parts and don't mark part as broken if the error is like "not enough memory". Fixes [#6269](https://github.com/ClickHouse/ClickHouse/issues/6269) [#10364](https://github.com/ClickHouse/ClickHouse/pull/10364) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Show information about not loaded dictionaries in system tables. [#10234](https://github.com/ClickHouse/ClickHouse/pull/10234) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix nullptr dereference in StorageBuffer if server was shutdown before table startup. [#10641](https://github.com/ClickHouse/ClickHouse/pull/10641) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed `DROP` vs `OPTIMIZE` race in `ReplicatedMergeTree`. `DROP` could left some garbage in replica path in ZooKeeper if there was concurrent `OPTIMIZE` query. [#10312](https://github.com/ClickHouse/ClickHouse/pull/10312) ([tavplubix](https://github.com/tavplubix))
- Fix 'Logical error: CROSS JOIN has expressions' error for queries with comma and names joins mix. Fixes [#9910](https://github.com/ClickHouse/ClickHouse/issues/9910) [#10311](https://github.com/ClickHouse/ClickHouse/pull/10311) ([Artem Zuikov](https://github.com/4ertus2))
- Fix queries with `max_bytes_before_external_group_by`. [#10302](https://github.com/ClickHouse/ClickHouse/pull/10302) ([Artem Zuikov](https://github.com/4ertus2))
- Fix the issue with limiting maximum recursion depth in parser in certain cases. This fixes [#10283](https://github.com/ClickHouse/ClickHouse/issues/10283) This fix may introduce minor incompatibility: long and deep queries via clickhouse-client may refuse to work, and you should adjust settings `max_query_size` and `max_parser_depth` accordingly. [#10295](https://github.com/ClickHouse/ClickHouse/pull/10295) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Allow to use `count(*)` with multiple JOINs. Fixes [#9853](https://github.com/ClickHouse/ClickHouse/issues/9853) [#10291](https://github.com/ClickHouse/ClickHouse/pull/10291) ([Artem Zuikov](https://github.com/4ertus2))
- Fix error `Pipeline stuck` with `max_rows_to_group_by` and `group_by_overflow_mode = 'break'`. [#10279](https://github.com/ClickHouse/ClickHouse/pull/10279) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix 'Cannot add column' error while creating `range_hashed` dictionary using DDL query. Fixes [#10093](https://github.com/ClickHouse/ClickHouse/issues/10093). [#10235](https://github.com/ClickHouse/ClickHouse/pull/10235) ([alesapin](https://github.com/alesapin))
- Fix rare possible exception `Cannot drain connections: cancel first`. [#10239](https://github.com/ClickHouse/ClickHouse/pull/10239) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed bug where ClickHouse would throw "Unknown function lambda." error message when user tries to run ALTER UPDATE/DELETE on tables with ENGINE = Replicated\*. Check for nondeterministic functions now handles lambda expressions correctly. [#10237](https://github.com/ClickHouse/ClickHouse/pull/10237) ([Alexander Kazakov](https://github.com/Akazz))
- Fixed reasonably rare segfault in StorageSystemTables that happens when SELECT ... FROM system.tables is run on a database with Lazy engine. [#10209](https://github.com/ClickHouse/ClickHouse/pull/10209) ([Alexander Kazakov](https://github.com/Akazz))
- Fix possible infinite query execution when the query actually should stop on LIMIT, while reading from infinite source like `system.numbers` or `system.zeros`. [#10206](https://github.com/ClickHouse/ClickHouse/pull/10206) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed "generateRandom" function for Date type. This fixes [#9973](https://github.com/ClickHouse/ClickHouse/issues/9973). Fix an edge case when dates with year 2106 are inserted to MergeTree tables with old-style partitioning but partitions are named with year 1970. [#10218](https://github.com/ClickHouse/ClickHouse/pull/10218) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Convert types if the table definition of a View does not correspond to the SELECT query. This fixes [#10180](https://github.com/ClickHouse/ClickHouse/issues/10180) and [#10022](https://github.com/ClickHouse/ClickHouse/issues/10022) [#10217](https://github.com/ClickHouse/ClickHouse/pull/10217) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix `parseDateTimeBestEffort` for strings in RFC-2822 when day of week is Tuesday or Thursday. This fixes [#10082](https://github.com/ClickHouse/ClickHouse/issues/10082) [#10214](https://github.com/ClickHouse/ClickHouse/pull/10214) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix column names of constants inside JOIN that may clash with names of constants outside of JOIN. [#10207](https://github.com/ClickHouse/ClickHouse/pull/10207) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix move-to-prewhere optimization in presense of arrayJoin functions (in certain cases). This fixes [#10092](https://github.com/ClickHouse/ClickHouse/issues/10092) [#10195](https://github.com/ClickHouse/ClickHouse/pull/10195) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix issue with separator appearing in SCRAMBLE for native mysql-connector-java (JDBC) [#10140](https://github.com/ClickHouse/ClickHouse/pull/10140) ([BohuTANG](https://github.com/BohuTANG))
- Fix using the current database for an access checking when the database isn't specified. [#10192](https://github.com/ClickHouse/ClickHouse/pull/10192) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix ALTER of tables with compact parts. [#10130](https://github.com/ClickHouse/ClickHouse/pull/10130) ([Anton Popov](https://github.com/CurtizJ))
- Add the ability to relax the restriction on non-deterministic functions usage in mutations with `allow_nondeterministic_mutations` setting. [#10186](https://github.com/ClickHouse/ClickHouse/pull/10186) ([filimonov](https://github.com/filimonov))
- Fix `DROP TABLE` invoked for dictionary [#10165](https://github.com/ClickHouse/ClickHouse/pull/10165) ([Azat Khuzhin](https://github.com/azat))
- Convert blocks if structure does not match when doing `INSERT` into Distributed table [#10135](https://github.com/ClickHouse/ClickHouse/pull/10135) ([Azat Khuzhin](https://github.com/azat))
- The number of rows was logged incorrectly (as sum across all parts) when inserted block is split by parts with partition key. [#10138](https://github.com/ClickHouse/ClickHouse/pull/10138) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add some arguments check and support identifier arguments for MySQL Database Engine [#10077](https://github.com/ClickHouse/ClickHouse/pull/10077) ([Winter Zhang](https://github.com/zhang2014))
- Fix incorrect `index_granularity_bytes` check while creating new replica. Fixes [#10098](https://github.com/ClickHouse/ClickHouse/issues/10098). [#10121](https://github.com/ClickHouse/ClickHouse/pull/10121) ([alesapin](https://github.com/alesapin))
- Fix bug in `CHECK TABLE` query when table contain skip indices. [#10068](https://github.com/ClickHouse/ClickHouse/pull/10068) ([alesapin](https://github.com/alesapin))
- Fix Distributed-over-Distributed with the only one shard in a nested table [#9997](https://github.com/ClickHouse/ClickHouse/pull/9997) ([Azat Khuzhin](https://github.com/azat))
- Fix possible rows loss for queries with `JOIN` and `UNION ALL`. Fixes [#9826](https://github.com/ClickHouse/ClickHouse/issues/9826), [#10113](https://github.com/ClickHouse/ClickHouse/issues/10113). ... [#10099](https://github.com/ClickHouse/ClickHouse/pull/10099) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix bug in dictionary when local clickhouse server is used as source. It may caused memory corruption if types in dictionary and source are not compatible. [#10071](https://github.com/ClickHouse/ClickHouse/pull/10071) ([alesapin](https://github.com/alesapin))
- Fixed replicated tables startup when updating from an old ClickHouse version where `/table/replicas/replica_name/metadata` node does not exist. Fixes [#10037](https://github.com/ClickHouse/ClickHouse/issues/10037). [#10095](https://github.com/ClickHouse/ClickHouse/pull/10095) ([alesapin](https://github.com/alesapin))
- Fix error `Cannot clone block with columns because block has 0 columns ... While executing GroupingAggregatedTransform`. It happened when setting `distributed_aggregation_memory_efficient` was enabled, and distributed query read aggregating data with mixed single and two-level aggregation from different shards. [#10063](https://github.com/ClickHouse/ClickHouse/pull/10063) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix deadlock when database with materialized view failed attach at start [#10054](https://github.com/ClickHouse/ClickHouse/pull/10054) ([Azat Khuzhin](https://github.com/azat))
- Fix a segmentation fault that could occur in GROUP BY over string keys containing trailing zero bytes ([#8636](https://github.com/ClickHouse/ClickHouse/issues/8636), [#8925](https://github.com/ClickHouse/ClickHouse/issues/8925)). ... [#10025](https://github.com/ClickHouse/ClickHouse/pull/10025) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Fix wrong results of distributed queries when alias could override qualified column name. Fixes [#9672](https://github.com/ClickHouse/ClickHouse/issues/9672) [#9714](https://github.com/ClickHouse/ClickHouse/issues/9714) [#9972](https://github.com/ClickHouse/ClickHouse/pull/9972) ([Artem Zuikov](https://github.com/4ertus2))
- Fix possible deadlock in `SYSTEM RESTART REPLICAS` [#9955](https://github.com/ClickHouse/ClickHouse/pull/9955) ([tavplubix](https://github.com/tavplubix))
- Fix the number of threads used for remote query execution (performance regression, since 20.3). This happened when query from `Distributed` table was executed simultaneously on local and remote shards. Fixes [#9965](https://github.com/ClickHouse/ClickHouse/issues/9965) [#9971](https://github.com/ClickHouse/ClickHouse/pull/9971) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed `DeleteOnDestroy` logic in `ATTACH PART` which could lead to automatic removal of attached part and added few tests [#9410](https://github.com/ClickHouse/ClickHouse/pull/9410) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix a bug with `ON CLUSTER` DDL queries freezing on server startup. [#9927](https://github.com/ClickHouse/ClickHouse/pull/9927) ([Gagan Arneja](https://github.com/garneja))
- Fix bug in which the necessary tables weren't retrieved at one of the processing stages of queries to some databases. Fixes [#9699](https://github.com/ClickHouse/ClickHouse/issues/9699). [#9949](https://github.com/ClickHouse/ClickHouse/pull/9949) ([achulkov2](https://github.com/achulkov2))
- Fix 'Not found column in block' error when `JOIN` appears with `TOTALS`. Fixes [#9839](https://github.com/ClickHouse/ClickHouse/issues/9839) [#9939](https://github.com/ClickHouse/ClickHouse/pull/9939) ([Artem Zuikov](https://github.com/4ertus2))
- Fix parsing multiple hosts set in the CREATE USER command [#9924](https://github.com/ClickHouse/ClickHouse/pull/9924) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix `TRUNCATE` for Join table engine ([#9917](https://github.com/ClickHouse/ClickHouse/issues/9917)). [#9920](https://github.com/ClickHouse/ClickHouse/pull/9920) ([Amos Bird](https://github.com/amosbird))
- Fix race condition between drop and optimize in `ReplicatedMergeTree`. [#9901](https://github.com/ClickHouse/ClickHouse/pull/9901) ([alesapin](https://github.com/alesapin))
- Fix `DISTINCT` for Distributed when `optimize_skip_unused_shards` is set. [#9808](https://github.com/ClickHouse/ClickHouse/pull/9808) ([Azat Khuzhin](https://github.com/azat))
- Fix "scalar does not exist" error in ALTERs ([#9878](https://github.com/ClickHouse/ClickHouse/issues/9878)). ... [#9904](https://github.com/ClickHouse/ClickHouse/pull/9904) ([Amos Bird](https://github.com/amosbird))
- Fix error with qualified names in `distributed_product_mode=\'local\'`. Fixes [#4756](https://github.com/ClickHouse/ClickHouse/issues/4756) [#9891](https://github.com/ClickHouse/ClickHouse/pull/9891) ([Artem Zuikov](https://github.com/4ertus2))
- For INSERT queries shards now do clamp the settings from the initiator to their constraints instead of throwing an exception. This fix allows to send INSERT queries to a shard with another constraints. This change improves fix [#9447](https://github.com/ClickHouse/ClickHouse/issues/9447). [#9852](https://github.com/ClickHouse/ClickHouse/pull/9852) ([Vitaly Baranov](https://github.com/vitlibar))
- Add some retries when commiting offsets to Kafka broker, since it can reject commit if during `offsets.commit.timeout.ms` there were no enough replicas available for the `__consumer_offsets` topic [#9884](https://github.com/ClickHouse/ClickHouse/pull/9884) ([filimonov](https://github.com/filimonov))
- Fix Distributed engine behavior when virtual columns of the underlying table used in `WHERE` [#9847](https://github.com/ClickHouse/ClickHouse/pull/9847) ([Azat Khuzhin](https://github.com/azat))
- Fixed some cases when timezone of the function argument wasn't used properly. [#9574](https://github.com/ClickHouse/ClickHouse/pull/9574) ([Vasily Nemkov](https://github.com/Enmk))
- Fix 'Different expressions with the same alias' error when query has PREWHERE and WHERE on distributed table and `SET distributed_product_mode = 'local'`. [#9871](https://github.com/ClickHouse/ClickHouse/pull/9871) ([Artem Zuikov](https://github.com/4ertus2))
- Fix mutations excessive memory consumption for tables with a composite primary key. This fixes [#9850](https://github.com/ClickHouse/ClickHouse/issues/9850). [#9860](https://github.com/ClickHouse/ClickHouse/pull/9860) ([alesapin](https://github.com/alesapin))
- Fix calculating grants for introspection functions from the setting `allow_introspection_functions`. [#9840](https://github.com/ClickHouse/ClickHouse/pull/9840) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix max_distributed_connections (w/ and w/o Processors) [#9673](https://github.com/ClickHouse/ClickHouse/pull/9673) ([Azat Khuzhin](https://github.com/azat))
- Fix possible exception `Got 0 in totals chunk, expected 1` on client. It happened for queries with `JOIN` in case if right joined table had zero rows. Example: `select * from system.one t1 join system.one t2 on t1.dummy = t2.dummy limit 0 FORMAT TabSeparated;`. Fixes [#9777](https://github.com/ClickHouse/ClickHouse/issues/9777). ... [#9823](https://github.com/ClickHouse/ClickHouse/pull/9823) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix 'COMMA to CROSS JOIN rewriter is not enabled or cannot rewrite query' error in case of subqueries with COMMA JOIN out of tables lists (i.e. in WHERE). Fixes [#9782](https://github.com/ClickHouse/ClickHouse/issues/9782) [#9830](https://github.com/ClickHouse/ClickHouse/pull/9830) ([Artem Zuikov](https://github.com/4ertus2))
- Fix server crashing when `optimize_skip_unused_shards` is set and expression for key can't be converted to its field type [#9804](https://github.com/ClickHouse/ClickHouse/pull/9804) ([Azat Khuzhin](https://github.com/azat))
- Fix empty string handling in `splitByString`. [#9767](https://github.com/ClickHouse/ClickHouse/pull/9767) ([hcz](https://github.com/hczhcz))
- Fix broken `ALTER TABLE DELETE COLUMN` query for compact parts. [#9779](https://github.com/ClickHouse/ClickHouse/pull/9779) ([alesapin](https://github.com/alesapin))
- Fixed missing `rows_before_limit_at_least` for queries over http (with processors pipeline). Fixes [#9730](https://github.com/ClickHouse/ClickHouse/issues/9730) [#9757](https://github.com/ClickHouse/ClickHouse/pull/9757) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix excessive memory consumption in `ALTER` queries (mutations). This fixes [#9533](https://github.com/ClickHouse/ClickHouse/issues/9533) and [#9670](https://github.com/ClickHouse/ClickHouse/issues/9670). [#9754](https://github.com/ClickHouse/ClickHouse/pull/9754) ([alesapin](https://github.com/alesapin))
- Fix possible permanent "Cannot schedule a task" error. [#9154](https://github.com/ClickHouse/ClickHouse/pull/9154) ([Azat Khuzhin](https://github.com/azat))
- Fix bug in backquoting in external dictionaries DDL. Fixes [#9619](https://github.com/ClickHouse/ClickHouse/issues/9619). [#9734](https://github.com/ClickHouse/ClickHouse/pull/9734) ([alesapin](https://github.com/alesapin))
- Fixed data race in `text_log`. It does not correspond to any real bug. [#9726](https://github.com/ClickHouse/ClickHouse/pull/9726) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix bug in a replication that does not allow replication to work if the user has executed mutations on the previous version. This fixes [#9645](https://github.com/ClickHouse/ClickHouse/issues/9645). [#9652](https://github.com/ClickHouse/ClickHouse/pull/9652) ([alesapin](https://github.com/alesapin))
- Fixed incorrect internal function names for `sumKahan` and `sumWithOverflow`. It led to exception while using this functions in remote queries. [#9636](https://github.com/ClickHouse/ClickHouse/pull/9636) ([Azat Khuzhin](https://github.com/azat))
- Add setting `use_compact_format_in_distributed_parts_names` which allows to write files for `INSERT` queries into `Distributed` table with more compact format. This fixes [#9647](https://github.com/ClickHouse/ClickHouse/issues/9647). [#9653](https://github.com/ClickHouse/ClickHouse/pull/9653) ([alesapin](https://github.com/alesapin))
- Fix RIGHT and FULL JOIN with LowCardinality in JOIN keys. [#9610](https://github.com/ClickHouse/ClickHouse/pull/9610) ([Artem Zuikov](https://github.com/4ertus2))
- Fix possible exceptions `Size of filter does not match size of column` and `Invalid number of rows in Chunk` in `MergeTreeRangeReader`. They could appear while executing `PREWHERE` in some cases. [#9612](https://github.com/ClickHouse/ClickHouse/pull/9612) ([Anton Popov](https://github.com/CurtizJ))
- Allow `ALTER ON CLUSTER` of Distributed tables with internal replication. This fixes [#3268](https://github.com/ClickHouse/ClickHouse/issues/3268) [#9617](https://github.com/ClickHouse/ClickHouse/pull/9617) ([shinoi2](https://github.com/shinoi2))
- Fix issue when timezone was not preserved if you write a simple arithmetic expression like `time + 1` (in contrast to an expression like `time + INTERVAL 1 SECOND`). This fixes [#5743](https://github.com/ClickHouse/ClickHouse/issues/5743) [#9323](https://github.com/ClickHouse/ClickHouse/pull/9323) ([alexey-milovidov](https://github.com/alexey-milovidov))





#### Улучшение {#improvement-16}

- Use time zone when comparing DateTime with string literal. This fixes [#5206](https://github.com/ClickHouse/ClickHouse/issues/5206). [#10515](https://github.com/ClickHouse/ClickHouse/pull/10515) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Print verbose diagnostic info if Decimal value cannot be parsed from text input format. [#10205](https://github.com/ClickHouse/ClickHouse/pull/10205) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add tasks/memory metrics for distributed/buffer schedule pools [#10449](https://github.com/ClickHouse/ClickHouse/pull/10449) ([Azat Khuzhin](https://github.com/azat))
- Display result as soon as it's ready for SELECT DISTINCT queries in clickhouse-local and HTTP interface. This fixes [#8951](https://github.com/ClickHouse/ClickHouse/issues/8951) [#9559](https://github.com/ClickHouse/ClickHouse/pull/9559) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Allow to use `SAMPLE OFFSET` query instead of `cityHash64(PRIMARY KEY) % N == n` for splitting in `clickhouse-copier`. To use this feature, pass `--experimental-use-sample-offset 1` as a command line argument. [#10414](https://github.com/ClickHouse/ClickHouse/pull/10414) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Allow to parse BOM in TSV if the first column cannot contain BOM in its value. This fixes [#10301](https://github.com/ClickHouse/ClickHouse/issues/10301) [#10424](https://github.com/ClickHouse/ClickHouse/pull/10424) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add Avro nested fields insert support [#10354](https://github.com/ClickHouse/ClickHouse/pull/10354) ([Andrew Onyshchuk](https://github.com/oandrew))
- Allowed to alter column in non-modifying data mode when the same type is specified. [#10382](https://github.com/ClickHouse/ClickHouse/pull/10382) ([Vladimir Chebotarev](https://github.com/excitoon))
- Auto `distributed_group_by_no_merge` on GROUP BY sharding key (if `optimize_skip_unused_shards` is set) [#10341](https://github.com/ClickHouse/ClickHouse/pull/10341) ([Azat Khuzhin](https://github.com/azat))
- Optimize queries with LIMIT/LIMIT BY/ORDER BY for distributed with GROUP BY sharding_key [#10373](https://github.com/ClickHouse/ClickHouse/pull/10373) ([Azat Khuzhin](https://github.com/azat))
- Added a setting `max_server_memory_usage` to limit total memory usage of the server. The metric `MemoryTracking` is now calculated without a drift. The setting `max_memory_usage_for_all_queries` is now obsolete and does nothing. This closes [#10293](https://github.com/ClickHouse/ClickHouse/issues/10293). [#10362](https://github.com/ClickHouse/ClickHouse/pull/10362) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add config option `system_tables_lazy_load`. If it's set to false, then system tables with logs are loaded at the server startup. [Alexander Burmak](https://github.com/Alex-Burmak), [Svyatoslav Tkhon Il Pak](https://github.com/DeifyTheGod), [#9642](https://github.com/ClickHouse/ClickHouse/pull/9642) [#10359](https://github.com/ClickHouse/ClickHouse/pull/10359) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Use background thread pool (background_schedule_pool_size) for distributed sends [#10263](https://github.com/ClickHouse/ClickHouse/pull/10263) ([Azat Khuzhin](https://github.com/azat))
- Use background thread pool for background buffer flushes. [#10315](https://github.com/ClickHouse/ClickHouse/pull/10315) ([Azat Khuzhin](https://github.com/azat))
- Support for one special case of removing incompletely written parts. This fixes [#9940](https://github.com/ClickHouse/ClickHouse/issues/9940). [#10221](https://github.com/ClickHouse/ClickHouse/pull/10221) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Use isInjective() over manual list of such functions for GROUP BY optimization. [#10342](https://github.com/ClickHouse/ClickHouse/pull/10342) ([Azat Khuzhin](https://github.com/azat))
- Avoid printing error message in log if client sends RST packet immediately on connect. It is typical behaviour of IPVS balancer with keepalived and VRRP. This fixes [#1851](https://github.com/ClickHouse/ClickHouse/issues/1851) [#10274](https://github.com/ClickHouse/ClickHouse/pull/10274) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Allow to parse `+inf` for floating point types. This closes [#1839](https://github.com/ClickHouse/ClickHouse/issues/1839) [#10272](https://github.com/ClickHouse/ClickHouse/pull/10272) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Implemented `generateRandom` table function for Nested types. This closes [#9903](https://github.com/ClickHouse/ClickHouse/issues/9903) [#10219](https://github.com/ClickHouse/ClickHouse/pull/10219) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Provide `max_allowed_packed` in MySQL compatibility interface that will help some clients to communicate with ClickHouse via MySQL protocol. [#10199](https://github.com/ClickHouse/ClickHouse/pull/10199) ([BohuTANG](https://github.com/BohuTANG))
- Allow literals for GLOBAL IN (i.e. `SELECT * FROM remote('localhost', system.one) WHERE dummy global in (0)`) [#10196](https://github.com/ClickHouse/ClickHouse/pull/10196) ([Azat Khuzhin](https://github.com/azat))
- Fix various small issues in interactive mode of clickhouse-client [#10194](https://github.com/ClickHouse/ClickHouse/pull/10194) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Avoid superfluous dictionaries load (system.tables, DROP/SHOW CREATE TABLE) [#10164](https://github.com/ClickHouse/ClickHouse/pull/10164) ([Azat Khuzhin](https://github.com/azat))
- Update to RWLock: timeout parameter for getLock() + implementation reworked to be phase fair [#10073](https://github.com/ClickHouse/ClickHouse/pull/10073) ([Alexander Kazakov](https://github.com/Akazz))
- Enhanced compatibility with native mysql-connector-java(JDBC) [#10021](https://github.com/ClickHouse/ClickHouse/pull/10021) ([BohuTANG](https://github.com/BohuTANG))
- The function `toString` is considered monotonic and can be used for index analysis even when applied in tautological cases with String or LowCardinality(String) argument. [#10110](https://github.com/ClickHouse/ClickHouse/pull/10110) ([Amos Bird](https://github.com/amosbird))
- Add `ON CLUSTER` clause support to commands `{CREATE|DROP} USER/ROLE/ROW POLICY/SETTINGS PROFILE/QUOTA`, `GRANT`. [#9811](https://github.com/ClickHouse/ClickHouse/pull/9811) ([Vitaly Baranov](https://github.com/vitlibar))
- Virtual hosted-style support for S3 URI [#9998](https://github.com/ClickHouse/ClickHouse/pull/9998) ([Pavel Kovalenko](https://github.com/Jokser))
- Now layout type for dictionaries with no arguments can be specified without round brackets in dictionaries DDL-queries. Fixes [#10057](https://github.com/ClickHouse/ClickHouse/issues/10057). [#10064](https://github.com/ClickHouse/ClickHouse/pull/10064) ([alesapin](https://github.com/alesapin))
- Add ability to use number ranges with leading zeros in filepath [#9989](https://github.com/ClickHouse/ClickHouse/pull/9989) ([Olga Khvostikova](https://github.com/stavrolia))
- Better memory usage in CROSS JOIN. [#10029](https://github.com/ClickHouse/ClickHouse/pull/10029) ([Artem Zuikov](https://github.com/4ertus2))
- Try to connect to all shards in cluster when getting structure of remote table and skip_unavailable_shards is set. [#7278](https://github.com/ClickHouse/ClickHouse/pull/7278) ([nvartolomei](https://github.com/nvartolomei))
- Add `total_rows`/`total_bytes` into the `system.tables` table. [#9919](https://github.com/ClickHouse/ClickHouse/pull/9919) ([Azat Khuzhin](https://github.com/azat))
- System log tables now use polymorpic parts by default. [#9905](https://github.com/ClickHouse/ClickHouse/pull/9905) ([Anton Popov](https://github.com/CurtizJ))
- Add type column into system.settings/merge_tree_settings [#9909](https://github.com/ClickHouse/ClickHouse/pull/9909) ([Azat Khuzhin](https://github.com/azat))
- Check for available CPU instructions at server startup as early as possible. [#9888](https://github.com/ClickHouse/ClickHouse/pull/9888) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Remove `ORDER BY` stage from mutations because we read from a single ordered part in a single thread. Also add check that the rows in mutation are ordered by sorting key and this order is not violated. [#9886](https://github.com/ClickHouse/ClickHouse/pull/9886) ([alesapin](https://github.com/alesapin))
- Implement operator LIKE for FixedString at left hand side. This is needed to better support TPC-DS queries. [#9890](https://github.com/ClickHouse/ClickHouse/pull/9890) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add `force_optimize_skip_unused_shards_no_nested` that will disable `force_optimize_skip_unused_shards` for nested Distributed table [#9812](https://github.com/ClickHouse/ClickHouse/pull/9812) ([Azat Khuzhin](https://github.com/azat))
- Now columns size is calculated only once for MergeTree data parts. [#9827](https://github.com/ClickHouse/ClickHouse/pull/9827) ([alesapin](https://github.com/alesapin))
- Evaluate constant expressions for `optimize_skip_unused_shards` (i.e. `SELECT * FROM foo_dist WHERE key=xxHash32(0)`) [#8846](https://github.com/ClickHouse/ClickHouse/pull/8846) ([Azat Khuzhin](https://github.com/azat))
- Check for using `Date` or `DateTime` column from TTL expressions was removed. [#9967](https://github.com/ClickHouse/ClickHouse/pull/9967) ([Vladimir Chebotarev](https://github.com/excitoon))
- DiskS3 hard links optimal implementation. [#9760](https://github.com/ClickHouse/ClickHouse/pull/9760) ([Pavel Kovalenko](https://github.com/Jokser))
- If `set multiple_joins_rewriter_version = 2` enables second version of multiple JOIN rewrites that keeps not clashed column names as is. It supports multiple JOINs with `USING` and allow `select *` for JOINs with subqueries. [#9739](https://github.com/ClickHouse/ClickHouse/pull/9739) ([Artem Zuikov](https://github.com/4ertus2))
- Implementation of "non-blocking" alter for StorageMergeTree [#9606](https://github.com/ClickHouse/ClickHouse/pull/9606) ([alesapin](https://github.com/alesapin))
- Add MergeTree full support for DiskS3 [#9646](https://github.com/ClickHouse/ClickHouse/pull/9646) ([Pavel Kovalenko](https://github.com/Jokser))
- Extend `splitByString` to support empty strings as separators. [#9742](https://github.com/ClickHouse/ClickHouse/pull/9742) ([hcz](https://github.com/hczhcz))
- Add a `timestamp_ns` column to `system.trace_log`. It contains a high-definition timestamp of the trace event, and allows to build timelines of thread profiles ("flame charts"). [#9696](https://github.com/ClickHouse/ClickHouse/pull/9696) ([Alexander Kuzmenkov](https://github.com/akuzm))
- When the setting `send_logs_level` is enabled, avoid intermixing of log messages and query progress. [#9634](https://github.com/ClickHouse/ClickHouse/pull/9634) ([Azat Khuzhin](https://github.com/azat))
- Added support of `MATERIALIZE TTL IN PARTITION`. [#9581](https://github.com/ClickHouse/ClickHouse/pull/9581) ([Vladimir Chebotarev](https://github.com/excitoon))
- Support complex types inside Avro nested fields [#10502](https://github.com/ClickHouse/ClickHouse/pull/10502) ([Andrew Onyshchuk](https://github.com/oandrew))

#### Улучшение производительности {#performance-improvement-11}

- Улучшена логика вставки для правой таблицы в Partial MergeJoin. [#10467](https://github.com/ClickHouse/ClickHouse/pull/10467) ([Artem Zuikov](https://github.com/4ertus2))
- Улучшена производительность строчно-ориентированных форматов (более чем на 10% для CSV и более чем на 35% для Avro в случае узких таблиц). [#10503](https://github.com/ClickHouse/ClickHouse/pull/10503) ([Andrew Onyshchuk](https://github.com/oandrew))
- Улучшена производительность запросов с явно определёнными множествами в правой части оператора IN и кортежами в левой части. [#10385](https://github.com/ClickHouse/ClickHouse/pull/10385) ([Anton Popov](https://github.com/CurtizJ))
- Уменьшено потребление памяти для хеш-таблицы в HashJoin. [#10416](https://github.com/ClickHouse/ClickHouse/pull/10416) ([Artem Zuikov](https://github.com/4ertus2))
- Специальный HashJoin для StorageDictionary. Позволяет переписывать функции `dictGet()` с использованием JOIN. Само по себе это не нарушает обратную совместимость, но может выявить проблему [#8400](https://github.com/ClickHouse/ClickHouse/issues/8400) на некоторых установках. [#10133](https://github.com/ClickHouse/ClickHouse/pull/10133) ([Artem Zuikov](https://github.com/4ertus2))
- Включена параллельная вставка для материализованных представлений, когда целевая таблица это поддерживает. [#10052](https://github.com/ClickHouse/ClickHouse/pull/10052) ([vxider](https://github.com/Vxider))
- Улучшена производительность анализа индексов с монотонными функциями. [#9607](https://github.com/ClickHouse/ClickHouse/pull/9607)[#10026](https://github.com/ClickHouse/ClickHouse/pull/10026) ([Anton Popov](https://github.com/CurtizJ))
- Использование SIMD-инструкций SSE2 или SSE4.2 для ускорения токенизации в фильтрах Блума. [#9968](https://github.com/ClickHouse/ClickHouse/pull/9968) ([Vasily Nemkov](https://github.com/Enmk))
- Улучшена производительность запросов с явно определёнными множествами в правой части оператора `IN`. Это исправляет регрессию производительности в версии 20.3. [#9740](https://github.com/ClickHouse/ClickHouse/pull/9740) ([Anton Popov](https://github.com/CurtizJ))
- Теперь clickhouse-copier разделяет каждую партицию на несколько частей и копирует их независимо. [#9075](https://github.com/ClickHouse/ClickHouse/pull/9075) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Добавлены дополнительные методы агрегации. Например, запрос 1 из TPC-H теперь будет использовать `FixedHashMap<UInt16, AggregateDataPtr>` и получит прирост производительности на 25% [#9829](https://github.com/ClickHouse/ClickHouse/pull/9829) ([Amos Bird](https://github.com/amosbird))
- Использование единого счётчика строк для нескольких потоков в преобразовании pre-limit. Это помогает избежать объединения потоков конвейера в запросах с `limit`, но без `order by` (например, `select f(x) from (select x from t limit 1000000000)`) и использовать несколько потоков для дальнейшей обработки. [#9602](https://github.com/ClickHouse/ClickHouse/pull/9602) ([Nikolai Kochetov](https://github.com/KochetovNicolai))


#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-15}

- Use a fork of AWS SDK libraries from ClickHouse-Extras [#10527](https://github.com/ClickHouse/ClickHouse/pull/10527) ([Pavel Kovalenko](https://github.com/Jokser))
- Add integration tests for new ALTER RENAME COLUMN query. [#10654](https://github.com/ClickHouse/ClickHouse/pull/10654) ([vzakaznikov](https://github.com/vzakaznikov))
- Fix possible signed integer overflow in invocation of function `now64` with wrong arguments. This fixes [#8973](https://github.com/ClickHouse/ClickHouse/issues/8973) [#10511](https://github.com/ClickHouse/ClickHouse/pull/10511) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Split fuzzer and sanitizer configurations to make build config compatible with Oss-fuzz. [#10494](https://github.com/ClickHouse/ClickHouse/pull/10494) ([kyprizel](https://github.com/kyprizel))
- Fixes for clang-tidy on clang-10. [#10420](https://github.com/ClickHouse/ClickHouse/pull/10420) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Display absolute paths in error messages. Otherwise KDevelop fails to navigate to correct file and opens a new file instead. [#10434](https://github.com/ClickHouse/ClickHouse/pull/10434) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added `ASAN_OPTIONS` environment variable to investigate errors in CI stress tests with Address sanitizer. [#10440](https://github.com/ClickHouse/ClickHouse/pull/10440) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Enable ThinLTO for clang builds (experimental). [#10435](https://github.com/ClickHouse/ClickHouse/pull/10435) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Remove accidential dependency on Z3 that may be introduced if the system has Z3 solver installed. [#10426](https://github.com/ClickHouse/ClickHouse/pull/10426) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Move integration tests docker files to docker/ directory. [#10335](https://github.com/ClickHouse/ClickHouse/pull/10335) ([Ilya Yatsishin](https://github.com/qoega))
- Allow to use `clang-10` in CI. It ensures that [#10238](https://github.com/ClickHouse/ClickHouse/issues/10238) is fixed. [#10384](https://github.com/ClickHouse/ClickHouse/pull/10384) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update OpenSSL to upstream master. Fixed the issue when TLS connections may fail with the message `OpenSSL SSL_read: error:14094438:SSL routines:ssl3_read_bytes:tlsv1 alert internal error` and `SSL Exception: error:2400006E:random number generator::error retrieving entropy`. The issue was present in version 20.1. [#8956](https://github.com/ClickHouse/ClickHouse/pull/8956) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix clang-10 build. [#10238](https://github.com/ClickHouse/ClickHouse/issues/10238) [#10370](https://github.com/ClickHouse/ClickHouse/pull/10370) ([Amos Bird](https://github.com/amosbird))
- Add performance test for [Parallel INSERT for materialized view](https://github.com/ClickHouse/ClickHouse/pull/10052). [#10345](https://github.com/ClickHouse/ClickHouse/pull/10345) ([vxider](https://github.com/Vxider))
- Fix flaky test `test_settings_constraints_distributed.test_insert_clamps_settings`. [#10346](https://github.com/ClickHouse/ClickHouse/pull/10346) ([Vitaly Baranov](https://github.com/vitlibar))
- Add util to test results upload in CI ClickHouse [#10330](https://github.com/ClickHouse/ClickHouse/pull/10330) ([Ilya Yatsishin](https://github.com/qoega))
- Convert test results to JSONEachRow format in junit_to_html tool [#10323](https://github.com/ClickHouse/ClickHouse/pull/10323) ([Ilya Yatsishin](https://github.com/qoega))
- Update cctz. [#10215](https://github.com/ClickHouse/ClickHouse/pull/10215) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Allow to create HTML report from the purest JUnit XML report. [#10247](https://github.com/ClickHouse/ClickHouse/pull/10247) ([Ilya Yatsishin](https://github.com/qoega))
- Update the check for minimal compiler version. Fix the root cause of the issue [#10250](https://github.com/ClickHouse/ClickHouse/issues/10250) [#10256](https://github.com/ClickHouse/ClickHouse/pull/10256) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Initial support for live view tables over distributed [#10179](https://github.com/ClickHouse/ClickHouse/pull/10179) ([vzakaznikov](https://github.com/vzakaznikov))
- Fix (false) MSan report in MergeTreeIndexFullText. The issue first appeared in [#9968](https://github.com/ClickHouse/ClickHouse/issues/9968). [#10801](https://github.com/ClickHouse/ClickHouse/pull/10801) ([alexey-milovidov](https://github.com/alexey-milovidov))
- clickhouse-docker-util [#10151](https://github.com/ClickHouse/ClickHouse/pull/10151) ([filimonov](https://github.com/filimonov))
- Update pdqsort to recent version [#10171](https://github.com/ClickHouse/ClickHouse/pull/10171) ([Ivan](https://github.com/abyss7))
- Update libdivide to v3.0 [#10169](https://github.com/ClickHouse/ClickHouse/pull/10169) ([Ivan](https://github.com/abyss7))
- Add check with enabled polymorphic parts. [#10086](https://github.com/ClickHouse/ClickHouse/pull/10086) ([Anton Popov](https://github.com/CurtizJ))
- Add cross-compile build for FreeBSD. This fixes [#9465](https://github.com/ClickHouse/ClickHouse/issues/9465) [#9643](https://github.com/ClickHouse/ClickHouse/pull/9643) ([Ivan](https://github.com/abyss7))
- Add performance test for [#6924](https://github.com/ClickHouse/ClickHouse/issues/6924) [#6980](https://github.com/ClickHouse/ClickHouse/pull/6980) ([filimonov](https://github.com/filimonov))
- Add support of `/dev/null` in the `File` engine for better performance testing [#8455](https://github.com/ClickHouse/ClickHouse/pull/8455) ([Amos Bird](https://github.com/amosbird))
- Move all folders inside /dbms one level up [#9974](https://github.com/ClickHouse/ClickHouse/pull/9974) ([Ivan](https://github.com/abyss7))
- Add a test that checks that read from MergeTree with single thread is performed in order. Addition to [#9670](https://github.com/ClickHouse/ClickHouse/issues/9670) [#9762](https://github.com/ClickHouse/ClickHouse/pull/9762) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix the `00964_live_view_watch_events_heartbeat.py` test to avoid race condition. [#9944](https://github.com/ClickHouse/ClickHouse/pull/9944) ([vzakaznikov](https://github.com/vzakaznikov))
- Fix integration test `test_settings_constraints` [#9962](https://github.com/ClickHouse/ClickHouse/pull/9962) ([Vitaly Baranov](https://github.com/vitlibar))
- Every function in its own file, part 12. [#9922](https://github.com/ClickHouse/ClickHouse/pull/9922) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added performance test for the case of extremely slow analysis of array of tuples. [#9872](https://github.com/ClickHouse/ClickHouse/pull/9872) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update zstd to 1.4.4. It has some minor improvements in performance and compression ratio. If you run replicas with different versions of ClickHouse you may see reasonable error messages `Data after merge is not byte-identical to data on another replicas.` with explanation. These messages are Ok and you should not worry. [#10663](https://github.com/ClickHouse/ClickHouse/pull/10663) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix TSan report in `system.stack_trace`. [#9832](https://github.com/ClickHouse/ClickHouse/pull/9832) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Removed dependency on `clock_getres`. [#9833](https://github.com/ClickHouse/ClickHouse/pull/9833) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added identifier names check with clang-tidy. [#9799](https://github.com/ClickHouse/ClickHouse/pull/9799) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update "builder" docker image. This image is not used in CI but is useful for developers. [#9809](https://github.com/ClickHouse/ClickHouse/pull/9809) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Remove old `performance-test` tool that is no longer used in CI. `clickhouse-performance-test` is great but now we are using way superior tool that is doing comparison testing with sophisticated statistical formulas to achieve confident results regardless to various changes in environment. [#9796](https://github.com/ClickHouse/ClickHouse/pull/9796) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added most of clang-static-analyzer checks. [#9765](https://github.com/ClickHouse/ClickHouse/pull/9765) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update Poco to 1.9.3 in preparation for MongoDB URI support. [#6892](https://github.com/ClickHouse/ClickHouse/pull/6892) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Fix build with `-DUSE_STATIC_LIBRARIES=0 -DENABLE_JEMALLOC=0` [#9651](https://github.com/ClickHouse/ClickHouse/pull/9651) ([Artem Zuikov](https://github.com/4ertus2))
- For change log script, if merge commit was cherry-picked to release branch, take PR name from commit description. [#9708](https://github.com/ClickHouse/ClickHouse/pull/9708) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Support `vX.X-conflicts` tag in backport script. [#9705](https://github.com/ClickHouse/ClickHouse/pull/9705) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix `auto-label` for backporting script. [#9685](https://github.com/ClickHouse/ClickHouse/pull/9685) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Use libc++ in Darwin cross-build to make it consistent with native build. [#9665](https://github.com/ClickHouse/ClickHouse/pull/9665) ([Hui Wang](https://github.com/huiwang))
- Fix flacky test `01017_uniqCombined_memory_usage`. Continuation of [#7236](https://github.com/ClickHouse/ClickHouse/issues/7236). [#9667](https://github.com/ClickHouse/ClickHouse/pull/9667) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix build for native macOS Clang compiler [#9649](https://github.com/ClickHouse/ClickHouse/pull/9649) ([Ivan](https://github.com/abyss7))
- Allow to add various glitches around `pthread_mutex_lock`, `pthread_mutex_unlock` functions. [#9635](https://github.com/ClickHouse/ClickHouse/pull/9635) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add support for `clang-tidy` in `packager` script. [#9625](https://github.com/ClickHouse/ClickHouse/pull/9625) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add ability to use unbundled msgpack. [#10168](https://github.com/ClickHouse/ClickHouse/pull/10168) ([Azat Khuzhin](https://github.com/azat))





## Релиз ClickHouse v20.3 {#clickhouse-release-v203}

### Релиз ClickHouse v20.3.21.2-lts, 2020-11-02 {#clickhouse-release-v203212-lts-2020-11-02}

#### Исправление ошибок {#bug-fix-33}

- Исправлена работа `dictGet` в `sharding_key` (и аналогичных местах, то есть когда контекст функции сохраняется постоянно). [#16205](https://github.com/ClickHouse/ClickHouse/pull/16205) ([Azat Khuzhin](https://github.com/azat)).
- Исправлен ошибочный пустой результат для запроса к таблице `Distributed`, если запрос содержит `WHERE`, `PREWHERE` и `GLOBAL IN`. Исправляет [#15792](https://github.com/ClickHouse/ClickHouse/issues/15792). [#15933](https://github.com/ClickHouse/ClickHouse/pull/15933) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Исправлено отсутствие или избыточность заголовков в форматах `TSV/CSVWithNames`. Это исправляет [#12504](https://github.com/ClickHouse/ClickHouse/issues/12504). [#13343](https://github.com/ClickHouse/ClickHouse/pull/13343) ([Azat Khuzhin](https://github.com/azat)).

### Релиз ClickHouse v20.3.20.6-lts, 2020-10-09 {#clickhouse-release-v203206-lts-2020-10-09}

#### Исправление ошибок {#bug-fix-34}

- Мутация могла зависать в ожидании несуществующей части после `MOVE` или `REPLACE PARTITION` или, в редких случаях, после `DETACH` или `DROP PARTITION`. Это исправлено. [#15724](https://github.com/ClickHouse/ClickHouse/pull/15724), [#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix)).
- Исправлено зависание запросов с большим количеством подзапросов к одной и той же таблице движка `MySQL`. Ранее, если в запросе было более 16 подзапросов к одной и той же таблице `MySQL`, он зависал навсегда. [#15299](https://github.com/ClickHouse/ClickHouse/pull/15299) ([Anton Popов](https://github.com/CurtizJ)).
- Исправлена ошибка «Unknown identifier» в `GROUP BY`, когда запрос содержит `JOIN` по таблице `Merge`. [#15242](https://github.com/ClickHouse/ClickHouse/pull/15242) ([Artem Zuиков](https://github.com/4ertus2)).
- Исправлена работа механизма проталкивания предикатов, когда подзапрос содержит функцию `finalizeAggregation`. Исправляет [#14847](https://github.com/ClickHouse/ClickHouse/issues/14847). [#14937](https://github.com/ClickHouse/ClickHouse/pull/14937) ([filimonov](https://github.com/filimonov)).
- Параллельные запросы `ALTER ... REPLACE/MOVE PARTITION ...` могли приводить к взаимоблокировкам. Это исправлено. [#13626](https://github.com/ClickHouse/ClickHouse/pull/13626) ([tavplubix](https://github.com/tavplubix)).

### Релиз ClickHouse v20.3.19.4-lts, 2020-09-18 {#clickhouse-release-v203194-lts-2020-09-18}

#### Исправление ошибок {#bug-fix-35}


- Исправлена редкая ошибка в запросах `SELECT`, когда запрашиваемый столбец имеет выражение `DEFAULT`, которое зависит от другого столбца, также имеющего `DEFAULT`, отсутствующего в запросе select и не существующего на диске. Частично исправляет [#14531](https://github.com/ClickHouse/ClickHouse/issues/14531). [#14845](https://github.com/ClickHouse/ClickHouse/pull/14845) ([alesapin](https://github.com/alesapin)).
- Исправлена ошибка, когда мутация `ALTER UPDATE` со столбцом Nullable в выражении присваивания и константным значением (например, `UPDATE x = 42`) приводила к некорректному значению в столбце или segfault. Исправляет [#13634](https://github.com/ClickHouse/ClickHouse/issues/13634), [#14045](https://github.com/ClickHouse/ClickHouse/issues/14045). [#14646](https://github.com/ClickHouse/ClickHouse/pull/14646) ([alesapin](https://github.com/alesapin)).
- Исправлен неверный результат умножения Decimal, вызванный неправильным масштабом десятичного значения результирующего столбца. [#14603](https://github.com/ClickHouse/ClickHouse/pull/14603) ([Artem Zuikov](https://github.com/4ertus2)).

#### Улучшение {#improvement-17}

- Поддержка пользовательских кодеков в компактных частях. [#12183](https://github.com/ClickHouse/ClickHouse/pull/12183) ([Anton Popov](https://github.com/CurtizJ)).

### Релиз ClickHouse v20.3.18.10-lts, 2020-09-08 {#clickhouse-release-v2031810-lts-2020-09-08}

#### Исправление ошибок {#bug-fix-36}

- Остановка выполнения запроса при возникновении исключения в самом `PipelineExecutor`. Это может предотвратить редкое возможное зависание запроса. Продолжение [#14334](https://github.com/ClickHouse/ClickHouse/issues/14334). [#14402](https://github.com/ClickHouse/ClickHouse/pull/14402) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Исправлено поведение, когда иногда кэш-словарь возвращал значение по умолчанию вместо имеющегося значения из источника. [#13624](https://github.com/ClickHouse/ClickHouse/pull/13624) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Исправлен парсинг политик строк из users.xml, когда имена баз данных или таблиц содержат точки. Это исправляет [#5779](https://github.com/ClickHouse/ClickHouse/issues/5779), [#12527](https://github.com/ClickHouse/ClickHouse/issues/12527). [#13199](https://github.com/ClickHouse/ClickHouse/pull/13199) ([Vitaly Baranov](https://github.com/vitlibar)).
- Исправлен CAST(Nullable(String), Enum()). [#12745](https://github.com/ClickHouse/ClickHouse/pull/12745) ([Azat Khuzhin](https://github.com/azat)).
- Исправлена гонка данных в `text_log`. Не соответствует какой-либо реальной ошибке. [#9726](https://github.com/ClickHouse/ClickHouse/pull/9726) ([alexey-milovidov](https://github.com/alexey-milovidov)).

#### Улучшение {#improvement-18}

- Исправлена неверная ошибка для длинных запросов. Для корректного запроса можно было получить синтаксическую ошибку, отличную от `Max query size exceeded`. [#13928](https://github.com/ClickHouse/ClickHouse/pull/13928) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Возврат NULL/нуля, когда значение не полностью распознано в функциях parseDateTimeBestEffortOrNull/Zero. Это исправляет [#7876](https://github.com/ClickHouse/ClickHouse/issues/7876). [#11653](https://github.com/ClickHouse/ClickHouse/pull/11653) ([alexey-milovidov](https://github.com/alexey-milovidov)).

#### Улучшение производительности {#performance-improvement-12}

- Небольшая оптимизация очень коротких запросов с LowCardinality. [#14129](https://github.com/ClickHouse/ClickHouse/pull/14129) ([Anton Popov](https://github.com/CurtizJ)).

#### Улучшение сборки/тестирования/упаковки {#buildtestingpackaging-improvement-16}


- Исправлен отчёт UBSan (сложение нуля с nullptr) в HashTable, появившийся после миграции на clang-10. [#10638](https://github.com/ClickHouse/ClickHouse/pull/10638) ([alexey-milovidov](https://github.com/alexey-milovidov)).

### Релиз ClickHouse v20.3.17.173-lts, 2020-08-15 {#clickhouse-release-v20317173-lts-2020-08-15}

#### Исправления ошибок {#bug-fix-37}

- Исправлен сбой в JOIN со StorageMerge и при `set enable_optimize_predicate_expression=1`. [#13679](https://github.com/ClickHouse/ClickHouse/pull/13679) ([Artem Zuikov](https://github.com/4ertus2)).
- Исправлен некорректный тип возвращаемого значения при сравнении кортежей с элементами `NULL`. Исправляет [#12461](https://github.com/ClickHouse/ClickHouse/issues/12461). [#13420](https://github.com/ClickHouse/ClickHouse/pull/13420) ([Nikolai Kochetов](https://github.com/KochetovNicolai)).
- Исправлена обработка запросов с константными столбцами и префиксом первичного ключа в `ORDER BY`. [#13396](https://github.com/ClickHouse/ClickHouse/pull/13396) ([Anton Popov](https://github.com/CurtizJ)).
- Возвращать переданное число для чисел с установленным старшим битом (MSB) в roundUpToPowerOfTwoOrZero(). [#13234](https://github.com/ClickHouse/ClickHouse/pull/13234) ([Azat Khuzhin](https://github.com/azat)).

### Релиз ClickHouse v20.3.16.165-lts 2020-08-10 {#clickhouse-release-v20316165-lts-2020-08-10}

#### Исправления ошибок {#bug-fix-38}


* Исправлена ошибка в функции `parseDateTimeBestEffort`, возникавшая при передаче Unix timestamp в качестве аргумента. Это исправление закрывает [#13362](https://github.com/ClickHouse/ClickHouse/issues/13362). [#13441](https://github.com/ClickHouse/ClickHouse/pull/13441) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены потенциально низкая производительность и слегка некорректный результат для агрегатных функций `uniqExact`, `topK`, `sumDistinct` и аналогичных, вызываемых для типов Float со значениями `NaN`. Это также приводило к срабатыванию `assert` в отладочной сборке. Исправляет [#12491](https://github.com/ClickHouse/ClickHouse/issues/12491). [#13254](https://github.com/ClickHouse/ClickHouse/pull/13254) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена функция if с nullable constexpr в качестве cond, не являющимся литералом NULL. Исправляет [#12463](https://github.com/ClickHouse/ClickHouse/issues/12463). [#13226](https://github.com/ClickHouse/ClickHouse/pull/13226) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена проверка `assert` в функции `arrayElement` в случае, когда элементы массива имеют тип Nullable и индекс массива также имеет тип Nullable. Это исправляет [#12172](https://github.com/ClickHouse/ClickHouse/issues/12172). [#13224](https://github.com/ClickHouse/ClickHouse/pull/13224) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено избыточное ограничение числа потоков для `SELECT` из локальной реплики. [#12840](https://github.com/ClickHouse/ClickHouse/pull/12840) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена возможная лишняя строка с итогами в данных, которая могла появляться для запросов `WITH TOTALS`. [#12747](https://github.com/ClickHouse/ClickHouse/pull/12747) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена производительность при работе с большими кортежами, которые в `IN`-выражении интерпретируются как функции. Это касается случаев, когда пользователь по какой-то непонятной причине пишет `WHERE x IN tuple(1, 2, ...)` вместо `WHERE x IN (1, 2, ...)`. [#12700](https://github.com/ClickHouse/ClickHouse/pull/12700) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено отслеживание памяти для input&#95;format&#95;parallel&#95;parsing (за счёт привязки потока к группе). [#12672](https://github.com/ClickHouse/ClickHouse/pull/12672) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено [#12293](https://github.com/ClickHouse/ClickHouse/issues/12293) — разрешено проталкивание предиката, когда подзапрос содержит `WITH`‑секцию. [#12663](https://github.com/ClickHouse/ClickHouse/pull/12663) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена [#10572](https://github.com/ClickHouse/ClickHouse/issues/10572) — ошибка в индексе bloom filter при использовании константного выражения. [#12659](https://github.com/ClickHouse/ClickHouse/pull/12659) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена ошибка SIGSEGV в `StorageKafka`, возникавшая при недоступности брокера (и в других случаях). [#12658](https://github.com/ClickHouse/ClickHouse/pull/12658) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена гонка в внешних словарях с кэшируемым размещением, которая могла приводить к сбою сервера. [#12566](https://github.com/ClickHouse/ClickHouse/pull/12566) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка, приводившая к повреждению старых частей после запроса `ALTER DELETE` при `enable_mixed_granularity_parts=1`. Исправляет [#12536](https://github.com/ClickHouse/ClickHouse/issues/12536). [#12543](https://github.com/ClickHouse/ClickHouse/pull/12543) ([alesapin](https://github.com/alesapin)).
* Улучшено сообщение об исключении для функции `in` при неверном количестве аргументов. [#12529](https://github.com/ClickHouse/ClickHouse/pull/12529) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена проблема с производительностью при чтении из компактных частей. [#12492](https://github.com/ClickHouse/ClickHouse/pull/12492) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена взаимная блокировка при включенном `text_log`. [#12452](https://github.com/ClickHouse/ClickHouse/pull/12452) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена возможная ошибка сегментации при работе `StorageMerge`. Закрывает [#12054](https://github.com/ClickHouse/ClickHouse/issues/12054). [#12401](https://github.com/ClickHouse/ClickHouse/pull/12401) ([tavplubix](https://github.com/tavplubix)).
* Исправлена работа `TOTALS/ROLLUP/CUBE` для агрегатных функций с аргументами `-State` и `Nullable`. Это решает проблему [#12163](https://github.com/ClickHouse/ClickHouse/issues/12163). [#12376](https://github.com/ClickHouse/ClickHouse/pull/12376) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен порядок столбцов в модификаторе `WITH FILL`. Ранее порядок столбцов в операторе `ORDER BY` не соблюдался. [#12306](https://github.com/ClickHouse/ClickHouse/pull/12306) ([Anton Popov](https://github.com/CurtizJ)).
* Избегает возникновения исключения «bad cast», когда используется выражение, фильтрующее данные по виртуальным столбцам (таким как `_table` в таблицах `Merge`) или по столбцам «index» в системных таблицах, например при фильтрации по имени базы данных при запросе к `system.tables`, и это выражение возвращает тип `Nullable`. Это исправляет [#12166](https://github.com/ClickHouse/ClickHouse/issues/12166). [#12305](https://github.com/ClickHouse/ClickHouse/pull/12305) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Показывать ошибку после сбоя загрузки `TrieDictionary`. [#12290](https://github.com/ClickHouse/ClickHouse/pull/12290) ([Vitaly Baranov](https://github.com/vitlibar)).
* Функция `arrayFill` работала некорректно для пустых массивов, что могло приводить к падению. Это исправляет [#12263](https://github.com/ClickHouse/ClickHouse/issues/12263). [#12279](https://github.com/ClickHouse/ClickHouse/pull/12279) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Реализованы преобразования к общему типу для типов `LowCardinality`. Это позволяет выполнять UNION ALL таблиц со столбцами типа LowCardinality и другими столбцами. Исправлено [#8212](https://github.com/ClickHouse/ClickHouse/issues/8212). Исправлено [#4342](https://github.com/ClickHouse/ClickHouse/issues/4342). [#12275](https://github.com/ClickHouse/ClickHouse/pull/12275) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено поведение, при котором при нескольких последовательных вставках в `StorageFile` заголовок для некоторых специальных типов записывался более одного раза. Это исправило [#6155](https://github.com/ClickHouse/ClickHouse/issues/6155). [#12197](https://github.com/ClickHouse/ClickHouse/pull/12197) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена работа логических функций для значений UInt8, отличных от 0 и 1. [#12196](https://github.com/ClickHouse/ClickHouse/pull/12196) ([Alexander Kazakov](https://github.com/Akazz)).
* Исправлена проверка аргументов `dictGet` при устранении инъективных функций в GROUP BY. [#12179](https://github.com/ClickHouse/ClickHouse/pull/12179) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена неверная логика в `ALTER DELETE`, приводившая к удалению записей, когда результат условия имел значение NULL. Исправляет [#9088](https://github.com/ClickHouse/ClickHouse/issues/9088). Закрывает [#12106](https://github.com/ClickHouse/ClickHouse/issues/12106). [#12153](https://github.com/ClickHouse/ClickHouse/pull/12153) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено преобразование запроса, отправляемого во внешние СУБД (например, MySQL, ODBC), при наличии псевдонимов. Это исправляет [#12032](https://github.com/ClickHouse/ClickHouse/issues/12032). [#12151](https://github.com/ClickHouse/ClickHouse/pull/12151) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено потенциальное переполнение при целочисленном делении. Это устраняет [#12119](https://github.com/ClickHouse/ClickHouse/issues/12119). [#12140](https://github.com/ClickHouse/ClickHouse/pull/12140) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен потенциальный бесконечный цикл в функциях `greatCircleDistance` и `geoDistance`. Это устраняет проблему [#12117](https://github.com/ClickHouse/ClickHouse/issues/12117). [#12137](https://github.com/ClickHouse/ClickHouse/pull/12137) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Избежано появление исключения `There is no query` для материализованных представлений с соединениями или с подзапросами, подключёнными к системным логам (system.query&#95;log, metric&#95;log и т. д.) или к базовой таблице с движком Buffer. [#12120](https://github.com/ClickHouse/ClickHouse/pull/12120) ([filimonov](https://github.com/filimonov)).
* Исправлена производительность запросов `SELECT` с `UNION`, страдавшая из-за неверного ограничения на общее количество потоков. Исправляет [#12030](https://github.com/ClickHouse/ClickHouse/issues/12030). [#12103](https://github.com/ClickHouse/ClickHouse/pull/12103) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка сегментирования памяти с комбинаторами `-StateResample`. [#12092](https://github.com/ClickHouse/ClickHouse/pull/12092) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено ненужное ограничение числа потоков для запросов `SELECT` к `VIEW`. Исправляет [#11937](https://github.com/ClickHouse/ClickHouse/issues/11937). [#12085](https://github.com/ClickHouse/ClickHouse/pull/12085) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен возможный сбой при использовании некорректного типа для `PREWHERE`. Исправляет [#12053](https://github.com/ClickHouse/ClickHouse/issues/12053), [#12060](https://github.com/ClickHouse/ClickHouse/issues/12060). [#12060](https://github.com/ClickHouse/ClickHouse/pull/12060) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка `Expected single dictionary argument for function` в функции `defaultValueOfArgumentType` с типом `LowCardinality`. Исправляет [#11808](https://github.com/ClickHouse/ClickHouse/issues/11808). [#12056](https://github.com/ClickHouse/ClickHouse/pull/12056) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка `Cannot capture column` для функций высшего порядка с аргументом `Tuple(LowCardinality)`. Исправляет [#9766](https://github.com/ClickHouse/ClickHouse/issues/9766). [#12055](https://github.com/ClickHouse/ClickHouse/pull/12055) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Параллельный разбор метаданных таблиц при загрузке базы данных. Это устраняет медленный запуск сервера при большом количестве таблиц. [#12045](https://github.com/ClickHouse/ClickHouse/pull/12045) ([tavplubix](https://github.com/tavplubix)).
* Агрегатная функция `topK` для типов Enum теперь возвращает Enum. Это исправляет [#3740](https://github.com/ClickHouse/ClickHouse/issues/3740). [#12043](https://github.com/ClickHouse/ClickHouse/pull/12043) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена проверка ограничений: теперь проверяется, является ли ограничение константным выражением. Это исправляет [#11360](https://github.com/ClickHouse/ClickHouse/issues/11360). [#12042](https://github.com/ClickHouse/ClickHouse/pull/12042) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено некорректное сравнение кортежей с колонками типа `Nullable`. Исправляет [#11985](https://github.com/ClickHouse/ClickHouse/issues/11985). [#12039](https://github.com/ClickHouse/ClickHouse/pull/12039) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлены некорректный результат и возможный сбой при вызове функции `if` с аргументами типа `FixedString` разного размера. Это исправляет [#11362](https://github.com/ClickHouse/ClickHouse/issues/11362). [#12021](https://github.com/ClickHouse/ClickHouse/pull/12021) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Запрос, в котором функция `neighbor` является единственным возвращаемым выражением, может вернуть пустой результат, если функция вызывается со смещением `-9223372036854775808`. Исправляет [#11367](https://github.com/ClickHouse/ClickHouse/issues/11367). [#12019](https://github.com/ClickHouse/ClickHouse/pull/12019) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено потенциальное переполнение размера массива в generateRandom, которое могло приводить к сбою. Это исправляет [#11371](https://github.com/ClickHouse/ClickHouse/issues/11371). [#12013](https://github.com/ClickHouse/ClickHouse/pull/12013) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено потенциальное исключение с плавающей запятой. Закрывает [#11378](https://github.com/ClickHouse/ClickHouse/issues/11378). [#12005](https://github.com/ClickHouse/ClickHouse/pull/12005) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено некорректное имя настройки в сообщении журнала при запуске сервера. [#11997](https://github.com/ClickHouse/ClickHouse/pull/11997) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено сообщение об ошибке `Query parameter was not set` в формате `Values`. Исправляет [#11918](https://github.com/ClickHouse/ClickHouse/issues/11918). [#11936](https://github.com/ClickHouse/ClickHouse/pull/11936) ([tavplubix](https://github.com/tavplubix)).
* Сохранять псевдонимы для подстановок в запросе (параметризованные запросы). Исправляет [#11914](https://github.com/ClickHouse/ClickHouse/issues/11914). [#11916](https://github.com/ClickHouse/ClickHouse/pull/11916) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено потенциальное исключение «деление на ноль с плавающей запятой» при парсинге DateTime64. Это исправляет [#11374](https://github.com/ClickHouse/ClickHouse/issues/11374). [#11875](https://github.com/ClickHouse/ClickHouse/pull/11875) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен учёт памяти при работе через интерфейс `HTTP` (может существенно влиять при `wait_end_of_query=1`). [#11840](https://github.com/ClickHouse/ClickHouse/pull/11840) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен неверный результат функции `if()` при использовании NULL в условии. [#11807](https://github.com/ClickHouse/ClickHouse/pull/11807) ([Artem Zuikov](https://github.com/4ertus2)).
* Разбирать метаданные, хранящиеся в ZooKeeper, перед проверкой на равенство. [#11739](https://github.com/ClickHouse/ClickHouse/pull/11739) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено использование `LIMIT n WITH TIES` вместе с оператором `ORDER BY`, содержащим псевдонимы. [#11689](https://github.com/ClickHouse/ClickHouse/pull/11689) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено потенциальное чтение неинициализированной памяти в кэш-словаре. [#10834](https://github.com/ClickHouse/ClickHouse/pull/10834) ([alexey-milovidov](https://github.com/alexey-milovidov)).

#### Улучшение производительности {#performance-improvement-13}

- Индекс не использовался для оператора IN с литералами, регрессия производительности введена в версии v19.3. Исправляет [#10574](https://github.com/ClickHouse/ClickHouse/issues/10574). [#12062](https://github.com/ClickHouse/ClickHouse/pull/12062) ([nvartolomei](https://github.com/nvartolomei)).

### Релиз ClickHouse v20.3.12.112-lts 2020-06-25 {#clickhouse-release-v20312112-lts-2020-06-25}

#### Исправление ошибок {#bug-fix-39}


* Исправлен редкий сбой, вызванный использованием столбца типа `Nullable` в условии PREWHERE. Продолжение [#11608](https://github.com/ClickHouse/ClickHouse/issues/11608). [#11869](https://github.com/ClickHouse/ClickHouse/pull/11869) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Запрещено использовать arrayJoin внутри функций высшего порядка. Это приводило к нарушению синхронизации протокола. Закрывает [#3933](https://github.com/ClickHouse/ClickHouse/issues/3933). [#11846](https://github.com/ClickHouse/ClickHouse/pull/11846) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена проблема с использованием слишком большого числа потоков для запросов. [#11788](https://github.com/ClickHouse/ClickHouse/pull/11788) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено неожиданное поведение запросов вида `SELECT *, xyz.*`, которые выполнялись успешно, хотя должна была возникать ошибка. [#11753](https://github.com/ClickHouse/ClickHouse/pull/11753) ([hexiaoting](https://github.com/hexiaoting)).
* Теперь реплицируемые загрузки (fetches) будут отменяться во время изменения метаданных. [#11744](https://github.com/ClickHouse/ClickHouse/pull/11744) ([alesapin](https://github.com/alesapin)).
* Исправлена LOGICAL&#95;ERROR, возникавшая из-за неверного определения типа сложных литералов во входном формате Values. [#11732](https://github.com/ClickHouse/ClickHouse/pull/11732) ([tavplubix](https://github.com/tavplubix)).
* Исправлена работа `ORDER BY ... WITH FILL` с константными столбцами. [#11697](https://github.com/ClickHouse/ClickHouse/pull/11697) ([Anton Popov](https://github.com/CurtizJ)).
* Передавайте корректные значения тайм-аутов при взаимодействии с мостом XDBC. Ранее тайм-ауты не учитывались при проверке работы моста и при получении метаинформации. [#11690](https://github.com/ClickHouse/ClickHouse/pull/11690) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка, приводившая к некорректному состоянию `system.mutations`. Она могла показывать, что вся мутация уже выполнена, хотя на сервере все еще оставались задания `MUTATE_PART` в очереди репликации, и он продолжал пытаться их выполнять. Это исправляет [#11611](https://github.com/ClickHouse/ClickHouse/issues/11611). [#11681](https://github.com/ClickHouse/ClickHouse/pull/11681) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка регулярных выражений с флагами, не зависящими от регистра. Это исправляет [#11101](https://github.com/ClickHouse/ClickHouse/issues/11101) и [#11506](https://github.com/ClickHouse/ClickHouse/issues/11506). [#11649](https://github.com/ClickHouse/ClickHouse/pull/11649) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Удалена оптимизация тривиальных запросов `COUNT`, если настроена безопасность на уровне строк (row-level security). В предыдущих версиях пользователь получал общее количество записей в таблице, а не отфильтрованное. Это исправляет [#11352](https://github.com/ClickHouse/ClickHouse/issues/11352). [#11644](https://github.com/ClickHouse/ClickHouse/pull/11644) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены фильтры Блума для `String` (индексы пропуска данных). [#11638](https://github.com/ClickHouse/ClickHouse/pull/11638) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен редкий сбой, вызванный использованием столбца `Nullable` в условии PREWHERE. (Вероятно, это как‑то связано с [#11572](https://github.com/ClickHouse/ClickHouse/issues/11572)). [#11608](https://github.com/ClickHouse/ClickHouse/pull/11608) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка `Block structure mismatch` для запросов с выборкой при чтении из таблицы `Buffer`. [#11602](https://github.com/ClickHouse/ClickHouse/pull/11602) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен неверный код завершения `clickhouse-client`, когда `exception.code() % 256 = 0`. [#11601](https://github.com/ClickHouse/ClickHouse/pull/11601) ([filimonov](https://github.com/filimonov)).
* Исправлена тривиальная ошибка в сообщении лога «Mark cache size was lowered» при запуске сервера. Закрывает [#11399](https://github.com/ClickHouse/ClickHouse/issues/11399). [#11589](https://github.com/ClickHouse/ClickHouse/pull/11589) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка `Size of offsets does not match size of column` в запросах с `PREWHERE column in (subquery)` и `ARRAY JOIN`. [#11580](https://github.com/ClickHouse/ClickHouse/pull/11580) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Все запросы в HTTP-сессии имели один и тот же `query_id`. Ошибка исправлена. [#11578](https://github.com/ClickHouse/ClickHouse/pull/11578) ([tavplubix](https://github.com/tavplubix)).
* Теперь docker-контейнер clickhouse-server при проверке работоспособности сервера будет использовать IPv6 по умолчанию. [#11550](https://github.com/ClickHouse/ClickHouse/pull/11550) ([Ivan Starkov](https://github.com/istarkov)).
* Исправлены значения shard&#95;num/replica&#95;num для `<node>` (из-за ошибки не работал use&#95;compact&#95;format&#95;in&#95;distributed&#95;parts&#95;names). [#11528](https://github.com/ClickHouse/ClickHouse/pull/11528) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена утечка памяти при возникновении исключения в середине агрегации с функциями `-State`. Это исправляет [#8995](https://github.com/ClickHouse/ClickHouse/issues/8995). [#11496](https://github.com/ClickHouse/ClickHouse/pull/11496) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены некорректные результаты распределённых запросов, возникавшие, когда псевдоним мог переопределять квалифицированное имя столбца. Исправлено в [#9672](https://github.com/ClickHouse/ClickHouse/issues/9672), [#9714](https://github.com/ClickHouse/ClickHouse/issues/9714). [#9972](https://github.com/ClickHouse/ClickHouse/pull/9972) ([Artem Zuikov](https://github.com/4ertus2)).

### Релиз ClickHouse v20.3.11.97-lts 2020-06-10 {#clickhouse-release-v2031197-lts-2020-06-10}

#### Новая функциональность {#new-feature-9}

- Теперь ClickHouse самостоятельно контролирует таймауты источников словарей. В конфигурацию кэширующего словаря добавлены две новые настройки: `strict_max_lifetime_seconds`, которая по умолчанию равна `max_lifetime`, и `query_wait_timeout_milliseconds`, которая по умолчанию равна одной минуте. Первая настройка также полезна в сочетании с настройкой `allow_read_expired_keys` (для запрета чтения сильно устаревших ключей). [#10337](https://github.com/ClickHouse/ClickHouse/pull/10337) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).

#### Исправление ошибок {#bug-fix-40}


* Исправлена ошибка `Data compressed with different methods`, которая могла возникать при включённом `min_bytes_to_use_direct_io`, активном PREWHERE и использовании SAMPLE или большого числа потоков. Это исправляет [#11539](https://github.com/ClickHouse/ClickHouse/issues/11539). [#11540](https://github.com/ClickHouse/ClickHouse/pull/11540) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен возвращаемый размер сжатых данных кодеков. [#11448](https://github.com/ClickHouse/ClickHouse/pull/11448) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен сбой сервера, возникавший, когда для столбца был задан кодек сжатия с нелитеральными аргументами. Исправляет [#11365](https://github.com/ClickHouse/ClickHouse/issues/11365). [#11431](https://github.com/ClickHouse/ClickHouse/pull/11431) ([alesapin](https://github.com/alesapin)).
* Исправлена функция pointInPolygon при использовании nan в качестве точки. Исправление [#11375](https://github.com/ClickHouse/ClickHouse/issues/11375). [#11421](https://github.com/ClickHouse/ClickHouse/pull/11421) ([Alexey Ilyukhov](https://github.com/livace)).
* Исправлена ошибка, приводившая к падению при выполнении JOIN над LowCarinality(T) и Nullable(T). [#11380](https://github.com/ClickHouse/ClickHouse/issues/11380). [#11414](https://github.com/ClickHouse/ClickHouse/pull/11414) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлен код ошибки для некорректного ключа `USING`. [#11373](https://github.com/ClickHouse/ClickHouse/issues/11373). [#11404](https://github.com/ClickHouse/ClickHouse/pull/11404) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлена работа функции geohashesInBox с аргументами вне допустимого диапазона широты/долготы. [#11403](https://github.com/ClickHouse/ClickHouse/pull/11403) ([Vasily Nemkov](https://github.com/Enmk)).
* Улучшены сообщения об ошибках для функций `joinGet()`. [#11389](https://github.com/ClickHouse/ClickHouse/pull/11389) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлена возможная ошибка `Pipeline stuck` для запросов с внешней сортировкой и ограничением. Исправление для [#11359](https://github.com/ClickHouse/ClickHouse/issues/11359). [#11366](https://github.com/ClickHouse/ClickHouse/pull/11366) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Удалена избыточная блокировка при отправке кусков в ReplicatedMergeTree. [#11354](https://github.com/ClickHouse/ClickHouse/pull/11354) ([alesapin](https://github.com/alesapin)).
* Исправлена поддержка `\G` (вертикальный вывод) в clickhouse-client в режиме многострочного ввода. Это закрывает [#9933](https://github.com/ClickHouse/ClickHouse/issues/9933). [#11350](https://github.com/ClickHouse/ClickHouse/pull/11350) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлен сбой при прямых запросах к StorageJoin (без JOIN) и некорректная обработка NULL-значений. [#11340](https://github.com/ClickHouse/ClickHouse/pull/11340) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлено падение в `quantilesExactWeightedArray`. [#11337](https://github.com/ClickHouse/ClickHouse/pull/11337) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Теперь слияния останавливаются перед изменением метаданных в запросах `ALTER`. [#11335](https://github.com/ClickHouse/ClickHouse/pull/11335) ([alesapin](https://github.com/alesapin)).
* Снова сделана параллельной запись в `MATERIALIZED VIEW` при настройке `parallel_view_processing = 1`. Исправляет [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241). [#11330](https://github.com/ClickHouse/ClickHouse/pull/11330) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена функция visitParamExtractRaw для случая, когда извлечённый JSON содержит строки с несбалансированными &#123; или [. [#11318](https://github.com/ClickHouse/ClickHouse/pull/11318) ([Ewout](https://github.com/devwout)).
* Исправлено крайне редкое состояние гонки в `ThreadPool`. [#11314](https://github.com/ClickHouse/ClickHouse/pull/11314) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена возможная работа с неинициализированной памятью при преобразовании. Пример: `SELECT toIntervalSecond(now64())`. [#11311](https://github.com/ClickHouse/ClickHouse/pull/11311) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена проблема, из‑за которой анализ индексов не работал, если в первичный ключ таблицы входил столбец типа `Array`, а запрос фильтровал по этому столбцу с помощью функций `empty` или `notEmpty`. Это исправляет [#11286](https://github.com/ClickHouse/ClickHouse/issues/11286). [#11303](https://github.com/ClickHouse/ClickHouse/pull/11303) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка, из-за которой оценка скорости выполнения запроса могла быть некорректной, а ограничение `min_execution_speed` могло не работать или работать неправильно, если запрос ограничивается настройками `max_network_bandwidth`, `max_execution_speed` или `priority`. Значение по умолчанию для `timeout_before_checking_execution_speed` изменено на ненулевое, потому что иначе настройки `min_execution_speed` и `max_execution_speed` не оказывают никакого эффекта. Исправлено [#11297](https://github.com/ClickHouse/ClickHouse/issues/11297). Исправлено [#5732](https://github.com/ClickHouse/ClickHouse/issues/5732). Исправлено [#6228](https://github.com/ClickHouse/ClickHouse/issues/6228). Улучшение удобства использования: исключена конкатенация сообщения об исключении с индикатором прогресса в `clickhouse-client`. [#11296](https://github.com/ClickHouse/ClickHouse/pull/11296) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено падение при чтении некорректных данных в формате Protobuf. Исправляет [#5957](https://github.com/ClickHouse/ClickHouse/issues/5957), исправляет [#11203](https://github.com/ClickHouse/ClickHouse/issues/11203). [#11258](https://github.com/ClickHouse/ClickHouse/pull/11258) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена ошибка, из‑за которой `cache-dictionary` мог возвращать значение по умолчанию вместо корректного (когда есть только истекшие ключи). Это затрагивает только строковые поля. [#11233](https://github.com/ClickHouse/ClickHouse/pull/11233) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена ошибка `Block structure mismatch in QueryPipeline` при чтении из `VIEW` с константами во внутреннем запросе. Исправление для [#11181](https://github.com/ClickHouse/ClickHouse/issues/11181). [#11205](https://github.com/ClickHouse/ClickHouse/pull/11205) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена возможная ошибка `Invalid status for associated output`. [#11200](https://github.com/ClickHouse/ClickHouse/pull/11200) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена возможная ошибка `Cannot capture column` для функций высшего порядка с захватываемым аргументом типа `Array(Array(LowCardinality))`. [#11185](https://github.com/ClickHouse/ClickHouse/pull/11185) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена обработка шаблонов (globbing) в S3, которая могла завершаться сбоем при наличии более 1000 ключей в некоторых бэкендах. [#11179](https://github.com/ClickHouse/ClickHouse/pull/11179) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Если индекс пропуска данных зависит от столбцов, которые будут изменены во время фонового слияния (для SummingMergeTree, AggregatingMergeTree, а также для TTL GROUP BY), он вычислялся некорректно. Эта проблема исправлена переносом вычисления индекса на этап после слияния, чтобы индекс вычислялся по уже слитым данным. [#11162](https://github.com/ClickHouse/ClickHouse/pull/11162) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено чрезмерное резервирование потоков для простых запросов (оптимизация по сокращению количества потоков, частично нарушенная после изменений в конвейере обработки). [#11114](https://github.com/ClickHouse/ClickHouse/pull/11114) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена оптимизация предикатов для распределённых запросов (`enable_optimize_predicate_expression=1`) в запросах с разделом `HAVING` (то есть когда требуется фильтрация на сервере-инициаторе) за счёт сохранения порядка выражений (чего достаточно для исправления), а также принудительного использования агрегатором имён столбцов вместо индексов. Исправления: [#10613](https://github.com/ClickHouse/ClickHouse/issues/10613), [#11413](https://github.com/ClickHouse/ClickHouse/issues/11413). [#10621](https://github.com/ClickHouse/ClickHouse/pull/10621) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена логика повторных попыток фиксации смещений, чтобы уменьшить вероятность получения дубликатов из Kafka в редких случаях, когда не удалось зафиксировать смещение. [#9884](https://github.com/ClickHouse/ClickHouse/pull/9884) ([filimonov](https://github.com/filimonov)).

#### Улучшение производительности {#performance-improvement-14}

- Получение словаря и проверка прав доступа теперь выполняются только один раз при каждом вызове функции, читающей внешние словари. [#10928](https://github.com/ClickHouse/ClickHouse/pull/10928) ([Vitaly Baranov](https://github.com/vitlibar)).

#### Улучшение сборки/тестирования/упаковки {#buildtestingpackaging-improvement-17}

- Исправлено несколько нестабильных интеграционных тестов. [#11355](https://github.com/ClickHouse/ClickHouse/pull/11355) ([alesapin](https://github.com/alesapin)).

### Релиз ClickHouse v20.3.10.75-lts 2020-05-23 {#clickhouse-release-v2031075-lts-2020-05-23}

#### Исправление ошибок {#bug-fix-41}


* Убрано логирование из задачи финализации мутаций, если ничего не было финализировано. [#11109](https://github.com/ClickHouse/ClickHouse/pull/11109) ([alesapin](https://github.com/alesapin)).
* Исправлены ошибки обработки аргументов в `parseDateTime64BestEffort`. [#11038](https://github.com/ClickHouse/ClickHouse/pull/11038) ([Vasily Nemkov](https://github.com/Enmk)).
* Исправлен некорректный размер «сырых» данных в методе `getRawData()`. [#10964](https://github.com/ClickHouse/ClickHouse/pull/10964) ([Igr](https://github.com/ObjatieGroba)).
* Исправлена несовместимость двухуровневой агрегации между версией 20.1 и более ранними версиями. Эта несовместимость проявляется, когда на узле-инициаторе и удалённых узлах используются разные версии ClickHouse, размер результата `GROUP BY` велик, и агрегация выполняется по единственному полю типа `String`. Это приводит к появлению нескольких несведённых строк для одного ключа в результате. [#10952](https://github.com/ClickHouse/ClickHouse/pull/10952) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена обратная совместимость с кортежами в таблицах `Distributed`. [#10889](https://github.com/ClickHouse/ClickHouse/pull/10889) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен `SIGSEGV` в `StringHashTable`, возникающий при отсутствии ключа. [#10870](https://github.com/ClickHouse/ClickHouse/pull/10870) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка в `ReplicatedMergeTree`, из-за которой некоторые запросы `ALTER` при выполнении `OPTIMIZE` могли зависать в ожидании реплики после того, как она переходила в неактивное состояние. [#10849](https://github.com/ClickHouse/ClickHouse/pull/10849) ([tavplubix](https://github.com/tavplubix)).
* Исправлен порядок столбцов после вызова `Block::sortColumns()`. [#10826](https://github.com/ClickHouse/ClickHouse/pull/10826) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема с мостом `ODBC`, возникавшая при отключённом экранировании идентификаторов. Исправляет [#7984](https://github.com/ClickHouse/ClickHouse/issues/7984). [#10821](https://github.com/ClickHouse/ClickHouse/pull/10821) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены отчеты `UBSan` и `MSan` в `DateLUT`. [#10798](https://github.com/ClickHouse/ClickHouse/pull/10798) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено некорректное преобразование типов в условиях по ключу. Исправление для [#6287](https://github.com/ClickHouse/ClickHouse/issues/6287). [#10791](https://github.com/ClickHouse/ClickHouse/pull/10791) ([Andrew Onyshchuk](https://github.com/oandrew))
* Исправлено поведение `parallel_view_processing`. Теперь все вставки в `MATERIALIZED VIEW` в любом случае будут завершены, даже если произошло исключение. Исправляет [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241). [#10757](https://github.com/ClickHouse/ClickHouse/pull/10757) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена работа комбинаторов `-OrNull` и `-OrDefault` при совместном использовании с `-State`. [#10741](https://github.com/ClickHouse/ClickHouse/pull/10741) ([hcz](https://github.com/hczhcz)).
* Исправлена ошибка, приводившая к сбою `generateRandom` при работе с вложенными типами. Исправляет [#10583](https://github.com/ClickHouse/ClickHouse/issues/10583). [#10734](https://github.com/ClickHouse/ClickHouse/pull/10734) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена порча данных в ключевом столбце `LowCardinality(FixedString)` в `SummingMergeTree`, которая могла происходить после слияния. Исправляет [#10489](https://github.com/ClickHouse/ClickHouse/issues/10489). [#10721](https://github.com/ClickHouse/ClickHouse/pull/10721) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено потенциальное переполнение буфера в функции `h3EdgeAngle`. [#10711](https://github.com/ClickHouse/ClickHouse/pull/10711) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено исчезновение totals. Значения totals могли отфильтровываться, если запрос содержал `JOIN` или подзапрос с внешним условием `WHERE`. Исправление для [#10674](https://github.com/ClickHouse/ClickHouse/issues/10674). [#10698](https://github.com/ClickHouse/ClickHouse/pull/10698) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена работа с несколькими использованиями оператора `IN` с одним и тем же набором значений в рамках одного запроса. [#10686](https://github.com/ClickHouse/ClickHouse/pull/10686) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка, из-за которой HTTP-запросы зависали при закрытии клиента при `readonly=2` и `cancel_http_readonly_queries_on_client_close=1`. Исправлены [#7939](https://github.com/ClickHouse/ClickHouse/issues/7939), [#7019](https://github.com/ClickHouse/ClickHouse/issues/7019), [#7736](https://github.com/ClickHouse/ClickHouse/issues/7736), [#7091](https://github.com/ClickHouse/ClickHouse/issues/7091). [#10684](https://github.com/ClickHouse/ClickHouse/pull/10684) ([tavplubix](https://github.com/tavplubix)).
* Исправлен порядок параметров в конструкторе `AggregateTransform`. [#10667](https://github.com/ClickHouse/ClickHouse/pull/10667) ([palasonic1](https://github.com/palasonic1)).
* Исправлено отсутствие параллельного выполнения удалённых запросов при включённом `distributed_aggregation_memory_efficient`. Исправлена проблема [#10655](https://github.com/ClickHouse/ClickHouse/issues/10655). [#10664](https://github.com/ClickHouse/ClickHouse/pull/10664) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена возможная некорректность числа строк в результатах запросов с `LIMIT`. Исправляет [#10566](https://github.com/ClickHouse/ClickHouse/issues/10566), [#10709](https://github.com/ClickHouse/ClickHouse/issues/10709). [#10660](https://github.com/ClickHouse/ClickHouse/pull/10660) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, из-за которой блокировались параллельные операции `ALTER` при большом количестве частей в таблице. [#10659](https://github.com/ClickHouse/ClickHouse/pull/10659) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка, из-за которой запрос `SYSTEM DROP DNS CACHE` также сбрасывал кеши, используемые для проверки, имеет ли пользователь право подключаться с некоторых IP-адресов. [#10608](https://github.com/ClickHouse/ClickHouse/pull/10608) ([tavplubix](https://github.com/tavplubix)).
* Исправлены некорректные скалярные результаты во внутреннем запросе `MATERIALIZED VIEW` в случае, когда этот запрос содержал зависимую таблицу. [#10603](https://github.com/ClickHouse/ClickHouse/pull/10603) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен `SELECT` для столбца `ALIAS`, у которого тип выражения по умолчанию отличается от типа столбца. [#10563](https://github.com/ClickHouse/ClickHouse/pull/10563) ([Azat Khuzhin](https://github.com/azat)).
* Реализовано сравнение значений типов `DateTime64` и `String`. [#10560](https://github.com/ClickHouse/ClickHouse/pull/10560) ([Vasily Nemkov](https://github.com/Enmk)).
* Исправлено повреждение индексов, которое в некоторых случаях могло происходить после слияния компактных кусков в другой компактный кусок. [#10531](https://github.com/ClickHouse/ClickHouse/pull/10531) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ситуация, когда мутация обработала все части, но зависла в состоянии `is_done=0`. [#10526](https://github.com/ClickHouse/ClickHouse/pull/10526) ([alesapin](https://github.com/alesapin)).
* Исправлено переполнение в начале эпохи Unix для часовых поясов с дробным смещением относительно `UTC`. Это устраняет проблему [#9335](https://github.com/ClickHouse/ClickHouse/issues/9335). [#10513](https://github.com/ClickHouse/ClickHouse/pull/10513) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено некорректное завершение работы движка таблиц `Distributed`. [#10491](https://github.com/ClickHouse/ClickHouse/pull/10491) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено переполнение чисел в `simpleLinearRegression` при работе с большими целыми значениями. [#10474](https://github.com/ClickHouse/ClickHouse/pull/10474) ([hcz](https://github.com/hczhcz)).

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-18}

- Исправлен отчёт UBSan в библиотеке LZ4. [#10631](https://github.com/ClickHouse/ClickHouse/pull/10631) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Исправлена сборка с clang-10. [#10238](https://github.com/ClickHouse/ClickHouse/issues/10238). [#10370](https://github.com/ClickHouse/ClickHouse/pull/10370) ([Amos Bird](https://github.com/amosbird)).
- Добавлены тесты с ошибками для настройки `max_rows_to_sort`. [#10268](https://github.com/ClickHouse/ClickHouse/pull/10268) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлены улучшения в вывод диагностической информации во входных форматах. Исправляет [#10204](https://github.com/ClickHouse/ClickHouse/issues/10204). [#10418](https://github.com/ClickHouse/ClickHouse/pull/10418) ([tavplubix](https://github.com/tavplubix)).
- Добавлены CA-сертификаты в Docker-образ clickhouse-server. [#10476](https://github.com/ClickHouse/ClickHouse/pull/10476) ([filimonov](https://github.com/filimonov)).

#### Исправление ошибок {#bug-fix-42}

- Исправлена ошибка `the BloomFilter false positive must be a double number between 0 and 1` [#10551](https://github.com/ClickHouse/ClickHouse/issues/10551). [#10569](https://github.com/ClickHouse/ClickHouse/pull/10569) ([Winter Zhang](https://github.com/zhang2014)).

### Релиз ClickHouse v20.3.8.53, 2020-04-23 {#clickhouse-release-v203853-2020-04-23}


#### Исправление ошибок {#bug-fix-43}

- Исправлено неправильное поведение функций datetime для часовых поясов, которые переходили между положительными и отрицательными смещениями относительно UTC (например, Pacific/Kiritimati). Исправляет [#7202](https://github.com/ClickHouse/ClickHouse/issues/7202) [#10369](https://github.com/ClickHouse/ClickHouse/pull/10369) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлен возможный segfault при включенной настройке `distributed_group_by_no_merge` (появился в версии 20.3.7.46 в [#10131](https://github.com/ClickHouse/ClickHouse/issues/10131)). [#10399](https://github.com/ClickHouse/ClickHouse/pull/10399) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Исправлено неправильное выравнивание типов данных `Array(Tuple(...))`. Исправляет [#10259](https://github.com/ClickHouse/ClickHouse/issues/10259) [#10390](https://github.com/ClickHouse/ClickHouse/pull/10390) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Удалено резервирование дисков в Aggregator. Исправляет ошибку в резервировании дискового пространства, которая могла приводить к сбою больших внешних агрегаций, даже если они могли быть успешно завершены [#10375](https://github.com/ClickHouse/ClickHouse/pull/10375) ([Azat Khuzhin](https://github.com/azat))
- Исправлено состояние гонки между `DROP` и `OPTIMIZE` в `ReplicatedMergeTree`. `DROP` мог оставлять мусор в пути реплики в ZooKeeper при одновременном выполнении запроса `OPTIMIZE`. [#10312](https://github.com/ClickHouse/ClickHouse/pull/10312) ([tavplubix](https://github.com/tavplubix))
- Исправлена ошибка, при которой сервер не мог подключить таблицу после изменения значения по умолчанию для столбца. [#10441](https://github.com/ClickHouse/ClickHouse/pull/10441) ([alesapin](https://github.com/alesapin))
- Директория метаданных больше не удаляется, если подключение базы данных завершается неудачей до загрузки таблиц. [#10442](https://github.com/ClickHouse/ClickHouse/pull/10442) ([Winter Zhang](https://github.com/zhang2014))
- Исправлено несколько ошибок, когда данные вставлялись с кворумом, затем каким-то образом удалялись (DROP PARTITION, TTL), что приводило к зависанию операций INSERT или ложноположительным исключениям в SELECT. Исправляет [#9946](https://github.com/ClickHouse/ClickHouse/issues/9946) [#10188](https://github.com/ClickHouse/ClickHouse/pull/10188) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Исправлена возможная ошибка `Pipeline stuck` в `ConcatProcessor`, которая могла возникать в удаленных запросах. [#10381](https://github.com/ClickHouse/ClickHouse/pull/10381) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Исправлено неправильное поведение в HashTable, которое вызывало ошибку компиляции при попытке чтения HashMap из буфера. [#10386](https://github.com/ClickHouse/ClickHouse/pull/10386) ([palasonic1](https://github.com/palasonic1))
- Разрешено использование `count(*)` с несколькими JOIN. Исправляет [#9853](https://github.com/ClickHouse/ClickHouse/issues/9853) [#10291](https://github.com/ClickHouse/ClickHouse/pull/10291) ([Artem Zuikov](https://github.com/4ertus2))
- Приоритет отдается настройке `fallback_to_stale_replicas` над `skip_unavailable_shards`, иначе при указании обеих настроек и отсутствии актуальных реплик запрос завершится неудачей (патч от @alex-zaitsev). Исправляет: [#2564](https://github.com/ClickHouse/ClickHouse/issues/2564). [#10422](https://github.com/ClickHouse/ClickHouse/pull/10422) ([Azat Khuzhin](https://github.com/azat))
- Исправлена проблема, при которой запрос с ARRAY JOIN, ORDER BY и LIMIT мог возвращать неполный результат. Исправляет [#10226](https://github.com/ClickHouse/ClickHouse/issues/10226). Автор: [Vadim Plakhtinskiy](https://github.com/VadimPlh). [#10427](https://github.com/ClickHouse/ClickHouse/pull/10427) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Проверка количества и типа аргументов при создании индекса BloomFilter [#9623](https://github.com/ClickHouse/ClickHouse/issues/9623) [#10431](https://github.com/ClickHouse/ClickHouse/pull/10431) ([Winter Zhang](https://github.com/zhang2014))

#### Улучшение производительности {#performance-improvement-15}

- Улучшена производительность запросов с явно определёнными множествами в правой части оператора `IN` и кортежами в левой части. Это исправляет регрессию производительности в версии 20.3. [#9740](https://github.com/ClickHouse/ClickHouse/pull/9740), [#10385](https://github.com/ClickHouse/ClickHouse/pull/10385) ([Anton Popov](https://github.com/CurtizJ))

### Релиз ClickHouse v20.3.7.46, 2020-04-17 {#clickhouse-release-v203746-2020-04-17}

#### Исправление ошибок {#bug-fix-44}

- Исправлена ошибка `Logical error: CROSS JOIN has expressions` для запросов со смешанным использованием соединений через запятую и именованных соединений. [#10311](https://github.com/ClickHouse/ClickHouse/pull/10311) ([Artem Zuikov](https://github.com/4ertus2)).
- Исправлены запросы с `max_bytes_before_external_group_by`. [#10302](https://github.com/ClickHouse/ClickHouse/pull/10302) ([Artem Zuikov](https://github.com/4ertus2)).
- Исправлена оптимизация move-to-prewhere при наличии функций arrayJoin (в некоторых случаях). Это исправляет [#10092](https://github.com/ClickHouse/ClickHouse/issues/10092). [#10195](https://github.com/ClickHouse/ClickHouse/pull/10195) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлена возможность ослабить ограничение на использование недетерминированных функций в мутациях с помощью настройки `allow_nondeterministic_mutations`. [#10186](https://github.com/ClickHouse/ClickHouse/pull/10186) ([filimonov](https://github.com/filimonov)).

### Релиз ClickHouse v20.3.6.40, 2020-04-16 {#clickhouse-release-v203640-2020-04-16}

#### Новая функциональность {#new-feature-10}

- Добавлена функция `isConstant`. Эта функция проверяет, является ли её аргумент константным выражением, и возвращает 1 или 0. Предназначена для целей разработки, отладки и демонстрации. [#10198](https://github.com/ClickHouse/ClickHouse/pull/10198) ([alexey-milovidov](https://github.com/alexey-milovidov)).

#### Исправление ошибок {#bug-fix-45}


* Исправлена ошибка `Pipeline stuck`, возникающая при использовании `max_rows_to_group_by` и `group_by_overflow_mode = 'break'`. [#10279](https://github.com/ClickHouse/ClickHouse/pull/10279) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена редкая возможная ошибка `Cannot drain connections: cancel first`. [#10239](https://github.com/ClickHouse/ClickHouse/pull/10239) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, из-за которой ClickHouse выдавал сообщение об ошибке &quot;Unknown function lambda.&quot; при попытке выполнить ALTER UPDATE/DELETE над таблицами с ENGINE = Replicated*. Проверка на недетерминированные функции теперь корректно обрабатывает lambda-выражения. [#10237](https://github.com/ClickHouse/ClickHouse/pull/10237) ([Alexander Kazakov](https://github.com/Akazz)).
* Исправлена функция `generateRandom` для типа Date. Это исправляет [#9973](https://github.com/ClickHouse/ClickHouse/issues/9973). Исправлен пограничный случай, когда даты с годом 2106 вставляются в таблицы MergeTree со старым стилем секционирования, но секции именуются с годом 1970. [#10218](https://github.com/ClickHouse/ClickHouse/pull/10218) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Выполняется преобразование типов, если определение таблицы представления не соответствует запросу `SELECT`. Это исправляет [#10180](https://github.com/ClickHouse/ClickHouse/issues/10180) и [#10022](https://github.com/ClickHouse/ClickHouse/issues/10022). [#10217](https://github.com/ClickHouse/ClickHouse/pull/10217) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена функция `parseDateTimeBestEffort` для строк в формате RFC-2822, когда указанный день недели — вторник или четверг. Это исправляет [#10082](https://github.com/ClickHouse/ClickHouse/issues/10082). [#10214](https://github.com/ClickHouse/ClickHouse/pull/10214) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены имена константных столбцов внутри JOIN, которые могли конфликтовать с именами константных столбцов вне JOIN. [#10207](https://github.com/ClickHouse/ClickHouse/pull/10207) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена возможная ситуация, когда запрос бесконечно выполнялся вместо того, чтобы остановиться по `LIMIT` при чтении из бесконечного источника, такого как `system.numbers` или `system.zeros`. [#10206](https://github.com/ClickHouse/ClickHouse/pull/10206) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено использование текущей базы данных при проверке доступа, если база данных не указана. [#10192](https://github.com/ClickHouse/ClickHouse/pull/10192) ([Vitaly Baranov](https://github.com/vitlibar)).
* Преобразовывать блоки, если структура не совпадает при выполнении INSERT в таблицу типа Distributed(). [#10135](https://github.com/ClickHouse/ClickHouse/pull/10135) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен возможный некорректный результат для функции `extremes` в конвейере процессоров. [#10131](https://github.com/ClickHouse/ClickHouse/pull/10131) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлены некоторые типы `ALTER` с компактными частями. [#10130](https://github.com/ClickHouse/ClickHouse/pull/10130) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена некорректная проверка `index_granularity_bytes` при создании новой реплики. Исправляет [#10098](https://github.com/ClickHouse/ClickHouse/issues/10098). [#10121](https://github.com/ClickHouse/ClickHouse/pull/10121) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка SIGSEGV при выполнении INSERT в таблицу типа Distributed, если её структура отличается от структуры базовых таблиц. [#10105](https://github.com/ClickHouse/ClickHouse/pull/10105) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена возможная потеря строк в запросах с `JOIN` и `UNION ALL`. Исправлены [#9826](https://github.com/ClickHouse/ClickHouse/issues/9826), [#10113](https://github.com/ClickHouse/ClickHouse/issues/10113). [#10099](https://github.com/ClickHouse/ClickHouse/pull/10099) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен запуск реплицируемых таблиц при обновлении со старой версии ClickHouse, в которой отсутствует узел `/table/replicas/replica_name/metadata`. Исправлена проблема [#10037](https://github.com/ClickHouse/ClickHouse/issues/10037). [#10095](https://github.com/ClickHouse/ClickHouse/pull/10095) ([alesapin](https://github.com/alesapin)).
* Добавлена дополнительная проверка аргументов и поддержка идентификаторов в качестве аргументов для MySQL Database Engine. [#10077](https://github.com/ClickHouse/ClickHouse/pull/10077) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена ошибка в источнике словаря ClickHouse, использующем локальный сервер ClickHouse. Эта ошибка могла приводить к повреждению памяти, если типы в словаре и источнике были несовместимы. [#10071](https://github.com/ClickHouse/ClickHouse/pull/10071) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка в запросе `CHECK TABLE`, возникавшая при наличии в таблице пропускающих индексов. [#10068](https://github.com/ClickHouse/ClickHouse/pull/10068) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка `Cannot clone block with columns because block has 0 columns ... While executing GroupingAggregatedTransform`. Она возникала, когда настройка `distributed_aggregation_memory_efficient` была включена, а распределённый запрос читал агрегированные данные с разными уровнями агрегации с разных шардов (смешение одноуровневой и двухуровневой агрегации). [#10063](https://github.com/ClickHouse/ClickHouse/pull/10063) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка сегментации, которая могла возникать в `GROUP BY` по строковым ключам, содержащим завершающие нулевые байты ([#8636](https://github.com/ClickHouse/ClickHouse/issues/8636), [#8925](https://github.com/ClickHouse/ClickHouse/issues/8925)). [#10025](https://github.com/ClickHouse/ClickHouse/pull/10025) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Исправлено количество потоков, используемых для удалённого выполнения запросов (регрессия производительности, начиная с 20.3). Проблема проявлялась, когда запрос к таблице `Distributed` выполнялся одновременно на локальных и удалённых шардах. Исправлено [#9965](https://github.com/ClickHouse/ClickHouse/issues/9965). [#9971](https://github.com/ClickHouse/ClickHouse/pull/9971) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, из-за которой необходимые таблицы не получались на одном из этапов обработки запросов к некоторым базам данных. Исправляет [#9699](https://github.com/ClickHouse/ClickHouse/issues/9699). [#9949](https://github.com/ClickHouse/ClickHouse/pull/9949) ([achulkov2](https://github.com/achulkov2)).
* Исправлена ошибка &#39;Not found column in block&#39;, возникающая, когда `JOIN` используется вместе с `TOTALS`. Исправляет [#9839](https://github.com/ClickHouse/ClickHouse/issues/9839). [#9939](https://github.com/ClickHouse/ClickHouse/pull/9939) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлена ошибка, из-за которой DDL-запросы с `ON CLUSTER` зависали при запуске сервера. [#9927](https://github.com/ClickHouse/ClickHouse/pull/9927) ([Gagan Arneja](https://github.com/garneja)).
* Исправлена обработка нескольких хостов, заданных в команде CREATE USER, например: `CREATE USER user6 HOST NAME REGEXP 'lo.?*host', NAME REGEXP 'lo*host'`. [#9924](https://github.com/ClickHouse/ClickHouse/pull/9924) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен `TRUNCATE` для движка таблиц Join ([#9917](https://github.com/ClickHouse/ClickHouse/issues/9917)). [#9920](https://github.com/ClickHouse/ClickHouse/pull/9920) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка «scalar does not exist» в `ALTER` ([#9878](https://github.com/ClickHouse/ClickHouse/issues/9878)). [#9904](https://github.com/ClickHouse/ClickHouse/pull/9904) ([Amos Bird](https://github.com/amosbird)).
* Исправлена гонка между `drop` и `optimize` в `ReplicatedMergeTree`. [#9901](https://github.com/ClickHouse/ClickHouse/pull/9901) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка с полными именами (qualified names) при `distributed_product_mode='local'`. Исправляет [#4756](https://github.com/ClickHouse/ClickHouse/issues/4756). [#9891](https://github.com/ClickHouse/ClickHouse/pull/9891) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлен расчет прав доступа для introspection-функций на основе настройки &#39;allow&#95;introspection&#95;functions&#39;. [#9840](https://github.com/ClickHouse/ClickHouse/pull/9840) ([Vitaly Baranov](https://github.com/vitlibar)).

#### Улучшение сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-19}

- Исправлен интеграционный тест `test_settings_constraints`. [#9962](https://github.com/ClickHouse/ClickHouse/pull/9962) ([Vitaly Baranov](https://github.com/vitlibar)).
- Удалена зависимость от `clock_getres`. [#9833](https://github.com/ClickHouse/ClickHouse/pull/9833) ([alexey-milovidov](https://github.com/alexey-milovidov)).

### Релиз ClickHouse v20.3.5.21, 2020-03-27 {#clickhouse-release-v203521-2020-03-27}

#### Исправление ошибок {#bug-fix-46}

- Исправлена ошибка 'Different expressions with the same alias' при выполнении запроса с PREWHERE и WHERE к распределённой таблице и `SET distributed_product_mode = 'local'`. [#9871](https://github.com/ClickHouse/ClickHouse/pull/9871) ([Artem Zuikov](https://github.com/4ertus2)).
- Исправлено чрезмерное потребление памяти при мутациях для таблиц с составным первичным ключом. Исправляет [#9850](https://github.com/ClickHouse/ClickHouse/issues/9850). [#9860](https://github.com/ClickHouse/ClickHouse/pull/9860) ([alesapin](https://github.com/alesapin)).
- Для запросов INSERT шард теперь приводит настройки, полученные от инициатора, в соответствие с ограничениями шарда, вместо генерации исключения. Это исправление позволяет отправлять запросы INSERT на шард с другими ограничениями. Это изменение улучшает исправление [#9447](https://github.com/ClickHouse/ClickHouse/issues/9447). [#9852](https://github.com/ClickHouse/ClickHouse/pull/9852) ([Vitaly Baranov](https://github.com/vitlibar)).
- Исправлена ошибка 'COMMA to CROSS JOIN rewriter is not enabled or cannot rewrite query' в случае подзапросов с COMMA JOIN вне списков таблиц (например, в WHERE). Исправляет [#9782](https://github.com/ClickHouse/ClickHouse/issues/9782). [#9830](https://github.com/ClickHouse/ClickHouse/pull/9830) ([Artem Zuikov](https://github.com/4ertus2)).
- Исправлено возможное исключение `Got 0 in totals chunk, expected 1` на клиенте. Оно возникало для запросов с `JOIN`, если правая присоединяемая таблица содержала ноль строк. Пример: `select * from system.one t1 join system.one t2 on t1.dummy = t2.dummy limit 0 FORMAT TabSeparated;`. Исправляет [#9777](https://github.com/ClickHouse/ClickHouse/issues/9777). [#9823](https://github.com/ClickHouse/ClickHouse/pull/9823) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Исправлен SIGSEGV с optimize_skip_unused_shards, когда тип не может быть преобразован. [#9804](https://github.com/ClickHouse/ClickHouse/pull/9804) ([Azat Khuzhin](https://github.com/azat)).
- Исправлен неработающий запрос `ALTER TABLE DELETE COLUMN` для компактных кусков. [#9779](https://github.com/ClickHouse/ClickHouse/pull/9779) ([alesapin](https://github.com/alesapin)).
- Исправлен max_distributed_connections (с процессорами и без них). [#9673](https://github.com/ClickHouse/ClickHouse/pull/9673) ([Azat Khuzhin](https://github.com/azat)).
- Исправлено несколько случаев, когда часовой пояс аргумента функции использовался неправильно. [#9574](https://github.com/ClickHouse/ClickHouse/pull/9574) ([Vasily Nemkov](https://github.com/Enmk)).

#### Улучшение {#improvement-19}

- Удалена стадия сортировки из мутаций, поскольку чтение выполняется из одного упорядоченного куска в одном потоке. Также добавлена проверка того, что порядок строк в мутации соответствует порядку ключа сортировки и этот порядок не нарушается. [#9886](https://github.com/ClickHouse/ClickHouse/pull/9886) ([alesapin](https://github.com/alesapin)).

### Релиз ClickHouse v20.3.4.10, 2020-03-20 {#clickhouse-release-v203410-2020-03-20}


#### Исправление ошибок {#bug-fix-47}

- Этот релиз также содержит все исправления ошибок из версии 20.1.8.41
- Исправлено отсутствие `rows_before_limit_at_least` для запросов по http (с конвейером процессоров). Исправляет [#9730](https://github.com/ClickHouse/ClickHouse/issues/9730). [#9757](https://github.com/ClickHouse/ClickHouse/pull/9757) ([Nikolai Kochetov](https://github.com/KochetovNicolai))

### Релиз ClickHouse v20.3.3.6, 2020-03-17 {#clickhouse-release-v20336-2020-03-17}

#### Исправление ошибок {#bug-fix-48}

- Этот релиз также содержит все исправления ошибок из версии 20.1.7.38
- Исправлена ошибка в репликации, которая не позволяла репликации работать, если пользователь выполнял мутации на предыдущей версии. Исправляет [#9645](https://github.com/ClickHouse/ClickHouse/issues/9645). [#9652](https://github.com/ClickHouse/ClickHouse/pull/9652) ([alesapin](https://github.com/alesapin)). Восстанавливает обратную совместимость версии 20.3.
- Добавлена настройка `use_compact_format_in_distributed_parts_names`, которая позволяет записывать файлы для запросов `INSERT` в таблицу `Distributed` в более компактном формате. Исправляет [#9647](https://github.com/ClickHouse/ClickHouse/issues/9647). [#9653](https://github.com/ClickHouse/ClickHouse/pull/9653) ([alesapin](https://github.com/alesapin)). Восстанавливает обратную совместимость версии 20.3.

### Релиз ClickHouse v20.3.2.1, 2020-03-12 {#clickhouse-release-v20321-2020-03-12}

#### Обратно несовместимое изменение {#backward-incompatible-change-9}


* Исправлена проблема `file name too long` при отправке данных в таблицы `Distributed` при большом количестве реплик. Исправлена проблема, из‑за которой учетные данные реплик записывались в лог сервера. Формат имени каталога на диске изменён на `[shard{shard_index}[_replica{replica_index}]]`. [#8911](https://github.com/ClickHouse/ClickHouse/pull/8911) ([Mikhail Korotov](https://github.com/millb)) После обновления до новой версии вы не сможете выполнить откат без ручного вмешательства, так как старая версия сервера не распознаёт новый формат каталогов. Если вам нужно выполнить откат, необходимо вручную переименовать соответствующие каталоги в старый формат. Это изменение актуально только в том случае, если вы использовали асинхронные `INSERT` в таблицы `Distributed`. В версии 20.3.3 мы добавим настройку, которая позволит вам постепенно включать новый формат.
* Изменён формат записей лога репликации для команд мутаций. Перед установкой новой версии необходимо дождаться завершения старых мутаций.
* Реализован простой профилировщик памяти, который записывает stacktrace в `system.trace_log` каждые N байт сверх мягкого лимита аллокаций [#8765](https://github.com/ClickHouse/ClickHouse/pull/8765) ([Ivan](https://github.com/abyss7)) [#9472](https://github.com/ClickHouse/ClickHouse/pull/9472) ([alexey-milovidov](https://github.com/alexey-milovidov)). Столбец в `system.trace_log` был переименован с `timer_type` на `trace_type`. Это потребует изменений в сторонних инструментах анализа производительности и построения flamegraph.
* Использовать везде идентификатор потока ОС вместо внутреннего номера потока. Это исправляет [#7477](https://github.com/ClickHouse/ClickHouse/issues/7477). Старый `clickhouse-client` не может получать логи, которые отправляются с сервера при включённой настройке `send_logs_level`, потому что были изменены имена и типы структурированных сообщений логов. С другой стороны, разные версии сервера могут отправлять друг другу логи с разными типами. Если вы не используете настройку `send_logs_level`, вам не о чем беспокоиться. [#8954](https://github.com/ClickHouse/ClickHouse/pull/8954) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Удалена функция `indexHint` [#9542](https://github.com/ClickHouse/ClickHouse/pull/9542) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Удалены функции `findClusterIndex` и `findClusterValue`. Это исправляет [#8641](https://github.com/ClickHouse/ClickHouse/issues/8641). Если вы использовали эти функции, отправьте письмо на адрес `clickhouse-feedback@yandex-team.com` [#9543](https://github.com/ClickHouse/ClickHouse/pull/9543) ([alexey-milovidov](https://github.com/alexey-milovidov))
* Теперь нельзя создавать столбцы или добавлять столбцы с подзапросом `SELECT` в качестве выражения по умолчанию. [#9481](https://github.com/ClickHouse/ClickHouse/pull/9481) ([alesapin](https://github.com/alesapin))
* Требуются псевдонимы для подзапросов в JOIN. [#9274](https://github.com/ClickHouse/ClickHouse/pull/9274) ([Artem Zuikov](https://github.com/4ertus2))
* Улучшена логика запросов `ALTER MODIFY/ADD`. Теперь нельзя `ADD` столбец без типа, `MODIFY` выражение по умолчанию не изменяет тип столбца, а изменение типа с помощью `MODIFY` не приводит к потере значения выражения по умолчанию. Исправляет [#8669](https://github.com/ClickHouse/ClickHouse/issues/8669). [#9227](https://github.com/ClickHouse/ClickHouse/pull/9227) ([alesapin](https://github.com/alesapin))
* Для применения изменений в конфигурации логирования требуется перезапуск сервера. Это временное решение, позволяющее избежать ошибки, при которой сервер продолжает записывать логи в уже удалённый файл журнала (см. [#8696](https://github.com/ClickHouse/ClickHouse/issues/8696)). [#8707](https://github.com/ClickHouse/ClickHouse/pull/8707) ([Alexander Kuzmenkov](https://github.com/akuzm))
* Настройка `experimental_use_processors` включена по умолчанию. Эта настройка активирует использование нового конвейера выполнения запросов. Это внутренняя переработка, и мы не ожидаем каких-либо видимых изменений. Если вы заметите какие-либо проблемы, сбросьте её обратно в ноль. [#8768](https://github.com/ClickHouse/ClickHouse/pull/8768) ([alexey-milovidov](https://github.com/alexey-milovidov))





#### Новые возможности {#new-feature-11}

- Добавлены форматы ввода/вывода `Avro` и `AvroConfluent` [#8571](https://github.com/ClickHouse/ClickHouse/pull/8571) ([Andrew Onyshchuk](https://github.com/oandrew)) [#8957](https://github.com/ClickHouse/ClickHouse/pull/8957) ([Andrew Onyshchuk](https://github.com/oandrew)) [#8717](https://github.com/ClickHouse/ClickHouse/pull/8717) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Многопоточное и неблокирующее обновление устаревших ключей в словарях `cache` (с возможностью чтения старых значений). [#8303](https://github.com/ClickHouse/ClickHouse/pull/8303) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Добавлен запрос `ALTER ... MATERIALIZE TTL`. Он запускает мутацию, которая принудительно удаляет данные с истекшим TTL и пересчитывает метаинформацию о TTL во всех кусках. [#8775](https://github.com/ClickHouse/ClickHouse/pull/8775) ([Anton Popov](https://github.com/CurtizJ))
- Переключение с HashJoin на MergeJoin (на диске) при необходимости [#9082](https://github.com/ClickHouse/ClickHouse/pull/9082) ([Artem Zuikov](https://github.com/4ertus2))
- Добавлена команда `MOVE PARTITION` для `ALTER TABLE` [#4729](https://github.com/ClickHouse/ClickHouse/issues/4729) [#6168](https://github.com/ClickHouse/ClickHouse/pull/6168) ([Guillaume Tassery](https://github.com/YiuRULE))
- Перезагрузка конфигурации хранилища из конфигурационного файла на лету. [#8594](https://github.com/ClickHouse/ClickHouse/pull/8594) ([Vladimir Chebotarev](https://github.com/excitoon))
- Разрешено изменение `storage_policy` на не менее функциональную политику. [#8107](https://github.com/ClickHouse/ClickHouse/pull/8107) ([Vladimir Chebotarev](https://github.com/excitoon))
- Добавлена поддержка глобов/масок для хранилища S3 и табличной функции. [#8851](https://github.com/ClickHouse/ClickHouse/pull/8851) ([Vladimir Chebotarev](https://github.com/excitoon))
- Реализованы функции `bitAnd`, `bitOr`, `bitXor`, `bitNot` для типа данных `FixedString(N)`. [#9091](https://github.com/ClickHouse/ClickHouse/pull/9091) ([Guillaume Tassery](https://github.com/YiuRULE))
- Добавлена функция `bitCount`. Это исправляет [#8702](https://github.com/ClickHouse/ClickHouse/issues/8702). [#8708](https://github.com/ClickHouse/ClickHouse/pull/8708) ([alexey-milovidov](https://github.com/alexey-milovidov)) [#8749](https://github.com/ClickHouse/ClickHouse/pull/8749) ([ikopylov](https://github.com/ikopylov))
- Добавлена табличная функция `generateRandom` для генерации случайных строк с заданной схемой. Позволяет заполнять произвольные тестовые таблицы данными. [#8994](https://github.com/ClickHouse/ClickHouse/pull/8994) ([Ilya Yatsishin](https://github.com/qoega))
- `JSONEachRowFormat`: поддержка специального случая, когда объекты заключены в массив верхнего уровня. [#8860](https://github.com/ClickHouse/ClickHouse/pull/8860) ([Kruglov Pavel](https://github.com/Avogar))
- Теперь можно создать столбец с выражением `DEFAULT`, которое зависит от столбца с выражением по умолчанию `ALIAS`. [#9489](https://github.com/ClickHouse/ClickHouse/pull/9489) ([alesapin](https://github.com/alesapin))
- Разрешено указывать `--limit` больше размера исходных данных в `clickhouse-obfuscator`. Данные будут повторяться с разными случайными начальными значениями. [#9155](https://github.com/ClickHouse/ClickHouse/pull/9155) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлена функция `groupArraySample` (аналогичная `groupArray`) с алгоритмом резервуарной выборки. [#8286](https://github.com/ClickHouse/ClickHouse/pull/8286) ([Amos Bird](https://github.com/amosbird))
- Теперь можно отслеживать размер очереди обновлений в словарях `cache`/`complex_key_cache` через системные метрики. [#9413](https://github.com/ClickHouse/ClickHouse/pull/9413) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Разрешено использование CRLF в качестве разделителя строк в формате вывода CSV при установке параметра `output_format_csv_crlf_end_of_line` в 1 [#8934](https://github.com/ClickHouse/ClickHouse/pull/8934) [#8935](https://github.com/ClickHouse/ClickHouse/pull/8935) [#8963](https://github.com/ClickHouse/ClickHouse/pull/8963) ([Mikhail Korotov](https://github.com/millb))
- Реализованы дополнительные функции API [H3](https://github.com/uber/h3): `h3GetBaseCell`, `h3HexAreaM2`, `h3IndexesAreNeighbors`, `h3ToChildren`, `h3ToString` и `stringToH3` [#8938](https://github.com/ClickHouse/ClickHouse/pull/8938) ([Nico Mandery](https://github.com/nmandery))
- Введен новый параметр `max_parser_depth` для управления максимальным размером стека и поддержки больших сложных запросов. Это исправляет [#6681](https://github.com/ClickHouse/ClickHouse/issues/6681) и [#7668](https://github.com/ClickHouse/ClickHouse/issues/7668). [#8647](https://github.com/ClickHouse/ClickHouse/pull/8647) ([Maxim Smirnov](https://github.com/qMBQx8GH))
- Добавлен параметр `force_optimize_skip_unused_shards` для генерации исключения, если пропуск неиспользуемых шардов невозможен [#8805](https://github.com/ClickHouse/ClickHouse/pull/8805) ([Azat Khuzhin](https://github.com/azat))
- Разрешена настройка нескольких дисков/томов для хранения данных для отправки в движке `Distributed` [#8756](https://github.com/ClickHouse/ClickHouse/pull/8756) ([Azat Khuzhin](https://github.com/azat))
- Поддержка политики хранения (`<tmp_policy>`) для хранения временных данных. [#8750](https://github.com/ClickHouse/ClickHouse/pull/8750) ([Azat Khuzhin](https://github.com/azat))
- Добавлен HTTP-заголовок `X-ClickHouse-Exception-Code`, который устанавливается, если исключение было выброшено до отправки данных. Это реализует [#4971](https://github.com/ClickHouse/ClickHouse/issues/4971). [#8786](https://github.com/ClickHouse/ClickHouse/pull/8786) ([Mikhail Korotov](https://github.com/millb))
- Добавлена функция `ifNotFinite`. Это синтаксический сахар: `ifNotFinite(x, y) = isFinite(x) ? x : y`. [#8710](https://github.com/ClickHouse/ClickHouse/pull/8710) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлен столбец `last_successful_update_time` в таблицу `system.dictionaries` [#9394](https://github.com/ClickHouse/ClickHouse/pull/9394) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Добавлена функция `blockSerializedSize` (размер на диске без сжатия) [#8952](https://github.com/ClickHouse/ClickHouse/pull/8952) ([Azat Khuzhin](https://github.com/azat))
- Добавлена функция `moduloOrZero` [#9358](https://github.com/ClickHouse/ClickHouse/pull/9358) ([hcz](https://github.com/hczhcz))
- Добавлены системные таблицы `system.zeros` и `system.zeros_mt`, а также табличные функции `zeros()` и `zeros_mt()`. Таблицы (и табличные функции) содержат один столбец с именем `zero` и типом `UInt8`. Этот столбец содержит нули. Это необходимо для тестовых целей как самый быстрый способ генерации большого количества строк. Это исправляет [#6604](https://github.com/ClickHouse/ClickHouse/issues/6604) [#9593](https://github.com/ClickHouse/ClickHouse/pull/9593) ([Nikolai Kochetov](https://github.com/KochetovNicolai))

#### Экспериментальная функциональность {#experimental-feature-7}

- Добавлен новый компактный формат кусков данных в таблицах семейства `MergeTree`, в котором все столбцы хранятся в одном файле. Это позволяет повысить производительность при небольших и частых вставках. Старый формат (один файл на столбец) теперь называется широким (wide). Формат хранения данных управляется настройками `min_bytes_for_wide_part` и `min_rows_for_wide_part`. [#8290](https://github.com/ClickHouse/ClickHouse/pull/8290) ([Anton Popov](https://github.com/CurtizJ))
- Поддержка хранилища S3 для таблиц `Log`, `TinyLog` и `StripeLog`. [#8862](https://github.com/ClickHouse/ClickHouse/pull/8862) ([Pavel Kovalenko](https://github.com/Jokser))


#### Исправление ошибок {#bug-fix-49}

- Исправлены несогласованные пробелы в сообщениях журнала. [#9322](https://github.com/ClickHouse/ClickHouse/pull/9322) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена ошибка, при которой массивы безымянных кортежей разворачивались как структуры Nested при создании таблицы. [#8866](https://github.com/ClickHouse/ClickHouse/pull/8866) ([achulkov2](https://github.com/achulkov2))
- Исправлена проблема, когда ошибка "Too many open files" могла возникать при наличии слишком большого количества файлов, соответствующих шаблону glob, в таблице `File` или табличной функции `file`. Теперь файлы открываются лениво. Это исправляет [#8857](https://github.com/ClickHouse/ClickHouse/issues/8857) [#8861](https://github.com/ClickHouse/ClickHouse/pull/8861) ([alexey-milovidov](https://github.com/alexey-milovidov))
- DROP TEMPORARY TABLE теперь удаляет только временную таблицу. [#8907](https://github.com/ClickHouse/ClickHouse/pull/8907) ([Vitaly Baranov](https://github.com/vitlibar))
- Удаление устаревшей партиции при остановке сервера или выполнении DETACH/ATTACH таблицы. [#8602](https://github.com/ClickHouse/ClickHouse/pull/8602) ([Guillaume Tassery](https://github.com/YiuRULE))
- Исправлен способ расчета свободного места на диске по умолчанию из подкаталога `data`. Исправлена проблема, когда объем свободного места рассчитывался неправильно, если каталог `data` смонтирован на отдельное устройство (редкий случай). Это исправляет [#7441](https://github.com/ClickHouse/ClickHouse/issues/7441) [#9257](https://github.com/ClickHouse/ClickHouse/pull/9257) ([Mikhail Korotov](https://github.com/millb))
- Разрешено использование запятой (cross join) с IN () внутри. [#9251](https://github.com/ClickHouse/ClickHouse/pull/9251) ([Artem Zuikov](https://github.com/4ertus2))
- Разрешено преобразование CROSS в INNER JOIN при наличии оператора [NOT] LIKE в секции WHERE. [#9229](https://github.com/ClickHouse/ClickHouse/pull/9229) ([Artem Zuikov](https://github.com/4ertus2))
- Исправлен возможный некорректный результат после `GROUP BY` с включенной настройкой `distributed_aggregation_memory_efficient`. Исправляет [#9134](https://github.com/ClickHouse/ClickHouse/issues/9134). [#9289](https://github.com/ClickHouse/ClickHouse/pull/9289) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Найденные ключи учитывались как пропущенные в метриках кэширующих словарей. [#9411](https://github.com/ClickHouse/ClickHouse/pull/9411) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Исправлена несовместимость протокола репликации, введенная в [#8598](https://github.com/ClickHouse/ClickHouse/issues/8598). [#9412](https://github.com/ClickHouse/ClickHouse/pull/9412) ([alesapin](https://github.com/alesapin))
- Исправлено состояние гонки для `queue_task_handle` при запуске таблиц `ReplicatedMergeTree`. [#9552](https://github.com/ClickHouse/ClickHouse/pull/9552) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Токен `NOT` не работал в запросе `SHOW TABLES NOT LIKE` [#8727](https://github.com/ClickHouse/ClickHouse/issues/8727) [#8940](https://github.com/ClickHouse/ClickHouse/pull/8940) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлена проверка диапазона для функции `h3EdgeLengthM`. Без этой проверки возможно переполнение буфера. [#8945](https://github.com/ClickHouse/ClickHouse/pull/8945) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена ошибка в пакетных вычислениях тернарных логических операций для нескольких аргументов (более 10). [#8718](https://github.com/ClickHouse/ClickHouse/pull/8718) ([Alexander Kazakov](https://github.com/Akazz))
- Исправлена ошибка оптимизации PREWHERE, которая могла приводить к segfault или исключению `Inconsistent number of columns got from MergeTreeRangeReader`. [#9024](https://github.com/ClickHouse/ClickHouse/pull/9024) ([Anton Popov](https://github.com/CurtizJ))
- Исправлено неожиданное исключение `Timeout exceeded while reading from socket`, которое случайно возникало при защищенном соединении до фактического превышения таймаута и при включенном профилировщике запросов. Также добавлена настройка `connect_timeout_with_failover_secure_ms` (по умолчанию 100 мс), которая аналогична `connect_timeout_with_failover_ms`, но используется для защищенных соединений (поскольку SSL-рукопожатие медленнее обычного TCP-соединения) [#9026](https://github.com/ClickHouse/ClickHouse/pull/9026) ([tavplubix](https://github.com/tavplubix))
- Исправлена ошибка с финализацией мутаций, когда мутация могла зависнуть в состоянии с `parts_to_do=0` и `is_done=0`. [#9022](https://github.com/ClickHouse/ClickHouse/pull/9022) ([alesapin](https://github.com/alesapin))
- Использование новой логики ANY JOIN с настройкой `partial_merge_join`. Теперь возможно выполнять соединения `ANY|ALL|SEMI LEFT` и `ALL INNER` с `partial_merge_join=1`. [#8932](https://github.com/ClickHouse/ClickHouse/pull/8932) ([Artem Zuikov](https://github.com/4ertus2))
- Шард теперь ограничивает настройки, полученные от инициатора, в соответствии с ограничениями шарда, вместо выброса исключения. Это исправление позволяет отправлять запросы на шард с другими ограничениями. [#9447](https://github.com/ClickHouse/ClickHouse/pull/9447) ([Vitaly Baranov](https://github.com/vitlibar))
- Исправлена проблема управления памятью в `MergeTreeReadPool`. [#8791](https://github.com/ClickHouse/ClickHouse/pull/8791) ([Vladimir Chebotarev](https://github.com/excitoon))
- Исправлено семейство функций `toDecimal*OrNull()` при вызове со строкой `e`. Исправляет [#8312](https://github.com/ClickHouse/ClickHouse/issues/8312) [#8764](https://github.com/ClickHouse/ClickHouse/pull/8764) ([Artem Zuikov](https://github.com/4ertus2))
- Обеспечена гарантия того, что `FORMAT Null` не отправляет данные клиенту. [#8767](https://github.com/ClickHouse/ClickHouse/pull/8767) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Исправлена ошибка, при которой временная метка в `LiveViewBlockInputStream` не обновлялась. `LIVE VIEW` — экспериментальная функция. [#8644](https://github.com/ClickHouse/ClickHouse/pull/8644) ([vxider](https://github.com/Vxider)) [#8625](https://github.com/ClickHouse/ClickHouse/pull/8625) ([vxider](https://github.com/Vxider))
- Исправлено неправильное поведение `ALTER MODIFY TTL`, которое не позволяло удалять старые выражения TTL. [#8422](https://github.com/ClickHouse/ClickHouse/pull/8422) ([Vladimir Chebotarev](https://github.com/excitoon))
- Исправлен отчет UBSan в MergeTreeIndexSet. Это исправляет [#9250](https://github.com/ClickHouse/ClickHouse/issues/9250) [#9365](https://github.com/ClickHouse/ClickHouse/pull/9365) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлено поведение функций `match` и `extract`, когда haystack содержит нулевые байты. Поведение было неправильным, когда haystack был константой. Это исправляет [#9160](https://github.com/ClickHouse/ClickHouse/issues/9160) [#9163](https://github.com/ClickHouse/ClickHouse/pull/9163) ([alexey-milovidov](https://github.com/alexey-milovidov)) [#9345](https://github.com/ClickHouse/ClickHouse/pull/9345) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Предотвращен выброс исключений из деструктора в сторонней библиотеке Apache Avro. [#9066](https://github.com/ClickHouse/ClickHouse/pull/9066) ([Andrew Onyshchuk](https://github.com/oandrew))
- Не выполняется частичная фиксация пакета, полученного из `Kafka`, так как это может привести к пропускам в данных. [#8876](https://github.com/ClickHouse/ClickHouse/pull/8876) ([filimonov](https://github.com/filimonov))
- Исправлена функция `joinGet` с nullable типами возврата. [#8919](https://github.com/ClickHouse/ClickHouse/issues/8919) [#9014](https://github.com/ClickHouse/ClickHouse/pull/9014) ([Amos Bird](https://github.com/amosbird))
- Исправлена несовместимость данных при сжатии кодеком `T64`. [#9016](https://github.com/ClickHouse/ClickHouse/pull/9016) ([Artem Zuikov](https://github.com/4ertus2)) Исправлены идентификаторы типов данных в кодеке сжатия `T64`, которые приводили к неправильному (де)сжатию в затронутых версиях. [#9033](https://github.com/ClickHouse/ClickHouse/pull/9033) ([Artem Zuikov](https://github.com/4ertus2))
- Добавлена настройка `enable_early_constant_folding` и отключена в некоторых случаях, приводящих к ошибкам. [#9010](https://github.com/ClickHouse/ClickHouse/pull/9010) ([Artem Zuikov](https://github.com/4ertus2))
- Исправлен оптимизатор проталкивания предикатов с VIEW и включен тест [#9011](https://github.com/ClickHouse/ClickHouse/pull/9011) ([Winter Zhang](https://github.com/zhang2014))
- Исправлен segfault в таблицах `Merge`, который мог возникать при чтении из хранилищ `File` [#9387](https://github.com/ClickHouse/ClickHouse/pull/9387) ([tavplubix](https://github.com/tavplubix))
- Добавлена проверка политики хранения в `ATTACH PARTITION FROM`, `REPLACE PARTITION`, `MOVE TO TABLE`. В противном случае это могло сделать данные партиции недоступными после перезапуска и помешать запуску ClickHouse. [#9383](https://github.com/ClickHouse/ClickHouse/pull/9383) ([Vladimir Chebotarev](https://github.com/excitoon))
- Исправлены операции ALTER при наличии TTL для таблицы. [#8800](https://github.com/ClickHouse/ClickHouse/pull/8800) ([Anton Popov](https://github.com/CurtizJ))
- Исправлено состояние гонки, которое может возникнуть при выполнении `SYSTEM RELOAD ALL DICTIONARIES` во время изменения/добавления/удаления словаря. [#8801](https://github.com/ClickHouse/ClickHouse/pull/8801) ([Vitaly Baranov](https://github.com/vitlibar))
- В предыдущих версиях движок базы данных `Memory` использовал пустой путь к данным, поэтому таблицы создавались в каталоге `path` (например, `/var/lib/clickhouse/`), а не в каталоге данных базы данных (например, `/var/lib/clickhouse/db_name`). [#8753](https://github.com/ClickHouse/ClickHouse/pull/8753) ([tavplubix](https://github.com/tavplubix))
- Исправлены неправильные сообщения журнала об отсутствующем диске или политике по умолчанию. [#9530](https://github.com/ClickHouse/ClickHouse/pull/9530) ([Vladimir Chebotarev](https://github.com/excitoon))
- Исправлена функция not(has()) для индекса bloom_filter типов массивов. [#9407](https://github.com/ClickHouse/ClickHouse/pull/9407) ([achimbab](https://github.com/achimbab))
- Разрешено использование псевдонима для первого столбца (столбцов) в таблице с движком `Log` [#9231](https://github.com/ClickHouse/ClickHouse/pull/9231) ([Ivan](https://github.com/abyss7))
- Исправлен порядок диапазонов при чтении из таблицы `MergeTree` в одном потоке. Это могло приводить к исключениям из `MergeTreeRangeReader` или неправильным результатам запроса. [#9050](https://github.com/ClickHouse/ClickHouse/pull/9050) ([Anton Popov](https://github.com/CurtizJ))
- Функция `reinterpretAsFixedString` теперь возвращает `FixedString` вместо `String`. [#9052](https://github.com/ClickHouse/ClickHouse/pull/9052) ([Andrew Onyshchuk](https://github.com/oandrew))
- Предотвращены крайне редкие случаи, когда пользователь мог получить неправильное сообщение об ошибке (`Success` вместо подробного описания ошибки). [#9457](https://github.com/ClickHouse/ClickHouse/pull/9457) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Предотвращен сбой при использовании формата `Template` с пустым шаблоном строки. [#8785](https://github.com/ClickHouse/ClickHouse/pull/8785) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Файлы метаданных для системных таблиц могли создаваться в неправильном месте [#8653](https://github.com/ClickHouse/ClickHouse/pull/8653) ([tavplubix](https://github.com/tavplubix)) Fixes [#8581](https://github.com/ClickHouse/ClickHouse/issues/8581).
- Исправлена гонка данных для exception_ptr в кэширующем словаре [#8303](https://github.com/ClickHouse/ClickHouse/issues/8303). [#9379](https://github.com/ClickHouse/ClickHouse/pull/9379) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Не выбрасывается исключение для запроса `ATTACH TABLE IF NOT EXISTS`. Ранее оно выбрасывалось, если таблица уже существовала, несмотря на условие `IF NOT EXISTS`. [#8967](https://github.com/ClickHouse/ClickHouse/pull/8967) ([Anton Popov](https://github.com/CurtizJ))
- Исправлена отсутствующая закрывающая скобка в сообщении об исключении. [#8811](https://github.com/ClickHouse/ClickHouse/pull/8811) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Предотвращено сообщение `Possible deadlock avoided` при запуске clickhouse-client в интерактивном режиме. [#9455](https://github.com/ClickHouse/ClickHouse/pull/9455) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена проблема, когда заполнение в конце значения, закодированного в base64, могло быть некорректным. Обновлена библиотека base64. Это исправляет [#9491](https://github.com/ClickHouse/ClickHouse/issues/9491), closes [#9492](https://github.com/ClickHouse/ClickHouse/issues/9492) [#9500](https://github.com/ClickHouse/ClickHouse/pull/9500) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Предотвращена потеря данных в `Kafka` в редких случаях, когда исключение возникает после чтения суффикса, но до фиксации. Исправляет [#9378](https://github.com/ClickHouse/ClickHouse/issues/9378) [#9507](https://github.com/ClickHouse/ClickHouse/pull/9507) ([filimonov](https://github.com/filimonov))
- Исправлено исключение в `DROP TABLE IF EXISTS` [#8663](https://github.com/ClickHouse/ClickHouse/pull/8663) ([Nikita Vasilev](https://github.com/nikvas0))
- Исправлен сбой, когда пользователь пытается выполнить `ALTER MODIFY SETTING` для семейства движков таблиц `MergeTree` старого формата. [#9435](https://github.com/ClickHouse/ClickHouse/pull/9435) ([alesapin](https://github.com/alesapin))
- Поддержка чисел UInt64, которые не помещаются в Int64, в функциях, связанных с JSON. Обновление SIMDJSON до master. Это исправляет [#9209](https://github.com/ClickHouse/ClickHouse/issues/9209) [#9344](https://github.com/ClickHouse/ClickHouse/pull/9344) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлено выполнение инвертированных предикатов при использовании нестрого монотонного функционального индекса. [#9223](https://github.com/ClickHouse/ClickHouse/pull/9223) ([Alexander Kazakov](https://github.com/Akazz))
- Не выполняется попытка свертывания константы `IN` в `GROUP BY` [#8868](https://github.com/ClickHouse/ClickHouse/pull/8868) ([Amos Bird](https://github.com/amosbird))
- Исправлена ошибка в мутациях `ALTER DELETE`, которая приводила к повреждению индекса. Это исправляет [#9019](https://github.com/ClickHouse/ClickHouse/issues/9019) and [#8982](https://github.com/ClickHouse/ClickHouse/issues/8982). Дополнительно исправлены крайне редкие состояния гонки в запросах `ALTER` для `ReplicatedMergeTree`. [#9048](https://github.com/ClickHouse/ClickHouse/pull/9048) ([alesapin](https://github.com/alesapin))
- При включенной настройке `compile_expressions` можно получить `unexpected column` в `LLVMExecutableFunction` при использовании типа `Nullable` [#8910](https://github.com/ClickHouse/ClickHouse/pull/8910) ([Guillaume Tassery](https://github.com/YiuRULE))
- Множественные исправления для движка `Kafka`: 1) исправлены дубликаты, которые появлялись во время ребалансировки группы потребителей. 2) Исправлены редкие «пропуски», которые появлялись, когда данные извлекались из нескольких партиций одним опросом и фиксировались частично (теперь всегда обрабатывается/фиксируется весь полученный блок сообщений). 3) Исправлена сброс по размеру блока (ранее правильно работал только сброс по таймауту). 4) Улучшена процедура подписки (с обратной связью о назначении). 5) Ускорена работа тестов (с интервалами и таймаутами по умолчанию). Из-за того, что ранее данные не сбрасывались по размеру блока (как должно быть согласно документации), этот PR может привести к некоторому снижению производительности с настройками по умолчанию (из-за более частых и мелких сбросов, которые менее оптимальны). Если вы столкнетесь с проблемой производительности после этого изменения — увеличьте `kafka_max_block_size` в таблице до большего значения (например, `CREATE TABLE ...Engine=Kafka ... SETTINGS ... kafka_max_block_size=524288`). Исправляет [#7259](https://github.com/ClickHouse/ClickHouse/issues/7259) [#8917](https://github.com/ClickHouse/ClickHouse/pull/8917) ([filimonov](https://github.com/filimonov))
- Исправлено исключение `Parameter out of bound` в некоторых запросах после оптимизаций PREWHERE. [#8914](https://github.com/ClickHouse/ClickHouse/pull/8914) ([Baudouin Giard](https://github.com/bgiard))
- Исправлен случай смешанной константности аргументов функции `arrayZip`. [#8705](https://github.com/ClickHouse/ClickHouse/pull/8705) ([alexey-milovidov](https://github.com/alexey-milovidov))
- При выполнении запроса `CREATE` выполняется свертывание константных выражений в аргументах движка хранения. Пустое имя базы данных заменяется текущей базой данных. Исправляет [#6508](https://github.com/ClickHouse/ClickHouse/issues/6508), [#3492](https://github.com/ClickHouse/ClickHouse/issues/3492) [#9262](https://github.com/ClickHouse/ClickHouse/pull/9262) ([tavplubix](https://github.com/tavplubix))
- Теперь невозможно создать или добавить столбцы с простыми циклическими псевдонимами, такими как `a DEFAULT b, b DEFAULT a`. [#9603](https://github.com/ClickHouse/ClickHouse/pull/9603) ([alesapin](https://github.com/alesapin))
- Исправлена ошибка с двойным перемещением, которая могла повредить исходную партицию. Это актуально при использовании `ALTER TABLE MOVE` [#8680](https://github.com/ClickHouse/ClickHouse/pull/8680) ([Vladimir Chebotarev](https://github.com/excitoon))
- Разрешен корректный разбор идентификатора `interval` без обратных кавычек. Исправлена проблема, когда запрос не мог быть выполнен, даже если идентификатор `interval` заключен в обратные кавычки или двойные кавычки. Это исправляет [#9124](https://github.com/ClickHouse/ClickHouse/issues/9124). [#9142](https://github.com/ClickHouse/ClickHouse/pull/9142) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлен fuzz-тест и некорректное поведение функций `bitTestAll`/`bitTestAny`. [#9143](https://github.com/ClickHouse/ClickHouse/pull/9143) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлен возможный сбой/неправильное количество строк в `LIMIT n WITH TIES`, когда есть много строк, равных n-й строке. [#9464](https://github.com/ClickHouse/ClickHouse/pull/9464) ([tavplubix](https://github.com/tavplubix))
- Исправлены мутации с партициями, записанными с включенным `insert_quorum`. [#9463](https://github.com/ClickHouse/ClickHouse/pull/9463) ([alesapin](https://github.com/alesapin))
- Исправлена гонка данных при уничтожении `Poco::HTTPServer`. Это могло произойти при запуске сервера и немедленном его завершении. [#9468](https://github.com/ClickHouse/ClickHouse/pull/9468) ([Anton Popov](https://github.com/CurtizJ))
- Исправлена ошибка, при которой отображалось вводящее в заблуждение сообщение об ошибке при выполнении `SHOW CREATE TABLE a_table_that_does_not_exist`. [#8899](https://github.com/ClickHouse/ClickHouse/pull/8899) ([achulkov2](https://github.com/achulkov2))
- Исправлено исключение `Parameters are out of bound` в некоторых редких случаях, когда в секции `SELECT` есть константа при наличии секций `ORDER BY` и `LIMIT`. [#8892](https://github.com/ClickHouse/ClickHouse/pull/8892) ([Guillaume Tassery](https://github.com/YiuRULE))
- Исправлена финализация мутаций, когда уже выполненная мутация может иметь статус `is_done=0`. [#9217](https://github.com/ClickHouse/ClickHouse/pull/9217) ([alesapin](https://github.com/alesapin))
- Предотвращено выполнение `ALTER ADD INDEX` для таблиц MergeTree со старым синтаксисом, поскольку это не работает. [#8822](https://github.com/ClickHouse/ClickHouse/pull/8822) ([Mikhail Korotov](https://github.com/millb))
- При запуске сервера не выполняется доступ к таблице, от которой зависит `LIVE VIEW`, чтобы сервер мог запуститься. Также удаляются зависимости `LIVE VIEW` при отсоединении `LIVE VIEW`. `LIVE VIEW` — экспериментальная функция. [#8824](https://github.com/ClickHouse/ClickHouse/pull/8824) ([tavplubix](https://github.com/tavplubix))
- Исправлен возможный segfault в `MergeTreeRangeReader` при выполнении `PREWHERE`. [#9106](https://github.com/ClickHouse/ClickHouse/pull/9106) ([Anton Popov](https://github.com/CurtizJ))
- Исправлены возможные несовпадения контрольных сумм при использовании TTL столбцов. [#9451](https://github.com/ClickHouse/ClickHouse/pull/9451) ([Anton Popov](https://github.com/CurtizJ))
- Исправлена ошибка, когда партиции не перемещались в фоновом режиме по правилам TTL в случае, когда есть только один том. [#8672](https://github.com/ClickHouse/ClickHouse/pull/8672) ([Vladimir Chebotarev](https://github.com/excitoon))
- Исправлена проблема `Method createColumn() is not implemented for data type Set`. Это исправляет [#7799](https://github.com/ClickHouse/ClickHouse/issues/7799). [#8674](https://github.com/ClickHouse/ClickHouse/pull/8674) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Теперь будет выполняться попытка финализации мутаций чаще. [#9427](https://github.com/ClickHouse/ClickHouse/pull/9427) ([alesapin](https://github.com/alesapin))
- Исправлена функция `intDiv` при делении на константу минус один [#9351](https://github.com/ClickHouse/ClickHouse/pull/9351) ([hcz](https://github.com/hczhcz))
- Исправлено возможное состояние гонки в `BlockIO`. [#9356](https://github.com/ClickHouse/ClickHouse/pull/9356) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Исправлена ошибка, приводящая к завершению работы сервера при попытке использовать/удалить таблицу `Kafka`, созданную с неправильными параметрами. [#9513](https://github.com/ClickHouse/ClickHouse/pull/9513) ([filimonov](https://github.com/filimonov))
- Добавлено обходное решение на случай, если ОС возвращает неправильный результат для функции `timer_create`. [#8837](https://github.com/ClickHouse/ClickHouse/pull/8837) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена ошибка в использовании параметра `min_marks_for_seek`. Исправлено сообщение об ошибке, когда в распределенной таблице отсутствует ключ шардирования и выполняется попытка пропустить неиспользуемые шарды. [#8908](https://github.com/ClickHouse/ClickHouse/pull/8908) ([Azat Khuzhin](https://github.com/azat))





#### Улучшения {#improvement-20}

- Реализованы запросы `ALTER MODIFY/DROP` поверх мутаций для семейства движков `ReplicatedMergeTree*`. Теперь `ALTERS` блокируется только на этапе обновления метаданных и не блокируется после этого. [#8701](https://github.com/ClickHouse/ClickHouse/pull/8701) ([alesapin](https://github.com/alesapin))
- Добавлена возможность преобразования CROSS в INNER JOIN с секцией `WHERE`, содержащей неквалифицированные имена. [#9512](https://github.com/ClickHouse/ClickHouse/pull/9512) ([Artem Zuikov](https://github.com/4ertus2))
- Запросы `SHOW TABLES` и `SHOW DATABASES` теперь поддерживают выражения `WHERE` и `FROM`/`IN` [#9076](https://github.com/ClickHouse/ClickHouse/pull/9076) ([sundyli](https://github.com/sundy-li))
- Добавлена настройка `deduplicate_blocks_in_dependent_materialized_views`. [#9070](https://github.com/ClickHouse/ClickHouse/pull/9070) ([urykhy](https://github.com/urykhy))
- После недавних изменений клиент MySQL начал выводить бинарные строки в шестнадцатеричном формате, делая их нечитаемыми ([#9032](https://github.com/ClickHouse/ClickHouse/issues/9032)). Обходное решение в ClickHouse — пометить строковые столбцы как UTF-8, что не всегда, но обычно соответствует действительности. [#9079](https://github.com/ClickHouse/ClickHouse/pull/9079) ([Yuriy Baranov](https://github.com/yurriy))
- Добавлена поддержка ключей типа String и FixedString для `sumMap` [#8903](https://github.com/ClickHouse/ClickHouse/pull/8903) ([Baudouin Giard](https://github.com/bgiard))
- Поддержка строковых ключей в картах SummingMergeTree [#8933](https://github.com/ClickHouse/ClickHouse/pull/8933) ([Baudouin Giard](https://github.com/bgiard))
- Сигнализация о завершении потока в пул потоков даже если поток выбросил исключение [#8736](https://github.com/ClickHouse/ClickHouse/pull/8736) ([Ding Xiang Fei](https://github.com/dingxiangfei2009))
- Разрешена установка `query_id` в `clickhouse-benchmark` [#9416](https://github.com/ClickHouse/ClickHouse/pull/9416) ([Anton Popov](https://github.com/CurtizJ))
- Запрещены некорректные выражения в запросе `ALTER TABLE ... PARTITION partition`. Это решает проблему [#7192](https://github.com/ClickHouse/ClickHouse/issues/7192) [#8835](https://github.com/ClickHouse/ClickHouse/pull/8835) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Таблица `system.table_engines` теперь предоставляет информацию о поддержке функций (таких как `supports_ttl` или `supports_sort_order`). [#8830](https://github.com/ClickHouse/ClickHouse/pull/8830) ([Max Akhmedov](https://github.com/zlobober))
- Включена по умолчанию таблица `system.metric_log`. Она будет содержать строки со значениями ProfileEvents, CurrentMetrics, собранными с интервалом "collect_interval_milliseconds" (по умолчанию одна секунда). Таблица очень маленькая (обычно порядка мегабайт), и сбор этих данных по умолчанию является разумным. [#9225](https://github.com/ClickHouse/ClickHouse/pull/9225) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Инициализация профилировщика запросов для всех потоков в группе, например, это позволяет полностью профилировать insert-запросы. Исправляет [#6964](https://github.com/ClickHouse/ClickHouse/issues/6964) [#8874](https://github.com/ClickHouse/ClickHouse/pull/8874) ([Ivan](https://github.com/abyss7))
- Теперь временное `LIVE VIEW` создается с помощью `CREATE LIVE VIEW name WITH TIMEOUT [42] ...` вместо `CREATE TEMPORARY LIVE VIEW ...`, поскольку предыдущий синтаксис не был согласован с `CREATE TEMPORARY TABLE ...` [#9131](https://github.com/ClickHouse/ClickHouse/pull/9131) ([tavplubix](https://github.com/tavplubix))
- Добавлен параметр конфигурации text_log.level для ограничения записей, попадающих в таблицу `system.text_log` [#8809](https://github.com/ClickHouse/ClickHouse/pull/8809) ([Azat Khuzhin](https://github.com/azat))
- Разрешено размещение загруженных частей на дисках/томах в соответствии с правилами TTL [#8598](https://github.com/ClickHouse/ClickHouse/pull/8598) ([Vladimir Chebotarev](https://github.com/excitoon))
- Для внешних словарей MySQL разрешено объединение пула соединений MySQL для их совместного использования между словарями. Эта опция значительно сокращает количество соединений с серверами MySQL. [#9409](https://github.com/ClickHouse/ClickHouse/pull/9409) ([Clément Rodriguez](https://github.com/clemrodriguez))
- Показ ближайшего времени выполнения запроса для квантилей в выводе `clickhouse-benchmark` вместо интерполированных значений. Лучше показывать значения, соответствующие времени выполнения реальных запросов. [#8712](https://github.com/ClickHouse/ClickHouse/pull/8712) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Возможность добавления ключа и временной метки для сообщения при вставке данных в Kafka. Исправляет [#7198](https://github.com/ClickHouse/ClickHouse/issues/7198) [#8969](https://github.com/ClickHouse/ClickHouse/pull/8969) ([filimonov](https://github.com/filimonov))
- Если сервер запущен из терминала, номер потока, идентификатор запроса и приоритет лога выделяются цветом. Это сделано для улучшения читаемости связанных сообщений лога для разработчиков. [#8961](https://github.com/ClickHouse/ClickHouse/pull/8961) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Улучшено сообщение об исключении при загрузке таблиц для базы данных `Ordinary`. [#9527](https://github.com/ClickHouse/ClickHouse/pull/9527) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Реализована функция `arraySlice` для массивов с состояниями агрегатных функций. Это исправляет [#9388](https://github.com/ClickHouse/ClickHouse/issues/9388) [#9391](https://github.com/ClickHouse/ClickHouse/pull/9391) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Разрешено использование константных функций и константных массивов в правой части оператора IN. [#8813](https://github.com/ClickHouse/ClickHouse/pull/8813) ([Anton Popov](https://github.com/CurtizJ))
- Если при получении данных для system.replicas произошло исключение zookeeper, оно отображается в отдельном столбце. Это реализует [#9137](https://github.com/ClickHouse/ClickHouse/issues/9137) [#9138](https://github.com/ClickHouse/ClickHouse/pull/9138) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Атомарное удаление частей данных MergeTree при уничтожении. [#8402](https://github.com/ClickHouse/ClickHouse/pull/8402) ([Vladimir Chebotarev](https://github.com/excitoon))
- Поддержка безопасности на уровне строк для распределенных таблиц. [#8926](https://github.com/ClickHouse/ClickHouse/pull/8926) ([Ivan](https://github.com/abyss7))
- Теперь распознаются суффиксы (такие как KB, KiB...) в значениях настроек. [#8072](https://github.com/ClickHouse/ClickHouse/pull/8072) ([Mikhail Korotov](https://github.com/millb))
- Предотвращение нехватки памяти при построении результата большого JOIN. [#8637](https://github.com/ClickHouse/ClickHouse/pull/8637) ([Artem Zuikov](https://github.com/4ertus2))
- Добавлены имена кластеров в подсказки в интерактивном режиме в `clickhouse-client`. [#8709](https://github.com/ClickHouse/ClickHouse/pull/8709) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Инициализация профилировщика запросов для всех потоков в группе, например, это позволяет полностью профилировать insert-запросы [#8820](https://github.com/ClickHouse/ClickHouse/pull/8820) ([Ivan](https://github.com/abyss7))
- Добавлен столбец `exception_code` в таблицу `system.query_log`. [#8770](https://github.com/ClickHouse/ClickHouse/pull/8770) ([Mikhail Korotov](https://github.com/millb))
- Включен сервер совместимости с MySQL на порту `9004` в файле конфигурации сервера по умолчанию. Исправлена команда генерации пароля в примере конфигурации. [#8771](https://github.com/ClickHouse/ClickHouse/pull/8771) ([Yuriy Baranov](https://github.com/yurriy))
- Предотвращение аварийного завершения при выключении, если файловая система доступна только для чтения. Это исправляет [#9094](https://github.com/ClickHouse/ClickHouse/issues/9094) [#9100](https://github.com/ClickHouse/ClickHouse/pull/9100) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Улучшено сообщение об исключении, когда требуется длина в HTTP POST запросе. [#9453](https://github.com/ClickHouse/ClickHouse/pull/9453) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлены виртуальные столбцы `_path` и `_file` в движки `HDFS` и `File` и табличные функции `hdfs` и `file` [#8489](https://github.com/ClickHouse/ClickHouse/pull/8489) ([Olga Khvostikova](https://github.com/stavrolia))
- Исправлена ошибка `Cannot find column` при вставке в `MATERIALIZED VIEW` в случае, если новый столбец был добавлен во внутреннюю таблицу представления. [#8766](https://github.com/ClickHouse/ClickHouse/pull/8766) [#8788](https://github.com/ClickHouse/ClickHouse/pull/8788) ([vzakaznikov](https://github.com/vzakaznikov)) [#8788](https://github.com/ClickHouse/ClickHouse/issues/8788) [#8806](https://github.com/ClickHouse/ClickHouse/pull/8806) ([Nikolai Kochetov](https://github.com/KochetovNicolai)) [#8803](https://github.com/ClickHouse/ClickHouse/pull/8803) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Исправлен прогресс по нативному клиент-серверному протоколу путем отправки прогресса после финального обновления (как логи). Это может быть актуально только для некоторых сторонних инструментов, использующих нативный протокол. [#9495](https://github.com/ClickHouse/ClickHouse/pull/9495) ([Azat Khuzhin](https://github.com/azat))
- Добавлена системная метрика, отслеживающая количество клиентских соединений, использующих протокол MySQL ([#9013](https://github.com/ClickHouse/ClickHouse/issues/9013)). [#9015](https://github.com/ClickHouse/ClickHouse/pull/9015) ([Eugene Klimov](https://github.com/Slach))
- Отныне HTTP-ответы будут иметь заголовок `X-ClickHouse-Timezone`, установленный в то же значение часового пояса, которое вернул бы `SELECT timezone()`. [#9493](https://github.com/ClickHouse/ClickHouse/pull/9493) ([Denis Glazachev](https://github.com/traceon))

#### Улучшение производительности {#performance-improvement-16}

- Улучшена производительность анализа индекса с оператором IN [#9261](https://github.com/ClickHouse/ClickHouse/pull/9261) ([Anton Popov](https://github.com/CurtizJ))
- Более простой и эффективный код логических функций + очистка кода. Продолжение [#8718](https://github.com/ClickHouse/ClickHouse/issues/8718) [#8728](https://github.com/ClickHouse/ClickHouse/pull/8728) ([Alexander Kazakov](https://github.com/Akazz))
- Общее улучшение производительности (в диапазоне 5%..200% для затронутых запросов) за счет обеспечения еще более строгого алиасинга с использованием возможностей C++20. [#9304](https://github.com/ClickHouse/ClickHouse/pull/9304) ([Amos Bird](https://github.com/amosbird))
- Более строгий алиасинг для внутренних циклов функций сравнения. [#9327](https://github.com/ClickHouse/ClickHouse/pull/9327) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Более строгий алиасинг для внутренних циклов арифметических функций. [#9325](https://github.com/ClickHouse/ClickHouse/pull/9325) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Реализация ColumnVector::replicate() примерно в 3 раза быстрее, через которую реализуется ColumnConst::convertToFullColumn(). Также будет полезна в тестах при материализации констант. [#9293](https://github.com/ClickHouse/ClickHouse/pull/9293) ([Alexander Kazakov](https://github.com/Akazz))
- Еще одно небольшое улучшение производительности `ColumnVector::replicate()` (ускоряет функцию `materialize` и функции высшего порядка) — дальнейшее улучшение [#9293](https://github.com/ClickHouse/ClickHouse/issues/9293) [#9442](https://github.com/ClickHouse/ClickHouse/pull/9442) ([Alexander Kazakov](https://github.com/Akazz))
- Улучшена производительность агрегатной функции `stochasticLinearRegression`. Этот патч предоставлен Intel. [#8652](https://github.com/ClickHouse/ClickHouse/pull/8652) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Улучшена производительность функции `reinterpretAsFixedString`. [#9342](https://github.com/ClickHouse/ClickHouse/pull/9342) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Блоки не отправляются клиенту для формата `Null` в конвейере процессоров. [#8797](https://github.com/ClickHouse/ClickHouse/pull/8797) ([Nikolai Kochetov](https://github.com/KochetovNicolai)) [#8767](https://github.com/ClickHouse/ClickHouse/pull/8767) ([Alexander Kuzmenkov](https://github.com/akuzm))


#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-20}

- Обработка исключений теперь работает корректно в Windows Subsystem for Linux. См. https://github.com/ClickHouse-Extras/libunwind/pull/3 Это исправляет [#6480](https://github.com/ClickHouse/ClickHouse/issues/6480) [#9564](https://github.com/ClickHouse/ClickHouse/pull/9564) ([sobolevsv](https://github.com/sobolevsv))
- Замена `readline` на `replxx` для интерактивного редактирования строк в `clickhouse-client` [#8416](https://github.com/ClickHouse/ClickHouse/pull/8416) ([Ivan](https://github.com/abyss7))
- Улучшено время сборки и уменьшено количество инстанцирований шаблонов в FunctionsComparison. [#9324](https://github.com/ClickHouse/ClickHouse/pull/9324) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлена интеграция с `clang-tidy` в CI. См. также [#6044](https://github.com/ClickHouse/ClickHouse/issues/6044) [#9566](https://github.com/ClickHouse/ClickHouse/pull/9566) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Теперь в CI ClickHouse линкуется с использованием `lld` даже для `gcc`. [#9049](https://github.com/ClickHouse/ClickHouse/pull/9049) ([alesapin](https://github.com/alesapin))
- Добавлена возможность рандомизации планирования потоков и внесения сбоев при установке переменных окружения `THREAD_FUZZER_*`. Это помогает в тестировании. [#9459](https://github.com/ClickHouse/ClickHouse/pull/9459) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Включены защищенные сокеты в stateless-тестах [#9288](https://github.com/ClickHouse/ClickHouse/pull/9288) ([tavplubix](https://github.com/tavplubix))
- Режим SPLIT_SHARED_LIBRARIES=OFF сделан более надежным [#9156](https://github.com/ClickHouse/ClickHouse/pull/9156) ([Azat Khuzhin](https://github.com/azat))
- Тест "performance_introspection_and_logging" сделан устойчивым к случайному зависанию сервера. Это может происходить в окружении CI. См. также [#9515](https://github.com/ClickHouse/ClickHouse/issues/9515) [#9528](https://github.com/ClickHouse/ClickHouse/pull/9528) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлена валидация XML в проверке стиля. [#9550](https://github.com/ClickHouse/ClickHouse/pull/9550) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлено состояние гонки в тесте `00738_lock_for_inner_table`. Этот тест полагался на sleep. [#9555](https://github.com/ClickHouse/ClickHouse/pull/9555) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Удалены тесты производительности типа `once`. Это необходимо для запуска всех тестов производительности в режиме статистического сравнения (более надежно). [#9557](https://github.com/ClickHouse/ClickHouse/pull/9557) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлен тест производительности для арифметических функций. [#9326](https://github.com/ClickHouse/ClickHouse/pull/9326) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлен тест производительности для агрегатных функций `sumMap` и `sumMapWithOverflow`. Продолжение [#8933](https://github.com/ClickHouse/ClickHouse/issues/8933) [#8947](https://github.com/ClickHouse/ClickHouse/pull/8947) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлена проверка стиля ErrorCodes при проверке стиля кода. [#9370](https://github.com/ClickHouse/ClickHouse/pull/9370) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлен скрипт для истории тестов. [#8796](https://github.com/ClickHouse/ClickHouse/pull/8796) ([alesapin](https://github.com/alesapin))
- Добавлено предупреждение GCC `-Wsuggest-override` для обнаружения и исправления всех мест, где должно использоваться ключевое слово `override`. [#8760](https://github.com/ClickHouse/ClickHouse/pull/8760) ([kreuzerkrieg](https://github.com/kreuzerkrieg))
- Игнорирование слабого символа в Mac OS X, поскольку он должен быть определен [#9538](https://github.com/ClickHouse/ClickHouse/pull/9538) ([Deleted user](https://github.com/ghost))
- Нормализовано время выполнения некоторых запросов в тестах производительности. Это сделано в рамках подготовки к запуску всех тестов производительности в режиме сравнения. [#9565](https://github.com/ClickHouse/ClickHouse/pull/9565) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлены некоторые тесты для поддержки pytest с тестами запросов [#9062](https://github.com/ClickHouse/ClickHouse/pull/9062) ([Ivan](https://github.com/abyss7))
- Включен SSL в сборке с MSan, чтобы сервер не падал при запуске во время выполнения stateless-тестов [#9531](https://github.com/ClickHouse/ClickHouse/pull/9531) ([tavplubix](https://github.com/tavplubix))
- Исправлена подстановка базы данных в результатах тестов [#9384](https://github.com/ClickHouse/ClickHouse/pull/9384) ([Ilya Yatsishin](https://github.com/qoega))
- Исправления сборки для различных платформ [#9381](https://github.com/ClickHouse/ClickHouse/pull/9381) ([proller](https://github.com/proller)) [#8755](https://github.com/ClickHouse/ClickHouse/pull/8755) ([proller](https://github.com/proller)) [#8631](https://github.com/ClickHouse/ClickHouse/pull/8631) ([proller](https://github.com/proller))
- Добавлена секция дисков в docker-образ теста stateless-with-coverage [#9213](https://github.com/ClickHouse/ClickHouse/pull/9213) ([Pavel Kovalenko](https://github.com/Jokser))
- Устранены файлы в дереве исходников при сборке с GRPC [#9588](https://github.com/ClickHouse/ClickHouse/pull/9588) ([Amos Bird](https://github.com/amosbird))
- Немного ускорено время сборки за счет удаления SessionCleaner из Context. Код SessionCleaner сделан более простым. [#9232](https://github.com/ClickHouse/ClickHouse/pull/9232) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Обновлена проверка зависших запросов в скрипте clickhouse-test [#8858](https://github.com/ClickHouse/ClickHouse/pull/8858) ([Alexander Kazakov](https://github.com/Akazz))
- Удалены некоторые ненужные файлы из репозитория. [#8843](https://github.com/ClickHouse/ClickHouse/pull/8843) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Изменен тип математических тестов производительности с `once` на `loop`. [#8783](https://github.com/ClickHouse/ClickHouse/pull/8783) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Добавлен docker-образ, который позволяет создавать интерактивный HTML-отчет браузера кода для нашей кодовой базы. [#8781](https://github.com/ClickHouse/ClickHouse/pull/8781) ([alesapin](https://github.com/alesapin)) См. [Woboq Code Browser](https://clickhouse-test-reports.s3.yandex.net/codebrowser/ClickHouse/dbms/index.html)
- Подавлены некоторые сбои тестов под MSan. [#8780](https://github.com/ClickHouse/ClickHouse/pull/8780) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Ускорен тест "exception while insert". Этот тест часто превышает время ожидания в сборке debug-with-coverage. [#8711](https://github.com/ClickHouse/ClickHouse/pull/8711) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Обновлены `libcxx` и `libcxxabi` до master. В рамках подготовки к [#9304](https://github.com/ClickHouse/ClickHouse/issues/9304) [#9308](https://github.com/ClickHouse/ClickHouse/pull/9308) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлен нестабильный тест `00910_zookeeper_test_alter_compression_codecs`. [#9525](https://github.com/ClickHouse/ClickHouse/pull/9525) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Очищены дублирующиеся флаги линковщика. Обеспечено, что линковщик не будет искать неожиданный символ. [#9433](https://github.com/ClickHouse/ClickHouse/pull/9433) ([Amos Bird](https://github.com/amosbird))
- Добавлен драйвер `clickhouse-odbc` в тестовые образы. Это позволяет тестировать взаимодействие ClickHouse с ClickHouse через собственный ODBC-драйвер. [#9348](https://github.com/ClickHouse/ClickHouse/pull/9348) ([filimonov](https://github.com/filimonov))
- Исправлено несколько ошибок в модульных тестах. [#9047](https://github.com/ClickHouse/ClickHouse/pull/9047) ([alesapin](https://github.com/alesapin))
- Включено предупреждение GCC `-Wmissing-include-dirs` для устранения всех несуществующих включений — в основном как результат ошибок в скриптах CMake [#8704](https://github.com/ClickHouse/ClickHouse/pull/8704) ([kreuzerkrieg](https://github.com/kreuzerkrieg))
- Добавлено описание причин, если профайлер запросов не может работать. Это предназначено для [#9049](https://github.com/ClickHouse/ClickHouse/issues/9049) [#9144](https://github.com/ClickHouse/ClickHouse/pull/9144) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Обновлен OpenSSL до upstream master. Исправлена проблема, когда TLS-соединения могли завершаться с сообщением `OpenSSL SSL_read: error:14094438:SSL routines:ssl3_read_bytes:tlsv1 alert internal error` и `SSL Exception: error:2400006E:random number generator::error retrieving entropy`. Проблема присутствовала в версии 20.1. [#8956](https://github.com/ClickHouse/ClickHouse/pull/8956) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Обновлен Dockerfile для сервера [#8893](https://github.com/ClickHouse/ClickHouse/pull/8893) ([Ilya Mazaev](https://github.com/ne-ray))
- Незначительные исправления в скрипте build-gcc-from-sources [#8774](https://github.com/ClickHouse/ClickHouse/pull/8774) ([Michael Nacharov](https://github.com/mnach))
- Замена `numbers` на `zeros` в тестах производительности, где столбец `number` не используется. Это приведет к более чистым результатам тестов. [#9600](https://github.com/ClickHouse/ClickHouse/pull/9600) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Исправлена проблема переполнения стека при использовании initializer_list в конструкторах Column. [#9367](https://github.com/ClickHouse/ClickHouse/pull/9367) ([Deleted user](https://github.com/ghost))
- Обновление librdkafka до v1.3.0. Включены встроенные библиотеки `rdkafka` и `gsasl` на Mac OS X. [#9000](https://github.com/ClickHouse/ClickHouse/pull/9000) ([Andrew Onyshchuk](https://github.com/oandrew))
- Исправление сборки на GCC 9.2.0 [#9306](https://github.com/ClickHouse/ClickHouse/pull/9306) ([vxider](https://github.com/Vxider))





## Релиз ClickHouse v20.1 {#clickhouse-release-v201}

### Релиз ClickHouse v20.1.16.120-stable 2020-60-26 {#clickhouse-release-v20116120-stable-2020-60-26}

#### Исправление ошибок {#bug-fix-50}

- Исправлено редкое падение, вызванное использованием столбца типа `Nullable` в условии prewhere. Продолжение [#11608](https://github.com/ClickHouse/ClickHouse/issues/11608). [#11869](https://github.com/ClickHouse/ClickHouse/pull/11869) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Запрещено использование arrayJoin внутри функций высшего порядка. Это приводило к нарушению синхронизации протокола. Закрывает [#3933](https://github.com/ClickHouse/ClickHouse/issues/3933). [#11846](https://github.com/ClickHouse/ClickHouse/pull/11846) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Исправлено неожиданное поведение запросов вида `SELECT *, xyz.*`, которые выполнялись успешно, хотя ожидалась ошибка. [#11753](https://github.com/ClickHouse/ClickHouse/pull/11753) ([hexiaoting](https://github.com/hexiaoting)).
- Исправлена ошибка LOGICAL_ERROR, вызванная неправильным выводом типа сложных литералов во входном формате Values. [#11732](https://github.com/ClickHouse/ClickHouse/pull/11732) ([tavplubix](https://github.com/tavplubix)).
- Исправлена работа `ORDER BY ... WITH FILL` для константных столбцов. [#11697](https://github.com/ClickHouse/ClickHouse/pull/11697) ([Anton Popov](https://github.com/CurtizJ)).
- Исправлена передача корректных таймаутов при взаимодействии с XDBC bridge. Ранее таймауты не учитывались при проверке доступности bridge и получении метаинформации. [#11690](https://github.com/ClickHouse/ClickHouse/pull/11690) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлена поддержка регулярных выражений с флагами без учёта регистра. Исправляет [#11101](https://github.com/ClickHouse/ClickHouse/issues/11101) и [#11506](https://github.com/ClickHouse/ClickHouse/issues/11506). [#11649](https://github.com/ClickHouse/ClickHouse/pull/11649) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Исправлены фильтры Блума для типа String (индексы пропуска данных). [#11638](https://github.com/ClickHouse/ClickHouse/pull/11638) ([Azat Khuzhin](https://github.com/azat)).
- Исправлено редкое падение, вызванное использованием столбца типа `Nullable` в условии prewhere. (Вероятно, это как-то связано с [#11572](https://github.com/ClickHouse/ClickHouse/issues/11572)). [#11608](https://github.com/ClickHouse/ClickHouse/pull/11608) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Исправлен неправильный код выхода clickhouse-client, когда exception.code() % 256 = 0. [#11601](https://github.com/ClickHouse/ClickHouse/pull/11601) ([filimonov](https://github.com/filimonov)).
- Исправлена тривиальная ошибка в сообщении лога о «Mark cache size was lowered» при запуске сервера. Закрывает [#11399](https://github.com/ClickHouse/ClickHouse/issues/11399). [#11589](https://github.com/ClickHouse/ClickHouse/pull/11589) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Теперь docker-контейнер clickhouse-server будет предпочитать IPv6 при проверке доступности сервера. [#11550](https://github.com/ClickHouse/ClickHouse/pull/11550) ([Ivan Starkov](https://github.com/istarkov)).
- Исправлена утечка памяти при возникновении исключения в процессе агрегации с функциями -State. Исправляет [#8995](https://github.com/ClickHouse/ClickHouse/issues/8995). [#11496](https://github.com/ClickHouse/ClickHouse/pull/11496) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Исправлено использование первичного ключа, обёрнутого в функцию, с модификатором 'FINAL' и оптимизацией 'ORDER BY'. [#10715](https://github.com/ClickHouse/ClickHouse/pull/10715) ([Anton Popov](https://github.com/CurtizJ)).


### ClickHouse release v20.1.15.109-stable 2020-06-19 {#clickhouse-release-v20115109-stable-2020-06-19}

#### Исправление ошибки {#bug-fix-51}

- Исправлено избыточное блокирование структуры во время ALTER-запросов. [#11790](https://github.com/ClickHouse/ClickHouse/pull/11790) ([alesapin](https://github.com/alesapin)).

### ClickHouse release v20.1.14.107-stable 2020-06-11 {#clickhouse-release-v20114107-stable-2020-06-11}

#### Исправление ошибки {#bug-fix-52}

- Исправлена ошибка `Size of offsets does not match size of column` для запросов с `PREWHERE column in (subquery)` и `ARRAY JOIN`. [#11580](https://github.com/ClickHouse/ClickHouse/pull/11580) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).

### ClickHouse release v20.1.13.105-stable 2020-06-10 {#clickhouse-release-v20113105-stable-2020-06-10}

#### Исправление ошибки {#bug-fix-53}


* Исправлена ошибка `Data compressed with different methods`, которая могла возникать при включённом `min_bytes_to_use_direct_io`, активном PREWHERE и использовании SAMPLE или большого числа потоков. Исправлено [#11539](https://github.com/ClickHouse/ClickHouse/issues/11539). [#11540](https://github.com/ClickHouse/ClickHouse/pull/11540) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено значение возвращаемого размера сжатых данных для кодеков. [#11448](https://github.com/ClickHouse/ClickHouse/pull/11448) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено падение сервера, когда столбец использует кодек сжатия с нелитеральными аргументами. Исправляет [#11365](https://github.com/ClickHouse/ClickHouse/issues/11365). [#11431](https://github.com/ClickHouse/ClickHouse/pull/11431) ([alesapin](https://github.com/alesapin)).
* Исправлена функция pointInPolygon при использовании `nan` в качестве точки. Исправляет [#11375](https://github.com/ClickHouse/ClickHouse/issues/11375). [#11421](https://github.com/ClickHouse/ClickHouse/pull/11421) ([Alexey Ilyukhov](https://github.com/livace)).
* Исправлена функция geohashesInBox при использовании аргументов, выходящих за пределы допустимого диапазона широты/долготы. [#11403](https://github.com/ClickHouse/ClickHouse/pull/11403) ([Vasily Nemkov](https://github.com/Enmk)).
* Исправлена возможная ошибка `Pipeline stuck` для запросов с внешней сортировкой и ограничением. Устраняет [#11359](https://github.com/ClickHouse/ClickHouse/issues/11359). [#11366](https://github.com/ClickHouse/ClickHouse/pull/11366) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, приводившая к падению в `quantilesExactWeightedArray`. [#11337](https://github.com/ClickHouse/ClickHouse/pull/11337) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Снова сделать запись в `MATERIALIZED VIEW` с настройкой `parallel_view_processing = 1` параллельной. Исправлено в [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241). [#11330](https://github.com/ClickHouse/ClickHouse/pull/11330) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена функция `visitParamExtractRaw` для случая, когда извлечённый JSON содержит строки с несбалансированными &#123; или [. [#11318](https://github.com/ClickHouse/ClickHouse/pull/11318) ([Ewout](https://github.com/devwout)).
* Исправлена крайне редкая гонка в `ThreadPool`. [#11314](https://github.com/ClickHouse/ClickHouse/pull/11314) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено потенциальное использование неинициализированной памяти при преобразовании. Пример: `SELECT toIntervalSecond(now64())`. [#11311](https://github.com/ClickHouse/ClickHouse/pull/11311) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена проблема, из-за которой анализ индексов не работал, если в первичный ключ таблицы входил столбец типа Array и запрос фильтровал по этому столбцу с помощью функций `empty` или `notEmpty`. Это исправляет [#11286](https://github.com/ClickHouse/ClickHouse/issues/11286). [#11303](https://github.com/ClickHouse/ClickHouse/pull/11303) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка, из-за которой оценка скорости выполнения запроса могла быть некорректной и настройка `min_execution_speed` могла не работать или работать неправильно, если запрос ограничивается параметрами `max_network_bandwidth`, `max_execution_speed` или `priority`. Изменено значение по умолчанию `timeout_before_checking_execution_speed` на ненулевое, потому что в противном случае настройки `min_execution_speed` и `max_execution_speed` не оказывают никакого эффекта. Исправляет [#11297](https://github.com/ClickHouse/ClickHouse/issues/11297). Исправляет [#5732](https://github.com/ClickHouse/ClickHouse/issues/5732). Исправляет [#6228](https://github.com/ClickHouse/ClickHouse/issues/6228). Улучшение удобства использования: исключена конкатенация сообщения об исключении с индикатором прогресса в `clickhouse-client`. [#11296](https://github.com/ClickHouse/ClickHouse/pull/11296) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено падение при чтении некорректных данных в формате Protobuf. Исправляет [#5957](https://github.com/ClickHouse/ClickHouse/issues/5957), исправляет [#11203](https://github.com/ClickHouse/ClickHouse/issues/11203). [#11258](https://github.com/ClickHouse/ClickHouse/pull/11258) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена возможная ошибка `Cannot capture column` при использовании функций высшего порядка с захваченным аргументом типа `Array(Array(LowCardinality))`. [#11185](https://github.com/ClickHouse/ClickHouse/pull/11185) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Если индекс пропуска данных зависит от столбцов, которые будут изменены во время фонового слияния (для SummingMergeTree, AggregatingMergeTree, а также для TTL GROUP BY), он вычислялся некорректно. Эта проблема исправлена переносом вычисления индекса на этап после слияния, чтобы индекс вычислялся по уже слитым данным. [#11162](https://github.com/ClickHouse/ClickHouse/pull/11162) ([Azat Khuzhin](https://github.com/azat)).
* Убрано логирование в задаче финализации мутаций, если ничего не было финализировано. [#11109](https://github.com/ClickHouse/ClickHouse/pull/11109) ([alesapin](https://github.com/alesapin)).
* Исправлены ошибки разрешения аргументов функции parseDateTime64BestEffort. [#10925](https://github.com/ClickHouse/ClickHouse/issues/10925). [#11038](https://github.com/ClickHouse/ClickHouse/pull/11038) ([Vasily Nemkov](https://github.com/Enmk)).
* Исправлен некорректный размер сырых данных в методе getRawData(). [#10964](https://github.com/ClickHouse/ClickHouse/pull/10964) ([Igr](https://github.com/ObjatieGroba)).
* Исправлена обратная совместимость с кортежами в таблицах типа Distributed. [#10889](https://github.com/ClickHouse/ClickHouse/pull/10889) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен SIGSEGV в StringHashTable (если такого ключа не существует). [#10870](https://github.com/ClickHouse/ClickHouse/pull/10870) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка в `ReplicatedMergeTree`, из-за которой некоторые запросы `ALTER` на `OPTIMIZE` могли зависать в ожидании реплики после того, как она становилась неактивной. [#10849](https://github.com/ClickHouse/ClickHouse/pull/10849) ([tavplubix](https://github.com/tavplubix)).
* Исправлен порядок столбцов после `Block::sortColumns()` (также добавлен тест, демонстрирующий влияние на реальный сценарий использования — движок Buffer). [#10826](https://github.com/ClickHouse/ClickHouse/pull/10826) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема с ODBC bridge, возникавшая, когда не требовалось экранирование идентификаторов. Это исправляет [#7984](https://github.com/ClickHouse/ClickHouse/issues/7984). [#10821](https://github.com/ClickHouse/ClickHouse/pull/10821) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены отчёты UBSan и MSan в DateLUT. [#10798](https://github.com/ClickHouse/ClickHouse/pull/10798) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* * Использовать `src_type` для корректного преобразования типов в условиях по ключу. Исправляет [#6287](https://github.com/ClickHouse/ClickHouse/issues/6287). [#10791](https://github.com/ClickHouse/ClickHouse/pull/10791) ([Andrew Onyshchuk](https://github.com/oandrew)).
* Исправлено поведение `parallel_view_processing`. Теперь все вставки в `MATERIALIZED VIEW` в любом случае будут завершены даже при возникновении исключения. Исправляет [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241). [#10757](https://github.com/ClickHouse/ClickHouse/pull/10757) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлены комбинаторы -OrNull и -OrDefault при совместном использовании с -State. [#10741](https://github.com/ClickHouse/ClickHouse/pull/10741) ([hcz](https://github.com/hczhcz)).
* Исправлена проблема с исчезающими totals. Totals могли быть отфильтрованы, если запрос содержал `JOIN` или подзапрос с внешним `WHERE`-условием. Исправляет [#10674](https://github.com/ClickHouse/ClickHouse/issues/10674). [#10698](https://github.com/ClickHouse/ClickHouse/pull/10698) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ситуация с многократным использованием оператора `IN` с одним и тем же набором значений в одном запросе. [#10686](https://github.com/ClickHouse/ClickHouse/pull/10686) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен порядок параметров в конструкторе `AggregateTransform`. [#10667](https://github.com/ClickHouse/ClickHouse/pull/10667) ([palasonic1](https://github.com/palasonic1)).
* Исправлено отсутствие параллельного выполнения удалённых запросов при включённом `distributed_aggregation_memory_efficient`. Исправляет [#10655](https://github.com/ClickHouse/ClickHouse/issues/10655). [#10664](https://github.com/ClickHouse/ClickHouse/pull/10664) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена оптимизация предикатов для распределённых запросов (`enable_optimize_predicate_expression=1`) для запросов с секцией `HAVING` (то есть когда требуется фильтрация на сервере-инициаторе) за счёт сохранения порядка выражений (этого достаточно для исправления), а также принудительного использования агрегатором имён столбцов вместо индексов. Исправления: [#10613](https://github.com/ClickHouse/ClickHouse/issues/10613), [#11413](https://github.com/ClickHouse/ClickHouse/issues/11413). [#10621](https://github.com/ClickHouse/ClickHouse/pull/10621) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка «the BloomFilter false positive must be a double number between 0 and 1» [#10551](https://github.com/ClickHouse/ClickHouse/issues/10551). [#10569](https://github.com/ClickHouse/ClickHouse/pull/10569) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена обработка `SELECT` столбца `ALIAS`, у которого тип выражения по умолчанию отличается от типа столбца. [#10563](https://github.com/ClickHouse/ClickHouse/pull/10563) ([Azat Khuzhin](https://github.com/azat)).
* * Реализовано сравнение значений `DateTime64` и `String` (аналогично `DateTime`). [#10560](https://github.com/ClickHouse/ClickHouse/pull/10560) ([Vasily Nemkov](https://github.com/Enmk)).

### Релиз ClickHouse v20.1.12.86, 2020-05-26 {#clickhouse-release-v2011286-2020-05-26}

#### Исправление ошибок {#bug-fix-54}


* Исправлена несовместимость двухуровневой агрегации между версией 20.1 и более ранними. Эта несовместимость возникает, когда на инициирующем узле и удалённых узлах используются разные версии ClickHouse, размер результата GROUP BY велик, а агрегация выполняется по одному полю типа String. Это приводит к появлению в результате нескольких несведённых строк для одного ключа. [#10952](https://github.com/ClickHouse/ClickHouse/pull/10952) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено повреждение данных в ключевом столбце `LowCardinality(FixedString)` в `SummingMergeTree`, которое могло происходить после слияния. Исправлена проблема [#10489](https://github.com/ClickHouse/ClickHouse/issues/10489). [#10721](https://github.com/ClickHouse/ClickHouse/pull/10721) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, из-за которой HTTP-запросы зависали при закрытии клиента при `readonly=2` и `cancel_http_readonly_queries_on_client_close=1`. Исправляет [#7939](https://github.com/ClickHouse/ClickHouse/issues/7939), [#7019](https://github.com/ClickHouse/ClickHouse/issues/7019), [#7736](https://github.com/ClickHouse/ClickHouse/issues/7736), [#7091](https://github.com/ClickHouse/ClickHouse/issues/7091). [#10684](https://github.com/ClickHouse/ClickHouse/pull/10684) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ошибка, из-за которой при выполнении запроса `SYSTEM DROP DNS CACHE` также сбрасывались кэши, используемые для проверки, разрешено ли пользователю подключаться с определённых IP-адресов. [#10608](https://github.com/ClickHouse/ClickHouse/pull/10608) ([tavplubix](https://github.com/tavplubix)).
* Исправлены некорректные скалярные результаты во внутреннем запросе `MATERIALIZED VIEW` в случае, когда этот запрос ссылался на зависимую таблицу. [#10603](https://github.com/ClickHouse/ClickHouse/pull/10603) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ситуация, когда мутация обработала все части, но зависла в состоянии `is_done=0`. [#10526](https://github.com/ClickHouse/ClickHouse/pull/10526) ([alesapin](https://github.com/alesapin)).
* Исправлено переполнение в начале эпохи Unix для часовых поясов с дробным смещением от UTC. Это исправляет [#9335](https://github.com/ClickHouse/ClickHouse/issues/9335). [#10513](https://github.com/ClickHouse/ClickHouse/pull/10513) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено некорректное завершение работы движка таблиц Distributed. [#10491](https://github.com/ClickHouse/ClickHouse/pull/10491) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено переполнение чисел в `simpleLinearRegression` при работе с большими целыми значениями. [#10474](https://github.com/ClickHouse/ClickHouse/pull/10474) ([hcz](https://github.com/hczhcz)).
* Исправлено некорректное удаление каталога метаданных при ошибке операции `ATTACH DATABASE`. [#10442](https://github.com/ClickHouse/ClickHouse/pull/10442) ([Winter Zhang](https://github.com/zhang2014)).
* Добавлена проверка количества и типов аргументов при создании индекса `BloomFilter` [#9623](https://github.com/ClickHouse/ClickHouse/issues/9623). [#10431](https://github.com/ClickHouse/ClickHouse/pull/10431) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена проблема, из-за которой запрос с `ARRAY JOIN`, `ORDER BY` и `LIMIT` мог возвращать неполный результат. Это исправляет [#10226](https://github.com/ClickHouse/ClickHouse/issues/10226). [#10427](https://github.com/ClickHouse/ClickHouse/pull/10427) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Используйте `fallback_to_stale_replicas` вместо `skip_unavailable_shards`. [#10422](https://github.com/ClickHouse/ClickHouse/pull/10422) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена некорректная «плоская» развёртка типов данных `Array(Tuple(...))`. Это исправляет [#10259](https://github.com/ClickHouse/ClickHouse/issues/10259). [#10390](https://github.com/ClickHouse/ClickHouse/pull/10390) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено некорректное поведение в `HashTable`, которое приводило к ошибке компиляции при попытке прочитать `HashMap` из буфера. [#10386](https://github.com/ClickHouse/ClickHouse/pull/10386) ([palasonic1](https://github.com/palasonic1)).
* Исправлена возможная ошибка `Pipeline stuck` в `ConcatProcessor`, которая могла возникать при выполнении удалённого запроса. [#10381](https://github.com/ClickHouse/ClickHouse/pull/10381) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка зависания конвейера (`Pipeline stuck`) при использовании `max_rows_to_group_by` и `group_by_overflow_mode = 'break'`. [#10279](https://github.com/ClickHouse/ClickHouse/pull/10279) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено несколько ошибок, возникавших, когда часть данных вставлялась с `quorum`, затем каким‑то образом удалялась (`DROP PARTITION`, `TTL`), что приводило к зависанию `INSERT` или ложным исключениям в `SELECT`. Это исправляет [#9946](https://github.com/ClickHouse/ClickHouse/issues/9946). [#10188](https://github.com/ClickHouse/ClickHouse/pull/10188) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена несовместимость, возникавшая при использовании версий до 18.12.17 на удалённых серверах и более новой версии на инициирующем сервере, при выполнении GROUP BY одновременно по фиксированным и нефиксированным ключам, а также при включённом двухуровневом методе группировки. [#3254](https://github.com/ClickHouse/ClickHouse/pull/3254) ([alexey-milovidov](https://github.com/alexey-milovidov)).

#### Улучшение сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-21}

- Добавлены CA-сертификаты в Docker-образ clickhouse-server. [#10476](https://github.com/ClickHouse/ClickHouse/pull/10476) ([filimonov](https://github.com/filimonov)).

### Релиз ClickHouse v20.1.10.70, 2020-04-17 {#clickhouse-release-v2011070-2020-04-17}

#### Исправление ошибок {#bug-fix-55}


* Исправлено редкое возможное исключение `Cannot drain connections: cancel first`. [#10239](https://github.com/ClickHouse/ClickHouse/pull/10239) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, из-за которой ClickHouse выдавал сообщение `'Unknown function lambda.'`, когда пользователь пытался выполнить `ALTER UPDATE/DELETE` над таблицами с `ENGINE = Replicated*`. Проверка недетерминированных функций теперь корректно обрабатывает lambda-выражения. [#10237](https://github.com/ClickHouse/ClickHouse/pull/10237) ([Alexander Kazakov](https://github.com/Akazz)).
* Исправлена функция `parseDateTimeBestEffort` для строк в формате RFC-2822, когда в качестве дня недели указаны Tuesday или Thursday. Это исправляет [#10082](https://github.com/ClickHouse/ClickHouse/issues/10082). [#10214](https://github.com/ClickHouse/ClickHouse/pull/10214) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены имена столбцов с константами внутри `JOIN`, которые могли конфликтовать с именами констант вне `JOIN`. [#10207](https://github.com/ClickHouse/ClickHouse/pull/10207) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена возможная ситуация, когда запрос бесконечно выполнялся при чтении из бесконечного источника, такого как `system.numbers` или `system.zeros`, хотя должен был завершаться по LIMIT. [#10206](https://github.com/ClickHouse/ClickHouse/pull/10206) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена оптимизация переноса в PREWHERE в присутствии функций `arrayJoin` (в некоторых случаях). Это исправляет [#10092](https://github.com/ClickHouse/ClickHouse/issues/10092). [#10195](https://github.com/ClickHouse/ClickHouse/pull/10195) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность ослабить ограничение на использование недетерминированных функций в мутациях с помощью настройки `allow_nondeterministic_mutations`. [#10186](https://github.com/ClickHouse/ClickHouse/pull/10186) ([filimonov](https://github.com/filimonov)).
* Преобразовывать блоки, если структура не совпадает при `INSERT` в таблицу с движком `Distributed`. [#10135](https://github.com/ClickHouse/ClickHouse/pull/10135) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка `SIGSEGV` при выполнении `INSERT` в таблицу `Distributed`, если её структура отличается от структуры базовых таблиц. [#10105](https://github.com/ClickHouse/ClickHouse/pull/10105) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена возможная потеря строк для запросов с `JOIN` и `UNION ALL`. Исправляет [#9826](https://github.com/ClickHouse/ClickHouse/issues/9826), [#10113](https://github.com/ClickHouse/ClickHouse/issues/10113). [#10099](https://github.com/ClickHouse/ClickHouse/pull/10099) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлена проверка аргументов и поддержка идентификаторов в качестве аргументов для MySQL Database Engine. [#10077](https://github.com/ClickHouse/ClickHouse/pull/10077) ([Winter Zhang](https://github.com/zhang2014)).
* Исправлена ошибка в источнике словаря ClickHouse с использованием локального сервера ClickHouse. Ошибка могла приводить к повреждению памяти, если типы в словаре и источнике были несовместимы. [#10071](https://github.com/ClickHouse/ClickHouse/pull/10071) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка `Cannot clone block with columns because block has 0 columns ... While executing GroupingAggregatedTransform`. Она возникала при включённой настройке `distributed_aggregation_memory_efficient`, когда распределённый запрос считывал агрегированные данные с разным уровнем из разных шардов (смешанная одно- и двухуровневая агрегация). [#10063](https://github.com/ClickHouse/ClickHouse/pull/10063) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка сегментации, которая могла возникать в `GROUP BY` по строковым ключам, содержащим завершающие нулевые байты ([#8636](https://github.com/ClickHouse/ClickHouse/issues/8636), [#8925](https://github.com/ClickHouse/ClickHouse/issues/8925)). [#10025](https://github.com/ClickHouse/ClickHouse/pull/10025) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Исправлена ошибка, из-за которой необходимые таблицы не извлекались на одном из этапов обработки запросов к некоторым базам данных. Исправляет [#9699](https://github.com/ClickHouse/ClickHouse/issues/9699). [#9949](https://github.com/ClickHouse/ClickHouse/pull/9949) ([achulkov2](https://github.com/achulkov2)).
* Исправлена ошибка `'Not found column in block'`, возникающая при использовании `JOIN` с `TOTALS`. Исправляет [#9839](https://github.com/ClickHouse/ClickHouse/issues/9839). [#9939](https://github.com/ClickHouse/ClickHouse/pull/9939) ([Artem Zuikov](https://github.com/4ertus2)).
* Исправлена ошибка, из-за которой DDL-запросы с `ON CLUSTER` зависали при запуске сервера. [#9927](https://github.com/ClickHouse/ClickHouse/pull/9927) ([Gagan Arneja](https://github.com/garneja)).
* Исправлена команда `TRUNCATE` для движка таблиц Join ([#9917](https://github.com/ClickHouse/ClickHouse/issues/9917)). [#9920](https://github.com/ClickHouse/ClickHouse/pull/9920) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка `'scalar does not exist'` в запросах ALTER ([#9878](https://github.com/ClickHouse/ClickHouse/issues/9878)). [#9904](https://github.com/ClickHouse/ClickHouse/pull/9904) ([Amos Bird](https://github.com/amosbird)).
* Исправлена гонка потоков между `drop` и `optimize` в `ReplicatedMergeTree`. [#9901](https://github.com/ClickHouse/ClickHouse/pull/9901) ([alesapin](https://github.com/alesapin)).
* Исправлена логика `DeleteOnDestroy` в `ATTACH PART`, которая могла приводить к автоматическому удалению присоединённой партиции, и добавлено несколько тестов. [#9410](https://github.com/ClickHouse/ClickHouse/pull/9410) ([Vladimir Chebotarev](https://github.com/excitoon)).

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-22}

- Исправлен модульный тест `collapsing_sorted_stream`. [#9367](https://github.com/ClickHouse/ClickHouse/pull/9367) ([Deleted user](https://github.com/ghost)).

### Релиз ClickHouse v20.1.9.54, 2020-03-28 {#clickhouse-release-v201954-2020-03-28}

#### Исправление ошибок {#bug-fix-56}

- Исправлена ошибка `'Different expressions with the same alias'` при выполнении запроса с `PREWHERE` и `WHERE` к распределённой таблице и `SET distributed_product_mode = 'local'`. [#9871](https://github.com/ClickHouse/ClickHouse/pull/9871) ([Artem Zuikov](https://github.com/4ertus2)).
- Исправлено чрезмерное потребление памяти при выполнении мутаций для таблиц с составным первичным ключом. Исправляет [#9850](https://github.com/ClickHouse/ClickHouse/issues/9850). [#9860](https://github.com/ClickHouse/ClickHouse/pull/9860) ([alesapin](https://github.com/alesapin)).
- Для запросов INSERT шард теперь приводит настройки, полученные от инициатора, к ограничениям шарда, вместо выброса исключения. Это исправление позволяет отправлять запросы `INSERT` на шард с другими ограничениями. Улучшает исправление [#9447](https://github.com/ClickHouse/ClickHouse/issues/9447). [#9852](https://github.com/ClickHouse/ClickHouse/pull/9852) ([Vitaly Baranov](https://github.com/vitlibar)).
- Исправлено возможное исключение `Got 0 in totals chunk, expected 1` на клиенте. Оно возникало для запросов с `JOIN`, если правая присоединяемая таблица содержала ноль строк. Пример: `select * from system.one t1 join system.one t2 on t1.dummy = t2.dummy limit 0 FORMAT TabSeparated;`. Исправляет [#9777](https://github.com/ClickHouse/ClickHouse/issues/9777). [#9823](https://github.com/ClickHouse/ClickHouse/pull/9823) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Исправлен `SIGSEGV` с `optimize_skip_unused_shards` при невозможности преобразования типа. [#9804](https://github.com/ClickHouse/ClickHouse/pull/9804) ([Azat Khuzhin](https://github.com/azat)).
- Исправлено несколько случаев, когда часовой пояс аргумента функции использовался некорректно. [#9574](https://github.com/ClickHouse/ClickHouse/pull/9574) ([Vasily Nemkov](https://github.com/Enmk)).

#### Улучшения {#improvement-21}

- Удалена стадия `ORDER BY` из мутаций, поскольку чтение выполняется из одной упорядоченной части в одном потоке. Также добавлена проверка того, что порядок строк в мутации соответствует порядку ключа сортировки и не нарушается. [#9886](https://github.com/ClickHouse/ClickHouse/pull/9886) ([alesapin](https://github.com/alesapin)).

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-23}

- Удалены дублирующиеся флаги компоновщика. Обеспечена гарантия того, что компоновщик не будет искать неожиданные символы. [#9433](https://github.com/ClickHouse/ClickHouse/pull/9433) ([Amos Bird](https://github.com/amosbird)).

### Релиз ClickHouse v20.1.8.41, 2020-03-20 {#clickhouse-release-v201841-2020-03-20}


#### Исправление ошибок {#bug-fix-57}

- Исправлена возможная постоянная ошибка `Cannot schedule a task` (из-за необработанного исключения в `ParallelAggregatingBlockInputStream::Handler::onFinish/onFinishThread`). Исправляет [#6833](https://github.com/ClickHouse/ClickHouse/issues/6833). [#9154](https://github.com/ClickHouse/ClickHouse/pull/9154) ([Azat Khuzhin](https://github.com/azat))
- Исправлено чрезмерное потребление памяти в запросах `ALTER` (мутациях). Исправляет [#9533](https://github.com/ClickHouse/ClickHouse/issues/9533) и [#9670](https://github.com/ClickHouse/ClickHouse/issues/9670). [#9754](https://github.com/ClickHouse/ClickHouse/pull/9754) ([alesapin](https://github.com/alesapin))
- Исправлена ошибка в обратных кавычках в DDL внешних словарей. Исправляет [#9619](https://github.com/ClickHouse/ClickHouse/issues/9619). [#9734](https://github.com/ClickHouse/ClickHouse/pull/9734) ([alesapin](https://github.com/alesapin))

### Релиз ClickHouse v20.1.7.38, 2020-03-18 {#clickhouse-release-v201738-2020-03-18}


#### Исправление ошибок {#bug-fix-58}

- Исправлены некорректные внутренние имена функций `sumKahan` и `sumWithOverflow`. Это приводило к исключению при использовании этих функций в удалённых запросах. [#9636](https://github.com/ClickHouse/ClickHouse/pull/9636) ([Azat Khuzhin](https://github.com/azat)). Эта проблема присутствовала во всех релизах ClickHouse.
- Разрешено выполнение `ALTER ON CLUSTER` для таблиц `Distributed` с внутренней репликацией. Это исправляет [#3268](https://github.com/ClickHouse/ClickHouse/issues/3268). [#9617](https://github.com/ClickHouse/ClickHouse/pull/9617) ([shinoi2](https://github.com/shinoi2)). Эта проблема присутствовала во всех релизах ClickHouse.
- Исправлены возможные исключения `Size of filter does not match size of column` и `Invalid number of rows in Chunk` в `MergeTreeRangeReader`. Они могли возникать при выполнении `PREWHERE` в некоторых случаях. Исправляет [#9132](https://github.com/ClickHouse/ClickHouse/issues/9132). [#9612](https://github.com/ClickHouse/ClickHouse/pull/9612) ([Anton Popov](https://github.com/CurtizJ))
- Исправлена проблема: часовой пояс не сохранялся при записи простого арифметического выражения вида `time + 1` (в отличие от выражения вида `time + INTERVAL 1 SECOND`). Это исправляет [#5743](https://github.com/ClickHouse/ClickHouse/issues/5743). [#9323](https://github.com/ClickHouse/ClickHouse/pull/9323) ([alexey-milovidov](https://github.com/alexey-milovidov)). Эта проблема присутствовала во всех релизах ClickHouse.
- Теперь невозможно создать или добавить столбцы с простыми циклическими псевдонимами вида `a DEFAULT b, b DEFAULT a`. [#9603](https://github.com/ClickHouse/ClickHouse/pull/9603) ([alesapin](https://github.com/alesapin))
- Исправлена проблема, когда дополнение в конце значения, закодированного в base64, могло быть некорректным. Обновлена библиотека base64. Это исправляет [#9491](https://github.com/ClickHouse/ClickHouse/issues/9491), закрывает [#9492](https://github.com/ClickHouse/ClickHouse/issues/9492) [#9500](https://github.com/ClickHouse/ClickHouse/pull/9500) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Исправлена гонка данных при уничтожении `Poco::HTTPServer`. Это могло происходить при запуске сервера с немедленным завершением работы. [#9468](https://github.com/ClickHouse/ClickHouse/pull/9468) ([Anton Popov](https://github.com/CurtizJ))
- Исправлен возможный сбой/неверное количество строк в `LIMIT n WITH TIES`, когда имеется много строк, равных n-й строке. [#9464](https://github.com/ClickHouse/ClickHouse/pull/9464) ([tavplubix](https://github.com/tavplubix))
- Исправлены возможные несовпадения контрольных сумм при использовании TTL столбцов. [#9451](https://github.com/ClickHouse/ClickHouse/pull/9451) ([Anton Popov](https://github.com/CurtizJ))
- Исправлен сбой, когда пользователь пытается выполнить `ALTER MODIFY SETTING` для движков таблиц семейства `MergeTree` старого формата. [#9435](https://github.com/ClickHouse/ClickHouse/pull/9435) ([alesapin](https://github.com/alesapin))
- Теперь будет выполняться попытка завершения мутаций чаще. [#9427](https://github.com/ClickHouse/ClickHouse/pull/9427) ([alesapin](https://github.com/alesapin))
- Исправлена несовместимость протокола репликации, внесённая в [#8598](https://github.com/ClickHouse/ClickHouse/issues/8598). [#9412](https://github.com/ClickHouse/ClickHouse/pull/9412) ([alesapin](https://github.com/alesapin))
- Исправлена функция not(has()) для индекса bloom_filter типов массивов. [#9407](https://github.com/ClickHouse/ClickHouse/pull/9407) ([achimbab](https://github.com/achimbab))
- Исправлено поведение функций `match` и `extract`, когда haystack содержит нулевые байты. Поведение было неверным, когда haystack был константой. Это исправляет [#9160](https://github.com/ClickHouse/ClickHouse/issues/9160) [#9163](https://github.com/ClickHouse/ClickHouse/pull/9163) ([alexey-milovidov](https://github.com/alexey-milovidov)) [#9345](https://github.com/ClickHouse/ClickHouse/pull/9345) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### Улучшение сборки/тестирования/упаковки {#buildtestingpackaging-improvement-24}

- Обработка исключений теперь работает корректно в подсистеме Windows для Linux. См. https://github.com/ClickHouse-Extras/libunwind/pull/3 Это исправляет [#6480](https://github.com/ClickHouse/ClickHouse/issues/6480) [#9564](https://github.com/ClickHouse/ClickHouse/pull/9564) ([sobolevsv](https://github.com/sobolevsv))

### Релиз ClickHouse v20.1.6.30, 2020-03-05 {#clickhouse-release-v201630-2020-03-05}

#### Исправление ошибок {#bug-fix-59}


* Исправлена несовместимость данных при сжатии кодеком `T64`.
  [#9039](https://github.com/ClickHouse/ClickHouse/pull/9039) [(abyss7)](https://github.com/abyss7)
* Исправлен порядок диапазонов при чтении из таблицы MergeTree в одном потоке. Исправляет проблему [#8964](https://github.com/ClickHouse/ClickHouse/issues/8964).
  [#9050](https://github.com/ClickHouse/ClickHouse/pull/9050) [(CurtizJ)](https://github.com/CurtizJ)
* Исправлен возможный сегфолт в `MergeTreeRangeReader` при выполнении `PREWHERE`. Исправляет [#9064](https://github.com/ClickHouse/ClickHouse/issues/9064).
  [#9106](https://github.com/ClickHouse/ClickHouse/pull/9106) [(CurtizJ)](https://github.com/CurtizJ)
* Исправлена функция `reinterpretAsFixedString`, теперь она возвращает `FixedString` вместо `String`.
  [#9052](https://github.com/ClickHouse/ClickHouse/pull/9052) [(oandrew)](https://github.com/oandrew)
* Исправлен `joinGet` с возвращаемыми типами, допускающими `NULL`. Исправляет [#8919](https://github.com/ClickHouse/ClickHouse/issues/8919)
  [#9014](https://github.com/ClickHouse/ClickHouse/pull/9014) [(amosbird)](https://github.com/amosbird)
* Исправлены fuzz-тест и некорректное поведение функций bitTestAll/bitTestAny.
  [#9143](https://github.com/ClickHouse/ClickHouse/pull/9143) [(alexey-milovidov)](https://github.com/alexey-milovidov)
* Исправлено поведение функций match и extract при нулевой длине строки haystack. Поведение было некорректным, когда haystack был константой. Исправляет [#9160](https://github.com/ClickHouse/ClickHouse/issues/9160)
  [#9163](https://github.com/ClickHouse/ClickHouse/pull/9163) [(alexey-milovidov)](https://github.com/alexey-milovidov)
* Исправлено выполнение инвертированных предикатов при использовании нестрого монотонного функционального индекса. Исправляет [#9034](https://github.com/ClickHouse/ClickHouse/issues/9034)
  [#9223](https://github.com/ClickHouse/ClickHouse/pull/9223) [(Akazz)](https://github.com/Akazz)
* Разрешает переписывать `CROSS` в `INNER JOIN`, если в секции `WHERE` используется оператор `[NOT] LIKE`. Исправляет [#9191](https://github.com/ClickHouse/ClickHouse/issues/9191)
  [#9229](https://github.com/ClickHouse/ClickHouse/pull/9229) [(4ertus2)](https://github.com/4ertus2)
* Разрешить использование первого столбца (столбцов) в таблице с движком Log в качестве алиаса.
  [#9231](https://github.com/ClickHouse/ClickHouse/pull/9231) [(abyss7)](https://github.com/abyss7)
* Разрешено объединение через запятую с выражением `IN()` внутри. Исправляет [#7314](https://github.com/ClickHouse/ClickHouse/issues/7314).
  [#9251](https://github.com/ClickHouse/ClickHouse/pull/9251) [(4ertus2)](https://github.com/4ertus2)
* Улучшена логика запросов `ALTER MODIFY/ADD`. Теперь нельзя выполнять `ADD` столбца без указания типа, `MODIFY` default expression не изменяет тип столбца, а `MODIFY` type не приводит к потере значения выражения по умолчанию. Исправляет [#8669](https://github.com/ClickHouse/ClickHouse/issues/8669).
  [#9227](https://github.com/ClickHouse/ClickHouse/pull/9227)  [(alesapin)](https://github.com/alesapin)
* Исправлена финализация мутаций: уже выполненная мутация могла иметь статус is&#95;done=0.
  [#9217](https://github.com/ClickHouse/ClickHouse/pull/9217) [(alesapin)](https://github.com/alesapin)
* Поддержка конвейера Processors для system.numbers и system.numbers&#95;mt. Также исправлена ошибка, из-за которой не соблюдался лимит `max_execution_time`.
  [#7796](https://github.com/ClickHouse/ClickHouse/pull/7796)  [(KochetovNicolai)](https://github.com/KochetovNicolai)
* Исправлен некорректный подсчёт метрики `DictCacheKeysRequestedFound`.
  [#9411](https://github.com/ClickHouse/ClickHouse/pull/9411) [(nikitamikhaylov)](https://github.com/nikitamikhaylov)
* Добавлена проверка политики хранения в `ATTACH PARTITION FROM`, `REPLACE PARTITION`, `MOVE TO TABLE`, отсутствие которой могло сделать данные части недоступными после перезапуска и помешать запуску ClickHouse.
  [#9383](https://github.com/ClickHouse/ClickHouse/pull/9383) [(excitoon)](https://github.com/excitoon)
* Исправлен отчёт UBSan в `MergeTreeIndexSet`. Это решает проблему [#9250](https://github.com/ClickHouse/ClickHouse/issues/9250)
  [#9365](https://github.com/ClickHouse/ClickHouse/pull/9365) [(alexey-milovidov)](https://github.com/alexey-milovidov)
* Исправлена возможная гонка потоков в BlockIO.
  [#9356](https://github.com/ClickHouse/ClickHouse/pull/9356) [(KochetovNicolai)](https://github.com/KochetovNicolai)
* Поддержка чисел типа `UInt64`, которые не укладываются в Int64, в функциях, работающих с JSON. Обновление `SIMDJSON` до состояния master. Это исправляет [#9209](https://github.com/ClickHouse/ClickHouse/issues/9209)
  [#9344](https://github.com/ClickHouse/ClickHouse/pull/9344) [(alexey-milovidov)](https://github.com/alexey-milovidov)
* Исправлена проблема, из-за которой объём свободного места рассчитывался некорректно, если каталог с данными был смонтирован на отдельное устройство. Для диска по умолчанию теперь объём свободного места вычисляется относительно подкаталога с данными. Это исправляет [#7441](https://github.com/ClickHouse/ClickHouse/issues/7441)
  [#9257](https://github.com/ClickHouse/ClickHouse/pull/9257) [(millb)](https://github.com/millb)
* Исправлена проблема, из-за которой TLS-подключения могли завершаться с сообщением `OpenSSL SSL_read: error:14094438:SSL routines:ssl3_read_bytes:tlsv1 alert internal error and SSL Exception: error:2400006E:random number generator::error retrieving entropy.` OpenSSL обновлён до актуальной версии из upstream master.
  [#8956](https://github.com/ClickHouse/ClickHouse/pull/8956) [(alexey-milovidov)](https://github.com/alexey-milovidov)
* При выполнении запроса `CREATE` сворачивать константные выражения в аргументах движка хранения. Заменять пустое имя базы данных на имя текущей базы. Исправляет [#6508](https://github.com/ClickHouse/ClickHouse/issues/6508), [#3492](https://github.com/ClickHouse/ClickHouse/issues/3492). Также исправлена проверка локального адреса в ClickHouseDictionarySource.
  [#9262](https://github.com/ClickHouse/ClickHouse/pull/9262) [(tabplubix)](https://github.com/tavplubix)
* Исправлена ошибка сегментации в `StorageMerge`, которая могла возникать при чтении из `StorageFile`.
  [#9387](https://github.com/ClickHouse/ClickHouse/pull/9387) [(tabplubix)](https://github.com/tavplubix)
* Предотвращена редкая потеря данных в `Kafka` в случаях, когда исключение происходит после чтения суффикса, но до фиксации (commit). Исправляет [#9378](https://github.com/ClickHouse/ClickHouse/issues/9378). Связано с: [#7175](https://github.com/ClickHouse/ClickHouse/issues/7175)
  [#9507](https://github.com/ClickHouse/ClickHouse/pull/9507) [(filimonov)](https://github.com/filimonov)
* Исправлена ошибка, приводившая к аварийному завершению работы сервера при попытке использовать или удалить таблицу `Kafka`, созданную с некорректными параметрами. Исправляет [#9494](https://github.com/ClickHouse/ClickHouse/issues/9494). Включает [#9507](https://github.com/ClickHouse/ClickHouse/issues/9507).
  [#9513](https://github.com/ClickHouse/ClickHouse/pull/9513) [(filimonov)](https://github.com/filimonov)

#### Новая функциональность {#new-feature-12}

- Добавлена опция `deduplicate_blocks_in_dependent_materialized_views` для управления поведением идемпотентных вставок в таблицы с материализованными представлениями. Эта новая функциональность была добавлена в релиз с исправлениями по специальному запросу от Altinity.
  [#9070](https://github.com/ClickHouse/ClickHouse/pull/9070) [(urykhy)](https://github.com/urykhy)

### Релиз ClickHouse v20.1.2.4, 2020-01-22 {#clickhouse-release-v20124-2020-01-22}

#### Обратно несовместимое изменение {#backward-incompatible-change-10}

- Настройка `merge_tree_uniform_read_distribution` объявлена устаревшей. Сервер по-прежнему распознает эту настройку, но она не оказывает никакого эффекта. [#8308](https://github.com/ClickHouse/ClickHouse/pull/8308) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Изменен тип возвращаемого значения функции `greatCircleDistance` на `Float32`, поскольку теперь результат вычисления имеет тип `Float32`. [#7993](https://github.com/ClickHouse/ClickHouse/pull/7993) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Теперь ожидается, что параметры запроса представлены в экранированном формате. Например, чтобы передать строку `a<tab>b`, необходимо написать `a\tb` или `a\<tab>b` и соответственно `a%5Ctb` или `a%5C%09b` в URL. Это необходимо для добавления возможности передавать NULL как `\N`. Это исправляет [#7488](https://github.com/ClickHouse/ClickHouse/issues/7488). [#8517](https://github.com/ClickHouse/ClickHouse/pull/8517) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Настройка `use_minimalistic_part_header_in_zookeeper` для `ReplicatedMergeTree` включена по умолчанию. Это значительно уменьшит объем данных, хранящихся в ZooKeeper. Эта настройка поддерживается начиная с версии 19.1, и мы уже используем ее в продакшене в нескольких сервисах без каких-либо проблем более полугода. Отключите эту настройку, если существует вероятность отката к версиям старше 19.1. [#6850](https://github.com/ClickHouse/ClickHouse/pull/6850) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Индексы пропуска данных готовы к использованию в продакшене и включены по умолчанию. Настройки `allow_experimental_data_skipping_indices`, `allow_experimental_cross_to_join_conversion` и `allow_experimental_multiple_joins_emulation` теперь устарели и не оказывают никакого эффекта. [#7974](https://github.com/ClickHouse/ClickHouse/pull/7974) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлена новая логика `ANY JOIN` для `StorageJoin`, согласованная с операцией `JOIN`. Для обновления без изменений в поведении необходимо добавить `SETTINGS any_join_distinct_right_table_keys = 1` в метаданные таблиц с движком Join или пересоздать эти таблицы после обновления. [#8400](https://github.com/ClickHouse/ClickHouse/pull/8400) ([Artem Zuikov](https://github.com/4ertus2))
- Требуется перезапуск сервера для применения изменений в конфигурации логирования. Это временное решение для предотвращения ошибки, при которой сервер записывает логи в удаленный файл логов (см. [#8696](https://github.com/ClickHouse/ClickHouse/issues/8696)). [#8707](https://github.com/ClickHouse/ClickHouse/pull/8707) ([Alexander Kuzmenkov](https://github.com/akuzm))


#### Новые возможности {#new-feature-13}

- Добавлена информация о путях к частям данных в таблицу `system.merges`. [#8043](https://github.com/ClickHouse/ClickHouse/pull/8043) ([Vladimir Chebotarev](https://github.com/excitoon))
- Добавлена возможность выполнения запроса `SYSTEM RELOAD DICTIONARY` в режиме `ON CLUSTER`. [#8288](https://github.com/ClickHouse/ClickHouse/pull/8288) ([Guillaume Tassery](https://github.com/YiuRULE))
- Добавлена возможность выполнения запросов `CREATE DICTIONARY` в режиме `ON CLUSTER`. [#8163](https://github.com/ClickHouse/ClickHouse/pull/8163) ([alesapin](https://github.com/alesapin))
- Теперь профиль пользователя в `users.xml` может наследовать несколько профилей. [#8343](https://github.com/ClickHouse/ClickHouse/pull/8343) ([Mikhail f. Shiryaev](https://github.com/Felixoid))
- Добавлена таблица `system.stack_trace`, которая позволяет просматривать трассировки стека всех потоков сервера. Это полезно для разработчиков при анализе состояния сервера. Исправляет [#7576](https://github.com/ClickHouse/ClickHouse/issues/7576). [#8344](https://github.com/ClickHouse/ClickHouse/pull/8344) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлен тип данных `DateTime64` с настраиваемой субсекундной точностью. [#7170](https://github.com/ClickHouse/ClickHouse/pull/7170) ([Vasily Nemkov](https://github.com/Enmk))
- Добавлена табличная функция `clusterAllReplicas`, которая позволяет выполнять запросы ко всем узлам кластера. [#8493](https://github.com/ClickHouse/ClickHouse/pull/8493) ([kiran sunkari](https://github.com/kiransunkari))
- Добавлена агрегатная функция `categoricalInformationValue`, которая вычисляет информационную ценность дискретного признака. [#8117](https://github.com/ClickHouse/ClickHouse/pull/8117) ([hcz](https://github.com/hczhcz))
- Ускорен парсинг файлов данных в форматах `CSV`, `TSV` и `JSONEachRow` за счёт параллельной обработки. [#7780](https://github.com/ClickHouse/ClickHouse/pull/7780) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Добавлена функция `bankerRound`, которая выполняет банковское округление. [#8112](https://github.com/ClickHouse/ClickHouse/pull/8112) ([hcz](https://github.com/hczhcz))
- Добавлена поддержка дополнительных языков во встроенном словаре для названий регионов: 'ru', 'en', 'ua', 'uk', 'by', 'kz', 'tr', 'de', 'uz', 'lv', 'lt', 'et', 'pt', 'he', 'vi'. [#8189](https://github.com/ClickHouse/ClickHouse/pull/8189) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Улучшена согласованность логики `ANY JOIN`. Теперь `t1 ANY LEFT JOIN t2` эквивалентно `t2 ANY RIGHT JOIN t1`. [#7665](https://github.com/ClickHouse/ClickHouse/pull/7665) ([Artem Zuikov](https://github.com/4ertus2))
- Добавлена настройка `any_join_distinct_right_table_keys`, которая включает прежнее поведение для `ANY INNER JOIN`. [#7665](https://github.com/ClickHouse/ClickHouse/pull/7665) ([Artem Zuikov](https://github.com/4ertus2))
- Добавлены новые типы соединений `SEMI` и `ANTI JOIN`. Прежнее поведение `ANY INNER JOIN` теперь доступно как `SEMI LEFT JOIN`. [#7665](https://github.com/ClickHouse/ClickHouse/pull/7665) ([Artem Zuikov](https://github.com/4ertus2))
- Добавлен формат `Distributed` для движка `File` и табличной функции `file`, который позволяет читать из `.bin` файлов, созданных асинхронными вставками в таблицу `Distributed`. [#8535](https://github.com/ClickHouse/ClickHouse/pull/8535) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Добавлен опциональный аргумент столбца сброса для `runningAccumulate`, который позволяет сбрасывать результаты агрегации для каждого нового значения ключа. [#8326](https://github.com/ClickHouse/ClickHouse/pull/8326) ([Sergey Kononenko](https://github.com/kononencheg))
- Добавлена возможность использовать ClickHouse в качестве конечной точки Prometheus. [#7900](https://github.com/ClickHouse/ClickHouse/pull/7900) ([vdimir](https://github.com/Vdimir))
- Добавлена секция `<remote_url_allow_hosts>` в `config.xml`, которая ограничивает разрешённые хосты для удалённых движков таблиц и табличных функций `URL`, `S3`, `HDFS`. [#7154](https://github.com/ClickHouse/ClickHouse/pull/7154) ([Mikhail Korotov](https://github.com/millb))
- Добавлена функция `greatCircleAngle`, которая вычисляет расстояние на сфере в градусах. [#8105](https://github.com/ClickHouse/ClickHouse/pull/8105) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Изменён радиус Земли для соответствия библиотеке H3. [#8105](https://github.com/ClickHouse/ClickHouse/pull/8105) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлены форматы `JSONCompactEachRow` и `JSONCompactEachRowWithNamesAndTypes` для ввода и вывода. [#7841](https://github.com/ClickHouse/ClickHouse/pull/7841) ([Mikhail Korotov](https://github.com/millb))
- Добавлена возможность для файловых движков таблиц и табличных функций (`File`, `S3`, `URL`, `HDFS`) читать и записывать файлы `gzip` на основе дополнительного параметра движка или расширения файла. [#7840](https://github.com/ClickHouse/ClickHouse/pull/7840) ([Andrey Bodrov](https://github.com/apbodrov))
- Добавлена функция `randomASCII(length)`, генерирующая строку со случайным набором печатаемых символов [ASCII](https://en.wikipedia.org/wiki/ASCII#Printable_characters). [#8401](https://github.com/ClickHouse/ClickHouse/pull/8401) ([BayoNet](https://github.com/BayoNet))
- Добавлена функция `JSONExtractArrayRaw`, которая возвращает массив необработанных элементов json-массива из строки `JSON`. [#8081](https://github.com/ClickHouse/ClickHouse/pull/8081) ([Oleg Matrokhin](https://github.com/errx))
- Добавлена функция `arrayZip`, которая позволяет объединять несколько массивов одинаковой длины в один массив кортежей. [#8149](https://github.com/ClickHouse/ClickHouse/pull/8149) ([Winter Zhang](https://github.com/zhang2014))
- Добавлена возможность перемещения данных между дисками в соответствии с настроенными `TTL`-выражениями для семейства движков таблиц `*MergeTree`. [#8140](https://github.com/ClickHouse/ClickHouse/pull/8140) ([Vladimir Chebotarev](https://github.com/excitoon))
- Добавлена новая агрегатная функция `avgWeighted`, которая позволяет вычислять взвешенное среднее. [#7898](https://github.com/ClickHouse/ClickHouse/pull/7898) ([Andrey Bodrov](https://github.com/apbodrov))
- Теперь параллельный парсинг включён по умолчанию для форматов `TSV`, `TSKV`, `CSV` и `JSONEachRow`. [#7894](https://github.com/ClickHouse/ClickHouse/pull/7894) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Добавлено несколько геофункций из библиотеки `H3`: `h3GetResolution`, `h3EdgeAngle`, `h3EdgeLength`, `h3IsValid` и `h3kRing`. [#8034](https://github.com/ClickHouse/ClickHouse/pull/8034) ([Konstantin Malanchev](https://github.com/hombit))
- Добавлена поддержка сжатия brotli (`br`) в файловых хранилищах и табличных функциях. Исправляет [#8156](https://github.com/ClickHouse/ClickHouse/issues/8156). [#8526](https://github.com/ClickHouse/ClickHouse/pull/8526) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлены функции `groupBit*` для типа `SimpleAggregationFunction`. [#8485](https://github.com/ClickHouse/ClickHouse/pull/8485) ([Guillaume Tassery](https://github.com/YiuRULE))





#### Исправление ошибок {#bug-fix-60}

- Fix rename of tables with `Distributed` engine. Fixes issue [#7868](https://github.com/ClickHouse/ClickHouse/issues/7868). [#8306](https://github.com/ClickHouse/ClickHouse/pull/8306) ([tavplubix](https://github.com/tavplubix))
- Now dictionaries support `EXPRESSION` for attributes in arbitrary string in non-ClickHouse SQL dialect. [#8098](https://github.com/ClickHouse/ClickHouse/pull/8098) ([alesapin](https://github.com/alesapin))
- Fix broken `INSERT SELECT FROM mysql(...)` query. This fixes [#8070](https://github.com/ClickHouse/ClickHouse/issues/8070) and [#7960](https://github.com/ClickHouse/ClickHouse/issues/7960). [#8234](https://github.com/ClickHouse/ClickHouse/pull/8234) ([tavplubix](https://github.com/tavplubix))
- Fix error "Mismatch column sizes" when inserting default `Tuple` from `JSONEachRow`. This fixes [#5653](https://github.com/ClickHouse/ClickHouse/issues/5653). [#8606](https://github.com/ClickHouse/ClickHouse/pull/8606) ([tavplubix](https://github.com/tavplubix))
- Now an exception will be thrown in case of using `WITH TIES` alongside `LIMIT BY`. Also add ability to use `TOP` with `LIMIT BY`. This fixes [#7472](https://github.com/ClickHouse/ClickHouse/issues/7472). [#7637](https://github.com/ClickHouse/ClickHouse/pull/7637) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Fix unintendent dependency from fresh glibc version in `clickhouse-odbc-bridge` binary. [#8046](https://github.com/ClickHouse/ClickHouse/pull/8046) ([Amos Bird](https://github.com/amosbird))
- Fix bug in check function of `*MergeTree` engines family. Now it does not fail in case when we have equal amount of rows in last granule and last mark (non-final). [#8047](https://github.com/ClickHouse/ClickHouse/pull/8047) ([alesapin](https://github.com/alesapin))
- Fix insert into `Enum*` columns after `ALTER` query, when underlying numeric type is equal to table specified type. This fixes [#7836](https://github.com/ClickHouse/ClickHouse/issues/7836). [#7908](https://github.com/ClickHouse/ClickHouse/pull/7908) ([Anton Popov](https://github.com/CurtizJ))
- Allowed non-constant negative "size" argument for function `substring`. It was not allowed by mistake. This fixes [#4832](https://github.com/ClickHouse/ClickHouse/issues/4832). [#7703](https://github.com/ClickHouse/ClickHouse/pull/7703) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix parsing bug when wrong number of arguments passed to `(O|J)DBC` table engine. [#7709](https://github.com/ClickHouse/ClickHouse/pull/7709) ([alesapin](https://github.com/alesapin))
- Using command name of the running clickhouse process when sending logs to syslog. In previous versions, empty string was used instead of command name. [#8460](https://github.com/ClickHouse/ClickHouse/pull/8460) ([Michael Nacharov](https://github.com/mnach))
- Fix check of allowed hosts for `localhost`. This PR fixes the solution provided in [#8241](https://github.com/ClickHouse/ClickHouse/pull/8241). [#8342](https://github.com/ClickHouse/ClickHouse/pull/8342) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix rare crash in `argMin` and `argMax` functions for long string arguments, when result is used in `runningAccumulate` function. This fixes [#8325](https://github.com/ClickHouse/ClickHouse/issues/8325) [#8341](https://github.com/ClickHouse/ClickHouse/pull/8341) ([dinosaur](https://github.com/769344359))
- Fix memory overcommit for tables with `Buffer` engine. [#8345](https://github.com/ClickHouse/ClickHouse/pull/8345) ([Azat Khuzhin](https://github.com/azat))
- Fixed potential bug in functions that can take `NULL` as one of the arguments and return non-NULL. [#8196](https://github.com/ClickHouse/ClickHouse/pull/8196) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Better metrics calculations in thread pool for background processes for `MergeTree` table engines. [#8194](https://github.com/ClickHouse/ClickHouse/pull/8194) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix function `IN` inside `WHERE` statement when row-level table filter is present. Fixes [#6687](https://github.com/ClickHouse/ClickHouse/issues/6687) [#8357](https://github.com/ClickHouse/ClickHouse/pull/8357) ([Ivan](https://github.com/abyss7))
- Now an exception is thrown if the integral value is not parsed completely for settings values. [#7678](https://github.com/ClickHouse/ClickHouse/pull/7678) ([Mikhail Korotov](https://github.com/millb))
- Fix exception when aggregate function is used in query to distributed table with more than two local shards. [#8164](https://github.com/ClickHouse/ClickHouse/pull/8164) ([小路](https://github.com/nicelulu))
- Now bloom filter can handle zero length arrays and does not perform redundant calculations. [#8242](https://github.com/ClickHouse/ClickHouse/pull/8242) ([achimbab](https://github.com/achimbab))
- Fixed checking if a client host is allowed by matching the client host to `host_regexp` specified in `users.xml`. [#8241](https://github.com/ClickHouse/ClickHouse/pull/8241) ([Vitaly Baranov](https://github.com/vitlibar))
- Relax ambiguous column check that leads to false positives in multiple `JOIN ON` section. [#8385](https://github.com/ClickHouse/ClickHouse/pull/8385) ([Artem Zuikov](https://github.com/4ertus2))
- Fixed possible server crash (`std::terminate`) when the server cannot send or write data in `JSON` or `XML` format with values of `String` data type (that require `UTF-8` validation) or when compressing result data with Brotli algorithm or in some other rare cases. This fixes [#7603](https://github.com/ClickHouse/ClickHouse/issues/7603) [#8384](https://github.com/ClickHouse/ClickHouse/pull/8384) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix race condition in `StorageDistributedDirectoryMonitor` found by CI. This fixes [#8364](https://github.com/ClickHouse/ClickHouse/issues/8364). [#8383](https://github.com/ClickHouse/ClickHouse/pull/8383) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Now background merges in `*MergeTree` table engines family preserve storage policy volume order more accurately. [#8549](https://github.com/ClickHouse/ClickHouse/pull/8549) ([Vladimir Chebotarev](https://github.com/excitoon))
- Now table engine `Kafka` works properly with `Native` format. This fixes [#6731](https://github.com/ClickHouse/ClickHouse/issues/6731) [#7337](https://github.com/ClickHouse/ClickHouse/issues/7337) [#8003](https://github.com/ClickHouse/ClickHouse/issues/8003). [#8016](https://github.com/ClickHouse/ClickHouse/pull/8016) ([filimonov](https://github.com/filimonov))
- Fixed formats with headers (like `CSVWithNames`) which were throwing exception about EOF for table engine `Kafka`. [#8016](https://github.com/ClickHouse/ClickHouse/pull/8016) ([filimonov](https://github.com/filimonov))
- Fixed a bug with making set from subquery in right part of `IN` section. This fixes [#5767](https://github.com/ClickHouse/ClickHouse/issues/5767) and [#2542](https://github.com/ClickHouse/ClickHouse/issues/2542). [#7755](https://github.com/ClickHouse/ClickHouse/pull/7755) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Fix possible crash while reading from storage `File`. [#7756](https://github.com/ClickHouse/ClickHouse/pull/7756) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed reading of the files in `Parquet` format containing columns of type `list`. [#8334](https://github.com/ClickHouse/ClickHouse/pull/8334) ([maxulan](https://github.com/maxulan))
- Fix error `Not found column` for distributed queries with `PREWHERE` condition dependent on sampling key if `max_parallel_replicas > 1`. [#7913](https://github.com/ClickHouse/ClickHouse/pull/7913) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix error `Not found column` if query used `PREWHERE` dependent on table's alias and the result set was empty because of primary key condition. [#7911](https://github.com/ClickHouse/ClickHouse/pull/7911) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed return type for functions `rand` and `randConstant` in case of `Nullable` argument. Now functions always return `UInt32` and never `Nullable(UInt32)`. [#8204](https://github.com/ClickHouse/ClickHouse/pull/8204) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Disabled predicate push-down for `WITH FILL` expression. This fixes [#7784](https://github.com/ClickHouse/ClickHouse/issues/7784). [#7789](https://github.com/ClickHouse/ClickHouse/pull/7789) ([Winter Zhang](https://github.com/zhang2014))
- Fixed incorrect `count()` result for `SummingMergeTree` when `FINAL` section is used. [#3280](https://github.com/ClickHouse/ClickHouse/issues/3280) [#7786](https://github.com/ClickHouse/ClickHouse/pull/7786) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Fix possible incorrect result for constant functions from remote servers. It happened for queries with functions like `version()`, `uptime()`, etc. which returns different constant values for different servers. This fixes [#7666](https://github.com/ClickHouse/ClickHouse/issues/7666). [#7689](https://github.com/ClickHouse/ClickHouse/pull/7689) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix complicated bug in push-down predicate optimization which leads to wrong results. This fixes a lot of issues on push-down predicate optimization. [#8503](https://github.com/ClickHouse/ClickHouse/pull/8503) ([Winter Zhang](https://github.com/zhang2014))
- Fix crash in `CREATE TABLE .. AS dictionary` query. [#8508](https://github.com/ClickHouse/ClickHouse/pull/8508) ([Azat Khuzhin](https://github.com/azat))
- Several improvements ClickHouse grammar in `.g4` file. [#8294](https://github.com/ClickHouse/ClickHouse/pull/8294) ([taiyang-li](https://github.com/taiyang-li))
- Fix bug that leads to crashes in `JOIN`s with tables with engine `Join`. This fixes [#7556](https://github.com/ClickHouse/ClickHouse/issues/7556) [#8254](https://github.com/ClickHouse/ClickHouse/issues/8254) [#7915](https://github.com/ClickHouse/ClickHouse/issues/7915) [#8100](https://github.com/ClickHouse/ClickHouse/issues/8100). [#8298](https://github.com/ClickHouse/ClickHouse/pull/8298) ([Artem Zuikov](https://github.com/4ertus2))
- Fix redundant dictionaries reload on `CREATE DATABASE`. [#7916](https://github.com/ClickHouse/ClickHouse/pull/7916) ([Azat Khuzhin](https://github.com/azat))
- Limit maximum number of streams for read from `StorageFile` and `StorageHDFS`. Fixes [#7650](https://github.com/ClickHouse/ClickHouse/issues/7650). [#7981](https://github.com/ClickHouse/ClickHouse/pull/7981) ([alesapin](https://github.com/alesapin))
- Fix bug in `ALTER ... MODIFY ... CODEC` query, when user specify both default expression and codec. Fixes [8593](https://github.com/ClickHouse/ClickHouse/issues/8593). [#8614](https://github.com/ClickHouse/ClickHouse/pull/8614) ([alesapin](https://github.com/alesapin))
- Fix error in background merge of columns with `SimpleAggregateFunction(LowCardinality)` type. [#8613](https://github.com/ClickHouse/ClickHouse/pull/8613) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed type check in function `toDateTime64`. [#8375](https://github.com/ClickHouse/ClickHouse/pull/8375) ([Vasily Nemkov](https://github.com/Enmk))
- Now server do not crash on `LEFT` or `FULL JOIN` with and Join engine and unsupported `join_use_nulls` settings. [#8479](https://github.com/ClickHouse/ClickHouse/pull/8479) ([Artem Zuikov](https://github.com/4ertus2))
- Now `DROP DICTIONARY IF EXISTS db.dict` query does not throw exception if `db` does not exist. [#8185](https://github.com/ClickHouse/ClickHouse/pull/8185) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix possible crashes in table functions (`file`, `mysql`, `remote`) caused by usage of reference to removed `IStorage` object. Fix incorrect parsing of columns specified at insertion into table function. [#7762](https://github.com/ClickHouse/ClickHouse/pull/7762) ([tavplubix](https://github.com/tavplubix))
- Ensure network be up before starting `clickhouse-server`. This fixes [#7507](https://github.com/ClickHouse/ClickHouse/issues/7507). [#8570](https://github.com/ClickHouse/ClickHouse/pull/8570) ([Zhichang Yu](https://github.com/yuzhichang))
- Fix timeouts handling for secure connections, so queries does not hang indefenitely. This fixes [#8126](https://github.com/ClickHouse/ClickHouse/issues/8126). [#8128](https://github.com/ClickHouse/ClickHouse/pull/8128) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix `clickhouse-copier`'s redundant contention between concurrent workers. [#7816](https://github.com/ClickHouse/ClickHouse/pull/7816) ([Ding Xiang Fei](https://github.com/dingxiangfei2009))
- Now mutations does not skip attached parts, even if their mutation version were larger than current mutation version. [#7812](https://github.com/ClickHouse/ClickHouse/pull/7812) ([Zhichang Yu](https://github.com/yuzhichang)) [#8250](https://github.com/ClickHouse/ClickHouse/pull/8250) ([alesapin](https://github.com/alesapin))
- Ignore redundant copies of `*MergeTree` data parts after move to another disk and server restart. [#7810](https://github.com/ClickHouse/ClickHouse/pull/7810) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix crash in `FULL JOIN` with `LowCardinality` in `JOIN` key. [#8252](https://github.com/ClickHouse/ClickHouse/pull/8252) ([Artem Zuikov](https://github.com/4ertus2))
- Forbidden to use column name more than once in insert query like `INSERT INTO tbl (x, y, x)`. This fixes [#5465](https://github.com/ClickHouse/ClickHouse/issues/5465), [#7681](https://github.com/ClickHouse/ClickHouse/issues/7681). [#7685](https://github.com/ClickHouse/ClickHouse/pull/7685) ([alesapin](https://github.com/alesapin))
- Added fallback for detection the number of physical CPU cores for unknown CPUs (using the number of logical CPU cores). This fixes [#5239](https://github.com/ClickHouse/ClickHouse/issues/5239). [#7726](https://github.com/ClickHouse/ClickHouse/pull/7726) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix `There's no column` error for materialized and alias columns. [#8210](https://github.com/ClickHouse/ClickHouse/pull/8210) ([Artem Zuikov](https://github.com/4ertus2))
- Fixed sever crash when `EXISTS` query was used without `TABLE` or `DICTIONARY` qualifier. Just like `EXISTS t`. This fixes [#8172](https://github.com/ClickHouse/ClickHouse/issues/8172). This bug was introduced in version 19.17. [#8213](https://github.com/ClickHouse/ClickHouse/pull/8213) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix rare bug with error `"Sizes of columns does not match"` that might appear when using `SimpleAggregateFunction` column. [#7790](https://github.com/ClickHouse/ClickHouse/pull/7790) ([Boris Granveaud](https://github.com/bgranvea))
- Fix bug where user with empty `allow_databases` got access to all databases (and same for `allow_dictionaries`). [#7793](https://github.com/ClickHouse/ClickHouse/pull/7793) ([DeifyTheGod](https://github.com/DeifyTheGod))
- Fix client crash when server already disconnected from client. [#8071](https://github.com/ClickHouse/ClickHouse/pull/8071) ([Azat Khuzhin](https://github.com/azat))
- Fix `ORDER BY` behaviour in case of sorting by primary key prefix and non primary key suffix. [#7759](https://github.com/ClickHouse/ClickHouse/pull/7759) ([Anton Popov](https://github.com/CurtizJ))
- Check if qualified column present in the table. This fixes [#6836](https://github.com/ClickHouse/ClickHouse/issues/6836). [#7758](https://github.com/ClickHouse/ClickHouse/pull/7758) ([Artem Zuikov](https://github.com/4ertus2))
- Fixed behavior with `ALTER MOVE` ran immediately after merge finish moves superpart of specified. Fixes [#8103](https://github.com/ClickHouse/ClickHouse/issues/8103). [#8104](https://github.com/ClickHouse/ClickHouse/pull/8104) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix possible server crash while using `UNION` with different number of columns. Fixes [#7279](https://github.com/ClickHouse/ClickHouse/issues/7279). [#7929](https://github.com/ClickHouse/ClickHouse/pull/7929) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix size of result substring for function `substr` with negative size. [#8589](https://github.com/ClickHouse/ClickHouse/pull/8589) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Now server does not execute part mutation in `MergeTree` if there are not enough free threads in background pool. [#8588](https://github.com/ClickHouse/ClickHouse/pull/8588) ([tavplubix](https://github.com/tavplubix))
- Fix a minor typo on formatting `UNION ALL` AST. [#7999](https://github.com/ClickHouse/ClickHouse/pull/7999) ([litao91](https://github.com/litao91))
- Fixed incorrect bloom filter results for negative numbers. This fixes [#8317](https://github.com/ClickHouse/ClickHouse/issues/8317). [#8566](https://github.com/ClickHouse/ClickHouse/pull/8566) ([Winter Zhang](https://github.com/zhang2014))
- Fixed potential buffer overflow in decompress. Malicious user can pass fabricated compressed data that will cause read after buffer. This issue was found by Eldar Zaitov from Yandex information security team. [#8404](https://github.com/ClickHouse/ClickHouse/pull/8404) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix incorrect result because of integers overflow in `arrayIntersect`. [#7777](https://github.com/ClickHouse/ClickHouse/pull/7777) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Now `OPTIMIZE TABLE` query will not wait for offline replicas to perform the operation. [#8314](https://github.com/ClickHouse/ClickHouse/pull/8314) ([javi santana](https://github.com/javisantana))
- Fixed `ALTER TTL` parser for `Replicated*MergeTree` tables. [#8318](https://github.com/ClickHouse/ClickHouse/pull/8318) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix communication between server and client, so server read temporary tables info after query failure. [#8084](https://github.com/ClickHouse/ClickHouse/pull/8084) ([Azat Khuzhin](https://github.com/azat))
- Fix `bitmapAnd` function error when intersecting an aggregated bitmap and a scalar bitmap. [#8082](https://github.com/ClickHouse/ClickHouse/pull/8082) ([Yue Huang](https://github.com/moon03432))
- Refine the definition of `ZXid` according to the ZooKeeper Programmer's Guide which fixes bug in `clickhouse-cluster-copier`. [#8088](https://github.com/ClickHouse/ClickHouse/pull/8088) ([Ding Xiang Fei](https://github.com/dingxiangfei2009))
- `odbc` table function now respects `external_table_functions_use_nulls` setting. [#7506](https://github.com/ClickHouse/ClickHouse/pull/7506) ([Vasily Nemkov](https://github.com/Enmk))
- Fixed bug that lead to a rare data race. [#8143](https://github.com/ClickHouse/ClickHouse/pull/8143) ([Alexander Kazakov](https://github.com/Akazz))
- Now `SYSTEM RELOAD DICTIONARY` reloads a dictionary completely, ignoring `update_field`. This fixes [#7440](https://github.com/ClickHouse/ClickHouse/issues/7440). [#8037](https://github.com/ClickHouse/ClickHouse/pull/8037) ([Vitaly Baranov](https://github.com/vitlibar))
- Add ability to check if dictionary exists in create query. [#8032](https://github.com/ClickHouse/ClickHouse/pull/8032) ([alesapin](https://github.com/alesapin))
- Fix `Float*` parsing in `Values` format. This fixes [#7817](https://github.com/ClickHouse/ClickHouse/issues/7817). [#7870](https://github.com/ClickHouse/ClickHouse/pull/7870) ([tavplubix](https://github.com/tavplubix))
- Fix crash when we cannot reserve space in some background operations of `*MergeTree` table engines family. [#7873](https://github.com/ClickHouse/ClickHouse/pull/7873) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix crash of merge operation when table contains `SimpleAggregateFunction(LowCardinality)` column. This fixes [#8515](https://github.com/ClickHouse/ClickHouse/issues/8515). [#8522](https://github.com/ClickHouse/ClickHouse/pull/8522) ([Azat Khuzhin](https://github.com/azat))
- Restore support of all ICU locales and add the ability to apply collations for constant expressions. Also add language name to `system.collations` table. [#8051](https://github.com/ClickHouse/ClickHouse/pull/8051) ([alesapin](https://github.com/alesapin))
- Fix bug when external dictionaries with zero minimal lifetime (`LIFETIME(MIN 0 MAX N)`, `LIFETIME(N)`) don't update in background. [#7983](https://github.com/ClickHouse/ClickHouse/pull/7983) ([alesapin](https://github.com/alesapin))
- Fix crash when external dictionary with ClickHouse source has subquery in query. [#8351](https://github.com/ClickHouse/ClickHouse/pull/8351) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix incorrect parsing of file extension in table with engine `URL`. This fixes [#8157](https://github.com/ClickHouse/ClickHouse/issues/8157). [#8419](https://github.com/ClickHouse/ClickHouse/pull/8419) ([Andrey Bodrov](https://github.com/apbodrov))
- Fix `CHECK TABLE` query for `*MergeTree` tables without key. Fixes [#7543](https://github.com/ClickHouse/ClickHouse/issues/7543). [#7979](https://github.com/ClickHouse/ClickHouse/pull/7979) ([alesapin](https://github.com/alesapin))
- Fixed conversion of `Float64` to MySQL type. [#8079](https://github.com/ClickHouse/ClickHouse/pull/8079) ([Yuriy Baranov](https://github.com/yurriy))
- Now if table was not completely dropped because of server crash, server will try to restore and load it. [#8176](https://github.com/ClickHouse/ClickHouse/pull/8176) ([tavplubix](https://github.com/tavplubix))
- Fixed crash in table function `file` while inserting into file that does not exist. Now in this case file would be created and then insert would be processed. [#8177](https://github.com/ClickHouse/ClickHouse/pull/8177) ([Olga Khvostikova](https://github.com/stavrolia))
- Fix rare deadlock which can happen when `trace_log` is in enabled. [#7838](https://github.com/ClickHouse/ClickHouse/pull/7838) ([filimonov](https://github.com/filimonov))
- Add ability to work with different types besides `Date` in `RangeHashed` external dictionary created from DDL query. Fixes [7899](https://github.com/ClickHouse/ClickHouse/issues/7899). [#8275](https://github.com/ClickHouse/ClickHouse/pull/8275) ([alesapin](https://github.com/alesapin))
- Fixes crash when `now64()` is called with result of another function. [#8270](https://github.com/ClickHouse/ClickHouse/pull/8270) ([Vasily Nemkov](https://github.com/Enmk))
- Fixed bug with detecting client IP for connections through mysql wire protocol. [#7743](https://github.com/ClickHouse/ClickHouse/pull/7743) ([Dmitry Muzyka](https://github.com/dmitriy-myz))
- Fix empty array handling in `arraySplit` function. This fixes [#7708](https://github.com/ClickHouse/ClickHouse/issues/7708). [#7747](https://github.com/ClickHouse/ClickHouse/pull/7747) ([hcz](https://github.com/hczhcz))
- Fixed the issue when `pid-file` of another running `clickhouse-server` may be deleted. [#8487](https://github.com/ClickHouse/ClickHouse/pull/8487) ([Weiqing Xu](https://github.com/weiqxu))
- Fix dictionary reload if it has `invalidate_query`, which stopped updates and some exception on previous update tries. [#8029](https://github.com/ClickHouse/ClickHouse/pull/8029) ([alesapin](https://github.com/alesapin))
- Fixed error in function `arrayReduce` that may lead to "double free" and error in aggregate function combinator `Resample` that may lead to memory leak. Added aggregate function `aggThrow`. This function can be used for testing purposes. [#8446](https://github.com/ClickHouse/ClickHouse/pull/8446) ([alexey-milovidov](https://github.com/alexey-milovidov))





#### Улучшения {#improvement-22}

- Improved logging when working with `S3` table engine. [#8251](https://github.com/ClickHouse/ClickHouse/pull/8251) ([Grigory Pervakov](https://github.com/GrigoryPervakov))
- Printed help message when no arguments are passed when calling `clickhouse-local`. This fixes [#5335](https://github.com/ClickHouse/ClickHouse/issues/5335). [#8230](https://github.com/ClickHouse/ClickHouse/pull/8230) ([Andrey Nagorny](https://github.com/Melancholic))
- Add setting `mutations_sync` which allows to wait `ALTER UPDATE/DELETE` queries synchronously. [#8237](https://github.com/ClickHouse/ClickHouse/pull/8237) ([alesapin](https://github.com/alesapin))
- Allow to set up relative `user_files_path` in `config.xml` (in the way similar to `format_schema_path`). [#7632](https://github.com/ClickHouse/ClickHouse/pull/7632) ([hcz](https://github.com/hczhcz))
- Add exception for illegal types for conversion functions with `-OrZero` postfix. [#7880](https://github.com/ClickHouse/ClickHouse/pull/7880) ([Andrey Konyaev](https://github.com/akonyaev90))
- Simplify format of the header of data sending to a shard in a distributed query. [#8044](https://github.com/ClickHouse/ClickHouse/pull/8044) ([Vitaly Baranov](https://github.com/vitlibar))
- `Live View` table engine refactoring. [#8519](https://github.com/ClickHouse/ClickHouse/pull/8519) ([vzakaznikov](https://github.com/vzakaznikov))
- Add additional checks for external dictionaries created from DDL-queries. [#8127](https://github.com/ClickHouse/ClickHouse/pull/8127) ([alesapin](https://github.com/alesapin))
- Fix error `Column ... already exists` while using `FINAL` and `SAMPLE` together, e.g. `select count() from table final sample 1/2`. Fixes [#5186](https://github.com/ClickHouse/ClickHouse/issues/5186). [#7907](https://github.com/ClickHouse/ClickHouse/pull/7907) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Now table the first argument of `joinGet` function can be table identifier. [#7707](https://github.com/ClickHouse/ClickHouse/pull/7707) ([Amos Bird](https://github.com/amosbird))
- Allow using `MaterializedView` with subqueries above `Kafka` tables. [#8197](https://github.com/ClickHouse/ClickHouse/pull/8197) ([filimonov](https://github.com/filimonov))
- Now background moves between disks run it the seprate thread pool. [#7670](https://github.com/ClickHouse/ClickHouse/pull/7670) ([Vladimir Chebotarev](https://github.com/excitoon))
- `SYSTEM RELOAD DICTIONARY` now executes synchronously. [#8240](https://github.com/ClickHouse/ClickHouse/pull/8240) ([Vitaly Baranov](https://github.com/vitlibar))
- Stack traces now display physical addresses (offsets in object file) instead of virtual memory addresses (where the object file was loaded). That allows the use of `addr2line` when binary is position independent and ASLR is active. This fixes [#8360](https://github.com/ClickHouse/ClickHouse/issues/8360). [#8387](https://github.com/ClickHouse/ClickHouse/pull/8387) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Support new syntax for row-level security filters: `<table name='table_name'>...</table>`. Fixes [#5779](https://github.com/ClickHouse/ClickHouse/issues/5779). [#8381](https://github.com/ClickHouse/ClickHouse/pull/8381) ([Ivan](https://github.com/abyss7))
- Now `cityHash` function can work with `Decimal` and `UUID` types. Fixes [#5184](https://github.com/ClickHouse/ClickHouse/issues/5184). [#7693](https://github.com/ClickHouse/ClickHouse/pull/7693) ([Mikhail Korotov](https://github.com/millb))
- Removed fixed index granularity (it was 1024) from system logs because it's obsolete after implementation of adaptive granularity. [#7698](https://github.com/ClickHouse/ClickHouse/pull/7698) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Enabled MySQL compatibility server when ClickHouse is compiled without SSL. [#7852](https://github.com/ClickHouse/ClickHouse/pull/7852) ([Yuriy Baranov](https://github.com/yurriy))
- Now server checksums distributed batches, which gives more verbose errors in case of corrupted data in batch. [#7914](https://github.com/ClickHouse/ClickHouse/pull/7914) ([Azat Khuzhin](https://github.com/azat))
- Support `DROP DATABASE`, `DETACH TABLE`, `DROP TABLE` and `ATTACH TABLE` for `MySQL` database engine. [#8202](https://github.com/ClickHouse/ClickHouse/pull/8202) ([Winter Zhang](https://github.com/zhang2014))
- Add authentication in S3 table function and table engine. [#7623](https://github.com/ClickHouse/ClickHouse/pull/7623) ([Vladimir Chebotarev](https://github.com/excitoon))
- Added check for extra parts of `MergeTree` at different disks, in order to not allow to miss data parts at undefined disks. [#8118](https://github.com/ClickHouse/ClickHouse/pull/8118) ([Vladimir Chebotarev](https://github.com/excitoon))
- Enable SSL support for Mac client and server. [#8297](https://github.com/ClickHouse/ClickHouse/pull/8297) ([Ivan](https://github.com/abyss7))
- Now ClickHouse can work as MySQL federated server (see https://dev.mysql.com/doc/refman/5.7/en/federated-create-server.html). [#7717](https://github.com/ClickHouse/ClickHouse/pull/7717) ([Maxim Fedotov](https://github.com/MaxFedotov))
- `clickhouse-client` now only enable `bracketed-paste` when multiquery is on and multiline is off. This fixes [#7757](https://github.com/ClickHouse/ClickHouse/issues/7757). [#7761](https://github.com/ClickHouse/ClickHouse/pull/7761) ([Amos Bird](https://github.com/amosbird))
- Support `Array(Decimal)` in `if` function. [#7721](https://github.com/ClickHouse/ClickHouse/pull/7721) ([Artem Zuikov](https://github.com/4ertus2))
- Support Decimals in `arrayDifference`, `arrayCumSum` and `arrayCumSumNegative` functions. [#7724](https://github.com/ClickHouse/ClickHouse/pull/7724) ([Artem Zuikov](https://github.com/4ertus2))
- Added `lifetime` column to `system.dictionaries` table. [#6820](https://github.com/ClickHouse/ClickHouse/issues/6820) [#7727](https://github.com/ClickHouse/ClickHouse/pull/7727) ([kekekekule](https://github.com/kekekekule))
- Improved check for existing parts on different disks for `*MergeTree` table engines. Addresses [#7660](https://github.com/ClickHouse/ClickHouse/issues/7660). [#8440](https://github.com/ClickHouse/ClickHouse/pull/8440) ([Vladimir Chebotarev](https://github.com/excitoon))
- Integration with `AWS SDK` for `S3` interactions which allows to use all S3 features out of the box. [#8011](https://github.com/ClickHouse/ClickHouse/pull/8011) ([Pavel Kovalenko](https://github.com/Jokser))
- Added support for subqueries in `Live View` tables. [#7792](https://github.com/ClickHouse/ClickHouse/pull/7792) ([vzakaznikov](https://github.com/vzakaznikov))
- Check for using `Date` or `DateTime` column from `TTL` expressions was removed. [#7920](https://github.com/ClickHouse/ClickHouse/pull/7920) ([Vladimir Chebotarev](https://github.com/excitoon))
- Information about disk was added to `system.detached_parts` table. [#7833](https://github.com/ClickHouse/ClickHouse/pull/7833) ([Vladimir Chebotarev](https://github.com/excitoon))
- Now settings `max_(table|partition)_size_to_drop` can be changed without a restart. [#7779](https://github.com/ClickHouse/ClickHouse/pull/7779) ([Grigory Pervakov](https://github.com/GrigoryPervakov))
- Slightly better usability of error messages. Ask user not to remove the lines below `Stack trace:`. [#7897](https://github.com/ClickHouse/ClickHouse/pull/7897) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Better reading messages from `Kafka` engine in various formats after [#7935](https://github.com/ClickHouse/ClickHouse/issues/7935). [#8035](https://github.com/ClickHouse/ClickHouse/pull/8035) ([Ivan](https://github.com/abyss7))
- Better compatibility with MySQL clients which don't support `sha2_password` auth plugin. [#8036](https://github.com/ClickHouse/ClickHouse/pull/8036) ([Yuriy Baranov](https://github.com/yurriy))
- Support more column types in MySQL compatibility server. [#7975](https://github.com/ClickHouse/ClickHouse/pull/7975) ([Yuriy Baranov](https://github.com/yurriy))
- Implement `ORDER BY` optimization for `Merge`, `Buffer` and `Materilized View` storages with underlying `MergeTree` tables. [#8130](https://github.com/ClickHouse/ClickHouse/pull/8130) ([Anton Popov](https://github.com/CurtizJ))
- Now we always use POSIX implementation of `getrandom` to have better compatibility with old kernels (< 3.17). [#7940](https://github.com/ClickHouse/ClickHouse/pull/7940) ([Amos Bird](https://github.com/amosbird))
- Better check for valid destination in a move TTL rule. [#8410](https://github.com/ClickHouse/ClickHouse/pull/8410) ([Vladimir Chebotarev](https://github.com/excitoon))
- Better checks for broken insert batches for `Distributed` table engine. [#7933](https://github.com/ClickHouse/ClickHouse/pull/7933) ([Azat Khuzhin](https://github.com/azat))
- Add column with array of parts name which mutations must process in future to `system.mutations` table. [#8179](https://github.com/ClickHouse/ClickHouse/pull/8179) ([alesapin](https://github.com/alesapin))
- Parallel merge sort optimization for processors. [#8552](https://github.com/ClickHouse/ClickHouse/pull/8552) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- The settings `mark_cache_min_lifetime` is now obsolete and does nothing. In previous versions, mark cache can grow in memory larger than `mark_cache_size` to accomodate data within `mark_cache_min_lifetime` seconds. That was leading to confusion and higher memory usage than expected, that is especially bad on memory constrained systems. If you will see performance degradation after installing this release, you should increase the `mark_cache_size`. [#8484](https://github.com/ClickHouse/ClickHouse/pull/8484) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Preparation to use `tid` everywhere. This is needed for [#7477](https://github.com/ClickHouse/ClickHouse/issues/7477). [#8276](https://github.com/ClickHouse/ClickHouse/pull/8276) ([alexey-milovidov](https://github.com/alexey-milovidov))





#### Улучшение производительности {#performance-improvement-17}

- Оптимизация производительности конвейера процессоров. [#7988](https://github.com/ClickHouse/ClickHouse/pull/7988) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Неблокирующее обновление устаревших ключей в кэш-словарях (с возможностью чтения старых значений). [#8303](https://github.com/ClickHouse/ClickHouse/pull/8303) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Компиляция ClickHouse без глобального флага `-fno-omit-frame-pointer` для освобождения дополнительного регистра. [#8097](https://github.com/ClickHouse/ClickHouse/pull/8097) ([Amos Bird](https://github.com/amosbird))
- Ускорение функции `greatCircleDistance` и добавление тестов производительности. [#7307](https://github.com/ClickHouse/ClickHouse/pull/7307) ([Olga Khvostikova](https://github.com/stavrolia))
- Улучшена производительность функции `roundDown`. [#8465](https://github.com/ClickHouse/ClickHouse/pull/8465) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Улучшена производительность функций `max`, `min`, `argMin`, `argMax` для типа данных `DateTime64`. [#8199](https://github.com/ClickHouse/ClickHouse/pull/8199) ([Vasily Nemkov](https://github.com/Enmk))
- Улучшена производительность сортировки без ограничения или с большим лимитом, а также внешней сортировки. [#8545](https://github.com/ClickHouse/ClickHouse/pull/8545) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Улучшена производительность форматирования чисел с плавающей точкой до 6 раз. [#8542](https://github.com/ClickHouse/ClickHouse/pull/8542) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Улучшена производительность функции `modulo`. [#7750](https://github.com/ClickHouse/ClickHouse/pull/7750) ([Amos Bird](https://github.com/amosbird))
- Оптимизированы `ORDER BY` и слияние с ключом из одного столбца. [#8335](https://github.com/ClickHouse/ClickHouse/pull/8335) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Улучшена реализация `arrayReduce`, комбинаторов `-Array` и `-State`. [#7710](https://github.com/ClickHouse/ClickHouse/pull/7710) ([Amos Bird](https://github.com/amosbird))
- Теперь `PREWHERE` оптимизирован так, чтобы быть как минимум столь же эффективным, как `WHERE`. [#7769](https://github.com/ClickHouse/ClickHouse/pull/7769) ([Amos Bird](https://github.com/amosbird))
- Улучшена обработка отрицательных чисел функциями `round` и `roundBankers`. [#8229](https://github.com/ClickHouse/ClickHouse/pull/8229) ([hcz](https://github.com/hczhcz))
- Улучшена производительность декодирования кодеков `DoubleDelta` и `Gorilla` примерно на 30-40%. Это исправляет [#7082](https://github.com/ClickHouse/ClickHouse/issues/7082). [#8019](https://github.com/ClickHouse/ClickHouse/pull/8019) ([Vasily Nemkov](https://github.com/Enmk))
- Улучшена производительность функций, связанных с `base64`. [#8444](https://github.com/ClickHouse/ClickHouse/pull/8444) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Добавлена функция `geoDistance`. Она похожа на `greatCircleDistance`, но использует аппроксимацию модели эллипсоида WGS-84. Производительность обеих функций примерно одинакова. [#8086](https://github.com/ClickHouse/ClickHouse/pull/8086) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Ускорены агрегатные функции `min` и `max` для типа данных `Decimal`. [#8144](https://github.com/ClickHouse/ClickHouse/pull/8144) ([Artem Zuikov](https://github.com/4ertus2))
- Векторизована обработка `arrayReduce`. [#7608](https://github.com/ClickHouse/ClickHouse/pull/7608) ([Amos Bird](https://github.com/amosbird))
- Цепочки `if` теперь оптимизируются как `multiIf`. [#8355](https://github.com/ClickHouse/ClickHouse/pull/8355) ([kamalov-ruslan](https://github.com/kamalov-ruslan))
- Исправлена регрессия производительности движка таблиц `Kafka`, появившаяся в версии 19.15. Это исправляет [#7261](https://github.com/ClickHouse/ClickHouse/issues/7261). [#7935](https://github.com/ClickHouse/ClickHouse/pull/7935) ([filimonov](https://github.com/filimonov))
- Удалена генерация кода «pie», которую `gcc` из пакетов Debian иногда включает по умолчанию. [#8483](https://github.com/ClickHouse/ClickHouse/pull/8483) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Параллельный парсинг форматов данных [#6553](https://github.com/ClickHouse/ClickHouse/pull/6553) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Включён по умолчанию оптимизированный парсер `Values` с выражениями (`input_format_values_deduce_templates_of_expressions=1`). [#8231](https://github.com/ClickHouse/ClickHouse/pull/8231) ([tavplubix](https://github.com/tavplubix))





#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-25}

- Build fixes for `ARM` and in minimal mode. [#8304](https://github.com/ClickHouse/ClickHouse/pull/8304) ([proller](https://github.com/proller))
- Add coverage file flush for `clickhouse-server` when std::atexit is not called. Also slightly improved logging in stateless tests with coverage. [#8267](https://github.com/ClickHouse/ClickHouse/pull/8267) ([alesapin](https://github.com/alesapin))
- Update LLVM library in contrib. Avoid using LLVM from OS packages. [#8258](https://github.com/ClickHouse/ClickHouse/pull/8258) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Make bundled `curl` build fully quiet. [#8232](https://github.com/ClickHouse/ClickHouse/pull/8232) [#8203](https://github.com/ClickHouse/ClickHouse/pull/8203) ([Pavel Kovalenko](https://github.com/Jokser))
- Fix some `MemorySanitizer` warnings. [#8235](https://github.com/ClickHouse/ClickHouse/pull/8235) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Use `add_warning` and `no_warning` macros in `CMakeLists.txt`. [#8604](https://github.com/ClickHouse/ClickHouse/pull/8604) ([Ivan](https://github.com/abyss7))
- Add support of Minio S3 Compatible object (https://min.io/) for better integration tests. [#7863](https://github.com/ClickHouse/ClickHouse/pull/7863) [#7875](https://github.com/ClickHouse/ClickHouse/pull/7875) ([Pavel Kovalenko](https://github.com/Jokser))
- Imported `libc` headers to contrib. It allows to make builds more consistent across various systems (only for `x86_64-linux-gnu`). [#5773](https://github.com/ClickHouse/ClickHouse/pull/5773) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Remove `-fPIC` from some libraries. [#8464](https://github.com/ClickHouse/ClickHouse/pull/8464) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Clean `CMakeLists.txt` for curl. See https://github.com/ClickHouse/ClickHouse/pull/8011#issuecomment-569478910 [#8459](https://github.com/ClickHouse/ClickHouse/pull/8459) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Silent warnings in `CapNProto` library. [#8220](https://github.com/ClickHouse/ClickHouse/pull/8220) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add performance tests for short string optimized hash tables. [#7679](https://github.com/ClickHouse/ClickHouse/pull/7679) ([Amos Bird](https://github.com/amosbird))
- Now ClickHouse will build on `AArch64` even if `MADV_FREE` is not available. This fixes [#8027](https://github.com/ClickHouse/ClickHouse/issues/8027). [#8243](https://github.com/ClickHouse/ClickHouse/pull/8243) ([Amos Bird](https://github.com/amosbird))
- Update `zlib-ng` to fix memory sanitizer problems. [#7182](https://github.com/ClickHouse/ClickHouse/pull/7182) [#8206](https://github.com/ClickHouse/ClickHouse/pull/8206) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Enable internal MySQL library on non-Linux system, because usage of OS packages is very fragile and usually does not work at all. This fixes [#5765](https://github.com/ClickHouse/ClickHouse/issues/5765). [#8426](https://github.com/ClickHouse/ClickHouse/pull/8426) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed build on some systems after enabling `libc++`. This supersedes [#8374](https://github.com/ClickHouse/ClickHouse/issues/8374). [#8380](https://github.com/ClickHouse/ClickHouse/pull/8380) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Make `Field` methods more type-safe to find more errors. [#7386](https://github.com/ClickHouse/ClickHouse/pull/7386) [#8209](https://github.com/ClickHouse/ClickHouse/pull/8209) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Added missing files to the `libc-headers` submodule. [#8507](https://github.com/ClickHouse/ClickHouse/pull/8507) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix wrong `JSON` quoting in performance test output. [#8497](https://github.com/ClickHouse/ClickHouse/pull/8497) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Now stack trace is displayed for `std::exception` and `Poco::Exception`. In previous versions it was available only for `DB::Exception`. This improves diagnostics. [#8501](https://github.com/ClickHouse/ClickHouse/pull/8501) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Porting `clock_gettime` and `clock_nanosleep` for fresh glibc versions. [#8054](https://github.com/ClickHouse/ClickHouse/pull/8054) ([Amos Bird](https://github.com/amosbird))
- Enable `part_log` in example config for developers. [#8609](https://github.com/ClickHouse/ClickHouse/pull/8609) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix async nature of reload in `01036_no_superfluous_dict_reload_on_create_database*`. [#8111](https://github.com/ClickHouse/ClickHouse/pull/8111) ([Azat Khuzhin](https://github.com/azat))
- Fixed codec performance tests. [#8615](https://github.com/ClickHouse/ClickHouse/pull/8615) ([Vasily Nemkov](https://github.com/Enmk))
- Add install scripts for `.tgz` build and documentation for them. [#8612](https://github.com/ClickHouse/ClickHouse/pull/8612) [#8591](https://github.com/ClickHouse/ClickHouse/pull/8591) ([alesapin](https://github.com/alesapin))
- Removed old `ZSTD` test (it was created in year 2016 to reproduce the bug that pre 1.0 version of ZSTD has had). This fixes [#8618](https://github.com/ClickHouse/ClickHouse/issues/8618). [#8619](https://github.com/ClickHouse/ClickHouse/pull/8619) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed build on Mac OS Catalina. [#8600](https://github.com/ClickHouse/ClickHouse/pull/8600) ([meo](https://github.com/meob))
- Increased number of rows in codec performance tests to make results noticeable. [#8574](https://github.com/ClickHouse/ClickHouse/pull/8574) ([Vasily Nemkov](https://github.com/Enmk))
- In debug builds, treat `LOGICAL_ERROR` exceptions as assertion failures, so that they are easier to notice. [#8475](https://github.com/ClickHouse/ClickHouse/pull/8475) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Make formats-related performance test more deterministic. [#8477](https://github.com/ClickHouse/ClickHouse/pull/8477) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update `lz4` to fix a MemorySanitizer failure. [#8181](https://github.com/ClickHouse/ClickHouse/pull/8181) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Suppress a known MemorySanitizer false positive in exception handling. [#8182](https://github.com/ClickHouse/ClickHouse/pull/8182) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Update `gcc` and `g++` to version 9 in `build/docker/build.sh` [#7766](https://github.com/ClickHouse/ClickHouse/pull/7766) ([TLightSky](https://github.com/tlightsky))
- Add performance test case to test that `PREWHERE` is worse than `WHERE`. [#7768](https://github.com/ClickHouse/ClickHouse/pull/7768) ([Amos Bird](https://github.com/amosbird))
- Progress towards fixing one flacky test. [#8621](https://github.com/ClickHouse/ClickHouse/pull/8621) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Avoid MemorySanitizer report for data from `libunwind`. [#8539](https://github.com/ClickHouse/ClickHouse/pull/8539) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Updated `libc++` to the latest version. [#8324](https://github.com/ClickHouse/ClickHouse/pull/8324) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Build ICU library from sources. This fixes [#6460](https://github.com/ClickHouse/ClickHouse/issues/6460). [#8219](https://github.com/ClickHouse/ClickHouse/pull/8219) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Switched from `libressl` to `openssl`. ClickHouse should support TLS 1.3 and SNI after this change. This fixes [#8171](https://github.com/ClickHouse/ClickHouse/issues/8171). [#8218](https://github.com/ClickHouse/ClickHouse/pull/8218) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed UBSan report when using `chacha20_poly1305` from SSL (happens on connect to https://yandex.ru/). [#8214](https://github.com/ClickHouse/ClickHouse/pull/8214) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix mode of default password file for `.deb` linux distros. [#8075](https://github.com/ClickHouse/ClickHouse/pull/8075) ([proller](https://github.com/proller))
- Improved expression for getting `clickhouse-server` PID in `clickhouse-test`. [#8063](https://github.com/ClickHouse/ClickHouse/pull/8063) ([Alexander Kazakov](https://github.com/Akazz))
- Updated contrib/googletest to v1.10.0. [#8587](https://github.com/ClickHouse/ClickHouse/pull/8587) ([Alexander Burmak](https://github.com/Alex-Burmak))
- Fixed ThreadSaninitizer report in `base64` library. Also updated this library to the latest version, but it does not matter. This fixes [#8397](https://github.com/ClickHouse/ClickHouse/issues/8397). [#8403](https://github.com/ClickHouse/ClickHouse/pull/8403) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix `00600_replace_running_query` for processors. [#8272](https://github.com/ClickHouse/ClickHouse/pull/8272) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Remove support for `tcmalloc` to make `CMakeLists.txt` simpler. [#8310](https://github.com/ClickHouse/ClickHouse/pull/8310) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Release gcc builds now use `libc++` instead of `libstdc++`. Recently `libc++` was used only with clang. This will improve consistency of build configurations and portability. [#8311](https://github.com/ClickHouse/ClickHouse/pull/8311) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Enable ICU library for build with MemorySanitizer. [#8222](https://github.com/ClickHouse/ClickHouse/pull/8222) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Suppress warnings from `CapNProto` library. [#8224](https://github.com/ClickHouse/ClickHouse/pull/8224) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Removed special cases of code for `tcmalloc`, because it's no longer supported. [#8225](https://github.com/ClickHouse/ClickHouse/pull/8225) ([alexey-milovidov](https://github.com/alexey-milovidov))
- In CI coverage task, kill the server gracefully to allow it to save the coverage report. This fixes incomplete coverage reports we've been seeing lately. [#8142](https://github.com/ClickHouse/ClickHouse/pull/8142) ([alesapin](https://github.com/alesapin))
- Performance tests for all codecs against `Float64` and `UInt64` values. [#8349](https://github.com/ClickHouse/ClickHouse/pull/8349) ([Vasily Nemkov](https://github.com/Enmk))
- `termcap` is very much deprecated and lead to various problems (f.g. missing "up" cap and echoing `^J` instead of multi line) . Favor `terminfo` or bundled `ncurses`. [#7737](https://github.com/ClickHouse/ClickHouse/pull/7737) ([Amos Bird](https://github.com/amosbird))
- Fix `test_storage_s3` integration test. [#7734](https://github.com/ClickHouse/ClickHouse/pull/7734) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Support `StorageFile(<format>, null) ` to insert block into given format file without actually write to disk. This is required for performance tests. [#8455](https://github.com/ClickHouse/ClickHouse/pull/8455) ([Amos Bird](https://github.com/amosbird))
- Added argument `--print-time` to functional tests which prints execution time per test. [#8001](https://github.com/ClickHouse/ClickHouse/pull/8001) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Added asserts to `KeyCondition` while evaluating RPN. This will fix warning from gcc-9. [#8279](https://github.com/ClickHouse/ClickHouse/pull/8279) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Dump cmake options in CI builds. [#8273](https://github.com/ClickHouse/ClickHouse/pull/8273) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Don't generate debug info for some fat libraries. [#8271](https://github.com/ClickHouse/ClickHouse/pull/8271) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Make `log_to_console.xml` always log to stderr, regardless of is it interactive or not. [#8395](https://github.com/ClickHouse/ClickHouse/pull/8395) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Removed some unused features from `clickhouse-performance-test` tool. [#8555](https://github.com/ClickHouse/ClickHouse/pull/8555) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Now we will also search for `lld-X` with corresponding `clang-X` version. [#8092](https://github.com/ClickHouse/ClickHouse/pull/8092) ([alesapin](https://github.com/alesapin))
- Parquet build improvement. [#8421](https://github.com/ClickHouse/ClickHouse/pull/8421) ([maxulan](https://github.com/maxulan))
- More GCC warnings [#8221](https://github.com/ClickHouse/ClickHouse/pull/8221) ([kreuzerkrieg](https://github.com/kreuzerkrieg))
- Package for Arch Linux now allows to run ClickHouse server, and not only client. [#8534](https://github.com/ClickHouse/ClickHouse/pull/8534) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix test with processors. Tiny performance fixes. [#7672](https://github.com/ClickHouse/ClickHouse/pull/7672) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Update contrib/protobuf. [#8256](https://github.com/ClickHouse/ClickHouse/pull/8256) ([Matwey V. Kornilov](https://github.com/matwey))
- In preparation of switching to c++20 as a new year celebration. "May the C++ force be with ClickHouse." [#8447](https://github.com/ClickHouse/ClickHouse/pull/8447) ([Amos Bird](https://github.com/amosbird))

#### Экспериментальная функциональность {#experimental-feature-8}

- Добавлена экспериментальная настройка `min_bytes_to_use_mmap_io`. Она позволяет читать большие файлы без копирования данных из ядра в пространство пользователя. Настройка по умолчанию отключена. Рекомендуемый порог составляет около 64 МБ, так как операции mmap/munmap выполняются медленно. [#8520](https://github.com/ClickHouse/ClickHouse/pull/8520) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Переработаны квоты в рамках системы контроля доступа. Добавлена новая таблица `system.quotas`, новые функции `currentQuota`, `currentQuotaKey`, новый синтаксис SQL `CREATE QUOTA`, `ALTER QUOTA`, `DROP QUOTA`, `SHOW QUOTA`. [#7257](https://github.com/ClickHouse/ClickHouse/pull/7257) ([Vitaly Baranov](https://github.com/vitlibar))
- Разрешён пропуск неизвестных настроек с выводом предупреждений вместо генерации исключений. [#7653](https://github.com/ClickHouse/ClickHouse/pull/7653) ([Vitaly Baranov](https://github.com/vitlibar))
- Переработаны политики строк в рамках системы контроля доступа. Добавлена новая таблица `system.row_policies`, новая функция `currentRowPolicies()`, новый синтаксис SQL `CREATE POLICY`, `ALTER POLICY`, `DROP POLICY`, `SHOW CREATE POLICY`, `SHOW POLICIES`. [#7808](https://github.com/ClickHouse/ClickHouse/pull/7808) ([Vitaly Baranov](https://github.com/vitlibar))

#### Исправление уязвимости {#security-fix}

- Исправлена возможность чтения структуры каталогов в таблицах с движком `File`. Это исправляет [#8536](https://github.com/ClickHouse/ClickHouse/issues/8536). [#8537](https://github.com/ClickHouse/ClickHouse/pull/8537) ([alexey-milovidov](https://github.com/alexey-milovidov))


## [Журнал изменений за 2019 год](./2019.md) {#changelog-for-2019}
