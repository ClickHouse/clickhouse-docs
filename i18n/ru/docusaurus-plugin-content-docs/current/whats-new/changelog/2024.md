---
slug: /whats-new/changelog/2024
sidebar_position: 3
sidebar_label: "2024"
title: "Журнал изменений 2024"
description: "Журнал изменений за 2024 год"
keywords:
  [
    "ClickHouse 2024",
    "журнал изменений 2024",
    "примечания к выпуску",
    "история версий",
    "новые функции"
  ]
doc_type: "changelog"
---

### Содержание {#table-of-contents}

**[ClickHouse release v24.12, 2024-12-19](/whats-new/changelog/2024#a-id2412a-clickhouse-release-2412-2024-12-19)**<br/>
**[ClickHouse release v24.11, 2024-11-26](/whats-new/changelog/2024#a-id2411a-clickhouse-release-2411-2024-11-26)**<br/>
**[ClickHouse release v24.10, 2024-10-31](/whats-new/changelog/2024#a-id2410a-clickhouse-release-2410-2024-10-31)**<br/>
**[ClickHouse release v24.9, 2024-09-26](/whats-new/changelog/2024#a-id249a-clickhouse-release-249-2024-09-26)**<br/>
**[ClickHouse release v24.8 LTS, 2024-08-20](/whats-new/changelog/2024#a-id248a-clickhouse-release-248-lts-2024-08-20)**<br/>
**[ClickHouse release v24.7, 2024-07-30](/whats-new/changelog/2024#a-id247a-clickhouse-release-247-2024-07-30)**<br/>
**[ClickHouse release v24.6, 2024-07-01](/whats-new/changelog/2024#a-id246a-clickhouse-release-246-2024-07-01)**<br/>
**[ClickHouse release v24.5, 2024-05-30](/whats-new/changelog/2024#a-id245a-clickhouse-release-245-2024-05-30)**<br/>
**[ClickHouse release v24.4, 2024-04-30](/whats-new/changelog/2024#a-id244a-clickhouse-release-244-2024-04-30)**<br/>
**[ClickHouse release v24.3 LTS, 2024-03-26](/whats-new/changelog/2024#a-id243a-clickhouse-release-243-lts-2024-03-27)**<br/>
**[ClickHouse release v24.2, 2024-02-29](/whats-new/changelog/2024#a-id242a-clickhouse-release-242-2024-02-29)**<br/>
**[ClickHouse release v24.1, 2024-01-30](/whats-new/changelog/2024#a-id241a-clickhouse-release-241-2024-01-30)**<br/>
**[Журнал изменений за 2023](/whats-new/changelog/2023/)**<br/>

### <a id="2412"></a> ClickHouse release 24.12, 2024-12-19 {#a-id2412a-clickhouse-release-2412-2024-12-19}

#### Обратно несовместимые изменения {#backward-incompatible-change}

- Функции `greatest` и `least` теперь игнорируют входные значения NULL, тогда как ранее они возвращали NULL, если один из аргументов был NULL. Например, `SELECT greatest(1, 2, NULL)` теперь возвращает 2. Это делает поведение совместимым с PostgreSQL, но при этом нарушает совместимость с MySQL, который возвращает NULL. Чтобы сохранить прежнее поведение, установите настройку `least_greatest_legacy_null_behavior` (по умолчанию: `false`) в значение `true`. [#65519](https://github.com/ClickHouse/ClickHouse/pull/65519) [#73344](https://github.com/ClickHouse/ClickHouse/pull/73344) ([kevinyhzou](https://github.com/KevinyhZou)).
- Новая интеграция с MongoDB теперь используется по умолчанию. Пользователи, желающие использовать устаревший драйвер MongoDB (на основе драйвера Poco), могут включить серверную настройку `use_legacy_mongodb_integration`. [#73359](https://github.com/ClickHouse/ClickHouse/pull/73359) ([Kirill Nikiforov](https://github.com/allmazz).


#### Новые возможности {#new-feature}

- Типы `JSON`/`Dynamic`/`Variant` переведены из экспериментальных функций в бета-версию. [#72294](https://github.com/ClickHouse/ClickHouse/pull/72294) ([Pavel Kruglov](https://github.com/Avogar)). Все исправления и это изменение также были перенесены в версию 24.11.
- Эволюция схемы для формата хранения данных [Iceberg](https://iceberg.apache.org/spec/#file-system-operations) предоставляет пользователю широкие возможности для изменения схемы таблицы. Порядок столбцов, имена столбцов и простые расширения типов могут изменяться автоматически. [#69445](https://github.com/ClickHouse/ClickHouse/pull/69445) ([Daniil Ivanik](https://github.com/divanik)).
- Интеграция с Iceberg REST Catalog: новый движок базы данных Iceberg, который интегрирует весь каталог в ClickHouse. [#71542](https://github.com/ClickHouse/ClickHouse/pull/71542) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлен кеш для первичного индекса таблиц `MergeTree` (включается настройкой таблицы `use_primary_key_cache`). Если для первичного индекса включены отложенная загрузка и кеширование, он будет загружаться в кеш по требованию (аналогично кешу меток) вместо постоянного хранения в памяти. Добавлен предварительный прогрев первичного индекса при вставке/слиянии/получении частей данных и при перезапуске таблицы (включается настройкой `prewarm_primary_key_cache`). Это позволяет снизить потребление памяти для больших таблиц на общем хранилище; функциональность протестирована на таблицах с более чем одним квадриллионом записей. [#72102](https://github.com/ClickHouse/ClickHouse/pull/72102) ([Anton Popov](https://github.com/CurtizJ)). [#72750](https://github.com/ClickHouse/ClickHouse/pull/72750) ([Alexander Gololobov](https://github.com/davenger)).
- Реализована команда `SYSTEM LOAD PRIMARY KEY` для загрузки первичных индексов всех частей указанной таблицы или всех таблиц, если таблица не указана. Это полезно для бенчмарков и для предотвращения дополнительных задержек при выполнении запросов. [#66252](https://github.com/ClickHouse/ClickHouse/pull/66252) [#67733](https://github.com/ClickHouse/ClickHouse/pull/67733) ([ZAWA_ll](https://github.com/Zawa-ll)).
- Добавлен запрос, позволяющий подключать таблицы `MergeTree` как `ReplicatedMergeTree` и наоборот: `ATTACH TABLE ... AS REPLICATED` и `ATTACH TABLE ... AS NOT REPLICATED`. [#65401](https://github.com/ClickHouse/ClickHouse/pull/65401) ([Kirill](https://github.com/kirillgarbar)).
- Новая настройка `http_response_headers`, позволяющая настраивать заголовки HTTP-ответа. Например, можно указать браузеру отобразить изображение, хранящееся в базе данных. Закрывает [#59620](https://github.com/ClickHouse/ClickHouse/issues/59620). [#72656](https://github.com/ClickHouse/ClickHouse/pull/72656) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлена функция `toUnixTimestamp64Second`, которая преобразует `DateTime64` в значение `Int64` с фиксированной точностью до секунды, что позволяет возвращать отрицательное значение для дат до начала эпохи Unix. [#70597](https://github.com/ClickHouse/ClickHouse/pull/70597) ([zhanglistar](https://github.com/zhanglistar)). [#73146](https://github.com/ClickHouse/ClickHouse/pull/73146) ([Robert Schulze](https://github.com/rschu1ze)).
- Добавлена новая настройка `enforce_index_structure_match_on_partition_manipulation`, позволяющая подключать таблицу, когда набор проекций и вторичных индексов исходной таблицы является подмножеством таковых в целевой таблице. Закрывает [#70602](https://github.com/ClickHouse/ClickHouse/issues/70602). [#70603](https://github.com/ClickHouse/ClickHouse/pull/70603) ([zwy991114](https://github.com/zwy991114)).
- Добавлен синтаксис ALTER USER `{ADD|MODIFY|DROP SETTING}`, ALTER USER `{ADD|DROP PROFILE}`, аналогично для ALTER ROLE и ALTER PROFILE. Теперь вместо замены всего набора настроек можно изменять его частично. [#72050](https://github.com/ClickHouse/ClickHouse/pull/72050) ([pufit](https://github.com/pufit)).
- Добавлена функция `arrayPRAUC`, которая вычисляет AUC (площадь под кривой) для кривой точности-полноты (Precision-Recall). [#72073](https://github.com/ClickHouse/ClickHouse/pull/72073) ([Emmanuel](https://github.com/emmanuelsdias)).
- Добавлена функция `indexOfAssumeSorted` для типов массивов. Оптимизирует поиск в массиве, отсортированном в неубывающем порядке. Эффект заметен на очень больших массивах (более 100 000 элементов). [#72517](https://github.com/ClickHouse/ClickHouse/pull/72517) ([Eric Kurbanov](https://github.com/erickurbanov)).
- Разрешено использование разделителя в качестве необязательного второго аргумента для агрегатной функции `groupConcat`. [#72540](https://github.com/ClickHouse/ClickHouse/pull/72540) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Функция `translate` теперь поддерживает удаление символов, если аргумент `from` содержит больше символов, чем аргумент `to`. Пример: `SELECT translate('clickhouse', 'clickhouse', 'CLICK')` теперь возвращает `CLICK`. [#71441](https://github.com/ClickHouse/ClickHouse/pull/71441) ([shuai.xu](https://github.com/shuai-xu)).

#### Экспериментальные функции {#experimental-features}

- Новая настройка MergeTree `allow_experimental_reverse_key`, которая включает поддержку сортировки по убыванию в ключах сортировки MergeTree. Это полезно для анализа временных рядов, особенно для запросов TopN. Пример использования: `ENGINE = MergeTree ORDER BY (time DESC, key)` — сортировка по убыванию для поля `time`. [#71095](https://github.com/ClickHouse/ClickHouse/pull/71095) ([Amos Bird](https://github.com/amosbird)).


#### Улучшение производительности {#performance-improvement}

- Переупорядочивание JOIN. Добавлена опция для выбора стороны соединения, которая будет выступать в качестве внутренней (build) таблицы в плане запроса. Управляется параметром `query_plan_join_swap_table`, который может быть установлен в `auto`. В этом режиме ClickHouse попытается выбрать таблицу с наименьшим количеством строк. [#71577](https://github.com/ClickHouse/ClickHouse/pull/71577) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Теперь алгоритм `parallel_hash` будет использоваться (если применимо), когда настройка `join_algorithm` установлена в `default`. Две предыдущие альтернативы (`direct` и `hash`) по-прежнему рассматриваются, когда `parallel_hash` не может быть использован. [#70788](https://github.com/ClickHouse/ClickHouse/pull/70788) ([Nikita Taranov](https://github.com/nickitat)).
- Добавлена опция для извлечения общих выражений из выражений `WHERE` и `ON` с целью уменьшения количества хеш-таблиц, используемых при соединениях. Это имеет смысл, когда условие JOIN ON содержит общие части внутри AND в различных частях OR. Может быть включено с помощью `optimize_extract_common_expressions = 1`. [#71537](https://github.com/ClickHouse/ClickHouse/pull/71537) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Позволяет использовать индексы в `SELECT`, когда индексированный столбец преобразуется в `LowCardinality(String)`, что может иметь место при выполнении запроса к таблице Merge, где некоторые таблицы имеют тип `String`, а некоторые — `LowCardinality(String)`. [#71598](https://github.com/ClickHouse/ClickHouse/pull/71598) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- При выполнении запроса с параллельными репликами и включенным локальным планом анализ индексов на рабочих узлах не выполняется. Координатор выберет диапазоны для чтения рабочими узлами на основе анализа индексов на своей стороне (на инициаторе запроса). Это позволяет коротким запросам с параллельными репликами иметь такую же низкую задержку, как и запросы на одном узле. [#72109](https://github.com/ClickHouse/ClickHouse/pull/72109) ([Igor Nikonov](https://github.com/devcrafter)).
- Снижено использование памяти командой `clickhouse disks remove --recursive` для дисков объектного хранилища. [#67323](https://github.com/ClickHouse/ClickHouse/pull/67323) ([Kirill](https://github.com/kirillgarbar)).
- Возвращена оптимизация для чтения подстолбцов одного столбца в компактных частях из [#57631](https://github.com/ClickHouse/ClickHouse/pull/57631). Она была удалена случайно. [#72285](https://github.com/ClickHouse/ClickHouse/pull/72285) ([Pavel Kruglov](https://github.com/Avogar)).
- Ускорена сортировка столбцов `LowCardinality(String)` путем девиртуализации вызовов в компараторе. [#72337](https://github.com/ClickHouse/ClickHouse/pull/72337) ([Alexander Gololobov](https://github.com/davenger)).
- Оптимизированы функции `argMin`/`argMax` для некоторых простых типов данных. [#72350](https://github.com/ClickHouse/ClickHouse/pull/72350) ([alesapin](https://github.com/alesapin)).
- Оптимизирована блокировка с использованием разделяемых блокировок в трекере памяти для снижения конкуренции за блокировки, что улучшает производительность на системах с очень большим количеством процессоров. [#72375](https://github.com/ClickHouse/ClickHouse/pull/72375) ([Jiebin Sun](https://github.com/jiebinn)).
- Добавлена новая настройка `use_async_executor_for_materialized_views`. Использует асинхронное и потенциально многопоточное выполнение запроса материализованного представления, может ускорить обработку представлений во время INSERT, но также потребляет больше памяти. [#72497](https://github.com/ClickHouse/ClickHouse/pull/72497) ([alesapin](https://github.com/alesapin)).
- Улучшена производительность десериализации состояний агрегатных функций (в типе данных `AggregateFunction` и в распределенных запросах). Немного улучшена производительность парсинга формата `RowBinary`. [#72818](https://github.com/ClickHouse/ClickHouse/pull/72818) ([Anton Popov](https://github.com/CurtizJ)).
- Разделение диапазонов при чтении с параллельными репликами в порядке ключа таблицы для снижения потребления памяти во время чтения. [#72173](https://github.com/ClickHouse/ClickHouse/pull/72173) ([JIaQi](https://github.com/JiaQiTang98)).
- Ускорены вставки в merge tree в случае одного значения ключа партиционирования внутри вставляемого пакета. [#72348](https://github.com/ClickHouse/ClickHouse/pull/72348) ([alesapin](https://github.com/alesapin)).
- Реализовано параллельное создание таблиц при восстановлении из резервной копии. До этого PR команда `RESTORE` всегда создавала таблицы в одном потоке, что могло быть медленным в случае резервных копий, содержащих много таблиц. [#72427](https://github.com/ClickHouse/ClickHouse/pull/72427) ([Vitaly Baranov](https://github.com/vitlibar)).
- Очистка кеша меток может занять заметное время, если он большой. Если мы удерживаем мьютекс контекста во время этого, это блокирует многие другие операции, даже новое клиентское соединение не может быть установлено, пока он не будет освобожден. Удержание этого мьютекса фактически не требуется для синхронизации, достаточно иметь локальную ссылку на кеш через shared ptr. [#72749](https://github.com/ClickHouse/ClickHouse/pull/72749) ([Alexander Gololobov](https://github.com/davenger)).





#### Улучшения {#improvement}

- Удалена настройка `allow_experimental_join_condition`, неравенственные условия теперь разрешены по умолчанию. [#69910](https://github.com/ClickHouse/ClickHouse/pull/69910) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Настройки из конфигурации сервера (users.xml) теперь применяются и на клиенте. Полезно для настроек форматирования, например `date_time_output_format`. [#71178](https://github.com/ClickHouse/ClickHouse/pull/71178) ([Michael Kolupaev](https://github.com/al13n321)).
- Автоматическое выполнение `GROUP BY`/`ORDER BY` на диске на основе использования памяти сервером/пользователем. Управляется настройками запроса `max_bytes_ratio_before_external_group_by`/`max_bytes_ratio_before_external_sort`. [#71406](https://github.com/ClickHouse/ClickHouse/pull/71406) ([Azat Khuzhin](https://github.com/azat)).
- Добавлена новая логика отмены: `CancellationChecker` проверяет таймауты для каждого запущенного запроса и останавливает их по достижении таймаута. [#69880](https://github.com/ClickHouse/ClickHouse/pull/69880) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Поддержка ALTER из `Object` в `JSON`, что позволяет легко мигрировать с устаревшего типа Object. [#71784](https://github.com/ClickHouse/ClickHouse/pull/71784) ([Pavel Kruglov](https://github.com/Avogar)).
- Разрешены неизвестные значения в множестве, которые отсутствуют в Enum. Исправление [#72662](https://github.com/ClickHouse/ClickHouse/issues/72662). [#72686](https://github.com/ClickHouse/ClickHouse/pull/72686) ([zhanglistar](https://github.com/zhanglistar)).
- Поддержка оператора поиска строк (например, LIKE) для типа данных `Enum`, реализует [#72661](https://github.com/ClickHouse/ClickHouse/issues/72661). [#72732](https://github.com/ClickHouse/ClickHouse/pull/72732) ([zhanglistar](https://github.com/zhanglistar)).
- Некоторые бессмысленные запросы ALTER USER принимались. Исправление [#71227](https://github.com/ClickHouse/ClickHouse/issues/71227). [#71286](https://github.com/ClickHouse/ClickHouse/pull/71286) ([Arthur Passos](https://github.com/arthurpassos)).
- Учитывается `prefer_locahost_replica` при построении плана для распределённого `INSERT ... SELECT`. [#72190](https://github.com/ClickHouse/ClickHouse/pull/72190) ([filimonov](https://github.com/filimonov)).
- Azure нарушил спецификацию Iceberg, ошибочно маркируя Iceberg v1 как Iceberg v2. Проблема [описана здесь](https://github.com/ClickHouse/ClickHouse/issues/72091). Azure Iceberg Writer создаёт файлы метаданных Iceberg (а также файлы манифестов), которые нарушают спецификацию. Теперь мы пытаемся читать метаданные формата Iceberg v1 с помощью читателя v2 (поскольку они записывают их таким образом), и добавлена ошибка, когда они не создали соответствующие поля в файле манифеста. [#72277](https://github.com/ClickHouse/ClickHouse/pull/72277) ([Daniil Ivanik](https://github.com/divanik)).
- Теперь разрешено создавать `CREATE MATERIALIZED VIEW` с `UNION [ALL]` в запросе. Поведение аналогично материализованному представлению с `JOIN`: только первая таблица в выражении `SELECT` будет работать как триггер для вставки, все остальные таблицы будут игнорироваться. Однако, если есть много ссылок на первую таблицу (например, UNION с самой собой), все они будут обработаны как вставленный блок данных. [#72347](https://github.com/ClickHouse/ClickHouse/pull/72347) ([alesapin](https://github.com/alesapin)).
- Добавлена валидация исходного запроса, когда ClickHouse используется как источник для словаря. [#72548](https://github.com/ClickHouse/ClickHouse/pull/72548) ([Alexey Katsman](https://github.com/alexkats)).
- Обеспечено, что ClickHouse будет видеть изменения ZooKeeper при перезагрузке конфигурации. [#72593](https://github.com/ClickHouse/ClickHouse/pull/72593) ([Azat Khuzhin](https://github.com/azat)).
- Улучшена аппроксимация использования памяти кэшированными метками для снижения общего использования памяти кэшем. [#72630](https://github.com/ClickHouse/ClickHouse/pull/72630) ([Antonio Andelic](https://github.com/antonio2368)).
- Добавлена новая метрика `StartupScriptsExecutionState`. Метрика может иметь три значения: 0 = скрипты запуска ещё не завершены, 1 = скрипты запуска выполнены успешно, 2 = скрипты запуска завершились с ошибкой. Эта метрика необходима, чтобы знать, успешно ли выполняются скрипты запуска в облаке, особенно после выпуска базовых конфигураций. [#72637](https://github.com/ClickHouse/ClickHouse/pull/72637) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Добавлена новая метрика `MergeTreeIndexGranularityInternalArraysTotalSize` в `system.metrics`. Эта метрика необходима для поиска экземпляров с огромными наборами данных, подверженных высокому
- Добавлены повторные попытки при создании реплицируемой таблицы. [#72682](https://github.com/ClickHouse/ClickHouse/pull/72682) ([Vitaly Baranov](https://github.com/vitlibar)).
- Добавлено поле `total_bytes_with_inactive` в `system.tables` для подсчёта общего объёма неактивных частей в байтах. [#72690](https://github.com/ClickHouse/ClickHouse/pull/72690) ([Kai Zhu](https://github.com/nauu)).
- Добавлены настройки MergeTree в `system.settings_changes`. [#72694](https://github.com/ClickHouse/ClickHouse/pull/72694) ([Raúl Marín](https://github.com/Algunenano)).
- Поддержка типа JSON в функции `notEmpty`. [#72741](https://github.com/ClickHouse/ClickHouse/pull/72741) ([Pavel Kruglov](https://github.com/Avogar)).
- Поддержка разбора ошибки GCS S3 `AuthenticationRequired`. [#72753](https://github.com/ClickHouse/ClickHouse/pull/72753) ([Vitaly Baranov](https://github.com/vitlibar)).
- Поддержка типа `Dynamic` в функциях `ifNull` и `coalesce`. [#72772](https://github.com/ClickHouse/ClickHouse/pull/72772) ([Pavel Kruglov](https://github.com/Avogar)).
- Поддержка `Dynamic` в функциях `toFloat64`/`touInt32`/и т. д. [#72989](https://github.com/ClickHouse/ClickHouse/pull/72989) ([Pavel Kruglov](https://github.com/Avogar)).
- Добавлены настройки S3-запросов `http_max_fields`, `http_max_field_name_size`, `http_max_field_value_size` и их использование при разборе ответов S3 API во время создания резервной копии или восстановления. [#72778](https://github.com/ClickHouse/ClickHouse/pull/72778) ([Vitaly Baranov](https://github.com/vitlibar)).
- Удаление метаданных таблицы в keeper в Storage S3(Azure)Queue только после удаления последней таблицы, использующей эти метаданные. [#72810](https://github.com/ClickHouse/ClickHouse/pull/72810) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлены события профилирования `JoinBuildTableRowCount`/`JoinProbeTableRowCount/JoinResultRowCount`. [#72842](https://github.com/ClickHouse/ClickHouse/pull/72842) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Поддержка подстолбцов в ключе сортировки MergeTree и индексах пропуска. [#72644](https://github.com/ClickHouse/ClickHouse/pull/72644) ([Pavel Kruglov](https://github.com/Avogar)).





#### Исправление ошибки (видимое пользователю некорректное поведение в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release}

- Исправлено возможное пересечение частей для MergeTree (после неудачной операции перемещения части в каталог detached, возможно, из-за операции с объектным хранилищем). [#70476](https://github.com/ClickHouse/ClickHouse/pull/70476) ([Azat Khuzhin](https://github.com/azat)).
- Исправлено обнаружение ошибки при слишком длинном имени таблицы. Добавлена диагностика с указанием максимальной длины. Добавлена новая функция `getMaxTableNameLengthForDatabase`. [#70810](https://github.com/ClickHouse/ClickHouse/pull/70810) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Исправлены зомби-процессы после сбоя `clickhouse-library-bridge` (эта программа позволяет запускать небезопасные библиотеки). [#71301](https://github.com/ClickHouse/ClickHouse/pull/71301) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Исправлена ошибка NoSuchKey при откате транзакции, когда не удаётся создать каталог для диска `plain_rewritable`. [#71439](https://github.com/ClickHouse/ClickHouse/pull/71439) ([Julia Kartseva](https://github.com/jkartseva)).
- Исправлена сериализация значений `Dynamic` в форматах `Pretty` JSON. [#71923](https://github.com/ClickHouse/ClickHouse/pull/71923) ([Pavel Kruglov](https://github.com/Avogar)).
- Добавлено автоматически определённое имя формата в запрос создания для движков `File`/`S3`/`URL`/`HDFS`/`Azure`. Ранее имя формата определялось при каждом перезапуске сервера, и если указанные файлы данных были удалены, это приводило к ошибкам при запуске сервера. [#72108](https://github.com/ClickHouse/ClickHouse/pull/72108) ([Pavel Kruglov](https://github.com/Avogar)).
- Исправлены ошибки при использовании UDF в соединении по выражению со старым анализатором. [#72179](https://github.com/ClickHouse/ClickHouse/pull/72179) ([Raúl Marín](https://github.com/Algunenano)).
- Исправлены некоторые небольшие ошибки в `StorageObjectStorage`. Необходимо включить `use_hive_partitioning` по умолчанию. [#72185](https://github.com/ClickHouse/ClickHouse/pull/72185) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Исправлена ошибка, при которой `min_age_to_force_merge_on_partition_only` зацикливался, пытаясь повторно слить одну и ту же партицию, которая уже была слита в одну часть, и не сливал партиции с несколькими частями. [#72209](https://github.com/ClickHouse/ClickHouse/pull/72209) ([Christoph Wurm](https://github.com/cwurm)).
- Исправлен сбой в `SimpleSquashingChunksTransform`, который происходил в редких случаях при обработке разреженных столбцов. [#72226](https://github.com/ClickHouse/ClickHouse/pull/72226) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Исправлено состояние гонки в `GraceHashJoin`, в результате которого некоторые строки могли отсутствовать в результате соединения. [#72233](https://github.com/ClickHouse/ClickHouse/pull/72233) ([Nikita Taranov](https://github.com/nickitat)).
- Исправлены запросы `ALTER DELETE` с материализованным столбцом `_block_number` (если включена настройка `enable_block_number_column`). [#72261](https://github.com/ClickHouse/ClickHouse/pull/72261) ([Anton Popov](https://github.com/CurtizJ)).
- Исправлено состояние гонки при одновременном вызове `ColumnDynamic::dumpStructure()`, например, в конструкторе `ConcurrentHashJoin`. [#72278](https://github.com/ClickHouse/ClickHouse/pull/72278) ([Nikita Taranov](https://github.com/nickitat)).
- Исправлена возможная ошибка `LOGICAL_ERROR` с дублирующимися столбцами в `ORDER BY ... WITH FILL`. [#72387](https://github.com/ClickHouse/ClickHouse/pull/72387) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Исправлено несоответствие типов в нескольких случаях после применения `optimize_functions_to_subcolumns`. [#72394](https://github.com/ClickHouse/ClickHouse/pull/72394) ([Anton Popov](https://github.com/CurtizJ)).
- Используется `AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE` вместо `AWS_CONTAINER_AUTHORIZATION_TOKEN_PATH`. Исправляет [#71074](https://github.com/ClickHouse/ClickHouse/issues/71074). [#72397](https://github.com/ClickHouse/ClickHouse/pull/72397) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Исправлена ошибка при парсинге запросов `BACKUP DATABASE db EXCEPT TABLES db.table`. [#72429](https://github.com/ClickHouse/ClickHouse/pull/72429) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Запрещено создание пустого `Variant`. [#72454](https://github.com/ClickHouse/ClickHouse/pull/72454) ([Pavel Kruglov](https://github.com/Avogar)).
- Исправлено неверное форматирование `result_part_path` в `system.merges`. [#72567](https://github.com/ClickHouse/ClickHouse/pull/72567) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Исправлен парсинг glob-шаблона с одним элементом (например, `{file}`). [#72572](https://github.com/ClickHouse/ClickHouse/pull/72572) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Исправлена генерация запроса для сервера-последователя в случае распределённого запроса с `ARRAY JOIN`. Исправляет [#69276](https://github.com/ClickHouse/ClickHouse/issues/69276). [#72608](https://github.com/ClickHouse/ClickHouse/pull/72608) ([Dmitry Novik](https://github.com/novikd)).
- Исправлена ошибка, когда DateTime64 IN DateTime64 ничего не возвращает. [#72640](https://github.com/ClickHouse/ClickHouse/pull/72640) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Исправлены несогласованные метаданные при добавлении новой реплики в реплицируемую базу данных, содержащую таблицу, созданную с `flatten_nested=0`. [#72685](https://github.com/ClickHouse/ClickHouse/pull/72685) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Исправлена расширенная конфигурация SSL для внутренней коммуникации Keeper. [#72730](https://github.com/ClickHouse/ClickHouse/pull/72730) ([Antonio Andelic](https://github.com/antonio2368)).
- Исправлена ошибка "No such key" в неупорядоченном режиме S3Queue с настройкой `tracked_files_limit` меньше, чем скорость появления файлов s3. [#72738](https://github.com/ClickHouse/ClickHouse/pull/72738) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Исправлено исключение, выбрасываемое в RemoteQueryExecutor, когда пользователь не существует локально. [#72759](https://github.com/ClickHouse/ClickHouse/pull/72759) ([Andrey Zvonov](https://github.com/zvonand)).
- Исправлены мутации с материализованным столбцом `_block_number` (если включена настройка `enable_block_number_column`). [#72854](https://github.com/ClickHouse/ClickHouse/pull/72854) ([Anton Popov](https://github.com/CurtizJ)).
- Исправлено резервное копирование/восстановление с обычным перезаписываемым диском в случае наличия пустых файлов в резервной копии. [#72858](https://github.com/ClickHouse/ClickHouse/pull/72858) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Корректная отмена вставок в DistributedAsyncInsertDirectoryQueue. [#72885](https://github.com/ClickHouse/ClickHouse/pull/72885) ([Antonio Andelic](https://github.com/antonio2368)).
- Исправлен сбой при парсинге некорректных данных в разреженные столбцы (может произойти при включённой настройке `enable_parsing_to_custom_serialization`). [#72891](https://github.com/ClickHouse/ClickHouse/pull/72891) ([Anton Popov](https://github.com/CurtizJ)).
- Исправлен потенциальный сбой во время восстановления резервной копии. [#72947](https://github.com/ClickHouse/ClickHouse/pull/72947) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Исправлена ошибка в методе JOIN `parallel_hash`, которая могла возникнуть, когда запрос имеет сложное условие в предложении `ON` с фильтрами неравенства. [#72993](https://github.com/ClickHouse/ClickHouse/pull/72993) ([Nikita Taranov](https://github.com/nickitat)).
- Используются настройки формата по умолчанию при парсинге JSON для предотвращения некорректной десериализации. [#73043](https://github.com/ClickHouse/ClickHouse/pull/73043) ([Pavel Kruglov](https://github.com/Avogar)).
- Исправлен сбой в транзакциях с неподдерживаемым хранилищем. [#73045](https://github.com/ClickHouse/ClickHouse/pull/73045) ([Raúl Marín](https://github.com/Algunenano)).
- Исправлена возможная переоценка отслеживания памяти (когда разница между `MemoryTracking` и `MemoryResident` продолжала расти). [#73081](https://github.com/ClickHouse/ClickHouse/pull/73081) ([Azat Khuzhin](https://github.com/azat)).
- Проверка дублирующихся ключей JSON при парсинге Tuple. Ранее это могло привести к логической ошибке `Invalid number of rows in Chunk` во время парсинга. [#73082](https://github.com/ClickHouse/ClickHouse/pull/73082) ([Pavel Kruglov](https://github.com/Avogar)).

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement}

- Все небольшие утилиты, ранее хранившиеся в папке `/utils` и требовавшие ручной компиляции из исходного кода, теперь входят в состав основного пакета ClickHouse. Закрывает: [#72404](https://github.com/ClickHouse/ClickHouse/issues/72404). [#72426](https://github.com/ClickHouse/ClickHouse/pull/72426) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Отменено удаление `/etc/systemd/system/clickhouse-server.service`, введенное в версии 22.3 [#39323](https://github.com/ClickHouse/ClickHouse/issues/39323). [#72259](https://github.com/ClickHouse/ClickHouse/pull/72259) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Разделены крупные единицы трансляции во избежание сбоев компиляции из-за ограничений памяти/процессора. [#72352](https://github.com/ClickHouse/ClickHouse/pull/72352) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- OSX: Сборка с поддержкой ICU, что обеспечивает сортировки, преобразования кодировок и другие функции локализации. [#73083](https://github.com/ClickHouse/ClickHouse/pull/73083) ([Raúl Marín](https://github.com/Algunenano)).

### <a id="2411"></a> Релиз ClickHouse 24.11, 2024-11-26 {#a-id2411a-clickhouse-release-2411-2024-11-26}

#### Обратно несовместимые изменения {#backward-incompatible-change-1}

- Удалены системные таблицы `generate_series` и `generateSeries`. Они были добавлены по ошибке: [#59390](https://github.com/ClickHouse/ClickHouse/issues/59390). [#71091](https://github.com/ClickHouse/ClickHouse/pull/71091) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Удален `StorageExternalDistributed`. Закрывает [#70600](https://github.com/ClickHouse/ClickHouse/issues/70600).[#71176](https://github.com/ClickHouse/ClickHouse/pull/71176) ([flynn](https://github.com/ucasfl)).
- Движки таблиц Kafka, NATS и RabbitMQ теперь имеют собственные права доступа в иерархии `SOURCES`. Необходимо предоставить права всем пользователям базы данных, отличным от пользователя по умолчанию, которые создают таблицы с этими типами движков. [#71250](https://github.com/ClickHouse/ClickHouse/pull/71250) ([Christoph Wurm](https://github.com/cwurm)).
- Выполняется проверка полного запроса мутации перед его выполнением (включая подзапросы). Это предотвращает случайное выполнение некорректного запроса и накопление неактивных мутаций, блокирующих корректные мутации. [#71300](https://github.com/ClickHouse/ClickHouse/pull/71300) ([Christoph Wurm](https://github.com/cwurm)).
- Переименована настройка кеша файловой системы `skip_download_if_exceeds_query_cache` в `filesystem_cache_skip_download_if_exceeds_per_query_cache_write_limit`. [#71578](https://github.com/ClickHouse/ClickHouse/pull/71578) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Удалена поддержка аргументов `Enum`, а также `UInt128` и `UInt256` в `deltaSumTimestamp`. Удалена поддержка `Int8`, `UInt8`, `Int16` и `UInt16` для второго аргумента ("timestamp") функции `deltaSumTimestamp`. [#71790](https://github.com/ClickHouse/ClickHouse/pull/71790) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- При получении данных непосредственно из словаря с использованием хранилища Dictionary, табличной функции словаря или прямого SELECT из самого словаря теперь достаточно иметь разрешение `SELECT` или разрешение `dictGet` для словаря. Это согласуется с предыдущими попытками предотвратить обход ACL: https://github.com/ClickHouse/ClickHouse/pull/57362 и https://github.com/ClickHouse/ClickHouse/pull/65359. Также это обеспечивает обратную совместимость последнего изменения. [#72051](https://github.com/ClickHouse/ClickHouse/pull/72051) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).


#### Экспериментальная функциональность {#experimental-feature}

- Реализован параметр `allow_feature_tier` в качестве глобального переключателя для отключения всех экспериментальных и бета-функций. [#71841](https://github.com/ClickHouse/ClickHouse/pull/71841) [#71145](https://github.com/ClickHouse/ClickHouse/pull/71145) ([Raúl Marín](https://github.com/Algunenano)).
- Исправлена возможная ошибка `No such file or directory` из-за неэкранированных специальных символов в именах файлов для подстолбцов JSON. [#71182](https://github.com/ClickHouse/ClickHouse/pull/71182) ([Pavel Kruglov](https://github.com/Avogar)).
- Добавлена поддержка изменения типа из String в JSON. Это изменение также переводит сериализацию типов JSON и Dynamic на новую версию V2. Старая версия V1 по-прежнему может использоваться путём включения настройки `merge_tree_use_v1_object_and_dynamic_serialization` (может применяться во время обновления для возможности отката версии без проблем). [#70442](https://github.com/ClickHouse/ClickHouse/pull/70442) ([Pavel Kruglov](https://github.com/Avogar)).
- Реализовано простое преобразование CAST из Map/Tuple/Object в новый тип JSON через сериализацию/десериализацию из JSON-строки. [#71320](https://github.com/ClickHouse/ClickHouse/pull/71320) ([Pavel Kruglov](https://github.com/Avogar)).
- По умолчанию запрещено использование типов Variant/Dynamic в ORDER BY/GROUP BY/PARTITION BY/PRIMARY KEY, поскольку это может привести к неожиданным результатам. [#69731](https://github.com/ClickHouse/ClickHouse/pull/69731) ([Pavel Kruglov](https://github.com/Avogar)).
- Запрещено использование типов Dynamic/Variant в функциях min/max во избежание путаницы. [#71761](https://github.com/ClickHouse/ClickHouse/pull/71761) ([Pavel Kruglov](https://github.com/Avogar)).

#### Новая функциональность {#new-feature-1}

- Добавлен синтаксис SQL для описания управления рабочей нагрузкой и ресурсами. https://clickhouse.com/docs/operations/workload-scheduling. [#69187](https://github.com/ClickHouse/ClickHouse/pull/69187) ([Sergei Trifonov](https://github.com/serxa)).
- Новый тип данных `BFloat16` представляет 16-битные числа с плавающей точкой с 8-битной экспонентой, знаком и 7-битной мантиссой. Закрывает [#44206](https://github.com/ClickHouse/ClickHouse/issues/44206). Закрывает [#49937](https://github.com/ClickHouse/ClickHouse/issues/49937). [#64712](https://github.com/ClickHouse/ClickHouse/pull/64712) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлен запрос `CHECK GRANT` для проверки того, предоставлена ли текущему пользователю/роли конкретная привилегия и существует ли соответствующая таблица/столбец в памяти. [#68885](https://github.com/ClickHouse/ClickHouse/pull/68885) ([Unalian](https://github.com/Unalian)).
- Добавлены табличные функции `iceberg[S3;HDFS;Azure]Cluster`, `deltaLakeCluster`, `hudiCluster`. [#72045](https://github.com/ClickHouse/ClickHouse/pull/72045) ([Mikhail Artemenko](https://github.com/Michicosun)).
- Добавлена возможность установки имени пользователя и пароля в http_handlers (для `dynamic_query_handler`/`predefined_query_handler`). [#70725](https://github.com/ClickHouse/ClickHouse/pull/70725) ([Azat Khuzhin](https://github.com/azat)).
- Добавлена поддержка условия staleness в операторе ORDER BY WITH FILL. [#71151](https://github.com/ClickHouse/ClickHouse/pull/71151) ([Mikhail Artemenko](https://github.com/Michicosun)).
- Каждому методу аутентификации теперь можно задать собственную дату истечения срока действия, удалено из сущности пользователя. [#70090](https://github.com/ClickHouse/ClickHouse/pull/70090) ([Arthur Passos](https://github.com/arthurpassos)).
- Добавлены новые функции `parseDateTime64`, `parseDateTime64OrNull` и `parseDateTime64OrZero`. В отличие от существующей функции `parseDateTime` (и её вариантов), они возвращают значение типа `DateTime64` вместо `DateTime`. [#71581](https://github.com/ClickHouse/ClickHouse/pull/71581) ([kevinyhzou](https://github.com/KevinyhZou)).


#### Улучшение производительности {#performance-improvement-1}

- Оптимизировано использование памяти для значений гранулярности индекса, если гранулярность постоянна для части. Добавлена возможность всегда выбирать постоянную гранулярность для части (настройка `use_const_adaptive_granularity`), что обеспечивает постоянную оптимизацию в памяти. Это помогает при больших нагрузках (триллионы строк в общем хранилище) избежать постоянного роста использования памяти метаданными (значениями гранулярности индекса) частей данных. [#71786](https://github.com/ClickHouse/ClickHouse/pull/71786) ([Anton Popov](https://github.com/CurtizJ)).
- Теперь столбцы входных блоков не копируются для `join_algorithm = 'parallel_hash'` при распределении их между потоками для параллельной обработки. [#67782](https://github.com/ClickHouse/ClickHouse/pull/67782) ([Nikita Taranov](https://github.com/nickitat)).
- Оптимизирован алгоритм слияния `Replacing` для непересекающихся частей. [#70977](https://github.com/ClickHouse/ClickHouse/pull/70977) ([Anton Popov](https://github.com/CurtizJ)).
- Отсоединенные части с дисков только для чтения и однократной записи не перечисляются для метрик и system.detached_parts. [#71086](https://github.com/ClickHouse/ClickHouse/pull/71086) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- По умолчанию тяжелые асинхронные метрики не вычисляются. Функция была введена в [#40332](https://github.com/ClickHouse/ClickHouse/issues/40332), но нецелесообразно иметь тяжелую фоновую задачу, которая нужна только одному клиенту. [#71087](https://github.com/ClickHouse/ClickHouse/pull/71087) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Для дисков `plain_rewritable`: API объектного хранилища не вызывается при перечислении каталогов, так как это может быть неэффективно с точки зрения затрат. Вместо этого список имен файлов хранится в памяти. Компромиссами являются увеличенное время начальной загрузки и память, необходимая для хранения имен файлов. [#70823](https://github.com/ClickHouse/ClickHouse/pull/70823) ([Julia Kartseva](https://github.com/jkartseva)).
- Улучшена производительность и точность интервала сбора `system.query_metric_log` за счет уменьшения критической области. [#71473](https://github.com/ClickHouse/ClickHouse/pull/71473) ([Pablo Marcos](https://github.com/pamarcos)).
- Оптимизация чтения по порядку через генерацию виртуальных строк, благодаря чему меньше данных будет прочитано во время сортировки слиянием, что особенно полезно при наличии нескольких частей. [#62125](https://github.com/ClickHouse/ClickHouse/pull/62125) ([Shichao Jin](https://github.com/jsc0218)).
- Добавлена серверная настройка `async_load_system_database`, которая позволяет серверу запускаться с не полностью загруженной системной базой данных. Это помогает запускать ClickHouse быстрее, если имеется много системных таблиц. [#69847](https://github.com/ClickHouse/ClickHouse/pull/69847) ([Sergei Trifonov](https://github.com/serxa)).
- Добавлен параметр `--threads` в `clickhouse-compressor`, который позволяет сжимать данные параллельно. [#70860](https://github.com/ClickHouse/ClickHouse/pull/70860) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлена настройка `prewarm_mark_cache`, которая включает загрузку меток в кеш меток при вставках, слияниях, получении частей и при запуске таблицы. [#71053](https://github.com/ClickHouse/ClickHouse/pull/71053) ([Anton Popov](https://github.com/CurtizJ)).
- Сжатие массива index_granularity в памяти для уменьшения объема используемой памяти для семейства движков таблиц MergeTree. [#71595](https://github.com/ClickHouse/ClickHouse/pull/71595) ([alesapin](https://github.com/alesapin)).
- Отключена настройка кеша файловой системы `boundary_alignment` для чтения не с диска, что улучшает производительность чтения из автономных удаленных файлов с кешированием. [#71827](https://github.com/ClickHouse/ClickHouse/pull/71827) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Запросы вида `SELECT * FROM table LIMIT ...` загружали индексы частей, даже если они не использовались. [#71866](https://github.com/ClickHouse/ClickHouse/pull/71866) ([Alexander Gololobov](https://github.com/davenger)).
- Включена по умолчанию настройка `parallel_replicas_local_plan`. Построение полноценного локального плана на инициаторе запроса улучшает производительность параллельных реплик с меньшим потреблением ресурсов и предоставляет возможности для применения большего количества оптимизаций запросов. [#70171](https://github.com/ClickHouse/ClickHouse/pull/70171) ([Igor Nikonov](https://github.com/devcrafter)).





#### Улучшение {#improvement-1}

- Разрешено использование clickhouse с файловым аргументом в виде `ch queries.sql`. [#71589](https://github.com/ClickHouse/ClickHouse/pull/71589) ([Raúl Marín](https://github.com/Algunenano)).
- Формат `Vertical` (который также активируется при завершении запроса символом `\G`) получает возможности форматов Pretty, такие как: - выделение разрядов тысяч в числах; - вывод читаемой подсказки для чисел. [#71630](https://github.com/ClickHouse/ClickHouse/pull/71630) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Передача внешних ролей пользователя от инициатора запроса к другим узлам кластера. Полезно, когда только инициатор имеет доступ к внешнему аутентификатору (например, LDAP). [#70332](https://github.com/ClickHouse/ClickHouse/pull/70332) ([Andrey Zvonov](https://github.com/zvonand)).
- Добавлены псевдонимы `anyRespectNulls`, `firstValueRespectNulls` и `anyValueRespectNulls` для агрегатной функции `any`. Также добавлены псевдонимы `anyLastRespectNulls` и `lastValueRespectNulls` для агрегатной функции `anyLast`. Это позволяет использовать более естественный синтаксис только в стиле camelCase вместо смешанного синтаксиса camelCase/underscore, например: `SELECT anyLastRespectNullsStateIf` вместо `anyLast_respect_nullsStateIf`. [#71403](https://github.com/ClickHouse/ClickHouse/pull/71403) ([Peter Nguyen](https://github.com/petern48)).
- Добавлен параметр конфигурации `date_time_utc`, позволяющий форматировать журналы JSON с поддержкой даты-времени UTC в формате RFC 3339/ISO8601. [#71560](https://github.com/ClickHouse/ClickHouse/pull/71560) ([Ali](https://github.com/xogoodnow)).
- Добавлен новый тип заголовка для конечных точек S3 для аутентификации пользователя (`access_header`). Это позволяет получить заголовок доступа с наименьшим приоритетом, который будет перезаписан значением `access_key_id` из любого другого источника (например, схемы таблицы или именованной коллекции). [#71011](https://github.com/ClickHouse/ClickHouse/pull/71011) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Функции высшего порядка с константными массивами и константными захваченными аргументами будут возвращать константы. [#58400](https://github.com/ClickHouse/ClickHouse/pull/58400) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Имена шагов плана запроса (`EXPLAIN PLAN json=1`) и имена процессоров конвейера (`EXPLAIN PIPELINE compact=0,graph=1`) теперь имеют уникальный идентификатор в качестве суффикса. Это позволяет сопоставить вывод профилировщика процессоров и трассировки OpenTelemetry с выводом explain. [#63518](https://github.com/ClickHouse/ClickHouse/pull/63518) ([qhsong](https://github.com/qhsong)).
- Добавлена опция проверки существования объекта после записи в Azure Blob Storage, управляемая настройкой `check_objects_after_upload`. [#64847](https://github.com/ClickHouse/ClickHouse/pull/64847) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
- По умолчанию используется база данных `Atomic` в `clickhouse-local`. Решены пункты 1 и 5 из [#50647](https://github.com/ClickHouse/ClickHouse/issues/50647). Закрывает [#44817](https://github.com/ClickHouse/ClickHouse/issues/44817). [#68024](https://github.com/ClickHouse/ClickHouse/pull/68024) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Исключения прерывают протокол HTTP для оповещения клиента об ошибке. [#68800](https://github.com/ClickHouse/ClickHouse/pull/68800) ([Sema Checherinda](https://github.com/CheSema)).
- Отчет о хостах, выполняющих распределенные DDL-запросы, путем создания replica_dir и пометки реплик как активных в DDLWorker. [#69658](https://github.com/ClickHouse/ClickHouse/pull/69658) ([tuanpach](https://github.com/tuanpach)).
- Ожидание только активных реплик для запросов к базе данных ON CLUSTER, если distributed_ddl_output_mode установлен в \*\_only_active. [#69660](https://github.com/ClickHouse/ClickHouse/pull/69660) ([tuanpach](https://github.com/tuanpach)).
- Улучшенная обработка ошибок и отмена резервного копирования и восстановления `ON CLUSTER`: - Если резервное копирование или восстановление завершается неудачей на одном хосте, оно будет автоматически отменено на других хостах - Не должно возникать странных ошибок из-за того, что некоторые хосты завершились неудачей, а другие продолжили работу - Если резервное копирование или восстановление отменено на одном хосте, оно будет автоматически отменено на других хостах - Исправлены проблемы с `test_disallow_concurrency` — теперь отключение параллелизма должно работать лучше - Резервное копирование и восстановление теперь гораздо более устойчивы к отключениям ZooKeeper. [#70027](https://github.com/ClickHouse/ClickHouse/pull/70027) ([Vitaly Baranov](https://github.com/vitlibar)).
- Поддержка `ALTER TABLE ... MODIFY/RESET SETTING ...` для определенных настроек в хранилище S3Queue. [#70811](https://github.com/ClickHouse/ClickHouse/pull/70811) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлена возможность перезагрузки клиентских сертификатов таким же образом, как процедура перезагрузки серверных сертификатов. [#70997](https://github.com/ClickHouse/ClickHouse/pull/70997) ([Roman Antonov](https://github.com/Romeo58rus)).
- Размер истории клиента теперь настраивается, и его размер по умолчанию увеличен. [#71014](https://github.com/ClickHouse/ClickHouse/pull/71014) ([Jiří Kozlovský](https://github.com/jirislav)).
- Поддержка булевых типов для нативного читателя parquet. [#71055](https://github.com/ClickHouse/ClickHouse/pull/71055) ([Arthur Passos](https://github.com/arthurpassos)).
- Повторная попытка при большем количестве ошибок при взаимодействии с S3, таких как «Malformed message». [#71088](https://github.com/ClickHouse/ClickHouse/pull/71088) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Снижен уровень журналирования для некоторых сообщений о S3. [#71090](https://github.com/ClickHouse/ClickHouse/pull/71090) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Поддержка записи файлов HDFS с пробелами. [#71105](https://github.com/ClickHouse/ClickHouse/pull/71105) ([exmy](https://github.com/exmy)).
- Добавлены настройки, ограничивающие количество реплицируемых таблиц, словарей и представлений. [#71179](https://github.com/ClickHouse/ClickHouse/pull/71179) ([Kirill](https://github.com/kirillgarbar)).
- Использование `AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE` вместо `AWS_CONTAINER_AUTHORIZATION_TOKEN`, если первый доступен. Исправляет [#71074](https://github.com/ClickHouse/ClickHouse/issues/71074). [#71269](https://github.com/ClickHouse/ClickHouse/pull/71269) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Удалено создание узла metadata_version ZooKeeper из потока перезапуска ReplicatedMergeTree. Единственный сценарий, когда необходимо создать этот узел, — это когда пользователь обновился с версии ранее 20.4 напрямую до версии позднее 24.10. ClickHouse не поддерживает обновления, охватывающие более года, поэтому следует выбросить исключение и попросить пользователя обновляться постепенно, вместо создания узла. [#71385](https://github.com/ClickHouse/ClickHouse/pull/71385) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Добавлены дашборды для каждого хоста `Overview (host)` и `Cloud overview (host)` в расширенный дашборд. [#71422](https://github.com/ClickHouse/ClickHouse/pull/71422) ([alesapin](https://github.com/alesapin)).
- `clickhouse-local` по умолчанию использует неявный SELECT, что позволяет использовать его как калькулятор. Улучшена подсветка синтаксиса для режима неявного SELECT. [#71620](https://github.com/ClickHouse/ClickHouse/pull/71620) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Приложения командной строки будут подсвечивать синтаксис даже для множественных операторов. [#71622](https://github.com/ClickHouse/ClickHouse/pull/71622) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Приложения командной строки будут возвращать ненулевые коды завершения при ошибках. В предыдущих версиях приложение `disks` возвращало ноль при ошибках, а другие приложения возвращали ноль для ошибок 256 (`PARTITION_ALREADY_EXISTS`) и 512 (`SET_NON_GRANTED_ROLE`). [#71623](https://github.com/ClickHouse/ClickHouse/pull/71623) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Когда пользователь/группа указаны как ID, `clickhouse su` завершается неудачей. Этот патч исправляет это, позволяя также принимать `UID:GID`. [#71626](https://github.com/ClickHouse/ClickHouse/pull/71626) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Разрешено отключение увеличения буфера памяти для кеша файловой системы через настройку `filesystem_cache_prefer_bigger_buffer_size`. [#71640](https://github.com/ClickHouse/ClickHouse/pull/71640) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлена отдельная настройка `background_download_max_file_segment_size` для максимального размера сегмента файла при фоновой загрузке в кеше файловой системы. [#71648](https://github.com/ClickHouse/ClickHouse/pull/71648) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Немного улучшен разбор типов JSON: если текущий блок для пути JSON содержит значения нескольких типов, выполняется попытка выбрать лучший тип путем проверки типов в специальном порядке наилучшего усилия. [#71785](https://github.com/ClickHouse/ClickHouse/pull/71785) ([Pavel Kruglov](https://github.com/Avogar)).
- Ранее чтение из `system.asynchronous_metrics` ожидало завершения параллельного обновления. Это может занять много времени, если система находится под большой нагрузкой. С этим изменением ранее собранные значения всегда можно прочитать. [#71798](https://github.com/ClickHouse/ClickHouse/pull/71798) ([Alexander Gololobov](https://github.com/davenger)).
- S3Queue и AzureQueue: установлено `polling_max_timeout_ms` на 10 минут, `polling_backoff_ms` на 30 секунд. [#71817](https://github.com/ClickHouse/ClickHouse/pull/71817) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Обновление `HostResolver` три раза за период `history`. [#71863](https://github.com/ClickHouse/ClickHouse/pull/71863) ([Sema Checherinda](https://github.com/CheSema)).
- На HTML-странице расширенного дашборда добавлен выпадающий селектор для дашборда из таблицы `system.dashboards`. [#72081](https://github.com/ClickHouse/ClickHouse/pull/72081) ([Sergei Trifonov](https://github.com/serxa)).
- Проверка наличия базы данных по умолчанию после авторизации. Исправляет [#71097](https://github.com/ClickHouse/ClickHouse/issues/71097). [#71140](https://github.com/ClickHouse/ClickHouse/pull/71140) ([Konstantin Bogdanov](https://github.com/thevar1able)).





#### Исправление ошибки (видимое пользователю некорректное поведение в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-1}

- The parts deduplicated during `ATTACH PART` query don't get stuck with the `attaching_` prefix anymore. [#65636](https://github.com/ClickHouse/ClickHouse/pull/65636) ([Kirill](https://github.com/kirillgarbar)).
- Fix for the bug when DateTime64 losing precision for the `IN` function. [#67230](https://github.com/ClickHouse/ClickHouse/pull/67230) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix possible logical error when using functions with `IGNORE/RESPECT NULLS` in `ORDER BY ... WITH FILL`, close [#57609](https://github.com/ClickHouse/ClickHouse/issues/57609). [#68234](https://github.com/ClickHouse/ClickHouse/pull/68234) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Fixed rare logical errors in asynchronous inserts with format `Native` in case of reached memory limit. [#68965](https://github.com/ClickHouse/ClickHouse/pull/68965) ([Anton Popov](https://github.com/CurtizJ)).
- Fix COMMENT in CREATE TABLE for EPHEMERAL column. [#70458](https://github.com/ClickHouse/ClickHouse/pull/70458) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix logical error in JSONExtract with LowCardinality(Nullable). [#70549](https://github.com/ClickHouse/ClickHouse/pull/70549) ([Pavel Kruglov](https://github.com/Avogar)).
- Allow system drop replica zkpath when there is another replica with the same zk path. [#70642](https://github.com/ClickHouse/ClickHouse/pull/70642) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Fix a crash and a leak in AggregateFunctionGroupArraySorted. [#70820](https://github.com/ClickHouse/ClickHouse/pull/70820) ([Michael Kolupaev](https://github.com/al13n321)).
- Add ability to override Content-Type by user headers in the URL engine. [#70859](https://github.com/ClickHouse/ClickHouse/pull/70859) ([Artem Iurin](https://github.com/ortyomka)).
- Fix logical error in `StorageS3Queue` "Cannot create a persistent node in /processed since it already exists". [#70984](https://github.com/ClickHouse/ClickHouse/pull/70984) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fixed named sessions not being closed and hanging on forever under certain circumstances. [#70998](https://github.com/ClickHouse/ClickHouse/pull/70998) ([Márcio Martins](https://github.com/marcio-absmartly)).
- Fix the bug that didn't consider \_row_exists column in rebuild option of projection lightweight delete. [#71089](https://github.com/ClickHouse/ClickHouse/pull/71089) ([Shichao Jin](https://github.com/jsc0218)).
- Fix `AT_* is out of range` problem when running on Oracle Linux UEK 6.10. [#71109](https://github.com/ClickHouse/ClickHouse/pull/71109) ([Örjan Fors](https://github.com/op)).
- Fix wrong value in system.query_metric_log due to unexpected race condition. [#71124](https://github.com/ClickHouse/ClickHouse/pull/71124) ([Pablo Marcos](https://github.com/pamarcos)).
- Fix mismatched aggreage function name of quantileExactWeightedInterpolated. The bug was introduced in https://github.com/ClickHouse/ClickHouse/pull/69619. cc @Algunenano. [#71168](https://github.com/ClickHouse/ClickHouse/pull/71168) ([李扬](https://github.com/taiyang-li)).
- Fix bad_weak_ptr exception with Dynamic in functions comparison. [#71183](https://github.com/ClickHouse/ClickHouse/pull/71183) ([Pavel Kruglov](https://github.com/Avogar)).
- Checks that read 7z file is on a local machine. [#71184](https://github.com/ClickHouse/ClickHouse/pull/71184) ([Daniil Ivanik](https://github.com/divanik)).
- Fix ignoring format settings in Native format via HTTP and Async Inserts. [#71193](https://github.com/ClickHouse/ClickHouse/pull/71193) ([Pavel Kruglov](https://github.com/Avogar)).
- SELECT queries run with setting `use_query_cache = 1` are no longer rejected if the name of a system table appears as a literal, e.g. `SELECT * FROM users WHERE name = 'system.metrics' SETTINGS use_query_cache = true;` now works. [#71254](https://github.com/ClickHouse/ClickHouse/pull/71254) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix bug of memory usage increase if enable_filesystem_cache=1, but disk in storage configuration did not have any cache configuration. [#71261](https://github.com/ClickHouse/ClickHouse/pull/71261) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix possible error "Cannot read all data" erros during deserialization of LowCardinality dictionary from Dynamic column. [#71299](https://github.com/ClickHouse/ClickHouse/pull/71299) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix incomplete cleanup of parallel output format in the client. [#71304](https://github.com/ClickHouse/ClickHouse/pull/71304) ([Raúl Marín](https://github.com/Algunenano)).
- Added missing unescaping in named collections. Without fix clickhouse-server can't start. [#71308](https://github.com/ClickHouse/ClickHouse/pull/71308) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Fix async inserts with empty blocks via native protocol. [#71312](https://github.com/ClickHouse/ClickHouse/pull/71312) ([Anton Popov](https://github.com/CurtizJ)).
- Fix inconsistent AST formatting when granting wrong wildcard grants [#71309](https://github.com/ClickHouse/ClickHouse/issues/71309). [#71332](https://github.com/ClickHouse/ClickHouse/pull/71332) ([pufit](https://github.com/pufit)).
- Add try/catch to data parts destructors to avoid std::terminate. [#71364](https://github.com/ClickHouse/ClickHouse/pull/71364) ([alesapin](https://github.com/alesapin)).
- Check suspicious and experimental types in JSON type hints. [#71369](https://github.com/ClickHouse/ClickHouse/pull/71369) ([Pavel Kruglov](https://github.com/Avogar)).
- Start memory worker thread on non-Linux OS too (fixes [#71051](https://github.com/ClickHouse/ClickHouse/issues/71051)). [#71384](https://github.com/ClickHouse/ClickHouse/pull/71384) ([Alexandre Snarskii](https://github.com/snar)).
- Fix error Invalid number of rows in Chunk with the Variant column. [#71388](https://github.com/ClickHouse/ClickHouse/pull/71388) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix error column "attgenerated" does not exist for older PostgreSQL versions, fix [#60651](https://github.com/ClickHouse/ClickHouse/issues/60651). [#71396](https://github.com/ClickHouse/ClickHouse/pull/71396) ([0xMihalich](https://github.com/0xMihalich)).
- To avoid spamming the server logs, failing authentication attempts are now logged at level `DEBUG` instead of `ERROR`. [#71405](https://github.com/ClickHouse/ClickHouse/pull/71405) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix crash in `mongodb` table function when passing wrong arguments (e.g. `NULL`). [#71426](https://github.com/ClickHouse/ClickHouse/pull/71426) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Fix crash with optimize_rewrite_array_exists_to_has. [#71432](https://github.com/ClickHouse/ClickHouse/pull/71432) ([Raúl Marín](https://github.com/Algunenano)).
- Fixed the usage of setting `max_insert_delayed_streams_for_parallel_write` in inserts. Previously it worked incorrectly which could lead to high memory usage in inserts which write data into several partitions. [#71474](https://github.com/ClickHouse/ClickHouse/pull/71474) ([Anton Popov](https://github.com/CurtizJ)).
- Fix possible error `Argument for function must be constant` (old analyzer) in case when arrayJoin can apparently appear in `WHERE` condition. Regression after https://github.com/ClickHouse/ClickHouse/pull/65414. [#71476](https://github.com/ClickHouse/ClickHouse/pull/71476) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Prevent crash in SortCursor with 0 columns (old analyzer). [#71494](https://github.com/ClickHouse/ClickHouse/pull/71494) ([Raúl Marín](https://github.com/Algunenano)).
- Fix Date32 out of range caused by uninitialized ORC data. For more details, refer to https://github.com/apache/incubator-gluten/issues/7823. [#71500](https://github.com/ClickHouse/ClickHouse/pull/71500) ([李扬](https://github.com/taiyang-li)).
- Fix counting column size in wide part for Dynamic and JSON types. [#71526](https://github.com/ClickHouse/ClickHouse/pull/71526) ([Pavel Kruglov](https://github.com/Avogar)).
- Analyzer fix when query inside materialized view uses IN with CTE. Closes [#65598](https://github.com/ClickHouse/ClickHouse/issues/65598). [#71538](https://github.com/ClickHouse/ClickHouse/pull/71538) ([Maksim Kita](https://github.com/kitaisreal)).
- Avoid crash when using a UDF in a constraint. [#71541](https://github.com/ClickHouse/ClickHouse/pull/71541) ([Raúl Marín](https://github.com/Algunenano)).
- Return 0 or default char instead of throwing an error in bitShift functions in case of out of bounds. [#71580](https://github.com/ClickHouse/ClickHouse/pull/71580) ([Pablo Marcos](https://github.com/pamarcos)).
- Fix server crashes while using materialized view with certain engines. [#71593](https://github.com/ClickHouse/ClickHouse/pull/71593) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
- Array join with a nested data structure, which contains an alias to a constant array was leading to a null pointer dereference. This closes [#71677](https://github.com/ClickHouse/ClickHouse/issues/71677). [#71678](https://github.com/ClickHouse/ClickHouse/pull/71678) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix LOGICAL_ERROR when doing ALTER with empty tuple. This fixes [#71647](https://github.com/ClickHouse/ClickHouse/issues/71647). [#71679](https://github.com/ClickHouse/ClickHouse/pull/71679) ([Amos Bird](https://github.com/amosbird)).
- Don't transform constant set in predicates over partition columns in case of NOT IN operator. [#71695](https://github.com/ClickHouse/ClickHouse/pull/71695) ([Eduard Karacharov](https://github.com/korowa)).
- Fix docker init script fail log message for more clean understanding. [#71734](https://github.com/ClickHouse/ClickHouse/pull/71734) ([Андрей](https://github.com/andreineustroev)).
- Fix CAST from LowCardinality(Nullable) to Dynamic. Previously it could lead to error `Bad cast from type DB::ColumnVector<int> to DB::ColumnNullable`. [#71742](https://github.com/ClickHouse/ClickHouse/pull/71742) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix exception for toDayOfWeek on WHERE condition with primary key of DateTime64 type. [#71849](https://github.com/ClickHouse/ClickHouse/pull/71849) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fixed filling of defaults after parsing into sparse columns. [#71854](https://github.com/ClickHouse/ClickHouse/pull/71854) ([Anton Popov](https://github.com/CurtizJ)).
- Fix GROUPING function error when input is ALIAS on distributed table, close [#68602](https://github.com/ClickHouse/ClickHouse/issues/68602). [#71855](https://github.com/ClickHouse/ClickHouse/pull/71855) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Fix possible crash when using `allow_experimental_join_condition`, close [#71693](https://github.com/ClickHouse/ClickHouse/issues/71693). [#71857](https://github.com/ClickHouse/ClickHouse/pull/71857) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Fixed select statements that use `WITH TIES` clause which might not return enough rows. [#71886](https://github.com/ClickHouse/ClickHouse/pull/71886) ([wxybear](https://github.com/wxybear)).
- Fix the TOO_LARGE_ARRAY_SIZE exception caused when a column of arrayWithConstant evaluation is mistaken to cross the array size limit. [#71894](https://github.com/ClickHouse/ClickHouse/pull/71894) ([Udi](https://github.com/udiz)).
- `clickhouse-benchmark` reported wrong metrics for queries taking longer than one second. [#71898](https://github.com/ClickHouse/ClickHouse/pull/71898) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix data race between the progress indicator and the progress table in clickhouse-client. This issue is visible when FROM INFILE is used. Intercept keystrokes during INSERT queries to toggle progress table display. [#71901](https://github.com/ClickHouse/ClickHouse/pull/71901) ([Julia Kartseva](https://github.com/jkartseva)).
- Use auxiliary keepers for cluster autodiscovery. [#71911](https://github.com/ClickHouse/ClickHouse/pull/71911) ([Anton Ivashkin](https://github.com/ianton-ru)).
- Fix rows_processed column in system.s3/azure_queue_log broken in 24.6. Closes [#69975](https://github.com/ClickHouse/ClickHouse/issues/69975). [#71946](https://github.com/ClickHouse/ClickHouse/pull/71946) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fixed case when `s3`/`s3Cluster` functions could return incomplete result or throw an exception. It involved using glob pattern in s3 uri (like `pattern/*`) and an empty object should exist with the key `pattern/` (such objects automatically created by S3 Console). Also default value for setting `s3_skip_empty_files` changed from `false` to `true` by default. [#71947](https://github.com/ClickHouse/ClickHouse/pull/71947) ([Nikita Taranov](https://github.com/nickitat)).
- Fix a crash in clickhouse-client syntax highlighting. Closes [#71864](https://github.com/ClickHouse/ClickHouse/issues/71864). [#71949](https://github.com/ClickHouse/ClickHouse/pull/71949) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix `Illegal type` error for `MergeTree` tables with binary monotonic function in `ORDER BY` when the first argument is constant. Fixes [#71941](https://github.com/ClickHouse/ClickHouse/issues/71941). [#71966](https://github.com/ClickHouse/ClickHouse/pull/71966) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Allow only SELECT queries in EXPLAIN AST used inside subquery. Other types of queries lead to logical error: 'Bad cast from type DB::ASTCreateQuery to DB::ASTSelectWithUnionQuery' or `Inconsistent AST formatting`. [#71982](https://github.com/ClickHouse/ClickHouse/pull/71982) ([Pavel Kruglov](https://github.com/Avogar)).
- When insert a record by `clickhouse-client`, client will read column descriptions from server. but there was a bug that we wrote the descritions with a wrong order , it should be [statistics, ttl, settings]. [#71991](https://github.com/ClickHouse/ClickHouse/pull/71991) ([Han Fei](https://github.com/hanfei1991)).
- Fix formatting of `MOVE PARTITION ... TO TABLE ...` alter commands when `format_alter_commands_with_parentheses` is enabled. [#72080](https://github.com/ClickHouse/ClickHouse/pull/72080) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fixes RIGHT / FULL joins in queries with parallel replicas. Now, RIGHT joins can be executed with parallel replicas (right table reading is distributed). FULL joins can't be parallelized among nodes, - executed locally. [#71162](https://github.com/ClickHouse/ClickHouse/pull/71162) ([Igor Nikonov](https://github.com/devcrafter)).
- Fix the issue where ClickHouse in Docker containers printed "get_mempolicy: Operation not permitted" into stderr due to restricted syscalls. [#70900](https://github.com/ClickHouse/ClickHouse/pull/70900) ([filimonov](https://github.com/filimonov)).
- Fix the metadata_version record in ZooKeeper in restarting thread rather than in attach thread. [#70297](https://github.com/ClickHouse/ClickHouse/pull/70297) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- This is a fix for "zero-copy" replication, which is unsupported and will be removed entirely. Don't delete a blob when there are nodes using it in ReplicatedMergeTree with zero-copy replication. [#71186](https://github.com/ClickHouse/ClickHouse/pull/71186) ([Antonio Andelic](https://github.com/antonio2368)).
- This is a fix for "zero-copy" replication, which is unsupported and will be removed entirely. Acquiring zero-copy shared lock before moving a part to zero-copy disk to prevent possible data loss if Keeper is unavailable. [#71845](https://github.com/ClickHouse/ClickHouse/pull/71845) ([Aleksei Filatov](https://github.com/aalexfvk)).

### <a id="2410"></a> ClickHouse release 24.10, 2024-10-31 {#a-id2410a-clickhouse-release-2410-2024-10-31}

#### Обратно несовместимые изменения {#backward-incompatible-change-2}

- Разрешено указывать `SETTINGS` перед `FORMAT` в цепочке запросов с `UNION`, когда подзапросы находятся внутри скобок. Это закрывает [#39712](https://github.com/ClickHouse/ClickHouse/issues/39712). Изменено поведение, когда в запросе секция SETTINGS указана дважды подряд. Ближайшая секция SETTINGS будет иметь приоритет для соответствующего подзапроса. В предыдущих версиях внешняя секция SETTINGS могла иметь приоритет над внутренней. [#68614](https://github.com/ClickHouse/ClickHouse/pull/68614) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Изменение порядка условий фильтрации из секции `[PRE]WHERE` теперь разрешено по умолчанию. Это можно отключить, установив `allow_reorder_prewhere_conditions` в `false`. [#70657](https://github.com/ClickHouse/ClickHouse/pull/70657) ([Nikita Taranov](https://github.com/nickitat)).
- Удалена библиотека `idxd-config`, имеющая несовместимую лицензию. Это также удаляет экспериментальный кодек Intel DeflateQPL. [#70987](https://github.com/ClickHouse/ClickHouse/pull/70987) ([Alexey Milovidov](https://github.com/alexey-milovidov)).


#### Новая функциональность {#new-feature-2}

- Добавлена возможность предоставлять доступ к префиксам с подстановочными знаками. `GRANT SELECT ON db.table_pefix_* TO user`. [#65311](https://github.com/ClickHouse/ClickHouse/pull/65311) ([pufit](https://github.com/pufit)).
- При нажатии клавиши пробела во время выполнения запроса клиент отображает таблицу с подробными метриками в реальном времени. Эту функцию можно включить глобально с помощью новой опции `--progress-table` в clickhouse-client; новая опция `--enable-progress-table-toggle` связана с опцией `--progress-table` и переключает отображение таблицы прогресса при нажатии управляющей клавиши (пробел). [#63689](https://github.com/ClickHouse/ClickHouse/pull/63689) ([Maria Khristenko](https://github.com/mariaKhr)), [#70423](https://github.com/ClickHouse/ClickHouse/pull/70423) ([Julia Kartseva](https://github.com/jkartseva)).
- Добавлена возможность кэшировать прочитанные файлы для движков таблиц объектного хранилища и озёр данных, используя хеш от ETag + путь к файлу в качестве ключа кэша. [#70135](https://github.com/ClickHouse/ClickHouse/pull/70135) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлена поддержка создания таблицы с помощью запроса: `CREATE TABLE ... CLONE AS ...`. Клонирует схему исходной таблицы, а затем присоединяет все партиции к вновь созданной таблице. Эта функция поддерживается только для таблиц семейства `MergeTree`. Закрывает [#65015](https://github.com/ClickHouse/ClickHouse/issues/65015). [#69091](https://github.com/ClickHouse/ClickHouse/pull/69091) ([tuanpach](https://github.com/tuanpach)).
- Добавлена новая системная таблица `system.query_metric_log`, которая содержит историю значений памяти и метрик из таблицы system.events для отдельных запросов, периодически сбрасываемых на диск. [#66532](https://github.com/ClickHouse/ClickHouse/pull/66532) ([Pablo Marcos](https://github.com/pamarcos)).
- Простой запрос SELECT можно записать с неявным SELECT для использования выражений в стиле калькулятора, например, `ch "1 + 2"`. Это управляется новой настройкой `implicit_select`. [#68502](https://github.com/ClickHouse/ClickHouse/pull/68502) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлена поддержка режима `--copy` для clickhouse local в качестве сокращения для преобразования форматов [#68503](https://github.com/ClickHouse/ClickHouse/issues/68503). [#68583](https://github.com/ClickHouse/ClickHouse/pull/68583) ([Denis Hananein](https://github.com/denis-hananein)).
- Добавлена встроенная HTML-страница для визуализации слияний, доступная по пути `/merges`. [#70821](https://github.com/ClickHouse/ClickHouse/pull/70821) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлена поддержка функции `arrayUnion`. [#68989](https://github.com/ClickHouse/ClickHouse/pull/68989) ([Peter Nguyen](https://github.com/petern48)).
- Добавлена поддержка параметризованных SQL-псевдонимов. [#50665](https://github.com/ClickHouse/ClickHouse/pull/50665) ([Anton Kozlov](https://github.com/tonickkozlov)).
- Новая агрегатная функция `quantileExactWeightedInterpolated`, которая является интерполированной версией на основе quantileExactWeighted. Некоторые могут задаться вопросом, зачем нужна новая функция `quantileExactWeightedInterpolated`, если у нас уже есть `quantileExactInterpolatedWeighted`. Причина в том, что новая функция более точная, чем старая. Это сделано для совместимости со Spark. [#69619](https://github.com/ClickHouse/ClickHouse/pull/69619) ([李扬](https://github.com/taiyang-li)).
- Новая функция `arrayElementOrNull`. Возвращает `NULL`, если индекс массива выходит за пределы диапазона или ключ Map не найден. [#69646](https://github.com/ClickHouse/ClickHouse/pull/69646) ([李扬](https://github.com/taiyang-li)).
- Добавлена возможность указывать регулярные выражения через новые поля `message_regexp` и `message_regexp_negative` в файле `config.xml` для фильтрации логирования. Логирование применяется к форматированному тексту без цветового оформления для наиболее интуитивного опыта разработчика. [#69657](https://github.com/ClickHouse/ClickHouse/pull/69657) ([Peter Nguyen](https://github.com/petern48)).
- Добавлена функция `RIPEMD160`, которая вычисляет криптографический хеш RIPEMD-160 строки. Пример: `SELECT HEX(RIPEMD160('The quick brown fox jumps over the lazy dog'))` возвращает `37F332F68DB77BD9D7EDD4969571AD671CF9DD3B`. [#70087](https://github.com/ClickHouse/ClickHouse/pull/70087) ([Dergousov Maxim](https://github.com/m7kss1)).
- Добавлена поддержка чтения таблиц `Iceberg` на `HDFS`. [#70268](https://github.com/ClickHouse/ClickHouse/pull/70268) ([flynn](https://github.com/ucasfl)).
- Добавлена поддержка CTE в форме `WITH ... INSERT`, поскольку ранее поддерживалась только форма `INSERT ... WITH ...`. [#70593](https://github.com/ClickHouse/ClickHouse/pull/70593) ([Shichao Jin](https://github.com/jsc0218)).
- Интеграция с MongoDB: поддержка всех типов MongoDB, поддержка операторов WHERE и ORDER BY на стороне MongoDB, ограничение для выражений, не поддерживаемых MongoDB. Обратите внимание, что новая интеграция по умолчанию отключена, для её использования установите `<use_legacy_mongodb_integration>` в значение `false` в конфигурации сервера. [#63279](https://github.com/ClickHouse/ClickHouse/pull/63279) ([Kirill Nikiforov](https://github.com/allmazz)).
- Добавлена новая функция `getSettingOrDefault` для возврата значения по умолчанию и предотвращения исключения, если пользовательская настройка не найдена в текущем профиле. [#69917](https://github.com/ClickHouse/ClickHouse/pull/69917) ([Shankar](https://github.com/shiyer7474)).

#### Экспериментальная функциональность {#experimental-feature-1}

- Обновляемые материализованные представления готовы к использованию в production. [#70550](https://github.com/ClickHouse/ClickHouse/pull/70550) ([Michael Kolupaev](https://github.com/al13n321)). Обновляемые материализованные представления теперь поддерживаются в реплицируемых базах данных. [#60669](https://github.com/ClickHouse/ClickHouse/pull/60669) ([Michael Kolupaev](https://github.com/al13n321)).
- Параллельные реплики переведены из экспериментального статуса в бета-версию. Переработаны настройки, управляющие поведением алгоритмов параллельных реплик. Краткое резюме: ClickHouse имеет четыре различных алгоритма параллельного чтения с использованием нескольких реплик, что отражено в настройке `parallel_replicas_mode`, значение по умолчанию — `read_tasks`. Дополнительно добавлена настройка-переключатель `enable_parallel_replicas`. [#63151](https://github.com/ClickHouse/ClickHouse/pull/63151) ([Alexey Milovidov](https://github.com/alexey-milovidov)), ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Поддержка типа `Dynamic` в большинстве функций путём их выполнения на внутренних типах внутри `Dynamic`. [#69691](https://github.com/ClickHouse/ClickHouse/pull/69691) ([Pavel Kruglov](https://github.com/Avogar)).
- Разрешено чтение/запись типа `JSON` как бинарной строки в формате `RowBinary` при использовании настроек `input_format_binary_read_json_as_string/output_format_binary_write_json_as_string`. [#70288](https://github.com/ClickHouse/ClickHouse/pull/70288) ([Pavel Kruglov](https://github.com/Avogar)).
- Разрешена сериализация/десериализация колонки `JSON` как единой колонки типа String в формате Native. Для вывода используйте настройку `output_format_native_write_json_as_string`. Для ввода используйте версию сериализации `1` перед данными колонки. [#70312](https://github.com/ClickHouse/ClickHouse/pull/70312) ([Pavel Kruglov](https://github.com/Avogar)).
- Введён специальный (экспериментальный) режим селектора слияний для таблиц MergeTree, который делает его более агрессивным для партиций, близких к лимиту по количеству кусков. Управляется настройкой уровня MergeTree `merge_selector_use_blurry_base`. [#70645](https://github.com/ClickHouse/ClickHouse/pull/70645) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Реализована универсальная сериализация/десериализация между типами `Union` в Avro и `Variant` в ClickHouse. Решает [#69713](https://github.com/ClickHouse/ClickHouse/issues/69713). [#69712](https://github.com/ClickHouse/ClickHouse/pull/69712) ([Jiří Kozlovský](https://github.com/jirislav)).


#### Улучшение производительности {#performance-improvement-2}

- Рефакторинг `IDisk` и `IObjectStorage` для повышения производительности. Таблицы из объектных хранилищ `plain` и `plain_rewritable` инициализируются быстрее. [#68146](https://github.com/ClickHouse/ClickHouse/pull/68146) ([Alexey Milovidov](https://github.com/alexey-milovidov), [Julia Kartseva](https://github.com/jkartseva)). Отказ от вызова API LIST объектного хранилища при определении существования файла или каталога на диске plain rewritable, поскольку это может быть затратно. [#70852](https://github.com/ClickHouse/ClickHouse/pull/70852) ([Julia Kartseva](https://github.com/jkartseva)). Сокращение количества запросов HEAD API объектного хранилища на диске plain_rewritable. [#70915](https://github.com/ClickHouse/ClickHouse/pull/70915) ([Julia Kartseva](https://github.com/jkartseva)).
- Добавлена возможность парсинга данных непосредственно в разреженные столбцы. [#69828](https://github.com/ClickHouse/ClickHouse/pull/69828) ([Anton Popov](https://github.com/CurtizJ)).
- Улучшена производительность парсинга форматов с большим количеством пропущенных значений (например, `JSONEachRow`). [#69875](https://github.com/ClickHouse/ClickHouse/pull/69875) ([Anton Popov](https://github.com/CurtizJ)).
- Поддержка параллельного чтения групп строк Parquet и предварительной загрузки групп строк в однопоточном режиме. [#69862](https://github.com/ClickHouse/ClickHouse/pull/69862) ([LiuNeng](https://github.com/liuneng1994)).
- Поддержка индекса minmax для `pointInPolygon`. [#62085](https://github.com/ClickHouse/ClickHouse/pull/62085) ([JackyWoo](https://github.com/JackyWoo)).
- Использование фильтров Блума при чтении файлов Parquet. [#62966](https://github.com/ClickHouse/ClickHouse/pull/62966) ([Arthur Passos](https://github.com/arthurpassos)).
- Переименование частей без блокировок для предотвращения влияния INSERT на SELECT (из-за блокировки частей) (при нормальных условиях с `fsync_part_directory` QPS для SELECT с параллельным INSERT увеличивается в 2 раза, при высокой нагрузке эффект ещё больше). Примечание: на данный момент это касается только `ReplicatedMergeTree`. [#64955](https://github.com/ClickHouse/ClickHouse/pull/64955) ([Azat Khuzhin](https://github.com/azat)).
- Учёт `ttl_only_drop_parts` при выполнении `materialize ttl`; чтение только необходимых столбцов для пересчёта TTL и удаление частей путём замены их на пустые. [#65488](https://github.com/ClickHouse/ClickHouse/pull/65488) ([Andrey Zvonov](https://github.com/zvonand)).
- Оптимизировано создание потоков в ThreadPool для минимизации конкуренции за блокировки. Создание потоков теперь выполняется вне критической секции, чтобы избежать задержек в планировании задач и управлении потоками при высокой нагрузке. Это обеспечивает значительно более отзывчивую работу ClickHouse при интенсивной параллельной нагрузке. [#68694](https://github.com/ClickHouse/ClickHouse/pull/68694) ([filimonov](https://github.com/filimonov)).
- Включено чтение строковых столбцов `LowCardinality` из `ORC`. [#69481](https://github.com/ClickHouse/ClickHouse/pull/69481) ([李扬](https://github.com/taiyang-li)).
- Использование `LowCardinality` для `ProfileEvents` в системных логах, таких как `part_log`, `query_views_log`, `filesystem_cache_log`. [#70152](https://github.com/ClickHouse/ClickHouse/pull/70152) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Улучшена производительность функций `fromUnixTimestamp`/`toUnixTimestamp`. [#71042](https://github.com/ClickHouse/ClickHouse/pull/71042) ([kevinyhzou](https://github.com/KevinyhZou)).
- Отказ от отключения неблокирующего чтения из кэша страниц для всего сервера при чтении из блокирующего I/O. Это приводило к снижению производительности, когда одна файловая система (например, tmpfs) не поддерживала системный вызов `preadv2`, в то время как другие поддерживали. [#70299](https://github.com/ClickHouse/ClickHouse/pull/70299) ([Antonio Andelic](https://github.com/antonio2368)).
- `ALTER TABLE .. REPLACE PARTITION` больше не ожидает завершения мутаций/слияний, происходящих в других партициях. [#59138](https://github.com/ClickHouse/ClickHouse/pull/59138) ([Vasily Nemkov](https://github.com/Enmk)).
- Отказ от валидации при синхронизации ACL из Keeper. Валидация выполняется при создании. Это не должно иметь большого значения, но существуют установки с десятками тысяч или даже большим количеством созданных пользователей, и ненужная валидация хэшей может занимать много времени при запуске сервера (он синхронизирует всё из Keeper). [#70644](https://github.com/ClickHouse/ClickHouse/pull/70644) ([Raúl Marín](https://github.com/Algunenano)).





#### Улучшение {#improvement-2}

- `CREATE TABLE AS` будет копировать `PRIMARY KEY`, `ORDER BY` и аналогичные конструкции (для таблиц `MergeTree`). [#69739](https://github.com/ClickHouse/ClickHouse/pull/69739) ([sakulali](https://github.com/sakulali)).
- Поддержка 64-битного XID в Keeper. Включается с помощью параметра конфигурации `use_xid_64`. [#69908](https://github.com/ClickHouse/ClickHouse/pull/69908) ([Antonio Andelic](https://github.com/antonio2368)).
- Аргументы командной строки для булевых настроек устанавливаются в true, если значение для аргумента не указано (например, `clickhouse-client --optimize_aggregation_in_order --query "SELECT 1"`). [#70459](https://github.com/ClickHouse/ClickHouse/pull/70459) ([davidtsuk](https://github.com/davidtsuk)).
- Добавлены пользовательские настройки `min_free_disk_bytes_to_perform_insert` и `min_free_disk_perform_to_throw_insert` для предотвращения вставок на почти заполненные диски. [#69755](https://github.com/ClickHouse/ClickHouse/pull/69755) ([Marco Vilas Boas](https://github.com/marco-vb)).
- Встроенная документация для настроек будет строго более детальной и полной, чем документация на веб-сайте. Это первый шаг к тому, чтобы документация на веб-сайте всегда автоматически генерировалась из исходного кода. Это имеет долгосрочные последствия: - гарантируется наличие каждой настройки; - исключается возможность устаревания значений по умолчанию; - можно генерировать документацию для каждой версии ClickHouse; - документация может отображаться самим сервером даже без доступа к Интернету. Генерация документации на веб-сайте из исходного кода. [#70289](https://github.com/ClickHouse/ClickHouse/pull/70289) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Разрешена пустая подстрока для поиска в функции `replace`, аналогично поведению PostgreSQL. [#69918](https://github.com/ClickHouse/ClickHouse/pull/69918) ([zhanglistar](https://github.com/zhanglistar)).
- Разрешена пустая подстрока для поиска в функциях `replaceRegexp*`. [#70053](https://github.com/ClickHouse/ClickHouse/pull/70053) ([zhanglistar](https://github.com/zhanglistar)).
- Символические ссылки для таблиц в директории `data/database_name/` создаются для фактических путей к данным таблицы в зависимости от политики хранения, а не для директории `store/...` на диске по умолчанию. [#61777](https://github.com/ClickHouse/ClickHouse/pull/61777) ([Kirill](https://github.com/kirillgarbar)).
- При разборе поля `Enum` из `JSON` строка, содержащая целое число, будет интерпретироваться как соответствующий элемент `Enum`. Закрывает [#65119](https://github.com/ClickHouse/ClickHouse/issues/65119). [#66801](https://github.com/ClickHouse/ClickHouse/pull/66801) ([scanhex12](https://github.com/scanhex12)).
- Разрешено использование `TRIM` с `LEADING` или `TRAILING` для пустой строки как операции без действия. Закрывает [#67792](https://github.com/ClickHouse/ClickHouse/issues/67792). [#68455](https://github.com/ClickHouse/ClickHouse/pull/68455) ([Peter Nguyen](https://github.com/petern48)).
- Улучшена совместимость `cast(timestamp as String)` со Spark. [#69179](https://github.com/ClickHouse/ClickHouse/pull/69179) ([Wenzheng Liu](https://github.com/lwz9103)).
- Новый анализатор всегда используется для вычисления константных выражений, когда `enable_analyzer` установлен в `true`. Поддержка вычисления аргументов табличной функции `executable` без использования запроса `SELECT` для константных выражений. [#69292](https://github.com/ClickHouse/ClickHouse/pull/69292) ([Dmitry Novik](https://github.com/novikd)).
- Добавлена настройка `enable_secure_identifiers` для запрета идентификаторов со специальными символами. [#69411](https://github.com/ClickHouse/ClickHouse/pull/69411) ([tuanpach](https://github.com/tuanpach)).
- Добавлена настройка `show_create_query_identifier_quoting_rule` для определения поведения заключения идентификаторов в кавычки в результате запроса `SHOW CREATE TABLE`. Возможные значения: - `user_display`: когда идентификатор является ключевым словом. - `when_necessary`: когда идентификатор является одним из `{"distinct", "all", "table"}` и когда это может привести к неоднозначности: имена столбцов, имена атрибутов словаря. - `always`: всегда заключать идентификаторы в кавычки. [#69448](https://github.com/ClickHouse/ClickHouse/pull/69448) ([tuanpach](https://github.com/tuanpach)).
- Улучшено восстановление зависимостей сущностей доступа [#69563](https://github.com/ClickHouse/ClickHouse/pull/69563) ([Vitaly Baranov](https://github.com/vitlibar)).
- Если вы запускаете `clickhouse-client` или другое CLI-приложение, и оно запускается медленно из-за перегруженного сервера, и вы начинаете вводить свой запрос, например `SELECT`, предыдущие версии отображали остаток содержимого эха терминала перед выводом приветственного сообщения, например `SELECTClickHouse local version 24.10.1.1.` вместо `ClickHouse local version 24.10.1.1.`. Теперь это исправлено. Закрывает [#31696](https://github.com/ClickHouse/ClickHouse/issues/31696). [#69856](https://github.com/ClickHouse/ClickHouse/pull/69856) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлен новый столбец `readonly_duration` в таблицу `system.replicas`. Необходим для различения фактических реплик только для чтения от сторожевых в оповещениях. [#69871](https://github.com/ClickHouse/ClickHouse/pull/69871) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Изменен тип настройки `join_output_by_rowlist_perkey_rows_threshold` на беззнаковое целое число. [#69886](https://github.com/ClickHouse/ClickHouse/pull/69886) ([kevinyhzou](https://github.com/KevinyhZou)).
- Улучшено логирование span OpenTelemetry для включения настроек запроса. [#70011](https://github.com/ClickHouse/ClickHouse/pull/70011) ([sharathks118](https://github.com/sharathks118)).
- Добавлена диагностическая информация о функциях массивов высшего порядка, если тип результата лямбда-функции неожиданный. [#70093](https://github.com/ClickHouse/ClickHouse/pull/70093) ([ttanay](https://github.com/ttanay)).
- Улучшение Keeper: меньше блокировок при изменениях кластера. [#70275](https://github.com/ClickHouse/ClickHouse/pull/70275) ([Antonio Andelic](https://github.com/antonio2368)).
- Добавлены ключевые слова `WITH IMPLICIT` и `FINAL` в команду `SHOW GRANTS`. Исправлена незначительная ошибка с неявными привилегиями: [#70094](https://github.com/ClickHouse/ClickHouse/issues/70094). [#70293](https://github.com/ClickHouse/ClickHouse/pull/70293) ([pufit](https://github.com/pufit)).
- Учет настройки `compatibility` для настроек MergeTree. Значение `compatibility` берется из профиля `default` при запуске сервера, и настройки MergeTree по умолчанию изменяются соответственно. Дальнейшие изменения настройки `compatibility` не влияют на настройки MergeTree. [#70322](https://github.com/ClickHouse/ClickHouse/pull/70322) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Предотвращение засорения логов большими телами HTTP-ответов в случае ошибок при межсерверном взаимодействии. [#70487](https://github.com/ClickHouse/ClickHouse/pull/70487) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Добавлена новая настройка `max_parts_to_move` для контроля максимального количества частей, которые могут быть перемещены за один раз. [#70520](https://github.com/ClickHouse/ClickHouse/pull/70520) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Ограничена частота определенных сообщений в логах. [#70601](https://github.com/ClickHouse/ClickHouse/pull/70601) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- `CHECK TABLE` с квалификатором `PART` был неправильно отформатирован в клиенте. [#70660](https://github.com/ClickHouse/ClickHouse/pull/70660) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Поддержка записи индекса столбцов и индекса смещений с использованием нативного writer Parquet. [#70669](https://github.com/ClickHouse/ClickHouse/pull/70669) ([LiuNeng](https://github.com/liuneng1994)).
- Поддержка разбора `DateTime64` для микросекунд и часового пояса в синтаксисе joda ("joda" — популярная библиотека Java для работы с датой и временем, а "синтаксис joda" — стиль этой библиотеки). [#70737](https://github.com/ClickHouse/ClickHouse/pull/70737) ([kevinyhzou](https://github.com/KevinyhZou)).
- Изменен подход к определению того, поддерживает ли облачное хранилище [пакетное удаление](https://docs.aws.amazon.com/AmazonS3/latest/API/API_DeleteObjects.html). [#70786](https://github.com/ClickHouse/ClickHouse/pull/70786) ([Vitaly Baranov](https://github.com/vitlibar)).
- Поддержка Parquet page v2 в нативном reader. [#70807](https://github.com/ClickHouse/ClickHouse/pull/70807) ([Arthur Passos](https://github.com/arthurpassos)).
- Проверка, установлены ли у таблицы одновременно `storage_policy` и `disk`. Добавлена проверка совместимости новой политики хранения со старой при использовании настройки `disk`. [#70839](https://github.com/ClickHouse/ClickHouse/pull/70839) ([Kirill](https://github.com/kirillgarbar)).
- Добавлены `system.s3_queue_settings` и `system.azure_queue_settings`. [#70841](https://github.com/ClickHouse/ClickHouse/pull/70841) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Функции `base58Encode` и `base58Decode` теперь принимают аргументы типа `FixedString`. Пример: `SELECT base58Encode(toFixedString('plaintext', 9));`. [#70846](https://github.com/ClickHouse/ClickHouse/pull/70846) ([Faizan Patel](https://github.com/faizan2786)).
- Добавлен столбец `partition` для каждого типа записи в логе частей. Ранее он устанавливался только для некоторых записей. Закрывает [#70819](https://github.com/ClickHouse/ClickHouse/issues/70819). [#70848](https://github.com/ClickHouse/ClickHouse/pull/70848) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлены события `MergeStart` и `MutateStart` в `system.part_log`, что помогает с анализом и визуализацией слияний. [#70850](https://github.com/ClickHouse/ClickHouse/pull/70850) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлено событие профиля о количестве объединенных исходных частей. Позволяет отслеживать разветвление дерева слияний в продакшене. [#70908](https://github.com/ClickHouse/ClickHouse/pull/70908) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Фоновые загрузки в кеш файловой системы снова включены. [#70929](https://github.com/ClickHouse/ClickHouse/pull/70929) ([Nikita Taranov](https://github.com/nickitat)).
- Добавлен новый алгоритм выбора слияний `Trivial`, только для профессионального использования. Он хуже, чем селектор слияний `Simple`. [#70969](https://github.com/ClickHouse/ClickHouse/pull/70969) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Поддержка атомарного `CREATE OR REPLACE VIEW`. [#70536](https://github.com/ClickHouse/ClickHouse/pull/70536) ([tuanpach](https://github.com/tuanpach))
- Добавлен режим `strict_once` для агрегатной функции `windowFunnel`, чтобы избежать подсчета одного события несколько раз в случае, если оно соответствует нескольким условиям, закрывает [#21835](https://github.com/ClickHouse/ClickHouse/issues/21835). [#69738](https://github.com/ClickHouse/ClickHouse/pull/69738) ([Vladimir Cherkasov](https://github.com/vdimir)).





#### Исправление ошибки (видимое пользователю некорректное поведение в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-2}

- Apply configuration updates in global context object. It fixes issues like [#62308](https://github.com/ClickHouse/ClickHouse/issues/62308). [#62944](https://github.com/ClickHouse/ClickHouse/pull/62944) ([Amos Bird](https://github.com/amosbird)).
- Fix `ReadSettings` not using user set values, because defaults were only used. [#65625](https://github.com/ClickHouse/ClickHouse/pull/65625) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix type mismatch issue in `sumMapFiltered` when using signed arguments. [#58408](https://github.com/ClickHouse/ClickHouse/pull/58408) ([Chen768959](https://github.com/Chen768959)).
- Fix toHour-like conversion functions' monotonicity when optional time zone argument is passed. [#60264](https://github.com/ClickHouse/ClickHouse/pull/60264) ([Amos Bird](https://github.com/amosbird)).
- Relax `supportsPrewhere` check for `Merge` tables. This fixes [#61064](https://github.com/ClickHouse/ClickHouse/issues/61064). It was hardened unnecessarily in [#60082](https://github.com/ClickHouse/ClickHouse/issues/60082). [#61091](https://github.com/ClickHouse/ClickHouse/pull/61091) ([Amos Bird](https://github.com/amosbird)).
- Fix `use_concurrency_control` setting handling for proper `concurrent_threads_soft_limit_num` limit enforcing. This enables concurrency control by default because previously it was broken. [#61473](https://github.com/ClickHouse/ClickHouse/pull/61473) ([Sergei Trifonov](https://github.com/serxa)).
- Fix incorrect `JOIN ON` section optimization in case of `IS NULL` check under any other function (like `NOT`) that may lead to wrong results. Closes [#67915](https://github.com/ClickHouse/ClickHouse/issues/67915). [#68049](https://github.com/ClickHouse/ClickHouse/pull/68049) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Prevent `ALTER` queries that would make the `CREATE` query of tables invalid. [#68574](https://github.com/ClickHouse/ClickHouse/pull/68574) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fix inconsistent AST formatting for `negate` (`-`) and `NOT` functions with tuples and arrays. [#68600](https://github.com/ClickHouse/ClickHouse/pull/68600) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Fix insertion of incomplete type into `Dynamic` during deserialization. It could lead to `Parameter out of bound` errors. [#69291](https://github.com/ClickHouse/ClickHouse/pull/69291) ([Pavel Kruglov](https://github.com/Avogar)).
- Zero-copy replication, which is experimental and should not be used in production: fix inf loop after `restore replica` in the replicated merge tree with zero copy. [#69293](https://github.com/CljmnickHouse/ClickHouse/pull/69293) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Return back default value of `processing_threads_num` as number of cpu cores in storage `S3Queue`. [#69384](https://github.com/ClickHouse/ClickHouse/pull/69384) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Bypass try/catch flow when de/serializing nested repeated protobuf to nested columns (fixes [#41971](https://github.com/ClickHouse/ClickHouse/issues/41971)). [#69556](https://github.com/ClickHouse/ClickHouse/pull/69556) ([Eliot Hautefeuille](https://github.com/hileef)).
- Fix crash during insertion into FixedString column in PostgreSQL engine. [#69584](https://github.com/ClickHouse/ClickHouse/pull/69584) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix crash when executing `create view t as (with recursive 42 as ttt select ttt);`. [#69676](https://github.com/ClickHouse/ClickHouse/pull/69676) ([Han Fei](https://github.com/hanfei1991)).
- Fixed `maxMapState` throwing 'Bad get' if value type is DateTime64. [#69787](https://github.com/ClickHouse/ClickHouse/pull/69787) ([Michael Kolupaev](https://github.com/al13n321)).
- Fix `getSubcolumn` with `LowCardinality` columns by overriding `useDefaultImplementationForLowCardinalityColumns` to return `true`. [#69831](https://github.com/ClickHouse/ClickHouse/pull/69831) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Fix permanent blocked distributed sends if a DROP of distributed table failed. [#69843](https://github.com/ClickHouse/ClickHouse/pull/69843) ([Azat Khuzhin](https://github.com/azat)).
- Fix non-cancellable queries containing WITH FILL with NaN keys. This closes [#69261](https://github.com/ClickHouse/ClickHouse/issues/69261). [#69845](https://github.com/ClickHouse/ClickHouse/pull/69845) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix analyzer default with old compatibility value. [#69895](https://github.com/ClickHouse/ClickHouse/pull/69895) ([Raúl Marín](https://github.com/Algunenano)).
- Don't check dependencies during CREATE OR REPLACE VIEW during DROP of old table. Previously CREATE OR REPLACE query failed when there are dependent tables of the recreated view. [#69907](https://github.com/ClickHouse/ClickHouse/pull/69907) ([Pavel Kruglov](https://github.com/Avogar)).
- Something for Decimal. Fixes [#69730](https://github.com/ClickHouse/ClickHouse/issues/69730). [#69978](https://github.com/ClickHouse/ClickHouse/pull/69978) ([Arthur Passos](https://github.com/arthurpassos)).
- Now DEFINER/INVOKER will work with parameterized views. [#69984](https://github.com/ClickHouse/ClickHouse/pull/69984) ([pufit](https://github.com/pufit)).
- Fix parsing for view's definers. [#69985](https://github.com/ClickHouse/ClickHouse/pull/69985) ([pufit](https://github.com/pufit)).
- Fixed a bug when the timezone could change the result of the query with a `Date` or `Date32` arguments. [#70036](https://github.com/ClickHouse/ClickHouse/pull/70036) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fixes `Block structure mismatch` for queries with nested views and `WHERE` condition. Fixes [#66209](https://github.com/ClickHouse/ClickHouse/issues/66209). [#70054](https://github.com/ClickHouse/ClickHouse/pull/70054) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Avoid reusing columns among different named tuples when evaluating `tuple` functions. This fixes [#70022](https://github.com/ClickHouse/ClickHouse/issues/70022). [#70103](https://github.com/ClickHouse/ClickHouse/pull/70103) ([Amos Bird](https://github.com/amosbird)).
- Fix wrong LOGICAL_ERROR when replacing literals in ranges. [#70122](https://github.com/ClickHouse/ClickHouse/pull/70122) ([Pablo Marcos](https://github.com/pamarcos)).
- Check for Nullable(Nothing) type during ALTER TABLE MODIFY COLUMN/QUERY to prevent tables with such data type. [#70123](https://github.com/ClickHouse/ClickHouse/pull/70123) ([Pavel Kruglov](https://github.com/Avogar)).
- Proper error message for illegal query `JOIN ... ON *` , close [#68650](https://github.com/ClickHouse/ClickHouse/issues/68650). [#70124](https://github.com/ClickHouse/ClickHouse/pull/70124) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Fix wrong result with skipping index. [#70127](https://github.com/ClickHouse/ClickHouse/pull/70127) ([Raúl Marín](https://github.com/Algunenano)).
- Fix data race in ColumnObject/ColumnTuple decompress method that could lead to heap use after free. [#70137](https://github.com/ClickHouse/ClickHouse/pull/70137) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix possible hung in ALTER COLUMN with Dynamic type. [#70144](https://github.com/ClickHouse/ClickHouse/pull/70144) ([Pavel Kruglov](https://github.com/Avogar)).
- Now ClickHouse will consider more errors as retriable and will not mark data parts as broken in case of such errors. [#70145](https://github.com/ClickHouse/ClickHouse/pull/70145) ([alesapin](https://github.com/alesapin)).
- Use correct `max_types` parameter during Dynamic type creation for JSON subcolumn. [#70147](https://github.com/ClickHouse/ClickHouse/pull/70147) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix the password being displayed in `system.query_log` for users with bcrypt password authentication method. [#70148](https://github.com/ClickHouse/ClickHouse/pull/70148) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix event counter for the native interface (InterfaceNativeSendBytes). [#70153](https://github.com/ClickHouse/ClickHouse/pull/70153) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix possible crash related to JSON columns. [#70172](https://github.com/ClickHouse/ClickHouse/pull/70172) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix multiple issues with arrayMin and arrayMax. [#70207](https://github.com/ClickHouse/ClickHouse/pull/70207) ([Raúl Marín](https://github.com/Algunenano)).
- Respect setting allow_simdjson in the JSON type parser. [#70218](https://github.com/ClickHouse/ClickHouse/pull/70218) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix a null pointer dereference on creating a materialized view with two selects and an `INTERSECT`, e.g. `CREATE MATERIALIZED VIEW v0 AS (SELECT 1) INTERSECT (SELECT 1);`. [#70264](https://github.com/ClickHouse/ClickHouse/pull/70264) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Don't modify global settings with startup scripts. Previously, changing a setting in a startup script would change it globally. [#70310](https://github.com/ClickHouse/ClickHouse/pull/70310) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix ALTER of `Dynamic` type with reducing max_types parameter that could lead to server crash. [#70328](https://github.com/ClickHouse/ClickHouse/pull/70328) ([Pavel Kruglov](https://github.com/Avogar)).
- Fix crash when using WITH FILL incorrectly. [#70338](https://github.com/ClickHouse/ClickHouse/pull/70338) ([Raúl Marín](https://github.com/Algunenano)).
- Fix possible use-after-free in `SYSTEM DROP FORMAT SCHEMA CACHE FOR Protobuf`. [#70358](https://github.com/ClickHouse/ClickHouse/pull/70358) ([Azat Khuzhin](https://github.com/azat)).
- Fix crash during GROUP BY JSON sub-object subcolumn. [#70374](https://github.com/ClickHouse/ClickHouse/pull/70374) ([Pavel Kruglov](https://github.com/Avogar)).
- Don't prefetch parts for vertical merges if part has no rows. [#70452](https://github.com/ClickHouse/ClickHouse/pull/70452) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix crash in WHERE with lambda functions. [#70464](https://github.com/ClickHouse/ClickHouse/pull/70464) ([Raúl Marín](https://github.com/Algunenano)).
- Fix table creation with `CREATE ... AS table_function(...)` with database `Replicated` and unavailable table function source on secondary replica. [#70511](https://github.com/ClickHouse/ClickHouse/pull/70511) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Ignore all output on async insert with `wait_for_async_insert=1`. Closes [#62644](https://github.com/ClickHouse/ClickHouse/issues/62644). [#70530](https://github.com/ClickHouse/ClickHouse/pull/70530) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Ignore frozen_metadata.txt while traversing shadow directory from system.remote_data_paths. [#70590](https://github.com/ClickHouse/ClickHouse/pull/70590) ([Aleksei Filatov](https://github.com/aalexfvk)).
- Fix creation of stateful window functions on misaligned memory. [#70631](https://github.com/ClickHouse/ClickHouse/pull/70631) ([Raúl Marín](https://github.com/Algunenano)).
- Fixed rare crashes in `SELECT`-s and merges after adding a column of `Array` type with non-empty default expression. [#70695](https://github.com/ClickHouse/ClickHouse/pull/70695) ([Anton Popov](https://github.com/CurtizJ)).
- Insert into table function s3 will respect query settings. [#70696](https://github.com/ClickHouse/ClickHouse/pull/70696) ([Vladimir Cherkasov](https://github.com/vdimir)).
- Fix infinite recursion when inferring a protobuf schema when skipping unsupported fields is enabled. [#70697](https://github.com/ClickHouse/ClickHouse/pull/70697) ([Raúl Marín](https://github.com/Algunenano)).
- Disable enable_named_columns_in_function_tuple by default. [#70833](https://github.com/ClickHouse/ClickHouse/pull/70833) ([Raúl Marín](https://github.com/Algunenano)).
- Fix S3Queue table engine setting processing_threads_num not being effective in case it was deduced from the number of cpu cores on the server. [#70837](https://github.com/ClickHouse/ClickHouse/pull/70837) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Normalize named tuple arguments in aggregation states. This fixes [#69732](https://github.com/ClickHouse/ClickHouse/issues/69732) . [#70853](https://github.com/ClickHouse/ClickHouse/pull/70853) ([Amos Bird](https://github.com/amosbird)).
- Fix a logical error due to negative zeros in the two-level hash table. This closes [#70973](https://github.com/ClickHouse/ClickHouse/issues/70973). [#70979](https://github.com/ClickHouse/ClickHouse/pull/70979) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix `limit by`, `limit with ties` for distributed and parallel replicas. [#70880](https://github.com/ClickHouse/ClickHouse/pull/70880) ([Nikita Taranov](https://github.com/nickitat)).

### <a id="249"></a> Релиз ClickHouse 24.9, 2024-09-26 {#a-id249a-clickhouse-release-249-2024-09-26}

#### Обратно несовместимые изменения {#backward-incompatible-change-3}

- Выражения вида `a[b].c` теперь поддерживаются для именованных кортежей, а также именованные индексы из произвольных выражений, например `expr().name`. Это полезно для обработки JSON. Закрывает [#54965](https://github.com/ClickHouse/ClickHouse/issues/54965). В предыдущих версиях выражение вида `expr().name` разбиралось как `tupleElement(expr(), name)`, и анализатор запросов искал столбец `name`, а не соответствующий элемент кортежа; в новой версии это изменено на `tupleElement(expr(), 'name')`. В большинстве случаев предыдущая версия не работала, но можно представить очень необычный сценарий, когда это изменение может привести к несовместимости: если вы хранили имена элементов кортежа в столбце или псевдониме, который был назван иначе, чем имя элемента кортежа: `SELECT 'b' AS a, CAST([tuple(123)] AS 'Array(Tuple(b UInt8))') AS t, t[1].a`. Маловероятно, что вы использовали такие запросы, но мы всё же должны отметить это изменение как потенциально обратно несовместимое. [#68435](https://github.com/ClickHouse/ClickHouse/pull/68435) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Когда настройка `print_pretty_type_names` включена, тип данных `Tuple` будет выводиться в удобочитаемой форме в операторах `SHOW CREATE TABLE`, функции `formatQuery` и в интерактивном режиме в `clickhouse-client` и `clickhouse-local`. В предыдущих версиях эта настройка применялась только к запросам `DESCRIBE` и `toTypeName`. Закрывает [#65753](https://github.com/ClickHouse/ClickHouse/issues/65753). [#68492](https://github.com/ClickHouse/ClickHouse/pull/68492) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Запрещено явное указание UUID при создании таблицы в базах данных `Replicated`. Также запрещено явное указание пути Keeper и имени реплики для таблиц \*MergeTree в реплицируемых базах данных. Вводится новая настройка `database_replicated_allow_explicit_uuid` и изменяется тип `database_replicated_allow_replicated_engine_arguments` с Bool на UInt64 [#66104](https://github.com/ClickHouse/ClickHouse/pull/66104) ([Alexander Tokmakov](https://github.com/tavplubix)).


#### Новая функциональность {#new-feature-3}

- Добавлена возможность использования нескольких методов аутентификации для пользователя вместо одного. Методы аутентификации можно сбросить до последнего добавленного метода. Если вы планируете одновременно запускать экземпляры на версиях 24.8 и 24.9 в течение некоторого времени, рекомендуется установить `max_authentication_methods_per_user` = 1 на этот период во избежание потенциальных проблем совместимости. [#65277](https://github.com/ClickHouse/ClickHouse/pull/65277) ([Arthur Passos](https://github.com/arthurpassos)).
- Добавлена поддержка `ATTACH PARTITION ALL FROM`. [#61987](https://github.com/ClickHouse/ClickHouse/pull/61987) ([Kirill Nikiforov](https://github.com/allmazz)).
- Добавлена настройка `input_format_json_empty_as_default`, которая при включении обрабатывает пустые поля во входных данных JSON как значения по умолчанию. Закрывает [#59339](https://github.com/ClickHouse/ClickHouse/issues/59339). [#66782](https://github.com/ClickHouse/ClickHouse/pull/66782) ([Alexis Arnaud](https://github.com/a-a-f)).
- Добавлены функции `overlay` и `overlayUTF8`, которые заменяют части строки другой строкой. Пример: `SELECT overlay('Hello New York', 'Jersey', 11)` возвращает `Hello New Jersey`. [#66933](https://github.com/ClickHouse/ClickHouse/pull/66933) ([李扬](https://github.com/taiyang-li)).
- Добавлена поддержка легковесных удалений в партиции `DELETE FROM [db.]table [ON CLUSTER cluster] [IN PARTITION partition_expr] WHERE expr; ` [#67805](https://github.com/ClickHouse/ClickHouse/pull/67805) ([sunny](https://github.com/sunny19930321)).
- Реализовано сравнение значений типа данных `Interval` из различных доменов (таких как секунды и минуты) с преобразованием к наименьшему супертипу. [#68057](https://github.com/ClickHouse/ClickHouse/pull/68057) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Добавлена настройка `create_if_not_exists` для использования поведения `IF NOT EXISTS` по умолчанию в операторах CREATE. [#68164](https://github.com/ClickHouse/ClickHouse/pull/68164) ([Peter Nguyen](https://github.com/petern48)).
- Реализована возможность чтения таблиц `Iceberg` в Azure и локально. [#68210](https://github.com/ClickHouse/ClickHouse/pull/68210) ([Daniil Ivanik](https://github.com/divanik)).
- Записи кэша запросов теперь можно удалять по тегу. Например, запись кэша запросов, созданная запросом `SELECT 1 SETTINGS use_query_cache = true, query_cache_tag = 'abc'`, теперь можно удалить командой `SYSTEM DROP QUERY CACHE TAG 'abc'`. [#68477](https://github.com/ClickHouse/ClickHouse/pull/68477) ([Michał Tabaszewski](https://github.com/pinsvin00)).
- Добавлено шифрование хранилища для именованных коллекций. [#68615](https://github.com/ClickHouse/ClickHouse/pull/68615) ([Pablo Marcos](https://github.com/pamarcos)).
- Добавлен виртуальный столбец `_headers` для движка таблиц `URL`. Закрывает [#65026](https://github.com/ClickHouse/ClickHouse/issues/65026). [#68867](https://github.com/ClickHouse/ClickHouse/pull/68867) ([flynn](https://github.com/ucasfl)).
- Добавлена таблица `system.projections` для отслеживания доступных проекций. [#68901](https://github.com/ClickHouse/ClickHouse/pull/68901) ([Jordi Villar](https://github.com/jrdi)).
- Добавлена новая функция `arrayZipUnaligned` для совместимости со Spark (в Spark называется `arrays_zip`), позволяющая работать с массивами разной длины на основе оригинальной функции `arrayZip`. [#69030](https://github.com/ClickHouse/ClickHouse/pull/69030) ([李扬](https://github.com/taiyang-li)).
- Добавлены команды `cp`/`mv` для клиентского приложения командной строки keeper, которые атомарно копируют/перемещают узел. [#69034](https://github.com/ClickHouse/ClickHouse/pull/69034) ([Mikhail Artemenko](https://github.com/Michicosun)).
- Добавлен аргумент `scale` (по умолчанию: `true`) к функции `arrayAUC`, который позволяет пропустить этап нормализации (задача [#69609](https://github.com/ClickHouse/ClickHouse/issues/69609)). [#69717](https://github.com/ClickHouse/ClickHouse/pull/69717) ([gabrielmcg44](https://github.com/gabrielmcg44)).

#### Экспериментальная функциональность {#experimental-feature-2}

- Добавлена настройка `input_format_try_infer_variants`, которая позволяет определять тип `Variant` при автоматическом выводе схемы для текстовых форматов, когда для столбца или элементов массива возможно более одного типа. [#63798](https://github.com/ClickHouse/ClickHouse/pull/63798) ([Shaun Struwig](https://github.com/Blargian)).
- Добавлены агрегатные функции `distinctDynamicTypes`/`distinctJSONPaths`/`distinctJSONPathsAndTypes` для улучшенного анализа содержимого столбцов типа JSON. [#68463](https://github.com/ClickHouse/ClickHouse/pull/68463) ([Kruglov Pavel](https://github.com/Avogar)).
- Новый алгоритм определения единицы распределения меток между параллельными репликами на основе согласованного хеширования. Для различных паттернов чтения выбирается разное количество меток для повышения производительности. [#68424](https://github.com/ClickHouse/ClickHouse/pull/68424) ([Nikita Taranov](https://github.com/nickitat)).
- Ранее алгоритмическая сложность логики дедупликации кусков при обработке объявлений параллельных реплик составляла O(n^2), что могло занимать заметное время для таблиц с большим количеством кусков (или партиций). Это изменение снижает сложность до O(n\*log(n)). [#69596](https://github.com/ClickHouse/ClickHouse/pull/69596) ([Alexander Gololobov](https://github.com/davenger)).
- Улучшения обновляемых материализованных представлений: режим добавления (`... REFRESH EVERY 1 MINUTE APPEND ...`) для добавления строк в существующую таблицу вместо перезаписи всей таблицы, повторные попытки (по умолчанию отключены, настраиваются в секции SETTINGS запроса), запрос `SYSTEM WAIT VIEW <name>`, который ожидает завершения текущего обновления, а также некоторые исправления. [#58934](https://github.com/ClickHouse/ClickHouse/pull/58934) ([Michael Kolupaev](https://github.com/al13n321)).
- Добавлен `min_max` как новый тип (экспериментальной) статистики. Он поддерживает оценку диапазонных предикатов для числовых столбцов, например `x < 100`. [#67013](https://github.com/ClickHouse/ClickHouse/pull/67013) ([JackyWoo](https://github.com/JackyWoo)).
- Улучшена функция castOrDefault для столбцов Variant/Dynamic, теперь она работает даже когда внутренние типы полностью не конвертируемы. [#67150](https://github.com/ClickHouse/ClickHouse/pull/67150) ([Kruglov Pavel](https://github.com/Avogar)).
- Репликация подмножества столбцов теперь доступна через MaterializedPostgreSQL. Закрывает [#33748](https://github.com/ClickHouse/ClickHouse/issues/33748). [#69092](https://github.com/ClickHouse/ClickHouse/pull/69092) ([Kruglov Kirill](https://github.com/1on)).


#### Улучшение производительности {#performance-improvement-3}

- Реализовано чтение только необходимых файлов для партиционирования Hive. [#68963](https://github.com/ClickHouse/ClickHouse/pull/68963) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Улучшена производительность JOIN за счет переупорядочивания правой таблицы по ключам при плотном распределении ключей в LEFT или INNER хеш-соединениях. [#60341](https://github.com/ClickHouse/ClickHouse/pull/60341) ([kevinyhzou](https://github.com/KevinyhZou)).
- Улучшена производительность ALL JOIN за счет отложенного добавления списка строк. [#63677](https://github.com/ClickHouse/ClickHouse/pull/63677) ([kevinyhzou](https://github.com/KevinyhZou)).
- Асинхронная загрузка метаданных кеша файловой системы во время запуска для ускорения перезапусков (управляется настройкой `load_metadata_asynchronously`). [#65736](https://github.com/ClickHouse/ClickHouse/pull/65736) ([Daniel Pozo Escalona](https://github.com/danipozo)).
- Функции `array` и `map` оптимизированы для значительно более быстрой обработки некоторых распространенных случаев. [#67707](https://github.com/ClickHouse/ClickHouse/pull/67707) ([李扬](https://github.com/taiyang-li)).
- Небольшая оптимизация чтения строк ORC, особенно когда столбец не содержит значений NULL. [#67794](https://github.com/ClickHouse/ClickHouse/pull/67794) ([李扬](https://github.com/taiyang-li)).
- Улучшена общая производительность слияний за счет снижения накладных расходов на планирование этапов слияний. [#68016](https://github.com/ClickHouse/ClickHouse/pull/68016) ([Anton Popov](https://github.com/CurtizJ)).
- Ускорены запросы к S3, когда профиль не задан, учетные данные не указаны и IMDS недоступен (например, при запросе к публичному бакету на машине вне облачной инфраструктуры). Это закрывает [#52771](https://github.com/ClickHouse/ClickHouse/issues/52771). [#68082](https://github.com/ClickHouse/ClickHouse/pull/68082) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Девиртуализация средства чтения формата в `RowInputFormatWithNamesAndTypes` для повышения производительности. [#68437](https://github.com/ClickHouse/ClickHouse/pull/68437) ([李扬](https://github.com/taiyang-li)).
- Добавлено параллельное слияние для агрегатной функции `uniq` при агрегировании с ключом группировки для максимального использования CPU. [#68441](https://github.com/ClickHouse/ClickHouse/pull/68441) ([Jiebin Sun](https://github.com/jiebinn)).
- Добавлена настройка `output_format_orc_dictionary_key_size_threshold`, позволяющая пользователю включить словарное кодирование для строковых столбцов в выходном формате `ORC`. Это помогает уменьшить размер выходного файла `ORC` и значительно улучшить производительность чтения. [#68591](https://github.com/ClickHouse/ClickHouse/pull/68591) ([李扬](https://github.com/taiyang-li)).
- Введен новый запрос Keeper RemoveRecursive, который удаляет узел со всем его поддеревом. [#69332](https://github.com/ClickHouse/ClickHouse/pull/69332) ([Mikhail Artemenko](https://github.com/Michicosun)).
- Ускорена производительность вставки в таблицу с индексом векторного сходства за счет параллельного добавления данных в векторный индекс. [#69493](https://github.com/ClickHouse/ClickHouse/pull/69493) ([flynn](https://github.com/ucasfl)).
- Снижено потребление памяти при вставках в JSON за счет использования адаптивного размера буфера записи. Многие файлы, создаваемые столбцом JSON в широкой части, содержат небольшой объем данных, и выделение для них буфера размером 1 МБ нецелесообразно. [#69272](https://github.com/ClickHouse/ClickHouse/pull/69272) ([Kruglov Pavel](https://github.com/Avogar)).
- Предотвращено возвращение потока в пул потоков параллельного хеш-соединения во избежание чрезмерного порождения потоков запросом. [#69406](https://github.com/ClickHouse/ClickHouse/pull/69406) ([Duc Canh Le](https://github.com/canhld94)).


#### Улучшение {#improvement-3}

- CREATE TABLE AS теперь копирует конструкции PRIMARY KEY, ORDER BY и аналогичные. В настоящее время поддерживается только для семейства движков таблиц MergeTree. [#69076](https://github.com/ClickHouse/ClickHouse/pull/69076) ([sakulali](https://github.com/sakulali)).
- Усилены части кодовой базы, связанные с парсингом небольших сущностей. Обнаружены и исправлены следующие (незначительные) ошибки: - если таблица `DeltaLake` разбита на партиции по Bool, значение партиции всегда интерпретируется как false; - таблица `ExternalDistributed` использовала только один шард из предоставленных адресов; значение настройки `max_threads` и аналогичных выводилось как `'auto(N)'` вместо `auto(N)`. [#52503](https://github.com/ClickHouse/ClickHouse/pull/52503) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Для учета использования CPU применяются метрики, специфичные для cgroup, вместо общесистемных метрик. [#62003](https://github.com/ClickHouse/ClickHouse/pull/62003) ([Nikita Taranov](https://github.com/nickitat)).
- Планирование ввода-вывода для удаленных дисков S3 теперь выполняется на уровне потоков HTTP-сокетов (вместо целых S3-запросов) для решения проблем с ограничением `bandwidth_limit`. [#65182](https://github.com/ClickHouse/ClickHouse/pull/65182) ([Sergei Trifonov](https://github.com/serxa)).
- Функции `upperUTF8` и `lowerUTF8` ранее могли преобразовывать в верхний/нижний регистр только кириллические символы. Это ограничение теперь снято, и символы на произвольных языках преобразуются в верхний/нижний регистр. Пример: `SELECT upperUTF8('Süden')` теперь возвращает `SÜDEN`. [#65761](https://github.com/ClickHouse/ClickHouse/pull/65761) ([李扬](https://github.com/taiyang-li)).
- Когда происходит легковесное удаление в таблице с проекцией (проекциями), несмотря на то, что у пользователей есть выбор либо выбросить исключение (по умолчанию), либо удалить проекцию при выполнении легковесного удаления, теперь есть третий вариант — выполнить легковесное удаление и затем перестроить проекцию (проекции). [#66169](https://github.com/ClickHouse/ClickHouse/pull/66169) ([jsc0218](https://github.com/jsc0218)).
- Добавлены две опции (`dns_allow_resolve_names_to_ipv4` и `dns_allow_resolve_names_to_ipv6`) для блокировки подключений по семейству IP-адресов. [#66895](https://github.com/ClickHouse/ClickHouse/pull/66895) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Игнорирование Ctrl-Z теперь настраивается (ignore_shell_suspend) в clickhouse-client. [#67134](https://github.com/ClickHouse/ClickHouse/pull/67134) ([Azat Khuzhin](https://github.com/azat)).
- Улучшена валидация UTF-8 в форматах вывода JSON. Обеспечивается генерация корректного JSON в случае определенных последовательностей байтов в результирующих данных. [#67938](https://github.com/ClickHouse/ClickHouse/pull/67938) ([mwoenker](https://github.com/mwoenker)).
- Добавлены события профилирования для слияний и мутаций для улучшенной интроспекции. [#68015](https://github.com/ClickHouse/ClickHouse/pull/68015) ([Anton Popov](https://github.com/CurtizJ)).
- ODBC: получение http_max_tries из конфигурации сервера. [#68128](https://github.com/ClickHouse/ClickHouse/pull/68128) ([Rodolphe Dugé de Bernonville](https://github.com/RodolpheDuge)).
- Добавлена поддержка подстановочных символов для идентификации пользователей в расширении X.509 SubjectAltName. [#68236](https://github.com/ClickHouse/ClickHouse/pull/68236) ([Marco Vilas Boas](https://github.com/marco-vb)).
- Улучшен вывод схемы для дат и времени. Теперь `DateTime64` используется только когда дата-время имеет дробную часть, в противном случае используется обычный DateTime. Вывод Date/DateTime теперь более строгий, особенно при `date_time_input_format='best_effort'`, чтобы избежать вывода дат-времени из строк в граничных случаях. [#68382](https://github.com/ClickHouse/ClickHouse/pull/68382) ([Kruglov Pavel](https://github.com/Avogar)).
- Удален старый код именованных коллекций из словарей и заменен на новый, который позволяет использовать именованные коллекции, созданные через DDL, в словарях. Закрывает [#60936](https://github.com/ClickHouse/ClickHouse/issues/60936), закрывает [#36890](https://github.com/ClickHouse/ClickHouse/issues/36890). [#68412](https://github.com/ClickHouse/ClickHouse/pull/68412) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Для внешних HTTP-аутентификаторов используется HTTP/1.1 вместо HTTP/1.0 (установлен по умолчанию). [#68456](https://github.com/ClickHouse/ClickHouse/pull/68456) ([Aleksei Filatov](https://github.com/aalexfvk)).
- Добавлен новый набор метрик для интроспекции пула потоков, обеспечивающий более глубокое понимание производительности и поведения пула потоков. [#68674](https://github.com/ClickHouse/ClickHouse/pull/68674) ([filimonov](https://github.com/filimonov)).
- Поддержка параметров запроса в асинхронных вставках с форматом `Values`. [#68741](https://github.com/ClickHouse/ClickHouse/pull/68741) ([Anton Popov](https://github.com/CurtizJ)).
- Поддержка `Date32` в `dateTrunc` и `toStartOfInterval`. [#68874](https://github.com/ClickHouse/ClickHouse/pull/68874) ([LiuNeng](https://github.com/liuneng1994)).
- Добавлены столбцы `plan_step_name` и `plan_step_description` в `system.processors_profile_log`. [#68954](https://github.com/ClickHouse/ClickHouse/pull/68954) ([Alexander Gololobov](https://github.com/davenger)).
- Поддержка испанского языка во встроенных словарях. [#69035](https://github.com/ClickHouse/ClickHouse/pull/69035) ([Vasily Okunev](https://github.com/VOkunev)).
- Добавлена архитектура CPU в краткое сообщение об ошибке. [#69037](https://github.com/ClickHouse/ClickHouse/pull/69037) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Запросы будут завершаться с ошибкой быстрее, если новое соединение с Keeper не может быть установлено во время повторных попыток. [#69148](https://github.com/ClickHouse/ClickHouse/pull/69148) ([Raúl Marín](https://github.com/Algunenano)).
- Обновлена Database Factory, чтобы пользовательские движки баз данных могли иметь аргументы, настройки и переопределения таблиц (аналогично StorageFactory). [#69201](https://github.com/ClickHouse/ClickHouse/pull/69201) ([NikBarykin](https://github.com/NikBarykin)).
- Режим восстановления, который заменяет все внешние движки таблиц и функции на движок `Null` (настройки `restore_replace_external_engines_to_null`, `restore_replace_external_table_functions_to_null`), завершался с ошибкой, если таблица имела SETTINGS. Теперь он удаляет настройки из определения таблицы в этом случае и позволяет восстанавливать такие таблицы. [#69253](https://github.com/ClickHouse/ClickHouse/pull/69253) ([Ilya Yatsishin](https://github.com/qoega)).
- CLICKHOUSE_PASSWORD корректно экранируется для XML в точке входа образа clickhouse. [#69301](https://github.com/ClickHouse/ClickHouse/pull/69301) ([aohoyd](https://github.com/aohoyd)).
- Разрешены пустые аргументы для `arrayZip`/`arrayZipUnaligned`, как это было сделано для concat в https://github.com/ClickHouse/ClickHouse/pull/65887. Это для совместимости со Spark в Gluten CH Backend. [#69576](https://github.com/ClickHouse/ClickHouse/pull/69576) ([李扬](https://github.com/taiyang-li)).
- Поддержка более продвинутых опций SSL для внутренней коммуникации Keeper (например, приватные ключи с парольной фразой). [#69582](https://github.com/ClickHouse/ClickHouse/pull/69582) ([Antonio Andelic](https://github.com/antonio2368)).
- Анализ индексов может занимать заметное время для больших таблиц с множеством частей или партиций. Это изменение должно позволить прерывать тяжелый запрос на этом этапе. [#69606](https://github.com/ClickHouse/ClickHouse/pull/69606) ([Alexander Gololobov](https://github.com/davenger)).
- Маскировка конфиденциальной информации в табличной функции `gcs`. [#69611](https://github.com/ClickHouse/ClickHouse/pull/69611) ([Vitaly Baranov](https://github.com/vitlibar)).
- Перестроение проекции для слияний, которые уменьшают количество строк. [#62364](https://github.com/ClickHouse/ClickHouse/pull/62364) ([cangyin](https://github.com/cangyin)).





#### Исправление ошибок (видимые пользователю проблемы в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-3}

- Fix attaching table when pg dbname contains "-" in the experimental and unsupported MaterializedPostgreSQL engine. [#62730](https://github.com/ClickHouse/ClickHouse/pull/62730) ([takakawa](https://github.com/takakawa)).
- Fixed error on generated columns in the experimental and totally unsupported MaterializedPostgreSQL engine when adnum ordering is broken [#63161](https://github.com/ClickHouse/ClickHouse/issues/63161). Fixed error on id column with nextval expression as default in the experimental and totally unsupported MaterializedPostgreSQL when there are generated columns in table. Fixed error on dropping publication with symbols except \[a-z1-9-\]. [#67664](https://github.com/ClickHouse/ClickHouse/pull/67664) ([Kruglov Kirill](https://github.com/1on)).
- Storage Join to support Nullable columns in the left table, close [#61247](https://github.com/ClickHouse/ClickHouse/issues/61247). [#66926](https://github.com/ClickHouse/ClickHouse/pull/66926) ([vdimir](https://github.com/vdimir)).
- Incorrect query result with parallel replicas (distribute queries as well) when `IN` operator contains conversion to Decimal(). The bug was introduced with the new analyzer. [#67234](https://github.com/ClickHouse/ClickHouse/pull/67234) ([Igor Nikonov](https://github.com/devcrafter)).
- Fix the problem that alter modify order by causes inconsistent metadata. [#67436](https://github.com/ClickHouse/ClickHouse/pull/67436) ([iceFireser](https://github.com/iceFireser)).
- Fix the upper bound of the function `fromModifiedJulianDay`. It was supposed to be `9999-12-31` but was mistakenly set to `9999-01-01`. [#67583](https://github.com/ClickHouse/ClickHouse/pull/67583) ([PHO](https://github.com/depressed-pho)).
- Fix when the index is not at the beginning of the tuple during `IN` query. [#67626](https://github.com/ClickHouse/ClickHouse/pull/67626) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix expiration in `RoleCache`. [#67748](https://github.com/ClickHouse/ClickHouse/pull/67748) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix window view missing blocks due to slow flush to view. [#67983](https://github.com/ClickHouse/ClickHouse/pull/67983) ([Raúl Marín](https://github.com/Algunenano)).
- Fix MSan issue caused by incorrect date format. [#68105](https://github.com/ClickHouse/ClickHouse/pull/68105) ([JackyWoo](https://github.com/JackyWoo)).
- Fixed crash in Parquet filtering when data types in the file substantially differ from requested types (e.g. `... FROM file('a.parquet', Parquet, 'x String')`, but the file has `x Int64`). Without this fix, use `input_format_parquet_filter_push_down = 0` as a workaround. [#68131](https://github.com/ClickHouse/ClickHouse/pull/68131) ([Michael Kolupaev](https://github.com/al13n321)).
- Fix crash in `lag`/`lead` which is introduced in [#67091](https://github.com/ClickHouse/ClickHouse/issues/67091). [#68262](https://github.com/ClickHouse/ClickHouse/pull/68262) ([lgbo](https://github.com/lgbo-ustc)).
- Try fix postgres crash when query is cancelled. [#68288](https://github.com/ClickHouse/ClickHouse/pull/68288) ([Kseniia Sumarokova](https://github.com/kssenii)).
- After https://github.com/ClickHouse/ClickHouse/pull/61984 `schema_inference_make_columns_nullable=0` still can make columns `Nullable` in Parquet/Arrow formats. The change was backward incompatible and users noticed the changes in the behaviour. This PR makes `schema_inference_make_columns_nullable=0` to work as before (no Nullable columns will be inferred) and introduces new value `auto` for this setting that will make columns `Nullable` only if data has information about nullability. [#68298](https://github.com/ClickHouse/ClickHouse/pull/68298) ([Kruglov Pavel](https://github.com/Avogar)).
- Fixes [#50868](https://github.com/ClickHouse/ClickHouse/issues/50868). Small DateTime64 constant values returned by a nested subquery inside a distributed query were wrongly transformed to Nulls, thus causing errors and possible incorrect query results. [#68323](https://github.com/ClickHouse/ClickHouse/pull/68323) ([Shankar](https://github.com/shiyer7474)).
- Fix missing sync replica mode in query `SYSTEM SYNC REPLICA`. [#68326](https://github.com/ClickHouse/ClickHouse/pull/68326) ([Duc Canh Le](https://github.com/canhld94)).
- Fix bug in key condition. [#68354](https://github.com/ClickHouse/ClickHouse/pull/68354) ([Han Fei](https://github.com/hanfei1991)).
- Fix crash on drop or rename a role that is used in LDAP external user directory. [#68355](https://github.com/ClickHouse/ClickHouse/pull/68355) ([Andrey Zvonov](https://github.com/zvonand)).
- Fix Progress column value of system.view_refreshes greater than 1 [#68377](https://github.com/ClickHouse/ClickHouse/issues/68377). [#68378](https://github.com/ClickHouse/ClickHouse/pull/68378) ([megao](https://github.com/jetgm)).
- Process regexp flags correctly. [#68389](https://github.com/ClickHouse/ClickHouse/pull/68389) ([Han Fei](https://github.com/hanfei1991)).
- PostgreSQL-style cast operator (`::`) works correctly even for SQL-style hex and binary string literals (e.g., `SELECT x'414243'::String`). This closes [#68324](https://github.com/ClickHouse/ClickHouse/issues/68324). [#68482](https://github.com/ClickHouse/ClickHouse/pull/68482) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Minor patch for https://github.com/ClickHouse/ClickHouse/pull/68131. [#68494](https://github.com/ClickHouse/ClickHouse/pull/68494) ([Chang chen](https://github.com/baibaichen)).
- Fix [#68239](https://github.com/ClickHouse/ClickHouse/issues/68239) SAMPLE n where n is an integer. [#68499](https://github.com/ClickHouse/ClickHouse/pull/68499) ([Denis Hananein](https://github.com/denis-hananein)).
- Fix bug in mann-whitney-utest when the size of two districutions are not equal. [#68556](https://github.com/ClickHouse/ClickHouse/pull/68556) ([Han Fei](https://github.com/hanfei1991)).
- After unexpected restart, fail to start replication of ReplicatedMergeTree due to abnormal handling of covered-by-broken part. [#68584](https://github.com/ClickHouse/ClickHouse/pull/68584) ([baolin](https://github.com/baolinhuang)).
- Fix `LOGICAL_ERROR`s when functions `sipHash64Keyed`, `sipHash128Keyed`, or `sipHash128ReferenceKeyed` are applied to empty arrays or tuples. [#68630](https://github.com/ClickHouse/ClickHouse/pull/68630) ([Robert Schulze](https://github.com/rschu1ze)).
- Full text index may filter out wrong columns when index multiple columns, it didn't reset row_id between different columns, the reproduce procedure is in tests/queries/0_stateless/03228_full_text_with_multi_col.sql. Without this. [#68644](https://github.com/ClickHouse/ClickHouse/pull/68644) ([siyuan](https://github.com/linkwk7)).
- Fix invalid character '\t' and '\n' in replica_name when creating a Replicated table, which causes incorrect parsing of 'source replica' in LogEntry. Mentioned in issue [#68640](https://github.com/ClickHouse/ClickHouse/issues/68640). [#68645](https://github.com/ClickHouse/ClickHouse/pull/68645) ([Zhigao Hong](https://github.com/zghong)).
- Added back virtual columns ` _table` and `_database` to distributed tables. They were available until version 24.3. [#68672](https://github.com/ClickHouse/ClickHouse/pull/68672) ([Anton Popov](https://github.com/CurtizJ)).
- Fix possible error `Size of permutation (0) is less than required (...)` during Variant column permutation. [#68681](https://github.com/ClickHouse/ClickHouse/pull/68681) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix possible error `DB::Exception: Block structure mismatch in joined block stream: different columns:` with new JSON column. [#68686](https://github.com/ClickHouse/ClickHouse/pull/68686) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix issue with materialized constant keys when hashing maps with arrays as keys in functions `sipHash(64/128)Keyed`. [#68731](https://github.com/ClickHouse/ClickHouse/pull/68731) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
- Make `ColumnsDescription::toString` format each column using the same `IAST::FormatState object`. This results in uniform columns metadata being written to disk and ZooKeeper. [#68733](https://github.com/ClickHouse/ClickHouse/pull/68733) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Fix merging of aggregated data for grouping sets. [#68744](https://github.com/ClickHouse/ClickHouse/pull/68744) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix logical error, when we create a replicated merge tree, alter a column and then execute modify statistics. [#68820](https://github.com/ClickHouse/ClickHouse/pull/68820) ([Han Fei](https://github.com/hanfei1991)).
- Fix resolving dynamic subcolumns from subqueries in analyzer. [#68824](https://github.com/ClickHouse/ClickHouse/pull/68824) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix complex types metadata parsing in DeltaLake. Closes [#68739](https://github.com/ClickHouse/ClickHouse/issues/68739). [#68836](https://github.com/ClickHouse/ClickHouse/pull/68836) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fixed asynchronous inserts in case when metadata of table is changed (by `ALTER ADD/MODIFY COLUMN` queries) after insert but before flush to the table. [#68837](https://github.com/ClickHouse/ClickHouse/pull/68837) ([Anton Popov](https://github.com/CurtizJ)).
- Fix unexpected exception when passing empty tuple in array. This fixes [#68618](https://github.com/ClickHouse/ClickHouse/issues/68618). [#68848](https://github.com/ClickHouse/ClickHouse/pull/68848) ([Amos Bird](https://github.com/amosbird)).
- Fix parsing pure metadata mutations commands. [#68935](https://github.com/ClickHouse/ClickHouse/pull/68935) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fix possible wrong result during anyHeavy state merge. [#68950](https://github.com/ClickHouse/ClickHouse/pull/68950) ([Raúl Marín](https://github.com/Algunenano)).
- Fixed writing to Materialized Views with enabled setting `optimize_functions_to_subcolumns`. [#68951](https://github.com/ClickHouse/ClickHouse/pull/68951) ([Anton Popov](https://github.com/CurtizJ)).
- Don't use serializations cache in const Dynamic column methods. It could let to use-of-uninitialized value or even race condition during aggregations. [#68953](https://github.com/ClickHouse/ClickHouse/pull/68953) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix parsing error when null should be inserted as default in some cases during JSON type parsing. [#68955](https://github.com/ClickHouse/ClickHouse/pull/68955) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix `Content-Encoding` not sent in some compressed responses. [#64802](https://github.com/ClickHouse/ClickHouse/issues/64802). [#68975](https://github.com/ClickHouse/ClickHouse/pull/68975) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- There were cases when path was concatenated incorrectly and had the `//` part in it, solving this problem using path normalization. [#69066](https://github.com/ClickHouse/ClickHouse/pull/69066) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix logical error when we have empty async insert. [#69080](https://github.com/ClickHouse/ClickHouse/pull/69080) ([Han Fei](https://github.com/hanfei1991)).
- Fixed data race of progress indication in clickhouse-client during query canceling. [#69081](https://github.com/ClickHouse/ClickHouse/pull/69081) ([Sergei Trifonov](https://github.com/serxa)).
- Fix a bug that the vector similarity index (currently experimental) was not utilized when used with cosine distance as distance function. [#69090](https://github.com/ClickHouse/ClickHouse/pull/69090) ([flynn](https://github.com/ucasfl)).
- This change addresses an issue where attempting to create a Replicated database again after a server failure during the initial creation process could result in error. [#69102](https://github.com/ClickHouse/ClickHouse/pull/69102) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Don't infer Bool type from String in CSV when `input_format_csv_try_infer_numbers_from_strings = 1` because we don't allow reading bool values from strings. [#69109](https://github.com/ClickHouse/ClickHouse/pull/69109) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix explain ast insert queries parsing errors on client when `--multiquery` is enabled. [#69123](https://github.com/ClickHouse/ClickHouse/pull/69123) ([wxybear](https://github.com/wxybear)).
- `UNION` clause in subqueries wasn't handled correctly in queries with parallel replicas and lead to LOGICAL_ERROR `Duplicate announcement received for replica`. [#69146](https://github.com/ClickHouse/ClickHouse/pull/69146) ([Igor Nikonov](https://github.com/devcrafter)).
- Fix propogating structure argument in s3Cluster. Previously the `DEFAULT` expression of the column could be lost when sending the query to the replicas in s3Cluster. [#69147](https://github.com/ClickHouse/ClickHouse/pull/69147) ([Kruglov Pavel](https://github.com/Avogar)).
- Respect format settings in Values format during conversion from expression to the destination type. [#69149](https://github.com/ClickHouse/ClickHouse/pull/69149) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix `clickhouse-client --queries-file` for readonly users (previously fails with `Cannot modify 'log_comment' setting in readonly mode`). [#69175](https://github.com/ClickHouse/ClickHouse/pull/69175) ([Azat Khuzhin](https://github.com/azat)).
- Fix data race in clickhouse-client when it's piped to a process that terminated early. [#69186](https://github.com/ClickHouse/ClickHouse/pull/69186) ([vdimir](https://github.com/vdimir)).
- Fix incorrect results of Fix uniq and GROUP BY for JSON/Dynamic types. [#69203](https://github.com/ClickHouse/ClickHouse/pull/69203) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix the INFILE format detection for asynchronous inserts. If the format is not explicitly defined in the FORMAT clause, it can be detected from the INFILE file extension. [#69237](https://github.com/ClickHouse/ClickHouse/pull/69237) ([Julia Kartseva](https://github.com/jkartseva)).
- After [this issue](https://github.com/ClickHouse/ClickHouse/pull/59946#issuecomment-1943653197) there are quite a few table replicas in production such that their `metadata_version` node value is both equal to `0` and is different from the respective table's `metadata` node version. This leads to `alter` queries failing on such replicas. [#69274](https://github.com/ClickHouse/ClickHouse/pull/69274) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Mark Dynamic type as not safe primary key type to avoid issues with Fields. [#69311](https://github.com/ClickHouse/ClickHouse/pull/69311) ([Kruglov Pavel](https://github.com/Avogar)).
- Improve restoring of access entities' dependencies. [#69346](https://github.com/ClickHouse/ClickHouse/pull/69346) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix undefined behavior when all connection attempts fail getting a connection for insertions. [#69390](https://github.com/ClickHouse/ClickHouse/pull/69390) ([Pablo Marcos](https://github.com/pamarcos)).
- Close [#69135](https://github.com/ClickHouse/ClickHouse/issues/69135). If we try to reuse joined data for `cross` join, but this could not happen in ClickHouse at present. It's better to keep `have_compressed` in `reuseJoinedData`. [#69404](https://github.com/ClickHouse/ClickHouse/pull/69404) ([lgbo](https://github.com/lgbo-ustc)).
- Make `materialize()` function return full column when parameter is a sparse column. [#69429](https://github.com/ClickHouse/ClickHouse/pull/69429) ([Alexander Gololobov](https://github.com/davenger)).
- Fixed a `LOGICAL_ERROR` with function `sqidDecode` ([#69450](https://github.com/ClickHouse/ClickHouse/issues/69450)). [#69451](https://github.com/ClickHouse/ClickHouse/pull/69451) ([Robert Schulze](https://github.com/rschu1ze)).
- Quick fix for s3queue problem on 24.6 or create query with database replicated. [#69454](https://github.com/ClickHouse/ClickHouse/pull/69454) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fixed case when memory consumption was too high because of the squashing in `INSERT INTO ... SELECT` or `CREATE TABLE AS SELECT` queries. [#69469](https://github.com/ClickHouse/ClickHouse/pull/69469) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Statements `SHOW COLUMNS` and `SHOW INDEX` now work properly if the table has dots in its name. [#69514](https://github.com/ClickHouse/ClickHouse/pull/69514) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
- Usage of the query cache for queries with an overflow mode != 'throw' is now disallowed. This prevents situations where potentially truncated and incorrect query results could be stored in the query cache. (issue [#67476](https://github.com/ClickHouse/ClickHouse/issues/67476)). [#69549](https://github.com/ClickHouse/ClickHouse/pull/69549) ([Robert Schulze](https://github.com/rschu1ze)).
- Keep original order of conditions during move to prewhere. Previously the order could change and it could lead to failing queries when the order is important. [#69560](https://github.com/ClickHouse/ClickHouse/pull/69560) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix Keeper multi-request preprocessing after ZNOAUTH error. [#69627](https://github.com/ClickHouse/ClickHouse/pull/69627) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix METADATA_MISMATCH that might have happened due to TTL with a WHERE clause in DatabaseReplicated when creating a new replica. [#69736](https://github.com/ClickHouse/ClickHouse/pull/69736) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix `StorageS3(Azure)Queue` settings `tracked_file_ttl_sec`. We wrote it to keeper with key `tracked_file_ttl_sec`, but read as `tracked_files_ttl_sec`, which was a typo. [#69742](https://github.com/ClickHouse/ClickHouse/pull/69742) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Use tryconvertfieldtotype in gethyperrectangleforrowgroup. [#69745](https://github.com/ClickHouse/ClickHouse/pull/69745) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Revert "Fix prewhere without columns and without adaptive index granularity (almost w/o anything)"'. Due to the reverted changes some errors might happen when reading data parts produced by old CH releases (presumably 2021 or older). [#68897](https://github.com/ClickHouse/ClickHouse/pull/68897) ([Alexander Gololobov](https://github.com/davenger)).

### <a id="248"></a> Релиз ClickHouse 24.8 LTS, 2024-08-20 {#a-id248a-clickhouse-release-248-lts-2024-08-20}

#### Обратно несовместимые изменения {#backward-incompatible-change-4}

- `clickhouse-client` и `clickhouse-local` теперь по умолчанию работают в режиме множественных запросов (вместо режима одиночного запроса). Например, `clickhouse-client -q "SELECT 1; SELECT 2"` теперь работает, тогда как ранее пользователям приходилось добавлять `--multiquery` (или `-n`). Переключатель `--multiquery/-n` стал устаревшим. Запросы INSERT в операторах с множественными запросами обрабатываются особым образом в зависимости от их секции FORMAT: если FORMAT имеет значение `VALUES` (наиболее распространённый случай), конец оператора INSERT обозначается завершающей точкой с запятой `;` в конце запроса. Для всех остальных FORMAT (например, `CSV` или `JSONEachRow`) конец оператора INSERT обозначается двумя символами новой строки `\n\n` в конце запроса. [#63898](https://github.com/ClickHouse/ClickHouse/pull/63898) ([FFish](https://github.com/wxybear)).
- В предыдущих версиях можно было использовать альтернативный синтаксис для типов данных `LowCardinality`, добавляя `WithDictionary` к имени типа данных. Это была первоначальная рабочая реализация, которая никогда не была документирована или представлена публично. Теперь она устарела. Если вы использовали этот синтаксис, необходимо выполнить ALTER для ваших таблиц и переименовать типы данных в `LowCardinality`. [#66842](https://github.com/ClickHouse/ClickHouse/pull/66842) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Исправлены логические ошибки при использовании движка хранения `Buffer` с распределённой целевой таблицей. Это обратно несовместимое изменение: запросы, использующие `Buffer` с распределённой целевой таблицей, могут перестать работать, если таблица встречается в запросе более одного раза (например, в самосоединении). [#67015](https://github.com/ClickHouse/ClickHouse/pull/67015) ([vdimir](https://github.com/vdimir)).
- В предыдущих версиях вызов функций для случайных распределений на основе гамма-функции (таких как хи-квадрат, Стьюдента, Фишера) с отрицательными аргументами, близкими к нулю, приводил к длительным вычислениям или бесконечному циклу. В новой версии вызов этих функций с нулевыми или отрицательными аргументами будет генерировать исключение. Это закрывает [#67297](https://github.com/ClickHouse/ClickHouse/issues/67297). [#67326](https://github.com/ClickHouse/ClickHouse/pull/67326) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Системная таблица `text_log` включена по умолчанию. Это полностью совместимо с предыдущими версиями, но вы можете заметить незначительное увеличение использования дискового пространства на локальном диске (эта системная таблица занимает небольшой объём дискового пространства). [#67428](https://github.com/ClickHouse/ClickHouse/pull/67428) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- В предыдущих версиях `arrayWithConstant` могла работать медленно при генерации очень больших массивов. В новой версии она ограничена 1 ГБ на массив. Это закрывает [#32754](https://github.com/ClickHouse/ClickHouse/issues/32754). [#67741](https://github.com/ClickHouse/ClickHouse/pull/67741) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Исправлено форматирование модификатора REPLACE (запрещено опускать скобки). [#67774](https://github.com/ClickHouse/ClickHouse/pull/67774) ([Azat Khuzhin](https://github.com/azat)).
- Портировано в [#68349](https://github.com/ClickHouse/ClickHouse/issues/68349): Переработан тип `Dynamic`. Теперь при достижении лимита динамических типов данных новые типы не приводятся к String, а сохраняются в специальной структуре данных в бинарном формате с бинарно закодированным типом данных. Теперь любой тип, когда-либо вставленный в столбец `Dynamic`, может быть прочитан из него как подстолбец. [#68132](https://github.com/ClickHouse/ClickHouse/pull/68132) ([Kruglov Pavel](https://github.com/Avogar)).


#### Новая функциональность {#new-feature-4}

- Добавлена новая настройка `MergeTree` `deduplicate_merge_projection_mode` для управления проекциями во время слияний (для определённых движков) и запроса `OPTIMIZE DEDUPLICATE`. Поддерживаемые опции: `throw` (выбросить исключение, если проекция не полностью поддерживается движком \*MergeTree), `drop` (удалить проекцию во время слияния, если её невозможно согласованно объединить) и `rebuild` (пересоздать проекцию с нуля, что является ресурсоёмкой операцией). [#66672](https://github.com/ClickHouse/ClickHouse/pull/66672) ([jsc0218](https://github.com/jsc0218)).
- Добавлен виртуальный столбец `_etag` для движка таблиц S3. Исправляет [#65312](https://github.com/ClickHouse/ClickHouse/issues/65312). [#65386](https://github.com/ClickHouse/ClickHouse/pull/65386) ([skyoct](https://github.com/skyoct)).
- Добавлен механизм тегирования (пространства имён) для кеша запросов. Одинаковые запросы с разными тегами рассматриваются кешем запросов как различные. Пример: `SELECT 1 SETTINGS use_query_cache = 1, query_cache_tag = 'abc'` и `SELECT 1 SETTINGS use_query_cache = 1, query_cache_tag = 'def'` теперь создают разные записи в кеше запросов. [#68235](https://github.com/ClickHouse/ClickHouse/pull/68235) ([sakulali](https://github.com/sakulali)).
- Поддержка дополнительных вариантов строгости JOIN (`LEFT/RIGHT SEMI/ANTI/ANY JOIN`) с условиями неравенства, которые включают столбцы как из левой, так и из правой таблицы, например `t1.y < t2.y` (см. настройку `allow_experimental_join_condition`). [#64281](https://github.com/ClickHouse/ClickHouse/pull/64281) ([lgbo](https://github.com/lgbo-ustc)).
- Интерпретация партиционирования в стиле Hive для различных движков (`File`, `URL`, `S3`, `AzureBlobStorage`, `HDFS`). Партиционирование в стиле Hive организует данные в партиционированные подкаталоги, что делает эффективным выполнение запросов и управление большими наборами данных. В настоящее время создаются только виртуальные столбцы с соответствующим именем и данными. Последующий PR введёт соответствующую фильтрацию данных (повышение производительности). [#65997](https://github.com/ClickHouse/ClickHouse/pull/65997) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Добавлена функция `printf` для совместимости со Spark (также можно использовать существующую функцию `format`). [#66257](https://github.com/ClickHouse/ClickHouse/pull/66257) ([李扬](https://github.com/taiyang-li)).
- Добавлены опции `restore_replace_external_engines_to_null` и `restore_replace_external_table_functions_to_null` для замены внешних движков и table_engines на движок `Null`, что может быть полезно для тестирования. Работает для RESTORE и явного создания таблиц. [#66536](https://github.com/ClickHouse/ClickHouse/pull/66536) ([Ilya Yatsishin](https://github.com/qoega)).
- Добавлена поддержка чтения геометрии `MULTILINESTRING` в формате `WKT` с использованием функции `readWKTLineString`. [#67647](https://github.com/ClickHouse/ClickHouse/pull/67647) ([Jacob Reckhard](https://github.com/jacobrec)).
- Добавлена новая табличная функция `fuzzQuery`. Эта функция позволяет модифицировать заданную строку запроса со случайными вариациями. Пример: `SELECT query FROM fuzzQuery('SELECT 1') LIMIT 5;`. [#67655](https://github.com/ClickHouse/ClickHouse/pull/67655) ([pufit](https://github.com/pufit)).
- Добавлен запрос `ALTER TABLE ... DROP DETACHED PARTITION ALL` для удаления всех отсоединённых партиций. [#67885](https://github.com/ClickHouse/ClickHouse/pull/67885) ([Duc Canh Le](https://github.com/canhld94)).
- Добавлена статистика `rows_before_aggregation_at_least` в ответ на запрос при включении новой настройки `rows_before_aggregation`. Эта статистика представляет количество строк, прочитанных до агрегации. В контексте распределённого запроса при использовании функции агрегации `group by` или `max` без `limit`, `rows_before_aggregation_at_least` может отражать количество строк, затронутых запросом. [#66084](https://github.com/ClickHouse/ClickHouse/pull/66084) ([morning-color](https://github.com/morning-color)).
- Поддержка запроса `OPTIMIZE` для таблиц `Join` для уменьшения их потребления памяти. [#67883](https://github.com/ClickHouse/ClickHouse/pull/67883) ([Duc Canh Le](https://github.com/canhld94)).
- Разрешён мгновенный запуск запроса в play при добавлении `&run=1` в URL [#66457](https://github.com/ClickHouse/ClickHouse/pull/66457) ([Aleksandr Musorin](https://github.com/AVMusorin)).

#### Экспериментальная функциональность {#experimental-feature-3}

- Реализован новый тип данных `JSON`. [#66444](https://github.com/ClickHouse/ClickHouse/pull/66444) ([Kruglov Pavel](https://github.com/Avogar)).
- Добавлен новый движок таблиц `TimeSeries`. [#64183](https://github.com/ClickHouse/ClickHouse/pull/64183) ([Vitaly Baranov](https://github.com/vitlibar)).
- Добавлен новый экспериментальный движок хранения `Kafka` для сохранения смещений в Keeper вместо их фиксации в Kafka. Это обеспечивает атомарность фиксации в таблицах ClickHouse относительно потребления из очереди. [#57625](https://github.com/ClickHouse/ClickHouse/pull/57625) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Для параллельных реплик используется адаптивный метод расчета размера задачи чтения (адаптивный означает, что он зависит от размеров читаемых столбцов). [#60377](https://github.com/ClickHouse/ClickHouse/pull/60377) ([Nikita Taranov](https://github.com/nickitat)).
- Добавлен тип статистики `count_min` (count-min sketches), который предоставляет оценки селективности для предикатов равенства вида `col = 'val'`. Поддерживаются строковые типы данных, типы date, datetime и числовые типы. [#65521](https://github.com/ClickHouse/ClickHouse/pull/65521) ([JackyWoo](https://github.com/JackyWoo)).

#### Улучшение производительности {#performance-improvement-4}

- Настройка `optimize_functions_to_subcolumns` включена по умолчанию. [#68053](https://github.com/ClickHouse/ClickHouse/pull/68053) ([Anton Popov](https://github.com/CurtizJ)).
- Метаданные каталога диска `plain_rewritable` хранятся в структуре `__meta` отдельно от данных merge tree в объектном хранилище. Диск `plain_rewritable` переведен на плоскую структуру каталогов. [#65751](https://github.com/ClickHouse/ClickHouse/pull/65751) ([Julia Kartseva](https://github.com/jkartseva)).
- Улучшено уплотнение столбцов (операция, выполняемая в запросах INSERT) для типов `String`/`Array`/`Map`/`Variant`/`Dynamic` путем предварительного резервирования необходимой памяти для всех подстолбцов. [#67043](https://github.com/ClickHouse/ClickHouse/pull/67043) ([Kruglov Pavel](https://github.com/Avogar)).
- Ускорена команда `SYSTEM FLUSH LOGS` и сброс логов при завершении работы. [#67472](https://github.com/ClickHouse/ClickHouse/pull/67472) ([Sema Checherinda](https://github.com/CheSema)).
- Улучшена общая производительность слияний за счет снижения накладных расходов на этапы планирования слияний. [#68016](https://github.com/ClickHouse/ClickHouse/pull/68016) ([Anton Popov](https://github.com/CurtizJ)).
- Ускорено удаление таблиц для запроса `DROP DATABASE`, значение по умолчанию для `database_catalog_drop_table_concurrency` увеличено до 16. [#67228](https://github.com/ClickHouse/ClickHouse/pull/67228) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Исключено избыточное выделение емкости для столбцов массивов при записи ORC. Производительность для столбцов Array увеличена на 15%. [#67879](https://github.com/ClickHouse/ClickHouse/pull/67879) ([李扬](https://github.com/taiyang-li)).
- Значительно ускорены мутации для нереплицируемых MergeTree [#66911](https://github.com/ClickHouse/ClickHouse/pull/66911) [#66909](https://github.com/ClickHouse/ClickHouse/pull/66909) ([Alexey Milovidov](https://github.com/alexey-milovidov)).


#### Улучшения {#improvement-4}

- Настройка `allow_experimental_analyzer` переименована в `enable_analyzer`. Старое имя сохранено в форме псевдонима. Это означает, что анализатор больше не находится в бета-версии и полностью переведён в продакшн. [#66438](https://github.com/ClickHouse/ClickHouse/pull/66438) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Улучшен вывод схемы для типов даты и времени. Теперь DateTime64 используется только когда дата-время имеет дробную часть, в противном случае используется обычный DateTime. Вывод Date/DateTime теперь более строгий, особенно при `date_time_input_format='best_effort'`, чтобы избежать вывода дат-времени из строк в граничных случаях. [#68382](https://github.com/ClickHouse/ClickHouse/pull/68382) ([Kruglov Pavel](https://github.com/Avogar)).
- Сервер ClickHouse теперь поддерживает новую настройку `max_keep_alive_requests`. Для keep-alive HTTP-соединений с сервером она работает в паре с `keep_alive_timeout` — если таймаут простоя не истёк, но через данное соединение уже выполнено более `max_keep_alive_requests` запросов, оно будет закрыто сервером. [#61793](https://github.com/ClickHouse/ClickHouse/pull/61793) ([Nikita Taranov](https://github.com/nickitat)).
- Различные улучшения в расширенной панели управления. Закрывает [#67697](https://github.com/ClickHouse/ClickHouse/issues/67697). Закрывает [#63407](https://github.com/ClickHouse/ClickHouse/issues/63407). Закрывает [#51129](https://github.com/ClickHouse/ClickHouse/issues/51129). Закрывает [#61204](https://github.com/ClickHouse/ClickHouse/issues/61204). [#67701](https://github.com/ClickHouse/ClickHouse/pull/67701) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Не требуется привилегия для REMOTE при создании таблицы Distributed: достаточно привилегии для движка Distributed. [#65419](https://github.com/ClickHouse/ClickHouse/pull/65419) ([jsc0218](https://github.com/jsc0218)).
- Логи для keeper больше не передаются явно в Docker-образе, чтобы разрешить переопределение. [#65564](https://github.com/ClickHouse/ClickHouse/pull/65564) ([Azat Khuzhin](https://github.com/azat)).
- Введена настройка `use_same_password_for_base_backup` для запросов `BACKUP` и `RESTORE`, позволяющая создавать и восстанавливать инкрементные резервные копии в/из защищённых паролем архивов. [#66214](https://github.com/ClickHouse/ClickHouse/pull/66214) ([Samuele](https://github.com/sguerrini97)).
- Настройка `async_load_databases` игнорируется для запроса `ATTACH` (ранее было возможно, что ATTACH возвращался до того, как таблицы были подключены). [#66240](https://github.com/ClickHouse/ClickHouse/pull/66240) ([Azat Khuzhin](https://github.com/azat)).
- Добавлены логи и метрики для отклонённых соединений (когда недостаточно ресурсов). [#66410](https://github.com/ClickHouse/ClickHouse/pull/66410) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Поддержка корректного типа `UUID` для движка MongoDB. [#66671](https://github.com/ClickHouse/ClickHouse/pull/66671) ([Azat Khuzhin](https://github.com/azat)).
- Добавлены метрики задержки репликации и времени восстановления. [#66703](https://github.com/ClickHouse/ClickHouse/pull/66703) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Добавлена метрика `DiskS3NoSuchKeyErrors`. [#66704](https://github.com/ClickHouse/ClickHouse/pull/66704) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
- Обеспечена работа конструкции `COMMENT` для всех движков таблиц. [#66832](https://github.com/ClickHouse/ClickHouse/pull/66832) ([Joe Lynch](https://github.com/joelynch)).
- Функция `mapFromArrays` теперь принимает `Map(K, V)` в качестве первого аргумента, например: `SELECT mapFromArrays(map('a', 4, 'b', 4), ['aa', 'bb'])` теперь работает и возвращает `{('a',4):'aa',('b',4):'bb'}`. Также, если первый аргумент является массивом, он теперь может быть типа `Array(Nullable(T))` или `Array(LowCardinality(Nullable(T)))`, при условии что фактические значения массива не являются `NULL`. [#67103](https://github.com/ClickHouse/ClickHouse/pull/67103) ([李扬](https://github.com/taiyang-li)).
- Чтение конфигурации для `clickhouse-local` из `~/.clickhouse-local`. [#67135](https://github.com/ClickHouse/ClickHouse/pull/67135) ([Azat Khuzhin](https://github.com/azat)).
- Переименована настройка `input_format_orc_read_use_writer_time_zone` в `input_format_orc_reader_timezone` и добавлена возможность пользователю устанавливать часовой пояс чтения. [#67175](https://github.com/ClickHouse/ClickHouse/pull/67175) ([kevinyhzou](https://github.com/KevinyhZou)).
- Понижен уровень ошибки `Socket is not connected`, когда HTTP-соединение немедленно сбрасывается узлом после подключения, закрывает [#34218](https://github.com/ClickHouse/ClickHouse/issues/34218). [#67177](https://github.com/ClickHouse/ClickHouse/pull/67177) ([vdimir](https://github.com/vdimir)).
- Добавлена возможность загружать панели управления для `system.dashboards` из конфигурации (после установки они переопределяют предустановленные панели по умолчанию). [#67232](https://github.com/ClickHouse/ClickHouse/pull/67232) ([Azat Khuzhin](https://github.com/azat)).
- Оконные функции в SQL традиционно используют snake_case. ClickHouse использует `camelCase`, поэтому были созданы новые псевдонимы `denseRank()` и `percentRank()`. Эти новые функции можно вызывать точно так же, как оригинальные функции `dense_rank()` и `percent_rank()`. Оба синтаксиса snake_case и camelCase остаются доступными. Также добавлен новый тест для каждой из функций. Закрывает [#67042](https://github.com/ClickHouse/ClickHouse/issues/67042). [#67334](https://github.com/ClickHouse/ClickHouse/pull/67334) ([Peter Nguyen](https://github.com/petern48)).
- Автоопределение формата конфигурационного файла, если он не `.xml`, `.yml` или `.yaml`. Если файл начинается с &lt;, это может быть XML, в противном случае это может быть YAML. Это полезно при предоставлении конфигурационного файла из канала: `clickhouse-server --config-file <(echo "hello: world")`. [#67391](https://github.com/ClickHouse/ClickHouse/pull/67391) ([sakulali](https://github.com/sakulali)).
- Функции `formatDateTime` и `formatDateTimeInJodaSyntax` теперь рассматривают параметр формата как необязательный. Если он не указан, предполагаются строки формата `%Y-%m-%d %H:%i:%s` и `yyyy-MM-dd HH:mm:ss`. Пример: `SELECT parseDateTime('2021-01-04 23:12:34')` теперь возвращает значение DateTime `2021-01-04 23:12:34` (ранее это вызывало исключение). [#67399](https://github.com/ClickHouse/ClickHouse/pull/67399) ([Robert Schulze](https://github.com/rschu1ze)).
- Автоматический повтор запросов Keeper в KeeperMap, если они происходят из-за таймаута или потери соединения. [#67448](https://github.com/ClickHouse/ClickHouse/pull/67448) ([Antonio Andelic](https://github.com/antonio2368)).
- Добавлен `-no-pie` к сборкам Aarch64 Linux для обеспечения корректной интроспекции и символизации трассировок стека после перезапуска ClickHouse. [#67916](https://github.com/ClickHouse/ClickHouse/pull/67916) ([filimonov](https://github.com/filimonov)).
- Добавлены события профилирования для слияний и мутаций для улучшенной интроспекции. [#68015](https://github.com/ClickHouse/ClickHouse/pull/68015) ([Anton Popov](https://github.com/CurtizJ)).
- Удалены ненужные логи для нереплицируемого `MergeTree`. [#68238](https://github.com/ClickHouse/ClickHouse/pull/68238) ([Daniil Ivanik](https://github.com/divanik)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-1}

- Проверка нестабильных интеграционных тестов теперь запускает каждый тестовый случай несколько раз для обнаружения большего количества проблем в тестах и повышения их надёжности. Используется библиотека `pytest-repeat` для многократного запуска тестового случая в одном и том же окружении. Важно очищать таблицы и другие сущности в конце тестового случая для успешного прохождения. Повторный запуск работает значительно быстрее, чем несколько запусков pytest, так как необходимые контейнеры запускаются только один раз. [#66986](https://github.com/ClickHouse/ClickHouse/pull/66986) ([Ilya Yatsishin](https://github.com/qoega)).
- Разблокировано использование CLion с ClickHouse. В предыдущих версиях CLion зависал на минуту при каждом нажатии клавиши. Это закрывает [#66994](https://github.com/ClickHouse/ClickHouse/issues/66994). [#66995](https://github.com/ClickHouse/ClickHouse/pull/66995) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- getauxval: предотвращение сбоя при повторном запуске санитайзера из-за высокой энтропии ASLR в новых ядрах Linux. [#67081](https://github.com/ClickHouse/ClickHouse/pull/67081) ([Raúl Marín](https://github.com/Algunenano)).
- Некоторые части клиентского кода выделены в отдельный файл, и к ним применяется максимально возможный уровень оптимизации даже для отладочных сборок. Это закрывает: [#65745](https://github.com/ClickHouse/ClickHouse/issues/65745). [#67215](https://github.com/ClickHouse/ClickHouse/pull/67215) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).


#### Исправление ошибок {#bug-fix}

- Only relevant to the experimental Variant data type. Fix crash with Variant + AggregateFunction type. [#67122](https://github.com/ClickHouse/ClickHouse/pull/67122) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix crash in DistributedAsyncInsert when connection is empty. [#67219](https://github.com/ClickHouse/ClickHouse/pull/67219) ([Pablo Marcos](https://github.com/pamarcos)).
- Fix crash of `uniq` and `uniqTheta ` with `tuple()` argument. Closes [#67303](https://github.com/ClickHouse/ClickHouse/issues/67303). [#67306](https://github.com/ClickHouse/ClickHouse/pull/67306) ([flynn](https://github.com/ucasfl)).
- Fixes [#66026](https://github.com/ClickHouse/ClickHouse/issues/66026). Avoid unresolved table function arguments traversal in `ReplaceTableNodeToDummyVisitor`. [#67522](https://github.com/ClickHouse/ClickHouse/pull/67522) ([Dmitry Novik](https://github.com/novikd)).
- Fix potential stack overflow in `JSONMergePatch` function. Renamed this function from `jsonMergePatch` to `JSONMergePatch` because the previous name was wrong. The previous name is still kept for compatibility. Improved diagnostic of errors in the function. This closes [#67304](https://github.com/ClickHouse/ClickHouse/issues/67304). [#67756](https://github.com/ClickHouse/ClickHouse/pull/67756) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fixed a NULL pointer dereference, triggered by a specially crafted query, that crashed the server via hopEnd, hopStart, tumbleEnd, and tumbleStart. [#68098](https://github.com/ClickHouse/ClickHouse/pull/68098) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
- Fixed `Not-ready Set` in some system tables when filtering using subqueries. [#66018](https://github.com/ClickHouse/ClickHouse/pull/66018) ([Michael Kolupaev](https://github.com/al13n321)).
- Fixed reading of subcolumns after `ALTER ADD COLUMN` query. [#66243](https://github.com/ClickHouse/ClickHouse/pull/66243) ([Anton Popov](https://github.com/CurtizJ)).
- Fix boolean literals in query sent to external database (for engines like `PostgreSQL`). [#66282](https://github.com/ClickHouse/ClickHouse/pull/66282) ([vdimir](https://github.com/vdimir)).
- Fix formatting of query with aliased JOIN ON expression, e.g. `... JOIN t2 ON (x = y) AS e ORDER BY x` should be formatted as `... JOIN t2 ON ((x = y) AS e) ORDER BY x`. [#66312](https://github.com/ClickHouse/ClickHouse/pull/66312) ([vdimir](https://github.com/vdimir)).
- Fix cluster() for inter-server secret (preserve initial user as before). [#66364](https://github.com/ClickHouse/ClickHouse/pull/66364) ([Azat Khuzhin](https://github.com/azat)).
- Fix possible runtime error while converting Array field with nulls to Array(Variant). [#66727](https://github.com/ClickHouse/ClickHouse/pull/66727) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix for occasional deadlock in Context::getDDLWorker. [#66843](https://github.com/ClickHouse/ClickHouse/pull/66843) ([Alexander Gololobov](https://github.com/davenger)).
- Fix creating KeeperMap table after an incomplete drop. [#66865](https://github.com/ClickHouse/ClickHouse/pull/66865) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix broken part error while restoring to a `s3_plain_rewritable` disk. [#66881](https://github.com/ClickHouse/ClickHouse/pull/66881) ([Vitaly Baranov](https://github.com/vitlibar)).
- In rare cases ClickHouse could consider parts as broken because of some unexpected projections on disk. Now it's fixed. [#66898](https://github.com/ClickHouse/ClickHouse/pull/66898) ([alesapin](https://github.com/alesapin)).
- Fix invalid format detection in schema inference that could lead to logical error Format {} doesn't support schema inference. [#66899](https://github.com/ClickHouse/ClickHouse/pull/66899) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix possible deadlock on query cancel with parallel replicas. [#66905](https://github.com/ClickHouse/ClickHouse/pull/66905) ([Nikita Taranov](https://github.com/nickitat)).
- Forbid create as select even when database_replicated_allow_heavy_create is set. It was unconditionally forbidden in 23.12 and accidentally allowed under the setting in unreleased 24.7. [#66980](https://github.com/ClickHouse/ClickHouse/pull/66980) ([vdimir](https://github.com/vdimir)).
- Reading from the `numbers` could wrongly throw an exception when the `max_rows_to_read` limit was set. This closes [#66992](https://github.com/ClickHouse/ClickHouse/issues/66992). [#66996](https://github.com/ClickHouse/ClickHouse/pull/66996) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add proper type conversion to lagInFrame and leadInFrame window functions - fixes msan test. [#67091](https://github.com/ClickHouse/ClickHouse/pull/67091) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- TRUNCATE DATABASE used to stop replication as if it was a DROP DATABASE query, it's fixed. [#67129](https://github.com/ClickHouse/ClickHouse/pull/67129) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Use a separate client context in `clickhouse-local`. [#67133](https://github.com/ClickHouse/ClickHouse/pull/67133) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix error `Cannot convert column because it is non constant in source stream but must be constant in result.` for a query that reads from the `Merge` table over the `Distriburted` table with one shard. [#67146](https://github.com/ClickHouse/ClickHouse/pull/67146) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Correct behavior of `ORDER BY all` with disabled `enable_order_by_all` and parallel replicas (distributed queries as well). [#67153](https://github.com/ClickHouse/ClickHouse/pull/67153) ([Igor Nikonov](https://github.com/devcrafter)).
- Fix wrong usage of input_format_max_bytes_to_read_for_schema_inference in schema cache. [#67157](https://github.com/ClickHouse/ClickHouse/pull/67157) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix the memory leak for count distinct, when exception issued during group by single nullable key. [#67171](https://github.com/ClickHouse/ClickHouse/pull/67171) ([Jet He](https://github.com/compasses)).
- Fix an error in optimization which converts OUTER JOIN to INNER JOIN. This closes [#67156](https://github.com/ClickHouse/ClickHouse/issues/67156). This closes [#66447](https://github.com/ClickHouse/ClickHouse/issues/66447). The bug was introduced in https://github.com/ClickHouse/ClickHouse/pull/62907. [#67178](https://github.com/ClickHouse/ClickHouse/pull/67178) ([Maksim Kita](https://github.com/kitaisreal)).
- Fix error `Conversion from AggregateFunction(name, Type) to AggregateFunction(name, Nullable(Type)) is not supported`. The bug was caused by the `optimize_rewrite_aggregate_function_with_if` optimization. Fixes [#67112](https://github.com/ClickHouse/ClickHouse/issues/67112). [#67229](https://github.com/ClickHouse/ClickHouse/pull/67229) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix hung query when using empty tuple as lhs of function IN. [#67295](https://github.com/ClickHouse/ClickHouse/pull/67295) ([Duc Canh Le](https://github.com/canhld94)).
- It was possible to create a very deep nested JSON data that triggered stack overflow while skipping unknown fields. This closes [#67292](https://github.com/ClickHouse/ClickHouse/issues/67292). [#67324](https://github.com/ClickHouse/ClickHouse/pull/67324) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix attaching ReplicatedMergeTree table after exception during startup. [#67360](https://github.com/ClickHouse/ClickHouse/pull/67360) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix segfault caused by incorrectly detaching from thread group in `Aggregator`. [#67385](https://github.com/ClickHouse/ClickHouse/pull/67385) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix one more case when a non-deterministic function is specified in PK. [#67395](https://github.com/ClickHouse/ClickHouse/pull/67395) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fixed `bloom_filter` index breaking queries with mildly weird conditions like `(k=2)=(k=2)` or `has([1,2,3], k)`. [#67423](https://github.com/ClickHouse/ClickHouse/pull/67423) ([Michael Kolupaev](https://github.com/al13n321)).
- Correctly parse file name/URI containing `::` if it's not an archive. [#67433](https://github.com/ClickHouse/ClickHouse/pull/67433) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix wait for tasks in ~WriteBufferFromS3 in case WriteBuffer was cancelled. [#67459](https://github.com/ClickHouse/ClickHouse/pull/67459) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Protect temporary part directories from removing during RESTORE. [#67491](https://github.com/ClickHouse/ClickHouse/pull/67491) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix execution of nested short-circuit functions. [#67520](https://github.com/ClickHouse/ClickHouse/pull/67520) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix `Logical error: Expected the argument №N of type T to have X rows, but it has 0`. The error could happen in a remote query with constant expression in `GROUP BY` (with a new analyzer). [#67536](https://github.com/ClickHouse/ClickHouse/pull/67536) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix join on tuple with NULLs: Some queries with the new analyzer and `NULL` inside the tuple in the `JOIN ON` section returned incorrect results. [#67538](https://github.com/ClickHouse/ClickHouse/pull/67538) ([vdimir](https://github.com/vdimir)).
- Fix redundant reschedule of FileCache::freeSpaceRatioKeepingThreadFunc() in case of full non-evictable cache. [#67540](https://github.com/ClickHouse/ClickHouse/pull/67540) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix inserting into stream like engines (Kafka, RabbitMQ, NATS) through HTTP interface. [#67554](https://github.com/ClickHouse/ClickHouse/pull/67554) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fix for function `toStartOfWeek` which returned the wrong result with a small `DateTime64` value. [#67558](https://github.com/ClickHouse/ClickHouse/pull/67558) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix creation of view with recursive CTE. [#67587](https://github.com/ClickHouse/ClickHouse/pull/67587) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix `Logical error: 'file_offset_of_buffer_end <= read_until_position'` in filesystem cache. Closes [#57508](https://github.com/ClickHouse/ClickHouse/issues/57508). [#67623](https://github.com/ClickHouse/ClickHouse/pull/67623) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fixes [#62282](https://github.com/ClickHouse/ClickHouse/issues/62282). Removed the call to `convertFieldToString()` and added datatype specific serialization code. Parameterized view substitution was broken for multiple datatypes when parameter value was a function or expression returning datatype instance. [#67654](https://github.com/ClickHouse/ClickHouse/pull/67654) ([Shankar](https://github.com/shiyer7474)).
- Fix crash on `percent_rank`. `percent_rank`'s default frame type is changed to `range unbounded preceding and unbounded following`. `IWindowFunction`'s default window frame is considered and now window functions without window frame definition in sql can be put into different `WindowTransfomer`s properly. [#67661](https://github.com/ClickHouse/ClickHouse/pull/67661) ([lgbo](https://github.com/lgbo-ustc)).
- Fix reloading SQL UDFs with UNION. Previously, restarting the server could make UDF invalid. [#67665](https://github.com/ClickHouse/ClickHouse/pull/67665) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix possible logical error "Unexpected return type from if" with experimental Variant type and enabled setting `use_variant_as_common_type ` in function if with Tuples and Maps. [#67687](https://github.com/ClickHouse/ClickHouse/pull/67687) ([Kruglov Pavel](https://github.com/Avogar)).
- Due to a bug in Linux Kernel, a query can hung in `TimerDescriptor::drain`. This closes [#37686](https://github.com/ClickHouse/ClickHouse/issues/37686). [#67702](https://github.com/ClickHouse/ClickHouse/pull/67702) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix completion of `RESTORE ON CLUSTER` command. [#67720](https://github.com/ClickHouse/ClickHouse/pull/67720) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix dictionary hang in case of CANNOT_SCHEDULE_TASK while loading. [#67751](https://github.com/ClickHouse/ClickHouse/pull/67751) ([Azat Khuzhin](https://github.com/azat)).
- Queries like `SELECT count() FROM t WHERE cast(c = 1 or c = 9999 AS Bool) SETTINGS use_skip_indexes=1` with bloom filter indexes on `c` now work correctly. [#67781](https://github.com/ClickHouse/ClickHouse/pull/67781) ([jsc0218](https://github.com/jsc0218)).
- Fix wrong aggregation result in some queries with aggregation without keys and filter, close [#67419](https://github.com/ClickHouse/ClickHouse/issues/67419). [#67804](https://github.com/ClickHouse/ClickHouse/pull/67804) ([vdimir](https://github.com/vdimir)).
- Validate experimental/suspicious data types in ALTER ADD/MODIFY COLUMN. [#67911](https://github.com/ClickHouse/ClickHouse/pull/67911) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix DateTime64 parsing after constant folding in distributed queries, close [#66773](https://github.com/ClickHouse/ClickHouse/issues/66773). [#67920](https://github.com/ClickHouse/ClickHouse/pull/67920) ([vdimir](https://github.com/vdimir)).
- Fix wrong `count()` result when there is non-deterministic function in predicate. [#67922](https://github.com/ClickHouse/ClickHouse/pull/67922) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fixed the calculation of the maximum thread soft limit in containerized environments where the usable CPU count is limited. [#67963](https://github.com/ClickHouse/ClickHouse/pull/67963) ([Robert Schulze](https://github.com/rschu1ze)).
- Now ClickHouse doesn't consider part as broken if projection doesn't exist on disk but exists in `checksums.txt`. [#68003](https://github.com/ClickHouse/ClickHouse/pull/68003) ([alesapin](https://github.com/alesapin)).
- Fixed skipping of untouched parts in mutations with new analyzer. Previously with enabled analyzer data in part could be rewritten by mutation even if mutation doesn't affect this part according to predicate. [#68052](https://github.com/ClickHouse/ClickHouse/pull/68052) ([Anton Popov](https://github.com/CurtizJ)).
- Removes an incorrect optimization to remove sorting in subqueries that use `OFFSET`. Fixes [#67906](https://github.com/ClickHouse/ClickHouse/issues/67906). [#68099](https://github.com/ClickHouse/ClickHouse/pull/68099) ([Graham Campbell](https://github.com/GrahamCampbell)).
- Attempt to fix `Block structure mismatch in AggregatingStep stream: different types` for aggregate projection optimization. [#68107](https://github.com/ClickHouse/ClickHouse/pull/68107) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Try fix postgres crash when query is cancelled. [#68288](https://github.com/ClickHouse/ClickHouse/pull/68288) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix missing sync replica mode in query `SYSTEM SYNC REPLICA`. [#68326](https://github.com/ClickHouse/ClickHouse/pull/68326) ([Duc Canh Le](https://github.com/canhld94)).

### <a id="247"></a> Релиз ClickHouse 24.7, 2024-07-30 {#a-id247a-clickhouse-release-247-2024-07-30}

#### Обратно несовместимые изменения {#backward-incompatible-change-5}

- Запрещено использование `CREATE MATERIALIZED VIEW ... ENGINE Replicated*MergeTree POPULATE AS SELECT ...` с реплицируемыми базами данных. [#63963](https://github.com/ClickHouse/ClickHouse/pull/63963) ([vdimir](https://github.com/vdimir)).
- `clickhouse-keeper-client` теперь принимает пути только в виде строковых литералов, например `ls '/hello/world'`, а не в виде простых строк, таких как `ls /hello/world`. [#65494](https://github.com/ClickHouse/ClickHouse/pull/65494) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Метрика `KeeperOutstandingRequets` переименована в `KeeperOutstandingRequests`. [#66206](https://github.com/ClickHouse/ClickHouse/pull/66206) ([Robert Schulze](https://github.com/rschu1ze)).
- Удалено поле `is_deterministic` из таблицы `system.functions`. [#66630](https://github.com/ClickHouse/ClickHouse/pull/66630) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Функция `tuple` теперь пытается создавать именованные кортежи в запросе (управляется настройкой `enable_named_columns_in_function_tuple`). Добавлена функция `tupleNames` для извлечения имён из кортежей. [#54881](https://github.com/ClickHouse/ClickHouse/pull/54881) ([Amos Bird](https://github.com/amosbird)).
- Изменён механизм дедупликации для материализованных представлений. Исправлено множество случаев, таких как: - в целевой таблице: данные разделяются на 2 или более блоков, и эти блоки считаются дубликатами при параллельной вставке; - в целевой таблице материализованного представления: одинаковые блоки дедуплицируются, что происходит, когда материализованное представление часто производит одинаковые данные в результате обработки различных входных данных из-за выполнения агрегации; - в целевой таблице материализованного представления: дедуплицируются одинаковые блоки, поступающие из разных материализованных представлений. [#61601](https://github.com/ClickHouse/ClickHouse/pull/61601) ([Sema Checherinda](https://github.com/CheSema)).
- Функции `bitShiftLeft` и `bitShiftRight` возвращают ошибку при выходе позиции сдвига за допустимые границы. [#65838](https://github.com/ClickHouse/ClickHouse/pull/65838) ([Pablo Marcos](https://github.com/pamarcos)).


#### Новая функциональность {#new-feature-5}

- Добавлена поддержка `ASOF JOIN` для алгоритма `full_sorting_join`. [#55051](https://github.com/ClickHouse/ClickHouse/pull/55051) ([vdimir](https://github.com/vdimir)).
- Поддержка JWT-аутентификации в `clickhouse-client` (будет доступна только в ClickHouse Cloud). [#62829](https://github.com/ClickHouse/ClickHouse/pull/62829) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Добавлены SQL-функции `changeYear`, `changeMonth`, `changeDay`, `changeHour`, `changeMinute`, `changeSecond`. Например, `SELECT changeMonth(toDate('2024-06-14'), 7)` возвращает дату `2024-07-14`. [#63186](https://github.com/ClickHouse/ClickHouse/pull/63186) ([cucumber95](https://github.com/cucumber95)).
- Добавлены стартовые скрипты, которые позволяют выполнять предварительно настроенные запросы на этапе запуска. [#64889](https://github.com/ClickHouse/ClickHouse/pull/64889) ([pufit](https://github.com/pufit)).
- Поддержка параметра accept_invalid_certificate в конфигурации клиента для подключения по защищённому TCP к серверу с самоподписанным сертификатом — может использоваться как сокращённая запись соответствующих настроек клиента `openSSL`: `verificationMode=none` + `invalidCertificateHandler.name=AcceptCertificateHandler`. [#65238](https://github.com/ClickHouse/ClickHouse/pull/65238) ([peacewalker122](https://github.com/peacewalker122)).
- Добавлена таблица system.error_log, которая содержит историю значений ошибок из таблицы system.errors с периодической записью на диск. [#65381](https://github.com/ClickHouse/ClickHouse/pull/65381) ([Pablo Marcos](https://github.com/pamarcos)).
- Добавлена агрегатная функция `groupConcat`. Примерно эквивалентна `arrayStringConcat(groupArray(column), ',')`. Может принимать 2 параметра: строковый разделитель и количество обрабатываемых элементов. [#65451](https://github.com/ClickHouse/ClickHouse/pull/65451) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Добавлено хранилище AzureQueue. [#65458](https://github.com/ClickHouse/ClickHouse/pull/65458) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлена новая настройка для включения/отключения записи индекса страниц в файлы parquet. [#65475](https://github.com/ClickHouse/ClickHouse/pull/65475) ([lgbo](https://github.com/lgbo-ustc)).
- Добавлен параметр конфигурации сервера `logger.console_log_level` для управления уровнем логирования в консоль (если включено). [#65559](https://github.com/ClickHouse/ClickHouse/pull/65559) ([Azat Khuzhin](https://github.com/azat)).
- Автоматическое добавление символа подстановки `*` в конец пути к директории при использовании табличной функции `file`. [#66019](https://github.com/ClickHouse/ClickHouse/pull/66019) ([Zhidong (David) Guo](https://github.com/Gun9niR)).
- Добавлена опция `--memory-usage` для клиента в неинтерактивном режиме. [#66393](https://github.com/ClickHouse/ClickHouse/pull/66393) ([vdimir](https://github.com/vdimir)).
- Реализован интерактивный клиент для clickhouse-disks, добавлена возможность подключения локального диска из локальной директории. [#64446](https://github.com/ClickHouse/ClickHouse/pull/64446) ([Daniil Ivanik](https://github.com/divanik)).
- При выполнении лёгкого удаления в таблице с проекцией(ями) пользователи могут выбрать: либо выбросить исключение (по умолчанию), либо удалить проекцию. [#65594](https://github.com/ClickHouse/ClickHouse/pull/65594) ([jsc0218](https://github.com/jsc0218)).
- Добавлены системные таблицы с основной информацией обо всех отсоединённых таблицах. [#65400](https://github.com/ClickHouse/ClickHouse/pull/65400) ([Konstantin Morozov](https://github.com/k-morozov)).


#### Экспериментальная функциональность {#experimental-feature-4}

- Изменена бинарная сериализация типа данных `Variant`: добавлен режим `compact` для предотвращения многократной записи одного и того же дискриминатора для гранул с одним вариантом или только со значениями NULL. Добавлен параметр MergeTree `use_compact_variant_discriminators_serialization`, который включён по умолчанию. Обратите внимание, что тип Variant всё ещё является экспериментальным, и обратно несовместимые изменения в сериализации допустимы. [#62774](https://github.com/ClickHouse/ClickHouse/pull/62774) ([Kruglov Pavel](https://github.com/Avogar)).
- Добавлена поддержка дискового хранилища для clickhouse-keeper. [#56626](https://github.com/ClickHouse/ClickHouse/pull/56626) ([Han Fei](https://github.com/hanfei1991)).
- Выполнен рефакторинг функций JSONExtract, добавлена поддержка большего количества типов, включая экспериментальный тип Dynamic. [#66046](https://github.com/ClickHouse/ClickHouse/pull/66046) ([Kruglov Pavel](https://github.com/Avogar)).
- Добавлена поддержка подстолбца null map для подстолбцов `Variant` и `Dynamic`. [#66178](https://github.com/ClickHouse/ClickHouse/pull/66178) ([Kruglov Pavel](https://github.com/Avogar)).
- Исправлено чтение подстолбцов `Dynamic` из изменённой таблицы `Memory`. Ранее, если параметр `max_types` типа Dynamic был изменён в таблице Memory через alter, последующее чтение подстолбцов могло возвращать неверный результат. [#66066](https://github.com/ClickHouse/ClickHouse/pull/66066) ([Kruglov Pavel](https://github.com/Avogar)).
- Добавлена поддержка `cluster_for_parallel_replicas` при использовании параллельных реплик с пользовательским ключом. Это позволяет использовать параллельные реплики с пользовательским ключом для таблиц MergeTree. [#65453](https://github.com/ClickHouse/ClickHouse/pull/65453) ([Antonio Andelic](https://github.com/antonio2368)).


#### Улучшение производительности {#performance-improvement-5}

- Замена алгоритма преобразования int в string на более быстрый (с модифицированного amdn/itoa на модифицированный jeaiii/itoa). [#61661](https://github.com/ClickHouse/ClickHouse/pull/61661) ([Raúl Marín](https://github.com/Algunenano)).
- Размеры хеш-таблиц, создаваемых операцией join (алгоритм `parallel_hash`), теперь собираются и кешируются. Эта информация будет использоваться для предварительного выделения места в хеш-таблицах при последующих выполнениях запросов и экономии времени на изменении размера хеш-таблиц. [#64553](https://github.com/ClickHouse/ClickHouse/pull/64553) ([Nikita Taranov](https://github.com/nickitat)).
- Оптимизированы запросы с `ORDER BY` по первичному ключу и `WHERE`, имеющие условие с высокой селективностью, за счет использования буферизации. Управляется настройкой `read_in_order_use_buffering` (включена по умолчанию) и может увеличить потребление памяти запросом. [#64607](https://github.com/ClickHouse/ClickHouse/pull/64607) ([Anton Popov](https://github.com/CurtizJ)).
- Улучшена производительность загрузки метаданных `plain_rewritable`. [#65634](https://github.com/ClickHouse/ClickHouse/pull/65634) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Подключение таблиц на дисках только для чтения будет использовать меньше ресурсов за счет отказа от загрузки устаревших частей. [#65635](https://github.com/ClickHouse/ClickHouse/pull/65635) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлена поддержка minmax-гиперпрямоугольника для индексов Set. [#65676](https://github.com/ClickHouse/ClickHouse/pull/65676) ([AntiTopQuark](https://github.com/AntiTopQuark)).
- Выгрузка первичного индекса устаревших частей для снижения общего потребления памяти. [#65852](https://github.com/ClickHouse/ClickHouse/pull/65852) ([Anton Popov](https://github.com/CurtizJ)).
- Функции `replaceRegexpAll` и `replaceRegexpOne` теперь работают значительно быстрее, если шаблон тривиален, т. е. не содержит метасимволов, классов шаблонов, флагов, символов группировки и т. д. (Благодарность Taiyang Li). [#66185](https://github.com/ClickHouse/ClickHouse/pull/66185) ([Robert Schulze](https://github.com/rschu1ze)).
- Запросы s3: сокращено время повторных попыток для запросов, увеличено количество повторных попыток для резервных копий. 8,5 минут и 100 повторных попыток для запросов, 1,2 часа и 1000 повторных попыток для восстановления резервных копий. [#65232](https://github.com/ClickHouse/ClickHouse/pull/65232) ([Sema Checherinda](https://github.com/CheSema)).
- Добавлена поддержка оптимизации LIMIT в плане запроса. Добавлена поддержка проталкивания LIMIT для хранилища PostgreSQL и табличной функции. [#65454](https://github.com/ClickHouse/ClickHouse/pull/65454) ([Maksim Kita](https://github.com/kitaisreal)).
- Улучшена балансировка нагрузки ZooKeeper. Текущая сессия не истекает до тех пор, пока не станут доступны оптимальные узлы, несмотря на `fallback_session_lifetime`. Добавлена поддержка балансировки с учетом зон доступности. [#65570](https://github.com/ClickHouse/ClickHouse/pull/65570) ([Alexander Tokmakov](https://github.com/tavplubix)).
- DatabaseCatalog удаляет таблицы быстрее, используя до database_catalog_drop_table_concurrency потоков. [#66065](https://github.com/ClickHouse/ClickHouse/pull/66065) ([Sema Checherinda](https://github.com/CheSema)).


#### Улучшение {#improvement-5}

- Улучшена балансировка нагрузки ZooKeeper. Текущая сессия не истекает до тех пор, пока не станут доступны оптимальные узлы, несмотря на `fallback_session_lifetime`. Добавлена поддержка балансировки с учетом зон доступности. [#65570](https://github.com/ClickHouse/ClickHouse/pull/65570) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Настройка `optimize_trivial_insert_select` отключена по умолчанию. В большинстве случаев это должно быть полезно. Тем не менее, если вы наблюдаете замедление INSERT SELECT или увеличение использования памяти, вы можете включить её обратно или выполнить `SET compatibility = '24.6'`. [#58970](https://github.com/ClickHouse/ClickHouse/pull/58970) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Вывод трассировки стека и диагностической информации при сбое `clickhouse-client` или `clickhouse-local`. [#61109](https://github.com/ClickHouse/ClickHouse/pull/61109) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Результат `SHOW INDEX | INDEXES | INDICES | KEYS` ранее сортировался по именам столбцов первичного ключа. Поскольку это было неинтуитивно, теперь результат сортируется по позиции столбцов первичного ключа в составе первичного ключа. [#61131](https://github.com/ClickHouse/ClickHouse/pull/61131) ([Robert Schulze](https://github.com/rschu1ze)).
- Изменен механизм дедупликации для материализованных представлений. Исправлено множество случаев, таких как: - в целевой таблице: данные разделяются на 2 или более блоков, и эти блоки считаются дубликатами при параллельной вставке. - в целевой таблице MV: одинаковые блоки дедуплицируются, что происходит, когда MV часто производит одинаковые данные в результате обработки различных входных данных из-за выполнения агрегации. - в целевой таблице MV: дедуплицируются одинаковые блоки, поступающие из разных MV. [#61601](https://github.com/ClickHouse/ClickHouse/pull/61601) ([Sema Checherinda](https://github.com/CheSema)).
- Поддержка чтения партиционированных данных DeltaLake. Вывод схемы DeltaLake путем чтения метаданных вместо данных. [#63201](https://github.com/ClickHouse/ClickHouse/pull/63201) ([Kseniia Sumarokova](https://github.com/kssenii)).
- В составных протоколах уровень TLS принимал только параметры `certificateFile` и `privateKeyFile`. https://clickhouse.com/docs/operations/settings/composable-protocols. [#63985](https://github.com/ClickHouse/ClickHouse/pull/63985) ([Anton Ivashkin](https://github.com/ianton-ru)).
- Добавлено событие профилирования `SelectQueriesWithPrimaryKeyUsage`, которое показывает, сколько запросов SELECT используют первичный ключ для вычисления условия WHERE. [#64492](https://github.com/ClickHouse/ClickHouse/pull/64492) ([0x01f](https://github.com/0xfei)).
- Исправления и улучшения, связанные с `StorageS3Queue`. Определение значения по умолчанию для `s3queue_processing_threads_num` в соответствии с количеством физических ядер процессора на сервере (вместо предыдущего значения по умолчанию 1). Установка значения по умолчанию для `s3queue_loading_retries` равным 10. Исправление возможного неопределенного исключения «Uncaught exception» в столбце исключений `system.s3queue`. Отказ от увеличения счетчика повторных попыток при исключении `MEMORY_LIMIT_EXCEEDED`. Перенос фиксации файлов на этап после полного завершения вставки в таблицу, чтобы избежать фиксации файлов до их вставки. Добавление настроек `s3queue_max_processed_files_before_commit`, `s3queue_max_processed_rows_before_commit`, `s3queue_max_processed_bytes_before_commit`, `s3queue_max_processing_time_sec_before_commit` для лучшего контроля времени фиксации и сброса. [#65046](https://github.com/ClickHouse/ClickHouse/pull/65046) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Поддержка псевдонимов в параметризованной функции представления (только новый анализатор). [#65190](https://github.com/ClickHouse/ClickHouse/pull/65190) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Обновлено для маскировки ключа учетной записи в логах azureBlobStorage. [#65273](https://github.com/ClickHouse/ClickHouse/pull/65273) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Отсечение партиций для предикатов `IN`, когда выражение фильтра является частью выражения `PARTITION BY`. [#65335](https://github.com/ClickHouse/ClickHouse/pull/65335) ([Eduard Karacharov](https://github.com/korowa)).
- `arrayMin`/`arrayMax` могут применяться ко всем сравнимым типам данных. [#65455](https://github.com/ClickHouse/ClickHouse/pull/65455) ([pn](https://github.com/chloro-pn)).
- Улучшен учет памяти для cgroups v2 с исключением объема, занимаемого кешем страниц. [#65470](https://github.com/ClickHouse/ClickHouse/pull/65470) ([Nikita Taranov](https://github.com/nickitat)).
- Отказ от создания настроек формата для каждой строки при сериализации фрагментов для вставки в таблицу EmbeddedRocksDB. [#65474](https://github.com/ClickHouse/ClickHouse/pull/65474) ([Duc Canh Le](https://github.com/canhld94)).
- Сокращение приглашения `clickhouse-local` до просто `:)`. `getFQDNOrHostName()` выполняется слишком долго на macOS, и нам в любом случае не нужно имя хоста в приглашении для `clickhouse-local`. [#65510](https://github.com/ClickHouse/ClickHouse/pull/65510) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Отказ от вывода сообщения от jemalloc об аренах для каждого процессора на виртуальных машинах низкого уровня. [#65532](https://github.com/ClickHouse/ClickHouse/pull/65532) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Отключение фоновой загрузки кеша файловой системы по умолчанию. Она будет включена обратно, когда мы исправим проблему с возможным «Memory limit exceeded», поскольку освобождение памяти происходит вне контекста запроса (в то время как буфер выделяется внутри контекста запроса) при использовании потоков фоновой загрузки. Кроме того, необходимо добавить отдельную настройку для определения максимального размера загрузки для фоновых обработчиков (в настоящее время он ограничен max_file_segment_size, что может быть слишком большим). [#65534](https://github.com/ClickHouse/ClickHouse/pull/65534) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлена новая опция в конфигурацию `<config_reload_interval_ms>`, которая позволяет указать, как часто ClickHouse будет перезагружать конфигурацию. [#65545](https://github.com/ClickHouse/ClickHouse/pull/65545) ([alesapin](https://github.com/alesapin)).
- Реализовано двоичное кодирование для типов данных ClickHouse и добавлена его спецификация в документацию. Использование в динамической двоичной сериализации, возможность использования в форматах RowBinaryWithNamesAndTypes и Native в соответствии с настройками. [#65546](https://github.com/ClickHouse/ClickHouse/pull/65546) ([Kruglov Pavel](https://github.com/Avogar)).
- Настройки сервера `compiled_expression_cache_size` и `compiled_expression_cache_elements_size` теперь отображаются в `system.server_settings`. [#65584](https://github.com/ClickHouse/ClickHouse/pull/65584) ([Robert Schulze](https://github.com/rschu1ze)).
- Добавлена поддержка идентификации пользователей на основе расширения x509 SubjectAltName. [#65626](https://github.com/ClickHouse/ClickHouse/pull/65626) ([Anton Kozlov](https://github.com/tonickkozlov)).
- `clickhouse-local` будет учитывать `max_server_memory_usage` и `max_server_memory_usage_to_ram_ratio` из файла конфигурации. Также по умолчанию будет установлено максимальное использование памяти на уровне 90% системной памяти, как это делает `clickhouse-server`. [#65697](https://github.com/ClickHouse/ClickHouse/pull/65697) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлен скрипт для резервного копирования файлов в ClickHouse. [#65699](https://github.com/ClickHouse/ClickHouse/pull/65699) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Источник PostgreSQL для поддержки отмены запросов. [#65722](https://github.com/ClickHouse/ClickHouse/pull/65722) ([Maksim Kita](https://github.com/kitaisreal)).
- Управление `allow_experimental_analyzer` инициатором для распределенных запросов. Это обеспечивает совместимость и корректность при операциях в кластерах со смешанными версиями. [#65777](https://github.com/ClickHouse/ClickHouse/pull/65777) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Учет ограничения CPU cgroup в Keeper. [#65819](https://github.com/ClickHouse/ClickHouse/pull/65819) ([Antonio Andelic](https://github.com/antonio2368)).
- Разрешено использование функции `concat` с пустыми аргументами `:) select concat();`. [#65887](https://github.com/ClickHouse/ClickHouse/pull/65887) ([李扬](https://github.com/taiyang-li)).
- Разрешено управление именованными коллекциями в `clickhouse-local`. [#65973](https://github.com/ClickHouse/ClickHouse/pull/65973) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Улучшены события профилирования, связанные с Azure. [#65999](https://github.com/ClickHouse/ClickHouse/pull/65999) ([alesapin](https://github.com/alesapin)).
- Поддержка чтения файлов ORC с учетом часового пояса записывающего устройства. [#66025](https://github.com/ClickHouse/ClickHouse/pull/66025) ([kevinyhzou](https://github.com/KevinyhZou)).
- Добавлены настройки для управления подключениями к PostgreSQL. Настройка `postgresql_connection_attempt_timeout` указывает значение, передаваемое параметру `connect_timeout` URL подключения. Настройка `postgresql_connection_pool_retries` указывает количество повторных попыток установления соединения с конечной точкой PostgreSQL. [#66232](https://github.com/ClickHouse/ClickHouse/pull/66232) ([Dmitry Novik](https://github.com/novikd)).
- Снижена неточность `input_wait_elapsed_us`/`elapsed_us` в `system.processors_profile_log`. [#66239](https://github.com/ClickHouse/ClickHouse/pull/66239) ([Azat Khuzhin](https://github.com/azat)).
- Улучшены ProfileEvents для кеша файловой системы. [#66249](https://github.com/ClickHouse/ClickHouse/pull/66249) ([zhukai](https://github.com/nauu)).
- Добавлены настройки для игнорирования условия `ON CLUSTER` в запросах для управления именованными коллекциями с реплицируемым хранилищем. [#66288](https://github.com/ClickHouse/ClickHouse/pull/66288) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Функция `generateSnowflakeID` теперь позволяет указать идентификатор машины в качестве параметра для предотвращения коллизий в больших кластерах. [#66374](https://github.com/ClickHouse/ClickHouse/pull/66374) ([ZAWA_ll](https://github.com/Zawa-ll)).
- Отключение приостановки по `Ctrl+Z` в интерактивном режиме. Это распространенная ловушка и не является ожидаемым поведением для почти всех пользователей. Я полагаю, что только несколько экстремальных опытных пользователей могли бы оценить приостановку терминальных приложений в фоновом режиме, но я таких не знаю. [#66511](https://github.com/ClickHouse/ClickHouse/pull/66511) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлена опция для проверки типа первичного ключа в словарях. Без этой опции для простых макетов любой тип столбца будет неявно преобразован в UInt64. [#66595](https://github.com/ClickHouse/ClickHouse/pull/66595) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).





#### Исправление ошибок (видимые пользователю проблемы в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-4}

- Check cyclic dependencies on CREATE/REPLACE/RENAME/EXCHANGE queries and throw an exception if there is a cyclic dependency. Previously such cyclic dependencies could lead to a deadlock during server startup. Also fix some bugs in dependencies creation. [#65405](https://github.com/ClickHouse/ClickHouse/pull/65405) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix unexpected sizes of `LowCardinality` columns in function calls. [#65298](https://github.com/ClickHouse/ClickHouse/pull/65298) ([Raúl Marín](https://github.com/Algunenano)).
- Fix crash in maxIntersections. [#65689](https://github.com/ClickHouse/ClickHouse/pull/65689) ([Raúl Marín](https://github.com/Algunenano)).
- Fix the `VALID UNTIL` clause in the user definition resetting after a restart. [#66409](https://github.com/ClickHouse/ClickHouse/pull/66409) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix the remaining time column in `SHOW MERGES`. [#66735](https://github.com/ClickHouse/ClickHouse/pull/66735) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- `Query was cancelled` might have been printed twice in clickhouse-client. This behaviour is fixed. [#66005](https://github.com/ClickHouse/ClickHouse/pull/66005) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Fixed crash while using `MaterializedMySQL` (which is an unsupported, experimental feature) with TABLE OVERRIDE that maps MySQL NULL field into ClickHouse not NULL field. [#54649](https://github.com/ClickHouse/ClickHouse/pull/54649) ([Filipp Ozinov](https://github.com/bakwc)).
- Fix logical error when `PREWHERE` expression read no columns and table has no adaptive index granularity (very old table). [#59173](https://github.com/ClickHouse/ClickHouse/pull/59173) ([Alexander Gololobov](https://github.com/davenger)).
- Fix bug with the cancellation buffer when canceling a query. [#64478](https://github.com/ClickHouse/ClickHouse/pull/64478) ([Sema Checherinda](https://github.com/CheSema)).
- Fix filling parts columns from metadata (when columns.txt does not exists). [#64757](https://github.com/ClickHouse/ClickHouse/pull/64757) ([Azat Khuzhin](https://github.com/azat)).
- Fix crash for `ALTER TABLE ... ON CLUSTER ... MODIFY SQL SECURITY`. [#64957](https://github.com/ClickHouse/ClickHouse/pull/64957) ([pufit](https://github.com/pufit)).
- Fix crash on destroying AccessControl: add explicit shutdown. [#64993](https://github.com/ClickHouse/ClickHouse/pull/64993) ([Vitaly Baranov](https://github.com/vitlibar)).
- Eliminate injective function in argument of functions `uniq*` recursively. This used to work correctly but was broken in the new analyzer. [#65140](https://github.com/ClickHouse/ClickHouse/pull/65140) ([Duc Canh Le](https://github.com/canhld94)).
- Fix unexpected projection name when query with CTE. [#65267](https://github.com/ClickHouse/ClickHouse/pull/65267) ([wudidapaopao](https://github.com/wudidapaopao)).
- Require `dictGet` privilege when accessing dictionaries via direct query or the `Dictionary` table engine. [#65359](https://github.com/ClickHouse/ClickHouse/pull/65359) ([Joe Lynch](https://github.com/joelynch)).
- Fix user-specific S3 auth with incremental backups. [#65481](https://github.com/ClickHouse/ClickHouse/pull/65481) ([Antonio Andelic](https://github.com/antonio2368)).
- Disable `non-intersecting-parts` optimization for queries with `FINAL` in case of `read-in-order` optimization was enabled. This could lead to an incorrect query result. As a workaround, disable `do_not_merge_across_partitions_select_final` and `split_parts_ranges_into_intersecting_and_non_intersecting_final` before this fix is merged. [#65505](https://github.com/ClickHouse/ClickHouse/pull/65505) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix getting exception `Index out of bound for blob metadata` in case all files from list batch were filtered out. [#65523](https://github.com/ClickHouse/ClickHouse/pull/65523) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix NOT_FOUND_COLUMN_IN_BLOCK for deduplicate merge of projection. [#65573](https://github.com/ClickHouse/ClickHouse/pull/65573) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fixed bug in MergeJoin. Column in sparse serialisation might be treated as a column of its nested type though the required conversion wasn't performed. [#65632](https://github.com/ClickHouse/ClickHouse/pull/65632) ([Nikita Taranov](https://github.com/nickitat)).
- Fixed a bug that compatibility level '23.4' was not properly applied. [#65737](https://github.com/ClickHouse/ClickHouse/pull/65737) ([cw5121](https://github.com/cw5121)).
- Fix odbc table with nullable fields. [#65738](https://github.com/ClickHouse/ClickHouse/pull/65738) ([Rodolphe Dugé de Bernonville](https://github.com/RodolpheDuge)).
- Fix data race in `TCPHandler`, which could happen on fatal error. [#65744](https://github.com/ClickHouse/ClickHouse/pull/65744) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix invalid exceptions in function `parseDateTime` with `%F` and `%D` placeholders. [#65768](https://github.com/ClickHouse/ClickHouse/pull/65768) ([Antonio Andelic](https://github.com/antonio2368)).
- For queries that read from `PostgreSQL`, cancel the internal `PostgreSQL` query if the ClickHouse query is finished. Otherwise, `ClickHouse` query cannot be canceled until the internal `PostgreSQL` query is finished. [#65771](https://github.com/ClickHouse/ClickHouse/pull/65771) ([Maksim Kita](https://github.com/kitaisreal)).
- Fix a bug in short circuit logic when old analyzer and dictGetOrDefault is used. [#65802](https://github.com/ClickHouse/ClickHouse/pull/65802) ([jsc0218](https://github.com/jsc0218)).
- Fix a bug leads to EmbeddedRocksDB with TTL write corrupted SST files. [#65816](https://github.com/ClickHouse/ClickHouse/pull/65816) ([Duc Canh Le](https://github.com/canhld94)).
- Functions `bitTest`, `bitTestAll`, and `bitTestAny` now return an error if the specified bit index is out-of-bounds [#65818](https://github.com/ClickHouse/ClickHouse/pull/65818) ([Pablo Marcos](https://github.com/pamarcos)).
- Setting `join_any_take_last_row` is supported in any query with hash join. [#65820](https://github.com/ClickHouse/ClickHouse/pull/65820) ([vdimir](https://github.com/vdimir)).
- Better handling of join conditions involving `IS NULL` checks (for example `ON (a = b AND (a IS NOT NULL) AND (b IS NOT NULL) ) OR ( (a IS NULL) AND (b IS NULL) )` is rewritten to `ON a <=> b`), fix incorrect optimization when condition other then `IS NULL` are present. [#65835](https://github.com/ClickHouse/ClickHouse/pull/65835) ([vdimir](https://github.com/vdimir)).
- Fix growing memory usage in S3Queue. [#65839](https://github.com/ClickHouse/ClickHouse/pull/65839) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix tie handling in `arrayAUC` to match sklearn. [#65840](https://github.com/ClickHouse/ClickHouse/pull/65840) ([gabrielmcg44](https://github.com/gabrielmcg44)).
- Fix possible issues with MySQL server protocol TLS connections. [#65917](https://github.com/ClickHouse/ClickHouse/pull/65917) ([Azat Khuzhin](https://github.com/azat)).
- Fix possible issues with MySQL client protocol TLS connections. [#65938](https://github.com/ClickHouse/ClickHouse/pull/65938) ([Azat Khuzhin](https://github.com/azat)).
- Fix handling of `SSL_ERROR_WANT_READ`/`SSL_ERROR_WANT_WRITE` with zero timeout. [#65941](https://github.com/ClickHouse/ClickHouse/pull/65941) ([Azat Khuzhin](https://github.com/azat)).
- Add missing settings `input_format_csv_skip_first_lines/input_format_tsv_skip_first_lines/input_format_csv_try_infer_numbers_from_strings/input_format_csv_try_infer_strings_from_quoted_tuples` in schema inference cache because they can change the resulting schema. It prevents from incorrect result of schema inference with these settings changed. [#65980](https://github.com/ClickHouse/ClickHouse/pull/65980) ([Kruglov Pavel](https://github.com/Avogar)).
- Column \_size in s3 engine and s3 table function denotes the size of a file inside the archive, not a size of the archive itself. [#65993](https://github.com/ClickHouse/ClickHouse/pull/65993) ([Daniil Ivanik](https://github.com/divanik)).
- Fix resolving dynamic subcolumns in analyzer, avoid reading the whole column on dynamic subcolumn reading. [#66004](https://github.com/ClickHouse/ClickHouse/pull/66004) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix config merging for from_env with replace overrides. [#66034](https://github.com/ClickHouse/ClickHouse/pull/66034) ([Azat Khuzhin](https://github.com/azat)).
- Fix a possible hanging in `GRPCServer` during shutdown. [#66061](https://github.com/ClickHouse/ClickHouse/pull/66061) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fixed several cases in function `has` with non-constant `LowCardinality` arguments. [#66088](https://github.com/ClickHouse/ClickHouse/pull/66088) ([Anton Popov](https://github.com/CurtizJ)).
- Fix for `groupArrayIntersect`. It had incorrect behavior in the `merge()` function. Also, fixed behavior in `deserialise()` for numeric and general data. [#66103](https://github.com/ClickHouse/ClickHouse/pull/66103) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fixed buffer overflow bug in `unbin`/`unhex` implementation. [#66106](https://github.com/ClickHouse/ClickHouse/pull/66106) ([Nikita Taranov](https://github.com/nickitat)).
- Disable the `merge-filters` optimization introduced in [#64760](https://github.com/ClickHouse/ClickHouse/issues/64760). It may cause an exception if optimization merges two filter expressions and does not apply a short-circuit evaluation. [#66126](https://github.com/ClickHouse/ClickHouse/pull/66126) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fixed the issue when the server failed to parse Avro files with negative block size arrays encoded, which is now allowed by the Avro specification. [#66130](https://github.com/ClickHouse/ClickHouse/pull/66130) ([Serge Klochkov](https://github.com/slvrtrn)).
- Fixed a bug in ZooKeeper client: a session could get stuck in unusable state after receiving a hardware error from ZooKeeper. For example, this might happen due to "soft memory limit" in ClickHouse Keeper. [#66140](https://github.com/ClickHouse/ClickHouse/pull/66140) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix issue in SumIfToCountIfVisitor and signed integers. [#66146](https://github.com/ClickHouse/ClickHouse/pull/66146) ([Raúl Marín](https://github.com/Algunenano)).
- Fix rare case with missing data in the result of distributed query. [#66174](https://github.com/ClickHouse/ClickHouse/pull/66174) ([vdimir](https://github.com/vdimir)).
- Fix order of parsing metadata fields in StorageDeltaLake. [#66211](https://github.com/ClickHouse/ClickHouse/pull/66211) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Don't throw `TIMEOUT_EXCEEDED` for `none_only_active` mode of `distributed_ddl_output_mode`. [#66218](https://github.com/ClickHouse/ClickHouse/pull/66218) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix handling limit for `system.numbers_mt` when no index can be used. [#66231](https://github.com/ClickHouse/ClickHouse/pull/66231) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fixed how the ClickHouse server detects the maximum number of usable CPU cores as specified by cgroups v2 if the server runs in a container such as Docker. In more detail, containers often run their process in the root cgroup which has an empty name. In that case, ClickHouse ignored the CPU limits set by cgroups v2. [#66237](https://github.com/ClickHouse/ClickHouse/pull/66237) ([filimonov](https://github.com/filimonov)).
- Fix the `Not-ready set` error when a subquery with `IN` is used in the constraint. [#66261](https://github.com/ClickHouse/ClickHouse/pull/66261) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix error reporting while copying to S3 or AzureBlobStorage. [#66295](https://github.com/ClickHouse/ClickHouse/pull/66295) ([Vitaly Baranov](https://github.com/vitlibar)).
- Prevent watchdog from keeping descriptors of unlinked (rotated) log files. [#66334](https://github.com/ClickHouse/ClickHouse/pull/66334) ([Aleksei Filatov](https://github.com/aalexfvk)).
- Fix the bug that logicalexpressionoptimizerpass lost logical type of constant. [#66344](https://github.com/ClickHouse/ClickHouse/pull/66344) ([pn](https://github.com/chloro-pn)).
- Fix `Column identifier is already registered` error with `group_by_use_nulls=true` and new analyzer. [#66400](https://github.com/ClickHouse/ClickHouse/pull/66400) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix possible incorrect result for queries joining and filtering table external engine (like PostgreSQL), due to too aggressive filter pushdown. Since now, conditions from where section won't be send to external database in case of outer join with external table. [#66402](https://github.com/ClickHouse/ClickHouse/pull/66402) ([vdimir](https://github.com/vdimir)).
- Added missing column materialization for cross join. [#66413](https://github.com/ClickHouse/ClickHouse/pull/66413) ([lgbo](https://github.com/lgbo-ustc)).
- Fix `Cannot find column` error for queries with constant expression in `GROUP BY` key and new analyzer enabled. [#66433](https://github.com/ClickHouse/ClickHouse/pull/66433) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Avoid possible logical error during import from Npy format in case of bad array nesting level, fix testing of other kinds of errors. [#66461](https://github.com/ClickHouse/ClickHouse/pull/66461) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix wrong count() result when there is non-deterministic function in predicate. [#66510](https://github.com/ClickHouse/ClickHouse/pull/66510) ([Duc Canh Le](https://github.com/canhld94)).
- Correctly track memory for `Allocator::realloc`. [#66548](https://github.com/ClickHouse/ClickHouse/pull/66548) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix reading of uninitialized memory when hashing empty tuples. [#66562](https://github.com/ClickHouse/ClickHouse/pull/66562) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix an invalid result for queries with `WINDOW`. This could happen when `PARTITION` columns have sparse serialization and window functions are executed in parallel. [#66579](https://github.com/ClickHouse/ClickHouse/pull/66579) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix removing named collections in local storage. [#66599](https://github.com/ClickHouse/ClickHouse/pull/66599) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fix `column_length` is not updated in `ColumnTuple::insertManyFrom`. [#66626](https://github.com/ClickHouse/ClickHouse/pull/66626) ([lgbo](https://github.com/lgbo-ustc)).
- Fix `Unknown identifier` and `Column is not under aggregate function` errors for queries with the expression `(column IS NULL).` The bug was triggered by [#65088](https://github.com/ClickHouse/ClickHouse/issues/65088), with the disabled analyzer only. [#66654](https://github.com/ClickHouse/ClickHouse/pull/66654) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix `Method getResultType is not supported for QUERY query node` error when scalar subquery was used as the first argument of IN (with new analyzer). [#66655](https://github.com/ClickHouse/ClickHouse/pull/66655) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix possible PARAMETER_OUT_OF_BOUND error during reading variant subcolumn. [#66659](https://github.com/ClickHouse/ClickHouse/pull/66659) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix rare case of stuck merge after drop column. [#66707](https://github.com/ClickHouse/ClickHouse/pull/66707) ([Raúl Marín](https://github.com/Algunenano)).
- Fix assertion `isUniqTypes` when insert select from remote sources. [#66722](https://github.com/ClickHouse/ClickHouse/pull/66722) ([Sema Checherinda](https://github.com/CheSema)).
- Fix logical error in PrometheusRequestHandler. [#66621](https://github.com/ClickHouse/ClickHouse/pull/66621) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix `indexHint` function case found by fuzzer. [#66286](https://github.com/ClickHouse/ClickHouse/pull/66286) ([Anton Popov](https://github.com/CurtizJ)).
- Fix AST formatting of 'create table b empty as a'. [#64951](https://github.com/ClickHouse/ClickHouse/pull/64951) ([Michael Kolupaev](https://github.com/al13n321)).

### <a id="246"></a> Релиз ClickHouse 24.6, 2024-07-01 {#a-id246a-clickhouse-release-246-2024-07-01}

#### Обратно несовместимые изменения {#backward-incompatible-change-6}

- По умолчанию включена асинхронная загрузка баз данных и таблиц. См. параметр `async_load_databases` в config.xml. Хотя это изменение полностью совместимо, оно может привести к изменению поведения. Когда `async_load_databases` имеет значение false, как в предыдущих версиях, сервер не принимает соединения до тех пор, пока не будут загружены все таблицы. Когда `async_load_databases` имеет значение true, как в новой версии, сервер может принимать соединения до того, как будут загружены все таблицы. Если выполняется запрос к таблице, которая еще не загружена, он будет ожидать загрузки таблицы, что может занять значительное время. Это может изменить поведение сервера, если он является частью большой распределенной системы под балансировщиком нагрузки. В первом случае балансировщик нагрузки может получить отказ в соединении и быстро переключиться на другой сервер. Во втором случае балансировщик нагрузки может подключиться к серверу, который все еще загружает таблицы, и запрос будет иметь более высокую задержку. Более того, если множество запросов накапливается в состоянии ожидания, это может привести к проблеме «лавинообразного наплыва» (thundering herd), когда они начинают обрабатываться одновременно. Это может иметь значение только для высоконагруженных распределенных бэкендов. Вы можете установить значение `async_load_databases` в false, чтобы избежать этой проблемы. [#57695](https://github.com/ClickHouse/ClickHouse/pull/57695) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Настройка `replace_long_file_name_to_hash` включена по умолчанию для таблиц `MergeTree`. [#64457](https://github.com/ClickHouse/ClickHouse/pull/64457) ([Anton Popov](https://github.com/CurtizJ)). Эта настройка полностью совместима, и никаких действий при обновлении не требуется. Новый формат данных поддерживается всеми версиями начиная с 23.9. После включения этой настройки вы больше не сможете откатиться к версии 23.8 или более ранней.
- Некоторые некорректные запросы будут завершаться с ошибкой раньше на этапе парсинга. Примечание: отключена поддержка встроенных выражений KQL (экспериментальный язык Kusto), когда они помещаются в табличную функцию `kql` без строкового литерала, например `kql(garbage | trash)` вместо `kql('garbage | trash')` или `kql($$garbage | trash$$)`. Эта функция была введена непреднамеренно и не должна существовать. [#61500](https://github.com/ClickHouse/ClickHouse/pull/61500) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Переработана параллельная обработка в режиме `Ordered` хранилища `S3Queue`. Это изменение обратно несовместимо для режима Ordered, если вы использовали настройки `s3queue_processing_threads_num` или `s3queue_total_shards_num`. Настройка `s3queue_total_shards_num` удалена, ранее её можно было использовать только с `s3queue_allow_experimental_sharded_mode`, который теперь устарел. Добавлена новая настройка — `s3queue_buckets`. [#64349](https://github.com/ClickHouse/ClickHouse/pull/64349) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлены новые функции `snowflakeIDToDateTime`, `snowflakeIDToDateTime64`, `dateTimeToSnowflakeID` и `dateTime64ToSnowflakeID`. В отличие от существующих функций `snowflakeToDateTime`, `snowflakeToDateTime64`, `dateTimeToSnowflake` и `dateTime64ToSnowflake`, новые функции совместимы с функцией `generateSnowflakeID`, т.е. они принимают идентификаторы snowflake, сгенерированные `generateSnowflakeID`, и создают идентификаторы snowflake того же типа, что и `generateSnowflakeID` (т.е. `UInt64`). Кроме того, новые функции по умолчанию используют эпоху UNIX (т.е. 1970-01-01), так же как и `generateSnowflakeID`. При необходимости можно передать другую эпоху, например, эпоху Twitter/X 2010-11-04, т.е. 1288834974657 мс с эпохи UNIX. Старые функции преобразования устарели и будут удалены после переходного периода: чтобы использовать их в любом случае, включите настройку `allow_deprecated_snowflake_conversion_functions`. [#64948](https://github.com/ClickHouse/ClickHouse/pull/64948) ([Robert Schulze](https://github.com/rschu1ze)).


#### Новые возможности {#new-feature-6}

- Добавлена возможность хранения именованных коллекций в ClickHouse Keeper. [#64574](https://github.com/ClickHouse/ClickHouse/pull/64574) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлена поддержка пустых кортежей. [#55061](https://github.com/ClickHouse/ClickHouse/pull/55061) ([Amos Bird](https://github.com/amosbird)).
- Добавлены функции кодирования и декодирования кривой Гильберта. [#60156](https://github.com/ClickHouse/ClickHouse/pull/60156) ([Artem Mustafin](https://github.com/Artemmm91)).
- Добавлена поддержка анализа индексов для функции `hilbertEncode`. [#64662](https://github.com/ClickHouse/ClickHouse/pull/64662) ([Artem Mustafin](https://github.com/Artemmm91)).
- Добавлена поддержка чтения геометрии `LINESTRING` в формате WKT с помощью функции `readWKTLineString`. [#62519](https://github.com/ClickHouse/ClickHouse/pull/62519) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Добавлена возможность присоединения частей с другого диска. [#63087](https://github.com/ClickHouse/ClickHouse/pull/63087) ([Unalian](https://github.com/Unalian)).
- Добавлена новая SQL-функция `generateSnowflakeID` для генерации идентификаторов Snowflake в стиле Twitter. [#63577](https://github.com/ClickHouse/ClickHouse/pull/63577) ([Danila Puzov](https://github.com/kazalika)).
- Добавлены настройки `merge_workload` и `mutation_workload` для регулирования использования и распределения ресурсов между слияниями, мутациями и другими рабочими нагрузками. [#64061](https://github.com/ClickHouse/ClickHouse/pull/64061) ([Sergei Trifonov](https://github.com/serxa)).
- Добавлена поддержка сравнения типов `IPv4` и `IPv6` с помощью оператора `=`. [#64292](https://github.com/ClickHouse/ClickHouse/pull/64292) ([Francisco J. Jurado Moreno](https://github.com/Beetelbrox)).
- Добавлена поддержка десятичных аргументов в бинарных математических функциях (pow, atan2, max2, min2, hypot). [#64582](https://github.com/ClickHouse/ClickHouse/pull/64582) ([Mikhail Gorshkov](https://github.com/mgorshkov)).
- Добавлены SQL-функции `parseReadableSize` (вместе с вариантами `OrNull` и `OrZero`). [#64742](https://github.com/ClickHouse/ClickHouse/pull/64742) ([Francisco J. Jurado Moreno](https://github.com/Beetelbrox)).
- Добавлены серверные настройки `max_table_num_to_throw` и `max_database_num_to_throw` для ограничения количества баз данных или таблиц при выполнении запросов `CREATE`. [#64781](https://github.com/ClickHouse/ClickHouse/pull/64781) ([Xu Jia](https://github.com/XuJia0210)).
- Добавлен виртуальный столбец `_time` для файловых хранилищ (s3/file/hdfs/url/azureBlobStorage). [#64947](https://github.com/ClickHouse/ClickHouse/pull/64947) ([Ilya Golshtein](https://github.com/ilejn)).
- Добавлены новые функции `base64URLEncode`, `base64URLDecode` и `tryBase64URLDecode`. [#64991](https://github.com/ClickHouse/ClickHouse/pull/64991) ([Mikhail Gorshkov](https://github.com/mgorshkov)).
- Добавлена новая функция `editDistanceUTF8`, которая вычисляет [расстояние редактирования](https://en.wikipedia.org/wiki/Edit_distance) между двумя строками UTF8. [#65269](https://github.com/ClickHouse/ClickHouse/pull/65269) ([LiuNeng](https://github.com/liuneng1994)).
- Добавлена конфигурация `http_response_headers` для поддержки пользовательских заголовков ответа в пользовательских HTTP-обработчиках. [#63562](https://github.com/ClickHouse/ClickHouse/pull/63562) ([Grigorii](https://github.com/GSokol)).
- Добавлена новая табличная функция `loop` для поддержки возврата результатов запроса в бесконечном цикле. [#63452](https://github.com/ClickHouse/ClickHouse/pull/63452) ([Sariel](https://github.com/sarielwxm)). Это полезно для тестирования.
- Добавлены два дополнительных столбца в таблицу `system.query_log`: `used_privileges` и `missing_privileges`. Столбец `used_privileges` содержит привилегии, которые были проверены во время выполнения запроса, а `missing_privileges` содержит отсутствующие необходимые привилегии. [#64597](https://github.com/ClickHouse/ClickHouse/pull/64597) ([Alexey Katsman](https://github.com/alexkats)).
- Добавлена настройка `output_format_pretty_display_footer_column_names`, которая при включении отображает имена столбцов в конце таблицы для длинных таблиц (по умолчанию 50 строк), при этом пороговое значение минимального количества строк контролируется параметром `output_format_pretty_display_footer_column_names_min_rows`. [#65144](https://github.com/ClickHouse/ClickHouse/pull/65144) ([Shaun Struwig](https://github.com/Blargian)).

#### Экспериментальная функциональность {#experimental-feature-5}

- Введена статистика типа «количество уникальных значений». [#59357](https://github.com/ClickHouse/ClickHouse/pull/59357) ([Han Fei](https://github.com/hanfei1991)).
- Добавлена поддержка статистики для ReplicatedMergeTree. [#64934](https://github.com/ClickHouse/ClickHouse/pull/64934) ([Han Fei](https://github.com/hanfei1991)).
- Если для базы данных `Replicated` настроена «группа реплик», автоматически создаётся кластер, включающий реплики из всех групп. [#64312](https://github.com/ClickHouse/ClickHouse/pull/64312) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Добавлены настройки `parallel_replicas_custom_key_range_lower` и `parallel_replicas_custom_key_range_upper` для управления параллелизацией запросов параллельными репликами с динамическими шардами при использовании фильтра по диапазону. [#64604](https://github.com/ClickHouse/ClickHouse/pull/64604) ([josh-hildred](https://github.com/josh-hildred)).


#### Улучшение производительности {#performance-improvement-6}

- Добавлена возможность перемешивания строк во время вставки для оптимизации размера без нарушения порядка, установленного `PRIMARY KEY`. Управляется настройкой `optimize_row_order` (по умолчанию отключена). [#63578](https://github.com/ClickHouse/ClickHouse/pull/63578) ([Igor Markelov](https://github.com/ElderlyPassionFruit)).
- Добавлен нативный читатель parquet, который может читать бинарные данные parquet непосредственно в столбцы ClickHouse. Управляется настройкой `input_format_parquet_use_native_reader` (по умолчанию отключена). [#60361](https://github.com/ClickHouse/ClickHouse/pull/60361) ([ZhiHong Zhang](https://github.com/copperybean)).
- Добавлена поддержка частичной тривиальной оптимизации подсчёта, когда фильтр запроса способен выбирать точные диапазоны из таблиц семейства MergeTree. [#60463](https://github.com/ClickHouse/ClickHouse/pull/60463) ([Amos Bird](https://github.com/amosbird)).
- Снижено максимальное потребление памяти многопоточными операциями `INSERT` за счёт сбора фрагментов из нескольких потоков в одном преобразовании. [#61047](https://github.com/ClickHouse/ClickHouse/pull/61047) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Снижено потребление памяти при использовании объектного хранилища Azure за счёт использования фиксированного выделения памяти, что позволяет избежать выделения дополнительного буфера. [#63160](https://github.com/ClickHouse/ClickHouse/pull/63160) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Уменьшено количество вызовов виртуальных функций в `ColumnNullable::size`. [#60556](https://github.com/ClickHouse/ClickHouse/pull/60556) ([HappenLee](https://github.com/HappenLee)).
- Ускорена функция `splitByRegexp`, когда аргумент регулярного выражения состоит из одного символа. [#62696](https://github.com/ClickHouse/ClickHouse/pull/62696) ([Robert Schulze](https://github.com/rschu1ze)).
- Ускорена агрегация по 8-битным и 16-битным ключам за счёт отслеживания минимальных и максимальных используемых ключей. Это позволяет уменьшить количество ячеек, которые необходимо проверить. [#62746](https://github.com/ClickHouse/ClickHouse/pull/62746) ([Jiebin Sun](https://github.com/jiebinn)).
- Оптимизирован оператор IN, когда левая часть имеет тип `LowCardinality`, а правая представляет собой набор констант. [#64060](https://github.com/ClickHouse/ClickHouse/pull/64060) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
- Используется пул потоков для инициализации и уничтожения хеш-таблиц внутри `ConcurrentHashJoin`. [#64241](https://github.com/ClickHouse/ClickHouse/pull/64241) ([Nikita Taranov](https://github.com/nickitat)).
- Оптимизированы вертикальные слияния в таблицах с разреженными столбцами. [#64311](https://github.com/ClickHouse/ClickHouse/pull/64311) ([Anton Popov](https://github.com/CurtizJ)).
- Включена предварительная выборка данных из удалённой файловой системы во время вертикальных слияний. Это улучшает задержку вертикальных слияний в таблицах с данными, хранящимися в удалённой файловой системе. [#64314](https://github.com/ClickHouse/ClickHouse/pull/64314) ([Anton Popov](https://github.com/CurtizJ)).
- Уменьшено количество избыточных вызовов `isDefault` в `ColumnSparse::filter` для повышения производительности. [#64426](https://github.com/ClickHouse/ClickHouse/pull/64426) ([Jiebin Sun](https://github.com/jiebinn)).
- Ускорены команды keeper-client `find_super_nodes` и `find_big_family` за счёт выполнения нескольких асинхронных запросов getChildren. [#64628](https://github.com/ClickHouse/ClickHouse/pull/64628) ([Alexander Gololobov](https://github.com/davenger)).
- Улучшены функции `least`/`greatest` для аргументов числовых типов, допускающих NULL. [#64668](https://github.com/ClickHouse/ClickHouse/pull/64668) ([KevinyhZou](https://github.com/KevinyhZou)).
- Разрешено объединение двух последовательных шагов фильтрации в плане запроса. Это улучшает оптимизацию проталкивания фильтров, если условие фильтра может быть протолкнуто из родительского шага. [#64760](https://github.com/ClickHouse/ClickHouse/pull/64760) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Удалена неудачная оптимизация в реализации вертикального финального слияния и повторно включён алгоритм вертикального финального слияния по умолчанию. [#64783](https://github.com/ClickHouse/ClickHouse/pull/64783) ([Duc Canh Le](https://github.com/canhld94)).
- Удалены узлы ALIAS из выражения фильтра. Это незначительно улучшает производительность запросов с `PREWHERE` (при использовании нового анализатора). [#64793](https://github.com/ClickHouse/ClickHouse/pull/64793) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Повторно включено кеширование сессий OpenSSL. [#65111](https://github.com/ClickHouse/ClickHouse/pull/65111) ([Robert Schulze](https://github.com/rschu1ze)).
- Добавлены настройки для отключения материализации индексов пропуска и статистики при вставке (`materialize_skip_indexes_on_insert` и `materialize_statistics_on_insert`). [#64391](https://github.com/ClickHouse/ClickHouse/pull/64391) ([Anton Popov](https://github.com/CurtizJ)).
- Используется размер выделенной памяти для вычисления размера группы строк и снижения пикового потребления памяти записывающим модулем parquet в однопоточном режиме. [#64424](https://github.com/ClickHouse/ClickHouse/pull/64424) ([LiuNeng](https://github.com/liuneng1994)).
- Улучшен итератор разреженного столбца для уменьшения вызовов `size`. [#64497](https://github.com/ClickHouse/ClickHouse/pull/64497) ([Jiebin Sun](https://github.com/jiebinn)).
- Обновлено условие для использования серверного копирования при создании резервных копий в хранилище Azure Blob Storage. [#64518](https://github.com/ClickHouse/ClickHouse/pull/64518) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Оптимизировано потребление памяти вертикальными слияниями для таблиц с большим количеством индексов пропуска. [#64580](https://github.com/ClickHouse/ClickHouse/pull/64580) ([Anton Popov](https://github.com/CurtizJ)).





#### Улучшения {#improvement-6}

- `SHOW CREATE TABLE`, выполненная для системных таблиц, теперь будет показывать очень удобный комментарий, уникальный для каждой таблицы, который объясняет, зачем нужна эта таблица. [#63788](https://github.com/ClickHouse/ClickHouse/pull/63788) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Второй аргумент (масштаб) функций `round()`, `roundBankers()`, `floor()`, `ceil()` и `trunc()` теперь может быть неконстантным. [#64798](https://github.com/ClickHouse/ClickHouse/pull/64798) ([Mikhail Gorshkov](https://github.com/mgorshkov)).
- Горячая перезагрузка политики хранения для таблиц `Distributed` при добавлении нового диска. [#58285](https://github.com/ClickHouse/ClickHouse/pull/58285) ([Duc Canh Le](https://github.com/canhld94)).
- Предотвращение возможной взаимной блокировки во время анализа индекса MergeTree при планировании потоков в перегруженном сервисе. [#59427](https://github.com/ClickHouse/ClickHouse/pull/59427) ([Sean Haynes](https://github.com/seandhaynes)).
- Несколько незначительных исправлений граничных случаев для поддержки прокси S3 и туннелирования. [#63427](https://github.com/ClickHouse/ClickHouse/pull/63427) ([Arthur Passos](https://github.com/arthurpassos)).
- Улучшена видимость повторной отправки io_uring. Событие профилирования `IOUringSQEsResubmits` переименовано в `IOUringSQEsResubmitsAsync` и добавлено новое событие `IOUringSQEsResubmitsSync`. [#63699](https://github.com/ClickHouse/ClickHouse/pull/63699) ([Tomer Shafir](https://github.com/tomershafir)).
- Добавлена новая настройка `metadata_keep_free_space_bytes` для резервирования свободного места на диске хранения метаданных. [#64128](https://github.com/ClickHouse/ClickHouse/pull/64128) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Добавлены метрики для отслеживания количества каталогов, созданных и удаленных хранилищем метаданных `plain_rewritable`, а также количества записей в отображении локальных и удаленных данных в памяти. [#64175](https://github.com/ClickHouse/ClickHouse/pull/64175) ([Julia Kartseva](https://github.com/jkartseva)).
- Кеш запросов теперь рассматривает идентичные запросы с разными настройками как различные. Это повышает надежность в случаях, когда различные настройки (например, `limit` или `additional_table_filters`) влияют на результат запроса. [#64205](https://github.com/ClickHouse/ClickHouse/pull/64205) ([Robert Schulze](https://github.com/rschu1ze)).
- Поддержка нестандартного кода ошибки `QpsLimitExceeded` в объектном хранилище как ошибки, допускающей повторную попытку. [#64225](https://github.com/ClickHouse/ClickHouse/pull/64225) ([Sema Checherinda](https://github.com/CheSema)).
- Запрещено преобразование таблицы MergeTree в реплицируемую, если путь zookeeper для этой таблицы уже существует. [#64244](https://github.com/ClickHouse/ClickHouse/pull/64244) ([Kirill](https://github.com/kirillgarbar)).
- Добавлена новая настройка `input_format_parquet_prefer_block_bytes` для управления средним размером выходного блока в байтах, а значение по умолчанию для `input_format_parquet_max_block_size` изменено на 65409. [#64427](https://github.com/ClickHouse/ClickHouse/pull/64427) ([LiuNeng](https://github.com/liuneng1994)).
- Разрешен обход прокси для хостов, указанных в переменной окружения `no_proxy` и конфигурации прокси ClickHouse. [#63314](https://github.com/ClickHouse/ClickHouse/pull/63314) ([Arthur Passos](https://github.com/arthurpassos)).
- Keeper теперь всегда запускается с достаточным количеством потоков в глобальном пуле потоков. [#64444](https://github.com/ClickHouse/ClickHouse/pull/64444) ([Duc Canh Le](https://github.com/canhld94)).
- Настройки из пользовательской конфигурации не влияют на слияния и мутации для `MergeTree` поверх объектного хранилища. [#64456](https://github.com/ClickHouse/ClickHouse/pull/64456) ([alesapin](https://github.com/alesapin)).
- Поддержка нестандартного кода ошибки `TotalQpsLimitExceeded` в объектном хранилище как ошибки, допускающей повторную попытку. [#64520](https://github.com/ClickHouse/ClickHouse/pull/64520) ([Sema Checherinda](https://github.com/CheSema)).
- Обновлена расширенная панель мониторинга для версий с открытым исходным кодом и ClickHouse Cloud с добавлением графика «Максимальное количество одновременных сетевых соединений». [#64610](https://github.com/ClickHouse/ClickHouse/pull/64610) ([Thom O'Connor](https://github.com/thomoco)).
- Улучшен отчет о прогрессе для `zeros_mt` и `generateRandom`. [#64804](https://github.com/ClickHouse/ClickHouse/pull/64804) ([Raúl Marín](https://github.com/Algunenano)).
- Добавлена асинхронная метрика `jemalloc.profile.active` для отображения того, активна ли в данный момент выборка. Это механизм активации в дополнение к prof.active; оба должны быть активны для выборки вызывающего потока. [#64842](https://github.com/ClickHouse/ClickHouse/pull/64842) ([Unalian](https://github.com/Unalian)).
- Удалена отметка `allow_experimental_join_condition` как важной. Эта отметка могла препятствовать успешному выполнению распределенных запросов в кластере со смешанными версиями. [#65008](https://github.com/ClickHouse/ClickHouse/pull/65008) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Добавлены асинхронные метрики сервера `DiskGetObjectThrottler*` и `DiskPutObjectThrottler*`, отражающие ограничение скорости запросов в секунду, определенное настройками диска `s3_max_get_rps` и `s3_max_put_rps`, а также текущее доступное количество запросов, которые могут быть отправлены без достижения предела регулирования на диске. Метрики определены для каждого диска с настроенным ограничением. [#65050](https://github.com/ClickHouse/ClickHouse/pull/65050) ([Sergei Trifonov](https://github.com/serxa)).
- Инициализация глобального сборщика трассировок для `Poco::ThreadPool` (необходимо для Keeper и т. д.). [#65239](https://github.com/ClickHouse/ClickHouse/pull/65239) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлена проверка при создании пользователя с `bcrypt_hash`. [#65242](https://github.com/ClickHouse/ClickHouse/pull/65242) ([Raúl Marín](https://github.com/Algunenano)).
- Добавлены события профилирования для количества строк, прочитанных во время/после `PREWHERE`. [#64198](https://github.com/ClickHouse/ClickHouse/pull/64198) ([Nikita Taranov](https://github.com/nickitat)).
- Вывод запроса в `EXPLAIN PLAN` с параллельными репликами. [#64298](https://github.com/ClickHouse/ClickHouse/pull/64298) ([vdimir](https://github.com/vdimir)).
- Настройка `allow_deprecated_functions` переименована в `allow_deprecated_error_prone_window_functions`. [#64358](https://github.com/ClickHouse/ClickHouse/pull/64358) ([Raúl Marín](https://github.com/Algunenano)).
- Учет настройки `max_read_buffer_size` также для файловых дескрипторов в табличной функции `file`. [#64532](https://github.com/ClickHouse/ClickHouse/pull/64532) ([Azat Khuzhin](https://github.com/azat)).
- Отключение транзакций для неподдерживаемых хранилищ даже для материализованных представлений. [#64918](https://github.com/ClickHouse/ClickHouse/pull/64918) ([alesapin](https://github.com/alesapin)).
- Запрещено использование конструкции `QUALIFY` в старом анализаторе. Старый анализатор игнорировал `QUALIFY`, что могло привести к неожиданному удалению данных в мутациях. [#65356](https://github.com/ClickHouse/ClickHouse/pull/65356) ([Dmitry Novik](https://github.com/novikd)).





#### Исправление ошибок (видимые пользователю проблемы в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-5}

- A bug in Apache ORC library was fixed: Fixed ORC statistics calculation, when writing, for unsigned types on all platforms and Int8 on ARM. [#64563](https://github.com/ClickHouse/ClickHouse/pull/64563) ([Michael Kolupaev](https://github.com/al13n321)).
- Returned back the behaviour of how ClickHouse works and interprets Tuples in CSV format. This change effectively reverts https://github.com/ClickHouse/ClickHouse/pull/60994 and makes it available only under a few settings: `output_format_csv_serialize_tuple_into_separate_columns`, `input_format_csv_deserialize_separate_columns_into_tuple` and `input_format_csv_try_infer_strings_from_quoted_tuples`. [#65170](https://github.com/ClickHouse/ClickHouse/pull/65170) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Fix a permission error where a user in a specific situation can escalate their privileges on the default database without necessary grants. [#64769](https://github.com/ClickHouse/ClickHouse/pull/64769) ([pufit](https://github.com/pufit)).
- Fix crash with UniqInjectiveFunctionsEliminationPass and uniqCombined. [#65188](https://github.com/ClickHouse/ClickHouse/pull/65188) ([Raúl Marín](https://github.com/Algunenano)).
- Fix a bug in ClickHouse Keeper that causes digest mismatch during closing session. [#65198](https://github.com/ClickHouse/ClickHouse/pull/65198) ([Aleksei Filatov](https://github.com/aalexfvk)).
- Use correct memory alignment for Distinct combinator. Previously, crash could happen because of invalid memory allocation when the combinator was used. [#65379](https://github.com/ClickHouse/ClickHouse/pull/65379) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix crash with `DISTINCT` and window functions. [#64767](https://github.com/ClickHouse/ClickHouse/pull/64767) ([Igor Nikonov](https://github.com/devcrafter)).
- Fixed 'set' skip index not working with IN and indexHint(). [#62083](https://github.com/ClickHouse/ClickHouse/pull/62083) ([Michael Kolupaev](https://github.com/al13n321)).
- Support executing function during assignment of parameterized view value. [#63502](https://github.com/ClickHouse/ClickHouse/pull/63502) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Fixed parquet memory tracking. [#63584](https://github.com/ClickHouse/ClickHouse/pull/63584) ([Michael Kolupaev](https://github.com/al13n321)).
- Fixed reading of columns of type `Tuple(Map(LowCardinality(String), String), ...)`. [#63956](https://github.com/ClickHouse/ClickHouse/pull/63956) ([Anton Popov](https://github.com/CurtizJ)).
- Fix an `Cyclic aliases` error for cyclic aliases of different type (expression and function). [#63993](https://github.com/ClickHouse/ClickHouse/pull/63993) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- This fix will use a proper redefined context with the correct definer for each individual view in the query pipeline. [#64079](https://github.com/ClickHouse/ClickHouse/pull/64079) ([pufit](https://github.com/pufit)).
- Fix analyzer: "Not found column" error is fixed when using INTERPOLATE. [#64096](https://github.com/ClickHouse/ClickHouse/pull/64096) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix creating backups to S3 buckets with different credentials from the disk containing the file. [#64153](https://github.com/ClickHouse/ClickHouse/pull/64153) ([Antonio Andelic](https://github.com/antonio2368)).
- The query cache now considers two identical queries against different databases as different. The previous behavior could be used to bypass missing privileges to read from a table. [#64199](https://github.com/ClickHouse/ClickHouse/pull/64199) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix possible abort on uncaught exception in ~WriteBufferFromFileDescriptor in StatusFile. [#64206](https://github.com/ClickHouse/ClickHouse/pull/64206) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix `duplicate alias` error for distributed queries with `ARRAY JOIN`. [#64226](https://github.com/ClickHouse/ClickHouse/pull/64226) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix unexpected accurateCast from string to integer. [#64255](https://github.com/ClickHouse/ClickHouse/pull/64255) ([wudidapaopao](https://github.com/wudidapaopao)).
- Fixed CNF simplification, in case any OR group contains mutually exclusive atoms. [#64256](https://github.com/ClickHouse/ClickHouse/pull/64256) ([Eduard Karacharov](https://github.com/korowa)).
- Fix Query Tree size validation. [#64377](https://github.com/ClickHouse/ClickHouse/pull/64377) ([Dmitry Novik](https://github.com/novikd)).
- Fix `Logical error: Bad cast` for `Buffer` table with `PREWHERE`. [#64388](https://github.com/ClickHouse/ClickHouse/pull/64388) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Prevent recursive logging in `blob_storage_log` when it's stored on object storage. [#64393](https://github.com/ClickHouse/ClickHouse/pull/64393) ([vdimir](https://github.com/vdimir)).
- Fixed `CREATE TABLE AS` queries for tables with default expressions. [#64455](https://github.com/ClickHouse/ClickHouse/pull/64455) ([Anton Popov](https://github.com/CurtizJ)).
- Fixed `optimize_read_in_order` behaviour for ORDER BY ... NULLS FIRST / LAST on tables with nullable keys. [#64483](https://github.com/ClickHouse/ClickHouse/pull/64483) ([Eduard Karacharov](https://github.com/korowa)).
- Fix the `Expression nodes list expected 1 projection names` and `Unknown expression or identifier` errors for queries with aliases to `GLOBAL IN.`. [#64517](https://github.com/ClickHouse/ClickHouse/pull/64517) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix an error `Cannot find column` in distributed queries with constant CTE in the `GROUP BY` key. [#64519](https://github.com/ClickHouse/ClickHouse/pull/64519) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix the crash loop when restoring from backup is blocked by creating an MV with a definer that hasn't been restored yet. [#64595](https://github.com/ClickHouse/ClickHouse/pull/64595) ([pufit](https://github.com/pufit)).
- Fix the output of function `formatDateTimeInJodaSyntax` when a formatter generates an uneven number of characters and the last character is `0`. For example, `SELECT formatDateTimeInJodaSyntax(toDate('2012-05-29'), 'D')` now correctly returns `150` instead of previously `15`. [#64614](https://github.com/ClickHouse/ClickHouse/pull/64614) ([LiuNeng](https://github.com/liuneng1994)).
- Do not rewrite aggregation if `-If` combinator is already used. [#64638](https://github.com/ClickHouse/ClickHouse/pull/64638) ([Dmitry Novik](https://github.com/novikd)).
- Fix type inference for float (in case of small buffer, i.e. `--max_read_buffer_size 1`). [#64641](https://github.com/ClickHouse/ClickHouse/pull/64641) ([Azat Khuzhin](https://github.com/azat)).
- Fix bug which could lead to non-working TTLs with expressions. [#64694](https://github.com/ClickHouse/ClickHouse/pull/64694) ([alesapin](https://github.com/alesapin)).
- Fix removing the `WHERE` and `PREWHERE` expressions, which are always true (for the new analyzer). [#64695](https://github.com/ClickHouse/ClickHouse/pull/64695) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fixed excessive part elimination by token-based text indexes (`ngrambf` , `full_text`) when filtering by result of `startsWith`, `endsWith`, `match`, `multiSearchAny`. [#64720](https://github.com/ClickHouse/ClickHouse/pull/64720) ([Eduard Karacharov](https://github.com/korowa)).
- Fixes incorrect behaviour of ANSI CSI escaping in the `UTF8::computeWidth` function. [#64756](https://github.com/ClickHouse/ClickHouse/pull/64756) ([Shaun Struwig](https://github.com/Blargian)).
- Fix a case of incorrect removal of `ORDER BY` / `LIMIT BY` across subqueries. [#64766](https://github.com/ClickHouse/ClickHouse/pull/64766) ([Raúl Marín](https://github.com/Algunenano)).
- Fix (experimental) unequal join with subqueries for sets which are in the mixed join conditions. [#64775](https://github.com/ClickHouse/ClickHouse/pull/64775) ([lgbo](https://github.com/lgbo-ustc)).
- Fix crash in a local cache over `plain_rewritable` disk. [#64778](https://github.com/ClickHouse/ClickHouse/pull/64778) ([Julia Kartseva](https://github.com/jkartseva)).
- Keeper fix: return correct value for `zk_latest_snapshot_size` in `mntr` command. [#64784](https://github.com/ClickHouse/ClickHouse/pull/64784) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix `Cannot find column` in distributed query with `ARRAY JOIN` by `Nested` column. Fixes [#64755](https://github.com/ClickHouse/ClickHouse/issues/64755). [#64801](https://github.com/ClickHouse/ClickHouse/pull/64801) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix memory leak in slru cache policy. [#64803](https://github.com/ClickHouse/ClickHouse/pull/64803) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fixed possible incorrect memory tracking in several kinds of queries: queries that read any data from S3, queries via http protocol, asynchronous inserts. [#64844](https://github.com/ClickHouse/ClickHouse/pull/64844) ([Anton Popov](https://github.com/CurtizJ)).
- Fix the `Block structure mismatch` error for queries reading with `PREWHERE` from the materialized view when the materialized view has columns of different types than the source table. Fixes [#64611](https://github.com/ClickHouse/ClickHouse/issues/64611). [#64855](https://github.com/ClickHouse/ClickHouse/pull/64855) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix rare crash when table has TTL with subquery + database replicated + parallel replicas + analyzer. It's really rare, but please don't use TTLs with subqueries. [#64858](https://github.com/ClickHouse/ClickHouse/pull/64858) ([alesapin](https://github.com/alesapin)).
- Fix duplicating `Delete` events in `blob_storage_log` in case of large batch to delete. [#64924](https://github.com/ClickHouse/ClickHouse/pull/64924) ([vdimir](https://github.com/vdimir)).
- Fixed `Session moved to another server` error from [Zoo]Keeper that might happen after server startup when the config has includes from [Zoo]Keeper. [#64986](https://github.com/ClickHouse/ClickHouse/pull/64986) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix `ALTER MODIFY COMMENT` query that was broken for parameterized VIEWs in https://github.com/ClickHouse/ClickHouse/pull/54211. [#65031](https://github.com/ClickHouse/ClickHouse/pull/65031) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix `host_id` in DatabaseReplicated when `cluster_secure_connection` parameter is enabled. Previously all the connections within the cluster created by DatabaseReplicated were not secure, even if the parameter was enabled. [#65054](https://github.com/ClickHouse/ClickHouse/pull/65054) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fixing the `Not-ready Set` error after the `PREWHERE` optimization for StorageMerge. [#65057](https://github.com/ClickHouse/ClickHouse/pull/65057) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Avoid writing to finalized buffer in File-like storages. [#65063](https://github.com/ClickHouse/ClickHouse/pull/65063) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix possible infinite query duration in case of cyclic aliases. Fixes [#64849](https://github.com/ClickHouse/ClickHouse/issues/64849). [#65081](https://github.com/ClickHouse/ClickHouse/pull/65081) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix the `Unknown expression identifier` error for remote queries with `INTERPOLATE (alias)` (new analyzer). Fixes [#64636](https://github.com/ClickHouse/ClickHouse/issues/64636). [#65090](https://github.com/ClickHouse/ClickHouse/pull/65090) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix pushing arithmetic operations out of aggregation. In the new analyzer, optimization was applied only once. [#65104](https://github.com/ClickHouse/ClickHouse/pull/65104) ([Dmitry Novik](https://github.com/novikd)).
- Fix aggregate function name rewriting in the new analyzer. [#65110](https://github.com/ClickHouse/ClickHouse/pull/65110) ([Dmitry Novik](https://github.com/novikd)).
- Respond with 5xx instead of 200 OK in case of receive timeout while reading (parts of) the request body from the client socket. [#65118](https://github.com/ClickHouse/ClickHouse/pull/65118) ([Julian Maicher](https://github.com/jmaicher)).
- Fix possible crash for hedged requests. [#65206](https://github.com/ClickHouse/ClickHouse/pull/65206) ([Azat Khuzhin](https://github.com/azat)).
- Fix the bug in Hashed and Hashed_Array dictionary short circuit evaluation, which may read uninitialized number, leading to various errors. [#65256](https://github.com/ClickHouse/ClickHouse/pull/65256) ([jsc0218](https://github.com/jsc0218)).
- This PR ensures that the type of the constant(IN operator's second parameter) is always visible during the IN operator's type conversion process. Otherwise, losing type information may cause some conversions to fail, such as the conversion from DateTime to Date. This fixes ([#64487](https://github.com/ClickHouse/ClickHouse/issues/64487)). [#65315](https://github.com/ClickHouse/ClickHouse/pull/65315) ([pn](https://github.com/chloro-pn)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-2}

- Добавлена поддержка LLVM XRay. [#64592](https://github.com/ClickHouse/ClickHouse/pull/64592) [#64837](https://github.com/ClickHouse/ClickHouse/pull/64837) ([Tomer Shafir](https://github.com/tomershafir)).
- Объединены реализации хранилищ s3/hdfs/azure в единый класс, работающий с IObjectStorage. То же самое для \*Cluster, озёр данных и хранилищ очередей. [#59767](https://github.com/ClickHouse/ClickHouse/pull/59767) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Рефакторинг модуля записи частей данных для устранения зависимостей от MergeTreeData и DataPart. [#63620](https://github.com/ClickHouse/ClickHouse/pull/63620) ([Alexander Gololobov](https://github.com/davenger)).
- Рефакторинг `KeyCondition` и анализа ключей для улучшения PartitionPruner и оптимизации тривиального подсчёта. Это выделено из [#60463](https://github.com/ClickHouse/ClickHouse/issues/60463) . [#61459](https://github.com/ClickHouse/ClickHouse/pull/61459) ([Amos Bird](https://github.com/amosbird)).
- Введены проверки для верификации того, что все функции вызываются со столбцами правильного размера. [#63723](https://github.com/ClickHouse/ClickHouse/pull/63723) ([Raúl Marín](https://github.com/Algunenano)).
- Сервис `network` теперь является обязательным при использовании init-скрипта `rc` для запуска демона сервера ClickHouse. [#60650](https://github.com/ClickHouse/ClickHouse/pull/60650) ([Chun-Sheng, Li](https://github.com/peter279k)).
- Уменьшен размер некоторых медленных тестов. [#64387](https://github.com/ClickHouse/ClickHouse/pull/64387) [#64452](https://github.com/ClickHouse/ClickHouse/pull/64452) ([Raúl Marín](https://github.com/Algunenano)).
- Воспроизведение логов ZooKeeper с использованием keeper-bench. [#62481](https://github.com/ClickHouse/ClickHouse/pull/62481) ([Antonio Andelic](https://github.com/antonio2368)).

### <a id="245"></a> Релиз ClickHouse 24.5, 2024-05-30 {#a-id245a-clickhouse-release-245-2024-05-30}

#### Обратно несовместимые изменения {#backward-incompatible-change-7}

- Переименованы «инвертированные индексы» в «полнотекстовые индексы», что является менее техническим и более понятным для пользователей названием. Это также изменяет внутренние метаданные таблиц и нарушает работу таблиц с существующими (экспериментальными) инвертированными индексами. Пожалуйста, убедитесь, что удалили такие индексы перед обновлением и пересоздали их после обновления. [#62884](https://github.com/ClickHouse/ClickHouse/pull/62884) ([Robert Schulze](https://github.com/rschu1ze)).
- Использование функций `neighbor`, `runningAccumulate`, `runningDifferenceStartingWithFirstValue`, `runningDifference` объявлено устаревшим (поскольку они подвержены ошибкам). Вместо них следует использовать соответствующие оконные функции. Чтобы включить их обратно, установите `allow_deprecated_error_prone_window_functions = 1` или установите `compatibility = '24.4'` или ниже. [#63132](https://github.com/ClickHouse/ClickHouse/pull/63132) ([Nikita Taranov](https://github.com/nickitat)).
- Запросы к `system.columns` будут работать быстрее при большом количестве столбцов, но когда многие базы данных или таблицы не имеют прав для `SHOW TABLES`. Обратите внимание, что в предыдущих версиях, если вы предоставляли права `SHOW COLUMNS` для отдельных столбцов без предоставления прав `SHOW TABLES` для соответствующих таблиц, таблица `system.columns` показывала эти столбцы, но в новой версии она будет полностью пропускать такую таблицу. Удалены трассировочные сообщения логов «Access granted» и «Access denied», которые замедляли запросы. [#63439](https://github.com/ClickHouse/ClickHouse/pull/63439) ([Alexey Milovidov](https://github.com/alexey-milovidov)).


#### Новая функциональность {#new-feature-7}

- Добавлен формат `Form` для чтения/записи одной записи в формате `application/x-www-form-urlencoded`. [#60199](https://github.com/ClickHouse/ClickHouse/pull/60199) ([Shaun Struwig](https://github.com/Blargian)).
- Добавлена возможность сжатия при выполнении CROSS JOIN. [#60459](https://github.com/ClickHouse/ClickHouse/pull/60459) ([p1rattttt](https://github.com/p1rattttt)).
- Добавлена возможность выполнения `CROSS JOIN` во временных файлах при превышении лимитов размера. [#63432](https://github.com/ClickHouse/ClickHouse/pull/63432) ([p1rattttt](https://github.com/p1rattttt)).
- Добавлена поддержка соединений с условиями неравенства, включающими столбцы из обеих таблиц, например `t1.y < t2.y`. Для включения используйте `SET allow_experimental_join_condition = 1`. [#60920](https://github.com/ClickHouse/ClickHouse/pull/60920) ([lgbo](https://github.com/lgbo-ustc)).
- Типы Map теперь могут иметь `Float32`, `Float64`, `Array(T)`, `Map(K, V)` и `Tuple(T1, T2, ...)` в качестве ключей. Закрывает [#54537](https://github.com/ClickHouse/ClickHouse/issues/54537). [#59318](https://github.com/ClickHouse/ClickHouse/pull/59318) ([李扬](https://github.com/taiyang-li)).
- Реализована массовая загрузка в `EmbeddedRocksDB` путем создания и загрузки SST-файлов вместо использования встроенной memtable RocksDB. Это позволяет увеличить скорость импорта, особенно для длительных запросов INSERT в таблицы StorageEmbeddedRocksDB. Также добавлены настройки таблиц `EmbeddedRocksDB`. [#59163](https://github.com/ClickHouse/ClickHouse/pull/59163) [#63324](https://github.com/ClickHouse/ClickHouse/pull/63324) ([Duc Canh Le](https://github.com/canhld94)).
- Добавлена возможность обработки CRLF в формате TSV с помощью настройки `input_format_tsv_crlf_end_of_line`. Закрывает [#56257](https://github.com/ClickHouse/ClickHouse/issues/56257). [#59747](https://github.com/ClickHouse/ClickHouse/pull/59747) ([Shaun Struwig](https://github.com/Blargian)).
- Добавлена новая настройка `input_format_force_null_for_omitted_fields`, которая принудительно устанавливает значения NULL для пропущенных полей. [#60887](https://github.com/ClickHouse/ClickHouse/pull/60887) ([Constantine Peresypkin](https://github.com/pkit)).
- Ранее хранилище S3 и табличная функция s3 не поддерживали выборку из архивных файлов, таких как tarball, zip, 7z. Теперь они позволяют перебирать файлы внутри архивов в S3. [#62259](https://github.com/ClickHouse/ClickHouse/pull/62259) ([Daniil Ivanik](https://github.com/divanik)).
- Добавлена поддержка условной функции `clamp`. [#62377](https://github.com/ClickHouse/ClickHouse/pull/62377) ([skyoct](https://github.com/skyoct)).
- Добавлен выходной формат `NPy`. [#62430](https://github.com/ClickHouse/ClickHouse/pull/62430) ([豪肥肥](https://github.com/HowePa)).
- Формат `Raw` как синоним `TSVRaw`. [#63394](https://github.com/ClickHouse/ClickHouse/pull/63394) ([Unalian](https://github.com/Unalian)).
- Добавлена новая SQL-функция `generateUUIDv7` для генерации UUID версии 7, то есть UUID на основе временной метки со случайным компонентом. Также добавлены новая функция `UUIDToNum` для извлечения байтов из UUID и новая функция `UUIDv7ToDateTime` для извлечения компонента временной метки из UUID версии 7. [#62852](https://github.com/ClickHouse/ClickHouse/pull/62852) ([Alexey Petrunyaka](https://github.com/pet74alex)).
- В Linux и MacOS, если stdout программы перенаправлен в файл с расширением сжатия, используется соответствующий метод сжатия (что делает поведение аналогичным `INTO OUTFILE`). [#63662](https://github.com/ClickHouse/ClickHouse/pull/63662) ([v01dXYZ](https://github.com/v01dXYZ)).
- Изменено предупреждение о большом количестве подключенных объектов для различения таблиц, представлений и словарей. [#64180](https://github.com/ClickHouse/ClickHouse/pull/64180) ([Francisco J. Jurado Moreno](https://github.com/Beetelbrox)).
- Добавлена поддержка функции `azureBlobStorage` на сервере ClickHouse для использования Azure Workload Identity для аутентификации в Azure Blob Storage. Если параметр `use_workload_identity` установлен в конфигурации, для аутентификации используется [workload identity](https://github.com/Azure/azure-sdk-for-cpp/tree/main/sdk/identity/azure-identity#authenticate-azure-hosted-applications). [#57881](https://github.com/ClickHouse/ClickHouse/pull/57881) ([Vinay Suryadevara](https://github.com/vinay92-ch)).
- Добавлена информация о TTL в таблицу `system.parts_columns`. [#63200](https://github.com/ClickHouse/ClickHouse/pull/63200) ([litlig](https://github.com/litlig)).

#### Экспериментальные функции {#experimental-features-1}

- Реализован тип данных `Dynamic`, позволяющий хранить значения любого типа без необходимости заранее знать все типы. Тип `Dynamic` доступен при включении настройки `allow_experimental_dynamic_type`. Ссылка: [#54864](https://github.com/ClickHouse/ClickHouse/issues/54864). [#63058](https://github.com/ClickHouse/ClickHouse/pull/63058) ([Kruglov Pavel](https://github.com/Avogar)).
- Добавлена возможность создания базы данных `MaterializedMySQL` без подключения к MySQL. [#63397](https://github.com/ClickHouse/ClickHouse/pull/63397) ([Kirill](https://github.com/kirillgarbar)).
- Реплика реплицируемой базы данных автоматически помечается как потерянная и запускается процесс восстановления, если какая-либо DDL-задача завершается с одной и той же ошибкой более `max_retries_before_automatic_recovery` (по умолчанию 100) раз подряд. Также исправлена ошибка, которая могла приводить к пропуску DDL-записей при возникновении исключения на ранней стадии выполнения записи. [#63549](https://github.com/ClickHouse/ClickHouse/pull/63549) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Добавлен учет файлов с ошибками в параметрах `s3queue_tracked_file_ttl_sec` и `s3queue_traked_files_limit` для `StorageS3Queue`. [#63638](https://github.com/ClickHouse/ClickHouse/pull/63638) ([Kseniia Sumarokova](https://github.com/kssenii)).


#### Улучшение производительности {#performance-improvement-7}

- Снижение конкуренции в кеше файловой системы (часть 4). Позволяет поддерживать кеш файловой системы не заполненным до предела путем дополнительного вытеснения в фоновом режиме (управляется параметром `keep_free_space_size(elements)_ratio`). Это позволяет снизить нагрузку на резервирование пространства для запросов (в методе `tryReserve`). Также это выполняется максимально без блокировок, т.е. не должно блокировать обычное использование кеша. [#61250](https://github.com/ClickHouse/ClickHouse/pull/61250) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Пропуск слияния вновь созданных блоков проекций во время операций `INSERT`. [#59405](https://github.com/ClickHouse/ClickHouse/pull/59405) ([Nikita Taranov](https://github.com/nickitat)).
- Обработка строковых функций `...UTF8` в режиме ASCII, если входные строки состоят только из символов ASCII. Вдохновлено https://github.com/apache/doris/pull/29799. Общее ускорение в 1.07x~1.62x раз. Обратите внимание, что пиковое использование памяти было снижено в некоторых случаях. [#61632](https://github.com/ClickHouse/ClickHouse/pull/61632) ([李扬](https://github.com/taiyang-li)).
- Улучшена производительность выборки с использованием шаблонов (`{}`) в StorageS3. [#62120](https://github.com/ClickHouse/ClickHouse/pull/62120) ([Andrey Zvonov](https://github.com/zvonand)).
- HostResolver содержит каждый IP-адрес несколько раз. Если удаленный хост имеет несколько IP-адресов и по какой-то причине (например, правила брандмауэра) доступ к некоторым IP разрешен, а к другим запрещен, то только первая запись запрещенных IP помечается как неудачная, и при каждой попытке эти IP могут быть выбраны (и снова завершиться неудачей). Даже если это исправить, каждые 120 секунд кеш DNS сбрасывается, и IP могут быть выбраны снова. [#62652](https://github.com/ClickHouse/ClickHouse/pull/62652) ([Anton Ivashkin](https://github.com/ianton-ru)).
- Добавлена новая конфигурация `prefer_merge_sort_block_bytes` для управления использованием памяти и ускорения сортировки в 2 раза при слиянии, когда имеется много столбцов. [#62904](https://github.com/ClickHouse/ClickHouse/pull/62904) ([LiuNeng](https://github.com/liuneng1994)).
- `clickhouse-local` будет запускаться быстрее. В предыдущих версиях он по ошибке не удалял временные каталоги. Теперь будет. Это закрывает [#62941](https://github.com/ClickHouse/ClickHouse/issues/62941). [#63074](https://github.com/ClickHouse/ClickHouse/pull/63074) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Микрооптимизации для нового анализатора. [#63429](https://github.com/ClickHouse/ClickHouse/pull/63429) ([Raúl Marín](https://github.com/Algunenano)).
- Анализ индексов будет работать при сравнении `DateTime` с `DateTime64`. Это закрывает [#63441](https://github.com/ClickHouse/ClickHouse/issues/63441). [#63443](https://github.com/ClickHouse/ClickHouse/pull/63443) [#63532](https://github.com/ClickHouse/ClickHouse/pull/63532) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Небольшое ускорение индексов типа `set` (примерно в 1.5 раза) за счет удаления мусора. [#64098](https://github.com/ClickHouse/ClickHouse/pull/64098) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Устранено копирование данных при записи в кеш файловой системы. [#63401](https://github.com/ClickHouse/ClickHouse/pull/63401) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Теперь резервные копии с хранилищем Azure Blob Storage будут использовать многопоточное копирование. [#64116](https://github.com/ClickHouse/ClickHouse/pull/64116) ([alesapin](https://github.com/alesapin)).
- Разрешено использование нативного копирования для Azure даже с разными контейнерами. [#64154](https://github.com/ClickHouse/ClickHouse/pull/64154) ([alesapin](https://github.com/alesapin)).
- Наконец включено нативное копирование для Azure. [#64182](https://github.com/ClickHouse/ClickHouse/pull/64182) ([alesapin](https://github.com/alesapin)).


#### Улучшение {#improvement-7}

- Разрешено использование `clickhouse-local` и его сокращений `clickhouse` и `ch` с запросом или файлом запросов в качестве позиционного аргумента. Примеры: `ch "SELECT 1"`, `ch --param_test Hello "SELECT {test:String}"`, `ch query.sql`. Закрывает [#62361](https://github.com/ClickHouse/ClickHouse/issues/62361). [#63081](https://github.com/ClickHouse/ClickHouse/pull/63081) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Включены метаданные plain_rewritable для локальных и Azure (azure_blob_storage) объектных хранилищ. [#63365](https://github.com/ClickHouse/ClickHouse/pull/63365) ([Julia Kartseva](https://github.com/jkartseva)).
- Поддержка Unicode-кавычек в английском стиле, например "Hello", 'world'. В целом это спорное решение, но полезно при вводе запроса в текстовом редакторе, таком как Google Docs. Закрывает [#58634](https://github.com/ClickHouse/ClickHouse/issues/58634). [#63381](https://github.com/ClickHouse/ClickHouse/pull/63381) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Разрешены завершающие запятые в списке столбцов в запросе INSERT. Например, `INSERT INTO test (a, b, c, ) VALUES ...`. [#63803](https://github.com/ClickHouse/ClickHouse/pull/63803) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Улучшены сообщения об исключениях для формата `Regexp`. [#63804](https://github.com/ClickHouse/ClickHouse/pull/63804) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Разрешены завершающие запятые в формате `Values`. Например, допустим следующий запрос: `INSERT INTO test (a, b, c) VALUES (4, 5, 6,);`. [#63810](https://github.com/ClickHouse/ClickHouse/pull/63810) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Реализована отправка nack для поврежденных сообщений RabbitMQ. Закрывает [#45350](https://github.com/ClickHouse/ClickHouse/issues/45350). [#60312](https://github.com/ClickHouse/ClickHouse/pull/60312) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Исправлено аварийное завершение при асинхронной раскрутке стека (например, при использовании профилировщика запросов с выборкой) во время интерпретации отладочной информации. Закрывает [#60460](https://github.com/ClickHouse/ClickHouse/issues/60460). [#60468](https://github.com/ClickHouse/ClickHouse/pull/60468) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Различные сообщения для ошибки S3 'no key' в случаях диска и хранилища. [#61108](https://github.com/ClickHouse/ClickHouse/pull/61108) ([Sema Checherinda](https://github.com/CheSema)).
- Индикатор прогресса теперь работает для простых запросов с LIMIT из `system.zeros`, `system.zeros_mt` (он уже работает для `system.numbers` и `system.numbers_mt`), а также табличной функции `generateRandom`. В качестве бонуса, если общее количество записей превышает лимит `max_rows_to_read`, исключение будет выброшено раньше. Закрывает [#58183](https://github.com/ClickHouse/ClickHouse/issues/58183). [#61823](https://github.com/ClickHouse/ClickHouse/pull/61823) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Поддержка "Merge Key" в конфигурациях YAML (это странная особенность YAML, не обращайте внимания). [#62685](https://github.com/ClickHouse/ClickHouse/pull/62685) ([Azat Khuzhin](https://github.com/azat)).
- Улучшено сообщение об ошибке при использовании недетерминированной функции с реплицируемым источником. [#62896](https://github.com/ClickHouse/ClickHouse/pull/62896) ([Grégoire Pineau](https://github.com/lyrixx)).
- Исправлен межсерверный секрет для Distributed поверх Distributed из `remote`. [#63013](https://github.com/ClickHouse/ClickHouse/pull/63013) ([Azat Khuzhin](https://github.com/azat)).
- Поддержка `include_from` для файлов YAML. Однако лучше использовать `config.d`. [#63106](https://github.com/ClickHouse/ClickHouse/pull/63106) ([Eduard Karacharov](https://github.com/korowa)).
- Сохранение предыдущих данных в терминале после выбора из предложений skim. [#63261](https://github.com/ClickHouse/ClickHouse/pull/63261) ([FlameFactory](https://github.com/FlameFactory)).
- Ширина полей (в форматах Pretty или функции `visibleWidth`) теперь корректно игнорирует управляющие последовательности ANSI. [#63270](https://github.com/ClickHouse/ClickHouse/pull/63270) ([Shaun Struwig](https://github.com/Blargian)).
- Обновлено использование кода ошибки `NUMBER_OF_ARGUMENTS_DOESNT_MATCH` на более точные коды ошибок там, где это уместно. [#63406](https://github.com/ClickHouse/ClickHouse/pull/63406) ([Yohann Jardin](https://github.com/yohannj)).
- `os_user` и `client_hostname` теперь корректно устанавливаются для запросов подсказок командной строки в clickhouse-client. Закрывает [#63430](https://github.com/ClickHouse/ClickHouse/issues/63430). [#63433](https://github.com/ClickHouse/ClickHouse/pull/63433) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Автоматическая корректировка `max_block_size` до значения по умолчанию, если оно равно нулю. [#63587](https://github.com/ClickHouse/ClickHouse/pull/63587) ([Antonio Andelic](https://github.com/antonio2368)).
- Добавлен столбец-псевдоним build_id в trace_log для упрощения автоматического переименования при обнаружении изменений в бинарном файле. Решает проблему [#52086](https://github.com/ClickHouse/ClickHouse/issues/52086). [#63656](https://github.com/ClickHouse/ClickHouse/pull/63656) ([Zimu Li](https://github.com/woodlzm)).
- Включена операция truncate для дисков объектного хранилища. [#63693](https://github.com/ClickHouse/ClickHouse/pull/63693) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Загрузка списка ключевых слов теперь зависит от ревизии сервера и будет отключена для старых версий сервера ClickHouse. CC @azat. [#63786](https://github.com/ClickHouse/ClickHouse/pull/63786) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Диски ClickHouse должны читать настройки сервера для получения актуальной версии формата метаданных. [#63831](https://github.com/ClickHouse/ClickHouse/pull/63831) ([Sema Checherinda](https://github.com/CheSema)).
- Отключены ограничения формата pretty (`output_format_pretty_max_rows`/`output_format_pretty_max_value_width`), когда stdout не является TTY. [#63942](https://github.com/ClickHouse/ClickHouse/pull/63942) ([Azat Khuzhin](https://github.com/azat)).
- Обработка исключений теперь работает при использовании ClickHouse внутри AWS Lambda. Автор: [Alexey Coolnev](https://github.com/acoolnev). [#64014](https://github.com/ClickHouse/ClickHouse/pull/64014) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Выбрасывается исключение `CANNOT_DECOMPRESS` вместо `CORRUPTED_DATA` при передаче некорректных сжатых данных через HTTP. [#64036](https://github.com/ClickHouse/ClickHouse/pull/64036) ([vdimir](https://github.com/vdimir)).
- Подсказка для одного большого числа в форматах Pretty теперь работает для Nullable и LowCardinality. Закрывает [#61993](https://github.com/ClickHouse/ClickHouse/issues/61993). [#64084](https://github.com/ClickHouse/ClickHouse/pull/64084) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлены метрики, логи и имена потоков для фильтрации частей с использованием индексов. [#64130](https://github.com/ClickHouse/ClickHouse/pull/64130) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Игнорирование `allow_suspicious_primary_key` при `ATTACH` и проверка при `ALTER`. [#64202](https://github.com/ClickHouse/ClickHouse/pull/64202) ([Azat Khuzhin](https://github.com/azat)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-3}

- ClickHouse собирается с помощью clang-18. Включено множество новых проверок из clang-tidy-18. [#60469](https://github.com/ClickHouse/ClickHouse/pull/60469) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Экспериментальная поддержка loongarch64 в качестве новой платформы для ClickHouse. [#63733](https://github.com/ClickHouse/ClickHouse/pull/63733) ([qiangxuhui](https://github.com/qiangxuhui)).
- Dockerfile проверен официальной библиотекой Docker в https://github.com/docker-library/official-images/pull/15846. [#63400](https://github.com/ClickHouse/ClickHouse/pull/63400) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Информация о каждом символе в каждой единице трансляции будет собираться в базе данных CI для каждой сборки. Это закрывает [#63494](https://github.com/ClickHouse/ClickHouse/issues/63494). [#63495](https://github.com/ClickHouse/ClickHouse/pull/63495) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Обновлена библиотека Apache Datasketches. Это решает [#63858](https://github.com/ClickHouse/ClickHouse/issues/63858). [#63923](https://github.com/ClickHouse/ClickHouse/pull/63923) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Включена поддержка GRPC для aarch64 Linux при кросс-компиляции бинарного файла. [#64072](https://github.com/ClickHouse/ClickHouse/pull/64072) ([alesapin](https://github.com/alesapin)).
- Исправлена раскрутка стека при SIGSEGV на aarch64 (из-за малого размера стека для сигнала) [#64058](https://github.com/ClickHouse/ClickHouse/pull/64058) ([Azat Khuzhin](https://github.com/azat)).


#### Исправление ошибок {#bug-fix-1}

- Disabled `enable_vertical_final` setting by default. This feature should not be used because it has a bug: [#64543](https://github.com/ClickHouse/ClickHouse/issues/64543). [#64544](https://github.com/ClickHouse/ClickHouse/pull/64544) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix making backup when multiple shards are used [#57684](https://github.com/ClickHouse/ClickHouse/pull/57684) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix passing projections/indexes/primary key from columns list from CREATE query into inner table of MV [#59183](https://github.com/ClickHouse/ClickHouse/pull/59183) ([Azat Khuzhin](https://github.com/azat)).
- Fix boundRatio incorrect merge [#60532](https://github.com/ClickHouse/ClickHouse/pull/60532) ([Tao Wang](https://github.com/wangtZJU)).
- Fix crash when calling some functions on const low-cardinality columns [#61966](https://github.com/ClickHouse/ClickHouse/pull/61966) ([Michael Kolupaev](https://github.com/al13n321)).
- Fix queries with FINAL give wrong result when table does not use adaptive granularity [#62432](https://github.com/ClickHouse/ClickHouse/pull/62432) ([Duc Canh Le](https://github.com/canhld94)).
- Improve detection of cgroups v2 support for memory controllers [#62903](https://github.com/ClickHouse/ClickHouse/pull/62903) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix subsequent use of external tables in client [#62964](https://github.com/ClickHouse/ClickHouse/pull/62964) ([Azat Khuzhin](https://github.com/azat)).
- Fix crash with untuple and unresolved lambda [#63131](https://github.com/ClickHouse/ClickHouse/pull/63131) ([Raúl Marín](https://github.com/Algunenano)).
- Fix premature server listen for connections [#63181](https://github.com/ClickHouse/ClickHouse/pull/63181) ([alesapin](https://github.com/alesapin)).
- Fix intersecting parts when restarting after a DROP PART command [#63202](https://github.com/ClickHouse/ClickHouse/pull/63202) ([Han Fei](https://github.com/hanfei1991)).
- Correctly load SQL security defaults during startup [#63209](https://github.com/ClickHouse/ClickHouse/pull/63209) ([pufit](https://github.com/pufit)).
- JOIN filter push down filter join fix [#63234](https://github.com/ClickHouse/ClickHouse/pull/63234) ([Maksim Kita](https://github.com/kitaisreal)).
- Fix infinite loop in AzureObjectStorage::listObjects [#63257](https://github.com/ClickHouse/ClickHouse/pull/63257) ([Julia Kartseva](https://github.com/jkartseva)).
- CROSS join ignore join_algorithm setting [#63273](https://github.com/ClickHouse/ClickHouse/pull/63273) ([vdimir](https://github.com/vdimir)).
- Fix finalize WriteBufferToFileSegment and StatusFile [#63346](https://github.com/ClickHouse/ClickHouse/pull/63346) ([vdimir](https://github.com/vdimir)).
- Fix logical error during SELECT query after ALTER in rare case [#63353](https://github.com/ClickHouse/ClickHouse/pull/63353) ([alesapin](https://github.com/alesapin)).
- Fix `X-ClickHouse-Timezone` header with `session_timezone` [#63377](https://github.com/ClickHouse/ClickHouse/pull/63377) ([Andrey Zvonov](https://github.com/zvonand)).
- Fix debug assert when using grouping WITH ROLLUP and LowCardinality types [#63398](https://github.com/ClickHouse/ClickHouse/pull/63398) ([Raúl Marín](https://github.com/Algunenano)).
- Small fixes for group_by_use_nulls [#63405](https://github.com/ClickHouse/ClickHouse/pull/63405) ([vdimir](https://github.com/vdimir)).
- Fix backup/restore of projection part in case projection was removed from table metadata, but part still has projection [#63426](https://github.com/ClickHouse/ClickHouse/pull/63426) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix mysql dictionary source [#63481](https://github.com/ClickHouse/ClickHouse/pull/63481) ([vdimir](https://github.com/vdimir)).
- Insert QueryFinish on AsyncInsertFlush with no data [#63483](https://github.com/ClickHouse/ClickHouse/pull/63483) ([Raúl Marín](https://github.com/Algunenano)).
- Fix: empty used_dictionaries in system.query_log [#63487](https://github.com/ClickHouse/ClickHouse/pull/63487) ([Eduard Karacharov](https://github.com/korowa)).
- Make `MergeTreePrefetchedReadPool` safer [#63513](https://github.com/ClickHouse/ClickHouse/pull/63513) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix crash on exit with sentry enabled (due to openssl destroyed before sentry) [#63548](https://github.com/ClickHouse/ClickHouse/pull/63548) ([Azat Khuzhin](https://github.com/azat)).
- Fix Array and Map support with Keyed hashing [#63628](https://github.com/ClickHouse/ClickHouse/pull/63628) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
- Fix filter pushdown for Parquet and maybe StorageMerge [#63642](https://github.com/ClickHouse/ClickHouse/pull/63642) ([Michael Kolupaev](https://github.com/al13n321)).
- Prevent conversion to Replicated if zookeeper path already exists [#63670](https://github.com/ClickHouse/ClickHouse/pull/63670) ([Kirill](https://github.com/kirillgarbar)).
- Analyzer: views read only necessary columns [#63688](https://github.com/ClickHouse/ClickHouse/pull/63688) ([Maksim Kita](https://github.com/kitaisreal)).
- Analyzer: Forbid WINDOW redefinition [#63694](https://github.com/ClickHouse/ClickHouse/pull/63694) ([Dmitry Novik](https://github.com/novikd)).
- flatten_nested was broken with the experimental Replicated database. [#63695](https://github.com/ClickHouse/ClickHouse/pull/63695) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix [#63653](https://github.com/ClickHouse/ClickHouse/issues/63653) [#63722](https://github.com/ClickHouse/ClickHouse/pull/63722) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Allow cast from Array(Nothing) to Map(Nothing, Nothing) [#63753](https://github.com/ClickHouse/ClickHouse/pull/63753) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix ILLEGAL_COLUMN in partial_merge join [#63755](https://github.com/ClickHouse/ClickHouse/pull/63755) ([vdimir](https://github.com/vdimir)).
- Fix: remove redundant distinct with window functions [#63776](https://github.com/ClickHouse/ClickHouse/pull/63776) ([Igor Nikonov](https://github.com/devcrafter)).
- Fix possible crash with SYSTEM UNLOAD PRIMARY KEY [#63778](https://github.com/ClickHouse/ClickHouse/pull/63778) ([Raúl Marín](https://github.com/Algunenano)).
- Fix a query with duplicating cycling alias. [#63791](https://github.com/ClickHouse/ClickHouse/pull/63791) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Make `TokenIterator` lazy as it should be [#63801](https://github.com/ClickHouse/ClickHouse/pull/63801) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add `endpoint_subpath` S3 URI setting [#63806](https://github.com/ClickHouse/ClickHouse/pull/63806) ([Julia Kartseva](https://github.com/jkartseva)).
- Fix deadlock in `ParallelReadBuffer` [#63814](https://github.com/ClickHouse/ClickHouse/pull/63814) ([Antonio Andelic](https://github.com/antonio2368)).
- JOIN filter push down equivalent columns fix [#63819](https://github.com/ClickHouse/ClickHouse/pull/63819) ([Maksim Kita](https://github.com/kitaisreal)).
- Remove data from all disks after DROP with Lazy database. [#63848](https://github.com/ClickHouse/ClickHouse/pull/63848) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Fix incorrect result when reading from MV with parallel replicas and new analyzer [#63861](https://github.com/ClickHouse/ClickHouse/pull/63861) ([Nikita Taranov](https://github.com/nickitat)).
- Fixes in `find_super_nodes` and `find_big_family` command of keeper-client [#63862](https://github.com/ClickHouse/ClickHouse/pull/63862) ([Alexander Gololobov](https://github.com/davenger)).
- Update lambda execution name [#63864](https://github.com/ClickHouse/ClickHouse/pull/63864) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix SIGSEGV due to CPU/Real profiler [#63865](https://github.com/ClickHouse/ClickHouse/pull/63865) ([Azat Khuzhin](https://github.com/azat)).
- Fix `EXPLAIN CURRENT TRANSACTION` query [#63926](https://github.com/ClickHouse/ClickHouse/pull/63926) ([Anton Popov](https://github.com/CurtizJ)).
- Fix analyzer: there's turtles all the way down... [#63930](https://github.com/ClickHouse/ClickHouse/pull/63930) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Allow certain ALTER TABLE commands for `plain_rewritable` disk [#63933](https://github.com/ClickHouse/ClickHouse/pull/63933) ([Julia Kartseva](https://github.com/jkartseva)).
- Recursive CTE distributed fix [#63939](https://github.com/ClickHouse/ClickHouse/pull/63939) ([Maksim Kita](https://github.com/kitaisreal)).
- Analyzer: Fix COLUMNS resolve [#63962](https://github.com/ClickHouse/ClickHouse/pull/63962) ([Dmitry Novik](https://github.com/novikd)).
- LIMIT BY and skip_unused_shards with analyzer [#63983](https://github.com/ClickHouse/ClickHouse/pull/63983) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- A fix for some trash (experimental Kusto) [#63992](https://github.com/ClickHouse/ClickHouse/pull/63992) ([Yong Wang](https://github.com/kashwy)).
- Deserialize untrusted binary inputs in a safer way [#64024](https://github.com/ClickHouse/ClickHouse/pull/64024) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix query analysis for queries with the setting `final` = 1 for Distributed tables over tables from other than the MergeTree family. [#64037](https://github.com/ClickHouse/ClickHouse/pull/64037) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Add missing settings to recoverLostReplica [#64040](https://github.com/ClickHouse/ClickHouse/pull/64040) ([Raúl Marín](https://github.com/Algunenano)).
- Fix SQL security access checks with analyzer [#64079](https://github.com/ClickHouse/ClickHouse/pull/64079) ([pufit](https://github.com/pufit)).
- Fix analyzer: only interpolate expression should be used for DAG [#64096](https://github.com/ClickHouse/ClickHouse/pull/64096) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix azure backup writing multipart blocks by 1 MiB (read buffer size) instead of `max_upload_part_size` (in non-native copy case) [#64117](https://github.com/ClickHouse/ClickHouse/pull/64117) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Correctly fallback during backup copy [#64153](https://github.com/ClickHouse/ClickHouse/pull/64153) ([Antonio Andelic](https://github.com/antonio2368)).
- Prevent LOGICAL_ERROR on CREATE TABLE as materialized view [#64174](https://github.com/ClickHouse/ClickHouse/pull/64174) ([Raúl Marín](https://github.com/Algunenano)).
- Query Cache: Consider identical queries against different databases as different [#64199](https://github.com/ClickHouse/ClickHouse/pull/64199) ([Robert Schulze](https://github.com/rschu1ze)).
- Ignore `text_log` for Keeper [#64218](https://github.com/ClickHouse/ClickHouse/pull/64218) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix Logical error: Bad cast for Buffer table with prewhere. [#64388](https://github.com/ClickHouse/ClickHouse/pull/64388) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).

### <a id="244"></a> ClickHouse release 24.4, 2024-04-30 {#a-id244a-clickhouse-release-244-2024-04-30}

#### Примечания по обновлению {#upgrade-notes}

- `clickhouse-odbc-bridge` и `clickhouse-library-bridge` теперь являются отдельными пакетами. Решает проблему [#61677](https://github.com/ClickHouse/ClickHouse/issues/61677). [#62114](https://github.com/ClickHouse/ClickHouse/pull/62114) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Запрещена установка max_parallel_replicas (для экспериментального параллельного чтения из реплик) в значение `0`, так как это не имеет смысла. Решает проблему [#60140](https://github.com/ClickHouse/ClickHouse/issues/60140). [#61201](https://github.com/ClickHouse/ClickHouse/pull/61201) ([Kruglov Pavel](https://github.com/Avogar)).
- Удалена поддержка запроса `INSERT WATCH` (часть устаревшей функции `LIVE VIEW`). [#62382](https://github.com/ClickHouse/ClickHouse/pull/62382) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Удалена настройка `optimize_monotonous_functions_in_order_by`. [#63004](https://github.com/ClickHouse/ClickHouse/pull/63004) ([Raúl Marín](https://github.com/Algunenano)).
- Удалена пометка экспериментальности с движка базы данных `Replicated`. Теперь он находится на стадии бета-версии. [#62937](https://github.com/ClickHouse/ClickHouse/pull/62937) ([Justin de Guzman](https://github.com/justindeguzman)).


#### Новые возможности {#new-feature-8}

- Поддержка рекурсивных CTE. [#62074](https://github.com/ClickHouse/ClickHouse/pull/62074) ([Maksim Kita](https://github.com/kitaisreal)).
- Поддержка конструкции `QUALIFY`. Закрывает [#47819](https://github.com/ClickHouse/ClickHouse/issues/47819). [#62619](https://github.com/ClickHouse/ClickHouse/pull/62619) ([Maksim Kita](https://github.com/kitaisreal)).
- Движки таблиц теперь могут быть объектами привилегий, это не повлияет на поведение существующих пользователей. [#60117](https://github.com/ClickHouse/ClickHouse/pull/60117) ([jsc0218](https://github.com/jsc0218)).
- Добавлен перезаписываемый S3-диск, который поддерживает операции INSERT и не требует локального хранения метаданных. [#61116](https://github.com/ClickHouse/ClickHouse/pull/61116) ([Julia Kartseva](https://github.com/jkartseva)). Основной вариант использования — системные таблицы.
- Подсветка синтаксиса при вводе в клиенте теперь работает на уровне синтаксиса (ранее работала на уровне лексера). [#62123](https://github.com/ClickHouse/ClickHouse/pull/62123) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Поддержка удаления нескольких таблиц одновременно, например `DROP TABLE a, b, c`;. [#58705](https://github.com/ClickHouse/ClickHouse/pull/58705) ([zhongyuankai](https://github.com/zhongyuankai)).
- Теперь поддерживается изменение настроек таблиц Memory через `ALTER MODIFY SETTING`. Пример: `ALTER TABLE memory MODIFY SETTING min_rows_to_keep = 100, max_rows_to_keep = 1000;`. [#62039](https://github.com/ClickHouse/ClickHouse/pull/62039) ([zhongyuankai](https://github.com/zhongyuankai)).
- Добавлен параметр запроса `role` в HTTP-интерфейс. Он работает аналогично `SET ROLE x`, применяя роль перед выполнением запроса. Это позволяет обойти ограничение HTTP-интерфейса, поскольку множественные запросы не разрешены, и невозможно отправить одновременно и `SET ROLE x`, и сам запрос. Таким образом можно установить несколько ролей, например `?role=x&role=y`, что будет эквивалентно `SET ROLE x, y`. [#62669](https://github.com/ClickHouse/ClickHouse/pull/62669) ([Serge Klochkov](https://github.com/slvrtrn)).
- Добавлена команда `SYSTEM UNLOAD PRIMARY KEY` для освобождения памяти, используемой первичным ключом таблицы. [#62738](https://github.com/ClickHouse/ClickHouse/pull/62738) ([Pablo Marcos](https://github.com/pamarcos)).
- Добавлены столбцы `value1`, `value2`, ..., `value10` в `system.text_log`. Эти столбцы содержат значения, которые использовались для форматирования сообщения. [#59619](https://github.com/ClickHouse/ClickHouse/pull/59619) ([Alexey Katsman](https://github.com/alexkats)).
- Добавлен постоянный виртуальный столбец `_block_offset`, который хранит исходный номер строки в блоке, присвоенный при вставке. Постоянство столбца `_block_offset` можно включить с помощью настройки MergeTree `enable_block_offset_column`. Добавлен виртуальный столбец `_part_data_version`, который содержит либо минимальный номер блока, либо версию мутации куска. Постоянный виртуальный столбец `_block_number` больше не считается экспериментальным. [#60676](https://github.com/ClickHouse/ClickHouse/pull/60676) ([Anton Popov](https://github.com/CurtizJ)).
- Добавлена настройка `input_format_json_throw_on_bad_escape_sequence`, её отключение позволяет сохранять некорректные escape-последовательности во входных форматах JSON. [#61889](https://github.com/ClickHouse/ClickHouse/pull/61889) ([Kruglov Pavel](https://github.com/Avogar)).


#### Улучшение производительности {#performance-improvement-8}

- Улучшения проталкивания фильтров JOIN с использованием эквивалентных множеств. [#61216](https://github.com/ClickHouse/ClickHouse/pull/61216) ([Maksim Kita](https://github.com/kitaisreal)).
- Оптимизация преобразования OUTER JOIN в INNER JOIN, если фильтр после JOIN всегда отфильтровывает значения по умолчанию. Оптимизация управляется настройкой `query_plan_convert_outer_join_to_inner_join`, включена по умолчанию. [#62907](https://github.com/ClickHouse/ClickHouse/pull/62907) ([Maksim Kita](https://github.com/kitaisreal)).
- Улучшение для AWS S3. Клиент должен отправлять заголовок 'Keep-Alive: timeout=X' на сервер. Если клиент получает ответ от сервера с этим заголовком, он должен использовать значение от сервера. Также клиенту лучше не использовать соединение, срок действия которого близок к истечению, чтобы избежать состояния гонки при закрытии соединения. [#62249](https://github.com/ClickHouse/ClickHouse/pull/62249) ([Sema Checherinda](https://github.com/CheSema)).
- Снижение накладных расходов мутаций для запросов SELECT (версия 2). [#60856](https://github.com/ClickHouse/ClickHouse/pull/60856) ([Azat Khuzhin](https://github.com/azat)).
- Наиболее часто вызываемые функции в PODArray теперь принудительно встраиваются. [#61144](https://github.com/ClickHouse/ClickHouse/pull/61144) ([李扬](https://github.com/taiyang-li)).
- Ускорение разбора JSON путем пропуска остальной части объекта после чтения всех необходимых столбцов. [#62210](https://github.com/ClickHouse/ClickHouse/pull/62210) ([lgbo](https://github.com/lgbo-ustc)).
- Улучшение тривиальных операций INSERT SELECT из файлов в табличных функциях file/s3/hdfs/url/... Добавлена отдельная настройка max_parsing_threads для управления количеством потоков, используемых при параллельном разборе. [#62404](https://github.com/ClickHouse/ClickHouse/pull/62404) ([Kruglov Pavel](https://github.com/Avogar)).
- Функции `to_utc_timestamp` и `from_utc_timestamp` теперь работают примерно в 2 раза быстрее. [#62583](https://github.com/ClickHouse/ClickHouse/pull/62583) ([KevinyhZou](https://github.com/KevinyhZou)).
- Функции `parseDateTimeOrNull`, `parseDateTimeOrZero`, `parseDateTimeInJodaSyntaxOrNull` и `parseDateTimeInJodaSyntaxOrZero` теперь работают значительно быстрее (в 10–1000 раз), когда входные данные содержат в основном неразбираемые значения. [#62634](https://github.com/ClickHouse/ClickHouse/pull/62634) ([LiuNeng](https://github.com/liuneng1994)).
- Запросы SELECT к `system.query_cache` теперь заметно быстрее, когда кеш запросов содержит много записей (например, более 100 000). [#62671](https://github.com/ClickHouse/ClickHouse/pull/62671) ([Robert Schulze](https://github.com/rschu1ze)).
- Меньше конкуренции в кеше файловой системы (часть 3): выполнение удаления из файловой системы без блокировки при попытке резервирования места. [#61163](https://github.com/ClickHouse/ClickHouse/pull/61163) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Ускорение динамического изменения размера кеша файловой системы. [#61723](https://github.com/ClickHouse/ClickHouse/pull/61723) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Источник словаря с `INVALIDATE_QUERY` больше не перезагружается дважды при запуске. [#62050](https://github.com/ClickHouse/ClickHouse/pull/62050) ([vdimir](https://github.com/vdimir)).
- Исправлена проблема, при которой добавление избыточного `= 1` или `= 0` после булевого выражения с первичным ключом приводило к неиспользованию первичного индекса. Например, оба запроса `SELECT * FROM <table> WHERE <primary-key> IN (<value>) = 1` и `SELECT * FROM <table> WHERE <primary-key> NOT IN (<value>) = 0` выполняли полное сканирование таблицы, хотя первичный индекс мог быть использован. [#62142](https://github.com/ClickHouse/ClickHouse/pull/62142) ([josh-hildred](https://github.com/josh-hildred)).
- Возврат потока блоков из `system.remote_data_paths` вместо накопления всего результата в одном большом блоке. Это позволяет потреблять меньше памяти, показывать промежуточный прогресс и отменять запрос. [#62613](https://github.com/ClickHouse/ClickHouse/pull/62613) ([Alexander Gololobov](https://github.com/davenger)).

#### Экспериментальная функциональность {#experimental-feature-6}

- Поддержка параллельного буфера записи для Azure Blob Storage, управляемого с помощью настройки `azure_allow_parallel_part_upload`. [#62534](https://github.com/ClickHouse/ClickHouse/pull/62534) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Кэш страниц пользовательского пространства теперь работает со статическим веб-хранилищем (`disk(type = web)`). Для включения используйте клиентскую настройку `use_page_cache_for_disks_without_file_cache=1`. [#61911](https://github.com/ClickHouse/ClickHouse/pull/61911) ([Michael Kolupaev](https://github.com/al13n321)).
- Варианты Bool и числовых типов больше не рассматриваются как подозрительные в типе `Variant`. [#61999](https://github.com/ClickHouse/ClickHouse/pull/61999) ([Kruglov Pavel](https://github.com/Avogar)).
- Реализовано улучшенное преобразование из String в `Variant` с использованием парсинга. [#62005](https://github.com/ClickHouse/ClickHouse/pull/62005) ([Kruglov Pavel](https://github.com/Avogar)).
- Поддержка `Variant` в функциях JSONExtract. [#62014](https://github.com/ClickHouse/ClickHouse/pull/62014) ([Kruglov Pavel](https://github.com/Avogar)).
- Тип `Variant` помечен как сравнимый, что позволяет использовать его в первичном ключе. [#62693](https://github.com/ClickHouse/ClickHouse/pull/62693) ([Kruglov Pavel](https://github.com/Avogar)).


#### Улучшение {#improvement-8}

- Для удобства `SELECT * FROM numbers()` будет работать так же, как `SELECT * FROM system.numbers` — без ограничения. [#61969](https://github.com/ClickHouse/ClickHouse/pull/61969) ([YenchangChan](https://github.com/YenchangChan)).
- Введены отдельные теги consumer/producer для конфигурации Kafka. Это позволяет избежать предупреждений от librdkafka (плохой библиотеки на C с множеством ошибок) о том, что свойства потребителя были указаны для экземпляров производителя и наоборот (например, `Configuration property session.timeout.ms is a consumer property and will be ignored by this producer instance`). Закрывает: [#58983](https://github.com/ClickHouse/ClickHouse/issues/58983). [#58956](https://github.com/ClickHouse/ClickHouse/pull/58956) ([Aleksandr Musorin](https://github.com/AVMusorin)).
- Функции `date_diff` и `age` теперь вычисляют результат с точностью до наносекунды вместо микросекунды. Они также теперь поддерживают `nanosecond` (или `nanoseconds`, или `ns`) в качестве возможного значения для параметра `unit`. [#61409](https://github.com/ClickHouse/ClickHouse/pull/61409) ([Austin Kothig](https://github.com/kothiga)).
- Добавлены единицы измерения нано-, микро-, миллисекунды для `date_trunc`. [#62335](https://github.com/ClickHouse/ClickHouse/pull/62335) ([Misz606](https://github.com/Misz606)).
- Перезагрузка цепочки сертификатов при перезагрузке сертификата. [#61671](https://github.com/ClickHouse/ClickHouse/pull/61671) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
- Попытка предотвратить ошибку [#60432](https://github.com/ClickHouse/ClickHouse/issues/60432) путем запрета подключения таблицы, если для данного пути реплики существует активная реплика. [#61876](https://github.com/ClickHouse/ClickHouse/pull/61876) ([Arthur Passos](https://github.com/arthurpassos)).
- Реализована поддержка `input` для `clickhouse-local`. [#61923](https://github.com/ClickHouse/ClickHouse/pull/61923) ([Azat Khuzhin](https://github.com/azat)).
- Движок таблиц `Join` со строгостью `ANY` теперь согласован после перезагрузки. Когда вставляется несколько строк с одинаковым ключом, первая будет иметь более высокий приоритет (ранее выбор был случайным при загрузке таблицы). Закрывает [#51027](https://github.com/ClickHouse/ClickHouse/issues/51027). [#61972](https://github.com/ClickHouse/ClickHouse/pull/61972) ([vdimir](https://github.com/vdimir)).
- Автоматический вывод типов столбцов Nullable из схемы Apache Arrow. [#61984](https://github.com/ClickHouse/ClickHouse/pull/61984) ([Maksim Kita](https://github.com/kitaisreal)).
- Возможность отмены параллельного слияния агрегатных состояний во время агрегации. Пример: `uniqExact`. [#61992](https://github.com/ClickHouse/ClickHouse/pull/61992) ([Maksim Kita](https://github.com/kitaisreal)).
- Использование `system.keywords` для заполнения подсказок, а также их применение во всех местах внутри системы. [#62000](https://github.com/ClickHouse/ClickHouse/pull/62000) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- `OPTIMIZE FINAL` для `ReplicatedMergeTree` теперь будет ожидать завершения текущих активных слияний, а затем повторно попытается запланировать финальное слияние. Это приведет поведение в соответствие с обычным поведением `MergeTree`. [#62067](https://github.com/ClickHouse/ClickHouse/pull/62067) ([Nikita Taranov](https://github.com/nickitat)).
- При чтении данных из текстового файла Hive первая строка использовалась для определения количества входных полей, и иногда количество полей в первой строке не совпадало с определением таблицы Hive. Например, таблица Hive определена с 3 столбцами, как `test_tbl(a Int32, b Int32, c Int32)`, но первая строка текстового файла содержит только 2 поля. В этой ситуации входные поля изменялись до 2, и если следующая строка текстового файла содержала 3 поля, третье поле не могло быть прочитано и устанавливалось в значение по умолчанию 0, что неверно. [#62086](https://github.com/ClickHouse/ClickHouse/pull/62086) ([KevinyhZou](https://github.com/KevinyhZou)).
- `CREATE AS` копирует комментарий таблицы. [#62117](https://github.com/ClickHouse/ClickHouse/pull/62117) ([Pablo Marcos](https://github.com/pamarcos)).
- Добавлен прогресс выполнения запроса в таблицу zookeeper. [#62152](https://github.com/ClickHouse/ClickHouse/pull/62152) ([JackyWoo](https://github.com/JackyWoo)).
- Добавлена возможность включения сборщика трассировки (Real и CPU) на уровне всего сервера. [#62189](https://github.com/ClickHouse/ClickHouse/pull/62189) ([alesapin](https://github.com/alesapin)).
- Добавлена настройка `lightweight_deletes_sync` (значение по умолчанию: 2 — синхронное ожидание всех реплик). Она аналогична настройке `mutations_sync`, но влияет только на поведение легковесных удалений. [#62195](https://github.com/ClickHouse/ClickHouse/pull/62195) ([Anton Popov](https://github.com/CurtizJ)).
- Различение булевых значений и целых чисел при разборе значений для пользовательских настроек: `SET custom_a = true; SET custom_b = 1;`. [#62206](https://github.com/ClickHouse/ClickHouse/pull/62206) ([Vitaly Baranov](https://github.com/vitlibar)).
- Поддержка доступа к S3 через конечные точки AWS Private Link Interface. Закрывает [#60021](https://github.com/ClickHouse/ClickHouse/issues/60021), [#31074](https://github.com/ClickHouse/ClickHouse/issues/31074) и [#53761](https://github.com/ClickHouse/ClickHouse/issues/53761). [#62208](https://github.com/ClickHouse/ClickHouse/pull/62208) ([Arthur Passos](https://github.com/arthurpassos)).
- Не создавать директорию для UDF в clickhouse-client, если она не существует. Это закрывает [#59597](https://github.com/ClickHouse/ClickHouse/issues/59597). [#62366](https://github.com/ClickHouse/ClickHouse/pull/62366) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Кеш запросов теперь больше не кеширует результаты запросов к системным таблицам (`system.*`, `information_schema.*`, `INFORMATION_SCHEMA.*`). [#62376](https://github.com/ClickHouse/ClickHouse/pull/62376) ([Robert Schulze](https://github.com/rschu1ze)).
- Запрос `MOVE PARTITION TO TABLE` может быть задержан или может выбросить исключение `TOO_MANY_PARTS`, чтобы избежать превышения лимитов на количество частей. Применяются те же настройки и лимиты, что и для запроса `INSERT` (см. настройки `max_parts_in_total`, `parts_to_delay_insert`, `parts_to_throw_insert`, `inactive_parts_to_throw_insert`, `inactive_parts_to_delay_insert`, `max_avg_part_size_for_too_many_parts`, `min_delay_to_insert_ms` и `max_delay_to_insert`). [#62420](https://github.com/ClickHouse/ClickHouse/pull/62420) ([Sergei Trifonov](https://github.com/serxa)).
- Изменена директория установки по умолчанию на macOS с `/usr/bin` на `/usr/local/bin`. Это необходимо, поскольку System Integrity Protection от Apple, введенная в macOS El Capitan (2015), запрещает запись в `/usr/bin`, даже с использованием `sudo`. [#62489](https://github.com/ClickHouse/ClickHouse/pull/62489) ([haohang](https://github.com/yokofly)).
- Функция transform теперь всегда возвращает первое совпадение. [#62518](https://github.com/ClickHouse/ClickHouse/pull/62518) ([Raúl Marín](https://github.com/Algunenano)).
- Добавлен отсутствующий столбец `hostname` в системную таблицу `blob_storage_log`. [#62456](https://github.com/ClickHouse/ClickHouse/pull/62456) ([Jayme Bird](https://github.com/jaymebrd)).
- Для согласованности с другими системными таблицами `system.backup_log` теперь имеет столбец `event_time`. [#62541](https://github.com/ClickHouse/ClickHouse/pull/62541) ([Jayme Bird](https://github.com/jaymebrd)).
- Таблица `system.backup_log` теперь имеет ключ сортировки по умолчанию `event_date, event_time`, как и для других движков таблиц `_log`. [#62667](https://github.com/ClickHouse/ClickHouse/pull/62667) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Избегание вычисления выражений DEFAULT таблицы при выполнении `RESTORE`. [#62601](https://github.com/ClickHouse/ClickHouse/pull/62601) ([Vitaly Baranov](https://github.com/vitlibar)).
- Хранилище S3 и резервные копии также требуют тех же настроек keep alive по умолчанию, что и диск s3. [#62648](https://github.com/ClickHouse/ClickHouse/pull/62648) ([Sema Checherinda](https://github.com/CheSema)).
- Добавлен идентификатор клиента librdkafka (той печально известной библиотеки на C с множеством ошибок) в сообщения журнала для возможности различать сообщения журнала от разных потребителей одной таблицы. [#62813](https://github.com/ClickHouse/ClickHouse/pull/62813) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Разрешены специальные макросы `{uuid}` и `{database}` в пути ZooKeeper реплицируемой базы данных. [#62818](https://github.com/ClickHouse/ClickHouse/pull/62818) ([Vitaly Baranov](https://github.com/vitlibar)).
- Разрешен ключ квоты с другой схемой аутентификации в HTTP-запросах. [#62842](https://github.com/ClickHouse/ClickHouse/pull/62842) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Снижена подробность вывода аргумента командной строки `--help` в `clickhouse client` и `clickhouse local`. Предыдущий вывод теперь генерируется с помощью `--help --verbose`. [#62973](https://github.com/ClickHouse/ClickHouse/pull/62973) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- `log_bin_use_v1_row_events` был удален в MySQL 8.3, и мы адаптировали экспериментальный движок `MaterializedMySQL` для этого [#60479](https://github.com/ClickHouse/ClickHouse/issues/60479). [#63101](https://github.com/ClickHouse/ClickHouse/pull/63101) ([Eugene Klimov](https://github.com/Slach)). Автор: Nikolay Yankin.





#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-4}

- Добавлены зависимости Rust в дерево исходного кода, чтобы код на Rust (который мы используем для второстепенных функций ради хайпа и веселья) можно было собирать разумным способом, аналогично C++. [#62297](https://github.com/ClickHouse/ClickHouse/pull/62297) ([Raúl Marín](https://github.com/Algunenano)).
- ClickHouse теперь использует OpenSSL 3.2 вместо BoringSSL. [#59870](https://github.com/ClickHouse/ClickHouse/pull/59870) ([Robert Schulze](https://github.com/rschu1ze)). Обратите внимание, что OpenSSL в целом имеет более низкую инженерную культуру (например, ненулевое количество отчетов санитайзеров, которые нам пришлось исправлять, сложная система сборки с генерируемыми файлами и т. д.), но обеспечивает лучшую совместимость.
- Игнорирование запросов DROP в стресс-тесте с вероятностью 1/2, использование TRUNCATE вместо игнорирования DROP при проверке обновления для таблиц Memory/JOIN. [#61476](https://github.com/ClickHouse/ClickHouse/pull/61476) ([Kruglov Pavel](https://github.com/Avogar)).
- Удалены из Docker-образа Keeper тома в /etc/clickhouse-keeper и /var/log/clickhouse-keeper. [#61683](https://github.com/ClickHouse/ClickHouse/pull/61683) ([Tristan](https://github.com/Tristan971)).
- Добавлены тесты для всех проблем, которые больше не актуальны при включенном по умолчанию анализаторе (Analyzer). Closes: [#55794](https://github.com/ClickHouse/ClickHouse/issues/55794) Closes: [#49472](https://github.com/ClickHouse/ClickHouse/issues/49472) Closes: [#44414](https://github.com/ClickHouse/ClickHouse/issues/44414) Closes: [#13843](https://github.com/ClickHouse/ClickHouse/issues/13843) Closes: [#55803](https://github.com/ClickHouse/ClickHouse/issues/55803) Closes: [#48308](https://github.com/ClickHouse/ClickHouse/issues/48308) Closes: [#45535](https://github.com/ClickHouse/ClickHouse/issues/45535) Closes: [#44365](https://github.com/ClickHouse/ClickHouse/issues/44365) Closes: [#44153](https://github.com/ClickHouse/ClickHouse/issues/44153) Closes: [#42399](https://github.com/ClickHouse/ClickHouse/issues/42399) Closes: [#27115](https://github.com/ClickHouse/ClickHouse/issues/27115) Closes: [#23162](https://github.com/ClickHouse/ClickHouse/issues/23162) Closes: [#15395](https://github.com/ClickHouse/ClickHouse/issues/15395) Closes: [#15411](https://github.com/ClickHouse/ClickHouse/issues/15411) Closes: [#14978](https://github.com/ClickHouse/ClickHouse/issues/14978) Closes: [#17319](https://github.com/ClickHouse/ClickHouse/issues/17319) Closes: [#11813](https://github.com/ClickHouse/ClickHouse/issues/11813) Closes: [#13210](https://github.com/ClickHouse/ClickHouse/issues/13210) Closes: [#23053](https://github.com/ClickHouse/ClickHouse/issues/23053) Closes: [#37729](https://github.com/ClickHouse/ClickHouse/issues/37729) Closes: [#32639](https://github.com/ClickHouse/ClickHouse/issues/32639) Closes: [#9954](https://github.com/ClickHouse/ClickHouse/issues/9954) Closes: [#41964](https://github.com/ClickHouse/ClickHouse/issues/41964) Closes: [#54317](https://github.com/ClickHouse/ClickHouse/issues/54317) Closes: [#7520](https://github.com/ClickHouse/ClickHouse/issues/7520) Closes: [#36973](https://github.com/ClickHouse/ClickHouse/issues/36973) Closes: [#40955](https://github.com/ClickHouse/ClickHouse/issues/40955) Closes: [#19687](https://github.com/ClickHouse/ClickHouse/issues/19687) Closes: [#23104](https://github.com/ClickHouse/ClickHouse/issues/23104) Closes: [#21584](https://github.com/ClickHouse/ClickHouse/issues/21584) Closes: [#23344](https://github.com/ClickHouse/ClickHouse/issues/23344) Closes: [#22627](https://github.com/ClickHouse/ClickHouse/issues/22627) Closes: [#10276](https://github.com/ClickHouse/ClickHouse/issues/10276) Closes: [#19687](https://github.com/ClickHouse/ClickHouse/issues/19687) Closes: [#4567](https://github.com/ClickHouse/ClickHouse/issues/4567) Closes: [#17710](https://github.com/ClickHouse/ClickHouse/issues/17710) Closes: [#11068](https://github.com/ClickHouse/ClickHouse/issues/11068) Closes: [#24395](https://github.com/ClickHouse/ClickHouse/issues/24395) Closes: [#23416](https://github.com/ClickHouse/ClickHouse/issues/23416) Closes: [#23162](https://github.com/ClickHouse/ClickHouse/issues/23162) Closes: [#25655](https://github.com/ClickHouse/ClickHouse/issues/25655) Closes: [#11757](https://github.com/ClickHouse/ClickHouse/issues/11757) Closes: [#6571](https://github.com/ClickHouse/ClickHouse/issues/6571) Closes: [#4432](https://github.com/ClickHouse/ClickHouse/issues/4432) Closes: [#8259](https://github.com/ClickHouse/ClickHouse/issues/8259) Closes: [#9233](https://github.com/ClickHouse/ClickHouse/issues/9233) Closes: [#14699](https://github.com/ClickHouse/ClickHouse/issues/14699) Closes: [#27068](https://github.com/ClickHouse/ClickHouse/issues/27068) Closes: [#28687](https://github.com/ClickHouse/ClickHouse/issues/28687) Closes: [#28777](https://github.com/ClickHouse/ClickHouse/issues/28777) Closes: [#29734](https://github.com/ClickHouse/ClickHouse/issues/29734) Closes: [#61238](https://github.com/ClickHouse/ClickHouse/issues/61238) Closes: [#33825](https://github.com/ClickHouse/ClickHouse/issues/33825) Closes: [#35608](https://github.com/ClickHouse/ClickHouse/issues/35608) Closes: [#29838](https://github.com/ClickHouse/ClickHouse/issues/29838) Closes: [#35652](https://github.com/ClickHouse/ClickHouse/issues/35652) Closes: [#36189](https://github.com/ClickHouse/ClickHouse/issues/36189) Closes: [#39634](https://github.com/ClickHouse/ClickHouse/issues/39634) Closes: [#47432](https://github.com/ClickHouse/ClickHouse/issues/47432) Closes: [#54910](https://github.com/ClickHouse/ClickHouse/issues/54910) Closes: [#57321](https://github.com/ClickHouse/ClickHouse/issues/57321) Closes: [#59154](https://github.com/ClickHouse/ClickHouse/issues/59154) Closes: [#61014](https://github.com/ClickHouse/ClickHouse/issues/61014) Closes: [#61950](https://github.com/ClickHouse/ClickHouse/issues/61950) Closes: [#55647](https://github.com/ClickHouse/ClickHouse/issues/55647) Closes: [#61947](https://github.com/ClickHouse/ClickHouse/issues/61947). [#62185](https://github.com/ClickHouse/ClickHouse/pull/62185) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Добавлены дополнительные тесты из проблем, которые больше не актуальны или исправлены анализатором (Analyzer). Closes: [#58985](https://github.com/ClickHouse/ClickHouse/issues/58985) Closes: [#59549](https://github.com/ClickHouse/ClickHouse/issues/59549) Closes: [#36963](https://github.com/ClickHouse/ClickHouse/issues/36963) Closes: [#39453](https://github.com/ClickHouse/ClickHouse/issues/39453) Closes: [#56521](https://github.com/ClickHouse/ClickHouse/issues/56521) Closes: [#47552](https://github.com/ClickHouse/ClickHouse/issues/47552) Closes: [#56503](https://github.com/ClickHouse/ClickHouse/issues/56503) Closes: [#59101](https://github.com/ClickHouse/ClickHouse/issues/59101) Closes: [#50271](https://github.com/ClickHouse/ClickHouse/issues/50271) Closes: [#54954](https://github.com/ClickHouse/ClickHouse/issues/54954) Closes: [#56466](https://github.com/ClickHouse/ClickHouse/issues/56466) Closes: [#11000](https://github.com/ClickHouse/ClickHouse/issues/11000) Closes: [#10894](https://github.com/ClickHouse/ClickHouse/issues/10894) Closes: https://github.com/ClickHouse/ClickHouse/issues/448 Closes: [#8030](https://github.com/ClickHouse/ClickHouse/issues/8030) Closes: [#32139](https://github.com/ClickHouse/ClickHouse/issues/32139) Closes: [#47288](https://github.com/ClickHouse/ClickHouse/issues/47288) Closes: [#50705](https://github.com/ClickHouse/ClickHouse/issues/50705) Closes: [#54511](https://github.com/ClickHouse/ClickHouse/issues/54511) Closes: [#55466](https://github.com/ClickHouse/ClickHouse/issues/55466) Closes: [#58500](https://github.com/ClickHouse/ClickHouse/issues/58500) Closes: [#39923](https://github.com/ClickHouse/ClickHouse/issues/39923) Closes: [#39855](https://github.com/ClickHouse/ClickHouse/issues/39855) Closes: [#4596](https://github.com/ClickHouse/ClickHouse/issues/4596) Closes: [#47422](https://github.com/ClickHouse/ClickHouse/issues/47422) Closes: [#33000](https://github.com/ClickHouse/ClickHouse/issues/33000) Closes: [#14739](https://github.com/ClickHouse/ClickHouse/issues/14739) Closes: [#44039](https://github.com/ClickHouse/ClickHouse/issues/44039) Closes: [#8547](https://github.com/ClickHouse/ClickHouse/issues/8547) Closes: [#22923](https://github.com/ClickHouse/ClickHouse/issues/22923) Closes: [#23865](https://github.com/ClickHouse/ClickHouse/issues/23865) Closes: [#29748](https://github.com/ClickHouse/ClickHouse/issues/29748) Closes: [#4222](https://github.com/ClickHouse/ClickHouse/issues/4222). [#62457](https://github.com/ClickHouse/ClickHouse/pull/62457) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Исправлены ошибки сборки при динамической компоновке OpenSSL (примечание: это в целом не поддерживается и требуется только для платформ IBM s390x). [#62888](https://github.com/ClickHouse/ClickHouse/pull/62888) ([Harry Lee](https://github.com/HarryLeeIBM)).





#### Исправление ошибок (видимые пользователю проблемы в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-6}

- Fix logical-error when undoing quorum insert transaction. [#61953](https://github.com/ClickHouse/ClickHouse/pull/61953) ([Han Fei](https://github.com/hanfei1991)).
- Fix parser error when using COUNT(\*) with FILTER clause [#61357](https://github.com/ClickHouse/ClickHouse/pull/61357) ([Duc Canh Le](https://github.com/canhld94)).
- Fix logical error in `group_by_use_nulls` + grouping sets + analyzer + materialize/constant [#61567](https://github.com/ClickHouse/ClickHouse/pull/61567) ([Kruglov Pavel](https://github.com/Avogar)).
- Cancel merges before removing moved parts [#61610](https://github.com/ClickHouse/ClickHouse/pull/61610) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fix abort in Apache Arrow [#61720](https://github.com/ClickHouse/ClickHouse/pull/61720) ([Kruglov Pavel](https://github.com/Avogar)).
- Search for `convert_to_replicated` flag at the correct path corresponding to the specific disk [#61769](https://github.com/ClickHouse/ClickHouse/pull/61769) ([Kirill](https://github.com/kirillgarbar)).
- Fix possible connections data-race for distributed_foreground_insert/distributed_background_insert_batch [#61867](https://github.com/ClickHouse/ClickHouse/pull/61867) ([Azat Khuzhin](https://github.com/azat)).
- Mark CANNOT_PARSE_ESCAPE_SEQUENCE error as parse error to be able to skip it in row input formats [#61883](https://github.com/ClickHouse/ClickHouse/pull/61883) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix writing exception message in output format in HTTP when http_wait_end_of_query is used [#61951](https://github.com/ClickHouse/ClickHouse/pull/61951) ([Kruglov Pavel](https://github.com/Avogar)).
- Proper fix for LowCardinality together with JSONExtact functions [#61957](https://github.com/ClickHouse/ClickHouse/pull/61957) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Crash in Engine Merge if Row Policy does not have expression [#61971](https://github.com/ClickHouse/ClickHouse/pull/61971) ([Ilya Golshtein](https://github.com/ilejn)).
- Fix WriteBufferAzureBlobStorage destructor uncaught exception [#61988](https://github.com/ClickHouse/ClickHouse/pull/61988) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Fix CREATE TABLE without columns definition for ReplicatedMergeTree [#62040](https://github.com/ClickHouse/ClickHouse/pull/62040) ([Azat Khuzhin](https://github.com/azat)).
- Fix optimize_skip_unused_shards_rewrite_in for composite sharding key [#62047](https://github.com/ClickHouse/ClickHouse/pull/62047) ([Azat Khuzhin](https://github.com/azat)).
- ReadWriteBufferFromHTTP set right header host when redirected [#62068](https://github.com/ClickHouse/ClickHouse/pull/62068) ([Sema Checherinda](https://github.com/CheSema)).
- Fix external table cannot parse data type Bool [#62115](https://github.com/ClickHouse/ClickHouse/pull/62115) ([Duc Canh Le](https://github.com/canhld94)).
- Analyzer: Fix query parameter resolution [#62186](https://github.com/ClickHouse/ClickHouse/pull/62186) ([Dmitry Novik](https://github.com/novikd)).
- Fix restoring parts while readonly [#62207](https://github.com/ClickHouse/ClickHouse/pull/62207) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix crash in index definition containing SQL UDF [#62225](https://github.com/ClickHouse/ClickHouse/pull/62225) ([vdimir](https://github.com/vdimir)).
- Fixing NULL random seed for generateRandom with analyzer. [#62248](https://github.com/ClickHouse/ClickHouse/pull/62248) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Correctly handle const columns in Distinct Transfom [#62250](https://github.com/ClickHouse/ClickHouse/pull/62250) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix Parts Splitter for queries with the FINAL modifier [#62268](https://github.com/ClickHouse/ClickHouse/pull/62268) ([Nikita Taranov](https://github.com/nickitat)).
- Analyzer: Fix alias to parametrized view resolution [#62274](https://github.com/ClickHouse/ClickHouse/pull/62274) ([Dmitry Novik](https://github.com/novikd)).
- Analyzer: Fix name resolution from parent scopes [#62281](https://github.com/ClickHouse/ClickHouse/pull/62281) ([Dmitry Novik](https://github.com/novikd)).
- Fix argMax with nullable non native numeric column [#62285](https://github.com/ClickHouse/ClickHouse/pull/62285) ([Raúl Marín](https://github.com/Algunenano)).
- Fix BACKUP and RESTORE of a materialized view in Ordinary database [#62295](https://github.com/ClickHouse/ClickHouse/pull/62295) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix data race on scalars in Context [#62305](https://github.com/ClickHouse/ClickHouse/pull/62305) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix primary key in materialized view [#62319](https://github.com/ClickHouse/ClickHouse/pull/62319) ([Murat Khairulin](https://github.com/mxwell)).
- Do not build multithread insert pipeline for tables without support [#62333](https://github.com/ClickHouse/ClickHouse/pull/62333) ([vdimir](https://github.com/vdimir)).
- Fix analyzer with positional arguments in distributed query [#62362](https://github.com/ClickHouse/ClickHouse/pull/62362) ([flynn](https://github.com/ucasfl)).
- Fix filter pushdown from additional_table_filters in Merge engine in analyzer [#62398](https://github.com/ClickHouse/ClickHouse/pull/62398) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix GLOBAL IN table queries with analyzer. [#62409](https://github.com/ClickHouse/ClickHouse/pull/62409) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Respect settings truncate_on_insert/create_new_file_on_insert in s3/hdfs/azure engines during partitioned write [#62425](https://github.com/ClickHouse/ClickHouse/pull/62425) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix backup restore path for AzureBlobStorage [#62447](https://github.com/ClickHouse/ClickHouse/pull/62447) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Fix SimpleSquashingChunksTransform [#62451](https://github.com/ClickHouse/ClickHouse/pull/62451) ([Nikita Taranov](https://github.com/nickitat)).
- Fix capture of nested lambda. [#62462](https://github.com/ClickHouse/ClickHouse/pull/62462) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Avoid crash when reading protobuf with recursive types [#62506](https://github.com/ClickHouse/ClickHouse/pull/62506) ([Raúl Marín](https://github.com/Algunenano)).
- Fix a bug moving one partition from one to itself [#62524](https://github.com/ClickHouse/ClickHouse/pull/62524) ([helifu](https://github.com/helifu)).
- Fix scalar subquery in LIMIT [#62567](https://github.com/ClickHouse/ClickHouse/pull/62567) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix segfault in the experimental and unsupported Hive engine, which we don't like anyway [#62578](https://github.com/ClickHouse/ClickHouse/pull/62578) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix memory leak in groupArraySorted [#62597](https://github.com/ClickHouse/ClickHouse/pull/62597) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix crash in largestTriangleThreeBuckets [#62646](https://github.com/ClickHouse/ClickHouse/pull/62646) ([Raúl Marín](https://github.com/Algunenano)).
- Fix tumble\[Start,End\] and hop\[Start,End\] for bigger resolutions [#62705](https://github.com/ClickHouse/ClickHouse/pull/62705) ([Jordi Villar](https://github.com/jrdi)).
- Fix argMin/argMax combinator state [#62708](https://github.com/ClickHouse/ClickHouse/pull/62708) ([Raúl Marín](https://github.com/Algunenano)).
- Fix temporary data in cache failing because of cache lock contention optimization [#62715](https://github.com/ClickHouse/ClickHouse/pull/62715) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix crash in function `mergeTreeIndex` [#62762](https://github.com/ClickHouse/ClickHouse/pull/62762) ([Anton Popov](https://github.com/CurtizJ)).
- fix: update: nested materialized columns: size check fixes [#62773](https://github.com/ClickHouse/ClickHouse/pull/62773) ([Eliot Hautefeuille](https://github.com/hileef)).
- Fix FINAL modifier is not respected in CTE with analyzer [#62811](https://github.com/ClickHouse/ClickHouse/pull/62811) ([Duc Canh Le](https://github.com/canhld94)).
- Fix crash in function `formatRow` with `JSON` format and HTTP interface [#62840](https://github.com/ClickHouse/ClickHouse/pull/62840) ([Anton Popov](https://github.com/CurtizJ)).
- Azure: fix building final url from endpoint object [#62850](https://github.com/ClickHouse/ClickHouse/pull/62850) ([Daniel Pozo Escalona](https://github.com/danipozo)).
- Fix GCD codec [#62853](https://github.com/ClickHouse/ClickHouse/pull/62853) ([Nikita Taranov](https://github.com/nickitat)).
- Fix LowCardinality(Nullable) key in hyperrectangle [#62866](https://github.com/ClickHouse/ClickHouse/pull/62866) ([Amos Bird](https://github.com/amosbird)).
- Fix fromUnixtimestamp in joda syntax while the input value beyond UInt32 [#62901](https://github.com/ClickHouse/ClickHouse/pull/62901) ([KevinyhZou](https://github.com/KevinyhZou)).
- Disable optimize_rewrite_aggregate_function_with_if for sum(nullable) [#62912](https://github.com/ClickHouse/ClickHouse/pull/62912) ([Raúl Marín](https://github.com/Algunenano)).
- Fix PREWHERE for StorageBuffer with different source table column types. [#62916](https://github.com/ClickHouse/ClickHouse/pull/62916) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix temporary data in cache incorrectly processing failure of cache key directory creation [#62925](https://github.com/ClickHouse/ClickHouse/pull/62925) ([Kseniia Sumarokova](https://github.com/kssenii)).
- gRPC: fix crash on IPv6 peer connection [#62978](https://github.com/ClickHouse/ClickHouse/pull/62978) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Fix possible CHECKSUM_DOESNT_MATCH (and others) during replicated fetches [#62987](https://github.com/ClickHouse/ClickHouse/pull/62987) ([Azat Khuzhin](https://github.com/azat)).
- Fix terminate with uncaught exception in temporary data in cache [#62998](https://github.com/ClickHouse/ClickHouse/pull/62998) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix optimize_rewrite_aggregate_function_with_if implicit cast [#62999](https://github.com/ClickHouse/ClickHouse/pull/62999) ([Raúl Marín](https://github.com/Algunenano)).
- Fix unhandled exception in ~RestorerFromBackup [#63040](https://github.com/ClickHouse/ClickHouse/pull/63040) ([Vitaly Baranov](https://github.com/vitlibar)).
- Do not remove server constants from GROUP BY key for secondary query. [#63047](https://github.com/ClickHouse/ClickHouse/pull/63047) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix incorrect judgement of of monotonicity of function abs [#63097](https://github.com/ClickHouse/ClickHouse/pull/63097) ([Duc Canh Le](https://github.com/canhld94)).
- Set server name for SSL handshake in MongoDB engine [#63122](https://github.com/ClickHouse/ClickHouse/pull/63122) ([Alexander Gololobov](https://github.com/davenger)).
- Use user specified db instead of "config" for MongoDB wire protocol version check [#63126](https://github.com/ClickHouse/ClickHouse/pull/63126) ([Alexander Gololobov](https://github.com/davenger)).

### <a id="243"></a> Релиз ClickHouse 24.3 LTS, 27.03.2024 {#a-id243a-clickhouse-release-243-lts-2024-03-27}


#### Примечания к обновлению {#upgrade-notes-1}

- Настройка `allow_experimental_analyzer` включена по умолчанию и переключает анализ запросов на новую реализацию с улучшенной совместимостью и полнотой функциональности. Функция "analyzer" теперь считается бета-версией, а не экспериментальной. Вы можете вернуться к прежнему поведению, установив `compatibility` в `24.2` или отключив настройку `allow_experimental_analyzer`. Посмотрите [видео на YouTube](https://www.youtube.com/watch?v=zhrOYQpgvkk).
- ClickHouse допускает произвольные бинарные данные в типе данных String, который обычно представляет UTF-8. Строки Parquet/ORC/Arrow поддерживают только UTF-8. Поэтому вы можете выбрать, какой тип данных Arrow использовать для типа данных String в ClickHouse — String или Binary. Это управляется настройками `output_format_parquet_string_as_string`, `output_format_orc_string_as_string`, `output_format_arrow_string_as_string`. Хотя Binary был бы более корректным и совместимым, использование String по умолчанию соответствует ожиданиям пользователей в большинстве случаев. Parquet/ORC/Arrow поддерживают множество методов сжатия, включая lz4 и zstd. ClickHouse поддерживает все методы сжатия. Некоторые менее совершенные инструменты не поддерживают более быстрый метод сжатия `lz4`, поэтому мы установили `zstd` по умолчанию. Это управляется настройками `output_format_parquet_compression_method`, `output_format_orc_compression_method` и `output_format_arrow_compression_method`. Мы изменили значение по умолчанию на `zstd` для Parquet и ORC, но не для Arrow (он предназначен для низкоуровневого использования). [#61817](https://github.com/ClickHouse/ClickHouse/pull/61817) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- В новой версии ClickHouse функции `geoDistance`, `greatCircleDistance` и `greatCircleAngle` будут использовать 64-битный тип данных с плавающей точкой двойной точности для внутренних вычислений и возвращаемого типа, если все аргументы имеют тип Float64. Это закрывает [#58476](https://github.com/ClickHouse/ClickHouse/issues/58476). В предыдущих версиях функция всегда использовала Float32. Вы можете вернуться к прежнему поведению, установив `geo_distance_returns_float64_on_float64_arguments` в `false` или установив `compatibility` в `24.2` или более раннюю версию. [#61848](https://github.com/ClickHouse/ClickHouse/pull/61848) ([Alexey Milovidov](https://github.com/alexey-milovidov)). В соавторстве с [Geet Patel](https://github.com/geetptl).
- Устаревшие части данных в памяти были объявлены устаревшими начиная с версии 23.5 и не поддерживаются с версии 23.10. Теперь оставшийся код удален. Продолжение [#55186](https://github.com/ClickHouse/ClickHouse/issues/55186) и [#45409](https://github.com/ClickHouse/ClickHouse/issues/45409). Маловероятно, что вы использовали части данных в памяти, поскольку они были доступны только до версии 23.5 и только при их ручном включении путем указания соответствующих SETTINGS для таблицы MergeTree. Чтобы проверить наличие частей данных в памяти, выполните следующий запрос: `SELECT part_type, count() FROM system.parts GROUP BY part_type ORDER BY part_type`. Чтобы отключить использование частей данных в памяти, выполните `ALTER TABLE ... MODIFY SETTING min_bytes_for_compact_part = DEFAULT, min_rows_for_compact_part = DEFAULT`. Перед обновлением со старых версий ClickHouse сначала убедитесь, что у вас нет частей данных в памяти. Если части данных в памяти есть, сначала отключите их, затем дождитесь их исчезновения и продолжите обновление. [#61127](https://github.com/ClickHouse/ClickHouse/pull/61127) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Изменено имя столбца с `duration_ms` на `duration_microseconds` в таблице `system.zookeeper`, чтобы отразить тот факт, что длительность измеряется в микросекундах. [#60774](https://github.com/ClickHouse/ClickHouse/pull/60774) ([Duc Canh Le](https://github.com/canhld94)).
- Отклонение входящих запросов INSERT в случае, когда настройки уровня запроса `async_insert` и `deduplicate_blocks_in_dependent_materialized_views` включены одновременно. Это поведение управляется настройкой `throw_if_deduplication_in_dependent_materialized_views_enabled_with_async_insert` и включено по умолчанию. Это продолжение https://github.com/ClickHouse/ClickHouse/pull/59699, необходимое для разблокировки https://github.com/ClickHouse/ClickHouse/pull/59915. [#60888](https://github.com/ClickHouse/ClickHouse/pull/60888) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Утилита `clickhouse-copier` перенесена в отдельный репозиторий на GitHub: https://github.com/ClickHouse/copier. Она больше не включена в комплект поставки, но по-прежнему доступна для отдельной загрузки. Это закрывает: [#60734](https://github.com/ClickHouse/ClickHouse/issues/60734) Это закрывает: [#60540](https://github.com/ClickHouse/ClickHouse/issues/60540) Это закрывает: [#60250](https://github.com/ClickHouse/ClickHouse/issues/60250) Это закрывает: [#52917](https://github.com/ClickHouse/ClickHouse/issues/52917) Это закрывает: [#51140](https://github.com/ClickHouse/ClickHouse/issues/51140) Это закрывает: [#47517](https://github.com/ClickHouse/ClickHouse/issues/47517) Это закрывает: [#47189](https://github.com/ClickHouse/ClickHouse/issues/47189) Это закрывает: [#46598](https://github.com/ClickHouse/ClickHouse/issues/46598) Это закрывает: [#40257](https://github.com/ClickHouse/ClickHouse/issues/40257) Это закрывает: [#36504](https://github.com/ClickHouse/ClickHouse/issues/36504) Это закрывает: [#35485](https://github.com/ClickHouse/ClickHouse/issues/35485) Это закрывает: [#33702](https://github.com/ClickHouse/ClickHouse/issues/33702) Это закрывает: [#26702](https://github.com/ClickHouse/ClickHouse/issues/26702).
- Для повышения совместимости с MySQL псевдоним совместимости `locate` теперь по умолчанию принимает аргументы `(needle, haystack[, start_pos])`. Предыдущее поведение `(haystack, needle, [, start_pos])` можно восстановить, установив `function_locate_has_mysql_compatible_argument_order` в `0`. [#61092](https://github.com/ClickHouse/ClickHouse/pull/61092) ([Robert Schulze](https://github.com/rschu1ze)).
- Запрещено использование `SimpleAggregateFunction` в `ORDER BY` таблиц `MergeTree` (как и `AggregateFunction`, но они запрещены, потому что не являются сравнимыми) по умолчанию (используйте `allow_suspicious_primary_key`, чтобы разрешить их). [#61399](https://github.com/ClickHouse/ClickHouse/pull/61399) ([Azat Khuzhin](https://github.com/azat)).
- Движок базы данных `Ordinary` объявлен устаревшим. Вы получите предупреждение в clickhouse-client, если ваш сервер использует его. Это закрывает [#52229](https://github.com/ClickHouse/ClickHouse/issues/52229). [#56942](https://github.com/ClickHouse/ClickHouse/pull/56942) ([shabroo](https://github.com/shabroo)).

#### Новые возможности {#new-feature-9}

- Поддержка чтения и записи резервных копий в формате `tar` (в дополнение к `zip`). [#59535](https://github.com/ClickHouse/ClickHouse/pull/59535) ([josh-hildred](https://github.com/josh-hildred)).
- Реализована поддержка бакетов S3 Express. [#59965](https://github.com/ClickHouse/ClickHouse/pull/59965) ([Nikita Taranov](https://github.com/nickitat)).
- Возможность присоединения частей с другого диска (с использованием копирования вместо жёсткой ссылки). [#60112](https://github.com/ClickHouse/ClickHouse/pull/60112) ([Unalian](https://github.com/Unalian)).
- Таблицы `Memory` с ограничением размера: управляются настройками `min_bytes_to_keep, max_bytes_to_keep, min_rows_to_keep` и `max_rows_to_keep`. [#60612](https://github.com/ClickHouse/ClickHouse/pull/60612) ([Jake Bamrah](https://github.com/JakeBamrah)).
- Раздельные ограничения на количество ожидающих и выполняющихся запросов. Добавлена новая серверная настройка `max_waiting_queries`, которая ограничивает количество запросов, ожидающих из-за `async_load_databases`. Существующие ограничения на количество выполняющихся запросов больше не учитывают ожидающие запросы. [#61053](https://github.com/ClickHouse/ClickHouse/pull/61053) ([Sergei Trifonov](https://github.com/serxa)).
- Добавлена таблица `system.keywords`, которая содержит все ключевые слова парсера. В основном необходима и будет использоваться для улучшенного фаззинга и подсветки синтаксиса. [#51808](https://github.com/ClickHouse/ClickHouse/pull/51808) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Добавлена поддержка `ATTACH PARTITION ALL`. [#61107](https://github.com/ClickHouse/ClickHouse/pull/61107) ([Kirill Nikiforov](https://github.com/allmazz)).
- Добавлена новая функция `getClientHTTPHeader`. Закрывает [#54665](https://github.com/ClickHouse/ClickHouse/issues/54665). В соавторстве с @lingtaolf. [#61820](https://github.com/ClickHouse/ClickHouse/pull/61820) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлена табличная функция `generate_series` (псевдоним совместимости с PostgreSQL для существующей функции `numbers`). Эта функция генерирует таблицу с арифметической прогрессией натуральных чисел. [#59390](https://github.com/ClickHouse/ClickHouse/pull/59390) ([divanik](https://github.com/divanik)).
- Режим для `topK`/`topkWeighed`, который возвращает количество значений и его погрешность. [#54508](https://github.com/ClickHouse/ClickHouse/pull/54508) ([UnamedRus](https://github.com/UnamedRus)).
- Добавлена функция `toMillisecond`, которая возвращает компонент миллисекунд для значений типа `DateTime` или `DateTime64`. [#60281](https://github.com/ClickHouse/ClickHouse/pull/60281) ([Shaun Struwig](https://github.com/Blargian)).
- Возможность настройки обработчиков HTTP-перенаправлений для clickhouse-server. Например, можно настроить перенаправление `/` на интерфейс Play UI. [#60390](https://github.com/ClickHouse/ClickHouse/pull/60390) ([Alexey Milovidov](https://github.com/alexey-milovidov)).


#### Улучшение производительности {#performance-improvement-9}

- Оптимизирована функция `dotProduct` для устранения ненужных и затратных операций копирования памяти. [#60928](https://github.com/ClickHouse/ClickHouse/pull/60928) ([Robert Schulze](https://github.com/rschu1ze)).
- Вывод 256-битных целых чисел ускорен в 30 раз. [#61100](https://github.com/ClickHouse/ClickHouse/pull/61100) ([Raúl Marín](https://github.com/Algunenano)).
- Если первичный ключ таблицы содержит преимущественно малоинформативные столбцы, они не будут храниться в памяти. Это контролируется новой настройкой `primary_key_ratio_of_unique_prefix_values_to_skip_suffix_columns` со значением `0.9` по умолчанию, что означает: для составного первичного ключа, если столбец изменяет своё значение как минимум в 0.9 случаев, следующие за ним столбцы не будут загружаться. [#60255](https://github.com/ClickHouse/ClickHouse/pull/60255) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Улучшена производительность методов сериализованной агрегации при работе с несколькими столбцами типа `Nullable`. [#55809](https://github.com/ClickHouse/ClickHouse/pull/55809) ([Amos Bird](https://github.com/amosbird)).
- Ленивое построение вывода JSON для улучшения производительности ALL JOIN. [#58278](https://github.com/ClickHouse/ClickHouse/pull/58278) ([LiuNeng](https://github.com/liuneng1994)).
- HTTP/HTTPS-соединения с внешними сервисами, такими как AWS S3, теперь переиспользуются во всех случаях, даже когда ответ имеет код 3xx или 4xx. [#58845](https://github.com/ClickHouse/ClickHouse/pull/58845) ([Sema Checherinda](https://github.com/CheSema)).
- Улучшения агрегатных функций `argMin` / `argMax` / `any` / `anyLast` / `anyHeavy`, а также запросов `ORDER BY {u8/u16/u32/u64/i8/i16/u32/i64) LIMIT 1`. [#58640](https://github.com/ClickHouse/ClickHouse/pull/58640) ([Raúl Marín](https://github.com/Algunenano)).
- Простая оптимизация фильтра столбцов. Пиковое потребление памяти может быть снижено до 44% от исходного в некоторых случаях. [#59698](https://github.com/ClickHouse/ClickHouse/pull/59698) ([李扬](https://github.com/taiyang-li)).
- Выполнение функции `multiIf` в колоночном режиме, когда базовый тип результата является числом. [#60384](https://github.com/ClickHouse/ClickHouse/pull/60384) ([李扬](https://github.com/taiyang-li)).
- Более быстрые (почти в 2 раза) мьютексы. [#60823](https://github.com/ClickHouse/ClickHouse/pull/60823) ([Azat Khuzhin](https://github.com/azat)).
- Параллельное завершение нескольких соединений при окончании распределённого запроса. [#60845](https://github.com/ClickHouse/ClickHouse/pull/60845) ([lizhuoyu5](https://github.com/lzydmxy)).
- Оптимизировано перемещение данных между столбцами типа Nullable number или Nullable string, что улучшает некоторые микробенчмарки. [#60846](https://github.com/ClickHouse/ClickHouse/pull/60846) ([李扬](https://github.com/taiyang-li)).
- Операции с кешем файловой системы будут меньше страдать от конкуренции за блокировки. [#61066](https://github.com/ClickHouse/ClickHouse/pull/61066) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Оптимизированы array join и другие JOIN путём предотвращения неправильной оптимизации компилятора. Закрывает [#61074](https://github.com/ClickHouse/ClickHouse/issues/61074). [#61075](https://github.com/ClickHouse/ClickHouse/pull/61075) ([李扬](https://github.com/taiyang-li)).
- Если запрос с синтаксической ошибкой содержал сопоставитель `COLUMNS` с регулярным выражением, регулярное выражение компилировалось каждый раз во время отката парсера, вместо однократной компиляции. Это была фундаментальная ошибка. Скомпилированное регулярное выражение помещалось в AST. Но буква A в AST означает «абстрактное», что означает, что оно не должно содержать тяжеловесные объекты. Части AST могут создаваться и отбрасываться во время парсинга, включая большое количество откатов. Это приводит к замедлению на стороне парсинга и, следовательно, позволяет DoS-атаку пользователем с правами только на чтение. Но основная проблема в том, что это препятствует прогрессу в фаззерах. [#61543](https://github.com/ClickHouse/ClickHouse/pull/61543) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлен новый проход анализатора для оптимизации оператора IN для одного значения. [#61564](https://github.com/ClickHouse/ClickHouse/pull/61564) ([LiuNeng](https://github.com/liuneng1994)).
- DNSResolver перемешивает набор разрешённых IP-адресов, что необходимо для равномерного использования нескольких конечных точек AWS S3. [#60965](https://github.com/ClickHouse/ClickHouse/pull/60965) ([Sema Checherinda](https://github.com/CheSema)).

#### Экспериментальная функциональность {#experimental-feature-7}

- Поддержка параллельного чтения для Azure Blob Storage. Это повышает производительность экспериментального объектного хранилища Azure. [#61503](https://github.com/ClickHouse/ClickHouse/pull/61503) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Добавлен асинхронный WriteBuffer для Azure Blob Storage, аналогичный S3. Это повышает производительность экспериментального объектного хранилища Azure. [#59929](https://github.com/ClickHouse/ClickHouse/pull/59929) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Использование управляемого удостоверения для операций ввода-вывода резервных копий при работе с Azure Blob Storage. Добавлена настройка, предотвращающая попытки ClickHouse создать несуществующий контейнер, что требует разрешений на уровне учетной записи хранилища. [#61785](https://github.com/ClickHouse/ClickHouse/pull/61785) ([Daniel Pozo Escalona](https://github.com/danipozo)).
- Добавлена настройка `parallel_replicas_allow_in_with_subquery = 1`, которая позволяет использовать подзапросы для IN при работе с параллельными репликами. [#60950](https://github.com/ClickHouse/ClickHouse/pull/60950) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Изменение для репликации «zero-copy»: все блокировки zero-copy, связанные с таблицей, должны быть удалены при удалении таблицы. Директория, содержащая эти блокировки, также должна быть удалена. [#57575](https://github.com/ClickHouse/ClickHouse/pull/57575) ([Sema Checherinda](https://github.com/CheSema)).


#### Улучшение {#improvement-9}

- Use `MergeTree` as a default table engine. [#60524](https://github.com/ClickHouse/ClickHouse/pull/60524) ([Alexey Milovidov](https://github.com/alexey-milovidov))
- Enable `output_format_pretty_row_numbers` by default. It is better for usability. [#61791](https://github.com/ClickHouse/ClickHouse/pull/61791) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- In the previous version, some numbers in Pretty formats were not pretty enough. [#61794](https://github.com/ClickHouse/ClickHouse/pull/61794) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- A long value in Pretty formats won't be cut if it is the single value in the resultset, such as in the result of the `SHOW CREATE TABLE` query. [#61795](https://github.com/ClickHouse/ClickHouse/pull/61795) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Similarly to `clickhouse-local`, `clickhouse-client` will accept the `--output-format` option as a synonym to the `--format` option. This closes [#59848](https://github.com/ClickHouse/ClickHouse/issues/59848). [#61797](https://github.com/ClickHouse/ClickHouse/pull/61797) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- If stdout is a terminal and the output format is not specified, `clickhouse-client` and similar tools will use `PrettyCompact` by default, similarly to the interactive mode. `clickhouse-client` and `clickhouse-local` will handle command line arguments for input and output formats in a unified fashion. This closes [#61272](https://github.com/ClickHouse/ClickHouse/issues/61272). [#61800](https://github.com/ClickHouse/ClickHouse/pull/61800) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Underscore digit groups in Pretty formats for better readability. This is controlled by a new setting, `output_format_pretty_highlight_digit_groups`. [#61802](https://github.com/ClickHouse/ClickHouse/pull/61802) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add ability to override initial INSERT settings via `SYSTEM FLUSH DISTRIBUTED`. [#61832](https://github.com/ClickHouse/ClickHouse/pull/61832) ([Azat Khuzhin](https://github.com/azat)).
- Enable processors profiling (time spent/in and out bytes for sorting, aggregation, ...) by default. [#61096](https://github.com/ClickHouse/ClickHouse/pull/61096) ([Azat Khuzhin](https://github.com/azat)).
- Support files without format extension in Filesystem database. [#60795](https://github.com/ClickHouse/ClickHouse/pull/60795) ([Kruglov Pavel](https://github.com/Avogar)).
- Make all format names case insensitive, like Tsv, or TSV, or tsv, or even rowbinary. [#60420](https://github.com/ClickHouse/ClickHouse/pull/60420) ([豪肥肥](https://github.com/HowePa)). I appreciate if you will continue to write it correctly, e.g., `JSON` 😇, not `Json` 🤮, but we don't mind if you spell it as you prefer.
- Added `none_only_active` mode for `distributed_ddl_output_mode` setting. [#60340](https://github.com/ClickHouse/ClickHouse/pull/60340) ([Alexander Tokmakov](https://github.com/tavplubix)).
- The advanced dashboard has slightly better colors for multi-line graphs. [#60391](https://github.com/ClickHouse/ClickHouse/pull/60391) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- The Advanced dashboard now has controls always visible on scrolling. This allows you to add a new chart without scrolling up. [#60692](https://github.com/ClickHouse/ClickHouse/pull/60692) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- While running the `MODIFY COLUMN` query for materialized views, check the inner table's structure to ensure every column exists. [#47427](https://github.com/ClickHouse/ClickHouse/pull/47427) ([sunny](https://github.com/sunny19930321)).
- String types and Enums can be used in the same context, such as: arrays, UNION queries, conditional expressions. This closes [#60726](https://github.com/ClickHouse/ClickHouse/issues/60726). [#60727](https://github.com/ClickHouse/ClickHouse/pull/60727) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Allow declaring Enums in the structure of external data for query processing (this is an immediate temporary table that you can provide for your query). [#57857](https://github.com/ClickHouse/ClickHouse/pull/57857) ([Duc Canh Le](https://github.com/canhld94)).
- Consider lightweight deleted rows when selecting parts to merge, so the disk size of the resulting part will be estimated better. [#58223](https://github.com/ClickHouse/ClickHouse/pull/58223) ([Zhuo Qiu](https://github.com/jewelzqiu)).
- Added comments for columns for more system tables. Continuation of https://github.com/ClickHouse/ClickHouse/pull/58356. [#59016](https://github.com/ClickHouse/ClickHouse/pull/59016) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Now we can use virtual columns in PREWHERE. It's worthwhile for non-const virtual columns like `_part_offset`. [#59033](https://github.com/ClickHouse/ClickHouse/pull/59033) ([Amos Bird](https://github.com/amosbird)). Improved overall usability of virtual columns. Now it is allowed to use virtual columns in `PREWHERE` (it's worthwhile for non-const virtual columns like `_part_offset`). Now a builtin documentation is available for virtual columns as a comment of column in `DESCRIBE` query with enabled setting `describe_include_virtual_columns`. [#60205](https://github.com/ClickHouse/ClickHouse/pull/60205) ([Anton Popov](https://github.com/CurtizJ)).
- Instead of using a constant key, now object storage generates key for determining remove objects capability. [#59495](https://github.com/ClickHouse/ClickHouse/pull/59495) ([Sema Checherinda](https://github.com/CheSema)).
- Allow "local" as object storage type instead of "local_blob_storage". [#60165](https://github.com/ClickHouse/ClickHouse/pull/60165) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Parallel flush of pending INSERT blocks of Distributed engine on `DETACH`/server shutdown and `SYSTEM FLUSH DISTRIBUTED` (Parallelism will work only if you have multi-disk policy for a table (like everything in the Distributed engine right now)). [#60225](https://github.com/ClickHouse/ClickHouse/pull/60225) ([Azat Khuzhin](https://github.com/azat)).
- Add a setting to force read-through cache for merges. [#60308](https://github.com/ClickHouse/ClickHouse/pull/60308) ([Kseniia Sumarokova](https://github.com/kssenii)).
- An improvement for the MySQL compatibility protocol. The issue [#57598](https://github.com/ClickHouse/ClickHouse/issues/57598) mentions a variant behaviour regarding transaction handling. An issued COMMIT/ROLLBACK when no transaction is active is reported as an error contrary to MySQL behaviour. [#60338](https://github.com/ClickHouse/ClickHouse/pull/60338) ([PapaToemmsn](https://github.com/PapaToemmsn)).
- Function `substring` now has a new alias `byteSlice`. [#60494](https://github.com/ClickHouse/ClickHouse/pull/60494) ([Robert Schulze](https://github.com/rschu1ze)).
- Renamed server setting `dns_cache_max_size` to `dns_cache_max_entries` to reduce ambiguity. [#60500](https://github.com/ClickHouse/ClickHouse/pull/60500) ([Kirill Nikiforov](https://github.com/allmazz)).
- `SHOW INDEX | INDEXES | INDICES | KEYS` no longer sorts by the primary key columns (which was unintuitive). [#60514](https://github.com/ClickHouse/ClickHouse/pull/60514) ([Robert Schulze](https://github.com/rschu1ze)).
- Keeper improvement: abort during startup if an invalid snapshot is detected to avoid data loss. [#60537](https://github.com/ClickHouse/ClickHouse/pull/60537) ([Antonio Andelic](https://github.com/antonio2368)).
- Update tzdata to 2024a. [#60768](https://github.com/ClickHouse/ClickHouse/pull/60768) ([Raúl Marín](https://github.com/Algunenano)).
- Keeper improvement: support `leadership_expiry_ms` in Keeper's settings. [#60806](https://github.com/ClickHouse/ClickHouse/pull/60806) ([Brokenice0415](https://github.com/Brokenice0415)).
- Always infer exponential numbers in JSON formats regardless of the setting `input_format_try_infer_exponent_floats`. Add setting `input_format_json_use_string_type_for_ambiguous_paths_in_named_tuples_inference_from_objects` that allows to use String type for ambiguous paths instead of an exception during named Tuples inference from JSON objects. [#60808](https://github.com/ClickHouse/ClickHouse/pull/60808) ([Kruglov Pavel](https://github.com/Avogar)).
- Add support for `START TRANSACTION` syntax typically used in MySQL syntax, resolving https://github.com/ClickHouse/ClickHouse/discussions/60865. [#60886](https://github.com/ClickHouse/ClickHouse/pull/60886) ([Zach Naimon](https://github.com/ArctypeZach)).
- Add a flag for the full-sorting merge join algorithm to treat null as biggest/smallest. So the behavior can be compitable with other SQL systems, like Apache Spark. [#60896](https://github.com/ClickHouse/ClickHouse/pull/60896) ([loudongfeng](https://github.com/loudongfeng)).
- Support detect output format by file exctension in `clickhouse-client` and `clickhouse-local`. [#61036](https://github.com/ClickHouse/ClickHouse/pull/61036) ([豪肥肥](https://github.com/HowePa)).
- Update memory limit in runtime when Linux's CGroups value changed. [#61049](https://github.com/ClickHouse/ClickHouse/pull/61049) ([Han Fei](https://github.com/hanfei1991)).
- Add the function `toUInt128OrZero`, which was missed by mistake (the mistake is related to https://github.com/ClickHouse/ClickHouse/pull/945). The compatibility aliases `FROM_UNIXTIME` and `DATE_FORMAT` (they are not ClickHouse-native and only exist for MySQL compatibility) have been made case insensitive, as expected for SQL-compatibility aliases. [#61114](https://github.com/ClickHouse/ClickHouse/pull/61114) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Improvements for the access checks, allowing to revoke of unpossessed rights in case the target user doesn't have the revoking grants either. Example: `GRANT SELECT ON *.* TO user1; REVOKE SELECT ON system.* FROM user1;`. [#61115](https://github.com/ClickHouse/ClickHouse/pull/61115) ([pufit](https://github.com/pufit)).
- Fix `has()` function with `Nullable` column (fixes [#60214](https://github.com/ClickHouse/ClickHouse/issues/60214)). [#61249](https://github.com/ClickHouse/ClickHouse/pull/61249) ([Mikhail Koviazin](https://github.com/mkmkme)).
- Now it's possible to specify the attribute `merge="true"` in config substitutions for subtrees `<include from_zk="/path" merge="true">`. In case this attribute specified, clickhouse will merge subtree with existing configuration, otherwise default behavior is append new content to configuration. [#61299](https://github.com/ClickHouse/ClickHouse/pull/61299) ([alesapin](https://github.com/alesapin)).
- Add async metrics for virtual memory mappings: `VMMaxMapCount` & `VMNumMaps`. Closes [#60662](https://github.com/ClickHouse/ClickHouse/issues/60662). [#61354](https://github.com/ClickHouse/ClickHouse/pull/61354) ([Tuan Pham Anh](https://github.com/tuanpavn)).
- Use `temporary_files_codec` setting in all places where we create temporary data, for example external memory sorting and external memory GROUP BY. Before it worked only in `partial_merge` JOIN algorithm. [#61456](https://github.com/ClickHouse/ClickHouse/pull/61456) ([Maksim Kita](https://github.com/kitaisreal)).
- Add a new setting `max_parser_backtracks` which allows to limit the complexity of query parsing. [#61502](https://github.com/ClickHouse/ClickHouse/pull/61502) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Less contention during dynamic resize of the filesystem cache. [#61524](https://github.com/ClickHouse/ClickHouse/pull/61524) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Disallow sharded mode of StorageS3 queue, because it will be rewritten. [#61537](https://github.com/ClickHouse/ClickHouse/pull/61537) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fixed typo: from `use_leagcy_max_level` to `use_legacy_max_level`. [#61545](https://github.com/ClickHouse/ClickHouse/pull/61545) ([William Schoeffel](https://github.com/wiledusc)).
- Remove some duplicate entries in `system.blob_storage_log`. [#61622](https://github.com/ClickHouse/ClickHouse/pull/61622) ([YenchangChan](https://github.com/YenchangChan)).
- Added `current_user` function as a compatibility alias for MySQL. [#61770](https://github.com/ClickHouse/ClickHouse/pull/61770) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix inconsistent floating point aggregate function states in mixed x86-64 / ARM clusters [#60610](https://github.com/ClickHouse/ClickHouse/pull/60610) ([Harry Lee](https://github.com/HarryLeeIBM)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-5}

- Профилировщик запросов в реальном времени теперь работает на AArch64. В предыдущих версиях он работал только в том случае, если программа не находилась внутри системного вызова. [#60807](https://github.com/ClickHouse/ClickHouse/pull/60807) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Версия ClickHouse добавлена в метки docker. Закрывает [#54224](https://github.com/ClickHouse/ClickHouse/issues/54224). [#60949](https://github.com/ClickHouse/ClickHouse/pull/60949) ([Nikolay Monkov](https://github.com/nikmonkov)).
- Обновлён `prqlc` до версии 0.11.3. [#60616](https://github.com/ClickHouse/ClickHouse/pull/60616) ([Maximilian Roos](https://github.com/max-sixty)).
- Добавлен универсальный фаззер текста запросов в `clickhouse-local`. [#61508](https://github.com/ClickHouse/ClickHouse/pull/61508) ([Alexey Milovidov](https://github.com/alexey-milovidov)).


#### Исправление ошибок (видимые пользователю проблемы в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-7}

- Fix finished_mutations_to_keep=0 for MergeTree (as docs says 0 is to keep everything) [#60031](https://github.com/ClickHouse/ClickHouse/pull/60031) ([Azat Khuzhin](https://github.com/azat)).
- Something was wrong with the FINAL optimization, here is how the author describes it: "PartsSplitter invalid ranges for the same part". [#60041](https://github.com/ClickHouse/ClickHouse/pull/60041) ([Maksim Kita](https://github.com/kitaisreal)).
- Something was wrong with Apache Hive, which is experimental and not supported. [#60262](https://github.com/ClickHouse/ClickHouse/pull/60262) ([shanfengp](https://github.com/Aed-p)).
- An improvement for experimental parallel replicas: force reanalysis if parallel replicas changed [#60362](https://github.com/ClickHouse/ClickHouse/pull/60362) ([Raúl Marín](https://github.com/Algunenano)).
- Fix usage of plain metadata type with new disks configuration option [#60396](https://github.com/ClickHouse/ClickHouse/pull/60396) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Try to fix logical error 'Cannot capture column because it has incompatible type' in mapContainsKeyLike [#60451](https://github.com/ClickHouse/ClickHouse/pull/60451) ([Kruglov Pavel](https://github.com/Avogar)).
- Avoid calculation of scalar subqueries for CREATE TABLE. [#60464](https://github.com/ClickHouse/ClickHouse/pull/60464) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix deadlock in parallel parsing when lots of rows are skipped due to errors [#60516](https://github.com/ClickHouse/ClickHouse/pull/60516) ([Kruglov Pavel](https://github.com/Avogar)).
- Something was wrong with experimental KQL (Kusto) support: fix `max_query_size_for_kql_compound_operator`: [#60534](https://github.com/ClickHouse/ClickHouse/pull/60534) ([Yong Wang](https://github.com/kashwy)).
- Keeper fix: add timeouts when waiting for commit logs [#60544](https://github.com/ClickHouse/ClickHouse/pull/60544) ([Antonio Andelic](https://github.com/antonio2368)).
- Don't output number tips for date types [#60577](https://github.com/ClickHouse/ClickHouse/pull/60577) ([Raúl Marín](https://github.com/Algunenano)).
- Fix reading from MergeTree with non-deterministic functions in filter [#60586](https://github.com/ClickHouse/ClickHouse/pull/60586) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix logical error on bad compatibility setting value type [#60596](https://github.com/ClickHouse/ClickHouse/pull/60596) ([Kruglov Pavel](https://github.com/Avogar)).
- fix(prql): Robust panic handler [#60615](https://github.com/ClickHouse/ClickHouse/pull/60615) ([Maximilian Roos](https://github.com/max-sixty)).
- Fix `intDiv` for decimal and date arguments [#60672](https://github.com/ClickHouse/ClickHouse/pull/60672) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix: expand CTE in alter modify query [#60682](https://github.com/ClickHouse/ClickHouse/pull/60682) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix system.parts for non-Atomic/Ordinary database engine (i.e. Memory) [#60689](https://github.com/ClickHouse/ClickHouse/pull/60689) ([Azat Khuzhin](https://github.com/azat)).
- Fix "Invalid storage definition in metadata file" for parameterized views [#60708](https://github.com/ClickHouse/ClickHouse/pull/60708) ([Azat Khuzhin](https://github.com/azat)).
- Fix buffer overflow in CompressionCodecMultiple [#60731](https://github.com/ClickHouse/ClickHouse/pull/60731) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Remove nonsense from SQL/JSON [#60738](https://github.com/ClickHouse/ClickHouse/pull/60738) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Remove wrong assertion in aggregate function quantileGK [#60740](https://github.com/ClickHouse/ClickHouse/pull/60740) ([李扬](https://github.com/taiyang-li)).
- Fix insert-select + insert_deduplication_token bug by setting streams to 1 [#60745](https://github.com/ClickHouse/ClickHouse/pull/60745) ([Jordi Villar](https://github.com/jrdi)).
- Prevent setting custom metadata headers on unsupported multipart upload operations [#60748](https://github.com/ClickHouse/ClickHouse/pull/60748) ([Francisco J. Jurado Moreno](https://github.com/Beetelbrox)).
- Fix toStartOfInterval [#60763](https://github.com/ClickHouse/ClickHouse/pull/60763) ([Andrey Zvonov](https://github.com/zvonand)).
- Fix crash in arrayEnumerateRanked [#60764](https://github.com/ClickHouse/ClickHouse/pull/60764) ([Raúl Marín](https://github.com/Algunenano)).
- Fix crash when using input() in INSERT SELECT JOIN [#60765](https://github.com/ClickHouse/ClickHouse/pull/60765) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix crash with different allow_experimental_analyzer value in subqueries [#60770](https://github.com/ClickHouse/ClickHouse/pull/60770) ([Dmitry Novik](https://github.com/novikd)).
- Remove recursion when reading from S3 [#60849](https://github.com/ClickHouse/ClickHouse/pull/60849) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix possible stuck on error in HashedDictionaryParallelLoader [#60926](https://github.com/ClickHouse/ClickHouse/pull/60926) ([vdimir](https://github.com/vdimir)).
- Fix async RESTORE with Replicated database (experimental feature) [#60934](https://github.com/ClickHouse/ClickHouse/pull/60934) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix deadlock in async inserts to `Log` tables via native protocol [#61055](https://github.com/ClickHouse/ClickHouse/pull/61055) ([Anton Popov](https://github.com/CurtizJ)).
- Fix lazy execution of default argument in dictGetOrDefault for RangeHashedDictionary [#61196](https://github.com/ClickHouse/ClickHouse/pull/61196) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix multiple bugs in groupArraySorted [#61203](https://github.com/ClickHouse/ClickHouse/pull/61203) ([Raúl Marín](https://github.com/Algunenano)).
- Fix Keeper reconfig for standalone binary [#61233](https://github.com/ClickHouse/ClickHouse/pull/61233) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix usage of session_token in S3 engine [#61234](https://github.com/ClickHouse/ClickHouse/pull/61234) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix possible incorrect result of aggregate function `uniqExact` [#61257](https://github.com/ClickHouse/ClickHouse/pull/61257) ([Anton Popov](https://github.com/CurtizJ)).
- Fix bugs in show database [#61269](https://github.com/ClickHouse/ClickHouse/pull/61269) ([Raúl Marín](https://github.com/Algunenano)).
- Fix logical error in RabbitMQ storage with MATERIALIZED columns [#61320](https://github.com/ClickHouse/ClickHouse/pull/61320) ([vdimir](https://github.com/vdimir)).
- Fix CREATE OR REPLACE DICTIONARY [#61356](https://github.com/ClickHouse/ClickHouse/pull/61356) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix ATTACH query with external ON CLUSTER [#61365](https://github.com/ClickHouse/ClickHouse/pull/61365) ([Nikolay Degterinsky](https://github.com/evillique)).
- Fix consecutive keys optimization for nullable keys [#61393](https://github.com/ClickHouse/ClickHouse/pull/61393) ([Anton Popov](https://github.com/CurtizJ)).
- fix issue of actions dag split [#61458](https://github.com/ClickHouse/ClickHouse/pull/61458) ([Raúl Marín](https://github.com/Algunenano)).
- Fix finishing a failed RESTORE [#61466](https://github.com/ClickHouse/ClickHouse/pull/61466) ([Vitaly Baranov](https://github.com/vitlibar)).
- Disable async_insert_use_adaptive_busy_timeout correctly with compatibility settings [#61468](https://github.com/ClickHouse/ClickHouse/pull/61468) ([Raúl Marín](https://github.com/Algunenano)).
- Allow queuing in restore pool [#61475](https://github.com/ClickHouse/ClickHouse/pull/61475) ([Nikita Taranov](https://github.com/nickitat)).
- Fix an inconsistency when reading system.parts using UUID. [#61479](https://github.com/ClickHouse/ClickHouse/pull/61479) ([Dan Wu](https://github.com/wudanzy)).
- Fix ALTER QUERY MODIFY SQL SECURITY [#61480](https://github.com/ClickHouse/ClickHouse/pull/61480) ([pufit](https://github.com/pufit)).
- Fix a crash in window view (experimental feature) [#61526](https://github.com/ClickHouse/ClickHouse/pull/61526) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix `repeat` with non-native integers [#61527](https://github.com/ClickHouse/ClickHouse/pull/61527) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix client's `-s` argument [#61530](https://github.com/ClickHouse/ClickHouse/pull/61530) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Fix crash in arrayPartialReverseSort [#61539](https://github.com/ClickHouse/ClickHouse/pull/61539) ([Raúl Marín](https://github.com/Algunenano)).
- Fix string search with const position [#61547](https://github.com/ClickHouse/ClickHouse/pull/61547) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix addDays cause an error when used DateTime64 [#61561](https://github.com/ClickHouse/ClickHouse/pull/61561) ([Shuai li](https://github.com/loneylee)).
- Disallow LowCardinality input type for JSONExtract [#61617](https://github.com/ClickHouse/ClickHouse/pull/61617) ([Julia Kartseva](https://github.com/jkartseva)).
- Fix `system.part_log` for async insert with deduplication [#61620](https://github.com/ClickHouse/ClickHouse/pull/61620) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix a `Non-ready set` exception for system.parts. [#61666](https://github.com/ClickHouse/ClickHouse/pull/61666) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix actual_part_name for REPLACE_RANGE (`Entry actual part isn't empty yet`) [#61675](https://github.com/ClickHouse/ClickHouse/pull/61675) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix a sanitizer report in `multiSearchAllPositionsCaseInsensitiveUTF8` for incorrect UTF-8 [#61749](https://github.com/ClickHouse/ClickHouse/pull/61749) ([pufit](https://github.com/pufit)).
- Fix an observation that the RANGE frame is not supported for Nullable columns. [#61766](https://github.com/ClickHouse/ClickHouse/pull/61766) ([YuanLiu](https://github.com/ditgittube)).

### <a id="242"></a> Релиз ClickHouse 24.2, 2024-02-29 {#a-id242a-clickhouse-release-242-2024-02-29}

#### Обратно несовместимые изменения {#backward-incompatible-change-8}

- Добавлена валидация подозрительных/экспериментальных типов во вложенных типах. Ранее такие типы (за исключением JSON) не валидировались во вложенных типах, таких как Array/Tuple/Map. [#59385](https://github.com/ClickHouse/ClickHouse/pull/59385) ([Kruglov Pavel](https://github.com/Avogar)).
- Добавлена проверка корректности количества потоков и размеров блоков. [#60138](https://github.com/ClickHouse/ClickHouse/pull/60138) ([Raúl Marín](https://github.com/Algunenano)).
- По умолчанию отключен автоматический вывод типов для чисел с плавающей точкой в экспоненциальной нотации. Добавлена настройка `input_format_try_infer_exponent_floats`, которая восстанавливает прежнее поведение (по умолчанию отключена). Закрывает [#59476](https://github.com/ClickHouse/ClickHouse/issues/59476). [#59500](https://github.com/ClickHouse/ClickHouse/pull/59500) ([Kruglov Pavel](https://github.com/Avogar)).
- Разрешено заключать операции ALTER в скобки. Вывод скобок можно контролировать с помощью параметра конфигурации `format_alter_operations_with_parentheses`. По умолчанию в форматированных запросах скобки выводятся, поскольку форматированные операции ALTER сохраняются в некоторых местах как метаданные (например, мутации). Новый синтаксис устраняет неоднозначность в некоторых запросах, где операции ALTER заканчиваются списком. Например, запрос `ALTER TABLE x MODIFY TTL date GROUP BY a, b, DROP COLUMN c` не может быть корректно разобран со старым синтаксисом. В новом синтаксисе запрос `ALTER TABLE x (MODIFY TTL date GROUP BY a, b), (DROP COLUMN c)` однозначен. Старые версии не могут читать новый синтаксис, поэтому использование нового синтаксиса может вызвать проблемы, если в одном кластере смешаны новые и старые версии ClickHouse. [#59532](https://github.com/ClickHouse/ClickHouse/pull/59532) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Исправлена проблема безопасности материализованных представлений, которая позволяла пользователю вставлять данные в таблицу без необходимых прав. Исправление проверяет, что у пользователя есть разрешение на вставку не только в материализованное представление, но и во все базовые таблицы. Это означает, что некоторые запросы, которые работали ранее, теперь могут завершаться с ошибкой `Not enough privileges`. Для решения этой проблемы в релизе представлена новая функция SQL security для представлений https://clickhouse.com/docs/sql-reference/statements/create/view#sql_security. [#54901](https://github.com/ClickHouse/ClickHouse/pull/54901) [#60439](https://github.com/ClickHouse/ClickHouse/pull/60439) ([pufit](https://github.com/pufit)).


#### Новая функциональность {#new-feature-10}

- Добавлен новый синтаксис, позволяющий указывать пользователя-определителя в представлении/материализованном представлении. Это позволяет выполнять операции SELECT/INSERT из представлений без явного предоставления прав доступа к базовым таблицам. Таким образом, представление инкапсулирует права доступа. [#54901](https://github.com/ClickHouse/ClickHouse/pull/54901) [#60439](https://github.com/ClickHouse/ClickHouse/pull/60439) ([pufit](https://github.com/pufit)).
- Реализовано автоматическое определение формата файла при выводе схемы, если он неизвестен в движках `file/s3/hdfs/url/azureBlobStorage`. Закрывает [#50576](https://github.com/ClickHouse/ClickHouse/issues/50576). [#59092](https://github.com/ClickHouse/ClickHouse/pull/59092) ([Kruglov Pavel](https://github.com/Avogar)).
- Реализована автоматическая настройка таймаутов асинхронных вставок. Введены следующие настройки: async_insert_poll_timeout_ms, async_insert_use_adaptive_busy_timeout, async_insert_busy_timeout_min_ms, async_insert_busy_timeout_max_ms, async_insert_busy_timeout_increase_rate, async_insert_busy_timeout_decrease_rate. [#58486](https://github.com/ClickHouse/ClickHouse/pull/58486) ([Julia Kartseva](https://github.com/jkartseva)).
- Добавлена возможность установки квоты на максимальное количество последовательных неудачных попыток входа. [#54737](https://github.com/ClickHouse/ClickHouse/pull/54737) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
- Новая агрегатная функция `groupArrayIntersect`. Продолжение: [#49862](https://github.com/ClickHouse/ClickHouse/issues/49862). [#59598](https://github.com/ClickHouse/ClickHouse/pull/59598) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Поддержка резервного копирования и восстановления для `AzureBlobStorage`. Решает [#50747](https://github.com/ClickHouse/ClickHouse/issues/50747). [#56988](https://github.com/ClickHouse/ClickHouse/pull/56988) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Пользователь теперь может указать строку шаблона непосредственно в запросе, используя `format_schema_rows_template` в качестве альтернативы `format_template_row`. Закрывает [#31363](https://github.com/ClickHouse/ClickHouse/issues/31363). [#59088](https://github.com/ClickHouse/ClickHouse/pull/59088) ([Shaun Struwig](https://github.com/Blargian)).
- Реализовано автоматическое преобразование таблиц семейства MergeTree различных типов в реплицируемый движок. Создайте пустой файл `convert_to_replicated` в директории данных таблицы (`/clickhouse/store/xxx/xxxyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy/`), и таблица будет автоматически преобразована при следующем запуске сервера. [#57798](https://github.com/ClickHouse/ClickHouse/pull/57798) ([Kirill](https://github.com/kirillgarbar)).
- Добавлен запрос `ALTER TABLE table FORGET PARTITION partition`, который удаляет узлы ZooKeeper, связанные с пустой партицией. [#59507](https://github.com/ClickHouse/ClickHouse/pull/59507) ([Sergei Trifonov](https://github.com/serxa)). Это функция экспертного уровня.
- Поддержка файла учетных данных JWT для движка таблиц NATS. [#59543](https://github.com/ClickHouse/ClickHouse/pull/59543) ([Nickolaj Jepsen](https://github.com/nickolaj-jepsen)).
- Реализована таблица `system.dns_cache`, которая может быть полезна для отладки проблем с DNS. [#59856](https://github.com/ClickHouse/ClickHouse/pull/59856) ([Kirill Nikiforov](https://github.com/allmazz)).
- Кодек `LZ4HC` теперь принимает новый уровень 2, который быстрее предыдущего минимального уровня 3 за счет меньшей степени сжатия. В предыдущих версиях `LZ4HC(2)` и ниже были эквивалентны `LZ4HC(3)`. Автор: [Cyan4973](https://github.com/Cyan4973). [#60090](https://github.com/ClickHouse/ClickHouse/pull/60090) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Реализована таблица `system.dns_cache`, которая может быть полезна для отладки проблем с DNS. Новая серверная настройка dns_cache_max_size. [#60257](https://github.com/ClickHouse/ClickHouse/pull/60257) ([Kirill Nikiforov](https://github.com/allmazz)).
- Поддержка версии с одним аргументом для табличной функции `merge` в виде `merge(['db_name', ] 'tables_regexp')`. [#60372](https://github.com/ClickHouse/ClickHouse/pull/60372) ([豪肥肥](https://github.com/HowePa)).
- Поддержка отрицательных позиционных аргументов. Закрывает [#57736](https://github.com/ClickHouse/ClickHouse/issues/57736). [#58292](https://github.com/ClickHouse/ClickHouse/pull/58292) ([flynn](https://github.com/ucasfl)).
- Поддержка указания набора разрешенных пользователей для конкретных настроек S3 в конфигурации с использованием ключа `user`. [#60144](https://github.com/ClickHouse/ClickHouse/pull/60144) ([Antonio Andelic](https://github.com/antonio2368)).
- Добавлена табличная функция `mergeTreeIndex`. Она представляет содержимое индексных файлов и файлов меток таблиц `MergeTree`. Может использоваться для интроспекции. Синтаксис: `mergeTreeIndex(database, table, [with_marks = true])`, где `database.table` — существующая таблица с движком `MergeTree`. [#58140](https://github.com/ClickHouse/ClickHouse/pull/58140) ([Anton Popov](https://github.com/CurtizJ)).

#### Экспериментальная функциональность {#experimental-feature-8}

- Добавлена функция `seriesOutliersDetectTukey` для обнаружения выбросов в данных временных рядов с использованием алгоритма границ Тьюки. [#58632](https://github.com/ClickHouse/ClickHouse/pull/58632) ([Bhavna Jindal](https://github.com/bhavnajindal)). Обратите внимание, что поведение будет изменено в следующем патч-релизе.
- Добавлена функция `variantType`, которая возвращает Enum с именем типа варианта для каждой строки. [#59398](https://github.com/ClickHouse/ClickHouse/pull/59398) ([Kruglov Pavel](https://github.com/Avogar)).
- Добавлена поддержка `LEFT JOIN`, `ALL INNER JOIN` и простых подзапросов для параллельных реплик (только с анализатором). Новая настройка `parallel_replicas_prefer_local_join` выбирает локальное выполнение `JOIN` (по умолчанию) вместо `GLOBAL JOIN`. Все таблицы должны существовать на каждой реплике из `cluster_for_parallel_replicas`. Новые настройки `min_external_table_block_size_rows` и `min_external_table_block_size_bytes` используются для объединения небольших блоков, отправляемых во временные таблицы (только с анализатором). [#58916](https://github.com/ClickHouse/ClickHouse/pull/58916) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Разрешено одновременное создание таблиц в базе данных `Replicated` при добавлении или восстановлении новой реплики. [#59277](https://github.com/ClickHouse/ClickHouse/pull/59277) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Реализован оператор сравнения для значений `Variant` и корректная вставка Field в столбец `Variant`. По умолчанию запрещено создание типа `Variant` с похожими типами вариантов (разрешается с помощью настройки `allow_suspicious_variant_types`). Закрывает [#59996](https://github.com/ClickHouse/ClickHouse/issues/59996). Закрывает [#59850](https://github.com/ClickHouse/ClickHouse/issues/59850). [#60198](https://github.com/ClickHouse/ClickHouse/pull/60198) ([Kruglov Pavel](https://github.com/Avogar)).
- Отключен JOIN параллельных реплик с CTE (без анализатора) [#59239](https://github.com/ClickHouse/ClickHouse/pull/59239) ([Raúl Marín](https://github.com/Algunenano)).


#### Улучшение производительности {#performance-improvement-10}

- Первичный ключ будет использовать меньше памяти. [#60049](https://github.com/ClickHouse/ClickHouse/pull/60049) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Улучшено использование памяти для первичного ключа и некоторых других операций. [#60050](https://github.com/ClickHouse/ClickHouse/pull/60050) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Первичные ключи таблиц будут загружаться в память лениво при первом обращении. Это контролируется новой настройкой MergeTree `primary_key_lazy_load`, которая включена по умолчанию. Это дает несколько преимуществ: - ключ не будет загружен для неиспользуемых таблиц; - если недостаточно памяти, исключение будет выброшено при первом использовании, а не при запуске сервера. Это также имеет несколько недостатков: - задержка загрузки первичного ключа будет происходить при первом запросе, а не до принятия соединений; теоретически это может привести к проблеме thundering-herd. Закрывает [#11188](https://github.com/ClickHouse/ClickHouse/issues/11188). [#60093](https://github.com/ClickHouse/ClickHouse/pull/60093) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Векторизованные функции расстояния, используемые в векторном поиске. [#58866](https://github.com/ClickHouse/ClickHouse/pull/58866) ([Robert Schulze](https://github.com/rschu1ze)).
- Векторизованная функция `dotProduct`, которая полезна для векторного поиска. [#60202](https://github.com/ClickHouse/ClickHouse/pull/60202) ([Robert Schulze](https://github.com/rschu1ze)).
- Добавлена возможность короткого замыкания для функции `dictGetOrDefault`. Закрывает [#52098](https://github.com/ClickHouse/ClickHouse/issues/52098). [#57767](https://github.com/ClickHouse/ClickHouse/pull/57767) ([jsc0218](https://github.com/jsc0218)).
- Улучшение Keeper: кэширование только определенного количества логов в памяти, контролируемое параметрами `latest_logs_cache_size_threshold` и `commit_logs_cache_size_threshold`. [#59460](https://github.com/ClickHouse/ClickHouse/pull/59460) ([Antonio Andelic](https://github.com/antonio2368)).
- Улучшение Keeper: еще большее уменьшение размера узла данных. [#59592](https://github.com/ClickHouse/ClickHouse/pull/59592) ([Antonio Andelic](https://github.com/antonio2368)).
- Продолжение оптимизации промахов ветвления функции `if`, когда тип результата `Float*/Decimal*/*Int*`, продолжение https://github.com/ClickHouse/ClickHouse/pull/57885. [#59148](https://github.com/ClickHouse/ClickHouse/pull/59148) ([李扬](https://github.com/taiyang-li)).
- Оптимизация функции `if`, когда входной тип `Map`, ускорение до ~10x. [#59413](https://github.com/ClickHouse/ClickHouse/pull/59413) ([李扬](https://github.com/taiyang-li)).
- Улучшена производительность типа `Int8` путем реализации строгого алиасинга (он уже реализован для `UInt8` и всех других целочисленных типов). [#59485](https://github.com/ClickHouse/ClickHouse/pull/59485) ([Raúl Marín](https://github.com/Algunenano)).
- Оптимизирована производительность условных sum/avg для типов bigint и big decimal путем уменьшения промахов ветвления. [#59504](https://github.com/ClickHouse/ClickHouse/pull/59504) ([李扬](https://github.com/taiyang-li)).
- Улучшена производительность SELECT с активными мутациями. [#59531](https://github.com/ClickHouse/ClickHouse/pull/59531) ([Azat Khuzhin](https://github.com/azat)).
- Оптимизирована функция `isNotNull` с использованием AVX2. [#59621](https://github.com/ClickHouse/ClickHouse/pull/59621) ([李扬](https://github.com/taiyang-li)).
- Улучшена производительность ASOF JOIN для отсортированных или почти отсортированных данных. [#59731](https://github.com/ClickHouse/ClickHouse/pull/59731) ([Maksim Kita](https://github.com/kitaisreal)).
- Предыдущее значение по умолчанию, равное 1 МБ для `async_insert_max_data_size`, оказалось слишком маленьким. Новое значение составляет 10 МиБ. [#59536](https://github.com/ClickHouse/ClickHouse/pull/59536) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Использование нескольких потоков при чтении метаданных таблиц из резервной копии во время выполнения команды RESTORE. [#60040](https://github.com/ClickHouse/ClickHouse/pull/60040) ([Vitaly Baranov](https://github.com/vitlibar)).
- Теперь, если `StorageBuffer` имеет более 1 шарда (`num_layers` > 1), фоновая очистка будет происходить одновременно для всех шардов в нескольких потоках. [#60111](https://github.com/ClickHouse/ClickHouse/pull/60111) ([alesapin](https://github.com/alesapin)).





#### Улучшение {#improvement-10}

- Когда формат вывода — `Pretty`, и блок состоит из одного числового значения, превышающего один миллион, справа от таблицы будет выведено читаемое число. [#60379](https://github.com/ClickHouse/ClickHouse/pull/60379) ([rogeryk](https://github.com/rogeryk)).
- Добавлены настройки `split_parts_ranges_into_intersecting_and_non_intersecting_final` и `split_intersecting_parts_ranges_into_layers_final`. Эти настройки необходимы для отключения оптимизаций в запросах с `FINAL` и предназначены только для отладки. [#59705](https://github.com/ClickHouse/ClickHouse/pull/59705) ([Maksim Kita](https://github.com/kitaisreal)). На самом деле не только для этого — они также могут снизить потребление памяти за счёт производительности.
- Переименована настройка `extract_kvp_max_pairs_per_row` в `extract_key_value_pairs_max_pairs_per_row`. Проблема (ненужное сокращение в названии настройки) была внесена в https://github.com/ClickHouse/ClickHouse/pull/43606. Исправлена документация этой настройки. [#59683](https://github.com/ClickHouse/ClickHouse/pull/59683) ([Alexey Milovidov](https://github.com/alexey-milovidov)). [#59960](https://github.com/ClickHouse/ClickHouse/pull/59960) ([jsc0218](https://github.com/jsc0218)).
- Выполнение `ALTER COLUMN MATERIALIZE` для столбца с выражением `DEFAULT` или `MATERIALIZED` теперь точно следует семантике. [#58023](https://github.com/ClickHouse/ClickHouse/pull/58023) ([Duc Canh Le](https://github.com/canhld94)).
- Включена логика экспоненциальной задержки для ошибок во время мутаций. Это снизит использование CPU, памяти и размеры файлов журналов. [#58036](https://github.com/ClickHouse/ClickHouse/pull/58036) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
- Добавлено улучшение для подсчёта события профилирования `InitialQuery`. [#58195](https://github.com/ClickHouse/ClickHouse/pull/58195) ([Unalian](https://github.com/Unalian)).
- Разрешено определять `volume_priority` в `storage_configuration`. [#58533](https://github.com/ClickHouse/ClickHouse/pull/58533) ([Andrey Zvonov](https://github.com/zvonand)).
- Добавлена поддержка типа `Date32` в кодеке `T64`. [#58738](https://github.com/ClickHouse/ClickHouse/pull/58738) ([Hongbin Ma](https://github.com/binmahone)).
- Разрешены завершающие запятые в типах с несколькими элементами. [#59119](https://github.com/ClickHouse/ClickHouse/pull/59119) ([Aleksandr Musorin](https://github.com/AVMusorin)).
- Настройки для движка таблиц Distributed теперь могут быть указаны в конфигурационном файле сервера (аналогично настройкам MergeTree), например `<distributed> <flush_on_detach>false</flush_on_detach> </distributed>`. [#59291](https://github.com/ClickHouse/ClickHouse/pull/59291) ([Azat Khuzhin](https://github.com/azat)).
- Повторные попытки при отключениях и истёкших сессиях при чтении `system.zookeeper`. Это полезно при чтении большого количества строк из таблицы `system.zookeeper`, особенно при наличии искусственно внедрённых отключений. [#59388](https://github.com/ClickHouse/ClickHouse/pull/59388) ([Alexander Gololobov](https://github.com/davenger)).
- Не интерпретировать числа с ведущими нулями как восьмеричные, когда `input_format_values_interpret_expressions=0`. [#59403](https://github.com/ClickHouse/ClickHouse/pull/59403) ([Joanna Hulboj](https://github.com/jh0x)).
- При запуске и при изменении конфигурационных файлов ClickHouse обновляет жёсткие лимиты памяти своего общего трекера памяти. Эти лимиты вычисляются на основе различных настроек сервера и лимитов cgroups (в Linux). Ранее настройка `/sys/fs/cgroup/memory.max` (для cgroups v2) была жёстко закодирована. В результате лимиты памяти cgroup v2, настроенные для вложенных групп (иерархий), например `/sys/fs/cgroup/my/nested/group/memory.max`, игнорировались. Теперь это исправлено. Поведение лимитов памяти v1 остаётся неизменным. [#59435](https://github.com/ClickHouse/ClickHouse/pull/59435) ([Robert Schulze](https://github.com/rschu1ze)).
- Добавлены новые события профилирования для наблюдения за временем, затраченным на вычисление первичных ключей/проекций/вторичных индексов во время операций `INSERT`. [#59436](https://github.com/ClickHouse/ClickHouse/pull/59436) ([Nikita Taranov](https://github.com/nickitat)).
- Разрешено определять начальную точку для S3Queue в режиме Ordered при создании с помощью настройки `s3queue_last_processed_path`. [#59446](https://github.com/ClickHouse/ClickHouse/pull/59446) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Комментарии для системных таблиц теперь также доступны в `system.tables` в `clickhouse-local`. [#59493](https://github.com/ClickHouse/ClickHouse/pull/59493) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Таблица `system.zookeeper`: ранее весь результат накапливался в памяти и возвращался одним большим блоком. Это изменение должно помочь снизить потребление памяти при чтении большого количества строк из `system.zookeeper`, позволить показывать промежуточный прогресс (сколько строк уже прочитано) и избежать превышения тайм-аута соединения при большом наборе результатов. [#59545](https://github.com/ClickHouse/ClickHouse/pull/59545) ([Alexander Gololobov](https://github.com/davenger)).
- Теперь панель управления понимает как сжатое, так и несжатое состояние #hash URL (обратная совместимость). Продолжение [#59124](https://github.com/ClickHouse/ClickHouse/issues/59124). [#59548](https://github.com/ClickHouse/ClickHouse/pull/59548) ([Amos Bird](https://github.com/amosbird)).
- Обновлена библиотека Intel QPL (используемая кодеком `DEFLATE_QPL`) с версии v1.3.1 до v1.4.0. Также исправлена ошибка в механизме тайм-аута опроса, поскольку мы наблюдали, что в некоторых случаях тайм-аут не работает должным образом, и если происходит тайм-аут, IAA и CPU могут обрабатывать буфер одновременно. На данный момент лучше убедиться, что статус кодека IAA не QPL_STS_BEING_PROCESSED, а затем переключиться на программный кодек. [#59551](https://github.com/ClickHouse/ClickHouse/pull/59551) ([jasperzhu](https://github.com/jinjunzh)).
- Не показывать предупреждение о версии сервера в ClickHouse Cloud, поскольку ClickHouse Cloud автоматически обрабатывает бесшовные обновления. [#59657](https://github.com/ClickHouse/ClickHouse/pull/59657) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- После самораспаковки временный бинарный файл перемещается вместо копирования. [#59661](https://github.com/ClickHouse/ClickHouse/pull/59661) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Исправлена раскрутка стека на Apple macOS. Это закрывает [#53653](https://github.com/ClickHouse/ClickHouse/issues/53653). [#59690](https://github.com/ClickHouse/ClickHouse/pull/59690) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Проверка переполнения стека в парсерах, даже если пользователь неправильно настроил параметр `max_parser_depth` на очень высокое значение. Это закрывает [#59622](https://github.com/ClickHouse/ClickHouse/issues/59622). [#59697](https://github.com/ClickHouse/ClickHouse/pull/59697) ([Alexey Milovidov](https://github.com/alexey-milovidov)). [#60434](https://github.com/ClickHouse/ClickHouse/pull/60434)
- Унифицировано поведение именованных коллекций, созданных через XML и SQL, в хранилище Kafka. [#59710](https://github.com/ClickHouse/ClickHouse/pull/59710) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
- В случае, когда `merge_max_block_size_bytes` достаточно мал, а таблицы содержат широкие строки (строки или кортежи), фоновые слияния могут застрять в бесконечном цикле. Это поведение исправлено. Продолжение для https://github.com/ClickHouse/ClickHouse/pull/59340. [#59812](https://github.com/ClickHouse/ClickHouse/pull/59812) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Разрешён uuid в replica_path, если CREATE TABLE явно его содержит. [#59908](https://github.com/ClickHouse/ClickHouse/pull/59908) ([Azat Khuzhin](https://github.com/azat)).
- Добавлен столбец `metadata_version` таблицы ReplicatedMergeTree в системную таблицу `system.tables`. [#59942](https://github.com/ClickHouse/ClickHouse/pull/59942) ([Maksim Kita](https://github.com/kitaisreal)).
- Улучшение Keeper: отправка только связанных с Keeper метрик/событий для Prometheus. [#59945](https://github.com/ClickHouse/ClickHouse/pull/59945) ([Antonio Andelic](https://github.com/antonio2368)).
- Панель управления будет отображать метрики для разных версий ClickHouse, даже если структура системных таблиц изменилась после обновления. [#59967](https://github.com/ClickHouse/ClickHouse/pull/59967) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Разрешена загрузка информации о зоне доступности из файла. [#59976](https://github.com/ClickHouse/ClickHouse/pull/59976) ([Konstantin Bogdanov](https://github.com/thevar1able)).
- Улучшение Keeper: добавлены повторные попытки при сбоях для операций, связанных с диском. [#59980](https://github.com/ClickHouse/ClickHouse/pull/59980) ([Antonio Andelic](https://github.com/antonio2368)).
- Добавлена новая настройка конфигурации `backups.remove_backup_files_after_failure`: `<clickhouse> <backups> <remove_backup_files_after_failure>true</remove_backup_files_after_failure> </backups> </clickhouse>`. [#60002](https://github.com/ClickHouse/ClickHouse/pull/60002) ([Vitaly Baranov](https://github.com/vitlibar)).
- Резервное копирование файла S3 в GCP переключается на буферное копирование в случае, если GCP вернул `Internal Error` с HTTP-кодом ошибки `GATEWAY_TIMEOUT`. [#60164](https://github.com/ClickHouse/ClickHouse/pull/60164) ([Maksim Kita](https://github.com/kitaisreal)).
- Оптимизация выполнения с коротким замыканием для `ULIDStringToDateTime`. [#60211](https://github.com/ClickHouse/ClickHouse/pull/60211) ([Juan Madurga](https://github.com/jlmadurga)).
- Добавлен столбец `query_id` для таблиц `system.backups` и `system.backup_log`. Добавлена трассировка стека ошибок в столбец `error`. [#60220](https://github.com/ClickHouse/ClickHouse/pull/60220) ([Maksim Kita](https://github.com/kitaisreal)).
- Соединения через порт MySQL теперь автоматически выполняются с настройкой `prefer_column_name_to_alias = 1` для поддержки QuickSight из коробки. Кроме того, настройки `mysql_map_string_to_text_in_show_columns` и `mysql_map_fixed_string_to_text_in_show_columns` теперь включены по умолчанию, также влияя только на соединения MySQL. Это повышает совместимость с большим количеством инструментов BI. [#60365](https://github.com/ClickHouse/ClickHouse/pull/60365) ([Robert Schulze](https://github.com/rschu1ze)).
- Исправлено состояние гонки в коде JavaScript, приводящее к дублированию диаграмм друг на друге. [#60392](https://github.com/ClickHouse/ClickHouse/pull/60392) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-6}

- Добавлены сборки и тесты со сбором покрытия с интроспекцией. Продолжение [#56102](https://github.com/ClickHouse/ClickHouse/issues/56102). [#58792](https://github.com/ClickHouse/ClickHouse/pull/58792) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Обновление инструментария Rust в `corrosion-cmake` при установке переменной инструментария кросс-компиляции CMake. [#59309](https://github.com/ClickHouse/ClickHouse/pull/59309) ([Aris Tritas](https://github.com/aris-aiven)).
- Добавлен фаззинг для ASTLiterals. [#59383](https://github.com/ClickHouse/ClickHouse/pull/59383) ([Raúl Marín](https://github.com/Algunenano)).
- Если требуется запускать скрипты initdb при каждом запуске контейнера ClickHouse, необходимо инициализировать переменную окружения CLICKHOUSE_ALWAYS_RUN_INITDB_SCRIPTS. [#59808](https://github.com/ClickHouse/ClickHouse/pull/59808) ([Alexander Nikolaev](https://github.com/AlexNik)).
- Удалена возможность отключения стандартных компонентов ClickHouse (таких как server/client/...), но сохранены компоненты, требующие дополнительных библиотек (например, ODBC или keeper). [#59857](https://github.com/ClickHouse/ClickHouse/pull/59857) ([Azat Khuzhin](https://github.com/azat)).
- Фаззер запросов теперь выполняет фаззинг SETTINGS внутри запросов. [#60087](https://github.com/ClickHouse/ClickHouse/pull/60087) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлена поддержка сборки ClickHouse с clang-19 (master). [#60448](https://github.com/ClickHouse/ClickHouse/pull/60448) ([Alexey Milovidov](https://github.com/alexey-milovidov)).


#### Исправление ошибок (видимые пользователю проблемы в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-8}

- Fix a "Non-ready set" error in TTL WHERE. [#57430](https://github.com/ClickHouse/ClickHouse/pull/57430) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix a bug in the `quantilesGK` function [#58216](https://github.com/ClickHouse/ClickHouse/pull/58216) ([李扬](https://github.com/taiyang-li)).
- Fix a wrong behavior with `intDiv` for Decimal arguments [#59243](https://github.com/ClickHouse/ClickHouse/pull/59243) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Fix `translate` with FixedString input [#59356](https://github.com/ClickHouse/ClickHouse/pull/59356) ([Raúl Marín](https://github.com/Algunenano)).
- Fix digest calculation in Keeper [#59439](https://github.com/ClickHouse/ClickHouse/pull/59439) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix stacktraces for binaries without debug symbols [#59444](https://github.com/ClickHouse/ClickHouse/pull/59444) ([Azat Khuzhin](https://github.com/azat)).
- Fix `ASTAlterCommand::formatImpl` in case of column specific settings... [#59445](https://github.com/ClickHouse/ClickHouse/pull/59445) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fix `SELECT * FROM [...] ORDER BY ALL` with Analyzer [#59462](https://github.com/ClickHouse/ClickHouse/pull/59462) ([zhongyuankai](https://github.com/zhongyuankai)).
- Fix possible uncaught exception during distributed query cancellation [#59487](https://github.com/ClickHouse/ClickHouse/pull/59487) ([Azat Khuzhin](https://github.com/azat)).
- Make MAX use the same rules as permutation for complex types [#59498](https://github.com/ClickHouse/ClickHouse/pull/59498) ([Raúl Marín](https://github.com/Algunenano)).
- Fix corner case when passing `update_insert_deduplication_token_in_dependent_materialized_views` [#59544](https://github.com/ClickHouse/ClickHouse/pull/59544) ([Jordi Villar](https://github.com/jrdi)).
- Fix incorrect result of arrayElement / map on empty value [#59594](https://github.com/ClickHouse/ClickHouse/pull/59594) ([Raúl Marín](https://github.com/Algunenano)).
- Fix crash in topK when merging empty states [#59603](https://github.com/ClickHouse/ClickHouse/pull/59603) ([Raúl Marín](https://github.com/Algunenano)).
- Fix distributed table with a constant sharding key [#59606](https://github.com/ClickHouse/ClickHouse/pull/59606) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix KQL issue found by WingFuzz [#59626](https://github.com/ClickHouse/ClickHouse/pull/59626) ([Yong Wang](https://github.com/kashwy)).
- Fix error "Read beyond last offset" for AsynchronousBoundedReadBuffer [#59630](https://github.com/ClickHouse/ClickHouse/pull/59630) ([Vitaly Baranov](https://github.com/vitlibar)).
- Maintain function alias in RewriteSumFunctionWithSumAndCountVisitor [#59658](https://github.com/ClickHouse/ClickHouse/pull/59658) ([Raúl Marín](https://github.com/Algunenano)).
- Fix query start time on non initial queries [#59662](https://github.com/ClickHouse/ClickHouse/pull/59662) ([Raúl Marín](https://github.com/Algunenano)).
- Validate types of arguments for `minmax` skipping index [#59733](https://github.com/ClickHouse/ClickHouse/pull/59733) ([Anton Popov](https://github.com/CurtizJ)).
- Fix leftPad / rightPad function with FixedString input [#59739](https://github.com/ClickHouse/ClickHouse/pull/59739) ([Raúl Marín](https://github.com/Algunenano)).
- Fix AST fuzzer issue in function `countMatches` [#59752](https://github.com/ClickHouse/ClickHouse/pull/59752) ([Robert Schulze](https://github.com/rschu1ze)).
- RabbitMQ: fix having neither acked nor nacked messages [#59775](https://github.com/ClickHouse/ClickHouse/pull/59775) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix StorageURL doing some of the query execution in single thread [#59833](https://github.com/ClickHouse/ClickHouse/pull/59833) ([Michael Kolupaev](https://github.com/al13n321)).
- S3Queue: fix uninitialized value [#59897](https://github.com/ClickHouse/ClickHouse/pull/59897) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix parsing of partition expressions surrounded by parens [#59901](https://github.com/ClickHouse/ClickHouse/pull/59901) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
- Fix crash in JSONColumnsWithMetadata format over HTTP [#59925](https://github.com/ClickHouse/ClickHouse/pull/59925) ([Kruglov Pavel](https://github.com/Avogar)).
- Do not rewrite sum to count if the return value differs in Analyzer [#59926](https://github.com/ClickHouse/ClickHouse/pull/59926) ([Azat Khuzhin](https://github.com/azat)).
- UniqExactSet read crash fix [#59928](https://github.com/ClickHouse/ClickHouse/pull/59928) ([Maksim Kita](https://github.com/kitaisreal)).
- ReplicatedMergeTree invalid metadata_version fix [#59946](https://github.com/ClickHouse/ClickHouse/pull/59946) ([Maksim Kita](https://github.com/kitaisreal)).
- Fix data race in `StorageDistributed` [#59987](https://github.com/ClickHouse/ClickHouse/pull/59987) ([Nikita Taranov](https://github.com/nickitat)).
- Docker: run init scripts when option is enabled rather than disabled [#59991](https://github.com/ClickHouse/ClickHouse/pull/59991) ([jktng](https://github.com/jktng)).
- Fix INSERT into `SQLite` with single quote (by escaping single quotes with a quote instead of backslash) [#60015](https://github.com/ClickHouse/ClickHouse/pull/60015) ([Azat Khuzhin](https://github.com/azat)).
- Fix several logical errors in `arrayFold` [#60022](https://github.com/ClickHouse/ClickHouse/pull/60022) ([Raúl Marín](https://github.com/Algunenano)).
- Fix optimize_uniq_to_count removing the column alias [#60026](https://github.com/ClickHouse/ClickHouse/pull/60026) ([Raúl Marín](https://github.com/Algunenano)).
- Fix possible exception from S3Queue table on drop [#60036](https://github.com/ClickHouse/ClickHouse/pull/60036) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix formatting of NOT with single literals [#60042](https://github.com/ClickHouse/ClickHouse/pull/60042) ([Raúl Marín](https://github.com/Algunenano)).
- Use max_query_size from context in DDLLogEntry instead of hardcoded 4096 [#60083](https://github.com/ClickHouse/ClickHouse/pull/60083) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix inconsistent formatting of queries containing tables named `table`. Fix wrong formatting of queries with `UNION ALL`, `INTERSECT`, and `EXCEPT` when their structure wasn't linear. This closes #52349. Fix wrong formatting of `SYSTEM` queries, including `SYSTEM ... DROP FILESYSTEM CACHE`, `SYSTEM ... REFRESH/START/STOP/CANCEL/TEST VIEW`, `SYSTEM ENABLE/DISABLE FAILPOINT`. Fix formatting of parameterized DDL queries. Fix the formatting of the `DESCRIBE FILESYSTEM CACHE` query. Fix incorrect formatting of the `SET param_...` (a query setting a parameter). Fix incorrect formatting of `CREATE INDEX` queries. Fix inconsistent formatting of `CREATE USER` and similar queries. Fix inconsistent formatting of `CREATE SETTINGS PROFILE`. Fix incorrect formatting of `ALTER ... MODIFY REFRESH`. Fix inconsistent formatting of window functions if frame offsets were expressions. Fix inconsistent formatting of `RESPECT NULLS` and `IGNORE NULLS` if they were used after a function that implements an operator (such as `plus`). Fix idiotic formatting of `SYSTEM SYNC REPLICA ... LIGHTWEIGHT FROM ...`. Fix inconsistent formatting of invalid queries with `GROUP BY GROUPING SETS ... WITH ROLLUP/CUBE/TOTALS`. Fix inconsistent formatting of `GRANT CURRENT GRANTS`. Fix inconsistent formatting of `CREATE TABLE (... COLLATE)`. Additionally, I fixed the incorrect formatting of `EXPLAIN` in subqueries (#60102). Fixed incorrect formatting of lambda functions (#60012). Added a check so there is no way to miss these abominations in the future. [#60095](https://github.com/ClickHouse/ClickHouse/pull/60095) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix inconsistent formatting of explain in subqueries [#60102](https://github.com/ClickHouse/ClickHouse/pull/60102) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix cosineDistance crash with Nullable [#60150](https://github.com/ClickHouse/ClickHouse/pull/60150) ([Raúl Marín](https://github.com/Algunenano)).
- Allow casting of bools in string representation to true bools [#60160](https://github.com/ClickHouse/ClickHouse/pull/60160) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix `system.s3queue_log` [#60166](https://github.com/ClickHouse/ClickHouse/pull/60166) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix arrayReduce with nullable aggregate function name [#60188](https://github.com/ClickHouse/ClickHouse/pull/60188) ([Raúl Marín](https://github.com/Algunenano)).
- Hide sensitive info for `S3Queue` [#60233](https://github.com/ClickHouse/ClickHouse/pull/60233) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix http exception codes. [#60252](https://github.com/ClickHouse/ClickHouse/pull/60252) ([Austin Kothig](https://github.com/kothiga)).
- S3Queue: fix a bug (also fixes flaky test_storage_s3_queue/test.py::test_shards_distributed) [#60282](https://github.com/ClickHouse/ClickHouse/pull/60282) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix use-of-uninitialized-value and invalid result in hashing functions with IPv6 [#60359](https://github.com/ClickHouse/ClickHouse/pull/60359) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix OptimizeDateOrDateTimeConverterWithPreimageVisitor with null arguments [#60453](https://github.com/ClickHouse/ClickHouse/pull/60453) ([Raúl Marín](https://github.com/Algunenano)).
- Fixed a minor bug that prevented distributed table queries sent from either KQL or PRQL dialect clients to be executed on replicas. [#59674](https://github.com/ClickHouse/ClickHouse/issues/59674). [#60470](https://github.com/ClickHouse/ClickHouse/pull/60470) ([Alexey Milovidov](https://github.com/alexey-milovidov)) [#59674](https://github.com/ClickHouse/ClickHouse/pull/59674) ([Austin Kothig](https://github.com/kothiga)).

### <a id="241"></a> Релиз ClickHouse 24.1, 2024-01-30 {#a-id241a-clickhouse-release-241-2024-01-30}

#### Обратно несовместимые изменения {#backward-incompatible-change-9}

- Настройка `print_pretty_type_names` включена по умолчанию. Вы можете отключить её для сохранения прежнего поведения или выполнить `SET compatibility = '23.12'`. [#57726](https://github.com/ClickHouse/ClickHouse/pull/57726) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Настройка MergeTree `clean_deleted_rows` устарела и больше не действует. Ключевое слово `CLEANUP` для `OPTIMIZE` по умолчанию запрещено (если не включена настройка `allow_experimental_replacing_merge_with_cleanup`). [#58316](https://github.com/ClickHouse/ClickHouse/pull/58316) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Функция `reverseDNSQuery` больше недоступна. Это закрывает [#58368](https://github.com/ClickHouse/ClickHouse/issues/58368). [#58369](https://github.com/ClickHouse/ClickHouse/pull/58369) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Включены различные изменения для улучшения контроля доступа в конфигурационном файле. Эти изменения влияют на поведение, проверьте `config.xml` в разделе `access_control_improvements`. Если вы не уверены, сохраните значения в конфигурационном файле такими же, как в предыдущей версии. [#58584](https://github.com/ClickHouse/ClickHouse/pull/58584) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Улучшена работа `sumMapFiltered` со значениями NaN. Значения NaN теперь размещаются в конце (а не в случайном порядке) и считаются отличными от любых других значений. `-0` теперь также обрабатывается как равное `0`; поскольку значения 0 отбрасываются, значения `-0` также отбрасываются. [#58959](https://github.com/ClickHouse/ClickHouse/pull/58959) ([Raúl Marín](https://github.com/Algunenano)).
- Функция `visibleWidth` теперь работает в соответствии с документацией. В предыдущих версиях она просто подсчитывала кодовые точки после сериализации строки, как функция `lengthUTF8`, но не учитывала символы нулевой ширины и комбинирующие символы, полноширинные символы, табуляции и символы удаления. Теперь поведение изменено соответствующим образом. Если вы хотите сохранить прежнее поведение, установите `function_visible_width_behavior` в `0` или `compatibility` в `23.12` или ниже. [#59022](https://github.com/ClickHouse/ClickHouse/pull/59022) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Диалект `Kusto` отключён до исправления этих двух ошибок: [#59037](https://github.com/ClickHouse/ClickHouse/issues/59037) и [#59036](https://github.com/ClickHouse/ClickHouse/issues/59036). [#59305](https://github.com/ClickHouse/ClickHouse/pull/59305) ([Alexey Milovidov](https://github.com/alexey-milovidov)). Любая попытка использовать `Kusto` приведёт к исключению.
- Более эффективная реализация модификатора `FINAL` больше не гарантирует сохранение порядка, даже если `max_threads = 1`. Если вы рассчитывали на прежнее поведение, установите `enable_vertical_final` в 0 или `compatibility` в `23.12`.


#### Новая функция {#new-feature-11}

- Реализован тип данных Variant, представляющий объединение других типов данных. Тип `Variant(T1, T2, ..., TN)` означает, что каждая строка этого типа имеет значение либо типа `T1`, либо `T2`, либо ... либо `TN`, либо не имеет значения (значение `NULL`). Тип Variant доступен при включении настройки `allow_experimental_variant_type`. Ссылка: [#54864](https://github.com/ClickHouse/ClickHouse/issues/54864). [#58047](https://github.com/ClickHouse/ClickHouse/pull/58047) ([Kruglov Pavel](https://github.com/Avogar)).
- Некоторые настройки (в настоящее время `min_compress_block_size` и `max_compress_block_size`) теперь можно указывать на уровне столбца, где они имеют приоритет над соответствующей настройкой на уровне таблицы. Пример: `CREATE TABLE tab (col String SETTINGS (min_compress_block_size = 81920, max_compress_block_size = 163840)) ENGINE = MergeTree ORDER BY tuple();`. [#55201](https://github.com/ClickHouse/ClickHouse/pull/55201) ([Duc Canh Le](https://github.com/canhld94)).
- Добавлена агрегатная функция `quantileDD`, а также соответствующие функции `quantilesDD` и `medianDD`. Основана на алгоритме DDSketch https://www.vldb.org/pvldb/vol12/p2195-masson.pdf. ### Запись в документации для пользовательских изменений. [#56342](https://github.com/ClickHouse/ClickHouse/pull/56342) ([Srikanth Chekuri](https://github.com/srikanthccv)).
- Добавлена возможность настройки любого типа объектного хранилища с любым типом метаданных. [#58357](https://github.com/ClickHouse/ClickHouse/pull/58357) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлены режимы `null_status_on_timeout_only_active` и `throw_only_active` для настройки `distributed_ddl_output_mode`, которые позволяют избежать ожидания неактивных реплик. [#58350](https://github.com/ClickHouse/ClickHouse/pull/58350) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Добавлена функция `arrayShingles` для вычисления подмассивов, например, `arrayShingles([1, 2, 3, 4, 5], 3)` возвращает `[[1,2,3],[2,3,4],[3,4,5]]`. [#58396](https://github.com/ClickHouse/ClickHouse/pull/58396) ([Zheng Miao](https://github.com/zenmiao7)).
- Добавлены функции `punycodeEncode`, `punycodeDecode`, `idnaEncode` и `idnaDecode`, которые полезны для преобразования интернационализированных доменных имён в ASCII-представление в соответствии со стандартом IDNA. [#58454](https://github.com/ClickHouse/ClickHouse/pull/58454) ([Robert Schulze](https://github.com/rschu1ze)).
- Добавлены функции для вычисления схожести строк: `dramerauLevenshteinDistance`, `jaroSimilarity` и `jaroWinklerSimilarity`. [#58531](https://github.com/ClickHouse/ClickHouse/pull/58531) ([Robert Schulze](https://github.com/rschu1ze)).
- Добавлены две настройки: `output_format_compression_level` для изменения уровня сжатия вывода и `output_format_compression_zstd_window_log` для явного задания размера окна сжатия и включения режима дальнего диапазона для сжатия zstd, если метод сжатия вывода — `zstd`. Применяется для `INTO OUTFILE` и при записи в табличные функции `file`, `url`, `hdfs`, `s3` и `azureBlobStorage`. [#58539](https://github.com/ClickHouse/ClickHouse/pull/58539) ([Duc Canh Le](https://github.com/canhld94)).
- Автоматическое отключение ANSI-последовательностей в форматах Pretty, если вывод не направлен в терминал. Добавлен новый режим `auto` для настройки `output_format_pretty_color`. [#58614](https://github.com/ClickHouse/ClickHouse/pull/58614) ([Shaun Struwig](https://github.com/Blargian)).
- Добавлена функция `sqidDecode`, которая декодирует [Sqids](https://sqids.org/). [#58544](https://github.com/ClickHouse/ClickHouse/pull/58544) ([Robert Schulze](https://github.com/rschu1ze)).
- Добавлена возможность чтения значений Bool как String во входных форматах JSON. Это реализовано с помощью настройки `input_format_json_read_bools_as_strings`, которая включена по умолчанию. [#58561](https://github.com/ClickHouse/ClickHouse/pull/58561) ([Kruglov Pavel](https://github.com/Avogar)).
- Добавлена функция `seriesDecomposeSTL`, которая разлагает временной ряд на сезонную, трендовую и остаточную компоненты. [#57078](https://github.com/ClickHouse/ClickHouse/pull/57078) ([Bhavna Jindal](https://github.com/bhavnajindal)).
- Представлен клиент MySQL Binlog для MaterializedMySQL: одно binlog-соединение для множества баз данных. [#57323](https://github.com/ClickHouse/ClickHouse/pull/57323) ([Val Doroshchuk](https://github.com/valbok)).
- Intel QuickAssist Technology (QAT) обеспечивает аппаратное ускорение сжатия и криптографии. В ClickHouse добавлен новый кодек сжатия `ZSTD_QAT`, который использует QAT для сжатия zstd. Кодек использует [Intel QATlib](https://github.com/intel/qatlib) и [Intel QAT ZSTD Plugin](https://github.com/intel/QAT-ZSTD-Plugin). В настоящее время только сжатие может быть ускорено аппаратно (программный резервный вариант используется в случае, если QAT не удалось инициализировать), распаковка всегда выполняется программно. [#57509](https://github.com/ClickHouse/ClickHouse/pull/57509) ([jasperzhu](https://github.com/jinjunzh)).
- Реализован новый способ генерации ключей объектного хранилища для дисков s3. Теперь формат можно определить с помощью синтаксиса регулярных выражений `re2` через опцию `key_template` в описании диска. [#57663](https://github.com/ClickHouse/ClickHouse/pull/57663) ([Sema Checherinda](https://github.com/CheSema)).
- Таблица system.dropped_tables_parts содержит части таблиц из system.dropped_tables (удалённые, но ещё не удалённые окончательно таблицы). [#58038](https://github.com/ClickHouse/ClickHouse/pull/58038) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Добавлена настройка `max_materialized_views_size_for_table` для ограничения количества материализованных представлений, присоединённых к таблице. [#58068](https://github.com/ClickHouse/ClickHouse/pull/58068) ([zhongyuankai](https://github.com/zhongyuankai)).
- Улучшения `clickhouse-format`: поддержка запросов INSERT с `VALUES`; поддержка комментариев (используйте `--comments` для их вывода); поддержка опции `--max_line_length` для форматирования только длинных запросов в многострочном виде. [#58246](https://github.com/ClickHouse/ClickHouse/pull/58246) ([vdimir](https://github.com/vdimir)).
- Подключение всех системных таблиц в `clickhouse-local`, включая `system.parts`. Это закрывает [#58312](https://github.com/ClickHouse/ClickHouse/issues/58312). [#58359](https://github.com/ClickHouse/ClickHouse/pull/58359) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Поддержка типов данных `Enum` в функции `transform`. Это закрывает [#58241](https://github.com/ClickHouse/ClickHouse/issues/58241). [#58360](https://github.com/ClickHouse/ClickHouse/pull/58360) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлена таблица `system.database_engines`. [#58390](https://github.com/ClickHouse/ClickHouse/pull/58390) ([Bharat Nallan](https://github.com/bharatnc)). Добавлена возможность независимой регистрации движков баз данных в кодовой базе. [#58365](https://github.com/ClickHouse/ClickHouse/pull/58365) ([Bharat Nallan](https://github.com/bharatnc)). Добавлена возможность независимой регистрации интерпретаторов. [#58443](https://github.com/ClickHouse/ClickHouse/pull/58443) ([Bharat Nallan](https://github.com/bharatnc)).
- Добавлен модификатор `FROM <Replicas>` для запроса `SYSTEM SYNC REPLICA LIGHTWEIGHT`. Модификатор `FROM` обеспечивает ожидание загрузок и удалений диапазонов только для указанных исходных реплик, а также для любых реплик, отсутствующих в zookeeper или имеющих пустое значение source_replica. [#58393](https://github.com/ClickHouse/ClickHouse/pull/58393) ([Jayme Bird](https://github.com/jaymebrd)).
- Добавлена настройка `update_insert_deduplication_token_in_dependent_materialized_views`. Эта настройка позволяет обновлять токен дедупликации вставки с идентификатором таблицы при вставке в зависимые материализованные представления. Закрывает [#59165](https://github.com/ClickHouse/ClickHouse/issues/59165). [#59238](https://github.com/ClickHouse/ClickHouse/pull/59238) ([Maksim Kita](https://github.com/kitaisreal)).
- Добавлена команда `SYSTEM RELOAD ASYNCHRONOUS METRICS`, которая обновляет асинхронные метрики. Преимущественно полезна для тестирования и разработки. [#53710](https://github.com/ClickHouse/ClickHouse/pull/53710) ([Robert Schulze](https://github.com/rschu1ze)).





#### Улучшение производительности {#performance-improvement-11}

- Координация параллельных реплик переписана для улучшения параллелизма и локальности кэша. Протестирована линейная масштабируемость на сотнях реплик. Также добавлена поддержка чтения с сохранением порядка. [#57968](https://github.com/ClickHouse/ClickHouse/pull/57968) ([Nikita Taranov](https://github.com/nickitat)).
- Исходящая буферизация HTTP заменена на нативные буферы ClickHouse. Добавлены метрики подсчёта байтов для интерфейсов. [#56064](https://github.com/ClickHouse/ClickHouse/pull/56064) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Большие состояния агрегации `uniqExact` теперь объединяются параллельно в распределённых запросах. [#59009](https://github.com/ClickHouse/ClickHouse/pull/59009) ([Nikita Taranov](https://github.com/nickitat)).
- Снижено потребление памяти после чтения из таблиц `MergeTree`. [#59290](https://github.com/ClickHouse/ClickHouse/pull/59290) ([Anton Popov](https://github.com/CurtizJ)).
- Снижено потребление памяти при вертикальных слияниях. [#59340](https://github.com/ClickHouse/ClickHouse/pull/59340) ([Anton Popov](https://github.com/CurtizJ)).
- Предотвращено чрезмерное потребление памяти при запуске Keeper в большем количестве случаев. [#58455](https://github.com/ClickHouse/ClickHouse/pull/58455) ([Antonio Andelic](https://github.com/antonio2368)).
- Улучшение Keeper: снижено потребление памяти Keeper для хранимых узлов. [#59002](https://github.com/ClickHouse/ClickHouse/pull/59002) ([Antonio Andelic](https://github.com/antonio2368)).
- Более эффективная с точки зрения кэша реализация final. Примечание об изменении поведения: ранее запросы с модификатором `FINAL`, которые читали данные одним потоком (например, `max_threads = 1`), выдавали отсортированный результат без явного указания `ORDER BY`. Это больше не гарантируется при `enable_vertical_final = true` (что установлено по умолчанию). [#54366](https://github.com/ClickHouse/ClickHouse/pull/54366) ([Duc Canh Le](https://github.com/canhld94)).
- Устранено лишнее копирование в `ReadBufferFromIStream`, который используется, например, для чтения из S3. [#56961](https://github.com/ClickHouse/ClickHouse/pull/56961) ([Nikita Taranov](https://github.com/nickitat)).
- Оптимизирована функция элемента массива для входных данных типа Array(Map)/Array(Array(Num)/Array(Array(String))/Array(BigInt)/Array(Decimal). Предыдущие реализации выполняли больше выделений памяти, чем требовалось. Ускорение достигает ~6x, особенно для входного типа Array(Map). [#56403](https://github.com/ClickHouse/ClickHouse/pull/56403) ([李扬](https://github.com/taiyang-li)).
- Столбец читается один раз при чтении из него нескольких подстолбцов в компактных частях. [#57631](https://github.com/ClickHouse/ClickHouse/pull/57631) ([Kruglov Pavel](https://github.com/Avogar)).
- Переписано AST функции `sum(column + constant)`. Доступно как проход оптимизации для Analyzer. [#57853](https://github.com/ClickHouse/ClickHouse/pull/57853) ([Jiebin Sun](https://github.com/jiebinn)).
- Вычисление функции `match` теперь использует индексы пропуска `ngrambf_v1` и `tokenbf_v1`. [#57882](https://github.com/ClickHouse/ClickHouse/pull/57882) ([凌涛](https://github.com/lingtaolf)).
- Вычисление функции `match` теперь использует инвертированные индексы. [#58284](https://github.com/ClickHouse/ClickHouse/pull/58284) ([凌涛](https://github.com/lingtaolf)).
- MergeTree `FINAL` не сравнивает строки из одной и той же не-L0 части. [#58142](https://github.com/ClickHouse/ClickHouse/pull/58142) ([Duc Canh Le](https://github.com/canhld94)).
- Ускорены вызовы iota (заполнение массива последовательными числами). [#58271](https://github.com/ClickHouse/ClickHouse/pull/58271) ([Raúl Marín](https://github.com/Algunenano)).
- Ускорены MIN/MAX для нечисловых типов. [#58334](https://github.com/ClickHouse/ClickHouse/pull/58334) ([Raúl Marín](https://github.com/Algunenano)).
- Оптимизирована комбинация фильтров (как в многоэтапном PREWHERE) с использованием инструкций BMI2/SSE. [#58800](https://github.com/ClickHouse/ClickHouse/pull/58800) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
- Используется на один поток меньше в `clickhouse-local`. [#58968](https://github.com/ClickHouse/ClickHouse/pull/58968) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Улучшена производительность функции `multiIf` для типа Nullable. [#57745](https://github.com/ClickHouse/ClickHouse/pull/57745) ([KevinyhZou](https://github.com/KevinyhZou)).
- Добавлена команда `SYSTEM JEMALLOC PURGE` для очистки неиспользуемых страниц jemalloc, `SYSTEM JEMALLOC [ ENABLE | DISABLE | FLUSH ] PROFILE` для управления профилем jemalloc при включённом профилировщике. Добавлены команды 4LW для jemalloc в Keeper: `jmst` для вывода статистики jemalloc, `jmfp`, `jmep`, `jmdp` для управления профилем jemalloc при включённом профилировщике. [#58665](https://github.com/ClickHouse/ClickHouse/pull/58665) ([Antonio Andelic](https://github.com/antonio2368)).
- Снижено потребление памяти при резервном копировании в S3. [#58962](https://github.com/ClickHouse/ClickHouse/pull/58962) ([Vitaly Baranov](https://github.com/vitlibar)).





#### Улучшение {#improvement-11}

- Added comments (brief descriptions) to all columns of system tables. There are several reasons for this: - We use system tables a lot, and sometimes it could be very difficult for developer to understand the purpose and the meaning of a particular column. - We change (add new ones or modify existing) system tables a lot and the documentation for them is always outdated. For example take a look at the documentation page for [`system.parts`](/operations/system-tables/parts). It misses a lot of columns - We would like to eventually generate documentation directly from ClickHouse. [#58356](https://github.com/ClickHouse/ClickHouse/pull/58356) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Allow queries without aliases for subqueries for `PASTE JOIN`. [#58654](https://github.com/ClickHouse/ClickHouse/pull/58654) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Enable `MySQL`/`MariaDB` integration on macOS. This closes [#21191](https://github.com/ClickHouse/ClickHouse/issues/21191). [#46316](https://github.com/ClickHouse/ClickHouse/pull/46316) ([Alexey Milovidov](https://github.com/alexey-milovidov)) ([Robert Schulze](https://github.com/rschu1ze)).
- Disable `max_rows_in_set_to_optimize_join` by default. [#56396](https://github.com/ClickHouse/ClickHouse/pull/56396) ([vdimir](https://github.com/vdimir)).
- Add `<host_name>` config parameter that allows avoiding resolving hostnames in ON CLUSTER DDL queries and Replicated database engines. This mitigates the possibility of the queue being stuck in case of a change in cluster definition. Closes [#57573](https://github.com/ClickHouse/ClickHouse/issues/57573). [#57603](https://github.com/ClickHouse/ClickHouse/pull/57603) ([Nikolay Degterinsky](https://github.com/evillique)).
- Increase `load_metadata_threads` to 16 for the filesystem cache. It will make the server start up faster. [#57732](https://github.com/ClickHouse/ClickHouse/pull/57732) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Add ability to throttle merges/mutations (`max_mutations_bandwidth_for_server`/`max_merges_bandwidth_for_server`). [#57877](https://github.com/ClickHouse/ClickHouse/pull/57877) ([Azat Khuzhin](https://github.com/azat)).
- Replaced undocumented (boolean) column `is_hot_reloadable` in system table `system.server_settings` by (Enum8) column `changeable_without_restart` with possible values `No`, `Yes`, `IncreaseOnly` and `DecreaseOnly`. Also documented the column. [#58029](https://github.com/ClickHouse/ClickHouse/pull/58029) ([skyoct](https://github.com/skyoct)).
- Cluster discovery supports setting username and password, close [#58063](https://github.com/ClickHouse/ClickHouse/issues/58063). [#58123](https://github.com/ClickHouse/ClickHouse/pull/58123) ([vdimir](https://github.com/vdimir)).
- Support query parameters in `ALTER TABLE ... PART`. [#58297](https://github.com/ClickHouse/ClickHouse/pull/58297) ([Azat Khuzhin](https://github.com/azat)).
- Create consumers for Kafka tables on the fly (but keep them for some period - `kafka_consumers_pool_ttl_ms`, since last used), this should fix problem with statistics for `system.kafka_consumers` (that does not consumed when nobody reads from Kafka table, which leads to live memory leak and slow table detach) and also this PR enables stats for `system.kafka_consumers` by default again. [#58310](https://github.com/ClickHouse/ClickHouse/pull/58310) ([Azat Khuzhin](https://github.com/azat)).
- `sparkBar` as an alias to `sparkbar`. [#58335](https://github.com/ClickHouse/ClickHouse/pull/58335) ([凌涛](https://github.com/lingtaolf)).
- Avoid sending `ComposeObject` requests after upload to `GCS`. [#58343](https://github.com/ClickHouse/ClickHouse/pull/58343) ([Azat Khuzhin](https://github.com/azat)).
- Correctly handle keys with dot in the name in configurations XMLs. [#58354](https://github.com/ClickHouse/ClickHouse/pull/58354) ([Azat Khuzhin](https://github.com/azat)).
- Make function `format` return constant on constant arguments. This closes [#58355](https://github.com/ClickHouse/ClickHouse/issues/58355). [#58358](https://github.com/ClickHouse/ClickHouse/pull/58358) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Adding a setting `max_estimated_execution_time` to separate `max_execution_time` and `max_estimated_execution_time`. [#58402](https://github.com/ClickHouse/ClickHouse/pull/58402) ([Zhang Yifan](https://github.com/zhangyifan27)).
- Provide a hint when an invalid database engine name is used. [#58444](https://github.com/ClickHouse/ClickHouse/pull/58444) ([Bharat Nallan](https://github.com/bharatnc)).
- Add settings for better control of indexes type in Arrow dictionary. Use signed integer type for indexes by default as Arrow recommends. Closes [#57401](https://github.com/ClickHouse/ClickHouse/issues/57401). [#58519](https://github.com/ClickHouse/ClickHouse/pull/58519) ([Kruglov Pavel](https://github.com/Avogar)).
- Implement [#58575](https://github.com/ClickHouse/ClickHouse/issues/58575) Support `CLICKHOUSE_PASSWORD_FILE ` environment variable when running the docker image. [#58583](https://github.com/ClickHouse/ClickHouse/pull/58583) ([Eyal Halpern Shalev](https://github.com/Eyal-Shalev)).
- When executing some queries, which require a lot of streams for reading data, the error `"Paste JOIN requires sorted tables only"` was previously thrown. Now the numbers of streams resize to 1 in that case. [#58608](https://github.com/ClickHouse/ClickHouse/pull/58608) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Better message for INVALID_IDENTIFIER error. [#58703](https://github.com/ClickHouse/ClickHouse/pull/58703) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Improved handling of signed numeric literals in normalizeQuery. [#58710](https://github.com/ClickHouse/ClickHouse/pull/58710) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
- Support Point data type for MySQL. [#58721](https://github.com/ClickHouse/ClickHouse/pull/58721) ([Kseniia Sumarokova](https://github.com/kssenii)).
- When comparing a Float32 column and a const string, read the string as Float32 (instead of Float64). [#58724](https://github.com/ClickHouse/ClickHouse/pull/58724) ([Raúl Marín](https://github.com/Algunenano)).
- Improve S3 compatibility, add ECloud EOS storage support. [#58786](https://github.com/ClickHouse/ClickHouse/pull/58786) ([xleoken](https://github.com/xleoken)).
- Allow `KILL QUERY` to cancel backups / restores. This PR also makes running backups and restores visible in `system.processes`. Also, there is a new setting in the server configuration now - `shutdown_wait_backups_and_restores` (default=true) which makes the server either wait on shutdown for all running backups and restores to finish or just cancel them. [#58804](https://github.com/ClickHouse/ClickHouse/pull/58804) ([Vitaly Baranov](https://github.com/vitlibar)).
- Avro format to support ZSTD codec. Closes [#58735](https://github.com/ClickHouse/ClickHouse/issues/58735). [#58805](https://github.com/ClickHouse/ClickHouse/pull/58805) ([flynn](https://github.com/ucasfl)).
- MySQL interface gained support for `net_write_timeout` and `net_read_timeout` settings. `net_write_timeout` is translated into the native `send_timeout` ClickHouse setting and, similarly, `net_read_timeout` into `receive_timeout`. Fixed an issue where it was possible to set MySQL `sql_select_limit` setting only if the entire statement was in upper case. [#58835](https://github.com/ClickHouse/ClickHouse/pull/58835) ([Serge Klochkov](https://github.com/slvrtrn)).
- A better exception message while conflict of creating dictionary and table with the same name. [#58841](https://github.com/ClickHouse/ClickHouse/pull/58841) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
- Make sure that for custom (created from SQL) disks ether `filesystem_caches_path` (a common directory prefix for all filesystem caches) or `custom_cached_disks_base_directory` (a common directory prefix for only filesystem caches created from custom disks) is specified in server config. `custom_cached_disks_base_directory` has higher priority for custom disks over `filesystem_caches_path`, which is used if the former one is absent. Filesystem cache setting `path` must lie inside that directory, otherwise exception will be thrown preventing disk to be created. This will not affect disks created on an older version and server was upgraded - then the exception will not be thrown to allow the server to successfully start). `custom_cached_disks_base_directory` is added to default server config as `/var/lib/clickhouse/caches/`. Closes [#57825](https://github.com/ClickHouse/ClickHouse/issues/57825). [#58869](https://github.com/ClickHouse/ClickHouse/pull/58869) ([Kseniia Sumarokova](https://github.com/kssenii)).
- MySQL interface gained compatibility with `SHOW WARNINGS`/`SHOW COUNT(*) WARNINGS` queries, though the returned result is always an empty set. [#58929](https://github.com/ClickHouse/ClickHouse/pull/58929) ([Serge Klochkov](https://github.com/slvrtrn)).
- Skip unavailable replicas when executing parallel distributed `INSERT SELECT`. [#58931](https://github.com/ClickHouse/ClickHouse/pull/58931) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Display word-descriptive log level while enabling structured log formatting in json. [#58936](https://github.com/ClickHouse/ClickHouse/pull/58936) ([Tim Liou](https://github.com/wheatdog)).
- MySQL interface gained support for `CAST(x AS SIGNED)` and `CAST(x AS UNSIGNED)` statements via data type aliases: `SIGNED` for Int64, and `UNSIGNED` for UInt64. This improves compatibility with BI tools such as Looker Studio. [#58954](https://github.com/ClickHouse/ClickHouse/pull/58954) ([Serge Klochkov](https://github.com/slvrtrn)).
- Change working directory to the data path in docker container. [#58975](https://github.com/ClickHouse/ClickHouse/pull/58975) ([cangyin](https://github.com/cangyin)).
- Added setting for Azure Blob Storage `azure_max_unexpected_write_error_retries` , can also be set from config under azure section. [#59001](https://github.com/ClickHouse/ClickHouse/pull/59001) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Allow server to start with broken data lake table. Closes [#58625](https://github.com/ClickHouse/ClickHouse/issues/58625). [#59080](https://github.com/ClickHouse/ClickHouse/pull/59080) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Allow to ignore schema evolution in the `Iceberg` table engine and read all data using schema specified by the user on table creation or latest schema parsed from metadata on table creation. This is done under a setting `iceberg_engine_ignore_schema_evolution` that is disabled by default. Note that enabling this setting can lead to incorrect result as in case of evolved schema all data files will be read using the same schema. [#59133](https://github.com/ClickHouse/ClickHouse/pull/59133) ([Kruglov Pavel](https://github.com/Avogar)).
- Prohibit mutable operations (`INSERT`/`ALTER`/`OPTIMIZE`/...) on read-only/write-once storages with a proper `TABLE_IS_READ_ONLY` error (to avoid leftovers). Avoid leaving left-overs on write-once disks (`format_version.txt`) on `CREATE`/`ATTACH`. Ignore `DROP` for `ReplicatedMergeTree` (so as for `MergeTree`). Fix iterating over `s3_plain` (`MetadataStorageFromPlainObjectStorage::iterateDirectory`). Note read-only is `web` disk, and write-once is `s3_plain`. [#59170](https://github.com/ClickHouse/ClickHouse/pull/59170) ([Azat Khuzhin](https://github.com/azat)).
- Fix bug in the experimental `_block_number` column which could lead to logical error during complex combination of `ALTER`s and `merge`s. Fixes [#56202](https://github.com/ClickHouse/ClickHouse/issues/56202). Replaces [#58601](https://github.com/ClickHouse/ClickHouse/issues/58601). [#59295](https://github.com/ClickHouse/ClickHouse/pull/59295) ([alesapin](https://github.com/alesapin)).
- Play UI understands when an exception is returned inside JSON. Adjustment for [#52853](https://github.com/ClickHouse/ClickHouse/issues/52853). [#59303](https://github.com/ClickHouse/ClickHouse/pull/59303) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- `/binary` HTTP handler allows to specify user, host, and optionally, password in the query string. [#59311](https://github.com/ClickHouse/ClickHouse/pull/59311) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Support backups for compressed in-memory tables. This closes [#57893](https://github.com/ClickHouse/ClickHouse/issues/57893). [#59315](https://github.com/ClickHouse/ClickHouse/pull/59315) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Support the `FORMAT` clause in `BACKUP` and `RESTORE` queries. [#59338](https://github.com/ClickHouse/ClickHouse/pull/59338) ([Vitaly Baranov](https://github.com/vitlibar)).
- Function `concatWithSeparator` now supports arbitrary argument types (instead of only `String` and `FixedString` arguments). For example, `SELECT concatWithSeparator('.', 'number', 1)` now returns `number.1`. [#59341](https://github.com/ClickHouse/ClickHouse/pull/59341) ([Robert Schulze](https://github.com/rschu1ze)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-7}

- Улучшены псевдонимы для бинарного файла clickhouse (теперь `ch`/`clickhouse` работает как `clickhouse-local` или `clickhouse` в зависимости от аргументов) и добавлено автодополнение bash для новых псевдонимов. [#58344](https://github.com/ClickHouse/ClickHouse/pull/58344) ([Azat Khuzhin](https://github.com/azat)).
- Добавлена проверка изменений настроек в CI для контроля того, что все изменения настроек отражены в истории изменений настроек. [#58555](https://github.com/ClickHouse/ClickHouse/pull/58555) ([Kruglov Pavel](https://github.com/Avogar)).
- В stateful-тестах используются таблицы, напрямую подключенные из S3. [#58791](https://github.com/ClickHouse/ClickHouse/pull/58791) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Теперь весь файл `fuzzer.log` сохраняется в виде архива вместо последних 100 тысяч строк. `tail -n 100000` часто удаляет строки с определениями таблиц. Пример:. [#58821](https://github.com/ClickHouse/ClickHouse/pull/58821) ([Dmitry Novik](https://github.com/novikd)).
- Включена поддержка Rust на macOS с Aarch64 (это добавит нечёткий поиск в клиенте с помощью skim и язык PRQL, хотя вряд ли кто-то размещает ClickHouse на darwin, так что это в основном для нечёткого поиска в клиенте). [#59272](https://github.com/ClickHouse/ClickHouse/pull/59272) ([Azat Khuzhin](https://github.com/azat)).
- Исправлена проблема агрегации в смешанных кластерах x86_64 и ARM [#59132](https://github.com/ClickHouse/ClickHouse/pull/59132) ([Harry Lee](https://github.com/HarryLeeIBM)).

#### Исправление ошибок (видимое пользователю некорректное поведение в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-9}


* Добавлено преобразование ключей соединения для вложенного LowCardinality [#51550](https://github.com/ClickHouse/ClickHouse/pull/51550) ([vdimir](https://github.com/vdimir)).
* Разворачивать только сам тип Nested при flatten&#95;nested=1, а не все Array(Tuple) [#56132](https://github.com/ClickHouse/ClickHouse/pull/56132) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка, связанная с проекциями и настройкой `aggregate_functions_null_for_empty` при вставке данных. [#56944](https://github.com/ClickHouse/ClickHouse/pull/56944) ([Amos Bird](https://github.com/amosbird)).
* Исправлено возможное исключение из-за устаревшего UUID профиля [#57263](https://github.com/ClickHouse/ClickHouse/pull/57263) ([Vasily Nemkov](https://github.com/Enmk)).
* Исправлена работа с буферами чтения в StreamingFormatExecutor [#57438](https://github.com/ClickHouse/ClickHouse/pull/57438) ([Kruglov Pavel](https://github.com/Avogar)).
* Не учитывать материализованные представления с удалённой целевой таблицей при проталкивании в представления [#57520](https://github.com/ClickHouse/ClickHouse/pull/57520) ([Kruglov Pavel](https://github.com/Avogar)).
* Устранена возможная гонка между ALTER&#95;METADATA и MERGE&#95;PARTS [#57755](https://github.com/ClickHouse/ClickHouse/pull/57755) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка порядка выражений в операторе GROUP BY с ROLLUP [#57786](https://github.com/ClickHouse/ClickHouse/pull/57786) ([Chen768959](https://github.com/Chen768959)).
* Исправление для устаревшей функции репликации «zero-copy»: устранена потеря BLOB-объектов после удаления реплики с повреждёнными отсоединёнными частями [#58333](https://github.com/ClickHouse/ClickHouse/pull/58333) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Разрешена работа пользователей с символическими ссылками в `user_files_path` [#58447](https://github.com/ClickHouse/ClickHouse/pull/58447) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлен сбой, возникавший при отсутствии agg-функции в таблице Graphite [#58453](https://github.com/ClickHouse/ClickHouse/pull/58453) ([Duc Canh Le](https://github.com/canhld94)).
* Отложить чтение из StorageKafka, чтобы обеспечить возможность многократного чтения в материализованных представлениях [#58477](https://github.com/ClickHouse/ClickHouse/pull/58477) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлен некорректный случай пересекающихся частей [#58482](https://github.com/ClickHouse/ClickHouse/pull/58482) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Отключён MergeTreePrefetchedReadPool для запросов только с LIMIT [#58505](https://github.com/ClickHouse/ClickHouse/pull/58505) ([Maksim Kita](https://github.com/kitaisreal)).
* Включена поддержка обычных баз данных при восстановлении [#58520](https://github.com/ClickHouse/ClickHouse/pull/58520) ([Jihyuk Bok](https://github.com/tomahawk28)).
* Исправлена работа пула потоков Apache Hive при чтении ORC/Parquet/... [#58537](https://github.com/ClickHouse/ClickHouse/pull/58537) ([sunny](https://github.com/sunny19930321)).
* Скрыты учетные данные в столбце `base_backup_name` таблицы `system.backup_log` [#58550](https://github.com/ClickHouse/ClickHouse/pull/58550) ([Daniel Pozo Escalona](https://github.com/danipozo)).
* `toStartOfInterval` для округления значений с точностью до милли- и микросекунд [#58557](https://github.com/ClickHouse/ClickHouse/pull/58557) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Отключить `max_joined_block_rows` в ConcurrentHashJoin [#58595](https://github.com/ClickHouse/ClickHouse/pull/58595) ([vdimir](https://github.com/vdimir)).
* Исправлена работа JOIN с Nullable в старом анализаторе [#58596](https://github.com/ClickHouse/ClickHouse/pull/58596) ([vdimir](https://github.com/vdimir)).
* `makeDateTime64`: Разрешить неконстантный аргумент дробной части [#58597](https://github.com/ClickHouse/ClickHouse/pull/58597) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлено возможное разыменование NULL-указателя при символизации встроенных фреймов [#58607](https://github.com/ClickHouse/ClickHouse/pull/58607) ([Azat Khuzhin](https://github.com/azat)).
* Улучшена изоляция записей кэша запросов для повторно созданных пользователей или при переключении ролей [#58611](https://github.com/ClickHouse/ClickHouse/pull/58611) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена ошибка анализа ключа партиционирования при выполнении оптимизации проекций [#58638](https://github.com/ClickHouse/ClickHouse/pull/58638) ([Amos Bird](https://github.com/amosbird)).
* Кэш запросов: исправлена квота на уровне пользователя [#58731](https://github.com/ClickHouse/ClickHouse/pull/58731) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлено разбиение потоков на разделы в параллельных оконных функциях [#58739](https://github.com/ClickHouse/ClickHouse/pull/58739) ([Dmitry Novik](https://github.com/novikd)).
* Исправлен двойной вызов destroy при возникновении исключения в addBatchLookupTable8 [#58745](https://github.com/ClickHouse/ClickHouse/pull/58745) ([Raúl Marín](https://github.com/Algunenano)).
* Не обрабатывать запросы в Keeper при завершении работы [#58765](https://github.com/ClickHouse/ClickHouse/pull/58765) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено разыменование нулевого указателя в `SlabsPolygonIndex::find` [#58771](https://github.com/ClickHouse/ClickHouse/pull/58771) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена работа функции JSONExtract для столбцов LowCardinality(Nullable) [#58808](https://github.com/ClickHouse/ClickHouse/pull/58808) ([vdimir](https://github.com/vdimir)).
* Исправлена проблема с неожиданным ростом потребления памяти при создании очень большого числа таблиц с помощью операций CREATE и DROP. [#58831](https://github.com/ClickHouse/ClickHouse/pull/58831) ([Maksim Kita](https://github.com/kitaisreal)).
* Хранение журнала многократных чтений файлов в mv [#58877](https://github.com/ClickHouse/ClickHouse/pull/58877) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Ограничение на идентификатор ключа доступа для S3. [#58900](https://github.com/ClickHouse/ClickHouse/pull/58900) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Исправлено возможное падение clickhouse-local при загрузке подсказок [#58907](https://github.com/ClickHouse/ClickHouse/pull/58907) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен сбой, возникавший при использовании `indexHint` [#58911](https://github.com/ClickHouse/ClickHouse/pull/58911) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена проблема, из-за которой StorageURL «забывал» заголовки после перезапуска сервера [#58933](https://github.com/ClickHouse/ClickHouse/pull/58933) ([Michael Kolupaev](https://github.com/al13n321)).
* Analyzer: исправлена замена хранилища на блок вставки [#58958](https://github.com/ClickHouse/ClickHouse/pull/58958) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена операция seek в ReadBufferFromZipArchive [#58966](https://github.com/ClickHouse/ClickHouse/pull/58966) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправление для экспериментальных инвертированных индексов (не используйте в продакшене): оператор `DROP INDEX` для инвертированного индекса теперь удаляет все соответствующие файлы из постоянного хранения [#59040](https://github.com/ClickHouse/ClickHouse/pull/59040) ([mochi](https://github.com/MochiXu)).
* Устранена гонка данных в query&#95;factories&#95;info [#59049](https://github.com/ClickHouse/ClickHouse/pull/59049) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отключено повторное выполнение при ошибке &quot;Too many redirects&quot; [#59099](https://github.com/ClickHouse/ClickHouse/pull/59099) ([skyoct](https://github.com/skyoct)).
* Исправлена взаимоблокировка при завершении работы незапущенной базы данных [#59137](https://github.com/ClickHouse/ClickHouse/pull/59137) ([Sergei Trifonov](https://github.com/serxa)).
* Исправлено: LIMIT BY и LIMIT в распределённом запросе [#59153](https://github.com/ClickHouse/ClickHouse/pull/59153) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлена ошибка, приводившая к сбою при использовании nullable часового пояса в `toString` [#59190](https://github.com/ClickHouse/ClickHouse/pull/59190) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлено аварийное завершение при обработке метаданных Iceberg при некорректных путях к файлам [#59275](https://github.com/ClickHouse/ClickHouse/pull/59275) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено имя архитектуры при выборе целевой платформы Rust [#59307](https://github.com/ClickHouse/ClickHouse/pull/59307) ([p1rattttt](https://github.com/p1rattttt)).
* Исправлена логическая ошибка, связанная с «неподготовленным набором» при выполнении запроса к `system.tables` с подзапросом в условии IN. [#59351](https://github.com/ClickHouse/ClickHouse/pull/59351) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).





## [Журнал изменений за 2023 год](/whats-new/changelog/2023) {#changelog-for-2023}
