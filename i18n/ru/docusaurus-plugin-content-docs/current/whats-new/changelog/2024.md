---
slug: /whats-new/changelog/2024
sidebar_position: 3
sidebar_label: '2024'
title: 'Журнал изменений за 2024 год'
description: 'Журнал изменений за 2024 год'
keywords: ['ClickHouse 2024', 'журнал изменений 2024', 'заметки о выпуске', 'история версий', 'новые функции']
doc_type: 'changelog'
---

### Оглавление {#table-of-contents}
**[Релиз ClickHouse v24.12, 2024-12-19](/whats-new/changelog/2024#a-id2412a-clickhouse-release-2412-2024-12-19)**<br/>
**[Релиз ClickHouse v24.11, 2024-11-26](/whats-new/changelog/2024#a-id2411a-clickhouse-release-2411-2024-11-26)**<br/>
**[Релиз ClickHouse v24.10, 2024-10-31](/whats-new/changelog/2024#a-id2410a-clickhouse-release-2410-2024-10-31)**<br/>
**[Релиз ClickHouse v24.9, 2024-09-26](/whats-new/changelog/2024#a-id249a-clickhouse-release-249-2024-09-26)**<br/>
**[Релиз ClickHouse v24.8 LTS, 2024-08-20](/whats-new/changelog/2024#a-id248a-clickhouse-release-248-lts-2024-08-20)**<br/>
**[Релиз ClickHouse v24.7, 2024-07-30](/whats-new/changelog/2024#a-id247a-clickhouse-release-247-2024-07-30)**<br/>
**[Релиз ClickHouse v24.6, 2024-07-01](/whats-new/changelog/2024#a-id246a-clickhouse-release-246-2024-07-01)**<br/>
**[Релиз ClickHouse v24.5, 2024-05-30](/whats-new/changelog/2024#a-id245a-clickhouse-release-245-2024-05-30)**<br/>
**[Релиз ClickHouse v24.4, 2024-04-30](/whats-new/changelog/2024#a-id244a-clickhouse-release-244-2024-04-30)**<br/>
**[Релиз ClickHouse v24.3 LTS, 2024-03-26](/whats-new/changelog/2024#a-id243a-clickhouse-release-243-lts-2024-03-27)**<br/>
**[Релиз ClickHouse v24.2, 2024-02-29](/whats-new/changelog/2024#a-id242a-clickhouse-release-242-2024-02-29)**<br/>
**[Релиз ClickHouse v24.1, 2024-01-30](/whats-new/changelog/2024#a-id241a-clickhouse-release-241-2024-01-30)**<br/>
**[Журнал изменений за 2023 год](/whats-new/changelog/2023/)**<br/>

### <a id="2412"></a> Релиз ClickHouse 24.12, 2024-12-19 {#a-id2412a-clickhouse-release-2412-2024-12-19}

#### Изменения, нарушающие обратную совместимость {#backward-incompatible-change}
* Функции `greatest` и `least` теперь игнорируют входные значения NULL, тогда как ранее они возвращали NULL, если один из аргументов был NULL. Например, теперь `SELECT greatest(1, 2, NULL)` возвращает 2. Это делает поведение совместимым с PostgreSQL, но при этом нарушает совместимость с MySQL, который возвращает NULL. Чтобы сохранить предыдущее поведение, установите настройку `least_greatest_legacy_null_behavior` (по умолчанию: `false`) в значение `true`. [#65519](https://github.com/ClickHouse/ClickHouse/pull/65519) [#73344](https://github.com/ClickHouse/ClickHouse/pull/73344) ([kevinyhzou](https://github.com/KevinyhZou)).
* Новая интеграция с MongoDB теперь используется по умолчанию. Пользователи, которые предпочитают использовать устаревший драйвер MongoDB (на основе драйвера Poco), могут включить серверную настройку `use_legacy_mongodb_integration`. [#73359](https://github.com/ClickHouse/ClickHouse/pull/73359) ([Kirill Nikiforov](https://github.com/allmazz).



#### Новая возможность {#new-feature}

* Типы `JSON`/`Dynamic`/`Variant` переведены из экспериментальных в бета-стадию. [#72294](https://github.com/ClickHouse/ClickHouse/pull/72294) ([Pavel Kruglov](https://github.com/Avogar)). Мы также перенесли все исправления, включая это изменение, в версию 24.11.
* Эволюция схемы для формата хранения данных [Iceberg](https://iceberg.apache.org/spec/#file-system-operations) предоставляет пользователю широкие возможности по изменению схемы таблицы. Порядок столбцов, их имена и простые расширения типов могут изменяться на уровне реализации. [#69445](https://github.com/ClickHouse/ClickHouse/pull/69445) ([Daniil Ivanik](https://github.com/divanik)).
* Интеграция с REST-каталогом Iceberg: новый движок базы данных Iceberg, подключающий весь каталог к ClickHouse. [#71542](https://github.com/ClickHouse/ClickHouse/pull/71542) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлен кэш для первичного индекса таблиц `MergeTree` (может быть включён настройкой таблицы `use_primary_key_cache`). Если для первичного индекса включены ленивая загрузка и кэш, он будет загружаться в кэш по требованию (аналогично кэшу меток), вместо того чтобы постоянно находиться в памяти. Добавлен предварительный прогрев (prewarm) первичного индекса при вставках/слияниях/загрузках частей данных и при перезапуске таблицы (может быть включён настройкой `prewarm_primary_key_cache`). Это позволяет снизить потребление памяти для очень больших таблиц на разделяемом хранилище; мы протестировали это на таблицах с более чем квадриллионом записей. [#72102](https://github.com/ClickHouse/ClickHouse/pull/72102) ([Anton Popov](https://github.com/CurtizJ)). [#72750](https://github.com/ClickHouse/ClickHouse/pull/72750) ([Alexander Gololobov](https://github.com/davenger)).
* Реализована команда `SYSTEM LOAD PRIMARY KEY` для загрузки первичных индексов для всех частей указанной таблицы или для всех таблиц, если таблица не указана. Это полезно для бенчмаркинга и для предотвращения дополнительной задержки при выполнении запросов. [#66252](https://github.com/ClickHouse/ClickHouse/pull/66252) [#67733](https://github.com/ClickHouse/ClickHouse/pull/67733) ([ZAWA&#95;ll](https://github.com/Zawa-ll)).
* Добавлен запрос, который позволяет подключать таблицы `MergeTree` в виде `ReplicatedMergeTree` и наоборот: `ATTACH TABLE ... AS REPLICATED` и `ATTACH TABLE ... AS NOT REPLICATED`. [#65401](https://github.com/ClickHouse/ClickHouse/pull/65401) ([Kirill](https://github.com/kirillgarbar)).
* Новая настройка `http_response_headers`, позволяющая настраивать заголовки HTTP-ответа. Например, вы можете указать браузеру отобразить изображение, хранящееся в базе данных. Это закрывает [#59620](https://github.com/ClickHouse/ClickHouse/issues/59620). [#72656](https://github.com/ClickHouse/ClickHouse/pull/72656) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена функция `toUnixTimestamp64Second`, которая преобразует `DateTime64` в значение типа `Int64` с фиксированной точностью до секунды, чтобы можно было возвращать отрицательное значение, если дата раньше эпохи Unix. [#70597](https://github.com/ClickHouse/ClickHouse/pull/70597) ([zhanglistar](https://github.com/zhanglistar)). [#73146](https://github.com/ClickHouse/ClickHouse/pull/73146) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена новая настройка `enforce_index_structure_match_on_partition_manipulation`, позволяющая выполнять операцию ATTACH, если набор проекций и вторичных индексов исходной таблицы является подмножеством набора проекций и вторичных индексов целевой таблицы. Закрывает [#70602](https://github.com/ClickHouse/ClickHouse/issues/70602). [#70603](https://github.com/ClickHouse/ClickHouse/pull/70603) ([zwy991114](https://github.com/zwy991114)).
* Добавлен синтаксис ALTER USER `{ADD|MODIFY|DROP SETTING}`, ALTER USER `{ADD|DROP PROFILE}`, а также для ALTER ROLE и ALTER PROFILE. Теперь вместо замены всего набора настроек можно просто изменять его. [#72050](https://github.com/ClickHouse/ClickHouse/pull/72050) ([pufit](https://github.com/pufit)).
* Добавлена функция `arrayPRAUC`, которая вычисляет AUC (Area Under the Curve) для кривой Precision–Recall. [#72073](https://github.com/ClickHouse/ClickHouse/pull/72073) ([Emmanuel](https://github.com/emmanuelsdias)).
* Добавлена функция `indexOfAssumeSorted` для массивов. Оптимизирует поиск в случае массива, отсортированного в неубывающем порядке. Эффект заметен на очень больших массивах (более 100 000 элементов). [#72517](https://github.com/ClickHouse/ClickHouse/pull/72517) ([Eric Kurbanov](https://github.com/erickurbanov)).
* Добавлена возможность использовать разделитель в качестве необязательного второго аргумента агрегатной функции `groupConcat`. [#72540](https://github.com/ClickHouse/ClickHouse/pull/72540) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Функция `translate` теперь поддерживает удаление символов, если в аргументе `from` больше символов, чем в аргументе `to`. Пример: `SELECT translate('clickhouse', 'clickhouse', 'CLICK')` теперь возвращает `CLICK`. [#71441](https://github.com/ClickHouse/ClickHouse/pull/71441) ([shuai.xu](https://github.com/shuai-xu)).



#### Экспериментальные возможности {#experimental-features}
* Новый параметр движка MergeTree `allow_experimental_reverse_key`, который включает поддержку сортировки по убыванию в ключах сортировки MergeTree. Это полезно для анализа временных рядов, особенно для TopN-запросов. Пример использования: `ENGINE = MergeTree ORDER BY (time DESC, key)` — сортировка по убыванию для поля `time`. [#71095](https://github.com/ClickHouse/ClickHouse/pull/71095) ([Amos Bird](https://github.com/amosbird)).



#### Повышение производительности {#performance-improvement}

* Переупорядочивание JOIN. Добавлен параметр для выбора стороны соединения, которая будет использоваться как внутренняя (build) таблица в плане запроса. Это контролируется параметром `query_plan_join_swap_table`, который может быть установлен в значение `auto`. В этом режиме ClickHouse попытается выбрать таблицу с наименьшим количеством строк. [#71577](https://github.com/ClickHouse/ClickHouse/pull/71577) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Теперь алгоритм `parallel_hash` будет использоваться (если применимо), когда настройка `join_algorithm` имеет значение `default`. Две предыдущие альтернативы (`direct` и `hash`) по-прежнему будут использоваться, если `parallel_hash` не может быть применён. [#70788](https://github.com/ClickHouse/ClickHouse/pull/70788) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлена опция для извлечения общих выражений из выражений `WHERE` и `ON` с целью уменьшения количества хеш-таблиц, используемых при соединениях. Это имеет смысл, когда условие JOIN ON содержит общие части внутри операторов AND в разных ветках OR. Можно включить с помощью `optimize_extract_common_expressions = 1`. [#71537](https://github.com/ClickHouse/ClickHouse/pull/71537) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Позволяет использовать индексы в запросах `SELECT`, когда индексируемый столбец приводится к типу `LowCardinality(String)`, что может происходить при выполнении запроса по таблице Merge, где в одних таблицах столбец имеет тип `String`, а в других — `LowCardinality(String)`. [#71598](https://github.com/ClickHouse/ClickHouse/pull/71598) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Во время выполнения запроса с параллельными репликами и включённым локальным планом не выполняется анализ индексов на рабочих узлах. Координатор выберет диапазоны для чтения рабочими узлами на основе анализа индексов на своей стороне (на инициаторе запроса). Это позволяет коротким запросам с параллельными репликами иметь такую же низкую задержку, как и односерверные запросы. [#72109](https://github.com/ClickHouse/ClickHouse/pull/72109) ([Igor Nikonov](https://github.com/devcrafter)).
* Потребление памяти при выполнении команды `clickhouse disks remove --recursive` уменьшено для дисков объектного хранилища. [#67323](https://github.com/ClickHouse/ClickHouse/pull/67323) ([Kirill](https://github.com/kirillgarbar)).
* Вернули оптимизацию для чтения подколонок одного столбца в compact‑частях из [#57631](https://github.com/ClickHouse/ClickHouse/pull/57631). Она была удалена по ошибке. [#72285](https://github.com/ClickHouse/ClickHouse/pull/72285) ([Pavel Kruglov](https://github.com/Avogar)).
* Ускорена сортировка столбцов `LowCardinality(String)` за счёт девиртуализации вызовов в компараторе. [#72337](https://github.com/ClickHouse/ClickHouse/pull/72337) ([Alexander Gololobov](https://github.com/davenger)).
* Оптимизированы функции `argMin` и `argMax` для некоторых простых типов данных. [#72350](https://github.com/ClickHouse/ClickHouse/pull/72350) ([alesapin](https://github.com/alesapin)).
* Оптимизировано использование разделяемых блокировок в трекере памяти для уменьшения конкуренции за блокировки, что улучшает производительность на системах с очень большим числом CPU. [#72375](https://github.com/ClickHouse/ClickHouse/pull/72375) ([Jiebin Sun](https://github.com/jiebinn)).
* Добавлен новый параметр `use_async_executor_for_materialized_views`. Используется асинхронное и потенциально многопоточное выполнение запроса материализованного представления, что может ускорить обработку представлений во время INSERT, но при этом требует больше памяти. [#72497](https://github.com/ClickHouse/ClickHouse/pull/72497) ([alesapin](https://github.com/alesapin)).
* Улучшена производительность десериализации состояний агрегатных функций (в типе данных `AggregateFunction` и в распределённых запросах). Незначительно улучшена производительность разбора формата `RowBinary`. [#72818](https://github.com/ClickHouse/ClickHouse/pull/72818) ([Anton Popov](https://github.com/CurtizJ)).
* Разделяйте диапазоны при чтении с использованием параллельных реплик в порядке ключа таблицы, чтобы использовать меньше памяти при чтении. [#72173](https://github.com/ClickHouse/ClickHouse/pull/72173) ([JIaQi](https://github.com/JiaQiTang98)).
* Ускорены вставки в таблицы семейства MergeTree в случае единственного значения ключа партиционирования во вставляемом батче. [#72348](https://github.com/ClickHouse/ClickHouse/pull/72348) ([alesapin](https://github.com/alesapin)).
* Реализовано параллельное создание таблиц при восстановлении из резервной копии. До этого PR команда `RESTORE` всегда создавала таблицы в одном потоке, что могло значительно замедлять восстановление для резервных копий, содержащих множество таблиц. [#72427](https://github.com/ClickHouse/ClickHouse/pull/72427) ([Vitaly Baranov](https://github.com/vitlibar)).
* Сброс кэша меток может занять заметное время, если он большой. Если на это время мы удерживаем мьютекс контекста, это блокирует множество других операций — даже новые клиентские подключения не могут быть установлены, пока он не будет освобождён. При этом удерживать этот мьютекс на самом деле не требуется для синхронизации, достаточно иметь локальную ссылку на кэш через `shared_ptr`. [#72749](https://github.com/ClickHouse/ClickHouse/pull/72749) ([Alexander Gololobov](https://github.com/davenger)).





#### Улучшение {#improvement}

* Удалена настройка `allow_experimental_join_condition`, что по умолчанию разрешает условия JOIN не по равенству. [#69910](https://github.com/ClickHouse/ClickHouse/pull/69910) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Настройки из конфигурации сервера (users.xml) теперь применяются и на клиенте. Это полезно для параметров формата, например `date_time_output_format`. [#71178](https://github.com/ClickHouse/ClickHouse/pull/71178) ([Michael Kolupaev](https://github.com/al13n321)).
* Автоматическая выгрузка `GROUP BY`/`ORDER BY` на диск в зависимости от использования памяти сервером/пользователем. Управляется настройками запроса `max_bytes_ratio_before_external_group_by`/`max_bytes_ratio_before_external_sort`. [#71406](https://github.com/ClickHouse/ClickHouse/pull/71406) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена новая логика отмены запросов: `CancellationChecker` проверяет тайм-ауты для каждого запущенного запроса и останавливает их, как только время ожидания истекает. [#69880](https://github.com/ClickHouse/ClickHouse/pull/69880) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена поддержка `ALTER` из `Object` в `JSON`, что позволяет легко мигрировать с устаревшего типа `Object`. [#71784](https://github.com/ClickHouse/ClickHouse/pull/71784) ([Pavel Kruglov](https://github.com/Avogar)).
* Разрешить наличие в наборе неизвестных значений, отсутствующих в Enum. Исправление [#72662](https://github.com/ClickHouse/ClickHouse/issues/72662). [#72686](https://github.com/ClickHouse/ClickHouse/pull/72686) ([zhanglistar](https://github.com/zhanglistar)).
* Добавлена поддержка строкового оператора поиска (например, LIKE) для типа данных `Enum`, что реализует [#72661](https://github.com/ClickHouse/ClickHouse/issues/72661). [#72732](https://github.com/ClickHouse/ClickHouse/pull/72732) ([zhanglistar](https://github.com/zhanglistar)).
* Некоторые бессмысленные запросы ALTER USER успешно выполнялись. Исправлена проблема [#71227](https://github.com/ClickHouse/ClickHouse/issues/71227). [#71286](https://github.com/ClickHouse/ClickHouse/pull/71286) ([Arthur Passos](https://github.com/arthurpassos)).
* При построении плана для распределённого запроса `INSERT ... SELECT` учитывать `prefer_locahost_replica`. [#72190](https://github.com/ClickHouse/ClickHouse/pull/72190) ([filimonov](https://github.com/filimonov)).
* Azure нарушила спецификацию Iceberg, по ошибке пометив Iceberg v1 как Iceberg v2. Проблема [описана здесь](https://github.com/ClickHouse/ClickHouse/issues/72091). Azure Iceberg Writer создает файлы метаданных Iceberg (а также manifest-файлы), которые нарушают спецификацию. В результате мы пытаемся читать метаданные формата Iceberg v1 с помощью ридера формата v2 (так как они записываются именно в таком виде) и добавили генерацию ошибки, если в manifest-файле не созданы соответствующие поля. [#72277](https://github.com/ClickHouse/ClickHouse/pull/72277) ([Daniil Ivanik](https://github.com/divanik)).
* Теперь разрешено использовать `CREATE MATERIALIZED VIEW` с `UNION [ALL]` в запросе. Поведение такое же, как для материализованного представления с `JOIN`: только первая таблица в выражении `SELECT` будет работать как триггер для вставки, все остальные таблицы будут игнорироваться. Однако, если есть несколько обращений к первой таблице (например, `UNION` с самой собой), все они будут обработаны как единый вставленный блок данных. [#72347](https://github.com/ClickHouse/ClickHouse/pull/72347) ([alesapin](https://github.com/alesapin)).
* Добавлена проверка исходного запроса при использовании ClickHouse в качестве источника для словаря. [#72548](https://github.com/ClickHouse/ClickHouse/pull/72548) ([Alexey Katsman](https://github.com/alexkats)).
* Убедитесь, что ClickHouse будет учитывать изменения в ZooKeeper при перезагрузке конфигурации. [#72593](https://github.com/ClickHouse/ClickHouse/pull/72593) ([Azat Khuzhin](https://github.com/azat)).
* Улучшено приближённое вычисление объёма памяти, занимаемой кэшированными метками, для снижения общего потребления памяти кэшем. [#72630](https://github.com/ClickHouse/ClickHouse/pull/72630) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена новая метрика `StartupScriptsExecutionState`. Она может принимать три значения: 0 = скрипты инициализации ещё не завершили выполнение, 1 = скрипты инициализации выполнены успешно, 2 = выполнение скриптов инициализации завершилось с ошибкой. Эта метрика нужна, потому что нам необходимо знать, успешно ли выполняются скрипты инициализации в облаке, особенно после выпусков базовых конфигураций. [#72637](https://github.com/ClickHouse/ClickHouse/pull/72637) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Добавьте новую метрику `MergeTreeIndexGranularityInternalArraysTotalSize` в `system.metrics`. Эта метрика нужна для поиска экземпляров с очень большими наборами данных, подверженных высокой
* Добавлены повторные попытки при создании реплицируемых таблиц. [#72682](https://github.com/ClickHouse/ClickHouse/pull/72682) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлен `total_bytes_with_inactive` в `system.tables` для подсчёта суммарного объёма неактивных частей в байтах. [#72690](https://github.com/ClickHouse/ClickHouse/pull/72690) ([Kai Zhu](https://github.com/nauu)).
* Добавлены настройки MergeTree в `system.settings_changes`. [#72694](https://github.com/ClickHouse/ClickHouse/pull/72694) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлена поддержка типа JSON в функции `notEmpty`. [#72741](https://github.com/ClickHouse/ClickHouse/pull/72741) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена поддержка разбора ошибки GCS S3 `AuthenticationRequired`. [#72753](https://github.com/ClickHouse/ClickHouse/pull/72753) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена поддержка типа `Dynamic` в функциях `ifNull` и `coalesce`. [#72772](https://github.com/ClickHouse/ClickHouse/pull/72772) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена поддержка `Dynamic` в функциях `toFloat64`/`touInt32`/и т. д. [#72989](https://github.com/ClickHouse/ClickHouse/pull/72989) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлены настройки запросов к S3 `http_max_fields`, `http_max_field_name_size`, `http_max_field_value_size`, которые используются при разборе ответов API S3 во время создания или восстановления бэкапа. [#72778](https://github.com/ClickHouse/ClickHouse/pull/72778) ([Vitaly Baranov](https://github.com/vitlibar)).
* Удалять метаданные таблицы в Keeper для Storage S3(Azure)Queue только после удаления последней таблицы, использующей эти метаданные. [#72810](https://github.com/ClickHouse/ClickHouse/pull/72810) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлены события профилирования `JoinBuildTableRowCount`/`JoinProbeTableRowCount/JoinResultRowCount`. [#72842](https://github.com/ClickHouse/ClickHouse/pull/72842) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Поддержка подстолбцов в сортировочном ключе и пропускающих индексах MergeTree. [#72644](https://github.com/ClickHouse/ClickHouse/pull/72644) ([Pavel Kruglov](https://github.com/Avogar)).





#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release}

* Исправлена возможная проблема пересечения партов для MergeTree (после неудачной операции перемещения парта в каталог detached, возможно из‑за операции с объектным хранилищем). [#70476](https://github.com/ClickHouse/ClickHouse/pull/70476) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено определение ошибки, возникающей при слишком длинном имени таблицы. Добавлен диагностический вывод с указанием максимально допустимой длины. Добавлена новая функция `getMaxTableNameLengthForDatabase`. [#70810](https://github.com/ClickHouse/ClickHouse/pull/70810) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлены зомби-процессы после аварийного завершения работы программы `clickhouse-library-bridge` (эта программа позволяет запускать небезопасные библиотеки). [#71301](https://github.com/ClickHouse/ClickHouse/pull/71301) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Исправлена ошибка `NoSuchKey` при откате транзакции, возникавшая, когда не удавалось создать каталог для диска `plain_rewritable`. [#71439](https://github.com/ClickHouse/ClickHouse/pull/71439) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлена сериализация значений `Dynamic` в форматах JSON `Pretty`. [#71923](https://github.com/ClickHouse/ClickHouse/pull/71923) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлено сохранение автоматически определённого имени формата в запрос `CREATE` в движках `File`/`S3`/`URL`/`HDFS`/`Azure`. Ранее имя формата определялось заново при каждом перезапуске сервера, и если указанные файлы с данными были удалены, это приводило к ошибкам при запуске сервера. [#72108](https://github.com/ClickHouse/ClickHouse/pull/72108) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлены ошибки при использовании UDF в выражении JOIN ON со старым анализатором. [#72179](https://github.com/ClickHouse/ClickHouse/pull/72179) ([Raúl Marín](https://github.com/Algunenano)).
* Исправляет несколько мелких ошибок в `StorageObjectStorage`. Необходимо включить параметр `use_hive_partitioning` по умолчанию. [#72185](https://github.com/ClickHouse/ClickHouse/pull/72185) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена ошибка, из-за которой `min_age_to_force_merge_on_partition_only` застревал, многократно пытаясь объединить один и тот же раздел, который уже был слит в одну часть, и при этом не объединял разделы, содержащие несколько частей. [#72209](https://github.com/ClickHouse/ClickHouse/pull/72209) ([Christoph Wurm](https://github.com/cwurm)).
* Исправлена ошибка в `SimpleSquashingChunksTransform`, которая в редких случаях приводила к сбою при обработке разреженных столбцов. [#72226](https://github.com/ClickHouse/ClickHouse/pull/72226) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлена гонка данных в `GraceHashJoin`, вследствие которой некоторые строки могли отсутствовать в результате операции JOIN. [#72233](https://github.com/ClickHouse/ClickHouse/pull/72233) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлены запросы `ALTER DELETE` с материализованным столбцом `_block_number` (если включена настройка `enable_block_number_column`). [#72261](https://github.com/ClickHouse/ClickHouse/pull/72261) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена гонка данных при параллельных вызовах `ColumnDynamic::dumpStructure()`, например из конструктора `ConcurrentHashJoin`. [#72278](https://github.com/ClickHouse/ClickHouse/pull/72278) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена возможная ошибка `LOGICAL_ERROR` при наличии повторяющихся столбцов в `ORDER BY ... WITH FILL`. [#72387](https://github.com/ClickHouse/ClickHouse/pull/72387) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлены несоответствия типов в нескольких случаях после применения `optimize_functions_to_subcolumns`. [#72394](https://github.com/ClickHouse/ClickHouse/pull/72394) ([Anton Popov](https://github.com/CurtizJ)).
* Используйте `AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE` вместо `AWS_CONTAINER_AUTHORIZATION_TOKEN_PATH`. Исправлена проблема [#71074](https://github.com/ClickHouse/ClickHouse/issues/71074). [#72397](https://github.com/ClickHouse/ClickHouse/pull/72397) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлена ошибка при разборе запросов `BACKUP DATABASE db EXCEPT TABLES db.table`. [#72429](https://github.com/ClickHouse/ClickHouse/pull/72429) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Запрещено создавать пустой тип `Variant`. [#72454](https://github.com/ClickHouse/ClickHouse/pull/72454) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено некорректное форматирование `result_part_path` в `system.merges`. [#72567](https://github.com/ClickHouse/ClickHouse/pull/72567) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлен разбор glob-шаблона с одним элементом (например, `{file}`). [#72572](https://github.com/ClickHouse/ClickHouse/pull/72572) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлена генерация запроса для ведомого сервера в случае распределённого запроса с `ARRAY JOIN`. Исправляет [#69276](https://github.com/ClickHouse/ClickHouse/issues/69276). [#72608](https://github.com/ClickHouse/ClickHouse/pull/72608) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена ошибка, из-за которой выражение DateTime64 IN DateTime64 не возвращало результатов. [#72640](https://github.com/ClickHouse/ClickHouse/pull/72640) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлены неконсистентные метаданные при добавлении новой реплики в реплицируемую базу данных, содержащую таблицу, созданную с параметром `flatten_nested=0`. [#72685](https://github.com/ClickHouse/ClickHouse/pull/72685) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена расширенная конфигурация SSL для внутреннего обмена данными в Keeper. [#72730](https://github.com/ClickHouse/ClickHouse/pull/72730) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка «No such key» в режиме unordered для S3Queue при значении настройки `tracked_files_limit`, меньшем скорости появления файлов в S3. [#72738](https://github.com/ClickHouse/ClickHouse/pull/72738) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено исключение, возникающее в `RemoteQueryExecutor` при отсутствии локального пользователя. [#72759](https://github.com/ClickHouse/ClickHouse/pull/72759) ([Andrey Zvonov](https://github.com/zvonand)).
* Исправлены мутации с материализованным столбцом `_block_number` (если включена настройка `enable_block_number_column`). [#72854](https://github.com/ClickHouse/ClickHouse/pull/72854) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено резервное копирование и восстановление с использованием перезаписываемого диска Plain в случае, если в резервной копии есть пустые файлы. [#72858](https://github.com/ClickHouse/ClickHouse/pull/72858) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Корректная отмена вставок в DistributedAsyncInsertDirectoryQueue. [#72885](https://github.com/ClickHouse/ClickHouse/pull/72885) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено падение при разборе некорректных данных в разрежённые столбцы (может происходить при включённой настройке `enable_parsing_to_custom_serialization`). [#72891](https://github.com/ClickHouse/ClickHouse/pull/72891) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен потенциальный сбой при восстановлении резервной копии. [#72947](https://github.com/ClickHouse/ClickHouse/pull/72947) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка в методе JOIN `parallel_hash`, которая могла проявляться при выполнении запроса со сложным условием в предложении `ON` с фильтрами по неравенству. [#72993](https://github.com/ClickHouse/ClickHouse/pull/72993) ([Nikita Taranov](https://github.com/nickitat)).
* Используйте настройки формата по умолчанию при разборе JSON, чтобы избежать ошибок десериализации. [#73043](https://github.com/ClickHouse/ClickHouse/pull/73043) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлен сбой в транзакциях при использовании неподдерживаемого хранилища. [#73045](https://github.com/ClickHouse/ClickHouse/pull/73045) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена возможная переоценка потребления памяти (когда разница между `MemoryTracking` и `MemoryResident` продолжала расти). [#73081](https://github.com/ClickHouse/ClickHouse/pull/73081) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена проверка наличия дублирующихся ключей JSON при разборе Tuple. Ранее это могло приводить к возникновению логической ошибки `Invalid number of rows in Chunk` при разборе. [#73082](https://github.com/ClickHouse/ClickHouse/pull/73082) ([Pavel Kruglov](https://github.com/Avogar)).



#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement}
* Все небольшие утилиты, ранее хранившиеся в каталоге `/utils` и требовавшие ручной компиляции из исходников, теперь являются частью основного дистрибутива ClickHouse. Это закрывает [#72404](https://github.com/ClickHouse/ClickHouse/issues/72404). [#72426](https://github.com/ClickHouse/ClickHouse/pull/72426) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Отменено удаление `/etc/systemd/system/clickhouse-server.service`, добавленное в 22.3. [#39323](https://github.com/ClickHouse/ClickHouse/issues/39323). [#72259](https://github.com/ClickHouse/ClickHouse/pull/72259) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Разделены крупные единицы трансляции для предотвращения сбоев компиляции из-за ограничений по памяти/CPU. [#72352](https://github.com/ClickHouse/ClickHouse/pull/72352) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* OSX: Сборка с поддержкой ICU, что включает коллации, конвертацию наборов символов и другие возможности локализации. [#73083](https://github.com/ClickHouse/ClickHouse/pull/73083) ([Raúl Marín](https://github.com/Algunenano)).

### <a id="2411"></a> Релиз ClickHouse 24.11, 2024-11-26 {#a-id2411a-clickhouse-release-2411-2024-11-26}

#### Изменения, нарушающие обратную совместимость {#backward-incompatible-change-1}
* Удалены системные таблицы `generate_series` и `generateSeries`. Они были добавлены по ошибке здесь: [#59390](https://github.com/ClickHouse/ClickHouse/issues/59390). [#71091](https://github.com/ClickHouse/ClickHouse/pull/71091) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Удалён `StorageExternalDistributed`. Закрывает [#70600](https://github.com/ClickHouse/ClickHouse/issues/70600). [#71176](https://github.com/ClickHouse/ClickHouse/pull/71176) ([flynn](https://github.com/ucasfl)).
* Движки таблиц Kafka, NATS и RabbitMQ теперь покрываются собственными правами в иерархии `SOURCES`. Добавьте соответствующие привилегии всем пользователям баз данных, отличных от базы данных по умолчанию, которые создают таблицы с этими типами движков. [#71250](https://github.com/ClickHouse/ClickHouse/pull/71250) ([Christoph Wurm](https://github.com/cwurm)).
* Полный запрос мутации теперь проверяется перед выполнением (включая подзапросы). Это предотвращает случайный запуск некорректного запроса и накопление «мёртвых» мутаций, блокирующих корректные мутации. [#71300](https://github.com/ClickHouse/ClickHouse/pull/71300) ([Christoph Wurm](https://github.com/cwurm)).
* Переименована настройка кеша файловой системы `skip_download_if_exceeds_query_cache` в `filesystem_cache_skip_download_if_exceeds_per_query_cache_write_limit`. [#71578](https://github.com/ClickHouse/ClickHouse/pull/71578) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Удалена поддержка аргументов типов `Enum`, а также `UInt128` и `UInt256` в `deltaSumTimestamp`. Удалена поддержка типов `Int8`, `UInt8`, `Int16` и `UInt16` для второго («timestamp») аргумента `deltaSumTimestamp`. [#71790](https://github.com/ClickHouse/ClickHouse/pull/71790) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* При получении данных непосредственно из словаря с использованием хранилища Dictionary, табличной функции словаря или прямого SELECT по самому словарю теперь достаточно иметь привилегию `SELECT` или `dictGet` для этого словаря. Это согласуется с предыдущими попытками предотвратить обход ACL: https://github.com/ClickHouse/ClickHouse/pull/57362 и https://github.com/ClickHouse/ClickHouse/pull/65359. Это также делает второе из них обратно совместимым. [#72051](https://github.com/ClickHouse/ClickHouse/pull/72051) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).



#### Экспериментальная функция {#experimental-feature}
* Реализован `allow_feature_tier` как глобальный переключатель для отключения всех экспериментальных / бета‑функций. [#71841](https://github.com/ClickHouse/ClickHouse/pull/71841) [#71145](https://github.com/ClickHouse/ClickHouse/pull/71145) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена возможная ошибка `No such file or directory`, возникающая из‑за неэкранированных специальных символов в файлах для подстолбцов JSON. [#71182](https://github.com/ClickHouse/ClickHouse/pull/71182) ([Pavel Kruglov](https://github.com/Avogar)).
* Добавлена поддержка ALTER типа с String на JSON. Этот PR также изменяет сериализацию типов JSON и Dynamic на новую версию V2. Старая версия V1 по‑прежнему может использоваться при включении настройки `merge_tree_use_v1_object_and_dynamic_serialization` (её можно использовать во время обновления, чтобы при необходимости откатить версию без проблем). [#70442](https://github.com/ClickHouse/ClickHouse/pull/70442) ([Pavel Kruglov](https://github.com/Avogar)).
* Реализован простой CAST из Map/Tuple/Object в новый JSON через сериализацию/десериализацию из JSON‑строки. [#71320](https://github.com/ClickHouse/ClickHouse/pull/71320) ([Pavel Kruglov](https://github.com/Avogar)).
* По умолчанию запрещено использовать типы Variant/Dynamic в ORDER BY/GROUP BY/PARTITION BY/PRIMARY KEY, так как это может приводить к неожиданным результатам. [#69731](https://github.com/ClickHouse/ClickHouse/pull/69731) ([Pavel Kruglov](https://github.com/Avogar)).
* Запрещено использовать типы Dynamic/Variant в функциях min/max во избежание путаницы. [#71761](https://github.com/ClickHouse/ClickHouse/pull/71761) ([Pavel Kruglov](https://github.com/Avogar)).

#### Новая функциональность {#new-feature-1}
* Добавлен SQL‑синтаксис для описания управления нагрузкой и ресурсами. https://clickhouse.com/docs/operations/workload-scheduling. [#69187](https://github.com/ClickHouse/ClickHouse/pull/69187) ([Sergei Trifonov](https://github.com/serxa)).
* Новый тип данных `BFloat16` представляет 16‑разрядные числа с плавающей запятой с 8‑битным показателем степени, знаком и 7‑битной мантиссой. Это закрывает [#44206](https://github.com/ClickHouse/ClickHouse/issues/44206). Это закрывает [#49937](https://github.com/ClickHouse/ClickHouse/issues/49937). [#64712](https://github.com/ClickHouse/ClickHouse/pull/64712) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен запрос `CHECK GRANT` для проверки, были ли текущему пользователю/роли выданы конкретные привилегии и существует ли соответствующая таблица/столбец в памяти. [#68885](https://github.com/ClickHouse/ClickHouse/pull/68885) ([Unalian](https://github.com/Unalian)).
* Добавлены табличные функции `iceberg[S3;HDFS;Azure]Cluster`, `deltaLakeCluster`, `hudiCluster`. [#72045](https://github.com/ClickHouse/ClickHouse/pull/72045) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Добавлена возможность задавать имя пользователя/пароль в http_handlers (для `dynamic_query_handler`/`predefined_query_handler`). [#70725](https://github.com/ClickHouse/ClickHouse/pull/70725) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка клаузы STALENESS в операторе ORDER BY WITH FILL. [#71151](https://github.com/ClickHouse/ClickHouse/pull/71151) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Разрешено задавать для каждого метода аутентификации собственный срок действия; при этом срок действия удалён из сущности пользователя. [#70090](https://github.com/ClickHouse/ClickHouse/pull/70090) ([Arthur Passos](https://github.com/arthurpassos)).
* Добавлены новые функции `parseDateTime64`, `parseDateTime64OrNull` и `parseDateTime64OrZero`. По сравнению с существующей функцией `parseDateTime` (и её вариантами) они возвращают значение типа `DateTime64` вместо `DateTime`. [#71581](https://github.com/ClickHouse/ClickHouse/pull/71581) ([kevinyhzou](https://github.com/KevinyhZou)).



#### Повышение производительности {#performance-improvement-1}

* Оптимизировано использование памяти для значений гранулярности индекса, если гранулярность постоянна для парта. Добавлена возможность всегда выбирать постоянную гранулярность для парта (настройка `use_const_adaptive_granularity`), что помогает гарантировать, что она всегда оптимально используется в памяти. Это помогает при больших нагрузках (триллионы строк в общем хранилище) избежать постоянного роста расхода памяти на метаданные (значения гранулярности индекса) партов данных. [#71786](https://github.com/ClickHouse/ClickHouse/pull/71786) ([Anton Popov](https://github.com/CurtizJ)).
* Теперь мы не копируем столбцы входных блоков для `join_algorithm = 'parallel_hash'` при распределении их между потоками для параллельной обработки. [#67782](https://github.com/ClickHouse/ClickHouse/pull/67782) ([Nikita Taranov](https://github.com/nickitat)).
* Оптимизирован алгоритм слияния `Replacing` для непересекающихся частей данных. [#70977](https://github.com/ClickHouse/ClickHouse/pull/70977) ([Anton Popov](https://github.com/CurtizJ)).
* Не перечислять отсоединённые части с дисков `readonly` и `write-once` в метриках и в `system.detached_parts`. [#71086](https://github.com/ClickHouse/ClickHouse/pull/71086) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* По умолчанию не вычислять тяжелые асинхронные метрики. Функция была добавлена в [#40332](https://github.com/ClickHouse/ClickHouse/issues/40332), но нецелесообразно держать ресурсоемкую фоновую задачу, которая требуется только одному клиенту. [#71087](https://github.com/ClickHouse/ClickHouse/pull/71087) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Для дисков `plain_rewritable` не вызывайте API объектного хранилища при перечислении каталогов, так как это может быть неэффективно по затратам. Вместо этого храните список имён файлов в памяти. Компромисс — увеличенное время начальной загрузки и больший объём памяти, необходимый для хранения имён файлов. [#70823](https://github.com/ClickHouse/ClickHouse/pull/70823) ([Julia Kartseva](https://github.com/jkartseva)).
* Улучшены производительность и точность интервала сбора данных в `system.query_metric_log` путём уменьшения критической области. [#71473](https://github.com/ClickHouse/ClickHouse/pull/71473) ([Pablo Marcos](https://github.com/pamarcos)).
* Оптимизация последовательного чтения с помощью генерации виртуальных строк, что позволяет при сортировке слиянием считывать меньше данных; особенно полезно при наличии нескольких частей. [#62125](https://github.com/ClickHouse/ClickHouse/pull/62125) ([Shichao Jin](https://github.com/jsc0218)).
* Добавлена настройка сервера `async_load_system_database`, которая позволяет запускать сервер при неполностью загруженной системной базе данных. Это помогает запускать ClickHouse быстрее, если в системе много системных таблиц. [#69847](https://github.com/ClickHouse/ClickHouse/pull/69847) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлен параметр `--threads` для `clickhouse-compressor`, позволяющий выполнять сжатие данных в параллельном режиме. [#70860](https://github.com/ClickHouse/ClickHouse/pull/70860) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена настройка `prewarm_mark_cache`, которая включает предварительную загрузку меток в кэш меток при вставках, слияниях, загрузках частей и при запуске таблицы. [#71053](https://github.com/ClickHouse/ClickHouse/pull/71053) ([Anton Popov](https://github.com/CurtizJ)).
* Сокращён размер размещаемого в памяти массива index&#95;granularity, чтобы уменьшить потребление памяти семейством движков таблиц MergeTree. [#71595](https://github.com/ClickHouse/ClickHouse/pull/71595) ([alesapin](https://github.com/alesapin)).
* Отключена настройка файлового кеша `boundary_alignment` для операций чтения, не выполняемых с диска, что улучшает производительность чтения отдельных удалённых файлов с кешированием. [#71827](https://github.com/ClickHouse/ClickHouse/pull/71827) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Запросы вида `SELECT * FROM table LIMIT ...` приводили к загрузке индексов частей, хотя они при этом не использовались. [#71866](https://github.com/ClickHouse/ClickHouse/pull/71866) ([Alexander Gololobov](https://github.com/davenger)).
* `parallel_replicas_local_plan` включён по умолчанию. Построение полноценного локального плана на инициаторе запроса улучшает производительность параллельных реплик при меньшем расходе ресурсов и даёт больше возможностей для оптимизации запросов. [#70171](https://github.com/ClickHouse/ClickHouse/pull/70171) ([Igor Nikonov](https://github.com/devcrafter)).





#### Улучшение {#improvement-1}

* Добавлена возможность использовать clickhouse с файловым аргументом, например `ch queries.sql`. [#71589](https://github.com/ClickHouse/ClickHouse/pull/71589) ([Raúl Marín](https://github.com/Algunenano)).
* Формат `Vertical` (который также активируется, если завершить запрос на `\G`) получает возможности форматов Pretty, такие как: - подсветка групп разрядов в числах; - вывод удобочитаемой подсказки по числу. [#71630](https://github.com/ClickHouse/ClickHouse/pull/71630) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Передавать внешние пользовательские роли от инициатора запроса на другие узлы кластера. Это полезно, когда только инициатор имеет доступ к внешнему аутентификатору (например, LDAP). [#70332](https://github.com/ClickHouse/ClickHouse/pull/70332) ([Andrey Zvonov](https://github.com/zvonand)).
* Добавлены псевдонимы `anyRespectNulls`, `firstValueRespectNulls` и `anyValueRespectNulls` для агрегатной функции `any`. Также добавлены псевдонимы `anyLastRespectNulls` и `lastValueRespectNulls` для агрегатной функции `anyLast`. Это позволяет использовать более естественный синтаксис в стиле camelCase вместо смешанного camelCase/underscore, например: `SELECT anyLastRespectNullsStateIf` вместо `anyLast_respect_nullsStateIf`. [#71403](https://github.com/ClickHouse/ClickHouse/pull/71403) ([Peter Nguyen](https://github.com/petern48)).
* Добавлен параметр конфигурации `date_time_utc`, который позволяет формату JSON-логов использовать дату и время в UTC в формате RFC 3339/ISO8601. [#71560](https://github.com/ClickHouse/ClickHouse/pull/71560) ([Ali](https://github.com/xogoodnow)).
* Добавлен новый тип заголовка для S3-эндпоинтов для аутентификации пользователей (`access_header`). Это позволяет задать заголовок доступа с наименьшим приоритетом, который будет переопределён значением `access_key_id` из любого другого источника (например, схемы таблицы или именованной коллекции). [#71011](https://github.com/ClickHouse/ClickHouse/pull/71011) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Функции высшего порядка с константными массивами и константными захваченными аргументами будут возвращать константные значения. [#58400](https://github.com/ClickHouse/ClickHouse/pull/58400) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Имена шагов плана запроса (`EXPLAIN PLAN json=1`) и имена процессоров конвейера (`EXPLAIN PIPELINE compact=0,graph=1`) теперь имеют уникальный идентификатор в качестве суффикса. Это позволяет сопоставлять вывод профилировщика процессоров и трассы OpenTelemetry с выводом команды EXPLAIN. [#63518](https://github.com/ClickHouse/ClickHouse/pull/63518) ([qhsong](https://github.com/qhsong)).
* Добавлена возможность проверки наличия объекта после записи его в Azure Blob Storage; это настраивается с помощью параметра `check_objects_after_upload`. [#64847](https://github.com/ClickHouse/ClickHouse/pull/64847) ([Smita Kulkarni](https://github.com/SmitaRKulkarni)).
* По умолчанию использовать базу данных `Atomic` в `clickhouse-local`. Решает пункты 1 и 5 из [#50647](https://github.com/ClickHouse/ClickHouse/issues/50647). Закрывает [#44817](https://github.com/ClickHouse/ClickHouse/issues/44817). [#68024](https://github.com/ClickHouse/ClickHouse/pull/68024) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исключения нарушают протокол HTTP для уведомления клиента об ошибке. [#68800](https://github.com/ClickHouse/ClickHouse/pull/68800) ([Sema Checherinda](https://github.com/CheSema)).
* Сообщать о хостах, выполняющих распределённые DDL-запросы, создавая replica&#95;dir и помечая реплики активными в DDLWorker. [#69658](https://github.com/ClickHouse/ClickHouse/pull/69658) ([tuanpach](https://github.com/tuanpach)).
* Ожидать выполнения только на активных репликах для запросов к базе данных с директивой ON CLUSTER, если distributed&#95;ddl&#95;output&#95;mode установлен в значение *&#95;only&#95;active. [#69660](https://github.com/ClickHouse/ClickHouse/pull/69660) ([tuanpach](https://github.com/tuanpach)).
* Улучшена обработка ошибок и отмена `ON CLUSTER` для бэкапов и восстановлений: - Если бэкап или восстановление завершается с ошибкой на одном хосте, эта операция будет автоматически отменена на других хостах - Не должно возникать странных ошибок из‑за того, что некоторые хосты завершились ошибкой, пока другие продолжали работу - Если бэкап или восстановление отменяется на одном хосте, эта операция будет автоматически отменена на других хостах - Исправлены проблемы с `test_disallow_concurrency` — теперь запрет параллельного выполнения должен работать лучше - Бэкапы и восстановления теперь гораздо более устойчивы к отключениям ZooKeeper. [#70027](https://github.com/ClickHouse/ClickHouse/pull/70027) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена поддержка `ALTER TABLE ... MODIFY/RESET SETTING ...` для некоторых настроек в хранилище S3Queue. [#70811](https://github.com/ClickHouse/ClickHouse/pull/70811) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена возможность перезагружать клиентские сертификаты по аналогии с процедурой перезагрузки серверных сертификатов. [#70997](https://github.com/ClickHouse/ClickHouse/pull/70997) ([Roman Antonov](https://github.com/Romeo58rus)).
* Сделать настраиваемым размер истории клиента и увеличить его значение по умолчанию. [#71014](https://github.com/ClickHouse/ClickHouse/pull/71014) ([Jiří Kozlovský](https://github.com/jirislav)).
* Поддержка булевых типов для нативного считывателя формата Parquet. [#71055](https://github.com/ClickHouse/ClickHouse/pull/71055) ([Arthur Passos](https://github.com/arthurpassos)).
* Повторять запросы при большем числе ошибок при работе с S3, например «Malformed message». [#71088](https://github.com/ClickHouse/ClickHouse/pull/71088) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Снижен уровень логирования для некоторых сообщений о S3. [#71090](https://github.com/ClickHouse/ClickHouse/pull/71090) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка записи файлов HDFS, имена которых содержат пробелы. [#71105](https://github.com/ClickHouse/ClickHouse/pull/71105) ([exmy](https://github.com/exmy)).
* Добавлены настройки, ограничивающие количество реплицируемых таблиц, словарей и представлений. [#71179](https://github.com/ClickHouse/ClickHouse/pull/71179) ([Kirill](https://github.com/kirillgarbar)).
* Используйте `AWS_CONTAINER_AUTHORIZATION_TOKEN_FILE` вместо `AWS_CONTAINER_AUTHORIZATION_TOKEN`, если он доступен. Исправляет [#71074](https://github.com/ClickHouse/ClickHouse/issues/71074). [#71269](https://github.com/ClickHouse/ClickHouse/pull/71269) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Удалить логику создания узла ZooKeeper `metadata_version` из потока перезапуска ReplicatedMergeTree. Единственный сценарий, когда нам нужно создавать этот узел, — если пользователь обновился с версии более ранней, чем 20.4, сразу на версию позже 24.10. ClickHouse не поддерживает обновления, между которыми проходит более года, поэтому вместо создания узла следует выбросить исключение и попросить пользователя обновляться поэтапно. [#71385](https://github.com/ClickHouse/ClickHouse/pull/71385) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Добавлены дашборды для каждого хоста `Overview (host)` и `Cloud overview (host)` в расширенный дашборд. [#71422](https://github.com/ClickHouse/ClickHouse/pull/71422) ([alesapin](https://github.com/alesapin)).
* `clickhouse-local` по умолчанию использует неявный SELECT, что позволяет использовать его как калькулятор. Улучшена подсветка синтаксиса для режима неявного SELECT. [#71620](https://github.com/ClickHouse/ClickHouse/pull/71620) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Приложения командной строки будут подсвечивать синтаксис даже для запросов с несколькими операторами. [#71622](https://github.com/ClickHouse/ClickHouse/pull/71622) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Консольные приложения будут завершаться с ненулевым кодом выхода при ошибках. В предыдущих версиях приложение `disks` завершалось с нулевым кодом при ошибках, а другие приложения возвращали нулевой код для ошибок 256 (`PARTITION_ALREADY_EXISTS`) и 512 (`SET_NON_GRANTED_ROLE`). [#71623](https://github.com/ClickHouse/ClickHouse/pull/71623) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Если пользователь/группа указываются по ID, `clickhouse su` завершается с ошибкой. Этот патч исправляет это и позволяет также принимать значения вида `UID:GID`. [#71626](https://github.com/ClickHouse/ClickHouse/pull/71626) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Добавлена возможность отключать увеличение буфера памяти для файлового кэша с помощью настройки `filesystem_cache_prefer_bigger_buffer_size`. [#71640](https://github.com/ClickHouse/ClickHouse/pull/71640) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена отдельная настройка `background_download_max_file_segment_size` для задания максимального размера сегмента файла при фоновой загрузке в файловый кэш. [#71648](https://github.com/ClickHouse/ClickHouse/pull/71648) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Немного улучшен разбор типов JSON: если текущий блок для JSON-пути содержит значения нескольких типов, пытаемся выбрать наиболее подходящий тип, перебирая типы в специальном эвристическом порядке. [#71785](https://github.com/ClickHouse/ClickHouse/pull/71785) ([Pavel Kruglov](https://github.com/Avogar)).
* Ранее чтение из `system.asynchronous_metrics` ожидало завершения параллельного обновления. Это может занимать много времени, если система находится под высокой нагрузкой. Благодаря этому изменению ранее собранные значения теперь всегда можно прочитать. [#71798](https://github.com/ClickHouse/ClickHouse/pull/71798) ([Alexander Gololobov](https://github.com/davenger)).
* S3Queue и AzureQueue: установите значение `polling_max_timeout_ms` равным 10 минутам, а `polling_backoff_ms` — 30 секундам. [#71817](https://github.com/ClickHouse/ClickHouse/pull/71817) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Обновлять `HostResolver` три раза в течение периода `history`. [#71863](https://github.com/ClickHouse/ClickHouse/pull/71863) ([Sema Checherinda](https://github.com/CheSema)).
* На HTML-страницу расширенного дашборда добавлен выпадающий список для выбора дашборда из таблицы `system.dashboards`. [#72081](https://github.com/ClickHouse/ClickHouse/pull/72081) ([Sergei Trifonov](https://github.com/serxa)).
* Проверяется наличие базы данных по умолчанию после авторизации. Исправляет [#71097](https://github.com/ClickHouse/ClickHouse/issues/71097). [#71140](https://github.com/ClickHouse/ClickHouse/pull/71140) ([Konstantin Bogdanov](https://github.com/thevar1able)).





#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-1}

* Части, дедуплицированные при выполнении запроса `ATTACH PART`, больше не остаются с префиксом `attaching_`. [#65636](https://github.com/ClickHouse/ClickHouse/pull/65636) ([Kirill](https://github.com/kirillgarbar)).
* Исправлена ошибка, из-за которой тип `DateTime64` терял точность в функции `IN`. [#67230](https://github.com/ClickHouse/ClickHouse/pull/67230) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена потенциальная логическая ошибка при использовании функций с `IGNORE/RESPECT NULLS` в `ORDER BY ... WITH FILL`, закрыт [#57609](https://github.com/ClickHouse/ClickHouse/issues/57609). [#68234](https://github.com/ClickHouse/ClickHouse/pull/68234) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлены редкие логические ошибки в асинхронных вставках с форматом `Native` при превышении лимита памяти. [#68965](https://github.com/ClickHouse/ClickHouse/pull/68965) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен COMMENT в CREATE TABLE для столбца EPHEMERAL. [#70458](https://github.com/ClickHouse/ClickHouse/pull/70458) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена логическая ошибка в функции JSONExtract с LowCardinality(Nullable). [#70549](https://github.com/ClickHouse/ClickHouse/pull/70549) ([Pavel Kruglov](https://github.com/Avogar)).
* Разрешить выполнение команды system drop replica zkpath, если существует другая реплика с тем же zk path. [#70642](https://github.com/ClickHouse/ClickHouse/pull/70642) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Исправлены падение и утечка памяти в AggregateFunctionGroupArraySorted. [#70820](https://github.com/ClickHouse/ClickHouse/pull/70820) ([Michael Kolupaev](https://github.com/al13n321)).
* Добавлена возможность переопределять Content-Type с помощью пользовательских заголовков в движке URL. [#70859](https://github.com/ClickHouse/ClickHouse/pull/70859) ([Artem Iurin](https://github.com/ortyomka)).
* Исправлена логическая ошибка в `StorageS3Queue` («Cannot create a persistent node in /processed since it already exists»). [#70984](https://github.com/ClickHouse/ClickHouse/pull/70984) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проблема, из-за которой именованные сессии в некоторых случаях не закрывались и зависали. [#70998](https://github.com/ClickHouse/ClickHouse/pull/70998) ([Márcio Martins](https://github.com/marcio-absmartly)).
* Исправлена ошибка, из-за которой столбец &#95;row&#95;exists не учитывался в параметре rebuild операции lightweight delete для проекций. [#71089](https://github.com/ClickHouse/ClickHouse/pull/71089) ([Shichao Jin](https://github.com/jsc0218)).
* Исправлена ошибка `AT_* is out of range` при запуске на Oracle Linux UEK 6.10. [#71109](https://github.com/ClickHouse/ClickHouse/pull/71109) ([Örjan Fors](https://github.com/op)).
* Исправлено неверное значение в system.query&#95;metric&#95;log из-за неожиданного состояния гонки. [#71124](https://github.com/ClickHouse/ClickHouse/pull/71124) ([Pablo Marcos](https://github.com/pamarcos)).
* Исправлено несоответствие в имени агрегатной функции quantileExactWeightedInterpolated. Ошибка появилась в [https://github.com/ClickHouse/ClickHouse/pull/69619](https://github.com/ClickHouse/ClickHouse/pull/69619). cc @Algunenano. [#71168](https://github.com/ClickHouse/ClickHouse/pull/71168) ([李扬](https://github.com/taiyang-li)).
* Исправлена ошибка bad&#95;weak&#95;ptr при использовании Dynamic при сравнении функций. [#71183](https://github.com/ClickHouse/ClickHouse/pull/71183) ([Pavel Kruglov](https://github.com/Avogar)).
* Проверки чтения файла 7z выполняются на локальной машине. [#71184](https://github.com/ClickHouse/ClickHouse/pull/71184) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлено игнорирование настроек формата при использовании формата Native по HTTP и при Async Inserts. [#71193](https://github.com/ClickHouse/ClickHouse/pull/71193) ([Pavel Kruglov](https://github.com/Avogar)).
* Запросы SELECT с настройкой `use_query_cache = 1` больше не отклоняются, если имя системной таблицы указано как литерал, например `SELECT * FROM users WHERE name = 'system.metrics' SETTINGS use_query_cache = true;` теперь выполняется. [#71254](https://github.com/ClickHouse/ClickHouse/pull/71254) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена ошибка увеличения потребления памяти при включённом `enable_filesystem_cache=1`, если диск в конфигурации хранилища не имел настроек кэша. [#71261](https://github.com/ClickHouse/ClickHouse/pull/71261) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена возможная ошибка «Cannot read all data» при десериализации словаря LowCardinality из колонки типа Dynamic. [#71299](https://github.com/ClickHouse/ClickHouse/pull/71299) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена неполная очистка формата параллельного вывода в клиенте. [#71304](https://github.com/ClickHouse/ClickHouse/pull/71304) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлена недостающая операция обратного экранирования в именованных коллекциях. Без этого исправления clickhouse-server не может запуститься. [#71308](https://github.com/ClickHouse/ClickHouse/pull/71308) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Исправлена проблема с асинхронными вставками с пустыми блоками через нативный протокол. [#71312](https://github.com/ClickHouse/ClickHouse/pull/71312) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено непоследовательное форматирование AST при выдаче некорректных грантов с подстановочными символами [#71309](https://github.com/ClickHouse/ClickHouse/issues/71309). [#71332](https://github.com/ClickHouse/ClickHouse/pull/71332) ([pufit](https://github.com/pufit)).
* Добавлены блоки try/catch в деструкторы частей данных для предотвращения вызова std::terminate. [#71364](https://github.com/ClickHouse/ClickHouse/pull/71364) ([alesapin](https://github.com/alesapin)).
* Проверять подозрительные и экспериментальные типы в подсказках типов JSON. [#71369](https://github.com/ClickHouse/ClickHouse/pull/71369) ([Pavel Kruglov](https://github.com/Avogar)).
* Запускать рабочий поток управления памятью и на операционных системах, отличных от Linux (исправляет [#71051](https://github.com/ClickHouse/ClickHouse/issues/71051)). [#71384](https://github.com/ClickHouse/ClickHouse/pull/71384) ([Alexandre Snarskii](https://github.com/snar)).
* Исправлена ошибка: «Invalid number of rows in Chunk with the Variant column». [#71388](https://github.com/ClickHouse/ClickHouse/pull/71388) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка «column &quot;attgenerated&quot; does not exist» в старых версиях PostgreSQL, исправление для [#60651](https://github.com/ClickHouse/ClickHouse/issues/60651). [#71396](https://github.com/ClickHouse/ClickHouse/pull/71396) ([0xMihalich](https://github.com/0xMihalich)).
* Чтобы не засорять логи сервера, неудачные попытки аутентификации теперь логируются с уровнем `DEBUG` вместо `ERROR`. [#71405](https://github.com/ClickHouse/ClickHouse/pull/71405) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена ошибка, приводившая к аварийному завершению работы табличной функции `mongodb` при передаче некорректных аргументов (например, `NULL`). [#71426](https://github.com/ClickHouse/ClickHouse/pull/71426) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлен сбой, связанный с optimize&#95;rewrite&#95;array&#95;exists&#95;to&#95;has. [#71432](https://github.com/ClickHouse/ClickHouse/pull/71432) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено использование настройки `max_insert_delayed_streams_for_parallel_write` во вставках. Ранее она работала некорректно, что могло приводить к высокому потреблению памяти при вставках, записывающих данные в несколько партиций. [#71474](https://github.com/ClickHouse/ClickHouse/pull/71474) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена возможная ошибка `Argument for function must be constant` (в старом анализаторе) в случае, когда arrayJoin может появляться в условии `WHERE`. Регрессия, появившаяся после [https://github.com/ClickHouse/ClickHouse/pull/65414](https://github.com/ClickHouse/ClickHouse/pull/65414). [#71476](https://github.com/ClickHouse/ClickHouse/pull/71476) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Предотвращено аварийное завершение SortCursor при нулевом числе столбцов (старый анализатор). [#71494](https://github.com/ClickHouse/ClickHouse/pull/71494) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена ошибка выхода значения Date32 за допустимый диапазон, вызванная неинициализированными данными ORC. Для получения дополнительной информации см. [https://github.com/apache/incubator-gluten/issues/7823](https://github.com/apache/incubator-gluten/issues/7823). [#71500](https://github.com/ClickHouse/ClickHouse/pull/71500) ([李扬](https://github.com/taiyang-li)).
* Исправлен расчет размера столбца в широких партах для типов Dynamic и JSON. [#71526](https://github.com/ClickHouse/ClickHouse/pull/71526) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправление работы анализатора для случая, когда запрос внутри материализованного представления использует оператор IN с CTE. Закрывает [#65598](https://github.com/ClickHouse/ClickHouse/issues/65598). [#71538](https://github.com/ClickHouse/ClickHouse/pull/71538) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлено падение при использовании UDF в ограничении. [#71541](https://github.com/ClickHouse/ClickHouse/pull/71541) ([Raúl Marín](https://github.com/Algunenano)).
* Функции bitShift при выходе за пределы возвращают 0 или символ по умолчанию вместо выбрасывания ошибки. [#71580](https://github.com/ClickHouse/ClickHouse/pull/71580) ([Pablo Marcos](https://github.com/pamarcos)).
* Исправлены сбои сервера при использовании материализованного представления с отдельными движками. [#71593](https://github.com/ClickHouse/ClickHouse/pull/71593) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Операция ARRAY JOIN с вложенной структурой данных, содержащей алиас на константный массив, приводила к разыменованию нулевого указателя. Это закрывает [#71677](https://github.com/ClickHouse/ClickHouse/issues/71677). [#71678](https://github.com/ClickHouse/ClickHouse/pull/71678) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена LOGICAL&#95;ERROR при выполнении операции ALTER с пустым кортежем. Это устраняет [#71647](https://github.com/ClickHouse/ClickHouse/issues/71647). [#71679](https://github.com/ClickHouse/ClickHouse/pull/71679) ([Amos Bird](https://github.com/amosbird)).
* Не преобразовывать множество констант в предикатах по столбцам партиционирования при использовании оператора NOT IN. [#71695](https://github.com/ClickHouse/ClickHouse/pull/71695) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлено сообщение в журнале при сбое init-скрипта Docker, чтобы оно было более понятным. [#71734](https://github.com/ClickHouse/ClickHouse/pull/71734) ([Андрей](https://github.com/andreineustroev)).
* Исправлена операция CAST из LowCardinality(Nullable) в Dynamic. Ранее это могло приводить к ошибке `Bad cast from type DB::ColumnVector<int> to DB::ColumnNullable`. [#71742](https://github.com/ClickHouse/ClickHouse/pull/71742) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено исключение, возникавшее при использовании `toDayOfWeek` в условии WHERE для первичного ключа типа `DateTime64`. [#71849](https://github.com/ClickHouse/ClickHouse/pull/71849) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлено заполнение значений по умолчанию после парсинга в разрежённые столбцы. [#71854](https://github.com/ClickHouse/ClickHouse/pull/71854) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка функции GROUPING при использовании ALIAS в качестве входного выражения в распределённой таблице, закрыт [#68602](https://github.com/ClickHouse/ClickHouse/issues/68602). [#71855](https://github.com/ClickHouse/ClickHouse/pull/71855) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Устранён возможный сбой при использовании `allow_experimental_join_condition`, закрыт [#71693](https://github.com/ClickHouse/ClickHouse/issues/71693). [#71857](https://github.com/ClickHouse/ClickHouse/pull/71857) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлены операторы SELECT с предложением `WITH TIES`, которые могли возвращать недостаточное число строк. [#71886](https://github.com/ClickHouse/ClickHouse/pull/71886) ([wxybear](https://github.com/wxybear)).
* Исправлено исключение TOO&#95;LARGE&#95;ARRAY&#95;SIZE, возникавшее, когда при вычислении столбца arrayWithConstant ошибочно считалось, что превышен предел размера массива. [#71894](https://github.com/ClickHouse/ClickHouse/pull/71894) ([Udi](https://github.com/udiz)).
* `clickhouse-benchmark` показывал некорректные метрики для запросов, выполнение которых занимало более одной секунды. [#71898](https://github.com/ClickHouse/ClickHouse/pull/71898) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Устранена гонка данных между индикатором прогресса и таблицей прогресса в clickhouse-client. Эта проблема проявляется при использовании FROM INFILE. Теперь во время запросов INSERT перехватываются нажатия клавиш для переключения отображения таблицы прогресса. [#71901](https://github.com/ClickHouse/ClickHouse/pull/71901) ([Julia Kartseva](https://github.com/jkartseva)).
* Используйте вспомогательные Keeper‑узлы для автоматического обнаружения кластера. [#71911](https://github.com/ClickHouse/ClickHouse/pull/71911) ([Anton Ivashkin](https://github.com/ianton-ru)).
* Исправлен столбец rows&#95;processed в system.s3/azure&#95;queue&#95;log, который был сломан в 24.6. Закрывает [#69975](https://github.com/ClickHouse/ClickHouse/issues/69975). [#71946](https://github.com/ClickHouse/ClickHouse/pull/71946) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ситуация, когда функции `s3`/`s3Cluster` могли возвращать неполный результат или выбрасывать исключение. Она возникала при использовании glob‑шаблона в URI S3 (например, `pattern/*`), когда должен существовать пустой объект с ключом `pattern/` (такие объекты автоматически создаются в консоли S3). Также значение по умолчанию для настройки `s3_skip_empty_files` изменено с `false` на `true`. [#71947](https://github.com/ClickHouse/ClickHouse/pull/71947) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлен сбой подсветки синтаксиса в clickhouse-client. Закрывает [#71864](https://github.com/ClickHouse/ClickHouse/issues/71864). [#71949](https://github.com/ClickHouse/ClickHouse/pull/71949) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена ошибка `Illegal type` для таблиц `MergeTree` с бинарной монотонной функцией в выражении `ORDER BY`, если первый аргумент — константа. Исправляет [#71941](https://github.com/ClickHouse/ClickHouse/issues/71941). [#71966](https://github.com/ClickHouse/ClickHouse/pull/71966) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Допускать только запросы SELECT в EXPLAIN AST, используемом внутри подзапроса. Другие типы запросов приводят к логической ошибке: &#39;Bad cast from type DB::ASTCreateQuery to DB::ASTSelectWithUnionQuery&#39; или `Inconsistent AST formatting`. [#71982](https://github.com/ClickHouse/ClickHouse/pull/71982) ([Pavel Kruglov](https://github.com/Avogar)).
* При вставке записи с помощью `clickhouse-client` клиент считывает описания столбцов с сервера. Однако была ошибка: мы записывали эти описания в неверном порядке; правильный порядок — [statistics, ttl, settings]. [#71991](https://github.com/ClickHouse/ClickHouse/pull/71991) ([Han Fei](https://github.com/hanfei1991)).
* Исправлено форматирование команд `ALTER MOVE PARTITION ... TO TABLE ...` при включённом параметре `format_alter_commands_with_parentheses`. [#72080](https://github.com/ClickHouse/ClickHouse/pull/72080) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправляет RIGHT / FULL JOIN в запросах с параллельными репликами. Теперь RIGHT JOIN может выполняться с использованием параллельных реплик (чтение правой таблицы распределяется). FULL JOIN не может быть распараллелен по узлам и выполняется локально. [#71162](https://github.com/ClickHouse/ClickHouse/pull/71162) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлена проблема, при которой ClickHouse в Docker-контейнерах выводил в stderr сообщение «get&#95;mempolicy: Operation not permitted» из-за ограничений на системные вызовы. [#70900](https://github.com/ClickHouse/ClickHouse/pull/70900) ([filimonov](https://github.com/filimonov)).
* Теперь запись `metadata_version` в ZooKeeper исправляется в потоке перезапуска, а не в потоке подключения. [#70297](https://github.com/ClickHouse/ClickHouse/pull/70297) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Это исправление для репликации &quot;zero-copy&quot;, которая не поддерживается и будет полностью удалена. Не удаляйте blob, если им пользуются узлы в ReplicatedMergeTree с репликацией zero-copy. [#71186](https://github.com/ClickHouse/ClickHouse/pull/71186) ([Antonio Andelic](https://github.com/antonio2368)).
* Это исправление для репликации «zero-copy», которая не поддерживается и будет полностью удалена. Перед перемещением парта на zero-copy-диск теперь берётся общий разделяемый блокирующий замок zero-copy, чтобы предотвратить возможную потерю данных при недоступности Keeper. [#71845](https://github.com/ClickHouse/ClickHouse/pull/71845) ([Aleksei Filatov](https://github.com/aalexfvk)).



### <a id="2410"></a> Релиз ClickHouse 24.10, 2024-10-31 {#a-id2410a-clickhouse-release-2410-2024-10-31}

#### Обратное несовместимое изменение {#backward-incompatible-change-2}
* Разрешена запись `SETTINGS` перед `FORMAT` в цепочке запросов с `UNION`, когда подзапросы заключены в круглые скобки. Это закрывает [#39712](https://github.com/ClickHouse/ClickHouse/issues/39712). Изменено поведение для случая, когда в запросе предложение SETTINGS указано дважды подряд. Ближайшее предложение SETTINGS будет иметь приоритет для соответствующего подзапроса. В предыдущих версиях внешнее предложение SETTINGS могло иметь приоритет над внутренним. [#68614](https://github.com/ClickHouse/ClickHouse/pull/68614) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Перестановка условий фильтрации в секции `[PRE]WHERE` теперь по умолчанию разрешена. Это можно отключить, установив параметр `allow_reorder_prewhere_conditions` в `false`. [#70657](https://github.com/ClickHouse/ClickHouse/pull/70657) ([Nikita Taranov](https://github.com/nickitat)).
* Удалена библиотека `idxd-config`, которая имеет несовместимую лицензию. Это также удаляет экспериментальный кодек Intel DeflateQPL. [#70987](https://github.com/ClickHouse/ClickHouse/pull/70987) ([Alexey Milovidov](https://github.com/alexey-milovidov)).



#### Новая возможность {#new-feature-2}

* Добавлена возможность выдавать доступ к шаблонам с подстановочными символами. `GRANT SELECT ON db.table_pefix_* TO user`. [#65311](https://github.com/ClickHouse/ClickHouse/pull/65311) ([pufit](https://github.com/pufit)).
* Если во время выполнения запроса нажать пробел, клиент отобразит таблицу в реальном времени с детальными метриками. Вы можете включить её глобально с помощью нового параметра `--progress-table` в clickhouse-client; новый параметр `--enable-progress-table-toggle` связан с параметром `--progress-table` и переключает отображение таблицы прогресса при нажатии клавиш Ctrl+Пробел. [#63689](https://github.com/ClickHouse/ClickHouse/pull/63689) ([Maria Khristenko](https://github.com/mariaKhr)), [#70423](https://github.com/ClickHouse/ClickHouse/pull/70423) ([Julia Kartseva](https://github.com/jkartseva)).
* Разрешено кэширование файлов при чтении для табличных движков объектного хранилища и озёр данных, с использованием хеша, вычисленного по ETag и пути к файлу, в качестве ключа кэша. [#70135](https://github.com/ClickHouse/ClickHouse/pull/70135) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Поддерживается создание таблицы с помощью запроса `CREATE TABLE ... CLONE AS ...`. Этот запрос клонирует схему исходной таблицы, а затем присоединяет все партиции к вновь созданной таблице. Эта возможность доступна только для таблиц семейства `MergeTree`. Закрывает [#65015](https://github.com/ClickHouse/ClickHouse/issues/65015). [#69091](https://github.com/ClickHouse/ClickHouse/pull/69091) ([tuanpach](https://github.com/tuanpach)).
* Добавлена новая системная таблица `system.query_metric_log`, которая содержит историю значений использования памяти и метрик из таблицы `system.events` для отдельных запросов и периодически сбрасывается на диск. [#66532](https://github.com/ClickHouse/ClickHouse/pull/66532) ([Pablo Marcos](https://github.com/pamarcos)).
* Простой запрос SELECT можно записать с использованием неявного SELECT, чтобы поддерживать вычисления в стиле калькулятора, например `ch "1 + 2"`. Это управляется новым параметром `implicit_select`. [#68502](https://github.com/ClickHouse/ClickHouse/pull/68502) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка режима `--copy` для clickhouse local для упрощённой конвертации форматов [#68503](https://github.com/ClickHouse/ClickHouse/issues/68503). [#68583](https://github.com/ClickHouse/ClickHouse/pull/68583) ([Denis Hananein](https://github.com/denis-hananein)).
* Добавлена встроенная HTML-страница для визуализации слияний, доступная по пути `/merges`. [#70821](https://github.com/ClickHouse/ClickHouse/pull/70821) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка функции `arrayUnion`. [#68989](https://github.com/ClickHouse/ClickHouse/pull/68989) ([Peter Nguyen](https://github.com/petern48)).
* Добавлена поддержка параметризованных псевдонимов SQL. [#50665](https://github.com/ClickHouse/ClickHouse/pull/50665) ([Anton Kozlov](https://github.com/tonickkozlov)).
* Новая агрегатная функция `quantileExactWeightedInterpolated`, представляющая собой интерполированную версию, основанную на `quantileExactWeighted`. Некоторые могут задаться вопросом, зачем нужна новая `quantileExactWeightedInterpolated`, если уже существует `quantileExactInterpolatedWeighted`. Дело в том, что новая функция более точна, чем старая. Это сделано для совместимости со Spark. [#69619](https://github.com/ClickHouse/ClickHouse/pull/69619) ([李扬](https://github.com/taiyang-li)).
* Новая функция `arrayElementOrNull`. Она возвращает `NULL`, если индекс массива выходит за допустимые пределы или если ключ в Map не найден. [#69646](https://github.com/ClickHouse/ClickHouse/pull/69646) ([李扬](https://github.com/taiyang-li)).
* Позволяет задавать регулярные выражения в новых полях `message_regexp` и `message_regexp_negative` в файле `config.xml` для фильтрации логов. Логирование применяется к отформатированному тексту без цветового оформления для максимально удобной работы разработчика. [#69657](https://github.com/ClickHouse/ClickHouse/pull/69657) ([Peter Nguyen](https://github.com/petern48)).
* Добавлена функция `RIPEMD160`, которая вычисляет криптографический хеш RIPEMD-160 для строки. Пример: `SELECT HEX(RIPEMD160('The quick brown fox jumps over the lazy dog'))` возвращает `37F332F68DB77BD9D7EDD4969571AD671CF9DD3B`. [#70087](https://github.com/ClickHouse/ClickHouse/pull/70087) ([Dergousov Maxim](https://github.com/m7kss1)).
* Добавлена поддержка чтения таблиц `Iceberg` на `HDFS`. [#70268](https://github.com/ClickHouse/ClickHouse/pull/70268) ([flynn](https://github.com/ucasfl)).
* Поддержка CTE в виде `WITH ... INSERT`, так как ранее поддерживался только синтаксис `INSERT ... WITH ...`. [#70593](https://github.com/ClickHouse/ClickHouse/pull/70593) ([Shichao Jin](https://github.com/jsc0218)).
* Интеграция с MongoDB: поддержка всех типов MongoDB, поддержка операторов WHERE и ORDER BY на стороне MongoDB, ограничение на выражения, не поддерживаемые MongoDB. Обратите внимание, что новая интеграция по умолчанию отключена; чтобы её использовать, установите параметр `<use_legacy_mongodb_integration>` в значение `false` в конфигурации сервера. [#63279](https://github.com/ClickHouse/ClickHouse/pull/63279) ([Kirill Nikiforov](https://github.com/allmazz)).
* Добавлена новая функция `getSettingOrDefault`, которая возвращает значение по умолчанию и предотвращает выброс исключения, если пользовательская настройка отсутствует в текущем профиле. [#69917](https://github.com/ClickHouse/ClickHouse/pull/69917) ([Shankar](https://github.com/shiyer7474)).



#### Экспериментальная функция {#experimental-feature-1}
* Обновляемые материализованные представления готовы для промышленной эксплуатации. [#70550](https://github.com/ClickHouse/ClickHouse/pull/70550) ([Michael Kolupaev](https://github.com/al13n321)). Обновляемые материализованные представления теперь поддерживаются в реплицируемых базах данных. [#60669](https://github.com/ClickHouse/ClickHouse/pull/60669) ([Michael Kolupaev](https://github.com/al13n321)).
* Параллельные реплики переведены из экспериментального статуса в бета. Переработаны настройки, которые управляют поведением алгоритмов параллельных реплик. Краткое напоминание: в ClickHouse есть четыре различных алгоритма параллельного чтения с участием нескольких реплик, что отражено в настройке `parallel_replicas_mode`, значение по умолчанию для неё — `read_tasks`. Дополнительно была добавлена переключаемая настройка `enable_parallel_replicas`. [#63151](https://github.com/ClickHouse/ClickHouse/pull/63151) ([Alexey Milovidov](https://github.com/alexey-milovidov)), ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлена поддержка типа `Dynamic` в большинстве функций за счёт выполнения их над внутренними типами внутри `Dynamic`. [#69691](https://github.com/ClickHouse/ClickHouse/pull/69691) ([Pavel Kruglov](https://github.com/Avogar)).
* Разрешено читать/писать тип `JSON` как бинарную строку в формате `RowBinary` при использовании настроек `input_format_binary_read_json_as_string/output_format_binary_write_json_as_string`. [#70288](https://github.com/ClickHouse/ClickHouse/pull/70288) ([Pavel Kruglov](https://github.com/Avogar)).
* Разрешена сериализация/десериализация столбца `JSON` как одного столбца типа String в формате Native. Для вывода используйте настройку `output_format_native_write_json_as_string`. Для ввода используйте версию сериализации `1` перед данными столбца. [#70312](https://github.com/ClickHouse/ClickHouse/pull/70312) ([Pavel Kruglov](https://github.com/Avogar)).
* Введён специальный (экспериментальный) режим селектора слияний для таблиц MergeTree, который делает его более агрессивным для разделов, находящихся близко к лимиту по количеству кусков. Он управляется настройкой уровня MergeTree `merge_selector_use_blurry_base`. [#70645](https://github.com/ClickHouse/ClickHouse/pull/70645) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Реализована обобщённая сериализация/десериализация между типом `Union` в Avro и типом `Variant` в ClickHouse. Решает проблему [#69713](https://github.com/ClickHouse/ClickHouse/issues/69713). [#69712](https://github.com/ClickHouse/ClickHouse/pull/69712) ([Jiří Kozlovský](https://github.com/jirislav)).



#### Повышение производительности {#performance-improvement-2}

* Рефакторинг `IDisk` и `IObjectStorage` для повышения производительности. Таблицы в объектных хранилищах `plain` и `plain_rewritable` будут инициализироваться быстрее. [#68146](https://github.com/ClickHouse/ClickHouse/pull/68146) ([Alexey Milovidov](https://github.com/alexey-milovidov), [Julia Kartseva](https://github.com/jkartseva)). Не вызывать API LIST объектного хранилища при определении, существует ли файл или каталог на диске plain rewritable, так как это может быть экономически неэффективно. [#70852](https://github.com/ClickHouse/ClickHouse/pull/70852) ([Julia Kartseva](https://github.com/jkartseva)). Сокращено количество запросов HEAD к API объектного хранилища на диске plain&#95;rewritable. [#70915](https://github.com/ClickHouse/ClickHouse/pull/70915) ([Julia Kartseva](https://github.com/jkartseva)).
* Добавлена возможность парсить данные напрямую в разреженные столбцы. [#69828](https://github.com/ClickHouse/ClickHouse/pull/69828) ([Anton Popov](https://github.com/CurtizJ)).
* Улучшена производительность разбора форматов с большим числом пропущенных значений (например, `JSONEachRow`). [#69875](https://github.com/ClickHouse/ClickHouse/pull/69875) ([Anton Popov](https://github.com/CurtizJ)).
* Поддерживается параллельное чтение групп строк Parquet и их предварительная подзагрузка в однопоточном режиме. [#69862](https://github.com/ClickHouse/ClickHouse/pull/69862) ([LiuNeng](https://github.com/liuneng1994)).
* Добавлена поддержка индекса minmax для функции `pointInPolygon`. [#62085](https://github.com/ClickHouse/ClickHouse/pull/62085) ([JackyWoo](https://github.com/JackyWoo)).
* Используйте фильтры Блума при чтении файлов Parquet. [#62966](https://github.com/ClickHouse/ClickHouse/pull/62966) ([Arthur Passos](https://github.com/arthurpassos)).
* Безблокировочное переименование частей данных, чтобы избежать влияния операций INSERT на SELECT (из‑за блокировки частей) (в обычных условиях с `fsync_part_directory` QPS запросов SELECT при параллельных INSERT увеличился в 2 раза, под высокой нагрузкой эффект ещё заметнее). Учтите, что пока это касается только `ReplicatedMergeTree`. [#64955](https://github.com/ClickHouse/ClickHouse/pull/64955) ([Azat Khuzhin](https://github.com/azat)).
* Учитывать `ttl_only_drop_parts` при выполнении `materialize ttl`; считывать только необходимые столбцы для перерасчёта TTL и удалять части, заменяя их пустыми. [#65488](https://github.com/ClickHouse/ClickHouse/pull/65488) ([Andrey Zvonov](https://github.com/zvonand)).
* Оптимизировано создание потоков в `ThreadPool` для минимизации конфликтов при блокировках. Создание потоков теперь выполняется вне критической секции, чтобы избежать задержек при планировании задач и управлении потоками в условиях высокой нагрузки. Это делает ClickHouse значительно более отзывчивым при высокой параллельной нагрузке. [#68694](https://github.com/ClickHouse/ClickHouse/pull/68694) ([filimonov](https://github.com/filimonov)).
* Добавлена поддержка чтения строковых столбцов `LowCardinality` из `ORC`. [#69481](https://github.com/ClickHouse/ClickHouse/pull/69481) ([李扬](https://github.com/taiyang-li)).
* Используйте `LowCardinality` для `ProfileEvents` в системных логах, таких как `part_log`, `query_views_log`, `filesystem_cache_log`. [#70152](https://github.com/ClickHouse/ClickHouse/pull/70152) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Повышена производительность функций `fromUnixTimestamp`/`toUnixTimestamp`. [#71042](https://github.com/ClickHouse/ClickHouse/pull/71042) ([kevinyhzou](https://github.com/KevinyhZou)).
* Не отключайте неблокирующее чтение из кэша страниц для всего сервера при выполнении блокирующего ввода-вывода. Это приводило к снижению производительности, когда одна файловая система (например, tmpfs) не поддерживала системный вызов `preadv2`, а другие — поддерживали. [#70299](https://github.com/ClickHouse/ClickHouse/pull/70299) ([Antonio Andelic](https://github.com/antonio2368)).
* `ALTER TABLE .. REPLACE PARTITION` больше не ожидает завершения мутаций/слияний, происходящих в других партициях. [#59138](https://github.com/ClickHouse/ClickHouse/pull/59138) ([Vasily Nemkov](https://github.com/Enmk)).
* Не выполнять валидацию при синхронизации ACL из Keeper. Валидация выполняется во время создания. Это не должно играть большой роли, но существуют установки с десятками тысяч и даже большим числом созданных пользователей, и ненужная проверка хеша может занимать много времени при запуске сервера (так как при этом синхронизируется всё из Keeper). [#70644](https://github.com/ClickHouse/ClickHouse/pull/70644) ([Raúl Marín](https://github.com/Algunenano)).





#### Улучшение {#improvement-2}

* `CREATE TABLE AS` копирует `PRIMARY KEY`, `ORDER BY` и аналогичные конструкции (для таблиц `MergeTree`). [#69739](https://github.com/ClickHouse/ClickHouse/pull/69739) ([sakulali](https://github.com/sakulali)).
* Добавлена поддержка 64-битного XID в Keeper. Ее можно включить параметром конфигурации `use_xid_64`. [#69908](https://github.com/ClickHouse/ClickHouse/pull/69908) ([Antonio Andelic](https://github.com/antonio2368)).
* Аргументы командной строки для логических настроек устанавливаются в значение true, если для аргумента не указано значение (например, `clickhouse-client --optimize_aggregation_in_order --query "SELECT 1"`). [#70459](https://github.com/ClickHouse/ClickHouse/pull/70459) ([davidtsuk](https://github.com/davidtsuk)).
* Добавлены пользовательские настройки `min_free_disk_bytes_to_perform_insert` и `min_free_disk_perform_to_throw_insert` для предотвращения выполнения операций INSERT на почти заполненных дисках. [#69755](https://github.com/ClickHouse/ClickHouse/pull/69755) ([Marco Vilas Boas](https://github.com/marco-vb)).
* Встроенная документация по настройкам будет заведомо более подробной и полной, чем документация на сайте. Это первый шаг на пути к тому, чтобы документация на сайте всегда автоматически генерировалась из исходного кода. Это имеет долгосрочные последствия: - будет гарантировано наличие каждой настройки; - не будет риска, что значения по умолчанию устареют; - мы сможем генерировать эту документацию для каждой версии ClickHouse; - документацию можно будет отображать самим сервером даже без доступа к Интернету. Генерировать документацию на сайте из исходного кода. [#70289](https://github.com/ClickHouse/ClickHouse/pull/70289) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка пустой подстроки в функции `replace`; поведение соответствует PostgreSQL. [#69918](https://github.com/ClickHouse/ClickHouse/pull/69918) ([zhanglistar](https://github.com/zhanglistar)).
* Разрешено использовать пустую строку-шаблон в функциях `replaceRegexp*`. [#70053](https://github.com/ClickHouse/ClickHouse/pull/70053) ([zhanglistar](https://github.com/zhanglistar)).
* Символические ссылки для таблиц в каталоге `data/database_name/` создаются как ссылки на фактические пути к данным таблицы в соответствии с политикой хранения, а не на каталог `store/...` на диске по умолчанию. [#61777](https://github.com/ClickHouse/ClickHouse/pull/61777) ([Kirill](https://github.com/kirillgarbar)).
* При разборе поля типа `Enum` из `JSON` строка, содержащая целое число, будет интерпретироваться как соответствующий элемент `Enum`. Тем самым закрывается [#65119](https://github.com/ClickHouse/ClickHouse/issues/65119). [#66801](https://github.com/ClickHouse/ClickHouse/pull/66801) ([scanhex12](https://github.com/scanhex12)).
* Разрешено применение `TRIM` с `LEADING` или `TRAILING` к пустой строке как операции, не выполняющей никаких изменений. Закрывает [#67792](https://github.com/ClickHouse/ClickHouse/issues/67792). [#68455](https://github.com/ClickHouse/ClickHouse/pull/68455) ([Peter Nguyen](https://github.com/petern48)).
* Улучшена совместимость `cast(timestamp as String)` со Spark. [#69179](https://github.com/ClickHouse/ClickHouse/pull/69179) ([Wenzheng Liu](https://github.com/lwz9103)).
* Всегда используется новый анализатор для вычисления константных выражений, когда `enable_analyzer` установлен в `true`. Поддерживается вычисление аргументов табличной функции `executable` без использования запроса `SELECT` для константных выражений. [#69292](https://github.com/ClickHouse/ClickHouse/pull/69292) ([Dmitry Novik](https://github.com/novikd)).
* Добавлена настройка `enable_secure_identifiers` для запрета использования идентификаторов со специальными символами. [#69411](https://github.com/ClickHouse/ClickHouse/pull/69411) ([tuanpach](https://github.com/tuanpach)).
* Добавлен параметр `show_create_query_identifier_quoting_rule` для определения поведения заключения идентификаторов в кавычки в результате запроса `SHOW CREATE TABLE`. Возможные значения: - `user_display`: когда идентификатор является ключевым словом. - `when_necessary`: когда идентификатор является одним из `{"distinct", "all", "table"}` и это может привести к неоднозначности, например для имён столбцов или атрибутов словаря. - `always`: всегда заключать идентификаторы в кавычки. [#69448](https://github.com/ClickHouse/ClickHouse/pull/69448) ([tuanpach](https://github.com/tuanpach)).
* Улучшено восстановление зависимостей сущностей доступа [#69563](https://github.com/ClickHouse/ClickHouse/pull/69563) ([Vitaly Baranov](https://github.com/vitlibar)).
* Если вы запускаете `clickhouse-client` или другое CLI-приложение, и оно из-за перегруженного сервера запускается медленно, а вы уже начинаете вводить запрос, например `SELECT`, то в предыдущих версиях перед выводом приветственного сообщения отображалось оставшееся эхо терминала, так что вы видели, например, `SELECTClickHouse local version 24.10.1.1.` вместо `ClickHouse local version 24.10.1.1.`. Теперь это исправлено. Это закрывает [#31696](https://github.com/ClickHouse/ClickHouse/issues/31696). [#69856](https://github.com/ClickHouse/ClickHouse/pull/69856) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен новый столбец `readonly_duration` в таблицу `system.replicas`. Он нужен, чтобы в оповещениях различать реальные реплики в режиме только для чтения и сторожевые (sentinel). [#69871](https://github.com/ClickHouse/ClickHouse/pull/69871) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Изменен тип параметра `join_output_by_rowlist_perkey_rows_threshold` на беззнаковое целое число. [#69886](https://github.com/ClickHouse/ClickHouse/pull/69886) ([kevinyhzou](https://github.com/KevinyhZou)).
* Улучшено логирование спанов OpenTelemetry: добавлены настройки запроса. [#70011](https://github.com/ClickHouse/ClickHouse/pull/70011) ([sharathks118](https://github.com/sharathks118)).
* Добавлена диагностическая информация для функций высшего порядка над массивами, если тип результата лямбда-выражения отличается от ожидаемого. [#70093](https://github.com/ClickHouse/ClickHouse/pull/70093) ([ttanay](https://github.com/ttanay)).
* Улучшение Keeper: меньше блокировок при изменениях в кластере. [#70275](https://github.com/ClickHouse/ClickHouse/pull/70275) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлены ключевые слова `WITH IMPLICIT` и `FINAL` в команду `SHOW GRANTS`. Исправлена небольшая ошибка с неявными правами: [#70094](https://github.com/ClickHouse/ClickHouse/issues/70094). [#70293](https://github.com/ClickHouse/ClickHouse/pull/70293) ([pufit](https://github.com/pufit)).
* Учитывается значение `compatibility` для настроек MergeTree. Значение `compatibility` берётся из профиля `default` при запуске сервера, и соответствующим образом изменяются настройки MergeTree по умолчанию. Дальнейшие изменения настройки `compatibility` не влияют на настройки MergeTree. [#70322](https://github.com/ClickHouse/ClickHouse/pull/70322) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Избегайте заспамливания логов большими телами HTTP‑ответов в случае ошибок при межсерверном взаимодействии. [#70487](https://github.com/ClickHouse/ClickHouse/pull/70487) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Добавлена новая настройка `max_parts_to_move` для управления максимальным количеством частей, которые могут быть перемещены за один раз. [#70520](https://github.com/ClickHouse/ClickHouse/pull/70520) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Ограничена частота вывода отдельных сообщений журнала. [#70601](https://github.com/ClickHouse/ClickHouse/pull/70601) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* `CHECK TABLE` с модификатором `PART` некорректно форматировалась в клиенте. [#70660](https://github.com/ClickHouse/ClickHouse/pull/70660) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка записи индекса столбца и индекса смещений с использованием нативного средства записи Parquet. [#70669](https://github.com/ClickHouse/ClickHouse/pull/70669) ([LiuNeng](https://github.com/liuneng1994)).
* Добавлена поддержка разбора `DateTime64` с микросекундной точностью и учетом часового пояса в синтаксисе joda (&quot;joda&quot; — это популярная Java-библиотека для работы с датой и временем, а &quot;синтаксис joda&quot; — это стиль этой библиотеки). [#70737](https://github.com/ClickHouse/ClickHouse/pull/70737) ([kevinyhzou](https://github.com/KevinyhZou)).
* Изменён подход к определению того, поддерживает ли облачное хранилище [пакетное удаление](https://docs.aws.amazon.com/AmazonS3/latest/API/API_DeleteObjects.html). [#70786](https://github.com/ClickHouse/ClickHouse/pull/70786) ([Vitaly Baranov](https://github.com/vitlibar)).
* Поддержка Parquet page v2 в нативном ридере. [#70807](https://github.com/ClickHouse/ClickHouse/pull/70807) ([Arthur Passos](https://github.com/arthurpassos)).
* Добавлена проверка наличия в таблице одновременно параметров `storage_policy` и `disk`. Добавлена проверка совместимости новой политики хранения со старой при использовании настройки `disk`. [#70839](https://github.com/ClickHouse/ClickHouse/pull/70839) ([Kirill](https://github.com/kirillgarbar)).
* Добавлены `system.s3_queue_settings` и `system.azure_queue_settings`. [#70841](https://github.com/ClickHouse/ClickHouse/pull/70841) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Функции `base58Encode` и `base58Decode` теперь принимают аргументы типа `FixedString`. Пример: `SELECT base58Encode(toFixedString('plaintext', 9));`. [#70846](https://github.com/ClickHouse/ClickHouse/pull/70846) ([Faizan Patel](https://github.com/faizan2786)).
* Добавлен столбец `partition` для каждого типа записи в журнале частей. Ранее он задавался только для некоторых записей. Это исправляет [#70819](https://github.com/ClickHouse/ClickHouse/issues/70819). [#70848](https://github.com/ClickHouse/ClickHouse/pull/70848) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлены события `MergeStart` и `MutateStart` в `system.part_log`, что упрощает анализ и визуализацию слияний. [#70850](https://github.com/ClickHouse/ClickHouse/pull/70850) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлено профильное событие, отражающее количество слитых исходных частей. Оно позволяет отслеживать степень ветвления дерева слияний MergeTree в продакшене. [#70908](https://github.com/ClickHouse/ClickHouse/pull/70908) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Фоновые загрузки в кэш файловой системы снова включены. [#70929](https://github.com/ClickHouse/ClickHouse/pull/70929) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлен новый алгоритм выбора слияний `Trivial`, предназначенный только для профессионального использования. Он хуже, чем алгоритм выбора слияний `Simple`. [#70969](https://github.com/ClickHouse/ClickHouse/pull/70969) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Поддержка атомарного `CREATE OR REPLACE VIEW`. [#70536](https://github.com/ClickHouse/ClickHouse/pull/70536) ([tuanpach](https://github.com/tuanpach))
* Добавлен режим `strict_once` для агрегатной функции `windowFunnel`, что позволяет избежать многократного учета одного и того же события, если оно удовлетворяет нескольким условиям, закрывает [#21835](https://github.com/ClickHouse/ClickHouse/issues/21835). [#69738](https://github.com/ClickHouse/ClickHouse/pull/69738) ([Vladimir Cherkasov](https://github.com/vdimir)).





#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-2}

* Применять обновления конфигурации к глобальному объекту контекста. Это исправляет проблемы, такие как [#62308](https://github.com/ClickHouse/ClickHouse/issues/62308). [#62944](https://github.com/ClickHouse/ClickHouse/pull/62944) ([Amos Bird](https://github.com/amosbird)).
* Исправлена проблема, из‑за которой `ReadSettings` не использовал значения, заданные пользователем, а применял только значения по умолчанию. [#65625](https://github.com/ClickHouse/ClickHouse/pull/65625) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проблема несоответствия типов данных в `sumMapFiltered` при использовании знаковых аргументов. [#58408](https://github.com/ClickHouse/ClickHouse/pull/58408) ([Chen768959](https://github.com/Chen768959)).
* Исправлена монотонность функций преобразования вида toHour при передаче необязательного аргумента часового пояса. [#60264](https://github.com/ClickHouse/ClickHouse/pull/60264) ([Amos Bird](https://github.com/amosbird)).
* Ослаблена проверка `supportsPrewhere` для таблиц `Merge`. Это исправляет [#61064](https://github.com/ClickHouse/ClickHouse/issues/61064). Эта проверка была ужесточена без необходимости в [#60082](https://github.com/ClickHouse/ClickHouse/issues/60082). [#61091](https://github.com/ClickHouse/ClickHouse/pull/61091) ([Amos Bird](https://github.com/amosbird)).
* Исправлена обработка настройки `use_concurrency_control` для корректного применения ограничения `concurrent_threads_soft_limit_num`. В результате управление параллелизмом теперь включено по умолчанию, так как ранее оно работало некорректно. [#61473](https://github.com/ClickHouse/ClickHouse/pull/61473) ([Sergei Trifonov](https://github.com/serxa)).
* Исправлена некорректная оптимизация условия `JOIN ON` в случае проверки `IS NULL`, находящейся внутри другой функции (например, `NOT`), что могло приводить к неверным результатам. Закрывает [#67915](https://github.com/ClickHouse/ClickHouse/issues/67915). [#68049](https://github.com/ClickHouse/ClickHouse/pull/68049) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Предотвращены запросы `ALTER`, которые могли бы сделать запрос `CREATE` для таблиц некорректным. [#68574](https://github.com/ClickHouse/ClickHouse/pull/68574) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлено несогласованное форматирование AST для функций `negate` (`-`) и `NOT` с кортежами и массивами. [#68600](https://github.com/ClickHouse/ClickHouse/pull/68600) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлена вставка неполного типа в `Dynamic` во время десериализации. Это могло приводить к возникновению ошибок `Parameter out of bound`. [#69291](https://github.com/ClickHouse/ClickHouse/pull/69291) ([Pavel Kruglov](https://github.com/Avogar)).
* Репликация с нулевым копированием — экспериментальная функция, её не следует использовать в продуктивной среде: исправлен бесконечный цикл после выполнения `restore replica` в ReplicatedMergeTree с нулевым копированием. [#69293](https://github.com/CljmnickHouse/ClickHouse/pull/69293) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Вернуть значение по умолчанию параметра `processing_threads_num` — количество ядер CPU — для хранилища `S3Queue`. [#69384](https://github.com/ClickHouse/ClickHouse/pull/69384) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Обойти использование конструкции try/catch при сериализации/десериализации вложенного повторяющегося protobuf во вложенные столбцы (исправляет [#41971](https://github.com/ClickHouse/ClickHouse/issues/41971)). [#69556](https://github.com/ClickHouse/ClickHouse/pull/69556) ([Eliot Hautefeuille](https://github.com/hileef)).
* Исправлена ошибка, приводившая к сбою при вставке в столбец FixedString в движке PostgreSQL. [#69584](https://github.com/ClickHouse/ClickHouse/pull/69584) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено падение при выполнении запроса `create view t as (with recursive 42 as ttt select ttt);`. [#69676](https://github.com/ClickHouse/ClickHouse/pull/69676) ([Han Fei](https://github.com/hanfei1991)).
* Исправлена ошибка, из-за которой `maxMapState` выбрасывал &#39;Bad get&#39;, если тип значения — DateTime64. [#69787](https://github.com/ClickHouse/ClickHouse/pull/69787) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена работа `getSubcolumn` для столбцов `LowCardinality` путём переопределения `useDefaultImplementationForLowCardinalityColumns` так, чтобы он возвращал `true`. [#69831](https://github.com/ClickHouse/ClickHouse/pull/69831) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Исправлена ошибка, из-за которой распределённые отправки могли навсегда блокироваться, если операция DROP распределённой таблицы завершалась неудачно. [#69843](https://github.com/ClickHouse/ClickHouse/pull/69843) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, из-за которой запросы с предложением WITH FILL и ключами NaN нельзя было отменить. Это закрывает [#69261](https://github.com/ClickHouse/ClickHouse/issues/69261). [#69845](https://github.com/ClickHouse/ClickHouse/pull/69845) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Приведено значение по умолчанию анализатора в соответствие со старым режимом совместимости. [#69895](https://github.com/ClickHouse/ClickHouse/pull/69895) ([Raúl Marín](https://github.com/Algunenano)).
* Не проверять зависимости при выполнении CREATE OR REPLACE VIEW на этапе DROP старой таблицы. Ранее запрос CREATE OR REPLACE VIEW завершался ошибкой, если существовали зависимые таблицы пересоздаваемого представления. [#69907](https://github.com/ClickHouse/ClickHouse/pull/69907) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправления для Decimal. Устраняет [#69730](https://github.com/ClickHouse/ClickHouse/issues/69730). [#69978](https://github.com/ClickHouse/ClickHouse/pull/69978) ([Arthur Passos](https://github.com/arthurpassos)).
* Теперь механизмы DEFINER/INVOKER будут работать с параметризованными представлениями. [#69984](https://github.com/ClickHouse/ClickHouse/pull/69984) ([pufit](https://github.com/pufit)).
* Исправлен разбор определяющих пользователей представлений. [#69985](https://github.com/ClickHouse/ClickHouse/pull/69985) ([pufit](https://github.com/pufit)).
* Исправлена ошибка, из-за которой часовой пояс мог влиять на результат запроса с аргументами `Date` или `Date32`. [#70036](https://github.com/ClickHouse/ClickHouse/pull/70036) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправляет ошибку `Block structure mismatch` для запросов с вложенными представлениями и условием `WHERE`. Исправляет [#66209](https://github.com/ClickHouse/ClickHouse/issues/66209). [#70054](https://github.com/ClickHouse/ClickHouse/pull/70054) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Избегайте повторного использования одних и тех же столбцов в разных именованных кортежах при вычислении функций `tuple`. Это исправляет [#70022](https://github.com/ClickHouse/ClickHouse/issues/70022). [#70103](https://github.com/ClickHouse/ClickHouse/pull/70103) ([Amos Bird](https://github.com/amosbird)).
* Исправлен ошибочный LOGICAL&#95;ERROR при замене литералов в диапазонах. [#70122](https://github.com/ClickHouse/ClickHouse/pull/70122) ([Pablo Marcos](https://github.com/pamarcos)).
* Теперь при выполнении ALTER TABLE MODIFY COLUMN/QUERY выполняется проверка на наличие типа Nullable(Nothing), чтобы предотвращать создание таблиц с таким типом данных. [#70123](https://github.com/ClickHouse/ClickHouse/pull/70123) ([Pavel Kruglov](https://github.com/Avogar)).
* Корректное сообщение об ошибке для недопустимого запроса `JOIN ... ON *`, закрыт [#68650](https://github.com/ClickHouse/ClickHouse/issues/68650). [#70124](https://github.com/ClickHouse/ClickHouse/pull/70124) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлен неверный результат при использовании пропускающего индекса. [#70127](https://github.com/ClickHouse/ClickHouse/pull/70127) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена гонка данных в методе распаковки ColumnObject/ColumnTuple, которая могла приводить к обращению к памяти кучи после её освобождения. [#70137](https://github.com/ClickHouse/ClickHouse/pull/70137) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено потенциальное зависание в `ALTER COLUMN` с типом `Dynamic`. [#70144](https://github.com/ClickHouse/ClickHouse/pull/70144) ([Pavel Kruglov](https://github.com/Avogar)).
* Теперь ClickHouse будет считать больше ошибок повторяемыми и не будет помечать части данных как повреждённые при возникновении таких ошибок. [#70145](https://github.com/ClickHouse/ClickHouse/pull/70145) ([alesapin](https://github.com/alesapin)).
* Используется корректный параметр `max_types` при создании динамического типа для подстолбца JSON. [#70147](https://github.com/ClickHouse/ClickHouse/pull/70147) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена проблема с отображением пароля в `system.query_log` для пользователей с методом аутентификации bcrypt. [#70148](https://github.com/ClickHouse/ClickHouse/pull/70148) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлен счетчик событий для нативного интерфейса (InterfaceNativeSendBytes). [#70153](https://github.com/ClickHouse/ClickHouse/pull/70153) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлено возможное аварийное завершение работы, связанное с JSON-столбцами. [#70172](https://github.com/ClickHouse/ClickHouse/pull/70172) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено несколько ошибок в arrayMin и arrayMax. [#70207](https://github.com/ClickHouse/ClickHouse/pull/70207) ([Raúl Marín](https://github.com/Algunenano)).
* Учитывать параметр allow&#95;simdjson в парсере типа JSON. [#70218](https://github.com/ClickHouse/ClickHouse/pull/70218) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлено разыменование нулевого указателя при создании материализованного представления с двумя операторами `SELECT` и оператором `INTERSECT`, например: `CREATE MATERIALIZED VIEW v0 AS (SELECT 1) INTERSECT (SELECT 1);`. [#70264](https://github.com/ClickHouse/ClickHouse/pull/70264) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Не изменяйте глобальные настройки с помощью стартовых скриптов. Ранее изменение настройки в стартовом скрипте приводило к её глобальному изменению. [#70310](https://github.com/ClickHouse/ClickHouse/pull/70310) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена операция ALTER для типа `Dynamic` с уменьшением параметра max&#95;types, которая могла приводить к аварийному завершению работы сервера. [#70328](https://github.com/ClickHouse/ClickHouse/pull/70328) ([Pavel Kruglov](https://github.com/Avogar)).
* Исправлена ошибка, приводившая к сбою при неправильном использовании WITH FILL. [#70338](https://github.com/ClickHouse/ClickHouse/pull/70338) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена возможная ошибка use-after-free в `SYSTEM DROP FORMAT SCHEMA CACHE FOR Protobuf`. [#70358](https://github.com/ClickHouse/ClickHouse/pull/70358) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено аварийное завершение при выполнении GROUP BY по подстолбцу JSON-подобъекта. [#70374](https://github.com/ClickHouse/ClickHouse/pull/70374) ([Pavel Kruglov](https://github.com/Avogar)).
* Не подгружать части заранее при вертикальных слияниях, если часть не содержит строк. [#70452](https://github.com/ClickHouse/ClickHouse/pull/70452) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено падение в WHERE при использовании лямбда‑функций. [#70464](https://github.com/ClickHouse/ClickHouse/pull/70464) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено создание таблицы с помощью `CREATE ... AS table_function(...)` для базы данных `Replicated` при недоступном источнике табличной функции на вторичной реплике. [#70511](https://github.com/ClickHouse/ClickHouse/pull/70511) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Игнорируется весь вывод при асинхронной вставке с `wait_for_async_insert=1`. Закрывает [#62644](https://github.com/ClickHouse/ClickHouse/issues/62644). [#70530](https://github.com/ClickHouse/ClickHouse/pull/70530) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Игнорировать frozen&#95;metadata.txt при обходе теневого каталога в system.remote&#95;data&#95;paths. [#70590](https://github.com/ClickHouse/ClickHouse/pull/70590) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Исправлено создание оконных функций с сохранением состояния при неправильно выровненной памяти. [#70631](https://github.com/ClickHouse/ClickHouse/pull/70631) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлены редкие аварийные завершения `SELECT`-запросов и операций слияния после добавления столбца типа `Array` с непустым выражением значения по умолчанию. [#70695](https://github.com/ClickHouse/ClickHouse/pull/70695) ([Anton Popov](https://github.com/CurtizJ)).
* Вставка в табличную функцию S3 теперь учитывает настройки запроса. [#70696](https://github.com/ClickHouse/ClickHouse/pull/70696) ([Vladimir Cherkasov](https://github.com/vdimir)).
* Исправлена бесконечная рекурсия при выводе protobuf-схемы при включённом режиме пропуска неподдерживаемых полей. [#70697](https://github.com/ClickHouse/ClickHouse/pull/70697) ([Raúl Marín](https://github.com/Algunenano)).
* По умолчанию параметр `enable_named_columns_in_function_tuple` отключен. [#70833](https://github.com/ClickHouse/ClickHouse/pull/70833) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена работа настройки движка таблицы S3Queue `processing_threads_num`, которая не действовала, когда её значение определялось по количеству ядер CPU на сервере. [#70837](https://github.com/ClickHouse/ClickHouse/pull/70837) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Нормализованы аргументы именованных кортежей в агрегатных состояниях. Это исправляет [#69732](https://github.com/ClickHouse/ClickHouse/issues/69732). [#70853](https://github.com/ClickHouse/ClickHouse/pull/70853) ([Amos Bird](https://github.com/amosbird)).
* Исправлена логическая ошибка, вызванная отрицательными нулями в двухуровневой хеш-таблице. Исправляет проблему из [#70973](https://github.com/ClickHouse/ClickHouse/issues/70973). [#70979](https://github.com/ClickHouse/ClickHouse/pull/70979) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена работа операторов `LIMIT BY` и `LIMIT WITH TIES` для распределённых и параллельных реплик. [#70880](https://github.com/ClickHouse/ClickHouse/pull/70880) ([Nikita Taranov](https://github.com/nickitat)).



### <a id="249"></a> Релиз ClickHouse 24.9, 2024-09-26 {#a-id249a-clickhouse-release-249-2024-09-26}

#### Изменение, нарушающее обратную совместимость {#backward-incompatible-change-3}
* Выражения вида `a[b].c` поддерживаются для именованных кортежей, а также обращение к полям по имени из произвольных выражений, например, `expr().name`. Это полезно для обработки JSON. Закрывает [#54965](https://github.com/ClickHouse/ClickHouse/issues/54965). В предыдущих версиях выражение вида `expr().name` разбиралось как `tupleElement(expr(), name)`, и анализатор запросов искал столбец `name`, а не соответствующий элемент кортежа; в новой версии оно разбирается как `tupleElement(expr(), 'name')`. В большинстве случаев предыдущие версии не работали, но можно представить себе крайне необычный сценарий, при котором это изменение может привести к несовместимости: если вы хранили имена элементов кортежа в столбце или алиасе, имя которого отличалось от имени элемента кортежа: `SELECT 'b' AS a, CAST([tuple(123)] AS 'Array(Tuple(b UInt8))') AS t, t[1].a`. Маловероятно, что вы использовали такие запросы, но мы всё равно должны пометить это изменение как потенциально нарушающее обратную совместимость. [#68435](https://github.com/ClickHouse/ClickHouse/pull/68435) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* При включённой настройке `print_pretty_type_names` тип данных `Tuple` будет выводиться в наглядной форме в операторах `SHOW CREATE TABLE`, в функции `formatQuery`, а также в интерактивном режиме в `clickhouse-client` и `clickhouse-local`. В предыдущих версиях эта настройка применялась только к запросам `DESCRIBE` и `toTypeName`. Это закрывает [#65753](https://github.com/ClickHouse/ClickHouse/issues/65753). [#68492](https://github.com/ClickHouse/ClickHouse/pull/68492) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Запрещено явно указывать UUID при создании таблицы в базах данных `Replicated`. Также запрещено явно указывать путь в Keeper и имя реплики для таблиц *MergeTree в базах данных `Replicated`. Вводится новая настройка `database_replicated_allow_explicit_uuid` и изменяется тип `database_replicated_allow_replicated_engine_arguments` с Bool на UInt64. [#66104](https://github.com/ClickHouse/ClickHouse/pull/66104) ([Alexander Tokmakov](https://github.com/tavplubix)).



#### Новая возможность {#new-feature-3}

* Разрешает пользователю иметь несколько методов аутентификации вместо одного. Позволяет сбрасывать методы аутентификации к последнему добавленному. Если вы хотите какое‑то время запускать экземпляры на версии 24.8 и один на 24.9, лучше на этот период задать `max_authentication_methods_per_user` = 1, чтобы избежать потенциальных несовместимостей. [#65277](https://github.com/ClickHouse/ClickHouse/pull/65277) ([Arthur Passos](https://github.com/arthurpassos)).
* Добавлена поддержка `ATTACH PARTITION ALL FROM`. [#61987](https://github.com/ClickHouse/ClickHouse/pull/61987) ([Kirill Nikiforov](https://github.com/allmazz)).
* Добавлена настройка `input_format_json_empty_as_default`, которая при включении рассматривает пустые поля во входных данных JSON как значения по умолчанию. Закрывает [#59339](https://github.com/ClickHouse/ClickHouse/issues/59339). [#66782](https://github.com/ClickHouse/ClickHouse/pull/66782) ([Alexis Arnaud](https://github.com/a-a-f)).
* Добавлены функции `overlay` и `overlayUTF8`, которые заменяют части строки другой строкой. Пример: `SELECT overlay('Hello New York', 'Jersey', 11)` возвращает `Hello New Jersey`. [#66933](https://github.com/ClickHouse/ClickHouse/pull/66933) ([李扬](https://github.com/taiyang-li)).
* Добавлена поддержка облегчённых удалений для партиционного варианта запроса `DELETE FROM [db.]table [ON CLUSTER cluster] [IN PARTITION partition_expr] WHERE expr;` [#67805](https://github.com/ClickHouse/ClickHouse/pull/67805) ([sunny](https://github.com/sunny19930321)).
* Реализовано сравнение значений типа данных `Interval` из разных доменов (например, секунд и минут), при котором они теперь приводятся к наименьшему общему супертиру. [#68057](https://github.com/ClickHouse/ClickHouse/pull/68057) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена настройка `create_if_not_exists`, которая по умолчанию включает поведение `IF NOT EXISTS` для операторов CREATE. [#68164](https://github.com/ClickHouse/ClickHouse/pull/68164) ([Peter Nguyen](https://github.com/petern48)).
* Позволяет читать таблицы `Iceberg` в Azure и локально. [#68210](https://github.com/ClickHouse/ClickHouse/pull/68210) ([Daniil Ivanik](https://github.com/divanik)).
* Теперь записи кэша запросов можно удалять по тегу. Например, запись кэша запросов, созданная запросом `SELECT 1 SETTINGS use_query_cache = true, query_cache_tag = 'abc'`, может быть удалена командой `SYSTEM DROP QUERY CACHE TAG 'abc'`. [#68477](https://github.com/ClickHouse/ClickHouse/pull/68477) ([Michał Tabaszewski](https://github.com/pinsvin00)).
* Добавлено шифрование данных для именованных коллекций. [#68615](https://github.com/ClickHouse/ClickHouse/pull/68615) ([Pablo Marcos](https://github.com/pamarcos)).
* Добавлен виртуальный столбец `_headers` для движка таблицы `URL`. Закрывает [#65026](https://github.com/ClickHouse/ClickHouse/issues/65026). [#68867](https://github.com/ClickHouse/ClickHouse/pull/68867) ([flynn](https://github.com/ucasfl)).
* Добавлена таблица `system.projections` для отслеживания доступных проекций. [#68901](https://github.com/ClickHouse/ClickHouse/pull/68901) ([Jordi Villar](https://github.com/jrdi)).
* Добавлена новая функция `arrayZipUnaligned` для совместимости со Spark (в Spark она называется `arrays_zip`), которая на основе исходной функции `arrayZip` поддерживает работу с невыравненными массивами. [#69030](https://github.com/ClickHouse/ClickHouse/pull/69030) ([李扬](https://github.com/taiyang-li)).
* Добавлены команды `cp`/`mv` для клиентского приложения keeper командной строки, которые атомарно копируют/перемещают узел. [#69034](https://github.com/ClickHouse/ClickHouse/pull/69034) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Добавлен аргумент `scale` (по умолчанию: `true`) для функции `arrayAUC`, позволяющий пропустить шаг нормализации (issue [#69609](https://github.com/ClickHouse/ClickHouse/issues/69609)). [#69717](https://github.com/ClickHouse/ClickHouse/pull/69717) ([gabrielmcg44](https://github.com/gabrielmcg44)).



#### Экспериментальная функция {#experimental-feature-2}
* Добавлена настройка `input_format_try_infer_variants`, которая позволяет определять тип `Variant` при определении схемы для текстовых форматов, когда для элементов столбца/массива существует более одного возможного типа. [#63798](https://github.com/ClickHouse/ClickHouse/pull/63798) ([Shaun Struwig](https://github.com/Blargian)).
* Добавлены агрегатные функции `distinctDynamicTypes`/`distinctJSONPaths`/`distinctJSONPathsAndTypes` для более удобного анализа содержимого типов в JSON-столбцах. [#68463](https://github.com/ClickHouse/ClickHouse/pull/68463) ([Kruglov Pavel](https://github.com/Avogar)).
* Новый алгоритм определения единицы распределения меток между параллельными репликами при помощи согласованного хеша. Разное количество меток выбирается для разных сценариев чтения для повышения производительности. [#68424](https://github.com/ClickHouse/ClickHouse/pull/68424) ([Nikita Taranov](https://github.com/nickitat)).
* Ранее алгоритмическая сложность логики дедупликации частей при обработке объявлений параллельных реплик была O(n^2), что могло занимать заметное время для таблиц с большим числом частей (или партиций). Это изменение снижает сложность до O(n*log(n)). [#69596](https://github.com/ClickHouse/ClickHouse/pull/69596) ([Alexander Gololobov](https://github.com/davenger)).
* Улучшения обновляемых материализованных представлений: режим добавления (`... REFRESH EVERY 1 MINUTE APPEND ...`) для добавления строк в существующую таблицу вместо полной её перезаписи, повторные попытки (по умолчанию отключены, настраиваются в секции SETTINGS запроса), запрос `SYSTEM WAIT VIEW <name>`, который ждёт завершения текущего обновления, некоторые исправления. [#58934](https://github.com/ClickHouse/ClickHouse/pull/58934) ([Michael Kolupaev](https://github.com/al13n321)).
* Добавлен `min_max` как новый тип (экспериментальной) статистики. Он поддерживает оценку диапазонных предикатов над числовыми столбцами, например `x < 100`. [#67013](https://github.com/ClickHouse/ClickHouse/pull/67013) ([JackyWoo](https://github.com/JackyWoo)).
* Улучшен `castOrDefault` для столбцов Variant/Dynamic, чтобы он работал, когда внутренние типы вообще не преобразуемы. [#67150](https://github.com/ClickHouse/ClickHouse/pull/67150) ([Kruglov Pavel](https://github.com/Avogar)).
* Репликация подмножества столбцов теперь доступна через MaterializedPostgreSQL. Закрывает [#33748](https://github.com/ClickHouse/ClickHouse/issues/33748). [#69092](https://github.com/ClickHouse/ClickHouse/pull/69092) ([Kruglov Kirill](https://github.com/1on)).



#### Улучшение производительности {#performance-improvement-3}
* Реализовано чтение только необходимых файлов для секционирования Hive. [#68963](https://github.com/ClickHouse/ClickHouse/pull/68963) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Улучшена производительность `JOIN` за счет перестановки правой таблицы по ключам, когда ключи таблицы плотные в `LEFT` или `INNER` хеш-объединениях. [#60341](https://github.com/ClickHouse/ClickHouse/pull/60341) ([kevinyhzou](https://github.com/KevinyhZou)).
* Улучшена производительность `ALL JOIN` за счет отложенного добавления списка строк. [#63677](https://github.com/ClickHouse/ClickHouse/pull/63677) ([kevinyhzou](https://github.com/KevinyhZou)).
* Реализована асинхронная загрузка метаданных файлового кэша во время процесса запуска для ускорения перезапуска (управляется настройкой `load_metadata_asynchronously`). [#65736](https://github.com/ClickHouse/ClickHouse/pull/65736) ([Daniel Pozo Escalona](https://github.com/danipozo)).
* Функции `array` и `map` оптимизированы для значительно более быстрого выполнения некоторых распространенных сценариев. [#67707](https://github.com/ClickHouse/ClickHouse/pull/67707) ([李扬](https://github.com/taiyang-li)).
* Небольшая оптимизация чтения строк в формате ORC, особенно когда столбец не содержит значений `NULL`. [#67794](https://github.com/ClickHouse/ClickHouse/pull/67794) ([李扬](https://github.com/taiyang-li)).
* Улучшена общая производительность слияний за счет уменьшения накладных расходов на планирование шагов слияний. [#68016](https://github.com/ClickHouse/ClickHouse/pull/68016) ([Anton Popov](https://github.com/CurtizJ)).
* Ускорены запросы к S3, когда профиль не задан, учетные данные не заданы и IMDS недоступен (например, при запросе публичного бакета с машины вне облака). Закрывает задачу [#52771](https://github.com/ClickHouse/ClickHouse/issues/52771). [#68082](https://github.com/ClickHouse/ClickHouse/pull/68082) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Убран виртуальный вызов читателя формата в `RowInputFormatWithNamesAndTypes` для повышения производительности. [#68437](https://github.com/ClickHouse/ClickHouse/pull/68437) ([李扬](https://github.com/taiyang-li)).
* Добавлено параллельное слияние для агрегатной функции `uniq` при агрегации с ключом `GROUP BY` для максимальной загрузки CPU. [#68441](https://github.com/ClickHouse/ClickHouse/pull/68441) ([Jiebin Sun](https://github.com/jiebinn)).
* Добавлена настройка `output_format_orc_dictionary_key_size_threshold`, позволяющая пользователю включить кодирование словарём (dictionary encoding) для строкового столбца в выходном формате `ORC`. Это помогает существенно уменьшить размер выходного файла `ORC` и значительно улучшить производительность чтения. [#68591](https://github.com/ClickHouse/ClickHouse/pull/68591) ([李扬](https://github.com/taiyang-li)).
* Добавлен новый запрос Keeper `RemoveRecursive`, который удаляет узел со всем его поддеревом. [#69332](https://github.com/ClickHouse/ClickHouse/pull/69332) ([Mikhail Artemenko](https://github.com/Michicosun)).
* Ускорена вставка в таблицу с индексом векторного сходства за счет параллельного добавления данных во векторный индекс. [#69493](https://github.com/ClickHouse/ClickHouse/pull/69493) ([flynn](https://github.com/ucasfl)).
* Снижено потребление памяти при вставках в столбец JSON за счет адаптивного размера буфера записи. Многие файлы, создаваемые JSON‑столбцом в широкой части, содержат небольшое количество данных, и нет смысла выделять для них буфер размером 1 МБ. [#69272](https://github.com/ClickHouse/ClickHouse/pull/69272) ([Kruglov Pavel](https://github.com/Avogar)).
* Исключён возврат потока в пул потоков concurrent hash join, чтобы предотвратить чрезмерное создание потоков запросом. [#69406](https://github.com/ClickHouse/ClickHouse/pull/69406) ([Duc Canh Le](https://github.com/canhld94)).



#### Улучшение {#improvement-3}

* CREATE TABLE AS теперь копирует PRIMARY KEY, ORDER BY и аналогичные конструкции. Сейчас это поддерживается только для семейства движков таблиц MergeTree. [#69076](https://github.com/ClickHouse/ClickHouse/pull/69076) ([sakulali](https://github.com/sakulali)).
* Усилены части кодовой базы, связанные с парсингом небольших сущностей. Были найдены и исправлены следующие (незначительные) ошибки: - если таблица `DeltaLake` партиционирована по типу Bool, значение партиции всегда интерпретируется как false; - таблица `ExternalDistributed` использовала только один шард из переданных адресов; значение настройки `max_threads` и подобных выводилось как `'auto(N)'` вместо `auto(N)`. [#52503](https://github.com/ClickHouse/ClickHouse/pull/52503) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Используйте метрики cgroup для учета загрузки CPU вместо системных метрик. [#62003](https://github.com/ClickHouse/ClickHouse/pull/62003) ([Nikita Taranov](https://github.com/nickitat)).
* Планирование операций ввода-вывода для удалённых дисков S3 теперь выполняется на уровне потоков HTTP-сокетов (вместо целых запросов S3), чтобы устранить проблемы с ограничением пропускной способности (`bandwidth_limit`). [#65182](https://github.com/ClickHouse/ClickHouse/pull/65182) ([Sergei Trifonov](https://github.com/serxa)).
* Функции `upperUTF8` и `lowerUTF8` ранее могли изменять регистр только кириллических символов. Это ограничение снято: теперь они работают с символами на любом языке. Пример: `SELECT upperUTF8('Süden')` возвращает `SÜDEN`. [#65761](https://github.com/ClickHouse/ClickHouse/pull/65761) ([李扬](https://github.com/taiyang-li)).
* При выполнении lightweight delete в таблице с проекциями, помимо уже существующих вариантов — по умолчанию выбросить исключение или удалить проекцию при выполнении lightweight delete — теперь доступен третий вариант: все же выполнить lightweight delete, а затем перестроить проекции. [#66169](https://github.com/ClickHouse/ClickHouse/pull/66169) ([jsc0218](https://github.com/jsc0218)).
* Добавлены два параметра (`dns_allow_resolve_names_to_ipv4` и `dns_allow_resolve_names_to_ipv6`), позволяющие блокировать подключения для определённых семейств IP-адресов. [#66895](https://github.com/ClickHouse/ClickHouse/pull/66895) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Добавлена возможность настраивать игнорирование Ctrl-Z (ignore&#95;shell&#95;suspend) в clickhouse-client. [#67134](https://github.com/ClickHouse/ClickHouse/pull/67134) ([Azat Khuzhin](https://github.com/azat)).
* Улучшена проверка UTF-8 в форматах вывода JSON. Это гарантирует генерацию корректного JSON при наличии некоторых последовательностей байт в результирующих данных. [#67938](https://github.com/ClickHouse/ClickHouse/pull/67938) ([mwoenker](https://github.com/mwoenker)).
* Добавлены события профилирования для слияний и мутаций для более детального анализа. [#68015](https://github.com/ClickHouse/ClickHouse/pull/68015) ([Anton Popov](https://github.com/CurtizJ)).
* ODBC: получать значение http&#95;max&#95;tries из конфигурации сервера. [#68128](https://github.com/ClickHouse/ClickHouse/pull/68128) ([Rodolphe Dugé de Bernonville](https://github.com/RodolpheDuge)).
* Добавлена поддержка подстановочных символов (wildcard) для идентификации пользователей в расширении X.509 SubjectAltName. [#68236](https://github.com/ClickHouse/ClickHouse/pull/68236) ([Marco Vilas Boas](https://github.com/marco-vb)).
* Улучшено определение схемы для дат и времени. Теперь `DateTime64` используется только тогда, когда значение даты и времени имеет дробную часть, в противном случае используется обычный DateTime. Определение типов Date/DateTime стало более строгим, особенно при `date_time_input_format='best_effort'`, чтобы избежать интерпретации строк как значений даты и времени в пограничных случаях. [#68382](https://github.com/ClickHouse/ClickHouse/pull/68382) ([Kruglov Pavel](https://github.com/Avogar)).
* Удалён старый код поддержки именованных коллекций в словарях и заменён новым, который позволяет использовать в словарях именованные коллекции, созданные с помощью DDL. Закрыты [#60936](https://github.com/ClickHouse/ClickHouse/issues/60936), [#36890](https://github.com/ClickHouse/ClickHouse/issues/36890). [#68412](https://github.com/ClickHouse/ClickHouse/pull/68412) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Используйте HTTP/1.1 вместо HTTP/1.0 (по умолчанию используется HTTP/1.0) для внешних HTTP-аутентификаторов. [#68456](https://github.com/ClickHouse/ClickHouse/pull/68456) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Добавлен новый набор метрик для анализа работы пула потоков, обеспечивающий более глубокое понимание его производительности и поведения. [#68674](https://github.com/ClickHouse/ClickHouse/pull/68674) ([filimonov](https://github.com/filimonov)).
* Добавлена поддержка параметров запроса в асинхронных вставках в формате `Values`. [#68741](https://github.com/ClickHouse/ClickHouse/pull/68741) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена поддержка типа `Date32` в функциях `dateTrunc` и `toStartOfInterval`. [#68874](https://github.com/ClickHouse/ClickHouse/pull/68874) ([LiuNeng](https://github.com/liuneng1994)).
* Добавлены столбцы `plan_step_name` и `plan_step_description` в таблицу `system.processors_profile_log`. [#68954](https://github.com/ClickHouse/ClickHouse/pull/68954) ([Alexander Gololobov](https://github.com/davenger)).
* Поддержка испанского языка во встроенных словарях. [#69035](https://github.com/ClickHouse/ClickHouse/pull/69035) ([Vasily Okunev](https://github.com/VOkunev)).
* Добавлено указание архитектуры CPU в краткое сообщение об ошибке. [#69037](https://github.com/ClickHouse/ClickHouse/pull/69037) ([Konstantин Bogданов](https://github.com/thevar1able)).
* Запросы будут быстрее завершаться с ошибкой, если при повторных попытках не удаётся установить новое соединение с Keeper. [#69148](https://github.com/ClickHouse/ClickHouse/pull/69148) ([Raúl Marín](https://github.com/Algunenano)).
* Обновлена `DatabaseFactory`, чтобы пользовательские движки баз данных поддерживали аргументы, настройки и переопределения таблиц (аналогично `StorageFactory`). [#69201](https://github.com/ClickHouse/ClickHouse/pull/69201) ([NikBarykin](https://github.com/NikBarykin)).
* Режим восстановления, в котором все внешние движки таблиц и табличные функции заменяются на движок `Null` (настройки `restore_replace_external_engines_to_null`, `restore_replace_external_table_functions_to_null`), завершался с ошибкой, если у таблицы были SETTINGS. Теперь в этом случае из определения таблицы удаляются настройки, и такие таблицы можно восстановить. [#69253](https://github.com/ClickHouse/ClickHouse/pull/69253) ([Ilya Yatsishin](https://github.com/qoega)).
* CLICKHOUSE&#95;PASSWORD корректно экранируется для XML в entrypoint-скрипте образа ClickHouse. [#69301](https://github.com/ClickHouse/ClickHouse/pull/69301) ([aohoyd](https://github.com/aohoyd)).
* Разрешить пустые аргументы для `arrayZip`/`arrayZipUnaligned`, аналогично тому, как это было сделано для `concat` в [https://github.com/ClickHouse/ClickHouse/pull/65887](https://github.com/ClickHouse/ClickHouse/pull/65887). Это сделано для совместимости со Spark в Gluten CH Backend. [#69576](https://github.com/ClickHouse/ClickHouse/pull/69576) ([李扬](https://github.com/taiyang-li)).
* Расширена поддержка более сложных параметров SSL для внутреннего взаимодействия Keeper (например, закрытых ключей с паролем). [#69582](https://github.com/ClickHouse/ClickHouse/pull/69582) ([Antonio Andelic](https://github.com/antonio2368)).
* Анализ индексов может занимать заметное время для больших таблиц с множеством частей или партиций. Это изменение позволяет прерывать тяжёлый запрос на этом этапе. [#69606](https://github.com/ClickHouse/ClickHouse/pull/69606) ([Alexander Gololobov](https://github.com/davenger)).
* Маскирование чувствительной информации в табличной функции `gcs`. [#69611](https://github.com/ClickHouse/ClickHouse/pull/69611) ([Vitaly Baranov](https://github.com/vitlibar)).
* Перестроена проекция для слияний, уменьшающих число строк. [#62364](https://github.com/ClickHouse/ClickHouse/pull/62364) ([cangyin](https://github.com/cangyin)).





#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-3}

* Исправлено подключение таблицы, когда имя базы данных PostgreSQL (pg dbname) содержит «-», в экспериментальном, неподдерживаемом движке MaterializedPostgreSQL. [#62730](https://github.com/ClickHouse/ClickHouse/pull/62730) ([takakawa](https://github.com/takakawa)).
* Исправлена ошибка в сгенерированных столбцах в экспериментальном и полностью неподдерживаемом движке MaterializedPostgreSQL при нарушении порядка adnum [#63161](https://github.com/ClickHouse/ClickHouse/issues/63161). Исправлена ошибка в столбце id с выражением nextval в качестве значения по умолчанию в экспериментальном и полностью неподдерживаемом движке MaterializedPostgreSQL при наличии сгенерированных столбцов в таблице. Исправлена ошибка при удалении публикации, имя которой содержало символы, отличные от [a-z1-9-]. [#67664](https://github.com/ClickHouse/ClickHouse/pull/67664) ([Kruglov Kirill](https://github.com/1on)).
* Storage Join: поддержка столбцов Nullable в левой таблице, закрыт [#61247](https://github.com/ClickHouse/ClickHouse/issues/61247). [#66926](https://github.com/ClickHouse/ClickHouse/pull/66926) ([vdimir](https://github.com/vdimir)).
* Некорректный результат запроса с параллельными репликами (а также при распределении запросов), когда оператор `IN` содержит приведение к Decimal(). Баг появился с новым анализатором. [#67234](https://github.com/ClickHouse/ClickHouse/pull/67234) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлена проблема, при которой `ALTER MODIFY ORDER BY` приводил к несогласованным метаданным. [#67436](https://github.com/ClickHouse/ClickHouse/pull/67436) ([iceFireser](https://github.com/iceFireser)).
* Исправлена верхняя граница допустимого диапазона функции `fromModifiedJulianDay`. Она должна была быть `9999-12-31`, но по ошибке была установлена как `9999-01-01`. [#67583](https://github.com/ClickHouse/ClickHouse/pull/67583) ([PHO](https://github.com/depressed-pho)).
* Исправлена ошибка, возникавшая, если индекс находился не в начале кортежа в запросе с `IN`. [#67626](https://github.com/ClickHouse/ClickHouse/pull/67626) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена логика истечения срока действия записей в `RoleCache`. [#67748](https://github.com/ClickHouse/ClickHouse/pull/67748) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена проблема, из-за которой в window view отсутствовали блоки при медленном сбросе (flush) данных в представление. [#67983](https://github.com/ClickHouse/ClickHouse/pull/67983) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена ошибка MSan, вызванная некорректным форматом даты. [#68105](https://github.com/ClickHouse/ClickHouse/pull/68105) ([JackyWoo](https://github.com/JackyWoo)).
* Исправлено аварийное завершение при фильтрации Parquet, которое происходило, когда типы данных в файле существенно отличались от запрошенных типов (например, `... FROM file('a.parquet', Parquet, 'x String')`, но в файле `x Int64`). Без этого исправления используйте `input_format_parquet_filter_push_down = 0` как временное решение. [#68131](https://github.com/ClickHouse/ClickHouse/pull/68131) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлен сбой в `lag`/`lead`, вызванный изменениями из [#67091](https://github.com/ClickHouse/ClickHouse/issues/67091). [#68262](https://github.com/ClickHouse/ClickHouse/pull/68262) ([lgbo](https://github.com/lgbo-ustc)).
* Попытка исправить сбой Postgres при отмене запроса. [#68288](https://github.com/ClickHouse/ClickHouse/pull/68288) ([Kseniia Sumarokova](https://github.com/kssenii)).
* После изменений из [https://github.com/ClickHouse/ClickHouse/pull/61984](https://github.com/ClickHouse/ClickHouse/pull/61984) параметр `schema_inference_make_columns_nullable=0` всё ещё мог делать столбцы `Nullable` в форматах Parquet/Arrow. Это изменение было несовместимо с предыдущим поведением, и пользователи заметили разницу. Этот PR возвращает параметр `schema_inference_make_columns_nullable=0` к прежнему поведению (столбцы `Nullable` больше не будут выводиться) и вводит новое значение `auto` для этого параметра, при котором столбцы будут становиться `Nullable` только если в данных есть информация о возможности хранения значений NULL. [#68298](https://github.com/ClickHouse/ClickHouse/pull/68298) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправляет [#50868](https://github.com/ClickHouse/ClickHouse/issues/50868). Небольшие константные значения типа DateTime64, возвращаемые вложенным подзапросом внутри распределённого запроса, ошибочно преобразовывались в Null, что приводило к ошибкам и потенциально некорректным результатам запроса. [#68323](https://github.com/ClickHouse/ClickHouse/pull/68323) ([Shankar](https://github.com/shiyer7474)).
* Исправлен пропущенный режим синхронизации реплики в запросе `SYSTEM SYNC REPLICA`. [#68326](https://github.com/ClickHouse/ClickHouse/pull/68326) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлена ошибка в ключевом условии. [#68354](https://github.com/ClickHouse/ClickHouse/pull/68354) ([Han Fei](https://github.com/hanfei1991)).
* Исправлен сбой при удалении или переименовании роли, используемой во внешнем пользовательском каталоге LDAP. [#68355](https://github.com/ClickHouse/ClickHouse/pull/68355) ([Andrey Zvonov](https://github.com/zvonand)).
* Исправлено значение столбца Progress в system.view&#95;refreshes, которое могло быть больше 1 [#68377](https://github.com/ClickHouse/ClickHouse/issues/68377). [#68378](https://github.com/ClickHouse/ClickHouse/pull/68378) ([megao](https://github.com/jetgm)).
* Корректно обрабатывать флаги регулярных выражений. [#68389](https://github.com/ClickHouse/ClickHouse/pull/68389) ([Han Fei](https://github.com/hanfei1991)).
* Оператор приведения типов в стиле PostgreSQL (`::`) корректно работает в том числе для строковых литералов в шестнадцатеричном и двоичном формате в стиле SQL (например, `SELECT x'414243'::String`). Это закрывает [#68324](https://github.com/ClickHouse/ClickHouse/issues/68324). [#68482](https://github.com/ClickHouse/ClickHouse/pull/68482) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Небольшое исправление для [https://github.com/ClickHouse/ClickHouse/pull/68131](https://github.com/ClickHouse/ClickHouse/pull/68131). [#68494](https://github.com/ClickHouse/ClickHouse/pull/68494) ([Chang Chen](https://github.com/baibaichen)).
* Исправлена ошибка [#68239](https://github.com/ClickHouse/ClickHouse/issues/68239) в SAMPLE n, где n — целое число. [#68499](https://github.com/ClickHouse/ClickHouse/pull/68499) ([Denis Hananein](https://github.com/denis-hananein)).
* Исправлена ошибка в mann-whitney-utest при разных размерах двух распределений. [#68556](https://github.com/ClickHouse/ClickHouse/pull/68556) ([Han Fei](https://github.com/hanfei1991)).
* После непредвиденной перезагрузки не удаётся запустить репликацию ReplicatedMergeTree из-за некорректной обработки части, перекрытой повреждённой частью. [#68584](https://github.com/ClickHouse/ClickHouse/pull/68584) ([baolin](https://github.com/baolinhuang)).
* Исправлены ошибки типа `LOGICAL_ERROR` при применении функций `sipHash64Keyed`, `sipHash128Keyed` или `sipHash128ReferenceKeyed` к пустым массивам или кортежам. [#68630](https://github.com/ClickHouse/ClickHouse/pull/68630) ([Robert Schulze](https://github.com/rschu1ze)).
* Полнотекстовый индекс мог некорректно отфильтровывать столбцы при индексировании нескольких столбцов: `row_id` не сбрасывался между разными столбцами. Процедура воспроизведения приведена в tests/queries/0&#95;stateless/03228&#95;full&#95;text&#95;with&#95;multi&#95;col.sql. Исправлено в [#68644](https://github.com/ClickHouse/ClickHouse/pull/68644) ([siyuan](https://github.com/linkwk7)).
* Исправлена ошибка обработки недопустимых символов &#39;\t&#39; и &#39;\n&#39; в replica&#95;name при создании Replicated-таблицы, из-за которой происходил неверный разбор &#39;source replica&#39; в LogEntry. Упомянуто в issue [#68640](https://github.com/ClickHouse/ClickHouse/issues/68640). [#68645](https://github.com/ClickHouse/ClickHouse/pull/68645) ([Zhigao Hong](https://github.com/zghong)).
* Возвращены виртуальные столбцы `_table` и `_database` в распределённых таблицах. Они были доступны до версии 24.3. [#68672](https://github.com/ClickHouse/ClickHouse/pull/68672) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена возможная ошибка `Size of permutation (0) is less than required (...)` при перестановке столбца типа Variant. [#68681](https://github.com/ClickHouse/ClickHouse/pull/68681) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена потенциальная ошибка `DB::Exception: Block structure mismatch in joined block stream: different columns:` при использовании нового столбца JSON. [#68686](https://github.com/ClickHouse/ClickHouse/pull/68686) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена проблема с материализованными константными ключами при хешировании значений типа Map с массивами в качестве ключей в функциях `sipHash(64/128)Keyed`. [#68731](https://github.com/ClickHouse/ClickHouse/pull/68731) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Сделать так, чтобы `ColumnsDescription::toString` форматировал каждый столбец, используя один и тот же объект `IAST::FormatState`. В результате на диск и в ZooKeeper записываются единообразные метаданные столбцов. [#68733](https://github.com/ClickHouse/ClickHouse/pull/68733) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Исправлено объединение агрегированных данных для `GROUPING SETS`. [#68744](https://github.com/ClickHouse/ClickHouse/pull/68744) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена логическая ошибка, возникавшая при создании реплицированного MergeTree, изменении столбца и последующем выполнении MODIFY STATISTICS. [#68820](https://github.com/ClickHouse/ClickHouse/pull/68820) ([Han Fei](https://github.com/hanfei1991)).
* Исправлено разрешение динамических подколонок в подзапросах анализатором. [#68824](https://github.com/ClickHouse/ClickHouse/pull/68824) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен разбор метаданных составных типов данных в Delta Lake. Закрывает [#68739](https://github.com/ClickHouse/ClickHouse/issues/68739). [#68836](https://github.com/ClickHouse/ClickHouse/pull/68836) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлены асинхронные вставки в случае, если метаданные таблицы изменяются (запросами `ALTER ADD/MODIFY COLUMN`) после вставки, но до сброса в таблицу. [#68837](https://github.com/ClickHouse/ClickHouse/pull/68837) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена неожиданная ошибка при передаче пустого кортежа в массив, что устраняет [#68618](https://github.com/ClickHouse/ClickHouse/issues/68618). [#68848](https://github.com/ClickHouse/ClickHouse/pull/68848) ([Amos Bird](https://github.com/amosbird)).
* Исправлен разбор команд мутаций, затрагивающих только метаданные. [#68935](https://github.com/ClickHouse/ClickHouse/pull/68935) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлен возможный некорректный результат при слиянии состояния anyHeavy. [#68950](https://github.com/ClickHouse/ClickHouse/pull/68950) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена запись в материализованные представления при включённой настройке `optimize_functions_to_subcolumns`. [#68951](https://github.com/ClickHouse/ClickHouse/pull/68951) ([Anton Popov](https://github.com/CurtizJ)).
* Не используйте кэш сериализаций в const-методах столбца Dynamic. Это может привести к использованию неинициализированного значения или даже к гонке условий во время агрегаций. [#68953](https://github.com/ClickHouse/ClickHouse/pull/68953) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка разбора, при которой в некоторых случаях при разборе типа JSON в качестве значения по умолчанию следовало вставлять `null`. [#68955](https://github.com/ClickHouse/ClickHouse/pull/68955) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена проблема, из-за которой `Content-Encoding` не отправлялся в некоторых сжатых ответах. [#64802](https://github.com/ClickHouse/ClickHouse/issues/64802). [#68975](https://github.com/ClickHouse/ClickHouse/pull/68975) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Были случаи, когда путь формировался некорректно и содержал подстроку `//`; эта проблема решена с помощью нормализации пути. [#69066](https://github.com/ClickHouse/ClickHouse/pull/69066) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена логическая ошибка, возникающая при пустой асинхронной вставке. [#69080](https://github.com/ClickHouse/ClickHouse/pull/69080) ([Han Fei](https://github.com/hanfei1991)).
* Исправлена гонка данных при обновлении индикатора прогресса в clickhouse-client во время отмены запроса. [#69081](https://github.com/ClickHouse/ClickHouse/pull/69081) ([Sergei Trifonov](https://github.com/serxa)).
* Исправлена ошибка, из-за которой индекс векторного сходства (в данный момент экспериментальный) не использовался при использовании косинусного расстояния как функции расстояния. [#69090](https://github.com/ClickHouse/ClickHouse/pull/69090) ([flynn](https://github.com/ucasfl)).
* Это изменение устраняет проблему, при которой попытка повторно создать базу данных Replicated после сбоя сервера во время ее первоначального создания могла приводить к ошибке. [#69102](https://github.com/ClickHouse/ClickHouse/pull/69102) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Не выводите тип Bool из строкового значения String в CSV, когда `input_format_csv_try_infer_numbers_from_strings = 1`, так как чтение логических значений из строк не поддерживается. [#69109](https://github.com/ClickHouse/ClickHouse/pull/69109) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлены ошибки разбора запросов `EXPLAIN AST INSERT` на клиенте при включённом флаге `--multiquery`. [#69123](https://github.com/ClickHouse/ClickHouse/pull/69123) ([wxybear](https://github.com/wxybear)).
* Оператор `UNION` в подзапросах обрабатывался некорректно в запросах с параллельными репликами, что приводило к LOGICAL&#95;ERROR `Duplicate announcement received for replica`. [#69146](https://github.com/ClickHouse/ClickHouse/pull/69146) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлена передача аргумента `structure` в s3Cluster. Ранее выражение `DEFAULT` столбца могло теряться при отправке запроса на реплики в s3Cluster. [#69147](https://github.com/ClickHouse/ClickHouse/pull/69147) ([Kruglov Pavel](https://github.com/Avogar)).
* Учитывать настройки формата Values при преобразовании выражения в целевой тип. [#69149](https://github.com/ClickHouse/ClickHouse/pull/69149) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена работа `clickhouse-client --queries-file` для пользователей с правами только на чтение (ранее приводило к ошибке `Cannot modify 'log_comment' setting in readonly mode`). [#69175](https://github.com/ClickHouse/ClickHouse/pull/69175) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена гонка данных в clickhouse-client при передаче его вывода по конвейеру в процесс, который завершился преждевременно. [#69186](https://github.com/ClickHouse/ClickHouse/pull/69186) ([vdimir](https://github.com/vdimir)).
* Исправлены некорректные результаты функции uniq и GROUP BY для типов JSON и Dynamic. [#69203](https://github.com/ClickHouse/ClickHouse/pull/69203) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена логика определения формата INFILE для асинхронных вставок. Если формат явно не задан в предложении FORMAT, он может быть определён по расширению файла INFILE. [#69237](https://github.com/ClickHouse/ClickHouse/pull/69237) ([Julia Kartseva](https://github.com/jkartseva)).
* После [этой проблемы](https://github.com/ClickHouse/ClickHouse/pull/59946#issuecomment-1943653197) в production-среде появилось довольно много реплик таблиц, у которых значение узла `metadata_version` одновременно равно `0` и отличается от версии узла `metadata` соответствующей таблицы. Это приводит к сбоям `alter`-запросов на таких репликах. [#69274](https://github.com/ClickHouse/ClickHouse/pull/69274) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Тип Dynamic помечен как небезопасный тип первичного ключа, чтобы избежать проблем с Fields. [#69311](https://github.com/ClickHouse/ClickHouse/pull/69311) ([Kruglov Pavel](https://github.com/Avogar)).
* Улучшено восстановление зависимостей объектов доступа. [#69346](https://github.com/ClickHouse/ClickHouse/pull/69346) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено неопределённое поведение при неудаче всех попыток установить соединение для вставок. [#69390](https://github.com/ClickHouse/ClickHouse/pull/69390) ([Pablo Marcos](https://github.com/pamarcos)).
* Закрыть [#69135](https://github.com/ClickHouse/ClickHouse/issues/69135). Если попытаться переиспользовать соединённые данные для `CROSS JOIN`, то в текущей версии ClickHouse это сделать нельзя. Лучше сохранить `have_compressed` в `reuseJoinedData`. [#69404](https://github.com/ClickHouse/ClickHouse/pull/69404) ([lgbo](https://github.com/lgbo-ustc)).
* Сделать так, чтобы функция `materialize()` возвращала полный столбец, если параметр — разреженный столбец. [#69429](https://github.com/ClickHouse/ClickHouse/pull/69429) ([Alexander Gololobov](https://github.com/davenger)).
* Исправлено исключение `LOGICAL_ERROR` в функции `sqidDecode` ([#69450](https://github.com/ClickHouse/ClickHouse/issues/69450)). [#69451](https://github.com/ClickHouse/ClickHouse/pull/69451) ([Robert Schulze](https://github.com/rschu1ze)).
* Быстрое исправление проблемы s3queue в версии 24.6 при выполнении запроса CREATE с реплицируемой базой данных. [#69454](https://github.com/ClickHouse/ClickHouse/pull/69454) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ситуация, когда потребление памяти становилось слишком высоким из‑за слияния в запросах `INSERT INTO ... SELECT` или `CREATE TABLE AS SELECT`. [#69469](https://github.com/ClickHouse/ClickHouse/pull/69469) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Операторы `SHOW COLUMNS` и `SHOW INDEX` теперь корректно работают с таблицами, имена которых содержат точки. [#69514](https://github.com/ClickHouse/ClickHouse/pull/69514) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Использование кэша запросов для запросов с режимом переполнения, отличным от &#39;throw&#39;, теперь не допускается. Это предотвращает ситуации, когда потенциально усечённые и некорректные результаты запросов могли бы быть сохранены в кэше запросов. (issue [#67476](https://github.com/ClickHouse/ClickHouse/issues/67476)). [#69549](https://github.com/ClickHouse/ClickHouse/pull/69549) ([Robert Schulze](https://github.com/rschu1ze)).
* Сохранять исходный порядок условий при переносе в секцию PREWHERE. Ранее порядок мог изменяться, что приводило к ошибкам выполнения запросов, когда порядок важен. [#69560](https://github.com/ClickHouse/ClickHouse/pull/69560) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена предварительная обработка многозапросных операций Keeper после ошибки ZNOAUTH. [#69627](https://github.com/ClickHouse/ClickHouse/pull/69627) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка METADATA&#95;MISMATCH, которая могла возникать при создании новой реплики в DatabaseReplicated из-за TTL с условием WHERE. [#69736](https://github.com/ClickHouse/ClickHouse/pull/69736) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена настройка `tracked_file_ttl_sec` для `StorageS3(Azure)Queue`. Мы записывали её в Keeper с ключом `tracked_file_ttl_sec`, но читали как `tracked_files_ttl_sec`, что было опечаткой. [#69742](https://github.com/ClickHouse/ClickHouse/pull/69742) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Использовать функцию tryconvertfieldtotype в gethyperrectangleforrowgroup. [#69745](https://github.com/ClickHouse/ClickHouse/pull/69745) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Откат исправления «Fix prewhere without columns and without adaptive index granularity (almost w/o anything)». В результате отката этих изменений возможны ошибки при чтении частей данных, созданных старыми релизами ClickHouse (предположительно 2021 года или более ранними). [#68897](https://github.com/ClickHouse/ClickHouse/pull/68897) ([Alexander Gololobov](https://github.com/davenger)).



### <a id="248"></a> Релиз ClickHouse 24.8 LTS, 2024-08-20 {#a-id248a-clickhouse-release-248-lts-2024-08-20}

#### Обратное несовместимое изменение {#backward-incompatible-change-4}
* `clickhouse-client` и `clickhouse-local` теперь по умолчанию работают в режиме multi-query (вместо single-query). Например, `clickhouse-client -q "SELECT 1; SELECT 2"` теперь работает, тогда как ранее пользователям нужно было добавлять `--multiquery` (или `-n`). Переключатель `--multiquery/-n` объявлен устаревшим. INSERT‑запросы в multi-query‑режиме обрабатываются особым образом в зависимости от их предложения FORMAT: если FORMAT — `VALUES` (наиболее распространённый случай), конец оператора INSERT задаётся завершающей точкой с запятой `;` в конце запроса. Для всех остальных FORMAT (например, `CSV` или `JSONEachRow`) конец оператора INSERT задаётся двумя переводами строки `\n\n` в конце запроса. [#63898](https://github.com/ClickHouse/ClickHouse/pull/63898) ([FFish](https://github.com/wxybear)).
* В предыдущих версиях было возможно использовать альтернативный синтаксис для типов данных `LowCardinality`, добавляя `WithDictionary` к имени типа данных. Это была первоначальная рабочая реализация, она никогда не документировалась и не была доступна публично. Теперь она объявлена устаревшей. Если вы использовали этот синтаксис, вам необходимо выполнить ALTER для ваших таблиц и переименовать типы данных в `LowCardinality`. [#66842](https://github.com/ClickHouse/ClickHouse/pull/66842) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлены логические ошибки при использовании хранилища `Buffer` с распределённой конечной таблицей. Это обратное несовместимое изменение: запросы, использующие `Buffer` с распределённой конечной таблицей, могут перестать работать, если таблица встречается в запросе более одного раза (например, в самосоединении, self-join). [#67015](https://github.com/ClickHouse/ClickHouse/pull/67015) ([vdimir](https://github.com/vdimir)).
* В предыдущих версиях вызов функций для случайных распределений, основанных на гамма‑функции (таких как хи‑квадрат, Стьюдента, Фишера), с отрицательными аргументами, близкими к нулю, приводил к длительным вычислениям или к бесконечному циклу. В новой версии вызов этих функций с нулевыми или отрицательными аргументами приводит к генерации исключения. Это решает проблему [#67297](https://github.com/ClickHouse/ClickHouse/issues/67297). [#67326](https://github.com/ClickHouse/ClickHouse/pull/67326) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Системная таблица `text_log` теперь включена по умолчанию. Это полностью совместимо с предыдущими версиями, но вы можете заметить немного возросшее использование локального диска (эта системная таблица занимает очень небольшой объём дискового пространства). [#67428](https://github.com/ClickHouse/ClickHouse/pull/67428) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* В предыдущих версиях `arrayWithConstant` могла работать медленно при генерации очень больших массивов. В новой версии она ограничена 1 ГБ на массив. Это решает проблему [#32754](https://github.com/ClickHouse/ClickHouse/issues/32754). [#67741](https://github.com/ClickHouse/ClickHouse/pull/67741) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено форматирование модификатора REPLACE (запрещено опускать скобки). [#67774](https://github.com/ClickHouse/ClickHouse/pull/67774) ([Azat Khuzhin](https://github.com/azat)).
* Бэкпортировано в [#68349](https://github.com/ClickHouse/ClickHouse/issues/68349): заново реализован тип `Dynamic`. Теперь, когда достигается лимит динамических типов данных, новые типы не приводятся к String, а сохраняются в специальной структуре данных в бинарном формате с двоичным кодированием типа данных. Теперь любой тип, когда‑либо вставленный в столбец `Dynamic`, может быть считан из него как подстолбец. [#68132](https://github.com/ClickHouse/ClickHouse/pull/68132) ([Kruglov Pavel](https://github.com/Avogar)).



#### Новая возможность {#new-feature-4}

* Добавлена новая настройка движка `MergeTree` `deduplicate_merge_projection_mode` для управления проекциями во время слияний (для определённых движков) и запроса `OPTIMIZE DEDUPLICATE`. Поддерживаемые варианты: `throw` (выбрасывать исключение, если проекция не полностью поддерживается для *движка MergeTree*), `drop` (удалять проекцию во время слияния, если её нельзя корректно слить) и `rebuild` (полностью перестраивать проекцию с нуля, что является ресурсоёмкой операцией). [#66672](https://github.com/ClickHouse/ClickHouse/pull/66672) ([jsc0218](https://github.com/jsc0218)).
* Добавлен виртуальный столбец `_etag` для движка таблиц S3. Исправлена проблема [#65312](https://github.com/ClickHouse/ClickHouse/issues/65312). [#65386](https://github.com/ClickHouse/ClickHouse/pull/65386) ([skyoct](https://github.com/skyoct)).
* Добавлен механизм тегирования (пространства имён) для кэша запросов. Одинаковые запросы с разными тегами считаются различными для кэша запросов. Пример: `SELECT 1 SETTINGS use_query_cache = 1, query_cache_tag = 'abc'` и `SELECT 1 SETTINGS use_query_cache = 1, query_cache_tag = 'def'` теперь создают разные записи в кэше запросов. [#68235](https://github.com/ClickHouse/ClickHouse/pull/68235) ([sakulali](https://github.com/sakulali)).
* Добавлена поддержка большего числа вариантов строгости JOIN (`LEFT/RIGHT SEMI/ANTI/ANY JOIN`) с условиями неравенства, которые ссылаются на столбцы как левой, так и правой таблиц, например `t1.y &lt; t2.y` (см. настройку `allow_experimental_join_condition`). [#64281](https://github.com/ClickHouse/ClickHouse/pull/64281) ([lgbo](https://github.com/lgbo-ustc)).
* Поддерживается секционирование в стиле Hive для различных движков (`File`, `URL`, `S3`, `AzureBlobStorage`, `HDFS`). Секционирование в стиле Hive организует данные в секционированные подкаталоги, что обеспечивает эффективное выполнение запросов и управление большими наборами данных. В настоящее время оно только создаёт виртуальные столбцы с соответствующими именами и данными. В следующем PR будет добавлена соответствующая фильтрация данных (для повышения производительности). [#65997](https://github.com/ClickHouse/ClickHouse/pull/65997) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена функция `printf` для совместимости со Spark (однако по-прежнему можно использовать существующую функцию `format`). [#66257](https://github.com/ClickHouse/ClickHouse/pull/66257) ([李扬](https://github.com/taiyang-li)).
* Добавлены параметры `restore_replace_external_engines_to_null` и `restore_replace_external_table_functions_to_null` для замены внешних движков и табличных функций на движок `Null`, что может быть полезно для тестирования. Они работают как при RESTORE, так и при явном создании таблиц. [#66536](https://github.com/ClickHouse/ClickHouse/pull/66536) ([Ilya Yatsishin](https://github.com/qoega)).
* Добавлена поддержка чтения геометрии `MULTILINESTRING` в формате `WKT` с помощью функции `readWKTLineString`. [#67647](https://github.com/ClickHouse/ClickHouse/pull/67647) ([Jacob Reckhard](https://github.com/jacobrec)).
* Добавлена новая табличная функция `fuzzQuery`. Эта функция позволяет модифицировать заданную строку запроса, внося в неё случайные изменения. Пример: `SELECT query FROM fuzzQuery('SELECT 1') LIMIT 5;`. [#67655](https://github.com/ClickHouse/ClickHouse/pull/67655) ([pufit](https://github.com/pufit)).
* Добавлен запрос `ALTER TABLE ... DROP DETACHED PARTITION ALL` для удаления всех отсоединённых партиций. [#67885](https://github.com/ClickHouse/ClickHouse/pull/67885) ([Duc Canh Le](https://github.com/canhld94)).
* Добавлена статистика `rows_before_aggregation_at_least` в ответ на запрос при включении новой настройки `rows_before_aggregation`. Эта статистика отражает количество строк, прочитанных до агрегации. В контексте распределённого запроса, при использовании операции `group by` или агрегатной функции `max` без `limit`, `rows_before_aggregation_at_least` может отражать количество строк, обработанных запросом. [#66084](https://github.com/ClickHouse/ClickHouse/pull/66084) ([morning-color](https://github.com/morning-color)).
* Добавлена поддержка запроса `OPTIMIZE` для таблиц `Join`, что позволяет уменьшить их потребление памяти. [#67883](https://github.com/ClickHouse/ClickHouse/pull/67883) ([Duc Canh Le](https://github.com/canhld94)).
* Добавлена возможность мгновенно выполнять запрос в Play при добавлении `&run=1` в URL [#66457](https://github.com/ClickHouse/ClickHouse/pull/66457) ([Aleksandr Musorin](https://github.com/AVMusorin)).



#### Экспериментальная функция {#experimental-feature-3}
* Реализован новый тип данных `JSON`. [#66444](https://github.com/ClickHouse/ClickHouse/pull/66444) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен новый движок таблиц `TimeSeries`. [#64183](https://github.com/ClickHouse/ClickHouse/pull/64183) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлен новый экспериментальный движок хранилища `Kafka` для сохранения смещений в Keeper вместо фиксации их в Kafka. Это делает фиксацию в таблицы ClickHouse атомарной относительно чтения из очереди. [#57625](https://github.com/ClickHouse/ClickHouse/pull/57625) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Используется адаптивный метод вычисления размера задач чтения (адаптивный означает, что он зависит от размеров читаемых столбцов) для параллельных реплик. [#60377](https://github.com/ClickHouse/ClickHouse/pull/60377) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлен тип статистики `count_min` (скизы count-min), который предоставляет оценки селективности для предикатов равенства, таких как `col = 'val'`. Поддерживаемые типы данных — строковый, дата, дата-время и числовые типы. [#65521](https://github.com/ClickHouse/ClickHouse/pull/65521) ([JackyWoo](https://github.com/JackyWoo)).

#### Улучшение производительности {#performance-improvement-4}
* Настройка `optimize_functions_to_subcolumns` теперь включена по умолчанию. [#68053](https://github.com/ClickHouse/ClickHouse/pull/68053) ([Anton Popov](https://github.com/CurtizJ)).
* Метаданные каталога диска `plain_rewritable` хранятся в структуре `__meta` отдельно от данных MergeTree в объектном хранилище. Диск `plain_rewritable` переведен на плоскую структуру каталогов. [#65751](https://github.com/ClickHouse/ClickHouse/pull/65751) ([Julia Kartseva](https://github.com/jkartseva)).
* Улучшено склеивание столбцов (операция, выполняемая в запросах INSERT) для типов `String`/`Array`/`Map`/`Variant`/`Dynamic` за счет предварительного резервирования требуемой памяти для всех подстолбцов. [#67043](https://github.com/ClickHouse/ClickHouse/pull/67043) ([Kruglov Pavel](https://github.com/Avogar)).
* Ускорена операция `SYSTEM FLUSH LOGS` и выполнен сброс логов при завершении работы. [#67472](https://github.com/ClickHouse/ClickHouse/pull/67472) ([Sema Checherinda](https://github.com/CheSema)).
* Улучшена общая производительность слияний за счет снижения накладных расходов на этапах планирования слияний. [#68016](https://github.com/ClickHouse/ClickHouse/pull/68016) ([Anton Popov](https://github.com/CurtizJ)).
* Ускорено удаление таблиц при выполнении запроса `DROP DATABASE`, значение по умолчанию для `database_catalog_drop_table_concurrency` увеличено до 16. [#67228](https://github.com/ClickHouse/ClickHouse/pull/67228) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исключено выделение избыточной емкости для столбца-массива при записи ORC. Производительность для столбца типа Array увеличена на 15%. [#67879](https://github.com/ClickHouse/ClickHouse/pull/67879) ([李扬](https://github.com/taiyang-li)).
* Существенно ускорены мутации для нереплицируемого движка MergeTree. [#66911](https://github.com/ClickHouse/ClickHouse/pull/66911) [#66909](https://github.com/ClickHouse/ClickHouse/pull/66909) ([Alexey Milovidov](https://github.com/alexey-milovidov)).



#### Улучшение {#improvement-4}

* Настройка `allow_experimental_analyzer` переименована в `enable_analyzer`. Старое имя сохранено как псевдоним. Это означает, что Analyzer больше не является бета-функциональностью и полностью готов к использованию в продуктивной среде. [#66438](https://github.com/ClickHouse/ClickHouse/pull/66438) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Улучшено определение схемы для значений даты и времени. Теперь DateTime64 используется только в том случае, если значение даты и времени имеет дробную часть, иначе используется обычный DateTime. Определение типов Date/DateTime теперь более строгие, особенно при `date_time_input_format='best_effort'`, чтобы избежать вывода дат и времени из строк в пограничных случаях. [#68382](https://github.com/ClickHouse/ClickHouse/pull/68382) ([Kruglov Pavel](https://github.com/Avogar)).
* Сервер ClickHouse теперь поддерживает новый параметр настройки `max_keep_alive_requests`. Для HTTP‑подключений с keep-alive к серверу он работает в связке с `keep_alive_timeout`: если время простоя ещё не истекло, но по данному подключению уже выполнено более `max_keep_alive_requests` запросов, подключение будет закрыто сервером. [#61793](https://github.com/ClickHouse/ClickHouse/pull/61793) ([Nikita Taranov](https://github.com/nickitat)).
* Различные улучшения расширенной панели мониторинга. Закрывает [#67697](https://github.com/ClickHouse/ClickHouse/issues/67697). Закрывает [#63407](https://github.com/ClickHouse/ClickHouse/issues/63407). Закрывает [#51129](https://github.com/ClickHouse/ClickHouse/issues/51129). Закрывает [#61204](https://github.com/ClickHouse/ClickHouse/issues/61204). [#67701](https://github.com/ClickHouse/ClickHouse/pull/67701) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Не нужно выдавать привилегию на REMOTE при создании распределённой таблицы: достаточно привилегии для движка Distributed. [#65419](https://github.com/ClickHouse/ClickHouse/pull/65419) ([jsc0218](https://github.com/jsc0218)).
* Не передавать логи keeper явно в образ Docker, чтобы их можно было переопределить. [#65564](https://github.com/ClickHouse/ClickHouse/pull/65564) ([Azat Khuzhin](https://github.com/azat)).
* Добавлен параметр `use_same_password_for_base_backup` для запросов `BACKUP` и `RESTORE`, позволяющий создавать и восстанавливать инкрементные бэкапы в/из архивов, защищённых паролем. [#66214](https://github.com/ClickHouse/ClickHouse/pull/66214) ([Samuele](https://github.com/sguerrini97)).
* Игнорируется `async_load_databases` для запроса `ATTACH` (ранее `ATTACH` мог завершиться до того, как таблицы были подключены). [#66240](https://github.com/ClickHouse/ClickHouse/pull/66240) ([Azat Khuzhin](https://github.com/azat)).
* Добавлены логи и метрики для отклонённых подключений (при недостатке ресурсов). [#66410](https://github.com/ClickHouse/ClickHouse/pull/66410) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Поддержка корректного типа `UUID` для движка MongoDB. [#66671](https://github.com/ClickHouse/ClickHouse/pull/66671) ([Azat Khuzhin](https://github.com/azat)).
* Добавлены метрики отставания репликации и времени восстановления. [#66703](https://github.com/ClickHouse/ClickHouse/pull/66703) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Добавлена метрика `DiskS3NoSuchKeyErrors`. [#66704](https://github.com/ClickHouse/ClickHouse/pull/66704) ([Miсhael Stetsyuk](https://github.com/mstetsyuk)).
* Обеспечена корректная работа предложения `COMMENT` для всех движков таблиц. [#66832](https://github.com/ClickHouse/ClickHouse/pull/66832) ([Joe Lynch](https://github.com/joelynch)).
* Функция `mapFromArrays` теперь принимает `Map(K, V)` в качестве первого аргумента, например: `SELECT mapFromArrays(map('a', 4, 'b', 4), ['aa', 'bb'])` теперь работает и возвращает `{('a',4):'aa',('b',4):'bb'}`. Кроме того, если первый аргумент — массив, он теперь может иметь тип `Array(Nullable(T))` или `Array(LowCardinality(Nullable(T)))` при условии, что реальные значения массива не равны `NULL`. [#67103](https://github.com/ClickHouse/ClickHouse/pull/67103) ([李扬](https://github.com/taiyang-li)).
* Читать конфигурацию `clickhouse-local` из `~/.clickhouse-local`. [#67135](https://github.com/ClickHouse/ClickHouse/pull/67135) ([Azat Khuzhin](https://github.com/azat)).
* Переименована настройка `input_format_orc_read_use_writer_time_zone` в `input_format_orc_reader_timezone` и добавлена возможность задавать часовой пояс чтения пользователем. [#67175](https://github.com/ClickHouse/ClickHouse/pull/67175) ([kevinyhzou](https://github.com/KevinyhZou)).
* Понижен уровень логирования ошибки `Socket is not connected`, возникающей при немедленном сбросе HTTP-соединения удалённой стороной сразу после установления подключения, закрыта задача [#34218](https://github.com/ClickHouse/ClickHouse/issues/34218). [#67177](https://github.com/ClickHouse/ClickHouse/pull/67177) ([vdimir](https://github.com/vdimir)).
* Добавлена возможность загружать дашборды для `system.dashboards` из конфигурации (после задания они переопределяют набор дашбордов по умолчанию). [#67232](https://github.com/ClickHouse/ClickHouse/pull/67232) ([Azat Khuzhin](https://github.com/azat)).
* Оконные функции в SQL традиционно именуются в стиле `snake_case`. ClickHouse использует `camelCase`, поэтому были созданы новые псевдонимы `denseRank()` и `percentRank()`. Эти новые функции можно вызывать так же, как и исходные функции `dense_rank()` и `percent_rank()`. Оба варианта синтаксиса — и `snake_case`, и `camelCase` — остаются доступными. Также был добавлен новый тест для каждой из функций. Это закрывает [#67042](https://github.com/ClickHouse/ClickHouse/issues/67042). [#67334](https://github.com/ClickHouse/ClickHouse/pull/67334) ([Peter Nguyen](https://github.com/petern48)).
* Автоматическое определение формата файла конфигурации, если его расширение не `.xml`, `.yml` или `.yaml`. Если файл начинается с символа &lt;, предполагается формат XML, в противном случае — YAML. Это полезно при передаче файла конфигурации через конвейер (pipe): `clickhouse-server --config-file &lt;(echo "hello: world")`. [#67391](https://github.com/ClickHouse/ClickHouse/pull/67391) ([sakulali](https://github.com/sakulali)).
* Функции `formatDateTime` и `formatDateTimeInJodaSyntax` теперь рассматривают свой параметр формата как необязательный. Если он не задан, по умолчанию используются строковые форматы `%Y-%m-%d %H:%i:%s` и `yyyy-MM-dd HH:mm:ss`. Пример: `SELECT parseDateTime('2021-01-04 23:12:34')` теперь возвращает значение DateTime `2021-01-04 23:12:34` (ранее это вызывало исключение). [#67399](https://github.com/ClickHouse/ClickHouse/pull/67399) ([Robert Schulze](https://github.com/rschu1ze)).
* Автоматически повторять запросы Keeper в KeeperMap, если они завершаются сбоем из‑за тайм‑аута или потери соединения. [#67448](https://github.com/ClickHouse/ClickHouse/pull/67448) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлен флаг `-no-pie` для сборок Linux на Aarch64, чтобы обеспечить корректный анализ и символизацию стек‑трейсов после перезапуска ClickHouse. [#67916](https://github.com/ClickHouse/ClickHouse/pull/67916) ([filimonov](https://github.com/filimonov)).
* Добавлены события профилирования для слияний и мутаций для более удобного анализа. [#68015](https://github.com/ClickHouse/ClickHouse/pull/68015) ([Anton Popov](https://github.com/CurtizJ)).
* Удалены лишние логи для нереплицируемого `MergeTree`. [#68238](https://github.com/ClickHouse/ClickHouse/pull/68238) ([Daniil Ivanik](https://github.com/divanik)).



#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-1}
* Проверка нестабильности интеграционных тестов теперь запускает каждый тестовый кейс несколько раз, чтобы найти больше проблем в тестах и сделать их более надёжными. Для этого используется библиотека `pytest-repeat`, позволяющая запускать тестовый кейс несколько раз в одном и том же окружении. Важно очищать таблицы и другие сущности в конце тестового кейса, чтобы он проходил. Повторные прогоны работают гораздо быстрее, чем несколько запусков pytest, так как необходимые контейнеры стартуют только один раз. [#66986](https://github.com/ClickHouse/ClickHouse/pull/66986) ([Ilya Yatsishin](https://github.com/qoega)).
* Снято ограничение на использование CLion с ClickHouse. В предыдущих версиях CLion подвисал на минуту при каждом нажатии клавиши. Это закрывает [#66994](https://github.com/ClickHouse/ClickHouse/issues/66994). [#66995](https://github.com/ClickHouse/ClickHouse/pull/66995) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* getauxval: предотвращён сбой при повторном запуске под санитайзером из‑за высокой энтропии ASLR в новых ядрах Linux. [#67081](https://github.com/ClickHouse/ClickHouse/pull/67081) ([Raúl Marín](https://github.com/Algunenano)).
* Часть клиентского кода вынесена в отдельный файл, и к ней применяется максимально возможный уровень оптимизации даже для debug-сборок. Это закрывает: [#65745](https://github.com/ClickHouse/ClickHouse/issues/65745). [#67215](https://github.com/ClickHouse/ClickHouse/pull/67215) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).



#### Исправление ошибки {#bug-fix}

* Актуально только для экспериментального типа данных Variant. Исправлено аварийное завершение при использовании типов Variant и AggregateFunction. [#67122](https://github.com/ClickHouse/ClickHouse/pull/67122) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен сбой DistributedAsyncInsert при пустом соединении. [#67219](https://github.com/ClickHouse/ClickHouse/pull/67219) ([Pablo Marcos](https://github.com/pamarcos)).
* Исправлен сбой `uniq` и `uniqTheta` при использовании аргумента `tuple()`. Закрывает [#67303](https://github.com/ClickHouse/ClickHouse/issues/67303). [#67306](https://github.com/ClickHouse/ClickHouse/pull/67306) ([flynn](https://github.com/ucasfl)).
* Исправляет [#66026](https://github.com/ClickHouse/ClickHouse/issues/66026). Избегает обхода неразрешённых аргументов табличной функции в `ReplaceTableNodeToDummyVisitor`. [#67522](https://github.com/ClickHouse/ClickHouse/pull/67522) ([Dmitry Novik](https://github.com/novikd)).
* Исправлено возможное переполнение стека в функции `JSONMergePatch`. Эта функция была переименована из `jsonMergePatch` в `JSONMergePatch`, так как прежнее имя было некорректным. Предыдущее имя по-прежнему поддерживается для совместимости. Улучшена диагностика ошибок в функции. Это закрывает [#67304](https://github.com/ClickHouse/ClickHouse/issues/67304). [#67756](https://github.com/ClickHouse/ClickHouse/pull/67756) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка разыменования нулевого указателя, вызываемая специально сконструированным запросом, которая приводила к падению сервера при использовании hopEnd, hopStart, tumbleEnd и tumbleStart. [#68098](https://github.com/ClickHouse/ClickHouse/pull/68098) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Исправлено состояние `Not-ready Set` в некоторых системных таблицах при фильтрации с использованием подзапросов. [#66018](https://github.com/ClickHouse/ClickHouse/pull/66018) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлено чтение подстолбцов после выполнения запроса `ALTER ADD COLUMN`. [#66243](https://github.com/ClickHouse/ClickHouse/pull/66243) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены булевы литералы в запросе, отправляемом во внешнюю базу данных (для движков вроде `PostgreSQL`). [#66282](https://github.com/ClickHouse/ClickHouse/pull/66282) ([vdimir](https://github.com/vdimir)).
* Исправлено форматирование запроса с выражением JOIN ON, в котором используется псевдоним, например, `... JOIN t2 ON (x = y) AS e ORDER BY x` должно форматироваться как `... JOIN t2 ON ((x = y) AS e) ORDER BY x`. [#66312](https://github.com/ClickHouse/ClickHouse/pull/66312) ([vdimir](https://github.com/vdimir)).
* Исправлена работа `cluster()` для межсерверного секрета (как и раньше, сохраняется исходный пользователь). [#66364](https://github.com/ClickHouse/ClickHouse/pull/66364) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена возможная ошибка времени выполнения при преобразовании поля типа Array, содержащего значения null, в Array(Variant). [#66727](https://github.com/ClickHouse/ClickHouse/pull/66727) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена периодическая взаимоблокировка в Context::getDDLWorker. [#66843](https://github.com/ClickHouse/ClickHouse/pull/66843) ([Alexander Gololobov](https://github.com/davenger)).
* Исправлена ошибка при создании таблицы KeeperMap после неполного удаления. [#66865](https://github.com/ClickHouse/ClickHouse/pull/66865) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка «broken part» при восстановлении на диск `s3_plain_rewritable`. [#66881](https://github.com/ClickHouse/ClickHouse/pull/66881) ([Vitaly Baranov](https://github.com/vitlibar)).
* В редких случаях ClickHouse мог считать части повреждёнными из‑за неожиданных проекций на диске. Теперь это исправлено. [#66898](https://github.com/ClickHouse/ClickHouse/pull/66898) ([alesapin](https://github.com/alesapin)).
* Исправлено некорректное определение формата при выводе схемы, из-за которого могла возникать логическая ошибка Format {} doesn&#39;t support schema inference. [#66899](https://github.com/ClickHouse/ClickHouse/pull/66899) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена возможная взаимоблокировка при отмене запроса при использовании параллельных реплик. [#66905](https://github.com/ClickHouse/ClickHouse/pull/66905) ([Nikita Taranov](https://github.com/nickitat)).
* Запретить CREATE AS SELECT даже когда параметр database&#95;replicated&#95;allow&#95;heavy&#95;create включён. Эта операция была безусловно запрещена в 23.12 и случайно разрешена при включении этого параметра в невыпущенной версии 24.7. [#66980](https://github.com/ClickHouse/ClickHouse/pull/66980) ([vdimir](https://github.com/vdimir)).
* Чтение из `numbers` могло ошибочно приводить к выбрасыванию исключения, когда был установлен лимит `max_rows_to_read`. Это закрывает [#66992](https://github.com/ClickHouse/ClickHouse/issues/66992). [#66996](https://github.com/ClickHouse/ClickHouse/pull/66996) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлено корректное приведение типов для оконных функций lagInFrame и leadInFrame — исправлен msan‑тест. [#67091](https://github.com/ClickHouse/ClickHouse/pull/67091) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* TRUNCATE DATABASE приводила к остановке репликации так, как будто это был запрос DROP DATABASE; теперь это исправлено. [#67129](https://github.com/ClickHouse/ClickHouse/pull/67129) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Использование отдельного клиентского контекста в `clickhouse-local`. [#67133](https://github.com/ClickHouse/ClickHouse/pull/67133) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена ошибка `Cannot convert column because it is non constant in source stream but must be constant in result.` для запроса, который читает из таблицы `Merge` по таблице `Distriburted` с одним шардом. [#67146](https://github.com/ClickHouse/ClickHouse/pull/67146) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Корректная работа `ORDER BY all` при отключённом `enable_order_by_all` и использовании параллельных реплик (а также распределённых запросов). [#67153](https://github.com/ClickHouse/ClickHouse/pull/67153) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлено некорректное использование input&#95;format&#95;max&#95;bytes&#95;to&#95;read&#95;for&#95;schema&#95;inference в кэше схем. [#67157](https://github.com/ClickHouse/ClickHouse/pull/67157) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена утечка памяти для `count distinct`, возникавшая при выбросе исключения во время выполнения `GROUP BY` по одному ключу типа `Nullable`. [#67171](https://github.com/ClickHouse/ClickHouse/pull/67171) ([Jet He](https://github.com/compasses)).
* Исправлена ошибка оптимизации, из-за которой OUTER JOIN преобразовывался в INNER JOIN. Закрывает [#67156](https://github.com/ClickHouse/ClickHouse/issues/67156). Закрывает [#66447](https://github.com/ClickHouse/ClickHouse/issues/66447). Ошибка была внесена в [https://github.com/ClickHouse/ClickHouse/pull/62907](https://github.com/ClickHouse/ClickHouse/pull/62907). [#67178](https://github.com/ClickHouse/ClickHouse/pull/67178) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена ошибка `Conversion from AggregateFunction(name, Type) to AggregateFunction(name, Nullable(Type)) is not supported`. Она была вызвана оптимизацией `optimize_rewrite_aggregate_function_with_if`. Устраняет [#67112](https://github.com/ClickHouse/ClickHouse/issues/67112). [#67229](https://github.com/ClickHouse/ClickHouse/pull/67229) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено зависание запроса при использовании пустого кортежа в качестве левого операнда функции IN. [#67295](https://github.com/ClickHouse/ClickHouse/pull/67295) ([Duc Canh Le](https://github.com/canhld94)).
* Можно было создать очень глубоко вложенные JSON‑данные, которые приводили к переполнению стека при пропуске неизвестных полей. Это закрывает [#67292](https://github.com/ClickHouse/ClickHouse/issues/67292). [#67324](https://github.com/ClickHouse/ClickHouse/pull/67324) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка подключения таблицы ReplicatedMergeTree после возникновения исключения при запуске. [#67360](https://github.com/ClickHouse/ClickHouse/pull/67360) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлен segfault, возникавший из-за некорректного отсоединения от группы потоков в `Aggregator`. [#67385](https://github.com/ClickHouse/ClickHouse/pull/67385) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлен ещё один случай, когда в первичном ключе (PK) была указана недетерминированная функция. [#67395](https://github.com/ClickHouse/ClickHouse/pull/67395) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен индекс `bloom_filter`, который приводил к ошибкам в запросах с не вполне обычными условиями вроде `(k=2)=(k=2)` или `has([1,2,3], k)`. [#67423](https://github.com/ClickHouse/ClickHouse/pull/67423) ([Michael Kolupaev](https://github.com/al13n321)).
* Корректно разбирать имя файла или URI с `::`, если это не архив. [#67433](https://github.com/ClickHouse/ClickHouse/pull/67433) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено ожидание задач в ~WriteBufferFromS3 в случае отмены WriteBuffer. [#67459](https://github.com/ClickHouse/ClickHouse/pull/67459) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Предотвращено удаление временных директорий частей во время RESTORE. [#67491](https://github.com/ClickHouse/ClickHouse/pull/67491) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена обработка вложенных функций с коротким замыканием. [#67520](https://github.com/ClickHouse/ClickHouse/pull/67520) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка `Logical error: Expected the argument №N of type T to have X rows, but it has 0`. Ошибка могла возникать в удалённом запросе с константным выражением в `GROUP BY` при использовании нового анализатора. [#67536](https://github.com/ClickHouse/ClickHouse/pull/67536) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено соединение по кортежу с NULL: некоторые запросы с новым анализатором и `NULL` внутри кортежа в условии `JOIN ON` возвращали некорректные результаты. [#67538](https://github.com/ClickHouse/ClickHouse/pull/67538) ([vdimir](https://github.com/vdimir)).
* Исправлено избыточное повторное планирование FileCache::freeSpaceRatioKeepingThreadFunc() в случае полностью невыгружаемого кэша. [#67540](https://github.com/ClickHouse/ClickHouse/pull/67540) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена вставка данных в движки потокового типа (Kafka, RabbitMQ, NATS) через HTTP-интерфейс. [#67554](https://github.com/ClickHouse/ClickHouse/pull/67554) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлена функция `toStartOfWeek`, которая возвращала неверный результат для малых значений `DateTime64`. [#67558](https://github.com/ClickHouse/ClickHouse/pull/67558) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена ошибка при создании представления с рекурсивным CTE. [#67587](https://github.com/ClickHouse/ClickHouse/pull/67587) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена логическая ошибка `Logical error: 'file_offset_of_buffer_end <= read_until_position'` в кэше файловой системы. Закрывает [#57508](https://github.com/ClickHouse/ClickHouse/issues/57508). [#67623](https://github.com/ClickHouse/ClickHouse/pull/67623) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправляет [#62282](https://github.com/ClickHouse/ClickHouse/issues/62282). Удалён вызов `convertFieldToString()` и добавлен типо-специфичный код сериализации. Параметризованная подстановка представления некорректно работала для нескольких типов данных, когда значение параметра было функцией или выражением, возвращающим экземпляр типа данных. [#67654](https://github.com/ClickHouse/ClickHouse/pull/67654) ([Shankar](https://github.com/shiyer7474)).
* Исправлено падение при работе с `percent_rank`. Тип кадра по умолчанию для `percent_rank` изменён на `range unbounded preceding and unbounded following`. Теперь учитывается кадр окна по умолчанию для `IWindowFunction`, и оконные функции без определения кадра окна в SQL могут корректно размещаться в разных `WindowTransformer`. [#67661](https://github.com/ClickHouse/ClickHouse/pull/67661) ([lgbo](https://github.com/lgbo-ustc)).
* Исправлена перезагрузка SQL UDF с UNION. Ранее перезапуск сервера мог сделать UDF некорректной. [#67665](https://github.com/ClickHouse/ClickHouse/pull/67665) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена возможная логическая ошибка «Unexpected return type from if» при использовании экспериментального типа Variant и включённой настройки `use_variant_as_common_type` в функции if с Tuples и Maps. [#67687](https://github.com/ClickHouse/ClickHouse/pull/67687) ([Kruglov Pavel](https://github.com/Avogar)).
* Из-за ошибки в ядре Linux запрос может зависать в `TimerDescriptor::drain`, что закрывает [#37686](https://github.com/ClickHouse/ClickHouse/issues/37686). [#67702](https://github.com/ClickHouse/ClickHouse/pull/67702) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено автодополнение команды `RESTORE ON CLUSTER`. [#67720](https://github.com/ClickHouse/ClickHouse/pull/67720) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено зависание словаря в случае CANNOT&#95;SCHEDULE&#95;TASK во время загрузки. [#67751](https://github.com/ClickHouse/ClickHouse/pull/67751) ([Azat Khuzhin](https://github.com/azat)).
* Запросы вида `SELECT count() FROM t WHERE cast(c = 1 or c = 9999 AS Bool) SETTINGS use_skip_indexes=1` с индексами Bloom-фильтра по `c` теперь работают корректно. [#67781](https://github.com/ClickHouse/ClickHouse/pull/67781) ([jsc0218](https://github.com/jsc0218)).
* Исправлен неверный результат агрегации в некоторых запросах, использующих агрегацию без ключей и фильтра, закрыта [#67419](https://github.com/ClickHouse/ClickHouse/issues/67419). [#67804](https://github.com/ClickHouse/ClickHouse/pull/67804) ([vdimir](https://github.com/vdimir)).
* Проверять экспериментальные и сомнительные типы данных в ALTER ADD/MODIFY COLUMN. [#67911](https://github.com/ClickHouse/ClickHouse/pull/67911) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен парсинг DateTime64 после свёртки констант в распределённых запросах, закрыт [#66773](https://github.com/ClickHouse/ClickHouse/issues/66773). [#67920](https://github.com/ClickHouse/ClickHouse/pull/67920) ([vdimir](https://github.com/vdimir)).
* Исправлен неверный результат `count()` при наличии недетерминированной функции в предикате. [#67922](https://github.com/ClickHouse/ClickHouse/pull/67922) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлен расчет максимального мягкого лимита на число потоков в контейнеризованных средах, где доступное количество CPU ограничено. [#67963](https://github.com/ClickHouse/ClickHouse/pull/67963) ([Robert Schulze](https://github.com/rschu1ze)).
* Теперь ClickHouse не считает кусок повреждённым, если проекция отсутствует на диске, но присутствует в `checksums.txt`. [#68003](https://github.com/ClickHouse/ClickHouse/pull/68003) ([alesapin](https://github.com/alesapin)).
* Исправлен пропуск нетронутых партиций в мутациях с новым анализатором. Ранее при включённом анализаторе данные в партиции могли быть перезаписаны мутацией, даже если, согласно предикату, мутация не должна была затрагивать эту партицию. [#68052](https://github.com/ClickHouse/ClickHouse/pull/68052) ([Anton Popov](https://github.com/CurtizJ)).
* Отменяет некорректную оптимизацию, которая удаляла сортировку в подзапросах, использующих `OFFSET`. Исправляет [#67906](https://github.com/ClickHouse/ClickHouse/issues/67906). [#68099](https://github.com/ClickHouse/ClickHouse/pull/68099) ([Graham Campbell](https://github.com/GrahamCampbell)).
* Попытка исправить ошибку `Block structure mismatch in AggregatingStep stream: different types` при оптимизации агрегатных проекций. [#68107](https://github.com/ClickHouse/ClickHouse/pull/68107) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Попытка исправить сбой Postgres при отмене запроса. [#68288](https://github.com/ClickHouse/ClickHouse/pull/68288) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено отсутствие режима синхронизации реплики в запросе `SYSTEM SYNC REPLICA`. [#68326](https://github.com/ClickHouse/ClickHouse/pull/68326) ([Duc Canh Le](https://github.com/canhld94)).



### <a id="247"></a> Релиз ClickHouse 24.7, 2024-07-30 {#a-id247a-clickhouse-release-247-2024-07-30}

#### Обратные несовместимые изменения {#backward-incompatible-change-5}
* Запрещён `CRATE MATERIALIZED VIEW ... ENGINE Replicated*MergeTree POPULATE AS SELECT ...` с реплицируемыми базами данных. [#63963](https://github.com/ClickHouse/ClickHouse/pull/63963) ([vdimir](https://github.com/vdimir)).
* `clickhouse-keeper-client` теперь принимает пути только в строковых литералах, таких как `ls '/hello/world'`, а не в виде строк без кавычек, таких как `ls /hello/world`. [#65494](https://github.com/ClickHouse/ClickHouse/pull/65494) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Метрика `KeeperOutstandingRequets` была переименована в `KeeperOutstandingRequests`. [#66206](https://github.com/ClickHouse/ClickHouse/pull/66206) ([Robert Schulze](https://github.com/rschu1ze)).
* Поле `is_deterministic` удалено из таблицы `system.functions`. [#66630](https://github.com/ClickHouse/ClickHouse/pull/66630) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Функция `tuple` теперь пытается конструировать именованные кортежи в запросе (управляется настройкой `enable_named_columns_in_function_tuple`). Добавлена функция `tupleNames` для извлечения имён из кортежей. [#54881](https://github.com/ClickHouse/ClickHouse/pull/54881) ([Amos Bird](https://github.com/amosbird)).
* Изменён принцип работы дедупликации для материализованных представлений. Исправлено множество случаев, таких как: - в целевой таблице: данные разбиваются на 2 или более блоков, и эти блоки считаются дубликатами, когда блок вставляется параллельно; - в целевой таблице MV: одинаковые блоки дедуплицируются, это происходит, когда MV часто производит одинаковые данные как результат для различных входных данных из-за выполнения агрегации; - в целевой таблице MV: одинаковые блоки, поступающие из разных MV, дедуплицируются. [#61601](https://github.com/ClickHouse/ClickHouse/pull/61601) ([Sema Checherinda](https://github.com/CheSema)).
* Функции `bitShiftLeft` и `bitShitfRight` возвращают ошибку при выходе позиции сдвига за допустимый диапазон. [#65838](https://github.com/ClickHouse/ClickHouse/pull/65838) ([Pablo Marcos](https://github.com/pamarcos)).



#### Новая функция {#new-feature-5}
* Добавлена поддержка `ASOF JOIN` для алгоритма `full_sorting_join`. [#55051](https://github.com/ClickHouse/ClickHouse/pull/55051) ([vdimir](https://github.com/vdimir)).
* Добавлена поддержка аутентификации по JWT в `clickhouse-client` (будет доступна только в ClickHouse Cloud). [#62829](https://github.com/ClickHouse/ClickHouse/pull/62829) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Добавлены SQL-функции `changeYear`, `changeMonth`, `changeDay`, `changeHour`, `changeMinute`, `changeSecond`. Например, `SELECT changeMonth(toDate('2024-06-14'), 7)` возвращает дату `2024-07-14`. [#63186](https://github.com/ClickHouse/ClickHouse/pull/63186) ([cucumber95](https://github.com/cucumber95)).
* Введены скрипты инициализации, которые позволяют выполнять преднастроенные запросы на этапе запуска. [#64889](https://github.com/ClickHouse/ClickHouse/pull/64889) ([pufit](https://github.com/pufit)).
* Добавлена поддержка параметра `accept_invalid_certificate` в конфигурации клиента, чтобы разрешить клиенту подключаться по защищённому TCP к серверу с самоподписанным сертификатом — может использоваться как сокращение для соответствующих настроек клиента `openSSL`: `verificationMode=none` + `invalidCertificateHandler.name=AcceptCertificateHandler`. [#65238](https://github.com/ClickHouse/ClickHouse/pull/65238) ([peacewalker122](https://github.com/peacewalker122)).
* Добавлена таблица `system.error_log`, которая содержит историю значений ошибок из таблицы `system.errors` и периодически сбрасывается на диск. [#65381](https://github.com/ClickHouse/ClickHouse/pull/65381) ([Pablo Marcos](https://github.com/pamarcos)).
* Добавлена агрегатная функция `groupConcat`. Почти то же самое, что `arrayStringConcat(groupArray(column), ',')`. Может принимать два параметра: строковый разделитель и количество обрабатываемых элементов. [#65451](https://github.com/ClickHouse/ClickHouse/pull/65451) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлен движок хранилища AzureQueue. [#65458](https://github.com/ClickHouse/ClickHouse/pull/65458) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена новая настройка для отключения/включения записи индекса страниц (page index) в файлы Parquet. [#65475](https://github.com/ClickHouse/ClickHouse/pull/65475) ([lgbo](https://github.com/lgbo-ustc)).
* Добавлен параметр конфигурации сервера `logger.console_log_level` для управления уровнем логирования в консоль (если включено). [#65559](https://github.com/ClickHouse/ClickHouse/pull/65559) ([Azat Khuzhin](https://github.com/azat)).
* Автоматически добавляется подстановочный символ `*` в конец пути к директории для табличной функции `file`. [#66019](https://github.com/ClickHouse/ClickHouse/pull/66019) ([Zhidong (David) Guo](https://github.com/Gun9niR)).
* Добавлен параметр `--memory-usage` для клиента в неинтерактивном режиме. [#66393](https://github.com/ClickHouse/ClickHouse/pull/66393) ([vdimir](https://github.com/vdimir)).
* Добавлен интерактивный клиент для clickhouse-disks, позволяющий добавлять локальный диск на основе локального каталога. [#64446](https://github.com/ClickHouse/ClickHouse/pull/64446) ([Daniil Ivanik](https://github.com/divanik)).
* При выполнении лёгкого удаления (lightweight delete) в таблице с одной или несколькими проекциями пользователи могут выбрать: выбросить исключение (по умолчанию) или удалить проекцию. [#65594](https://github.com/ClickHouse/ClickHouse/pull/65594) ([jsc0218](https://github.com/jsc0218)).
* Добавлены системные таблицы с основной информацией обо всех отсоединённых таблицах. [#65400](https://github.com/ClickHouse/ClickHouse/pull/65400) ([Konstantin Morozov](https://github.com/k-morozov)).



#### Экспериментальная возможность {#experimental-feature-4}
* Изменена двоичная сериализация типа данных `Variant`: добавлен режим `compact`, позволяющий избежать записи одного и того же дискриминатора несколько раз для гранул с единственным вариантом или только со значениями NULL. Добавлена настройка MergeTree `use_compact_variant_discriminators_serialization`, которая включена по умолчанию. Обратите внимание, что тип `Variant` по-прежнему является экспериментальным, и обратно несовместимое изменение формата сериализации допустимо. [#62774](https://github.com/ClickHouse/ClickHouse/pull/62774) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка дискового backend-хранилища для clickhouse-keeper. [#56626](https://github.com/ClickHouse/ClickHouse/pull/56626) ([Han Fei](https://github.com/hanfei1991)).
* Рефакторинг функций JSONExtract, добавлена поддержка большего числа типов, включая экспериментальный тип `Dynamic`. [#66046](https://github.com/ClickHouse/ClickHouse/pull/66046) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка подстолбца null map для подстолбцов `Variant` и `Dynamic`. [#66178](https://github.com/ClickHouse/ClickHouse/pull/66178) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено чтение подстолбцов `Dynamic` из изменённой таблицы `Memory`. Ранее, если параметр `max_types` типа `Dynamic` был изменён в таблице `Memory` через ALTER, последующее чтение подстолбцов могло возвращать неверный результат. [#66066](https://github.com/ClickHouse/ClickHouse/pull/66066) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка `cluster_for_parallel_replicas` при использовании параллельных реплик с пользовательским ключом. Это позволяет использовать параллельные реплики с пользовательским ключом для таблиц MergeTree. [#65453](https://github.com/ClickHouse/ClickHouse/pull/65453) ([Antonio Andelic](https://github.com/antonio2368)).



#### Повышение производительности {#performance-improvement-5}
* Заменён алгоритм преобразования int в строку на более быстрый (с модифицированного amdn/itoa на модифицированный jeaiii/itoa). [#61661](https://github.com/ClickHouse/ClickHouse/pull/61661) ([Raúl Marín](https://github.com/Algunenano)).
* Теперь размеры хеш-таблиц, создаваемых оператором `join` (алгоритм `parallel_hash`), собираются и кэшируются. Эта информация используется для предварительного выделения места в хеш-таблицах при последующих выполнениях запросов и экономии времени на изменение их размера. [#64553](https://github.com/ClickHouse/ClickHouse/pull/64553) ([Nikita Taranov](https://github.com/nickitat)).
* Оптимизированы запросы с `ORDER BY` по первичному ключу и `WHERE` с условием с высокой селективностью за счёт использования буферизации. Управляется настройкой `read_in_order_use_buffering` (включена по умолчанию) и может увеличивать потребление памяти запросом. [#64607](https://github.com/ClickHouse/ClickHouse/pull/64607) ([Anton Popov](https://github.com/CurtizJ)).
* Улучшена производительность загрузки метаданных `plain_rewritable`. [#65634](https://github.com/ClickHouse/ClickHouse/pull/65634) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Подключение таблиц на дисках только для чтения теперь использует меньше ресурсов за счёт пропуска загрузки устаревших кусков. [#65635](https://github.com/ClickHouse/ClickHouse/pull/65635) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка minmax-гиперпрямоугольника для индексов типа Set. [#65676](https://github.com/ClickHouse/ClickHouse/pull/65676) ([AntiTopQuark](https://github.com/AntiTopQuark)).
* Выгружается первичный индекс устаревших кусков, чтобы снизить общее потребление памяти. [#65852](https://github.com/ClickHouse/ClickHouse/pull/65852) ([Anton Popov](https://github.com/CurtizJ)).
* Функции `replaceRegexpAll` и `replaceRegexpOne` теперь значительно быстрее, если шаблон тривиален, то есть не содержит метасимволов, классов символов, флагов, группирующих символов и т. п. (Спасибо Taiyang Li). [#66185](https://github.com/ClickHouse/ClickHouse/pull/66185) ([Robert Schulze](https://github.com/rschu1ze)).
* s3 requests: Reduce retry time for queries, increase retries count for backups. 8.5 minutes and 100 retires for queries, 1.2 hours and 1000 retries for backup restore. [#65232](https://github.com/ClickHouse/ClickHouse/pull/65232) ([Sema Checherinda](https://github.com/CheSema)).
* Добавлена оптимизация плана запроса для LIMIT. Добавлено проталкивание LIMIT (pushdown) для хранилища PostgreSQL и табличной функции. [#65454](https://github.com/ClickHouse/ClickHouse/pull/65454) ([Maksim Kita](https://github.com/kitaisreal)).
* Улучшено балансирование нагрузки ZooKeeper. Текущая сессия не истекает до тех пор, пока не станут доступны оптимальные узлы, несмотря на `fallback_session_lifetime`. Добавлена поддержка AZ-aware балансировки. [#65570](https://github.com/ClickHouse/ClickHouse/pull/65570) ([Alexander Tokmakov](https://github.com/tavplubix)).
* DatabaseCatalog удаляет таблицы быстрее за счёт использования до database_catalog_drop_table_concurrency потоков. [#66065](https://github.com/ClickHouse/ClickHouse/pull/66065) ([Sema Checherinda](https://github.com/CheSema)).



#### Улучшение {#improvement-5}

* Улучшена балансировка нагрузки в ZooKeeper. Текущая сессия не истекает до тех пор, пока оптимальные узлы не станут доступными, несмотря на значение `fallback_session_lifetime`. Добавлена поддержка балансировки с учётом зон доступности (AZ-aware). [#65570](https://github.com/ClickHouse/ClickHouse/pull/65570) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Параметр `optimize_trivial_insert_select` по умолчанию отключён. В большинстве случаев его использование полезно. Однако, если вы замечаете более медленное выполнение INSERT SELECT или повышенное потребление памяти, вы можете включить его обратно или выполнить `SET compatibility = '24.6'`. [#58970](https://github.com/ClickHouse/ClickHouse/pull/58970) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Выводить стек вызовов и диагностическую информацию при аварийном завершении работы `clickhouse-client` или `clickhouse-local`. [#61109](https://github.com/ClickHouse/ClickHouse/pull/61109) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Результат выполнения `SHOW INDEX | INDEXES | INDICES | KEYS` ранее сортировался по именам столбцов первичного ключа. Поскольку это было неинтуитивно, теперь результат сортируется по позициям столбцов в определении первичного ключа. [#61131](https://github.com/ClickHouse/ClickHouse/pull/61131) ([Robert Schulze](https://github.com/rschu1ze)).
* Изменён принцип работы дедупликации для материализованных представлений. Исправлено множество случаев, таких как: - в целевой таблице: данные разбиваются на 2 или более блока и эти блоки считаются дубликатами при параллельной вставке; - в целевой таблице MV: одинаковые блоки дедуплицируются, это происходит, когда MV часто формирует одинаковые данные в результате для разных входных данных из‑за агрегации; - в целевой таблице MV: одинаковые блоки, поступающие из разных MV, дедуплицируются. [#61601](https://github.com/ClickHouse/ClickHouse/pull/61601) ([Sema Checherinda](https://github.com/CheSema)).
* Поддержка чтения секционированных данных DeltaLake. Схема DeltaLake теперь определяется по метаданным, а не по самим данным. [#63201](https://github.com/ClickHouse/ClickHouse/pull/63201) ([Kseniia Sumarokova](https://github.com/kssenii)).
* В протоколах composable слой TLS принимал только параметры `certificateFile` и `privateKeyFile`. [https://clickhouse.com/docs/operations/settings/composable-protocols](https://clickhouse.com/docs/operations/settings/composable-protocols). [#63985](https://github.com/ClickHouse/ClickHouse/pull/63985) ([Anton Ivashkin](https://github.com/ianton-ru)).
* Добавлено профильное событие `SelectQueriesWithPrimaryKeyUsage`, которое показывает количество запросов SELECT, использующих первичный ключ для вычисления условия WHERE. [#64492](https://github.com/ClickHouse/ClickHouse/pull/64492) ([0x01f](https://github.com/0xfei)).
* Исправления и улучшения, связанные с `StorageS3Queue`. Теперь значение по умолчанию для `s3queue_processing_threads_num` вычисляется в соответствии с количеством физических ядер CPU на сервере (вместо прежнего значения по умолчанию 1). Значение по умолчанию для `s3queue_loading_retries` установлено равным 10. Исправлено возможное расплывчатое сообщение «Uncaught exception» в столбце исключения таблицы `system.s3queue`. Счётчик повторных попыток не увеличивается при исключении `MEMORY_LIMIT_EXCEEDED`. Коммит файлов перенесён на этап после полного завершения вставки в таблицу, чтобы избежать ситуации, когда файлы помечаются как закоммиченные до фактической вставки. Добавлены настройки `s3queue_max_processed_files_before_commit`, `s3queue_max_processed_rows_before_commit`, `s3queue_max_processed_bytes_before_commit`, `s3queue_max_processing_time_sec_before_commit` для более точного контроля момента коммита и сброса данных. [#65046](https://github.com/ClickHouse/ClickHouse/pull/65046) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Поддержка псевдонимов в параметризованной функции представления (только новый анализатор). [#65190](https://github.com/ClickHouse/ClickHouse/pull/65190) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Обновлено: теперь ключ учетной записи маскируется в логах Azure Blob Storage. [#65273](https://github.com/ClickHouse/ClickHouse/pull/65273) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Отсечение партиций для предикатов `IN`, когда фильтрующее выражение является частью выражения `PARTITION BY`. [#65335](https://github.com/ClickHouse/ClickHouse/pull/65335) ([Eduard Karacharov](https://github.com/korowa)).
* `arrayMin`/`arrayMax` могут применяться ко всем сравнимым типам данных. [#65455](https://github.com/ClickHouse/ClickHouse/pull/65455) ([pn](https://github.com/chloro-pn)).
* Улучшен учет памяти для cgroups v2 за счет исключения объема памяти, занятого кэшем страниц. [#65470](https://github.com/ClickHouse/ClickHouse/pull/65470) ([Nikita Taranov](https://github.com/nickitat)).
* Не создавать настройки формата для каждой строки при сериализации чанков при вставке в таблицу EmbeddedRocksDB. [#65474](https://github.com/ClickHouse/ClickHouse/pull/65474) ([Duc Canh Le](https://github.com/canhld94)).
* Сократить приглашение в `clickhouse-local` до просто `:)`. Функция `getFQDNOrHostName()` на macOS выполняется слишком долго, и мы в любом случае не хотим видеть имя хоста в приглашении `clickhouse-local`. [#65510](https://github.com/ClickHouse/ClickHouse/pull/65510) ([Konstantин Bogdanov](https://github.com/thevar1able)).
* Не выводить сообщение jemalloc о per-CPU аренах на маломощных виртуальных машинах. [#65532](https://github.com/ClickHouse/ClickHouse/pull/65532) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* По умолчанию отключена фоновая загрузка файлового кеша. Она будет снова включена, когда мы исправим проблему с возможной ошибкой &quot;Memory limit exceeded&quot;, которая может возникать из‑за того, что память освобождается вне контекста запроса (в то время как буфер выделяется внутри контекста запроса) при использовании фоновых потоков загрузки. Кроме того, нам нужно добавить отдельную настройку для определения максимального размера данных, загружаемых фоновыми рабочими потоками (сейчас он ограничен параметром max&#95;file&#95;segment&#95;size, который может быть слишком большим). [#65534](https://github.com/ClickHouse/ClickHouse/pull/65534) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлен новый параметр конфигурации `<config_reload_interval_ms>`, который позволяет задать, как часто ClickHouse будет перезагружать конфигурацию. [#65545](https://github.com/ClickHouse/ClickHouse/pull/65545) ([alesapin](https://github.com/alesapin)).
* Реализовать двоичное кодирование типов данных ClickHouse и добавить его спецификацию в документацию. Использовать его в Dynamic binary serialization и добавить возможность его использования в форматах RowBinaryWithNamesAndTypes и Native через настройки. [#65546](https://github.com/ClickHouse/ClickHouse/pull/65546) ([Kruglov Pavel](https://github.com/Avogar)).
* Настройки сервера `compiled_expression_cache_size` и `compiled_expression_cache_elements_size` теперь отображаются в таблице `system.server_settings`. [#65584](https://github.com/ClickHouse/ClickHouse/pull/65584) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка идентификации пользователей на основе расширения SubjectAltName сертификата X.509. [#65626](https://github.com/ClickHouse/ClickHouse/pull/65626) ([Anton Kozlov](https://github.com/tonickkozlov)).
* `clickhouse-local` будет учитывать значения `max_server_memory_usage` и `max_server_memory_usage_to_ram_ratio` из файла конфигурации. По умолчанию он также установит максимально допустимое использование памяти на уровне 90% от объёма памяти системы, как и `clickhouse-server`. [#65697](https://github.com/ClickHouse/ClickHouse/pull/65697) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен скрипт для резервного копирования файлов в ClickHouse. [#65699](https://github.com/ClickHouse/ClickHouse/pull/65699) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Источник PostgreSQL теперь поддерживает отмену запросов. [#65722](https://github.com/ClickHouse/ClickHouse/pull/65722) ([Maksim Kita](https://github.com/kitaisreal)).
* Параметр `allow_experimental_analyzer` для распределённых запросов теперь управляется инициатором. Это обеспечивает совместимость и корректность работы в кластерах со смешанными версиями. [#65777](https://github.com/ClickHouse/ClickHouse/pull/65777) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Keeper теперь учитывает ограничение cgroup по CPU. [#65819](https://github.com/ClickHouse/ClickHouse/pull/65819) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена возможность использовать функцию `concat` с пустыми аргументами `:) select concat();`. [#65887](https://github.com/ClickHouse/ClickHouse/pull/65887) ([李扬](https://github.com/taiyang-li)).
* Добавлена возможность управления именованными коллекциями в `clickhouse-local`. [#65973](https://github.com/ClickHouse/ClickHouse/pull/65973) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшены события профилирования, связанные с Azure. [#65999](https://github.com/ClickHouse/ClickHouse/pull/65999) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка чтения файлов ORC с учетом часового пояса записывающей стороны. [#66025](https://github.com/ClickHouse/ClickHouse/pull/66025) ([kevinyhzou](https://github.com/KevinyhZou)).
* Добавлены настройки для управления подключениями к PostgreSQL. Настройка `postgresql_connection_attempt_timeout` задаёт значение, передаваемое параметру `connect_timeout` в URL-адресе подключения. Настройка `postgresql_connection_pool_retries` задаёт количество попыток установить соединение с конечной точкой PostgreSQL. [#66232](https://github.com/ClickHouse/ClickHouse/pull/66232) ([Dmitry Novik](https://github.com/novikd)).
* Снижена неточность `input_wait_elapsed_us`/`elapsed_us` в `system.processors_profile_log`. [#66239](https://github.com/ClickHouse/ClickHouse/pull/66239) ([Azat Khuzhin](https://github.com/azat)).
* Улучшены ProfileEvents для кэша файловой системы. [#66249](https://github.com/ClickHouse/ClickHouse/pull/66249) ([zhukai](https://github.com/nauu)).
* Добавлены настройки, позволяющие игнорировать предложение `ON CLUSTER` в запросах при управлении именованными коллекциями с реплицируемым хранилищем. [#66288](https://github.com/ClickHouse/ClickHouse/pull/66288) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Функция `generateSnowflakeID` теперь позволяет указывать идентификатор узла в качестве параметра для предотвращения коллизий в больших кластерах. [#66374](https://github.com/ClickHouse/ClickHouse/pull/66374) ([ZAWA&#95;ll](https://github.com/Zawa-ll)).
* Отключено приостановление по `Ctrl+Z` в интерактивном режиме. Это распространённая ловушка и не является ожидаемым поведением почти для всех пользователей. Полагаю, лишь немногие крайне продвинутые пользователи могли бы оценить приостановку терминальных приложений и их перевод в фоновый режим, но я таких не знаю. [#66511](https://github.com/ClickHouse/ClickHouse/pull/66511) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена опция проверки типа первичного ключа в Dictionaries. Без этой опции для простых макетов словарей любой тип столбца будет неявно преобразован в UInt64. [#66595](https://github.com/ClickHouse/ClickHouse/pull/66595) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).





#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-4}

* Теперь проверяются циклические зависимости в запросах CREATE/REPLACE/RENAME/EXCHANGE и при их наличии выбрасывается исключение. Ранее такие циклические зависимости могли приводить к взаимоблокировке (deadlock) во время запуска сервера. Также исправлены некоторые ошибки в логике создания зависимостей. [#65405](https://github.com/ClickHouse/ClickHouse/pull/65405) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена проблема с неожиданными размерами столбцов `LowCardinality` в вызовах функций. [#65298](https://github.com/ClickHouse/ClickHouse/pull/65298) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена ошибка, приводившая к сбою в maxIntersections. [#65689](https://github.com/ClickHouse/ClickHouse/pull/65689) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено поведение, при котором условие `VALID UNTIL` в определении пользователя сбрасывалось после перезапуска. [#66409](https://github.com/ClickHouse/ClickHouse/pull/66409) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлен столбец с оставшимся временем в `SHOW MERGES`. [#66735](https://github.com/ClickHouse/ClickHouse/pull/66735) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сообщение `Query was cancelled` могло выводиться дважды в clickhouse-client. Это поведение исправлено. [#66005](https://github.com/ClickHouse/ClickHouse/pull/66005) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлен сбой при использовании `MaterializedMySQL` (неподдерживаемой экспериментальной функциональности) с TABLE OVERRIDE, сопоставляющим поле MySQL со значением NULL с полем ClickHouse с ограничением NOT NULL. [#54649](https://github.com/ClickHouse/ClickHouse/pull/54649) ([Filipp Ozinov](https://github.com/bakwc)).
* Исправлена логическая ошибка, возникавшая, когда выражение `PREWHERE` не читало ни одного столбца, а таблица не имела адаптивной гранулярности индекса (для очень старых таблиц). [#59173](https://github.com/ClickHouse/ClickHouse/pull/59173) ([Alexander Gololobov](https://github.com/davenger)).
* Исправлена ошибка, связанная с буфером отмены при отмене запроса. [#64478](https://github.com/ClickHouse/ClickHouse/pull/64478) ([Sema Checherinda](https://github.com/CheSema)).
* Исправлено заполнение столбцов частей из метаданных (когда файл `columns.txt` отсутствует). [#64757](https://github.com/ClickHouse/ClickHouse/pull/64757) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, приводившая к падению при выполнении `ALTER TABLE ... ON CLUSTER ... MODIFY SQL SECURITY`. [#64957](https://github.com/ClickHouse/ClickHouse/pull/64957) ([pufit](https://github.com/pufit)).
* Исправлен сбой при уничтожении AccessControl: добавлено явное завершение. [#64993](https://github.com/ClickHouse/ClickHouse/pull/64993) ([Vitaly Baranov](https://github.com/vitlibar)).
* Рекурсивно удалять инъективную функцию из аргумента функций `uniq*`. Ранее это работало корректно, но было нарушено в новом анализаторе. [#65140](https://github.com/ClickHouse/ClickHouse/pull/65140) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлено неожиданное имя проекции в запросе с CTE. [#65267](https://github.com/ClickHouse/ClickHouse/pull/65267) ([wudidapaopao](https://github.com/wudidapaopao)).
* Теперь для доступа к словарям посредством прямого запроса или движка таблицы `Dictionary` требуется привилегия `dictGet`. [#65359](https://github.com/ClickHouse/ClickHouse/pull/65359) ([Joe Lynch](https://github.com/joelynch)).
* Исправлена проблема с пользовательской аутентификацией в S3 при использовании инкрементных резервных копий. [#65481](https://github.com/ClickHouse/ClickHouse/pull/65481) ([Antonio Andelic](https://github.com/antonio2368)).
* Отключите оптимизацию `non-intersecting-parts` для запросов с `FINAL` в случае включённой оптимизации `read-in-order`. Это могло приводить к некорректному результату запроса. В качестве временного решения отключите `do_not_merge_across_partitions_select_final` и `split_parts_ranges_into_intersecting_and_non_intersecting_final` до тех пор, пока это исправление не будет включено. [#65505](https://github.com/ClickHouse/ClickHouse/pull/65505) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено исключение `Index out of bound for blob metadata` в случае, если все файлы из пакетного списка были отфильтрованы. [#65523](https://github.com/ClickHouse/ClickHouse/pull/65523) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка NOT&#95;FOUND&#95;COLUMN&#95;IN&#95;BLOCK при слиянии проекции с дедупликацией. [#65573](https://github.com/ClickHouse/ClickHouse/pull/65573) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена ошибка в MergeJoin. Столбец в разреженной сериализации мог быть интерпретирован как столбец вложенного типа, хотя необходимое преобразование не было выполнено. [#65632](https://github.com/ClickHouse/ClickHouse/pull/65632) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена ошибка, из-за которой уровень совместимости &#39;23.4&#39; применялся некорректно. [#65737](https://github.com/ClickHouse/ClickHouse/pull/65737) ([cw5121](https://github.com/cw5121)).
* Исправлена работа таблицы ODBC с Nullable-полями. [#65738](https://github.com/ClickHouse/ClickHouse/pull/65738) ([Rodolphe Dugé de Bernonville](https://github.com/RodolpheDuge)).
* Исправлена гонка данных в `TCPHandler`, которая могла возникать при фатальной ошибке. [#65744](https://github.com/ClickHouse/ClickHouse/pull/65744) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлены некорректные исключения в функции `parseDateTime` при использовании спецификаторов формата `%F` и `%D`. [#65768](https://github.com/ClickHouse/ClickHouse/pull/65768) ([Antonio Andelic](https://github.com/antonio2368)).
* Для запросов, читающих из `PostgreSQL`, отменять внутренний запрос `PostgreSQL`, если запрос `ClickHouse` уже завершён. В противном случае запрос `ClickHouse` не может быть отменён, пока не завершится внутренний запрос `PostgreSQL`. [#65771](https://github.com/ClickHouse/ClickHouse/pull/65771) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена ошибка в логике укороченного вычисления при использовании старого анализатора и dictGetOrDefault. [#65802](https://github.com/ClickHouse/ClickHouse/pull/65802) ([jsc0218](https://github.com/jsc0218)).
* Исправлена ошибка, из-за которой EmbeddedRocksDB с TTL записывала повреждённые файлы SST. [#65816](https://github.com/ClickHouse/ClickHouse/pull/65816) ([Duc Canh Le](https://github.com/canhld94)).
* Функции `bitTest`, `bitTestAll` и `bitTestAny` теперь возвращают ошибку, если указанный индекс бита выходит за границы допустимого диапазона [#65818](https://github.com/ClickHouse/ClickHouse/pull/65818) ([Pablo Marcos](https://github.com/pamarcos)).
* Параметр `join_any_take_last_row` поддерживается в любом запросе, использующем hash join. [#65820](https://github.com/ClickHouse/ClickHouse/pull/65820) ([vdimir](https://github.com/vdimir)).
* Улучшена обработка условий соединения, включающих проверки `IS NULL` (например, выражение `ON (a = b AND (a IS NOT NULL) AND (b IS NOT NULL) ) OR ( (a IS NULL) AND (b IS NULL) )` переписывается в `ON a <=> b`), исправлена некорректная оптимизация при наличии дополнительных условий помимо `IS NULL`. [#65835](https://github.com/ClickHouse/ClickHouse/pull/65835) ([vdimir](https://github.com/vdimir)).
* Исправлено растущее потребление памяти в S3Queue. [#65839](https://github.com/ClickHouse/ClickHouse/pull/65839) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена обработка равных значений в `arrayAUC` для соответствия поведению sklearn. [#65840](https://github.com/ClickHouse/ClickHouse/pull/65840) ([gabrielmcg44](https://github.com/gabrielmcg44)).
* Исправлены возможные проблемы с TLS-подключениями в протоколе сервера MySQL. [#65917](https://github.com/ClickHouse/ClickHouse/pull/65917) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены возможные проблемы с TLS-соединениями клиентского протокола MySQL. [#65938](https://github.com/ClickHouse/ClickHouse/pull/65938) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена обработка `SSL_ERROR_WANT_READ`/`SSL_ERROR_WANT_WRITE` при нулевом таймауте. [#65941](https://github.com/ClickHouse/ClickHouse/pull/65941) ([Azat Khuzhin](https://github.com/azat)).
* Добавлены отсутствующие настройки `input_format_csv_skip_first_lines/input_format_tsv_skip_first_lines/input_format_csv_try_infer_numbers_from_strings/input_format_csv_try_infer_strings_from_quoted_tuples` в кэш автоопределения схемы, поскольку они могут изменять результирующую схему. Это предотвращает некорректные результаты автоопределения схемы при изменении этих настроек. [#65980](https://github.com/ClickHouse/ClickHouse/pull/65980) ([Kruglov Pavel](https://github.com/Avogar)).
* Столбец &#95;size в движке S3 и табличной функции S3 указывает на размер файла внутри архива, а не на размер самого архива. [#65993](https://github.com/ClickHouse/ClickHouse/pull/65993) ([Daniil Ivanik](https://github.com/divanik)).
* Исправлена обработка динамических подстолбцов в анализаторе, чтобы избежать чтения всего столбца при обращении к динамическому подстолбцу. [#66004](https://github.com/ClickHouse/ClickHouse/pull/66004) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено объединение конфигураций в from&#95;env при использовании переопределений replace. [#66034](https://github.com/ClickHouse/ClickHouse/pull/66034) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено возможное зависание `GRPCServer` при завершении работы. [#66061](https://github.com/ClickHouse/ClickHouse/pull/66061) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлены несколько случаев работы функции `has` с неконстантными аргументами типа `LowCardinality`. [#66088](https://github.com/ClickHouse/ClickHouse/pull/66088) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен `groupArrayIntersect`. Функция работала некорректно в `merge()`. Также исправлено поведение в `deserialise()` для числовых и произвольных данных. [#66103](https://github.com/ClickHouse/ClickHouse/pull/66103) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена ошибка переполнения буфера в реализации `unbin`/`unhex`. [#66106](https://github.com/ClickHouse/ClickHouse/pull/66106) ([Nikita Taranov](https://github.com/nickitat)).
* Отключите оптимизацию `merge-filters`, представленную в [#64760](https://github.com/ClickHouse/ClickHouse/issues/64760). Она может привести к исключению, если при объединении двух выражений фильтра не используется вычисление с коротким замыканием. [#66126](https://github.com/ClickHouse/ClickHouse/pull/66126) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена проблема, при которой сервер не мог разобрать файлы Avro с массивами, закодированными с отрицательным размером блока, что теперь допускается спецификацией Avro. [#66130](https://github.com/ClickHouse/ClickHouse/pull/66130) ([Serge Klochkov](https://github.com/slvrtrn)).
* Исправлена ошибка в клиенте ZooKeeper: сессия могла зависать в нерабочем состоянии после получения аппаратной ошибки от ZooKeeper. Например, это могло произойти из‑за &quot;soft memory limit&quot; в ClickHouse Keeper. [#66140](https://github.com/ClickHouse/ClickHouse/pull/66140) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена ошибка в SumIfToCountIfVisitor и при работе со знаковыми целыми числами. [#66146](https://github.com/ClickHouse/ClickHouse/pull/66146) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлен редкий случай, когда в результате распределённого запроса отсутствовали данные. [#66174](https://github.com/ClickHouse/ClickHouse/pull/66174) ([vdimir](https://github.com/vdimir)).
* Исправлен порядок разбора полей метаданных в StorageDeltaLake. [#66211](https://github.com/ClickHouse/ClickHouse/pull/66211) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Не генерировать исключение `TIMEOUT_EXCEEDED` для режима `none_only_active` параметра `distributed_ddl_output_mode`. [#66218](https://github.com/ClickHouse/ClickHouse/pull/66218) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена обработка лимита для `system.numbers_mt`, когда использование индекса невозможно. [#66231](https://github.com/ClickHouse/ClickHouse/pull/66231) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлено определение сервером ClickHouse максимального числа доступных ядер CPU в соответствии с ограничениями cgroups v2, если сервер запущен в контейнере, таком как Docker. Подробнее: контейнеры часто запускают свой процесс в корневой cgroup с пустым именем. В этом случае ClickHouse игнорировал лимиты CPU, установленные cgroups v2. [#66237](https://github.com/ClickHouse/ClickHouse/pull/66237) ([filimonov](https://github.com/filimonov)).
* Исправлена ошибка `Not-ready set`, возникающая при использовании подзапроса с `IN` в условии ограничения. [#66261](https://github.com/ClickHouse/ClickHouse/pull/66261) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено формирование сообщений об ошибках при копировании в S3 или AzureBlobStorage. [#66295](https://github.com/ClickHouse/ClickHouse/pull/66295) ([Vitaly Baranov](https://github.com/vitlibar)).
* Предотвратить удержание watchdog дескрипторов удалённых (ротированных) файлов журналов. [#66334](https://github.com/ClickHouse/ClickHouse/pull/66334) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Исправлена ошибка, из-за которой в logicalexpressionoptimizerpass утрачивался логический тип константы. [#66344](https://github.com/ClickHouse/ClickHouse/pull/66344) ([pn](https://github.com/chloro-pn)).
* Исправлена ошибка `Column identifier is already registered`, возникавшая при использовании `group_by_use_nulls=true` и нового анализатора. [#66400](https://github.com/ClickHouse/ClickHouse/pull/66400) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено возможное получение некорректных результатов запросов с объединением и фильтрацией таблиц внешних движков (например, PostgreSQL) из‑за слишком агрессивного проталкивания фильтров. С этого момента условия из предложения WHERE не будут отправляться во внешнюю базу данных в случае OUTER JOIN с внешней таблицей. [#66402](https://github.com/ClickHouse/ClickHouse/pull/66402) ([vdimir](https://github.com/vdimir)).
* Добавлена недостающая материализация столбца для CROSS JOIN. [#66413](https://github.com/ClickHouse/ClickHouse/pull/66413) ([lgbo](https://github.com/lgbo-ustc)).
* Исправлена ошибка `Cannot find column` для запросов с константным выражением в ключе `GROUP BY` при включённом новом анализаторе запросов. [#66433](https://github.com/ClickHouse/ClickHouse/pull/66433) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Предотвращена возможная логическая ошибка при импорте из формата Npy в случае некорректного уровня вложенности массивов, исправлено тестирование других типов ошибок. [#66461](https://github.com/ClickHouse/ClickHouse/pull/66461) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена ошибка, из-за которой при наличии недетерминированной функции в предикате возвращался неверный результат count(). [#66510](https://github.com/ClickHouse/ClickHouse/pull/66510) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлено отслеживание памяти в `Allocator::realloc`. [#66548](https://github.com/ClickHouse/ClickHouse/pull/66548) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено чтение неинициализированной памяти при хешировании пустых кортежей. [#66562](https://github.com/ClickHouse/ClickHouse/pull/66562) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка, приводившая к неверным результатам для запросов с `WINDOW`. Она могла возникать, когда столбцы `PARTITION` имели разреженную сериализацию, а оконные функции выполнялись параллельно. [#66579](https://github.com/ClickHouse/ClickHouse/pull/66579) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка удаления именованных коллекций в локальном хранилище. [#66599](https://github.com/ClickHouse/ClickHouse/pull/66599) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлена проблема, из-за которой `column_length` не обновлялся в `ColumnTuple::insertManyFrom`. [#66626](https://github.com/ClickHouse/ClickHouse/pull/66626) ([lgbo](https://github.com/lgbo-ustc)).
* Исправлены ошибки `Unknown identifier` и `Column is not under aggregate function` для запросов с выражением `(column IS NULL)`. Ошибка была спровоцирована изменением [#65088](https://github.com/ClickHouse/ClickHouse/issues/65088) и проявлялась только с отключённым анализатором. [#66654](https://github.com/ClickHouse/ClickHouse/pull/66654) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка `Method getResultType is not supported for QUERY query node`, возникавшая при использовании скалярного подзапроса в качестве первого аргумента оператора IN (с новым анализатором запросов). [#66655](https://github.com/ClickHouse/ClickHouse/pull/66655) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена потенциальная ошибка PARAMETER&#95;OUT&#95;OF&#95;BOUND при чтении подколонки типа Variant. [#66659](https://github.com/ClickHouse/ClickHouse/pull/66659) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена редкая ситуация, когда слияние могло зависнуть после удаления столбца. [#66707](https://github.com/ClickHouse/ClickHouse/pull/66707) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена ассерция `isUniqTypes` при выполнении `INSERT SELECT` из удалённых источников. [#66722](https://github.com/ClickHouse/ClickHouse/pull/66722) ([Sema Checherinda](https://github.com/CheSema)).
* Исправлена логическая ошибка в PrometheusRequestHandler. [#66621](https://github.com/ClickHouse/ClickHouse/pull/66621) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен граничный случай в функции `indexHint`, обнаруженный фаззером. [#66286](https://github.com/ClickHouse/ClickHouse/pull/66286) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено форматирование AST для выражения &#39;create table b empty as a&#39;. [#64951](https://github.com/ClickHouse/ClickHouse/pull/64951) ([Michael Kolupaev](https://github.com/al13n321)).



### <a id="246"></a> Релиз ClickHouse 24.6, 2024-07-01 {#a-id246a-clickhouse-release-246-2024-07-01}

#### Обратно несовместимые изменения {#backward-incompatible-change-6}
* Асинхронная загрузка баз данных и таблиц включена по умолчанию. См. `async_load_databases` в config.xml. Хотя это изменение полностью совместимо, оно может привести к изменению поведения. Когда `async_load_databases` равно false, как в предыдущих версиях, сервер не будет принимать подключения, пока не загрузятся все таблицы. Когда `async_load_databases` равно true, как в новой версии, сервер может принимать подключения до загрузки всех таблиц. Если выполняется запрос к таблице, которая ещё не загружена, он будет ждать завершения загрузки таблицы, что может занять значительное время. Это может изменить поведение сервера, если он является частью крупной распределённой системы за балансировщиком нагрузки. В первом случае балансировщик может получить отказ в установлении соединения и быстро переключиться на другой сервер. Во втором случае балансировщик может подключиться к серверу, который всё ещё загружает таблицы, и задержка выполнения запроса будет выше. Более того, если много запросов накопится в состоянии ожидания, это может привести к проблеме «thundering herd», когда они начнут обрабатываться одновременно. Это может иметь значение только для сильно нагруженных распределённых бэкендов. Чтобы избежать этой проблемы, вы можете установить значение `async_load_databases` в false. [#57695](https://github.com/ClickHouse/ClickHouse/pull/57695) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Настройка `replace_long_file_name_to_hash` по умолчанию включена для таблиц `MergeTree`. [#64457](https://github.com/ClickHouse/ClickHouse/pull/64457) ([Anton Popov](https://github.com/CurtizJ)). Эта настройка полностью совместима, никаких действий при обновлении не требуется. Новый формат данных поддерживается во всех версиях, начиная с 23.9. После включения этой настройки вы больше не сможете откатиться на версию 23.8 или более раннюю.
* Некоторые некорректные запросы теперь будут завершаться с ошибкой на этапе парсинга. Примечание: отключена поддержка inline‑выражений KQL (экспериментальный язык Kusto), когда они передаются в табличную функцию `kql` без строкового литерала, например `kql(garbage | trash)` вместо `kql('garbage | trash')` или `kql($$garbage | trash$$)`. Эта возможность была добавлена по ошибке и не должна существовать. [#61500](https://github.com/ClickHouse/ClickHouse/pull/61500) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Переделана параллельная обработка в режиме `Ordered` хранилища `S3Queue`. Этот PR обратно несовместим для режима Ordered, если вы использовали настройки `s3queue_processing_threads_num` или `s3queue_total_shards_num`. Настройка `s3queue_total_shards_num` удалена; ранее её было разрешено использовать только вместе с `s3queue_allow_experimental_sharded_mode`, который теперь помечен как устаревший. Добавлена новая настройка — `s3queue_buckets`. [#64349](https://github.com/ClickHouse/ClickHouse/pull/64349) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлены новые функции `snowflakeIDToDateTime`, `snowflakeIDToDateTime64`, `dateTimeToSnowflakeID` и `dateTime64ToSnowflakeID`. В отличие от существующих функций `snowflakeToDateTime`, `snowflakeToDateTime64`, `dateTimeToSnowflake` и `dateTime64ToSnowflake`, новые функции совместимы с функцией `generateSnowflakeID`, т.е. они принимают snowflake‑ID, сгенерированные `generateSnowflakeID`, и выдают snowflake‑ID того же типа, что и `generateSnowflakeID` (т.е. `UInt64`). Кроме того, новые функции по умолчанию используют эпоху UNIX (т.е. 1970-01-01), так же как `generateSnowflakeID`. При необходимости можно передать другую эпоху, например эпоху Twitter/X от 2010-11-04, т.е. 1288834974657 мс от эпохи UNIX. Старые функции конвертации объявлены устаревшими и будут удалены после переходного периода: чтобы продолжать использовать их, включите настройку `allow_deprecated_snowflake_conversion_functions`. [#64948](https://github.com/ClickHouse/ClickHouse/pull/64948) ([Robert Schulze](https://github.com/rschu1ze)).



#### Новая возможность {#new-feature-6}

* Добавлена возможность хранить именованные коллекции в ClickHouse Keeper. [#64574](https://github.com/ClickHouse/ClickHouse/pull/64574) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка пустых кортежей. [#55061](https://github.com/ClickHouse/ClickHouse/pull/55061) ([Amos Bird](https://github.com/amosbird)).
* Добавлены функции для кодирования и декодирования по кривой Гильберта. [#60156](https://github.com/ClickHouse/ClickHouse/pull/60156) ([Artem Mustafin](https://github.com/Artemmm91)).
* Добавлена поддержка анализа индексов с использованием `hilbertEncode`. [#64662](https://github.com/ClickHouse/ClickHouse/pull/64662) ([Artem Mustafin](https://github.com/Artemmm91)).
* Добавлена поддержка чтения геометрии типа `LINESTRING` в формате WKT с помощью функции `readWKTLineString`. [#62519](https://github.com/ClickHouse/ClickHouse/pull/62519) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлена возможность присоединять части с другого диска. [#63087](https://github.com/ClickHouse/ClickHouse/pull/63087) ([Unalian](https://github.com/Unalian)).
* Добавлена новая SQL-функция `generateSnowflakeID` для генерации идентификаторов Snowflake в стиле Twitter. [#63577](https://github.com/ClickHouse/ClickHouse/pull/63577) ([Danila Puzov](https://github.com/kazalika)).
* Добавлены настройки `merge_workload` и `mutation_workload` для регулирования использования ресурсов и их распределения между слияниями, мутациями и другими нагрузками. [#64061](https://github.com/ClickHouse/ClickHouse/pull/64061) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена поддержка сравнения типов данных `IPv4` и `IPv6` с использованием оператора `=`. [#64292](https://github.com/ClickHouse/ClickHouse/pull/64292) ([Francisco J. Jurado Moreno](https://github.com/Beetelbrox)).
* Добавлена поддержка десятичных аргументов в бинарных математических функциях (pow, atan2, max2, min2, hypot). [#64582](https://github.com/ClickHouse/ClickHouse/pull/64582) ([Mikhail Gorshkov](https://github.com/mgorshkov)).
* Добавлены SQL-функции `parseReadableSize` (вместе с вариантами `OrNull` и `OrZero`). [#64742](https://github.com/ClickHouse/ClickHouse/pull/64742) ([Francisco J. Jurado Moreno](https://github.com/Beetelbrox)).
* Добавлены серверные настройки `max_table_num_to_throw` и `max_database_num_to_throw` для ограничения количества создаваемых баз данных или таблиц в запросах `CREATE`. [#64781](https://github.com/ClickHouse/ClickHouse/pull/64781) ([Xu Jia](https://github.com/XuJia0210)).
* Добавлен виртуальный столбец `_time` в хранилища файлового типа (s3/file/hdfs/url/azureBlobStorage). [#64947](https://github.com/ClickHouse/ClickHouse/pull/64947) ([Ilya Golshtein](https://github.com/ilejn)).
* Добавлены новые функции `base64URLEncode`, `base64URLDecode` и `tryBase64URLDecode`. [#64991](https://github.com/ClickHouse/ClickHouse/pull/64991) ([Mikhail Gorshkov](https://github.com/mgorshkov)).
* Добавлена новая функция `editDistanceUTF8`, которая вычисляет [расстояние редактирования](https://en.wikipedia.org/wiki/Edit_distance) между двумя строками в кодировке UTF-8. [#65269](https://github.com/ClickHouse/ClickHouse/pull/65269) ([LiuNeng](https://github.com/liuneng1994)).
* Добавлена конфигурация `http_response_headers` для поддержки пользовательских заголовков ответа в пользовательских HTTP-обработчиках. [#63562](https://github.com/ClickHouse/ClickHouse/pull/63562) ([Grigorii](https://github.com/GSokol)).
* Добавлена новая табличная функция `loop` для возврата результатов запроса в бесконечном цикле. [#63452](https://github.com/ClickHouse/ClickHouse/pull/63452) ([Sariel](https://github.com/sarielwxm)). Это полезно для тестирования.
* Добавлены два дополнительных столбца в `system.query_log`: `used_privileges` и `missing_privileges`. `used_privileges` заполняется привилегиями, которые были проверены при выполнении запроса, а `missing_privileges` содержит необходимые, но отсутствующие привилегии. [#64597](https://github.com/ClickHouse/ClickHouse/pull/64597) ([Alexey Katsman](https://github.com/alexkats)).
* Добавлена настройка `output_format_pretty_display_footer_column_names`, которая при включении отображает имена столбцов в конце таблицы для длинных таблиц (по умолчанию — от 50 строк). Пороговое значение минимального числа строк задаётся параметром `output_format_pretty_display_footer_column_names_min_rows`. [#65144](https://github.com/ClickHouse/ClickHouse/pull/65144) ([Shaun Struwig](https://github.com/Blargian)).



#### Экспериментальная функция {#experimental-feature-5}
* Добавлена статистика типа «число различных значений». [#59357](https://github.com/ClickHouse/ClickHouse/pull/59357) ([Han Fei](https://github.com/hanfei1991)).
* Добавлена поддержка статистики с ReplicatedMergeTree. [#64934](https://github.com/ClickHouse/ClickHouse/pull/64934) ([Han Fei](https://github.com/hanfei1991)).
* Если для базы данных `Replicated` настроена «группа реплик» (replica group), автоматически создаётся кластер, включающий реплики из всех групп. [#64312](https://github.com/ClickHouse/ClickHouse/pull/64312) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Добавлены настройки `parallel_replicas_custom_key_range_lower` и `parallel_replicas_custom_key_range_upper` для управления тем, как параллельные реплики с динамическими шардами распараллеливают запросы при использовании фильтра по диапазону. [#64604](https://github.com/ClickHouse/ClickHouse/pull/64604) ([josh-hildred](https://github.com/josh-hildred)).



#### Повышение производительности {#performance-improvement-6}

* Добавлена возможность перераспределять строки при вставке для оптимизации размера без нарушения порядка, заданного `PRIMARY KEY`. Управляется настройкой `optimize_row_order` (по умолчанию выключена). [#63578](https://github.com/ClickHouse/ClickHouse/pull/63578) ([Igor Markelov](https://github.com/ElderlyPassionFruit)).
* Добавлен встроенный ридер формата Parquet, который считывает бинарные данные Parquet напрямую в столбцы ClickHouse. Его работу регулирует настройка `input_format_parquet_use_native_reader` (по умолчанию выключена). [#60361](https://github.com/ClickHouse/ClickHouse/pull/60361) ([ZhiHong Zhang](https://github.com/copperybean)).
* Реализована частичная тривиальная оптимизация COUNT, когда фильтр запроса может выбирать точные диапазоны из таблиц MergeTree. [#60463](https://github.com/ClickHouse/ClickHouse/pull/60463) ([Amos Bird](https://github.com/amosbird)).
* Снижено максимальное потребление памяти при многопоточных `INSERT` за счёт сбора чанков из нескольких потоков в одном преобразовании. [#61047](https://github.com/ClickHouse/ClickHouse/pull/61047) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Снижено потребление памяти при использовании объектного хранилища Azure за счёт фиксированного распределения памяти, что позволяет избежать выделения дополнительного буфера. [#63160](https://github.com/ClickHouse/ClickHouse/pull/63160) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Уменьшено количество виртуальных вызовов функций в `ColumnNullable::size`. [#60556](https://github.com/ClickHouse/ClickHouse/pull/60556) ([HappenLee](https://github.com/HappenLee)).
* Ускорена работа функции `splitByRegexp`, если аргумент регулярного выражения — одиночный символ. [#62696](https://github.com/ClickHouse/ClickHouse/pull/62696) ([Robert Schulze](https://github.com/rschu1ze)).
* Ускорена агрегация по 8-битным и 16-битным ключам за счёт отслеживания минимального и максимального значений ключей. Это позволяет сократить количество ячеек, которые требуется проверять. [#62746](https://github.com/ClickHouse/ClickHouse/pull/62746) ([Jiebin Sun](https://github.com/jiebinn)).
* Оптимизировать оператор `IN`, когда слева тип `LowCardinality`, а справа — набор констант. [#64060](https://github.com/ClickHouse/ClickHouse/pull/64060) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
* Теперь для инициализации и уничтожения хеш-таблиц внутри `ConcurrentHashJoin` используется пул потоков. [#64241](https://github.com/ClickHouse/ClickHouse/pull/64241) ([Nikita Taranov](https://github.com/nickitat)).
* Оптимизированы вертикальные слияния в таблицах с разреженными столбцами. [#64311](https://github.com/ClickHouse/ClickHouse/pull/64311) ([Anton Popov](https://github.com/CurtizJ)).
* Включена предварительная подгрузка данных из удалённой файловой системы при вертикальных слияниях. Это снижает задержку вертикальных слияний в таблицах с данными, хранящимися на удалённой файловой системе. [#64314](https://github.com/ClickHouse/ClickHouse/pull/64314) ([Anton Popov](https://github.com/CurtizJ)).
* Сокращено количество избыточных вызовов функции `isDefault` в `ColumnSparse::filter` для улучшения производительности. [#64426](https://github.com/ClickHouse/ClickHouse/pull/64426) ([Jiebin Sun](https://github.com/jiebinn)).
* Ускорены команды keeper-client `find_super_nodes` и `find_big_family` за счёт выполнения нескольких асинхронных запросов getChildren. [#64628](https://github.com/ClickHouse/ClickHouse/pull/64628) ([Alexander Gololobov](https://github.com/davenger)).
* Улучшена работа функций `least`/`greatest` для аргументов с типами данных Nullable числового типа. [#64668](https://github.com/ClickHouse/ClickHouse/pull/64668) ([KevinyhZou](https://github.com/KevinyhZou)).
* Разрешено объединение двух последовательных шагов фильтрации в плане запроса. Это улучшает оптимизацию проталкивания фильтра (filter push-down), если условие фильтрации может быть протолкнуто вниз из родительского шага. [#64760](https://github.com/ClickHouse/ClickHouse/pull/64760) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Удалена некорректная оптимизация в финальной вертикальной реализации и по умолчанию снова включён вертикальный финальный алгоритм. [#64783](https://github.com/ClickHouse/ClickHouse/pull/64783) ([Duc Canh Le](https://github.com/canhld94)).
* Из фильтрующего выражения удалены узлы ALIAS. Это слегка повышает производительность запросов с `PREWHERE` (с новым анализатором). [#64793](https://github.com/ClickHouse/ClickHouse/pull/64793) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Повторно включено кэширование сеансов OpenSSL. [#65111](https://github.com/ClickHouse/ClickHouse/pull/65111) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлены настройки для отключения материализации skip-индексов и статистики при вставке данных (`materialize_skip_indexes_on_insert` и `materialize_statistics_on_insert`). [#64391](https://github.com/ClickHouse/ClickHouse/pull/64391) ([Anton Popov](https://github.com/CurtizJ)).
* Теперь для вычисления размера группы строк и уменьшения пикового потребления памяти писателем Parquet в однопоточном режиме используется выделенный объем памяти. [#64424](https://github.com/ClickHouse/ClickHouse/pull/64424) ([LiuNeng](https://github.com/liuneng1994)).
* Улучшен итератор разреженного столбца, чтобы сократить количество вызовов `size`. [#64497](https://github.com/ClickHouse/ClickHouse/pull/64497) ([Jiebin Sun](https://github.com/jiebinn)).
* Обновлено условие для использования серверного копирования данных при создании резервных копий в Azure Blob Storage. [#64518](https://github.com/ClickHouse/ClickHouse/pull/64518) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Оптимизировано использование памяти вертикальных слияний для таблиц с большим количеством skip-индексов. [#64580](https://github.com/ClickHouse/ClickHouse/pull/64580) ([Anton Popov](https://github.com/CurtizJ)).





#### Улучшение {#improvement-6}

* `SHOW CREATE TABLE`, выполненный для системных таблиц, теперь выводит уникальный, весьма полезный комментарий для каждой таблицы, объясняющий её назначение. [#63788](https://github.com/ClickHouse/ClickHouse/pull/63788) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Второй аргумент (scale) функций `round()`, `roundBankers()`, `floor()`, `ceil()` и `trunc()` теперь может быть неконстантой. [#64798](https://github.com/ClickHouse/ClickHouse/pull/64798) ([Mikhail Gorshkov](https://github.com/mgorshkov)).
* Горячая перезагрузка политики хранения для таблиц типа `Distributed` при добавлении нового диска. [#58285](https://github.com/ClickHouse/ClickHouse/pull/58285) ([Duc Canh Le](https://github.com/canhld94)).
* Устранена возможная взаимоблокировка при анализе индексов MergeTree при планировании потоков в перегруженном сервисе. [#59427](https://github.com/ClickHouse/ClickHouse/pull/59427) ([Sean Haynes](https://github.com/seandhaynes)).
* Несколько незначительных исправлений обработки краевых случаев в поддержке S3-прокси и туннелировании. [#63427](https://github.com/ClickHouse/ClickHouse/pull/63427) ([Arthur Passos](https://github.com/arthurpassos)).
* Улучшена наблюдаемость повторных отправок в io&#95;uring. Событие профилирования `IOUringSQEsResubmits` переименовано в `IOUringSQEsResubmitsAsync` и добавлено новое событие `IOUringSQEsResubmitsSync`. [#63699](https://github.com/ClickHouse/ClickHouse/pull/63699) ([Tomer Shafir](https://github.com/tomershafir)).
* Добавлена новая настройка `metadata_keep_free_space_bytes` для резервирования свободного места на диске хранилища метаданных. [#64128](https://github.com/ClickHouse/ClickHouse/pull/64128) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Добавлены метрики для отслеживания количества директорий, создаваемых и удаляемых хранилищем метаданных `plain_rewritable`, а также количества записей в отображении local-to-remote в памяти. [#64175](https://github.com/ClickHouse/ClickHouse/pull/64175) ([Julia Kartseva](https://github.com/jkartseva)).
* Кэш запросов теперь рассматривает идентичные запросы с разными настройками как разные запросы. Это повышает надёжность в случаях, когда различные настройки (например, `limit` или `additional_table_filters`) могут повлиять на результат запроса. [#64205](https://github.com/ClickHouse/ClickHouse/pull/64205) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавить поддержку нестандартного кода ошибки `QpsLimitExceeded` в объектном хранилище как ошибки, допускающей повтор запроса. [#64225](https://github.com/ClickHouse/ClickHouse/pull/64225) ([Sema Checherinda](https://github.com/CheSema)).
* Запрещено преобразование таблицы MergeTree в реплицируемую, если путь ZooKeeper для этой таблицы уже существует. [#64244](https://github.com/ClickHouse/ClickHouse/pull/64244) ([Kirill](https://github.com/kirillgarbar)).
* Добавлена новая настройка `input_format_parquet_prefer_block_bytes` для управления средним размером выходного блока (в байтах) и изменено значение по умолчанию параметра `input_format_parquet_max_block_size` на 65409. [#64427](https://github.com/ClickHouse/ClickHouse/pull/64427) ([LiuNeng](https://github.com/liuneng1994)).
* Разрешён обход прокси для хостов, указанных в переменной окружения `no_proxy` и в конфигурации прокси ClickHouse. [#63314](https://github.com/ClickHouse/ClickHouse/pull/63314) ([Arthur Passos](https://github.com/arthurpassos)).
* Всегда запускайте Keeper с достаточным числом потоков в глобальном пуле потоков. [#64444](https://github.com/ClickHouse/ClickHouse/pull/64444) ([Duc Canh Le](https://github.com/canhld94)).
* Настройки из пользовательского конфига не влияют на слияния и мутации для `MergeTree` при работе с объектным хранилищем. [#64456](https://github.com/ClickHouse/ClickHouse/pull/64456) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка нестандартного кода ошибки `TotalQpsLimitExceeded` в объектном хранилище как ошибки, подлежащей повторной попытке. [#64520](https://github.com/ClickHouse/ClickHouse/pull/64520) ([Sema Checherinda](https://github.com/CheSema)).
* Обновлена расширенная панель мониторинга как в open-source-версии, так и в ClickHouse Cloud, добавлен график «Maximum concurrent network connections» (максимальное число одновременных сетевых подключений). [#64610](https://github.com/ClickHouse/ClickHouse/pull/64610) ([Thom O&#39;Connor](https://github.com/thomoco)).
* Улучшен отчет о ходе выполнения для `zeros_mt` и `generateRandom`. [#64804](https://github.com/ClickHouse/ClickHouse/pull/64804) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлена асинхронная метрика `jemalloc.profile.active`, показывающая, активно ли в данный момент семплирование. Это механизм активации в дополнение к `prof.active`; оба параметра должны быть активны, чтобы вызывающий поток выполнял семплирование. [#64842](https://github.com/ClickHouse/ClickHouse/pull/64842) ([Unalian](https://github.com/Unalian)).
* С настройки `allow_experimental_join_condition` снята пометка о важности. Эта пометка могла препятствовать успешному выполнению распределённых запросов в кластере со смешанными версиями. [#65008](https://github.com/ClickHouse/ClickHouse/pull/65008) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлены асинхронные серверные метрики `DiskGetObjectThrottler*` и `DiskGetObjectThrottler*`, отражающие лимит на количество запросов в секунду, задаваемый настройками диска `s3_max_get_rps` и `s3_max_put_rps`, а также текущее доступное число запросов, которые могут быть отправлены без достижения предела троттлинга на диске. Метрики определяются для каждого диска, для которого настроен лимит. [#65050](https://github.com/ClickHouse/ClickHouse/pull/65050) ([Sergei Trifonov](https://github.com/serxa)).
* Инициализирован глобальный сборщик трасс для `Poco::ThreadPool` (необходим для Keeper и т. д.). [#65239](https://github.com/ClickHouse/ClickHouse/pull/65239) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена проверка при создании пользователя с использованием `bcrypt_hash`. [#65242](https://github.com/ClickHouse/ClickHouse/pull/65242) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлены события профилирования о количестве строк, прочитанных во время выполнения и после выполнения `PREWHERE`. [#64198](https://github.com/ClickHouse/ClickHouse/pull/64198) ([Nikita Taranov](https://github.com/nickitat)).
* Вывод запроса в `EXPLAIN PLAN` при работе с параллельными репликами. [#64298](https://github.com/ClickHouse/ClickHouse/pull/64298) ([vdimir](https://github.com/vdimir)).
* Переименовать `allow_deprecated_functions` в `allow_deprecated_error_prone_window_functions`. [#64358](https://github.com/ClickHouse/ClickHouse/pull/64358) ([Raúl Marín](https://github.com/Algunenano)).
* Учитывать настройку `max_read_buffer_size` и для файловых дескрипторов в табличной функции `file`. [#64532](https://github.com/ClickHouse/ClickHouse/pull/64532) ([Azat Khuzhin](https://github.com/azat)).
* Отключены транзакции для неподдерживаемых хранилищ, в том числе для материализованных представлений. [#64918](https://github.com/ClickHouse/ClickHouse/pull/64918) ([alesapin](https://github.com/alesapin)).
* Запрещено использование конструкции `QUALIFY` в старом анализаторе. Старый анализатор игнорировал `QUALIFY`, поэтому это могло приводить к неожиданному удалению данных при мутациях. [#65356](https://github.com/ClickHouse/ClickHouse/pull/65356) ([Dmitry Novik](https://github.com/novikd)).





#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-5}

* Исправлена ошибка в библиотеке Apache ORC: скорректирован расчёт статистики ORC при записи данных для беззнаковых типов на всех платформах и типа Int8 на ARM. [#64563](https://github.com/ClickHouse/ClickHouse/pull/64563) ([Michael Kolupaev](https://github.com/al13n321)).
* Вернули прежнее поведение ClickHouse при работе и интерпретации `Tuple` в формате CSV. Это изменение по сути откатывает [https://github.com/ClickHouse/ClickHouse/pull/60994](https://github.com/ClickHouse/ClickHouse/pull/60994) и делает его доступным только при использовании нескольких настроек: `output_format_csv_serialize_tuple_into_separate_columns`, `input_format_csv_deserialize_separate_columns_into_tuple` и `input_format_csv_try_infer_strings_from_quoted_tuples`. [#65170](https://github.com/ClickHouse/ClickHouse/pull/65170) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена ошибка проверки прав, при которой пользователь в определённых условиях мог повысить свои привилегии в базе данных по умолчанию без необходимых грантов. [#64769](https://github.com/ClickHouse/ClickHouse/pull/64769) ([pufit](https://github.com/pufit)).
* Исправлено падение при использовании UniqInjectiveFunctionsEliminationPass и uniqCombined. [#65188](https://github.com/ClickHouse/ClickHouse/pull/65188) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена ошибка в ClickHouse Keeper, приводившая к несовпадению дайджеста при закрытии сессии. [#65198](https://github.com/ClickHouse/ClickHouse/pull/65198) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Теперь используется корректное выравнивание памяти для комбинатора Distinct. Ранее мог происходить сбой из-за некорректного выделения памяти при использовании этого комбинатора. [#65379](https://github.com/ClickHouse/ClickHouse/pull/65379) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлен сбой при использовании `DISTINCT` и оконных функций. [#64767](https://github.com/ClickHouse/ClickHouse/pull/64767) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлена проблема, из-за которой skip-индекс &#39;set&#39; не работал с IN и indexHint(). [#62083](https://github.com/ClickHouse/ClickHouse/pull/62083) ([Michael Kolupaev](https://github.com/al13n321)).
* Добавлена поддержка выполнения функции при присвоении значения параметризованного представления. [#63502](https://github.com/ClickHouse/ClickHouse/pull/63502) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлено отслеживание потребления памяти в Parquet. [#63584](https://github.com/ClickHouse/ClickHouse/pull/63584) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлено чтение столбцов типа `Tuple(Map(LowCardinality(String), String), ...)`. [#63956](https://github.com/ClickHouse/ClickHouse/pull/63956) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка `Cyclic aliases`, возникавшая при использовании циклических псевдонимов разных типов (выражения и функции). [#63993](https://github.com/ClickHouse/ClickHouse/pull/63993) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Это исправление будет использовать корректно переопределённый контекст с корректным пользователем-определителем для каждого отдельного представления в конвейере обработки запросов. [#64079](https://github.com/ClickHouse/ClickHouse/pull/64079) ([pufit](https://github.com/pufit)).
* Исправлен анализатор: при использовании INTERPOLATE устранена ошибка &quot;Not found column&quot;. [#64096](https://github.com/ClickHouse/ClickHouse/pull/64096) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена ошибка при создании резервных копий в S3-бакеты с учетными данными, отличающимися от учетных данных диска, содержащего файл. [#64153](https://github.com/ClickHouse/ClickHouse/pull/64153) ([Antonio Andelic](https://github.com/antonio2368)).
* Кэш запросов теперь рассматривает два идентичных запроса к разным базам данных как разные запросы. Предыдущее поведение могло использоваться для обхода ограничения прав на чтение таблицы. [#64199](https://github.com/ClickHouse/ClickHouse/pull/64199) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлено возможное аварийное завершение процесса при необработанном исключении в деструкторе ~WriteBufferFromFileDescriptor в StatusFile. [#64206](https://github.com/ClickHouse/ClickHouse/pull/64206) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка `duplicate alias` в распределённых запросах с `ARRAY JOIN`. [#64226](https://github.com/ClickHouse/ClickHouse/pull/64226) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено неожиданное поведение accurateCast при преобразовании строки в целое число. [#64255](https://github.com/ClickHouse/ClickHouse/pull/64255) ([wudidapaopao](https://github.com/wudidapaopao)).
* Исправлено упрощение CNF для случая, когда какая-либо группа OR содержит взаимоисключающие атомы. [#64256](https://github.com/ClickHouse/ClickHouse/pull/64256) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлена проверка размера дерева запроса. [#64377](https://github.com/ClickHouse/ClickHouse/pull/64377) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена ошибка `Logical error: Bad cast` для таблицы `Buffer` при использовании `PREWHERE`. [#64388](https://github.com/ClickHouse/ClickHouse/pull/64388) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Предотвращено рекурсивное логирование в `blob_storage_log` при размещении в объектном хранилище. [#64393](https://github.com/ClickHouse/ClickHouse/pull/64393) ([vdimir](https://github.com/vdimir)).
* Исправлены запросы `CREATE TABLE AS` для таблиц с выражениями по умолчанию. [#64455](https://github.com/ClickHouse/ClickHouse/pull/64455) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено поведение `optimize_read_in_order` для ORDER BY ... NULLS FIRST / LAST в таблицах с ключами, допускающими NULL. [#64483](https://github.com/ClickHouse/ClickHouse/pull/64483) ([Eduard Karacharov](https://github.com/korowa)).
* Исправлены ошибки `Expression nodes list expected 1 projection names` и `Unknown expression or identifier` для запросов, использующих псевдонимы для `GLOBAL IN`. [#64517](https://github.com/ClickHouse/ClickHouse/pull/64517) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка `Cannot find column` в распределённых запросах с константным CTE в ключе `GROUP BY`. [#64519](https://github.com/ClickHouse/ClickHouse/pull/64519) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен цикл сбоев, возникавший, если восстановление из резервной копии блокировалось созданием материализованного представления (MV) с definer&#39;ом (определяющим пользователем), который ещё не был восстановлен. [#64595](https://github.com/ClickHouse/ClickHouse/pull/64595) ([pufit](https://github.com/pufit)).
* Исправлен результат работы функции `formatDateTimeInJodaSyntax`, когда форматтер генерирует нечётное количество символов и последний символ — `0`. Например, теперь `SELECT formatDateTimeInJodaSyntax(toDate('2012-05-29'), 'D')` корректно возвращает `150` вместо прежнего значения `15`. [#64614](https://github.com/ClickHouse/ClickHouse/pull/64614) ([LiuNeng](https://github.com/liuneng1994)).
* Не переписывать агрегацию, если комбинатор `-If` уже используется. [#64638](https://github.com/ClickHouse/ClickHouse/pull/64638) ([Dmitry Novik](https://github.com/novikd)).
* Исправлено определение типа для `float` (в случае маленького буфера, т.е. `--max_read_buffer_size 1`). [#64641](https://github.com/ClickHouse/ClickHouse/pull/64641) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, которая могла приводить к некорректной работе TTL с выражениями. [#64694](https://github.com/ClickHouse/ClickHouse/pull/64694) ([alesapin](https://github.com/alesapin)).
* Исправлено удаление выражений `WHERE` и `PREWHERE`, если они всегда истинны (для нового анализатора). [#64695](https://github.com/ClickHouse/ClickHouse/pull/64695) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено чрезмерное отсечение партиций текстовыми индексами на основе токенов (`ngrambf` , `full_text`) при фильтрации с использованием `startsWith`, `endsWith`, `match`, `multiSearchAny`. [#64720](https://github.com/ClickHouse/ClickHouse/pull/64720) ([Eduard Karacharov](https://github.com/korowa)).
* Исправляет некорректное поведение обработки управляющих последовательностей ANSI CSI в функции `UTF8::computeWidth`. [#64756](https://github.com/ClickHouse/ClickHouse/pull/64756) ([Shaun Struwig](https://github.com/Blargian)).
* Исправлен случай некорректного удаления `ORDER BY` / `LIMIT BY` в нескольких подзапросах. [#64766](https://github.com/ClickHouse/ClickHouse/pull/64766) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлен (экспериментальный) неравенственный JOIN с подзапросами для множеств, которые используются в смешанных условиях соединения. [#64775](https://github.com/ClickHouse/ClickHouse/pull/64775) ([lgbo](https://github.com/lgbo-ustc)).
* Исправлена ошибка, приводившая к аварийному завершению работы локального кэша на диске `plain_rewritable`. [#64778](https://github.com/ClickHouse/ClickHouse/pull/64778) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправление в Keeper: теперь в команде `mntr` возвращается корректное значение `zk_latest_snapshot_size`. [#64784](https://github.com/ClickHouse/ClickHouse/pull/64784) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка `Cannot find column` в распределённом запросе, использующем `ARRAY JOIN` по столбцу типа `Nested`. Исправляет [#64755](https://github.com/ClickHouse/ClickHouse/issues/64755). [#64801](https://github.com/ClickHouse/ClickHouse/pull/64801) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена утечка памяти в политике кэширования SLRU. [#64803](https://github.com/ClickHouse/ClickHouse/pull/64803) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено возможное некорректное отслеживание памяти в нескольких видах запросов: запросах, читающих любые данные из S3, запросах по протоколу HTTP, асинхронных вставках. [#64844](https://github.com/ClickHouse/ClickHouse/pull/64844) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка `Block structure mismatch` для запросов, использующих `PREWHERE` при чтении из материализованного представления, когда материализованное представление содержит столбцы с типами, отличающимися от типов в исходной таблице. Устраняет [#64611](https://github.com/ClickHouse/ClickHouse/issues/64611). [#64855](https://github.com/ClickHouse/ClickHouse/pull/64855) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено редкое аварийное завершение при наличии у таблицы TTL с подзапросом + реплицируемой базы данных + параллельных реплик + analyzer. Это действительно редкий случай, но, пожалуйста, не используйте TTL с подзапросами. [#64858](https://github.com/ClickHouse/ClickHouse/pull/64858) ([alesapin](https://github.com/alesapin)).
* Исправлено дублирование событий `Delete` в `blob_storage_log` при удалении большого пакета. [#64924](https://github.com/ClickHouse/ClickHouse/pull/64924) ([vdimir](https://github.com/vdimir)).
* Исправлена ошибка `Session moved to another server` от [Zoo]Keeper, которая могла возникать после запуска сервера, если конфигурация содержала включения из [Zoo]Keeper. [#64986](https://github.com/ClickHouse/ClickHouse/pull/64986) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлен запрос `ALTER MODIFY COMMENT`, который некорректно работал для параметризованных представлений (VIEW) в [https://github.com/ClickHouse/ClickHouse/pull/54211](https://github.com/ClickHouse/ClickHouse/pull/54211). [#65031](https://github.com/ClickHouse/ClickHouse/pull/65031) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлен `host_id` в DatabaseReplicated при включённом параметре `cluster_secure_connection`. Ранее все подключения внутри кластера, создаваемые DatabaseReplicated, оставались незащищёнными, даже если параметр был включён. [#65054](https://github.com/ClickHouse/ClickHouse/pull/65054) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена ошибка `Not-ready Set` после оптимизации `PREWHERE` для StorageMerge. [#65057](https://github.com/ClickHouse/ClickHouse/pull/65057) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Не выполняйте запись в финализированный буфер в файлоподобных хранилищах. [#65063](https://github.com/ClickHouse/ClickHouse/pull/65063) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена потенциальная бесконечная длительность выполнения запроса при циклических псевдонимах. Исправляет [#64849](https://github.com/ClickHouse/ClickHouse/issues/64849). [#65081](https://github.com/ClickHouse/ClickHouse/pull/65081) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка `Unknown expression identifier` в удалённых запросах с `INTERPOLATE (alias)` (новый анализатор). Исправляет [#64636](https://github.com/ClickHouse/ClickHouse/issues/64636). [#65090](https://github.com/ClickHouse/ClickHouse/pull/65090) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена оптимизация выноса арифметических операций из агрегации. В новом анализаторе эта оптимизация выполнялась только один раз. [#65104](https://github.com/ClickHouse/ClickHouse/pull/65104) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена перезапись имени агрегатной функции в новом анализаторе. [#65110](https://github.com/ClickHouse/ClickHouse/pull/65110) ([Dmitry Novik](https://github.com/novikd)).
* Отвечать кодом ответа 5xx вместо 200 OK в случае тайм‑аута при чтении (частей) тела запроса из клиентского сокета. [#65118](https://github.com/ClickHouse/ClickHouse/pull/65118) ([Julian Maicher](https://github.com/jmaicher)).
* Исправлен потенциальный сбой при выполнении hedged-запросов. [#65206](https://github.com/ClickHouse/ClickHouse/pull/65206) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка в механизме короткого замыкания при вычислении словарей Hashed и Hashed&#95;Array, из-за которой могло происходить чтение неинициализированного числа, приводящее к различным ошибкам. [#65256](https://github.com/ClickHouse/ClickHouse/pull/65256) ([jsc0218](https://github.com/jsc0218)).
* Этот PR гарантирует, что тип константы (второго параметра оператора IN) всегда учитывается во время процесса приведения типов для оператора IN. В противном случае потеря информации о типе может привести к тому, что некоторые преобразования будут завершаться с ошибкой, например преобразование из DateTime в Date. Тем самым исправляется ([#64487](https://github.com/ClickHouse/ClickHouse/issues/64487)). [#65315](https://github.com/ClickHouse/ClickHouse/pull/65315) ([pn](https://github.com/chloro-pn)).



#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-2}
* Добавлена поддержка LLVM XRay. [#64592](https://github.com/ClickHouse/ClickHouse/pull/64592) [#64837](https://github.com/ClickHouse/ClickHouse/pull/64837) ([Tomer Shafir](https://github.com/tomershafir)).
* Объединены реализации хранилищ s3/hdfs/azure в один класс, работающий с IObjectStorage. То же самое сделано для *Cluster, озёр данных и хранилищ Queue. [#59767](https://github.com/ClickHouse/ClickHouse/pull/59767) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Проведён рефакторинг компонента записи частей данных для удаления зависимостей от MergeTreeData и DataPart. [#63620](https://github.com/ClickHouse/ClickHouse/pull/63620) ([Alexander Gololobov](https://github.com/davenger)).
* Проведён рефакторинг `KeyCondition` и анализа ключей для улучшения PartitionPruner и оптимизации тривиального подсчёта. Это выделено отдельно от [#60463](https://github.com/ClickHouse/ClickHouse/issues/60463). [#61459](https://github.com/ClickHouse/ClickHouse/pull/61459) ([Amos Bird](https://github.com/amosbird)).
* Добавлены утверждения (assertions) для проверки, что все функции вызываются с колонками корректного размера. [#63723](https://github.com/ClickHouse/ClickHouse/pull/63723) ([Raúl Marín](https://github.com/Algunenano)).
* Сделан обязательным сервис `network` при использовании init-скрипта `rc` для запуска демона сервера ClickHouse. [#60650](https://github.com/ClickHouse/ClickHouse/pull/60650) ([Chun-Sheng, Li](https://github.com/peter279k)).
* Уменьшен размер некоторых медленных тестов. [#64387](https://github.com/ClickHouse/ClickHouse/pull/64387) [#64452](https://github.com/ClickHouse/ClickHouse/pull/64452) ([Raúl Marín](https://github.com/Algunenano)).
* Реализовано воспроизведение журналов ZooKeeper с использованием keeper-bench. [#62481](https://github.com/ClickHouse/ClickHouse/pull/62481) ([Antonio Andelic](https://github.com/antonio2368)).

### <a id="245"></a> Релиз ClickHouse 24.5, 2024-05-30 {#a-id245a-clickhouse-release-245-2024-05-30}

#### Несовместимые изменения {#backward-incompatible-change-7}
* «Инвертированные индексы» переименованы в «полнотекстовые индексы», что является менее техническим и более удобным для пользователей названием. Это также изменяет внутренние метаданные таблиц и ломает таблицы с существующими (экспериментальными) инвертированными индексами. Перед обновлением обязательно удалите такие индексы и пересоздайте их после обновления. [#62884](https://github.com/ClickHouse/ClickHouse/pull/62884) ([Robert Schulze](https://github.com/rschu1ze)).
* Использование функций `neighbor`, `runningAccumulate`, `runningDifferenceStartingWithFirstValue`, `runningDifference` объявлено устаревшим (так как они легко приводят к ошибкам). Вместо них следует использовать корректные оконные функции. Чтобы включить их обратно, установите `allow_deprecated_error_prone_window_functions = 1` или установите `compatibility = '24.4'` или ниже. [#63132](https://github.com/ClickHouse/ClickHouse/pull/63132) ([Nikita Taranov](https://github.com/nickitat)).
* Запросы к `system.columns` будут работать быстрее, если имеется большое количество колонок, но при этом для многих баз данных или таблиц не выданы права `SHOW TABLES`. Обратите внимание, что в предыдущих версиях, если вы выдаёте `SHOW COLUMNS` для отдельных колонок, не выдавая `SHOW TABLES` для соответствующих таблиц, таблица `system.columns` будет показывать эти колонки, но в новой версии такая таблица будет полностью пропущена. Удалены сообщения трассировки в логах "Access granted" и "Access denied", которые замедляли запросы. [#63439](https://github.com/ClickHouse/ClickHouse/pull/63439) ([Alexey Milovidov](https://github.com/alexey-milovidov)).



#### Новая возможность {#new-feature-7}

* Добавляет формат `Form` для чтения и записи одной записи в формате `application/x-www-form-urlencoded`. [#60199](https://github.com/ClickHouse/ClickHouse/pull/60199) ([Shaun Struwig](https://github.com/Blargian)).
* Добавлена возможность сжатия в операторе CROSS JOIN. [#60459](https://github.com/ClickHouse/ClickHouse/pull/60459) ([p1rattttt](https://github.com/p1rattttt)).
* Добавлена возможность выполнять `CROSS JOIN` с использованием временных файлов, если размер превышает лимиты. [#63432](https://github.com/ClickHouse/ClickHouse/pull/63432) ([p1rattttt](https://github.com/p1rattttt)).
* Поддержка `JOIN` с условиями неравенства, которые задействуют столбцы из обеих таблиц (левой и правой), например `t1.y < t2.y`. Чтобы включить эту возможность, выполните `SET allow_experimental_join_condition = 1`. [#60920](https://github.com/ClickHouse/ClickHouse/pull/60920) ([lgbo](https://github.com/lgbo-ustc)).
* Карты теперь поддерживают использование `Float32`, `Float64`, `Array(T)`, `Map(K, V)` и `Tuple(T1, T2, ...)` в качестве ключей. Закрыта задача [#54537](https://github.com/ClickHouse/ClickHouse/issues/54537). [#59318](https://github.com/ClickHouse/ClickHouse/pull/59318) ([李扬](https://github.com/taiyang-li)).
* Добавлена массовая загрузка в `EmbeddedRocksDB` путём создания и приёма SST-файла вместо использования встроенной в RocksDB memtable. Это позволяет повысить скорость импорта, особенно для длительных запросов INSERT в таблицы `StorageEmbeddedRocksDB`. Также добавлены настройки таблиц `EmbeddedRocksDB`. [#59163](https://github.com/ClickHouse/ClickHouse/pull/59163) [#63324](https://github.com/ClickHouse/ClickHouse/pull/63324) ([Duc Canh Le](https://github.com/canhld94)).
* Теперь пользователь может разбирать формат TSV с окончаниями строк CRLF с помощью настройки `input_format_tsv_crlf_end_of_line`. Закрывает [#56257](https://github.com/ClickHouse/ClickHouse/issues/56257). [#59747](https://github.com/ClickHouse/ClickHouse/pull/59747) ([Shaun Struwig](https://github.com/Blargian)).
* Новая настройка `input_format_force_null_for_omitted_fields` принудительно устанавливает значения NULL для пропущенных полей. [#60887](https://github.com/ClickHouse/ClickHouse/pull/60887) ([Constantine Peresypkin](https://github.com/pkit)).
* Ранее наше хранилище S3 и табличная функция s3 не поддерживали выборку данных из файлов в архивных контейнерах, таких как tarball, zip, 7z. Теперь они позволяют перебирать файлы внутри таких архивов в S3. [#62259](https://github.com/ClickHouse/ClickHouse/pull/62259) ([Daniil Ivanik](https://github.com/divanik)).
* Добавлена поддержка условной функции `clamp`. [#62377](https://github.com/ClickHouse/ClickHouse/pull/62377) ([skyoct](https://github.com/skyoct)).
* Добавлен формат вывода `NPy`. [#62430](https://github.com/ClickHouse/ClickHouse/pull/62430) ([豪肥肥](https://github.com/HowePa)).
* Формат `Raw` теперь является синонимом `TSVRaw`. [#63394](https://github.com/ClickHouse/ClickHouse/pull/63394) ([Unalian](https://github.com/Unalian)).
* Добавлена новая SQL-функция `generateUUIDv7` для создания UUID версии 7, то есть UUID на основе метки времени со случайным компонентом. Также добавлена новая функция `UUIDToNum` для извлечения байтового представления UUID и новая функция `UUIDv7ToDateTime` для извлечения компонента метки времени из UUID версии 7. [#62852](https://github.com/ClickHouse/ClickHouse/pull/62852) ([Alexey Petrunyaka](https://github.com/pet74alex)).
* В Linux и MacOS, если stdout программы перенаправлен в файл с расширением, обозначающим сжатие, используется соответствующий метод сжатия вместо отсутствия сжатия (что делает поведение аналогичным `INTO OUTFILE`). [#63662](https://github.com/ClickHouse/ClickHouse/pull/63662) ([v01dXYZ](https://github.com/v01dXYZ)).
* Изменено предупреждение, отображаемое при большом количестве подключённых таблиц, чтобы различать таблицы, представления и словари. [#64180](https://github.com/ClickHouse/ClickHouse/pull/64180) ([Francisco J. Jurado Moreno](https://github.com/Beetelbrox)).
* Добавлена поддержка функции `azureBlobStorage` в сервере ClickHouse для использования Azure Workload Identity при аутентификации в Azure Blob Storage. Если в конфигурации установлен параметр `use_workload_identity`, для аутентификации используется [Workload Identity](https://github.com/Azure/azure-sdk-for-cpp/tree/main/sdk/identity/azure-identity#authenticate-azure-hosted-applications). [#57881](https://github.com/ClickHouse/ClickHouse/pull/57881) ([Vinay Suryadevara](https://github.com/vinay92-ch)).
* Добавлена информация о TTL в таблицу `system.parts_columns`. [#63200](https://github.com/ClickHouse/ClickHouse/pull/63200) ([litlig](https://github.com/litlig)).



#### Экспериментальные возможности {#experimental-features-1}
* Реализован тип данных `Dynamic`, который позволяет хранить значения любого типа без необходимости заранее знать все возможные типы. Тип `Dynamic` доступен при включённой настройке `allow_experimental_dynamic_type`. См.: [#54864](https://github.com/ClickHouse/ClickHouse/issues/54864). [#63058](https://github.com/ClickHouse/ClickHouse/pull/63058) ([Kruglov Pavel](https://github.com/Avogar)).
* Разрешено создавать базу данных `MaterializedMySQL` без подключения к MySQL. [#63397](https://github.com/ClickHouse/ClickHouse/pull/63397) ([Kirill](https://github.com/kirillgarbar)).
* Автоматически помечать реплику реплицируемой базы данных как потерянную и запускать восстановление, если некоторая DDL-задача более `max_retries_before_automatic_recovery` раз подряд (по умолчанию 100) завершается сбоем с одной и той же ошибкой. Также исправлена ошибка, из-за которой могли пропускаться записи DDL при возникновении исключения на ранней стадии выполнения записи. [#63549](https://github.com/ClickHouse/ClickHouse/pull/63549) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Учитывать файлы, обработка которых завершилась сбоем, в `s3queue_tracked_file_ttl_sec` и `s3queue_traked_files_limit` для `StorageS3Queue`. [#63638](https://github.com/ClickHouse/ClickHouse/pull/63638) ([Kseniia Sumarokova](https://github.com/kssenii)).



#### Улучшение производительности {#performance-improvement-7}
* Меньше конкуренции за файловый кэш (часть 4). Позволяет не заполнять файловый кэш до предела за счёт дополнительного вытеснения в фоне (управляется параметром `keep_free_space_size(elements)_ratio`). Это позволяет снизить нагрузку на резервирование места для запросов (в методе `tryReserve`). Также это реализовано по возможности без блокировок, то есть не должно блокировать обычное использование кэша. [#61250](https://github.com/ClickHouse/ClickHouse/pull/61250) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Пропуск слияния заново созданных блоков проекций во время `INSERT`-ов. [#59405](https://github.com/ClickHouse/ClickHouse/pull/59405) ([Nikita Taranov](https://github.com/nickitat)).
* Обработка строковых функций `...UTF8` в ASCII-режиме, если входные строки содержат только ASCII-символы. Вдохновлено https://github.com/apache/doris/pull/29799. Общее ускорение составляет 1.07x~1.62x. Обратите внимание, что пиковое потребление памяти в некоторых случаях уменьшилось. [#61632](https://github.com/ClickHouse/ClickHouse/pull/61632) ([李扬](https://github.com/taiyang-li)).
* Улучшена производительность glob-шаблонов выбора (`{}`) в StorageS3. [#62120](https://github.com/ClickHouse/ClickHouse/pull/62120) ([Andrey Zvonov](https://github.com/zvonand)).
* HostResolver содержит каждый IP-адрес несколько раз. Если удалённый хост имеет несколько IP, и по какой-то причине (например, правила файрвола) доступ по некоторым IP разрешён, а по другим запрещён, то только первая запись с запрещённым IP помечается как неуспешная, и при каждой попытке у этих IP остаётся шанс быть выбранными (и снова завершиться с ошибкой). Даже если это исправить, каждые 120 секунд DNS-кэш сбрасывается, и IP-адреса могут быть выбраны снова. [#62652](https://github.com/ClickHouse/ClickHouse/pull/62652) ([Anton Ivashkin](https://github.com/ianton-ru)).
* Добавлен новый параметр конфигурации `prefer_merge_sort_block_bytes` для управления использованием памяти и двукратного ускорения сортировки при слиянии при большом количестве столбцов. [#62904](https://github.com/ClickHouse/ClickHouse/pull/62904) ([LiuNeng](https://github.com/liuneng1994)).
* `clickhouse-local` теперь будет запускаться быстрее. В предыдущих версиях он по ошибке не удалял временные директории. Теперь будет удалять. Это закрывает задачу [#62941](https://github.com/ClickHouse/ClickHouse/issues/62941). [#63074](https://github.com/ClickHouse/ClickHouse/pull/63074) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Микрооптимизации для нового анализатора. [#63429](https://github.com/ClickHouse/ClickHouse/pull/63429) ([Raúl Marín](https://github.com/Algunenano)).
* Анализ индексов будет работать, если `DateTime` сравнивается с `DateTime64`. Это закрывает задачу [#63441](https://github.com/ClickHouse/ClickHouse/issues/63441). [#63443](https://github.com/ClickHouse/ClickHouse/pull/63443) [#63532](https://github.com/ClickHouse/ClickHouse/pull/63532) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Незначительное ускорение индексов типа `set` (примерно в 1.5 раза) за счёт удаления «мусора». [#64098](https://github.com/ClickHouse/ClickHouse/pull/64098) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Удалено копирование данных при записи в файловый кэш. [#63401](https://github.com/ClickHouse/ClickHouse/pull/63401) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Теперь резервные копии с использованием Azure Blob Storage будут использовать многократное копирование (multicopy). [#64116](https://github.com/ClickHouse/ClickHouse/pull/64116) ([alesapin](https://github.com/alesapin)).
* Разрешено использовать native copy для Azure даже при разных контейнерах. [#64154](https://github.com/ClickHouse/ClickHouse/pull/64154) ([alesapin](https://github.com/alesapin)).
* Наконец включён native copy для Azure. [#64182](https://github.com/ClickHouse/ClickHouse/pull/64182) ([alesapin](https://github.com/alesapin)).



#### Улучшение {#improvement-7}

* Теперь можно использовать `clickhouse-local` и его сокращения `clickhouse` и `ch` с запросом или файлом с запросами в качестве позиционного аргумента. Примеры: `ch "SELECT 1"`, `ch --param_test Hello "SELECT {test:String}"`, `ch query.sql`. Тем самым закрыта задача [#62361](https://github.com/ClickHouse/ClickHouse/issues/62361). [#63081](https://github.com/ClickHouse/ClickHouse/pull/63081) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Включена поддержка метаданных plain&#95;rewritable для локальных и Azure (azure&#95;blob&#95;storage) объектных хранилищ. [#63365](https://github.com/ClickHouse/ClickHouse/pull/63365) ([Julia Kartseva](https://github.com/jkartseva)).
* Поддержка английских Unicode-кавычек, например “Hello”, &#39;world&#39;. В целом это спорное решение, но полезно, когда вы набираете запрос в текстовом редакторе, например в Google Docs. Это закрывает [#58634](https://github.com/ClickHouse/ClickHouse/issues/58634). [#63381](https://github.com/ClickHouse/ClickHouse/pull/63381) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Разрешено использовать завершающие запятые в списке столбцов в запросе INSERT. Например, `INSERT INTO test (a, b, c, ) VALUES ...`. [#63803](https://github.com/ClickHouse/ClickHouse/pull/63803) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшены сообщения об исключениях для формата `Regexp`. [#63804](https://github.com/ClickHouse/ClickHouse/pull/63804) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Разрешены завершающие запятые в формате `Values`. Например, этот запрос допустим: `INSERT INTO test (a, b, c) VALUES (4, 5, 6,);`. [#63810](https://github.com/ClickHouse/ClickHouse/pull/63810) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* RabbitMQ теперь отправляет nack для повреждённых сообщений. Закрывает [#45350](https://github.com/ClickHouse/ClickHouse/issues/45350). [#60312](https://github.com/ClickHouse/ClickHouse/pull/60312) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка при асинхронном раскручивании стека (например, при использовании профилировщика запросов с выборкой), приводившая к аварийному завершению работы во время интерпретации отладочной информации. Это закрывает [#60460](https://github.com/ClickHouse/ClickHouse/issues/60460). [#60468](https://github.com/ClickHouse/ClickHouse/pull/60468) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Разные сообщения об ошибке S3 &#39;no key&#39; для диска и для хранилища. [#61108](https://github.com/ClickHouse/ClickHouse/pull/61108) ([Sema Checherinda](https://github.com/CheSema)).
* Индикатор прогресса теперь будет работать для простых запросов с LIMIT из `system.zeros`, `system.zeros_mt` (он уже работает для `system.numbers` и `system.numbers_mt`), а также с табличной функцией `generateRandom`. В качестве бонуса, если общее количество записей больше лимита `max_rows_to_read`, исключение будет выброшено раньше. Это закрывает [#58183](https://github.com/ClickHouse/ClickHouse/issues/58183). [#61823](https://github.com/ClickHouse/ClickHouse/pull/61823) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Поддержка «Merge Key» в конфигурациях YAML (это странная особенность YAML, можете не обращать на неё внимания). [#62685](https://github.com/ClickHouse/ClickHouse/pull/62685) ([Azat Khuzhin](https://github.com/azat)).
* Улучшено сообщение об ошибке при использовании недетерминированной функции в источнике Replicated. [#62896](https://github.com/ClickHouse/ClickHouse/pull/62896) ([Grégoire Pineau](https://github.com/lyrixx)).
* Исправлен межсерверный секрет для схемы Distributed поверх Distributed при использовании `remote`. [#63013](https://github.com/ClickHouse/ClickHouse/pull/63013) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка `include_from` для файлов YAML. Однако лучше использовать `config.d` [#63106](https://github.com/ClickHouse/ClickHouse/pull/63106) ([Eduard Karacharov](https://github.com/korowa)).
* Сохранять предыдущий ввод в терминале после выбора варианта из подсказок skim. [#63261](https://github.com/ClickHouse/ClickHouse/pull/63261) ([FlameFactory](https://github.com/FlameFactory)).
* Ширина полей (в форматах Pretty или при использовании функции `visibleWidth`) теперь корректно игнорирует escape-последовательности ANSI. [#63270](https://github.com/ClickHouse/ClickHouse/pull/63270) ([Shaun Struwig](https://github.com/Blargian)).
* Использование кода ошибки `NUMBER_OF_ARGUMENTS_DOESNT_MATCH` заменено на более точные коды ошибок, где это уместно. [#63406](https://github.com/ClickHouse/ClickHouse/pull/63406) ([Yohann Jardin](https://github.com/yohannj)).
* `os_user` и `client_hostname` теперь корректно устанавливаются для запросов, используемых для подсказок командной строки в clickhouse-client. Это закрывает [#63430](https://github.com/ClickHouse/ClickHouse/issues/63430). [#63433](https://github.com/ClickHouse/ClickHouse/pull/63433) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Автоматически устанавливать `max_block_size` в значение по умолчанию, если он равен нулю. [#63587](https://github.com/ClickHouse/ClickHouse/pull/63587) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавить в trace&#95;log столбец ALIAS build&#95;id, чтобы упростить автоматическое переименование при обнаружении изменений бинарного файла. Это необходимо для решения [#52086](https://github.com/ClickHouse/ClickHouse/issues/52086). [#63656](https://github.com/ClickHouse/ClickHouse/pull/63656) ([Zimu Li](https://github.com/woodlzm)).
* Добавлена поддержка операции truncate для дисков объектного хранилища. [#63693](https://github.com/ClickHouse/ClickHouse/pull/63693) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Загрузка списка ключевых слов теперь зависит от ревизии сервера и будет отключена для старых версий сервера ClickHouse. CC @azat. [#63786](https://github.com/ClickHouse/ClickHouse/pull/63786) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Диски ClickHouse должны прочитать настройку сервера, чтобы получить текущую версию формата метаданных. [#63831](https://github.com/ClickHouse/ClickHouse/pull/63831) ([Sema Checherinda](https://github.com/CheSema)).
* Отключены ограничения красивого формата (`output_format_pretty_max_rows`/`output_format_pretty_max_value_width`), если стандартный вывод (stdout) не является TTY. [#63942](https://github.com/ClickHouse/ClickHouse/pull/63942) ([Azat Khuzhin](https://github.com/azat)).
* Теперь обработка исключений работает при использовании ClickHouse внутри AWS Lambda. Автор: [Alexey Coolnev](https://github.com/acoolnev). [#64014](https://github.com/ClickHouse/ClickHouse/pull/64014) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Выбрасывать исключение `CANNOT_DECOMPRESS` вместо `CORRUPTED_DATA` при некорректных сжатых данных, полученных по HTTP. [#64036](https://github.com/ClickHouse/ClickHouse/pull/64036) ([vdimir](https://github.com/vdimir)).
* Всплывающая подсказка для отдельного большого числа в форматах Pretty теперь работает для Nullable и LowCardinality. Это закрывает [#61993](https://github.com/ClickHouse/ClickHouse/issues/61993). [#64084](https://github.com/ClickHouse/ClickHouse/pull/64084) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлены метрики, логи и имена потоков при фильтрации частей по индексам. [#64130](https://github.com/ClickHouse/ClickHouse/pull/64130) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Игнорировать параметр `allow_suspicious_primary_key` при `ATTACH` и проверять при `ALTER`. [#64202](https://github.com/ClickHouse/ClickHouse/pull/64202) ([Azat Khuzhin](https://github.com/azat)).



#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-3}
* ClickHouse теперь собирается с использованием clang-18. Включено множество новых проверок из clang-tidy-18. [#60469](https://github.com/ClickHouse/ClickHouse/pull/60469) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Экспериментально добавлена поддержка loongarch64 в качестве новой платформы для ClickHouse. [#63733](https://github.com/ClickHouse/ClickHouse/pull/63733) ([qiangxuhui](https://github.com/qiangxuhui)).
* Dockerfile был проверен официальной библиотекой Docker: https://github.com/docker-library/official-images/pull/15846. [#63400](https://github.com/ClickHouse/ClickHouse/pull/63400) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Информация о каждом символе в каждой единице трансляции будет собираться в базе данных CI для каждой сборки. Это закрывает [#63494](https://github.com/ClickHouse/ClickHouse/issues/63494). [#63495](https://github.com/ClickHouse/ClickHouse/pull/63495) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Обновлена библиотека Apache Datasketches. Это устраняет [#63858](https://github.com/ClickHouse/ClickHouse/issues/63858). [#63923](https://github.com/ClickHouse/ClickHouse/pull/63923) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Включена поддержка gRPC для aarch64 Linux при кросс-компиляции бинарного файла. [#64072](https://github.com/ClickHouse/ClickHouse/pull/64072) ([alesapin](https://github.com/alesapin)).
* Исправлена раскрутка стека (unwind) при обработке SIGSEGV на aarch64 (из-за малого стека для сигнала). [#64058](https://github.com/ClickHouse/ClickHouse/pull/64058) ([Azat Khuzhin](https://github.com/azat)).



#### Исправление ошибки {#bug-fix-1}

* По умолчанию отключена настройка `enable_vertical_final`. Эту возможность не следует использовать, потому что в ней есть ошибка: [#64543](https://github.com/ClickHouse/ClickHouse/issues/64543). [#64544](https://github.com/ClickHouse/ClickHouse/pull/64544) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлено создание резервной копии при использовании нескольких шардов [#57684](https://github.com/ClickHouse/ClickHouse/pull/57684) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена передача проекций/индексов/первичного ключа из списка столбцов запроса CREATE во внутреннюю таблицу MV [#59183](https://github.com/ClickHouse/ClickHouse/pull/59183) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено некорректное объединение boundRatio [#60532](https://github.com/ClickHouse/ClickHouse/pull/60532) ([Tao Wang](https://github.com/wangtZJU)).
* Исправлено падение при вызове некоторых функций для константных столбцов с низкой кардинальностью [#61966](https://github.com/ClickHouse/ClickHouse/pull/61966) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлены запросы с модификатором FINAL, которые возвращали неверный результат, если таблица не использовала адаптивную гранулярность [#62432](https://github.com/ClickHouse/ClickHouse/pull/62432) ([Duc Canh Le](https://github.com/canhld94)).
* Улучшено обнаружение поддержки cgroups v2 для контроллеров памяти [#62903](https://github.com/ClickHouse/ClickHouse/pull/62903) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлено последующее использование внешних таблиц в клиенте [#62964](https://github.com/ClickHouse/ClickHouse/pull/62964) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен сбой (краш), возникавший при использовании untuple и неразрешённой лямбда-функции [#63131](https://github.com/ClickHouse/ClickHouse/pull/63131) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена проблема преждевременного начала сервером прослушивания соединений [#63181](https://github.com/ClickHouse/ClickHouse/pull/63181) ([alesapin](https://github.com/alesapin)).
* Исправлена обработка пересекающихся частей при перезапуске после выполнения команды DROP PART [#63202](https://github.com/ClickHouse/ClickHouse/pull/63202) ([Han Fei](https://github.com/hanfei1991)).
* Корректная загрузка настроек безопасности SQL по умолчанию при запуске [#63209](https://github.com/ClickHouse/ClickHouse/pull/63209) ([pufit](https://github.com/pufit)).
* Исправлена оптимизация проталкивания фильтра в JOIN [#63234](https://github.com/ClickHouse/ClickHouse/pull/63234) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлен бесконечный цикл в AzureObjectStorage::listObjects [#63257](https://github.com/ClickHouse/ClickHouse/pull/63257) ([Julia Kartseva](https://github.com/jkartseva)).
* Оператор CROSS JOIN игнорирует настройку join&#95;algorithm [#63273](https://github.com/ClickHouse/ClickHouse/pull/63273) ([vdimir](https://github.com/vdimir)).
* Исправлены finalize WriteBufferToFileSegment и StatusFile [#63346](https://github.com/ClickHouse/ClickHouse/pull/63346) ([vdimir](https://github.com/vdimir)).
* Исправлена логическая ошибка при выполнении запроса SELECT после ALTER в редких случаях [#63353](https://github.com/ClickHouse/ClickHouse/pull/63353) ([alesapin](https://github.com/alesapin)).
* Исправлена обработка заголовка `X-ClickHouse-Timezone` с учетом `session_timezone` [#63377](https://github.com/ClickHouse/ClickHouse/pull/63377) ([Andrey Zvonov](https://github.com/zvonand)).
* Исправлено срабатывание отладочного assert при использовании группировки WITH ROLLUP и типов LowCardinality  [#63398](https://github.com/ClickHouse/ClickHouse/pull/63398) ([Raúl Marín](https://github.com/Algunenano)).
* Небольшие исправления настройки group&#95;by&#95;use&#95;nulls [#63405](https://github.com/ClickHouse/ClickHouse/pull/63405) ([vdimir](https://github.com/vdimir)).
* Исправлено резервное копирование и восстановление части проекции в случае, когда проекция была удалена из метаданных таблицы, но часть всё ещё содержит эту проекцию [#63426](https://github.com/ClickHouse/ClickHouse/pull/63426) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен источник словаря MySQL [#63481](https://github.com/ClickHouse/ClickHouse/pull/63481) ([vdimir](https://github.com/vdimir)).
* Добавить QueryFinish при AsyncInsertFlush без данных [#63483](https://github.com/ClickHouse/ClickHouse/pull/63483) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено: пустое поле used&#95;dictionaries в system.query&#95;log [#63487](https://github.com/ClickHouse/ClickHouse/pull/63487) ([Eduard Karacharov](https://github.com/korowa)).
* Повышена безопасность `MergeTreePrefetchedReadPool` [#63513](https://github.com/ClickHouse/ClickHouse/pull/63513) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено аварийное завершение при выходе с включённым Sentry (из-за того, что OpenSSL уничтожался раньше Sentry) [#63548](https://github.com/ClickHouse/ClickHouse/pull/63548) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена поддержка типов Array и Map при хешировании по ключу [#63628](https://github.com/ClickHouse/ClickHouse/pull/63628) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Исправить проталкивание фильтров для Parquet и, возможно, для StorageMerge [#63642](https://github.com/ClickHouse/ClickHouse/pull/63642) ([Michael Kolupaev](https://github.com/al13n321)).
* Предотвратить преобразование в Replicated, если путь в ZooKeeper уже существует [#63670](https://github.com/ClickHouse/ClickHouse/pull/63670) ([Kirill](https://github.com/kirillgarbar)).
* Анализатор: представления читают только необходимые столбцы [#63688](https://github.com/ClickHouse/ClickHouse/pull/63688) ([Maksim Kita](https://github.com/kitaisreal)).
* Analyzer: запрет переопределения WINDOW [#63694](https://github.com/ClickHouse/ClickHouse/pull/63694) ([Dmitry Novik](https://github.com/novikd)).
* flatten&#95;nested не работал с экспериментальной базой данных Replicated. [#63695](https://github.com/ClickHouse/ClickHouse/pull/63695) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлены [#63653](https://github.com/ClickHouse/ClickHouse/issues/63653), [#63722](https://github.com/ClickHouse/ClickHouse/pull/63722) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Разрешено приведение типа Array(Nothing) к типу Map(Nothing, Nothing) [#63753](https://github.com/ClickHouse/ClickHouse/pull/63753) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка ILLEGAL&#95;COLUMN в partial&#95;merge join [#63755](https://github.com/ClickHouse/ClickHouse/pull/63755) ([vdimir](https://github.com/vdimir)).
* Исправление: удалён избыточный `distinct` при работе с оконными функциями [#63776](https://github.com/ClickHouse/ClickHouse/pull/63776) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлен потенциальный сбой при выполнении SYSTEM UNLOAD PRIMARY KEY [#63778](https://github.com/ClickHouse/ClickHouse/pull/63778) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлен запрос с дублирующимся циклическим алиасом. [#63791](https://github.com/ClickHouse/ClickHouse/pull/63791) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Сделан `TokenIterator` ленивым, как и должно быть [#63801](https://github.com/ClickHouse/ClickHouse/pull/63801) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена настройка `endpoint_subpath` для S3 URI [#63806](https://github.com/ClickHouse/ClickHouse/pull/63806) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлена взаимоблокировка в `ParallelReadBuffer` [#63814](https://github.com/ClickHouse/ClickHouse/pull/63814) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено проталкивание фильтра в JOIN по эквивалентным столбцам [#63819](https://github.com/ClickHouse/ClickHouse/pull/63819) ([Maksim Kita](https://github.com/kitaisreal)).
* При использовании базы данных Lazy удалять данные со всех дисков после DROP. [#63848](https://github.com/ClickHouse/ClickHouse/pull/63848) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Исправлен некорректный результат при чтении из MV с параллельными репликами и использованием нового анализатора [#63861](https://github.com/ClickHouse/ClickHouse/pull/63861) ([Nikita Taranov](https://github.com/nickitat)).
* Исправления в командах `find_super_nodes` и `find_big_family` утилиты keeper-client [#63862](https://github.com/ClickHouse/ClickHouse/pull/63862) ([Alexander Gololobov](https://github.com/davenger)).
* Обновлено имя выполняемой функции lambda [#63864](https://github.com/ClickHouse/ClickHouse/pull/63864) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка сегментации (SIGSEGV), вызванная профилировщиком CPU/Real [#63865](https://github.com/ClickHouse/ClickHouse/pull/63865) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен запрос `EXPLAIN CURRENT TRANSACTION` [#63926](https://github.com/ClickHouse/ClickHouse/pull/63926) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен анализатор: это черепахи до самого низа... [#63930](https://github.com/ClickHouse/ClickHouse/pull/63930) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Разрешено использование отдельных команд ALTER TABLE для диска `plain_rewritable` [#63933](https://github.com/ClickHouse/ClickHouse/pull/63933) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлена работа распределённого рекурсивного CTE [#63939](https://github.com/ClickHouse/ClickHouse/pull/63939) ([Maksim Kita](https://github.com/kitaisreal)).
* Analyzer: исправлено разрешение конструкции COLUMNS [#63962](https://github.com/ClickHouse/ClickHouse/pull/63962) ([Dmitry Novik](https://github.com/novikd)).
* LIMIT BY и skip&#95;unused&#95;shards в анализаторе [#63983](https://github.com/ClickHouse/ClickHouse/pull/63983) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправление некоторых ошибок (experimental Kusto) [#63992](https://github.com/ClickHouse/ClickHouse/pull/63992) ([Yong Wang](https://github.com/kashwy)).
* Более безопасная десериализация недоверенных двоичных данных [#64024](https://github.com/ClickHouse/ClickHouse/pull/64024) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлен анализ запросов с настройкой `final` = 1 для Distributed-таблиц над таблицами, не относящимися к семейству MergeTree. [#64037](https://github.com/ClickHouse/ClickHouse/pull/64037) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлены недостающие настройки для recoverLostReplica [#64040](https://github.com/ClickHouse/ClickHouse/pull/64040) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлены проверки прав доступа в SQL с помощью анализатора [#64079](https://github.com/ClickHouse/ClickHouse/pull/64079) ([pufit](https://github.com/pufit)).
* Исправлен анализатор: для DAG теперь используются только выражения интерполяции [#64096](https://github.com/ClickHouse/ClickHouse/pull/64096) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена работа резервного копирования в Azure, при которой формировались multipart-блоки размером 1 MiB (размер буфера чтения) вместо `max_upload_part_size` (в случае ненативного копирования) [#64117](https://github.com/ClickHouse/ClickHouse/pull/64117) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Корректный переход на запасной вариант при копировании резервной копии [#64153](https://github.com/ClickHouse/ClickHouse/pull/64153) ([Antonio Andelic](https://github.com/antonio2368)).
* Предотвращён LOGICAL&#95;ERROR при выполнении CREATE TABLE AS MATERIALIZED VIEW [#64174](https://github.com/ClickHouse/ClickHouse/pull/64174) ([Raúl Marín](https://github.com/Algunenano)).
* Кэш запросов: рассматривать идентичные запросы к разным базам данных как разные [#64199](https://github.com/ClickHouse/ClickHouse/pull/64199) ([Robert Schulze](https://github.com/rschu1ze)).
* Игнорирование `text_log` для Keeper [#64218](https://github.com/ClickHouse/ClickHouse/pull/64218) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена логическая ошибка: некорректное приведение типов для таблицы движка Buffer с PREWHERE. [#64388](https://github.com/ClickHouse/ClickHouse/pull/64388) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).



### <a id="244"></a> Релиз ClickHouse 24.4, 2024-04-30 {#a-id244a-clickhouse-release-244-2024-04-30}

#### Заметки по обновлению {#upgrade-notes}
* `clickhouse-odbc-bridge` и `clickhouse-library-bridge` теперь поставляются как отдельные пакеты. Это закрывает [#61677](https://github.com/ClickHouse/ClickHouse/issues/61677). [#62114](https://github.com/ClickHouse/ClickHouse/pull/62114) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Больше нельзя устанавливать max_parallel_replicas (для экспериментального параллельного чтения с реплик) в значение `0`, так как это не имеет смысла. Закрывает [#60140](https://github.com/ClickHouse/ClickHouse/issues/60140). [#61201](https://github.com/ClickHouse/ClickHouse/pull/61201) ([Kruglov Pavel](https://github.com/Avogar)).
* Удалена поддержка запроса `INSERT WATCH` (часть устаревшей функциональности `LIVE VIEW`). [#62382](https://github.com/ClickHouse/ClickHouse/pull/62382) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Удалена настройка `optimize_monotonous_functions_in_order_by`. [#63004](https://github.com/ClickHouse/ClickHouse/pull/63004) ([Raúl Marín](https://github.com/Algunenano)).
* С движка базы данных `Replicated` снят экспериментальный статус. Теперь он находится на стадии beta. [#62937](https://github.com/ClickHouse/ClickHouse/pull/62937) ([Justin de Guzman](https://github.com/justindeguzman)).



#### Новая функция {#new-feature-8}
* Поддержка рекурсивных CTE. [#62074](https://github.com/ClickHouse/ClickHouse/pull/62074) ([Maksim Kita](https://github.com/kitaisreal)).
* Поддержка предложения `QUALIFY`. Закрывает [#47819](https://github.com/ClickHouse/ClickHouse/issues/47819). [#62619](https://github.com/ClickHouse/ClickHouse/pull/62619) ([Maksim Kita](https://github.com/kitaisreal)).
* Движки таблиц теперь можно назначать через `GRANT`, и это не влияет на поведение существующих пользователей. [#60117](https://github.com/ClickHouse/ClickHouse/pull/60117) ([jsc0218](https://github.com/jsc0218)).
* Добавлен перезаписываемый диск S3, который поддерживает операции INSERT и не требует локально хранимых метаданных. [#61116](https://github.com/ClickHouse/ClickHouse/pull/61116) ([Julia Kartseva](https://github.com/jkartseva)). Основной сценарий использования — для системных таблиц.
* Подсветка синтаксиса при вводе в клиенте теперь будет работать на уровне синтаксического анализа (ранее она работала на уровне лексера). [#62123](https://github.com/ClickHouse/ClickHouse/pull/62123) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Поддерживается удаление нескольких таблиц одновременно, как в `DROP TABLE a, b, c`;. [#58705](https://github.com/ClickHouse/ClickHouse/pull/58705) ([zhongyuankai](https://github.com/zhongyuankai)).
* Теперь поддерживается изменение настроек таблиц с движком Memory через `ALTER MODIFY SETTING`. Пример: `ALTER TABLE memory MODIFY SETTING min_rows_to_keep = 100, max_rows_to_keep = 1000;`. [#62039](https://github.com/ClickHouse/ClickHouse/pull/62039) ([zhongyuankai](https://github.com/zhongyuankai)).
* Добавлен параметр запроса `role` в HTTP-интерфейс. Он работает аналогично `SET ROLE x`, применяя роль до выполнения оператора. Это позволяет обойти ограничение HTTP-интерфейса, при котором не допускается несколько операторов и, соответственно, нельзя отправить и `SET ROLE x`, и сам оператор одновременно. Можно задать несколько ролей таким образом, например, `?role=x&role=y`, что будет эквивалентно `SET ROLE x, y`. [#62669](https://github.com/ClickHouse/ClickHouse/pull/62669) ([Serge Klochkov](https://github.com/slvrtrn)).
* Добавлена команда `SYSTEM UNLOAD PRIMARY KEY` для освобождения памяти, занимаемой первичным ключом таблицы. [#62738](https://github.com/ClickHouse/ClickHouse/pull/62738) ([Pablo Marcos](https://github.com/pamarcos)).
* В `system.text_log` добавлены столбцы `value1`, `value2`, ..., `value10`. Эти столбцы содержат значения, которые были использованы для форматирования сообщения. [#59619](https://github.com/ClickHouse/ClickHouse/pull/59619) ([Alexey Katsman](https://github.com/alexkats)).
* Добавлен постоянный виртуальный столбец `_block_offset`, который хранит исходный номер строки в блоке, присвоенный при вставке. Сохранение столбца `_block_offset` на диске может быть включено настройкой MergeTree `enable_block_offset_column`. Добавлен виртуальный столбец `_part_data_version`, который содержит либо минимальный номер блока, либо версию мутации части. Постоянный виртуальный столбец `_block_number` больше не считается экспериментальным. [#60676](https://github.com/ClickHouse/ClickHouse/pull/60676) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена настройка `input_format_json_throw_on_bad_escape_sequence`; её отключение позволяет сохранять некорректные escape-последовательности во входных форматах JSON. [#61889](https://github.com/ClickHouse/ClickHouse/pull/61889) ([Kruglov Pavel](https://github.com/Avogar)).



#### Повышение производительности {#performance-improvement-8}

* Улучшения проталкивания фильтров в JOIN с использованием множеств эквивалентности. [#61216](https://github.com/ClickHouse/ClickHouse/pull/61216) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена оптимизация, которая преобразует OUTER JOIN в INNER JOIN, если фильтр после JOIN всегда отбрасывает значения по умолчанию. Оптимизацией можно управлять с помощью настройки `query_plan_convert_outer_join_to_inner_join`, которая включена по умолчанию. [#62907](https://github.com/ClickHouse/ClickHouse/pull/62907) ([Maksim Kita](https://github.com/kitaisreal)).
* Улучшение для AWS S3. Клиент должен отправлять заголовок &#39;Keep-Alive: timeout=X&#39; на сервер. Если клиент получает от сервера ответ с этим заголовком, он должен использовать значение, указанное сервером. Также клиенту предпочтительно не использовать соединение, срок жизни которого почти истёк, чтобы избежать гонки закрытия соединения. [#62249](https://github.com/ClickHouse/ClickHouse/pull/62249) ([Sema Checherinda](https://github.com/CheSema)).
* Сокращение накладных расходов мутаций для запросов SELECT (v2). [#60856](https://github.com/ClickHouse/ClickHouse/pull/60856) ([Azat Khuzhin](https://github.com/azat)).
* Наиболее часто вызываемые функции в PODArray теперь принудительно встраиваются (force-inlined). [#61144](https://github.com/ClickHouse/ClickHouse/pull/61144) ([李扬](https://github.com/taiyang-li)).
* Ускорен разбор JSON за счёт пропуска оставшейся части объекта после чтения всех необходимых столбцов. [#62210](https://github.com/ClickHouse/ClickHouse/pull/62210) ([lgbo](https://github.com/lgbo-ustc)).
* Улучшена обработка простых запросов INSERT SELECT из файлов в табличных функциях file/s3/hdfs/url/.... Добавлена отдельная настройка max&#95;parsing&#95;threads для управления количеством потоков, используемых при параллельном разборе. [#62404](https://github.com/ClickHouse/ClickHouse/pull/62404) ([Kruglov Pavel](https://github.com/Avogar)).
* Функции `to_utc_timestamp` и `from_utc_timestamp` теперь примерно в 2 раза быстрее. [#62583](https://github.com/ClickHouse/ClickHouse/pull/62583) ([KevinyhZou](https://github.com/KevinyhZou)).
* Функции `parseDateTimeOrNull`, `parseDateTimeOrZero`, `parseDateTimeInJodaSyntaxOrNull` и `parseDateTimeInJodaSyntaxOrZero` теперь работают значительно быстрее (в 10–1000 раз), когда входные данные преимущественно содержат значения, которые не удаётся разобрать. [#62634](https://github.com/ClickHouse/ClickHouse/pull/62634) ([LiuNeng](https://github.com/liuneng1994)).
* SELECT-запросы к `system.query_cache` теперь выполняются заметно быстрее, когда кэш запросов содержит большое количество записей (например, более 100 000). [#62671](https://github.com/ClickHouse/ClickHouse/pull/62671) ([Robert Schulze](https://github.com/rschu1ze)).
* Меньше конфликтов в файловом кэше (часть 3): выполнять удаление из файловой системы без блокировки при попытке зарезервировать место на диске. [#61163](https://github.com/ClickHouse/ClickHouse/pull/61163) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Ускорено динамическое изменение размера кэша файловой системы. [#61723](https://github.com/ClickHouse/ClickHouse/pull/61723) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Источник словаря с `INVALIDATE_QUERY` при запуске больше не перезагружается дважды. [#62050](https://github.com/ClickHouse/ClickHouse/pull/62050) ([vdimir](https://github.com/vdimir)).
* Исправлена ошибка, из-за которой при добавлении избыточного `= 1` или `= 0` после логического выражения с участием первичного ключа не использовался первичный индекс. Например, и `SELECT * FROM &lt;table&gt; WHERE &lt;primary-key&gt; IN (&lt;value&gt;) = 1`, и `SELECT * FROM &lt;table&gt; WHERE &lt;primary-key&gt; NOT IN (&lt;value&gt;) = 0` приводили к полному сканированию таблицы, хотя мог быть использован первичный индекс. [#62142](https://github.com/ClickHouse/ClickHouse/pull/62142) ([josh-hildred](https://github.com/josh-hildred)).
* Возвращать поток чанков из `system.remote_data_paths` вместо накопления всего результата в одном большом чанке. Это позволяет расходовать меньше памяти, отображать промежуточный прогресс и отменять запрос. [#62613](https://github.com/ClickHouse/ClickHouse/pull/62613) ([Alexander Gololobov](https://github.com/davenger)).



#### Экспериментальная функция {#experimental-feature-6}
* Добавлена поддержка параллельного буфера записи для Azure Blob Storage, управляемая настройкой `azure_allow_parallel_part_upload`. [#62534](https://github.com/ClickHouse/ClickHouse/pull/62534) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Кэш страниц в пространстве пользователя (userspace page cache) теперь работает со статическим веб-хранилищем (`disk(type = web)`). Для включения используйте клиентскую настройку `use_page_cache_for_disks_without_file_cache=1`. [#61911](https://github.com/ClickHouse/ClickHouse/pull/61911) ([Michael Kolupaev](https://github.com/al13n321)).
* Типы Bool и числовые варианты больше не считаются подозрительными в типе `Variant`. [#61999](https://github.com/ClickHouse/ClickHouse/pull/61999) ([Kruglov Pavel](https://github.com/Avogar)).
* Реализовано улучшенное преобразование из типа String в `Variant` с использованием парсинга. [#62005](https://github.com/ClickHouse/ClickHouse/pull/62005) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка `Variant` в функциях JSONExtract. [#62014](https://github.com/ClickHouse/ClickHouse/pull/62014) ([Kruglov Pavel](https://github.com/Avogar)).
* Тип `Variant` помечен как сравнимый, поэтому его можно использовать в первичном ключе. [#62693](https://github.com/ClickHouse/ClickHouse/pull/62693) ([Kruglov Pavel](https://github.com/Avogar)).



#### Улучшение {#improvement-8}

* Для удобства `SELECT * FROM numbers() `будет работать так же, как `SELECT * FROM system.numbers` — без лимита. [#61969](https://github.com/ClickHouse/ClickHouse/pull/61969) ([YenchangChan](https://github.com/YenchangChan)).
* Введены отдельные теги consumer/producer для конфигурации Kafka. Это позволяет избежать предупреждений от librdkafka (неудачной библиотеки на C с множеством ошибок) о том, что свойства consumer были указаны для экземпляров producer и наоборот (например, предупреждение `Configuration property session.timeout.ms is a consumer property and will be ignored by this producer instance`). Закрывает: [#58983](https://github.com/ClickHouse/ClickHouse/issues/58983). [#58956](https://github.com/ClickHouse/ClickHouse/pull/58956) ([Aleksandr Musorin](https://github.com/AVMusorin)).
* Функции `date_diff` и `age` теперь вычисляют результат с наносекундной точностью вместо микросекундной. Они также поддерживают значение `nanosecond` (или `nanoseconds`, или `ns`) в качестве значения параметра `unit`. [#61409](https://github.com/ClickHouse/ClickHouse/pull/61409) ([Austin Kothig](https://github.com/kothiga)).
* Добавлены единицы измерения нано-, микро- и миллисекунд для `date_trunc`. [#62335](https://github.com/ClickHouse/ClickHouse/pull/62335) ([Misz606](https://github.com/Misz606)).
* Перезагружать цепочку сертификатов вместе с сертификатом. [#61671](https://github.com/ClickHouse/ClickHouse/pull/61671) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* Попытка предотвратить ошибку [#60432](https://github.com/ClickHouse/ClickHouse/issues/60432) путём запрета присоединения таблицы, если уже существует активная реплика для данного пути реплики. [#61876](https://github.com/ClickHouse/ClickHouse/pull/61876) ([Arthur Passos](https://github.com/arthurpassos)).
* Реализована поддержка `input` для `clickhouse-local`. [#61923](https://github.com/ClickHouse/ClickHouse/pull/61923) ([Azat Khuzhin](https://github.com/azat)).
* Движок таблицы `Join` со строгостью `ANY` ведет себя детерминированно после перезагрузки. Когда вставляется несколько строк с одинаковым ключом, первая из них имеет более высокий приоритет (ранее строка выбиралась случайным образом при загрузке таблицы). Закрыта задача [#51027](https://github.com/ClickHouse/ClickHouse/issues/51027). [#61972](https://github.com/ClickHouse/ClickHouse/pull/61972) ([vdimir](https://github.com/vdimir)).
* Автоматически определять типы столбцов Nullable на основе схемы Apache Arrow. [#61984](https://github.com/ClickHouse/ClickHouse/pull/61984) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена возможность отмены параллельного слияния агрегатных состояний в процессе агрегации. Пример: `uniqExact`. [#61992](https://github.com/ClickHouse/ClickHouse/pull/61992) ([Maksim Kita](https://github.com/kitaisreal)).
* Используйте `system.keywords` для заполнения подсказок, а также для внутреннего использования повсеместно. [#62000](https://github.com/ClickHouse/ClickHouse/pull/62000) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* `OPTIMIZE FINAL` для `ReplicatedMergeTree` теперь будет ждать завершения текущих активных слияний, а затем повторно попытается запланировать финальное слияние. Тем самым его поведение станет ближе к поведению обычного `MergeTree`. [#62067](https://github.com/ClickHouse/ClickHouse/pull/62067) ([Nikita Taranov](https://github.com/nickitat)).
* При чтении данных из текстового файла Hive первая строка файла используется для переопределения количества входных полей, и иногда количество полей в первой строке не совпадает с определением таблицы Hive. Например, таблица Hive определена с 3 столбцами, как `test_tbl(a Int32, b Int32, c Int32)`, но первая строка текстового файла содержит только 2 поля. В этой ситуации количество входных полей будет изменено на 2, и если следующая строка текстового файла содержит 3 поля, третье поле не будет прочитано, а будет установлено в значение по умолчанию 0, что является некорректным поведением. [#62086](https://github.com/ClickHouse/ClickHouse/pull/62086) ([KevinyhZou](https://github.com/KevinyhZou)).
* Оператор `CREATE AS` теперь копирует комментарий таблицы. [#62117](https://github.com/ClickHouse/ClickHouse/pull/62117) ([Pablo Marcos](https://github.com/pamarcos)).
* Добавлен прогресс выполнения запросов в таблицу zookeeper. [#62152](https://github.com/ClickHouse/ClickHouse/pull/62152) ([JackyWoo](https://github.com/JackyWoo)).
* Добавлена возможность включать сборщик трассировок (Real и CPU) на уровне сервера. [#62189](https://github.com/ClickHouse/ClickHouse/pull/62189) ([alesapin](https://github.com/alesapin)).
* Добавлена настройка `lightweight_deletes_sync` (значение по умолчанию: 2 — синхронное ожидание всех реплик). Она похожа на настройку `mutations_sync`, но влияет только на поведение облегчённых удалений. [#62195](https://github.com/ClickHouse/ClickHouse/pull/62195) ([Anton Popov](https://github.com/CurtizJ)).
* Различать логические и целочисленные значения при разборе значений пользовательских настроек: `SET custom_a = true; SET custom_b = 1;`. [#62206](https://github.com/ClickHouse/ClickHouse/pull/62206) ([Vitaly Baranov](https://github.com/vitlibar)).
* Реализована поддержка доступа к S3 через интерфейсные конечные точки AWS PrivateLink. Закрывает [#60021](https://github.com/ClickHouse/ClickHouse/issues/60021), [#31074](https://github.com/ClickHouse/ClickHouse/issues/31074) и [#53761](https://github.com/ClickHouse/ClickHouse/issues/53761). [#62208](https://github.com/ClickHouse/ClickHouse/pull/62208) ([Arthur Passos](https://github.com/arthurpassos)).
* Не создавать в clickhouse-client каталог для UDF, если он не существует. Это закрывает [#59597](https://github.com/ClickHouse/ClickHouse/issues/59597). [#62366](https://github.com/ClickHouse/ClickHouse/pull/62366) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Теперь кэш запросов больше не кэширует результаты запросов к системным таблицам (`system.*`, `information_schema.*`, `INFORMATION_SCHEMA.*`). [#62376](https://github.com/ClickHouse/ClickHouse/pull/62376) ([Robert Schulze](https://github.com/rschu1ze)).
* Запрос `MOVE PARTITION TO TABLE` может быть отложен или завершиться исключением `TOO_MANY_PARTS`, чтобы не превысить ограничения на количество частей. Применяются те же настройки и лимиты, что и для запроса `INSERT` (см. настройки `max_parts_in_total`, `parts_to_delay_insert`, `parts_to_throw_insert`, `inactive_parts_to_throw_insert`, `inactive_parts_to_delay_insert`, `max_avg_part_size_for_too_many_parts`, `min_delay_to_insert_ms` и `max_delay_to_insert`). [#62420](https://github.com/ClickHouse/ClickHouse/pull/62420) ([Sergei Trifonov](https://github.com/serxa)).
* Каталог установки по умолчанию в macOS изменён с `/usr/bin` на `/usr/local/bin`. Это необходимо, потому что механизм System Integrity Protection от Apple, введённый в macOS El Capitan (2015), запрещает запись в `/usr/bin`, даже при использовании `sudo`. [#62489](https://github.com/ClickHouse/ClickHouse/pull/62489) ([haohang](https://github.com/yokofly)).
* Сделали так, что функция transform всегда возвращает первое совпадение. [#62518](https://github.com/ClickHouse/ClickHouse/pull/62518) ([Raúl Marín](https://github.com/Algunenano)).
* В системную таблицу `blob_storage_log` добавлен отсутствовавший столбец `hostname`. [#62456](https://github.com/ClickHouse/ClickHouse/pull/62456) ([Jayme Bird](https://github.com/jaymebrd)).
* Для единообразия с другими системными таблицами в `system.backup_log` теперь имеется столбец `event_time`. [#62541](https://github.com/ClickHouse/ClickHouse/pull/62541) ([Jayme Bird](https://github.com/jaymebrd)).
* Таблица `system.backup_log` теперь имеет ключ сортировки по умолчанию `event_date, event_time`, такой же, как у других таблиц движка `_log`. [#62667](https://github.com/ClickHouse/ClickHouse/pull/62667) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Избегайте вычисления выражений DEFAULT для столбцов таблицы при выполнении `RESTORE`. [#62601](https://github.com/ClickHouse/ClickHouse/pull/62601) ([Vitaly Baranov](https://github.com/vitlibar)).
* Хранилищу S3 и резервным копиям также нужны те же параметры keep-alive по умолчанию, что и для диска S3. [#62648](https://github.com/ClickHouse/ClickHouse/pull/62648) ([Sema Checherinda](https://github.com/CheSema)).
* Добавлен идентификатор клиента библиотеки librdkafka (той самой печально известной библиотеки на C с множеством багов) в сообщения журнала, чтобы можно было различать сообщения журнала от разных потребителей одной таблицы. [#62813](https://github.com/ClickHouse/ClickHouse/pull/62813) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Разрешено использование специальных макросов `{uuid}` и `{database}` в пути ZooKeeper реплицируемой базы данных. [#62818](https://github.com/ClickHouse/ClickHouse/pull/62818) ([Vitaly Baranov](https://github.com/vitlibar)).
* Разрешено использование ключа квоты с иной схемой аутентификации в HTTP‑запросах. [#62842](https://github.com/ClickHouse/ClickHouse/pull/62842) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Уменьшена детализация вывода справки для аргумента командной строки `--help` в `clickhouse client` и `clickhouse local`. Предыдущий вариант вывода теперь генерируется с помощью `--help --verbose`. [#62973](https://github.com/ClickHouse/ClickHouse/pull/62973) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* `log_bin_use_v1_row_events` был удалён в MySQL 8.3, и мы соответственно доработали экспериментальный движок `MaterializedMySQL` [#60479](https://github.com/ClickHouse/ClickHouse/issues/60479). [#63101](https://github.com/ClickHouse/ClickHouse/pull/63101) ([Eugene Klimov](https://github.com/Slach)). Автор: Nikolay Yankin.





#### Улучшение сборки/тестирования/упаковки {#buildtestingpackaging-improvement-4}

* Завендорить зависимости Rust, чтобы код на Rust (который мы используем для мелких фич ради хайпа и лулзов) можно было собирать нормальным образом, аналогично C++. [#62297](https://github.com/ClickHouse/ClickHouse/pull/62297) ([Raúl Marín](https://github.com/Algunenano)).
* ClickHouse теперь использует OpenSSL 3.2 вместо BoringSSL. [#59870](https://github.com/ClickHouse/ClickHouse/pull/59870) ([Robert Schulze](https://github.com/rschu1ze)). Обратите внимание, что у OpenSSL в целом хуже инженерные практики (например, ненулевое количество отчётов от инструментов sanitizer, которые нам пришлось исправлять, сложная система сборки с генерируемыми файлами и т. д.), но при этом обеспечивается лучшая совместимость.
* Игнорировать запросы DROP во время стресс‑теста с вероятностью 1/2, использовать TRUNCATE вместо игнорирования DROP при проверке обновления для таблиц Memory/JOIN. [#61476](https://github.com/ClickHouse/ClickHouse/pull/61476) ([Kruglov Pavel](https://github.com/Avogar)).
* Удалены тома `/etc/clickhouse-keeper` и `/var/log/clickhouse-keeper` из Docker-образа Keeper. [#61683](https://github.com/ClickHouse/ClickHouse/pull/61683) ([Tristan](https://github.com/Tristan971)).
* Добавлены тесты для всех задач, которые больше не актуальны при включении анализатора по умолчанию. Закрывает: [#55794](https://github.com/ClickHouse/ClickHouse/issues/55794) Закрывает: [#49472](https://github.com/ClickHouse/ClickHouse/issues/49472) Закрывает: [#44414](https://github.com/ClickHouse/ClickHouse/issues/44414) Закрывает: [#13843](https://github.com/ClickHouse/ClickHouse/issues/13843) Закрывает: [#55803](https://github.com/ClickHouse/ClickHouse/issues/55803) Закрывает: [#48308](https://github.com/ClickHouse/ClickHouse/issues/48308) Закрывает: [#45535](https://github.com/ClickHouse/ClickHouse/issues/45535) Закрывает: [#44365](https://github.com/ClickHouse/ClickHouse/issues/44365) Закрывает: [#44153](https://github.com/ClickHouse/ClickHouse/issues/44153) Закрывает: [#42399](https://github.com/ClickHouse/ClickHouse/issues/42399) Закрывает: [#27115](https://github.com/ClickHouse/ClickHouse/issues/27115) Закрывает: [#23162](https://github.com/ClickHouse/ClickHouse/issues/23162) Закрывает: [#15395](https://github.com/ClickHouse/ClickHouse/issues/15395) Закрывает: [#15411](https://github.com/ClickHouse/ClickHouse/issues/15411) Закрывает: [#14978](https://github.com/ClickHouse/ClickHouse/issues/14978) Закрывает: [#17319](https://github.com/ClickHouse/ClickHouse/issues/17319) Закрывает: [#11813](https://github.com/ClickHouse/ClickHouse/issues/11813) Закрывает: [#13210](https://github.com/ClickHouse/ClickHouse/issues/13210) Закрывает: [#23053](https://github.com/ClickHouse/ClickHouse/issues/23053) Закрывает: [#37729](https://github.com/ClickHouse/ClickHouse/issues/37729) Закрывает: [#32639](https://github.com/ClickHouse/ClickHouse/issues/32639) Закрывает: [#9954](https://github.com/ClickHouse/ClickHouse/issues/9954) Закрывает: [#41964](https://github.com/ClickHouse/ClickHouse/issues/41964) Закрывает: [#54317](https://github.com/ClickHouse/ClickHouse/issues/54317) Закрывает: [#7520](https://github.com/ClickHouse/ClickHouse/issues/7520) Закрывает: [#36973](https://github.com/ClickHouse/ClickHouse/issues/36973) Закрывает: [#40955](https://github.com/ClickHouse/ClickHouse/issues/40955) Закрывает: [#19687](https://github.com/ClickHouse/ClickHouse/issues/19687) Закрывает: [#23104](https://github.com/ClickHouse/ClickHouse/issues/23104) Закрывает: [#21584](https://github.com/ClickHouse/ClickHouse/issues/21584) Закрывает: [#23344](https://github.com/ClickHouse/ClickHouse/issues/23344) Закрывает: [#22627](https://github.com/ClickHouse/ClickHouse/issues/22627) Закрывает: [#10276](https://github.com/ClickHouse/ClickHouse/issues/10276) Закрывает: [#19687](https://github.com/ClickHouse/ClickHouse/issues/19687) Закрывает: [#4567](https://github.com/ClickHouse/ClickHouse/issues/4567) Закрывает: [#17710](https://github.com/ClickHouse/ClickHouse/issues/17710) Закрывает: [#11068](https://github.com/ClickHouse/ClickHouse/issues/11068) Закрывает: [#24395](https://github.com/ClickHouse/ClickHouse/issues/24395) Закрывает: [#23416](https://github.com/ClickHouse/ClickHouse/issues/23416) Закрывает: [#23162](https://github.com/ClickHouse/ClickHouse/issues/23162) Закрывает: [#25655](https://github.com/ClickHouse/ClickHouse/issues/25655) Закрывает: [#11757](https://github.com/ClickHouse/ClickHouse/issues/11757) Закрывает: [#6571](https://github.com/ClickHouse/ClickHouse/issues/6571) Закрывает: [#4432](https://github.com/ClickHouse/ClickHouse/issues/4432) Закрывает: [#8259](https://github.com/ClickHouse/ClickHouse/issues/8259) Закрывает: [#9233](https://github.com/ClickHouse/ClickHouse/issues/9233) Закрывает: [#14699](https://github.com/ClickHouse/ClickHouse/issues/14699) Закрывает: [#27068](https://github.com/ClickHouse/ClickHouse/issues/27068) Закрывает: [#28687](https://github.com/ClickHouse/ClickHouse/issues/28687) Закрывает: [#28777](https://github.com/ClickHouse/ClickHouse/issues/28777) Закрывает: [#29734](https://github.com/ClickHouse/ClickHouse/issues/29734) Закрывает: [#61238](https://github.com/ClickHouse/ClickHouse/issues/61238) Закрывает: [#33825](https://github.com/ClickHouse/ClickHouse/issues/33825) Закрывает: [#35608](https://github.com/ClickHouse/ClickHouse/issues/35608) Закрывает: [#29838](https://github.com/ClickHouse/ClickHouse/issues/29838) Закрывает: [#35652](https://github.com/ClickHouse/ClickHouse/issues/35652) Закрывает: [#36189](https://github.com/ClickHouse/ClickHouse/issues/36189) Закрывает: [#39634](https://github.com/ClickHouse/ClickHouse/issues/39634) Закрывает: [#47432](https://github.com/ClickHouse/ClickHouse/issues/47432) Закрывает: [#54910](https://github.com/ClickHouse/ClickHouse/issues/54910) Закрывает: [#57321](https://github.com/ClickHouse/ClickHouse/issues/57321) Закрывает: [#59154](https://github.com/ClickHouse/ClickHouse/issues/59154) Закрывает: [#61014](https://github.com/ClickHouse/ClickHouse/issues/61014) Закрывает: [#61950](https://github.com/ClickHouse/ClickHouse/issues/61950) Закрывает: [#55647](https://github.com/ClickHouse/ClickHouse/issues/55647) Закрывает: [#61947](https://github.com/ClickHouse/ClickHouse/issues/61947). [#62185](https://github.com/ClickHouse/ClickHouse/pull/62185) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлены дополнительные тесты из задач, которые больше не актуальны или уже исправлены анализатором. Закрывает: [#58985](https://github.com/ClickHouse/ClickHouse/issues/58985) Закрывает: [#59549](https://github.com/ClickHouse/ClickHouse/issues/59549) Закрывает: [#36963](https://github.com/ClickHouse/ClickHouse/issues/36963) Закрывает: [#39453](https://github.com/ClickHouse/ClickHouse/issues/39453) Закрывает: [#56521](https://github.com/ClickHouse/ClickHouse/issues/56521) Закрывает: [#47552](https://github.com/ClickHouse/ClickHouse/issues/47552) Закрывает: [#56503](https://github.com/ClickHouse/ClickHouse/issues/56503) Закрывает: [#59101](https://github.com/ClickHouse/ClickHouse/issues/59101) Закрывает: [#50271](https://github.com/ClickHouse/ClickHouse/issues/50271) Закрывает: [#54954](https://github.com/ClickHouse/ClickHouse/issues/54954) Закрывает: [#56466](https://github.com/ClickHouse/ClickHouse/issues/56466) Закрывает: [#11000](https://github.com/ClickHouse/ClickHouse/issues/11000) Закрывает: [#10894](https://github.com/ClickHouse/ClickHouse/issues/10894) Закрывает: [https://github.com/ClickHouse/ClickHouse/issues/448](https://github.com/ClickHouse/ClickHouse/issues/448) Закрывает: [#8030](https://github.com/ClickHouse/ClickHouse/issues/8030) Закрывает: [#32139](https://github.com/ClickHouse/ClickHouse/issues/32139) Закрывает: [#47288](https://github.com/ClickHouse/ClickHouse/issues/47288) Закрывает: [#50705](https://github.com/ClickHouse/ClickHouse/issues/50705) Закрывает: [#54511](https://github.com/ClickHouse/ClickHouse/issues/54511) Закрывает: [#55466](https://github.com/ClickHouse/ClickHouse/issues/55466) Закрывает: [#58500](https://github.com/ClickHouse/ClickHouse/issues/58500) Закрывает: [#39923](https://github.com/ClickHouse/ClickHouse/issues/39923) Закрывает: [#39855](https://github.com/ClickHouse/ClickHouse/issues/39855) Закрывает: [#4596](https://github.com/ClickHouse/ClickHouse/issues/4596) Закрывает: [#47422](https://github.com/ClickHouse/ClickHouse/issues/47422) Закрывает: [#33000](https://github.com/ClickHouse/ClickHouse/issues/33000) Закрывает: [#14739](https://github.com/ClickHouse/ClickHouse/issues/14739) Закрывает: [#44039](https://github.com/ClickHouse/ClickHouse/issues/44039) Закрывает: [#8547](https://github.com/ClickHouse/ClickHouse/issues/8547) Закрывает: [#22923](https://github.com/ClickHouse/ClickHouse/issues/22923) Закрывает: [#23865](https://github.com/ClickHouse/ClickHouse/issues/23865) Закрывает: [#29748](https://github.com/ClickHouse/ClickHouse/issues/29748) Закрывает: [#4222](https://github.com/ClickHouse/ClickHouse/issues/4222). [#62457](https://github.com/ClickHouse/ClickHouse/pull/62457) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлены ошибки сборки при динамическом связывании с OpenSSL (примечание: это, как правило, не поддерживается и требуется только для платформ IBM s390x). [#62888](https://github.com/ClickHouse/ClickHouse/pull/62888) ([Harry Lee](https://github.com/HarryLeeIBM)).





#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-6}

* Исправлена логическая ошибка при откате транзакции кворумной вставки. [#61953](https://github.com/ClickHouse/ClickHouse/pull/61953) ([Han Fei](https://github.com/hanfei1991)).
* Исправлена ошибка парсера при использовании COUNT(*) с клаузой FILTER [#61357](https://github.com/ClickHouse/ClickHouse/pull/61357) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлена логическая ошибка в `group_by_use_nulls` + grouping sets + analyzer + materialize/constant [#61567](https://github.com/ClickHouse/ClickHouse/pull/61567) ([Kruglov Pavel](https://github.com/Avogar)).
* Отменять слияния перед удалением перемещённых частей [#61610](https://github.com/ClickHouse/ClickHouse/pull/61610) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлен аварийный сбой в Apache Arrow [#61720](https://github.com/ClickHouse/ClickHouse/pull/61720) ([Kruglov Pavel](https://github.com/Avogar)).
* Ищите флаг `convert_to_replicated` по корректному пути, соответствующему конкретному диску [#61769](https://github.com/ClickHouse/ClickHouse/pull/61769) ([Kirill](https://github.com/kirillgarbar)).
* Исправлена возможная гонка данных в соединениях для distributed&#95;foreground&#95;insert/distributed&#95;background&#95;insert&#95;batch [#61867](https://github.com/ClickHouse/ClickHouse/pull/61867) ([Azat Khuzhin](https://github.com/azat)).
* Пометить ошибку CANNOT&#95;PARSE&#95;ESCAPE&#95;SEQUENCE как ошибку разбора, чтобы её можно было пропускать в форматах построчного ввода [#61883](https://github.com/ClickHouse/ClickHouse/pull/61883) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена запись сообщения об исключении в HTTP-формате вывода при использовании http&#95;wait&#95;end&#95;of&#95;query [#61951](https://github.com/ClickHouse/ClickHouse/pull/61951) ([Kruglov Pavel](https://github.com/Avogar)).
* Корректное исправление работы LowCardinality совместно с функциями JSONExtract [#61957](https://github.com/ClickHouse/ClickHouse/pull/61957) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Сбой в движке Merge, если политика строк не содержит выражения [#61971](https://github.com/ClickHouse/ClickHouse/pull/61971) ([Ilya Golshtein](https://github.com/ilejn)).
* Исправлено неперехваченное исключение в деструкторе WriteBufferAzureBlobStorage [#61988](https://github.com/ClickHouse/ClickHouse/pull/61988) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлена работа CREATE TABLE без определения столбцов для ReplicatedMergeTree [#62040](https://github.com/ClickHouse/ClickHouse/pull/62040) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа optimize&#95;skip&#95;unused&#95;shards&#95;rewrite&#95;in для составного ключа шардинга [#62047](https://github.com/ClickHouse/ClickHouse/pull/62047) ([Azat Khuzhin](https://github.com/azat)).
* ReadWriteBufferFromHTTP теперь устанавливает корректный заголовок Host при перенаправлениях [#62068](https://github.com/ClickHouse/ClickHouse/pull/62068) ([Sema Checherinda](https://github.com/CheSema)).
* Исправлена ошибка, из-за которой внешней таблице не удавалось разобрать тип данных Bool [#62115](https://github.com/ClickHouse/ClickHouse/pull/62115) ([Duc Canh Le](https://github.com/canhld94)).
* Analyzer: Исправлено разрешение параметров запроса [#62186](https://github.com/ClickHouse/ClickHouse/pull/62186) ([Dmitry Novik](https://github.com/novikd)).
* Исправлено восстановление частей в режиме только для чтения [#62207](https://github.com/ClickHouse/ClickHouse/pull/62207) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен сбой при определении индекса, содержащего SQL UDF [#62225](https://github.com/ClickHouse/ClickHouse/pull/62225) ([vdimir](https://github.com/vdimir)).
* Исправлено использование seed со значением NULL в generateRandom при работе с analyzer. [#62248](https://github.com/ClickHouse/ClickHouse/pull/62248) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Корректная обработка константных столбцов в Distinct Transform [#62250](https://github.com/ClickHouse/ClickHouse/pull/62250) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлен Parts Splitter для запросов с модификатором FINAL [#62268](https://github.com/ClickHouse/ClickHouse/pull/62268) ([Nikita Taranov](https://github.com/nickitat)).
* Analyzer: Исправлено разрешение алиаса на параметризованное представление [#62274](https://github.com/ClickHouse/ClickHouse/pull/62274) ([Dmitry Novik](https://github.com/novikd)).
* Analyzer: исправлено разрешение имен из родительских областей видимости [#62281](https://github.com/ClickHouse/ClickHouse/pull/62281) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена работа argMax с nullable-столбцом числового ненативного типа [#62285](https://github.com/ClickHouse/ClickHouse/pull/62285) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена работа BACKUP и RESTORE для материализованного представления в базе данных типа Ordinary [#62295](https://github.com/ClickHouse/ClickHouse/pull/62295) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена гонка данных на скалярах в Context [#62305](https://github.com/ClickHouse/ClickHouse/pull/62305) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен первичный ключ в материализованном представлении [#62319](https://github.com/ClickHouse/ClickHouse/pull/62319) ([Murat Khairulin](https://github.com/mxwell)).
* Не создавать многопоточный конвейер вставки для таблиц, которые его не поддерживают [#62333](https://github.com/ClickHouse/ClickHouse/pull/62333) ([vdimir](https://github.com/vdimir)).
* Исправлена работа анализатора с позиционными аргументами в распределённом запросе [#62362](https://github.com/ClickHouse/ClickHouse/pull/62362) ([flynn](https://github.com/ucasfl)).
* Исправлено проталкивание фильтров из additional&#95;table&#95;filters в движке Merge в анализаторе [#62398](https://github.com/ClickHouse/ClickHouse/pull/62398) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена обработка запросов GLOBAL IN к таблицам в анализаторе. [#62409](https://github.com/ClickHouse/ClickHouse/pull/62409) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Учитывать настройки truncate&#95;on&#95;insert/create&#95;new&#95;file&#95;on&#95;insert в движках s3/hdfs/azure при записи по партициям [#62425](https://github.com/ClickHouse/ClickHouse/pull/62425) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен путь восстановления из резервной копии для AzureBlobStorage [#62447](https://github.com/ClickHouse/ClickHouse/pull/62447) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлен трансформ SimpleSquashingChunksTransform [#62451](https://github.com/ClickHouse/ClickHouse/pull/62451) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлен захват вложенной лямбда-функции. [#62462](https://github.com/ClickHouse/ClickHouse/pull/62462) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Предотвращён сбой при чтении protobuf с рекурсивными типами [#62506](https://github.com/ClickHouse/ClickHouse/pull/62506) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена ошибка при попытке переместить один раздел сам в себя [#62524](https://github.com/ClickHouse/ClickHouse/pull/62524) ([helifu](https://github.com/helifu)).
* Исправлен скалярный подзапрос в операторе LIMIT [#62567](https://github.com/ClickHouse/ClickHouse/pull/62567) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка сегментации (segfault) в экспериментальном и неподдерживаемом движке Hive, который нам всё равно не нравится [#62578](https://github.com/ClickHouse/ClickHouse/pull/62578) ([Nikolay Degterinsky](https://github.com/evillique)).
* Устранена утечка памяти в groupArraySorted [#62597](https://github.com/ClickHouse/ClickHouse/pull/62597) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено падение в largestTriangleThreeBuckets [#62646](https://github.com/ClickHouse/ClickHouse/pull/62646) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлены tumble[Start,End] и hop[Start,End] для более крупных разрешений [#62705](https://github.com/ClickHouse/ClickHouse/pull/62705) ([Jordi Villar](https://github.com/jrdi)).
* Исправлено состояние комбинаторов argMin/argMax [#62708](https://github.com/ClickHouse/ClickHouse/pull/62708) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлен сбой работы с временными данными в кэше, вызванный оптимизацией конкуренции за блокировки кэша [#62715](https://github.com/ClickHouse/ClickHouse/pull/62715) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено падение в функции `mergeTreeIndex` [#62762](https://github.com/ClickHouse/ClickHouse/pull/62762) ([Anton Popov](https://github.com/CurtizJ)).
* fix: update: вложенные материализованные столбцы: исправления проверки размера [#62773](https://github.com/ClickHouse/ClickHouse/pull/62773) ([Eliot Hautefeuille](https://github.com/hileef)).
* Исправлена проблема, из-за которой модификатор FINAL не учитывался в CTE при использовании анализатора [#62811](https://github.com/ClickHouse/ClickHouse/pull/62811) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлено аварийное завершение работы функции `formatRow` при использовании формата `JSON` и HTTP‑интерфейса [#62840](https://github.com/ClickHouse/ClickHouse/pull/62840) ([Anton Popov](https://github.com/CurtizJ)).
* Azure: исправлено построение конечного URL из объекта endpoint [#62850](https://github.com/ClickHouse/ClickHouse/pull/62850) ([Daniel Pozo Escalona](https://github.com/danipozo)).
* Исправлен кодек GCD [#62853](https://github.com/ClickHouse/ClickHouse/pull/62853) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлен ключ типа LowCardinality(Nullable) в гиперпрямоугольнике [#62866](https://github.com/ClickHouse/ClickHouse/pull/62866) ([Amos Bird](https://github.com/amosbird)).
* Исправлена работа `fromUnixtimestamp` в синтаксисе Joda при входном значении, выходящем за пределы диапазона UInt32 [#62901](https://github.com/ClickHouse/ClickHouse/pull/62901) ([KevinyhZou](https://github.com/KevinyhZou)).
* Отключена настройка optimize&#95;rewrite&#95;aggregate&#95;function&#95;with&#95;if для sum(nullable) [#62912](https://github.com/ClickHouse/ClickHouse/pull/62912) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена обработка PREWHERE для StorageBuffer при разных типах столбцов в исходной таблице. [#62916](https://github.com/ClickHouse/ClickHouse/pull/62916) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена некорректная обработка временных данных в кэше при ошибке создания директории ключей кэша [#62925](https://github.com/ClickHouse/ClickHouse/pull/62925) ([Kseniia Sumarokova](https://github.com/kssenii)).
* gRPC: исправлено падение при подключении пира по IPv6 [#62978](https://github.com/ClickHouse/ClickHouse/pull/62978) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлена возможная ошибка CHECKSUM&#95;DOESNT&#95;MATCH (и другие) при выполнении реплицированных выборок [#62987](https://github.com/ClickHouse/ClickHouse/pull/62987) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено аварийное завершение процесса из‑за неперехваченного исключения во временных данных кэша [#62998](https://github.com/ClickHouse/ClickHouse/pull/62998) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проблема с неявным приведением типов в optimize&#95;rewrite&#95;aggregate&#95;function&#95;with&#95;if [#62999](https://github.com/ClickHouse/ClickHouse/pull/62999) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено необработанное исключение в ~RestorerFromBackup [#63040](https://github.com/ClickHouse/ClickHouse/pull/63040) ([Vitaly Baranov](https://github.com/vitlibar)).
* Не удалять серверные константы из ключа GROUP BY для вторичного запроса. [#63047](https://github.com/ClickHouse/ClickHouse/pull/63047) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена неверная оценка монотонности функции abs [#63097](https://github.com/ClickHouse/ClickHouse/pull/63097) ([Duc Canh Le](https://github.com/canhld94)).
* Установлено имя сервера для SSL-рукопожатия в движке MongoDB [#63122](https://github.com/ClickHouse/ClickHouse/pull/63122) ([Alexander Gololobov](https://github.com/davenger)).
* Использовать указанную пользователем базу данных вместо &quot;config&quot; для проверки версии wire-протокола MongoDB [#63126](https://github.com/ClickHouse/ClickHouse/pull/63126) ([Alexander Gololobov](https://github.com/davenger)).



### <a id="243"></a> Релиз ClickHouse 24.3 LTS от 2024-03-27 {#a-id243a-clickhouse-release-243-lts-2024-03-27}



#### Примечания по обновлению {#upgrade-notes-1}

* Настройка `allow_experimental_analyzer` включена по умолчанию и переключает анализ запросов на новую реализацию, которая обеспечивает лучшую совместимость и более полный набор возможностей. Функция &quot;analyzer&quot; считается бета-версией, а не экспериментальной. Вы можете вернуть старое поведение, установив параметр `compatibility` в значение `24.2` или отключив настройку `allow_experimental_analyzer`. Посмотрите [видео на YouTube](https://www.youtube.com/watch?v=zhrOYQpgvkk).
* ClickHouse допускает произвольные бинарные данные в типе данных String, который обычно содержит UTF-8. Типы String в форматах Parquet/ORC/Arrow поддерживают только UTF-8. Поэтому вы можете выбрать, какой тип данных Arrow использовать для типа данных ClickHouse String — String или Binary. Это контролируется настройками `output_format_parquet_string_as_string`, `output_format_orc_string_as_string`, `output_format_arrow_string_as_string`. Хотя Binary был бы более корректным и совместимым вариантом, использование String по умолчанию в большинстве случаев соответствует ожиданиям пользователей. Parquet/ORC/Arrow поддерживают множество методов сжатия, включая lz4 и zstd. ClickHouse поддерживает все эти методы сжатия. Некоторые менее продвинутые инструменты не поддерживают более быстрый метод сжатия `lz4`, поэтому по умолчанию мы используем `zstd`. Это контролируется настройками `output_format_parquet_compression_method`, `output_format_orc_compression_method` и `output_format_arrow_compression_method`. Мы изменили значение по умолчанию на `zstd` для Parquet и ORC, но не для Arrow (он предназначен для низкоуровневых сценариев использования). [#61817](https://github.com/ClickHouse/ClickHouse/pull/61817) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* В новой версии ClickHouse функции `geoDistance`, `greatCircleDistance` и `greatCircleAngle` будут использовать 64-битный тип данных с плавающей запятой двойной точности для внутренних вычислений и в качестве типа возвращаемого значения, если все аргументы имеют тип Float64. Это закрывает [#58476](https://github.com/ClickHouse/ClickHouse/issues/58476). В предыдущих версиях функция всегда использовала Float32. Вы можете переключиться на старое поведение, установив параметр `geo_distance_returns_float64_on_float64_arguments` в значение `false` или параметр `compatibility` в значение `24.2` или более раннее. [#61848](https://github.com/ClickHouse/ClickHouse/pull/61848) ([Alexey Milovidov](https://github.com/alexey-milovidov)). Соавтор — [Geet Patel](https://github.com/geetptl).
* Части данных в оперативной памяти были объявлены устаревшими начиная с версии 23.5 и перестали поддерживаться, начиная с версии 23.10. Теперь оставшийся код удалён. Продолжение [#55186](https://github.com/ClickHouse/ClickHouse/issues/55186) и [#45409](https://github.com/ClickHouse/ClickHouse/issues/45409). Маловероятно, что вы использовали части данных в оперативной памяти, поскольку они были доступны только до версии 23.5 и только при их ручном включении через указание соответствующих SETTINGS для таблицы MergeTree. Чтобы проверить, есть ли у вас части данных в оперативной памяти, выполните следующий запрос: `SELECT part_type, count() FROM system.parts GROUP BY part_type ORDER BY part_type`. Чтобы отключить использование частей данных в оперативной памяти, выполните `ALTER TABLE ... MODIFY SETTING min_bytes_for_compact_part = DEFAULT, min_rows_for_compact_part = DEFAULT`. Перед обновлением со старых релизов ClickHouse сначала убедитесь, что у вас нет частей данных в оперативной памяти. Если они есть, сначала отключите их, затем дождитесь, пока части данных в оперативной памяти исчезнут, и продолжайте обновление. [#61127](https://github.com/ClickHouse/ClickHouse/pull/61127) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Изменено имя столбца с `duration_ms` на `duration_microseconds` в таблице `system.zookeeper`, чтобы отразить тот факт, что длительность измеряется с микросекундным разрешением. [#60774](https://github.com/ClickHouse/ClickHouse/pull/60774) ([Duc Canh Le](https://github.com/canhld94)).
* Отклонять входящие запросы INSERT, если параметры уровня запроса `async_insert` и `deduplicate_blocks_in_dependent_materialized_views` одновременно включены. Это поведение управляется настройкой `throw_if_deduplication_in_dependent_materialized_views_enabled_with_async_insert`, которая по умолчанию включена. Это продолжение [https://github.com/ClickHouse/ClickHouse/pull/59699](https://github.com/ClickHouse/ClickHouse/pull/59699), необходимое для разблокировки [https://github.com/ClickHouse/ClickHouse/pull/59915](https://github.com/ClickHouse/ClickHouse/pull/59915). [#60888](https://github.com/ClickHouse/ClickHouse/pull/60888) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Утилита `clickhouse-copier` перенесена в отдельный репозиторий на GitHub: [https://github.com/ClickHouse/copier](https://github.com/ClickHouse/copier). Она больше не входит в основной дистрибутив, но по-прежнему доступна для отдельной загрузки. Закрывает: [#60734](https://github.com/ClickHouse/ClickHouse/issues/60734) Закрывает: [#60540](https://github.com/ClickHouse/ClickHouse/issues/60540) Закрывает: [#60250](https://github.com/ClickHouse/ClickHouse/issues/60250) Закрывает: [#52917](https://github.com/ClickHouse/ClickHouse/issues/52917) Закрывает: [#51140](https://github.com/ClickHouse/ClickHouse/issues/51140) Закрывает: [#47517](https://github.com/ClickHouse/ClickHouse/issues/47517) Закрывает: [#47189](https://github.com/ClickHouse/ClickHouse/issues/47189) Закрывает: [#46598](https://github.com/ClickHouse/ClickHouse/issues/46598) Закрывает: [#40257](https://github.com/ClickHouse/ClickHouse/issues/40257) Закрывает: [#36504](https://github.com/ClickHouse/ClickHouse/issues/36504) Закрывает: [#35485](https://github.com/ClickHouse/ClickHouse/issues/35485) Закрывает: [#33702](https://github.com/ClickHouse/ClickHouse/issues/33702) Закрывает: [#26702](https://github.com/ClickHouse/ClickHouse/issues/26702).
* Для повышения совместимости с MySQL совместимый псевдоним `locate` теперь по умолчанию принимает аргументы `(needle, haystack[, start_pos])`. Предыдущее поведение `(haystack, needle[, start_pos])` можно восстановить, задав `function_locate_has_mysql_compatible_argument_order = 0`. [#61092](https://github.com/ClickHouse/ClickHouse/pull/61092) ([Robert Schulze](https://github.com/rschu1ze)).
* По умолчанию запретить использование `SimpleAggregateFunction` в `ORDER BY` таблиц `MergeTree` (аналогично уже запрещённому `AggregateFunction`; запрет связан с тем, что такие функции не являются сравнимыми). Для разрешения их использования применяйте `allow_suspicious_primary_key`. [#61399](https://github.com/ClickHouse/ClickHouse/pull/61399) ([Azat Khuzhin](https://github.com/azat)).
* Движок базы данных `Ordinary` объявлен устаревшим. Вы получите предупреждение в clickhouse-client, если ваш сервер его использует. Это закрывает [#52229](https://github.com/ClickHouse/ClickHouse/issues/52229). [#56942](https://github.com/ClickHouse/ClickHouse/pull/56942) ([shabroo](https://github.com/shabroo)).



#### Новые возможности {#new-feature-9}
* Поддержка чтения и записи резервных копий в формате `tar` (в дополнение к `zip`). [#59535](https://github.com/ClickHouse/ClickHouse/pull/59535) ([josh-hildred](https://github.com/josh-hildred)).
* Реализована поддержка бакетов S3 Express. [#59965](https://github.com/ClickHouse/ClickHouse/pull/59965) ([Nikita Taranov](https://github.com/nickitat)).
* Разрешено присоединять парты с другого диска (используя копирование вместо жёсткой ссылки). [#60112](https://github.com/ClickHouse/ClickHouse/pull/60112) ([Unalian](https://github.com/Unalian)).
* Таблицы `Memory` с ограничением по размеру: управляются настройками `min_bytes_to_keep, max_bytes_to_keep, min_rows_to_keep` и `max_rows_to_keep`. [#60612](https://github.com/ClickHouse/ClickHouse/pull/60612) ([Jake Bamrah](https://github.com/JakeBamrah)).
* Раздельные лимиты на количество ожидающих и выполняющихся запросов. Добавлена новая серверная настройка `max_waiting_queries`, которая ограничивает число запросов, ожидающих из‑за `async_load_databases`. Существующие лимиты на количество выполняющихся запросов больше не учитывают ожидающие запросы. [#61053](https://github.com/ClickHouse/ClickHouse/pull/61053) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена таблица `system.keywords`, которая содержит все ключевые слова парсера. В основном нужна и будет использоваться для улучшенного фаззинга и подсветки синтаксиса. [#51808](https://github.com/ClickHouse/ClickHouse/pull/51808) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлена поддержка `ATTACH PARTITION ALL`. [#61107](https://github.com/ClickHouse/ClickHouse/pull/61107) ([Kirill Nikiforov](https://github.com/allmazz)).
* Добавлена новая функция `getClientHTTPHeader`. Это закрывает задачу [#54665](https://github.com/ClickHouse/ClickHouse/issues/54665). Соавтор — @lingtaolf. [#61820](https://github.com/ClickHouse/ClickHouse/pull/61820) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена `generate_series` как табличная функция (алиас совместимости с PostgreSQL для существующей функции `numbers`). Эта функция генерирует таблицу с арифметической прогрессией из натуральных чисел. [#59390](https://github.com/ClickHouse/ClickHouse/pull/59390) ([divanik](https://github.com/divanik)).
* Добавлен режим для `topK`/`topkWeighed`, который возвращает количество значений и их погрешность. [#54508](https://github.com/ClickHouse/ClickHouse/pull/54508) ([UnamedRus](https://github.com/UnamedRus)).
* Добавлена функция `toMillisecond`, которая возвращает значение миллисекунд для значений типа `DateTime` или `DateTime64`. [#60281](https://github.com/ClickHouse/ClickHouse/pull/60281) ([Shaun Struwig](https://github.com/Blargian)).
* Добавлена возможность настраивать обработчики HTTP‑редиректов для clickhouse-server. Например, можно сделать так, чтобы `/` перенаправлял в Play UI. [#60390](https://github.com/ClickHouse/ClickHouse/pull/60390) ([Alexey Milovidov](https://github.com/alexey-milovidov)).



#### Повышение производительности {#performance-improvement-9}

* Оптимизирована функция `dotProduct`, чтобы избежать ненужных и дорогостоящих операций копирования памяти. [#60928](https://github.com/ClickHouse/ClickHouse/pull/60928) ([Robert Schulze](https://github.com/rschu1ze)).
* Вывод 256-битных целых чисел стал в 30 раз быстрее. [#61100](https://github.com/ClickHouse/ClickHouse/pull/61100) ([Raúl Marín](https://github.com/Algunenano)).
* Если первичный ключ таблицы содержит преимущественно бесполезные столбцы, не держите их в памяти. За это отвечает новый параметр настройки `primary_key_ratio_of_unique_prefix_values_to_skip_suffix_columns` со значением `0.9` по умолчанию, что означает следующее: для составного первичного ключа, если столбец меняет своё значение как минимум в 90 % случаев, следующие за ним столбцы не будут загружаться в память. [#60255](https://github.com/ClickHouse/ClickHouse/pull/60255) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшена производительность сериализованных методов агрегации при работе с несколькими столбцами `Nullable`. [#55809](https://github.com/ClickHouse/ClickHouse/pull/55809) ([Amos Bird](https://github.com/amosbird)).
* Ленивое формирование JSON-вывода для повышения производительности ALL JOIN. [#58278](https://github.com/ClickHouse/ClickHouse/pull/58278) ([LiuNeng](https://github.com/liuneng1994)).
* Сделать HTTP/HTTPS‑подключения к внешним сервисам (например, AWS S3) повторно используемыми для всех сценариев, даже при ответах со статусом 3xx или 4xx. [#58845](https://github.com/ClickHouse/ClickHouse/pull/58845) ([Sema Checherinda](https://github.com/CheSema)).
* Улучшены агрегатные функции `argMin` / `argMax` / `any` / `anyLast` / `anyHeavy`, а также запросы вида `ORDER BY {u8/u16/u32/u64/i8/i16/u32/i64) LIMIT 1`. [#58640](https://github.com/ClickHouse/ClickHouse/pull/58640) ([Raúl Marín](https://github.com/Algunenano)).
* Тривиальная оптимизация фильтра по столбцу. В некоторых случаях пиковое потребление памяти может быть уменьшено до 44 % от исходного значения. [#59698](https://github.com/ClickHouse/ClickHouse/pull/59698) ([李扬](https://github.com/taiyang-li)).
* Выполнять функцию `multiIf` в столбцовом режиме, когда базовый тип результирующего типа является числовым. [#60384](https://github.com/ClickHouse/ClickHouse/pull/60384) ([李扬](https://github.com/taiyang-li)).
* Более быстрые мьютексы (почти в 2 раза). [#60823](https://github.com/ClickHouse/ClickHouse/pull/60823) ([Azat Khuzhin](https://github.com/azat)).
* Параллельно освобождать несколько соединений при завершении распределённого запроса. [#60845](https://github.com/ClickHouse/ClickHouse/pull/60845) ([lizhuoyu5](https://github.com/lzydmxy)).
* Оптимизировано перемещение данных между столбцами типа Nullable с числовыми или строковыми значениями, что улучшило результаты некоторых микробенчмарков. [#60846](https://github.com/ClickHouse/ClickHouse/pull/60846) ([李扬](https://github.com/taiyang-li)).
* Операции с файловым кэшем будут в меньшей степени страдать от конкуренции за блокировки. [#61066](https://github.com/ClickHouse/ClickHouse/pull/61066) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Оптимизировать `ARRAY JOIN` и другие `JOIN`, предотвратив некорректную оптимизацию компилятором. Закрыть [#61074](https://github.com/ClickHouse/ClickHouse/issues/61074).  [#61075](https://github.com/ClickHouse/ClickHouse/pull/61075) ([李扬](https://github.com/taiyang-li)).
* Если запрос с синтаксической ошибкой содержал `COLUMNS` с регулярным выражением, это регулярное выражение компилировалось каждый раз при бэктрекинге парсера вместо однократной компиляции. Это была принципиальная ошибка. Скомпилированное регулярное выражение помещалось в AST. Но буква A в AST означает &quot;abstract&quot; (&quot;абстрактное&quot;), что подразумевает отсутствие тяжеловесных объектов. Части AST могут создаваться и удаляться во время парсинга, в том числе при множественных шагах бэктрекинга. Это приводит к замедлению парсинга и, как следствие, позволяет осуществить DoS пользователю только с правами чтения. Но основная проблема в том, что это мешает прогрессу фаззеров. [#61543](https://github.com/ClickHouse/ClickHouse/pull/61543) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен новый проход анализатора для оптимизации оператора IN в случае одного значения. [#61564](https://github.com/ClickHouse/ClickHouse/pull/61564) ([LiuNeng](https://github.com/liuneng1994)).
* DNSResolver перемешивает набор разрешённых IP-адресов, что необходимо для равномерного распределения нагрузки между несколькими конечными точками AWS S3. [#60965](https://github.com/ClickHouse/ClickHouse/pull/60965) ([Sema Checherinda](https://github.com/CheSema)).



#### Экспериментальная функциональность {#experimental-feature-7}
* Добавлена поддержка параллельного чтения из Azure Blob Storage. Это повышает производительность экспериментального объектного хранилища Azure. [#61503](https://github.com/ClickHouse/ClickHouse/pull/61503) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Добавлен асинхронный WriteBuffer для Azure Blob Storage, аналогичный S3. Это повышает производительность экспериментального объектного хранилища Azure. [#59929](https://github.com/ClickHouse/ClickHouse/pull/59929) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Добавлено использование managed identity для операций ввода-вывода резервных копий при работе с Azure Blob Storage. Добавлена настройка, предотвращающая попытки ClickHouse создать несуществующий контейнер, что требует прав на уровне учетной записи хранилища. [#61785](https://github.com/ClickHouse/ClickHouse/pull/61785) ([Daniel Pozo Escalona](https://github.com/danipozo)).
* Добавлена настройка `parallel_replicas_allow_in_with_subquery = 1`, которая позволяет подзапросам в операторе IN работать с параллельными репликами. [#60950](https://github.com/ClickHouse/ClickHouse/pull/60950) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Изменение для репликации «zero-copy»: все блокировки «zero-copy», относящиеся к таблице, должны быть сняты при удалении таблицы. Каталог, содержащий эти блокировки, также должен быть удален. [#57575](https://github.com/ClickHouse/ClickHouse/pull/57575) ([Sema Checherinda](https://github.com/CheSema)).



#### Улучшение {#improvement-9}

* Используйте `MergeTree` в качестве табличного движка по умолчанию. [#60524](https://github.com/ClickHouse/ClickHouse/pull/60524) ([Alexey Milovidov](https://github.com/alexey-milovidov))
* Включён `output_format_pretty_row_numbers` по умолчанию. Это улучшает удобство использования. [#61791](https://github.com/ClickHouse/ClickHouse/pull/61791) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* В предыдущей версии некоторые числа в форматах Pretty отображались не слишком красиво. [#61794](https://github.com/ClickHouse/ClickHouse/pull/61794) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Длинное значение в форматах Pretty не будет обрезано, если оно является единственным значением в результате, например в результате выполнения запроса `SHOW CREATE TABLE`. [#61795](https://github.com/ClickHouse/ClickHouse/pull/61795) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Так же, как и `clickhouse-local`, `clickhouse-client` принимает опцию `--output-format` как синоним опции `--format`. Это закрывает [#59848](https://github.com/ClickHouse/ClickHouse/issues/59848). [#61797](https://github.com/ClickHouse/ClickHouse/pull/61797) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Если stdout является терминалом и формат вывода не указан, `clickhouse-client` и подобные инструменты по умолчанию будут использовать формат `PrettyCompact`, как и в интерактивном режиме. `clickhouse-client` и `clickhouse-local` будут единообразно обрабатывать аргументы командной строки, связанные с форматами ввода и вывода. Это закрывает [#61272](https://github.com/ClickHouse/ClickHouse/issues/61272). [#61800](https://github.com/ClickHouse/ClickHouse/pull/61800) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Подчёркивание групп цифр в форматах Pretty для улучшения читаемости. Управляется новым параметром настройки `output_format_pretty_highlight_digit_groups`. [#61802](https://github.com/ClickHouse/ClickHouse/pull/61802) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность переопределять начальные настройки INSERT с помощью `SYSTEM FLUSH DISTRIBUTED`. [#61832](https://github.com/ClickHouse/ClickHouse/pull/61832) ([Azat Khuzhin](https://github.com/azat)).
* Включить по умолчанию профилирование процессоров (время выполнения, объём входящих и исходящих байт при сортировке, агрегации и т. д.). [#61096](https://github.com/ClickHouse/ClickHouse/pull/61096) ([Azat Khuzhin](https://github.com/azat)).
* Поддержка файлов без расширения в базе данных Filesystem. [#60795](https://github.com/ClickHouse/ClickHouse/pull/60795) ([Kruglov Pavel](https://github.com/Avogar)).
* Названия всех форматов сделали нечувствительными к регистру, например Tsv, TSV, tsv или даже rowbinary. [#60420](https://github.com/ClickHouse/ClickHouse/pull/60420) ([豪肥肥](https://github.com/HowePa)). Я буду признателен, если вы по-прежнему будете писать их правильно, например `JSON` 😇, а не `Json` 🤮, но мы не возражаем, если вы будете писать так, как вам удобнее.
* Добавлен режим `none_only_active` для параметра `distributed_ddl_output_mode`. [#60340](https://github.com/ClickHouse/ClickHouse/pull/60340) ([Alexander Tokmakov](https://github.com/tavplubix)).
* В расширенной панели мониторинга слегка улучшена цветовая схема многолинейных графиков. [#60391](https://github.com/ClickHouse/ClickHouse/pull/60391) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Теперь на панели Advanced элементы управления всегда остаются видимыми при прокрутке. Это позволяет добавить новый график, не прокручивая страницу вверх. [#60692](https://github.com/ClickHouse/ClickHouse/pull/60692) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* При выполнении запроса `MODIFY COLUMN` для материализованных представлений проверьте структуру внутренней таблицы, чтобы убедиться, что все столбцы присутствуют. [#47427](https://github.com/ClickHouse/ClickHouse/pull/47427) ([sunny](https://github.com/sunny19930321)).
* Типы String и Enum могут использоваться в одном и том же контексте, например в массивах, запросах UNION и условных выражениях. Это закрывает задачу [#60726](https://github.com/ClickHouse/ClickHouse/issues/60726). [#60727](https://github.com/ClickHouse/ClickHouse/pull/60727) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность объявлять Enum в структуре внешних данных для обработки запросов (это временная таблица, создаваемая на лету, которую вы можете предоставить для своего запроса). [#57857](https://github.com/ClickHouse/ClickHouse/pull/57857) ([Duc Canh Le](https://github.com/canhld94)).
* При выборе частей для слияния учитывать строки легковесного удаления, чтобы точнее оценивать размер результирующей части на диске. [#58223](https://github.com/ClickHouse/ClickHouse/pull/58223) ([Zhuo Qiu](https://github.com/jewelzqiu)).
* Добавлены комментарии к столбцам в дополнительных системных таблицах. Продолжение [https://github.com/ClickHouse/ClickHouse/pull/58356](https://github.com/ClickHouse/ClickHouse/pull/58356). [#59016](https://github.com/ClickHouse/ClickHouse/pull/59016) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Теперь можно использовать виртуальные столбцы в PREWHERE. Это особенно полезно для неконстантных виртуальных столбцов, таких как `_part_offset`. [#59033](https://github.com/ClickHouse/ClickHouse/pull/59033) ([Amos Bird](https://github.com/amosbird)). Улучшено общее удобство использования виртуальных столбцов. Теперь разрешено использовать виртуальные столбцы в `PREWHERE` (это особенно полезно для неконстантных виртуальных столбцов, таких как `_part_offset`). Теперь для виртуальных столбцов доступна встроенная документация в виде комментария к столбцу в запросе `DESCRIBE` при включённой настройке `describe_include_virtual_columns`. [#60205](https://github.com/ClickHouse/ClickHouse/pull/60205) ([Anton Popov](https://github.com/CurtizJ)).
* Вместо использования фиксированного ключа теперь объектное хранилище генерирует ключ для определения возможности удаления объектов. [#59495](https://github.com/ClickHouse/ClickHouse/pull/59495) ([Sema Checherinda](https://github.com/CheSema)).
* Добавлена возможность использовать &quot;local&quot; в качестве типа объектного хранилища вместо &quot;local&#95;blob&#95;storage&quot;. [#60165](https://github.com/ClickHouse/ClickHouse/pull/60165) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Параллельный сброс ожидающих блоков INSERT движка Distributed при `DETACH`/остановке сервера и `SYSTEM FLUSH DISTRIBUTED` (параллелизм будет работать только в том случае, если для таблицы настроена политика хранения с несколькими дисками (как и для всего в движке Distributed сейчас)). [#60225](https://github.com/ClickHouse/ClickHouse/pull/60225) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена настройка, позволяющая принудительно использовать кэш read-through при слияниях. [#60308](https://github.com/ClickHouse/ClickHouse/pull/60308) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Улучшение протокола совместимости с MySQL. В задаче [#57598](https://github.com/ClickHouse/ClickHouse/issues/57598) описано отличающееся поведение при обработке транзакций: выполнение команды COMMIT/ROLLBACK при отсутствии активной транзакции приводит к сообщению об ошибке, в отличие от поведения MySQL. [#60338](https://github.com/ClickHouse/ClickHouse/pull/60338) ([PapaToemmsn](https://github.com/PapaToemmsn)).
* Функция `substring` теперь имеет новый псевдоним `byteSlice`. [#60494](https://github.com/ClickHouse/ClickHouse/pull/60494) ([Robert Schulze](https://github.com/rschu1ze)).
* Переименован параметр сервера `dns_cache_max_size` в `dns_cache_max_entries`, чтобы снизить неоднозначность. [#60500](https://github.com/ClickHouse/ClickHouse/pull/60500) ([Kirill Nikiforov](https://github.com/allmazz)).
* `SHOW INDEX | INDEXES | INDICES | KEYS` больше не сортирует по столбцам первичного ключа (что было неочевидным). [#60514](https://github.com/ClickHouse/ClickHouse/pull/60514) ([Robert Schulze](https://github.com/rschu1ze)).
* Улучшение в Keeper: прерывать запуск при обнаружении недопустимого снапшота, чтобы избежать потери данных. [#60537](https://github.com/ClickHouse/ClickHouse/pull/60537) ([Antonio Andelic](https://github.com/antonio2368)).
* Обновить tzdata до версии 2024a. [#60768](https://github.com/ClickHouse/ClickHouse/pull/60768) ([Raúl Marín](https://github.com/Algunenano)).
* Улучшение Keeper: добавлена поддержка параметра `leadership_expiry_ms` в настройках Keeper. [#60806](https://github.com/ClickHouse/ClickHouse/pull/60806) ([Brokenice0415](https://github.com/Brokenice0415)).
* Числа в экспоненциальной форме в форматах JSON теперь всегда интерпретируются независимо от значения настройки `input_format_try_infer_exponent_floats`. Добавлена настройка `input_format_json_use_string_type_for_ambiguous_paths_in_named_tuples_inference_from_objects`, которая позволяет использовать тип String для неоднозначных путей вместо генерации исключения при выводе именованных Tuple из JSON-объектов. [#60808](https://github.com/ClickHouse/ClickHouse/pull/60808) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка синтаксиса `START TRANSACTION`, обычно используемого в MySQL, что закрывает обсуждение [https://github.com/ClickHouse/ClickHouse/discussions/60865](https://github.com/ClickHouse/ClickHouse/discussions/60865). [#60886](https://github.com/ClickHouse/ClickHouse/pull/60886) ([Zach Naimon](https://github.com/ArctypeZach)).
* Добавлен флаг для алгоритма full-sorting merge join, позволяющий трактовать значения NULL как наибольшее или наименьшее. Это позволяет сделать поведение совместимым с другими SQL‑системами, такими как Apache Spark. [#60896](https://github.com/ClickHouse/ClickHouse/pull/60896) ([loudongfeng](https://github.com/loudongfeng)).
* Добавлена поддержка определения формата вывода по расширению файла в `clickhouse-client` и `clickhouse-local`. [#61036](https://github.com/ClickHouse/ClickHouse/pull/61036) ([豪肥肥](https://github.com/HowePa)).
* Обновлять лимит памяти во время работы при изменении значения cgroups в Linux. [#61049](https://github.com/ClickHouse/ClickHouse/pull/61049) ([Han Fei](https://github.com/hanfei1991)).
* Добавлена функция `toUInt128OrZero`, которая ранее была пропущена по ошибке (ошибка связана с [https://github.com/ClickHouse/ClickHouse/pull/945](https://github.com/ClickHouse/ClickHouse/pull/945)). Псевдонимы совместимости `FROM_UNIXTIME` и `DATE_FORMAT` (они не являются встроенными в ClickHouse и существуют только для совместимости с MySQL) сделаны регистронезависимыми, как и положено SQL-псевдонимам совместимости. [#61114](https://github.com/ClickHouse/ClickHouse/pull/61114) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшены проверки доступа, теперь можно отзывать права, которыми пользователь не обладает, даже если у целевого пользователя также нет соответствующих прав с правом передачи. Пример: `GRANT SELECT ON *.* TO user1; REVOKE SELECT ON system.* FROM user1;`. [#61115](https://github.com/ClickHouse/ClickHouse/pull/61115) ([pufit](https://github.com/pufit)).
* Исправлена функция `has()` при работе со столбцом `Nullable` (устраняет [#60214](https://github.com/ClickHouse/ClickHouse/issues/60214)). [#61249](https://github.com/ClickHouse/ClickHouse/pull/61249) ([Mikhail Koviazin](https://github.com/mkmkme)).
* Теперь можно указывать атрибут `merge="true"` в подстановках конфигурации для поддеревьев `<include from_zk="/path" merge="true">`. Если этот атрибут указан, ClickHouse будет объединять поддерево с существующей конфигурацией, в противном случае используется поведение по умолчанию — к конфигурации добавляется новое содержимое. [#61299](https://github.com/ClickHouse/ClickHouse/pull/61299) ([alesapin](https://github.com/alesapin)).
* Добавлены асинхронные метрики для отображений виртуальной памяти: `VMMaxMapCount` и `VMNumMaps`. Закрывает [#60662](https://github.com/ClickHouse/ClickHouse/issues/60662). [#61354](https://github.com/ClickHouse/ClickHouse/pull/61354) ([Tuan Pham Anh](https://github.com/tuanpavn)).
* Используйте настройку `temporary_files_codec` во всех местах, где создаются временные данные, например при сортировке с использованием внешней памяти и выполнении GROUP BY с использованием внешней памяти. Ранее она применялась только в алгоритме JOIN `partial_merge`. [#61456](https://github.com/ClickHouse/ClickHouse/pull/61456) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена новая настройка `max_parser_backtracks`, которая позволяет ограничить сложность парсинга запросов. [#61502](https://github.com/ClickHouse/ClickHouse/pull/61502) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Меньше конфликтов при динамическом изменении размера кэша файловой системы. [#61524](https://github.com/ClickHouse/ClickHouse/pull/61524) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отключён шардированный режим очереди StorageS3, так как он будет переписан. [#61537](https://github.com/ClickHouse/ClickHouse/pull/61537) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена опечатка: с `use_leagcy_max_level` на `use_legacy_max_level`. [#61545](https://github.com/ClickHouse/ClickHouse/pull/61545) ([William Schoeffel](https://github.com/wiledusc)).
* Удалены несколько дублирующихся записей в `system.blob_storage_log`. [#61622](https://github.com/ClickHouse/ClickHouse/pull/61622) ([YenchangChan](https://github.com/YenchangChan)).
* Добавлена функция `current_user` в качестве псевдонима для совместимости с MySQL. [#61770](https://github.com/ClickHouse/ClickHouse/pull/61770) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлены несогласованные состояния агрегатных функций с плавающей запятой в смешанных кластерах x86-64 / ARM [#60610](https://github.com/ClickHouse/ClickHouse/pull/60610) ([Harry Lee](https://github.com/HarryLeeIBM)).



#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-5}
* Профилировщик запросов в реальном времени теперь работает на AArch64. В предыдущих версиях он работал только если программа не находилась внутри системного вызова. [#60807](https://github.com/ClickHouse/ClickHouse/pull/60807) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Версия ClickHouse добавлена в метки Docker. Закрывает [#54224](https://github.com/ClickHouse/ClickHouse/issues/54224). [#60949](https://github.com/ClickHouse/ClickHouse/pull/60949) ([Nikolay Monkov](https://github.com/nikmonkov)).
* Компонент `prqlc` обновлён до версии 0.11.3. [#60616](https://github.com/ClickHouse/ClickHouse/pull/60616) ([Maximilian Roos](https://github.com/max-sixty)).
* Добавлен универсальный фаззер текста запросов в `clickhouse-local`. [#61508](https://github.com/ClickHouse/ClickHouse/pull/61508) ([Alexey Milovidov](https://github.com/alexey-milovidov)).



#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-7}

* Исправлена настройка finished&#95;mutations&#95;to&#95;keep=0 для MergeTree (в документации указано, что 0 означает «сохранять всё») [#60031](https://github.com/ClickHouse/ClickHouse/pull/60031) ([Azat Khuzhin](https://github.com/azat)).
* Что-то было не так с оптимизацией FINAL; автор описывает это так: &quot;PartsSplitter invalid ranges for the same part&quot;. [#60041](https://github.com/ClickHouse/ClickHouse/pull/60041) ([Maksim Kita](https://github.com/kitaisreal)).
* Была проблема с Apache Hive, который является экспериментальной и не поддерживаемой функциональностью. [#60262](https://github.com/ClickHouse/ClickHouse/pull/60262) ([shanfengp](https://github.com/Aed-p)).
* Улучшение для экспериментальных параллельных реплик: принудительный повторный анализ при изменении набора параллельных реплик [#60362](https://github.com/ClickHouse/ClickHouse/pull/60362) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено использование простого типа метаданных с новым параметром конфигурации дисков [#60396](https://github.com/ClickHouse/ClickHouse/pull/60396) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Попытка исправить логическую ошибку &#39;Cannot capture column because it has incompatible type&#39; в функции mapContainsKeyLike [#60451](https://github.com/ClickHouse/ClickHouse/pull/60451) ([Kruglov Pavel](https://github.com/Avogar)).
* Исключено вычисление скалярных подзапросов при CREATE TABLE. [#60464](https://github.com/ClickHouse/ClickHouse/pull/60464) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена взаимоблокировка при параллельном парсинге, возникающая, когда из‑за ошибок пропускается большое число строк [#60516](https://github.com/ClickHouse/ClickHouse/pull/60516) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка в экспериментальной поддержке KQL (Kusto): скорректирован параметр `max_query_size_for_kql_compound_operator`: [#60534](https://github.com/ClickHouse/ClickHouse/pull/60534) ([Yong Wang](https://github.com/kashwy)).
* Исправление в Keeper: добавлены тайм-ауты при ожидании журналов фиксации [#60544](https://github.com/ClickHouse/ClickHouse/pull/60544) ([Antonio Andelic](https://github.com/antonio2368)).
* Не показывать числовые подсказки для датовых типов [#60577](https://github.com/ClickHouse/ClickHouse/pull/60577) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено чтение из MergeTree с недетерминированными функциями в фильтре [#60586](https://github.com/ClickHouse/ClickHouse/pull/60586) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена логическая ошибка при неподходящем типе значения настройки совместимости [#60596](https://github.com/ClickHouse/ClickHouse/pull/60596) ([Kruglov Pavel](https://github.com/Avogar)).
* fix(prql): Более надежный обработчик паники [#60615](https://github.com/ClickHouse/ClickHouse/pull/60615) ([Maximilian Roos](https://github.com/max-sixty)).
* Исправлена работа функции `intDiv` для аргументов типов Decimal и Date [#60672](https://github.com/ClickHouse/ClickHouse/pull/60672) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправление: разворачивать CTE в запросах ALTER MODIFY [#60682](https://github.com/ClickHouse/ClickHouse/pull/60682) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена таблица system.parts для движков баз данных, не являющихся Atomic/Ordinary (например, Memory) [#60689](https://github.com/ClickHouse/ClickHouse/pull/60689) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка «Invalid storage definition in metadata file» для параметризованных представлений [#60708](https://github.com/ClickHouse/ClickHouse/pull/60708) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено переполнение буфера в CompressionCodecMultiple [#60731](https://github.com/ClickHouse/ClickHouse/pull/60731) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Удалить некорректные данные из SQL/JSON [#60738](https://github.com/ClickHouse/ClickHouse/pull/60738) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Удалена некорректная проверка (assert) в агрегатной функции quantileGK [#60740](https://github.com/ClickHouse/ClickHouse/pull/60740) ([李扬](https://github.com/taiyang-li)).
* Исправлена ошибка insert-select + insert&#95;deduplication&#95;token путем установки параметра streams в значение 1 [#60745](https://github.com/ClickHouse/ClickHouse/pull/60745) ([Jordi Villar](https://github.com/jrdi)).
* Предотвращена установка пользовательских заголовков метаданных при неподдерживаемых операциях многокомпонентной загрузки [#60748](https://github.com/ClickHouse/ClickHouse/pull/60748) ([Francisco J. Jurado Moreno](https://github.com/Beetelbrox)).
* Исправлена функция toStartOfInterval [#60763](https://github.com/ClickHouse/ClickHouse/pull/60763) ([Andrey Zvonov](https://github.com/zvonand)).
* Исправлено падение в arrayEnumerateRanked [#60764](https://github.com/ClickHouse/ClickHouse/pull/60764) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено аварийное завершение при использовании input() в INSERT SELECT JOIN [#60765](https://github.com/ClickHouse/ClickHouse/pull/60765) ([Kruglov Pavel](https://github.com/Avogar)).
* Устранена ошибка, из-за которой происходило аварийное завершение работы при отличающемся значении параметра allow&#95;experimental&#95;analyzer в подзапросах [#60770](https://github.com/ClickHouse/ClickHouse/pull/60770) ([Dmitry Novik](https://github.com/novikd)).
* Удалена рекурсия при чтении из S3 [#60849](https://github.com/ClickHouse/ClickHouse/pull/60849) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено возможное зависание при ошибке в HashedDictionaryParallelLoader [#60926](https://github.com/ClickHouse/ClickHouse/pull/60926) ([vdimir](https://github.com/vdimir)).
* Исправлена асинхронная операция RESTORE для базы данных Replicated (экспериментальная возможность) [#60934](https://github.com/ClickHouse/ClickHouse/pull/60934) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена взаимоблокировка при асинхронных вставках в таблицы `Log` через нативный протокол [#61055](https://github.com/ClickHouse/ClickHouse/pull/61055) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено отложенное вычисление аргумента по умолчанию в dictGetOrDefault для RangeHashedDictionary [#61196](https://github.com/ClickHouse/ClickHouse/pull/61196) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено несколько ошибок в groupArraySorted [#61203](https://github.com/ClickHouse/ClickHouse/pull/61203) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена переконфигурация Keeper для автономного бинарника [#61233](https://github.com/ClickHouse/ClickHouse/pull/61233) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено использование параметра session&#95;token в движке S3 [#61234](https://github.com/ClickHouse/ClickHouse/pull/61234) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена возможная некорректность результата работы агрегатной функции `uniqExact` [#61257](https://github.com/ClickHouse/ClickHouse/pull/61257) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены ошибки в команде SHOW DATABASE [#61269](https://github.com/ClickHouse/ClickHouse/pull/61269) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена логическая ошибка в хранилище RabbitMQ при использовании колонок MATERIALIZED [#61320](https://github.com/ClickHouse/ClickHouse/pull/61320) ([vdimir](https://github.com/vdimir)).
* Исправлена команда CREATE OR REPLACE DICTIONARY [#61356](https://github.com/ClickHouse/ClickHouse/pull/61356) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен запрос ATTACH с внешним предложением ON CLUSTER [#61365](https://github.com/ClickHouse/ClickHouse/pull/61365) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена оптимизация последовательных ключей для ключей, допускающих NULL [#61393](https://github.com/ClickHouse/ClickHouse/pull/61393) ([Anton Popov](https://github.com/CurtizJ)).
* исправлена ошибка при разбиении DAG действий [#61458](https://github.com/ClickHouse/ClickHouse/pull/61458) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена обработка завершения неудавшегося RESTORE [#61466](https://github.com/ClickHouse/ClickHouse/pull/61466) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено корректное отключение параметра async&#95;insert&#95;use&#95;adaptive&#95;busy&#95;timeout при использовании настроек совместимости [#61468](https://github.com/ClickHouse/ClickHouse/pull/61468) ([Raúl Marín](https://github.com/Algunenano)).
* Разрешена постановка задач в очередь в пуле восстановления [#61475](https://github.com/ClickHouse/ClickHouse/pull/61475) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена несогласованность при чтении таблицы system.parts с использованием UUID. [#61479](https://github.com/ClickHouse/ClickHouse/pull/61479) ([Dan Wu](https://github.com/wudanzy)).
* Исправлено ALTER QUERY MODIFY SQL SECURITY [#61480](https://github.com/ClickHouse/ClickHouse/pull/61480) ([pufit](https://github.com/pufit)).
* Исправлен сбой в Window View (экспериментальная функция) [#61526](https://github.com/ClickHouse/ClickHouse/pull/61526) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена работа функции `repeat` с ненативными целыми числами [#61527](https://github.com/ClickHouse/ClickHouse/pull/61527) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлен аргумент `-s` клиента [#61530](https://github.com/ClickHouse/ClickHouse/pull/61530) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Исправлена ошибка, приводившая к аварийному завершению работы arrayPartialReverseSort [#61539](https://github.com/ClickHouse/ClickHouse/pull/61539) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлен поиск строк с `const position` [#61547](https://github.com/ClickHouse/ClickHouse/pull/61547) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка, из-за которой `addDays` вызывала сбой при использовании с типом данных `DateTime64` [#61561](https://github.com/ClickHouse/ClickHouse/pull/61561) ([Shuai li](https://github.com/loneylee)).
* Запрещён тип аргумента LowCardinality для JSONExtract [#61617](https://github.com/ClickHouse/ClickHouse/pull/61617) ([Julia Kartseva](https://github.com/jkartseva)).
* Исправлен `system.part_log` для асинхронных вставок с дедупликацией [#61620](https://github.com/ClickHouse/ClickHouse/pull/61620) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка, приводившая к исключению `Non-ready set` в system.parts. [#61666](https://github.com/ClickHouse/ClickHouse/pull/61666) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено actual&#95;part&#95;name для REPLACE&#95;RANGE (`Entry actual part isn't empty yet`) [#61675](https://github.com/ClickHouse/ClickHouse/pull/61675) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлен отчёт санитайзера в `multiSearchAllPositionsCaseInsensitiveUTF8` о некорректных данных UTF-8 [#61749](https://github.com/ClickHouse/ClickHouse/pull/61749) ([pufit](https://github.com/pufit)).
* Уточнено, что фрейм RANGE не поддерживается для столбцов типа Nullable. [#61766](https://github.com/ClickHouse/ClickHouse/pull/61766) ([YuanLiu](https://github.com/ditgittube)).



### <a id="242"></a> Релиз ClickHouse 24.2, 2024-02-29 {#a-id242a-clickhouse-release-242-2024-02-29}

#### Обратное несовместимое изменение {#backward-incompatible-change-8}
* Проверка подозрительных/экспериментальных типов во вложенных типах. Ранее мы не проверяли такие типы (за исключением JSON) во вложенных типах, таких как Array/Tuple/Map. [#59385](https://github.com/ClickHouse/ClickHouse/pull/59385) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена дополнительная проверка корректности (sanity check) для числа потоков и размеров блоков. [#60138](https://github.com/ClickHouse/ClickHouse/pull/60138) ([Raúl Marín](https://github.com/Algunenano)).
* По умолчанию не выводить типы с плавающей запятой для чисел в экспоненциальной нотации. Добавлена настройка `input_format_try_infer_exponent_floats`, которая восстанавливает предыдущее поведение (по умолчанию отключена). Закрывает [#59476](https://github.com/ClickHouse/ClickHouse/issues/59476). [#59500](https://github.com/ClickHouse/ClickHouse/pull/59500) ([Kruglov Pavel](https://github.com/Avogar)).
* Разрешить заключать операции ALTER в круглые скобки. Вывод скобок может управляться с помощью настройки `format_alter_operations_with_parentheses`. По умолчанию в отформатированных запросах скобки выводятся, поскольку мы храним отформатированные операции ALTER в некоторых местах как метаданные (например, для мутаций). Новый синтаксис проясняет некоторые запросы, в которых операции ALTER заканчиваются списком. Например, `ALTER TABLE x MODIFY TTL date GROUP BY a, b, DROP COLUMN c` не может быть корректно разобран со старым синтаксисом. В новом синтаксисе запрос `ALTER TABLE x (MODIFY TTL date GROUP BY a, b), (DROP COLUMN c)` очевиден. Старые версии не могут прочитать новый синтаксис, поэтому использование нового синтаксиса может вызвать проблемы, если новые и старые версии ClickHouse используются в одном кластере. [#59532](https://github.com/ClickHouse/ClickHouse/pull/59532) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправление уязвимости безопасности в материализованном представлении, которая позволяла пользователю выполнять вставку в таблицу без необходимых привилегий. Исправление проверяет, что у пользователя есть права на вставку не только в материализованное представление, но и во все лежащие в его основе таблицы. Это означает, что некоторые запросы, которые работали раньше, теперь могут завершаться ошибкой `Not enough privileges`. Для решения этой проблемы релиз вводит новый механизм SQL security для представлений https://clickhouse.com/docs/sql-reference/statements/create/view#sql_security. [#54901](https://github.com/ClickHouse/ClickHouse/pull/54901) [#60439](https://github.com/ClickHouse/ClickHouse/pull/60439) ([pufit](https://github.com/pufit)).



#### Новая возможность {#new-feature-10}

* Добавлен новый синтаксис, который позволяет указывать пользователя-определителя (definer) в представлении/материализованном представлении. Это позволяет выполнять операции SELECT/INSERT из представлений без явных привилегий на базовые таблицы. Таким образом, представление будет инкапсулировать права доступа. [#54901](https://github.com/ClickHouse/ClickHouse/pull/54901) [#60439](https://github.com/ClickHouse/ClickHouse/pull/60439) ([pufit](https://github.com/pufit)).
* Пытаться автоматически определять формат файла при выводе схемы, если он неизвестен, в движках `file/s3/hdfs/url/azureBlobStorage`. Закрывает [#50576](https://github.com/ClickHouse/ClickHouse/issues/50576). [#59092](https://github.com/ClickHouse/ClickHouse/pull/59092) ([Kruglov Pavel](https://github.com/Avogar)).
* Реализована автоматическая настройка таймаутов асинхронных вставок. Добавлены следующие параметры: async&#95;insert&#95;poll&#95;timeout&#95;ms, async&#95;insert&#95;use&#95;adaptive&#95;busy&#95;timeout, async&#95;insert&#95;busy&#95;timeout&#95;min&#95;ms, async&#95;insert&#95;busy&#95;timeout&#95;max&#95;ms, async&#95;insert&#95;busy&#95;timeout&#95;increase&#95;rate, async&#95;insert&#95;busy&#95;timeout&#95;decrease&#95;rate. [#58486](https://github.com/ClickHouse/ClickHouse/pull/58486) ([Julia Kartseva](https://github.com/jkartseva)).
* Позволяет настроить ограничение на максимальное число последовательных неудачных попыток входа. [#54737](https://github.com/ClickHouse/ClickHouse/pull/54737) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
* Новая агрегатная функция `groupArrayIntersect`. Продолжение для: [#49862](https://github.com/ClickHouse/ClickHouse/issues/49862). [#59598](https://github.com/ClickHouse/ClickHouse/pull/59598) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Реализована поддержка резервного копирования и восстановления для `AzureBlobStorage`. Решает [#50747](https://github.com/ClickHouse/ClickHouse/issues/50747). [#56988](https://github.com/ClickHouse/ClickHouse/pull/56988) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Теперь пользователь может указывать шаблонную строку непосредственно в запросе с помощью `format_schema_rows_template` как альтернативы `format_template_row`. Закрывает [#31363](https://github.com/ClickHouse/ClickHouse/issues/31363). [#59088](https://github.com/ClickHouse/ClickHouse/pull/59088) ([Shaun Struwig](https://github.com/Blargian)).
* Реализовано автоматическое преобразование таблиц семейства MergeTree различных типов в реплицированный движок. Создайте пустой файл `convert_to_replicated` в каталоге данных таблицы (`/clickhouse/store/xxx/xxxyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy/`), и эта таблица будет автоматически преобразована при следующем запуске сервера. [#57798](https://github.com/ClickHouse/ClickHouse/pull/57798) ([Kirill](https://github.com/kirillgarbar)).
* Добавлен запрос `ALTER TABLE table FORGET PARTITION partition`, который удаляет узлы ZooKeeper, связанные с пустым разделом. [#59507](https://github.com/ClickHouse/ClickHouse/pull/59507) ([Sergei Trifonov](https://github.com/serxa)). Это функция экспертного уровня.
* Поддержка файла учетных данных JWT для движка таблицы NATS. [#59543](https://github.com/ClickHouse/ClickHouse/pull/59543) ([Nickolaj Jepsen](https://github.com/nickolaj-jepsen)).
* Реализована таблица `system.dns_cache`, которая может быть полезна для диагностики проблем с DNS. [#59856](https://github.com/ClickHouse/ClickHouse/pull/59856) ([Kirill Nikiforov](https://github.com/allmazz)).
* Кодек `LZ4HC` теперь поддерживает новый уровень 2, который быстрее, чем предыдущий минимальный уровень 3, за счёт меньшей степени сжатия. В предыдущих версиях значения `LZ4HC(2)` и ниже были эквивалентны `LZ4HC(3)`. Автор: [Cyan4973](https://github.com/Cyan4973). [#60090](https://github.com/ClickHouse/ClickHouse/pull/60090) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена таблица `system.dns_cache`, полезная для отладки проблем с DNS. Новая настройка сервера dns&#95;cache&#95;max&#95;size. [#60257](https://github.com/ClickHouse/ClickHouse/pull/60257) ([Kirill Nikiforov](https://github.com/allmazz)).
* Добавлена поддержка одноаргументного варианта табличной функции `merge`: `merge(['db_name', ] 'tables_regexp')`. [#60372](https://github.com/ClickHouse/ClickHouse/pull/60372) ([豪肥肥](https://github.com/HowePa)).
* Добавлена поддержка отрицательных позиционных аргументов. Закрывает [#57736](https://github.com/ClickHouse/ClickHouse/issues/57736). [#58292](https://github.com/ClickHouse/ClickHouse/pull/58292) ([flynn](https://github.com/ucasfl)).
* Добавлена поддержка указания набора разрешённых пользователей для отдельных настроек S3 в конфигурации с помощью ключа `user`. [#60144](https://github.com/ClickHouse/ClickHouse/pull/60144) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена табличная функция `mergeTreeIndex`. Она представляет содержимое файлов индекса и меток таблиц `MergeTree`. Её можно использовать для интроспекции. Синтаксис: `mergeTreeIndex(database, table, [with_marks = true])`, где `database.table` — это существующая таблица с движком `MergeTree`. [#58140](https://github.com/ClickHouse/ClickHouse/pull/58140) ([Anton Popov](https://github.com/CurtizJ)).



#### Экспериментальная функция {#experimental-feature-8}
* Добавлена функция `seriesOutliersDetectTukey` для обнаружения выбросов в данных временных рядов с использованием алгоритма ограждений Тьюки (Tukey's fences). [#58632](https://github.com/ClickHouse/ClickHouse/pull/58632) ([Bhavna Jindal](https://github.com/bhavnajindal)). Имейте в виду, что поведение будет изменено в следующем патч-релизе.
* Добавлена функция `variantType`, которая возвращает Enum с именем варианта типа для каждой строки. [#59398](https://github.com/ClickHouse/ClickHouse/pull/59398) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка `LEFT JOIN`, `ALL INNER JOIN` и простых подзапросов для параллельных реплик (только с analyzer). Новый параметр настройки `parallel_replicas_prefer_local_join` выбирает локальное выполнение `JOIN` (по умолчанию) вместо `GLOBAL JOIN`. Все таблицы должны существовать на каждой реплике из `cluster_for_parallel_replicas`. Новые настройки `min_external_table_block_size_rows` и `min_external_table_block_size_bytes` используются для укрупнения мелких блоков, которые отправляются для временных таблиц (только с analyzer). [#58916](https://github.com/ClickHouse/ClickHouse/pull/58916) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Разрешено одновременное создание таблиц в базе данных `Replicated` при добавлении или восстановлении новой реплики. [#59277](https://github.com/ClickHouse/ClickHouse/pull/59277) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Реализован оператор сравнения для значений `Variant` и корректная вставка Field в столбец `Variant`. По умолчанию запрещено создавать тип `Variant` со схожими вариантами типов (разрешается при включении настройки `allow_suspicious_variant_types`). Закрывает [#59996](https://github.com/ClickHouse/ClickHouse/issues/59996). Закрывает [#59850](https://github.com/ClickHouse/ClickHouse/issues/59850). [#60198](https://github.com/ClickHouse/ClickHouse/pull/60198) ([Kruglov Pavel](https://github.com/Avogar)).
* Отключено выполнение `JOIN` с параллельными репликами для CTE (без analyzer'а). [#59239](https://github.com/ClickHouse/ClickHouse/pull/59239) ([Raúl Marín](https://github.com/Algunenano)).



#### Повышение производительности {#performance-improvement-10}

* Первичный ключ будет потреблять меньше памяти. [#60049](https://github.com/ClickHouse/ClickHouse/pull/60049) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Оптимизировано использование памяти для первичного ключа и некоторых других операций. [#60050](https://github.com/ClickHouse/ClickHouse/pull/60050) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Первичные ключи таблиц будут загружаться в память лениво при первом обращении. Это контролируется новой настройкой MergeTree `primary_key_lazy_load`, которая включена по умолчанию. Это даёт несколько преимуществ: - первичный ключ не будет загружаться для таблиц, которые не используются; - если недостаточно памяти, исключение будет сгенерировано при первом использовании, а не при запуске сервера. Однако есть и несколько недостатков: - задержка при загрузке первичного ключа проявится при выполнении первого запроса, а не до принятия подключений; теоретически это может привести к проблеме «thundering herd». Это закрывает [#11188](https://github.com/ClickHouse/ClickHouse/issues/11188). [#60093](https://github.com/ClickHouse/ClickHouse/pull/60093) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Векторизованные функции расстояния, используемые в векторном поиске. [#58866](https://github.com/ClickHouse/ClickHouse/pull/58866) ([Robert Schulze](https://github.com/rschu1ze)).
* Векторизованная функция `dotProduct`, которая полезна для векторного поиска. [#60202](https://github.com/ClickHouse/ClickHouse/pull/60202) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка короткого замыкания для функции `dictGetOrDefault`. Закрывает [#52098](https://github.com/ClickHouse/ClickHouse/issues/52098). [#57767](https://github.com/ClickHouse/ClickHouse/pull/57767) ([jsc0218](https://github.com/jsc0218)).
* Улучшение Keeper: теперь в памяти кэшируется только ограниченное количество логов, задаваемое параметрами `latest_logs_cache_size_threshold` и `commit_logs_cache_size_threshold`. [#59460](https://github.com/ClickHouse/ClickHouse/pull/59460) ([Antonio Andelic](https://github.com/antonio2368)).
* Улучшение Keeper: ещё больше уменьшен размер узла данных. [#59592](https://github.com/ClickHouse/ClickHouse/pull/59592) ([Antonio Andelic](https://github.com/antonio2368)).
* Продолжена оптимизация промахов предсказания ветвлений функции `if`, когда тип результата — `Float*/Decimal*/*Int*`, как продолжение работы из [https://github.com/ClickHouse/ClickHouse/pull/57885](https://github.com/ClickHouse/ClickHouse/pull/57885). [#59148](https://github.com/ClickHouse/ClickHouse/pull/59148) ([李扬](https://github.com/taiyang-li)).
* Оптимизирована функция `if` для входного типа `Map`, ускорение — до ~10 раз. [#59413](https://github.com/ClickHouse/ClickHouse/pull/59413) ([李扬](https://github.com/taiyang-li)).
* Улучшена производительность типа `Int8` за счёт реализации строгого алиасинга (он уже реализован для `UInt8` и всех остальных целочисленных типов). [#59485](https://github.com/ClickHouse/ClickHouse/pull/59485) ([Raúl Marín](https://github.com/Algunenano)).
* Оптимизировать производительность условных операций sum/avg для типов bigint и BigDecimal за счёт уменьшения количества промахов предсказателя ветвлений. [#59504](https://github.com/ClickHouse/ClickHouse/pull/59504) ([李扬](https://github.com/taiyang-li)).
* Повышена производительность запросов SELECT при активных мутациях. [#59531](https://github.com/ClickHouse/ClickHouse/pull/59531) ([Azat Khuzhin](https://github.com/azat)).
* Оптимизирована функция `isNotNull` с использованием AVX2. [#59621](https://github.com/ClickHouse/ClickHouse/pull/59621) ([李扬](https://github.com/taiyang-li)).
* Улучшена производительность ASOF JOIN для отсортированных или почти отсортированных данных. [#59731](https://github.com/ClickHouse/ClickHouse/pull/59731) ([Maksim Kita](https://github.com/kitaisreal)).
* Предыдущее значение по умолчанию, равное 1 МБ для `async_insert_max_data_size`, оказалось слишком маленьким. Новым значением будет 10 МиБ. [#59536](https://github.com/ClickHouse/ClickHouse/pull/59536) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Использовать несколько потоков при чтении метаданных таблиц из резервной копии во время выполнения команды RESTORE. [#60040](https://github.com/ClickHouse/ClickHouse/pull/60040) ([Vitaly Baranov](https://github.com/vitlibar)).
* Теперь, если в `StorageBuffer` больше одного шарда (`num_layers` &gt; 1), фоновый сброс будет выполняться параллельно для всех шардов в нескольких потоках. [#60111](https://github.com/ClickHouse/ClickHouse/pull/60111) ([alesapin](https://github.com/alesapin)).





#### Улучшение {#improvement-10}

* Когда формат вывода — `Pretty`, и блок состоит из одного числового значения, которое превышает один миллион, читабельное число будет выведено в правой части таблицы. [#60379](https://github.com/ClickHouse/ClickHouse/pull/60379) ([rogeryk](https://github.com/rogeryk)).
* Добавлены настройки `split_parts_ranges_into_intersecting_and_non_intersecting_final` и `split_intersecting_parts_ranges_into_layers_final`. Эти настройки нужны для отключения оптимизаций для запросов с `FINAL` и предназначены только для отладки. [#59705](https://github.com/ClickHouse/ClickHouse/pull/59705) ([Maksim Kita](https://github.com/kitaisreal)). На самом деле не только для этого — они также могут снизить потребление памяти за счёт снижения производительности.
* Переименована настройка `extract_kvp_max_pairs_per_row` в `extract_key_value_pairs_max_pairs_per_row`. Проблема (неоправданное сокращение в имени настройки) появилась в [https://github.com/ClickHouse/ClickHouse/pull/43606](https://github.com/ClickHouse/ClickHouse/pull/43606). Исправлена документация этой настройки. [#59683](https://github.com/ClickHouse/ClickHouse/pull/59683) ([Alexey Milovidov](https://github.com/alexey-milovidov)). [#59960](https://github.com/ClickHouse/ClickHouse/pull/59960) ([jsc0218](https://github.com/jsc0218)).
* Выполнение `ALTER COLUMN MATERIALIZE` для столбца с выражением `DEFAULT` или `MATERIALIZED` теперь точно соответствует их семантике. [#58023](https://github.com/ClickHouse/ClickHouse/pull/58023) ([Duc Canh Le](https://github.com/canhld94)).
* Включена логика экспоненциального backoff при ошибках во время мутаций. Это снизит загрузку CPU, потребление памяти и размер файлов журналов. [#58036](https://github.com/ClickHouse/ClickHouse/pull/58036) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Улучшен подсчёт события профилирования `InitialQuery`. [#58195](https://github.com/ClickHouse/ClickHouse/pull/58195) ([Unalian](https://github.com/Unalian)).
* Добавлена возможность указывать `volume_priority` в `storage_configuration`. [#58533](https://github.com/ClickHouse/ClickHouse/pull/58533) ([Andrey Zvonov](https://github.com/zvonand)).
* Добавлена поддержка типа данных `Date32` в кодеке `T64`. [#58738](https://github.com/ClickHouse/ClickHouse/pull/58738) ([Hongbin Ma](https://github.com/binmahone)).
* Добавлена поддержка завершающих запятых в типах с несколькими элементами. [#59119](https://github.com/ClickHouse/ClickHouse/pull/59119) ([Aleksandr Musorin](https://github.com/AVMusorin)).
* Параметры табличного движка Distributed теперь можно задавать в конфигурационном файле сервера (аналогично настройкам MergeTree), например: `<distributed> <flush_on_detach>false</flush_on_detach> </distributed>`. [#59291](https://github.com/ClickHouse/ClickHouse/pull/59291) ([Azat Khuzhin](https://github.com/azat)).
* Повторять операции чтения при разрывах соединения и истечении срока действия сессий при обращении к `system.zookeeper`. Это полезно при чтении большого числа строк из таблицы `system.zookeeper`, особенно в условиях искусственно вызванных разрывов соединения. [#59388](https://github.com/ClickHouse/ClickHouse/pull/59388) ([Alexander Gololobov](https://github.com/davenger)).
* Не интерпретировать числа с ведущими нулями как числа в восьмеричной системе счисления при `input_format_values_interpret_expressions=0`. [#59403](https://github.com/ClickHouse/ClickHouse/pull/59403) ([Joanna Hulboj](https://github.com/jh0x)).
* При запуске и при каждом изменении конфигурационных файлов ClickHouse обновляет жёсткие ограничения памяти своего общего трекера памяти. Эти ограничения вычисляются на основе различных настроек сервера и лимитов cgroups (в Linux). Ранее путь `/sys/fs/cgroup/memory.max` (для cgroups v2) был жёстко прописан. В результате лимиты памяти cgroup v2, настроенные для вложенных групп (иерархий), например `/sys/fs/cgroup/my/nested/group/memory.max`, игнорировались. Теперь это исправлено. Поведение лимитов памяти v1 осталось без изменений. [#59435](https://github.com/ClickHouse/ClickHouse/pull/59435) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлены новые события профилирования для анализа времени, затраченного на вычисление PK/проекций/вторичных индексов при выполнении операций `INSERT`. [#59436](https://github.com/ClickHouse/ClickHouse/pull/59436) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлена возможность задать начальную точку для S3Queue в режиме Ordered при создании с помощью настройки `s3queue_last_processed_path`. [#59446](https://github.com/ClickHouse/ClickHouse/pull/59446) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Комментарии для системных таблиц теперь также доступны в `system.tables` в `clickhouse-local`. [#59493](https://github.com/ClickHouse/ClickHouse/pull/59493) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Таблица `system.zookeeper`: ранее весь результат накапливался в памяти и возвращался одним большим блоком. Это изменение должно помочь снизить потребление памяти при чтении большого количества строк из `system.zookeeper`, позволит отображать промежуточный прогресс (сколько строк было прочитано на данный момент) и избежать тайм-аута соединения при большом объёме результирующего набора. [#59545](https://github.com/ClickHouse/ClickHouse/pull/59545) ([Alexander Gololobov](https://github.com/davenger)).
* Теперь дашборд поддерживает как сжатое, так и несжатое состояние #hash в URL (обратная совместимость). Продолжение [#59124](https://github.com/ClickHouse/ClickHouse/issues/59124). [#59548](https://github.com/ClickHouse/ClickHouse/pull/59548) ([Amos Bird](https://github.com/amosbird)).
* Обновлена версия Intel QPL (используется кодеком `DEFLATE_QPL`) с v1.3.1 до v1.4.0. Также исправлена ошибка в механизме опроса с тайм‑аутом: в некоторых случаях тайм‑аут мог работать некорректно, и при его срабатывании IAA и CPU могли обрабатывать буфер одновременно. На данный момент лучше дополнительно проверять, что состояние кодека IAA не равно QPL&#95;STS&#95;BEING&#95;PROCESSED, а затем переходить на программный (SW) кодек. [#59551](https://github.com/ClickHouse/ClickHouse/pull/59551) ([jasperzhu](https://github.com/jinjunzh)).
* Не показывать предупреждение о версии сервера в ClickHouse Cloud, поскольку ClickHouse Cloud автоматически выполняет прозрачные обновления. [#59657](https://github.com/ClickHouse/ClickHouse/pull/59657) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* После самоизвлечения временный бинарный файл перемещается, а не копируется. [#59661](https://github.com/ClickHouse/ClickHouse/pull/59661) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена раскрутка стека вызовов на Apple macOS. Это закрывает [#53653](https://github.com/ClickHouse/ClickHouse/issues/53653). [#59690](https://github.com/ClickHouse/ClickHouse/pull/59690) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлена проверка на переполнение стека в парсерах даже в том случае, если пользователь настроил параметр `max_parser_depth` на чрезмерно высокое значение. Это исправляет [#59622](https://github.com/ClickHouse/ClickHouse/issues/59622). [#59697](https://github.com/ClickHouse/ClickHouse/pull/59697) ([Alexey Milovidov](https://github.com/alexey-milovidov)). [#60434](https://github.com/ClickHouse/ClickHouse/pull/60434)
* Унифицировано поведение именованных коллекций, создаваемых через XML и SQL, в хранилище Kafka. [#59710](https://github.com/ClickHouse/ClickHouse/pull/59710) ([Pervakov Grigorii](https://github.com/GrigoryPervakov)).
* В случае, когда `merge_max_block_size_bytes` достаточно мал, а таблицы содержат широкие строки (со строками или кортежами), фоновые слияния могли застревать в бесконечном цикле. Это поведение исправлено. Продолжение к [https://github.com/ClickHouse/ClickHouse/pull/59340](https://github.com/ClickHouse/ClickHouse/pull/59340). [#59812](https://github.com/ClickHouse/ClickHouse/pull/59812) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Разрешить использование uuid в replica&#95;path, если он явно задан в CREATE TABLE. [#59908](https://github.com/ClickHouse/ClickHouse/pull/59908) ([Azat Khuzhin](https://github.com/azat)).
* Добавлен столбец `metadata_version` для таблиц ReplicatedMergeTree в системную таблицу `system.tables`. [#59942](https://github.com/ClickHouse/ClickHouse/pull/59942) ([Maksim Kita](https://github.com/kitaisreal)).
* Улучшение для Keeper: отправлять в Prometheus только метрики и события, относящиеся к Keeper. [#59945](https://github.com/ClickHouse/ClickHouse/pull/59945) ([Antonio Andelic](https://github.com/antonio2368)).
* Панель мониторинга будет отображать метрики в разных версиях ClickHouse, даже если структура системных таблиц изменилась после обновления. [#59967](https://github.com/ClickHouse/ClickHouse/pull/59967) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Разрешить загрузку информации о зонах доступности (AZ) из файла. [#59976](https://github.com/ClickHouse/ClickHouse/pull/59976) ([Konstantин Bogdanov](https://github.com/thevar1able)).
* Улучшение в Keeper: добавлены повторные попытки при сбоях операций, связанных с Disk. [#59980](https://github.com/ClickHouse/ClickHouse/pull/59980) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлен новый параметр конфигурации `backups.remove_backup_files_after_failure`: `<clickhouse> <backups> <remove_backup_files_after_failure>true</remove_backup_files_after_failure> </backups> </clickhouse>`. [#60002](https://github.com/ClickHouse/ClickHouse/pull/60002) ([Vitaly Baranov](https://github.com/vitlibar)).
* Резервный сценарий при копировании файла S3 через GCP — копирование в буфер на случай, если GCP вернул `Internal Error` с HTTP‑кодом `GATEWAY_TIMEOUT`. [#60164](https://github.com/ClickHouse/ClickHouse/pull/60164) ([Maksim Kita](https://github.com/kitaisreal)).
* Укороченное вычисление для `ULIDStringToDateTime`. [#60211](https://github.com/ClickHouse/ClickHouse/pull/60211) ([Juan Madurga](https://github.com/jlmadurga)).
* Для таблиц `system.backups` и `system.backup_log` добавлен столбец `query_id`. В столбец `error` добавлен стек-трейс ошибки. [#60220](https://github.com/ClickHouse/ClickHouse/pull/60220) ([Maksim Kita](https://github.com/kitaisreal)).
* Подключения через MySQL-порт теперь автоматически выполняются с настройкой `prefer_column_name_to_alias = 1`, что позволяет поддерживать QuickSight «из коробки». Также настройки `mysql_map_string_to_text_in_show_columns` и `mysql_map_fixed_string_to_text_in_show_columns` теперь включены по умолчанию и, как и предыдущая, применяются только к подключениям по MySQL. Это повышает совместимость с большим числом BI-инструментов. [#60365](https://github.com/ClickHouse/ClickHouse/pull/60365) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлено состояние гонки в коде JavaScript, из-за которого графики дублировались и накладывались друг на друга. [#60392](https://github.com/ClickHouse/ClickHouse/pull/60392) ([Alexey Milovidov](https://github.com/alexey-milovidov)).



#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-6}
* Добавлены сборки и тесты с интроспективным сбором покрытия. Продолжение [#56102](https://github.com/ClickHouse/ClickHouse/issues/56102). [#58792](https://github.com/ClickHouse/ClickHouse/pull/58792) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Обновлён инструментарий Rust в `corrosion-cmake`, когда задана переменная CMake для кросс-компиляции toolchain. [#59309](https://github.com/ClickHouse/ClickHouse/pull/59309) ([Aris Tritas](https://github.com/aris-aiven)).
* Добавлен фаззинг для ASTLiterals. [#59383](https://github.com/ClickHouse/ClickHouse/pull/59383) ([Raúl Marín](https://github.com/Algunenano)).
* Если вы хотите запускать initdb-скрипты каждый раз при старте контейнера ClickHouse, необходимо установить переменную окружения CLICKHOUSE_ALWAYS_RUN_INITDB_SCRIPTS. [#59808](https://github.com/ClickHouse/ClickHouse/pull/59808) ([Alexander Nikolaev](https://github.com/AlexNik)).
* Удалена возможность отключать базовые компоненты ClickHouse (такие как server/client/...), но сохранены некоторые, которые требуют дополнительных библиотек (такие как ODBC или Keeper). [#59857](https://github.com/ClickHouse/ClickHouse/pull/59857) ([Azat Khuzhin](https://github.com/azat)).
* Query fuzzer теперь фаззит SETTINGS внутри запросов. [#60087](https://github.com/ClickHouse/ClickHouse/pull/60087) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка сборки ClickHouse с clang-19 (master). [#60448](https://github.com/ClickHouse/ClickHouse/pull/60448) ([Alexey Milovidov](https://github.com/alexey-milovidov)).



#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-8}

* Исправлена ошибка «Non-ready set» в TTL WHERE. [#57430](https://github.com/ClickHouse/ClickHouse/pull/57430) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка в функции `quantilesGK` [#58216](https://github.com/ClickHouse/ClickHouse/pull/58216) ([李扬](https://github.com/taiyang-li)).
* Исправлено некорректное поведение `intDiv` для аргументов типа Decimal [#59243](https://github.com/ClickHouse/ClickHouse/pull/59243) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена работа функции `translate` с аргументом типа FixedString [#59356](https://github.com/ClickHouse/ClickHouse/pull/59356) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлен расчёт дайджеста в Keeper [#59439](https://github.com/ClickHouse/ClickHouse/pull/59439) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлены трассировки стека для исполняемых файлов без отладочных символов [#59444](https://github.com/ClickHouse/ClickHouse/pull/59444) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен `ASTAlterCommand::formatImpl` для настроек, задаваемых для отдельных столбцов... [#59445](https://github.com/ClickHouse/ClickHouse/pull/59445) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлена обработка запросов вида `SELECT * FROM [...] ORDER BY ALL` анализатором (Analyzer) [#59462](https://github.com/ClickHouse/ClickHouse/pull/59462) ([zhongyuankai](https://github.com/zhongyuankai)).
* Исправлено возможное необработанное исключение при отмене распределённого запроса [#59487](https://github.com/ClickHouse/ClickHouse/pull/59487) ([Azat Khuzhin](https://github.com/azat)).
* Сделать так, чтобы функция MAX использовала те же правила, что и permutation, для работы со сложными типами данных [#59498](https://github.com/ClickHouse/ClickHouse/pull/59498) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлен граничный случай при передаче `update_insert_deduplication_token_in_dependent_materialized_views` [#59544](https://github.com/ClickHouse/ClickHouse/pull/59544) ([Jordi Villar](https://github.com/jrdi)).
* Исправлен некорректный результат функций arrayElement / map при пустом значении [#59594](https://github.com/ClickHouse/ClickHouse/pull/59594) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено падение topK при слиянии пустых состояний [#59603](https://github.com/ClickHouse/ClickHouse/pull/59603) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена работа распределённой таблицы с фиксированным ключом шардинга [#59606](https://github.com/ClickHouse/ClickHouse/pull/59606) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена проблема в KQL, обнаруженная WingFuzz [#59626](https://github.com/ClickHouse/ClickHouse/pull/59626) ([Yong Wang](https://github.com/kashwy)).
* Исправлена ошибка &quot;Read beyond last offset&quot; для AsynchronousBoundedReadBuffer [#59630](https://github.com/ClickHouse/ClickHouse/pull/59630) ([Vitaly Baranov](https://github.com/vitlibar)).
* Сохранить псевдоним функции в RewriteSumFunctionWithSumAndCountVisitor [#59658](https://github.com/ClickHouse/ClickHouse/pull/59658) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено время начала для неинициирующих запросов [#59662](https://github.com/ClickHouse/ClickHouse/pull/59662) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлена проверка типов аргументов для индекса пропуска `minmax` [#59733](https://github.com/ClickHouse/ClickHouse/pull/59733) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена работа функций leftPad и rightPad с входными данными типа FixedString [#59739](https://github.com/ClickHouse/ClickHouse/pull/59739) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена ошибка AST fuzzer&#39;а в функции `countMatches` [#59752](https://github.com/ClickHouse/ClickHouse/pull/59752) ([Robert Schulze](https://github.com/rschu1ze)).
* RabbitMQ: исправлена ситуация, когда сообщения не подтверждались (ack) и не отклонялись (nack) [#59775](https://github.com/ClickHouse/ClickHouse/pull/59775) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проблема, из-за которой StorageURL выполнял часть обработки запроса в одном потоке [#59833](https://github.com/ClickHouse/ClickHouse/pull/59833) ([Michael Kolupaev](https://github.com/al13n321)).
* S3Queue: исправлена проблема с неинициализированным значением [#59897](https://github.com/ClickHouse/ClickHouse/pull/59897) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен разбор выражений партиционирования, заключённых в скобки [#59901](https://github.com/ClickHouse/ClickHouse/pull/59901) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлена ошибка, вызывавшая сбой в формате JSONColumnsWithMetadata при работе по HTTP [#59925](https://github.com/ClickHouse/ClickHouse/pull/59925) ([Kruglov Pavel](https://github.com/Avogar)).
* Не переписывать sum на count в Analyzer, если возвращаемое значение отличается [#59926](https://github.com/ClickHouse/ClickHouse/pull/59926) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен сбой при чтении UniqExactSet [#59928](https://github.com/ClickHouse/ClickHouse/pull/59928) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправление некорректного значения metadata&#95;version в ReplicatedMergeTree [#59946](https://github.com/ClickHouse/ClickHouse/pull/59946) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена гонка данных в `StorageDistributed` [#59987](https://github.com/ClickHouse/ClickHouse/pull/59987) ([Nikita Taranov](https://github.com/nickitat)).
* Docker: запускать init-скрипты, когда опция включена, а не выключена [#59991](https://github.com/ClickHouse/ClickHouse/pull/59991) ([jktng](https://github.com/jktng)).
* Исправлена операция INSERT в `SQLite` при использовании одинарных кавычек (теперь одинарные кавычки экранируются самой кавычкой, а не обратной косой чертой) [#60015](https://github.com/ClickHouse/ClickHouse/pull/60015) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены несколько логических ошибок в `arrayFold` [#60022](https://github.com/ClickHouse/ClickHouse/pull/60022) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено поведение optimize&#95;uniq&#95;to&#95;count, при котором удалялся псевдоним столбца [#60026](https://github.com/ClickHouse/ClickHouse/pull/60026) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено возможное исключение, которое могло возникнуть в таблице S3Queue при её удалении [#60036](https://github.com/ClickHouse/ClickHouse/pull/60036) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено форматирование `NOT` с отдельными литералами [#60042](https://github.com/ClickHouse/ClickHouse/pull/60042) ([Raúl Marín](https://github.com/Algunenano)).
* Использовать max&#95;query&#95;size из контекста в DDLLogEntry вместо жёстко заданного значения 4096 [#60083](https://github.com/ClickHouse/ClickHouse/pull/60083) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено непоследовательное форматирование запросов, содержащих таблицы с именем `table`. Исправлено неверное форматирование запросов с `UNION ALL`, `INTERSECT` и `EXCEPT`, когда их структура была нелинейной. Это закрывает #52349. Исправлено неверное форматирование запросов `SYSTEM`, включая `SYSTEM ... DROP FILESYSTEM CACHE`, `SYSTEM ... REFRESH/START/STOP/CANCEL/TEST VIEW`, `SYSTEM ENABLE/DISABLE FAILPOINT`. Исправлено форматирование параметризованных DDL‑запросов. Исправлено форматирование запроса `DESCRIBE FILESYSTEM CACHE`. Исправлено некорректное форматирование `SET param_...` (запроса, устанавливающего параметр). Исправлено некорректное форматирование запросов `CREATE INDEX`. Исправлено непоследовательное форматирование запросов `CREATE USER` и аналогичных. Исправлено непоследовательное форматирование `CREATE SETTINGS PROFILE`. Исправлено некорректное форматирование `ALTER ... MODIFY REFRESH`. Исправлено непоследовательное форматирование оконных функций, если смещения фрейма были выражениями. Исправлено непоследовательное форматирование `RESPECT NULLS` и `IGNORE NULLS`, если они использовались после функции, реализующей оператор (например, `plus`). Исправлено идиотское форматирование `SYSTEM SYNC REPLICA ... LIGHTWEIGHT FROM ...`. Исправлено непоследовательное форматирование некорректных запросов с `GROUP BY GROUPING SETS ... WITH ROLLUP/CUBE/TOTALS`. Исправлено непоследовательное форматирование `GRANT CURRENT GRANTS`. Исправлено непоследовательное форматирование `CREATE TABLE (... COLLATE)`. Дополнительно исправлено некорректное форматирование `EXPLAIN` во вложенных запросах (#60102). Исправлено некорректное форматирование лямбда‑функций (#60012). Добавлена проверка, чтобы в будущем не было возможности пропустить подобные уродства. [#60095](https://github.com/ClickHouse/ClickHouse/pull/60095) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено несогласованное форматирование `EXPLAIN` в подзапросах [#60102](https://github.com/ClickHouse/ClickHouse/pull/60102) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлен сбой функции cosineDistance при работе с Nullable [#60150](https://github.com/ClickHouse/ClickHouse/pull/60150) ([Raúl Marín](https://github.com/Algunenano)).
* Разрешено приведение значений типа bool в строковом представлении к значениям типа bool [#60160](https://github.com/ClickHouse/ClickHouse/pull/60160) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлен `system.s3queue_log` [#60166](https://github.com/ClickHouse/ClickHouse/pull/60166) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена работа arrayReduce при использовании допускающего NULL имени агрегатной функции [#60188](https://github.com/ClickHouse/ClickHouse/pull/60188) ([Raúl Marín](https://github.com/Algunenano)).
* Скрытие чувствительной информации для `S3Queue` [#60233](https://github.com/ClickHouse/ClickHouse/pull/60233) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлены коды HTTP-исключений. [#60252](https://github.com/ClickHouse/ClickHouse/pull/60252) ([Austin Kothig](https://github.com/kothiga)).
* S3Queue: исправлена ошибка (также исправлен нестабильный тест test&#95;storage&#95;s3&#95;queue/test.py::test&#95;shards&#95;distributed) [#60282](https://github.com/ClickHouse/ClickHouse/pull/60282) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлены ошибки использования неинициализированного значения и получения некорректного результата в хеширующих функциях для IPv6 [#60359](https://github.com/ClickHouse/ClickHouse/pull/60359) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена проблема в `OptimizeDateOrDateTimeConverterWithPreimageVisitor` при работе с аргументами `null` [#60453](https://github.com/ClickHouse/ClickHouse/pull/60453) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена незначительная ошибка, из-за которой запросы к распределённым таблицам, отправленные клиентами, использующими диалекты KQL или PRQL, не выполнялись на репликах. [#59674](https://github.com/ClickHouse/ClickHouse/issues/59674). [#60470](https://github.com/ClickHouse/ClickHouse/pull/60470) ([Alexey Milovidov](https://github.com/alexey-milovidov)) [#59674](https://github.com/ClickHouse/ClickHouse/pull/59674) ([Austin Kothig](https://github.com/kothiga)).



### <a id="241"></a> Релиз ClickHouse 24.1, 2024-01-30 {#a-id241a-clickhouse-release-241-2024-01-30}

#### Изменения, нарушающие обратную совместимость {#backward-incompatible-change-9}
* Настройка `print_pretty_type_names` теперь включена по умолчанию. Вы можете отключить её, чтобы сохранить прежнее поведение, или выполнить `SET compatibility = '23.12'`. [#57726](https://github.com/ClickHouse/ClickHouse/pull/57726) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Настройка MergeTree `clean_deleted_rows` объявлена устаревшей, она больше ни на что не влияет. Ключевое слово `CLEANUP` для `OPTIMIZE` теперь запрещено по умолчанию (если только не включена настройка `allow_experimental_replacing_merge_with_cleanup`). [#58316](https://github.com/ClickHouse/ClickHouse/pull/58316) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Функция `reverseDNSQuery` больше недоступна. Это закрывает задачу [#58368](https://github.com/ClickHouse/ClickHouse/issues/58368). [#58369](https://github.com/ClickHouse/ClickHouse/pull/58369) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Включены различные изменения для улучшения контроля доступа в конфигурационном файле. Эти изменения влияют на поведение системы, и вам следует проверить `config.xml` в разделе `access_control_improvements`. Если вы не уверены, сохраните значения в конфигурационном файле такими же, как в предыдущей версии. [#58584](https://github.com/ClickHouse/ClickHouse/pull/58584) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшена работа `sumMapFiltered` со значениями NaN. Значения NaN теперь помещаются в конец (вместо случайного порядка) и считаются отличными от любых других значений. `-0` теперь также считается равным `0`; так как значения 0 отбрасываются, значения `-0` также отбрасываются. [#58959](https://github.com/ClickHouse/ClickHouse/pull/58959) ([Raúl Marín](https://github.com/Algunenano)).
* Функция `visibleWidth` теперь будет вести себя в соответствии с документацией. В предыдущих версиях она просто подсчитывала кодовые точки после сериализации строки, как функция `lengthUTF8`, но не учитывала символы нулевой ширины и комбинирующие символы, полноширинные символы, табуляции и символы удаления. Теперь поведение изменено соответствующим образом. Если вы хотите сохранить старое поведение, установите `function_visible_width_behavior` в значение `0` или задайте `compatibility` равным `23.12` или ниже. [#59022](https://github.com/ClickHouse/ClickHouse/pull/59022) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Диалект `Kusto` отключён до тех пор, пока не будут исправлены следующие две ошибки: [#59037](https://github.com/ClickHouse/ClickHouse/issues/59037) и [#59036](https://github.com/ClickHouse/ClickHouse/issues/59036). [#59305](https://github.com/ClickHouse/ClickHouse/pull/59305) ([Alexey Milovidov](https://github.com/alexey-milovidov)). Любая попытка использовать `Kusto` приведёт к исключению.
* Более эффективная реализация модификатора `FINAL` больше не гарантирует сохранение порядка даже при `max_threads = 1`. Если вы рассчитывали на предыдущее поведение, установите `enable_vertical_final` в значение 0 или `compatibility` в `23.12`.



#### Новая возможность {#new-feature-11}

* Реализован тип данных Variant, представляющий собой объединение других типов данных. Тип `Variant(T1, T2, ..., TN)` означает, что каждая строка этого типа содержит значение одного из типов `T1`, `T2`, ..., `TN` либо ни одного из них (значение `NULL`). Тип Variant доступен при включённой настройке `allow_experimental_variant_type`. Ссылка: [#54864](https://github.com/ClickHouse/ClickHouse/issues/54864). [#58047](https://github.com/ClickHouse/ClickHouse/pull/58047) ([Kruglov Pavel](https://github.com/Avogar)).
* Некоторые настройки (в настоящее время `min_compress_block_size` и `max_compress_block_size`) теперь можно задавать на уровне столбца; в этом случае они имеют приоритет над соответствующими настройками на уровне таблицы. Пример: `CREATE TABLE tab (col String SETTINGS (min_compress_block_size = 81920, max_compress_block_size = 163840)) ENGINE = MergeTree ORDER BY tuple();`. [#55201](https://github.com/ClickHouse/ClickHouse/pull/55201) ([Duc Canh Le](https://github.com/canhld94)).
* Добавлена агрегатная функция `quantileDD`, а также соответствующие функции `quantilesDD` и `medianDD`. Она основана на DDSketch [https://www.vldb.org/pvldb/vol12/p2195-masson.pdf](https://www.vldb.org/pvldb/vol12/p2195-masson.pdf). ### Запись в документации для изменений, заметных пользователям. [#56342](https://github.com/ClickHouse/ClickHouse/pull/56342) ([Srikanth Chekuri](https://github.com/srikanthccv)).
* Позволяет настроить любое объектное хранилище с любым типом метаданных. [#58357](https://github.com/ClickHouse/ClickHouse/pull/58357) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлены режимы `null_status_on_timeout_only_active` и `throw_only_active` для `distributed_ddl_output_mode`, позволяющие не дожидаться неактивных реплик. [#58350](https://github.com/ClickHouse/ClickHouse/pull/58350) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Добавлена функция `arrayShingles`, которая вычисляет подмассивы, например: `arrayShingles([1, 2, 3, 4, 5], 3)` возвращает `[[1,2,3],[2,3,4],[3,4,5]]`. [#58396](https://github.com/ClickHouse/ClickHouse/pull/58396) ([Zheng Miao](https://github.com/zenmiao7)).
* Добавлены функции `punycodeEncode`, `punycodeDecode`, `idnaEncode` и `idnaDecode`, которые полезны для преобразования интернационализированных доменных имён (IDN) в ASCII-представление в соответствии со стандартом IDNA. [#58454](https://github.com/ClickHouse/ClickHouse/pull/58454) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлены функции вычисления схожести строк `dramerauLevenshteinDistance`, `jaroSimilarity` и `jaroWinklerSimilarity`. [#58531](https://github.com/ClickHouse/ClickHouse/pull/58531) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлены два параметра настройки: `output_format_compression_level` для изменения уровня сжатия вывода и `output_format_compression_zstd_window_log` для явного задания размера окна сжатия и включения режима long-range для сжатия zstd, если в качестве метода сжатия вывода используется `zstd`. Применяется для `INTO OUTFILE` и при записи в табличные функции `file`, `url`, `hdfs`, `s3` и `azureBlobStorage`. [#58539](https://github.com/ClickHouse/ClickHouse/pull/58539) ([Duc Canh Le](https://github.com/canhld94)).
* Автоматически отключать управляющие последовательности ANSI в форматах Pretty, если вывод идет не в терминал. Добавлен новый режим `auto` для настройки `output_format_pretty_color`. [#58614](https://github.com/ClickHouse/ClickHouse/pull/58614) ([Shaun Struwig](https://github.com/Blargian)).
* Добавлена функция `sqidDecode`, которая декодирует [Sqids](https://sqids.org/). [#58544](https://github.com/ClickHouse/ClickHouse/pull/58544) ([Robert Schulze](https://github.com/rschu1ze)).
* Во входных форматах JSON теперь можно считывать значения типа Bool как строковый тип String. Это реализовано настройкой `input_format_json_read_bools_as_strings`, которая включена по умолчанию. [#58561](https://github.com/ClickHouse/ClickHouse/pull/58561) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена функция `seriesDecomposeSTL`, которая разлагает временной ряд на сезонную, трендовую и остаточную компоненты. [#57078](https://github.com/ClickHouse/ClickHouse/pull/57078) ([Bhavna Jindal](https://github.com/bhavnajindal)).
* Добавлен MySQL Binlog Client для MaterializedMySQL: одно подключение к binlog’у сразу для многих баз данных. [#57323](https://github.com/ClickHouse/ClickHouse/pull/57323) ([Val Doroshchuk](https://github.com/valbok)).
* Технология Intel QuickAssist (QAT) обеспечивает аппаратно ускоренное сжатие и криптографические операции. В ClickHouse появился новый кодек сжатия `ZSTD_QAT`, который использует QAT для сжатия с помощью zstd. Кодек использует [QATlib от Intel](https://github.com/intel/qatlib) и [QAT ZSTD Plugin от Intel](https://github.com/intel/QAT-ZSTD-Plugin). В данный момент только сжатие может быть аппаратно ускорено (при невозможности инициализации QAT задействуется программная реализация), декомпрессия всегда выполняется программно. [#57509](https://github.com/ClickHouse/ClickHouse/pull/57509) ([jasperzhu](https://github.com/jinjunzh)).
* Реализован новый способ формирования ключей объектного хранилища для дисков S3. Теперь формат можно задать в терминах синтаксиса регулярных выражений `re2` с помощью опции `key_template` в описании диска. [#57663](https://github.com/ClickHouse/ClickHouse/pull/57663) ([Sema Checherinda](https://github.com/CheSema)).
* Таблица system.dropped&#95;tables&#95;parts содержит парты таблиц из system.dropped&#95;tables (удалённые, но ещё не очищенные таблицы). [#58038](https://github.com/ClickHouse/ClickHouse/pull/58038) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Добавлена настройка `max_materialized_views_size_for_table` для ограничения количества материализованных представлений, привязанных к таблице. [#58068](https://github.com/ClickHouse/ClickHouse/pull/58068) ([zhongyuankai](https://github.com/zhongyuankai)).
* Улучшения `clickhouse-format`: поддержка запросов INSERT с `VALUES`; поддержка комментариев (используйте `--comments` для их вывода); поддержка опции `--max_line_length` для форматирования только длинных запросов в несколько строк. [#58246](https://github.com/ClickHouse/ClickHouse/pull/58246) ([vdimir](https://github.com/vdimir)).
* В `clickhouse-local` подключаются все системные таблицы, включая `system.parts`. Это закрывает [#58312](https://github.com/ClickHouse/ClickHouse/issues/58312). [#58359](https://github.com/ClickHouse/ClickHouse/pull/58359) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Поддержка типов данных `Enum` в функции `transform`. Это закрывает [#58241](https://github.com/ClickHouse/ClickHouse/issues/58241). [#58360](https://github.com/ClickHouse/ClickHouse/pull/58360) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена таблица `system.database_engines`. [#58390](https://github.com/ClickHouse/ClickHouse/pull/58390) ([Bharat Nallan](https://github.com/bharatnc)). Добавлена возможность независимой регистрации движков баз данных в кодовой базе. [#58365](https://github.com/ClickHouse/ClickHouse/pull/58365) ([Bharat Nallan](https://github.com/bharatnc)). Добавлена возможность независимой регистрации интерпретаторов. [#58443](https://github.com/ClickHouse/ClickHouse/pull/58443) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлен модификатор `FROM <Replicas>` для запроса `SYSTEM SYNC REPLICA LIGHTWEIGHT`. Модификатор `FROM` гарантирует, что ожидание выборок и удаления диапазонов происходит только для указанных исходных реплик, а также для любых реплик, отсутствующих в ZooKeeper или с пустым полем source&#95;replica. [#58393](https://github.com/ClickHouse/ClickHouse/pull/58393) ([Jayme Bird](https://github.com/jaymebrd)).
* Добавлена настройка `update_insert_deduplication_token_in_dependent_materialized_views`. Эта настройка позволяет при вставке в зависимые материализованные представления обновлять токен дедупликации вставок на основе идентификатора таблицы. Закрывает [#59165](https://github.com/ClickHouse/ClickHouse/issues/59165). [#59238](https://github.com/ClickHouse/ClickHouse/pull/59238) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлен оператор `SYSTEM RELOAD ASYNCHRONOUS METRICS`, который обновляет асинхронные метрики. Прежде всего полезен для тестирования и разработки. [#53710](https://github.com/ClickHouse/ClickHouse/pull/53710) ([Robert Schulze](https://github.com/rschu1ze)).





#### Повышение производительности {#performance-improvement-11}

* Координационный механизм для параллельных реплик переработан для улучшения параллелизма и локальности кэша. Он был протестирован и показал линейную масштабируемость на сотнях реплик. Также добавлена поддержка чтения в заданном порядке. [#57968](https://github.com/ClickHouse/ClickHouse/pull/57968) ([Nikita Taranov](https://github.com/nickitat)).
* Заменить буферизацию исходящих HTTP-запросов на встроенные буферы ClickHouse. Добавить метрики объёма переданных байт для интерфейсов. [#56064](https://github.com/ClickHouse/ClickHouse/pull/56064) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Большие агрегатные состояния функции `uniqExact` будут параллельно объединяться в распределённых запросах. [#59009](https://github.com/ClickHouse/ClickHouse/pull/59009) ([Nikita Taranov](https://github.com/nickitat)).
* Снижено потребление памяти после чтения из таблиц `MergeTree`. [#59290](https://github.com/ClickHouse/ClickHouse/pull/59290) ([Anton Popov](https://github.com/CurtizJ)).
* Снижено потребление памяти при вертикальных слияниях. [#59340](https://github.com/ClickHouse/ClickHouse/pull/59340) ([Anton Popov](https://github.com/CurtizJ)).
* Для большего числа сценариев предотвращено чрезмерное потребление памяти при запуске Keeper. [#58455](https://github.com/ClickHouse/ClickHouse/pull/58455) ([Antonio Andelic](https://github.com/antonio2368)).
* Оптимизация Keeper: снижено потребление памяти при хранении узлов. [#59002](https://github.com/ClickHouse/ClickHouse/pull/59002) ([Antonio Andelic](https://github.com/antonio2368)).
* Окончательная реализация, более эффективная с точки зрения кэша. Замечание об изменении поведения: ранее запросы с модификатором `FINAL`, выполняемые в одном потоке (например, `max_threads = 1`), выдавали отсортированный результат без явно указанного предложения `ORDER BY`. При включённой настройке `enable_vertical_final = true` (а по умолчанию она включена) это больше не гарантируется. [#54366](https://github.com/ClickHouse/ClickHouse/pull/54366) ([Duc Canh Le](https://github.com/canhld94)).
* Исключено дополнительное копирование в `ReadBufferFromIStream`, который используется, например, при чтении из S3. [#56961](https://github.com/ClickHouse/ClickHouse/pull/56961) ([Nikita Taranov](https://github.com/nickitat)).
* Оптимизирована функция работы с элементами массива, когда входными данными являются Array(Map)/Array(Array(Num))/Array(Array(String))/Array(BigInt)/Array(Decimal). Предыдущая реализация выполняла больше выделений памяти, чем было необходимо. Оптимизация даёт ускорение до ~6 раз, особенно когда тип входных данных — Array(Map). [#56403](https://github.com/ClickHouse/ClickHouse/pull/56403) ([李扬](https://github.com/taiyang-li)).
* Однократное чтение столбца при чтении нескольких его подстолбцов в компактных частях. [#57631](https://github.com/ClickHouse/ClickHouse/pull/57631) ([Kruglov Pavel](https://github.com/Avogar)).
* Переписать AST функции `sum(column + constant)`. Это доступно в виде этапа оптимизации в Analyzer [#57853](https://github.com/ClickHouse/ClickHouse/pull/57853) ([Jiebin Sun](https://github.com/jiebinn)).
* Выполнение функции `match` теперь использует пропускающие индексы `ngrambf_v1` и `tokenbf_v1`. [#57882](https://github.com/ClickHouse/ClickHouse/pull/57882) ([凌涛](https://github.com/lingtaolf)).
* Теперь при вычислении функции `match` используются инвертированные индексы. [#58284](https://github.com/ClickHouse/ClickHouse/pull/58284) ([凌涛](https://github.com/lingtaolf)).
* `FINAL` в MergeTree не сравнивает строки из одной и той же части, не относящейся к уровню L0. [#58142](https://github.com/ClickHouse/ClickHouse/pull/58142) ([Duc Canh Le](https://github.com/canhld94)).
* Ускорены вызовы функции iota (заполнение массива последовательными числами). [#58271](https://github.com/ClickHouse/ClickHouse/pull/58271) ([Raúl Marín](https://github.com/Algunenano)).
* Ускорена работа функций MIN/MAX для нечисловых типов. [#58334](https://github.com/ClickHouse/ClickHouse/pull/58334) ([Raúl Marín](https://github.com/Algunenano)).
* Оптимизирована комбинация фильтров (как в многошаговом PREWHERE) с использованием интринсиков BMI2/SSE [#58800](https://github.com/ClickHouse/ClickHouse/pull/58800) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
* В `clickhouse-local` используется на один поток меньше. [#58968](https://github.com/ClickHouse/ClickHouse/pull/58968) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшена производительность функции `multiIf` для типов Nullable. [#57745](https://github.com/ClickHouse/ClickHouse/pull/57745) ([KevinyhZou](https://github.com/KevinyhZou)).
* Добавлена команда `SYSTEM JEMALLOC PURGE` для очистки неиспользуемых страниц jemalloc, а также `SYSTEM JEMALLOC [ ENABLE | DISABLE | FLUSH ] PROFILE` для управления профилем jemalloc при включённом профилировщике. Добавлена команда 4LW в Keeper, связанная с jemalloc: `jmst` для дампа статистики jemalloc, `jmfp`, `jmep`, `jmdp` для управления профилем jemalloc при включённом профилировщике. [#58665](https://github.com/ClickHouse/ClickHouse/pull/58665) ([Antonio Andelic](https://github.com/antonio2368)).
* Снижено потребление памяти при создании резервных копий в S3. [#58962](https://github.com/ClickHouse/ClickHouse/pull/58962) ([Vitaly Baranov](https://github.com/vitlibar)).





#### Улучшение {#improvement-11}

* Добавлены комментарии (краткие описания) ко всем столбцам системных таблиц. На это есть несколько причин: - Мы очень активно используем системные таблицы, и иногда разработчику бывает очень сложно понять назначение и смысл конкретного столбца. - Мы часто меняем системные таблицы (добавляем новые или модифицируем существующие), и документация по ним постоянно устаревает. Например, посмотрите на страницу документации для [`system.parts`](/operations/system-tables/parts). В ней отсутствует множество столбцов. - В перспективе мы хотим генерировать документацию напрямую из ClickHouse. [#58356](https://github.com/ClickHouse/ClickHouse/pull/58356) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Разрешены запросы без указания алиасов для подзапросов в `PASTE JOIN`. [#58654](https://github.com/ClickHouse/ClickHouse/pull/58654) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Включена интеграция с `MySQL`/`MariaDB` на macOS. Это закрывает [#21191](https://github.com/ClickHouse/ClickHouse/issues/21191). [#46316](https://github.com/ClickHouse/ClickHouse/pull/46316) ([Alexey Milovidov](https://github.com/alexey-milovidov)) ([Robert Schulze](https://github.com/rschu1ze)).
* По умолчанию параметр `max_rows_in_set_to_optimize_join` теперь отключён. [#56396](https://github.com/ClickHouse/ClickHouse/pull/56396) ([vdimir](https://github.com/vdimir)).
* Добавлен параметр конфигурации `<host_name>`, который позволяет избежать необходимости разрешать имена хостов в запросах ON CLUSTER DDL и в реплицируемых движках баз данных. Это уменьшает вероятность зависания очереди в случае изменения определения кластера. Закрывает [#57573](https://github.com/ClickHouse/ClickHouse/issues/57573). [#57603](https://github.com/ClickHouse/ClickHouse/pull/57603) ([Nikolay Degterinsky](https://github.com/evillique)).
* Увеличьте `load_metadata_threads` до 16 для кэша файловой системы. Это ускорит запуск сервера. [#57732](https://github.com/ClickHouse/ClickHouse/pull/57732) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность ограничивать скорость слияний и мутаций (`max_mutations_bandwidth_for_server`/`max_merges_bandwidth_for_server`). [#57877](https://github.com/ClickHouse/ClickHouse/pull/57877) ([Azat Khuzhin](https://github.com/azat)).
* Недокументированный ранее столбец логического типа `is_hot_reloadable` в системной таблице `system.server_settings` заменён на столбец типа Enum8 `changeable_without_restart` с возможными значениями `No`, `Yes`, `IncreaseOnly` и `DecreaseOnly`. Столбец также задокументирован. [#58029](https://github.com/ClickHouse/ClickHouse/pull/58029) ([skyoct](https://github.com/skyoct)).
* В механизме обнаружения кластера добавлена поддержка указания имени пользователя и пароля, закрыта задача [#58063](https://github.com/ClickHouse/ClickHouse/issues/58063). [#58123](https://github.com/ClickHouse/ClickHouse/pull/58123) ([vdimir](https://github.com/vdimir)).
* Добавлена поддержка параметров запроса в `ALTER TABLE ... PART`. [#58297](https://github.com/ClickHouse/ClickHouse/pull/58297) ([Azat Khuzhin](https://github.com/azat)).
* Создавать консьюмеры для таблиц Kafka динамически (но сохранять их на некоторый период — `kafka_consumers_pool_ttl_ms` с момента последнего использования). Это должно исправить проблему со статистикой для `system.kafka_consumers` (которая не обновлялась, когда никто не читал из таблицы Kafka, что приводило к утечке памяти и медленному отсоединению таблицы), а также этот PR снова включает статистику для `system.kafka_consumers` по умолчанию. [#58310](https://github.com/ClickHouse/ClickHouse/pull/58310) ([Azat Khuzhin](https://github.com/azat)).
* `sparkBar` в качестве псевдонима для `sparkbar`. [#58335](https://github.com/ClickHouse/ClickHouse/pull/58335) ([凌涛](https://github.com/lingtaolf)).
* Не отправляйте запросы `ComposeObject` после загрузки в `GCS`. [#58343](https://github.com/ClickHouse/ClickHouse/pull/58343) ([Azat Khuzhin](https://github.com/azat)).
* Корректно обрабатываются ключи с точкой в названии в XML-конфигурациях. [#58354](https://github.com/ClickHouse/ClickHouse/pull/58354) ([Azat Khuzhin](https://github.com/azat)).
* Функция `format` теперь возвращает константу при константных аргументах. Это закрывает [#58355](https://github.com/ClickHouse/ClickHouse/issues/58355). [#58358](https://github.com/ClickHouse/ClickHouse/pull/58358) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена отдельная настройка `max_estimated_execution_time`, отличная от `max_execution_time`. [#58402](https://github.com/ClickHouse/ClickHouse/pull/58402) ([Zhang Yifan](https://github.com/zhangyifan27)).
* Теперь выводится подсказка при использовании недопустимого имени движка базы данных. [#58444](https://github.com/ClickHouse/ClickHouse/pull/58444) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлены настройки для более точного контроля типа индексов в словаре Arrow. По умолчанию для индексов используется знаковый целочисленный тип в соответствии с рекомендациями Arrow. Закрывает [#57401](https://github.com/ClickHouse/ClickHouse/issues/57401). [#58519](https://github.com/ClickHouse/ClickHouse/pull/58519) ([Kruglov Pavel](https://github.com/Avogar)).
* Реализована поддержка переменной окружения `CLICKHOUSE_PASSWORD_FILE` при запуске docker-образа ([#58575](https://github.com/ClickHouse/ClickHouse/issues/58575)). [#58583](https://github.com/ClickHouse/ClickHouse/pull/58583) ([Eyal Halpern Shalev](https://github.com/Eyal-Shalev)).
* При выполнении некоторых запросов, которым требуется много потоков для чтения данных, ранее возникала ошибка `"Paste JOIN requires sorted tables only"`. Теперь в таком случае количество потоков устанавливается равным 1. [#58608](https://github.com/ClickHouse/ClickHouse/pull/58608) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Улучшено сообщение об ошибке INVALID&#95;IDENTIFIER. [#58703](https://github.com/ClickHouse/ClickHouse/pull/58703) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Улучшена обработка числовых литералов со знаком в normalizeQuery. [#58710](https://github.com/ClickHouse/ClickHouse/pull/58710) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Добавлена поддержка типа данных Point в MySQL. [#58721](https://github.com/ClickHouse/ClickHouse/pull/58721) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Теперь при сравнении столбца типа Float32 и строковой константы строка читается как Float32 (вместо Float64). [#58724](https://github.com/ClickHouse/ClickHouse/pull/58724) ([Raúl Marín](https://github.com/Algunenano)).
* Улучшена совместимость с S3, добавлена поддержка хранилища ECloud EOS. [#58786](https://github.com/ClickHouse/ClickHouse/pull/58786) ([xleoken](https://github.com/xleoken)).
* Разрешить `KILL QUERY` отменять операции резервного копирования и восстановления. Этот PR также делает выполняющиеся операции резервного копирования и восстановления видимыми в `system.processes`. Кроме того, в конфигурации сервера появился новый параметр — `shutdown_wait_backups_and_restores` (по умолчанию true), который при завершении работы сервера заставляет его либо ждать окончания всех выполняющихся операций резервного копирования и восстановления, либо просто отменять их. [#58804](https://github.com/ClickHouse/ClickHouse/pull/58804) ([Vitaly Baranov](https://github.com/vitlibar)).
* Формат Avro с поддержкой кодека ZSTD. Закрывает [#58735](https://github.com/ClickHouse/ClickHouse/issues/58735). [#58805](https://github.com/ClickHouse/ClickHouse/pull/58805) ([flynn](https://github.com/ucasfl)).
* Интерфейс MySQL получил поддержку настроек `net_write_timeout` и `net_read_timeout`. `net_write_timeout` транслируется в соответствующую настройку ClickHouse `send_timeout`, а `net_read_timeout` — в `receive_timeout`. Исправлена проблема, из-за которой настройку MySQL `sql_select_limit` можно было задать только в том случае, если весь запрос был написан в верхнем регистре. [#58835](https://github.com/ClickHouse/ClickHouse/pull/58835) ([Serge Klochkov](https://github.com/slvrtrn)).
* Более информативное сообщение об исключении при конфликте между словарём и таблицей с одинаковым именем. [#58841](https://github.com/ClickHouse/ClickHouse/pull/58841) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Убедитесь, что для пользовательских дисков (созданных через SQL) в конфигурации сервера указано либо `filesystem_caches_path` (общий префикс каталога для всех кэшей файловой системы), либо `custom_cached_disks_base_directory` (общий префикс каталога только для кэшей файловой системы, созданных для пользовательских дисков). `custom_cached_disks_base_directory` имеет более высокий приоритет для пользовательских дисков по сравнению с `filesystem_caches_path`; в противном случае используется `filesystem_caches_path`. Параметр кэша файловой системы `path` должен указывать путь внутри этого каталога, в противном случае будет сгенерировано исключение, не позволяющее создать диск. Это не затронет диски, которые были созданы в более старой версии и затем сервер был обновлён — в этом случае исключение выброшено не будет, чтобы дать серверу возможность успешно запуститься. `custom_cached_disks_base_directory` добавлен в конфигурацию сервера по умолчанию в виде `/var/lib/clickhouse/caches/`. Закрывает [#57825](https://github.com/ClickHouse/ClickHouse/issues/57825). [#58869](https://github.com/ClickHouse/ClickHouse/pull/58869) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Интерфейс MySQL получил поддержку запросов `SHOW WARNINGS`/`SHOW COUNT(*) WARNINGS`, хотя возвращаемый результат всегда представляет собой пустой набор. [#58929](https://github.com/ClickHouse/ClickHouse/pull/58929) ([Serge Klochkov](https://github.com/slvrtrn)).
* Пропускать недоступные реплики при выполнении параллельного распределённого `INSERT SELECT`. [#58931](https://github.com/ClickHouse/ClickHouse/pull/58931) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Отображать текстовое название уровня логирования при включённом структурированном формате логов в JSON. [#58936](https://github.com/ClickHouse/ClickHouse/pull/58936) ([Tim Liou](https://github.com/wheatdog)).
* Интерфейс MySQL получил поддержку выражений `CAST(x AS SIGNED)` и `CAST(x AS UNSIGNED)` посредством псевдонимов типов данных: `SIGNED` для Int64 и `UNSIGNED` для UInt64. Это повышает совместимость с инструментами BI, такими как Looker Studio. [#58954](https://github.com/ClickHouse/ClickHouse/pull/58954) ([Serge Klochkov](https://github.com/slvrtrn)).
* Изменить рабочий каталог на путь к данным в контейнере Docker. [#58975](https://github.com/ClickHouse/ClickHouse/pull/58975) ([cangyin](https://github.com/cangyin)).
* Добавлен параметр для Azure Blob Storage `azure_max_unexpected_write_error_retries`, который также можно задать в конфигурации в секции `azure`. [#59001](https://github.com/ClickHouse/ClickHouse/pull/59001) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Разрешён запуск сервера, даже если таблица data lake повреждена. Закрывает [#58625](https://github.com/ClickHouse/ClickHouse/issues/58625). [#59080](https://github.com/ClickHouse/ClickHouse/pull/59080) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Позволяет игнорировать эволюцию схемы в движке таблиц `Iceberg` и читать все данные, используя схему, указанную пользователем при создании таблицы, или последнюю схему, полученную из метаданных при создании таблицы. Это реализовано с помощью настройки `iceberg_engine_ignore_schema_evolution`, которая по умолчанию отключена. Обратите внимание, что включение этой настройки может привести к некорректным результатам, так как при эволюции схемы все файлы данных будут читаться, используя одну и ту же схему. [#59133](https://github.com/ClickHouse/ClickHouse/pull/59133) ([Kruglov Pavel](https://github.com/Avogar)).
* Запретить изменяющие операции (`INSERT`/`ALTER`/`OPTIMIZE`/...) на хранилищах только для чтения/одноразовой записи с выдачей корректной ошибки `TABLE_IS_READ_ONLY` (во избежание остатков данных). Не допускать появления остатков на дисках с одноразовой записью (`format_version.txt`) при выполнении `CREATE`/`ATTACH`. Игнорировать `DROP` для `ReplicatedMergeTree` (так же, как для `MergeTree`). Исправить итерацию по `s3_plain` (`MetadataStorageFromPlainObjectStorage::iterateDirectory`). Учтите, что диск только для чтения — это `web`, а диск с одноразовой записью — это `s3_plain`. [#59170](https://github.com/ClickHouse/ClickHouse/pull/59170) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка в экспериментальном столбце `_block_number`, которая могла приводить к логической ошибке при сложной комбинации операций `ALTER` и `MERGE`. Исправляет [#56202](https://github.com/ClickHouse/ClickHouse/issues/56202). Заменяет [#58601](https://github.com/ClickHouse/ClickHouse/issues/58601). [#59295](https://github.com/ClickHouse/ClickHouse/pull/59295) ([alesapin](https://github.com/alesapin)).
* Интерфейс Play UI теперь корректно обрабатывает случаи, когда исключение возвращается в формате JSON. Корректировка для [#52853](https://github.com/ClickHouse/ClickHouse/issues/52853). [#59303](https://github.com/ClickHouse/ClickHouse/pull/59303) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* HTTP-обработчик `/binary` позволяет указать пользователя, хост и, при необходимости, пароль в строке запроса. [#59311](https://github.com/ClickHouse/ClickHouse/pull/59311) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Реализована поддержка резервного копирования для сжатых таблиц в памяти. Это закрывает [#57893](https://github.com/ClickHouse/ClickHouse/issues/57893). [#59315](https://github.com/ClickHouse/ClickHouse/pull/59315) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Реализована поддержка предложения `FORMAT` в запросах `BACKUP` и `RESTORE`. [#59338](https://github.com/ClickHouse/ClickHouse/pull/59338) ([Vitaly Baranov](https://github.com/vitlibar)).
* Функция `concatWithSeparator` теперь поддерживает аргументы произвольных типов (а не только аргументы типов `String` и `FixedString`). Например, теперь `SELECT concatWithSeparator('.', 'number', 1)` возвращает `number.1`. [#59341](https://github.com/ClickHouse/ClickHouse/pull/59341) ([Robert Schulze](https://github.com/rschu1ze)).



#### Улучшение сборки/тестирования/упаковки {#buildtestingpackaging-improvement-7}
* Улучшены алиасы для бинарника clickhouse (теперь `ch`/`clickhouse` — это `clickhouse-local` или `clickhouse` в зависимости от аргументов) и добавлено автодополнение bash для новых алиасов. [#58344](https://github.com/ClickHouse/ClickHouse/pull/58344) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена проверка изменений настроек в CI, чтобы убедиться, что все изменения настроек отражены в истории изменений настроек. [#58555](https://github.com/ClickHouse/ClickHouse/pull/58555) ([Kruglov Pavel](https://github.com/Avogar)).
* Теперь в stateful-тестах используются таблицы, напрямую подключённые из S3. [#58791](https://github.com/ClickHouse/ClickHouse/pull/58791) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сохраняется весь `fuzzer.log` как архив вместо последних 100k строк. `tail -n 100000` часто удаляет строки с определениями таблиц. Например. [#58821](https://github.com/ClickHouse/ClickHouse/pull/58821) ([Dmitry Novik](https://github.com/novikd)).
* Включена поддержка Rust на macOS с Aarch64 (это добавит нечёткий поиск в клиенте с помощью skim и язык PRQL, хотя я не думаю, что есть люди, которые хостят ClickHouse на darwin, так что, по сути, это в основном для нечёткого поиска в клиенте). [#59272](https://github.com/ClickHouse/ClickHouse/pull/59272) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема агрегации в смешанных кластерах x86_64 и ARM. [#59132](https://github.com/ClickHouse/ClickHouse/pull/59132) ([Harry Lee](https://github.com/HarryLeeIBM)).

#### Исправление ошибки (заметное пользователю некорректное поведение в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-9}



* Добавлено преобразование ключей соединения для вложенных типов LowCardinality [#51550](https://github.com/ClickHouse/ClickHouse/pull/51550) ([vdimir](https://github.com/vdimir)).
* Разворачивать при flatten&#95;nested=1 только собственно тип Nested, а не все Array(Tuple) [#56132](https://github.com/ClickHouse/ClickHouse/pull/56132) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка с проекциями и настройкой `aggregate_functions_null_for_empty` при вставке. [#56944](https://github.com/ClickHouse/ClickHouse/pull/56944) ([Amos Bird](https://github.com/amosbird)).
* Исправлено потенциальное исключение из-за устаревшего UUID профиля [#57263](https://github.com/ClickHouse/ClickHouse/pull/57263) ([Vasily Nemkov](https://github.com/Enmk)).
* Исправлена обработка буферов чтения в StreamingFormatExecutor [#57438](https://github.com/ClickHouse/ClickHouse/pull/57438) ([Kruglov Pavel](https://github.com/Avogar)).
* Игнорировать материализованные представления (MV) с удалённой целевой таблицей при проталкивании в представления [#57520](https://github.com/ClickHouse/ClickHouse/pull/57520) ([Круглов Павел](https://github.com/Avogar)).
* Устранена возможная гонка между ALTER&#95;METADATA и MERGE&#95;PARTS [#57755](https://github.com/ClickHouse/ClickHouse/pull/57755) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка порядка выражений в операторе `GROUP BY` с `ROLLUP` [#57786](https://github.com/ClickHouse/ClickHouse/pull/57786) ([Chen768959](https://github.com/Chen768959)).
* Исправление устаревшей функции репликации «zero-copy»: устранена потеря BLOB-объектов после удаления реплики с повреждёнными отсоединёнными частями [#58333](https://github.com/ClickHouse/ClickHouse/pull/58333) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Разрешить пользователям работать с символическими ссылками в user&#95;files&#95;path [#58447](https://github.com/ClickHouse/ClickHouse/pull/58447) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлено падение при отсутствии функции агрегации у таблицы Graphite [#58453](https://github.com/ClickHouse/ClickHouse/pull/58453) ([Duc Canh Le](https://github.com/canhld94)).
* Добавлена задержка чтения из StorageKafka, чтобы разрешить многократное чтение в материализованных представлениях [#58477](https://github.com/ClickHouse/ClickHouse/pull/58477) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Исправлен дурацкий случай пересечения частей [#58482](https://github.com/ClickHouse/ClickHouse/pull/58482) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Отключён MergeTreePrefetchedReadPool для запросов, содержащих только LIMIT [#58505](https://github.com/ClickHouse/ClickHouse/pull/58505) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена возможность использования обычных баз данных во время восстановления [#58520](https://github.com/ClickHouse/ClickHouse/pull/58520) ([Jihyuk Bok](https://github.com/tomahawk28)).
* Исправлено чтение ORC/Parquet/... с использованием пула потоков Apache Hive [#58537](https://github.com/ClickHouse/ClickHouse/pull/58537) ([sunny](https://github.com/sunny19930321)).
* Скрыть учётные данные в столбце `base_backup_name` таблицы `system.backup_log` [#58550](https://github.com/ClickHouse/ClickHouse/pull/58550) ([Daniel Pozo Escalona](https://github.com/danipozo)).
* `toStartOfInterval` для округления значений в миллисекундах и микросекундах [#58557](https://github.com/ClickHouse/ClickHouse/pull/58557) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Отключён параметр `max_joined_block_rows` в ConcurrentHashJoin [#58595](https://github.com/ClickHouse/ClickHouse/pull/58595) ([vdimir](https://github.com/vdimir)).
* Исправлено соединение с использованием Nullable в старом анализаторе [#58596](https://github.com/ClickHouse/ClickHouse/pull/58596) ([vdimir](https://github.com/vdimir)).
* `makeDateTime64`: Теперь допускается неконстантный аргумент дробной части [#58597](https://github.com/ClickHouse/ClickHouse/pull/58597) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена возможная разыменовка указателя NULL при символизации inline frames [#58607](https://github.com/ClickHouse/ClickHouse/pull/58607) ([Azat Khuzhin](https://github.com/azat)).
* Улучшена изоляция записей кэша запросов при пересоздании пользователей или смене ролей [#58611](https://github.com/ClickHouse/ClickHouse/pull/58611) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлен анализ некорректного ключа партиционирования при выполнении оптимизации проекций [#58638](https://github.com/ClickHouse/ClickHouse/pull/58638) ([Amos Bird](https://github.com/amosbird)).
* Кэш запросов: исправлена пользовательская квота [#58731](https://github.com/ClickHouse/ClickHouse/pull/58731) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлено разбиение потоков в параллельных оконных функциях [#58739](https://github.com/ClickHouse/ClickHouse/pull/58739) ([Dmitry Novik](https://github.com/novikd)).
* Исправлен двойной вызов destroy при выбрасывании исключения в addBatchLookupTable8 [#58745](https://github.com/ClickHouse/ClickHouse/pull/58745) ([Raúl Marín](https://github.com/Algunenano)).
* Не обрабатывать запросы в Keeper при завершении работы [#58765](https://github.com/ClickHouse/ClickHouse/pull/58765) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено разыменование нулевого указателя в `SlabsPolygonIndex::find` [#58771](https://github.com/ClickHouse/ClickHouse/pull/58771) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена работа функции JSONExtract для столбцов LowCardinality(Nullable) [#58808](https://github.com/ClickHouse/ClickHouse/pull/58808) ([vdimir](https://github.com/vdimir)).
* Исправлено неожиданное накопление потребления памяти при создании и удалении очень большого числа таблиц командами CREATE и DROP. [#58831](https://github.com/ClickHouse/ClickHouse/pull/58831) ([Maksim Kita](https://github.com/kitaisreal)).
* Хранение журнала чтения нескольких файлов в mv [#58877](https://github.com/ClickHouse/ClickHouse/pull/58877) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Ограничение на идентификатор ключа доступа (`access key id`) для S3. [#58900](https://github.com/ClickHouse/ClickHouse/pull/58900) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Исправлена возможная ошибка, приводившая к аварийному завершению работы clickhouse-local при загрузке подсказок [#58907](https://github.com/ClickHouse/ClickHouse/pull/58907) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка при использовании `indexHint` [#58911](https://github.com/ClickHouse/ClickHouse/pull/58911) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена ошибка, из-за которой StorageURL забывал заголовки при перезапуске сервера [#58933](https://github.com/ClickHouse/ClickHouse/pull/58933) ([Michael Kolupaev](https://github.com/al13n321)).
* Analyzer: исправлена замена хранилища на блок вставки [#58958](https://github.com/ClickHouse/ClickHouse/pull/58958) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлен `seek` в ReadBufferFromZipArchive [#58966](https://github.com/ClickHouse/ClickHouse/pull/58966) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправление для экспериментальных инвертированных индексов (не используйте в продакшене): `DROP INDEX` для инвертированного индекса теперь удаляет все соответствующие файлы из постоянного хранилища [#59040](https://github.com/ClickHouse/ClickHouse/pull/59040) ([mochi](https://github.com/MochiXu)).
* Устранена гонка данных в query&#95;factories&#95;info [#59049](https://github.com/ClickHouse/ClickHouse/pull/59049) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отключена повторная попытка запроса при ошибке &quot;Too many redirects&quot; [#59099](https://github.com/ClickHouse/ClickHouse/pull/59099) ([skyoct](https://github.com/skyoct)).
* Исправлена взаимоблокировка при завершении работы незапущенной базы данных [#59137](https://github.com/ClickHouse/ClickHouse/pull/59137) ([Sergei Trifonov](https://github.com/serxa)).
* Исправление: LIMIT BY и LIMIT в распределённом запросе [#59153](https://github.com/ClickHouse/ClickHouse/pull/59153) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлено падение при использовании nullable часового пояса в `toString` [#59190](https://github.com/ClickHouse/ClickHouse/pull/59190) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлен аварийный сбой в метаданных Iceberg при некорректных путях к файлам [#59275](https://github.com/ClickHouse/ClickHouse/pull/59275) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено название архитектуры в списке выбора цели Rust [#59307](https://github.com/ClickHouse/ClickHouse/pull/59307) ([p1rattttt](https://github.com/p1rattttt)).
* Исправлена логическая ошибка, связанная с «not-ready set» при выполнении запроса к таблице `system.tables` с подзапросом в предложении IN. [#59351](https://github.com/ClickHouse/ClickHouse/pull/59351) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).





## [Журнал изменений за 2023 год](/whats-new/changelog/2023) {#changelog-for-2023}
