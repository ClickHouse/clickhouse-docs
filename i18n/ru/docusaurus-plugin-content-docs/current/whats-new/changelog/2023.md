---
slug: /whats-new/changelog/2023
sidebar_position: 4
sidebar_label: '2023'
title: 'Журнал изменений за 2023 год'
description: 'Журнал изменений за 2023 год'
keywords: ['ClickHouse 2023', 'журнал изменений 2023', 'примечания к выпуску', 'история версий', 'улучшения производительности']
doc_type: 'changelog'
---

### Оглавление {#table-of-contents}

**[Релиз ClickHouse v23.12, 2023-12-28](#2312)**<br/>
**[Релиз ClickHouse v23.11, 2023-12-06](#2311)**<br/>
**[Релиз ClickHouse v23.10, 2023-11-02](#2310)**<br/>
**[Релиз ClickHouse v23.9, 2023-09-28](#239)**<br/>
**[Релиз ClickHouse v23.8 LTS, 2023-08-31](#238)**<br/>
**[Релиз ClickHouse v23.7, 2023-07-27](#237)**<br/>
**[Релиз ClickHouse v23.6, 2023-06-30](#236)**<br/>
**[Релиз ClickHouse v23.5, 2023-06-08](#235)**<br/>
**[Релиз ClickHouse v23.4, 2023-04-26](#234)**<br/>
**[Релиз ClickHouse v23.3 LTS, 2023-03-30](#233)**<br/>
**[Релиз ClickHouse v23.2, 2023-02-23](#232)**<br/>
**[Релиз ClickHouse v23.1, 2023-01-25](#231)**<br/>
**[Журнал изменений за 2022 год](/whats-new/changelog/2022/)**<br/>

### <a id="2312"></a> Релиз ClickHouse 23.12, 2023-12-28. [Презентация](https://presentations.clickhouse.com/2023-release-23.12/), [видео](https://www.youtube.com/watch?v=7TLuT6gt0PQ) {#2312}

<iframe width="1024" height="576" src="https://www.youtube.com/embed/7TLuT6gt0PQ" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

#### Обратное несовместимое изменение {#backward-incompatible-change}

* Исправлена проверка на недетерминированные функции в выражениях TTL. Ранее в некоторых случаях можно было создать выражение TTL с недетерминированными функциями, что могло приводить к неопределённому поведению в дальнейшем. Это исправляет [#37250](https://github.com/ClickHouse/ClickHouse/issues/37250). По умолчанию запрещены выражения TTL, которые не зависят ни от каких столбцов таблицы. Их можно снова разрешить с помощью `SET allow_suspicious_ttl_expressions = 1` или `SET compatibility = '23.11'`. Закрывает [#37286](https://github.com/ClickHouse/ClickHouse/issues/37286). [#51858](https://github.com/ClickHouse/ClickHouse/pull/51858) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Параметр MergeTree `clean_deleted_rows` объявлен устаревшим, он больше ни на что не влияет. Ключевое слово `CLEANUP` для `OPTIMIZE` по умолчанию не допускается (его можно разблокировать с помощью параметра `allow_experimental_replacing_merge_with_cleanup`). [#58267](https://github.com/ClickHouse/ClickHouse/pull/58267) ([Alexander Tokmakov](https://github.com/tavplubix)). Это исправляет [#57930](https://github.com/ClickHouse/ClickHouse/issues/57930). Это закрывает [#54988](https://github.com/ClickHouse/ClickHouse/issues/54988). Это закрывает [#54570](https://github.com/ClickHouse/ClickHouse/issues/54570). Это закрывает [#50346](https://github.com/ClickHouse/ClickHouse/issues/50346). Это закрывает [#47579](https://github.com/ClickHouse/ClickHouse/issues/47579). Функциональность должна быть удалена, потому что она оказалась неудачной. Мы должны удалить её как можно скорее, потому что у нас нет другого выхода. [#57932](https://github.com/ClickHouse/ClickHouse/pull/57932) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### Новая функциональность {#new-feature}

* Реализована поддержка refreshable materialized views, запрошенных в [#33919](https://github.com/ClickHouse/ClickHouse/issues/33919). [#56946](https://github.com/ClickHouse/ClickHouse/pull/56946) ([Michael Kolupaev](https://github.com/al13n321), [Michael Guzov](https://github.com/koloshmet)).
* Добавлен `PASTE JOIN`, который позволяет соединять таблицы без указания условия `ON`, просто по номерам строк. Пример: `SELECT * FROM (SELECT number AS a FROM numbers(2)) AS t1 PASTE JOIN (SELECT number AS a FROM numbers(2) ORDER BY a DESC) AS t2`. [#57995](https://github.com/ClickHouse/ClickHouse/pull/57995) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Оператор `ORDER BY` теперь поддерживает указание значения `ALL`, что означает, что ClickHouse сортирует по всем столбцам, указанным в операторе `SELECT`. Пример: `SELECT col1, col2 FROM tab WHERE [...] ORDER BY ALL`. [#57875](https://github.com/ClickHouse/ClickHouse/pull/57875) ([zhongyuankai](https://github.com/zhongyuankai)).
* Добавлена новая команда мутации `ALTER TABLE <table> APPLY DELETED MASK`, которая позволяет принудительно применить маску, записанную с помощью механизма легковесного удаления, и удалить с диска строки, помеченные как удалённые. [#57433](https://github.com/ClickHouse/ClickHouse/pull/57433) ([Anton Popov](https://github.com/CurtizJ)).
* Обработчик `/binary` открывает визуальный интерфейс для просмотра символов в бинарнике ClickHouse. [#58211](https://github.com/ClickHouse/ClickHouse/pull/58211) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена новая SQL‑функция `sqid` для генерации идентификаторов Sqid ([https://sqids.org/](https://sqids.org/)), пример: `SELECT sqid(125, 126)`. [#57512](https://github.com/ClickHouse/ClickHouse/pull/57512) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена новая функция `seriesPeriodDetectFFT` для обнаружения периода временного ряда с использованием FFT. [#57574](https://github.com/ClickHouse/ClickHouse/pull/57574) ([Bhavna Jindal](https://github.com/bhavnajindal)).
* Добавлен HTTP-эндпоинт для проверки готовности Keeper к приёму трафика. [#55876](https://github.com/ClickHouse/ClickHouse/pull/55876) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Добавлен режим &#39;union&#39; для определения схемы. В этом режиме результирующая схема таблицы представляет собой объединение схем всех файлов (то есть схема определяется по каждому файлу). Режим определения схемы управляется настройкой `schema_inference_mode` с двумя возможными значениями — `default` и `union`. Закрывает [#55428](https://github.com/ClickHouse/ClickHouse/issues/55428). [#55892](https://github.com/ClickHouse/ClickHouse/pull/55892) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена новая настройка `input_format_csv_try_infer_numbers_from_strings`, которая позволяет определять числовые значения по строкам в формате CSV. Закрывает [#56455](https://github.com/ClickHouse/ClickHouse/issues/56455). [#56859](https://github.com/ClickHouse/ClickHouse/pull/56859) ([Kruglov Pavel](https://github.com/Avogar)).
* Если количество баз данных или таблиц превышает настраиваемый порог, отображается предупреждение для пользователя. [#57375](https://github.com/ClickHouse/ClickHouse/pull/57375) ([凌涛](https://github.com/lingtaolf)).
* Словарь с макетом `HASHED_ARRAY` (и `COMPLEX_KEY_HASHED_ARRAY`) поддерживает параметр `SHARDS` так же, как и макет `HASHED`. [#57544](https://github.com/ClickHouse/ClickHouse/pull/57544) ([vdimir](https://github.com/vdimir)).
* Добавлены асинхронные метрики для общего объёма байт первичного ключа и общего объёма байт первичного ключа, выделенных в памяти. [#57551](https://github.com/ClickHouse/ClickHouse/pull/57551) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлена функция `SHA512_256`. [#57645](https://github.com/ClickHouse/ClickHouse/pull/57645) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлен алиас `FORMAT_BYTES` для `formatReadableSize`. [#57592](https://github.com/ClickHouse/ClickHouse/pull/57592) ([Bharat Nallan](https://github.com/bharatnc)).
* Разрешена возможность передавать необязательный токен сессии в табличную функцию `s3`. [#57850](https://github.com/ClickHouse/ClickHouse/pull/57850) ([Shani Elharrar](https://github.com/shanielh)).
* Добавлена новая настройка `http_make_head_request`. Если она отключена, табличный движок URL не будет выполнять запрос HEAD для определения размера файла. Это нужно для поддержки неэффективных, неправильно сконфигурированных или не поддерживающих такую возможность HTTP-серверов. [#54602](https://github.com/ClickHouse/ClickHouse/pull/54602) ([Fionera](https://github.com/fionera)).
* Теперь можно ссылаться на столбец-алиас (ALIAS) в определениях индексов, не являющихся первичным ключом (issue [#55650](https://github.com/ClickHouse/ClickHouse/issues/55650)). Пример: `CREATE TABLE tab(col UInt32, col_alias ALIAS col + 1, INDEX idx (col_alias) TYPE minmax) ENGINE = MergeTree ORDER BY col;`. [#57546](https://github.com/ClickHouse/ClickHouse/pull/57546) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена новая настройка `readonly`, которую можно использовать для указания, что диск S3 доступен только для чтения. Это может быть полезно для создания таблицы на диске типа `s3_plain` при наличии доступа только на чтение к лежащему в основе бакету S3. [#57977](https://github.com/ClickHouse/ClickHouse/pull/57977) ([Pengyuan Bian](https://github.com/bianpengyuan)).
* Анализ первичного ключа в таблицах MergeTree теперь применяется к предикатам, которые включают виртуальный столбец `_part_offset` (при необходимости совместно с `_part`). Эта возможность может использоваться как особый вид вторичного индекса. [#58224](https://github.com/ClickHouse/ClickHouse/pull/58224) ([Amos Bird](https://github.com/amosbird)).

#### Повышение производительности {#performance-improvement}

* Извлекаются диапазоны непересекающихся частей из таблицы MergeTree во время обработки FINAL. Таким образом можно избежать дополнительной логики FINAL для этих непересекающихся диапазонов частей. Если количество дублирующихся значений с одинаковым первичным ключом невелико, производительность будет почти такой же, как без FINAL. Улучшена производительность чтения для MergeTree FINAL, когда включена настройка `do_not_merge_across_partitions_select_final`. [#58120](https://github.com/ClickHouse/ClickHouse/pull/58120) ([Maksim Kita](https://github.com/kitaisreal)).
* Реализовано копирование между S3-дисками с использованием s3-server-side copy вместо копирования через буфер. Улучшены операции `BACKUP/RESTORE` и команда `clickhouse-disks copy`. [#56744](https://github.com/ClickHouse/ClickHouse/pull/56744) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Hash JOIN учитывает настройку `max_joined_block_size_rows` и не создаёт большие блоки для `ALL JOIN`. [#56996](https://github.com/ClickHouse/ClickHouse/pull/56996) ([vdimir](https://github.com/vdimir)).
* Более раннее освобождение памяти при агрегации. Это может позволить избежать ненужной внешней агрегации. [#57691](https://github.com/ClickHouse/ClickHouse/pull/57691) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Повышена производительность сериализации строк. [#57717](https://github.com/ClickHouse/ClickHouse/pull/57717) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена поддержка тривиальной оптимизации `count` для таблиц с движком `Merge`. [#57867](https://github.com/ClickHouse/ClickHouse/pull/57867) ([skyoct](https://github.com/skyoct)).
* Оптимизирована агрегация в некоторых случаях. [#57872](https://github.com/ClickHouse/ClickHouse/pull/57872) ([Anton Popov](https://github.com/CurtizJ)).
* Функция `hasAny` теперь может использовать преимущества полнотекстовых индексов пропуска. [#57878](https://github.com/ClickHouse/ClickHouse/pull/57878) ([Jpnock](https://github.com/Jpnock)).
* Функция `if(cond, then, else)` (и её псевдоним `cond ? then : else`) была оптимизирована для безветвленного вычисления. [#57885](https://github.com/ClickHouse/ClickHouse/pull/57885) ([zhanglistar](https://github.com/zhanglistar)).
* MergeTree автоматически определяет значение настройки `do_not_merge_across_partitions_select_final`, если выражение ключа партиции содержит только столбцы из выражения первичного ключа. [#58218](https://github.com/ClickHouse/ClickHouse/pull/58218) ([Maksim Kita](https://github.com/kitaisreal)).
* Ускорена работа операций `MIN` и `MAX` для нативных типов данных. [#58231](https://github.com/ClickHouse/ClickHouse/pull/58231) ([Raúl Marín](https://github.com/Algunenano)).
* Реализована политика кэширования `SLRU` для кэша файловой системы. [#57076](https://github.com/ClickHouse/ClickHouse/pull/57076) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Лимит числа подключений на один endpoint для фоновых выборок увеличен с `15` до значения настройки `background_fetches_pool_size`. - Настройка уровня MergeTree `replicated_max_parallel_fetches_for_host` признана устаревшей. - Настройки уровня MergeTree `replicated_fetches_http_connection_timeout`, `replicated_fetches_http_send_timeout` и `replicated_fetches_http_receive_timeout` перенесены на уровень Server. - Настройка `keep_alive_timeout` добавлена в список настроек уровня Server. [#57523](https://github.com/ClickHouse/ClickHouse/pull/57523) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Запросы к `system.filesystem_cache` стали менее затратными по памяти. [#57687](https://github.com/ClickHouse/ClickHouse/pull/57687) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Снижено использование памяти при десериализации строк. [#57787](https://github.com/ClickHouse/ClickHouse/pull/57787) ([Maksim Kita](https://github.com/kitaisreal)).
* Более эффективный конструктор для Enum — актуально, когда у Enum очень много значений. [#57887](https://github.com/ClickHouse/ClickHouse/pull/57887) ([Duc Canh Le](https://github.com/canhld94)).
* Улучшено чтение из кэша файловой системы: всегда используется метод `pread`. [#57970](https://github.com/ClickHouse/ClickHouse/pull/57970) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлена оптимизация цепочки AND notEquals в оптимизаторе логических выражений. Эта оптимизация доступна только при включённом экспериментальном Analyzer. [#58214](https://github.com/ClickHouse/ClickHouse/pull/58214) ([Kevin Mingtarja](https://github.com/kevinmingtarja)).

#### Улучшения {#improvement}

* Поддержка мягкого ограничения памяти в Keeper. Он будет отклонять запросы, когда использование памяти приближается к максимальному значению. [#57271](https://github.com/ClickHouse/ClickHouse/pull/57271) ([Han Fei](https://github.com/hanfei1991)). [#57699](https://github.com/ClickHouse/ClickHouse/pull/57699) ([Han Fei](https://github.com/hanfei1991)).
* Обеспечена корректная обработка обновлённой конфигурации кластера при вставках в distributed таблицы. При динамическом обновлении списка узлов кластера Directory Monitor distributed таблицы будет синхронизировать его. [#42826](https://github.com/ClickHouse/ClickHouse/pull/42826) ([zhongyuankai](https://github.com/zhongyuankai)).
* Не допускается создание реплицируемой таблицы с несогласованными параметрами слияния. [#56833](https://github.com/ClickHouse/ClickHouse/pull/56833) ([Duc Canh Le](https://github.com/canhld94)).
* Отображать несжатый размер в `system.tables`. [#56618](https://github.com/ClickHouse/ClickHouse/issues/56618). [#57186](https://github.com/ClickHouse/ClickHouse/pull/57186) ([Chen Lixiang](https://github.com/chenlx0)).
* Добавлена настройка `skip_unavailable_shards` для таблиц `Distributed`, аналогичная одноимённой настройке на уровне запроса. Закрывает [#43666](https://github.com/ClickHouse/ClickHouse/issues/43666). [#57218](https://github.com/ClickHouse/ClickHouse/pull/57218) ([Gagan Goel](https://github.com/tntnatbry)).
* Функция `substring` (синонимы: `substr`, `mid`) теперь может использоваться с типами `Enum`. Ранее первый аргумент функции должен был иметь тип `String` или `FixedString`. Это улучшает совместимость с инструментами третьих сторон, такими как Tableau, при использовании интерфейса MySQL. [#57277](https://github.com/ClickHouse/ClickHouse/pull/57277) ([Serge Klochkov](https://github.com/slvrtrn)).
* Функция `format` теперь поддерживает произвольные типы аргументов (вместо того чтобы работать только с аргументами типов `String` и `FixedString`). Это позволяет выполнить запрос `SELECT format('The {0} to all questions is {1}', 'answer', 42)`. [#57549](https://github.com/ClickHouse/ClickHouse/pull/57549) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена возможность использовать функцию `date_trunc` с нечувствительным к регистру первым аргументом. Теперь поддерживаются оба варианта: `SELECT date_trunc('day', now())` и `SELECT date_trunc('DAY', now())`. [#57624](https://github.com/ClickHouse/ClickHouse/pull/57624) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Более информативные подсказки, когда таблица не существует. [#57342](https://github.com/ClickHouse/ClickHouse/pull/57342) ([Bharat Nallan](https://github.com/bharatnc)).
* Разрешено переопределять серверные настройки `max_partition_size_to_drop` и `max_table_size_to_drop` при выполнении запроса. [#57452](https://github.com/ClickHouse/ClickHouse/pull/57452) ([Jordi Villar](https://github.com/jrdi)).
* Незначительно улучшено определение безымянных кортежей в форматах JSON. [#57751](https://github.com/ClickHouse/ClickHouse/pull/57751) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка флага read-only при подключении к Keeper (исправляет [#53749](https://github.com/ClickHouse/ClickHouse/issues/53749)). [#57479](https://github.com/ClickHouse/ClickHouse/pull/57479) ([Mikhail Koviazin](https://github.com/mkmkme)).
* Исправлены возможные случаи, когда распределённые отправки «застревали» из‑за ошибки «No such file or directory» (во время восстановления батча с диска). Исправлены возможные проблемы со значением `error_count` из `system.distribution_queue` (в случае, если `distributed_directory_monitor_max_sleep_time_ms` &gt; 5 минут). Добавлено событие профилирования для отслеживания неуспешных асинхронных INSERT — `DistributedAsyncInsertionFailures`. [#57480](https://github.com/ClickHouse/ClickHouse/pull/57480) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка генерируемых столбцов PostgreSQL и значений по умолчанию для столбцов в `MaterializedPostgreSQL` (экспериментальная возможность). Закрывает [#40449](https://github.com/ClickHouse/ClickHouse/issues/40449). [#57568](https://github.com/ClickHouse/ClickHouse/pull/57568) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Позволяет применять некоторые изменения настроек кэша файловой системы без перезапуска сервера. [#57578](https://github.com/ClickHouse/ClickHouse/pull/57578) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Корректная обработка структуры таблицы PostgreSQL при пустом массиве. [#57618](https://github.com/ClickHouse/ClickHouse/pull/57618) ([Mike Kot](https://github.com/myrrc)).
* Добавлена метрика `ClickHouseErrorMetric_ALL`, отображающая общее количество ошибок, произошедших с момента последнего перезапуска сервера. [#57627](https://github.com/ClickHouse/ClickHouse/pull/57627) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Разрешены узлы в конфигурационном файле со ссылкой `from_env`/`from_zk` и непустым элементом при replace=1. [#57628](https://github.com/ClickHouse/ClickHouse/pull/57628) ([Azat Khuzhin](https://github.com/azat)).
* Табличная функция `fuzzJSON`, которая позволяет генерировать большое количество некорректного JSON для фаззинга. [#57646](https://github.com/ClickHouse/ClickHouse/pull/57646) ([Julia Kartseva](https://github.com/jkartseva)).
* Разрешено преобразование IPv6 в UInt128 и бинарные арифметические операции. [#57707](https://github.com/ClickHouse/ClickHouse/pull/57707) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Добавлена настройка `async inserts deduplication cache`, задающая время ожидания обновления кэша. Настройка `async_block_ids_cache_min_update_interval_ms` объявлена устаревшей. Теперь кэш обновляется только в случае конфликтов. [#57743](https://github.com/ClickHouse/ClickHouse/pull/57743) ([alesapin](https://github.com/alesapin)).
* Функция `sleep()` теперь может быть прервана командой `KILL QUERY`. [#57746](https://github.com/ClickHouse/ClickHouse/pull/57746) ([Vitaly Baranov](https://github.com/vitlibar)).
* Запрещено выполнение запросов `CREATE TABLE ... AS SELECT` для движков таблиц `Replicated` в экспериментальной базе данных `Replicated`, поскольку они не поддерживаются. См. [#35408](https://github.com/ClickHouse/ClickHouse/issues/35408). [#57796](https://github.com/ClickHouse/ClickHouse/pull/57796) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена и улучшена трансформация запросов для внешних баз данных, чтобы рекурсивно получать все совместимые предикаты. [#57888](https://github.com/ClickHouse/ClickHouse/pull/57888) ([flynn](https://github.com/ucasfl)).
* Добавлена поддержка динамического изменения размера файлового кеша. Закрывает [#57866](https://github.com/ClickHouse/ClickHouse/issues/57866). [#57897](https://github.com/ClickHouse/ClickHouse/pull/57897) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Обеспечена корректная поддержка `system.stack_trace` для потоков с заблокированным SIGRTMIN (такие потоки могут встречаться во внешних библиотеках низкого качества, таких как Apache rdkafka). [#57907](https://github.com/ClickHouse/ClickHouse/pull/57907) ([Azat Khuzhin](https://github.com/azat)). А также сигнал отправляется потокам только в том случае, если он не заблокирован, чтобы избежать ожидания `storage_system_stack_trace_pipe_read_timeout_ms`, когда в этом нет смысла. [#58136](https://github.com/ClickHouse/ClickHouse/pull/58136) ([Azat Khuzhin](https://github.com/azat)).
* Разрешить сбои Keeper при проверке вставок с кворумом. [#57986](https://github.com/ClickHouse/ClickHouse/pull/57986) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлено максимальное/пиковое значение RSS (`MemoryResidentMax`) в таблицу system.asynchronous&#95;metrics. [#58095](https://github.com/ClickHouse/ClickHouse/pull/58095) ([Azat Khuzhin](https://github.com/azat)).
* Этот PR позволяет использовать ссылки в стиле S3 (`https://` и `s3://`) без указания региона, даже если он отличается от региона по умолчанию. Кроме того, автоматически определяется корректный регион, если пользователь указал неверный. [#58148](https://github.com/ClickHouse/ClickHouse/pull/58148) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* `clickhouse-format --obfuscate` будет корректно обрабатывать Settings, MergeTreeSettings и часовые пояса и не изменять их названия. [#58179](https://github.com/ClickHouse/ClickHouse/pull/58179) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена явная функция `finalize()` в `ZipArchiveWriter`. Упрощён слишком сложный код в `ZipArchiveWriter`. Это исправляет [#58074](https://github.com/ClickHouse/ClickHouse/issues/58074). [#58202](https://github.com/ClickHouse/ClickHouse/pull/58202) ([Vitaly Baranov](https://github.com/vitlibar)).
* Кэши с одинаковым путём теперь используют одни и те же объекты кэша. Такое поведение было и раньше, но было нарушено в версии 23.4. Если для таких кэшей с одинаковым путём заданы разные наборы настроек кэша, будет выброшено исключение, сообщающее, что это не допускается. [#58264](https://github.com/ClickHouse/ClickHouse/pull/58264) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Параллельные реплики (экспериментальная функция): более удобные настройки [#57542](https://github.com/ClickHouse/ClickHouse/pull/57542) ([Igor Nikonov](https://github.com/devcrafter)).
* Parallel replicas (экспериментальная возможность): улучшена обработка ответов на объявления [#57749](https://github.com/ClickHouse/ClickHouse/pull/57749) ([Igor Nikonov](https://github.com/devcrafter)).
* Параллельные реплики (экспериментальная функция): строже учитывать `min_number_of_marks` в `ParallelReplicasReadingCoordinator` [#57763](https://github.com/ClickHouse/ClickHouse/pull/57763) ([Nikita Taranov](https://github.com/nickitat)).
* Параллельные реплики (экспериментальная возможность): отключены параллельные реплики для IN (subquery) [#58133](https://github.com/ClickHouse/ClickHouse/pull/58133) ([Igor Nikonov](https://github.com/devcrafter)).
* Параллельные реплики (экспериментальная возможность): добавлено событие профиля &#39;ParallelReplicasUsedCount&#39; [#58173](https://github.com/ClickHouse/ClickHouse/pull/58173) ([Igor Nikonov](https://github.com/devcrafter)).
* Запросы, отличные от POST, такие как HEAD, будут только для чтения, аналогично GET. [#58060](https://github.com/ClickHouse/ClickHouse/pull/58060) ([San](https://github.com/santrancisco)).
* Добавлен столбец `bytes_uncompressed` в таблицу `system.part_log` [#58167](https://github.com/ClickHouse/ClickHouse/pull/58167) ([Jordi Villar](https://github.com/jrdi)).
* Добавлено имя базового бэкапа в таблицы `system.backups` и `system.backup_log` [#58178](https://github.com/ClickHouse/ClickHouse/pull/58178) ([Pradeep Chhetri](https://github.com/chhetripradeep)).
* Добавлена поддержка задания параметров запроса в clickhouse-local через командную строку [#58210](https://github.com/ClickHouse/ClickHouse/pull/58210) ([Pradeep Chhetri](https://github.com/chhetripradeep)).

#### Улучшение сборки/тестирования/упаковки {#buildtestingpackaging-improvement}

* Рандомизировать больше настроек [#39663](https://github.com/ClickHouse/ClickHouse/pull/39663) ([Anton Popov](https://github.com/CurtizJ)).
* Рандомизировать отключённые оптимизации в CI [#57315](https://github.com/ClickHouse/ClickHouse/pull/57315) ([Raúl Marín](https://github.com/Algunenano)).
* Разрешить использование табличных движков и функций, связанных с Azure, на macOS. [#51866](https://github.com/ClickHouse/ClickHouse/pull/51866) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* ClickHouse Fast Test теперь использует Musl вместо GLibc. [#57711](https://github.com/ClickHouse/ClickHouse/pull/57711) ([Alexey Milovidov](https://github.com/alexey-milovidov)). Полностью статическая сборка на Musl доступна для загрузки из CI.
* Запускать ClickBench для каждого коммита. Это закрывает [#57708](https://github.com/ClickHouse/ClickHouse/issues/57708). [#57712](https://github.com/ClickHouse/ClickHouse/pull/57712) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исключить использование небезопасной C/POSIX-функции `select` во внешних библиотеках. [#57467](https://github.com/ClickHouse/ClickHouse/pull/57467) ([Igor Nikonov](https://github.com/devcrafter)).
* Настройки, доступные только в ClickHouse Cloud, также будут присутствовать в open-source сборке ClickHouse для удобства. [#57638](https://github.com/ClickHouse/ClickHouse/pull/57638) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).

#### Исправление ошибки (некорректное поведение, заметное пользователю, в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release}

* Исправлена возможная проблема с нарушением порядка сортировки в TTL GROUP BY [#49103](https://github.com/ClickHouse/ClickHouse/pull/49103) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлено: в стратегии разбиения на бакеты `lttb` первый и последний бакеты теперь содержат только по одной точке [#57003](https://github.com/ClickHouse/ClickHouse/pull/57003) ([FFish](https://github.com/wxybear)).
* Исправлена потенциальная взаимоблокировка в формате `Template` при синхронизации после ошибки [#57004](https://github.com/ClickHouse/ClickHouse/pull/57004) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка, приводившая к преждевременной остановке разбора файла при пропуске большого количества ошибок [#57006](https://github.com/ClickHouse/ClickHouse/pull/57006) ([Kruglov Pavel](https://github.com/Avogar)).
* Предотвращён обход ACL словаря через табличную функцию `dictionary` [#57362](https://github.com/ClickHouse/ClickHouse/pull/57362) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Исправлен ещё один случай ошибки «non-ready Set», обнаруженной фаззером. [#57423](https://github.com/ClickHouse/ClickHouse/pull/57423) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено несколько ошибок в использовании функции PostgreSQL `array_ndims`. [#57436](https://github.com/ClickHouse/ClickHouse/pull/57436) ([Ryan Jacobs](https://github.com/ryanmjacobs)).
* Исправлена несогласованность RWLock после истечения тайм‑аута блокировки на запись [#57454](https://github.com/ClickHouse/ClickHouse/pull/57454) ([Vitaly Baranov](https://github.com/vitlibar)). Исправлена несогласованность RWLock после истечения тайм‑аута блокировки на запись (снова) [#57733](https://github.com/ClickHouse/ClickHouse/pull/57733) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено: не исключать эфемерный столбец при построении цепочки проталкивания в представления [#57461](https://github.com/ClickHouse/ClickHouse/pull/57461) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* MaterializedPostgreSQL (экспериментальная функциональность): исправлена ошибка [#41922](https://github.com/ClickHouse/ClickHouse/issues/41922), добавлен тест для [#41923](https://github.com/ClickHouse/ClickHouse/issues/41923) [#57515](https://github.com/ClickHouse/ClickHouse/pull/57515) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Игнорировать предложение ON CLUSTER в запросах GRANT/REVOKE для управления реплицируемыми сущностями доступа.  [#57538](https://github.com/ClickHouse/ClickHouse/pull/57538) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Исправлено падение clickhouse-local [#57553](https://github.com/ClickHouse/ClickHouse/pull/57553) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена ошибка в Hash JOIN. [#57564](https://github.com/ClickHouse/ClickHouse/pull/57564) ([vdimir](https://github.com/vdimir)).
* Исправлена потенциальная ошибка в источнике PostgreSQL [#57567](https://github.com/ClickHouse/ClickHouse/pull/57567) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено приведение типов в Hash JOIN для вложенного LowCardinality. [#57614](https://github.com/ClickHouse/ClickHouse/pull/57614) ([vdimir](https://github.com/vdimir)).
* Предотвращены зависания `system.stack_trace` путём корректного запрета параллельного чтения из него. [#57641](https://github.com/ClickHouse/ClickHouse/pull/57641) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка при агрегации разреженных столбцов с `any(...) RESPECT NULL` [#57710](https://github.com/ClickHouse/ClickHouse/pull/57710) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен парсинг унарных операторов [#57713](https://github.com/ClickHouse/ClickHouse/pull/57713) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена загрузка зависимостей для экспериментального табличного движка `MaterializedPostgreSQL`. [#57754](https://github.com/ClickHouse/ClickHouse/pull/57754) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлены повторные попытки выполнения для отключённых узлов при BACKUP/RESTORE ON CLUSTER [#57764](https://github.com/ClickHouse/ClickHouse/pull/57764) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен результат внешней агрегации при частично материализованной проекции [#57790](https://github.com/ClickHouse/ClickHouse/pull/57790) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено слияние в агрегатных функциях с комбинатором `*Map` [#57795](https://github.com/ClickHouse/ClickHouse/pull/57795) ([Anton Popov](https://github.com/CurtizJ)).
* Отключён `system.kafka_consumers` из-за ошибки. [#57822](https://github.com/ClickHouse/ClickHouse/pull/57822) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена поддержка ключей типа LowCardinality в Merge JOIN. [#57827](https://github.com/ClickHouse/ClickHouse/pull/57827) ([vdimir](https://github.com/vdimir)).
* Исправление для `InterpreterCreateQuery`, связанное с примерным блоком. [#57855](https://github.com/ClickHouse/ClickHouse/pull/57855) ([Maksim Kita](https://github.com/kitaisreal)).
* `addresses_expr` игнорировались в именованных коллекциях PostgreSQL. [#57874](https://github.com/ClickHouse/ClickHouse/pull/57874) ([joelynch](https://github.com/joelynch)).
* Исправлен некорректный доступ к памяти в BLAKE3 (Rust) [#57876](https://github.com/ClickHouse/ClickHouse/pull/57876) ([Raúl Marín](https://github.com/Algunenano)). Затем реализация была переписана с Rust на C++ для повышения [безопасности работы с памятью](https://www.memorysafety.org/). [#57994](https://github.com/ClickHouse/ClickHouse/pull/57994) ([Raúl Марин](https://github.com/Algunenano)).
* Нормализованы имена функций в `CREATE INDEX` [#57906](https://github.com/ClickHouse/ClickHouse/pull/57906) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена обработка случая недоступности реплик до выполнения первого запроса [#57933](https://github.com/ClickHouse/ClickHouse/pull/57933) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена некорректная классификация псевдонима литерала [#57988](https://github.com/ClickHouse/ClickHouse/pull/57988) ([Chen768959](https://github.com/Chen768959)).
* Исправлена некорректная предварительная обработка в Keeper [#58069](https://github.com/ClickHouse/ClickHouse/pull/58069) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено целочисленное переполнение в библиотеке `Poco`, связанное с `UTF32Encoding` [#58073](https://github.com/ClickHouse/ClickHouse/pull/58073) ([Andrey Fedotov](https://github.com/anfedotoff)).
* Исправлена работа параллельных реплик (экспериментальная функциональность) при наличии скалярного подзапроса с большим целочисленным значением [#58118](https://github.com/ClickHouse/ClickHouse/pull/58118) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена функция `accurateCastOrNull` для значений `DateTime`, выходящих за допустимый диапазон [#58139](https://github.com/ClickHouse/ClickHouse/pull/58139) ([Andrey Zvonov](https://github.com/zvonand)).
* Исправлена возможная ошибка `PARAMETER_OUT_OF_BOUND` при чтении подстолбцов из широкой части в MergeTree [#58175](https://github.com/ClickHouse/ClickHouse/pull/58175) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено снижение производительности `CREATE VIEW` с огромным количеством подзапросов [#58220](https://github.com/ClickHouse/ClickHouse/pull/58220) ([Tao Wang](https://github.com/wangtZJU)).
* Исправлен параллельный парсинг JSONCompactEachRow [#58181](https://github.com/ClickHouse/ClickHouse/pull/58181) ([Alexey Milovidov](https://github.com/alexey-milovidov)). [#58250](https://github.com/ClickHouse/ClickHouse/pull/58250) ([Kruglov Pavel](https://github.com/Avogar)).

### <a id="2311"></a> Релиз ClickHouse 23.11 от 2023-12-06. [Презентация](https://presentations.clickhouse.com/2023-release-23.11/), [Видео](https://www.youtube.com/watch?v=1HJdjOH4Eis) {#2311}

<iframe width="1024" height="576" src="https://www.youtube.com/embed/1HJdjOH4Eis" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

#### Изменение, нарушающее обратную совместимость {#backward-incompatible-change-1}

* В конфигурационном файле сервера ClickHouse по умолчанию включены `access_management` (управление пользователями с помощью SQL-запросов) и `named_collection_control` (управление именованными коллекциями с помощью SQL-запросов) для пользователя `default`. Это закрывает [#56482](https://github.com/ClickHouse/ClickHouse/issues/56482). [#56619](https://github.com/ClickHouse/ClickHouse/pull/56619) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Многочисленные улучшения для `RESPECT NULLS`/`IGNORE NULLS` для оконных функций. Если вы используете их как агрегатные функции и храните состояния агрегатных функций с этими модификаторами, они могут стать несовместимыми. [#57189](https://github.com/ClickHouse/ClickHouse/pull/57189) ([Raúl Marín](https://github.com/Algunenano)).
* Удалена оптимизация `optimize_move_functions_out_of_any`. [#57190](https://github.com/ClickHouse/ClickHouse/pull/57190) ([Raúl Marín](https://github.com/Algunenano)).
* Спецификаторы формата `%l`/`%k`/`%c` в функции `parseDateTime` теперь могут разбирать часы/месяцы без ведущих нулей, например, `select parseDateTime('2023-11-26 8:14', '%F %k:%i')` теперь работает. Установите `parsedatetime_parse_without_leading_zeros = 0`, чтобы восстановить предыдущее поведение, требовавшее две цифры. Функция `formatDateTime` теперь также может выводить часы/месяцы без ведущих нулей. Это контролируется настройкой `formatdatetime_format_without_leading_zeros`, но по умолчанию она выключена, чтобы не ломать существующие сценарии использования. [#55872](https://github.com/ClickHouse/ClickHouse/pull/55872) ([Azat Khuzhin](https://github.com/azat)).
* Больше нельзя использовать агрегатную функцию `avgWeighted` с аргументами типа `Decimal`. Обходной путь: преобразовать аргументы в `Float64`. Это закрывает [#43928](https://github.com/ClickHouse/ClickHouse/issues/43928). Это закрывает [#31768](https://github.com/ClickHouse/ClickHouse/issues/31768). Это закрывает [#56435](https://github.com/ClickHouse/ClickHouse/issues/56435). Если вы использовали эту функцию внутри materialized views или проекций с аргументами типа `Decimal`, свяжитесь с support@clickhouse.com. Исправлена ошибка в агрегатной функции `sumMap`, из-за чего она стала работать медленнее примерно в 1,5–2 раза. Это не важно, потому что функция всё равно мусорная. Это закрывает [#54955](https://github.com/ClickHouse/ClickHouse/issues/54955). Это закрывает [#53134](https://github.com/ClickHouse/ClickHouse/issues/53134). Это закрывает [#55148](https://github.com/ClickHouse/ClickHouse/issues/55148). Исправлена ошибка в функции `groupArraySample` — она использовала одно и то же случайное начальное значение (seed) в случае, когда в запросе генерировалось более одного агрегатного состояния. [#56350](https://github.com/ClickHouse/ClickHouse/pull/56350) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### Новая возможность {#new-feature-1}

* Добавлена серверная настройка `async_load_databases` для асинхронной загрузки баз данных и таблиц. Ускоряет запуск сервера. Применяется к базам данных с движками `Ordinary`, `Atomic` и `Replicated`. Метаданные их таблиц загружаются асинхронно. Запрос к таблице повышает приоритет задания загрузки и ждёт его завершения. Добавлена новая таблица `system.asynchronous_loader` для интроспекции. [#49351](https://github.com/ClickHouse/ClickHouse/pull/49351) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена системная таблица `blob_storage_log`. Она позволяет вести аудит всех данных, записанных в S3 и другие объектные хранилища. [#52918](https://github.com/ClickHouse/ClickHouse/pull/52918) ([vdimir](https://github.com/vdimir)).
* Используйте статистику для более оптимального упорядочивания условий PREWHERE. [#53240](https://github.com/ClickHouse/ClickHouse/pull/53240) ([Han Fei](https://github.com/hanfei1991)).
* Добавлена поддержка сжатия в протоколе Keeper. Ее можно включить на стороне ClickHouse с помощью флага `use_compression` в секции `zookeeper`. Учтите, что сжатие поддерживается только в ClickHouse Keeper, а Apache ZooKeeper его не поддерживает. Исправляет [#49507](https://github.com/ClickHouse/ClickHouse/issues/49507). [#54957](https://github.com/ClickHouse/ClickHouse/pull/54957) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Добавлен параметр `storage_metadata_write_full_object_key`. Если он имеет значение `true`, метаданные записываются в новом формате. В этом формате ClickHouse сохраняет полный ключ удалённого объекта в файле метаданных, что даёт большую гибкость и возможности для оптимизации. [#55566](https://github.com/ClickHouse/ClickHouse/pull/55566) ([Sema Checherinda](https://github.com/CheSema)).
* Добавлены новые настройки и синтаксис, предотвращающие перезапись полей именованных коллекций. Это позволяет исключить получение злоумышленником несанкционированного доступа к секретам. [#55782](https://github.com/ClickHouse/ClickHouse/pull/55782) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Добавлен столбец `hostname` во все системные таблицы логов — он полезен, если вы используете реплицируемые, общие или распределённые системные таблицы. [#55894](https://github.com/ClickHouse/ClickHouse/pull/55894) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлен запрос `CHECK ALL TABLES`. [#56022](https://github.com/ClickHouse/ClickHouse/pull/56022) ([vdimir](https://github.com/vdimir)).
* Добавлена функция `fromDaysSinceYearZero`, которая аналогична функции `FROM_DAYS` в MySQL. Например, `SELECT fromDaysSinceYearZero(739136)` возвращает `2023-09-08`. [#56088](https://github.com/ClickHouse/ClickHouse/pull/56088) ([Joanna Hulboj](https://github.com/jh0x)).
* Добавлен внешний инструмент на Python для просмотра бэкапов и извлечения из них информации без использования ClickHouse. [#56268](https://github.com/ClickHouse/ClickHouse/pull/56268) ([Vitaly Baranov](https://github.com/vitlibar)).
* Реализована новая настройка `preferred_optimize_projection_name`. Если она имеет непустое значение, по возможности будет использоваться указанная проекция вместо выбора из всех кандидатов. [#56309](https://github.com/ClickHouse/ClickHouse/pull/56309) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена 4-символьная команда для передачи / отказа от роли лидера ([https://github.com/ClickHouse/ClickHouse/issues/56352](https://github.com/ClickHouse/ClickHouse/issues/56352)). [#56354](https://github.com/ClickHouse/ClickHouse/pull/56354) ([Pradeep Chhetri](https://github.com/chhetripradeep)). [#56620](https://github.com/ClickHouse/ClickHouse/pull/56620) ([Pradeep Chhetri](https://github.com/chhetripradeep)).
* Добавлена новая SQL-функция `arrayRandomSample(arr, k)`, которая возвращает выборку k элементов из входного массива. Ранее аналогичную функциональность можно было реализовать только с использованием менее удобного синтаксиса, например `SELECT arrayReduce('groupArraySample(3)', range(10))`. [#56416](https://github.com/ClickHouse/ClickHouse/pull/56416) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка данных типа `Float16` для использования в файлах `.npy`. Закрыта задача [#56344](https://github.com/ClickHouse/ClickHouse/issues/56344). [#56424](https://github.com/ClickHouse/ClickHouse/pull/56424) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлено системное представление `information_schema.statistics` для лучшей совместимости с Tableau Online. [#56425](https://github.com/ClickHouse/ClickHouse/pull/56425) ([Serge Klochkov](https://github.com/slvrtrn)).
* Добавлена таблица `system.symbols` для интроспекции бинарника. [#56548](https://github.com/ClickHouse/ClickHouse/pull/56548) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Настраиваемые дашборды. Запросы для графиков теперь по умолчанию загружаются из новой таблицы `system.dashboards`. [#56771](https://github.com/ClickHouse/ClickHouse/pull/56771) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена табличная функция `fileCluster` — она полезна, если вы монтируете общую файловую систему (NFS и подобные) в каталог `user_files`. [#56868](https://github.com/ClickHouse/ClickHouse/pull/56868) ([Andrey Zvonov](https://github.com/zvonand)).
* Добавлен виртуальный столбец `_size`, содержащий размер файла в байтах, для движков `s3/file/hdfs/url/azureBlobStorage`. [#57126](https://github.com/ClickHouse/ClickHouse/pull/57126) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена метрика Prometheus, показывающая количество ошибок для каждого кода ошибки, возникших на сервере с момента последнего перезапуска, через endpoint Prometheus. [#57209](https://github.com/ClickHouse/ClickHouse/pull/57209) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* ClickHouse Keeper сообщает о зоне доступности, в которой он запущен, по пути `/keeper/availability-zone`. Её можно настроить с помощью `<availability_zone><value>us-west-1a</value></availability_zone>`. [#56715](https://github.com/ClickHouse/ClickHouse/pull/56715) ([Jianfei Hu](https://github.com/incfly)).
* Снять экспериментальный статус `ALTER materialized_view MODIFY QUERY` и объявить устаревшей настройку `allow_experimental_alter_materialized_view_structure`. Исправляет [#15206](https://github.com/ClickHouse/ClickHouse/issues/15206). [#57311](https://github.com/ClickHouse/ClickHouse/pull/57311) ([alesapin](https://github.com/alesapin)).
* Настройка `join_algorithm` теперь учитывает указанный порядок [#51745](https://github.com/ClickHouse/ClickHouse/pull/51745) ([vdimir](https://github.com/vdimir)).
* Добавлена поддержка [стандартных типов Protobuf](https://protobuf.dev/reference/protobuf/google.protobuf/) в формате Protobuf. [#56741](https://github.com/ClickHouse/ClickHouse/pull/56741) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).

#### Повышение производительности {#performance-improvement-1}

* Адаптивные таймауты для взаимодействия с S3. Первая попытка выполняется с короткими таймаутами отправки и приёма данных. [#56314](https://github.com/ClickHouse/ClickHouse/pull/56314) ([Sema Checherinda](https://github.com/CheSema)).
* Увеличено значение по умолчанию параметра `max_concurrent_queries` со 100 до 1000. Это имеет смысл, когда есть большое количество подключающихся клиентов, которые медленно отправляют или получают данные, так что производительность сервера не ограничивается CPU, или когда число ядер CPU превышает 100. Также по умолчанию включено управление параллелизмом, а общее желаемое количество потоков обработки запросов установлено равным удвоенному числу ядер CPU. Это улучшает производительность в сценариях с очень большим количеством одновременных запросов. [#46927](https://github.com/ClickHouse/ClickHouse/pull/46927) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка параллельного вычисления оконных функций. Исправлена [#34688](https://github.com/ClickHouse/ClickHouse/issues/34688). [#39631](https://github.com/ClickHouse/ClickHouse/pull/39631) ([Dmitry Novik](https://github.com/novikd)).
* Движок таблицы `Numbers` (таблицы `system.numbers`) теперь анализирует условие запроса, чтобы сгенерировать нужное подмножество данных, аналогично индексу таблицы. [#50909](https://github.com/ClickHouse/ClickHouse/pull/50909) ([JackyWoo](https://github.com/JackyWoo)).
* Повышена производительность фильтрации по условию `IN (...)` для движка таблицы `Merge`. [#54905](https://github.com/ClickHouse/ClickHouse/pull/54905) ([Nikita Taranov](https://github.com/nickitat)).
* Улучшение, которое проявляется при полном кэше файловой системы и выполнении крупных операций чтения. [#55158](https://github.com/ClickHouse/ClickHouse/pull/55158) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена возможность отключать контрольные суммы для S3, чтобы избежать избыточных проходов по файлу (это поведение управляется настройкой `s3_disable_checksum`). [#55559](https://github.com/ClickHouse/ClickHouse/pull/55559) ([Azat Khuzhin](https://github.com/azat)).
* Теперь мы синхронно читаем из удалённых таблиц, когда данные находятся в кэше страниц (как и для локальных таблиц). Это быстрее, не требует синхронизации внутри пула потоков, позволяет свободно выполнять операции `seek` по локальной файловой системе и сокращает время простоя CPU в ожидании. [#55841](https://github.com/ClickHouse/ClickHouse/pull/55841) ([Nikita Taranov](https://github.com/nickitat)).
* Оптимизация получения значений из `map`, `arrayElement`. Это даст ускорение примерно на 30%: уменьшен объём зарезервированной памяти и сокращено число вызовов `resize`. [#55957](https://github.com/ClickHouse/ClickHouse/pull/55957) ([lgbo](https://github.com/lgbo-ustc)).
* Оптимизация многоступенчатой фильтрации с использованием AVX-512. Результаты экспериментов производительности на наборе данных OnTime на устройстве ICX (процессор Intel Xeon Platinum 8380, 80 ядер, 160 потоков) показывают, что это изменение может дать прирост QPS запросов Q2, Q3, Q4, Q5 и Q6 на 7.4%, 5.9%, 4.7%, 3.0% и 4.6% соответственно, без влияния на остальные запросы. [#56079](https://github.com/ClickHouse/ClickHouse/pull/56079) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
* Ограничено максимальное количество потоков, участвующих в профилировании запросов. Если потоков больше — они пропускают профилирование. [#56105](https://github.com/ClickHouse/ClickHouse/pull/56105) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Снижено количество вызовов виртуальных функций в оконных функциях. [#56120](https://github.com/ClickHouse/ClickHouse/pull/56120) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена поддержка рекурсивного отсечения полей `Tuple` в формате ORC для ускорения сканирования. [#56122](https://github.com/ClickHouse/ClickHouse/pull/56122) ([李扬](https://github.com/taiyang-li)).
* Простая оптимизация подсчёта для формата данных `Npy`: запросы вида `select count() from 'data.npy'` будут выполняться значительно быстрее за счёт кэширования результатов. [#56304](https://github.com/ClickHouse/ClickHouse/pull/56304) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Запросы с агрегацией и большим количеством потоков будут использовать меньше памяти при построении плана выполнения. [#57074](https://github.com/ClickHouse/ClickHouse/pull/57074) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Повышена производительность выполнения запросов для сценариев с большим числом пользователей и высокой конкурентностью запросов (&gt;2000 QPS) за счёт оптимизации доступа к ProcessList. [#57106](https://github.com/ClickHouse/ClickHouse/pull/57106) ([Andrej Hoos](https://github.com/adikus)).
* Незначительное улучшение `ARRAY JOIN`: повторное использование промежуточных результатов. [#57183](https://github.com/ClickHouse/ClickHouse/pull/57183) ([李扬](https://github.com/taiyang-li)).
* Бывали случаи, когда раскрутка стека выполнялась медленно. Больше нет. [#57221](https://github.com/ClickHouse/ClickHouse/pull/57221) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Теперь при чтении из внешнего хранилища при `max_streams = 1` используется пул чтения по умолчанию. Это особенно полезно, когда включена упреждающая выборка данных (prefetch). [#57334](https://github.com/ClickHouse/ClickHouse/pull/57334) ([Nikita Taranov](https://github.com/nickitat)).
* Улучшение Keeper: снижено потребление памяти при запуске за счёт отложенной предварительной обработки журналов. [#55660](https://github.com/ClickHouse/ClickHouse/pull/55660) ([Antonio Andelic](https://github.com/antonio2368)).
* Улучшена производительность сопоставления по маскам (glob) для хранилищ `File` и `HDFS`. [#56141](https://github.com/ClickHouse/ClickHouse/pull/56141) ([Andrey Zvonov](https://github.com/zvonand)).
* Списки постинга в экспериментальных полнотекстовых индексах теперь хранятся в сжатом виде, что уменьшает их размер на 10–30%. [#56226](https://github.com/ClickHouse/ClickHouse/pull/56226) ([Harry Lee](https://github.com/HarryLeeIBM)).
* Параллелизована работа `BackupEntriesCollector` при создании резервных копий. [#56312](https://github.com/ClickHouse/ClickHouse/pull/56312) ([Kseniia Sumarokova](https://github.com/kssenii)).

#### Улучшения {#improvement-1}

* Добавлена новая настройка `MergeTree` `add_implicit_sign_column_constraint_for_collapsing_engine` (по умолчанию отключена). При включении она добавляет неявное ограничение CHECK для таблиц `CollapsingMergeTree`, которое ограничивает значение столбца `Sign` значениями -1 и 1. [#56701](https://github.com/ClickHouse/ClickHouse/issues/56701). [#56986](https://github.com/ClickHouse/ClickHouse/pull/56986) ([Kevin Mingtarja](https://github.com/kevinmingtarja)).
* Разрешено добавлять новые диски в конфигурацию хранилища без перезапуска. [#56367](https://github.com/ClickHouse/ClickHouse/pull/56367) ([Duc Canh Le](https://github.com/canhld94)).
* Добавлена поддержка создания и материализации индекса в одном и том же запросе `ALTER`, а также возможности указывать `modify TTL` и `materialize TTL` в одном запросе. Закрывает [#55651](https://github.com/ClickHouse/ClickHouse/issues/55651). [#56331](https://github.com/ClickHouse/ClickHouse/pull/56331) ([flynn](https://github.com/ucasfl)).
* Добавлена новая табличная функция `fuzzJSON`, возвращающая строки с модифицированными версиями исходной JSON-строки со случайными вариациями. [#56490](https://github.com/ClickHouse/ClickHouse/pull/56490) ([Julia Kartseva](https://github.com/jkartseva)).
* Движок `Merge` фильтрует записи в соответствии с политиками строк исходных таблиц, поэтому нет необходимости создавать отдельную политику строк для таблицы `Merge`. [#50209](https://github.com/ClickHouse/ClickHouse/pull/50209) ([Ilya Golshtein](https://github.com/ilejn)).
* Добавлена настройка `max_execution_time_leaf` для ограничения времени выполнения на сегменте при распределённом запросе и `timeout_overflow_mode_leaf` для управления поведением при срабатывании тайм-аута. [#51823](https://github.com/ClickHouse/ClickHouse/pull/51823) ([Duc Canh Le](https://github.com/canhld94)).
* Добавлена настройка ClickHouse, позволяющая отключить туннелирование HTTPS‑запросов через HTTP‑прокси. [#55033](https://github.com/ClickHouse/ClickHouse/pull/55033) ([Arthur Passos](https://github.com/arthurpassos)).
* Параметр `background_fetches_pool_size` установлен в 16, а background&#95;schedule&#95;pool&#95;size — в 512; такая конфигурация лучше подходит для эксплуатации в продакшене с частыми небольшими вставками. [#54327](https://github.com/ClickHouse/ClickHouse/pull/54327) ([Denny Crane](https://github.com/den-crane)).
* При чтении данных из файла в формате CSV, если в конце строки стоит `\r`, за которым не следует `\n`, возникает исключение вида: `Cannot parse CSV format: found \r (CR) not followed by \n (LF). Line must end by \n (LF) or \r\n (CR LF) or \n\r.` В ClickHouse конец строки в CSV должен быть `\n` или `\r\n` или `\n\r`, поэтому символ `\r` должен сопровождаться `\n`, но в некоторых случаях входные CSV-данные могут быть некорректными, как в примере выше, когда `\r` стоит в конце строки. [#54340](https://github.com/ClickHouse/ClickHouse/pull/54340) ([KevinyhZou](https://github.com/KevinyhZou)).
* Библиотека Arrow обновлена до релиза 13.0.0 с поддержкой новых кодировок. Закрыта задача [#44505](https://github.com/ClickHouse/ClickHouse/issues/44505). [#54800](https://github.com/ClickHouse/ClickHouse/pull/54800) ([Kruglov Pavel](https://github.com/Avogar)).
* Улучшена производительность запросов `ON CLUSTER` за счет удаления ресурсоемких системных вызовов для получения всех сетевых интерфейсов при поиске локального IP-адреса в списке хостов в записи DDL. [#54909](https://github.com/ClickHouse/ClickHouse/pull/54909) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлен учет памяти, выделенной до привязки потока к запросу или пользователю. [#56089](https://github.com/ClickHouse/ClickHouse/pull/56089) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлена поддержка `LARGE_LIST` в форматах Apache Arrow. [#56118](https://github.com/ClickHouse/ClickHouse/pull/56118) ([edef](https://github.com/edef1c)).
* Добавлена возможность ручной компакции `EmbeddedRocksDB` с помощью запроса `OPTIMIZE`. [#56225](https://github.com/ClickHouse/ClickHouse/pull/56225) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена возможность задавать BlockBasedTableOptions для таблиц `EmbeddedRocksDB`. [#56264](https://github.com/ClickHouse/ClickHouse/pull/56264) ([Azat Khuzhin](https://github.com/azat)).
* `SHOW COLUMNS` теперь отображает эквивалентное имя типа данных MySQL, если соединение установлено через протокол MySQL. Ранее так было только при установке `use_mysql_types_in_show_columns = 1`. Настройка сохранена, но помечена как устаревшая. [#56277](https://github.com/ClickHouse/ClickHouse/pull/56277) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена возможная ошибка `The local set of parts of table doesn't look like the set of parts in ZooKeeper`, возникавшая при перезапуске сервера сразу после выполнения `TRUNCATE` или `DROP PARTITION`. [#56282](https://github.com/ClickHouse/ClickHouse/pull/56282) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена обработка неконстантных строк запросов в функциях `formatQuery`/`formatQuerySingleLine`. Также добавлены варианты обеих функций с суффиксом `OrNull`, которые возвращают NULL, если запрос не удаётся разобрать, вместо выбрасывания исключения. [#56327](https://github.com/ClickHouse/ClickHouse/pull/56327) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена возможность создания резервной копии materialized view с удалённой внутренней таблицей вместо завершения операции с ошибкой. [#56387](https://github.com/ClickHouse/ClickHouse/pull/56387) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Запросы к `system.replicas` инициируют обращения к ZooKeeper при выборке некоторых столбцов. Когда таблиц тысячи, эти обращения могут создавать значительную нагрузку на ZooKeeper. Если выполняется несколько одновременных запросов к `system.replicas`, они повторяют одни и те же обращения многократно. Изменение позволяет «дедуплицировать» обращения, выполняемые параллельными запросами. [#56420](https://github.com/ClickHouse/ClickHouse/pull/56420) ([Alexander Gololobov](https://github.com/davenger)).
* Исправлена трансляция в MySQL-совместимый запрос при обращении к внешним базам данных. [#56456](https://github.com/ClickHouse/ClickHouse/pull/56456) ([flynn](https://github.com/ucasfl)).
* Добавлена поддержка резервного копирования и восстановления таблиц с использованием движка `KeeperMap`. [#56460](https://github.com/ClickHouse/ClickHouse/pull/56460) ([Antonio Andelic](https://github.com/antonio2368)).
* Ответ 404 на CompleteMultipartUpload следует проверять повторно. Операция могла быть завершена на сервере, даже если клиент получил таймаут или другие сетевые ошибки. При следующей попытке CompleteMultipartUpload возвращается ответ 404. Если ключ объекта существует, эта операция считается успешной. [#56475](https://github.com/ClickHouse/ClickHouse/pull/56475) ([Sema Checherinda](https://github.com/CheSema)).
* По умолчанию включён метод HTTP OPTIONS — это упрощает выполнение запросов к ClickHouse из веб-браузера. [#56483](https://github.com/ClickHouse/ClickHouse/pull/56483) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Значение параметра `dns_max_consecutive_failures` было по ошибке изменено в [#46550](https://github.com/ClickHouse/ClickHouse/issues/46550) — это изменение отменено, а значение скорректировано на более подходящее. Также увеличен таймаут HTTP keep-alive до разумного значения, используемого в продакшене. [#56485](https://github.com/ClickHouse/ClickHouse/pull/56485) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Ленивая загрузка базовых бэкапов (базовый бэкап загружается только при необходимости). Также добавлены сообщения журнала и события профилирования для бэкапов. [#56516](https://github.com/ClickHouse/ClickHouse/pull/56516) ([Vitaly Baranov](https://github.com/vitlibar)).
* Параметр `query_cache_store_results_of_queries_with_nondeterministic_functions` (со значениями `false` или `true`) объявлен устаревшим. Его заменил параметр `query_cache_nondeterministic_function_handling` — перечисление (enum) с тремя значениями, которое определяет, как кэш запросов обрабатывает запросы с недетерминированными функциями: a) выбросить исключение (поведение по умолчанию), b) всё равно сохранить результат недетерминированного запроса или c) игнорировать, то есть не выбрасывать исключение и не кэшировать результат. [#56519](https://github.com/ClickHouse/ClickHouse/pull/56519) ([Robert Schulze](https://github.com/rschu1ze)).
* Проверка на равенство в секции JOIN ON теперь переписывается в проверку `is null`. Экспериментальная возможность, *только Analyzer*. [#56538](https://github.com/ClickHouse/ClickHouse/pull/56538) ([vdimir](https://github.com/vdimir)).
* Функция `concat` теперь поддерживает аргументы произвольных типов, а не только аргументы типов String и FixedString. Это делает её поведение более похожим на реализацию функции `concat` в MySQL. Например, `SELECT concat('ab', 42)` теперь возвращает `ab42`. [#56540](https://github.com/ClickHouse/ClickHouse/pull/56540) ([Serge Klochkov](https://github.com/slvrtrn)).
* Добавлена возможность получения конфигурации кэша из секции &#39;named&#95;collection&#39; в конфигурации или из созданных через SQL именованных коллекций. [#56541](https://github.com/ClickHouse/ClickHouse/pull/56541) ([Kseniia Sumarokova](https://github.com/kssenii)).
* PostgreSQL database engine: сделать удаление устаревших таблиц менее агрессивным в случае неуспешного подключения к PostgreSQL. [#56609](https://github.com/ClickHouse/ClickHouse/pull/56609) ([jsc0218](https://github.com/jsc0218)).
* Подключение к PostgreSQL занимало слишком много времени при неверно указанном URL, в результате соответствующий запрос зависал и затем отменялся. [#56648](https://github.com/ClickHouse/ClickHouse/pull/56648) ([jsc0218](https://github.com/jsc0218)).
* Улучшение Keeper: по умолчанию отключено сжатое логирование в Keeper. [#56763](https://github.com/ClickHouse/ClickHouse/pull/56763) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена конфигурационная настройка `wait_dictionaries_load_at_startup`. [#56782](https://github.com/ClickHouse/ClickHouse/pull/56782) ([Vitaly Baranov](https://github.com/vitlibar)).
* В предыдущих версиях ClickHouse существовала потенциальная уязвимость: если пользователь подключался и безуспешно пытался аутентифицироваться с помощью метода «interserver secret», сервер не завершал соединение немедленно, а продолжал принимать и игнорировать оставшиеся пакеты от клиента. Хотя эти пакеты игнорируются, они всё равно разбираются, и если в них используется метод сжатия с другой известной уязвимостью, это приводит к эксплуатации этой уязвимости без аутентификации. Эта проблема была обнаружена в рамках [ClickHouse Bug Bounty Program](https://github.com/ClickHouse/ClickHouse/issues/38986) пользователем [https://twitter.com/malacupa](https://twitter.com/malacupa). [#56794](https://github.com/ClickHouse/ClickHouse/pull/56794) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Получение части ожидает, пока эта часть будет полностью зафиксирована на удалённой реплике. Не следует отправлять часть в состоянии PreActive. В случае zero copy это жёсткое требование. [#56808](https://github.com/ClickHouse/ClickHouse/pull/56808) ([Sema Checherinda](https://github.com/CheSema)).
* Исправлена потенциальная ошибка преобразования логической репликации PostgreSQL при использовании экспериментального `MaterializedPostgreSQL`. [#53721](https://github.com/ClickHouse/ClickHouse/pull/53721) ([takakawa](https://github.com/takakawa)).
* Реализована пользовательская настройка `alter_move_to_space_execute_async`, позволяющая выполнять запросы `ALTER TABLE ... MOVE PARTITION|PART TO DISK|VOLUME` асинхронно. Размер пула для фонового выполнения контролируется параметром `background_move_pool_size`. Поведение по умолчанию — синхронное выполнение. Исправлена [#47643](https://github.com/ClickHouse/ClickHouse/issues/47643). [#56809](https://github.com/ClickHouse/ClickHouse/pull/56809) ([alesapin](https://github.com/alesapin)).
* Добавлена возможность фильтровать по движку при сканировании `system.tables`, чтобы избежать лишних (потенциально затратных по времени) подключений. [#56813](https://github.com/ClickHouse/ClickHouse/pull/56813) ([jsc0218](https://github.com/jsc0218)).
* Добавлен вывод `total_bytes` и `total_rows` в системных таблицах для хранилища RocksDB. [#56816](https://github.com/ClickHouse/ClickHouse/pull/56816) ([Aleksandr Musorin](https://github.com/AVMusorin)).
* Разрешить базовые команды ALTER для временных таблиц. [#56892](https://github.com/ClickHouse/ClickHouse/pull/56892) ([Sergey](https://github.com/icuken)).
* Сжатие LZ4. Буферизация сжатого блока в редких случаях, когда ёмкости выходного буфера недостаточно, чтобы записать его напрямую. [#56938](https://github.com/ClickHouse/ClickHouse/pull/56938) ([Sema Checherinda](https://github.com/CheSema)).
* Добавлены метрики для числа заданий в очереди, что полезно для пула потоков ввода-вывода. [#56958](https://github.com/ClickHouse/ClickHouse/pull/56958) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена настройка движка таблиц PostgreSQL в конфигурационный файл. Добавлена проверка этой настройки. Добавлена документация по этой дополнительной настройке. [#56959](https://github.com/ClickHouse/ClickHouse/pull/56959) ([Peignon Melvyn](https://github.com/melvynator)).
* Функцию `concat` теперь можно вызывать с одним аргументом, например `SELECT concat('abc')`. Это делает ее поведение более согласованным с реализацией функции `concat` в MySQL. [#57000](https://github.com/ClickHouse/ClickHouse/pull/57000) ([Serge Klochkov](https://github.com/slvrtrn)).
* Подписывает все заголовки `x-amz-*`, как того требует документация AWS S3. [#57001](https://github.com/ClickHouse/ClickHouse/pull/57001) ([Arthur Passos](https://github.com/arthurpassos)).
* Функцию `fromDaysSinceYearZero` (псевдоним: `FROM_DAYS`) теперь можно использовать со знаковыми и беззнаковыми целочисленными типами данных (ранее требовался беззнаковый целочисленный тип). Это повышает совместимость со сторонними инструментами, такими как Tableau Online. [#57002](https://github.com/ClickHouse/ClickHouse/pull/57002) ([Serge Klochkov](https://github.com/slvrtrn)).
* Добавлен `system.s3queue_log` в конфигурацию по умолчанию. [#57036](https://github.com/ClickHouse/ClickHouse/pull/57036) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Измените значение по умолчанию для `wait_dictionaries_load_at_startup` на true и используйте эту настройку только если `dictionaries_lazy_load` имеет значение false. [#57133](https://github.com/ClickHouse/ClickHouse/pull/57133) ([Vitaly Baranov](https://github.com/vitlibar)).
* Проверять тип источника словаря при создании словаря, даже если `dictionaries_lazy_load` включен. [#57134](https://github.com/ClickHouse/ClickHouse/pull/57134) ([Vitaly Baranov](https://github.com/vitlibar)).
* Оптимизации на уровне плана теперь можно включать и отключать по отдельности. Ранее можно было только отключить их все разом. Настройка, которая ранее использовалась для этого (`query_plan_enable_optimizations`), сохранена и по‑прежнему может использоваться для отключения всех оптимизаций. [#57152](https://github.com/ClickHouse/ClickHouse/pull/57152) ([Robert Schulze](https://github.com/rschu1ze)).
* Код завершения сервера будет соответствовать коду исключения. Например, если сервер не может запуститься из-за ограничения памяти, он завершится с кодом 241 = MEMORY&#95;LIMIT&#95;EXCEEDED. В предыдущих версиях код завершения для исключений всегда был 70 = Poco::Util::ExitCode::EXIT&#95;SOFTWARE. [#57153](https://github.com/ClickHouse/ClickHouse/pull/57153) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Не выполнять деманглирование и символизацию кадров стека из заголовочного файла C++ `functional`. [#57201](https://github.com/ClickHouse/ClickHouse/pull/57201) ([Mike Kot](https://github.com/myrrc)).
* Страница HTTP-сервера `/dashboard` теперь поддерживает многолинейные графики. [#57236](https://github.com/ClickHouse/ClickHouse/pull/57236) ([Sergei Trifonov](https://github.com/serxa)).
* Параметр командной строки `max_memory_usage_in_client` поддерживает строковое значение с суффиксом единицы измерения (K, M, G и т. д.). Закрывает задачу [#56879](https://github.com/ClickHouse/ClickHouse/issues/56879). [#57273](https://github.com/ClickHouse/ClickHouse/pull/57273) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Обновлена Intel QPL (используется кодеком `DEFLATE_QPL`) с v1.2.0 до v1.3.1. Также исправлена ошибка для случая BOF (Block on Fault) = 0: теперь при возникновении ошибок страниц памяти (page faults) выполняется переход на программный (SW) путь. [#57291](https://github.com/ClickHouse/ClickHouse/pull/57291) ([jasperzhu](https://github.com/jinjunzh)).
* Увеличено значение по умолчанию настройки `replicated_deduplication_window` в MergeTree со 100 до 1k. [#57335](https://github.com/ClickHouse/ClickHouse/pull/57335) ([sichenzhao](https://github.com/sichenzhao)).
* Реже использовать `INCONSISTENT_METADATA_FOR_BACKUP`. По возможности лучше продолжать сканирование вместо его остановки и последующего запуска сканирования резервной копии с самого начала. [#57385](https://github.com/ClickHouse/ClickHouse/pull/57385) ([Vitaly Baranov](https://github.com/vitlibar)).

#### Улучшения в сборке/тестировании/упаковке {#buildtestingpackaging-improvement-1}

* Добавлен тест SQLLogic. [#56078](https://github.com/ClickHouse/ClickHouse/pull/56078) ([Han Fei](https://github.com/hanfei1991)).
* Для удобства `clickhouse-local` и `clickhouse-client` доступны под короткими именами (`ch`, `chl`, `chc`). [#56634](https://github.com/ClickHouse/ClickHouse/pull/56634) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Дополнительно оптимизирован размер сборки за счёт удаления неиспользуемого кода из внешних библиотек. [#56786](https://github.com/ClickHouse/ClickHouse/pull/56786) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена автоматическая проверка на отсутствие слишком крупных единиц трансляции. [#56559](https://github.com/ClickHouse/ClickHouse/pull/56559) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Уменьшен размер однобинарного дистрибутива. Это закрывает [#55181](https://github.com/ClickHouse/ClickHouse/issues/55181). [#56617](https://github.com/ClickHouse/ClickHouse/pull/56617) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Информация о размерах каждой единицы трансляции и бинарного файла после каждой сборки будет отправляться в CI-базу данных ClickHouse Cloud. Это закрывает [#56107](https://github.com/ClickHouse/ClickHouse/issues/56107). [#56636](https://github.com/ClickHouse/ClickHouse/pull/56636) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Некоторые файлы библиотеки "Apache Arrow" (которую мы используем только для второстепенных задач, таких как разбор формата arrow) каждый раз пересобирались независимо от кэша сборки. Это исправлено. [#56657](https://github.com/ClickHouse/ClickHouse/pull/56657) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исключена повторная компиляция единиц трансляции, зависящих от автогенерируемого исходного файла с информацией о версии. [#56660](https://github.com/ClickHouse/ClickHouse/pull/56660) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Трассировочные данные запусков компоновщика будут отправляться в CI-базу данных ClickHouse Cloud. [#56725](https://github.com/ClickHouse/ClickHouse/pull/56725) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Для исполняемого файла clickhouse используются отладочные символы DWARF 5 (ранее использовался DWARF 4). [#56770](https://github.com/ClickHouse/ClickHouse/pull/56770) ([Michael Kolupaev](https://github.com/al13n321)).
* Добавлена новая опция сборки `SANITIZE_COVERAGE`. Если она включена, код инструментируется для отслеживания покрытия. Собранная информация доступна внутри ClickHouse с помощью: (1) новой функции `coverage`, которая возвращает массив уникальных адресов в коде, найденных после предыдущего сброса покрытия; (2) запроса `SYSTEM RESET COVERAGE`, который сбрасывает накопленные данные. Это позволяет сравнивать покрытие разных тестов, включая дифференциальное покрытие кода. Продолжение [#20539](https://github.com/ClickHouse/ClickHouse/issues/20539). [#56102](https://github.com/ClickHouse/ClickHouse/pull/56102) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Некоторые фреймы стека могут не разрешаться при сборе стеков. В таких случаях может быть полезен сам адрес. [#56267](https://github.com/ClickHouse/ClickHouse/pull/56267) ([Alexander Gololobov](https://github.com/davenger)).
* Добавлена опция для отключения `libssh`. [#56333](https://github.com/ClickHouse/ClickHouse/pull/56333) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* В S3-тестах в CI включён `temporary_data_in_cache`. [#48425](https://github.com/ClickHouse/ClickHouse/pull/48425) ([vdimir](https://github.com/vdimir)).
* В CI установлено максимальное потребление памяти для clickhouse-client (`1G`). [#56873](https://github.com/ClickHouse/ClickHouse/pull/56873) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).

#### Исправление ошибки (некорректное поведение, заметное пользователю, в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-1}

* Исправлен экспериментальный Analyzer — при вставке из SELECT с подзапросом, ссылающимся на таблицу, в которую выполняется вставка, он должен обрабатывать только вставляемый блок. [#50857](https://github.com/ClickHouse/ClickHouse/pull/50857) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена ошибка в функции `str_to_map`. [#56423](https://github.com/ClickHouse/ClickHouse/pull/56423) ([Arthur Passos](https://github.com/arthurpassos)).
* Keeper `reconfig`: добавлен тайм-аут перед передачей/получением роли лидера [#53481](https://github.com/ClickHouse/ClickHouse/pull/53481) ([Mike Kot](https://github.com/myrrc)).
* Исправлен некорректный заголовок в grace hash join и при проталкивании фильтра [#53922](https://github.com/ClickHouse/ClickHouse/pull/53922) ([vdimir](https://github.com/vdimir)).
* Разрешён выбор из системных таблиц, когда таблица основана на табличной функции. [#55540](https://github.com/ClickHouse/ClickHouse/pull/55540) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* RFC: Исправление ошибки «Cannot find column X in source stream» для распределённых запросов с LIMIT BY [#55836](https://github.com/ClickHouse/ClickHouse/pull/55836) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка «Cannot read from file:» при запуске клиента в фоновом режиме [#55976](https://github.com/ClickHouse/ClickHouse/pull/55976) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено аварийное завершение clickhouse-local при некорректном значении параметра send&#95;logs&#95;level [#55994](https://github.com/ClickHouse/ClickHouse/pull/55994) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка в EXPLAIN AST с параметризованным представлением [#56004](https://github.com/ClickHouse/ClickHouse/pull/56004) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлен сбой при загрузке таблицы во время запуска [#56232](https://github.com/ClickHouse/ClickHouse/pull/56232) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлены словари с источником данных ClickHouse, использующие явный запрос [#56236](https://github.com/ClickHouse/ClickHouse/pull/56236) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлен segfault в обработчике сигналов Keeper [#56266](https://github.com/ClickHouse/ClickHouse/pull/56266) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена проблема с неполным результатом запроса при использовании UNION в функции view(). [#56274](https://github.com/ClickHouse/ClickHouse/pull/56274) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Устранена несогласованность между &quot;cast(&#39;0&#39; as DateTime64(3))&quot; и &quot;cast(&#39;0&#39; as Nullable(DateTime64(3)))&quot; [#56286](https://github.com/ClickHouse/ClickHouse/pull/56286) ([李扬](https://github.com/taiyang-li)).
* Исправлено редкое состояние гонки, связанное с ошибкой выделения памяти [#56303](https://github.com/ClickHouse/ClickHouse/pull/56303) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка восстановления из резервной копии при использовании `flatten_nested` и `data_type_default_nullable` [#56306](https://github.com/ClickHouse/ClickHouse/pull/56306) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка, приводившая к сбою при добавлении столбца типа Object(JSON) [#56307](https://github.com/ClickHouse/ClickHouse/pull/56307) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлено падение в `filterPushDown` [#56380](https://github.com/ClickHouse/ClickHouse/pull/56380) ([vdimir](https://github.com/vdimir)).
* Исправлено восстановление из резервной копии при наличии материализованного представления и удалённой исходной таблицы [#56383](https://github.com/ClickHouse/ClickHouse/pull/56383) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен segfault во время инициализации Kerberos [#56401](https://github.com/ClickHouse/ClickHouse/pull/56401) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлено переполнение буфера в T64 [#56434](https://github.com/ClickHouse/ClickHouse/pull/56434) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена работа Nullable первичного ключа в FINAL (2) [#56452](https://github.com/ClickHouse/ClickHouse/pull/56452) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка в запросах ON CLUSTER без базы данных на инициирующем узле [#56484](https://github.com/ClickHouse/ClickHouse/pull/56484) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлен сбой запуска из-за зависимости TTL [#56489](https://github.com/ClickHouse/ClickHouse/pull/56489) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена работа запросов ALTER COMMENT с ON CLUSTER [#56491](https://github.com/ClickHouse/ClickHouse/pull/56491) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена работа ALTER COLUMN с ALIAS [#56493](https://github.com/ClickHouse/ClickHouse/pull/56493) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена обработка пустых NAMED COLLECTIONs [#56494](https://github.com/ClickHouse/ClickHouse/pull/56494) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлены две ошибки в анализе проекций. [#56502](https://github.com/ClickHouse/ClickHouse/pull/56502) ([Amos Bird](https://github.com/amosbird)).
* Исправлена обработка алиасов в кэше запросов [#56545](https://github.com/ClickHouse/ClickHouse/pull/56545) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлено преобразование из `Nullable(Enum)` в `Nullable(String)` [#56644](https://github.com/ClickHouse/ClickHouse/pull/56644) ([Nikolay Degterinsky](https://github.com/evillique)).
* Более надёжная обработка логов в Keeper [#56670](https://github.com/ClickHouse/ClickHouse/pull/56670) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено слияние конфигурации для узлов с атрибутами подстановки [#56694](https://github.com/ClickHouse/ClickHouse/pull/56694) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлено дублирующееся использование табличной функции input(). [#56695](https://github.com/ClickHouse/ClickHouse/pull/56695) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена проблема с динамической загрузкой OpenSSL для RabbitMQ [#56703](https://github.com/ClickHouse/ClickHouse/pull/56703) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлено падение кодека GCD при наличии нулей в данных [#56704](https://github.com/ClickHouse/ClickHouse/pull/56704) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена ошибка &#39;mutex lock failed: Invalid argument&#39; в clickhouse-local при вставке в функцию [#56710](https://github.com/ClickHouse/ClickHouse/pull/56710) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен разбор текстового представления Date в оптимистичном пути выполнения [#56765](https://github.com/ClickHouse/ClickHouse/pull/56765) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено аварийное завершение в кодеке FPC [#56795](https://github.com/ClickHouse/ClickHouse/pull/56795) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* DatabaseReplicated: исправлен таймаут DDL-запроса после восстановления реплики [#56796](https://github.com/ClickHouse/ClickHouse/pull/56796) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена некорректная передача информации о столбцах Nullable в двоичном протоколе MySQL [#56799](https://github.com/ClickHouse/ClickHouse/pull/56799) ([Serge Klochkov](https://github.com/slvrtrn)).
* Добавлена поддержка файлов метаданных Iceberg в таблицах метахранилища [#56810](https://github.com/ClickHouse/ClickHouse/pull/56810) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено сообщение TSAN для transform [#56817](https://github.com/ClickHouse/ClickHouse/pull/56817) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено форматирование запроса SET и SETTINGS [#56825](https://github.com/ClickHouse/ClickHouse/pull/56825) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлен сбой запуска из-за зависимости таблицы в joinGet [#56828](https://github.com/ClickHouse/ClickHouse/pull/56828) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена проблема с уплощением существующих столбцов типа Nested при выполнении ADD COLUMN [#56830](https://github.com/ClickHouse/ClickHouse/pull/56830) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлено: допускается символ CR (возврат каретки) в конце строки в CSV [#56901](https://github.com/ClickHouse/ClickHouse/pull/56901) ([KevinyhZou](https://github.com/KevinyhZou)).
* Исправлена ошибка в функции `tryBase64Decode` при обработке некорректного ввода [#56913](https://github.com/ClickHouse/ClickHouse/pull/56913) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена ошибка генерации глубоко вложенных столбцов в схемах CapnProto/Protobuf [#56941](https://github.com/ClickHouse/ClickHouse/pull/56941) ([Kruglov Pavel](https://github.com/Avogar)).
* Предотвращено выполнение несовместимого ALTER над столбцами PROJECTION [#56948](https://github.com/ClickHouse/ClickHouse/pull/56948) ([Amos Bird](https://github.com/amosbird)).
* Исправлена проверка пути к файлу SQLite [#56984](https://github.com/ClickHouse/ClickHouse/pull/56984) ([San](https://github.com/santrancisco)).
* S3Queue: исправлено увеличение счётчика ссылок на метаданные [#56990](https://github.com/ClickHouse/ClickHouse/pull/56990) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Небольшое исправление в S3Queue [#56999](https://github.com/ClickHouse/ClickHouse/pull/56999) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена валидация пути к файлу для DatabaseFileSystem [#57029](https://github.com/ClickHouse/ClickHouse/pull/57029) ([San](https://github.com/santrancisco)).
* Исправлена ошибка в `fuzzBits` при использовании с `ARRAY JOIN` [#57033](https://github.com/ClickHouse/ClickHouse/pull/57033) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено разыменование nullptr в частичном merge join с joined&#95;subquery&#95;re... [#57048](https://github.com/ClickHouse/ClickHouse/pull/57048) ([vdimir](https://github.com/vdimir)).
* Исправлена гонка условий в RemoteSource [#57052](https://github.com/ClickHouse/ClickHouse/pull/57052) ([Raúl Marín](https://github.com/Algunenano)).
* Реализована `bitHammingDistance` для больших целых чисел [#57073](https://github.com/ClickHouse/ClickHouse/pull/57073) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправление ошибки с ссылками в стиле S3 [#57075](https://github.com/ClickHouse/ClickHouse/pull/57075) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена ошибка в функции JSON&#95;QUERY с несколькими числовыми путями [#57096](https://github.com/ClickHouse/ClickHouse/pull/57096) ([KevinyhZou](https://github.com/KevinyhZou)).
* Исправлено переполнение буфера в кодеке Gorilla [#57107](https://github.com/ClickHouse/ClickHouse/pull/57107) ([Nikolay Degterinsky](https://github.com/evillique)).
* Закрывать межсерверное соединение при возникновении любого исключения до аутентификации [#57142](https://github.com/ClickHouse/ClickHouse/pull/57142) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлен segfault после выполнения ALTER UPDATE для столбца Nullable MATERIALIZED [#57147](https://github.com/ClickHouse/ClickHouse/pull/57147) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена некорректная оптимизация плана выполнения JOIN с частично материализованной обычной проекцией [#57196](https://github.com/ClickHouse/ClickHouse/pull/57196) ([Amos Bird](https://github.com/amosbird)).
* При сравнении описаний столбцов комментарии игнорируются [#57259](https://github.com/ClickHouse/ClickHouse/pull/57259) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена метрика `ReadonlyReplica` для всех случаев [#57267](https://github.com/ClickHouse/ClickHouse/pull/57267) ([Antonio Andelic](https://github.com/antonio2368)).
* Фоновые слияния теперь корректно используют временное хранилище данных в кэше [#57275](https://github.com/ClickHouse/ClickHouse/pull/57275) ([vdimir](https://github.com/vdimir)).
* Исправление в Keeper для журнала изменений и снимков состояния [#57299](https://github.com/ClickHouse/ClickHouse/pull/57299) ([Antonio Andelic](https://github.com/antonio2368)).
* Игнорировать завершённые задачи ON CLUSTER, если имя хоста изменилось [#57339](https://github.com/ClickHouse/ClickHouse/pull/57339) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Мутации в MergeTree повторно используют гранулярность индекса исходной части [#57352](https://github.com/ClickHouse/ClickHouse/pull/57352) ([Maksim Kita](https://github.com/kitaisreal)).
* FS cache: добавлено ограничение на фоновую загрузку [#57424](https://github.com/ClickHouse/ClickHouse/pull/57424) ([Kseniia Sumarokova](https://github.com/kssenii)).

### <a id="2310"></a> Релиз ClickHouse 23.10 от 2 ноября 2023 г. [Презентация](https://presentations.clickhouse.com/2023-release-23.10/), [Видео](https://www.youtube.com/watch?v=PGQS6uPb970) {#2310}

<iframe width="1024" height="576" src="https://www.youtube.com/embed/PGQS6uPb970" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

#### Несовместимые изменения с предыдущими версиями {#backward-incompatible-change-2}

* Больше нет возможности автоматически удалять повреждённые части данных. Это закрывает [#55174](https://github.com/ClickHouse/ClickHouse/issues/55174). [#55184](https://github.com/ClickHouse/ClickHouse/pull/55184) ([Alexey Milovidov](https://github.com/alexey-milovidov)). [#55557](https://github.com/ClickHouse/ClickHouse/pull/55557) ([Jihyuk Bok](https://github.com/tomahawk28)).
* Устаревшие части данных в памяти больше не могут считываться из журнала предзаписи (write-ahead log). Если у вас ранее были настроены части данных в памяти (in-memory parts), их необходимо удалить перед обновлением. [#55186](https://github.com/ClickHouse/ClickHouse/pull/55186) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Удалена интеграция с Meilisearch. Причина: она была совместима только со старой версией 0.18. В последней версии Meilisearch протокол был изменён, и интеграция больше не работает. Примечание: мы будем признательны, если вы поможете вернуть её обратно. [#55189](https://github.com/ClickHouse/ClickHouse/pull/55189) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Переименована концепция directory monitor в background INSERT. Все настройки `*directory_monitor*` были переименованы в `distributed_background_insert*`. *Обратная совместимость должна сохраняться* (так как старые настройки были добавлены как алиасы). [#55978](https://github.com/ClickHouse/ClickHouse/pull/55978) ([Azat Khuzhin](https://github.com/azat)).
* `send_timeout`, установленный на стороне клиента, больше не интерпретируется как `receive_timeout` на стороне сервера, и наоборот. [#56035](https://github.com/ClickHouse/ClickHouse/pull/56035) ([Azat Khuzhin](https://github.com/azat)).
* Сравнение временных интервалов с разными единицами измерения теперь будет выбрасывать исключение. Это закрывает [#55942](https://github.com/ClickHouse/ClickHouse/issues/55942). Ранее вы могли неосознанно полагаться на поведение, при котором сравнивались лежащие в основе числовые значения независимо от единиц измерения. [#56090](https://github.com/ClickHouse/ClickHouse/pull/56090) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Полностью переработан экспериментальный движок таблиц `S3Queue`: изменён способ хранения информации в ZooKeeper, что позволяет выполнять меньше запросов в ZooKeeper, добавлено кеширование состояния ZooKeeper в случаях, когда известно, что состояние не изменится, улучшен процесс опроса S3, чтобы сделать его менее агрессивным, изменён способ обслуживания TTL и max для отслеживаемых файлов — теперь это фоновый процесс. Добавлены таблицы `system.s3queue` и `system.s3queue_log`. Закрывает [#54998](https://github.com/ClickHouse/ClickHouse/issues/54998). [#54422](https://github.com/ClickHouse/ClickHouse/pull/54422) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Произвольные пути на HTTP-эндпоинте больше не интерпретируются как запрос к эндпоинту `/query`. [#55521](https://github.com/ClickHouse/ClickHouse/pull/55521) ([Konstantin Bogdanov](https://github.com/thevar1able)).

#### Новые возможности {#new-feature-2}

* Добавлена функция `arrayFold(accumulator, x1, ..., xn -> expression, initial, array1, ..., arrayn)`, которая применяет лямбда-функцию к нескольким массивам одинаковой длины и накапливает результат в аккумуляторе. [#49794](https://github.com/ClickHouse/ClickHouse/pull/49794) ([Lirikl](https://github.com/Lirikl)).
* Поддержка формата `Npy`. `SELECT * FROM file('example_array.npy', Npy)`. [#55982](https://github.com/ClickHouse/ClickHouse/pull/55982) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Если таблица имеет в своём ключе кривую, заполняющую пространство, например `ORDER BY mortonEncode(x, y)`, то условия по её аргументам, например `x >= 10 AND x <= 20 AND y >= 20 AND y <= 30`, могут использоваться для индексации. Добавлена настройка `analyze_index_with_space_filling_curves` для включения или отключения этого анализа. Закрывает [#41195](https://github.com/ClickHouse/ClickHouse/issue/41195). Продолжение [#4538](https://github.com/ClickHouse/ClickHouse/pull/4538). Продолжение [#6286](https://github.com/ClickHouse/ClickHouse/pull/6286). Продолжение [#28130](https://github.com/ClickHouse/ClickHouse/pull/28130). Продолжение [#41753](https://github.com/ClickHouse/ClickHouse/pull/#41753). [#55642](https://github.com/ClickHouse/ClickHouse/pull/55642) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена новая настройка `force_optimize_projection_name`, принимающая имя проекции в качестве аргумента. Если ей присвоено непустое значение, ClickHouse проверяет, что эта проекция используется в запросе хотя бы один раз. Закрывает [#55331](https://github.com/ClickHouse/ClickHouse/issues/55331). [#56134](https://github.com/ClickHouse/ClickHouse/pull/56134) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена поддержка асинхронных вставок с внешними данными через нативный протокол. Ранее это работало только в случае, если данные передавались внутри запроса. [#54730](https://github.com/ClickHouse/ClickHouse/pull/54730) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена агрегатная функция `lttb`, которая использует алгоритм [Largest-Triangle-Three-Buckets](https://skemman.is/bitstream/1946/15343/3/SS_MSthesis.pdf) для даунсемплинга (уменьшения объёма) данных при визуализации. [#53145](https://github.com/ClickHouse/ClickHouse/pull/53145) ([Sinan](https://github.com/sinsinan)).
* Запрос `CHECK TABLE` теперь обладает лучшей производительностью и удобством использования (отправляет уведомления о ходе выполнения, может быть отменён). Поддерживается проверка конкретной части с помощью `CHECK TABLE ... PART 'part_name'`. [#53404](https://github.com/ClickHouse/ClickHouse/pull/53404) ([vdimir](https://github.com/vdimir)).
* Добавлена функция `jsonMergePatch`. При работе с JSON-данными в виде строк она предоставляет способ объединять эти строки, каждая из которых содержит JSON-объект, в одну строку с одним JSON-объектом. [#54364](https://github.com/ClickHouse/ClickHouse/pull/54364) ([Memo](https://github.com/Joeywzr)).
* Вторая часть поддержки диалекта Kusto Query Language. [Реализация фазы 1](https://github.com/ClickHouse/ClickHouse/pull/37961) уже объединена. [#42510](https://github.com/ClickHouse/ClickHouse/pull/42510) ([larryluogit](https://github.com/larryluogit)).
* Добавлена новая SQL-функция `arrayRandomSample(arr, k)`, которая возвращает выборку из k элементов входного массива. Ранее аналогичную функциональность можно было реализовать только с помощью менее удобного синтаксиса, например: &quot;SELECT arrayReduce(&#39;groupArraySample(3)&#39;, range(10))&quot;. [#54391](https://github.com/ClickHouse/ClickHouse/pull/54391) ([itayisraelov](https://github.com/itayisraelov)).
* Добавлены агрегатные комбинаторы `-ArgMin`/`-ArgMax`, которые позволяют выполнять агрегацию только по минимальным/максимальным значениям. Один из вариантов использования описан в [#54818](https://github.com/ClickHouse/ClickHouse/issues/54818). Этот PR также переносит комбинаторы в отдельную директорию. [#54947](https://github.com/ClickHouse/ClickHouse/pull/54947) ([Amos Bird](https://github.com/amosbird)).
* Добавлена возможность очищать кэш для формата Protobuf с помощью `SYSTEM DROP SCHEMA FORMAT CACHE [FOR Protobuf]`. [#55064](https://github.com/ClickHouse/ClickHouse/pull/55064) ([Aleksandr Musorin](https://github.com/AVMusorin)).
* Добавлен внешний аутентификатор HTTP Basic. [#55199](https://github.com/ClickHouse/ClickHouse/pull/55199) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Добавлена функция `byteSwap`, которая обращает порядок байтов беззнаковых целых чисел. Это особенно полезно для обращения порядка байтов значений типов, которые внутренне хранятся как беззнаковые целые числа, например IPv4. [#55211](https://github.com/ClickHouse/ClickHouse/pull/55211) ([Priyansh Agrawal](https://github.com/Priyansh121096)).
* Добавлена функция `formatQuery`, которая возвращает форматированное представление (возможно, в несколько строк) строки SQL‑запроса. Также добавлена функция `formatQuerySingleLine`, которая делает то же самое, но возвращаемая строка не будет содержать переносов строки. [#55239](https://github.com/ClickHouse/ClickHouse/pull/55239) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Добавлен формат ввода `DWARF`, который считывает отладочные символы из ELF-исполняемого файла, библиотеки или объектного файла. [#55450](https://github.com/ClickHouse/ClickHouse/pull/55450) ([Michael Kolupaev](https://github.com/al13n321)).
* Позволяет сохранять неразобранные записи и ошибки в движках RabbitMQ, NATS и FileLog. Добавлены виртуальные столбцы `_error` и `_raw_message` (для NATS и RabbitMQ), `_raw_record` (для FileLog), которые заполняются, когда ClickHouse не может разобрать новую запись. Поведение управляется настройками хранилища `nats_handle_error_mode` для NATS, `rabbitmq_handle_error_mode` для RabbitMQ, `handle_error_mode` для FileLog, аналогично `kafka_handle_error_mode`. Если задано значение `default`, при неудачной попытке ClickHouse разобрать запись будет выброшено исключение, а если задано значение `stream`, ошибка и сырая запись будут сохранены в виртуальные столбцы. Закрывает [#36035](https://github.com/ClickHouse/ClickHouse/issues/36035). [#55477](https://github.com/ClickHouse/ClickHouse/pull/55477) ([Kruglov Pavel](https://github.com/Avogar)).
* Улучшение клиента Keeper: добавлена команда `get_all_children_number`, которая возвращает общее количество дочерних узлов по указанному пути. [#55485](https://github.com/ClickHouse/ClickHouse/pull/55485) ([guoxiaolong](https://github.com/guoxiaolongzte)).
* Улучшен клиент Keeper: добавлена команда `get_direct_children_number`, возвращающая число непосредственных дочерних узлов по указанному пути. [#55898](https://github.com/ClickHouse/ClickHouse/pull/55898) ([xuzifu666](https://github.com/xuzifu666)).
* Добавлен оператор `SHOW SETTING setting_name`, который является упрощённой версией существующего оператора `SHOW SETTINGS`. [#55979](https://github.com/ClickHouse/ClickHouse/pull/55979) ([Maksim Kita](https://github.com/kitaisreal)).
* В таблицу `system.parts_columns` добавлены столбцы `substreams` и `filenames`. [#55108](https://github.com/ClickHouse/ClickHouse/pull/55108) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена поддержка запроса `SHOW MERGES`. [#55815](https://github.com/ClickHouse/ClickHouse/pull/55815) ([megao](https://github.com/jetgm)).
* Добавлена настройка `create_table_empty_primary_key_by_default` для задания `ORDER BY ()` по умолчанию. [#55899](https://github.com/ClickHouse/ClickHouse/pull/55899) ([Srikanth Chekuri](https://github.com/srikanthccv)).

#### Повышение производительности {#performance-improvement-2}

* Добавлена опция `query_plan_preserve_num_streams_after_window_functions` для сохранения числа потоков после вычисления оконных функций, что позволяет выполнять параллельную обработку потоков. [#50771](https://github.com/ClickHouse/ClickHouse/pull/50771) ([frinkr](https://github.com/frinkr)).
* Использовать больше потоков, если объём данных мал. [#53867](https://github.com/ClickHouse/ClickHouse/pull/53867) ([Jiebin Sun](https://github.com/jiebinn)).
* RoaringBitmaps теперь оптимизируются перед сериализацией. [#55044](https://github.com/ClickHouse/ClickHouse/pull/55044) ([UnamedRus](https://github.com/UnamedRus)).
* Списки вхождений в инвертированных индексах теперь оптимизированы для использования максимально компактного представления внутренних битовых карт. В зависимости от степени повторяемости данных это может значительно снизить объем занимаемого места инвертированными индексами. [#55069](https://github.com/ClickHouse/ClickHouse/pull/55069) ([Harry Lee](https://github.com/HarryLeeIBM)).
* Уменьшена конкуренция за блокировку Context, что значительно улучшает производительность большого числа кратковременных параллельных запросов. [#55121](https://github.com/ClickHouse/ClickHouse/pull/55121) ([Maksim Kita](https://github.com/kitaisreal)).
* Производительность создания инвертированного индекса улучшена на 30%. Этого удалось добиться за счёт замены `std::unordered_map` на `absl::flat_hash_map`. [#55210](https://github.com/ClickHouse/ClickHouse/pull/55210) ([Harry Lee](https://github.com/HarryLeeIBM)).
* Поддержка проталкивания фильтров ORC (на уровне rowgroup). [#55330](https://github.com/ClickHouse/ClickHouse/pull/55330) ([李扬](https://github.com/taiyang-li)).
* Повышена производительность внешней агрегации при большом количестве временных файлов. [#55489](https://github.com/ClickHouse/ClickHouse/pull/55489) ([Maksim Kita](https://github.com/kitaisreal)).
* По умолчанию установлен разумный размер кеша меток для вторичных индексов, чтобы избежать их повторной многократной загрузки. [#55654](https://github.com/ClickHouse/ClickHouse/pull/55654) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Избегайте избыточной реконструкции гранул индекса при чтении skip-индексов. Это решает проблему [#55653](https://github.com/ClickHouse/ClickHouse/issues/55653#issuecomment-1763766009). [#55683](https://github.com/ClickHouse/ClickHouse/pull/55683) ([Amos Bird](https://github.com/amosbird)).
* Кэширование функции CAST в Set во время выполнения для повышения производительности функции `IN`, если тип элемента Set не полностью совпадает с типом столбца. [#55712](https://github.com/ClickHouse/ClickHouse/pull/55712) ([Duc Canh Le](https://github.com/canhld94)).
* Повышена производительность `ColumnVector::insertMany` и `ColumnVector::insertManyFrom`. [#55714](https://github.com/ClickHouse/ClickHouse/pull/55714) ([frinkr](https://github.com/frinkr)).
* Оптимизированы операции доступа по ключу в `Map` за счет предсказания позиции ключа следующей строки и уменьшения числа сравнений. [#55929](https://github.com/ClickHouse/ClickHouse/pull/55929) ([lgbo](https://github.com/lgbo-ustc)).
* Добавлена поддержка отсечения полей структур в Parquet (в предыдущих версиях это в некоторых случаях не работало). [#56117](https://github.com/ClickHouse/ClickHouse/pull/56117) ([lgbo](https://github.com/lgbo-ustc)).
* Добавлена возможность настраивать количество параллельных реплик, используемых при выполнении запроса, на основе оценки количества строк, подлежащих чтению. [#51692](https://github.com/ClickHouse/ClickHouse/pull/51692) ([Raúl Marín](https://github.com/Algunenano)).
* Оптимизировано потребление памяти при внешней агрегации в случаях, когда создаётся много временных файлов. [#54798](https://github.com/ClickHouse/ClickHouse/pull/54798) ([Nikita Taranov](https://github.com/nickitat)).
* Распределённые запросы, выполняемые в режиме `async_socket_for_remote` (по умолчанию), теперь соблюдают ограничение `max_threads`. Ранее некоторые запросы могли создавать чрезмерное количество потоков (до `max_distributed_connections`), что вызывало проблемы с производительностью сервера. [#53504](https://github.com/ClickHouse/ClickHouse/pull/53504) ([filimonov](https://github.com/filimonov)).
* Кэширование пропускаемых записей при выполнении DDL из очереди распределённого DDL в ZooKeeper. [#54828](https://github.com/ClickHouse/ClickHouse/pull/54828) ([Duc Canh Le](https://github.com/canhld94)).
* Экспериментальные инвертированные индексы не сохраняют токены с слишком большим числом совпадений (т. е. идентификаторов строк в списке вхождений). Это экономит место и позволяет избежать неэффективных поисков по индексу в случаях, когда последовательное сканирование было бы столь же быстрым или быстрее. Предыдущая эвристика (параметр `density`, передаваемый в определение индекса), которая определяла, когда токены не должны сохраняться, была слишком запутанной для пользователей. Вводится гораздо более простая эвристика, основанная на параметре `max_rows_per_postings_list` (по умолчанию: 64k), которая напрямую задаёт максимально допустимое число идентификаторов строк в списке вхождений. [#55616](https://github.com/ClickHouse/ClickHouse/pull/55616) ([Harry Lee](https://github.com/HarryLeeIBM)).
* Повышена производительность записи в таблицы `EmbeddedRocksDB`. [#55732](https://github.com/ClickHouse/ClickHouse/pull/55732) ([Duc Canh Le](https://github.com/canhld94)).
* Повышена общая надёжность ClickHouse при наличии большого числа частей в партиции (свыше 1000). Это может сократить количество ошибок `TOO_MANY_PARTS`. [#55526](https://github.com/ClickHouse/ClickHouse/pull/55526) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Снижено потребление памяти при загрузке иерархических словарей. [#55838](https://github.com/ClickHouse/ClickHouse/pull/55838) ([Nikita Taranov](https://github.com/nickitat)).
* Все словари поддерживают настройку `dictionary_use_async_executor`. [#55839](https://github.com/ClickHouse/ClickHouse/pull/55839) ([vdimir](https://github.com/vdimir)).
* Предотвращено чрезмерное потребление памяти при десериализации `AggregateFunctionTopKGenericData`. [#55947](https://github.com/ClickHouse/ClickHouse/pull/55947) ([Raúl Marín](https://github.com/Algunenano)).
* На Keeper с большим числом watches потоки AsyncMetrics могут на заметное время загружать CPU до 100% в `DB::KeeperStorage::getSessionsWithWatchesCount`. Исправление заключается в отказе от обхода тяжёлых множеств `watches` и `list_watches`. [#56054](https://github.com/ClickHouse/ClickHouse/pull/56054) ([Alexander Gololobov](https://github.com/davenger)).
* Добавлена настройка `optimize_trivial_approximate_count_query` для использования приблизительного значения `count` для хранилища EmbeddedRocksDB. Включено использование тривиального подсчёта для StorageJoin. [#55806](https://github.com/ClickHouse/ClickHouse/pull/55806) ([Duc Canh Le](https://github.com/canhld94)).

#### Улучшения {#improvement-2}

* Функции `toDayOfWeek` (псевдоним MySQL: `DAYOFWEEK`), `toYearWeek` (`YEARWEEK`) и `toWeek` (`WEEK`) теперь поддерживают аргументы типа `String`. Это делает их поведение соответствующим поведению MySQL. [#55589](https://github.com/ClickHouse/ClickHouse/pull/55589) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена настройка `date_time_overflow_behavior` с возможными значениями `ignore`, `throw`, `saturate`, которая задаёт поведение при переполнении при преобразовании из типов Date, Date32, DateTime64, Integer или Float в Date, Date32, DateTime или DateTime64. [#55696](https://github.com/ClickHouse/ClickHouse/pull/55696) ([Andrey Zvonov](https://github.com/zvonand)).
* Реализована поддержка параметров запроса для `ALTER TABLE ... ACTION PARTITION [ID] {parameter_name:ParameterType}`. Объединяет задачи [#49516](https://github.com/ClickHouse/ClickHouse/issues/49516). Закрывает [#49449](https://github.com/ClickHouse/ClickHouse/issues/49449). [#55604](https://github.com/ClickHouse/ClickHouse/pull/55604) ([alesapin](https://github.com/alesapin)).
* Вывод идентификаторов процессоров в более наглядном виде в EXPLAIN. [#48852](https://github.com/ClickHouse/ClickHouse/pull/48852) ([Vlad Seliverstov](https://github.com/behebot)).
* Попытка создать прямой словарь с полем lifetime будет отклонена при создании (поскольку параметр lifetime не имеет смысла для прямых словарей). Исправления: [#27861](https://github.com/ClickHouse/ClickHouse/issues/27861). [#49043](https://github.com/ClickHouse/ClickHouse/pull/49043) ([Rory Crispin](https://github.com/RoryCrispin)).
* Разрешено использование параметров в запросах по работе с партициями, например `ALTER TABLE t DROP PARTITION`. Закрывает [#49449](https://github.com/ClickHouse/ClickHouse/issues/49449). [#49516](https://github.com/ClickHouse/ClickHouse/pull/49516) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлен новый столбец `xid` в `system.zookeeper_connection`. [#50702](https://github.com/ClickHouse/ClickHouse/pull/50702) ([helifu](https://github.com/helifu)).
* Теперь в `system.server_settings` отображаются корректные настройки сервера после перезагрузки конфигурации. [#53774](https://github.com/ClickHouse/ClickHouse/pull/53774) ([helifu](https://github.com/helifu)).
* Добавлена поддержка математического символа минус `−` в запросах, аналогично символу `-`. [#54100](https://github.com/ClickHouse/ClickHouse/pull/54100) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлены группы реплик в экспериментальный движок базы данных `Replicated`. Закрывает [#53620](https://github.com/ClickHouse/ClickHouse/issues/53620). [#54421](https://github.com/ClickHouse/ClickHouse/pull/54421) ([Nikolay Degterinsky](https://github.com/evillique)).
* Лучше повторять попытки при повторяемых ошибках S3, чем полностью завершать запрос с ошибкой. По умолчанию увеличено значение параметра s3&#95;retry&#95;attempts. [#54770](https://github.com/ClickHouse/ClickHouse/pull/54770) ([Sema Checherinda](https://github.com/CheSema)).
* Добавлен режим балансировки нагрузки `hostname_levenshtein_distance`. [#54826](https://github.com/ClickHouse/ClickHouse/pull/54826) ([JackyWoo](https://github.com/JackyWoo)).
* Улучшена маскировка секретных данных в логах. [#55089](https://github.com/ClickHouse/ClickHouse/pull/55089) ([Vitaly Baranov](https://github.com/vitlibar)).
* Пока что анализ PROJECTION выполняется только на уровне плана запроса. Настройка `query_plan_optimize_projection` признана устаревшей (она уже давно включена по умолчанию). [#55112](https://github.com/ClickHouse/ClickHouse/pull/55112) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Теперь, когда функция `untuple` вызывается для кортежа с именованными элементами и сама функция имеет псевдоним (например, `select untuple(tuple(1)::Tuple(element_alias Int)) AS untuple_alias`), имя результирующего столбца формируется из псевдонима `untuple` и псевдонима элемента кортежа (в примере: &quot;untuple&#95;alias.element&#95;alias&quot;). [#55123](https://github.com/ClickHouse/ClickHouse/pull/55123) ([garcher22](https://github.com/garcher22)).
* Добавлена настройка `describe_include_virtual_columns`, которая позволяет включать виртуальные столбцы таблицы в результат выполнения запроса `DESCRIBE`. Добавлена настройка `describe_compact_output`. Если она установлена в значение `true`, запрос `DESCRIBE` возвращает только имена и типы столбцов без дополнительной информации. [#55129](https://github.com/ClickHouse/ClickHouse/pull/55129) ([Anton Popov](https://github.com/CurtizJ)).
* Иногда выполнение `OPTIMIZE` с `optimize_throw_if_noop=1` может завершаться с ошибкой `unknown reason`, тогда как истинной причиной являются разные проекции в разных частях. Это поведение исправлено. [#55130](https://github.com/ClickHouse/ClickHouse/pull/55130) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Позволяет использовать несколько таблиц `MaterializedPostgreSQL`, соответствующих одной и той же таблице Postgres. По умолчанию это поведение отключено (для совместимости, так как это изменение несовместимо с предыдущими версиями), но его можно включить с помощью настройки `materialized_postgresql_use_unique_replication_consumer_identifier`. Закрывает [#54918](https://github.com/ClickHouse/ClickHouse/issues/54918). [#55145](https://github.com/ClickHouse/ClickHouse/pull/55145) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена возможность разбора отрицательных `DateTime64` и `DateTime` с дробной частью из коротких строк. [#55146](https://github.com/ClickHouse/ClickHouse/pull/55146) ([Andrey Zvonov](https://github.com/zvonand)).
* Для улучшения совместимости с MySQL 1. `information_schema.tables` теперь содержит новое поле `table_rows`, а 2. `information_schema.columns` теперь содержит новое поле `extra`. [#55215](https://github.com/ClickHouse/ClickHouse/pull/55215) ([Robert Schulze](https://github.com/rschu1ze)).
* Clickhouse-client больше не будет показывать &quot;0 rows in set&quot;, если результат содержит 0 строк и при этом было выброшено исключение. [#55240](https://github.com/ClickHouse/ClickHouse/pull/55240) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Добавлена поддержка операции переименования таблиц без ключевого слова `TABLE`, например `RENAME db.t1 to db.t2`. [#55373](https://github.com/ClickHouse/ClickHouse/pull/55373) ([凌涛](https://github.com/lingtaolf)).
* Добавлен параметр `internal_replication` в `system.clusters`. [#55377](https://github.com/ClickHouse/ClickHouse/pull/55377) ([Konstantin Morozov](https://github.com/k-morozov)).
* Выбор удалённого прокси-резолвера в зависимости от протокола запроса, добавлена документация по возможностям прокси и удалён `DB::ProxyConfiguration::Protocol::ANY`. [#55430](https://github.com/ClickHouse/ClickHouse/pull/55430) ([Arthur Passos](https://github.com/arthurpassos)).
* Исключены повторные попытки выполнения операций Keeper при INSERT после остановки таблицы. [#55519](https://github.com/ClickHouse/ClickHouse/pull/55519) ([Azat Khuzhin](https://github.com/azat)).
* `SHOW COLUMNS` теперь корректно отображает тип `FixedString` как `BLOB`, если включена настройка `use_mysql_types_in_show_columns`. Также добавлены две новые настройки — `mysql_map_string_to_text_in_show_columns` и `mysql_map_fixed_string_to_text_in_show_columns`, — позволяющие переключать вывод типов `String` и `FixedString` между `TEXT` и `BLOB`. [#55617](https://github.com/ClickHouse/ClickHouse/pull/55617) ([Serge Klochkov](https://github.com/slvrtrn)).
* При запуске таблиц ReplicatedMergeTree сервер ClickHouse проверяет набор частей на наличие неожиданных частей (существуют локально, но отсутствуют в ZooKeeper). Все неожиданные части перемещаются в каталог detached, и вместо них сервер пытается восстановить предковые (покрывающие) части. Теперь сервер пытается восстановить ближайшие предковые части вместо случайных покрывающих частей. [#55645](https://github.com/ClickHouse/ClickHouse/pull/55645) ([alesapin](https://github.com/alesapin)).
* Расширенная панель мониторинга теперь поддерживает перетаскивание графиков на устройствах с сенсорным экраном. Это закрывает [#54206](https://github.com/ClickHouse/ClickHouse/issues/54206). [#55649](https://github.com/ClickHouse/ClickHouse/pull/55649) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Теперь используется формат запроса по умолчанию, если он задан, при выводе исключения с `http_write_exception_in_output_format`. [#55739](https://github.com/ClickHouse/ClickHouse/pull/55739) ([Raúl Marín](https://github.com/Algunenano)).
* Улучшено сообщение для типичных проблем при работе с MATERIALIZED VIEW. [#55826](https://github.com/ClickHouse/ClickHouse/pull/55826) ([Raúl Marín](https://github.com/Algunenano)).
* Если вы удалили текущую базу данных, вы по‑прежнему сможете выполнять некоторые запросы в `clickhouse-local` и переключаться на другую базу данных. Это делает поведение единообразным с `clickhouse-client`. Тем самым закрывается задача [#55834](https://github.com/ClickHouse/ClickHouse/issues/55834). [#55853](https://github.com/ClickHouse/ClickHouse/pull/55853) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Функции `(add|subtract)(Year|Quarter|Month|Week|Day|Hour|Minute|Second|Millisecond|Microsecond|Nanosecond)` теперь поддерживают аргументы даты в строковом виде, например `SELECT addDays('2023-10-22', 1)`. Это повышает совместимость с MySQL и требуется для Tableau Online. [#55869](https://github.com/ClickHouse/ClickHouse/pull/55869) ([Robert Schulze](https://github.com/rschu1ze)).
* Настройка `apply_deleted_mask`, если отключена, позволяет читать строки, которые были помечены как удалённые запросами легковесного удаления (lightweight DELETE). Это полезно для отладки. [#55952](https://github.com/ClickHouse/ClickHouse/pull/55952) ([Alexander Gololobov](https://github.com/davenger)).
* Добавлена возможность пропускать значения `null` при сериализации Tuple в JSON-объекты, что позволяет сохранить совместимость с функцией Spark `to_json` и также полезно для Gluten. [#55956](https://github.com/ClickHouse/ClickHouse/pull/55956) ([李扬](https://github.com/taiyang-li)).
* Функции `(add|sub)Date` теперь поддерживают аргументы дат в строковом виде, например `SELECT addDate('2023-10-22 11:12:13', INTERVAL 5 MINUTE)`. Аналогичная поддержка аргументов дат в строковом виде добавлена к операторам сложения и вычитания, например `SELECT '2023-10-23' + INTERVAL 1 DAY`. Это повышает совместимость с MySQL и необходимо для Tableau Online. [#55960](https://github.com/ClickHouse/ClickHouse/pull/55960) ([Robert Schulze](https://github.com/rschu1ze)).
* Разрешено использование строк без кавычек с CR (`\r`) в формате CSV. Закрывает [#39930](https://github.com/ClickHouse/ClickHouse/issues/39930). [#56046](https://github.com/ClickHouse/ClickHouse/pull/56046) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена возможность запускать `clickhouse-keeper` с использованием встроенной конфигурации. [#56086](https://github.com/ClickHouse/ClickHouse/pull/56086) ([Maksim Kita](https://github.com/kitaisreal)).
* Установлено ограничение максимального значения параметра конфигурации `queued.min.messages`, чтобы избежать проблем при запуске чтения данных из Kafka. [#56121](https://github.com/ClickHouse/ClickHouse/pull/56121) ([Stas Morozov](https://github.com/r3b-fish)).
* Исправлена опечатка в SQL-функции `minSampleSizeContinous` (переименована в `minSampleSizeContinuous`). Старое имя сохранено для обратной совместимости. Закрыта задача: [#56139](https://github.com/ClickHouse/ClickHouse/issues/56139). [#56143](https://github.com/ClickHouse/ClickHouse/pull/56143) ([Dorota Szeremeta](https://github.com/orotaday)).
* Перед завершением работы сервера выводится путь к повреждённым частям на диске. Ранее, если часть была повреждена на диске и сервер не мог запуститься, было почти невозможно определить, какая именно часть повреждена. Теперь это исправлено. [#56181](https://github.com/ClickHouse/ClickHouse/pull/56181) ([Duc Canh Le](https://github.com/canhld94)).

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-2}

* Если база данных в Docker уже инициализирована, её не нужно инициализировать повторно при последующих запусках. Это потенциально может исправить проблему бесконечных перезапусков контейнера, когда база данных не успевает загрузиться за 1000 попыток (актуально для очень больших баз данных и многонодовых конфигураций). [#50724](https://github.com/ClickHouse/ClickHouse/pull/50724) ([Alexander Nikolaev](https://github.com/AlexNik)).
* Ресурс с исходным кодом, включая подмодули, теперь собирается в специальной задаче сборки для Darwin. Он может использоваться для сборки ClickHouse без отдельной загрузки подмодулей. [#51435](https://github.com/ClickHouse/ClickHouse/pull/51435) ([Ilya Yatsishin](https://github.com/qoega)).
* Ошибка возникала при сборке ClickHouse с глобально включённой серией инструкций AVX (что не рекомендуется). Причина в том, что snappy не включает `SNAPPY_HAVE_X86_CRC32`. [#55049](https://github.com/ClickHouse/ClickHouse/pull/55049) ([monchickey](https://github.com/monchickey)).
* Решена проблема с запуском отдельного `clickhouse-keeper` из пакета `clickhouse-server`. [#55226](https://github.com/ClickHouse/ClickHouse/pull/55226) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* В тестах версия RabbitMQ обновлена до 3.12.6. Улучшен сбор логов для тестов RabbitMQ. [#55424](https://github.com/ClickHouse/ClickHouse/pull/55424) ([Ilya Yatsishin](https://github.com/qoega)).
* Сообщение об ошибке между openssl и boringssl приведено к единому виду, чтобы исправить функциональный тест. [#55975](https://github.com/ClickHouse/ClickHouse/pull/55975) ([MeenaRenganathan22](https://github.com/MeenaRenganathan22)).
* Теперь используется основной (upstream) репозиторий для apache datasketches. [#55787](https://github.com/ClickHouse/ClickHouse/pull/55787) ([Nikita Taranov](https://github.com/nickitat)).

#### Исправление ошибки (заметное пользователям некорректное поведение в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-2}

* Не создавать жёсткие ссылки на файлы инвертированного индекса при мутациях [#47663](https://github.com/ClickHouse/ClickHouse/pull/47663) ([cangyin](https://github.com/cangyin)).
* Исправлена ошибка в функции `match` (регулярное выражение), при которой шаблон с альтернативой приводил к некорректному ключевому условию. Закрывает #53222. [#54696](https://github.com/ClickHouse/ClickHouse/pull/54696) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена ошибка &#39;Cannot find column&#39; в оптимизации чтения в заданном порядке при использовании ARRAY JOIN [#51746](https://github.com/ClickHouse/ClickHouse/pull/51746) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлена поддержка экспериментальных подстолбцов `Object(Nullable(json))` в запросах, которые ранее не обрабатывались. [#54052](https://github.com/ClickHouse/ClickHouse/pull/54052) ([zps](https://github.com/VanDarkholme7)).
* Повторно применено исправление для `accurateCastOrNull` [#54629](https://github.com/ClickHouse/ClickHouse/pull/54629) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Исправлено определение `DEFAULT` для столбцов distributed таблицы, созданной без `AS` [#55060](https://github.com/ClickHouse/ClickHouse/pull/55060) ([Vitaly Baranov](https://github.com/vitlibar)).
* Корректная очистка ресурсов при возникновении исключения в конструкторе класса ShellCommandSource [#55103](https://github.com/ClickHouse/ClickHouse/pull/55103) ([Alexander Gololobov](https://github.com/davenger)).
* Устранена взаимоблокировка при обновлении роли, назначенной через LDAP [#55119](https://github.com/ClickHouse/ClickHouse/pull/55119) ([Julian Maicher](https://github.com/jmaicher)).
* Отключено обновление статистики ошибок для внутренних исключений [#55128](https://github.com/ClickHouse/ClickHouse/pull/55128) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена взаимная блокировка при резервном копировании [#55132](https://github.com/ClickHouse/ClickHouse/pull/55132) ([alesapin](https://github.com/alesapin)).
* Исправлено получение файлов из хранилища Iceberg [#55144](https://github.com/ClickHouse/ClickHouse/pull/55144) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено отсечение партиций по дополнительным столбцам в Set. [#55172](https://github.com/ClickHouse/ClickHouse/pull/55172) ([Amos Bird](https://github.com/amosbird)).
* Исправлен перерасчёт пропускающих индексов в запросах ALTER UPDATE для таблиц с адаптивной гранулярностью [#55202](https://github.com/ClickHouse/ClickHouse/pull/55202) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлена фоновая загрузка в кэше fs [#55252](https://github.com/ClickHouse/ClickHouse/pull/55252) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Предотвращены возможные утечки памяти в компрессорах при отсутствии финализации буфера [#55262](https://github.com/ClickHouse/ClickHouse/pull/55262) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено выполнение функций с разрежёнными столбцами [#55275](https://github.com/ClickHouse/ClickHouse/pull/55275) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено некорректное слияние `Nested` при `SELECT FINAL FROM SummingMergeTree` [#55276](https://github.com/ClickHouse/ClickHouse/pull/55276) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, из-за которой было невозможно удалить отсоединённую партицию в реплицированном MergeTree поверх S3 без zero-copy [#55309](https://github.com/ClickHouse/ClickHouse/pull/55309) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка, приводившая к падению MergeSortingPartialResultTransform (из-за пустых фрагментов после `remerge`) [#55335](https://github.com/ClickHouse/ClickHouse/pull/55335) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена гонка данных в CreatingSetsTransform при обработке ошибок из-за выбрасывания разделяемого исключения [#55338](https://github.com/ClickHouse/ClickHouse/pull/55338) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена оптимизация trash (в некоторой степени) [#55353](https://github.com/ClickHouse/ClickHouse/pull/55353) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Устранена утечка в StorageHDFS [#55370](https://github.com/ClickHouse/ClickHouse/pull/55370) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен разбор массивов оператором `CAST` [#55417](https://github.com/ClickHouse/ClickHouse/pull/55417) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена фильтрация по виртуальным столбцам при использовании оператора OR в запросе [#55418](https://github.com/ClickHouse/ClickHouse/pull/55418) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены проблемы подключения к MongoDB [#55419](https://github.com/ClickHouse/ClickHouse/pull/55419) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлено представление булевых значений в интерфейсе MySQL [#55427](https://github.com/ClickHouse/ClickHouse/pull/55427) ([Serge Klochkov](https://github.com/slvrtrn)).
* Исправлено форматирование `DateTime` в текстовом протоколе MySQL и вывод типов `LowCardinality(Nullable(T))` [#55479](https://github.com/ClickHouse/ClickHouse/pull/55479) ([Serge Klochkov](https://github.com/slvrtrn)).
* Параметр `use_mysql_types_in_show_columns` теперь влияет только на `SHOW COLUMNS` [#55481](https://github.com/ClickHouse/ClickHouse/pull/55481) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена некорректная обработка `DW_FORM_ref_addr` в символизаторе стека, которая иногда приводила к его падению [#55483](https://github.com/ClickHouse/ClickHouse/pull/55483) ([Michael Kolupaev](https://github.com/al13n321)).
* Теперь fiber уничтожается при возникновении исключения в cancelBefore в AsyncTaskExecutor [#55516](https://github.com/ClickHouse/ClickHouse/pull/55516) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена проблема, из-за которой параметры запроса не работали с пользовательскими HTTP-обработчиками [#55521](https://github.com/ClickHouse/ClickHouse/pull/55521) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлена проверка необработанных данных для формата Values [#55527](https://github.com/ClickHouse/ClickHouse/pull/55527) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка «Invalid cursor state» в драйвере ODBC при работе с MS SQL Server [#55558](https://github.com/ClickHouse/ClickHouse/pull/55558) ([vdimir](https://github.com/vdimir)).
* Исправлены максимальное время выполнения запроса и режим обработки переполнения &#39;break&#39; [#55577](https://github.com/ClickHouse/ClickHouse/pull/55577) ([Alexander Gololobov](https://github.com/davenger)).
* Исправлено аварийное завершение работы QueryNormalizer при циклических псевдонимах [#55602](https://github.com/ClickHouse/ClickHouse/pull/55602) ([vdimir](https://github.com/vdimir)).
* Отключена некорректная оптимизация и добавлен тест [#55609](https://github.com/ClickHouse/ClickHouse/pull/55609) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Объединены [#52352](https://github.com/ClickHouse/ClickHouse/issues/52352) и [#55621](https://github.com/ClickHouse/ClickHouse/pull/55621) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен тест, чтобы избежать некорректной сортировки десятичных чисел [#55662](https://github.com/ClickHouse/ClickHouse/pull/55662) ([Amos Bird](https://github.com/amosbird)).
* Исправлен индикатор прогресса для кластерных функций S3 и Azure с URL-адресами без масок (globs) [#55666](https://github.com/ClickHouse/ClickHouse/pull/55666) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена проблема с фильтрацией по виртуальным столбцам с использованием фильтра OR в запросе (повторная отправка) [#55678](https://github.com/ClickHouse/ClickHouse/pull/55678) ([Azat Khuzhin](https://github.com/azat)).
* Исправления и улучшения в хранилище Iceberg [#55695](https://github.com/ClickHouse/ClickHouse/pull/55695) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена гонка данных в CreatingSetsTransform (v2) [#55786](https://github.com/ClickHouse/ClickHouse/pull/55786) ([Azat Khuzhin](https://github.com/azat)).
* Генерировать исключение при разборе некорректной строки в число с плавающей запятой, если precise&#95;float&#95;parsing равно true [#55861](https://github.com/ClickHouse/ClickHouse/pull/55861) ([李扬](https://github.com/taiyang-li)).
* Отключено проталкивание предикатов, если CTE содержит функции с сохранением состояния [#55871](https://github.com/ClickHouse/ClickHouse/pull/55871) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена нормализация ASTSelectWithUnionQuery, из‑за которой из запроса удалялся `FORMAT` [#55887](https://github.com/ClickHouse/ClickHouse/pull/55887) ([flynn](https://github.com/ucasfl)).
* Попытка исправить возможный сбой сегментации (segfault) во входном формате Native ORC [#55891](https://github.com/ClickHouse/ClickHouse/pull/55891) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена работа оконных функций при разреженных столбцах. [#55895](https://github.com/ClickHouse/ClickHouse/pull/55895) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* fix: StorageNull теперь поддерживает подстолбцы [#55912](https://github.com/ClickHouse/ClickHouse/pull/55912) ([FFish](https://github.com/wxybear)).
* Не записывать повторяемые ошибки для операций Replicated mutate/merge в журнал ошибок [#55944](https://github.com/ClickHouse/ClickHouse/pull/55944) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа команды `SHOW DATABASES LIMIT &lt;N&gt;` [#55962](https://github.com/ClickHouse/ClickHouse/pull/55962) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена автоматически сгенерированная схема Protobuf для полей с символом подчёркивания в имени [#55974](https://github.com/ClickHouse/ClickHouse/pull/55974) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена работа dateTime64ToSnowflake64() при использовании масштаба, отличного от значения по умолчанию [#55983](https://github.com/ClickHouse/ClickHouse/pull/55983) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлены операции ввода/вывода для столбца Arrow со словарём [#55989](https://github.com/ClickHouse/ClickHouse/pull/55989) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено получение схемы из реестра схем в AvroConfluent [#55991](https://github.com/ClickHouse/ClickHouse/pull/55991) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка &#39;Block structure mismatch&#39; при одновременном выполнении операций ALTER и INSERT в таблице Buffer [#55995](https://github.com/ClickHouse/ClickHouse/pull/55995) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлен некорректный расчет свободного пространства в политике JBOD `least_used` [#56030](https://github.com/ClickHouse/ClickHouse/pull/56030) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, возникавшая из-за отсутствующего скаляра при вычислении подзапросов в табличных функциях [#56057](https://github.com/ClickHouse/ClickHouse/pull/56057) ([Amos Bird](https://github.com/amosbird)).
* Исправлено получение некорректного результата запроса при http&#95;write&#95;exception&#95;in&#95;output&#95;format=1 [#56135](https://github.com/ClickHouse/ClickHouse/pull/56135) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен кэш схемы для резервного варианта JSON-&gt;JSONEachRow при изменённых настройках [#56172](https://github.com/ClickHouse/ClickHouse/pull/56172) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен обработчик ошибок в компонент odbc-bridge [#56185](https://github.com/ClickHouse/ClickHouse/pull/56185) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).

### <a id="239"></a> Релиз ClickHouse 23.9 от 2023-09-28. [Презентация](https://presentations.clickhouse.com/2023-release-23.9/), [видео](https://www.youtube.com/watch?v=yS8YU-rBpMM) {#239}

<iframe width="1024" height="576" src="https://www.youtube.com/embed/yS8YU-rBpMM" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

#### Несовместимое изменение {#backward-incompatible-change-3}

* Удалён конфигурационный параметр `status_info` и статус словарей из обработчика Prometheus по умолчанию. [#54090](https://github.com/ClickHouse/ClickHouse/pull/54090) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Экспериментальный кэш метаданных частей удалён из кодовой базы. [#54215](https://github.com/ClickHouse/ClickHouse/pull/54215) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Настройка `input_format_json_try_infer_numbers_from_strings` больше не включена по умолчанию, поэтому мы не пытаемся определять числа по строкам в форматах JSON, чтобы избежать возможных ошибок разбора, когда в примерах данных есть строки, выглядящие как числа. [#55099](https://github.com/ClickHouse/ClickHouse/pull/55099) ([Kruglov Pavel](https://github.com/Avogar)).

#### Новая функция {#new-feature-3}

* Улучшен вывод схемы из форматов JSON: 1) Теперь возможно выводить именованные Tuple из JSON-объектов без экспериментального типа JSON с помощью настройки `input_format_json_try_infer_named_tuples_from_objects` в JSON-форматах. Ранее без экспериментального типа JSON мы могли выводить JSON-объекты только как String или Map, теперь мы можем выводить именованный Tuple. Итоговый тип Tuple будет содержать все ключи объектов, которые были прочитаны в выборке данных во время вывода схемы. Это может быть полезно для чтения структурированных JSON-данных без разреженных объектов. Настройка включена по умолчанию. 2) Разрешён разбор JSON-массива в столбец типа String с помощью настройки `input_format_json_read_arrays_as_strings`. Это может помочь при чтении массивов со значениями разных типов. 3) Разрешено использовать тип String для JSON-ключей со значениями неизвестных типов (`null`/`[]`/`{}`) в выборке данных с помощью настройки `input_format_json_infer_incomplete_types_as_strings`. Теперь в JSON-форматах мы можем читать любое значение в столбец типа String и можем избежать ошибки `Cannot determine type for column 'column_name' by first 25000 rows of data, most likely this column contains only Nulls or empty Arrays/Maps` во время вывода схемы, используя тип String для неизвестных типов, так что данные будут успешно прочитаны. [#54427](https://github.com/ClickHouse/ClickHouse/pull/54427) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка планирования ввода-вывода (IO scheduling) для удалённых дисков. Конфигурация хранилища для типов дисков `s3`, `s3_plain`, `hdfs` и `azure_blob_storage` теперь может содержать элементы `read_resource` и `write_resource`, в которых указываются имена ресурсов. Политики планирования для этих ресурсов можно настроить в отдельной секции конфигурации сервера `resources`. Запросы могут помечаться с помощью настройки `workload` и классифицироваться с помощью секции конфигурации сервера `workload_classifiers` для достижения различных целей планирования использования ресурсов. Более подробная информация в [документации](/operations/workload-scheduling). [#47009](https://github.com/ClickHouse/ClickHouse/pull/47009) ([Sergei Trifonov](https://github.com/serxa)). Добавлен тип узла планирования ввода-вывода `bandwidth_limit`. Он позволяет задать ограничения `max_speed` и `max_burst` на трафик, проходящий через этот узел. [#54618](https://github.com/ClickHouse/ClickHouse/pull/54618) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлен новый тип аутентификации на основе SSH-ключей. Он работает только для нативного протокола TCP. [#41109](https://github.com/ClickHouse/ClickHouse/pull/41109) ([George Gamezardashvili](https://github.com/InfJoker)).
* Добавлен новый столбец `_block_number` для таблиц MergeTree. [#44532](https://github.com/ClickHouse/ClickHouse/issues/44532). [#47532](https://github.com/ClickHouse/ClickHouse/pull/47532) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Добавлено предложение `IF EMPTY` для запросов `DROP TABLE`. [#48915](https://github.com/ClickHouse/ClickHouse/pull/48915) ([Pavel Novitskiy](https://github.com/pnovitskiy)).
* SQL-функции `toString(datetime, timezone)` и `formatDateTime(datetime, format, timezone)` теперь поддерживают неконстантные аргументы часового пояса. [#53680](https://github.com/ClickHouse/ClickHouse/pull/53680) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена поддержка `ALTER TABLE MODIFY COMMENT`. Примечание: нечто подобное было добавлено внешним участником сообщества давно, но функциональность совсем не работала и лишь вводила пользователей в заблуждение. Это закрывает [#36377](https://github.com/ClickHouse/ClickHouse/issues/36377). [#51304](https://github.com/ClickHouse/ClickHouse/pull/51304) ([Alexey Milovidov](https://github.com/alexey-milovidov)). Примечание: эта команда не распространяется между репликами, поэтому реплики таблицы могут иметь разные комментарии.
* Добавлен `GCD`, также известный как «greatest common divisor», в качестве нового кодека сжатия данных. Кодек вычисляет GCD всех значений столбца, а затем делит каждое значение на GCD. Кодек GCD является кодеком подготовки данных (аналогично Delta и DoubleDelta) и не может использоваться отдельно. Он работает с целочисленными, десятичными типами данных и типами дата/время. Типичным вариантом применения кодека GCD являются значения столбца, которые изменяются (увеличиваются/уменьшаются) на величину, кратную GCD, например 24 - 28 - 16 - 24 - 8 - 24 (при GCD = 4). [#53149](https://github.com/ClickHouse/ClickHouse/pull/53149) ([Alexander Nam](https://github.com/seshWCS)).
* Добавлены два новых псевдонима типов: `DECIMAL(P)` (как сокращённая форма `DECIMAL(P, 0)`) и `DECIMAL` (как сокращённая форма `DECIMAL(10, 0)`). Это делает ClickHouse более совместимым с SQL-диалектом MySQL. [#53328](https://github.com/ClickHouse/ClickHouse/pull/53328) ([Val Doroshchuk](https://github.com/valbok)).
* Добавлена новая таблица системного лога `backup_log` для отслеживания всех операций `BACKUP` и `RESTORE`. [#53638](https://github.com/ClickHouse/ClickHouse/pull/53638) ([Victor Krasnov](https://github.com/sirvickr)).
* Добавлена настройка формата вывода `output_format_markdown_escape_special_characters` (по умолчанию — false). Эта настройка определяет, экранируются ли специальные символы, такие как `!`, `#`, `$` и т.д. (то есть предваряются обратной косой чертой) в формате вывода `Markdown`. [#53860](https://github.com/ClickHouse/ClickHouse/pull/53860) ([irenjj](https://github.com/irenjj)).
* Добавлена функция `decodeHTMLComponent`. [#54097](https://github.com/ClickHouse/ClickHouse/pull/54097) ([Bharat Nallan](https://github.com/bharatnc)).
* В таблицу query&#95;log добавлен `peak_threads_usage`. [#54335](https://github.com/ClickHouse/ClickHouse/pull/54335) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
* Добавлена поддержка команды `SHOW FUNCTIONS` в clickhouse-client. [#54337](https://github.com/ClickHouse/ClickHouse/pull/54337) ([Julia Kartseva](https://github.com/wat-ze-hex)).
* Добавлена функция `toDaysSinceYearZero` с псевдонимом `TO_DAYS` (для совместимости с MySQL), которая возвращает количество дней, прошедших с `0001-01-01` (в пролептическом григорианском календаре). [#54479](https://github.com/ClickHouse/ClickHouse/pull/54479) ([Robert Schulze](https://github.com/rschu1ze)). Функция `toDaysSinceYearZero` теперь поддерживает аргументы типа `DateTime` и `DateTime64`. [#54856](https://github.com/ClickHouse/ClickHouse/pull/54856) ([Serge Klochkov](https://github.com/slvrtrn)).
* Добавлены функции `YYYYMMDDtoDate`, `YYYYMMDDtoDate32`, `YYYYMMDDhhmmssToDateTime` и `YYYYMMDDhhmmssToDateTime64`. Они преобразуют дату или дату и время, закодированные в виде целого числа (например, 20230911), в нативный тип даты или даты и времени. Таким образом, они выполняют противоположное преобразование по сравнению с существующими функциями `YYYYMMDDToDate`, `YYYYMMDDToDateTime`, `YYYYMMDDhhmmddToDateTime`, `YYYYMMDDhhmmddToDateTime64`. [#54509](https://github.com/ClickHouse/ClickHouse/pull/54509) ([Quanfa Fu](https://github.com/dentiscalprum)) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлено несколько функций для вычисления расстояния между строками, включая `byteHammingDistance`, `editDistance`. [#54935](https://github.com/ClickHouse/ClickHouse/pull/54935) ([flynn](https://github.com/ucasfl)).
* Теперь можно указывать дату окончания срока действия и, при необходимости, время для учетных данных пользователя в предложении `VALID UNTIL datetime`. [#51261](https://github.com/ClickHouse/ClickHouse/pull/51261) ([Nikolay Degterinsky](https://github.com/evillique)).
* Разрешены URL в стиле S3 для табличных функций `s3`, `gcs`, `oss`. URL автоматически преобразуется в HTTP. Пример: `'s3://clickhouse-public-datasets/hits.csv'` преобразуется в `'https://clickhouse-public-datasets.s3.amazonaws.com/hits.csv'`. [#54931](https://github.com/ClickHouse/ClickHouse/pull/54931) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена новая настройка `print_pretty_type_names` для красивого вывода глубоко вложенных типов, таких как Tuple/Maps/Arrays. [#55095](https://github.com/ClickHouse/ClickHouse/pull/55095) ([Kruglov Pavel](https://github.com/Avogar)).

#### Повышение производительности {#performance-improvement-3}

* Ускорено чтение из S3 за счет включения предзагрузки данных по умолчанию. [#53709](https://github.com/ClickHouse/ClickHouse/pull/53709) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Не читать неявно PK и столбцы версий в одиночных частях, если это не требуется для запросов с FINAL. [#53919](https://github.com/ClickHouse/ClickHouse/pull/53919) ([Duc Canh Le](https://github.com/canhld94)).
* Оптимизирована группировка по константным ключам. Теперь после [https://github.com/ClickHouse/ClickHouse/pull/53529](https://github.com/ClickHouse/ClickHouse/pull/53529) оптимизируются запросы с GROUP BY `_file/_path`. [#53549](https://github.com/ClickHouse/ClickHouse/pull/53549) ([Kruglov Pavel](https://github.com/Avogar)).
* Улучшена производительность сортировки для столбцов типа `Decimal`. Улучшена производительность вставки в `MergeTree`, если в ORDER BY содержится столбец типа `Decimal`. Улучшена производительность сортировки для уже отсортированных или почти отсортированных данных. [#35961](https://github.com/ClickHouse/ClickHouse/pull/35961) ([Maksim Kita](https://github.com/kitaisreal)).
* Улучшена производительность при анализе очень больших запросов. Исправляет [#51224](https://github.com/ClickHouse/ClickHouse/issues/51224). [#51469](https://github.com/ClickHouse/ClickHouse/pull/51469) ([frinkr](https://github.com/frinkr)).
* Оптимизация, позволяющая переписывать `COUNT(DISTINCT ...)` и различные варианты функции `uniq` в `count`, если они выбираются из подзапроса с GROUP BY. [#52082](https://github.com/ClickHouse/ClickHouse/pull/52082) [#52645](https://github.com/ClickHouse/ClickHouse/pull/52645) ([JackyWoo](https://github.com/JackyWoo)).
* Удалены ручные вызовы `mmap/mremap/munmap`, а вся эта работа делегирована `jemalloc`, что слегка улучшило производительность. [#52792](https://github.com/ClickHouse/ClickHouse/pull/52792) ([Nikita Taranов](https://github.com/nickitat)).
* Исправлено высокое потребление CPU при работе с NATS. [#54399](https://github.com/ClickHouse/ClickHouse/pull/54399) ([Vasilev Pyotr](https://github.com/vahpetr)).
* Так как для выполнения `toString` с аргументом типа DateTime используются отдельные инструкции, можно немного улучшить производительность для аргументов других типов и сделать некоторые участки кода более чистыми. Продолжение работы по задаче [#53680](https://github.com/ClickHouse/ClickHouse/issues/53680). [#54443](https://github.com/ClickHouse/ClickHouse/pull/54443) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Вместо сериализации JSON-элементов в `std::stringstream` результат сериализации теперь записывается непосредственно в `ColumnString`. [#54613](https://github.com/ClickHouse/ClickHouse/pull/54613) ([lgbo](https://github.com/lgbo-ustc)).
* Включена оптимизация ORDER BY для чтения данных в соответствующем порядке из таблицы MergeTree, когда эта таблица используется в представлении. [#54628](https://github.com/ClickHouse/ClickHouse/pull/54628) ([Vitaly Baranov](https://github.com/vitlibar)).
* Улучшены SQL-функции для JSON за счёт повторного использования `GeneratorJSONPath` и удаления нескольких разделяемых указателей. [#54735](https://github.com/ClickHouse/ClickHouse/pull/54735) ([lgbo](https://github.com/lgbo-ustc)).
* Keeper пытается объединять запросы на сброс в батчи для повышения производительности. [#53049](https://github.com/ClickHouse/ClickHouse/pull/53049) ([Antonio Andelic](https://github.com/antonio2368)).
* Теперь `clickhouse-client` обрабатывает файлы параллельно при использовании `INFILE 'glob_expression'`. Закрыта задача [#54218](https://github.com/ClickHouse/ClickHouse/issues/54218). [#54533](https://github.com/ClickHouse/ClickHouse/pull/54533) ([Max K.](https://github.com/mkaynov)).
* Теперь можно использовать первичный ключ для функции `IN`, даже когда типы столбцов первичного ключа отличаются от типов столбцов в правой части функции `IN`. Пример: `SELECT id FROM test_table WHERE id IN (SELECT '5')`. Закрывает [#48936](https://github.com/ClickHouse/ClickHouse/issues/48936). [#54544](https://github.com/ClickHouse/ClickHouse/pull/54544) ([Maksim Kita](https://github.com/kitaisreal)).
* Hash JOIN пытается уменьшить внутренние буферы, использующие половину максимально доступного объёма памяти (задаётся настройкой `max_bytes_in_join`). [#54584](https://github.com/ClickHouse/ClickHouse/pull/54584) ([vdimir](https://github.com/vdimir)).
* Соблюдать `max_block_size` для array join, чтобы избежать возможного OOM. Закрывает [#54290](https://github.com/ClickHouse/ClickHouse/issues/54290). [#54664](https://github.com/ClickHouse/ClickHouse/pull/54664) ([李扬](https://github.com/taiyang-li)).
* Повторное использование HTTP‑соединений в табличной функции `s3`. [#54812](https://github.com/ClickHouse/ClickHouse/pull/54812) ([Michael Kolupaev](https://github.com/al13n321)).
* Линейный поиск в `MergeTreeRangeReader::Stream::ceilRowsToCompleteGranules` заменён на двоичный. [#54869](https://github.com/ClickHouse/ClickHouse/pull/54869) ([usurai](https://github.com/usurai)).

#### Экспериментальная функциональность {#experimental-feature}

* Создание индексов `Annoy` теперь может выполняться параллельно с использованием настройки `max_threads_for_annoy_index_creation`. [#54047](https://github.com/ClickHouse/ClickHouse/pull/54047) ([Robert Schulze](https://github.com/rschu1ze)).
* Параллельные реплики для распределённых таблиц теперь не читают со всех реплик. [#54199](https://github.com/ClickHouse/ClickHouse/pull/54199) ([Igor Nikonov](https://github.com/devcrafter)).

#### Улучшения {#improvement-3}

* Позволяет заменять длинные имена файлов столбцов в частях данных `MergeTree` на хэши этих имён. Это помогает в некоторых случаях избежать ошибки `File name too long`. [#50612](https://github.com/ClickHouse/ClickHouse/pull/50612) ([Anton Popov](https://github.com/CurtizJ)).
* Разбирать данные в формате `JSON` как `JSONEachRow`, если не удалось разобрать метаданные. Это позволит читать файлы с расширением `.json`, даже если фактический формат — `JSONEachRow`. Закрывает [#45740](https://github.com/ClickHouse/ClickHouse/issues/45740). [#54405](https://github.com/ClickHouse/ClickHouse/pull/54405) ([Kruglov Pavel](https://github.com/Avogar)).
* Выводить корректный JSON/XML при возникновении исключения во время выполнения HTTP-запроса. Добавлена настройка `http_write_exception_in_output_format` для включения или отключения этого поведения (по умолчанию включено). [#52853](https://github.com/ClickHouse/ClickHouse/pull/52853) ([Kruglov Pavel](https://github.com/Avogar)).
* Представление `information_schema.tables` теперь содержит новый столбец `data_length`, который показывает приблизительный размер данных на диске. Это изменение необходимо для выполнения запросов, генерируемых Amazon QuickSight. [#55037](https://github.com/ClickHouse/ClickHouse/pull/55037) ([Robert Schulze](https://github.com/rschu1ze)).
* Интерфейс MySQL получил минимальную реализацию механизма подготовленных команд, достаточную для подключения Tableau Online к ClickHouse через коннектор MySQL. [#54115](https://github.com/ClickHouse/ClickHouse/pull/54115) ([Serge Klochkov](https://github.com/slvrtrn)). Обратите внимание: реализация подготовленных команд крайне минимальна, привязка аргументов пока не поддерживается, так как она не требуется в данном конкретном сценарии использования Tableau Online. Она будет реализована дополнительно при необходимости после тщательного тестирования Tableau Online, если мы обнаружим проблемы.
* Добавлена поддержка режимов сопоставления без учета регистра и «dot-all» в словарях `regexp_tree`. [#50906](https://github.com/ClickHouse/ClickHouse/pull/50906) ([Johann Gan](https://github.com/johanngan)).
* Улучшение Keeper: добавлена команда `createIfNotExists`. [#48855](https://github.com/ClickHouse/ClickHouse/pull/48855) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Более точное выведение типов целых чисел, исправлена проблема [#51236](https://github.com/ClickHouse/ClickHouse/issues/51236). [#53003](https://github.com/ClickHouse/ClickHouse/pull/53003) ([Chen768959](https://github.com/Chen768959)).
* Добавлено определение кодировок в строковых литералах для MaterializedMySQL. [#53220](https://github.com/ClickHouse/ClickHouse/pull/53220) ([Val Doroshchuk](https://github.com/valbok)).
* Исправлена неочевидная проблема с редко используемым движком таблицы `EmbeddedRocksDB` в крайне редком сценарии: иногда этот движок некорректно закрывал файлы на NFS после выполнения `DROP TABLE`. [#53502](https://github.com/ClickHouse/ClickHouse/pull/53502) ([Mingliang Pan](https://github.com/liangliangpan)).
* `RESTORE TABLE ON CLUSTER` должен создавать реплицированные таблицы с одинаковым UUID на всех хостах. В противном случае макрос `{uuid}` в пути в ZooKeeper не сможет корректно работать после RESTORE. Это реализовано в этом PR. [#53765](https://github.com/ClickHouse/ClickHouse/pull/53765) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена настройка восстановления `restore_broken_parts_as_detached`: если она имеет значение true, процесс RESTORE не будет останавливаться на повреждённых частях при восстановлении, вместо этого все повреждённые части будут скопированы в папку `detached` с префиксом `broken-from-backup'`. Если она имеет значение false, процесс RESTORE остановится на первой повреждённой части (если таковая есть). Значение по умолчанию — false. [#53877](https://github.com/ClickHouse/ClickHouse/pull/53877) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлено поле `elapsed_ns` в HTTP-заголовки X-ClickHouse-Progress и X-ClickHouse-Summary. [#54179](https://github.com/ClickHouse/ClickHouse/pull/54179) ([joelynch](https://github.com/joelynch)).
* Реализация команд `reconfig` ([https://github.com/ClickHouse/ClickHouse/pull/49450](https://github.com/ClickHouse/ClickHouse/pull/49450)), `sync` и `exists` в keeper-client. [#54201](https://github.com/ClickHouse/ClickHouse/pull/54201) ([pufit](https://github.com/pufit)).
* `clickhouse-local` и `clickhouse-client` теперь позволяют указывать параметр `--query` несколько раз, например `./clickhouse-client --query "SELECT 1" --query "SELECT 2"`. Этот синтаксис немного более интуитивен, чем `./clickhouse-client --multiquery "SELECT  1;S ELECT 2"`, чуть проще для использования в скриптах (например, `queries.push_back('--query "$q"')`) и в большей степени соответствует поведению уже существующего параметра `--queries-file` (например, `./clickhouse client --queries-file queries1.sql --queries-file queries2.sql`). [#54249](https://github.com/ClickHouse/ClickHouse/pull/54249) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка субсекундной точности для `formatReadableTimeDelta`. [#54250](https://github.com/ClickHouse/ClickHouse/pull/54250) ([Andrey Zvonov](https://github.com/zvonand)).
* По умолчанию включена настройка `allow_remove_stale_moving_parts`. [#54260](https://github.com/ClickHouse/ClickHouse/pull/54260) ([vdimir](https://github.com/vdimir)).
* Исправлено использование count из кэша и улучшен индикатор прогресса при чтении из архивов. [#54271](https://github.com/ClickHouse/ClickHouse/pull/54271) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка учетных данных S3 с использованием SSO. Чтобы задать профиль, который будет использоваться с SSO, установите переменную среды `AWS_PROFILE`. [#54347](https://github.com/ClickHouse/ClickHouse/pull/54347) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена поддержка значения NULL по умолчанию для вложенных типов данных Array/Tuple/Map во входных форматах. Закрывает [#51100](https://github.com/ClickHouse/ClickHouse/issues/51100). [#54351](https://github.com/ClickHouse/ClickHouse/pull/54351) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка чтения некоторых нетипичных конфигураций фрагментов из форматов Arrow/Parquet. [#54370](https://github.com/ClickHouse/ClickHouse/pull/54370) ([Arthur Passos](https://github.com/arthurpassos)).
* Добавлен псевдоним `STD` к функции `stddevPop` для обеспечения совместимости с MySQL. Закрывает [#54274](https://github.com/ClickHouse/ClickHouse/issues/54274). [#54382](https://github.com/ClickHouse/ClickHouse/pull/54382) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлены функции `addDate` для совместимости с MySQL и `subDate` для единообразия. См. [#54275](https://github.com/ClickHouse/ClickHouse/issues/54275). [#54400](https://github.com/ClickHouse/ClickHouse/pull/54400) ([Nikolay Degterinsky](https://github.com/evillique)).
* В таблицу `system.detached_parts` добавлен столбец `modification_time`. [#54506](https://github.com/ClickHouse/ClickHouse/pull/54506) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена настройка `splitby_max_substrings_includes_remaining_string`, которая определяет, включают ли функции `splitBy*()` с аргументом `max_substring` &gt; 0 оставшуюся часть строки (если она есть) в результирующий массив (семантика Python/Spark) или нет. Поведение по умолчанию не изменилось. [#54518](https://github.com/ClickHouse/ClickHouse/pull/54518) ([Robert Schulze](https://github.com/rschu1ze)).
* Улучшено выведение целочисленных типов для полей `Int64`/`UInt64`. Продолжение [#53003](https://github.com/ClickHouse/ClickHouse/pull/53003). Теперь оно работает и для вложенных типов, таких как массивы массивов, а также для функций вроде `map/tuple`. Задача: [#51236](https://github.com/ClickHouse/ClickHouse/issues/51236). [#54553](https://github.com/ClickHouse/ClickHouse/pull/54553) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлены операции над массивами для умножения, деления и вычисления остатка от деления на скаляр. Работают в обе стороны, например `5 * [5, 5]` и `[5, 5] * 5` — оба варианта возможны. [#54608](https://github.com/ClickHouse/ClickHouse/pull/54608) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлен необязательный аргумент `version` к команде `rm` в `keeper-client` для более безопасного выполнения операций удаления. [#54708](https://github.com/ClickHouse/ClickHouse/pull/54708) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Отключено принудительное завершение сервера через systemd, так как это могло приводить к потере данных при использовании таблиц Buffer. [#54744](https://github.com/ClickHouse/ClickHouse/pull/54744) ([Azat Khuzhin](https://github.com/azat)).
* Добавлено поле `is_deterministic` в системную таблицу `system.functions`, которое указывает, остаётся ли результат функции неизменным при двух вызовах с точно такими же входными данными или нет. [#54766](https://github.com/ClickHouse/ClickHouse/pull/54766) [#55035](https://github.com/ClickHouse/ClickHouse/pull/55035) ([Robert Schulze](https://github.com/rschu1ze)).
* Представления в схеме `information_schema` сделаны более совместимыми с эквивалентными представлениями в MySQL (то есть изменены и расширены) до такой степени, что Tableau Online может подключаться к ClickHouse. В частности: 1. Тип поля `information_schema.tables.table_type` изменён с Enum8 на String. 2. В представление `information_schema.table` добавлены поля `table_comment` и `table_collation`. 3. Добавлены представления `information_schema.key_column_usage` и `referential_constraints`. 4. В представлениях `information_schema` псевдонимы в верхнем регистре заменены на конкретные столбцы с именами в верхнем регистре. [#54773](https://github.com/ClickHouse/ClickHouse/pull/54773) ([Serge Klochkov](https://github.com/slvrtrn)).
* Кэш запросов теперь возвращает ошибку, если вы пытаетесь закэшировать результат запроса с недетерминированной функцией, такой как `now`, `randomString` или `dictGet`. По сравнению с предыдущим поведением (результат просто не кэшировался), это снижает путаницу и эффект неожиданности. [#54801](https://github.com/ClickHouse/ClickHouse/pull/54801) ([Robert Schulze](https://github.com/rschu1ze)).
* Запрещено использование специальных столбцов, таких как materialized/ephemeral/alias, для хранилищ `file`/`s3`/`url`/..., исправлена вставка в ephemeral‑столбцы из файлов. Закрывает [#53477](https://github.com/ClickHouse/ClickHouse/issues/53477). [#54803](https://github.com/ClickHouse/ClickHouse/pull/54803) ([Kruglov Pavel](https://github.com/Avogar)).
* Более настраиваемый сбор метаданных для резервного копирования. [#54804](https://github.com/ClickHouse/ClickHouse/pull/54804) ([Vitaly Baranov](https://github.com/vitlibar)).
* Файл журнала `clickhouse-local` (если включён с помощью флага --server&#95;logs&#95;file) теперь будет префиксовать каждую строку меткой времени, идентификатором потока и т.д., аналогично `clickhouse-server`. [#54807](https://github.com/ClickHouse/ClickHouse/pull/54807) ([Michael Kolupaev](https://github.com/al13n321)).
* Поле `is_obsolete` в таблице `system.merge_tree_settings` — теперь для устаревших настроек MergeTree его значение равно 1. Ранее об устаревании настройки сообщалось только в описании. [#54837](https://github.com/ClickHouse/ClickHouse/pull/54837) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена возможность использовать форму множественного числа в литералах интервала. `INTERVAL 2 HOURS` должен быть эквивалентен `INTERVAL 2 HOUR`. [#54860](https://github.com/ClickHouse/ClickHouse/pull/54860) ([Jordi Villar](https://github.com/jrdi)).
* Всегда разрешать создание проекций с первичным ключом (PK) типа `Nullable`. Это исправляет [#54814](https://github.com/ClickHouse/ClickHouse/issues/54814). [#54895](https://github.com/ClickHouse/ClickHouse/pull/54895) ([Amos Bird](https://github.com/amosbird)).
* Повторять операции резервного копирования в S3 после сбоя из‑за разрыва соединения. [#54900](https://github.com/ClickHouse/ClickHouse/pull/54900) ([Vitaly Baranov](https://github.com/vitlibar)).
* Сделано более точным сообщение об исключении для случая, когда максимальное значение настройки меньше минимального. [#54925](https://github.com/ClickHouse/ClickHouse/pull/54925) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Функции сопоставления `LIKE`, `match` и другие теперь позволяют выполнять сопоставление с шаблонами, содержащими подстроки, не являющиеся UTF-8, путём перехода к двоичному сопоставлению. Пример: вы можете использовать `string LIKE '\xFE\xFF%'` для обнаружения BOM. Это закрывает [#54486](https://github.com/ClickHouse/ClickHouse/issues/54486). [#54942](https://github.com/ClickHouse/ClickHouse/pull/54942) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлено событие профилирования `ContextLockWaitMicroseconds`. [#55029](https://github.com/ClickHouse/ClickHouse/pull/55029) ([Maksim Kita](https://github.com/kitaisreal)).
* Keeper теперь динамически изменяет уровни логирования. [#50372](https://github.com/ClickHouse/ClickHouse/pull/50372) ([helifu](https://github.com/helifu)).
* Добавлена функция `timestamp` для совместимости с MySQL. Закрывает [#54275](https://github.com/ClickHouse/ClickHouse/issues/54275). [#54639](https://github.com/ClickHouse/ClickHouse/pull/54639) ([Nikolay Degterinsky](https://github.com/evillique)).

#### Улучшение сборки/тестирования/упаковки {#buildtestingpackaging-improvement-3}

* Обновлён компилятор для официальных сборок ClickHouse и сборок в системе непрерывной интеграции с Clang 16 до 17. [#53831](https://github.com/ClickHouse/ClickHouse/pull/53831) ([Robert Schulze](https://github.com/rschu1ze)).
* Перегенерированы данные TLD для поиска (`tldLookup.generated.cpp`). [#54269](https://github.com/ClickHouse/ClickHouse/pull/54269) ([Bharat Nallan](https://github.com/bharatnc)).
* Удалена избыточная символьная ссылка `clickhouse-keeper-client`. [#54587](https://github.com/ClickHouse/ClickHouse/pull/54587) ([Tomas Barton](https://github.com/deric)).
* Используется `/usr/bin/env` для поиска bash — теперь поддерживается NixOS. [#54603](https://github.com/ClickHouse/ClickHouse/pull/54603) ([Fionera](https://github.com/fionera)).
* В CMake добавлена опция `PROFILE_CPU`, необходимая для выполнения `perf record` без использования графа вызовов DWARF. [#54917](https://github.com/ClickHouse/ClickHouse/pull/54917) ([Maksim Kita](https://github.com/kitaisreal)).
* Если компоновщик отличается от LLD, сборка завершается с фатальной ошибкой. [#55036](https://github.com/ClickHouse/ClickHouse/pull/55036) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Заменена библиотека для обработки (кодирования/декодирования) значений в формате base64 с Turbo-Base64 на aklomp-base64. Обе используют SIMD-ускорение на x86 и ARM, но: 1) лицензия второй (BSD-2) более благоприятна для ClickHouse, тогда как Turbo64 тем временем перешла на GPL-3; 2) с большим числом звёзд на GitHub aklomp-base64 выглядит более перспективной; 3) aklomp-base64 имеет немного более удобный API (что, разумеется, субъективно); и 4) aklomp-base64 не требует обходных решений вокруг багов (например, потоконебезопасной инициализации). Примечание: aklomp-base64 отвергает значения base64 без паддинга, тогда как Turbo-Base64 декодирует их по принципу «best effort». RFC-4648 оставляет открытым вопрос, является ли паддинг обязательным, но в зависимости от контекста это может привести к изменению поведения, о котором следует помнить. [#54119](https://github.com/ClickHouse/ClickHouse/pull/54119) ([Mikhail Koviazin](https://github.com/mkmkme)).

#### Исправление ошибки (некорректное поведение, заметное пользователю, в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-3}

* Исправлены операции REPLACE/MOVE PARTITION при использовании zero-copy replication (примечание: «zero-copy replication» — экспериментальная функция) [#54193](https://github.com/ClickHouse/ClickHouse/pull/54193) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлены блокировки механизма zero-copy при использовании hardlinks (примечание: «zero-copy replication» — экспериментальная функция) [#54859](https://github.com/ClickHouse/ClickHouse/pull/54859) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлено накопление мусора в zero copy (примечание: «zero-copy replication» — экспериментальная функция) [#54550](https://github.com/ClickHouse/ClickHouse/pull/54550) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Передавать таймаут повторных HTTP-запросов в миллисекундах (раньше он передавался некорректно). [#54438](https://github.com/ClickHouse/ClickHouse/pull/54438) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлено вводящее в заблуждение сообщение об ошибке OUTFILE при использовании `CapnProto`/`Protobuf` [#52870](https://github.com/ClickHouse/ClickHouse/pull/52870) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено формирование сводной статистики при использовании параллельных реплик с LIMIT [#53050](https://github.com/ClickHouse/ClickHouse/pull/53050) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено ограничение скорости выполнения BACKUP-ов при работе с S3 (в случаях, когда не использовалось нативное копирование), а также в некоторых других местах [#53336](https://github.com/ClickHouse/ClickHouse/pull/53336) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено дросселирование операций ввода-вывода (I/O throttling) при копировании целых каталогов [#53338](https://github.com/ClickHouse/ClickHouse/pull/53338) ([Azat Khuzhin](https://github.com/azat)).
* Исправление: при переносе действий в условие PREWHERE столбец мог теряться [#53492](https://github.com/ClickHouse/ClickHouse/pull/53492) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена внутренняя ошибка при замене частей на байтово идентичные [#53735](https://github.com/ClickHouse/ClickHouse/pull/53735) ([Pedro Riera](https://github.com/priera)).
* Исправлено: теперь требуется наличие столбцов, участвующих в выражении interpolate [#53754](https://github.com/ClickHouse/ClickHouse/pull/53754) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена инициализация обнаружения кластера и установка точек отказа в конфигурации [#54113](https://github.com/ClickHouse/ClickHouse/pull/54113) ([vdimir](https://github.com/vdimir)).
* Исправлены проблемы в функции `accurateCastOrNull` [#54136](https://github.com/ClickHouse/ClickHouse/pull/54136) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Исправлена ошибка в Nullable первичном ключе с модификатором FINAL [#54164](https://github.com/ClickHouse/ClickHouse/pull/54164) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка, из-за которой вставка новых данных в реплицируемую materialized view могла завершаться неудачей при наличии дублирующихся данных. [#54184](https://github.com/ClickHouse/ClickHouse/pull/54184) ([Pedro Riera](https://github.com/priera)).
* Исправление: разрешён `IPv6` для bloom-фильтра [#54200](https://github.com/ClickHouse/ClickHouse/pull/54200) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* исправлено возможное несоответствие типов с `IPv4` [#54212](https://github.com/ClickHouse/ClickHouse/pull/54212) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлена `system.data_skipping_indices` для заново созданных индексов [#54225](https://github.com/ClickHouse/ClickHouse/pull/54225) ([Artur Malchanau](https://github.com/Hexta)).
* исправлен конфликт имён для multiple join rewriter v2 [#54240](https://github.com/ClickHouse/ClickHouse/pull/54240) ([Tao Wang](https://github.com/wangtZJU)).
* Исправлены неожиданные ошибки в `system.errors` после выполнения JOIN [#54306](https://github.com/ClickHouse/ClickHouse/pull/54306) ([vdimir](https://github.com/vdimir)).
* Исправлена ошибка в `isZeroOrNull(NULL)` [#54316](https://github.com/ClickHouse/ClickHouse/pull/54316) ([flynn](https://github.com/ucasfl)).
* Исправлено: параллельные реплики поверх Distributed при `prefer_localhost_replica` = 1 [#54334](https://github.com/ClickHouse/ClickHouse/pull/54334) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлена логическая ошибка в вертикальном слиянии + ReplacingMergeTree + очистке при `OPTIMIZE` [#54368](https://github.com/ClickHouse/ClickHouse/pull/54368) ([alesapin](https://github.com/alesapin)).
* Исправлена потенциальная ошибка `URI contains invalid characters` в табличной функции `s3` [#54373](https://github.com/ClickHouse/ClickHouse/pull/54373) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка сегментации (segfault) при оптимизации AST функции `arrayExists` [#54379](https://github.com/ClickHouse/ClickHouse/pull/54379) ([Nikolay Degterinsky](https://github.com/evillique)).
* Проверка переполнения перед сложением в функции `analysisOfVariance` [#54385](https://github.com/ClickHouse/ClickHouse/pull/54385) ([Antonio Andelic](https://github.com/antonio2368)).
* Ошибка в removeSharedRecursive воспроизведена и исправлена [#54430](https://github.com/ClickHouse/ClickHouse/pull/54430) ([Sema Checherinda](https://github.com/CheSema)).
* Исправлен возможный некорректный результат при использовании SimpleAggregateFunction в PREWHERE и FINAL [#54436](https://github.com/ClickHouse/ClickHouse/pull/54436) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена фильтрация частей с `indexHint` для случаев без analyzer [#54449](https://github.com/ClickHouse/ClickHouse/pull/54449) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа агрегатных проекций с нормализованными состояниями [#54480](https://github.com/ClickHouse/ClickHouse/pull/54480) ([Amos Bird](https://github.com/amosbird)).
* `clickhouse-local`: исправление, связанное с параметром multiquery [#54498](https://github.com/ClickHouse/ClickHouse/pull/54498) ([CuiShuoGuo](https://github.com/bakam412)).
* `clickhouse-local` теперь поддерживает аргумент командной строки `--database` [#54503](https://github.com/ClickHouse/ClickHouse/pull/54503) ([vdimir](https://github.com/vdimir)).
* Исправлена потенциальная ошибка парсинга в форматах `-WithNames` при отключённом `input_format_with_names_use_header` [#54513](https://github.com/ClickHouse/ClickHouse/pull/54513) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен редкий случай возникновения ошибки CHECKSUM&#95;DOESNT&#95;MATCH [#54549](https://github.com/ClickHouse/ClickHouse/pull/54549) ([alesapin](https://github.com/alesapin)).
* Исправлена обработка сортировки в `UNION ALL` для уже отсортированных результатов [#54564](https://github.com/ClickHouse/ClickHouse/pull/54564) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена установка снапшота в Keeper [#54572](https://github.com/ClickHouse/ClickHouse/pull/54572) ([Antonio Andelic](https://github.com/antonio2368)).
* Устранено состояние гонки в `ColumnUnique` [#54575](https://github.com/ClickHouse/ClickHouse/pull/54575) ([Nikita Taranov](https://github.com/nickitat)).
* Индекс Annoy/Usearch: исправлена ошибка LOGICAL&#95;ERROR, возникавшая при построении со значениями по умолчанию [#54600](https://github.com/ClickHouse/ClickHouse/pull/54600) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена сериализация для `ColumnDecimal` [#54601](https://github.com/ClickHouse/ClickHouse/pull/54601) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлено определение схемы в функциях *Cluster для имён столбцов, содержащих пробелы [#54635](https://github.com/ClickHouse/ClickHouse/pull/54635) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено использование структуры таблиц-приёмников в случае значений по умолчанию и явного указания столбцов в INSERT [#54655](https://github.com/ClickHouse/ClickHouse/pull/54655) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправление: избегать использования сопоставления с регулярным выражением, которое может содержать альтернативы, в качестве ключевого условия. [#54696](https://github.com/ClickHouse/ClickHouse/pull/54696) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена проблема в ReplacingMergeTree при вертикальном слиянии и очистке [#54706](https://github.com/ClickHouse/ClickHouse/pull/54706) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлена проблема, из-за которой виртуальные столбцы получали неверные значения после ORDER BY [#54811](https://github.com/ClickHouse/ClickHouse/pull/54811) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена фильтрация частей с indexHint для non-analyzer [#54825](https://github.com/ClickHouse/ClickHouse/pull/54825) [#54449](https://github.com/ClickHouse/ClickHouse/pull/54449) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено падение Keeper из-за ошибки сегментации при завершении работы [#54841](https://github.com/ClickHouse/ClickHouse/pull/54841) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка `Invalid number of rows in Chunk` в MaterializedPostgreSQL [#54844](https://github.com/ClickHouse/ClickHouse/pull/54844) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Устаревшие настройки форматов перенесены в отдельный раздел [#54855](https://github.com/ClickHouse/ClickHouse/pull/54855) ([Kruglov Pavel](https://github.com/Avogar)).
* Теперь `minmax_count_projection` перестраивается при изменении ключа партиции [#54943](https://github.com/ClickHouse/ClickHouse/pull/54943) ([Amos Bird](https://github.com/amosbird)).
* Исправлено некорректное приведение типа к `ColumnVector<Int128>` в функции `if` [#55019](https://github.com/ClickHouse/ClickHouse/pull/55019) ([Kruglov Pavel](https://github.com/Avogar)).
* Предотвращена возможность присоединения частей таблиц с разными проекциями или индексами [#55062](https://github.com/ClickHouse/ClickHouse/pull/55062) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Сохранять NULL в отображении скалярных результатов при пустом результате подзапроса [#52240](https://github.com/ClickHouse/ClickHouse/pull/52240) ([vdimir](https://github.com/vdimir)).
* Исправлена ошибка, из-за которой оператор `FINAL` в редких случаях формировал некорректные диапазоны чтения [#54934](https://github.com/ClickHouse/ClickHouse/pull/54934) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлено: кворум вставки без повторных попыток ClickHouse Keeper [#55026](https://github.com/ClickHouse/ClickHouse/pull/55026) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлено простое состояние с типом Nullable [#55030](https://github.com/ClickHouse/ClickHouse/pull/55030) ([Pedro Riera](https://github.com/priera)).

### <a id="238"></a> Выпуск ClickHouse 23.8 LTS, 2023-08-31. [Презентация](https://presentations.clickhouse.com/2023-release-23.8/), [Видео](https://www.youtube.com/watch?v=d1_pyoWcydk) {#238}

<iframe width="1024" height="576" src="https://www.youtube.com/embed/d1_pyoWcydk" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

#### Обратное несовместимое изменение {#backward-incompatible-change-4}

* Если у динамического диска есть имя, его следует указывать в аргументах функции disk как `disk = disk(name = 'disk_name'`, ...). В предыдущей версии его можно было указывать как `disk = disk_<disk_name>(...)`, что больше не поддерживается. [#52820](https://github.com/ClickHouse/ClickHouse/pull/52820) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `clickhouse-benchmark` будет устанавливать соединения параллельно, если он запущен с параметром `--concurrency` больше единицы. Ранее он был практически непригоден к использованию, если вы запускали его с 1000 одновременных соединений из Европы в США. Исправлен расчет QPS для соединений с высокой задержкой. Обратное несовместимое изменение: опция вывода `clickhouse-benchmark` в формате JSON удалена. Если вы использовали эту опцию, в качестве обходного решения вы можете извлекать данные из `system.query_log` в формате JSON. [#53293](https://github.com/ClickHouse/ClickHouse/pull/53293) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Столбец `microseconds` удален из `system.text_log`, а столбец `milliseconds` удален из `system.metric_log`, поскольку они избыточны при наличии столбца `event_time_microseconds`. [#53601](https://github.com/ClickHouse/ClickHouse/pull/53601) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Механизм кэширования метаданных объявлен устаревшим. Он является экспериментальным, и мы никогда его не использовали. Механизм опасен: [#51182](https://github.com/ClickHouse/ClickHouse/issues/51182). Удалена системная таблица `system.merge_tree_metadata_cache`. Кэш метаданных все еще доступен в этой версии, но вскоре будет удален. Это закрывает [#39197](https://github.com/ClickHouse/ClickHouse/issues/39197). [#51303](https://github.com/ClickHouse/ClickHouse/pull/51303) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Отключена поддержка 3DES в TLS-соединениях. [#52893](https://github.com/ClickHouse/ClickHouse/pull/52893) ([Kenji Noguchi](https://github.com/knoguchi)).

#### Новая функция {#new-feature-4}

* Прямой импорт из архивов форматов zip/7z/tar. Пример: `file('*.zip :: *.csv')`. [#50321](https://github.com/ClickHouse/ClickHouse/pull/50321) ([nikitakeba](https://github.com/nikitakeba)).
* Добавлен столбец `ptr` в `system.trace_log` для `trace_type = 'MemorySample'`. Этот столбец содержит адрес выделенной памяти. Добавлена функция `flameGraph`, которая может строить flamegraph с информацией о выделенной и не освобождённой памяти. Доработка [#38391](https://github.com/ClickHouse/ClickHouse/issues/38391). [#45322](https://github.com/ClickHouse/ClickHouse/pull/45322) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлена табличная функция `azureBlobStorageCluster`. Набор поддерживаемых возможностей во многом аналогичен табличной функции `s3Cluster`. [#50795](https://github.com/ClickHouse/ClickHouse/pull/50795) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Разрешено использовать `cluster`, `clusterAllReplicas`, `remote` и `remoteSecure` без указания имени таблицы (см. задачу [#50808](https://github.com/ClickHouse/ClickHouse/issues/50808)). [#50848](https://github.com/ClickHouse/ClickHouse/pull/50848) ([Yangkuan Liu](https://github.com/LiuYangkuan)).
* Системная таблица для мониторинга потребителей в Kafka. [#50999](https://github.com/ClickHouse/ClickHouse/pull/50999) ([Ilya Golshtein](https://github.com/ilejn)).
* Добавлена настройка `max_sessions_for_user`. [#51724](https://github.com/ClickHouse/ClickHouse/pull/51724) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
* Новые функции `toUTCTimestamp/fromUTCTimestamp`, аналогичные функциям Spark `to_utc_timestamp/from_utc_timestamp`. [#52117](https://github.com/ClickHouse/ClickHouse/pull/52117) ([KevinyhZou](https://github.com/KevinyhZou)).
* Добавлены новые функции `structureToCapnProtoSchema`/`structureToProtobufSchema`, которые преобразуют структуру таблицы ClickHouse в схему формата CapnProto/Protobuf. Эти функции позволяют выполнять ввод/вывод данных в формате CapnProto/Protobuf без внешней схемы формата, используя автоматически сгенерированную схему на основе структуры таблицы (управляется настройками `format_capn_proto_use_autogenerated_schema`/`format_protobuf_use_autogenerated_schema`). Также они позволяют экспортировать автоматически сгенерированную схему при вводе/выводе данных с помощью настройки `output_format_schema`. [#52278](https://github.com/ClickHouse/ClickHouse/pull/52278) ([Kruglov Pavel](https://github.com/Avogar)).
* Новое поле `query_cache_usage` в `system.query_log` теперь показывает, использовался ли кеш запросов и каким образом. [#52384](https://github.com/ClickHouse/ClickHouse/pull/52384) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлены новые функции `startsWithUTF8` и `endsWithUTF8`. [#52555](https://github.com/ClickHouse/ClickHouse/pull/52555) ([李扬](https://github.com/taiyang-li)).
* Разрешено использование переменного числа столбцов в TSV/CustomSeparated/JSONCompactEachRow, определение схемы теперь работает с переменным числом столбцов. Добавлены настройки `input_format_tsv_allow_variable_number_of_columns`, `input_format_custom_allow_variable_number_of_columns`, `input_format_json_compact_allow_variable_number_of_columns`. [#52692](https://github.com/ClickHouse/ClickHouse/pull/52692) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлены запросы `SYSTEM STOP/START PULLING REPLICATION LOG` (для тестирования `ReplicatedMergeTree`). [#52881](https://github.com/ClickHouse/ClickHouse/pull/52881) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Разрешено выполнение константных недетерминированных функций в мутациях на сервере-инициаторе. [#53129](https://github.com/ClickHouse/ClickHouse/pull/53129) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлен формат ввода `One`, который не читает данные и всегда возвращает одну строку со столбцом `dummy` типа `UInt8` и значением `0`, как `system.one`. Его можно использовать совместно с виртуальными столбцами `_file/_path` для перечисления файлов в табличных функциях file/s3/url/hdfs/etc без чтения данных. [#53209](https://github.com/ClickHouse/ClickHouse/pull/53209) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена функция `tupleConcat`. Закрывает [#52759](https://github.com/ClickHouse/ClickHouse/issues/52759). [#53239](https://github.com/ClickHouse/ClickHouse/pull/53239) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена поддержка операции `TRUNCATE DATABASE`. [#53261](https://github.com/ClickHouse/ClickHouse/pull/53261) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлена настройка `max_threads_for_indexes` для ограничения числа потоков, используемых при обработке первичного ключа. [#53313](https://github.com/ClickHouse/ClickHouse/pull/53313) ([jorisgio](https://github.com/jorisgio)).
* Снова добавлены функции SipHash с ключом. [#53525](https://github.com/ClickHouse/ClickHouse/pull/53525) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* ([#52755](https://github.com/ClickHouse/ClickHouse/issues/52755), [#52895](https://github.com/ClickHouse/ClickHouse/issues/52895)) Добавлены функции `arrayRotateLeft`, `arrayRotateRight`, `arrayShiftLeft`, `arrayShiftRight`. [#53557](https://github.com/ClickHouse/ClickHouse/pull/53557) ([Mikhail Koviazin](https://github.com/mkmkme)).
* Добавлен столбец `name` в таблицу `system.clusters` в качестве псевдонима столбца `cluster`. [#53605](https://github.com/ClickHouse/ClickHouse/pull/53605) ([irenjj](https://github.com/irenjj)).
* Расширенная панель мониторинга теперь поддерживает массовое редактирование (сохранение/загрузка). [#53608](https://github.com/ClickHouse/ClickHouse/pull/53608) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* В расширенной панели мониторинга теперь можно разворачивать графики на весь экран и менять их расположение. [#53622](https://github.com/ClickHouse/ClickHouse/pull/53622) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка операций сложения и вычитания для массивов: `[5,2] + [1,7]`. Деление и умножение не были реализованы из-за неоднозначности между покомпонентным (точечным) умножением и скалярным произведением аргументов. Закрывает [#49939](https://github.com/ClickHouse/ClickHouse/issues/49939). [#52625](https://github.com/ClickHouse/ClickHouse/pull/52625) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена поддержка использования строковых литералов в качестве имён таблиц. Закрывает [#52178](https://github.com/ClickHouse/ClickHouse/issues/52178). [#52635](https://github.com/ClickHouse/ClickHouse/pull/52635) ([hendrik-m](https://github.com/hendrik-m)).

#### Экспериментальная возможность {#experimental-feature-1}

* Добавлен новый движок таблицы `S3Queue` для потокового импорта данных из S3. Закрывает [#37012](https://github.com/ClickHouse/ClickHouse/issues/37012). [#49086](https://github.com/ClickHouse/ClickHouse/pull/49086) ([s-kat](https://github.com/s-kat)). Эта функция пока не готова к использованию. Не используйте её.
* Включено параллельное чтение с реплик по distributed таблице. Связано с [#49708](https://github.com/ClickHouse/ClickHouse/issues/49708). [#53005](https://github.com/ClickHouse/ClickHouse/pull/53005) ([Igor Nikonov](https://github.com/devcrafter)).
* Добавлена экспериментальная поддержка HNSW как метода приближённого поиска ближайших соседей. [#53447](https://github.com/ClickHouse/ClickHouse/pull/53447) ([Davit Vardanyan](https://github.com/davvard)). В настоящий момент предназначено для тех, кто продолжает работать над реализацией. Не используйте её.

#### Повышение производительности {#performance-improvement-4}

* Проталкивание фильтра при работе с Parquet (filter pushdown). То есть при чтении файлов Parquet группы строк (фрагменты файла) пропускаются на основе условия WHERE и минимальных/максимальных значений в каждом столбце. В частности, если файл примерно отсортирован по какому-либо столбцу, запросы, которые фильтруют по узкому диапазону значений этого столбца, будут выполняться значительно быстрее. [#52951](https://github.com/ClickHouse/ClickHouse/pull/52951) ([Michael Kolupaev](https://github.com/al13n321)).
* Оптимизировано чтение небольших групп строк за счёт их объединения в пакеты в формате Parquet. Исправляет [#53069](https://github.com/ClickHouse/ClickHouse/issues/53069). [#53281](https://github.com/ClickHouse/ClickHouse/pull/53281) ([Kruglov Pavel](https://github.com/Avogar)).
* Оптимизировано вычисление COUNT по файлам в большинстве форматов входных данных. Закрывает [#44334](https://github.com/ClickHouse/ClickHouse/issues/44334). [#53637](https://github.com/ClickHouse/ClickHouse/pull/53637) ([Kruglov Pavel](https://github.com/Avogar)).
* Перед чтением данных в табличных функциях `url`/`file`/`hdfs` используйте фильтрацию по имени файла/пути. [#53529](https://github.com/ClickHouse/ClickHouse/pull/53529) ([Kruglov Pavel](https://github.com/Avogar)).
* Включена JIT-компиляция для архитектур AArch64, PowerPC, SystemZ и RISC-V. [#38217](https://github.com/ClickHouse/ClickHouse/pull/38217) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена настройка `rewrite_count_distinct_if_with_count_distinct_implementation` для переписывания выражений `countDistinctIf` с использованием `count_distinct_implementation`. Закрывает [#30642](https://github.com/ClickHouse/ClickHouse/issues/30642). [#46051](https://github.com/ClickHouse/ClickHouse/pull/46051) ([flynn](https://github.com/ucasfl)).
* Ускорено слияние состояний агрегатных функций `uniq` и `uniqExact` за счёт параллельного преобразования перед слиянием. [#50748](https://github.com/ClickHouse/ClickHouse/pull/50748) ([Jiebin Sun](https://github.com/jiebinn)).
* Повышена производительность агрегации по строковому ключу типа Nullable при использовании большого числа ключей переменной длины. [#51399](https://github.com/ClickHouse/ClickHouse/pull/51399) ([LiuNeng](https://github.com/liuneng1994)).
* Добавлен проход в Analyzer для оптимизации временных фильтров с использованием preimage. Результаты экспериментов производительности SSB на устройстве ICX (Intel Xeon Platinum 8380 CPU, 80 ядер, 160 потоков) показывают, что это изменение может улучшить геометрическое среднее по QPS на 8,5% при включённом экспериментальном анализаторе. [#52091](https://github.com/ClickHouse/ClickHouse/pull/52091) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
* Оптимизировано слияние в функции `uniqExact` (COUNT DISTINCT), когда все хэш‑множества одноуровневые. [#52973](https://github.com/ClickHouse/ClickHouse/pull/52973) ([Jiebin Sun](https://github.com/jiebinn)).
* `Join` table engine: не клонировать хеш-структуру данных соединения целиком (со всеми столбцами). [#53046](https://github.com/ClickHouse/ClickHouse/pull/53046) ([Duc Canh Le](https://github.com/canhld94)).
* Реализован собственный входной формат `ORC` без использования библиотеки Apache Arrow для повышения производительности. [#53324](https://github.com/ClickHouse/ClickHouse/pull/53324) ([李扬](https://github.com/taiyang-li)).
* Панель управления будет сообщать серверу, что данные нужно сжимать, что полезно для больших временных интервалов при медленном интернет-соединении. Например, один график с 86400 точками может занимать 1,5 МБ в несжатом виде и 60 КБ в сжатом виде с `br`. [#53569](https://github.com/ClickHouse/ClickHouse/pull/53569) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшено использование пула потоков при выполнении операций BACKUP и RESTORE. [#53649](https://github.com/ClickHouse/ClickHouse/pull/53649) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Параллельная загрузка метаданных файлового кэша при запуске. Настраивается параметром конфигурации кэша `load_metadata_threads` (по умолчанию: 1). Связано с [#52037](https://github.com/ClickHouse/ClickHouse/issues/52037). [#52943](https://github.com/ClickHouse/ClickHouse/pull/52943) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Улучшен `move_primary_key_columns_to_end_of_prewhere`. [#53337](https://github.com/ClickHouse/ClickHouse/pull/53337) ([Han Fei](https://github.com/hanfei1991)).
* Это оптимизирует взаимодействие с ClickHouse Keeper. Ранее вызывающий код мог зарегистрировать один и тот же watch callback несколько раз. В этом случае каждая запись потребляла память, и тот же callback вызывался несколько раз, что не имело большого смысла. Чтобы избежать этого, вызывающий код мог добавлять логику, не позволяющую регистрировать один и тот же watch несколько раз. С этим изменением такая дедупликация выполняется автоматически, если watch callback передаётся через shared&#95;ptr. [#53452](https://github.com/ClickHouse/ClickHouse/pull/53452) ([Alexander Gololobov](https://github.com/davenger)).
* Кэширование количества строк в файлах при выполнении `count` в функциях file/s3/url/hdfs/azure. Кэш может быть включён или отключён с помощью настройки `use_cache_for_count_from_files` (по умолчанию включён). Продолжение [https://github.com/ClickHouse/ClickHouse/pull/53637](https://github.com/ClickHouse/ClickHouse/pull/53637). [#53692](https://github.com/ClickHouse/ClickHouse/pull/53692) ([Kruglov Pavel](https://github.com/Avogar)).
* Более тщательное управление потоками повышает скорость работы табличной функции S3 при обработке большого количества файлов более чем на ~25%. [#53668](https://github.com/ClickHouse/ClickHouse/pull/53668) ([pufit](https://github.com/pufit)).

#### Улучшения {#improvement-4}

* Добавлена настройка `stderr_reaction` для управления реакцией (none, log или throw), когда внешняя команда записывает данные в stderr. Это упрощает отладку внешних команд. [#43210](https://github.com/ClickHouse/ClickHouse/pull/43210) ([Amos Bird](https://github.com/amosbird)).
* Добавлен столбец `partition` в `system part_log` и таблицу-объединение. [#48990](https://github.com/ClickHouse/ClickHouse/pull/48990) ([Jianfei Hu](https://github.com/incfly)).
* Размеры кэшей индекса (несжатых данных и mark-данных), mmap и запросов теперь можно динамически настраивать во время работы сервера (без его перезапуска). [#51446](https://github.com/ClickHouse/ClickHouse/pull/51446) ([Robert Schulze](https://github.com/rschu1ze)).
* Если словарь создан со сложным ключом, автоматически выбирается вариант компоновки «complex key». [#49587](https://github.com/ClickHouse/ClickHouse/pull/49587) ([xiebin](https://github.com/xbthink)).
* Добавлена настройка `use_concurrency_control` для улучшенного тестирования нового механизма управления параллелизмом. [#49618](https://github.com/ClickHouse/ClickHouse/pull/49618) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлены подсказки по исправлению опечаток в названиях баз данных и таблиц. [#49801](https://github.com/ClickHouse/ClickHouse/pull/49801) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* При чтении небольших файлов из HDFS с помощью Gluten мы обнаружили, что это занимает больше времени по сравнению с непосредственным выполнением запросов в Spark. Мы оптимизировали этот сценарий. [#50063](https://github.com/ClickHouse/ClickHouse/pull/50063) ([KevinyhZou](https://github.com/KevinyhZou)).
* После истечения срока действия сессии появлялось слишком много бесполезных сообщений об ошибках в логах, что нас не устраивало. [#50171](https://github.com/ClickHouse/ClickHouse/pull/50171) ([helifu](https://github.com/helifu)).
* Добавлены резервные сессии ZooKeeper с ограниченным временем жизни. Исправлен столбец `index` в system.zookeeper&#95;connection для DNS-адресов. [#50424](https://github.com/ClickHouse/ClickHouse/pull/50424) ([Anton Kozlov](https://github.com/tonickkozlov)).
* Добавлена возможность записывать в лог достижение max&#95;partitions&#95;per&#95;insert&#95;block. [#50948](https://github.com/ClickHouse/ClickHouse/pull/50948) ([Sean Haynes](https://github.com/seandhaynes)).
* Добавлен набор дополнительных команд в clickhouse-keeper-client (в основном для упрощения отладки ClickHouse). [#51117](https://github.com/ClickHouse/ClickHouse/pull/51117) ([pufit](https://github.com/pufit)).
* Обновлена проверка строки подключения в табличной функции `azureBlobStorage`, так как строка подключения с «sas» не всегда начинается с конечной точки по умолчанию, а также обновлён URL подключения: теперь токен «sas» добавляется в URL после контейнера Azure. [#51141](https://github.com/ClickHouse/ClickHouse/pull/51141) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлено описание фильтрации множеств в алгоритме JOIN `full_sorting_merge`. [#51329](https://github.com/ClickHouse/ClickHouse/pull/51329) ([Tanay Tummalapalli](https://github.com/ttanay)).
* Исправлено использование памяти в `Aggregator` при очень большом значении `max_block_size`. [#51566](https://github.com/ClickHouse/ClickHouse/pull/51566) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлена команда `SYSTEM SYNC FILESYSTEM CACHE`. Она сравнивает состояние кэша файловой системы в памяти с состоянием на диске и при необходимости исправляет состояние в памяти. Она требуется только в случае ручного вмешательства в данные на диске, что крайне не рекомендуется. [#51622](https://github.com/ClickHouse/ClickHouse/pull/51622) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Попытка реализовать универсальный proxy resolver для ClickHouse при сохранении обратной совместимости с существующим proxy resolver для конфигурации хранилища S3. [#51749](https://github.com/ClickHouse/ClickHouse/pull/51749) ([Arthur Passos](https://github.com/arthurpassos)).
* Добавлена поддержка чтения подстолбцов кортежей из табличных функций file, s3, hdfs, url и azureBlobStorage. [#51806](https://github.com/ClickHouse/ClickHouse/pull/51806) ([Kruglov Pavel](https://github.com/Avogar)).
* Функция `arrayIntersect` теперь возвращает значения в порядке следования элементов первого аргумента. Закрывает [#27622](https://github.com/ClickHouse/ClickHouse/issues/27622). [#51850](https://github.com/ClickHouse/ClickHouse/pull/51850) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлены новые запросы, позволяющие создавать и удалять объекты доступа в указанном хранилище доступа либо переносить объекты доступа из одного хранилища доступа в другое. [#51912](https://github.com/ClickHouse/ClickHouse/pull/51912) ([pufit](https://github.com/pufit)).
* Сделать так, чтобы запросы `ALTER TABLE FREEZE` не реплицировались в таблицах с движком Replicated. [#52064](https://github.com/ClickHouse/ClickHouse/pull/52064) ([Mike Kot](https://github.com/myrrc)).
* Добавлена возможность сбрасывать системные таблицы на диск при неожиданном завершении работы. [#52174](https://github.com/ClickHouse/ClickHouse/pull/52174) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
* Исправлена ошибка, из-за которой табличная функция `s3` не работала с предварительно подписанными URL-адресами. Закрывает [#50846](https://github.com/ClickHouse/ClickHouse/issues/50846). [#52310](https://github.com/ClickHouse/ClickHouse/pull/52310) ([chen](https://github.com/xiedeyantu)).
* Добавлен столбец `name` — псевдоним столбцов `event` и `metric` в таблицах `system.events` и `system.metrics`. Закрывает [#51257](https://github.com/ClickHouse/ClickHouse/issues/51257). [#52315](https://github.com/ClickHouse/ClickHouse/pull/52315) ([chen](https://github.com/xiedeyantu)).
* Добавлена поддержка синтаксиса `CREATE UNIQUE INDEX` в парсере как no-op (операции без действия) для лучшей совместимости с SQL. Индекс `UNIQUE` не поддерживается. Установите `create_index_ignore_unique = 1`, чтобы игнорировать ключевое слово `UNIQUE` в запросах. [#52320](https://github.com/ClickHouse/ClickHouse/pull/52320) ([Ilya Yatsishin](https://github.com/qoega)).
* Добавлена поддержка использования предопределённых макросов (`{database}` и `{table}`) в ряде настроек движка Kafka: topic, consumer, client&#95;id и т. д. [#52386](https://github.com/ClickHouse/ClickHouse/pull/52386) ([Yury Bogomolov](https://github.com/ybogo)).
* Отключено обновление кэша файловой системы во время backup/restore. Кэш файловой системы не должен обновляться при выполнении backup/restore, поскольку, по-видимому, это лишь замедляет процесс без какой-либо выгоды (так как команда BACKUP может читать большие объёмы данных, и нет смысла помещать все данные в кэш файловой системы и сразу же их оттуда вытеснять). [#52402](https://github.com/ClickHouse/ClickHouse/pull/52402) ([Vitaly Baranov](https://github.com/vitlibar)).
* Конфигурация S3-эндпоинта позволяет использовать его от корня и при необходимости автоматически добавляет символ &#39;/&#39;. [#47809](https://github.com/ClickHouse/ClickHouse/issues/47809). [#52600](https://github.com/ClickHouse/ClickHouse/pull/52600) ([xiaolei565](https://github.com/xiaolei565)).
* В clickhouse-local разрешены позиционные аргументы и заполняются глобальные настройки UDF (user&#95;scripts&#95;path и user&#95;defined&#95;executable&#95;functions&#95;config). [#52643](https://github.com/ClickHouse/ClickHouse/pull/52643) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* `system.asynchronous_metrics` теперь включает метрики «QueryCacheEntries» и «QueryCacheBytes» для проверки кэша запросов. [#52650](https://github.com/ClickHouse/ClickHouse/pull/52650) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена возможность использовать параметр `s3_storage_class` в предложении `SETTINGS` оператора `BACKUP` при создании резервных копий в S3. [#52658](https://github.com/ClickHouse/ClickHouse/pull/52658) ([Roman Vasin](https://github.com/rvasin)).
* Добавлена утилита `print-backup-info.py`, которая разбирает файл метаданных резервной копии и выводит информацию о ней. [#52690](https://github.com/ClickHouse/ClickHouse/pull/52690) ([Vitaly Baranov](https://github.com/vitlibar)).
* Закрывает [#49510](https://github.com/ClickHouse/ClickHouse/issues/49510). В настоящее время имена баз данных и таблиц чувствительны к регистру, но BI‑инструменты выполняют запросы к `information_schema` то в нижнем регистре, то в верхнем. По этой причине у нас есть база данных `information_schema`, содержащая таблицы в нижнем регистре, такие как `information_schema.tables`, и база данных `INFORMATION_SCHEMA`, содержащая таблицы в верхнем регистре, такие как `INFORMATION_SCHEMA.TABLES`. Но некоторые инструменты выполняют запросы к `INFORMATION_SCHEMA.tables` и `information_schema.TABLES`. Предлагаемое решение — продублировать таблицы и в нижнем, и в верхнем регистре в обеих базах данных `information_schema` (с именами в нижнем и верхнем регистре). [#52695](https://github.com/ClickHouse/ClickHouse/pull/52695) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Запрос `CHECK TABLE` имеет более высокую производительность и удобен в использовании (отправляет обновления о ходе выполнения, может быть отменён). [#52745](https://github.com/ClickHouse/ClickHouse/pull/52745) ([vdimir](https://github.com/vdimir)).
* Добавлена поддержка `modulo`, `intDiv`, `intDivOrZero` для кортежей за счёт применения этих операций к каждому элементу кортежа. [#52758](https://github.com/ClickHouse/ClickHouse/pull/52758) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Искать стандартные конфигурации `yaml` и `yml` в clickhouse-client после `xml`. [#52767](https://github.com/ClickHouse/ClickHouse/pull/52767) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* При слиянии с конфигурацией, корневой элемент которой имеет имя, отличное от &#39;clickhouse&#39;, конфигурации с другим именем корневого узла просто пропускались без выбрасывания исключения. [#52770](https://github.com/ClickHouse/ClickHouse/pull/52770) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Теперь можно задавать минимальный (`memory_profiler_sample_min_allocation_size`) и максимальный (`memory_profiler_sample_max_allocation_size`) размеры выделений памяти, которые будут отслеживаться выборочным профилировщиком памяти. [#52779](https://github.com/ClickHouse/ClickHouse/pull/52779) ([alesapin](https://github.com/alesapin)).
* Добавлена настройка `precise_float_parsing` для переключения методов разбора чисел с плавающей запятой (быстрый/точный). [#52791](https://github.com/ClickHouse/ClickHouse/pull/52791) ([Andrey Zvonov](https://github.com/zvonand)).
* Использовать те же пути по умолчанию для `clickhouse-keeper` (символической ссылки), как для `clickhouse-keeper` (исполняемого файла). [#52861](https://github.com/ClickHouse/ClickHouse/pull/52861) ([Vitaly Baranov](https://github.com/vitlibar)).
* Улучшено сообщение об ошибке для табличной функции `remote`. Закрывает [#40220](https://github.com/ClickHouse/ClickHouse/issues/40220). [#52959](https://github.com/ClickHouse/ClickHouse/pull/52959) ([jiyoungyoooo](https://github.com/jiyoungyoooo)).
* Добавлена возможность указывать пользовательскую политику хранения в секции `SETTINGS` для запросов `RESTORE`. [#52970](https://github.com/ClickHouse/ClickHouse/pull/52970) ([Victor Krasnov](https://github.com/sirvickr)).
* Добавлена возможность ограничивать частоту запросов к S3 при операциях резервного копирования (теперь команды `BACKUP` и `RESTORE` учитывают параметры `s3_max_[get/put]_[rps/burst]`). [#52974](https://github.com/ClickHouse/ClickHouse/pull/52974) ([Daniel Pozo Escalona](https://github.com/danipozo)).
* Добавлены настройки для игнорирования предложения ON CLUSTER в запросах при управлении реплицируемыми пользовательскими функциями или сущностями управления доступом с реплицируемым хранилищем. [#52975](https://github.com/ClickHouse/ClickHouse/pull/52975) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Действия EXPLAIN для шага JOIN. [#53006](https://github.com/ClickHouse/ClickHouse/pull/53006) ([Maksim Kita](https://github.com/kitaisreal)).
* Функции `hasTokenOrNull` и `hasTokenCaseInsensitiveOrNull` теперь возвращают null для пустых поисковых строк. [#53059](https://github.com/ClickHouse/ClickHouse/pull/53059) ([ltrk2](https://github.com/ltrk2)).
* Добавлена возможность ограничивать допустимые пути для файловых кешей. В основном это полезно для динамических дисков. Если в конфигурации сервера указан `filesystem_caches_path`, все пути файловых кешей будут ограничены этим каталогом. Например, если `path` в конфигурации кеша относительный — он будет размещён внутри `filesystem_caches_path`; если `path` в конфигурации кеша абсолютный, потребуется, чтобы он находился внутри `filesystem_caches_path`. Если `filesystem_caches_path` не указан в конфигурации, поведение будет таким же, как в более ранних версиях. [#53124](https://github.com/ClickHouse/ClickHouse/pull/53124) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлено несколько пользовательских команд (главным образом для упрощения отладки ClickHouse). [#53127](https://github.com/ClickHouse/ClickHouse/pull/53127) ([pufit](https://github.com/pufit)).
* Добавлена диагностическая информация об имени файла при выводе схемы — это помогает при обработке нескольких файлов с использованием glob-шаблонов. [#53135](https://github.com/ClickHouse/ClickHouse/pull/53135) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Клиент будет загружать подсказки через основное соединение, если второму соединению запрещено создавать сессию. [#53177](https://github.com/ClickHouse/ClickHouse/pull/53177) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
* Добавлено предложение EXCEPT в запрос `SYSTEM STOP/START LISTEN QUERIES [ALL/DEFAULT/CUSTOM]`, например: `SYSTEM STOP LISTEN QUERIES ALL EXCEPT TCP, HTTP`. [#53280](https://github.com/ClickHouse/ClickHouse/pull/53280) ([Nikolay Degterinsky](https://github.com/evillique)).
* Изменено значение по умолчанию для `max_concurrent_queries` со 100 на 1000. Допустимо иметь много одновременных запросов, если они не ресурсоёмкие и в основном ожидают сетевых операций. Примечание: не путайте одновременные запросы с QPS: например, сервер ClickHouse может обрабатывать десятки тысяч QPS при менее чем 100 одновременных запросах. [#53285](https://github.com/ClickHouse/ClickHouse/pull/53285) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Ограничено количество одновременно выполняющихся фоновых слияний при оптимизации партиций. [#53405](https://github.com/ClickHouse/ClickHouse/pull/53405) ([Duc Canh Le](https://github.com/canhld94)).
* Добавлена настройка `allow_moving_table_directory_to_trash`, которая позволяет игнорировать ошибку `Directory for table data already exists` при репликации или восстановлении базы данных `Replicated`. [#53425](https://github.com/ClickHouse/ClickHouse/pull/53425) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Если серверные настройки `asynchronous_metrics_update_period_s` и `asynchronous_heavy_metrics_update_period_s` ошибочно установлены в 0, теперь это приведёт к корректному завершению с ошибкой вместо аварийного завершения приложения. [#53428](https://github.com/ClickHouse/ClickHouse/pull/53428) ([Robert Schulze](https://github.com/rschu1ze)).
* Сервер ClickHouse теперь при перечитывании конфигурации учитывает изменения лимитов памяти, заданных через cgroups. [#53455](https://github.com/ClickHouse/ClickHouse/pull/53455) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена возможность отключить сброс distributed таблиц при выполнении команд `DETACH`, `DROP` или при остановке сервера. [#53501](https://github.com/ClickHouse/ClickHouse/pull/53501) ([Azat Khuzhin](https://github.com/azat)).
* Функция `domainRFC` теперь поддерживает IPv6 в квадратных скобках. [#53506](https://github.com/ClickHouse/ClickHouse/pull/53506) ([Chen768959](https://github.com/Chen768959)).
* Увеличен таймаут для запросов S3 CopyObject, используемых при создании резервных копий. [#53533](https://github.com/ClickHouse/ClickHouse/pull/53533) ([Michael Kolupaev](https://github.com/al13n321)).
* Добавлена серверная настройка `aggregate_function_group_array_max_element_size`. Она используется для ограничения размера массива для функции `groupArray` при сериализации. Значение по умолчанию — `16777215`. [#53550](https://github.com/ClickHouse/ClickHouse/pull/53550) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `SCHEMA` был добавлен в качестве псевдонима для `DATABASE` для повышения совместимости с MySQL. [#53587](https://github.com/ClickHouse/ClickHouse/pull/53587) ([Daniël van Eeden](https://github.com/dveeden)).
* Добавлены асинхронные метрики по таблицам в системной базе данных. Например, `TotalBytesOfMergeTreeTablesSystem`. Это закрывает [#53603](https://github.com/ClickHouse/ClickHouse/issues/53603). [#53604](https://github.com/ClickHouse/ClickHouse/pull/53604) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* SQL-редактор в интерфейсах Play и Dashboard больше не использует Grammarly. [#53614](https://github.com/ClickHouse/ClickHouse/pull/53614) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* На уровне экспертных настроек теперь можно (1) задавать `size_ratio` (т. е. относительный размер защищённой очереди) кэшей меток [index] и кэшей несжатых данных, (2) настраивать политику кэширования кэшей меток индекса и кэшей несжатых данных. [#53657](https://github.com/ClickHouse/ClickHouse/pull/53657) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена проверка информации о клиенте в пакет запроса TCPHandler. [#53673](https://github.com/ClickHouse/ClickHouse/pull/53673) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
* Повторная загрузка частей при сетевых ошибках во время взаимодействия с Microsoft Azure. [#53750](https://github.com/ClickHouse/ClickHouse/pull/53750) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Стек трассировки для исключений, исключения из материализованных представлений пробрасываются. [#53766](https://github.com/ClickHouse/ClickHouse/pull/53766) ([Ilya Golshtein](https://github.com/ilejn)).
* Если имя хоста и порт не указаны, клиент Keeper попытается найти строку подключения в файле config.xml ClickHouse. [#53769](https://github.com/ClickHouse/ClickHouse/pull/53769) ([pufit](https://github.com/pufit)).
* Добавлено профильное событие `PartsLockMicroseconds`, которое показывает количество микросекунд, в течение которых удерживается блокировка частей данных в семействе движков таблиц MergeTree. [#53797](https://github.com/ClickHouse/ClickHouse/pull/53797) ([alesapin](https://github.com/alesapin)).
* Сделано настраиваемым ограничение числа попыток переподключения в RAFT для Keeper. Этот параметр позволяет Keeper быстрее восстанавливать соединение с другими узлами, если текущее соединение разорвано. [#53817](https://github.com/ClickHouse/ClickHouse/pull/53817) ([Pengyuan Bian](https://github.com/bianpengyuan)).
* Теперь внешние ключи в определениях таблиц игнорируются для улучшения совместимости с MySQL, чтобы пользователям не приходилось переписывать свои SQL‑запросы, содержащие определения внешних ключей, см. [#53380](https://github.com/ClickHouse/ClickHouse/issues/53380). [#53864](https://github.com/ClickHouse/ClickHouse/pull/53864) ([jsc0218](https://github.com/jsc0218)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-4}

* Не экспортировать символы из бинарника ClickHouse динамическому компоновщику. Это может исправить [#43933](https://github.com/ClickHouse/ClickHouse/issues/43933). [#47475](https://github.com/ClickHouse/ClickHouse/pull/47475) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* В пакет clickhouse-server добавлена символическая ссылка `clickhouse-keeper-client`. [#51882](https://github.com/ClickHouse/ClickHouse/pull/51882) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Добавлен [https://github.com/elliotchance/sqltest](https://github.com/elliotchance/sqltest) в CI для отчётности о соответствии стандарту SQL:2016. [#52293](https://github.com/ClickHouse/ClickHouse/pull/52293) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Обновлён PRQL до 0.9.3. [#53060](https://github.com/ClickHouse/ClickHouse/pull/53060) ([Maximilian Roos](https://github.com/max-sixty)).
* Системные таблицы из проверок CI экспортируются в ClickHouse Cloud. [#53086](https://github.com/ClickHouse/ClickHouse/pull/53086) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Профильные данные компилятора (`-ftime-trace`) отправляются в ClickHouse Cloud. [#53100](https://github.com/ClickHouse/ClickHouse/pull/53100) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Ускорены сборки Debug и Tidy. [#53178](https://github.com/ClickHouse/ClickHouse/pull/53178) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Ускорена сборка благодаря удалению огромного количества мусора. Один из часто подключаемых заголовочных файлов был «отравлен» Boost. [#53180](https://github.com/ClickHouse/ClickHouse/pull/53180) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Удалено ещё больше ненужного кода. [#53182](https://github.com/ClickHouse/ClickHouse/pull/53182) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Функция `arrayAUC` использовала тяжёлые шаблоны C++, от которых отказались. [#53183](https://github.com/ClickHouse/ClickHouse/pull/53183) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Некоторые единицы трансляции всегда пересобирались, независимо от ccache. Причина была найдена и устранена. [#53184](https://github.com/ClickHouse/ClickHouse/pull/53184) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Данные профиля компилятора (`-ftime-trace`) загружаются в ClickHouse Cloud. Вторая попытка после [#53100](https://github.com/ClickHouse/ClickHouse/issues/53100). [#53213](https://github.com/ClickHouse/ClickHouse/pull/53213) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Экспорт логов из CI в stateful-тестах в ClickHouse Cloud. [#53351](https://github.com/ClickHouse/ClickHouse/pull/53351) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Экспорт логов из CI в стресс‑тестах. [#53353](https://github.com/ClickHouse/ClickHouse/pull/53353) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Экспорт логов из CI в fuzzer. [#53354](https://github.com/ClickHouse/ClickHouse/pull/53354) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сохраняются параметры окружения в команде `clickhouse start`. Исправлена [#51962](https://github.com/ClickHouse/ClickHouse/issues/51962). [#53418](https://github.com/ClickHouse/ClickHouse/pull/53418) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Продолжение к [#53418](https://github.com/ClickHouse/ClickHouse/issues/53418). Небольшие улучшения в install&#95;check.py, добавлены тесты для корректной передачи параметров окружения (ENV) в основной процесс при `init.d start`. [#53457](https://github.com/ClickHouse/ClickHouse/pull/53457) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Перестроено управление файлами в CMake, чтобы избежать возможного дублирования. Например, `indexHint.cpp` дублировался и в `dbms_sources`, и в `clickhouse_functions_sources`. [#53621](https://github.com/ClickHouse/ClickHouse/pull/53621) ([Amos Bird](https://github.com/amosbird)).
* Обновлена библиотека Snappy до версии 1.1.10. [#53672](https://github.com/ClickHouse/ClickHouse/pull/53672) ([李扬](https://github.com/taiyang-li)).
* Незначительно улучшена сборка CMake за счёт приведения в порядок некоторых зависимостей и удаления дубликатов. Каждый коммит включает краткое описание внесённых изменений. [#53759](https://github.com/ClickHouse/ClickHouse/pull/53759) ([Amos Bird](https://github.com/amosbird)).

#### Исправление ошибки (некорректное поведение, видимое пользователю, в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-4}

* Не сбрасывать (экспериментальный) индекс Annoy при построении, если имеется более одной метки [#51325](https://github.com/ClickHouse/ClickHouse/pull/51325) ([Tian Xinhui](https://github.com/xinhuitian)).
* Исправлено использование временных каталогов при операции RESTORE [#51493](https://github.com/ClickHouse/ClickHouse/pull/51493) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа бинарной арифметики для Nullable(IPv4) [#51642](https://github.com/ClickHouse/ClickHouse/pull/51642) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Добавлена поддержка типов данных IPv4 и IPv6 в качестве атрибутов словаря [#51756](https://github.com/ClickHouse/ClickHouse/pull/51756) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлено вычисление контрольной суммы маркеров сжатия [#51777](https://github.com/ClickHouse/ClickHouse/pull/51777) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлена ошибка, из-за которой запятая при разборе CSV в режиме best effort ошибочно интерпретировалась как часть значения datetime [#51950](https://github.com/ClickHouse/ClickHouse/pull/51950) ([Kruglov Pavel](https://github.com/Avogar)).
* Не выбрасывать исключение, если исполняемая UDF имеет параметры [#51961](https://github.com/ClickHouse/ClickHouse/pull/51961) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена ошибка пересчёта skip-индексов и проекций в запросах `ALTER DELETE` [#52530](https://github.com/ClickHouse/ClickHouse/pull/52530) ([Anton Popov](https://github.com/CurtizJ)).
* MaterializedMySQL: Исправлен бесконечный цикл в ReadBuffer::read [#52621](https://github.com/ClickHouse/ClickHouse/pull/52621) ([Val Doroshchuk](https://github.com/valbok)).
* Загружать подсказки только для диалекта `clickhouse` [#52628](https://github.com/ClickHouse/ClickHouse/pull/52628) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Создавать и уничтожать канал ares по мере необходимости. [#52634](https://github.com/ClickHouse/ClickHouse/pull/52634) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлена фильтрация по виртуальным столбцам при использовании выражения OR [#52653](https://github.com/ClickHouse/ClickHouse/pull/52653) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен сбой функции `tuple` при использовании одного разреженного столбца в качестве аргумента [#52659](https://github.com/ClickHouse/ClickHouse/pull/52659) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена работа именованных коллекций в кластере [#52687](https://github.com/ClickHouse/ClickHouse/pull/52687) ([Al Korgun](https://github.com/alkorgun)).
* Исправлено избыточное чтение лишнего столбца при многостадийном `PREWHERE` [#52689](https://github.com/ClickHouse/ClickHouse/pull/52689) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен неожиданный результат сортировки по нескольким столбцам с направлением NULLS FIRST [#52761](https://github.com/ClickHouse/ClickHouse/pull/52761) ([copperybean](https://github.com/copperybean)).
* Исправлена гонка данных при перенастройке Keeper [#52804](https://github.com/ClickHouse/ClickHouse/pull/52804) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена сортировка разреженных столбцов с большим лимитом [#52827](https://github.com/ClickHouse/ClickHouse/pull/52827) ([Anton Popov](https://github.com/CurtizJ)).
* clickhouse-keeper: исправлена реализация сервера на poll. [#52833](https://github.com/ClickHouse/ClickHouse/pull/52833) ([Andy Fiddaman](https://github.com/citrus-it)).
* Теперь анализатор регулярных выражений распознаёт именованные группы захвата [#52840](https://github.com/ClickHouse/ClickHouse/pull/52840) ([Han Fei](https://github.com/hanfei1991)).
* Исправлено возможное срабатывание assert в `~PushingAsyncPipelineExecutor` в clickhouse-local [#52862](https://github.com/ClickHouse/ClickHouse/pull/52862) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено чтение пустых значений типа `Nested(Array(LowCardinality(...)))` [#52949](https://github.com/ClickHouse/ClickHouse/pull/52949) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлены новые тесты для session&#95;log и исправлена несогласованность между операциями входа в систему и выхода из неё. [#52958](https://github.com/ClickHouse/ClickHouse/pull/52958) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
* Исправлена утечка пароля в выводе `SHOW CREATE TABLE` для таблиц MySQL [#52962](https://github.com/ClickHouse/ClickHouse/pull/52962) ([Duc Canh Le](https://github.com/canhld94)).
* Разреженный формат столбца в CreateSetAndFilterOnTheFlyStep преобразован в полный [#53000](https://github.com/ClickHouse/ClickHouse/pull/53000) ([vdimir](https://github.com/vdimir)).
* Исправлена редкая гонка состояний при удалении каталога с пустым префиксом ключа в fs cache [#53055](https://github.com/ClickHouse/ClickHouse/pull/53055) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка, из-за которой `ZstdDeflatingWriteBuffer` иногда усекал выходные данные [#53064](https://github.com/ClickHouse/ClickHouse/pull/53064) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлен query&#95;id в part&#95;log при асинхронном выполнении запросов FLUSH [#53103](https://github.com/ClickHouse/ClickHouse/pull/53103) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена возможная ошибка при работе с кешем &quot;Read unexpected size&quot; [#53121](https://github.com/ClickHouse/ClickHouse/pull/53121) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отключить новый кодировщик Parquet [#53130](https://github.com/ClickHouse/ClickHouse/pull/53130) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено исключение «Not-ready Set» [#53162](https://github.com/ClickHouse/ClickHouse/pull/53162) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено экранирование символов в движке PostgreSQL [#53250](https://github.com/ClickHouse/ClickHouse/pull/53250) ([Nikolay Degterinsky](https://github.com/evillique)).
* Экспериментальная таблица session&#95;log: добавлены новые тесты для session&#95;log и устранено несоответствие между входом в систему и выходом из системы. [#53255](https://github.com/ClickHouse/ClickHouse/pull/53255) ([Alexey Gerasimchuck](https://github.com/Demilivor)). Устранено несоответствие между успешным входом и выходом из системы [#53302](https://github.com/ClickHouse/ClickHouse/pull/53302) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
* Исправлена ошибка при добавлении субсекундных интервалов к DateTime [#53309](https://github.com/ClickHouse/ClickHouse/pull/53309) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена ошибка «Context has expired» в словарях [#53342](https://github.com/ClickHouse/ClickHouse/pull/53342) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлен некорректный формат AST для обычной проекции [#53347](https://github.com/ClickHouse/ClickHouse/pull/53347) ([Amos Bird](https://github.com/amosbird)).
* Запрещено использование настройки use&#95;structure&#95;from&#95;insertion&#95;table&#95;in&#95;table&#95;functions в табличных функциях при выполнении Scalar [#53348](https://github.com/ClickHouse/ClickHouse/pull/53348) ([flynn](https://github.com/ucasfl)).
* Исправлена загрузка лениво инициализируемой базы данных при выполнении запроса `SELECT` к `system.table` [#53372](https://github.com/ClickHouse/ClickHouse/pull/53372) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлена системная таблица `system.data_skipping_indices` для MaterializedMySQL [#53381](https://github.com/ClickHouse/ClickHouse/pull/53381) ([Filipp Ozinov](https://github.com/bakwc)).
* Исправлена обработка одиночного символа возврата каретки в движке сегментации TSV‑файлов [#53407](https://github.com/ClickHouse/ClickHouse/pull/53407) ([Kruglov Pavel](https://github.com/Avogar)).
* Корректно исправлена обработка ошибки `Context has expired` [#53433](https://github.com/ClickHouse/ClickHouse/pull/53433) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлен `timeout_overflow_mode` при наличии подзапроса в правой части выражения IN [#53439](https://github.com/ClickHouse/ClickHouse/pull/53439) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлено неожиданное поведение в [#53152](https://github.com/ClickHouse/ClickHouse/issues/53152) и [#53440](https://github.com/ClickHouse/ClickHouse/pull/53440) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
* Исправлена ошибка разбора в функции JSON&#95;QUERY, возникавшая, когда путь состоял только из цифр [#53470](https://github.com/ClickHouse/ClickHouse/pull/53470) ([KevinyhZou](https://github.com/KevinyhZou)).
* Исправлен некорректный порядок столбцов для запросов с параллельным FINAL. [#53489](https://github.com/ClickHouse/ClickHouse/pull/53489) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено выполнение SELECT из ReplacingMergeTree с do&#95;not&#95;merge&#95;across&#95;partitions&#95;select&#95;final [#53511](https://github.com/ClickHouse/ClickHouse/pull/53511) ([Vasily Nemkov](https://github.com/Enmk)).
* Сначала при завершении работы сбрасывать очередь асинхронных вставок [#53547](https://github.com/ClickHouse/ClickHouse/pull/53547) ([joelynch](https://github.com/joelynch)).
* Исправлен сбой при выполнении операции JOIN по разреженному столбцу [#53548](https://github.com/ClickHouse/ClickHouse/pull/53548) ([vdimir](https://github.com/vdimir)).
* Исправлено возможное неопределённое поведение (UB) в пропускающем индексе для Set при использовании функций с некорректными аргументами [#53559](https://github.com/ClickHouse/ClickHouse/pull/53559) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено возможное неопределённое поведение (UB) в инвертированных индексах (экспериментальная функциональность) [#53560](https://github.com/ClickHouse/ClickHouse/pull/53560) ([Azat Khuzhin](https://github.com/azat)).
* Исправление: выражение interpolate использует исходный столбец вместо одноимённого столбца-псевдонима из выражения SELECT. [#53572](https://github.com/ClickHouse/ClickHouse/pull/53572) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлено количество отброшенных гранул в EXPLAIN PLAN index=1 [#53616](https://github.com/ClickHouse/ClickHouse/pull/53616) ([wangxiaobo](https://github.com/wzb5212)).
* Корректно обрабатывать totals и extremes при работе с `DelayedSource` [#53644](https://github.com/ClickHouse/ClickHouse/pull/53644) ([Antonio Andelic](https://github.com/antonio2368)).
* Кэш prepared set в конвейере мутаций зависал [#53645](https://github.com/ClickHouse/ClickHouse/pull/53645) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка при выполнении мутаций с подстолбцами типа JSON в предикатах запросов UPDATE и DELETE. [#53677](https://github.com/ClickHouse/ClickHouse/pull/53677) ([VanDarkholme7](https://github.com/VanDarkholme7)).
* Исправлено filter pushdown для full&#95;sorting&#95;merge join [#53699](https://github.com/ClickHouse/ClickHouse/pull/53699) ([vdimir](https://github.com/vdimir)).
* Попытка исправить ошибку, связанную с `NULL::LowCardinality(Nullable(...)) NOT IN` [#53706](https://github.com/ClickHouse/ClickHouse/pull/53706) ([Andrey Zvonov](https://github.com/zvonand)).
* Исправлено: sorted distinct для разреженных столбцов [#53711](https://github.com/ClickHouse/ClickHouse/pull/53711) ([Igor Nikonov](https://github.com/devcrafter)).
* `transform`: правильная обработка столбца по умолчанию с несколькими строками [#53742](https://github.com/ClickHouse/ClickHouse/pull/53742) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Исправлен краш фаззера в parseDateTime [#53764](https://github.com/ClickHouse/ClickHouse/pull/53764) ([Robert Schulze](https://github.com/rschu1ze)).
* MaterializedPostgreSQL: устранено необработанное исключение в getCreateTableQueryImpl [#53832](https://github.com/ClickHouse/ClickHouse/pull/53832) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена возможная ошибка сегментации памяти при использовании движка PostgreSQL [#53847](https://github.com/ClickHouse/ClickHouse/pull/53847) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен алиас named&#95;collection&#95;admin [#54066](https://github.com/ClickHouse/ClickHouse/pull/54066) ([Kseniia Sumarokova](https://github.com/kssenii)).

### <a id="237"></a> Релиз ClickHouse 23.7, 2023-07-27. [Презентация](https://presentations.clickhouse.com/2023-release-23.7/), [Видео](https://www.youtube.com/watch?v=TI1kONfON18) {#237}

<iframe width="1024" height="576" src="https://www.youtube.com/embed/TI1kONfON18" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

#### Обратно несовместимые изменения {#backward-incompatible-change-5}

* Добавлен тип доступа `NAMED COLLECTION` (псевдонимы `USE NAMED COLLECTION`, `NAMED COLLECTION USAGE`). Этот PR обратно несовместим, поскольку этот тип доступа по умолчанию отключен (так как родительский тип доступа `NAMED COLLECTION ADMIN` также по умолчанию отключен). Предложено в [#50277](https://github.com/ClickHouse/ClickHouse/issues/50277). Для выдачи прав используйте `GRANT NAMED COLLECTION ON collection_name TO user` или `GRANT NAMED COLLECTION ON * TO user`; чтобы иметь возможность выдавать эти права, в конфигурации требуется `named_collection_admin` (ранее он назывался `named_collection_control`, поэтому останется как псевдоним). [#50625](https://github.com/ClickHouse/ClickHouse/pull/50625) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена опечатка в имени столбца `system.parts` `last_removal_attemp_time`. Теперь он называется `last_removal_attempt_time`. [#52104](https://github.com/ClickHouse/ClickHouse/pull/52104) ([filimonov](https://github.com/filimonov)).
* Версия distributed_ddl_entry_format_version по умолчанию увеличена до 5 (включает проброс OpenTelemetry и initial_query_idd). Это не позволит обрабатывать существующие записи для распределённого DDL после *downgrade* (но учтите, что обычно таких необработанных записей быть не должно). [#52128](https://github.com/ClickHouse/ClickHouse/pull/52128) ([Azat Khuzhin](https://github.com/azat)).
* Проверка метаданных проекций выполняется тем же способом, что и проверка обычных метаданных. Это изменение может помешать запуску сервера, если существует таблица с некорректной проекцией. Пример — проекция, которая создала позиционные столбцы в первичном ключе (например, `projection p (select * order by 1, 4)`, что не допускается в первичном ключе таблицы и может вызвать сбой при вставке/слиянии). Удалите такие проекции до обновления. Исправляет [#52353](https://github.com/ClickHouse/ClickHouse/issues/52353). [#52361](https://github.com/ClickHouse/ClickHouse/pull/52361) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Экспериментальная функция `hashid` удалена из‑за ошибки. Качество реализации изначально было сомнительным, и функция так и не вышла из экспериментального статуса. Это закрывает [#52406](https://github.com/ClickHouse/ClickHouse/issues/52406). [#52449](https://github.com/ClickHouse/ClickHouse/pull/52449) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### Новая функция {#new-feature-5}

* Добавлен движок базы данных `Overlay` для объединения нескольких баз данных в одну. Добавлен движок базы данных `Filesystem` для представления каталога в файловой системе в виде набора неявно доступных таблиц с автоматически определяемыми форматами и структурами. Новый движок базы данных `S3` предоставляет доступ к хранилищу S3 только для чтения, представляя префикс в виде набора таблиц. Новый движок базы данных `HDFS` позволяет взаимодействовать с хранилищем HDFS аналогичным образом. [#48821](https://github.com/ClickHouse/ClickHouse/pull/48821) ([alekseygolub](https://github.com/alekseygolub)).
* Добавлена поддержка использования внешних дисков в Keeper для хранения снапшотов и логов. [#50098](https://github.com/ClickHouse/ClickHouse/pull/50098) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена поддержка glob-шаблонов с выбором нескольких каталогов (`{}`). [#50559](https://github.com/ClickHouse/ClickHouse/pull/50559) ([Andrey Zvonov](https://github.com/zvonand)).
* Коннектор Kafka теперь может получать схему Avro из реестра схем с базовой аутентификацией, используя URL-кодированные учетные данные. [#49664](https://github.com/ClickHouse/ClickHouse/pull/49664) ([Ilya Golshtein](https://github.com/ilejn)).
* Добавлена функция `arrayJaccardIndex`, которая вычисляет коэффициент Жаккара между двумя массивами. [#50076](https://github.com/ClickHouse/ClickHouse/pull/50076) ([FFFFFFFHHHHHHH](https://github.com/FFFFFFFHHHHHHH)).
* Добавлен столбец `is_obsolete` в `system.settings` и другие аналогичные таблицы. Закрывает [#50819](https://github.com/ClickHouse/ClickHouse/issues/50819). [#50826](https://github.com/ClickHouse/ClickHouse/pull/50826) ([flynn](https://github.com/ucasfl)).
* Реализована поддержка зашифрованных элементов в файле конфигурации. Добавлена возможность использовать зашифрованный текст в листовых элементах файла конфигурации. Текст шифруется с помощью кодеков шифрования из раздела `<encryption_codecs>`. [#50986](https://github.com/ClickHouse/ClickHouse/pull/50986) ([Roman Vasin](https://github.com/rvasin)).
* Алгоритм Grace Hash Join теперь может применяться к операциям FULL и RIGHT JOIN. [#49483](https://github.com/ClickHouse/ClickHouse/issues/49483). [#51013](https://github.com/ClickHouse/ClickHouse/pull/51013) ([lgbo](https://github.com/lgbo-ustc)).
* Добавлен запрос `SYSTEM STOP LISTEN` для более плавного завершения работы. Закрывает [#47972](https://github.com/ClickHouse/ClickHouse/issues/47972). [#51016](https://github.com/ClickHouse/ClickHouse/pull/51016) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлен параметр `input_format_csv_allow_variable_number_of_columns`. [#51273](https://github.com/ClickHouse/ClickHouse/pull/51273) ([Dmitry Kardymon](https://github.com/kardymonds)).
* Еще одна скучная новинка: добавлена функция `substring_index`, как в Spark или MySQL. [#51472](https://github.com/ClickHouse/ClickHouse/pull/51472) ([李扬](https://github.com/taiyang-li)).
* Системная таблица `jemalloc_bins` для отображения статистики по бинам jemalloc. Пример: `SELECT *, size * (nmalloc - ndalloc) AS allocated_bytes FROM system.jemalloc_bins WHERE allocated_bytes > 0 ORDER BY allocated_bytes DESC LIMIT 10`. Приятной работы. [#51674](https://github.com/ClickHouse/ClickHouse/pull/51674) ([Alexander Gololobov](https://github.com/davenger)).
* Добавлен формат `RowBinaryWithDefaults` с дополнительным байтом перед каждым столбцом в качестве флага использования значения столбца по умолчанию. Закрывает [#50854](https://github.com/ClickHouse/ClickHouse/issues/50854). [#51695](https://github.com/ClickHouse/ClickHouse/pull/51695) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена настройка `default_temporary_table_engine`. Аналогична `default_table_engine`, но для временных таблиц. [#51292](https://github.com/ClickHouse/ClickHouse/issues/51292). [#51708](https://github.com/ClickHouse/ClickHouse/pull/51708) ([velavokr](https://github.com/velavokr)).
* Добавлены новые функции `initcap` / `initcapUTF8`, которые преобразуют первую букву каждого слова в верхний регистр, а остальные — в нижний. [#51735](https://github.com/ClickHouse/ClickHouse/pull/51735) ([Dmitry Kardymon](https://github.com/kardymonds)).
* CREATE TABLE теперь поддерживает использование синтаксиса `PRIMARY KEY` при определении столбцов. Столбцы добавляются в первичный индекс в том же порядке, в котором они определены. [#51881](https://github.com/ClickHouse/ClickHouse/pull/51881) ([Ilya Yatsishin](https://github.com/qoega)).
* Добавлена возможность использовать спецификаторы формата даты и времени в именах файлов журнала и журнала ошибок, как в конфигурационных файлах (теги `log` и `errorlog`), так и в параметрах командной строки (`--log-file` и `--errorlog-file`). [#51945](https://github.com/ClickHouse/ClickHouse/pull/51945) ([Victor Krasnov](https://github.com/sirvickr)).
* В HTTP-заголовки добавлена статистика пикового использования памяти. [#51946](https://github.com/ClickHouse/ClickHouse/pull/51946) ([Dmitry Kardymon](https://github.com/kardymonds)).
* Добавлены новые функции `hasSubsequence` (а также их варианты `CaseInsensitive` и `UTF8`) для поиска подпоследовательностей в строках. [#52050](https://github.com/ClickHouse/ClickHouse/pull/52050) ([Dmitry Kardymon](https://github.com/kardymonds)).
* Добавлен `array_agg` в качестве псевдонима `groupArray` для совместимости с PostgreSQL. Закрывает [#52100](https://github.com/ClickHouse/ClickHouse/issues/52100). ### Запись в документации об изменениях, затрагивающих пользователей. [#52135](https://github.com/ClickHouse/ClickHouse/pull/52135) ([flynn](https://github.com/ucasfl)).
* Добавлен псевдоним совместимости `any_value` для агрегатной функции `any`. Закрывает [#52140](https://github.com/ClickHouse/ClickHouse/issues/52140). [#52147](https://github.com/ClickHouse/ClickHouse/pull/52147) ([flynn](https://github.com/ucasfl)).
* Добавлена агрегатная функция `array_concat_agg` для совместимости с BigQuery; она является псевдонимом функции `groupArrayArray`. Закрывает [#52139](https://github.com/ClickHouse/ClickHouse/issues/52139). [#52149](https://github.com/ClickHouse/ClickHouse/pull/52149) ([flynn](https://github.com/ucasfl)).
* Добавлен `OCTET_LENGTH` в качестве псевдонима для `length`. Закрывает [#52153](https://github.com/ClickHouse/ClickHouse/issues/52153). [#52176](https://github.com/ClickHouse/ClickHouse/pull/52176) ([FFFFFFFHHHHHHH](https://github.com/FFFFFFFHHHHHHH)).
* Добавлена функция `firstLine` для извлечения первой строки из многострочной строки. Тем самым закрывается задача [#51172](https://github.com/ClickHouse/ClickHouse/issues/51172). [#52209](https://github.com/ClickHouse/ClickHouse/pull/52209) ([Mikhail Koviazin](https://github.com/mkmkme)).
* Реализовано форматирование в стиле KQL для типа данных `Interval`. Это требуется только для совместимости с языком запросов `Kusto`. [#45671](https://github.com/ClickHouse/ClickHouse/pull/45671) ([ltrk2](https://github.com/ltrk2)).
* Добавлен запрос `SYSTEM FLUSH ASYNC INSERT QUEUE`, который выполняет все ожидающие асинхронные вставки в целевые таблицы. Добавлена серверная настройка `async_insert_queue_flush_on_shutdown` (`true` по умолчанию), которая определяет, следует ли при корректном завершении работы выполнять сброс очереди асинхронных вставок. Настройка `async_insert_threads` теперь является серверной настройкой. [#49160](https://github.com/ClickHouse/ClickHouse/pull/49160) ([Anton Popov](https://github.com/CurtizJ)).
* Псевдонимы `current_database` и новая функция `current_schemas` для совместимости с PostgreSQL. [#51076](https://github.com/ClickHouse/ClickHouse/pull/51076) ([Pedro Riera](https://github.com/priera)).
* Добавлены псевдонимы для функций `today` (теперь также доступна под именами `curdate`/`current_date`) и `now` (`current_timestamp`). [#52106](https://github.com/ClickHouse/ClickHouse/pull/52106) ([Lloyd-Pottiger](https://github.com/Lloyd-Pottiger)).
* Добавлена поддержка `async_deduplication_token` для асинхронной вставки. [#52136](https://github.com/ClickHouse/ClickHouse/pull/52136) ([Han Fei](https://github.com/hanfei1991)).
* Добавлена новая настройка `disable_url_encoding`, которая позволяет отключить кодирование и декодирование пути в URI в движке URL. [#52337](https://github.com/ClickHouse/ClickHouse/pull/52337) ([Kruglov Pavel](https://github.com/Avogar)).

#### Повышение производительности {#performance-improvement-5}

* Включён автоматический выбор разреженного формата сериализации по умолчанию. Это улучшает производительность. Формат поддерживается начиная с версии 22.1. После этого изменения понижение версии до версий ранее 22.1 может быть невозможно. Понижение версии может потребовать установки параметра `ratio_of_defaults_for_sparse_serialization=0.9375` [55153](https://github.com/ClickHouse/ClickHouse/issues/55153). Вы можете отключить использование разреженного формата сериализации, указав параметр `ratio_of_defaults_for_sparse_serialization = 1` для ваших таблиц MergeTree. [#49631](https://github.com/ClickHouse/ClickHouse/pull/49631) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* По умолчанию включены настройки `move_all_conditions_to_prewhere` и `enable_multiple_prewhere_read_steps`. [#46365](https://github.com/ClickHouse/ClickHouse/pull/46365) ([Alexander Gololobov](https://github.com/davenger)).
* Улучшена производительность некоторых запросов за счет настройки аллокатора. [#46416](https://github.com/ClickHouse/ClickHouse/pull/46416) ([Azat Khuzhin](https://github.com/azat)).
* Теперь в `MergeTreePrefetchedReadPool`, как и в `MergeTreeReadPool`, используются задачи фиксированного размера. Кроме того, теперь для запросов к S3 используется пул подключений. [#49732](https://github.com/ClickHouse/ClickHouse/pull/49732) ([Nikita Taranov](https://github.com/nickitat)).
* Более агрессивное проталкивание вычислений на правую сторону `JOIN`. [#50532](https://github.com/ClickHouse/ClickHouse/pull/50532) ([Nikita Taranov](https://github.com/nickitat)).
* Улучшена операция grace&#95;hash join за счёт предварительного резервирования памяти под хеш-таблицу (повторная отправка). [#50875](https://github.com/ClickHouse/ClickHouse/pull/50875) ([lgbo](https://github.com/lgbo-ustc)).
* Ожидание блокировки в `OpenedFileCache` иногда могло заметно сказываться на производительности. Мы разделили его на несколько подотображений (каждое со своей собственной блокировкой), чтобы избежать конкуренции за блокировки. [#51341](https://github.com/ClickHouse/ClickHouse/pull/51341) ([Nikita Taranov](https://github.com/nickitat)).
* Переместить условия со столбцами первичного ключа в конец цепочки PREWHERE. Идея состоит в том, что такие условия, скорее всего, будут использоваться при анализе PK и почти не повлияют на дополнительную фильтрацию в PREWHERE. [#51958](https://github.com/ClickHouse/ClickHouse/pull/51958) ([Alexander Gololobov](https://github.com/davenger)).
* Ускорена операция `COUNT(DISTINCT)` для строкового типа String за счёт встраивания (inlining) SipHash. Результаты экспериментов производительности набора *OnTime* на устройстве ICX (процессор Intel Xeon Platinum 8380, 80 ядер, 160 потоков) показывают, что это изменение может повысить QPS запроса *Q8* на *11,6%* без влияния на другие запросы. [#52036](https://github.com/ClickHouse/ClickHouse/pull/52036) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
* По умолчанию теперь включена настройка `allow_vertical_merges_from_compact_to_wide_parts`. Это позволяет сократить использование памяти во время слияний. [#52295](https://github.com/ClickHouse/ClickHouse/pull/52295) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлен некорректный анализ PROJECTION, который делал первичные ключи недействительными. Эта проблема возникает только при `query_plan_optimize_primary_key = 1, query_plan_optimize_projection = 1`. Исправляет [#48823](https://github.com/ClickHouse/ClickHouse/issues/48823). Исправляет [#51173](https://github.com/ClickHouse/ClickHouse/issues/51173). [#52308](https://github.com/ClickHouse/ClickHouse/pull/52308) ([Amos Bird](https://github.com/amosbird)).
* Уменьшено количество системных вызовов в `FileCache::loadMetadata`, что ускоряет запуск сервера, если настроен кэш файловой системы. [#52435](https://github.com/ClickHouse/ClickHouse/pull/52435) ([Raúl Marín](https://github.com/Algunenano)).
* Позволяет задать жёсткую нижнюю границу для размера сегмента файла за счёт скачивания оставшихся данных в фоновом режиме. Минимальный размер сегмента файла (если фактический размер файла больше) настраивается параметром конфигурации кэша `boundary_alignment`, по умолчанию `4Mi`. Количество фоновых потоков настраивается параметром конфигурации кэша `background_download_threads`, по умолчанию `2`. Также `max_file_segment_size` был увеличен с `8Mi` до `32Mi` в этом PR. [#51000](https://github.com/ClickHouse/ClickHouse/pull/51000) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Уменьшены значения таймаутов по умолчанию для S3 с 30 секунд до 3 секунд, а для других HTTP-запросов ‒ со 180 секунд до 30 секунд. [#51171](https://github.com/ClickHouse/ClickHouse/pull/51171) ([Michael Kolupaev](https://github.com/al13n321)).
* Добавлена новая настройка `merge_tree_determine_task_size_by_prewhere_columns`. Если установлена в значение `true`, при определении размера задачи чтения будут учитываться только размеры столбцов, указанных в секции `PREWHERE`. В противном случае учитываются размеры всех столбцов из запроса. [#52606](https://github.com/ClickHouse/ClickHouse/pull/52606) ([Nikita Taranov](https://github.com/nickitat)).

#### Улучшения {#improvement-5}

* Используйте read&#95;bytes/total&#95;bytes&#95;to&#95;read для индикатора прогресса в табличных функциях S3/file/url/... для более точного отображения хода выполнения. [#51286](https://github.com/ClickHouse/ClickHouse/pull/51286) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена табличная настройка `wait_for_unique_parts_send_before_shutdown_ms`, которая задаёт время ожидания, в течение которого реплика будет ждать перед закрытием межсерверного обработчика, отвечающего за реплицируемые отправки. Также устранена несогласованность при завершении работы таблиц и межсерверных обработчиков: теперь сервер сначала отключает таблицы и только после этого завершает работу межсерверных обработчиков. [#51851](https://github.com/ClickHouse/ClickHouse/pull/51851) ([alesapin](https://github.com/alesapin)).
* Разрешено использование стандартного для SQL `FETCH` без `OFFSET`. См. [https://antonz.org/sql-fetch/](https://antonz.org/sql-fetch/). [#51293](https://github.com/ClickHouse/ClickHouse/pull/51293) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность фильтровать HTTP‑заголовки для табличных функций URL/S3 с помощью нового раздела конфигурации `http_forbid_headers`. Поддерживаются как точное совпадение, так и фильтры на основе регулярных выражений. [#51038](https://github.com/ClickHouse/ClickHouse/pull/51038) ([Nikolay Degterinsky](https://github.com/evillique)).
* Сообщения о `16 EiB` свободного места больше не выводятся в логах, так как они бессмысленны. Закрывает [#49320](https://github.com/ClickHouse/ClickHouse/issues/49320). [#49342](https://github.com/ClickHouse/ClickHouse/pull/49342) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Теперь лимит для функции `sleepEachRow` корректно проверяется. Добавлена настройка `function_sleep_max_microseconds_per_block`. Она нужна для универсального фаззера запросов. [#49343](https://github.com/ClickHouse/ClickHouse/pull/49343) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлены две ошибки в функциях `geoHash`. [#50066](https://github.com/ClickHouse/ClickHouse/pull/50066) ([李扬](https://github.com/taiyang-li)).
* Записывать в журнал запросы сброса асинхронных вставок в `system.query_log`. [#51160](https://github.com/ClickHouse/ClickHouse/pull/51160) ([Raúl Marín](https://github.com/Algunenano)).
* Функции `date_diff` и `age` теперь поддерживают единицы измерения миллисекунд и микросекунд и работают с точностью до микросекунд. [#51291](https://github.com/ClickHouse/ClickHouse/pull/51291) ([Dmitry Kardymon](https://github.com/kardymonds)).
* Улучшен разбор пути в clickhouse-keeper-client. [#51359](https://github.com/ClickHouse/ClickHouse/pull/51359) ([Azat Khuzhin](https://github.com/azat)).
* Сторонний продукт, зависящий от ClickHouse (Gluten: плагин, вдвое ускоряющий выполнение Spark SQL), содержал ошибку. Это исправление предотвращает переполнение кучи в этом стороннем продукте при чтении из HDFS. [#51386](https://github.com/ClickHouse/ClickHouse/pull/51386) ([李扬](https://github.com/taiyang-li)).
* Добавлена возможность отключать нативное копирование для S3 (настройка для BACKUP/RESTORE `allow_s3_native_copy` и `s3_allow_native_copy` для дисков `s3`/`s3_plain`). [#51448](https://github.com/ClickHouse/ClickHouse/pull/51448) ([Azat Khuzhin](https://github.com/azat)).
* Добавлен столбец `primary_key_size` в таблицу `system.parts` для отображения сжатого размера первичного ключа на диске. Закрывает [#51400](https://github.com/ClickHouse/ClickHouse/issues/51400). [#51496](https://github.com/ClickHouse/ClickHouse/pull/51496) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Разрешён запуск `clickhouse-local` без procfs, при отсутствии домашнего каталога и без плагинов разрешения имён из glibc. [#51518](https://github.com/ClickHouse/ClickHouse/pull/51518) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен плейсхолдер `%a`, представляющий полное имя файла, в настройку rename&#95;files&#95;after&#95;processing. [#51603](https://github.com/ClickHouse/ClickHouse/pull/51603) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен столбец `modification_time` в таблицу `system.parts_columns`. [#51685](https://github.com/ClickHouse/ClickHouse/pull/51685) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена новая настройка `input_format_csv_use_default_on_bad_values` для формата CSV, которая позволяет вставлять значение по умолчанию при ошибке парсинга отдельного поля. [#51716](https://github.com/ClickHouse/ClickHouse/pull/51716) ([KevinyhZou](https://github.com/KevinyhZou)).
* Добавлен сброс журнала сбоев на диск после непредвиденного сбоя. [#51720](https://github.com/ClickHouse/ClickHouse/pull/51720) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
* Исправлено поведение страницы дашборда, из-за которого ошибки, не связанные с аутентификацией, не отображались. Также исправлено поведение диаграммы с «перекрытием». [#51744](https://github.com/ClickHouse/ClickHouse/pull/51744) ([Zach Naimon](https://github.com/ArctypeZach)).
* Добавлена возможность конвертации UUID в UInt128. [#51765](https://github.com/ClickHouse/ClickHouse/pull/51765) ([Dmitry Kardymon](https://github.com/kardymonds)).
* Добавлена поддержка функции `range` для аргументов типа Nullable. [#51767](https://github.com/ClickHouse/ClickHouse/pull/51767) ([Dmitry Kardymon](https://github.com/kardymonds)).
* Условия вида `toyear(x) = c` преобразуются в `c1 <= x < c2`. [#51795](https://github.com/ClickHouse/ClickHouse/pull/51795) ([Han Fei](https://github.com/hanfei1991)).
* Улучшена совместимость оператора `SHOW INDEX` с MySQL. [#51796](https://github.com/ClickHouse/ClickHouse/pull/51796) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена проблема, из-за которой `use_structure_from_insertion_table_in_table_functions` не работала со столбцами `MATERIALIZED` и `ALIAS`. Закрывает [#51817](https://github.com/ClickHouse/ClickHouse/issues/51817). Закрывает [#51019](https://github.com/ClickHouse/ClickHouse/issues/51019). [#51825](https://github.com/ClickHouse/ClickHouse/pull/51825) ([flynn](https://github.com/ucasfl)).
* Кэшируемый словарь теперь запрашивает у источника только уникальные ключи. Закрывает [#51762](https://github.com/ClickHouse/ClickHouse/issues/51762). [#51853](https://github.com/ClickHouse/ClickHouse/pull/51853) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена проблема, из-за которой настройки не применялись для запроса EXPLAIN при указании FORMAT. [#51859](https://github.com/ClickHouse/ClickHouse/pull/51859) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлена возможность указывать SETTINGS перед FORMAT в запросе DESCRIBE TABLE для совместимости с запросами SELECT. Закрывает [#51544](https://github.com/ClickHouse/ClickHouse/issues/51544). [#51899](https://github.com/ClickHouse/ClickHouse/pull/51899) ([Nikolay Degterinsky](https://github.com/evillique)).
* Целые числа в кодировке Var-Int (например, используемые нативным протоколом) теперь могут использовать полный 64-битный диапазон. Сторонним клиентам рекомендуется обновить свою реализацию Var-Int соответствующим образом. [#51905](https://github.com/ClickHouse/ClickHouse/pull/51905) ([Robert Schulze](https://github.com/rschu1ze)).
* Сертификаты обновляются при их изменении, без необходимости вручную выполнять SYSTEM RELOAD CONFIG. [#52030](https://github.com/ClickHouse/ClickHouse/pull/52030) ([Mike Kot](https://github.com/myrrc)).
* Добавлена настройка `allow_create_index_without_type`, которая позволяет игнорировать запросы `ADD INDEX` без указанного `TYPE`. Стандартные SQL-запросы просто будут успешно выполняться без изменения схемы таблицы. [#52056](https://github.com/ClickHouse/ClickHouse/pull/52056) ([Ilya Yatsishin](https://github.com/qoega)).
* Сообщения лога записываются в `system.text_log` с момента запуска сервера. [#52113](https://github.com/ClickHouse/ClickHouse/pull/52113) ([Dmitry Kardymon](https://github.com/kardymonds)).
* Если HTTP-эндпоинт резолвится в несколько IP-адресов и первый из них недоступен, возникало исключение по таймауту. Реализовано создание сессии с обработкой всех разрешённых адресов. [#52116](https://github.com/ClickHouse/ClickHouse/pull/52116) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Входной формат Avro теперь поддерживает Union, даже если он содержит только один тип. Закрыта задача [#52131](https://github.com/ClickHouse/ClickHouse/issues/52131). [#52137](https://github.com/ClickHouse/ClickHouse/pull/52137) ([flynn](https://github.com/ucasfl)).
* Добавлена настройка `optimize_use_implicit_projections` для отключения неявных проекций (на данный момент — только проекции `min_max_count`). [#52152](https://github.com/ClickHouse/ClickHouse/pull/52152) ([Amos Bird](https://github.com/amosbird)).
* Раньше можно было использовать функцию `hasToken` для организации бесконечного цикла. Теперь такой сценарий недоступен. Это закрывает [#52156](https://github.com/ClickHouse/ClickHouse/issues/52156). [#52160](https://github.com/ClickHouse/ClickHouse/pull/52160) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Оптимистично создавать родительские узлы ZK. [#52195](https://github.com/ClickHouse/ClickHouse/pull/52195) ([Raúl Marín](https://github.com/Algunenano)).
* Исправление [#50582](https://github.com/ClickHouse/ClickHouse/issues/50582). Позволяет избежать ошибки `Not found column ... in block` в некоторых случаях упорядоченного чтения и при работе с константами. [#52259](https://github.com/ClickHouse/ClickHouse/pull/52259) ([Chen768959](https://github.com/Chen768959)).
* Проверять геопримитивы S2 на некорректность как можно раньше на стороне ClickHouse. Это закрывает задачу: [#27090](https://github.com/ClickHouse/ClickHouse/issues/27090). [#52260](https://github.com/ClickHouse/ClickHouse/pull/52260) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлена обратно отсутствовавшая проекция QueryAccessInfo при `query_plan_optimize_projection = 1`. Исправляет [#50183](https://github.com/ClickHouse/ClickHouse/issues/50183). Исправляет [#50093](https://github.com/ClickHouse/ClickHouse/issues/50093). [#52327](https://github.com/ClickHouse/ClickHouse/pull/52327) ([Amos Bird](https://github.com/amosbird)).
* Когда `ZooKeeperRetriesControl` повторно пробрасывает исключение, полезнее видеть его исходный стек вызовов, а не тот, который относится к самому `ZooKeeperRetriesControl`. [#52347](https://github.com/ClickHouse/ClickHouse/pull/52347) ([Vitaly Baranov](https://github.com/vitlibar)).
* Ожидать блокировку репликации с нулевым копированием данных, даже если некоторые диски её не поддерживают. [#52376](https://github.com/ClickHouse/ClickHouse/pull/52376) ([Raúl Marín](https://github.com/Algunenano)).
* Теперь межсерверный порт будет закрываться только после остановки таблиц. [#52498](https://github.com/ClickHouse/ClickHouse/pull/52498) ([alesapin](https://github.com/alesapin)).

#### Экспериментальная возможность {#experimental-feature-2}

* Запись файлов parquet стала в 10 раз быстрее, теперь она многопоточная. Скорость почти такая же, как при чтении. [#49367](https://github.com/ClickHouse/ClickHouse/pull/49367) ([Michael Kolupaev](https://github.com/al13n321)). Это контролируется настройкой `output_format_parquet_use_custom_encoder`, которая по умолчанию отключена, так как функциональность пока не идеальна.
* Добавлена поддержка [PRQL](https://prql-lang.org/) в качестве языка запросов. [#50686](https://github.com/ClickHouse/ClickHouse/pull/50686) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Теперь можно задавать имя для настраиваемых дисков. Ранее настраиваемые диски использовали внутреннее автоматически сгенерированное имя. Теперь это можно сделать с помощью `disk = disk_<name>(...)` (например, диск будет иметь имя `name`). [#51552](https://github.com/ClickHouse/ClickHouse/pull/51552) ([Kseniia Sumarokova](https://github.com/kssenii)). В этом релизе этот синтаксис может измениться.
* (experimental MaterializedMySQL) Исправлен сбой при использовании `mysqlxx::Pool::Entry` после отключения соединения. [#52063](https://github.com/ClickHouse/ClickHouse/pull/52063) ([Val Doroshchuk](https://github.com/valbok)).
* (experimental MaterializedMySQL) `CREATE TABLE ... AS SELECT` .. теперь поддерживается в MaterializedMySQL. [#52067](https://github.com/ClickHouse/ClickHouse/pull/52067) ([Val Doroshchuk](https://github.com/valbok)).
* (experimental MaterializedMySQL) Введено автоматическое преобразование текстовых типов в utf8 для MaterializedMySQL. [#52084](https://github.com/ClickHouse/ClickHouse/pull/52084) ([Val Doroshchuk](https://github.com/valbok)).
* (experimental MaterializedMySQL) Теперь в DDL для MaterializedMySQL поддерживаются строки UTF-8 без кавычек. [#52318](https://github.com/ClickHouse/ClickHouse/pull/52318) ([Val Doroshchuk](https://github.com/valbok)).
* (experimental MaterializedMySQL) Теперь в MaterializedMySQL поддерживаются комментарии в двойных кавычках. [#52355](https://github.com/ClickHouse/ClickHouse/pull/52355) ([Val Doroshchuk](https://github.com/valbok)).
* Обновлен Intel QPL с v1.1.0 до v1.2.0. 2. Обновлен Intel accel-config с v3.5 до v4.0. 3. Исправлена проблема, при которой промах Device IOTLB существенно снижал производительность ускорителей IAA. [#52180](https://github.com/ClickHouse/ClickHouse/pull/52180) ([jasperzhu](https://github.com/jinjunzh)).
* Настройка `session_timezone` (новая в версии 23.6) переведена в разряд экспериментальных. [#52445](https://github.com/ClickHouse/ClickHouse/pull/52445) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Поддержка команды ZooKeeper `reconfig` для ClickHouse Keeper с инкрементальной реконфигурацией, которую можно включить с помощью настройки `keeper_server.enable_reconfiguration`. Поддерживается добавление серверов, удаление серверов и изменение приоритетов серверов. [#49450](https://github.com/ClickHouse/ClickHouse/pull/49450) ([Mike Kot](https://github.com/myrrc)). Предполагается, что эта функциональность реализована не полностью.

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-5}

* Добавлены экспериментальные сборки ClickHouse для Linux RISC-V 64 в CI. [#31398](https://github.com/ClickHouse/ClickHouse/pull/31398) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена проверка интеграционных тестов при включённом Analyzer. [#50926](https://github.com/ClickHouse/ClickHouse/pull/50926) [#52210](https://github.com/ClickHouse/ClickHouse/pull/52210) ([Dmitry Novik](https://github.com/novikd)).
* Воспроизводимые сборки для Rust. [#52395](https://github.com/ClickHouse/ClickHouse/pull/52395) ([Azat Khuzhin](https://github.com/azat)).
* Обновлены зависимости Cargo. [#51721](https://github.com/ClickHouse/ClickHouse/pull/51721) ([Raúl Marín](https://github.com/Algunenano)).
* Функция `CHColumnToArrowColumn::fillArrowArrayWithArrayColumnData` доработана для работы с nullable-массивами, которые невозможны в ClickHouse, но нужны для Gluten. [#52112](https://github.com/ClickHouse/ClickHouse/pull/52112) ([李扬](https://github.com/taiyang-li)).
* Мы обновили библиотеку CCTZ до актуального master, но изменений, заметных пользователям, нет. [#52124](https://github.com/ClickHouse/ClickHouse/pull/52124) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Таблица `system.licenses` теперь включает библиотеку Poco, которая была жёстко форкнута. Это закрывает задачу [#52066](https://github.com/ClickHouse/ClickHouse/issues/52066). [#52127](https://github.com/ClickHouse/ClickHouse/pull/52127) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена проверка на случаи некорректной пунктуации: пробел перед запятой, как в `Hello ,world` вместо `Hello, world`. [#52549](https://github.com/ClickHouse/ClickHouse/pull/52549) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### Исправление ошибки (некорректное поведение, заметное пользователю, в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-5}

* Исправлена `syncTables` в `MaterializedPostgreSQL` [#49698](https://github.com/ClickHouse/ClickHouse/pull/49698) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена работа PROJECTION с optimize&#95;aggregators&#95;of&#95;group&#95;by&#95;keys [#49709](https://github.com/ClickHouse/ClickHouse/pull/49709) ([Amos Bird](https://github.com/amosbird)).
* Исправлено поведение optimize&#95;skip&#95;unused&#95;shards при использовании JOIN [#51037](https://github.com/ClickHouse/ClickHouse/pull/51037) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа функции formatDateTime() с отрицательными дробными значениями типа DateTime64 [#51290](https://github.com/ClickHouse/ClickHouse/pull/51290) ([Dmitry Kardymon](https://github.com/kardymonds)).
* Функции `hasToken*` работали полностью некорректно. Добавлен тест для [#43358](https://github.com/ClickHouse/ClickHouse/issues/43358) [#51378](https://github.com/ClickHouse/ClickHouse/pull/51378) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка в оптимизации переноса функций перед сортировкой. [#51481](https://github.com/ClickHouse/ClickHouse/pull/51481) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено несоответствие структуры Block в Pipe::unitePipes при использовании FINAL [#51492](https://github.com/ClickHouse/ClickHouse/pull/51492) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлен SIGSEGV для кластеров, у которых во всех сегментах нулевой вес (исправляет INSERT INTO FUNCTION clusterAllReplicas()) [#51545](https://github.com/ClickHouse/ClickHouse/pull/51545) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен таймаут для хеджированных запросов [#51582](https://github.com/ClickHouse/ClickHouse/pull/51582) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена логическая ошибка при ANTI JOIN с NULL-значениями [#51601](https://github.com/ClickHouse/ClickHouse/pull/51601) ([vdimir](https://github.com/vdimir)).
* Исправление проблемы с переносом условий &#39;IN&#39; в PREWHERE [#51610](https://github.com/ClickHouse/ClickHouse/pull/51610) ([Alexander Gololobov](https://github.com/davenger)).
* Не применять оптимизатор PredicateExpressionsOptimizer для соединений ASOF/ANTI [#51633](https://github.com/ClickHouse/ClickHouse/pull/51633) ([vdimir](https://github.com/vdimir)).
* Исправлена проблема с асинхронной вставкой с дедупликацией для ReplicatedMergeTree при использовании алгоритмов слияния [#51676](https://github.com/ClickHouse/ClickHouse/pull/51676) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка чтения из пустого столбца в `parseSipHashKey` [#51804](https://github.com/ClickHouse/ClickHouse/pull/51804) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена ошибка сегментации при создании недопустимой таблицы EmbeddedRocksdb [#51847](https://github.com/ClickHouse/ClickHouse/pull/51847) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлены операции вставки в таблицы MongoDB [#51876](https://github.com/ClickHouse/ClickHouse/pull/51876) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена взаимная блокировка при остановке DatabaseCatalog [#51908](https://github.com/ClickHouse/ClickHouse/pull/51908) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена ошибка в операторах подзапросов [#51922](https://github.com/ClickHouse/ClickHouse/pull/51922) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено асинхронное подключение к хостам с несколькими IP-адресами [#51934](https://github.com/ClickHouse/ClickHouse/pull/51934) ([Kruglov Pavel](https://github.com/Avogar)).
* Не удалять входы после вызова ActionsDAG::merge [#51947](https://github.com/ClickHouse/ClickHouse/pull/51947) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Проверять `refcount` в `RemoveManyObjectStorageOperation::finalize` вместо `execute` [#51954](https://github.com/ClickHouse/ClickHouse/pull/51954) ([vdimir](https://github.com/vdimir)).
* Разрешены параметризуемые UDF [#51964](https://github.com/ClickHouse/ClickHouse/pull/51964) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Небольшое исправление работы toDateTime64() с датами после 2283-12-31 [#52130](https://github.com/ClickHouse/ClickHouse/pull/52130) ([Andrey Zvonov](https://github.com/zvonand)).
* Исправлен ORDER BY для кортежа WINDOW-функций [#52145](https://github.com/ClickHouse/ClickHouse/pull/52145) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлен некорректный анализ проекций, когда агрегатное выражение содержит монотонные функции [#52151](https://github.com/ClickHouse/ClickHouse/pull/52151) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка в функциях `groupArrayMoving` [#52161](https://github.com/ClickHouse/ClickHouse/pull/52161) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Отключено прямое соединение для диапазонных словарей [#52187](https://github.com/ClickHouse/ClickHouse/pull/52187) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлен тест на «липкие» мутации (и крайне редкое состояние гонки) [#52197](https://github.com/ClickHouse/ClickHouse/pull/52197) ([alesapin](https://github.com/alesapin)).
* Устранена гонка в Web-диске [#52211](https://github.com/ClickHouse/ClickHouse/pull/52211) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена гонка данных в `Connection::setAsyncCallback`, возникавшая при обработке неизвестного пакета от сервера [#52219](https://github.com/ClickHouse/ClickHouse/pull/52219) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено удаление временных данных при запуске, добавлен тест [#52275](https://github.com/ClickHouse/ClickHouse/pull/52275) ([vdimir](https://github.com/vdimir)).
* Не используйте проекции minmax&#95;count для подсчёта столбцов с типом Nullable [#52297](https://github.com/ClickHouse/ClickHouse/pull/52297) ([Amos Bird](https://github.com/amosbird)).
* MergeTree/ReplicatedMergeTree должны использовать часовой пояс сервера для записей в журнал [#52325](https://github.com/ClickHouse/ClickHouse/pull/52325) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа параметризованного представления с CTE при многократном использовании [#52328](https://github.com/ClickHouse/ClickHouse/pull/52328) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Отключены шаблоны выражений для временных интервалов [#52335](https://github.com/ClickHouse/ClickHouse/pull/52335) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена функция `apply_snapshot` в Keeper [#52358](https://github.com/ClickHouse/ClickHouse/pull/52358) ([Antonio Andelic](https://github.com/antonio2368)).
* Обновлён файл build-osx.md [#52377](https://github.com/ClickHouse/ClickHouse/pull/52377) ([AlexBykovski](https://github.com/AlexBykovski)).
* Исправлено зависание `countSubstrings` при пустой подстроке `needle` и столбцовом `haystack` [#52409](https://github.com/ClickHouse/ClickHouse/pull/52409) ([Sergei Trifonov](https://github.com/serxa)).
* Исправлена работа обычной проекции с таблицами Merge  [#52432](https://github.com/ClickHouse/ClickHouse/pull/52432) ([Amos Bird](https://github.com/amosbird)).
* Исправлена потенциальная ошибка двойного освобождения памяти в Aggregator [#52439](https://github.com/ClickHouse/ClickHouse/pull/52439) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена ошибка вставки в движок Buffer [#52440](https://github.com/ClickHouse/ClickHouse/pull/52440) ([Vasily Nemkov](https://github.com/Enmk)).
* Реализация AnyHash не соответствовала спецификации. [#52448](https://github.com/ClickHouse/ClickHouse/pull/52448) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Проверка глубины рекурсии в OptimizedRegularExpression [#52451](https://github.com/ClickHouse/ClickHouse/pull/52451) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена гонка данных в методах DatabaseReplicated::startupTables()/canExecuteReplicatedMetadataAlter() [#52490](https://github.com/ClickHouse/ClickHouse/pull/52490) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено аварийное завершение работы функции `transform` [#52513](https://github.com/ClickHouse/ClickHouse/pull/52513) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена работа легковесного удаления после удаления проекции [#52517](https://github.com/ClickHouse/ClickHouse/pull/52517) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена возможная ошибка «Cannot drain connections: cancel first» [#52585](https://github.com/ClickHouse/ClickHouse/pull/52585) ([Pavel Kruglov](https://github.com/Avogar)).

### <a id="236"></a> Релиз ClickHouse 23.6 от 2023-06-29. [Презентация](https://presentations.clickhouse.com/2023-release-23.6/), [Видео](https://www.youtube.com/watch?v=cuf_hYn7dqU) {#236}

<iframe width="1024" height="576" src="https://www.youtube.com/embed/cuf_hYn7dqU" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

#### Изменения, нарушающие обратную совместимость {#backward-incompatible-change-6}

* Удалена функциональность `do_not_evict_index_and_mark_files` в fs-кэше. Эта функциональность только ухудшала ситуацию. [#51253](https://github.com/ClickHouse/ClickHouse/pull/51253) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Удалена поддержка ALTER для экспериментального LIVE VIEW. [#51287](https://github.com/ClickHouse/ClickHouse/pull/51287) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Значения по умолчанию для `http_max_field_value_size` и `http_max_field_name_size` уменьшены до 128 KiB. [#51163](https://github.com/ClickHouse/ClickHouse/pull/51163) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Метрики CGroups, связанные с CPU, заменены одной метрикой `CGroupMaxCPU` для удобства использования. Метрики использования CPU `Normalized` будут нормализоваться по лимитам CGroups вместо общего количества CPU, когда они заданы. Это закрывает [#50836](https://github.com/ClickHouse/ClickHouse/issues/50836). [#50835](https://github.com/ClickHouse/ClickHouse/pull/50835) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### Новая возможность {#new-feature-6}

* Функция `transform`, а также `CASE` с сопоставлением по значению теперь поддерживают все типы данных, что закрывает задачи [#29730](https://github.com/ClickHouse/ClickHouse/issues/29730), [#32387](https://github.com/ClickHouse/ClickHouse/issues/32387), [#50827](https://github.com/ClickHouse/ClickHouse/issues/50827), [#31336](https://github.com/ClickHouse/ClickHouse/issues/31336) и [#40493](https://github.com/ClickHouse/ClickHouse/issues/40493). [#51351](https://github.com/ClickHouse/ClickHouse/pull/51351) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена опция `--rename_files_after_processing <pattern>`. Это закрывает задачу [#34207](https://github.com/ClickHouse/ClickHouse/issues/34207). [#49626](https://github.com/ClickHouse/ClickHouse/pull/49626) ([alekseygolub](https://github.com/alekseygolub)).
* Добавлена поддержка модификатора `TRUNCATE` в предложении `INTO OUTFILE`. Рекомендуется использовать `APPEND` или `TRUNCATE` для `INTO OUTFILE`, если файл уже существует. [#50950](https://github.com/ClickHouse/ClickHouse/pull/50950) ([alekar](https://github.com/alekar)).
* Добавлен движок таблицы `Redis` и табличная функция `redis`. Это позволяет выполнять запросы к внешним серверам Redis. [#50150](https://github.com/ClickHouse/ClickHouse/pull/50150) ([JackyWoo](https://github.com/JackyWoo)).
* Добавлена возможность пропускать пустые файлы в табличных функциях `file`/`s3`/`url`/`hdfs` с помощью настроек `s3_skip_empty_files`, `hdfs_skip_empty_files`, `engine_file_skip_empty_files`, `engine_url_skip_empty_files`. [#50364](https://github.com/ClickHouse/ClickHouse/pull/50364) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена новая настройка `use_mysql_types_in_show_columns` для изменения SQL‑оператора `SHOW COLUMNS` так, чтобы он отображал эквивалентные типы MySQL, когда клиент подключён через порт совместимости с MySQL. [#49577](https://github.com/ClickHouse/ClickHouse/pull/49577) ([Thomas Panetti](https://github.com/tpanetti)).
* Теперь `clickhouse-client` можно вызывать с помощью строки подключения вместо параметров "--host", "--port", "--user" и т. д. [#50689](https://github.com/ClickHouse/ClickHouse/pull/50689) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
* Добавлена настройка `session_timezone`; она используется как часовой пояс по умолчанию для сессии, если явно не указан другой. [#44149](https://github.com/ClickHouse/ClickHouse/pull/44149) ([Andrey Zvonov](https://github.com/zvonand)).
* Кодек DEFLATE_QPL теперь управляется серверной настройкой "enable_deflate_qpl_codec" (по умолчанию: false) вместо настройки "allow_experimental_codecs". Это означает, что DEFLATE_QPL больше не считается экспериментальным. [#50775](https://github.com/ClickHouse/ClickHouse/pull/50775) ([Robert Schulze](https://github.com/rschu1ze)).

#### Повышение производительности {#performance-improvement-6}

* Улучшено планирование задач выбора слияний и очистки в `ReplicatedMergeTree`. Задачи не будут выполняться слишком часто, когда нет данных для слияния или очистки. Добавлены настройки `max_merge_selecting_sleep_ms`, `merge_selecting_sleep_slowdown_factor`, `max_cleanup_delay_period` и `cleanup_thread_preferred_points_per_iteration`. Это должно закрыть [#31919](https://github.com/ClickHouse/ClickHouse/issues/31919). [#50107](https://github.com/ClickHouse/ClickHouse/pull/50107) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Реализовано проталкивание фильтра (filter push down) через CROSS JOIN. [#50605](https://github.com/ClickHouse/ClickHouse/pull/50605) ([Han Fei](https://github.com/hanfei1991)).
* Улучшена производительность при включённом QueryProfiler за счёт использования thread-local `timer_id` вместо глобального объекта. [#48778](https://github.com/ClickHouse/ClickHouse/pull/48778) ([Jiebin Sun](https://github.com/jiebinn)).
* Переписан формат ввода/вывода CapnProto для улучшения его производительности. Имена столбцов и поля CapnProto сопоставляются без учёта регистра, исправлено чтение/запись полей вложенных структур. [#49752](https://github.com/ClickHouse/ClickHouse/pull/49752) ([Kruglov Pavel](https://github.com/Avogar)).
* Оптимизирована производительность записи Parquet для параллельных потоков. [#50102](https://github.com/ClickHouse/ClickHouse/pull/50102) ([Hongbin Ma](https://github.com/binmahone)).
* Отключён `parallelize_output_from_storages` для обработки materialized view (MATERIALIZED VIEW) и хранилищ только с одним блоком. [#50214](https://github.com/ClickHouse/ClickHouse/pull/50214) ([Azat Khuzhin](https://github.com/azat)).
* Влит PR [#46558](https://github.com/ClickHouse/ClickHouse/pull/46558). Избегается перестановка блоков при сортировке, если блок уже отсортирован. [#50697](https://github.com/ClickHouse/ClickHouse/pull/50697) ([Alexey Milovidov](https://github.com/alexey-milovidov), [Maksim Kita](https://github.com/kitaisreal)).
* Выполнение нескольких запросов на получение списка (list requests) к ZooKeeper в параллель для ускорения чтения из таблицы system.zookeeper. [#51042](https://github.com/ClickHouse/ClickHouse/pull/51042) ([Alexander Gololobov](https://github.com/davenger)).
* Ускорена инициализация lookup-таблиц DateTime для часовых поясов. Это должно сократить время запуска/подключения clickhouse-client, особенно в debug-сборке, так как она довольно тяжёлая. [#51347](https://github.com/ClickHouse/ClickHouse/pull/51347) ([Alexander Gololobov](https://github.com/davenger)).
* Исправлено снижение производительности озёр данных из-за синхронных запросов HEAD (относящихся к медленной работе Iceberg/Deltalake/Hudi при большом количестве файлов). [#50976](https://github.com/ClickHouse/ClickHouse/pull/50976) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Не выполняется чтение всех столбцов из правой таблицы GLOBAL JOIN. [#50721](https://github.com/ClickHouse/ClickHouse/pull/50721) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).

#### Экспериментальная возможность {#experimental-feature-3}

* Добавлена поддержка параллельных реплик в анализаторе. [#50441](https://github.com/ClickHouse/ClickHouse/pull/50441) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлена случайная пауза (`sleep`) перед выполнением крупных слияний/мутаций, чтобы распределять нагрузку более равномерно между репликами в случае репликации без копирования. [#51282](https://github.com/ClickHouse/ClickHouse/pull/51282) ([alesapin](https://github.com/alesapin)).
* Запросы `ALTER PARTITION` и мутации больше не реплицируются через базу данных `Replicated`, если она содержит только один сегмент, а лежащая в основе таблица — `ReplicatedMergeTree`. [#51049](https://github.com/ClickHouse/ClickHouse/pull/51049) ([Alexander Tokmakov](https://github.com/tavplubix)).

#### Улучшения {#improvement-6}

* Ослаблены пороговые значения для «слишком большого количества частей», чтобы соответствовать современным требованиям. Вернули backpressure для длительно выполняющихся запросов INSERT. [#50856](https://github.com/ClickHouse/ClickHouse/pull/50856) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность приводить IPv6-адрес к IPv4-адресу для CIDR ::ffff:0:0/96 (IPv4-mapped addresses). [#49759](https://github.com/ClickHouse/ClickHouse/pull/49759) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Обновлён протокол MongoDB, теперь поддерживаются версии MongoDB 5.1 и новее. Поддержка версий со старым протоколом (&lt;3.6) сохранена. Закрыты [#45621](https://github.com/ClickHouse/ClickHouse/issues/45621), [#49879](https://github.com/ClickHouse/ClickHouse/issues/49879). [#50061](https://github.com/ClickHouse/ClickHouse/pull/50061) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена настройка `input_format_max_bytes_to_read_for_schema_inference` для ограничения числа байт, считываемых при определении схемы. Закрывает [#50577](https://github.com/ClickHouse/ClickHouse/issues/50577). [#50592](https://github.com/ClickHouse/ClickHouse/pull/50592) ([Kruglov Pavel](https://github.com/Avogar)).
* При определении схемы учитывать настройку `input_format_null_as_default`. [#50602](https://github.com/ClickHouse/ClickHouse/pull/50602) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена возможность пропускать завершающие пустые строки в форматах CSV/TSV/CustomSeparated с помощью настроек `input_format_csv_skip_trailing_empty_lines`, `input_format_tsv_skip_trailing_empty_lines` и `input_format_custom_skip_trailing_empty_lines` (по умолчанию отключено). Закрывает [#49315](https://github.com/ClickHouse/ClickHouse/issues/49315). [#50635](https://github.com/ClickHouse/ClickHouse/pull/50635) ([Kruglov Pavel](https://github.com/Avogar)).
* Функции «toDateOrDefault|OrNull» и «accuateCast[OrDefault|OrNull]» теперь корректно интерпретируют числовые аргументы. [#50709](https://github.com/ClickHouse/ClickHouse/pull/50709) ([Dmitry Kardymon](https://github.com/kardymonds)).
* Добавлена поддержка CSV с разделителями полей — пробелом или `\t`; эти разделители поддерживаются в Spark. [#50712](https://github.com/ClickHouse/ClickHouse/pull/50712) ([KevinyhZou](https://github.com/KevinyhZou)).
* Параметры `number_of_mutations_to_delay` и `number_of_mutations_to_throw` теперь по умолчанию включены со значениями 500 и 1000 соответственно. [#50726](https://github.com/ClickHouse/ClickHouse/pull/50726) ([Anton Popov](https://github.com/CurtizJ)).
* Панель мониторинга корректно отображает отсутствующие значения. Исправление закрывает [#50831](https://github.com/ClickHouse/ClickHouse/issues/50831). [#50832](https://github.com/ClickHouse/ClickHouse/pull/50832) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность использовать аргументы даты и времени в формате временной метки syslog в функциях `parseDateTimeBestEffort*` и `parseDateTime64BestEffort*`. [#50925](https://github.com/ClickHouse/ClickHouse/pull/50925) ([Victor Krasnov](https://github.com/sirvickr)).
* Параметр командной строки «--password» для clickhouse-client теперь можно указывать только один раз. [#50966](https://github.com/ClickHouse/ClickHouse/pull/50966) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
* Используйте `hash_of_all_files` из `system.parts` для проверки совпадения частей при кластерном резервном копировании. [#50997](https://github.com/ClickHouse/ClickHouse/pull/50997) ([Vitaly Baranov](https://github.com/vitlibar)).
* В системной таблице zookeeper&#95;connection столбец connected&#95;time показывает время установления соединения (в стандартном формате), а добавленный столбец session&#95;uptime&#95;elapsed&#95;seconds отображает продолжительность сеанса установленного соединения (в секундах). [#51026](https://github.com/ClickHouse/ClickHouse/pull/51026) ([郭小龙](https://github.com/guoxiaolongzte)).
* Улучшен индикатор прогресса для табличных функций file/s3/hdfs/url за счет использования размера фрагмента исходных данных и поэтапного подсчета общего объема данных в каждом потоке. Исправлен индикатор прогресса для функций *Cluster. Закрывает [#47250](https://github.com/ClickHouse/ClickHouse/issues/47250). [#51088](https://github.com/ClickHouse/ClickHouse/pull/51088) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен total&#95;bytes&#95;to&#95;read в пакет Progress TCP-протокола для улучшения прогресс-бара. [#51158](https://github.com/ClickHouse/ClickHouse/pull/51158) ([Kruglov Pavel](https://github.com/Avogar)).
* Улучшена проверка частей данных на дисках с кэшем файловой системы. [#51164](https://github.com/ClickHouse/ClickHouse/pull/51164) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено иногда некорректное значение current&#95;elements&#95;num в кэше файловой системы. [#51242](https://github.com/ClickHouse/ClickHouse/pull/51242) ([Kseniia Sumarokova](https://github.com/kssenii)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-6}

* Во встроенный keeper добавлен встроенный keeper-client в отдельный исполняемый файл. [#50964](https://github.com/ClickHouse/ClickHouse/pull/50964) ([pufit](https://github.com/pufit)).
* Теперь используется актуальная версия LZ4. [#50621](https://github.com/ClickHouse/ClickHouse/pull/50621) ([Nikita Taranov](https://github.com/nickitat)).
* Сервер ClickHouse будет выводить список изменённых настроек при возникновении фатальных ошибок. Это закрывает [#51137](https://github.com/ClickHouse/ClickHouse/issues/51137). [#51138](https://github.com/ClickHouse/ClickHouse/pull/51138) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Разрешена сборка ClickHouse с clang-17. [#51300](https://github.com/ClickHouse/ClickHouse/pull/51300) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Проверка [SQLancer](https://github.com/sqlancer/sqlancer) считается стабильной, так как вызванные ею ошибки были исправлены. Теперь сбои проверки SQLancer будут отражаться как статус завершения проверки с ошибкой. [#51340](https://github.com/ClickHouse/ClickHouse/pull/51340) ([Ilya Yatsishin](https://github.com/qoega)).
* Огромная команда `RUN` в Dockerfile разделена на несколько меньших условных блоков. Необходимые инструменты устанавливаются по требованию в том же слое `RUN` и затем удаляются. Обновление ОС выполняется только один раз в начале. Используется современный способ проверки подписанного репозитория. Базовый образ понижен до ubuntu:20.04 для устранения проблем в более старых версиях Docker. Обновлена версия Go для устранения уязвимостей Go. [#51504](https://github.com/ClickHouse/ClickHouse/pull/51504) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).

#### Исправление ошибки (заметное для пользователя некорректное поведение в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-6}

* Корректно отображать статус загрузки исполняемых словарей [#48775](https://github.com/ClickHouse/ClickHouse/pull/48775) ([Anton Kozlov](https://github.com/tonickkozlov)).
* Корректная обработка мутаций индексов пропуска и проекций [#50104](https://github.com/ClickHouse/ClickHouse/pull/50104) ([Amos Bird](https://github.com/amosbird)).
* Очистка логики перемещения частей [#50489](https://github.com/ClickHouse/ClickHouse/pull/50489) ([vdimir](https://github.com/vdimir)).
* Исправлена проблема с обратной совместимостью хеширования IP-типов в агрегатных функциях [#50551](https://github.com/ClickHouse/ClickHouse/pull/50551) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена ошибка, из-за которой таблица семейства Log возвращала неверное количество строк после операции TRUNCATE [#50585](https://github.com/ClickHouse/ClickHouse/pull/50585) ([flynn](https://github.com/ucasfl)).
* Исправлена ошибка при параллельном слиянии `uniqExact` [#50590](https://github.com/ClickHouse/ClickHouse/pull/50590) ([Nikita Taranov](https://github.com/nickitat)).
* Откатили недавние изменения в grace hash join [#50699](https://github.com/ClickHouse/ClickHouse/pull/50699) ([vdimir](https://github.com/vdimir)).
* Query Cache: Попытка исправить некорректное приведение типов из `ColumnConst` к `ColumnVector<char8_t>` [#50704](https://github.com/ClickHouse/ClickHouse/pull/50704) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена ошибка, из-за которой в Keeper могли сохраняться логи с неизвестной операцией [#50751](https://github.com/ClickHouse/ClickHouse/pull/50751) ([Antonio Andelic](https://github.com/antonio2368)).
* Поддержка DateTime64 в SummingMergeTree [#50797](https://github.com/ClickHouse/ClickHouse/pull/50797) ([Jordi Villar](https://github.com/jrdi)).
* Добавлена настройка совместимости с неконстантными часовыми поясами [#50834](https://github.com/ClickHouse/ClickHouse/pull/50834) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлено хеширование параметров LDAP в записях кэша [#50865](https://github.com/ClickHouse/ClickHouse/pull/50865) ([Julian Maicher](https://github.com/jmaicher)).
* Резервный переход к разбору большого целого числа из String вместо генерации исключения в формате Parquet [#50873](https://github.com/ClickHouse/ClickHouse/pull/50873) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена проблема слишком частой проверки файла блокировки при записи резервной копии [#50889](https://github.com/ClickHouse/ClickHouse/pull/50889) ([Vitaly Baranov](https://github.com/vitlibar)).
* Не применять проекцию, если включен `read-in-order`. [#50923](https://github.com/ClickHouse/ClickHouse/pull/50923) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Устранена гонка состояний в итераторе Azure Blob Storage [#50936](https://github.com/ClickHouse/ClickHouse/pull/50936) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлена ошибочная передача `sort_description` в `CreatingSets` [#50955](https://github.com/ClickHouse/ClickHouse/pull/50955) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена обработка необязательных метаданных Iceberg v2 [#50974](https://github.com/ClickHouse/ClickHouse/pull/50974) ([Kseniia Sumarokova](https://github.com/kssenii)).
* MaterializedMySQL: сохранять скобки в пустых переопределениях таблиц [#50977](https://github.com/ClickHouse/ClickHouse/pull/50977) ([Val Doroshchuk](https://github.com/valbok)).
* Исправлен сбой в BackupCoordinationStageSync::setError() [#51012](https://github.com/ClickHouse/ClickHouse/pull/51012) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена слегка нарушенная реализация механизма copy-on-write для словаря ColumnLowCardinality [#51064](https://github.com/ClickHouse/ClickHouse/pull/51064) ([Michael Kolupaev](https://github.com/al13n321)).
* Генерировать безопасные векторы инициализации (IV) [#51086](https://github.com/ClickHouse/ClickHouse/pull/51086) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Исправлена неэффективная работа кэша запросов для SELECT с подзапросами [#51132](https://github.com/ClickHouse/ClickHouse/pull/51132) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена работа индекса Set при сравнении с константой типа Nullable. [#51205](https://github.com/ClickHouse/ClickHouse/pull/51205) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено падение в функциях s3 и s3Cluster [#51209](https://github.com/ClickHouse/ClickHouse/pull/51209) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена ошибка, вызывавшая сбой при использовании скомпилированных выражений [#51231](https://github.com/ClickHouse/ClickHouse/pull/51231) ([LiuNeng](https://github.com/liuneng1994)).
* Исправлена ошибка типа use-after-free в StorageURL при переключении URL [#51260](https://github.com/ClickHouse/ClickHouse/pull/51260) ([Michael Kolupaev](https://github.com/al13n321)).
* Обновлена проверка для параметризованного представления [#51272](https://github.com/ClickHouse/ClickHouse/pull/51272) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлена проблема с многократной записью одного и того же файла в резервную копию [#51299](https://github.com/ClickHouse/ClickHouse/pull/51299) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен сбой фаззера в ActionsDAG [#51301](https://github.com/ClickHouse/ClickHouse/pull/51301) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Из функции `transform` удалён ненужный код [#51350](https://github.com/ClickHouse/ClickHouse/pull/51350) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### <a id="235"></a> Релиз ClickHouse 23.5, 2023-06-08. [Презентация](https://presentations.clickhouse.com/2023-release-23.5/), [Видео](https://www.youtube.com/watch?v=o8Gj1ClU71M) {#235}

<iframe width="1024" height="576" src="https://www.youtube.com/embed/o8Gj1ClU71M" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

#### Заметки по обновлению {#upgrade-notes}

* По умолчанию сжимаются метки и первичный ключ. Это значительно уменьшает время выполнения холодных запросов. Заметки по обновлению: поддержка сжатых меток и первичного ключа была добавлена в версии 22.9. Если вы включили сжатые метки или первичный ключ либо установили версию 23.5 или новее, где сжатые метки или первичный ключ включены по умолчанию, вы не сможете выполнить откат до версии 22.8 или более ранней. Вы также можете явно отключить сжатые метки или первичный ключ, указав настройки `compress_marks` и `compress_primary_key` в секции `<merge_tree>` конфигурационного файла сервера. **Заметки по обновлению:** если вы обновляетесь с версий до 22.9, вам следует либо обновить все реплики одновременно, либо отключить сжатие перед обновлением, либо обновляться через промежуточную версию, в которой сжатые метки поддерживаются, но не включены по умолчанию, такую как 23.3. [#42587](https://github.com/ClickHouse/ClickHouse/pull/42587) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Обеспечена согласованная работа локального объектного хранилища с объектным хранилищем S3, исправлена проблема с добавлением (закрывает [#48465](https://github.com/ClickHouse/ClickHouse/issues/48465)), локальное хранилище можно настраивать как независимое. Изменение несовместимо с предыдущими версиями, поскольку кэш поверх локального объектного хранилища не совместим с ними. [#48791](https://github.com/ClickHouse/ClickHouse/pull/48791) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Экспериментальная функция "in-memory data parts" удалена. Формат данных по‑прежнему поддерживается, но настройки ничего не делают, и вместо него будут использоваться компактные или широкие части. Это закрывает [#45409](https://github.com/ClickHouse/ClickHouse/issues/45409). [#49429](https://github.com/ClickHouse/ClickHouse/pull/49429) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Изменены значения по умолчанию настроек `parallelize_output_from_storages` и `input_format_parquet_preserve_order`. Это позволяет ClickHouse изменять порядок строк при чтении из файлов (например, CSV или Parquet), что во многих случаях значительно улучшает производительность. Чтобы восстановить прежнее поведение с сохранением порядка, используйте `parallelize_output_from_storages = 0`, `input_format_parquet_preserve_order = 1`. [#49479](https://github.com/ClickHouse/ClickHouse/pull/49479) ([Michael Kolupaev](https://github.com/al13n321)).
* Проекции сделали готовыми к использованию в продакшене. Добавлена настройка `optimize_use_projections` для управления тем, будут ли проекции выбираться для SELECT-запросов. Настройка `allow_experimental_projection_optimization` устарела и больше ничего не делает. [#49719](https://github.com/ClickHouse/ClickHouse/pull/49719) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Пометить `joinGet` как недетерминированную (как и `dictGet`). Это позволяет использовать их в мутациях без дополнительной настройки. [#49843](https://github.com/ClickHouse/ClickHouse/pull/49843) ([Azat Khuzhin](https://github.com/azat)).
* Отменить изменение "`groupArray` returns cannot be nullable" (из‑за нарушения бинарной совместимости для `groupArray`/`groupArrayLast`/`groupArraySample` над типами `Nullable`, что, вероятнее всего, приведёт к ошибкам `TOO_LARGE_ARRAY_SIZE` или `CANNOT_READ_ALL_DATA`). [#49971](https://github.com/ClickHouse/ClickHouse/pull/49971) ([Azat Khuzhin](https://github.com/azat)).
* Настройка `enable_memory_bound_merging_of_aggregation_results` включена по умолчанию. Если вы обновляетесь с версии до 22.12, мы рекомендуем установить этот флаг в `false` до завершения обновления. [#50319](https://github.com/ClickHouse/ClickHouse/pull/50319) ([Nikita Taranov](https://github.com/nickitat)).

#### Новая функциональность {#new-feature-7}

* Добавлен движок хранения AzureBlobStorage и табличная функция azureBlobStorage. Поддерживаемый набор возможностей во многом аналогичен движку/табличной функции S3 [#50604] ([https://github.com/ClickHouse/ClickHouse/pull/50604](https://github.com/ClickHouse/ClickHouse/pull/50604)) ([alesapin](https://github.com/alesapin)) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Добавлен встроенный CLI-клиент ClickHouse Keeper; он доступен как команда `clickhouse keeper-client` [#47414](https://github.com/ClickHouse/ClickHouse/pull/47414) ([pufit](https://github.com/pufit)).
* Добавлена табличная функция `urlCluster`. Выполнен рефакторинг всех табличных функций *Cluster для уменьшения дублирования кода. Автоматический вывод схемы теперь работает для всех возможных сигнатур функций *Cluster и для именованных коллекций. Закрывает [#38499](https://github.com/ClickHouse/ClickHouse/issues/38499). [#45427](https://github.com/ClickHouse/ClickHouse/pull/45427) ([attack204](https://github.com/attack204)), Pavel Kruglov.
* Кэш запросов теперь можно использовать в производственной среде. [#47977](https://github.com/ClickHouse/ClickHouse/pull/47977) ([Robert Schulze](https://github.com/rschu1ze)). Кэш запросов теперь поддерживает запросы с модификаторами totals и extremes. [#48853](https://github.com/ClickHouse/ClickHouse/pull/48853) ([Robert Schulze](https://github.com/rschu1ze)). Настройка `allow_experimental_query_cache` помечена как устаревшая для обеспечения обратной совместимости. Она была удалена в [https://github.com/ClickHouse/ClickHouse/pull/47977](https://github.com/ClickHouse/ClickHouse/pull/47977). [#49934](https://github.com/ClickHouse/ClickHouse/pull/49934) ([Timur Solodovников](https://github.com/tsolodov)).
* Географические типы данных (`Point`, `Ring`, `Polygon` и `MultiPolygon`) готовы к промышленной эксплуатации. [#50022](https://github.com/ClickHouse/ClickHouse/pull/50022) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлено автоматическое определение схемы для движков таблиц PostgreSQL, MySQL, MeiliSearch и SQLite. Закрывает [#49972](https://github.com/ClickHouse/ClickHouse/issues/49972). [#50000](https://github.com/ClickHouse/ClickHouse/pull/50000) ([Nikolay Degterinsky](https://github.com/evillique)).
* Тип пароля в запросах вида `CREATE USER u IDENTIFIED BY 'p'` будет автоматически определён согласно настройке `default_password_type` в `config.xml` на сервере. Закрывает [#42915](https://github.com/ClickHouse/ClickHouse/issues/42915). [#44674](https://github.com/ClickHouse/ClickHouse/pull/44674) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлен тип аутентификации пароля с использованием bcrypt. Закрывает [#34599](https://github.com/ClickHouse/ClickHouse/issues/34599). [#44905](https://github.com/ClickHouse/ClickHouse/pull/44905) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлено новое ключевое слово `INTO OUTFILE 'file.txt' APPEND`. [#48880](https://github.com/ClickHouse/ClickHouse/pull/48880) ([alekar](https://github.com/alekar)).
* Добавлена таблица `system.zookeeper_connection`, которая показывает информацию о подключениях к Keeper. [#45245](https://github.com/ClickHouse/ClickHouse/pull/45245) ([mateng915](https://github.com/mateng0915)).
* Добавлена новая функция `generateRandomStructure`, которая генерирует случайную структуру таблицы. Её можно использовать совместно с табличной функцией `generateRandom`. [#47409](https://github.com/ClickHouse/ClickHouse/pull/47409) ([Kruglov Pavel](https://github.com/Avogar)).
* Разрешено использование `CASE` без ветки `ELSE`, а также расширена функция `transform` для работы с большим числом типов. Также исправлены некоторые проблемы, из-за которых `transform()` возвращал некорректные результаты при смешении десятичных типов с другими числовыми типами. [#48300](https://github.com/ClickHouse/ClickHouse/pull/48300) ([Salvatore Mesoraca](https://github.com/aiven-sal)). Закрывает #2655. Закрывает #9596. Закрывает #38666.
* Добавлено [шифрование на стороне сервера с использованием ключей KMS](https://docs.aws.amazon.com/AmazonS3/latest/userguide/UsingKMSEncryption.html) в таблицах S3 и добавлена настройка `header` для дисков S3. Закрывает [#48723](https://github.com/ClickHouse/ClickHouse/issues/48723). [#48724](https://github.com/ClickHouse/ClickHouse/pull/48724) ([Johann Gan](https://github.com/johanngan)).
* Добавлен MemoryTracker для фоновых задач слияний и мутаций. Введены настройки `merges_mutations_memory_usage_soft_limit` и `merges_mutations_memory_usage_to_ram_ratio`, представляющие собой мягкий лимит памяти для слияний и мутаций. Если этот лимит достигнут, ClickHouse больше не будет планировать новые задачи слияния или мутации. Также добавлена метрика `MergesMutationsMemoryTracking`, которая позволяет отслеживать текущее потребление памяти фоновыми задачами. Повторная отправка [#46089](https://github.com/ClickHouse/ClickHouse/issues/46089). Закрывает [#48774](https://github.com/ClickHouse/ClickHouse/issues/48774). [#48787](https://github.com/ClickHouse/ClickHouse/pull/48787) ([Dmitry Novik](https://github.com/novikd)).
* Функция `dotProduct` поддерживает массивы. [#49050](https://github.com/ClickHouse/ClickHouse/pull/49050) ([FFFFFFFHHHHHHH](https://github.com/FFFFFFFHHHHHHH)).
* Добавлена поддержка оператора `SHOW INDEX` для повышения совместимости с MySQL. [#49158](https://github.com/ClickHouse/ClickHouse/pull/49158) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка виртуальных столбцов `_file` и `_path` в табличной функции `url`. — Улучшено сообщение об ошибке для табличной функции `url`. — исправляет [#49231](https://github.com/ClickHouse/ClickHouse/issues/49231) — исправляет [#49232](https://github.com/ClickHouse/ClickHouse/issues/49232). [#49356](https://github.com/ClickHouse/ClickHouse/pull/49356) ([Ziyi Tan](https://github.com/Ziy1-Tan)).
* Добавлено поле `grants` в файл users.xml, позволяющее назначать привилегии пользователям. [#49381](https://github.com/ClickHouse/ClickHouse/pull/49381) ([pufit](https://github.com/pufit)).
* Добавлена поддержка операций FULL/RIGHT JOIN с использованием алгоритма Grace Hash Join. [#49483](https://github.com/ClickHouse/ClickHouse/pull/49483) ([lgbo](https://github.com/lgbo-ustc)).
* Модификатор `WITH FILL` выполняет заполнение, группируя его по префиксу сортировки. Управляется настройкой `use_with_fill_by_sorting_prefix` (включена по умолчанию). Связано с [#33203](https://github.com/ClickHouse/ClickHouse/issues/33203)#issuecomment-1418736794. [#49503](https://github.com/ClickHouse/ClickHouse/pull/49503) ([Igor Nikonov](https://github.com/devcrafter)).
* Clickhouse-client теперь принимает запросы, указанные после &quot;--multiquery&quot;, если не задан параметр &quot;--query&quot; (или &quot;-q&quot;). Пример: clickhouse-client --multiquery &quot;select 1; select 2;&quot;. [#49870](https://github.com/ClickHouse/ClickHouse/pull/49870) ([Alexey Gerasimchuk](https://github.com/Demilivor)).
* Добавлен отдельный параметр `handshake_timeout` для получения пакета Hello от реплики. Закрывает [#48854](https://github.com/ClickHouse/ClickHouse/issues/48854). [#49948](https://github.com/ClickHouse/ClickHouse/pull/49948) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена функция &quot;space&quot;, которая возвращает строку, состоящую из заданного количества пробелов. [#50103](https://github.com/ClickHouse/ClickHouse/pull/50103) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена опция --input&#95;format&#95;csv&#95;trim&#95;whitespaces. [#50215](https://github.com/ClickHouse/ClickHouse/pull/50215) ([Alexey Gerasimchuk](https://github.com/Demilivor)).
* Разрешить функции `dictGetAll` для словарей-деревьев с регулярными выражениями возвращать значения для нескольких совпадений в виде массивов. Закрывает [#50254](https://github.com/ClickHouse/ClickHouse/issues/50254). [#50255](https://github.com/ClickHouse/ClickHouse/pull/50255) ([Johann Gan](https://github.com/johanngan)).
* Добавлена функция `toLastDayOfWeek` для округления даты или даты со временем до ближайшей субботы или воскресенья. [#50315](https://github.com/ClickHouse/ClickHouse/pull/50315) ([Victor Krasnov](https://github.com/sirvickr)).
* Возможность игнорировать индексы пропуска данных с помощью параметра `ignore_data_skipping_indices`. [#50329](https://github.com/ClickHouse/ClickHouse/pull/50329) ([Boris Kuschel](https://github.com/bkuschel)).
* Добавлена таблица `system.user_processes` и запрос `SHOW USER PROCESSES` для отображения информации о потреблении памяти и ProfileEvents на уровне пользователей. [#50492](https://github.com/ClickHouse/ClickHouse/pull/50492) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Добавлены серверные настройки и настройки форматов `display_secrets_in_show_and_select` для отображения секретов таблиц, баз данных, табличных функций и словарей. Добавлена привилегия `displaySecretsInShowAndSelect`, контролирующая, какие пользователи могут просматривать секреты. [#46528](https://github.com/ClickHouse/ClickHouse/pull/46528) ([Mike Kot](https://github.com/myrrc)).
* Добавлена возможность настраивать ROW POLICY для всех таблиц, принадлежащих DATABASE. [#47640](https://github.com/ClickHouse/ClickHouse/pull/47640) ([Ilya Golshtein](https://github.com/ilejn)).

#### Повышение производительности {#performance-improvement-7}

* По умолчанию включено сжатие меток и первичного ключа. Это значительно сокращает время выполнения холодных запросов. Примечание по обновлению: поддержка сжатых меток и первичного ключа была добавлена в версии 22.9. Если вы включили сжатые метки или первичный ключ либо установили версию 23.5 или новее, в которой сжатые метки или первичный ключ включены по умолчанию, вы не сможете откатиться до версии 22.8 или более ранней. Вы также можете явно отключить сжатые метки или первичный ключ, указав настройки `compress_marks` и `compress_primary_key` в разделе `<merge_tree>` файла конфигурации сервера. [#42587](https://github.com/ClickHouse/ClickHouse/pull/42587) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Новый параметр s3&#95;max&#95;inflight&#95;parts&#95;for&#95;one&#95;file задаёт ограничение на число одновременно загружаемых частей при multipart-загрузке одного файла. [#49961](https://github.com/ClickHouse/ClickHouse/pull/49961) ([Sema Checherinda](https://github.com/CheSema)).
* При чтении из нескольких файлов уменьшено количество потоков параллельного разбора для каждого файла. Исправлено [#42192](https://github.com/ClickHouse/ClickHouse/issues/42192). [#46661](https://github.com/ClickHouse/ClickHouse/pull/46661) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Используйте агрегирующую PROJECTION только если при её использовании считывается меньше гранул, чем при обычном чтении. Это должно помочь в случае, когда запрос попадает по PK таблицы, но не по PROJECTION. Исправляет [#49150](https://github.com/ClickHouse/ClickHouse/issues/49150). [#49417](https://github.com/ClickHouse/ClickHouse/pull/49417) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Не хранить блоки в хэш-соединении `ANY`, если ничего не вставлено. [#48633](https://github.com/ClickHouse/ClickHouse/pull/48633) ([vdimir](https://github.com/vdimir)).
* Исправлена работа агрегатного комбинатора `-If` в режиме JIT-компиляции, а также включена JIT-компиляция для агрегатных функций. Закрывает [#48120](https://github.com/ClickHouse/ClickHouse/issues/48120). [#49083](https://github.com/ClickHouse/ClickHouse/pull/49083) ([Igor Nikonov](https://github.com/devcrafter)).
* Для чтения из удалённых таблиц мы используем более мелкие задачи (вместо чтения всей части), чтобы механизм *task stealing* работал; размер задач определяется размером столбцов для чтения; для чтения из S3 всегда используются буферы размером 1 МБ; границы сегментов кэша выровнены по 1 МБ, чтобы они имели приемлемый размер даже при небольших задачах. Это также должно предотвратить фрагментацию. [#49287](https://github.com/ClickHouse/ClickHouse/pull/49287) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлены настройки: - `merge_max_block_size_bytes` для ограничения объёма памяти, используемой фоновыми операциями. - `vertical_merge_algorithm_min_bytes_to_activate` чтобы задать дополнительное условие активации вертикальных слияний. [#49313](https://github.com/ClickHouse/ClickHouse/pull/49313) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Размер буфера чтения по умолчанию при работе с локальной файловой системой изменён на немного более оптимальное значение. Также добавлены две новые настройки: `max_read_buffer_size_local_fs` и `max_read_buffer_size_remote_fs`. [#49321](https://github.com/ClickHouse/ClickHouse/pull/49321) ([Nikita Taranov](https://github.com/nickitat)).
* Улучшено использование памяти и скорость работы словарей `SPARSE_HASHED`/`HASHED` (например, `SPARSE_HASHED` теперь потребляет в 2.6 раза меньше памяти и работает примерно в 2 раза быстрее). [#49380](https://github.com/ClickHouse/ClickHouse/pull/49380) ([Azat Khuzhin](https://github.com/azat)).
* Оптимизированы таблицы `system.query_log` и `system.query_thread_log` за счет использования `LowCardinality` там, где это возможно. Запросы к этим таблицам будут выполняться быстрее. [#49530](https://github.com/ClickHouse/ClickHouse/pull/49530) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшена производительность чтения локальных файлов `Parquet` (за счёт параллельного чтения). [#49539](https://github.com/ClickHouse/ClickHouse/pull/49539) ([Michael Kolupaev](https://github.com/al13n321)).
* Увеличена производительность `RIGHT/FULL JOIN` до 2 раз в некоторых сценариях, особенно при соединении небольшой левой таблицы с большой правой таблицей. [#49585](https://github.com/ClickHouse/ClickHouse/pull/49585) ([lgbo](https://github.com/lgbo-ustc)).
* Улучшена производительность BLAKE3 на 11% за счет включения LTO для Rust. [#49600](https://github.com/ClickHouse/ClickHouse/pull/49600) ([Azat Khuzhin](https://github.com/azat)). Теперь она сопоставима с реализацией на C++.
* Оптимизирована структура таблицы `system.opentelemetry_span_log`. Используйте `LowCardinality`, где это уместно. Хотя эта таблица в целом довольно неудачная (она использует тип данных Map даже для общих атрибутов), так будет немного лучше. [#49647](https://github.com/ClickHouse/ClickHouse/pull/49647) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Теперь выполняется предварительное резервирование размера хеш-таблицы в соединении `grace_hash`. [#49816](https://github.com/ClickHouse/ClickHouse/pull/49816) ([lgbo](https://github.com/lgbo-ustc)).
* Параллельное слияние состояний `uniqExactIf`. Закрывает [#49885](https://github.com/ClickHouse/ClickHouse/issues/49885). [#50285](https://github.com/ClickHouse/ClickHouse/pull/50285) ([flynn](https://github.com/ucasfl)).
* Улучшение Keeper: добавлен запрос `CheckNotExists` в Keeper, который повышает производительность реплицируемых таблиц. [#48897](https://github.com/ClickHouse/ClickHouse/pull/48897) ([Antonio Andelic](https://github.com/antonio2368)).
* Улучшения производительности Keeper: избежать повторной сериализации одного и того же запроса при обработке. Кэшировать результаты десериализации больших запросов. Управляется новым параметром координации `min_request_size_for_cache`. [#49004](https://github.com/ClickHouse/ClickHouse/pull/49004) ([Antonio Andelic](https://github.com/antonio2368)).
* Снижено количество запросов `List` к ZooKeeper при выборе частей для слияния, если многие партиции не содержат данных для слияния. [#49637](https://github.com/ClickHouse/ClickHouse/pull/49637) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Переработан механизм блокировок кэша файловой системы [#44985](https://github.com/ClickHouse/ClickHouse/pull/44985) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отключает режим полностью параллельных реплик, если возможна тривиальная оптимизация `count`. [#50594](https://github.com/ClickHouse/ClickHouse/pull/50594) ([Raúl Marín](https://github.com/Algunenano)).
* Не отправлять HEAD‑запрос для всех ключей при выводе схемы Iceberg, а только для ключей, которые используются для чтения данных. [#50203](https://github.com/ClickHouse/ClickHouse/pull/50203) ([Kruglov Pavel](https://github.com/Avogar)).
* Настройка `enable_memory_bound_merging_of_aggregation_results` включена по умолчанию. [#50319](https://github.com/ClickHouse/ClickHouse/pull/50319) ([Nikita Taranov](https://github.com/nickitat)).

#### Экспериментальная возможность {#experimental-feature-4}

* Кодек `DEFLATE_QPL` снижает минимальную требуемую версию SIMD до SSE 4.2. [изменение документации в qpl](https://github.com/intel/qpl/commit/3f8f5cea27739f5261e8fd577dc233ffe88bf679) – Intel® QPL использует диспетчер ядер, работающий во время выполнения, и проверку CPUID для выбора наилучшей доступной реализации (SSE/AVX2/AVX512); переработан CMake-файл для сборки qpl в ClickHouse в соответствии с последней версией upstream qpl. [#49811](https://github.com/ClickHouse/ClickHouse/pull/49811) ([jasperzhu](https://github.com/jinjunzh)).
* Добавлена начальная поддержка выполнения JOIN с чисто параллельными репликами. [#49544](https://github.com/ClickHouse/ClickHouse/pull/49544) ([Raúl Marín](https://github.com/Algunenano)).
* Больше параллелизма при удалении устаревших частей с использованием "zero-copy replication". [#49630](https://github.com/ClickHouse/ClickHouse/pull/49630) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Параллельные реплики: 1) Исправлена ошибка `NOT_FOUND_COLUMN_IN_BLOCK` при использовании параллельных реплик с нереплицируемым хранилищем и отключённой настройкой `parallel_replicas_for_non_replicated_merge_tree`. 2) Теперь `allow_experimental_parallel_reading_from_replicas` может принимать 3 значения — 0, 1 и 2. 0 — отключено, 1 — включено, при сбое они тихо отключаются (в случае FINAL или JOIN), 2 — включено, при сбое выбрасывается исключение. 3) Если модификатор FINAL используется в запросе SELECT и параллельные реплики включены, ClickHouse попытается их отключить, если `allow_experimental_parallel_reading_from_replicas` установлено в 1, и выбросит исключение в противном случае. [#50195](https://github.com/ClickHouse/ClickHouse/pull/50195) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Когда параллельные реплики включены, они всегда будут пропускать недоступные серверы (поведение контролируется настройкой `skip_unavailable_shards`, которая по умолчанию включена и может быть только отключена). Это закрывает: [#48565](https://github.com/ClickHouse/ClickHouse/issues/48565). [#50293](https://github.com/ClickHouse/ClickHouse/pull/50293) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).

#### Улучшения {#improvement-7}

* Команда `BACKUP` не расшифровывает данные с зашифрованных дисков при создании резервной копии. Вместо этого данные сохраняются в резервной копии в зашифрованном виде. Такие резервные копии можно восстановить только на зашифрованный диск с тем же (или расширенным) списком ключей шифрования. [#48896](https://github.com/ClickHouse/ClickHouse/pull/48896) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена возможность использовать временные таблицы в предложении FROM операторов ATTACH PARTITION FROM и REPLACE PARTITION FROM. [#49436](https://github.com/ClickHouse/ClickHouse/pull/49436) ([Roman Vasin](https://github.com/rvasin)).
* Добавлена настройка `async_insert` для таблиц `MergeTree`. Она имеет тот же смысл, что и настройка уровня запроса `async_insert`, и включает асинхронные вставки для конкретной таблицы. Примечание: она не влияет на запросы вставки из `clickhouse-client`, в этом случае используйте настройку уровня запроса. [#49122](https://github.com/ClickHouse/ClickHouse/pull/49122) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена поддержка суффиксов размера в параметрах оператора CREATE QUOTA. [#49087](https://github.com/ClickHouse/ClickHouse/pull/49087) ([Eridanus](https://github.com/Eridanus117)).
* Добавлена поддержка значения NULL в функциях `first_value` и `last_value`. [#46467](https://github.com/ClickHouse/ClickHouse/pull/46467) ([lgbo](https://github.com/lgbo-ustc)).
* Добавлены алиасы `str_to_map` и `mapFromString` для `extractKeyValuePairs`. Закрывает [https://github.com/clickhouse/clickhouse/issues/47185](https://github.com/clickhouse/clickhouse/issues/47185). [#49466](https://github.com/ClickHouse/ClickHouse/pull/49466) ([flynn](https://github.com/ucasfl)).
* Добавлена поддержка CGroup версии 2 для асинхронных метрик по использованию и доступности памяти. Тем самым закрывается [#37983](https://github.com/ClickHouse/ClickHouse/issues/37983). [#45999](https://github.com/ClickHouse/ClickHouse/pull/45999) ([sichenzhao](https://github.com/sichenzhao)).
* Табличные функции cluster теперь всегда пропускают недоступные сегменты; закрывает [#46314](https://github.com/ClickHouse/ClickHouse/issues/46314). [#46765](https://github.com/ClickHouse/ClickHouse/pull/46765) ([zk&#95;kiger](https://github.com/zk-kiger)).
* Разрешить пустые столбцы в заголовке CSV‑файла. [#47496](https://github.com/ClickHouse/ClickHouse/pull/47496) ([你不要过来啊](https://github.com/iiiuwioajdks)).
* Добавлена табличная функция `gcs` для Google Cloud Storage, совместимого с S3. Как и функции `oss` и `cosn`, она является всего лишь псевдонимом для табличной функции `s3` и не добавляет новых возможностей. [#47815](https://github.com/ClickHouse/ClickHouse/pull/47815) ([Kuba Kaflik](https://github.com/jkaflik)).
* Добавлена возможность использовать строгий размер частей для S3 (совместимость с хранилищем Cloudflare R2 S3). [#48492](https://github.com/ClickHouse/ClickHouse/pull/48492) ([Azat Khuzhin](https://github.com/azat)).
* Добавлены новые столбцы с информацией о репликах базы данных `Replicated` в таблицу `system.clusters`: `database_shard_name`, `database_replica_name`, `is_active`. Добавлено необязательное предложение `FROM SHARD` к запросу `SYSTEM DROP DATABASE REPLICA`. [#48548](https://github.com/ClickHouse/ClickHouse/pull/48548) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Добавлен новый столбец `zookeeper_name` в таблицу system.replicas, указывающий, в каком (дополнительном) кластере ZooKeeper хранятся метаданные реплицированной таблицы. [#48549](https://github.com/ClickHouse/ClickHouse/pull/48549) ([cangyin](https://github.com/cangyin)).
* Оператор `IN` теперь поддерживает сравнение значений типов `Date` и `Date32`. Закрывает [#48736](https://github.com/ClickHouse/ClickHouse/issues/48736). [#48806](https://github.com/ClickHouse/ClickHouse/pull/48806) ([flynn](https://github.com/ucasfl)).
* Поддержка стирающих кодов в `HDFS`, авторы: @M1eyu2018, @tomscut. [#48833](https://github.com/ClickHouse/ClickHouse/pull/48833) ([M1eyu](https://github.com/M1eyu2018)).
* Реализована команда `SYSTEM DROP REPLICA` для вспомогательных кластеров ZooKeeper, что может закрыть [#48931](https://github.com/ClickHouse/ClickHouse/issues/48931). [#48932](https://github.com/ClickHouse/ClickHouse/pull/48932) ([wangxiaobo](https://github.com/wzb5212)).
* Добавлен тип данных Array для MongoDB. Закрывает [#48598](https://github.com/ClickHouse/ClickHouse/issues/48598). [#48983](https://github.com/ClickHouse/ClickHouse/pull/48983) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена поддержка хранения типов данных `Interval` в таблицах. [#49085](https://github.com/ClickHouse/ClickHouse/pull/49085) ([larryluogit](https://github.com/larryluogit)).
* Теперь можно использовать оконную функцию `ntile` без явного задания рамки окна: `ntile(3) OVER (ORDER BY a)`, закрыта задача [#46763](https://github.com/ClickHouse/ClickHouse/issues/46763). [#49093](https://github.com/ClickHouse/ClickHouse/pull/49093) ([vdimir](https://github.com/vdimir)).
* Добавлены настройки (`number_of_mutations_to_delay`, `number_of_mutations_to_throw`) для задержки или отклонения запросов `ALTER`, которые создают мутации (`ALTER UPDATE`, `ALTER DELETE`, `ALTER MODIFY COLUMN`, ...), в случае, если в таблице уже есть много незавершённых мутаций. [#49117](https://github.com/ClickHouse/ClickHouse/pull/49117) ([Anton Popov](https://github.com/CurtizJ)).
* Перехватывать исключение из `create_directories` в файловом кэше. [#49203](https://github.com/ClickHouse/ClickHouse/pull/49203) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Копирует встроенные примеры в новое поле `example` таблицы `system.functions`, дополняя поле `description`. [#49222](https://github.com/ClickHouse/ClickHouse/pull/49222) ([Dan Roscigno](https://github.com/DanRoscigno)).
* Добавлены параметры подключения для словаря MongoDB. Пример: `xml <source> <mongodb> <host>localhost</host> <port>27017</port> <user></user> <password></password> <db>test</db> <collection>dictionary_source</collection> <options>ssl=true</options> </mongodb> </source>` ### Запись в документации об изменениях, заметных пользователям. [#49225](https://github.com/ClickHouse/ClickHouse/pull/49225) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Добавлен псевдоним `asymptotic` для вычислительного метода `asymp` в функции `kolmogorovSmirnovTest`. Улучшена документация. [#49286](https://github.com/ClickHouse/ClickHouse/pull/49286) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Агрегатные функции groupBitAnd/Or/Xor теперь работают с данными знаковых целочисленных типов. Это делает их поведение согласованным с поведением скалярных функций bitAnd/Or/Xor. [#49292](https://github.com/ClickHouse/ClickHouse/pull/49292) ([exmy](https://github.com/exmy)).
* Документация по функциям разбита на более мелкие поля. [#49300](https://github.com/ClickHouse/ClickHouse/pull/49300) ([Robert Schulze](https://github.com/rschu1ze)).
* Используйте несколько потоков, общих для всех таблиц на сервере, для загрузки устаревших частей данных. Размер пула и его очереди управляется настройками `max_outdated_parts_loading_thread_pool_size` и `outdated_part_loading_thread_pool_queue_size`. [#49317](https://github.com/ClickHouse/ClickHouse/pull/49317) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Больше не завышается оценка размера обработанных данных для столбцов `LowCardinality`, когда они используют общие словари между блоками. Это закрывает [#49322](https://github.com/ClickHouse/ClickHouse/issues/49322). См. также [#48745](https://github.com/ClickHouse/ClickHouse/issues/48745). [#49323](https://github.com/ClickHouse/ClickHouse/pull/49323) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Parquet writer теперь использует оптимальный размер группы строк при вызове через `OUTFILE`. [#49325](https://github.com/ClickHouse/ClickHouse/pull/49325) ([Michael Kolupaev](https://github.com/al13n321)).
* Разрешено использовать ограниченные ключевые слова, такие как `ARRAY`, в качестве псевдонима, если он заключён в кавычки. Исправлена проблема [#49324](https://github.com/ClickHouse/ClickHouse/issues/49324). [#49360](https://github.com/ClickHouse/ClickHouse/pull/49360) ([Nikolay Degterinsky](https://github.com/evillique)).
* Задачи загрузки и удаления частей данных были перенесены в общие серверные пулы вместо отдельных пулов для каждой таблицы. Размеры пулов управляются настройками `max_active_parts_loading_thread_pool_size`, `max_outdated_parts_loading_thread_pool_size` и `max_parts_cleaning_thread_pool_size` в конфигурации верхнего уровня. Настройки на уровне таблицы `max_part_loading_threads` и `max_part_removal_threads` признаны устаревшими. [#49474](https://github.com/ClickHouse/ClickHouse/pull/49474) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Разрешено использование `?password=pass` в URL-адресе интерфейса Play. Пароль подменяется в истории браузера. [#49505](https://github.com/ClickHouse/ClickHouse/pull/49505) ([Mike Kot](https://github.com/myrrc)).
* Разрешено чтение объектов с нулевым размером из удалённых файловых систем (так как пустые файлы не попадают в резервную копию, в результате в файле метаданных могут оказаться блобы нулевого размера). Закрывает [#49480](https://github.com/ClickHouse/ClickHouse/issues/49480). [#49519](https://github.com/ClickHouse/ClickHouse/pull/49519) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Присоединять трекер памяти потока `MemoryTracker` к `total_memory_tracker` после отсоединения `ThreadGroup`. [#49527](https://github.com/ClickHouse/ClickHouse/pull/49527) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена работа параметризованных представлений, когда параметр запроса используется несколько раз в запросе. [#49556](https://github.com/ClickHouse/ClickHouse/pull/49556) ([Azat Khuzhin](https://github.com/azat)).
* Освобождает память, выделенную под последний отправленный снимок ProfileEvents в рамках запроса. Продолжение [#47564](https://github.com/ClickHouse/ClickHouse/issues/47564). [#49561](https://github.com/ClickHouse/ClickHouse/pull/49561) ([Dmitry Novik](https://github.com/novikd)).
* Функция `makeDate` теперь поддерживает MySQL-совместимую перегрузку (аргументы: год и день года). [#49603](https://github.com/ClickHouse/ClickHouse/pull/49603) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка табличной функции `dictionary` для `RegExpTreeDictionary`. [#49666](https://github.com/ClickHouse/ClickHouse/pull/49666) ([Han Fei](https://github.com/hanfei1991)).
* Добавлена политика планирования ввода-вывода с взвешенным справедливым распределением. Добавлен динамический менеджер ресурсов, который позволяет обновлять иерархию планирования ввода-вывода во время работы без перезапуска сервера. [#49671](https://github.com/ClickHouse/ClickHouse/pull/49671) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлен запрос compose после multipart-загрузки в GCS. Это позволяет использовать операцию копирования для объектов, загруженных с помощью multipart-загрузки. Рекомендуется установить `s3_strict_upload_part_size` в конкретное значение, потому что запрос compose может завершиться неудачей для объектов, собранных из частей разного размера. [#49693](https://github.com/ClickHouse/ClickHouse/pull/49693) ([Antonio Andelic](https://github.com/antonio2368)).
* Для функции `extractKeyValuePairs`: улучшена логика парсинга по принципу «best effort», чтобы допускать `key_value_delimiter` как часть значения. Это также упрощает ветвление и может немного ускорить работу. [#49760](https://github.com/ClickHouse/ClickHouse/pull/49760) ([Arthur Passos](https://github.com/arthurpassos)).
* Добавлено поле `initial_query_id` в system.processors&#95;profile&#95;log [#49777](https://github.com/ClickHouse/ClickHouse/pull/49777) ([helifu](https://github.com/helifu)).
* Теперь для таблиц системных журналов можно задавать пользовательские ключи сортировки. [#49778](https://github.com/ClickHouse/ClickHouse/pull/49778) ([helifu](https://github.com/helifu)).
* Новое поле `partitions` в `system.query_log` используется для указания, какие партиции участвуют в вычислениях. [#49779](https://github.com/ClickHouse/ClickHouse/pull/49779) ([helifu](https://github.com/helifu)).
* Добавлена настройка `enable_the_endpoint_id_with_zookeeper_name_prefix` для `ReplicatedMergeTree` (по умолчанию отключена). При включении она добавляет имя кластера ZooKeeper к межсерверной точке взаимодействия таблицы. Это позволяет избежать ошибок `Duplicate interserver IO endpoint` при наличии реплицируемых таблиц с одинаковым путём, но разными вспомогательными кластерами ZooKeeper. [#49780](https://github.com/ClickHouse/ClickHouse/pull/49780) ([helifu](https://github.com/helifu)).
* Добавлена поддержка параметров запроса в `clickhouse-local`. Закрывает [#46561](https://github.com/ClickHouse/ClickHouse/issues/46561). [#49785](https://github.com/ClickHouse/ClickHouse/pull/49785) ([Nikolay Degterinsky](https://github.com/evillique)).
* Теперь по умолчанию разрешена загрузка словарей и функций из файлов YAML. В предыдущих версиях для этого требовалось отредактировать `dictionaries_config` или `user_defined_executable_functions_config` в конфигурационном файле, так как они ожидали файлы `*.xml`. [#49812](https://github.com/ClickHouse/ClickHouse/pull/49812) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Движок таблицы Kafka теперь позволяет использовать столбцы-псевдонимы. [#49824](https://github.com/ClickHouse/ClickHouse/pull/49824) ([Aleksandr Musorin](https://github.com/AVMusorin)).
* Добавлена настройка, ограничивающая максимальное количество пар, создаваемых `extractKeyValuePairs`, чтобы предотвратить чрезмерное потребление памяти. [#49836](https://github.com/ClickHouse/ClickHouse/pull/49836) ([Arthur Passos](https://github.com/arthurpassos)).
* Добавлена поддержка (необычного) случая, когда аргументы оператора `IN` — одноэлементные кортежи. [#49844](https://github.com/ClickHouse/ClickHouse/pull/49844) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Теперь функция `bitHammingDistance` поддерживает типы данных `String` и `FixedString`. Закрывает [#48827](https://github.com/ClickHouse/ClickHouse/issues/48827). [#49858](https://github.com/ClickHouse/ClickHouse/pull/49858) ([flynn](https://github.com/ucasfl)).
* Исправлены ошибки сброса таймаутов в клиенте под OS X. [#49863](https://github.com/ClickHouse/ClickHouse/pull/49863) ([alekar](https://github.com/alekar)).
* Добавлена поддержка больших целых чисел, таких, как UInt128, Int128, UInt256 и Int256, в функции `bitCount`. Это позволяет вычислять расстояние Хэмминга над большими битовыми масками в AI-приложениях. [#49867](https://github.com/ClickHouse/ClickHouse/pull/49867) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Отпечатки, используемые вместо идентификаторов ключей в зашифрованных дисках. Это упрощает конфигурацию зашифрованных дисков. [#49882](https://github.com/ClickHouse/ClickHouse/pull/49882) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлен тип данных UUID для PostgreSQL. Закрывает [#49739](https://github.com/ClickHouse/ClickHouse/issues/49739). [#49894](https://github.com/ClickHouse/ClickHouse/pull/49894) ([Nikolay Degterinsky](https://github.com/evillique)).
* Функция `toUnixTimestamp` теперь принимает аргументы типов `Date` и `Date32`. [#49989](https://github.com/ClickHouse/ClickHouse/pull/49989) ([Victor Krasnov](https://github.com/sirvickr)).
* Учитывать для словарей только память сервера. [#49995](https://github.com/ClickHouse/ClickHouse/pull/49995) ([Azat Khuzhin](https://github.com/azat)).
* Сервер будет допускать использование настроек `SQL_*`, таких как `SQL_AUTO_IS_NULL`, которые не выполняют никаких действий (no-op), для совместимости с MySQL. Это закрывает задачу [#49927](https://github.com/ClickHouse/ClickHouse/issues/49927). [#50013](https://github.com/ClickHouse/ClickHouse/pull/50013) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сохранять initial&#95;query&#95;id для запросов ON CLUSTER, что полезно при интроспекции (при `distributed_ddl_entry_format_version=5`). [#50015](https://github.com/ClickHouse/ClickHouse/pull/50015) ([Azat Khuzhin](https://github.com/azat)).
* Сохранена обратная совместимость для переименованных настроек с помощью алиасов (`allow_experimental_projection_optimization` для `optimize_use_projections`, `allow_experimental_lightweight_delete` для `enable_lightweight_delete`). [#50044](https://github.com/ClickHouse/ClickHouse/pull/50044) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка передачи FQDN через настройку my&#95;hostname, чтобы регистрировать узел кластера в Keeper. Добавлена настройка invisible для поддержки нескольких групп вычислительных ресурсов (compute groups). Группа вычислительных ресурсов как кластер невидима для других compute-групп. [#50186](https://github.com/ClickHouse/ClickHouse/pull/50186) ([Yangkuan Liu](https://github.com/LiuYangkuan)).
* Исправлена проблема в PostgreSQL: считывались все данные, даже если был указан `LIMIT n`. [#50187](https://github.com/ClickHouse/ClickHouse/pull/50187) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлены новые события профилирования для запросов с подзапросами (`QueriesWithSubqueries`/`SelectQueriesWithSubqueries`/`InsertQueriesWithSubqueries`). [#50204](https://github.com/ClickHouse/ClickHouse/pull/50204) ([Azat Khuzhin](https://github.com/azat)).
* Добавлено поле roles в файл users.xml, позволяющее задавать роли с грантами через конфигурационный файл. [#50278](https://github.com/ClickHouse/ClickHouse/pull/50278) ([pufit](https://github.com/pufit)).
* Сообщать `CGroupCpuCfsPeriod` и `CGroupCpuCfsQuota` в AsynchronousMetrics. Учитывать ограничения памяти cgroup v2 во время запуска сервера. [#50379](https://github.com/ClickHouse/ClickHouse/pull/50379) ([alekar](https://github.com/alekar)).
* Добавлен обработчик сигнала SIGQUIT, работающий так же, как SIGINT. Закрыта задача [#50298](https://github.com/ClickHouse/ClickHouse/issues/50298). [#50435](https://github.com/ClickHouse/ClickHouse/pull/50435) ([Nikolay Degterinsky](https://github.com/evillique)).
* При ошибке разбора JSON, вызванной слишком большим размером объекта, выводить последнюю позицию для упрощения отладки. [#50474](https://github.com/ClickHouse/ClickHouse/pull/50474) ([Valentin Alexeev](https://github.com/valentinalexeev)).
* Добавлена поддержка десятичных чисел переменного размера. Закрывает [#49130](https://github.com/ClickHouse/ClickHouse/issues/49130). [#50586](https://github.com/ClickHouse/ClickHouse/pull/50586) ([Kruglov Pavel](https://github.com/Avogar)).

#### Улучшения в сборке, тестировании и упаковке {#buildtestingpackaging-improvement-7}

* Новый и улучшенный `keeper-bench`. Всё можно настраивать из YAML/XML-файла: - генератор запросов — каждый тип генератора запросов может иметь свой набор полей - несколько запросов можно генерировать, просто описав то же самое под ключом `multi` - для каждого запроса или подзапроса в `multi` можно задать поле `weight` для управления распределением - можно задать деревья, которые нужно подготовить для тестового прогона - хосты можно определять с полностью настраиваемыми таймаутами; можно управлять количеством сессий, создаваемых для каждого хоста - целые числа, заданные полями `min_value` и `max_value`, являются генераторами случайных чисел. [#48547](https://github.com/ClickHouse/ClickHouse/pull/48547) ([Antonio Andelic](https://github.com/antonio2368)).
* Io&#95;uring не поддерживается на macOS, не выбирайте его при локальном запуске тестов, чтобы избежать случайных сбоев. [#49250](https://github.com/ClickHouse/ClickHouse/pull/49250) ([Frank Chen](https://github.com/FrankChen021)).
* Добавлена поддержка именованного внедрения сбоев для тестирования. [#49361](https://github.com/ClickHouse/ClickHouse/pull/49361) ([Han Fei](https://github.com/hanfei1991)).
* Теперь можно запускать ClickHouse в операционных системах, где системный вызов `prctl` (process control) недоступен, например в AWS Lambda. [#49538](https://github.com/ClickHouse/ClickHouse/pull/49538) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлен конфликт при сборке между contrib/isa-l и isa-l в qpl [49296](https://github.com/ClickHouse/ClickHouse/issues/49296). [#49584](https://github.com/ClickHouse/ClickHouse/pull/49584) ([jasperzhu](https://github.com/jinjunzh)).
* Утилиты теперь собираются только при явном указании параметра (&quot;-DENABLE&#95;UTILS=1&quot;), а не по умолчанию, что уменьшает время компоновки в типичных сборках для разработки. [#49620](https://github.com/ClickHouse/ClickHouse/pull/49620) ([Robert Schulze](https://github.com/rschu1ze)).
* Вынесено описание сборки idxd-config в отдельный файл CMake, чтобы избежать его случайного удаления в будущем. [#49651](https://github.com/ClickHouse/ClickHouse/pull/49651) ([jasperzhu](https://github.com/jinjunzh)).
* Добавлена проверка CI с включённым анализатором в ветке master. Продолжение [#49562](https://github.com/ClickHouse/ClickHouse/issues/49562). [#49668](https://github.com/ClickHouse/ClickHouse/pull/49668) ([Dmitry Novik](https://github.com/novikd)).
* Переход на LLVM/clang 16. [#49678](https://github.com/ClickHouse/ClickHouse/pull/49678) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена возможность сборки ClickHouse с помощью clang-17. [#49851](https://github.com/ClickHouse/ClickHouse/pull/49851) ([Alexey Milovidov](https://github.com/alexey-milovidov)). [#50410](https://github.com/ClickHouse/ClickHouse/pull/50410) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* ClickHouse теперь проще интегрировать в другие CMake-проекты. [#49991](https://github.com/ClickHouse/ClickHouse/pull/49991) ([Amos Bird](https://github.com/amosbird)). (Что настоятельно не рекомендуется — Alexey Milovidov).
* Исправлено странное дополнительное логирование QEMU после [#47151](https://github.com/ClickHouse/ClickHouse/issues/47151), см. [https://s3.amazonaws.com/clickhouse-test-reports/50078/a4743996ee4f3583884d07bcd6501df0cfdaa346/stateless&#95;tests&#95;&#95;release&#95;&#95;databasereplicated&#95;&#95;[3&#95;4].html](https://s3.amazonaws.com/clickhouse-test-reports/50078/a4743996ee4f3583884d07bcd6501df0cfdaa346/stateless_tests__release__databasereplicated__\[3_4].html). [#50442](https://github.com/ClickHouse/ClickHouse/pull/50442) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* В ClickHouse добавлена поддержка Linux RISC-V 6.1.22. Что закрывает [#50456](https://github.com/ClickHouse/ClickHouse/issues/50456). [#50457](https://github.com/ClickHouse/ClickHouse/pull/50457) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Обновлена внутренняя библиотека protobuf до v3.18 (исправляет ошибочно обозначенную уязвимость CVE-2022-1941). [#50400](https://github.com/ClickHouse/ClickHouse/pull/50400) ([Robert Schulze](https://github.com/rschu1ze)).
* Обновлена внутренняя версия libxml2 до v2.10.4 (исправляет ошибочно заявленные уязвимости CVE-2023-28484 и CVE-2023-29469). [#50402](https://github.com/ClickHouse/ClickHouse/pull/50402) ([Robert Schulze](https://github.com/rschu1ze)).
* Обновлён c-ares до версии v1.19.1 (фиктивные CVE-2023-32067, CVE-2023-31130, CVE-2023-31147). [#50403](https://github.com/ClickHouse/ClickHouse/pull/50403) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена ошибочная запись об уязвимости CVE-2022-2469 в libgsasl. [#50404](https://github.com/ClickHouse/ClickHouse/pull/50404) ([Robert Schulze](https://github.com/rschu1ze)).

#### Исправление ошибки (ошибочное поведение, заметное пользователям, в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-7}

* ActionsDAG: исправлена ошибочная оптимизация [#47584](https://github.com/ClickHouse/ClickHouse/pull/47584) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Корректная обработка параллельных снимков в Keeper [#48466](https://github.com/ClickHouse/ClickHouse/pull/48466) ([Antonio Andelic](https://github.com/antonio2368)).
* MergeTreeMarksLoader теперь содержит DataPart вместо DataPartStorage [#48515](https://github.com/ClickHouse/ClickHouse/pull/48515) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправление состояния последовательности [#48603](https://github.com/ClickHouse/ClickHouse/pull/48603) ([Ilya Golshtein](https://github.com/ilejn)).
* Проверка конкурентного выполнения BACKUP/RESTORE с учётом предыдущих неудачных запусков [#48726](https://github.com/ClickHouse/ClickHouse/pull/48726) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлена ошибка: при присоединении таблицы с несуществующим путем в ZK метрика ReadonlyReplica больше не увеличивается [#48954](https://github.com/ClickHouse/ClickHouse/pull/48954) ([wangxiaobo](https://github.com/wzb5212)).
* Исправлена возможная ситуация вызова `terminate` из-за неперехваченного исключения в некоторых местах [#49112](https://github.com/ClickHouse/ClickHouse/pull/49112) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка «key not found» для запросов с несколькими StorageJoin [#49137](https://github.com/ClickHouse/ClickHouse/pull/49137) ([vdimir](https://github.com/vdimir)).
* Исправлен ошибочный результат запроса при использовании первичного ключа Nullable [#49172](https://github.com/ClickHouse/ClickHouse/pull/49172) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлена работа функций reinterpretAs*() на машинах с порядком байт big-endian [#49198](https://github.com/ClickHouse/ClickHouse/pull/49198) ([Suzy Wang](https://github.com/SuzyWangIBMer)).
* (Экспериментальная репликация zero-copy) Более атомарная блокировка частей zero-copy [#49211](https://github.com/ClickHouse/ClickHouse/pull/49211) ([alesapin](https://github.com/alesapin)).
* Исправлена гонка состояний при загрузке устаревших частей [#49223](https://github.com/ClickHouse/ClickHouse/pull/49223) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена ошибка, из-за которой при всех значениях ключей `null` и использовании группировки с `rollup` возвращался неверный результат [#49282](https://github.com/ClickHouse/ClickHouse/pull/49282) ([Shuai li](https://github.com/loneylee)).
* Исправлено вычисление load&#95;factor для HASHED-словарей с сегментами [#49319](https://github.com/ClickHouse/ClickHouse/pull/49319) ([Azat Khuzhin](https://github.com/azat)).
* Запрещена настройка кодеков сжатия для столбцов‑псевдонимов [#49363](https://github.com/ClickHouse/ClickHouse/pull/49363) ([Timur Solodовников](https://github.com/tsolodov)).
* Исправлена ошибка при удалении существующего каталога парта [#49365](https://github.com/ClickHouse/ClickHouse/pull/49365) ([alesapin](https://github.com/alesapin)).
* Исправлена работа GCS при использовании HMAC [#49390](https://github.com/ClickHouse/ClickHouse/pull/49390) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка фаззинга, при которой Set подзапроса не создаётся при чтении из remote() [#49425](https://github.com/ClickHouse/ClickHouse/pull/49425) ([Alexander Gololobov](https://github.com/davenger)).
* Инвертирован `shutdown_wait_unfinished_queries` [#49427](https://github.com/ClickHouse/ClickHouse/pull/49427) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* (Экспериментальная zero-copy репликация) Исправлена ещё одна ошибка zero-copy [#49473](https://github.com/ClickHouse/ClickHouse/pull/49473) ([alesapin](https://github.com/alesapin)).
* Исправлена настройка базы данных Postgres [#49481](https://github.com/ClickHouse/ClickHouse/pull/49481) ([Mal Curtis](https://github.com/snikch)).
* Исправлена обработка аргументов `s3Cluster` [#49490](https://github.com/ClickHouse/ClickHouse/pull/49490) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка в деструкторе `TraceCollector`. [#49508](https://github.com/ClickHouse/ClickHouse/pull/49508) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена проблема, из-за которой AsynchronousReadIndirectBufferFromRemoteFS ломался при коротких операциях seek [#49525](https://github.com/ClickHouse/ClickHouse/pull/49525) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлен порядок загрузки словарей [#49560](https://github.com/ClickHouse/ClickHouse/pull/49560) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Запрещено изменять тип данных столбца Object(&#39;json&#39;) [#49563](https://github.com/ClickHouse/ClickHouse/pull/49563) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлен стресс‑тест (Logical error: Expected 7134 &gt;= 11030) [#49623](https://github.com/ClickHouse/ClickHouse/pull/49623) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка в DISTINCT [#49628](https://github.com/ClickHouse/ClickHouse/pull/49628) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено: DISTINCT при использовании сортировки с нулевыми значениями в столбцах, не участвующих в сортировке [#49636](https://github.com/ClickHouse/ClickHouse/pull/49636) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлена ошибка на единицу в больших целых числах, обнаруженная UBSan при фаззинге [#49645](https://github.com/ClickHouse/ClickHouse/pull/49645) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено чтение из разреженных столбцов после перезапуска [#49660](https://github.com/ClickHouse/ClickHouse/pull/49660) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена проверка assert в SpanHolder::finish() при использовании файберов [#49673](https://github.com/ClickHouse/ClickHouse/pull/49673) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлены функции с коротким замыканием и мутации с разрежёнными аргументами [#49716](https://github.com/ClickHouse/ClickHouse/pull/49716) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка записи добавленных файлов в инкрементные бэкапы [#49725](https://github.com/ClickHouse/ClickHouse/pull/49725) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена ошибка &quot;There is no physical column &#95;row&#95;exists in table&quot;, возникающая при выполнении мутации легковесного удаления над таблицей со столбцом типа Object. [#49737](https://github.com/ClickHouse/ClickHouse/pull/49737) ([Alexander Gololobov](https://github.com/davenger)).
* Исправлена проблема с msan в randomStringUTF8(нечётное число) [#49750](https://github.com/ClickHouse/ClickHouse/pull/49750) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена агрегатная функция kolmogorovSmirnovTest [#49768](https://github.com/ClickHouse/ClickHouse/pull/49768) ([FFFFFFFHHHHHHH](https://github.com/FFFFFFFHHHHHHH)).
* Исправлены алиасы настроек в нативном протоколе [#49776](https://github.com/ClickHouse/ClickHouse/pull/49776) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа `arrayMap` с массивом кортежей из одного элемента [#49789](https://github.com/ClickHouse/ClickHouse/pull/49789) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены настройки троттлинга IO/BACKUP на уровне запроса [#49797](https://github.com/ClickHouse/ClickHouse/pull/49797) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена установка значения NULL в определении профиля [#49831](https://github.com/ClickHouse/ClickHouse/pull/49831) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена ошибка при работе с проекциями и настройкой aggregate&#95;functions&#95;null&#95;for&#95;empty (для query&#95;plan&#95;optimize&#95;projection) [#49873](https://github.com/ClickHouse/ClickHouse/pull/49873) ([Amos Bird](https://github.com/amosbird)).
* Исправлена обработка ожидающего пакета для асинхронного `INSERT` в таблицу `Distributed` после перезапуска [#49884](https://github.com/ClickHouse/ClickHouse/pull/49884) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проверка assert в CacheMetadata::doCleanup [#49914](https://github.com/ClickHouse/ClickHouse/pull/49914) ([Kseniia Sumarokova](https://github.com/kssenii)).
* исправлен `is_prefix` в OptimizeRegularExpression [#49919](https://github.com/ClickHouse/ClickHouse/pull/49919) ([Han Fei](https://github.com/hanfei1991)).
* Исправлены метрики `WriteBufferFromS3Bytes`, `WriteBufferFromS3Microseconds` и `WriteBufferFromS3RequestsErrors` [#49930](https://github.com/ClickHouse/ClickHouse/pull/49930) ([Aleksandr Musorin](https://github.com/AVMusorin)).
* Исправлена ошибка кодирования IPv6 в protobuf [#49933](https://github.com/ClickHouse/ClickHouse/pull/49933) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена возможная логическая ошибка при некорректной обработке Nullable в текстовых форматах [#49960](https://github.com/ClickHouse/ClickHouse/pull/49960) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена настройка output&#95;format&#95;parquet&#95;compliant&#95;nested&#95;types для создания файлов Parquet с лучшей совместимостью [#50001](https://github.com/ClickHouse/ClickHouse/pull/50001) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена логическая ошибка в стресс‑тесте &quot;Not enough space to add ...&quot; [#50021](https://github.com/ClickHouse/ClickHouse/pull/50021) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Устранена взаимоблокировка, возникавшая при запуске таблицы в потоке attach движка `ReplicatedMergeTree` [#50026](https://github.com/ClickHouse/ClickHouse/pull/50026) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлен assert в SpanHolder::finish() при использовании fibers, попытка 2 [#50034](https://github.com/ClickHouse/ClickHouse/pull/50034) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлено корректное экранирование при сериализации контекста OpenTelemetry в DDL [#50045](https://github.com/ClickHouse/ClickHouse/pull/50045) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено сообщение о повреждённых частях PROJECTION [#50052](https://github.com/ClickHouse/ClickHouse/pull/50052) ([Amos Bird](https://github.com/amosbird)).
* Исправление JIT-компиляции операции not equals для NaN [#50056](https://github.com/ClickHouse/ClickHouse/pull/50056) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлен сбой при использовании базы данных Replicated без аргументов [#50058](https://github.com/ClickHouse/ClickHouse/pull/50058) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, приводившая к сбою при использовании `multiIf` с константным условием и Nullable-аргументами [#50123](https://github.com/ClickHouse/ClickHouse/pull/50123) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен некорректный анализ индекса для ключей, связанных с датами [#50153](https://github.com/ClickHouse/ClickHouse/pull/50153) ([Amos Bird](https://github.com/amosbird)).
* не разрешать изменять ORDER BY, если нет столбцов ORDER BY [#50154](https://github.com/ClickHouse/ClickHouse/pull/50154) ([Han Fei](https://github.com/hanfei1991)).
* Исправлен некорректный анализ индекса, если бинарный оператор содержит константный аргумент NULL [#50177](https://github.com/ClickHouse/ClickHouse/pull/50177) ([Amos Bird](https://github.com/amosbird)).
* clickhouse-client: запрещено использовать `--query` и `--queries-file` одновременно [#50210](https://github.com/ClickHouse/ClickHouse/pull/50210) ([Alexey Gerasimchuk](https://github.com/Demilivor)).
* Исправлено неопределённое поведение (UB) в расширениях INTO OUTFILE (APPEND / AND STDOUT) и WATCH EVENTS [#50216](https://github.com/ClickHouse/ClickHouse/pull/50216) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено игнорирование пробелов в конце строки в формате CustomSeparatedIgnoreSpaces [#50224](https://github.com/ClickHouse/ClickHouse/pull/50224) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена обработка метаданных Iceberg [#50232](https://github.com/ClickHouse/ClickHouse/pull/50232) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка во вложенном распределённом SELECT в предложении WITH [#50234](https://github.com/ClickHouse/ClickHouse/pull/50234) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема MSan в keyed siphash [#50245](https://github.com/ClickHouse/ClickHouse/pull/50245) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлены ошибки в сокетах Poco в неблокирующем режиме, теперь используются по-настоящему неблокирующие сокеты [#50252](https://github.com/ClickHouse/ClickHouse/pull/50252) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено вычисление контрольной суммы для записей резервной копии [#50264](https://github.com/ClickHouse/ClickHouse/pull/50264) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправление обработки NaN в функциях сравнения [#50287](https://github.com/ClickHouse/ClickHouse/pull/50287) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправление ошибки с Nullable-ключом в JIT-агрегации [#50291](https://github.com/ClickHouse/ClickHouse/pull/50291) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена ошибка, из-за которой clickhouse-local аварийно завершался при записи пустого вывода Arrow или Parquet [#50328](https://github.com/ClickHouse/ClickHouse/pull/50328) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена ошибка, приводившая к аварийному завершению работы при вызове Pool::Entry::disconnect() [#50334](https://github.com/ClickHouse/ClickHouse/pull/50334) ([Val Doroshchuk](https://github.com/valbok)).
* Улучшена операция fetch part за счёт более длительного удержания блокировки каталога [#50339](https://github.com/ClickHouse/ClickHouse/pull/50339) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлены функции bitShift* при использовании обоих аргументов как констант [#50343](https://github.com/ClickHouse/ClickHouse/pull/50343) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена взаимоблокировка в Keeper при возникновении исключения во время предварительной обработки запросов. [#50387](https://github.com/ClickHouse/ClickHouse/pull/50387) ([frinkr](https://github.com/frinkr)).
* Исправлено хеширование целочисленных констант [#50421](https://github.com/ClickHouse/ClickHouse/pull/50421) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена работа параметров `merge_tree_min_rows_for_seek` и `merge_tree_min_bytes_for_seek` для индексов пропуска данных [#50432](https://github.com/ClickHouse/ClickHouse/pull/50432) ([Azat Khuzhin](https://github.com/azat)).
* Ограничено количество одновременно выполняющихся задач по загрузке устаревших частей [#50450](https://github.com/ClickHouse/ClickHouse/pull/50450) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправление Keeper: применять незакоммиченное состояние после установки снимка [#50483](https://github.com/ClickHouse/ClickHouse/pull/50483) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено неправильное свёртывание констант [#50536](https://github.com/ClickHouse/ClickHouse/pull/50536) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена логическая ошибка в стресс‑тесте (Not enough space to add ...) [#50583](https://github.com/ClickHouse/ClickHouse/pull/50583) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено преобразование Null в LowCardinality(Nullable) при использовании табличной функции values [#50637](https://github.com/ClickHouse/ClickHouse/pull/50637) ([Kruglov Pavel](https://github.com/Avogar)).
* Откатили некорректную оптимизацию RegExpTreeDictionary [#50642](https://github.com/ClickHouse/ClickHouse/pull/50642) ([Johann Gan](https://github.com/johanngan)).

### <a id="234"></a> Релиз ClickHouse 23.4 от 2023-04-26. [Презентация](https://presentations.clickhouse.com/2023-release-23.4/), [Видео](https://www.youtube.com/watch?v=4rrf6bk_mOg) {#234}

<iframe width="1024" height="576" src="https://www.youtube.com/embed/4rrf6bk_mOg" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

#### Обратные несовместимые изменения {#backward-incompatible-change-7}

* Форматтер `%M` в функции `formatDateTime()` теперь выводит название месяца вместо минут. Это делает поведение согласованным с MySQL. Предыдущее поведение можно восстановить с помощью настройки `formatdatetime_parsedatetime_m_is_month_name = 0`. [#47246](https://github.com/ClickHouse/ClickHouse/pull/47246) ([Robert Schulze](https://github.com/rschu1ze)).
* Это изменение имеет смысл только в том случае, если вы используете кэш виртуальной файловой системы. Если `path` в конфигурации кэша виртуальной файловой системы не пустой и не является абсолютным путём, то он будет размещён в `<clickhouse server data directory>/caches/<path_from_cache_config>`. [#48784](https://github.com/ClickHouse/ClickHouse/pull/48784) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Первичные/вторичные индексы и ключи сортировки с идентичными выражениями теперь отклоняются. Это поведение можно отключить с помощью настройки `allow_suspicious_indices`. [#48536](https://github.com/ClickHouse/ClickHouse/pull/48536) ([凌涛](https://github.com/lingtaolf)).

#### Новые возможности {#new-feature-8}

* Добавлена поддержка новой агрегатной функции `quantileGK`/`quantilesGK`, аналогичной функции [approx&#95;percentile](https://spark.apache.org/docs/latest/api/sql/index.html#approx_percentile) в Spark. Алгоритм Гринвальда–Ханны описан в статье [http://infolab.stanford.edu/~datar/courses/cs361a/papers/quantiles.pdf](http://infolab.stanford.edu/~datar/courses/cs361a/papers/quantiles.pdf). [#46428](https://github.com/ClickHouse/ClickHouse/pull/46428) ([李扬](https://github.com/taiyang-li)).
* Добавлен оператор `SHOW COLUMNS`, который выводит сводную информацию из system.columns. [#48017](https://github.com/ClickHouse/ClickHouse/pull/48017) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлены модификаторы `LIGHTWEIGHT` и `PULL` для запроса `SYSTEM SYNC REPLICA`. Версия `LIGHTWEIGHT` ожидает только завершения загрузок и drop-ranges (слияния и мутации игнорируются). Версия `PULL` загружает новые записи из ZooKeeper и не ждёт их обработки. Исправляет [#47794](https://github.com/ClickHouse/ClickHouse/issues/47794). [#48085](https://github.com/ClickHouse/ClickHouse/pull/48085) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Добавлена функция `kafkaMurmurHash` для обеспечения совместимости с Kafka DefaultPartitioner. Закрывает [#47834](https://github.com/ClickHouse/ClickHouse/issues/47834). [#48185](https://github.com/ClickHouse/ClickHouse/pull/48185) ([Nikolay Degterinsky](https://github.com/evillique)).
* Теперь можно легко создать пользователя с теми же правами, что и у текущего пользователя, с помощью `GRANT CURRENT GRANTS`. [#48262](https://github.com/ClickHouse/ClickHouse/pull/48262) ([pufit](https://github.com/pufit)).
* Добавлена статистическая агрегатная функция `kolmogorovSmirnovTest`. Закрыта задача [#48228](https://github.com/ClickHouse/ClickHouse/issues/48228). [#48325](https://github.com/ClickHouse/ClickHouse/pull/48325) ([FFFFFFFHHHHHHH](https://github.com/FFFFFFFHHHHHHH)).
* В таблицу `system.replicas` добавлен столбец `lost_part_count`. Значение столбца показывает общее количество потерянных частей в соответствующей таблице. Значение хранится в ZooKeeper и может использоваться вместо неперсистентного события профилирования `ReplicatedDataLoss` для мониторинга. [#48526](https://github.com/ClickHouse/ClickHouse/pull/48526) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена функция `soundex` для совместимости. Закрывает [#39880](https://github.com/ClickHouse/ClickHouse/issues/39880). [#48567](https://github.com/ClickHouse/ClickHouse/pull/48567) ([FriendLey](https://github.com/FriendLey)).
* Добавлена поддержка типа `Map` в JSONExtract. [#48629](https://github.com/ClickHouse/ClickHouse/pull/48629) ([李扬](https://github.com/taiyang-li)).
* Добавлен формат `PrettyJSONEachRow` для вывода читабельного JSON с разделением строк и отступами в 4 пробела. [#48898](https://github.com/ClickHouse/ClickHouse/pull/48898) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен формат входных данных `ParquetMetadata` для чтения метаданных файлов Parquet. [#48911](https://github.com/ClickHouse/ClickHouse/pull/48911) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена функция `extractKeyValuePairs` для извлечения пар ключ–значение из строк. Входные строки могут содержать шум (например, файлы логов / не обязаны быть на 100% отформатированы в виде пар ключ–значение), алгоритм будет искать пары ключ–значение, соответствующие переданным в функцию аргументам. В настоящее время функция принимает следующие аргументы: `data_column` (обязательный), `key_value_pair_delimiter` (по умолчанию `:`), `pair_delimiters` (по умолчанию `\space \, \;`) и `quoting_character` (по умолчанию двойные кавычки). [#43606](https://github.com/ClickHouse/ClickHouse/pull/43606) ([Arthur Passos](https://github.com/arthurpassos)).
* Функции replaceOne(), replaceAll(), replaceRegexpOne() и replaceRegexpAll() теперь могут вызываться с неконстантными аргументами шаблона и замены. [#46589](https://github.com/ClickHouse/ClickHouse/pull/46589) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлены функции для работы со столбцами типа `Map`: `mapConcat`, `mapSort`, `mapExists`. [#48071](https://github.com/ClickHouse/ClickHouse/pull/48071) ([Anton Popov](https://github.com/CurtizJ)).

#### Улучшение производительности {#performance-improvement-8}

* Чтение файлов в формате `Parquet` теперь значительно быстрее. IO и декодирование выполняются параллельно (управляется настройкой `max_threads`), и читаются только необходимые диапазоны данных. [#47964](https://github.com/ClickHouse/ClickHouse/pull/47964) ([Michael Kolupaev](https://github.com/al13n321)).
* Если мы запускаем мутацию с IN (подзапросом) следующего вида: `ALTER TABLE t UPDATE col='new value' WHERE id IN (SELECT id FROM huge_table)` и таблица `t` состоит из нескольких частей, то для каждой части в памяти строится set для подзапроса `SELECT id FROM huge_table`. При большом количестве частей это может потреблять много памяти (и приводить к OOM) и процессорного времени. Решение — ввести краткоживущий кеш set-ов, которые в данный момент строятся задачами мутации. Если другая задача той же мутации выполняется параллельно, она может найти set в кеше, дождаться окончания его построения и повторно использовать его. [#46835](https://github.com/ClickHouse/ClickHouse/pull/46835) ([Alexander Gololobov](https://github.com/davenger)).
* Проверять зависимости только при необходимости при применении запросов `ALTER TABLE`. [#48062](https://github.com/ClickHouse/ClickHouse/pull/48062) ([Raúl Marín](https://github.com/Algunenano)).
* Оптимизирована функция `mapUpdate`. [#48118](https://github.com/ClickHouse/ClickHouse/pull/48118) ([Anton Popov](https://github.com/CurtizJ)).
* Теперь внутренний запрос к локальной реплике отправляется явно, а данные из него принимаются через loopback-интерфейс. Настройка `prefer_localhost_replica` не учитывается для параллельных реплик. Это необходимо для более эффективного планирования и делает код чище: инициатор отвечает только за координацию процесса чтения и слияние результатов, постоянно обрабатывая запросы, в то время как все вторичные запросы читают данные. Замечание: использование loopback-интерфейса само по себе менее эффективно по производительности, но без него некоторые реплики могли бы оставаться без задач, что привело бы к ещё более медленному выполнению запроса и неиспользованию всех доступных ресурсов. Инициализация координатора теперь ещё более отложенная. Все входящие запросы содержат информацию об алгоритме чтения, и мы инициализируем координатор с этим алгоритмом при поступлении первого запроса. Если какая-либо реплика решит читать с другим алгоритмом — будет выброшено исключение и запрос будет прерван. [#48246](https://github.com/ClickHouse/ClickHouse/pull/48246) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Не строить set для правой части `IN` с подзапросом, когда он используется только для анализа пропускающих индексов, и они отключены настройкой (`use_skip_indexes=0`). Ранее это могло отрицательно влиять на производительность запросов. [#48299](https://github.com/ClickHouse/ClickHouse/pull/48299) ([Anton Popov](https://github.com/CurtizJ)).
* Обработка запроса параллелизуется сразу после чтения `FROM file(...)`. Связано с [#38755](https://github.com/ClickHouse/ClickHouse/issues/38755). [#48525](https://github.com/ClickHouse/ClickHouse/pull/48525) ([Igor Nikonov](https://github.com/devcrafter)). Обработка запроса параллелизуется сразу после чтения из любого источника данных. Затронутые источники данных — в основном простые или внешние хранилища, такие как табличные функции `url`, `file`. [#48727](https://github.com/ClickHouse/ClickHouse/pull/48727) ([Igor Nikonov](https://github.com/devcrafter)). Это контролируется настройкой `parallelize_output_from_storages`, которая по умолчанию отключена.
* Снижена конкуренция за мьютекс в ThreadPool (может повысить производительность при огромном количестве маленьких задач). [#48750](https://github.com/ClickHouse/ClickHouse/pull/48750) ([Sergei Trifonov](https://github.com/serxa)).
* Снижено потребление памяти для нескольких мутаций `ALTER DELETE`. [#48522](https://github.com/ClickHouse/ClickHouse/pull/48522) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Удалены избыточные попытки подключения, если включена настройка `skip_unavailable_shards`. [#48771](https://github.com/ClickHouse/ClickHouse/pull/48771) ([Azat Khuzhin](https://github.com/azat)).

#### Экспериментальная функциональность {#experimental-feature-5}

* Записи в кэше запросов теперь агрегируются до `max_block_size` и сжимаются. [#45912](https://github.com/ClickHouse/ClickHouse/pull/45912) ([Robert Schulze](https://github.com/rschu1ze)).
* Теперь можно задавать квоты на пользователя в кэше запросов. [#48284](https://github.com/ClickHouse/ClickHouse/pull/48284) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлены некоторые проблемы с параллельными репликами. [#48433](https://github.com/ClickHouse/ClickHouse/pull/48433) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Реализована zero-copy-replication (экспериментальная функциональность) на зашифрованных дисках. [#48741](https://github.com/ClickHouse/ClickHouse/pull/48741) ([Vitaly Baranov](https://github.com/vitlibar)).

#### Улучшения {#improvement-8}

* Увеличено значение по умолчанию для `connect_timeout_with_failover_ms` до 1000 мс (в связи с добавлением асинхронных подключений в [https://github.com/ClickHouse/ClickHouse/pull/47229](https://github.com/ClickHouse/ClickHouse/pull/47229)). Закрывает [#5188](https://github.com/ClickHouse/ClickHouse/issues/5188). [#49009](https://github.com/ClickHouse/ClickHouse/pull/49009) ([Kruglov Pavel](https://github.com/Avogar)).
* Несколько улучшений, связанных с озерами данных: - Обеспечена работа `Iceberg` с данными без партиций. - Добавлена поддержка формата `Iceberg` версии v2 (ранее поддерживалась только v1). - Добавлена поддержка чтения данных, разбитых на партиции, для `DeltaLake`/`Hudi`. - Ускорено чтение метаданных `DeltaLake` за счёт использования checkpoint-файлов Delta. - Исправлено некорректное чтение `Hudi`: ранее неправильно выбирались данные для чтения, и поэтому корректно обрабатывались только таблицы небольшого размера. - Эти движки теперь подхватывают обновления изменённых данных (ранее состояние фиксировалось при создании таблицы). - Настроено корректное тестирование `Iceberg`/`DeltaLake`/`Hudi` с использованием Spark. [#47307](https://github.com/ClickHouse/ClickHouse/pull/47307) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлено асинхронное подключение к сокету и асинхронная запись в сокет. Установка соединений и отправка запроса/внешних таблиц по сегментам сделаны асинхронными. Рефакторинг кода с использованием fibers. Закрывает [#46931](https://github.com/ClickHouse/ClickHouse/issues/46931). После этого PR мы сможем по умолчанию увеличить `connect_timeout_with_failover_ms` ([https://github.com/ClickHouse/ClickHouse/issues/5188](https://github.com/ClickHouse/ClickHouse/issues/5188)). [#47229](https://github.com/ClickHouse/ClickHouse/pull/47229) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка секций конфигурации `keeper`/`keeper_server` в качестве альтернативы `zookeeper`. Закрыты [#34766](https://github.com/ClickHouse/ClickHouse/issues/34766), [#34767](https://github.com/ClickHouse/ClickHouse/issues/34767). [#35113](https://github.com/ClickHouse/ClickHouse/pull/35113) ([李扬](https://github.com/taiyang-li)).
* Теперь можно задавать флаг *secure* в named&#95;collections для словаря с источником в таблице ClickHouse. Исправляет [#38450](https://github.com/ClickHouse/ClickHouse/issues/38450). [#46323](https://github.com/ClickHouse/ClickHouse/pull/46323) ([Ilya Golshtein](https://github.com/ilejn)).
* Функция `bitCount` поддерживает типы данных `FixedString` и `String`. [#49044](https://github.com/ClickHouse/ClickHouse/pull/49044) ([flynn](https://github.com/ucasfl)).
* Добавлены настраиваемые повторные попытки для всех операций с [Zoo]Keeper при выполнении запросов BACKUP. [#47224](https://github.com/ClickHouse/ClickHouse/pull/47224) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Включить `use_environment_credentials` для S3 по умолчанию, так чтобы по умолчанию строилась вся цепочка провайдеров. [#47397](https://github.com/ClickHouse/ClickHouse/pull/47397) ([Antonio Andelic](https://github.com/antonio2368)).
* В настоящее время функция JSON&#95;VALUE во многом аналогична функции Spark get&#95;json&#95;object, которая позволяет получать значение из JSON-строки по пути вида &#39;$.key&#39;. Однако есть отличия: 1) в Spark get&#95;json&#95;object будет возвращено null, если путь не существует, тогда как JSON&#95;VALUE вернёт пустую строку; 2) в Spark get&#95;json&#95;object может быть возвращено значение сложного типа, например объект/массив JSON, тогда как JSON&#95;VALUE в таком случае вернёт пустую строку. [#47494](https://github.com/ClickHouse/ClickHouse/pull/47494) ([KevinyhZou](https://github.com/KevinyhZou)).
* Для `use_structure_from_insertion_table_in_table_functions` обеспечено более гибкое распространение структуры таблицы-вставки на табличную функцию. Исправлена проблема с сопоставлением имён и использованием виртуальных столбцов. Больше нет необходимости в настройке &#39;auto&#39;. [#47962](https://github.com/ClickHouse/ClickHouse/pull/47962) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Не продолжать попытки переподключения к Keeper, если запрос был отменён или превысил лимиты. [#47985](https://github.com/ClickHouse/ClickHouse/pull/47985) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлена поддержка ввода/вывода Enum в `BSONEachRow`, разрешены все типы ключей Map и устранены лишние вычисления при выводе. [#48122](https://github.com/ClickHouse/ClickHouse/pull/48122) ([Kruglov Pavel](https://github.com/Avogar)).
* Поддерживаются дополнительные типы ClickHouse в форматах `ORC`/`Arrow`/`Parquet`: Enum(8|16), (U)Int(128|256), Decimal256 (для ORC), добавлена возможность чтения IPv4 из значений Int32 (ORC выводит IPv4 как Int32, и мы не могли прочитать его обратно), исправлено чтение Nullable(IPv6) из двоичных данных для `ORC`. [#48126](https://github.com/ClickHouse/ClickHouse/pull/48126) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлены столбцы `perform_ttl_move_on_insert`, `load_balancing` в таблицу `system.storage_policies`, изменён тип столбца `volume_type` на `Enum8`. [#48167](https://github.com/ClickHouse/ClickHouse/pull/48167) ([lizhuoyu5](https://github.com/lzydmxy)).
* Добавлена поддержка команды `BACKUP ALL`, которая выполняет резервное копирование всех таблиц и баз данных, включая временные и системные. [#48189](https://github.com/ClickHouse/ClickHouse/pull/48189) ([Vitaly Baranov](https://github.com/vitlibar)).
* Функция mapFromArrays поддерживает тип `Map` в качестве входного параметра. [#48207](https://github.com/ClickHouse/ClickHouse/pull/48207) ([李扬](https://github.com/taiyang-li)).
* Результат выполнения некоторых команд `SHOW PROCESSLIST` теперь сортируется. [#48241](https://github.com/ClickHouse/ClickHouse/pull/48241) ([Robert Schulze](https://github.com/rschu1ze)).
* Ограничение пропускной способности на уровне запроса и сервера для remote IO/local IO/операций BACKUP (серверные настройки: `max_remote_read_network_bandwidth_for_server`, `max_remote_write_network_bandwidth_for_server`, `max_local_read_bandwidth_for_server`, `max_local_write_bandwidth_for_server`, `max_backup_bandwidth_for_server`; настройки: `max_remote_read_network_bandwidth`, `max_remote_write_network_bandwidth`, `max_local_read_bandwidth`, `max_local_write_bandwidth`, `max_backup_bandwidth`). [#48242](https://github.com/ClickHouse/ClickHouse/pull/48242) ([Azat Khuzhin](https://github.com/azat)).
* Поддержка дополнительных типов в формате `CapnProto`: Map, (U)Int(128|256), Decimal(128|256). Разрешены целочисленные преобразования при вводе и выводе. [#48257](https://github.com/ClickHouse/ClickHouse/pull/48257) ([Kruglov Pavel](https://github.com/Avogar)).
* Не выбрасывать исключение CURRENT&#95;WRITE&#95;BUFFER&#95;IS&#95;EXHAUSTED при штатной работе. [#48288](https://github.com/ClickHouse/ClickHouse/pull/48288) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлена новая настройка `keeper_map_strict_mode`, которая обеспечивает дополнительные гарантии для операций, выполняемых с таблицами `KeeperMap`. [#48293](https://github.com/ClickHouse/ClickHouse/pull/48293) ([Antonio Andelic](https://github.com/antonio2368)).
* Проверяется, что тип первичного ключа для простого словаря — нативный беззнаковый целочисленный тип. Добавлена настройка `check_dictionary_primary_key` для совместимости (установите `check_dictionary_primary_key = false`, чтобы отключить проверку). [#48335](https://github.com/ClickHouse/ClickHouse/pull/48335) ([lizhuoyu5](https://github.com/lzydmxy)).
* Не реплицируйте мутации для `KeeperMap`, поскольку в этом нет необходимости. [#48354](https://github.com/ClickHouse/ClickHouse/pull/48354) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена возможность записи и чтения безымянного кортежа как вложенного сообщения Message в формате Protobuf. Элементы кортежа и поля сообщения сопоставляются по порядку. [#48390](https://github.com/ClickHouse/ClickHouse/pull/48390) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка настроек `additional_table_filters` и `additional_result_filter` в новом планировщике. Также добавлен раздел документации для `additional_result_filter`. [#48405](https://github.com/ClickHouse/ClickHouse/pull/48405) ([Dmitry Novik](https://github.com/novikd)).
* `parseDateTime` теперь поддерживает спецификатор формата &#39;%f&#39; (дробные секунды). [#48420](https://github.com/ClickHouse/ClickHouse/pull/48420) ([Robert Schulze](https://github.com/rschu1ze)).
* Спецификатор формата &quot;%f&quot; в formatDateTime() теперь выводит &quot;000000&quot;, если у форматируемого значения нет дробных секунд; предыдущее поведение (один ноль) можно восстановить с помощью настройки &quot;formatdatetime&#95;f&#95;prints&#95;single&#95;zero = 1&quot;. [#48422](https://github.com/ClickHouse/ClickHouse/pull/48422) ([Robert Schulze](https://github.com/rschu1ze)).
* Не реплицировать операции DELETE и TRUNCATE для KeeperMap. [#48434](https://github.com/ClickHouse/ClickHouse/pull/48434) ([Antonio Andelic](https://github.com/antonio2368)).
* Генерировать корректные значения типов Decimal и Bool в функции generateRandom. [#48436](https://github.com/ClickHouse/ClickHouse/pull/48436) ([Kruglov Pavel](https://github.com/Avogar)).
* Разрешено использование завершающих запятых в списке выражений запроса SELECT, например `SELECT a, b, c, FROM table`. Закрывает [#37802](https://github.com/ClickHouse/ClickHouse/issues/37802). [#48438](https://github.com/ClickHouse/ClickHouse/pull/48438) ([Nikolay Degterinsky](https://github.com/evillique)).
* Переменные окружения `CLICKHOUSE_USER` и `CLICKHOUSE_PASSWORD` теперь переопределяются клиентскими параметрами `--user` и `--password`. Закрывает [#38909](https://github.com/ClickHouse/ClickHouse/issues/38909). [#48440](https://github.com/ClickHouse/ClickHouse/pull/48440) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлены повторные попытки загрузки частей данных в таблицах `MergeTree` при возникновении повторяемых ошибок. [#48442](https://github.com/ClickHouse/ClickHouse/pull/48442) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена поддержка типов данных `Date`, `Date32`, `DateTime`, `DateTime64` в функциях `arrayMin`, `arrayMax`, `arrayDifference`. Закрыта задача [#21645](https://github.com/ClickHouse/ClickHouse/issues/21645). [#48445](https://github.com/ClickHouse/ClickHouse/pull/48445) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена поддержка макроса `{server_uuid}`. Он полезен для идентификации реплик в кластерах с автоматическим масштабированием, когда новые реплики постоянно добавляются и удаляются во время работы. Тем самым закрыта [#48554](https://github.com/ClickHouse/ClickHouse/issues/48554). [#48563](https://github.com/ClickHouse/ClickHouse/pull/48563) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Теперь скрипт установки создаёт жёсткую ссылку вместо копирования, когда это возможно. [#48578](https://github.com/ClickHouse/ClickHouse/pull/48578) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка синтаксиса `SHOW TABLE`, эквивалентного `SHOW CREATE TABLE`. Закрывает [#48580](https://github.com/ClickHouse/ClickHouse/issues/48580). [#48591](https://github.com/ClickHouse/ClickHouse/pull/48591) ([flynn](https://github.com/ucasfl)).
* Временные буферы HTTP теперь могут работать, вытесняя данные из кэша виртуальной файловой системы. [#48664](https://github.com/ClickHouse/ClickHouse/pull/48664) ([Vladimir C](https://github.com/vdimir)).
* Добавлена поддержка автоматического вывода схемы для `CREATE AS SELECT`. Закрывает [#47599](https://github.com/ClickHouse/ClickHouse/issues/47599). [#48679](https://github.com/ClickHouse/ClickHouse/pull/48679) ([flynn](https://github.com/ucasfl)).
* Добавлена настройка `replicated_max_mutations_in_one_entry` для `ReplicatedMergeTree`, которая позволяет ограничить количество команд мутации в одной записи `MUTATE_PART` (значение по умолчанию — 10000). [#48731](https://github.com/ClickHouse/ClickHouse/pull/48731) ([Alexander Tokmakov](https://github.com/tavplubix)).
* В типах AggregateFunction не учитывать неиспользованные байты арены при вычислении `read_bytes`. [#48745](https://github.com/ClickHouse/ClickHouse/pull/48745) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена ситуация, при которой некоторые параметры MySQL не обрабатывались при использовании источника словаря MySQL и именованной коллекции. Закрывает [#48402](https://github.com/ClickHouse/ClickHouse/issues/48402). [#48759](https://github.com/ClickHouse/ClickHouse/pull/48759) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Если пользователь задаёт `max_single_part_upload_size` слишком большим, это может привести к аварийному завершению работы из-за ошибки в AWS S3 SDK. Это исправление решает проблему [#47679](https://github.com/ClickHouse/ClickHouse/issues/47679). [#48816](https://github.com/ClickHouse/ClickHouse/pull/48816) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Устранена гонка данных в `RabbitMQ` ([отчёт](https://pastila.nl/?004f7100/de1505289ab5bb355e67ebe6c7cc8707)), выполнен рефакторинг кода. [#48845](https://github.com/ClickHouse/ClickHouse/pull/48845) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлены псевдонимы `name` и `part_name` в таблицах `system.parts` и `system.part_log`. Закрыта задача [#48718](https://github.com/ClickHouse/ClickHouse/issues/48718). [#48850](https://github.com/ClickHouse/ClickHouse/pull/48850) ([sichenzhao](https://github.com/sichenzhao)).
* Функции &quot;arrayDifferenceSupport()&quot;, &quot;arrayCumSum()&quot; и &quot;arrayCumSumNonNegative()&quot; теперь поддерживают входные массивы целочисленных типов расширенной разрядности (U)Int128/256. [#48866](https://github.com/ClickHouse/ClickHouse/pull/48866) ([cluster](https://github.com/infdahai)).
* Многострочная история в clickhouse-client больше не выравнивается пробелами. Это делает вставку более естественной. [#48870](https://github.com/ClickHouse/ClickHouse/pull/48870) ([Joanna Hulboj](https://github.com/jh0x)).
* Реализовано небольшое улучшение для редкого случая, когда ClickHouse запускается внутри LXC и используется LXCFS. В LXCFS есть проблема: иногда при чтении файла внутри `/proc` он возвращает ошибку «Transport endpoint is not connected». Эта ошибка корректно записывалась в серверный журнал ClickHouse. Дополнительно реализован обходной путь для этой проблемы: файл повторно открывается. Это минимальное изменение. [#48922](https://github.com/ClickHouse/ClickHouse/pull/48922) ([Real](https://github.com/RunningXie)).
* Улучшен учет памяти для предвыборки. В CI настройки предвыборки случайным образом варьируются. [#48973](https://github.com/ClickHouse/ClickHouse/pull/48973) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Теперь заголовки для нативных операций копирования в GCS устанавливаются корректно. [#48981](https://github.com/ClickHouse/ClickHouse/pull/48981) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена поддержка указания имен настроек в командной строке с использованием дефисов вместо символов подчеркивания, например, `--max-threads` вместо `--max_threads`. Также добавлена поддержка символов дефиса Unicode, таких как `—` вместо `--` — это полезно, когда вы взаимодействуете с командой в другой компании, и менеджер из этой команды просто скопировал код из MS Word и вставил его. [#48985](https://github.com/ClickHouse/ClickHouse/pull/48985) ([alekseygolub](https://github.com/alekseygolub)).
* Добавлен переход на аутентификацию по паролю при сбое аутентификации по пользовательскому SSL-сертификату. Закрывает [#48974](https://github.com/ClickHouse/ClickHouse/issues/48974). [#48989](https://github.com/ClickHouse/ClickHouse/pull/48989) ([Nikolay Degterinsky](https://github.com/evillique)).
* Улучшена встроенная панель мониторинга. Закрыт [#46671](https://github.com/ClickHouse/ClickHouse/issues/46671). [#49036](https://github.com/ClickHouse/ClickHouse/pull/49036) ([Kevin Zhang](https://github.com/Kinzeng)).
* Добавлены события профилирования для лог-сообщений, чтобы можно было легко увидеть их количество по уровням серьёзности. [#49042](https://github.com/ClickHouse/ClickHouse/pull/49042) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* В предыдущих версиях формат `LineAsString` работал непоследовательно при включённом или выключенном параллельном разборе при наличии переводов строк формата DOS или macOS Classic. Исправляет [#49039](https://github.com/ClickHouse/ClickHouse/issues/49039). [#49052](https://github.com/ClickHouse/ClickHouse/pull/49052) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сообщение об исключении о неразобранном параметре запроса теперь также будет содержать имя параметра. Реализовать повторно [#48878](https://github.com/ClickHouse/ClickHouse/issues/48878). Закрыть [#48772](https://github.com/ClickHouse/ClickHouse/issues/48772). [#49061](https://github.com/ClickHouse/ClickHouse/pull/49061) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-8}

* Обновлены часовые пояса. Были обновлены следующие зоны: Africa/Cairo, Africa/Casablanca, Africa/El_Aaiun, America/Bogota, America/Cambridge_Bay, America/Ciudad_Juarez, America/Godthab, America/Inuvik, America/Iqaluit, America/Nuuk, America/Ojinaga, America/Pangnirtung, America/Rankin_Inlet, America/Resolute, America/Whitehorse, America/Yellowknife, Asia/Gaza, Asia/Hebron, Asia/Kuala_Lumpur, Asia/Singapore, Canada/Yukon, Egypt, Europe/Kirov, Europe/Volgograd, Singapore. [#48572](https://github.com/ClickHouse/ClickHouse/pull/48572) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Уменьшено количество зависимостей в заголовочных файлах для ускорения сборки. [#47984](https://github.com/ClickHouse/ClickHouse/pull/47984) ([Dmitry Novik](https://github.com/novikd)).
* Сжатие меток и индексов в тестах сделано случайным образом. [#48286](https://github.com/ClickHouse/ClickHouse/pull/48286) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Обновлён внутренний ZSTD с версии 1.5.4 до 1.5.5. [#46797](https://github.com/ClickHouse/ClickHouse/pull/46797) ([Robert Schulze](https://github.com/rschu1ze)).
* Вертикальные слияния из компактных в широкие части в тестах сделаны случайными. [#48287](https://github.com/ClickHouse/ClickHouse/pull/48287) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлена поддержка контрольной суммы CRC32 в HDFS. Исправлены проблемы с производительностью. [#48614](https://github.com/ClickHouse/ClickHouse/pull/48614) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Удалены оставшиеся элементы поддержки GCC. [#48671](https://github.com/ClickHouse/ClickHouse/pull/48671) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлен запуск CI с включённой новой инфраструктурой анализатора. [#48719](https://github.com/ClickHouse/ClickHouse/pull/48719) ([Dmitry Novik](https://github.com/novikd)).

#### Исправление ошибки (некорректное поведение, заметное пользователю, в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-8}

* Исправлен `system.query_views_log` для материализованных представлений, запускаемых фоновыми потоками [#46668](https://github.com/ClickHouse/ClickHouse/pull/46668) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены несколько ошибок, связанных с `RENAME COLUMN` [#46946](https://github.com/ClickHouse/ClickHouse/pull/46946) ([alesapin](https://github.com/alesapin)).
* Исправлены небольшие проблемы подсветки синтаксиса в clickhouse-format [#47610](https://github.com/ClickHouse/ClickHouse/pull/47610) ([Natasha Murashkina](https://github.com/murfel)).
* Исправлена ошибка в libc++ из LLVM, приводившая к сбою при загрузке в S3 частей, размер которых превышает INT&#95;MAX [#47693](https://github.com/ClickHouse/ClickHouse/pull/47693) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено переполнение в функции `sparkbar` [#48121](https://github.com/ClickHouse/ClickHouse/pull/48121) ([Vladimir C](https://github.com/vdimir)).
* Исправлено состояние гонки в S3 [#48190](https://github.com/ClickHouse/ClickHouse/pull/48190) ([Anton Popov](https://github.com/CurtizJ)).
* Отключить JIT для агрегатных функций из-за непоследовательного поведения [#48195](https://github.com/ClickHouse/ClickHouse/pull/48195) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Небольшие исправления форматирования ALTER [#48289](https://github.com/ClickHouse/ClickHouse/pull/48289) ([Natasha Murashkina](https://github.com/murfel)).
* Исправлено использование CPU в RabbitMQ (которое увеличилось в 23.2 после [#44404](https://github.com/ClickHouse/ClickHouse/issues/44404)) [#48311](https://github.com/ClickHouse/ClickHouse/pull/48311) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено падение в EXPLAIN PIPELINE для Merge over Distributed [#48320](https://github.com/ClickHouse/ClickHouse/pull/48320) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема с сериализацией LowCardinality в виде словаря Arrow [#48361](https://github.com/ClickHouse/ClickHouse/pull/48361) ([Kruglov Pavel](https://github.com/Avogar)).
* Сброс загрузчика сегмента файла кэша в TemporaryFileStream [#48386](https://github.com/ClickHouse/ClickHouse/pull/48386) ([Vladimir C](https://github.com/vdimir)).
* Исправлено возможное зависание SYSTEM SYNC REPLICA при выполнении DROP/REPLACE PARTITION [#48391](https://github.com/ClickHouse/ClickHouse/pull/48391) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка запуска при загрузке distributed таблицы, зависящей от словаря [#48419](https://github.com/ClickHouse/ClickHouse/pull/48419) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Не проверять зависимости при автоматическом переименовании системных таблиц [#48431](https://github.com/ClickHouse/ClickHouse/pull/48431) ([Raúl Marín](https://github.com/Algunenano)).
* Обновлять только затронутые изменениями строки в хранилище KeeperMap [#48435](https://github.com/ClickHouse/ClickHouse/pull/48435) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена возможная ошибка сегментации памяти в кэше VFS [#48469](https://github.com/ClickHouse/ClickHouse/pull/48469) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Функция `toTimeZone` вызывает ошибку, если не передана строковая константа [#48471](https://github.com/ClickHouse/ClickHouse/pull/48471) ([Jordi Villar](https://github.com/jrdi)).
* Исправлена логическая ошибка с IPv4 в Protobuf, добавлена поддержка Date32 [#48486](https://github.com/ClickHouse/ClickHouse/pull/48486) ([Kruglov Pavel](https://github.com/Avogar)).
* Флаг &quot;changed&quot; в system.settings вычислялся некорректно для параметров с несколькими значениями [#48516](https://github.com/ClickHouse/ClickHouse/pull/48516) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Исправлена работа хранилища `Memory` при включённом сжатии [#48517](https://github.com/ClickHouse/ClickHouse/pull/48517) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена работа режима bracketed paste, из‑за которого искажался ввод пароля при переподключении клиента [#48528](https://github.com/ClickHouse/ClickHouse/pull/48528) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлен вложенный тип Map для ключей типов IP и UUID [#48556](https://github.com/ClickHouse/ClickHouse/pull/48556) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлено необработанное исключение при использовании параллельного загрузчика для хешированных словарей [#48571](https://github.com/ClickHouse/ClickHouse/pull/48571) ([Azat Khuzhin](https://github.com/azat)).
* Агрегатная функция `groupArray` корректно работает для пустого результата над типами Nullable [#48593](https://github.com/ClickHouse/ClickHouse/pull/48593) ([lgbo](https://github.com/lgbo-ustc)).
* Исправлена ошибка в Keeper, из-за которой иногда узел создавался без схемы `auth` в ACL. [#48595](https://github.com/ClickHouse/ClickHouse/pull/48595) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Разрешены операторы сравнения IPv4 с UInt [#48611](https://github.com/ClickHouse/ClickHouse/pull/48611) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена возможная ошибка, связанная с кэшем [#48636](https://github.com/ClickHouse/ClickHouse/pull/48636) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Асинхронные вставки с пустыми данными больше не будут приводить к возникновению исключения. [#48663](https://github.com/ClickHouse/ClickHouse/pull/48663) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена обработка зависимостей таблиц в случае неудачного выполнения операции RENAME TABLE [#48683](https://github.com/ClickHouse/ClickHouse/pull/48683) ([Azat Khuzhin](https://github.com/azat)).
* Если первичный ключ содержит повторяющиеся столбцы (что возможно только для проекций PROJECTION), в предыдущих версиях это могло приводить к ошибке [#48838](https://github.com/ClickHouse/ClickHouse/pull/48838) ([Amos Bird](https://github.com/amosbird)).
* Исправление состояния гонки в ZooKeeper при присоединении потоков send&#95;thread и receive&#95;thread [#48849](https://github.com/ClickHouse/ClickHouse/pull/48849) ([Alexander Gololobov](https://github.com/davenger)).
* Исправлена ошибка «unexpected part name» при попытке удалить игнорируемую отсоединённую part при zero copy репликации [#48862](https://github.com/ClickHouse/ClickHouse/pull/48862) ([Michael Lex](https://github.com/mlex)).
* Исправлена ошибка, из-за которой столбец `Date32` из Parquet/Arrow считывался как столбец другого типа [#48864](https://github.com/ClickHouse/ClickHouse/pull/48864) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка `UNKNOWN_IDENTIFIER` при выполнении SELECT из таблицы с ROW POLICY и столбцом, имя которого содержит точки [#48976](https://github.com/ClickHouse/ClickHouse/pull/48976) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена агрегация по пустым строкам Nullable [#48999](https://github.com/ClickHouse/ClickHouse/pull/48999) ([LiuNeng](https://github.com/liuneng1994)).

### <a id="233"></a> Релиз ClickHouse 23.3 LTS, 2023-03-30. [Презентация](https://presentations.clickhouse.com/2023-release-23.3/), [Видео](https://www.youtube.com/watch?v=ISaGUjvBNao) {#233}

<iframe width="1024" height="576" src="https://www.youtube.com/embed/ISaGUjvBNao" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

#### Заметки по обновлению {#upgrade-notes-1}

* Легковесные удаления (Lightweight DELETE) готовы для промышленного использования и включены по умолчанию. Запрос `DELETE` для таблиц MergeTree теперь доступен по умолчанию.
* Поведение функций `*domain*RFC` и `netloc` немного изменено: расширен набор символов, разрешённых в части authority URL, для лучшего соответствия стандартам. [#46841](https://github.com/ClickHouse/ClickHouse/pull/46841) ([Azat Khuzhin](https://github.com/azat)).
* Запрещено создание таблиц с движком KafkaEngine с использованием конструкций DEFAULT/EPHEMERAL/ALIAS/MATERIALIZED для столбцов. [#47138](https://github.com/ClickHouse/ClickHouse/pull/47138) ([Aleksandr Musorin](https://github.com/AVMusorin)).
* Удалена функция "asynchronous connection drain". Связанные настройки и метрики также удалены. Это была внутренняя функция, поэтому её удаление не должно повлиять на пользователей, которые никогда о ней не слышали. [#47486](https://github.com/ClickHouse/ClickHouse/pull/47486) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Добавлена поддержка 256-битного типа данных Decimal (более 38 цифр) в `arraySum`/`Min`/`Max`/`Avg`/`Product`, `arrayCumSum`/`CumSumNonNegative`, `arrayDifference`, конструировании массивов, операторе IN, параметрах запроса, `groupArrayMovingSum`, статистических функциях, `min`/`max`/`any`/`argMin`/`argMax`, протоколе взаимодействия PostgreSQL (wire protocol), движке таблиц MySQL и одноимённой функции, `sumMap`, `mapAdd`, `mapSubtract`, `arrayIntersect`. Добавлена поддержка больших целых чисел в `arrayIntersect`. Статистические агрегатные функции, использующие моменты (например, `corr` или различные `TTest`), будут использовать `Float64` в качестве внутреннего представления (ранее использовался `Decimal128`, но это было бессмысленно), и эти функции могут возвращать `nan` вместо `inf` в случае бесконечной дисперсии. Некоторые функции были разрешены для типов данных `Decimal256`, но возвращали `Decimal128` в предыдущих версиях — теперь это исправлено. Это закрывает [#47569](https://github.com/ClickHouse/ClickHouse/issues/47569). Это закрывает [#44864](https://github.com/ClickHouse/ClickHouse/issues/44864). Это закрывает [#28335](https://github.com/ClickHouse/ClickHouse/issues/28335). [#47594](https://github.com/ClickHouse/ClickHouse/pull/47594) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Настройки backup_threads/restore_threads переведены в разряд серверных (вместо пользовательских). [#47881](https://github.com/ClickHouse/ClickHouse/pull/47881) ([Azat Khuzhin](https://github.com/azat)).
* Запрещено использование константных и недетерминированных вторичных индексов. [#46839](https://github.com/ClickHouse/ClickHouse/pull/46839) ([Anton Popov](https://github.com/CurtizJ)).

#### Новая функциональность {#new-feature-9}

* Добавлен новый режим распределения работы между репликами с помощью настроек `parallel_replicas_custom_key` и `parallel_replicas_custom_key_filter_type`. Если кластер состоит из одного сегмента с несколькими репликами, до `max_parallel_replicas` реплик будут случайным образом выбраны и логически превращены в сегменты. Для каждого такого сегмента соответствующий фильтр добавляется к запросу на стороне инициатора перед отправкой в сегмент. Если кластер состоит из нескольких сегментов, поведение будет таким же, как у `sample_key`, но с возможностью задать произвольный ключ. [#45108](https://github.com/ClickHouse/ClickHouse/pull/45108) ([Antonio Andelic](https://github.com/antonio2368)).
* Опция отображения частичного результата при отмене: Добавлена настройка запроса `partial_result_on_first_cancel`, позволяющая отменённому запросу (например, из-за Ctrl-C) возвращать частичный результат. [#45689](https://github.com/ClickHouse/ClickHouse/pull/45689) ([Alexey Perevyshin](https://github.com/alexX512)).
* Добавлена поддержка любых движков таблиц для временных таблиц (за исключением движков Replicated и KeeperMap). Закрыта задача [#31497](https://github.com/ClickHouse/ClickHouse/issues/31497). [#46071](https://github.com/ClickHouse/ClickHouse/pull/46071) ([Roman Vasin](https://github.com/rvasin)).
* Добавлена поддержка репликации определяемых пользователем SQL-функций с использованием централизованного хранилища в Keeper. [#46085](https://github.com/ClickHouse/ClickHouse/pull/46085) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Реализована таблица `system.server_settings` (аналогичная `system.settings`), содержащая настройки сервера. [#46550](https://github.com/ClickHouse/ClickHouse/pull/46550) ([pufit](https://github.com/pufit)).
* Добавлена поддержка запроса `UNDROP TABLE`. Закрывает [#46811](https://github.com/ClickHouse/ClickHouse/issues/46811). [#47241](https://github.com/ClickHouse/ClickHouse/pull/47241) ([chen](https://github.com/xiedeyantu)).
* Разрешены отдельные гранты для именованных коллекций (например, чтобы можно было дать доступ `SHOW/CREATE/ALTER/DROP named collection` только к определённым коллекциям, а не ко всем сразу). Закрывает [#40894](https://github.com/ClickHouse/ClickHouse/issues/40894). Добавлен новый тип доступа `NAMED_COLLECTION_CONTROL`, который по умолчанию не выдаётся пользователю, если явно не добавлен в его конфигурацию (требуется для возможности выполнить `GRANT ALL`); также `show_named_collections` больше не обязательно указывать вручную для пользователя по умолчанию, чтобы он имел полный набор прав доступа, как это было в 23.2. [#46241](https://github.com/ClickHouse/ClickHouse/pull/46241) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка вложенных пользовательских дисков. Ранее пользовательские диски поддерживали только плоскую структуру. [#47106](https://github.com/ClickHouse/ClickHouse/pull/47106) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена функция `widthBucket` (с алиасом `WIDTH_BUCKET` для совместимости). [#42974](https://github.com/ClickHouse/ClickHouse/issues/42974). [#46790](https://github.com/ClickHouse/ClickHouse/pull/46790) ([avoiderboi](https://github.com/avoiderboi)).
* Добавлены новые функции `parseDateTime`/`parseDateTimeInJodaSyntax` для работы с указанной строкой формата. `parseDateTime` преобразует String в DateTime в синтаксисе MySQL, `parseDateTimeInJodaSyntax` выполняет разбор в синтаксисе Joda. [#46815](https://github.com/ClickHouse/ClickHouse/pull/46815) ([李扬](https://github.com/taiyang-li)).
* Используется `dummy UInt8` в качестве структуры по умолчанию для табличной функции `null`. Закрывает [#46930](https://github.com/ClickHouse/ClickHouse/issues/46930). [#47006](https://github.com/ClickHouse/ClickHouse/pull/47006) ([flynn](https://github.com/ucasfl)).
* Добавлена поддержка формата даты с запятой, например `Dec 15, 2021`, в функции `parseDateTimeBestEffort`. Закрывает [#46816](https://github.com/ClickHouse/ClickHouse/issues/46816). [#47071](https://github.com/ClickHouse/ClickHouse/pull/47071) ([chen](https://github.com/xiedeyantu)).
* Добавлены настройки `http_wait_end_of_query` и `http_response_buffer_size`, соответствующие параметрам URL `wait_end_of_query` и `buffer_size` для HTTP-интерфейса. Это позволяет изменять эти настройки в профилях. [#47108](https://github.com/ClickHouse/ClickHouse/pull/47108) ([Vladimir C](https://github.com/vdimir)).
* Добавлена таблица `system.dropped_tables`, которая показывает таблицы, удалённые из баз данных типа `Atomic`, но ещё не окончательно удалённые. [#47364](https://github.com/ClickHouse/ClickHouse/pull/47364) ([chen](https://github.com/xiedeyantu)).
* Добавлен `INSTR` как псевдоним функции `positionCaseInsensitive` для совместимости с MySQL. Закрывает [#47529](https://github.com/ClickHouse/ClickHouse/issues/47529). [#47535](https://github.com/ClickHouse/ClickHouse/pull/47535) ([flynn](https://github.com/ucasfl)).
* Добавлена функция `toDecimalString`, позволяющая преобразовывать числа в строковое представление с фиксированной точностью. [#47838](https://github.com/ClickHouse/ClickHouse/pull/47838) ([Andrey Zvonov](https://github.com/zvonand)).
* Добавлена настройка MergeTree `max_number_of_mutations_for_replica`. Она ограничивает количество мутаций частей на одну реплику указанным значением. Ноль означает отсутствие ограничения на количество мутаций на реплику (выполнение по‑прежнему может ограничиваться другими настройками). [#48047](https://github.com/ClickHouse/ClickHouse/pull/48047) ([Vladimir C](https://github.com/vdimir)).
* Добавлена функция для работы с типом `Map` — `mapFromArrays`, которая позволяет создать отображение из пары массивов. [#31125](https://github.com/ClickHouse/ClickHouse/pull/31125) ([李扬](https://github.com/taiyang-li)).
* Добавлено управление сжатием в форматах вывода Parquet/ORC/Arrow, а также поддержка большего числа входных форматов сжатия. Это исправляет [#13541](https://github.com/ClickHouse/ClickHouse/issues/13541). [#47114](https://github.com/ClickHouse/ClickHouse/pull/47114) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена аутентификация с использованием пользовательских SSL-сертификатов для нативного протокола. Закрывает [#47077](https://github.com/ClickHouse/ClickHouse/issues/47077). [#47596](https://github.com/ClickHouse/ClickHouse/pull/47596) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлены варианты функций *OrNull() и *OrZero() для `parseDateTime`, а также псевдоним `str_to_date` для совместимости с MySQL. [#48000](https://github.com/ClickHouse/ClickHouse/pull/48000) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлен оператор `REGEXP` (по аналогии с операторами &quot;LIKE&quot;, &quot;IN&quot;, &quot;MOD&quot; и т. д.) для улучшения совместимости с MySQL [#47869](https://github.com/ClickHouse/ClickHouse/pull/47869) ([Robert Schulze](https://github.com/rschu1ze)).

#### Повышение производительности {#performance-improvement-9}

* Метки в памяти теперь хранятся в сжатом виде, что позволяет использовать в 3–6 раз меньше памяти. [#47290](https://github.com/ClickHouse/ClickHouse/pull/47290) ([Michael Kolupaev](https://github.com/al13n321)).
* Резервное копирование для очень большого числа файлов в предыдущих версиях было невероятно медленным. Теперь — нет. Теперь оно невероятно быстрое. [#47251](https://github.com/ClickHouse/ClickHouse/pull/47251) ([Alexey Milovidov](https://github.com/alexey-milovidov)). Добавлен отдельный пул потоков для операций ввода-вывода (I/O) при резервном копировании. Это позволит масштабировать его независимо от других пулов и повысить производительность. [#47174](https://github.com/ClickHouse/ClickHouse/pull/47174) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)). Теперь для сбора метаданных на финальной стадии обработки резервного копирования используются запрос MultiRead и повторные попытки. [#47243](https://github.com/ClickHouse/ClickHouse/pull/47243) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)). Если и резервная копия, и восстанавливаемые данные находятся в S3, то теперь должно использоваться серверное копирование. [#47546](https://github.com/ClickHouse/ClickHouse/pull/47546) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено избыточное считывание данных в запросах с `FINAL`. [#47801](https://github.com/ClickHouse/ClickHouse/pull/47801) ([Nikita Taranov](https://github.com/nickitat)).
* Параметр `max_final_threads` автоматически устанавливается в значение, равное числу ядер, при запуске сервера (по тому же алгоритму, что используется для `max_threads`). Это улучшает параллелизм выполнения `final` на серверах с большим числом процессорных ядер. [#47915](https://github.com/ClickHouse/ClickHouse/pull/47915) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлена возможность выполнять конвейер чтения для словаря DIRECT с источником CLICKHOUSE в нескольких потоках. Чтобы включить, установите `dictionary_use_async_executor=1` в секции `SETTINGS` для источника в операторе `CREATE DICTIONARY`. [#47986](https://github.com/ClickHouse/ClickHouse/pull/47986) ([Vladimir C](https://github.com/vdimir)).
* Оптимизирована производительность агрегации с одним ключом типа Nullable. [#45772](https://github.com/ClickHouse/ClickHouse/pull/45772) ([LiuNeng](https://github.com/liuneng1994)).
* Реализовано использование индекса `tokenbf_v1` в нижнем регистре в функциях `hasTokenOrNull`, `hasTokenCaseInsensitive` и `hasTokenCaseInsensitiveOrNull`. [#46252](https://github.com/ClickHouse/ClickHouse/pull/46252) ([ltrk2](https://github.com/ltrk2)).
* Оптимизированы функции `position` и `LIKE` путём поиска первых двух символов с использованием SIMD. [#46289](https://github.com/ClickHouse/ClickHouse/pull/46289) ([Jiebin Sun](https://github.com/jiebinn)).
* Оптимизированы запросы к `system.detached_parts`, которые могут быть существенно большими по объёму. Добавлено несколько источников чтения с учётом ограничения на размер блока; в каждом блоке используется пул потоков ввода-вывода для расчёта размера части, то есть для параллельного выполнения системных вызовов. [#46624](https://github.com/ClickHouse/ClickHouse/pull/46624) ([Sema Checherinda](https://github.com/CheSema)).
* Увеличено значение по умолчанию параметра `max_replicated_merges_in_queue` для таблиц ReplicatedMergeTree с 16 до 1000. Это позволяет ускорить выполнение фоновых операций слияния в кластерах с очень большим количеством реплик, например в кластерах с общим хранилищем в ClickHouse Cloud. [#47050](https://github.com/ClickHouse/ClickHouse/pull/47050) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Обновлён `clickhouse-copier`, чтобы использовать `GROUP BY` вместо `DISTINCT` при получении списка партиций. Для больших таблиц это сократило время выполнения SELECT с более чем 500 с до менее чем 1 с. [#47386](https://github.com/ClickHouse/ClickHouse/pull/47386) ([Clayton McClure](https://github.com/cmcclure-twilio)).
* Исправлена деградация производительности в `ASOF JOIN`. [#47544](https://github.com/ClickHouse/ClickHouse/pull/47544) ([Ongkong](https://github.com/ongkong)).
* Ещё больше пакетной обработки в Keeper. Повышена производительность за счёт того, что при запросах на чтение пакеты больше не разбиваются. [#47978](https://github.com/ClickHouse/ClickHouse/pull/47978) ([Antonio Andelic](https://github.com/antonio2368)).
* Разрешено использовать PREWHERE для Merge при различных выражениях DEFAULT для столбцов. [#46831](https://github.com/ClickHouse/ClickHouse/pull/46831) ([Azat Khuzhin](https://github.com/azat)).

#### Экспериментальная возможность {#experimental-feature-6}

* Параллельные реплики: повышена общая производительность за счет более эффективного использования локальной реплики и по умолчанию запрещено чтение с параллельными репликами из нереплицируемых таблиц MergeTree. [#47858](https://github.com/ClickHouse/ClickHouse/pull/47858) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Поддержка проталкивания фильтра (filter push down) в левую таблицу для JOIN с таблицами `Join`, `Dictionary` и `EmbeddedRocksDB`, если включен экспериментальный Analyzer. [#47280](https://github.com/ClickHouse/ClickHouse/pull/47280) ([Maksim Kita](https://github.com/kitaisreal)).
* Теперь ReplicatedMergeTree с репликацией zero copy создает меньшую нагрузку на Keeper. [#47676](https://github.com/ClickHouse/ClickHouse/pull/47676) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка при создании materialized view с MaterializedPostgreSQL. [#40807](https://github.com/ClickHouse/ClickHouse/pull/40807) ([Maksim Buren](https://github.com/maks-buren630501)).

#### Улучшения {#improvement-9}

* Параметр `input_format_json_ignore_unknown_keys_in_named_tuple` включён по умолчанию. [#46742](https://github.com/ClickHouse/ClickHouse/pull/46742) ([Kruglov Pavel](https://github.com/Avogar)).
* Разрешено игнорировать ошибки при записи в MATERIALIZED VIEW (добавлена новая настройка `materialized_views_ignore_errors`, по умолчанию — `false`, но для безусловного сброса логов в таблицы `system.*_log` она установлена в значение `true`). [#46658](https://github.com/ClickHouse/ClickHouse/pull/46658) ([Azat Khuzhin](https://github.com/azat)).
* Отслеживание файловой очереди распределённых отправок в памяти. [#45491](https://github.com/ClickHouse/ClickHouse/pull/45491) ([Azat Khuzhin](https://github.com/azat)).
* Теперь заголовки `X-ClickHouse-Query-Id` и `X-ClickHouse-Timezone` добавляются в ответы для всех запросов по протоколу HTTP. Ранее это делалось только для запросов `SELECT`. [#46364](https://github.com/ClickHouse/ClickHouse/pull/46364) ([Anton Popov](https://github.com/CurtizJ)).
* Внешние таблицы из `MongoDB`: добавлена поддержка подключения к набору реплик (replica set) по URI с перечнем хостов и портов (host:port), а также поддержка опции readPreference в словарях MongoDB. Пример URI: mongodb://db0.example.com:27017,db1.example.com:27017,db2.example.com:27017/?replicaSet=myRepl&amp;readPreference=primary. [#46524](https://github.com/ClickHouse/ClickHouse/pull/46524) ([artem-yadr](https://github.com/artem-yadr)).
* Это улучшение должно быть незаметным для вас. Перереализован анализ PROJECTION поверх плана запроса. Добавлена настройка `query_plan_optimize_projection=1` для переключения между старой и новой версиями. Исправлена проблема [#44963](https://github.com/ClickHouse/ClickHouse/issues/44963). [#46537](https://github.com/ClickHouse/ClickHouse/pull/46537) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* По умолчанию в качестве выходного формата используется Parquet v2 вместо v1. Добавлена настройка `output_format_parquet_version` для управления версией Parquet, возможные значения: `1.0`, `2.4`, `2.6`, `2.latest` (по умолчанию). [#46617](https://github.com/ClickHouse/ClickHouse/pull/46617) ([Kruglov Pavel](https://github.com/Avogar)).
* Теперь можно использовать новый синтаксис конфигурации для настройки топиков Kafka с точками (`.`) в их именах. [#46752](https://github.com/ClickHouse/ClickHouse/pull/46752) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлены эвристики, которые проверяют шаблоны Hyperscan на наличие проблемных повторов. [#46819](https://github.com/ClickHouse/ClickHouse/pull/46819) ([Robert Schulze](https://github.com/rschu1ze)).
* Не записывать в system.errors о существовании узла ZK, если блок был одновременно создан другой репликой. [#46820](https://github.com/ClickHouse/ClickHouse/pull/46820) ([Raúl Marín](https://github.com/Algunenano)).
* Увеличен лимит на количество открытых файлов в `clickhouse-local`. Теперь он сможет читать из таблиц `web` на серверах с очень большим количеством ядер CPU. Чтение из движка таблиц URL больше не прекращается при слишком большом количестве открытых файлов. Исправляет [#46852](https://github.com/ClickHouse/ClickHouse/issues/46852). [#46853](https://github.com/ClickHouse/ClickHouse/pull/46853) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исключения, возникающие при ошибке разбора чисел, теперь содержат более понятный текст сообщения. [#46917](https://github.com/ClickHouse/ClickHouse/pull/46917) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлено обновление таблицы `system.backups` после каждой обработанной задачи для отслеживания прогресса создания резервных копий. [#46989](https://github.com/ClickHouse/ClickHouse/pull/46989) ([Aleksandr Musorin](https://github.com/AVMusorin)).
* Разрешено преобразование типов во входном формате Native. Добавлена настройка `input_format_native_allow_types_conversion`, которая управляет этой возможностью (включена по умолчанию). [#46990](https://github.com/ClickHouse/ClickHouse/pull/46990) ([Kruglov Pavel](https://github.com/Avogar)).
* Разрешить использование IPv4 в функции `range` для генерации диапазонов IP-адресов. [#46995](https://github.com/ClickHouse/ClickHouse/pull/46995) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Улучшено сообщение об исключении, возникающем, если невозможно переместить часть с одного тома/диска на другой. [#47032](https://github.com/ClickHouse/ClickHouse/pull/47032) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка типа `Bool` в функции `JSONType`. Ранее для булевых значений по ошибке возвращался тип `Null`. [#47046](https://github.com/ClickHouse/ClickHouse/pull/47046) ([Anton Popov](https://github.com/CurtizJ)).
* Используйте параметр `_request_body` для настройки заранее определённых HTTP-запросов. [#47086](https://github.com/ClickHouse/ClickHouse/pull/47086) ([Constantine Peresypkin](https://github.com/pkit)).
* Автоматическое добавление отступа во встроенном UI SQL-редакторе при нажатии Enter. [#47113](https://github.com/ClickHouse/ClickHouse/pull/47113) ([Alexey Korepanov](https://github.com/alexkorep)).
* При самораспаковке под управлением &#39;sudo&#39; будет предпринята попытка установить uid и gid распакованных файлов на значения текущего пользователя. [#47116](https://github.com/ClickHouse/ClickHouse/pull/47116) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Ранее второй аргумент функции `repeat` принимал только значения типа беззнакового целого числа, поэтому нельзя было передавать, например, -1. Это поведение отличалось от поведения одноимённой функции в Spark. В этом обновлении функция `repeat` была изменена, чтобы соответствовать поведению функции в Spark: теперь она принимает те же типы входных данных, включая отрицательные целые числа. Для проверки корректности обновлённой реализации было проведено обширное тестирование. [#47134](https://github.com/ClickHouse/ClickHouse/pull/47134) ([KevinyhZou](https://github.com/KevinyhZou)). Примечание: этот пункт журнала изменений был переписан с помощью ChatGPT.
* Удалена часть `::__1` из стек-трейсов. `std::basic_string<char, ...` теперь отображается как `String` в стек-трейсах. [#47171](https://github.com/ClickHouse/ClickHouse/pull/47171) ([Mike Kot](https://github.com/myrrc)).
* Пере реализован межсерверный режим для предотвращения атак повторного воспроизведения (обратите внимание, что это изменение обратно совместимо с более старыми серверами). [#47213](https://github.com/ClickHouse/ClickHouse/pull/47213) ([Azat Khuzhin](https://github.com/azat)).
* Улучшено распознавание групп регулярных выражений и доработан словарь `regexp_tree`. [#47218](https://github.com/ClickHouse/ClickHouse/pull/47218) ([Han Fei](https://github.com/hanfei1991)).
* Улучшение Keeper: добавлена новая 4LW-команда `clrs` для очистки ресурсов, которые использует Keeper (например, для освобождения неиспользуемой памяти). [#47256](https://github.com/ClickHouse/ClickHouse/pull/47256) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлены необязательные аргументы к кодекам `DoubleDelta(bytes_size)`, `Gorilla(bytes_size)`, `FPC(level, float_size)`, что позволяет использовать эти кодеки без указания типа столбца в `clickhouse-compressor`. Исправлены возможные аварийные завершения работы и арифметические ошибки в `clickhouse-compressor` при использовании этих кодеков. Исправления: [https://github.com/ClickHouse/ClickHouse/discussions/47262](https://github.com/ClickHouse/ClickHouse/discussions/47262). [#47271](https://github.com/ClickHouse/ClickHouse/pull/47271) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка типов bigint для функции `runningDifference`. Закрывает [#47194](https://github.com/ClickHouse/ClickHouse/issues/47194). [#47322](https://github.com/ClickHouse/ClickHouse/pull/47322) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлено окно истечения срока действия для S3‑учетных данных с заданным временем истечения, чтобы избежать ошибок `ExpiredToken` в некоторых граничных случаях. Им можно управлять с помощью параметра конфигурации `expiration_window_seconds`, значение по умолчанию — 120 секунд. [#47423](https://github.com/ClickHouse/ClickHouse/pull/47423) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена поддержка типов данных Decimal и Date32 в формате `Avro`. [#47434](https://github.com/ClickHouse/ClickHouse/pull/47434) ([Kruglov Pavel](https://github.com/Avogar)).
* Не запускать сервер при обнаружении прерванного преобразования из `Ordinary` в `Atomic` и выводить более информативное сообщение об ошибке с рекомендациями по устранению неполадок. [#47487](https://github.com/ClickHouse/ClickHouse/pull/47487) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Добавлен новый столбец `kind` в таблицу `system.opentelemetry_span_log`. Этот столбец хранит значение [SpanKind](https://opentelemetry.io/docs/reference/specification/trace/api/#spankind), определённое в OpenTelemetry. [#47499](https://github.com/ClickHouse/ClickHouse/pull/47499) ([Frank Chen](https://github.com/FrankChen021)).
* Стало возможным чтение и запись вложенных массивов в формате `Protobuf`, используя в качестве имени столбца только имя корневого поля. Ранее имя столбца должно было содержать все вложенные имена полей (например, `a.b.c Array(Array(Array(UInt32)))`, теперь можно использовать просто `a Array(Array(Array(UInt32)))`. [#47650](https://github.com/ClickHouse/ClickHouse/pull/47650) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен необязательный модификатор `STRICT` для `SYSTEM SYNC REPLICA`, который заставляет запрос ждать, пока очередь репликации не опустеет (как это работало до [https://github.com/ClickHouse/ClickHouse/pull/45648](https://github.com/ClickHouse/ClickHouse/pull/45648)). [#47659](https://github.com/ClickHouse/ClickHouse/pull/47659) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Улучшены названия некоторых логов спанов OpenTelemetry. [#47667](https://github.com/ClickHouse/ClickHouse/pull/47667) ([Frank Chen](https://github.com/FrankChen021)).
* Запрещено использование слишком длинных последовательностей комбинаторов агрегатных функций (они могут приводить к медленным запросам на этапе анализа). Закрывает [#47715](https://github.com/ClickHouse/ClickHouse/issues/47715). [#47716](https://github.com/ClickHouse/ClickHouse/pull/47716) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка подзапросов в параметризованных представлениях; исправлены [#46741](https://github.com/ClickHouse/ClickHouse/issues/46741) [#47725](https://github.com/ClickHouse/ClickHouse/pull/47725) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлена утечка памяти в интеграции с MySQL (воспроизводится при `connection_auto_close=1`). [#47732](https://github.com/ClickHouse/ClickHouse/pull/47732) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Улучшена обработка ошибок в коде, работающем с параметрами Decimal, что привело к более информативным сообщениям об ошибках. Ранее при передаче некорректных параметров Decimal выводилось неясное или мало полезное сообщение об ошибке. В этом обновлении текст сообщения был исправлен так, чтобы предоставлять более подробную и полезную информацию, что упрощает выявление и устранение проблем, связанных с параметрами Decimal. [#47812](https://github.com/ClickHouse/ClickHouse/pull/47812) ([Yu Feng](https://github.com/Vigor-jpg)). Примечание: эта запись в журнале изменений была переформулирована ChatGPT.
* Параметр `exact_rows_before_limit` используется для того, чтобы параметр `rows_before_limit_at_least` точно отражал количество строк, возвращённых до достижения лимита. Этот pull request исправляет проблемы, возникавшие, если запрос выполнялся с распределённой обработкой по нескольким сегментам или с операциями сортировки. До этого обновления такие сценарии работали не так, как предполагалось. [#47874](https://github.com/ClickHouse/ClickHouse/pull/47874) ([Amos Bird](https://github.com/amosbird)).
* Интроспекция метрик пулов потоков. [#47880](https://github.com/ClickHouse/ClickHouse/pull/47880) ([Azat Khuzhin](https://github.com/azat)).
* Добавлены события профилирования `WriteBufferFromS3Microseconds` и `WriteBufferFromS3RequestsErrors`. [#47885](https://github.com/ClickHouse/ClickHouse/pull/47885) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлены опции `--link` и `--noninteractive` (`-y`) при установке ClickHouse. Закрыта задача [#47750](https://github.com/ClickHouse/ClickHouse/issues/47750). [#47887](https://github.com/ClickHouse/ClickHouse/pull/47887) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлено возникновение исключения `UNKNOWN_TABLE` при выполнении ATTACH для materialized view, у которой есть зависящие от неё, но недоступные таблицы. Это может быть полезно при попытке восстановить состояние из резервной копии. [#47975](https://github.com/ClickHouse/ClickHouse/pull/47975) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Исправлена ситуация, когда (необязательный) путь не добавлялся в конфигурацию зашифрованного диска. [#47981](https://github.com/ClickHouse/ClickHouse/pull/47981) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Поддержка CTE в параметризованных представлениях. Реализация: добавлена поддержка параметров запроса при вычислении скалярных подзапросов. [#48065](https://github.com/ClickHouse/ClickHouse/pull/48065) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Добавлена поддержка типов больших целых чисел `(U)Int128/(U)Int256`, `Map` с ключами любого типа и `DateTime64` с произвольной точностью (не только 3 и 6). [#48119](https://github.com/ClickHouse/ClickHouse/pull/48119) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена возможность пропускать ошибки, связанные с неизвестными значениями enum, во входных форматах построчного ввода данных. [#48133](https://github.com/ClickHouse/ClickHouse/pull/48133) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-9}

* ClickHouse теперь собирается с `C++23`. [#47424](https://github.com/ClickHouse/ClickHouse/pull/47424) ([Robert Schulze](https://github.com/rschu1ze)).
* Фаззинг запросов `EXPLAIN` в AST Fuzzer. [#47803](https://github.com/ClickHouse/ClickHouse/pull/47803) [#47852](https://github.com/ClickHouse/ClickHouse/pull/47852) ([flynn](https://github.com/ucasfl)).
* Разделены стресс‑тест и автоматическая проверка обратной совместимости (теперь Upgrade check). [#44879](https://github.com/ClickHouse/ClickHouse/pull/44879) ([Kruglov Pavel](https://github.com/Avogar)).
* Обновлён образ Ubuntu для Docker, чтобы «успокоить» некоторые ложные отчёты о безопасности. [#46784](https://github.com/ClickHouse/ClickHouse/pull/46784) ([Julio Jimenez](https://github.com/juliojimenez)). Обратите внимание, что ClickHouse не имеет зависимостей и не требует Docker.
* Добавлена подсказка, позволяющая удалить уже существующий загруженный бинарный файл `clickhouse` при использовании загрузки ClickHouse через "curl | sh". Текст подсказки: "ClickHouse binary clickhouse already exists. Overwrite? \[y/N\]". [#46859](https://github.com/ClickHouse/ClickHouse/pull/46859) ([Dan Roscigno](https://github.com/DanRoscigno)).
* Исправлена ошибка при запуске сервера на старых дистрибутивах (например, Amazon Linux 2) и на ARM, когда не находились символы glibc 2.28. [#47008](https://github.com/ClickHouse/ClickHouse/pull/47008) ([Robert Schulze](https://github.com/rschu1ze)).
* Подготовка к clang 16. [#47027](https://github.com/ClickHouse/ClickHouse/pull/47027) ([Amos Bird](https://github.com/amosbird)).
* Добавлена проверка в CI, которая гарантирует, что ClickHouse может работать со старой glibc на ARM. [#47063](https://github.com/ClickHouse/ClickHouse/pull/47063) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена проверка стиля для предотвращения некорректного использования макроса `NDEBUG`. [#47699](https://github.com/ClickHouse/ClickHouse/pull/47699) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Незначительно ускорена сборка. [#47714](https://github.com/ClickHouse/ClickHouse/pull/47714) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Обновлён `vectorscan` до версии 5.4.9. [#47955](https://github.com/ClickHouse/ClickHouse/pull/47955) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлен модульный тест, который проверяет, что аварийное логирование Apache Arrow не приводит к аварийному завершению (abort). Он покрывает изменения в [ClickHouse/arrow#16](https://github.com/ClickHouse/arrow/pull/16). [#47958](https://github.com/ClickHouse/ClickHouse/pull/47958) ([Arthur Passos](https://github.com/arthurpassos)).
* Восстановлена возможность запуска нативной отладочной сборки сервера для macOS. [#48050](https://github.com/ClickHouse/ClickHouse/pull/48050) ([Robert Schulze](https://github.com/rschu1ze)). Примечание: это изменение актуально только для разработки, поскольку официальные сборки ClickHouse собираются с использованием кросс‑компиляции.

#### Исправление ошибки (некорректное поведение, заметное пользователю, в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-9}

* Исправлен некорректный сброс парсера форматов, добавлен тест обработки некорректных сообщений в `Kafka` [#45693](https://github.com/ClickHouse/ClickHouse/pull/45693) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен расчет объема данных в Keeper [#46086](https://github.com/ClickHouse/ClickHouse/pull/46086) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка в автоматических повторных попытках выполнения запроса `DROP TABLE` для таблиц `ReplicatedMergeTree` и баз данных `Atomic`. В редких случаях это могло приводить к ошибкам `Can't get data for node /zk_path/log_pointer` и `The specified key does not exist`, если срок действия сессии ZooKeeper истекал во время выполнения DROP, а новая реплицируемая таблица с тем же путём в ZooKeeper создавалась параллельно. [#46384](https://github.com/ClickHouse/ClickHouse/pull/46384) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена некорректная рекурсия алиасов при нормализации запросов, которая приводила к тому, что некоторые запросы не выполнялись. [#46609](https://github.com/ClickHouse/ClickHouse/pull/46609) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлены проблемы с сериализацией и десериализацией IPv4/IPv6 в бинарных форматах [#46616](https://github.com/ClickHouse/ClickHouse/pull/46616) ([Kruglov Pavel](https://github.com/Avogar)).
* ActionsDAG: не изменять результат операции `and` во время оптимизации [#46653](https://github.com/ClickHouse/ClickHouse/pull/46653) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Улучшена отмена запросов при аварийном завершении работы клиента [#46681](https://github.com/ClickHouse/ClickHouse/pull/46681) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлены арифметические операции в оптимизации агрегирования [#46705](https://github.com/ClickHouse/ClickHouse/pull/46705) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлено возможное аварийное завершение `clickhouse-local` при автоматическом определении схемы JSONEachRow [#46731](https://github.com/ClickHouse/ClickHouse/pull/46731) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка при изменении истёкшей роли [#46772](https://github.com/ClickHouse/ClickHouse/pull/46772) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена ошибка комбинированного накопления столбцов PREWHERE из нескольких шагов [#46785](https://github.com/ClickHouse/ClickHouse/pull/46785) ([Alexander Gololobov](https://github.com/davenger)).
* Теперь используется начальный диапазон для определения размера файла в HTTP-буфере чтения. Без этого изменения некоторые удалённые файлы не могли быть обработаны. [#46824](https://github.com/ClickHouse/ClickHouse/pull/46824) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлен некорректно работающий индикатор прогресса при использовании URL-таблиц [#46830](https://github.com/ClickHouse/ClickHouse/pull/46830) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлен отчет MSan в функции `maxIntersections` [#46847](https://github.com/ClickHouse/ClickHouse/pull/46847) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка в типе данных `Map` [#46856](https://github.com/ClickHouse/ClickHouse/pull/46856) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлены некорректные результаты некоторых запросов с использованием LIKE, когда шаблон LIKE содержит экранированные символы, которые не подлежат экранированию [#46875](https://github.com/ClickHouse/ClickHouse/pull/46875) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправление: `WITH FILL` мог приводить к аварийному завершению работы, когда FillingTransform обрабатывал пустой блок [#46897](https://github.com/ClickHouse/ClickHouse/pull/46897) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлен вывод типов `date` и `int` из строк в JSON [#46972](https://github.com/ClickHouse/ClickHouse/pull/46972) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка выбора диска для zero-copy репликации при выполнении fetch [#47010](https://github.com/ClickHouse/ClickHouse/pull/47010) ([alesapin](https://github.com/alesapin)).
* Исправлена опечатка в определении службы systemd [#47051](https://github.com/ClickHouse/ClickHouse/pull/47051) ([Palash Goel](https://github.com/palash-goel)).
* Исправлена ошибка NOT&#95;IMPLEMENTED, возникавшая при использовании CROSS JOIN и algorithm = auto [#47068](https://github.com/ClickHouse/ClickHouse/pull/47068) ([Vladimir C](https://github.com/vdimir)).
* Исправлена проблема, из-за которой таблица &#39;ReplicatedMergeTree&#39; не могла вставить две одинаковые строки данных, когда &#39;part&#95;type&#39; был настроен в режиме &#39;InMemory&#39; (экспериментальная функция). [#47121](https://github.com/ClickHouse/ClickHouse/pull/47121) ([liding1992](https://github.com/liding1992)).
* External dictionaries / library-bridge: исправлена ошибка &quot;unknown library method &#39;extDict&#95;libClone&#39;&quot; [#47136](https://github.com/ClickHouse/ClickHouse/pull/47136) ([alex filatov](https://github.com/phil-88)).
* Исправлена гонка в grace hash join с ограничением LIMIT [#47153](https://github.com/ClickHouse/ClickHouse/pull/47153) ([Vladimir C](https://github.com/vdimir)).
* Исправлена поддержка PREWHERE для отдельных столбцов [#47154](https://github.com/ClickHouse/ClickHouse/pull/47154) ([Azat Khuzhin](https://github.com/azat)).
* Устранена возможная взаимная блокировка в Query Status [#47161](https://github.com/ClickHouse/ClickHouse/pull/47161) ([Kruglov Pavel](https://github.com/Avogar)).
* Запрещён `INSERT SELECT` для одной и той же таблицы типа `Join`, так как это приводит к взаимоблокировке [#47260](https://github.com/ClickHouse/ClickHouse/pull/47260) ([Vladimir C](https://github.com/vdimir)).
* Пропускать уже слитые партиции при слияниях по порогу `min_age_to_force_merge_seconds` [#47303](https://github.com/ClickHouse/ClickHouse/pull/47303) ([Antonio Andelic](https://github.com/antonio2368)).
* Изменена функция find&#95;first&#95;symbols, чтобы она корректно работала с find&#95;first&#95;not&#95;symbols [#47304](https://github.com/ClickHouse/ClickHouse/pull/47304) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлено определение типов для больших чисел в CSV [#47410](https://github.com/ClickHouse/ClickHouse/pull/47410) ([Kruglov Pavel](https://github.com/Avogar)).
* Отключена оптимизация логических выражений для выражений с псевдонимами. [#47451](https://github.com/ClickHouse/ClickHouse/pull/47451) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка в `decodeURLComponent` [#47457](https://github.com/ClickHouse/ClickHouse/pull/47457) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлен граф EXPLAIN при использовании PROJECTION [#47473](https://github.com/ClickHouse/ClickHouse/pull/47473) ([flynn](https://github.com/ucasfl)).
* Исправлена обработка параметров запроса [#47488](https://github.com/ClickHouse/ClickHouse/pull/47488) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Параметризованное представление: исправление ошибки. [#47495](https://github.com/ClickHouse/ClickHouse/pull/47495) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Фаззер для форматов данных и соответствующие исправления. [#47519](https://github.com/ClickHouse/ClickHouse/pull/47519) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена проверка монотонности для типа данных `DateTime64` [#47526](https://github.com/ClickHouse/ClickHouse/pull/47526) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка «block structure mismatch» для столбца типа Nullable(LowCardinality) [#47537](https://github.com/ClickHouse/ClickHouse/pull/47537) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Корректное устранение ошибки в Apache Parquet [#45878](https://github.com/ClickHouse/ClickHouse/issues/45878) [#47538](https://github.com/ClickHouse/ClickHouse/pull/47538) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен параллельный разбор формата `BSONEachRow` при некорректном размере документа [#47540](https://github.com/ClickHouse/ClickHouse/pull/47540) ([Kruglov Pavel](https://github.com/Avogar)).
* Сохранять ошибку в `system.distribution_queue` при выполнении команды `SYSTEM FLUSH DISTRIBUTED` [#47541](https://github.com/ClickHouse/ClickHouse/pull/47541) ([Azat Khuzhin](https://github.com/azat)).
* Проверка наличия дублирующегося столбца в формате `BSONEachRow` [#47609](https://github.com/ClickHouse/ClickHouse/pull/47609) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено ожидание блокировки zero-copy при перемещении [#47631](https://github.com/ClickHouse/ClickHouse/pull/47631) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка агрегации по партициям [#47634](https://github.com/ClickHouse/ClickHouse/pull/47634) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена ошибка в сериализации кортежа в виде массива в формате `BSONEachRow` [#47690](https://github.com/ClickHouse/ClickHouse/pull/47690) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен сбой в `polygonsSymDifferenceCartesian` [#47702](https://github.com/ClickHouse/ClickHouse/pull/47702) ([pufit](https://github.com/pufit)).
* Исправлено чтение сжатых файлов из хранилища `File` с компрессией `zlib` и `gzip` [#47796](https://github.com/ClickHouse/ClickHouse/pull/47796) ([Anton Popov](https://github.com/CurtizJ)).
* Улучшено обнаружение пустых запросов для PostgreSQL (для драйвера pgx для Go) [#47854](https://github.com/ClickHouse/ClickHouse/pull/47854) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проверка монотонности DateTime для типов LowCardinality [#47860](https://github.com/ClickHouse/ClickHouse/pull/47860) ([Antonio Andelic](https://github.com/antonio2368)).
* Используйте restore&#95;threads (а не backup&#95;threads) для RESTORE ASYNC [#47861](https://github.com/ClickHouse/ClickHouse/pull/47861) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа DROP COLUMN для таблиц ReplicatedMergeTree с проекциями [#47883](https://github.com/ClickHouse/ClickHouse/pull/47883) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено восстановление реплицированной базы данных [#47901](https://github.com/ClickHouse/ClickHouse/pull/47901) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Хотфикс слишком подробных HTTP‑предупреждений [#47903](https://github.com/ClickHouse/ClickHouse/pull/47903) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена ошибка «Field value too long» в `catboostEvaluate` [#47970](https://github.com/ClickHouse/ClickHouse/pull/47970) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправление [#36971](https://github.com/ClickHouse/ClickHouse/issues/36971): Watchdog: завершать работу с ненулевым кодом, если завершается дочерний процесс [#47973](https://github.com/ClickHouse/ClickHouse/pull/47973) ([Коренберг Марк](https://github.com/socketpair)).
* Исправлена ошибка: «файл индекса `cidx` неожиданно длинный» [#48010](https://github.com/ClickHouse/ClickHouse/pull/48010) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлен запрос MaterializedPostgreSQL для получения атрибутов replica-identity [#48015](https://github.com/ClickHouse/ClickHouse/pull/48015) ([Solomatov Sergei](https://github.com/solomatovs)).
* parseDateTime(): Исправлено неопределённое поведение (переполнение знакового целого) [#48019](https://github.com/ClickHouse/ClickHouse/pull/48019) ([Robert Schulze](https://github.com/rschu1ze)).
* Используйте уникальные имена для записей (Record) в Avro, чтобы избежать повторного использования их схемы [#48057](https://github.com/ClickHouse/ClickHouse/pull/48057) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена установка тайм-аутов TCP/HTTP-сокетов в Keeper [#48108](https://github.com/ClickHouse/ClickHouse/pull/48108) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлен возможный вызов метода на нулевом указателе в формате `Avro` [#48184](https://github.com/ClickHouse/ClickHouse/pull/48184) ([Kruglov Pavel](https://github.com/Avogar)).

### <a id="232"></a> Релиз ClickHouse 23.2, 2023-02-23. [Презентация](https://presentations.clickhouse.com/2023-release-23.2/), [Видео](https://www.youtube.com/watch?v=2o0vRMMIrkY) {#232}

<iframe width="1024" height="576" src="https://www.youtube.com/embed/2o0vRMMIrkY" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

#### Обратимое с предыдущими версиями изменение {#backward-incompatible-change-8}

* Функция `toDayOfWeek()` (псевдоним: `DAYOFWEEK`) расширена аргументом режима, который задаёт, начинается ли неделя с понедельника или воскресенья и начинается ли отсчёт с 0 или с 1. Для согласованности с другими функциями работы с датой и временем аргумент режима был добавлен между аргументами времени и часового пояса. Это ломает существующее использование (ранее недокументированного) синтаксиса с двумя аргументами `toDayOfWeek(time, time_zone)`. Чтобы исправить это, перепишите вызов функции как `toDayOfWeek(time, 0, time_zone)`. [#45233](https://github.com/ClickHouse/ClickHouse/pull/45233) ([Robert Schulze](https://github.com/rschu1ze)).
* Настройка `max_query_cache_size` переименована в `filesystem_cache_max_download_size`. [#45614](https://github.com/ClickHouse/ClickHouse/pull/45614) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Пользователь `default` по умолчанию не будет иметь прав доступа типа `SHOW NAMED COLLECTION` (например, пользователь `default` больше не сможет выдавать ALL другим пользователям, как это было раньше, поэтому этот PR несовместим с предыдущими версиями). [#46010](https://github.com/ClickHouse/ClickHouse/pull/46010) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Если предложение SETTINGS указано перед предложением FORMAT, настройки также будут применяться к форматированию. [#46003](https://github.com/ClickHouse/ClickHouse/pull/46003) ([Azat Khuzhin](https://github.com/azat)).
* Удалена поддержка настройки `materialized_postgresql_allow_automatic_update` (которая по умолчанию была выключена). [#46106](https://github.com/ClickHouse/ClickHouse/pull/46106) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Незначительно улучшена производительность `countDigits` на реалистичных наборах данных. Этим закрыта задача [#44518](https://github.com/ClickHouse/ClickHouse/issues/44518). В предыдущих версиях `countDigits(0)` возвращала `0`; теперь она возвращает `1`, что более корректно и соответствует существующей документации. [#46187](https://github.com/ClickHouse/ClickHouse/pull/46187) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Запрещено создание новых столбцов, сжатых комбинацией кодеков `Delta` или `DoubleDelta` с последующими кодеками `Gorilla` или `FPC`. Это ограничение можно обойти, используя настройку `allow_suspicious_codecs = true`. [#45652](https://github.com/ClickHouse/ClickHouse/pull/45652) ([Robert Schulze](https://github.com/rschu1ze)).

#### Новая функция {#new-feature-10}

* Добавлены `StorageIceberg` и табличная функция `iceberg` для доступа к хранилищу таблиц Iceberg в S3. [#45384](https://github.com/ClickHouse/ClickHouse/pull/45384) ([flynn](https://github.com/ucasfl)).
* Добавлена возможность настраивать хранилище с помощью `SETTINGS disk = '<disk_name>'` (вместо `storage_policy`), а также с явным созданием диска `SETTINGS disk = disk(type=s3, ...)`. [#41976](https://github.com/ClickHouse/ClickHouse/pull/41976) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлены счетчики `ProfileEvents` в `system.part_log`. [#38614](https://github.com/ClickHouse/ClickHouse/pull/38614) ([Bharat Nallan](https://github.com/bharatnc)).
* Расширение существующего движка `ReplacingMergeTree`, позволяющее вставлять дубликаты. Он объединяет возможности `ReplacingMergeTree` и `CollapsingMergeTree` в одном движке MergeTree. Удалённые данные не возвращаются при запросах, но при этом не удаляются с диска. [#41005](https://github.com/ClickHouse/ClickHouse/pull/41005) ([youennL-cs](https://github.com/youennL-cs)).
* Добавлена функция `generateULID`. Закрыта задача [#36536](https://github.com/ClickHouse/ClickHouse/issues/36536). [#44662](https://github.com/ClickHouse/ClickHouse/pull/44662) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена агрегатная функция `corrMatrix`, вычисляющая корреляцию для каждой пары столбцов. Дополнительно, так как агрегатные функции `covarSamp` и `covarPop` похожи на `corr`, заодно добавлены агрегатные функции `covarSampMatrix` и `covarPopMatrix`. @alexey-milovidov закрывает [#44587](https://github.com/ClickHouse/ClickHouse/issues/44587). [#44680](https://github.com/ClickHouse/ClickHouse/pull/44680) ([FFFFFFFHHHHHHH](https://github.com/FFFFFFFHHHHHHH)).
* Добавлена функция arrayShuffle для случайных перестановок элементов массива. [#45271](https://github.com/ClickHouse/ClickHouse/pull/45271) ([Joanna Hulboj](https://github.com/jh0x)).
* Добавлена поддержка типов `FIXED_SIZE_BINARY` в Arrow и `FIXED_LENGTH_BYTE_ARRAY` в `Parquet` и их отображение на тип `FixedString`. Добавлены настройки `output_format_parquet_fixed_string_as_fixed_byte_array/output_format_arrow_fixed_string_as_fixed_byte_array` для управления типом выходных данных по умолчанию для `FixedString`. Закрывает [#45326](https://github.com/ClickHouse/ClickHouse/issues/45326). [#45340](https://github.com/ClickHouse/ClickHouse/pull/45340) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен новый столбец `last_exception_time` в system.replication&#95;queue. [#45457](https://github.com/ClickHouse/ClickHouse/pull/45457) ([Frank Chen](https://github.com/FrankChen021)).
* Добавлены две новые функции, которые позволяют использовать заданные пользователем ключи/seed для SipHash{64,128}. [#45513](https://github.com/ClickHouse/ClickHouse/pull/45513) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Добавлена поддержка версии табличной функции `format` с тремя аргументами. Закрыто [#45808](https://github.com/ClickHouse/ClickHouse/issues/45808). [#45873](https://github.com/ClickHouse/ClickHouse/pull/45873) ([FFFFFFFHHHHHHH](https://github.com/FFFFFFFHHHHHHH)).
* Добавлена поддержка формата `JodaTime` для спецификаторов &#39;x&#39;, &#39;w&#39;, &#39;S&#39;. См. [https://joda-time.sourceforge.net/apidocs/org/joda/time/format/DateTimeFormat.html](https://joda-time.sourceforge.net/apidocs/org/joda/time/format/DateTimeFormat.html). [#46073](https://github.com/ClickHouse/ClickHouse/pull/46073) ([zk&#95;kiger](https://github.com/zk-kiger)).
* Добавлена поддержка оконной функции `ntile`. ([lgbo](https://github.com/lgbo-ustc)).
* Добавлена настройка `final`, которая неявно применяет модификатор `FINAL` ко всем таблицам. [#40945](https://github.com/ClickHouse/ClickHouse/pull/40945) ([Arthur Passos](https://github.com/arthurpassos)).
* Добавлены функции `arrayPartialSort` и `arrayPartialReverseSort`. [#46296](https://github.com/ClickHouse/ClickHouse/pull/46296) ([Joanna Hulboj](https://github.com/jh0x)).
* Новый HTTP-параметр `client_protocol_version` позволяет задавать версию клиентского протокола в HTTP-ответах при использовании формата Native. [#40397](https://github.com/ClickHouse/ClickHouse/issues/40397). [#46360](https://github.com/ClickHouse/ClickHouse/pull/46360) ([Geoff Genz](https://github.com/genzgd)).
* Добавлена новая функция `regexpExtract`, по аналогии с функцией Spark `REGEXP_EXTRACT` для совместимости. Она похожа на существующую функцию `extract`. [#46469](https://github.com/ClickHouse/ClickHouse/pull/46469) ([李扬](https://github.com/taiyang-li)).
* Добавлена новая функция `JSONArrayLength`, которая возвращает количество элементов во внешнем JSON-массиве. Функция возвращает NULL, если входная JSON-строка некорректна. [#46631](https://github.com/ClickHouse/ClickHouse/pull/46631) ([李扬](https://github.com/taiyang-li)).

#### Повышение производительности {#performance-improvement-10}

* Новая логика работает, если условие PREWHERE является конъюнкцией из нескольких условий (cond1 AND cond2 AND ... ). Она группирует в шаги те условия, для которых требуется чтение одних и тех же столбцов. После каждого шага вычисляется соответствующая часть полного условия, и результирующие строки могут быть отфильтрованы. Это позволяет читать меньше строк на последующих шагах, тем самым экономя пропускную способность ввода-вывода (I/O) и снижая объём вычислений. В настоящее время эта логика по умолчанию отключена. Она будет включена по умолчанию в одном из будущих релизов, как только будет подтверждено отсутствие регрессий, поэтому настоятельно рекомендуется использовать её при тестировании. Управлять ей можно с помощью двух настроек: &quot;enable&#95;multiple&#95;prewhere&#95;read&#95;steps&quot; и &quot;move&#95;all&#95;conditions&#95;to&#95;prewhere&quot;. [#46140](https://github.com/ClickHouse/ClickHouse/pull/46140) ([Alexander Gololobov](https://github.com/davenger)).
* Добавлена опция, позволяющая независимо агрегировать партиции, если ключ партиционирования таблицы и ключ GROUP BY совместимы. Управляется настройкой `allow_aggregate_partitions_independently`. По умолчанию отключена из‑за ограниченной применимости (см. документацию). [#45364](https://github.com/ClickHouse/ClickHouse/pull/45364) ([Nikita Taranov](https://github.com/nickitat)).
* Разрешено использовать алгоритм вертикального слияния для частей в формате Compact. Это позволит серверу ClickHouse использовать значительно меньше памяти при фоновых операциях. Это закрывает задачу [#46084](https://github.com/ClickHouse/ClickHouse/issues/46084). [#45681](https://github.com/ClickHouse/ClickHouse/pull/45681) [#46282](https://github.com/ClickHouse/ClickHouse/pull/46282) ([Anton Popov](https://github.com/CurtizJ)).
* Оптимизирован ридер `Parquet` за счет использования пакетного ридера. [#45878](https://github.com/ClickHouse/ClickHouse/pull/45878) ([LiuNeng](https://github.com/liuneng1994)).
* Добавлено новое значение параметра `local_filesystem_read_method` — `io_uring`, основанное на асинхронной подсистеме Linux [io&#95;uring](https://kernel.dk/io_uring.pdf), что практически во всех случаях повышает производительность чтения по сравнению с методом `pread` по умолчанию. [#38456](https://github.com/ClickHouse/ClickHouse/pull/38456) ([Saulius Valatka](https://github.com/sauliusvl)).
* Переписывайте агрегатные функции с выражением `if` в качестве аргумента, когда это логически эквивалентно. Например, `avg(if(cond, col, null))` можно переписать как avgIf(cond, col). Это помогает повысить производительность. [#44730](https://github.com/ClickHouse/ClickHouse/pull/44730) ([李扬](https://github.com/taiyang-li)).
* Улучшена производительность функций lower/upper с использованием инструкций AVX-512. [#37894](https://github.com/ClickHouse/ClickHouse/pull/37894) ([yaqi-zhao](https://github.com/yaqi-zhao)).
* Убрано ограничение, из-за которого на системах с &gt;=32 ядрами и отключённым SMT ClickHouse использует только половину ядер (когда в BIOS отключён Hyper-Threading). [#44973](https://github.com/ClickHouse/ClickHouse/pull/44973) ([Robert Schulze](https://github.com/rschu1ze)).
* Улучшена производительность функции `multiIf` за счёт столбцового выполнения, скорость увеличена в 2,3 раза. [#45296](https://github.com/ClickHouse/ClickHouse/pull/45296) ([李扬](https://github.com/taiyang-li)).
* Добавлен быстрый путь выполнения для функции `position`, когда искомая подстрока пуста. [#45382](https://github.com/ClickHouse/ClickHouse/pull/45382) ([李扬](https://github.com/taiyang-li)).
* По умолчанию включена оптимизация `query_plan_remove_redundant_sorting`. Оптимизация реализована в [#45420](https://github.com/ClickHouse/ClickHouse/issues/45420). [#45567](https://github.com/ClickHouse/ClickHouse/pull/45567) ([Igor Nikonov](https://github.com/devcrafter)).
* Увеличен размер фрагмента в HTTP Transfer Encoding для повышения производительности выполнения больших запросов через HTTP-интерфейс. [#45593](https://github.com/ClickHouse/ClickHouse/pull/45593) ([Geoff Genz](https://github.com/genzgd)).
* Улучшена производительность коротких запросов `SELECT`, которые читают данные из таблиц с большим числом столбцов типов `Array`/`Map`/`Nested`. [#45630](https://github.com/ClickHouse/ClickHouse/pull/45630) ([Anton Popov](https://github.com/CurtizJ)).
* Повышена производительность фильтрации для больших целых чисел и типов Decimal. [#45949](https://github.com/ClickHouse/ClickHouse/pull/45949) ([李扬](https://github.com/taiyang-li)).
* Это изменение может эффективно снизить накладные расходы на получение фильтра из столбца ColumnNullable(UInt8) и улучшить общую производительность выполнения запросов. Для оценки влияния этого изменения мы использовали бенчмарк TPC-H, предварительно изменив типы столбцов с non-nullable на Nullable, и измеряли QPS его запросов в качестве показателя производительности. [#45962](https://github.com/ClickHouse/ClickHouse/pull/45962) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
* Виртуальные столбцы `_part` и `_partition_id` теперь имеют тип `LowCardinality(String)`. Закрывает [#45964](https://github.com/ClickHouse/ClickHouse/issues/45964). [#45975](https://github.com/ClickHouse/ClickHouse/pull/45975) ([flynn](https://github.com/ucasfl)).
* Улучшена производительность преобразования Decimal при неизменном масштабе. [#46095](https://github.com/ClickHouse/ClickHouse/pull/46095) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Позволяет увеличить предвыборку данных при чтении. [#46168](https://github.com/ClickHouse/ClickHouse/pull/46168) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Переписали `arrayExists(x -> x = 1, arr)` -&gt; `has(arr, 1)`, что улучшило производительность в 1,34 раза. [#46188](https://github.com/ClickHouse/ClickHouse/pull/46188) ([李扬](https://github.com/taiyang-li)).
* Исправлено чрезмерное использование памяти при вертикальных слияниях на локальном диске. Параметр `max_insert_delayed_streams_for_parallel_write` теперь учитывается для удалённого диска. [#46275](https://github.com/ClickHouse/ClickHouse/pull/46275) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Обновлена библиотека zstd до версии v1.5.4. В ней есть некоторые незначительные улучшения производительности и коэффициента сжатия. Если вы используете реплики с разными версиями ClickHouse, вы можете увидеть корректные сообщения об ошибках `Data after merge/mutation is not byte-identical to data on another replicas.` с пояснением. Эти сообщения ожидаемы и не являются поводом для беспокойства. [#46280](https://github.com/ClickHouse/ClickHouse/pull/46280) ([Raúl Marín](https://github.com/Algunenano)).
* Устранена деградация производительности, вызванная [#39737](https://github.com/ClickHouse/ClickHouse/issues/39737). [#46309](https://github.com/ClickHouse/ClickHouse/pull/46309) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Обработчик `replicas_status` будет отвечать быстро даже при большой очереди репликации. [#46310](https://github.com/ClickHouse/ClickHouse/pull/46310) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка AVX-512 для агрегатной функции `sum`, унарных арифметических и сравнительных функций. [#37870](https://github.com/ClickHouse/ClickHouse/pull/37870) ([zhao zhou](https://github.com/zzachimed)).
* Переписан код, отвечающий за распределение меток и общую координацию чтения, чтобы добиться максимального прироста производительности. Это закрывает [#34527](https://github.com/ClickHouse/ClickHouse/issues/34527). [#43772](https://github.com/ClickHouse/ClickHouse/pull/43772) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Удаляет избыточные предложения `DISTINCT` в запросах (подзапросах). Реализовано на основе плана запроса. Выполняет оптимизацию, аналогичную `optimize_duplicate_order_by_and_distinct` в отношении предложений `DISTINCT`. Может быть включено с помощью настройки `query_plan_remove_redundant_distinct`. Связано с [#42648](https://github.com/ClickHouse/ClickHouse/issues/42648). [#44176](https://github.com/ClickHouse/ClickHouse/pull/44176) ([Igor Nikonov](https://github.com/devcrafter)).
* Несколько оптимизаций для переписывания запросов: `sumIf(123, cond) -> 123 * countIf(1, cond)`, `sum(if(cond, 123, 0)) -> 123 * countIf(cond)`, `sum(if(cond, 0, 123)) -> 123 * countIf(not(cond))` [#44728](https://github.com/ClickHouse/ClickHouse/pull/44728) ([李扬](https://github.com/taiyang-li)).
* Улучшено взаимодействие ограниченного по памяти слияния и агрегации по порядку на верхнем уровне плана запроса. Ранее в некоторых случаях мы переходили к явной сортировке для AIO, хотя в этом не было реальной необходимости. [#45892](https://github.com/ClickHouse/ClickHouse/pull/45892) ([Nikita Taranov](https://github.com/nickitat)).
* Одновременные слияния по умолчанию планируются по принципу циклического обхода (round-robin), чтобы обеспечить справедливую работу без «голодания» задач. Ранее в сильно перегруженных сегментах крупные слияния могли «голодать» по сравнению с мелкими из-за использования строгого приоритетного планирования. Добавлен серверный параметр конфигурации `background_merges_mutations_scheduling_policy` для выбора алгоритма планирования (`round_robin` или `shortest_task_first`). [#46247](https://github.com/ClickHouse/ClickHouse/pull/46247) ([Sergei Trifonov](https://github.com/serxa)).

#### Улучшения {#improvement-10}

* Включить повторные попытки выполнения INSERT по умолчанию при потере сессии ZooKeeper. Мы уже используем эту настройку в продакшене. [#46308](https://github.com/ClickHouse/ClickHouse/pull/46308) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность игнорировать неизвестные ключи в объекте JSON для именованных кортежей (`input_format_json_ignore_unknown_keys_in_named_tuple`). [#45678](https://github.com/ClickHouse/ClickHouse/pull/45678) ([Azat Khuzhin](https://github.com/azat)).
* Реализована оптимизация условия `where` с переносом выражения ключа сортировки в `prewhere` для запросов с `final`. [#38893](https://github.com/ClickHouse/ClickHouse/issues/38893). [#38950](https://github.com/ClickHouse/ClickHouse/pull/38950) ([hexiaoting](https://github.com/hexiaoting)).
* Добавлены новые метрики для бэкапов: num&#95;processed&#95;files и processed&#95;files&#95;size, отражающие фактическое количество обработанных файлов и их общий размер. [#42244](https://github.com/ClickHouse/ClickHouse/pull/42244) ([Aleksandr](https://github.com/AVMusorin)).
* Добавлены повторные попытки при межсерверных ошибках DNS. [#43179](https://github.com/ClickHouse/ClickHouse/pull/43179) ([Anton Kozlov](https://github.com/tonickkozlov)).
* Улучшение Keeper: добавлена предварительная аллокация места на диске, чтобы избежать неочевидных проблем при нехватке свободного пространства. Введена настройка `max_log_file_size` для задания максимального размера файлов журнала Raft в Keeper. [#44370](https://github.com/ClickHouse/ClickHouse/pull/44370) ([Antonio Andelic](https://github.com/antonio2368)).
* Оптимизирована работа логики API задержки реплики, если реплика доступна только для чтения. [#45148](https://github.com/ClickHouse/ClickHouse/pull/45148) ([mateng915](https://github.com/mateng0915)).
* Запрашивать пароль в clickhouse-client в интерактивном режиме, если пустой пароль не подходит. Закрывает [#46702](https://github.com/ClickHouse/ClickHouse/issues/46702). [#46730](https://github.com/ClickHouse/ClickHouse/pull/46730) ([Nikolay Degterinsky](https://github.com/evillique)).
* Помечать использование сжатия `Gorilla` для столбцов с типом, отличным от Float*, как подозрительное. [#45376](https://github.com/ClickHouse/ClickHouse/pull/45376) ([Robert Schulze](https://github.com/rschu1ze)).
* Теперь в столбце `postpone_reason` отображается имя реплики, выполняющей слияние. [#45458](https://github.com/ClickHouse/ClickHouse/pull/45458) ([Frank Chen](https://github.com/FrankChen021)).
* Сохранять трассировку стека исключения в `part_log`. [#45459](https://github.com/ClickHouse/ClickHouse/pull/45459) ([Frank Chen](https://github.com/FrankChen021)).
* Словарь `regexp_tree` улучшен и теперь совместим с [https://github.com/ua-parser/uap-core](https://github.com/ua-parser/uap-core). [#45631](https://github.com/ClickHouse/ClickHouse/pull/45631) ([Han Fei](https://github.com/hanfei1991)).
* Обновлена проверка `SYSTEM SYNC REPLICA`, что решает [#45508](https://github.com/ClickHouse/ClickHouse/issues/45508) [#45648](https://github.com/ClickHouse/ClickHouse/pull/45648) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Переименована настройка `replication_alter_partitions_sync` в `alter_sync`. [#45659](https://github.com/ClickHouse/ClickHouse/pull/45659) ([Antonio Andelic](https://github.com/antonio2368)).
* Табличная функция `generateRandom` и движок теперь поддерживают типы данных `LowCardinality`. Это полезно для тестирования, например можно выполнить запрос `INSERT INTO table SELECT * FROM generateRandom() LIMIT 1000`. Это понадобилось для отладки [#45590](https://github.com/ClickHouse/ClickHouse/issues/45590). [#45661](https://github.com/ClickHouse/ClickHouse/pull/45661) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Экспериментальный кэш результатов запроса теперь поддерживает более модульные настройки конфигурации. [#45679](https://github.com/ClickHouse/ClickHouse/pull/45679) ([Robert Schulze](https://github.com/rschu1ze)).
* Компонент «кэш результатов запросов» переименован в «кэш запросов». [#45682](https://github.com/ClickHouse/ClickHouse/pull/45682) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена команда `SYSTEM SYNC FILE CACHE`. Она выполняет системный вызов `sync`. [#8921](https://github.com/ClickHouse/ClickHouse/issues/8921). [#45685](https://github.com/ClickHouse/ClickHouse/pull/45685) ([DR](https://github.com/freedomDR)).
* Добавлен новый параметр S3 `allow_head_object_request`. В этом PR использование запроса `GetObjectAttributes` вместо `HeadObject`, добавленного в [https://github.com/ClickHouse/ClickHouse/pull/45288](https://github.com/ClickHouse/ClickHouse/pull/45288), сделано необязательным (и по умолчанию отключено). [#45701](https://github.com/ClickHouse/ClickHouse/pull/45701) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена возможность переопределять параметры подключения по имени подключения (то есть теперь можно не хранить пароль для каждого подключения отдельно, а просто поместить все параметры в `~/.clickhouse-client/config.xml` и даже использовать для них разные файлы истории, что также может быть полезно). [#45715](https://github.com/ClickHouse/ClickHouse/pull/45715) ([Azat Khuzhin](https://github.com/azat)).
* Формат Arrow: добавлена поддержка типа `duration`. Закрывает [#45669](https://github.com/ClickHouse/ClickHouse/issues/45669). [#45750](https://github.com/ClickHouse/ClickHouse/pull/45750) ([flynn](https://github.com/ucasfl)).
* Расширено логирование в кэше запросов (Query Cache) для улучшения анализа его поведения. [#45751](https://github.com/ClickHouse/ClickHouse/pull/45751) ([Robert Schulze](https://github.com/rschu1ze)).
* Настройки кэша запросов на уровне сервера теперь можно изменять во время работы. [#45758](https://github.com/ClickHouse/ClickHouse/pull/45758) ([Robert Schulze](https://github.com/rschu1ze)).
* Скрывать пароль в логах при указании аргументов табличной функции с помощью именованной коллекции. [#45774](https://github.com/ClickHouse/ClickHouse/pull/45774) ([Vitaly Baranov](https://github.com/vitlibar)).
* Улучшен внутренний S3‑клиент для корректного определения регионов и перенаправлений для различных типов URL-адресов. [#45783](https://github.com/ClickHouse/ClickHouse/pull/45783) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена поддержка типов Map, IPv4 и IPv6 в generateRandom. Прежде всего полезно для тестирования. [#45785](https://github.com/ClickHouse/ClickHouse/pull/45785) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлена поддержка функций empty/notEmpty для IP-типов. [#45799](https://github.com/ClickHouse/ClickHouse/pull/45799) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Столбец `num_processed_files` был разделён на два столбца: `num_files` (для BACKUP) и `files_read` (для RESTORE). Столбец `processed_files_size` был разделён на два столбца: `total_size` (для BACKUP) и `bytes_read` (для RESTORE). [#45800](https://github.com/ClickHouse/ClickHouse/pull/45800) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена поддержка запроса `SHOW ENGINES` для совместимости с MySQL. [#45859](https://github.com/ClickHouse/ClickHouse/pull/45859) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* Улучшена работа обфускатора с запросами. [#45867](https://github.com/ClickHouse/ClickHouse/pull/45867) ([Raúl Marín](https://github.com/Algunenano)).
* Улучшено поведение преобразования в тип Date для граничного значения 65535 (2149-06-06). [#46042](https://github.com/ClickHouse/ClickHouse/pull/46042) [#45914](https://github.com/ClickHouse/ClickHouse/pull/45914) ([Joanna Hulboj](https://github.com/jh0x)).
* Добавлена настройка `check_referential_table_dependencies` для проверки ссылочных зависимостей между таблицами при выполнении `DROP TABLE`. Этот PR решает проблему [#38326](https://github.com/ClickHouse/ClickHouse/issues/38326). [#45936](https://github.com/ClickHouse/ClickHouse/pull/45936) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена функция `tupleElement`, теперь она возвращает `Null` при аргументе `Null`. Закрывает [#45894](https://github.com/ClickHouse/ClickHouse/issues/45894). [#45952](https://github.com/ClickHouse/ClickHouse/pull/45952) ([flynn](https://github.com/ucasfl)).
* Выдавать ошибку при отсутствии файлов, удовлетворяющих шаблону S3. Закрывает [#45587](https://github.com/ClickHouse/ClickHouse/issues/45587). [#45957](https://github.com/ClickHouse/ClickHouse/pull/45957) ([chen](https://github.com/xiedeyantu)).
* Используйте данные о состоянии кластера для проверки одновременного выполнения операций резервного копирования и восстановления. [#45982](https://github.com/ClickHouse/ClickHouse/pull/45982) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* ClickHouse Client: использовать режим сопоставления «exact» для нечеткого поиска, который корректно игнорирует регистр и использует более подходящий алгоритм сопоставления SQL-запросов. [#46000](https://github.com/ClickHouse/ClickHouse/pull/46000) ([Azat Khuzhin](https://github.com/azat)).
* Запрещён некорректный синтаксис создания представления `CREATE View X TO Y AS SELECT`. Закрывает [#4331](https://github.com/ClickHouse/ClickHouse/issues/4331). [#46043](https://github.com/ClickHouse/ClickHouse/pull/46043) ([flynn](https://github.com/ucasfl)).
* Семейство хранилищ `Log` теперь поддерживает настройку параметра `storage_policy`. Закрыта задача [#43421](https://github.com/ClickHouse/ClickHouse/issues/43421). [#46044](https://github.com/ClickHouse/ClickHouse/pull/46044) ([flynn](https://github.com/ucasfl)).
* Улучшен формат `JSONColumns` при пустом результате. Закрывает [#46024](https://github.com/ClickHouse/ClickHouse/issues/46024). [#46053](https://github.com/ClickHouse/ClickHouse/pull/46053) ([flynn](https://github.com/ucasfl)).
* Добавлена эталонная реализация SipHash128. [#46065](https://github.com/ClickHouse/ClickHouse/pull/46065) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Добавлена новая метрика для учёта времени и объёмов выделений памяти с использованием mmap. [#46068](https://github.com/ClickHouse/ClickHouse/pull/46068) ([李扬](https://github.com/taiyang-li)).
* В настоящее время для таких функций, как `leftPad`, `rightPad`, `leftPadUTF8`, `rightPadUTF8`, второй аргумент `length` должен иметь тип одной из следующих целочисленных величин: UInt8, UInt16, UInt32, UInt64, UInt128 или UInt256. Это чересчур ограничительно для пользователей ClickHouse и, кроме того, не согласуется с поведением других аналогичных функций, таких как `arrayResize`, `substring` и т. д. [#46103](https://github.com/ClickHouse/ClickHouse/pull/46103) ([李扬](https://github.com/taiyang-li)).
* Исправлена assert-проверка в функции `welchTTest` в отладочной сборке, когда итоговая статистика равна NaN. Поведение унифицировано с другими аналогичными функциями. Изменено поведение функции `studentTTest` так, чтобы она возвращала NaN вместо выбрасывания исключения, поскольку предыдущее поведение было неудобным. Закрыты [#41176](https://github.com/ClickHouse/ClickHouse/issues/41176) и [#42162](https://github.com/ClickHouse/ClickHouse/issues/42162). [#46141](https://github.com/ClickHouse/ClickHouse/pull/46141) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Более удобная работа с большими целыми числами и ORDER BY WITH FILL. Разрешено использовать обычные целые числа для начальных и конечных значений в WITH FILL при ORDER BY по большим (128-битным и 256-битным) целым числам. Исправлен ошибочный результат для больших целых чисел с отрицательными начальными или конечными значениями. Закрывает [#16733](https://github.com/ClickHouse/ClickHouse/issues/16733). [#46152](https://github.com/ClickHouse/ClickHouse/pull/46152) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлены столбцы `parts`, `active_parts` и `total_marks` в `system.tables` согласно [issue](https://github.com/ClickHouse/ClickHouse/issues/44336). [#46161](https://github.com/ClickHouse/ClickHouse/pull/46161) ([attack204](https://github.com/attack204)).
* Функции &quot;multi[Fuzzy]Match(Any|AnyIndex|AllIndices&#125;&quot; теперь отклоняют регулярные выражения, которые, вероятнее всего, будут очень медленно обрабатываться в vectorscan. [#46167](https://github.com/ClickHouse/ClickHouse/pull/46167) ([Robert Schulze](https://github.com/rschu1ze)).
* Когда `insert_null_as_default` включён и для столбца не задано значение по умолчанию, будет использоваться значение по умолчанию для типа столбца. Также этот PR исправляет применение значений по умолчанию к NULL в случае столбцов типа LowCardinality. [#46171](https://github.com/ClickHouse/ClickHouse/pull/46171) ([Kruglov Pavel](https://github.com/Avogar)).
* Отдавать предпочтение явно заданным ключам доступа для клиентов S3. Если параметр `use_environment_credentials` имеет значение `true` и пользователь предоставил ключ доступа через запрос или конфигурацию, он будет использован вместо ключей из переменной окружения. [#46191](https://github.com/ClickHouse/ClickHouse/pull/46191) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлен псевдоним &quot;DATE&#95;FORMAT()&quot; к функции &quot;formatDateTime()&quot; для повышения совместимости с SQL-диалектом MySQL, функция `formatDateTime` расширена поддержкой подстановок &quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;h&quot;, &quot;i&quot;, &quot;k&quot;, &quot;l&quot;, &quot;r&quot;, &quot;s&quot;, &quot;W&quot;. ### Запись в документации об изменениях, видимых пользователю Краткое описание для пользователя: `DATE_FORMAT` — это псевдоним `formatDateTime`. Форматирует время в соответствии с заданной строкой формата. Формат — константное выражение, поэтому вы не можете использовать несколько форматов для одного результирующего столбца. (Предоставьте ссылку на [formatDateTime](/sql-reference/functions/date-time-functions/#formatDateTime)). [#46302](https://github.com/ClickHouse/ClickHouse/pull/46302) ([Jake Bamrah](https://github.com/JakeBamrah)).
* Добавлены `ProfileEvents` и `CurrentMetrics` о задачах обратного вызова для параллельных реплик таблиц `s3Cluster` и `MergeTree`. [#46313](https://github.com/ClickHouse/ClickHouse/pull/46313) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка операторов `DELETE` и `UPDATE` для таблиц, использующих движок хранения `KeeperMap`. [#46330](https://github.com/ClickHouse/ClickHouse/pull/46330) ([Antonio Andelic](https://github.com/antonio2368)).
* Разрешено выполнение запросов RENAME с параметрами запроса. Исправляет [#45778](https://github.com/ClickHouse/ClickHouse/issues/45778). [#46407](https://github.com/ClickHouse/ClickHouse/pull/46407) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлены параметризованные запросы SELECT при использовании трансформера REPLACE. Исправлена проблема [#33002](https://github.com/ClickHouse/ClickHouse/issues/33002). [#46420](https://github.com/ClickHouse/ClickHouse/pull/46420) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исключить внутреннюю базу данных, используемую для временных/внешних таблиц, из расчёта асинхронной метрики &quot;NumberOfDatabases&quot;. Это делает поведение единообразным с системной таблицей &quot;system.databases&quot;. [#46435](https://github.com/ClickHouse/ClickHouse/pull/46435) ([Robert Schulze](https://github.com/rschu1ze)).
* В таблицу distribution&#95;queue добавлен столбец `last_exception_time`. [#46564](https://github.com/ClickHouse/ClickHouse/pull/46564) ([Aleksandr](https://github.com/AVMusorin)).
* Поддержка оператора `IN` с параметром в параметризованных представлениях. [#46583](https://github.com/ClickHouse/ClickHouse/pull/46583) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Не загружать именованные коллекции при запуске сервера (загружать их при первом обращении к ним). [#46607](https://github.com/ClickHouse/ClickHouse/pull/46607) ([Kseniia Sumarokova](https://github.com/kssenii)).

#### Улучшение сборки/тестирования/упаковки {#buildtestingpackaging-improvement-10}

* Внедрён GWP-ASan, реализованный в рантайме LLVM. Это закрывает [#27039](https://github.com/ClickHouse/ClickHouse/issues/27039). [#45226](https://github.com/ClickHouse/ClickHouse/pull/45226) ([Han Fei](https://github.com/hanfei1991)).
* Мы хотим сделать наши тесты менее стабильными и более «flaky»: добавлена рандомизация настроек merge tree в тестах. [#38983](https://github.com/ClickHouse/ClickHouse/pull/38983) ([Anton Popov](https://github.com/CurtizJ)).
* Включена поддержка HDFS на PowerPC, что позволяет исправить следующие функциональные тесты: 02113_hdfs_assert.sh, 02244_hdfs_cluster.sql и 02368_cancel_write_into_hdfs.sh. [#44949](https://github.com/ClickHouse/ClickHouse/pull/44949) ([MeenaRenganathan22](https://github.com/MeenaRenganathan22)).
* Добавлен файл службы systemd.service для clickhouse-keeper. Исправляет [#44293](https://github.com/ClickHouse/ClickHouse/issues/44293). [#45568](https://github.com/ClickHouse/ClickHouse/pull/45568) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Форк библиотеки Poco в ClickHouse был перемещён из "contrib/" в "base/poco/". [#46075](https://github.com/ClickHouse/ClickHouse/pull/46075) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена опция для `clickhouse-watchdog` для перезапуска дочернего процесса. Практической пользы от этого немного. [#46312](https://github.com/ClickHouse/ClickHouse/pull/46312) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Если переменная окружения `CLICKHOUSE_DOCKER_RESTART_ON_EXIT` установлена в значение 1, Docker‑контейнер будет запускать `clickhouse-server` как дочерний процесс вместо первого процесса и перезапускать его после завершения. [#46391](https://github.com/ClickHouse/ClickHouse/pull/46391) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлен файл службы systemd. [#46461](https://github.com/ClickHouse/ClickHouse/pull/46461) ([SuperDJY](https://github.com/cmsxbc)).
* Повышена минимальная версия Clang, необходимая для сборки ClickHouse, с 12 до 15. [#46710](https://github.com/ClickHouse/ClickHouse/pull/46710) ([Robert Schulze](https://github.com/rschu1ze)).
* Обновлён Intel QPL с v0.3.0 до v1.0.0, собран libaccel-config и он статически слинкован с библиотекой QPL вместо динамической линковки. [#45809](https://github.com/ClickHouse/ClickHouse/pull/45809) ([jasperzhu](https://github.com/jinjunzh)).

#### Исправление ошибки (некорректное поведение, заметное пользователю, в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-official-stable-release}

* Сбрасывать данные строго по параметру `rabbitmq_flush_interval_ms` или по параметру `rabbitmq_max_block_size` в `StorageRabbitMQ`. Закрывает [#42389](https://github.com/ClickHouse/ClickHouse/issues/42389). Закрывает [#45160](https://github.com/ClickHouse/ClickHouse/issues/45160). [#44404](https://github.com/ClickHouse/ClickHouse/pull/44404) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Использовать PODArray для отрисовки в функции sparkBar, чтобы контролировать потребление памяти. Закрывает [#44467](https://github.com/ClickHouse/ClickHouse/issues/44467). [#44489](https://github.com/ClickHouse/ClickHouse/pull/44489) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлены функции quantilesExactExclusive и quantilesExactInclusive, которые возвращали неотсортированный элемент массива. [#45379](https://github.com/ClickHouse/ClickHouse/pull/45379) ([wujunfu](https://github.com/wujunfu)).
* Исправлено необработанное исключение в `HTTPHandler` при включённом OpenTelemetry. [#45456](https://github.com/ClickHouse/ClickHouse/pull/45456) ([Frank Chen](https://github.com/FrankChen021)).
* Не следует выводить тип `Date` из восьмизначных чисел. Это может привести к некорректному чтению данных. [#45581](https://github.com/ClickHouse/ClickHouse/pull/45581) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена логика использования настройки `odbc_bridge_use_connection_pooling`. [#45591](https://github.com/ClickHouse/ClickHouse/pull/45591) ([Bharat Nallan](https://github.com/bharatnc)).
* Когда вызывается callback в кэше, возможно, что этот кэш уже уничтожен. Для безопасности мы захватываем поля по значению. Такой подход также безопасен для планировщика задач, потому что он будет деактивирован до уничтожения хранилища. Исправляет [#45548](https://github.com/ClickHouse/ClickHouse/issues/45548). [#45601](https://github.com/ClickHouse/ClickHouse/pull/45601) ([Han Fei](https://github.com/hanfei1991)).
* Исправлена ошибка, приводившая к порче данных при совместном использовании кодеков Delta или DoubleDelta с кодеком Gorilla. [#45615](https://github.com/ClickHouse/ClickHouse/pull/45615) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена корректность проверки типов при использовании индекса блум-фильтра N-gram, чтобы избежать некорректных чтений. [#45617](https://github.com/ClickHouse/ClickHouse/pull/45617) ([Antonio Andelic](https://github.com/antonio2368)).
* Было сообщено о нескольких ошибках сегментации в районе `c-ares`. Они появились после моих предыдущих pull request-ов. Я исправил их с помощью Александра Токмакова. [#45629](https://github.com/ClickHouse/ClickHouse/pull/45629) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлено описание ключа при обнаружении дублирующихся значений первичного ключа. Такое может происходить в проекциях. Подробности см. в [#45590](https://github.com/ClickHouse/ClickHouse/issues/45590). [#45686](https://github.com/ClickHouse/ClickHouse/pull/45686) ([Amos Bird](https://github.com/amosbird)).
* Установлен метод и уровень сжатия для резервных копий. Закрывает [#45690](https://github.com/ClickHouse/ClickHouse/issues/45690). [#45737](https://github.com/ClickHouse/ClickHouse/pull/45737) ([Pradeep Chhetri](https://github.com/chhetripradeep)).
* Следует использовать `select_query_typed.limitByOffset` вместо `select_query_typed.limitOffset`. [#45817](https://github.com/ClickHouse/ClickHouse/pull/45817) ([刘陶峰](https://github.com/taofengliu)).
* При использовании экспериментального анализатора запросов запросы вида `SELECT number FROM numbers(100) LIMIT 10 OFFSET 10;` возвращают некорректные результаты (пустой результат для этого запроса). Это вызвано лишним шагом OFFSET, добавленным планировщиком. [#45822](https://github.com/ClickHouse/ClickHouse/pull/45822) ([刘陶峰](https://github.com/taofengliu)).
* Обратная совместимость — разрешено неявное сужающее преобразование из UInt64 в IPv4, необходимое для выражения «INSERT ... VALUES ...». [#45865](https://github.com/ClickHouse/ClickHouse/pull/45865) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена ошибка в IPv6‑парсере для смешанных IPv4-адресов с пропущенным первым октетом (например, `::.1.2.3`). [#45871](https://github.com/ClickHouse/ClickHouse/pull/45871) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Добавлен столбец `query_kind` в таблицу `system.processes` и в запрос `SHOW PROCESSLIST`. Удалён дублирующийся код. Это исправляет ошибку: глобальный параметр конфигурации `max_concurrent_select_queries` не соблюдался для запросов с цепочками `INTERSECT` или `EXCEPT`. [#45872](https://github.com/ClickHouse/ClickHouse/pull/45872) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено падение в функции `stochasticLinearRegression`. Обнаружено с помощью WingFuzz. [#45985](https://github.com/ClickHouse/ClickHouse/pull/45985) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен сбой в запросах `SELECT` с модификаторами `INTERSECT` и `EXCEPT`, которые читают данные из таблиц с включёнными разрежёнными столбцами (управляется настройкой `ratio_of_defaults_for_sparse_serialization`). [#45987](https://github.com/ClickHouse/ClickHouse/pull/45987) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена оптимизация чтения по порядку для сортировки по убыванию (DESC) с модификатором FINAL, закрыт [#45815](https://github.com/ClickHouse/ClickHouse/issues/45815). [#46009](https://github.com/ClickHouse/ClickHouse/pull/46009) ([Vladimir C](https://github.com/vdimir)).
* Исправлено чтение несуществующих вложенных столбцов с несколькими уровнями в компактных частях. [#46045](https://github.com/ClickHouse/ClickHouse/pull/46045) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен столбец elapsed в system.processes (значения отличались в 10 раз). [#46047](https://github.com/ClickHouse/ClickHouse/pull/46047) ([Azat Khuzhin](https://github.com/azat)).
* Дополнительное исправление для Replace domain IP types (IPv4, IPv6) with native [https://github.com/ClickHouse/ClickHouse/pull/43221](https://github.com/ClickHouse/ClickHouse/pull/43221). [#46087](https://github.com/ClickHouse/ClickHouse/pull/46087) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена подстановка переменных окружения в конфигурации, если параметр уже имеет значение. Исправление закрывает [#46131](https://github.com/ClickHouse/ClickHouse/issues/46131). Также закрывает [#9547](https://github.com/ClickHouse/ClickHouse/issues/9547). [#46144](https://github.com/ClickHouse/ClickHouse/pull/46144) ([pufit](https://github.com/pufit)).
* Исправлено некорректное проталкивание предикатов (predicate push down) с `GROUPING SETS`. Закрывает [#45947](https://github.com/ClickHouse/ClickHouse/issues/45947). [#46151](https://github.com/ClickHouse/ClickHouse/pull/46151) ([flynn](https://github.com/ucasfl)).
* Исправлена возможная ошибка, из-за которой конвейер мог зависать в `fulls_sorting_join` при использовании константных ключей. [#46175](https://github.com/ClickHouse/ClickHouse/pull/46175) ([Vladimir C](https://github.com/vdimir)).
* Функции `tuple` больше не переписываются в литералы при форматировании, чтобы избежать некорректных результатов. [#46232](https://github.com/ClickHouse/ClickHouse/pull/46232) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Исправлена возможная ошибка выхода за границы при чтении LowCardinality(Nullable) в формате Arrow. [#46270](https://github.com/ClickHouse/ClickHouse/pull/46270) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка, из-за которой запросы `SYSTEM UNFREEZE` завершались с исключением `CANNOT_PARSE_INPUT_ASSERTION_FAILED`. [#46325](https://github.com/ClickHouse/ClickHouse/pull/46325) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Исправлен возможный сбой, который мог быть вызван переполнением целого числа при десериализации агрегирующего состояния функции, хранящей HashTable. [#46349](https://github.com/ClickHouse/ClickHouse/pull/46349) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена возможная `LOGICAL_ERROR`, возникающая при асинхронных вставках некорректных данных в формате `VALUES`. [#46350](https://github.com/ClickHouse/ClickHouse/pull/46350) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено возникновение LOGICAL&#95;ERROR при попытке выполнить `ALTER ... MOVE PART ... TO TABLE`. Такой запрос никогда фактически не поддерживался. [#46359](https://github.com/ClickHouse/ClickHouse/pull/46359) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлено определение схемы s3Cluster в параллельной распределённой операции INSERT SELECT при включённом `parallel_distributed_insert_select`. [#46381](https://github.com/ClickHouse/ClickHouse/pull/46381) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена обработка запросов вида `ALTER TABLE ... UPDATE nested.arr1 = nested.arr2 ...`, где `arr1` и `arr2` являются полями одного и того же столбца типа `Nested`. [#46387](https://github.com/ClickHouse/ClickHouse/pull/46387) ([Anton Popov](https://github.com/CurtizJ)).
* Планировщик может не суметь запланировать задачу. Если это происходит, весь MulityPartUpload должен быть прерван, а `UploadHelper` обязан дождаться уже запланированных задач. [#46451](https://github.com/ClickHouse/ClickHouse/pull/46451) ([Dmitry Novik](https://github.com/novikd)).
* Исправление `PREWHERE` для движка `Merge` с различающимися типами значений по умолчанию (исправляет некоторые ошибки `NOT_FOUND_COLUMN_IN_BLOCK`, возникающие, когда тип значения по умолчанию для столбца отличается; также разрешает `PREWHERE`, когда тип столбца одинаков во всех таблицах, и запрещает его, только если они различаются). [#46454](https://github.com/ClickHouse/ClickHouse/pull/46454) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, приводившая к аварийному завершению при использовании константных значений в `ORDER BY`. Исправляет [#46466](https://github.com/ClickHouse/ClickHouse/issues/46466). [#46493](https://github.com/ClickHouse/ClickHouse/pull/46493) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Не выбрасывать исключение, если параметр `disk` был указан на уровне запроса, а `storage_policy` — в секции настроек MergeTree в конфигурации. В этом случае `disk` переопределяет настройку из конфигурации. [#46533](https://github.com/ClickHouse/ClickHouse/pull/46533) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена некорректная обработка константного аргумента типа `LowCardinality` в функции `arrayMap`. Эта ошибка могла приводить к ошибке сегментирования в релизной сборке и логической ошибке `Bad cast` в отладочной сборке. [#46569](https://github.com/ClickHouse/ClickHouse/pull/46569) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправляет ошибку [#46557](https://github.com/ClickHouse/ClickHouse/issues/46557). [#46611](https://github.com/ClickHouse/ClickHouse/pull/46611) ([Alexander Gololobov](https://github.com/davenger)).
* Исправлены бесконечные перезапуски юнита systemd clickhouse-server, если сервер не может запуститься в течение 1 минуты 30 секунд (отключена логика тайм-аута при запуске clickhouse-server из сервиса systemd). [#46613](https://github.com/ClickHouse/ClickHouse/pull/46613) ([Azat Khuzhin](https://github.com/azat)).
* Буферы памяти, выделенные при асинхронных вставках, освобождались в глобальном контексте, поэтому счетчики MemoryTracker для соответствующих пользователя и запроса обновлялись некорректно. Это приводило к ложным исключениям OOM. [#46622](https://github.com/ClickHouse/ClickHouse/pull/46622) ([Dmitry Novik](https://github.com/novikd)).
* Обновлено поведение: больше не очищается on&#95;expression из table&#95;join, поскольку он используется последующими запусками анализа, что исправляет [#45185](https://github.com/ClickHouse/ClickHouse/issues/45185). [#46487](https://github.com/ClickHouse/ClickHouse/pull/46487) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).

### <a id="231"></a> Релиз ClickHouse 23.1, 2023-01-26. [Презентация](https://presentations.clickhouse.com/2023-release-23.1/), [Видео](https://www.youtube.com/watch?v=zYSZXBnTMSE) {#231}

<iframe width="1024" height="576" src="https://www.youtube.com/embed/zYSZXBnTMSE" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

### Релиз ClickHouse 23.1 {#clickhouse-release-231}

#### Примечания по обновлению {#upgrade-notes-2}

* Запрос `SYSTEM RESTART DISK` теперь не выполняет никаких действий. [#44647](https://github.com/ClickHouse/ClickHouse/pull/44647) ([alesapin](https://github.com/alesapin)).
* Опция `PREALLOCATE` для словарей `HASHED`/`SPARSE_HASHED` теперь не выполняет никаких действий. [#45388](https://github.com/ClickHouse/ClickHouse/pull/45388) ([Azat Khuzhin](https://github.com/azat)). Она больше не даёт существенных преимуществ.
* Запрещён кодек `Gorilla` для столбцов типов, отличных от Float32 и Float64. [#45252](https://github.com/ClickHouse/ClickHouse/pull/45252) ([Robert Schulze](https://github.com/rschu1ze)). Его использование было бессмысленным и приводило к несогласованностям. 
* Параллельные кворумные вставки могут работать некорректно с таблицами `*MergeTree`, созданными с использованием устаревшего синтаксиса. Поэтому поддержка параллельных кворумных вставок полностью отключена для таких таблиц. Это не затрагивает таблицы, созданные с использованием нового синтаксиса. [#45430](https://github.com/ClickHouse/ClickHouse/pull/45430) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Для получения размера объекта в AWS S3 используется запрос `GetObjectAttributes` вместо запроса `HeadObject`. Это изменение, в частности, исправляет обработку конечных точек без явного указания региона после обновления AWS SDK. [#45288](https://github.com/ClickHouse/ClickHouse/pull/45288) ([Vitaly Baranov](https://github.com/vitlibar)). AWS S3 и Minio протестированы, но имейте в виду, что различные S3-совместимые сервисы (GCS, R2, B2) могут иметь тонкие несовместимости. Это изменение также может потребовать скорректировать ACL, чтобы разрешить запрос `GetObjectAttributes`.
* Запрещено использование путей в названиях часовых поясов. Например, название часового пояса `/usr/share/zoneinfo/Asia/Aden` недопустимо; следует использовать имя из базы часовых поясов IANA, например `Asia/Aden`. [#44225](https://github.com/ClickHouse/ClickHouse/pull/44225) ([Kruglov Pavel](https://github.com/Avogar)).
* Запросы, комбинирующие equijoin и константные выражения (например, `JOIN ON t1.x = t2.x AND 1 = 1`), запрещены из-за некорректных результатов. [#44016](https://github.com/ClickHouse/ClickHouse/pull/44016) ([Vladimir C](https://github.com/vdimir)).

#### Новая возможность {#new-feature-11}

* Источник словаря, извлекающий ключи при обходе дерева регулярных выражений. Может использоваться для разбора User-Agent. [#40878](https://github.com/ClickHouse/ClickHouse/pull/40878) ([Vage Ogannisian](https://github.com/nooblose)). [#43858](https://github.com/ClickHouse/ClickHouse/pull/43858) ([Han Fei](https://github.com/hanfei1991)).
* Добавлена функциональность параметризованных представлений, теперь для движка таблиц View можно задавать параметры запроса. Решает [#40907](https://github.com/ClickHouse/ClickHouse/issues/40907). [#41687](https://github.com/ClickHouse/ClickHouse/pull/41687) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Добавлены функции `quantileInterpolatedWeighted` и `quantilesInterpolatedWeighted`. [#38252](https://github.com/ClickHouse/ClickHouse/pull/38252) ([Bharat Nallan](https://github.com/bharatnc)).
* Поддержка `ARRAY JOIN` для типа `Map`, аналог функции `explode` в Spark. [#43239](https://github.com/ClickHouse/ClickHouse/pull/43239) ([李扬](https://github.com/taiyang-li)).
* Добавлена поддержка стандартных для SQL двоичных и шестнадцатеричных строковых литералов. [#43785](https://github.com/ClickHouse/ClickHouse/pull/43785) ([Mo Xuan](https://github.com/mo-avatar)).
* Добавлена поддержка форматирования `DateTime` в стиле Joda-Time. См. [документацию Joda-Time](https://joda-time.sourceforge.net/apidocs/org/joda/time/format/DateTimeFormat.html). [#43818](https://github.com/ClickHouse/ClickHouse/pull/43818) ([李扬](https://github.com/taiyang-li)).
* Реализована поддержка формата долей секунды (`%f`) в `formatDateTime`. [#44060](https://github.com/ClickHouse/ClickHouse/pull/44060) ([ltrk2](https://github.com/ltrk2)). [#44497](https://github.com/ClickHouse/ClickHouse/pull/44497) ([Alexander Gololobov](https://github.com/davenger)).
* Добавлена функция `age` для вычисления разницы между двумя датами или датами со временем, выраженной в количестве полных единиц времени. Закрывает [#41115](https://github.com/ClickHouse/ClickHouse/issues/41115). [#44421](https://github.com/ClickHouse/ClickHouse/pull/44421) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлен источник `Null` для словарей. Закрыта задача [#44240](https://github.com/ClickHouse/ClickHouse/issues/44240). [#44502](https://github.com/ClickHouse/ClickHouse/pull/44502) ([mayamika](https://github.com/mayamika)).
* Добавлена возможность настраивать класс хранилища S3 с помощью опции конфигурации `s3_storage_class`, например `<s3_storage_class>STANDARD/INTELLIGENT_TIERING</s3_storage_class>`. Закрывает [#44443](https://github.com/ClickHouse/ClickHouse/issues/44443). [#44707](https://github.com/ClickHouse/ClickHouse/pull/44707) ([chen](https://github.com/xiedeyantu)).
* Вставлять значения по умолчанию, если в JSON-объекте отсутствуют элементы при разборе именованного кортежа. Добавлена настройка `input_format_json_defaults_for_missing_elements_in_named_tuple` для управления этим поведением. Закрывает [#45142](https://github.com/ClickHouse/ClickHouse/issues/45142)#issuecomment-1380153217. [#45231](https://github.com/ClickHouse/ClickHouse/pull/45231) ([Kruglov Pavel](https://github.com/Avogar)).
* Записывает время запуска сервера в ProfileEvents (`ServerStartupMilliseconds`). Исправляет [#43188](https://github.com/ClickHouse/ClickHouse/issues/43188). [#45250](https://github.com/ClickHouse/ClickHouse/pull/45250) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Рефакторинг и улучшение стриминговых движков Kafka/RabbitMQ/NATS и добавление поддержки всех форматов, а также небольшой рефакторинг самих форматов: - Исправлено формирование сообщений в построчных форматах с суффиксами/префиксами. Теперь каждое сообщение полностью форматируется со всеми разделителями и может быть затем снова разобрано с помощью входного формата. - Добавлена поддержка блочных форматów, таких как Native, Parquet, ORC и др. Каждый блок форматируется как отдельное сообщение. Количество строк в одном сообщении зависит от размера блока, поэтому вы можете управлять им с помощью настройки `max_block_size`. - Добавлены новые настройки движка `kafka_max_rows_per_message/rabbitmq_max_rows_per_message/nats_max_rows_per_message`. Они управляют количеством строк, форматируемых в одном сообщении в построчных форматах. Значение по умолчанию: 1. - Исправлено высокое потребление памяти в табличном движке NATS. - Добавлена поддержка произвольных бинарных данных в продюсере NATS (ранее он работал только со строками, содержавшими \0 в конце). - Добавлены отсутствовавшие настройки движков Kafka/RabbitMQ/NATS в документацию. - Рефакторинг логики отправки и потребления сообщений в Kafka/RabbitMQ/NATS, её отделение от семантики WriteBuffers/ReadBuffers. - Рефакторинг выходных форматов: удалены обратные вызовы на каждую строку, использовавшиеся в Kafka/RabbitMQ/NATS (теперь там callbacks не используются), разрешено непосредственное использование IRowOutputFormat, уточнены разделители конца строки и между строками, появилась возможность сбросить состояние выходного формата, чтобы начать форматирование заново. - Добавлена корректная реализация в функции formatRow (бонус после рефакторинга форматов). [#42777](https://github.com/ClickHouse/ClickHouse/pull/42777) ([Kruglov Pavel](https://github.com/Avogar)).
* Поддержка чтения и записи таблиц типа `Nested` как `List` из `Struct` в формате `CapnProto`. Чтение и запись `Decimal32/64` как `Int32/64`. Закрывает [#43319](https://github.com/ClickHouse/ClickHouse/issues/43319). [#43379](https://github.com/ClickHouse/ClickHouse/pull/43379) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен столбец `message_format_string` в `system.text_log`. Столбец содержит шаблон, который использовался для форматирования сообщения. [#44543](https://github.com/ClickHouse/ClickHouse/pull/44543) ([Alexander Tokmakov](https://github.com/tavplubix)). Это позволяет выполнять различные виды анализа логов ClickHouse.
* Добавлена попытка автоматического определения заголовков с именами столбцов (и, возможно, типами) для форматов ввода CSV/TSV/CustomSeparated.
  Добавлены настройки input&#95;format&#95;tsv/csv/custom&#95;detect&#95;header, управляющие этим поведением (по умолчанию включено). Закрывает [#44640](https://github.com/ClickHouse/ClickHouse/issues/44640). [#44953](https://github.com/ClickHouse/ClickHouse/pull/44953) ([Kruglov Pavel](https://github.com/Avogar)).

#### Экспериментальные возможности {#experimental-feature-7}

* Добавлен экспериментальный инвертированный индекс как новый тип вторичного индекса для эффективного поиска по тексту. [#38667](https://github.com/ClickHouse/ClickHouse/pull/38667) ([larryluogit](https://github.com/larryluogit)).
* Добавлен экспериментальный кэш результатов запросов. [#43797](https://github.com/ClickHouse/ClickHouse/pull/43797) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена расширяемая и настраиваемая подсистема планирования для I/O-запросов (пока не интегрирована с самим I/O-кодом). [#41840](https://github.com/ClickHouse/ClickHouse/pull/41840) ([Sergei Trifonov](https://github.com/serxa)). Эта возможность пока совершенно ничего не делает — наслаждайтесь.
* Добавлена команда `SYSTEM DROP DATABASE REPLICA`, которая удаляет метаданные неработающей реплики базы данных `Replicated`. Закрывает [#41794](https://github.com/ClickHouse/ClickHouse/issues/41794). [#42807](https://github.com/ClickHouse/ClickHouse/pull/42807) ([Alexander Tokmakov](https://github.com/tavplubix)).

#### Улучшения производительности {#performance-improvement-11}

* Не загружать неактивные части при запуске таблиц `MergeTree`. [#42181](https://github.com/ClickHouse/ClickHouse/pull/42181) ([Anton Popov](https://github.com/CurtizJ)).
* Снижена задержка чтения из хранилища `S3` и табличной функции `s3` при работе с большим количеством мелких файлов. Теперь параметры `remote_filesystem_read_method` и `remote_filesystem_read_prefetch` применяются при чтении из хранилища `S3`. [#43726](https://github.com/ClickHouse/ClickHouse/pull/43726) ([Anton Popov](https://github.com/CurtizJ)).
* Оптимизация чтения полей структур в файлах Parquet/ORC. Загружаются только необходимые поля. [#44484](https://github.com/ClickHouse/ClickHouse/pull/44484) ([lgbo](https://github.com/lgbo-ustc)).
* Двухуровневый алгоритм агрегации по ошибке был отключён для запросов по HTTP. Он снова был включён, что привело к значительному росту производительности. [#45450](https://github.com/ClickHouse/ClickHouse/pull/45450) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлена поддержка mmap для StorageFile, что должно повысить производительность clickhouse-local. [#43927](https://github.com/ClickHouse/ClickHouse/pull/43927) ([pufit](https://github.com/pufit)).
* Добавлена поддержка сегментирования в HashedDictionary для параллельной загрузки (почти линейное масштабирование по числу сегментов). [#40003](https://github.com/ClickHouse/ClickHouse/pull/40003) ([Azat Khuzhin](https://github.com/azat)).
* Ускорен парсинг запросов. [#42284](https://github.com/ClickHouse/ClickHouse/pull/42284) ([Raúl Marín](https://github.com/Algunenano)).
* Всегда заменяйте цепочку `OR` вида `expr = x1 OR ... OR expr = xN` на `expr IN (x1, ..., xN)`, если `expr` — столбец с типом `LowCardinality`. Настройка `optimize_min_equality_disjunction_chain_length` при этом игнорируется. [#42889](https://github.com/ClickHouse/ClickHouse/pull/42889) ([Guo Wangyang](https://github.com/guowangy)).
* Незначительно повышена производительность за счет оптимизации кода, связанного с ThreadStatus. [#43586](https://github.com/ClickHouse/ClickHouse/pull/43586) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
* Оптимизирована по-столбцовая обработка тернарной логики за счёт авто-векторизации. В тесте производительности этого [микробенчмарка](https://github.com/ZhiguoZh/ClickHouse/blob/20221123-ternary-logic-opt-example/src/Functions/examples/associative_applier_perf.cpp) было достигнуто пиковое **увеличение производительности** в **21 раз** на платформе ICX (процессор Intel Xeon Platinum 8380). [#43669](https://github.com/ClickHouse/ClickHouse/pull/43669) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
* По возможности избегайте установки блокировок чтения в таблице `system.tables`. [#43840](https://github.com/ClickHouse/ClickHouse/pull/43840) ([Raúl Marín](https://github.com/Algunenano)).
* Оптимизирован `ThreadPool`. Эксперименты производительности SSB (Star Schema Benchmark) на устройстве ICX (процессор Intel Xeon Platinum 8380, 80 ядер, 160 потоков) показывают, что это изменение позволяет эффективно снизить конкуренцию за мьютекс `ThreadPoolImpl::mutex` на **75%**, увеличивая утилизацию CPU и улучшая общую производительность на **2,4%**. [#44308](https://github.com/ClickHouse/ClickHouse/pull/44308) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
* Теперь оптимизация предсказания размера хэш-таблицы применяется только в том случае, если закэшированный размер хэш-таблицы достаточно велик (пороговые значения были определены эмпирически и жестко закодированы). [#44455](https://github.com/ClickHouse/ClickHouse/pull/44455) ([Nikita Taranov](https://github.com/nickitat)).
* Небольшое улучшение производительности при асинхронном чтении из удалённых файловых систем. [#44868](https://github.com/ClickHouse/ClickHouse/pull/44868) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлен быстрый путь обработки для: - `col like '%%'`; - `col like '%'`; - `col not like '%'`; - `col not like '%'`; - `match(col, '.*')`. [#45244](https://github.com/ClickHouse/ClickHouse/pull/45244) ([李扬](https://github.com/taiyang-li)).
* Незначительно улучшена оптимизация быстрого пути при фильтрации (оператор WHERE). [#45289](https://github.com/ClickHouse/ClickHouse/pull/45289) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлена информация о монотонности для функций `toUnixTimestamp64*`, чтобы включить больше алгебраических оптимизаций при анализе индексов. [#44116](https://github.com/ClickHouse/ClickHouse/pull/44116) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлена возможность настраивать использование временных данных при обработке запросов (выгрузку на диск) так, чтобы оно взаимодействовало с кешем файловой системы (используя пространство диска, выделенное под кеш) [#43972](https://github.com/ClickHouse/ClickHouse/pull/43972) ([Vladimir C](https://github.com/vdimir)). В основном это улучшает работу [ClickHouse Cloud](https://console.clickhouse.cloud/), но может использоваться и в самоуправляемых развёртываниях, если вы знаете, что делаете.
* Таблица `system.replicas` теперь параллельно запрашивает статусы реплик. Закрывает [#43918](https://github.com/ClickHouse/ClickHouse/issues/43918). [#43998](https://github.com/ClickHouse/ClickHouse/pull/43998) ([Nikolay Degterinsky](https://github.com/evillique)).
* Оптимизировано потребление памяти при резервном копировании в S3: файлы в S3 теперь копируются напрямую, без использования `WriteBufferFromS3` (который мог использовать много памяти). [#45188](https://github.com/ClickHouse/ClickHouse/pull/45188) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлен кэш для идентификаторов асинхронных блоков. Это уменьшит число запросов в ZooKeeper при включении дедупликации асинхронных вставок. [#45106](https://github.com/ClickHouse/ClickHouse/pull/45106) ([Han Fei](https://github.com/hanfei1991)).

#### Улучшения {#improvement-11}

* Использовать структуру целевой таблицы вставки в `generateRandom` при вызове без аргументов. [#45239](https://github.com/ClickHouse/ClickHouse/pull/45239) ([Kruglov Pavel](https://github.com/Avogar)).
* Разрешено неявное преобразование чисел с плавающей запятой, хранящихся в строковых полях JSON, в целые числа в функциях `JSONExtract`. Например, `JSONExtract('{"a": "1000.111"}', 'a', 'UInt64')` -&gt; `1000`, раньше функция возвращала 0. [#45432](https://github.com/ClickHouse/ClickHouse/pull/45432) ([Anton Popov](https://github.com/CurtizJ)).
* В таблицу `system.formats` добавлены поля `supports_parallel_parsing` и `supports_parallel_formatting` для улучшения возможностей интроспекции. [#45499](https://github.com/ClickHouse/ClickHouse/pull/45499) ([Anton Popov](https://github.com/CurtizJ)).
* Улучшено чтение полей CSV в форматах CustomSeparated и Template. Закрывает [#42352](https://github.com/ClickHouse/ClickHouse/issues/42352) Закрывает [#39620](https://github.com/ClickHouse/ClickHouse/issues/39620). [#43332](https://github.com/ClickHouse/ClickHouse/pull/43332) ([Kruglov Pavel](https://github.com/Avogar)).
* Унифицированы измерения времени выполнения запросов. [#43455](https://github.com/ClickHouse/ClickHouse/pull/43455) ([Raúl Marín](https://github.com/Algunenano)).
* Улучшено автоматическое использование структуры из таблицы, в которую выполняется вставка, в табличных функциях file/hdfs/s3, когда в запросе SELECT присутствуют виртуальные столбцы; это исправляет возможную ошибку `Block structure mismatch` или `number of columns mismatch`. [#43695](https://github.com/ClickHouse/ClickHouse/pull/43695) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка знаковых аргументов в функции `range`. Исправлена ошибка [#43333](https://github.com/ClickHouse/ClickHouse/issues/43333). [#43733](https://github.com/ClickHouse/ClickHouse/pull/43733) ([sanyu](https://github.com/wineternity)).
* Удалено избыточное сортирование, например сортировки, связанные с предложениями ORDER BY во вложенных запросах. Реализовано на основе плана запроса. Выполняет оптимизацию, аналогичную `optimize_duplicate_order_by_and_distinct` в отношении предложений `ORDER BY`, но более общую, так как применяется к любым избыточным шагам сортировки (не только вызванным предложением ORDER BY) и к подзапросам любой глубины вложенности. Связано с [#42648](https://github.com/ClickHouse/ClickHouse/issues/42648). [#43905](https://github.com/ClickHouse/ClickHouse/pull/43905) ([Igor Nikonov](https://github.com/devcrafter)).
* Добавлена возможность отключать дедупликацию файлов для BACKUP (для резервных копий без дедупликации можно использовать ATTACH вместо полного RESTORE). Например, `BACKUP foo TO S3(...) SETTINGS deduplicate_files=0` (значение по умолчанию — `deduplicate_files=1`). [#43947](https://github.com/ClickHouse/ClickHouse/pull/43947) ([Azat Khuzhin](https://github.com/azat)).
* Рефакторинг и улучшение определения схемы для текстовых форматов. Добавлена новая настройка `schema_inference_make_columns_nullable`, которая управляет преобразованием результирующих типов в `Nullable` (включена по умолчанию). [#44019](https://github.com/ClickHouse/ClickHouse/pull/44019) ([Kruglov Pavel](https://github.com/Avogar)).
* Улучшена поддержка протокола `PROXYv1`. [#44135](https://github.com/ClickHouse/ClickHouse/pull/44135) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Добавлена информация о последней проверке части, выполняемой потоками очистки, в таблицу `system.parts`. [#44244](https://github.com/ClickHouse/ClickHouse/pull/44244) ([Dmitry Novik](https://github.com/novikd)).
* Отключены табличные функции в режиме только для чтения для вставок. [#44290](https://github.com/ClickHouse/ClickHouse/pull/44290) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Добавлена настройка `simultaneous_parts_removal_limit`, позволяющая ограничить количество частей, обрабатываемых за одну итерацию CleanupThread. [#44461](https://github.com/ClickHouse/ClickHouse/pull/44461) ([Dmitry Novik](https://github.com/novikd)).
* Не инициализируйте ReadBufferFromS3, если в запросе нужны только виртуальные столбцы, что может помочь с [#44246](https://github.com/ClickHouse/ClickHouse/issues/44246). [#44493](https://github.com/ClickHouse/ClickHouse/pull/44493) ([chen](https://github.com/xiedeyantu)).
* Предотвращено появление дублирующихся подсказок для имён столбцов. Закрывает [#44130](https://github.com/ClickHouse/ClickHouse/issues/44130). [#44519](https://github.com/ClickHouse/ClickHouse/pull/44519) ([Joanna Hulboj](https://github.com/jh0x)).
* Разрешена подстановка макросов в endpoint для дисков. Исправлена проблема [#40951](https://github.com/ClickHouse/ClickHouse/issues/40951). [#44533](https://github.com/ClickHouse/ClickHouse/pull/44533) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Улучшено определение схемы, когда включён `input_format_json_read_object_as_string`. [#44546](https://github.com/ClickHouse/ClickHouse/pull/44546) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена настройка на уровне пользователя `database_replicated_allow_replicated_engine_arguments`, которая позволяет запретить создание таблиц `ReplicatedMergeTree` с аргументами в `DatabaseReplicated`. [#44566](https://github.com/ClickHouse/ClickHouse/pull/44566) ([alesapin](https://github.com/alesapin)).
* Исключена возможность ошибочного указания пользователями нулевого (недопустимого) значения для `index_granularity`. Это закрывает [#44536](https://github.com/ClickHouse/ClickHouse/issues/44536). [#44578](https://github.com/ClickHouse/ClickHouse/pull/44578) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность задавать путь к сервисному keytab-файлу в параметре `keytab` секции `kerberos` файла config.xml. [#44594](https://github.com/ClickHouse/ClickHouse/pull/44594) ([Roman Vasin](https://github.com/rvasin)).
* Теперь для нечеткого поиска используется уже введённая часть запроса (она передаётся в библиотеку `skim`, написанную на Rust и статически связанную с ClickHouse). [#44600](https://github.com/ClickHouse/ClickHouse/pull/44600) ([Azat Khuzhin](https://github.com/azat)).
* Параметр `input_format_json_read_objects_as_strings` теперь включён по умолчанию, что позволяет считывать вложенные объекты JSON, пока тип JSON Object остаётся экспериментальным. [#44657](https://github.com/ClickHouse/ClickHouse/pull/44657) ([Kruglov Pavel](https://github.com/Avogar)).
* Улучшена дедупликация асинхронных вставок: при повторных асинхронных вставках мы должны выполнять дедупликацию в памяти до отправки запроса к Keeper. [#44682](https://github.com/ClickHouse/ClickHouse/pull/44682) ([Han Fei](https://github.com/hanfei1991)).
* Формат ввода/вывода `Avro` будет интерпретировать тип bool как тип bool в ClickHouse. [#44684](https://github.com/ClickHouse/ClickHouse/pull/44684) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка логического типа Bool в форматах Arrow/Parquet/ORC. Закрывает [#43970](https://github.com/ClickHouse/ClickHouse/issues/43970). [#44698](https://github.com/ClickHouse/ClickHouse/pull/44698) ([Kruglov Pavel](https://github.com/Avogar)).
* Не выполняйте жадный разбор, выходящий за пределы кавычек, при чтении UUID — это может приводить к тому, что некорректные данные будут ошибочно считаны как корректные. [#44686](https://github.com/ClickHouse/ClickHouse/pull/44686) ([Raúl Marín](https://github.com/Algunenano)).
* Определять тип UInt64 при переполнении Int64 и исправлять некоторые преобразования при выводе схемы. [#44696](https://github.com/ClickHouse/ClickHouse/pull/44696) ([Kruglov Pavel](https://github.com/Avogar)).
* Ранее разрешение зависимостей в базе данных `Replicated` выполнялось не самым корректным образом, а теперь оно реализовано правильно с использованием явного графа. [#44697](https://github.com/ClickHouse/ClickHouse/pull/44697) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена ошибка, из-за которой `output_format_pretty_row_numbers` не сохранял счётчик между блоками. Закрывает [#44815](https://github.com/ClickHouse/ClickHouse/issues/44815). [#44832](https://github.com/ClickHouse/ClickHouse/pull/44832) ([flynn](https://github.com/ucasfl)).
* Не учитывать ошибки в `system.errors`, возникающие из-за слияния частей, выполняемого параллельно с фоновым процессом очистки. [#44874](https://github.com/ClickHouse/ClickHouse/pull/44874) ([Raúl Marín](https://github.com/Algunenano)).
* Оптимизированы и исправлены метрики для асинхронного `INSERT` в таблицах `Distributed`. [#44922](https://github.com/ClickHouse/ClickHouse/pull/44922) ([Azat Khuzhin](https://github.com/azat)).
* Добавлены настройки для запрета одновременного выполнения резервных копирований и восстановлений, что решает проблему [#43891](https://github.com/ClickHouse/ClickHouse/issues/43891). Реализация: * Добавлены настройки на уровне сервера для запрета одновременного выполнения резервных копирований и восстановлений, которые считываются и устанавливаются при создании BackupWorker в Context. * По умолчанию настройки установлены в значение true. * Перед запуском резервного копирования или восстановления добавлена проверка на наличие других выполняющихся операций резервного копирования/восстановления. Для внутренних запросов проверяется, что запрос поступил с собственного узла с использованием backup&#95;uuid. [#45072](https://github.com/ClickHouse/ClickHouse/pull/45072) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Добавлен параметр конфигурации `<storage_policy>` для системных журналов. [#45320](https://github.com/ClickHouse/ClickHouse/pull/45320) ([Stig Bakken](https://github.com/stigsb)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-11}

* Выполнена статическая линковка с библиотекой `skim` (она написана на Rust) для нечеткого поиска в клиенте ClickHouse и локальной истории. [#44239](https://github.com/ClickHouse/ClickHouse/pull/44239) ([Azat Khuzhin](https://github.com/azat)).
* Мы удалили поддержку динамического линкования из‑за Rust. На самом деле Rust — лишь предлог для этого удаления, и мы все равно хотели ее убрать. [#44828](https://github.com/ClickHouse/ClickHouse/pull/44828) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Удалена зависимость от инструмента `adduser` из пакетов, потому что мы его не используем. Это исправляет [#44934](https://github.com/ClickHouse/ClickHouse/issues/44934). [#45011](https://github.com/ClickHouse/ClickHouse/pull/45011) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Библиотека `SQLite` обновлена до последней версии. Она используется для интеграционных движков базы данных и таблиц SQLite. Также исправлен ложноположительный отчет TSan. Это закрывает [#45027](https://github.com/ClickHouse/ClickHouse/issues/45027). [#45031](https://github.com/ClickHouse/ClickHouse/pull/45031) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Изменения CRC-32 для устранения проблемы коллизий WeakHash на PowerPC. [#45144](https://github.com/ClickHouse/ClickHouse/pull/45144) ([MeenaRenganathan22](https://github.com/MeenaRenganathan22)).
* Обновлены подмодули aws-c*. [#43020](https://github.com/ClickHouse/ClickHouse/pull/43020) ([Vitaly Baranov](https://github.com/vitlibar)).
* Автоматически объединять «зеленые» backport‑PR и «зеленые» одобренные PR. [#41110](https://github.com/ClickHouse/ClickHouse/pull/41110) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Создан [веб‑сайт](https://aretestsgreenyet.com/) для отслеживания статуса ClickHouse CI. [Source](https://github.com/ClickHouse/aretestsgreenyet).

#### Исправления ошибок {#bug-fix}

* Доменные типы IP (IPv4, IPv6) заменены на встроенные. [#43221](https://github.com/ClickHouse/ClickHouse/pull/43221) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)). Это автоматически устраняет некоторые пробелы в реализации кода.
* Исправлен процесс резервного копирования, если мутации принудительно завершаются во время выполнения резервной копии. [#45351](https://github.com/ClickHouse/ClickHouse/pull/45351) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено сообщение исключения `Invalid number of rows in Chunk`. [#41404](https://github.com/ClickHouse/ClickHouse/issues/41404). [#42126](https://github.com/ClickHouse/ClickHouse/pull/42126) ([Alexander Gololobov](https://github.com/davenger)).
* Исправлено возможное использование неинициализированного значения при выполнении выражений после сортировки. Закрывает [#43386](https://github.com/ClickHouse/ClickHouse/issues/43386) [#43635](https://github.com/ClickHouse/ClickHouse/pull/43635) ([Kruglov Pavel](https://github.com/Avogar)).
* Улучшена обработка NULL в агрегатных комбинаторах, исправлены возможные ошибки: segfault (ошибка сегментации) и логическая ошибка при использовании неочевидной оптимизации `optimize_rewrite_sum_if_to_count_if`. Закрывает [#43758](https://github.com/ClickHouse/ClickHouse/issues/43758). [#43813](https://github.com/ClickHouse/ClickHouse/pull/43813) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлены ограничения для настроек запросов CREATE USER/ROLE. [#43993](https://github.com/ClickHouse/ClickHouse/pull/43993) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена ошибка с непарсируемым значением по умолчанию для столбца `EPHEMERAL` в метаданных таблицы. [#44026](https://github.com/ClickHouse/ClickHouse/pull/44026) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлен разбор некорректной версии из параметра совместимости. [#44224](https://github.com/ClickHouse/ClickHouse/pull/44224) ([Kruglov Pavel](https://github.com/Avogar)).
* Привести операцию вычитания интервалов из значений datetime в соответствие с операцией их добавления. [#44241](https://github.com/ClickHouse/ClickHouse/pull/44241) ([ltrk2](https://github.com/ltrk2)).
* Сняты ограничения на максимальный размер результата для представлений. [#44261](https://github.com/ClickHouse/ClickHouse/pull/44261) ([lizhuoyu5](https://github.com/lzydmxy)).
* Исправлена возможная логическая ошибка в кэше при `do_not_evict_index_and_mrk_files=1`. Закрывает [#42142](https://github.com/ClickHouse/ClickHouse/issues/42142). [#44268](https://github.com/ClickHouse/ClickHouse/pull/44268) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено возможное преждевременное прекращение записи в кэш в режиме write-through (кэширование могло останавливаться из-за ошибочного предположения, хотя этого не должно было происходить). [#44289](https://github.com/ClickHouse/ClickHouse/pull/44289) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен возможный сбой при использовании функции `IN` с константными аргументами в качестве константного аргумента вместе с `LowCardinality`. Исправляет [#44221](https://github.com/ClickHouse/ClickHouse/issues/44221). [#44346](https://github.com/ClickHouse/ClickHouse/pull/44346) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена обработка сложных параметров (например, массивов) параметрических агрегатных функций. Это исправление закрывает [#30975](https://github.com/ClickHouse/ClickHouse/issues/30975). Агрегатная функция `sumMapFiltered` не могла использоваться в распределённых запросах до этого изменения. [#44358](https://github.com/ClickHouse/ClickHouse/pull/44358) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено чтение ObjectId при определении схемы BSON. [#44382](https://github.com/ClickHouse/ClickHouse/pull/44382) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена гонка состояний, из-за которой временные части могли преждевременно удаляться до завершения слияния в ReplicatedMergeTree. Эта проблема могла приводить к ошибкам наподобие `No such file or directory: xxx`. Исправляет [#43983](https://github.com/ClickHouse/ClickHouse/issues/43983). [#44383](https://github.com/ClickHouse/ClickHouse/pull/44383) ([alesapin](https://github.com/alesapin)).
* Некоторые некорректные запросы `SYSTEM ... ON CLUSTER` вели себя неожиданным образом, если имя кластера не было указано. Это исправлено: теперь такие запросы завершаются с ошибкой `SYNTAX_ERROR`, как и должно быть. Исправляет [#44264](https://github.com/ClickHouse/ClickHouse/issues/44264). [#44387](https://github.com/ClickHouse/ClickHouse/pull/44387) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлено чтение типа Map в формате ORC. [#44400](https://github.com/ClickHouse/ClickHouse/pull/44400) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена проблема с чтением столбцов, которые отсутствуют во входных данных в форматах Parquet/ORC. Ранее это могло приводить к ошибке `INCORRECT_NUMBER_OF_COLUMNS`. Закрывает [#44333](https://github.com/ClickHouse/ClickHouse/issues/44333). [#44405](https://github.com/ClickHouse/ClickHouse/pull/44405) ([Kruglov Pavel](https://github.com/Avogar)).
* Ранее функция `bar` использовала один и тот же символ &#39;▋&#39; (U+258B &quot;Left five eighths block&quot;) для отображения как столбика 5/8, так и столбика 6/8. Это изменение исправляет это поведение: теперь для отображения столбика 6/8 используется символ &#39;▊&#39; (U+258A &quot;Left three quarters block&quot;). [#44410](https://github.com/ClickHouse/ClickHouse/pull/44410) ([Alexander Gololobov](https://github.com/davenger)).
* Размещение настроек профиля в конфигурационном файле после ограничений для этих настроек приводило к тому, что ограничения не применялись. [#44411](https://github.com/ClickHouse/ClickHouse/pull/44411) ([Konstantин Bogdanov](https://github.com/thevar1able)).
* Исправлена ошибка `SYNTAX_ERROR` при выполнении запросов `EXPLAIN AST INSERT` с данными. Закрывает [#44207](https://github.com/ClickHouse/ClickHouse/issues/44207). [#44413](https://github.com/ClickHouse/ClickHouse/pull/44413) ([save-my-heart](https://github.com/save-my-heart)).
* Исправлено чтение булевого значения при наличии CRLF в формате CSV. Закрывает [#44401](https://github.com/ClickHouse/ClickHouse/issues/44401). [#44442](https://github.com/ClickHouse/ClickHouse/pull/44442) ([Kruglov Pavel](https://github.com/Avogar)).
* Не выполнять and/or/if/multiIf над столбцом типа LowCardinality, чтобы тип результата не мог быть LowCardinality. В некоторых случаях это могло приводить к ошибке `Illegal column ColumnLowCardinality`. Исправляет [#43603](https://github.com/ClickHouse/ClickHouse/issues/43603). [#44469](https://github.com/ClickHouse/ClickHouse/pull/44469) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена работа мутаций при использовании настройки `max_streams_for_merge_tree_reading`. [#44472](https://github.com/ClickHouse/ClickHouse/pull/44472) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена возможная ошибка разыменования нулевого указателя при использовании `GROUPING SETS` в `ASTSelectQuery::formatImpl` ([#43049](https://github.com/ClickHouse/ClickHouse/issues/43049)). [#44479](https://github.com/ClickHouse/ClickHouse/pull/44479) ([Robert Schulze](https://github.com/rschu1ze)).
* Проверять типы в аргументах табличных функций, аргументах функции CAST и при выводе схемы JSONAsObject в соответствии с настройками. [#44501](https://github.com/ClickHouse/ClickHouse/pull/44501) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена работа функции IN при использовании LowCardinality и константного столбца, закрыта [#44503](https://github.com/ClickHouse/ClickHouse/issues/44503). [#44506](https://github.com/ClickHouse/ClickHouse/pull/44506) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлена ошибка при нормализации выражения `DEFAULT` в операторе `CREATE TABLE`. Второй аргумент функции `in` (или правый аргумент оператора `IN`) мог быть заменен результатом его вычисления при выполнении запроса CREATE. Исправляет [#44496](https://github.com/ClickHouse/ClickHouse/issues/44496). [#44547](https://github.com/ClickHouse/ClickHouse/pull/44547) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Проекции не работают при использовании WITH ROLLUP, WITH CUBE и WITH TOTALS. В предыдущих версиях запрос приводил к исключению вместо того, чтобы просто не использовать проекции. Это исправление закрывает [#44614](https://github.com/ClickHouse/ClickHouse/issues/44614). Это исправление закрывает [#42772](https://github.com/ClickHouse/ClickHouse/issues/42772). [#44615](https://github.com/ClickHouse/ClickHouse/pull/44615) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Асинхронные блоки не очищались, потому что функция `get all blocks sorted by time` не возвращала асинхронные блоки. [#44651](https://github.com/ClickHouse/ClickHouse/pull/44651) ([Han Fei](https://github.com/hanfei1991)).
* Исправлено появление ошибки `LOGICAL_ERROR` `The top step of the right pipeline should be ExpressionStep` при использовании JOIN с подзапросом, UNION и TOTALS. Устранена проблема [#43687](https://github.com/ClickHouse/ClickHouse/issues/43687). [#44673](https://github.com/ClickHouse/ClickHouse/pull/44673) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Предотвращено возникновение исключения `std::out_of_range` в движке таблиц Executable. [#44681](https://github.com/ClickHouse/ClickHouse/pull/44681) ([Kruglov Pavel](https://github.com/Avogar)).
* Не применять `optimize_syntax_fuse_functions` к квантилям в AST, закрыта [#44712](https://github.com/ClickHouse/ClickHouse/issues/44712). [#44713](https://github.com/ClickHouse/ClickHouse/pull/44713) ([Vladimir C](https://github.com/vdimir)).
* Исправлена ошибка, связанная с неверным типом данных в таблице Merge и PREWHERE, закрыт [#43324](https://github.com/ClickHouse/ClickHouse/issues/43324). [#44716](https://github.com/ClickHouse/ClickHouse/pull/44716) ([Vladimir C](https://github.com/vdimir)).
* Исправлена возможная аварийная остановка при завершении работы (во время уничтожения TraceCollector). Исправление для [#44757](https://github.com/ClickHouse/ClickHouse/issues/44757). [#44758](https://github.com/ClickHouse/ClickHouse/pull/44758) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена возможная аварийная остановка при распределённой обработке запросов. Сбой мог происходить, если запрос с totals или extremes возвращал пустой результат, а типы данных в таблице Distributed и соответствующих локальных таблицах не совпадали. Исправляет [#44738](https://github.com/ClickHouse/ClickHouse/issues/44738). [#44760](https://github.com/ClickHouse/ClickHouse/pull/44760) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена работа fsync для операций fetch (`min_compressed_bytes_to_fsync_after_fetch`) и небольших файлов (ttl.txt, columns.txt) при выполнении мутаций (`min_rows_to_fsync_after_merge`/`min_compressed_bytes_to_fsync_after_merge`). [#44781](https://github.com/ClickHouse/ClickHouse/pull/44781) ([Azat Khuzhin](https://github.com/azat)).
* Была возможна редкая гонка состояний при выполнении запросов к таблицам `system.parts` или `system.parts_columns` во время перемещения частей между дисками. Ошибка появилась в [#41145](https://github.com/ClickHouse/ClickHouse/issues/41145). Исправлено в [#44809](https://github.com/ClickHouse/ClickHouse/pull/44809) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка `Context has expired`, которая могла возникать при включённой оптимизации проекций. Она воспроизводилась в запросах с определёнными функциями, например `dictHas/dictGet`, использующими контекст во время выполнения. Исправление для [#44844](https://github.com/ClickHouse/ClickHouse/issues/44844). [#44850](https://github.com/ClickHouse/ClickHouse/pull/44850) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправление ошибки `Cannot read all data`, которая могла возникать при чтении словаря `LowCardinality` из удалённой файловой системы. Исправляет [#44709](https://github.com/ClickHouse/ClickHouse/issues/44709). [#44875](https://github.com/ClickHouse/ClickHouse/pull/44875) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Игнорировать ситуации, когда не удаётся прочитать датчики мониторинга оборудования, и не выводить в логах полное сообщение об исключении. [#44895](https://github.com/ClickHouse/ClickHouse/pull/44895) ([Raúl Marín](https://github.com/Algunenano)).
* Используйте значение `max_delay_to_insert`, если вычисленное время задержки операции INSERT превышает это значение настройки. Связано с [#44902](https://github.com/ClickHouse/ClickHouse/issues/44902). [#44916](https://github.com/ClickHouse/ClickHouse/pull/44916) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлена ошибка `Different order of columns in UNION subquery` при выполнении запросов с `UNION`. Исправляет проблему [#44866](https://github.com/ClickHouse/ClickHouse/issues/44866). [#44920](https://github.com/ClickHouse/ClickHouse/pull/44920) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Задержка для INSERT могла рассчитываться некорректно, из‑за чего в качестве задержки всегда использовалось значение параметра `max_delay_to_insert` вместо правильного. Теперь используется простая формула `max_delay_to_insert * (parts_over_threshold/max_allowed_parts_over_threshold)`, то есть задержка растёт пропорционально количеству частей сверх порога. Закрывает [#44902](https://github.com/ClickHouse/ClickHouse/issues/44902). [#44954](https://github.com/ClickHouse/ClickHouse/pull/44954) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлена ошибка `ALTER TABLE TTL`, которая возникала, если у широкой части была маска легковесного удаления. [#44959](https://github.com/ClickHouse/ClickHouse/pull/44959) ([Mingliang Pan](https://github.com/liangliangpan)).
* Дополнительное исправление к изменению «Replace domain IP types (IPv4, IPv6) with native» [#43221](https://github.com/ClickHouse/ClickHouse/issues/43221). [#45024](https://github.com/ClickHouse/ClickHouse/pull/45024) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Дополнительное исправление к изменению, заменяющему доменные типы IP (IPv4, IPv6) на встроенные [https://github.com/ClickHouse/ClickHouse/pull/43221](https://github.com/ClickHouse/ClickHouse/pull/43221). [#45043](https://github.com/ClickHouse/ClickHouse/pull/45043) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* В парсере было возможно переполнение буфера. Найдено фаззером. [#45047](https://github.com/ClickHouse/ClickHouse/pull/45047) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена потенциальная ошибка cannot-read-all-data в хранилище FileLog. Закрывает [#45051](https://github.com/ClickHouse/ClickHouse/issues/45051), [#38257](https://github.com/ClickHouse/ClickHouse/issues/38257). [#45057](https://github.com/ClickHouse/ClickHouse/pull/45057) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Память-эффективная агрегация (настройка `distributed_aggregation_memory_efficient`) отключается, когда в запросе присутствуют GROUPING SETS. [#45058](https://github.com/ClickHouse/ClickHouse/pull/45058) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлен словарь `RANGE_HASHED`: диапазонные столбцы теперь учитываются как часть первичного ключа при обновлениях, когда указан `update_field`. Закрывает [#44588](https://github.com/ClickHouse/ClickHouse/issues/44588). [#45061](https://github.com/ClickHouse/ClickHouse/pull/45061) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена ошибка `Cannot capture column` при захвате вложенной лямбда-функцией аргумента типа `LowCardinality`. Исправляет [#45028](https://github.com/ClickHouse/ClickHouse/issues/45028). [#45065](https://github.com/ClickHouse/ClickHouse/pull/45065) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен неверный результат запроса с использованием `additional_table_filters` (дополнительный фильтр не применялся) при использовании проекций minmax/count. [#45133](https://github.com/ClickHouse/ClickHouse/pull/45133) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка в функции `histogram`, принимавшей отрицательные значения. [#45147](https://github.com/ClickHouse/ClickHouse/pull/45147) ([simpleton](https://github.com/rgzntrade)).
* Исправлена неверная NULL-допустимость столбца в `StorageJoin`, закрыт [#44940](https://github.com/ClickHouse/ClickHouse/issues/44940). [#45184](https://github.com/ClickHouse/ClickHouse/pull/45184) ([Vladimir C](https://github.com/vdimir)).
* Исправлена ошибка перезагрузки настройки `background_fetches_pool_size` при её увеличении во время работы. [#45189](https://github.com/ClickHouse/ClickHouse/pull/45189) ([Raúl Marín](https://github.com/Algunenano)).
* Теперь корректно обрабатываются `SELECT`-запросы для KV-движков (например, KeeperMap, EmbeddedRocksDB), использующие оператор `IN` по ключу с подзапросом, возвращающим значение другого типа. [#45215](https://github.com/ClickHouse/ClickHouse/pull/45215) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена логическая ошибка в SEMI JOIN и join&#95;use&#95;nulls в некоторых случаях, закрыты [#45163](https://github.com/ClickHouse/ClickHouse/issues/45163) и [#45209](https://github.com/ClickHouse/ClickHouse/issues/45209). [#45230](https://github.com/ClickHouse/ClickHouse/pull/45230) ([Vladimir C](https://github.com/vdimir)).
* Исправлена ошибка использования освобождённой памяти (heap-use-after-free) при чтении из S3. [#45253](https://github.com/ClickHouse/ClickHouse/pull/45253) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка, возникающая, когда тип Avro Union имеет вид [&#39;null&#39;, Nested type], [#45275](https://github.com/ClickHouse/ClickHouse/issues/45275). Исправлена ошибка, из-за которой тип `bytes` некорректно выводился как `Float`. [#45276](https://github.com/ClickHouse/ClickHouse/pull/45276) ([flynn](https://github.com/ucasfl)).
* Теперь выбрасывается корректное исключение, если явный PREWHERE не может быть использован с таблицей с движком `Merge`. [#45319](https://github.com/ClickHouse/ClickHouse/pull/45319) ([Antonio Andelic](https://github.com/antonio2368)).
* В Ubuntu под WSL1 самораспаковывающийся дистрибутив ClickHouse не может распаковаться из‑за несоответствия: `/proc/self/maps` сообщает об inode 32‑битного файла, тогда как `stat` — о 64‑битном inode. [#45339](https://github.com/ClickHouse/ClickHouse/pull/45339) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена гонка при запуске distributed таблицы (которая могла приводить к тому, что файл асинхронного `INSERT` обрабатывался несколько раз). [#45360](https://github.com/ClickHouse/ClickHouse/pull/45360) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена возможная аварийная остановка при чтении из хранилища `S3` и при использовании табличной функции `s3`, если запрос `ListObject` завершился с ошибкой. [#45371](https://github.com/ClickHouse/ClickHouse/pull/45371) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено исключение при выполнении `SELECT ... FROM system.dictionaries`, возникавшее, если существует словарь с некорректной структурой (например, с неправильным типом в XML-конфигурации). [#45399](https://github.com/ClickHouse/ClickHouse/pull/45399) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Исправлено определение схемы в s3Cluster при использовании структуры таблицы назначения в запросах `INSERT INTO ... SELECT * FROM s3Cluster`. [#45422](https://github.com/ClickHouse/ClickHouse/pull/45422) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка разбора JSON/BSONEachRow по HTTP, из-за которой для некоторых столбцов могли использоваться значения по умолчанию вместо значений из данных. [#45424](https://github.com/ClickHouse/ClickHouse/pull/45424) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка (Code: 632. DB::Exception: Unexpected data ... after parsed IPv6 value ...) при типизированном разборе IP-адресов из текстового источника. [#45425](https://github.com/ClickHouse/ClickHouse/pull/45425) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* закрывает [#45297](https://github.com/ClickHouse/ClickHouse/issues/45297) Добавлена проверка на пустые регулярные выражения. [#45428](https://github.com/ClickHouse/ClickHouse/pull/45428) ([Han Fei](https://github.com/hanfei1991)).
* Исправлено возможное зависание распределённого запроса. [#45448](https://github.com/ClickHouse/ClickHouse/pull/45448) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена возможная взаимоблокировка при включённой настройке `allow_asynchronous_read_from_io_pool_for_merge_tree` при возникновении исключения в `ThreadPool::schedule`. [#45481](https://github.com/ClickHouse/ClickHouse/pull/45481) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена потенциальная проблема, при которой таблица могла оставаться используемой после DETACH. [#45493](https://github.com/ClickHouse/ClickHouse/pull/45493) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено редкое аварийное завершение в случае, когда запрос был отменён и при его выполнении использовался параллельный парсинг. [#45498](https://github.com/ClickHouse/ClickHouse/pull/45498) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено состояние гонки между созданием distributed таблицы и выполнением INSERT в неё (оно могло приводить к ошибке CANNOT&#95;LINK при выполнении INSERT в таблицу). [#45502](https://github.com/ClickHouse/ClickHouse/pull/45502) ([Azat Khuzhin](https://github.com/azat)).
* Установлено корректное значение по умолчанию (SLRU) для геттера политики кэширования. Закрывает [#45514](https://github.com/ClickHouse/ClickHouse/issues/45514). [#45524](https://github.com/ClickHouse/ClickHouse/pull/45524) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Запрещено использование `ARRAY JOIN` в мутациях, закрывает [#42637](https://github.com/ClickHouse/ClickHouse/issues/42637) [#44447](https://github.com/ClickHouse/ClickHouse/pull/44447) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправление обработки квалифицированных звёздочек при использовании псевдонима таблицы и трансформера столбцов. Устраняет [#44736](https://github.com/ClickHouse/ClickHouse/issues/44736). [#44755](https://github.com/ClickHouse/ClickHouse/pull/44755) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).

## [Журнал изменений за 2022 год](/whats-new/changelog/2022) {#changelog-for-2022}