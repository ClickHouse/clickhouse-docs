---
slug: /whats-new/changelog/2023
sidebar_position: 4
sidebar_label: '2023'
title: 'Журнал изменений за 2023 год'
description: 'Журнал изменений за 2023 год'
keywords: ['ClickHouse 2023', 'журнал изменений 2023', 'заметки о выпуске', 'история версий', 'улучшения производительности']
doc_type: 'changelog'
---

### Оглавление {#table-of-contents}
**[Релиз ClickHouse v23.12, 2023-12-28](#2312)**<br/>
**[Релиз ClickHouse v23.11, 2023-12-06](#2311)**<br/>
**[Релиз ClickHouse v23.10, 2023-11-02](#2310)**<br/>
**[Релиз ClickHouse v23.9, 2023-09-28](#239)**<br/>
**[Релиз ClickHouse v23.8 LTS, 2023-08-31](#238)**<br/>
**[Релиз ClickHouse v23.7, 2023-07-27](#237)**<br/>
**[Релиз ClickHouse v23.6, 2023-06-30](#236)**<br/>
**[Релиз ClickHouse v23.5, 2023-06-08](#235)**<br/>
**[Релиз ClickHouse v23.4, 2023-04-26](#234)**<br/>
**[Релиз ClickHouse v23.3 LTS, 2023-03-30](#233)**<br/>
**[Релиз ClickHouse v23.2, 2023-02-23](#232)**<br/>
**[Релиз ClickHouse v23.1, 2023-01-25](#231)**<br/>
**[Журнал изменений за 2022 год](/whats-new/changelog/2022/)**<br/>

### <a id="2312"></a> Релиз ClickHouse 23.12, 2023-12-28 {#2312}

#### Несовместимое изменение {#backward-incompatible-change}
* Исправлена проверка на недетерминированные функции в выражениях TTL. Ранее в некоторых случаях можно было создать выражение TTL с недетерминированными функциями, что могло привести к неопределенному поведению в дальнейшем. Это исправляет [#37250](https://github.com/ClickHouse/ClickHouse/issues/37250). По умолчанию запрещены выражения TTL, которые не зависят ни от одного столбца таблицы. Их можно снова разрешить с помощью `SET allow_suspicious_ttl_expressions = 1` или `SET compatibility = '23.11'`. Закрывает [#37286](https://github.com/ClickHouse/ClickHouse/issues/37286). [#51858](https://github.com/ClickHouse/ClickHouse/pull/51858) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Настройка MergeTree `clean_deleted_rows` объявлена устаревшей, она больше ни на что не влияет. Ключевое слово `CLEANUP` для `OPTIMIZE` по умолчанию запрещено (его можно включить настройкой `allow_experimental_replacing_merge_with_cleanup`). [#58267](https://github.com/ClickHouse/ClickHouse/pull/58267) ([Alexander Tokmakov](https://github.com/tavplubix)). Это исправляет [#57930](https://github.com/ClickHouse/ClickHouse/issues/57930). Это закрывает [#54988](https://github.com/ClickHouse/ClickHouse/issues/54988). Это закрывает [#54570](https://github.com/ClickHouse/ClickHouse/issues/54570). Это закрывает [#50346](https://github.com/ClickHouse/ClickHouse/issues/50346). Это закрывает [#47579](https://github.com/ClickHouse/ClickHouse/issues/47579). Эта возможность удаляется, поскольку она неудачна. Мы должны убрать её как можно быстрее, так как другого варианта нет. [#57932](https://github.com/ClickHouse/ClickHouse/pull/57932) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### Новая возможность {#new-feature}

* Реализована поддержка обновляемых материализованных представлений, запрошенных в [#33919](https://github.com/ClickHouse/ClickHouse/issues/33919). [#56946](https://github.com/ClickHouse/ClickHouse/pull/56946) ([Michael Kolupaev](https://github.com/al13n321), [Michael Guzov](https://github.com/koloshmet)).
* Добавлен `PASTE JOIN`, который позволяет соединять таблицы без условия `ON`, просто по номерам строк. Пример: `SELECT * FROM (SELECT number AS a FROM numbers(2)) AS t1 PASTE JOIN (SELECT number AS a FROM numbers(2) ORDER BY a DESC) AS t2`. [#57995](https://github.com/ClickHouse/ClickHouse/pull/57995) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Предложение `ORDER BY` теперь поддерживает указание `ALL`, что означает, что ClickHouse сортирует по всем столбцам в предложении `SELECT`. Пример: `SELECT col1, col2 FROM tab WHERE [...] ORDER BY ALL`. [#57875](https://github.com/ClickHouse/ClickHouse/pull/57875) ([zhongyuankai](https://github.com/zhongyuankai)).
* Добавлена новая команда мутации `ALTER TABLE <table> APPLY DELETED MASK`, которая позволяет принудительно применить маску, созданную операцией lightweight delete, и удалить с диска строки, помеченные как удалённые. [#57433](https://github.com/ClickHouse/ClickHouse/pull/57433) ([Anton Popov](https://github.com/CurtizJ)).
* Обработчик `/binary` открывает визуальный интерфейс для просмотра символов в бинарнике ClickHouse. [#58211](https://github.com/ClickHouse/ClickHouse/pull/58211) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена новая SQL-функция `sqid` для генерации идентификаторов Sqid ([https://sqids.org/](https://sqids.org/)), пример: `SELECT sqid(125, 126)`. [#57512](https://github.com/ClickHouse/ClickHouse/pull/57512) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена новая функция `seriesPeriodDetectFFT` для определения периода ряда с использованием FFT. [#57574](https://github.com/ClickHouse/ClickHouse/pull/57574) ([Bhavna Jindal](https://github.com/bhavnajindal)).
* Добавлен HTTP-эндпойнт для проверки готовности Keeper к приёму трафика. [#55876](https://github.com/ClickHouse/ClickHouse/pull/55876) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Добавлен режим &#39;union&#39; для определения схемы. В этом режиме результирующая схема таблицы является объединением схем всех файлов (то есть схема определяется по каждому файлу). Режим определения схемы управляется настройкой `schema_inference_mode` с двумя возможными значениями — `default` и `union`. Закрывает [#55428](https://github.com/ClickHouse/ClickHouse/issues/55428). [#55892](https://github.com/ClickHouse/ClickHouse/pull/55892) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена новая настройка `input_format_csv_try_infer_numbers_from_strings`, которая позволяет выводить числовые значения из строк при чтении формата CSV. Закрывает [#56455](https://github.com/ClickHouse/ClickHouse/issues/56455). [#56859](https://github.com/ClickHouse/ClickHouse/pull/56859) ([Kruglov Pavel](https://github.com/Avogar)).
* Когда количество баз данных или таблиц превышает заданный порог, пользователю отображается предупреждение. [#57375](https://github.com/ClickHouse/ClickHouse/pull/57375) ([凌涛](https://github.com/lingtaolf)).
* Словарь со структурой `HASHED_ARRAY` (и `COMPLEX_KEY_HASHED_ARRAY`) поддерживает `SHARDS` так же, как и `HASHED`. [#57544](https://github.com/ClickHouse/ClickHouse/pull/57544) ([vdimir](https://github.com/vdimir)).
* Добавлены асинхронные метрики общего числа байт первичного ключа и общего числа байт, выделенных в памяти под первичный ключ. [#57551](https://github.com/ClickHouse/ClickHouse/pull/57551) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлена функция `SHA512_256`. [#57645](https://github.com/ClickHouse/ClickHouse/pull/57645) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлен псевдоним `FORMAT_BYTES` для `formatReadableSize`. [#57592](https://github.com/ClickHouse/ClickHouse/pull/57592) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлена возможность передавать необязательный сеансовый токен в табличную функцию `s3`. [#57850](https://github.com/ClickHouse/ClickHouse/pull/57850) ([Shani Elharrar](https://github.com/shanielh)).
* Введена новая настройка `http_make_head_request`. При её отключении движок таблицы URL не будет выполнять запрос HEAD для определения размера файла. Это необходимо для поддержки неэффективных, неправильно сконфигурированных или не поддерживающих эту возможность HTTP-серверов. [#54602](https://github.com/ClickHouse/ClickHouse/pull/54602) ([Fionera](https://github.com/fionera)).
* Теперь можно ссылаться на столбец ALIAS в определениях индексов (не являющихся первичным ключом) (issue [#55650](https://github.com/ClickHouse/ClickHouse/issues/55650)). Пример: `CREATE TABLE tab(col UInt32, col_alias ALIAS col + 1, INDEX idx (col_alias) TYPE minmax) ENGINE = MergeTree ORDER BY col;`. [#57546](https://github.com/ClickHouse/ClickHouse/pull/57546) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена новая настройка `readonly`, которую можно использовать, чтобы указать, что диск S3 доступен только для чтения. Это может быть полезно для создания таблицы на диске типа `s3_plain` при наличии доступа только на чтение к соответствующему бакету S3. [#57977](https://github.com/ClickHouse/ClickHouse/pull/57977) ([Pengyuan Bian](https://github.com/bianpengyuan)).
* Анализ первичного ключа в таблицах MergeTree теперь будет применяться к предикатам, которые включают виртуальный столбец `_part_offset` (при необходимости с `_part`). Эта возможность может служить особым видом вторичного индекса. [#58224](https://github.com/ClickHouse/ClickHouse/pull/58224) ([Amos Bird](https://github.com/amosbird)).



#### Повышение производительности {#performance-improvement}

* Во время обработки FINAL извлекаются диапазоны частей таблицы MergeTree, которые не пересекаются между собой. Таким образом можно избежать дополнительной логики FINAL для этих непересекающихся диапазонов частей. В случае, когда количество дублирующихся значений с одинаковым первичным ключом невелико, производительность будет почти такой же, как без FINAL. Улучшена производительность чтения для MergeTree с FINAL, когда установлена настройка `do_not_merge_across_partitions_select_final`. [#58120](https://github.com/ClickHouse/ClickHouse/pull/58120) ([Maksim Kita](https://github.com/kitaisreal)).
* Реализовано копирование между дисками S3 с использованием серверного копирования на стороне S3 вместо копирования через буфер. Улучшает операции `BACKUP/RESTORE` и команду `clickhouse-disks copy`. [#56744](https://github.com/ClickHouse/ClickHouse/pull/56744) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Hash JOIN учитывает настройку `max_joined_block_size_rows` и не создаёт крупные блоки для `ALL JOIN`. [#56996](https://github.com/ClickHouse/ClickHouse/pull/56996) ([vdimir](https://github.com/vdimir)).
* Ранее освобождать память при выполнении агрегации. Это может позволить избежать ненужной внешней агрегации. [#57691](https://github.com/ClickHouse/ClickHouse/pull/57691) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Повышена производительность сериализации строк. [#57717](https://github.com/ClickHouse/ClickHouse/pull/57717) ([Maksim Kita](https://github.com/kitaisreal)).
* Реализована поддержка тривиальной оптимизации `count` для таблиц движка `Merge`. [#57867](https://github.com/ClickHouse/ClickHouse/pull/57867) ([skyoct](https://github.com/skyoct)).
* Выполнена оптимизация агрегации в некоторых случаях. [#57872](https://github.com/ClickHouse/ClickHouse/pull/57872) ([Anton Popov](https://github.com/CurtizJ)).
* Функция `hasAny` теперь может использовать преимущества полнотекстовых пропускающих индексов. [#57878](https://github.com/ClickHouse/ClickHouse/pull/57878) ([Jpnock](https://github.com/Jpnock)).
* Функция `if(cond, then, else)` (и её псевдоним `cond ? then : else`) была оптимизирована для безветвленного вычисления. [#57885](https://github.com/ClickHouse/ClickHouse/pull/57885) ([zhanglistar](https://github.com/zhanglistar)).
* MergeTree автоматически определяет значение настройки `do_not_merge_across_partitions_select_final`, если выражение ключа партиционирования содержит только столбцы из выражения первичного ключа. [#58218](https://github.com/ClickHouse/ClickHouse/pull/58218) ([Maksim Kita](https://github.com/kitaisreal)).
* Ускорена работа функций `MIN` и `MAX` для встроенных типов данных. [#58231](https://github.com/ClickHouse/ClickHouse/pull/58231) ([Raúl Marín](https://github.com/Algunenano)).
* Реализована политика кэширования `SLRU` для файлового кэша. [#57076](https://github.com/ClickHouse/ClickHouse/pull/57076) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Лимит на количество подключений на эндпоинт для фоновых выборок увеличен с `15` до значения настройки `background_fetches_pool_size`. - Настройка уровня MergeTree `replicated_max_parallel_fetches_for_host` стала устаревшей. - Настройки уровня MergeTree `replicated_fetches_http_connection_timeout`, `replicated_fetches_http_send_timeout` и `replicated_fetches_http_receive_timeout` перенесены на уровень сервера. - Настройка `keep_alive_timeout` добавлена в список серверных настроек. [#57523](https://github.com/ClickHouse/ClickHouse/pull/57523) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Снизить потребление памяти при выполнении запросов к `system.filesystem_cache`. [#57687](https://github.com/ClickHouse/ClickHouse/pull/57687) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Снижено потребление памяти при десериализации строк. [#57787](https://github.com/ClickHouse/ClickHouse/pull/57787) ([Maksim Kita](https://github.com/kitaisreal)).
* Более эффективный конструктор для Enum — актуален, когда Enum содержит огромное количество значений. [#57887](https://github.com/ClickHouse/ClickHouse/pull/57887) ([Duc Canh Le](https://github.com/canhld94)).
* Улучшено чтение из файлового кэша: теперь всегда используется метод `pread`. [#57970](https://github.com/ClickHouse/ClickHouse/pull/57970) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлена оптимизация для цепочки AND notEquals в оптимизаторе логических выражений. Эта оптимизация доступна только при включенном экспериментальном Analyzer. [#58214](https://github.com/ClickHouse/ClickHouse/pull/58214) ([Kevin Mingtarja](https://github.com/kevinmingtarja)).



#### Улучшение {#improvement}

* Поддержка мягкого лимита памяти в Keeper. Он будет отклонять запросы, если потребление памяти приближается к максимальному значению. [#57271](https://github.com/ClickHouse/ClickHouse/pull/57271) ([Han Fei](https://github.com/hanfei1991)). [#57699](https://github.com/ClickHouse/ClickHouse/pull/57699) ([Han Fei](https://github.com/hanfei1991)).
* Вставки в распределённые таблицы теперь корректно обрабатывают обновления конфигурации кластера. Когда список узлов кластера динамически изменяется, Directory Monitor распределённой таблицы обновляет его. [#42826](https://github.com/ClickHouse/ClickHouse/pull/42826) ([zhongyuankai](https://github.com/zhongyuankai)).
* Не допускать создания реплицированной таблицы с несогласованными параметрами слияния. [#56833](https://github.com/ClickHouse/ClickHouse/pull/56833) ([Duc Canh Le](https://github.com/canhld94)).
* Показывать несжатый размер в `system.tables`. [#56618](https://github.com/ClickHouse/ClickHouse/issues/56618). [#57186](https://github.com/ClickHouse/ClickHouse/pull/57186) ([Chen Lixiang](https://github.com/chenlx0)).
* Добавлена настройка `skip_unavailable_shards` для таблиц `Distributed`, аналогичная одноимённой настройке на уровне запроса. Закрывает [#43666](https://github.com/ClickHouse/ClickHouse/issues/43666). [#57218](https://github.com/ClickHouse/ClickHouse/pull/57218) ([Gagan Goel](https://github.com/tntnatbry)).
* Функция `substring` (псевдонимы: `substr`, `mid`) теперь может использоваться с типами `Enum`. Ранее первый аргумент функции должен был иметь тип `String` или `FixedString`. Это улучшает совместимость со сторонними инструментами, такими как Tableau, при работе через интерфейс MySQL. [#57277](https://github.com/ClickHouse/ClickHouse/pull/57277) ([Serge Klochkov](https://github.com/slvrtrn)).
* Функция `format` теперь поддерживает аргументы произвольных типов (а не только типов `String` и `FixedString`). Это важно, например, для вычисления `SELECT format('The {0} to all questions is {1}', 'answer', 42)`. [#57549](https://github.com/ClickHouse/ClickHouse/pull/57549) ([Robert Schulze](https://github.com/rschu1ze)).
* Позволяет использовать функцию `date_trunc` с первым аргументом без учета регистра. Теперь поддерживаются оба варианта: `SELECT date_trunc('day', now())` и `SELECT date_trunc('DAY', now())`. [#57624](https://github.com/ClickHouse/ClickHouse/pull/57624) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Улучшены подсказки при отсутствии таблицы. [#57342](https://github.com/ClickHouse/ClickHouse/pull/57342) ([Bharat Nallan](https://github.com/bharatnc)).
* Разрешено переопределять серверные настройки `max_partition_size_to_drop` и `max_table_size_to_drop` при выполнении запроса. [#57452](https://github.com/ClickHouse/ClickHouse/pull/57452) ([Jordi Villar](https://github.com/jrdi)).
* Немного улучшено определение типов безымянных кортежей в JSON-форматах. [#57751](https://github.com/ClickHouse/ClickHouse/pull/57751) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка флага только для чтения при подключении к Keeper (исправляет [#53749](https://github.com/ClickHouse/ClickHouse/issues/53749)). [#57479](https://github.com/ClickHouse/ClickHouse/pull/57479) ([Mikhail Koviazin](https://github.com/mkmkme)).
* Исправлено возможное зависание распределённых отправок из-за ошибки «No such file or directory» (при восстановлении пакета с диска). Исправлены возможные проблемы с `error_count` из `system.distribution_queue` (если `distributed_directory_monitor_max_sleep_time_ms` &gt; 5 мин). Добавлено профилирующее событие для отслеживания ошибок асинхронных INSERT — `DistributedAsyncInsertionFailures`. [#57480](https://github.com/ClickHouse/ClickHouse/pull/57480) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка сгенерированных столбцов PostgreSQL и значений по умолчанию для столбцов в `MaterializedPostgreSQL` (экспериментальная функция). Закрывает [#40449](https://github.com/ClickHouse/ClickHouse/issues/40449). [#57568](https://github.com/ClickHouse/ClickHouse/pull/57568) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Позволяет применять изменения некоторых параметров конфигурации кэша файловой системы без перезапуска сервера. [#57578](https://github.com/ClickHouse/ClickHouse/pull/57578) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Корректная обработка структуры таблицы PostgreSQL при наличии пустого массива. [#57618](https://github.com/ClickHouse/ClickHouse/pull/57618) ([Mike Kot](https://github.com/myrrc)).
* Публикует общее число ошибок, произошедших с момента последнего перезапуска сервера, в виде метрики `ClickHouseErrorMetric_ALL`. [#57627](https://github.com/ClickHouse/ClickHouse/pull/57627) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Разрешены узлы в конфигурационном файле со ссылкой `from_env`/`from_zk` и непустым элементом с `replace=1`. [#57628](https://github.com/ClickHouse/ClickHouse/pull/57628) ([Azat Khuzhin](https://github.com/azat)).
* Табличная функция `fuzzJSON`, которая позволяет генерировать множество некорректных JSON-документов для фаззинга. [#57646](https://github.com/ClickHouse/ClickHouse/pull/57646) ([Julia Kartseva](https://github.com/jkartseva)).
* Разрешить преобразование IPv6 в UInt128 и выполнение двоичной арифметики. [#57707](https://github.com/ClickHouse/ClickHouse/pull/57707) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Добавлена настройка `async inserts deduplication cache`, определяющая время ожидания обновления кэша. Настройка `async_block_ids_cache_min_update_interval_ms` объявлена устаревшей. Теперь кэш обновляется только в случае конфликтов. [#57743](https://github.com/ClickHouse/ClickHouse/pull/57743) ([alesapin](https://github.com/alesapin)).
* Функцию `sleep()` теперь можно отменить с помощью `KILL QUERY`. [#57746](https://github.com/ClickHouse/ClickHouse/pull/57746) ([Vitaly Baranov](https://github.com/vitlibar)).
* Запретить запросы `CREATE TABLE ... AS SELECT` для движков таблиц `Replicated` в экспериментальной базе данных `Replicated`, поскольку они не поддерживаются. См. [#35408](https://github.com/ClickHouse/ClickHouse/issues/35408). [#57796](https://github.com/ClickHouse/ClickHouse/pull/57796) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлено и улучшено преобразование запросов к внешним базам данных для рекурсивного получения всех совместимых предикатов. [#57888](https://github.com/ClickHouse/ClickHouse/pull/57888) ([flynn](https://github.com/ucasfl)).
* Добавлена поддержка динамического изменения размера кэша файловой системы. Закрывает [#57866](https://github.com/ClickHouse/ClickHouse/issues/57866). [#57897](https://github.com/ClickHouse/ClickHouse/pull/57897) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Корректно обрабатывать `system.stack_trace` для потоков с заблокированным SIGRTMIN (такие потоки могут встречаться в низкокачественных внешних библиотеках, таких как Apache rdkafka). [#57907](https://github.com/ClickHouse/ClickHouse/pull/57907) ([Azat Khuzhin](https://github.com/azat)). А также отправлять сигнал потокам только если он для них не заблокирован, чтобы избегать ожидания `storage_system_stack_trace_pipe_read_timeout_ms`, когда в этом нет никакого смысла. [#58136](https://github.com/ClickHouse/ClickHouse/pull/58136) ([Azat Khuzhin](https://github.com/azat)).
* Корректно обрабатывать сбои Keeper при проверке вставок с кворумом. [#57986](https://github.com/ClickHouse/ClickHouse/pull/57986) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлен максимум (пиковое значение) RSS (`MemoryResidentMax`) в system.asynchronous&#95;metrics. [#58095](https://github.com/ClickHouse/ClickHouse/pull/58095) ([Azat Khuzhin](https://github.com/azat)).
* Этот PR позволяет пользователям использовать ссылки в стиле S3 (`https://` и `s3://`) без указания региона, даже если он отличается от региона по умолчанию. Также определяется корректный регион, если пользователь указал неверный. [#58148](https://github.com/ClickHouse/ClickHouse/pull/58148) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* `clickhouse-format --obfuscate` будет распознавать Settings, MergeTreeSettings и часовые пояса и оставлять их имена без изменений. [#58179](https://github.com/ClickHouse/ClickHouse/pull/58179) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена явная функция `finalize()` в `ZipArchiveWriter`. Упрощён излишне сложный код в `ZipArchiveWriter`. Исправляет [#58074](https://github.com/ClickHouse/ClickHouse/issues/58074). [#58202](https://github.com/ClickHouse/ClickHouse/pull/58202) ([Vitaly Baranov](https://github.com/vitlibar)).
* Кэши с одинаковым путём теперь используют одни и те же объекты кэша. Такое поведение было и раньше, но было нарушено в версии 23.4. Если такие кэши с одинаковым путём имеют разный набор настроек кэша, будет сгенерировано исключение о том, что это не допускается. [#58264](https://github.com/ClickHouse/ClickHouse/pull/58264) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Параллельные реплики (экспериментальная функция): более удобные параметры [#57542](https://github.com/ClickHouse/ClickHouse/pull/57542) ([Igor Nikonov](https://github.com/devcrafter)).
* Параллельные реплики (экспериментальная функция): улучшена обработка ответов на объявления [#57749](https://github.com/ClickHouse/ClickHouse/pull/57749) ([Igor Nikonov](https://github.com/devcrafter)).
* Параллельные реплики (экспериментальная функция): улучшен учет `min_number_of_marks` в `ParallelReplicasReadingCoordinator` [#57763](https://github.com/ClickHouse/ClickHouse/pull/57763) ([Nikita Taranov](https://github.com/nickitat)).
* Параллельные реплики (экспериментальная функция): отключить параллельные реплики для IN (подзапроса) [#58133](https://github.com/ClickHouse/ClickHouse/pull/58133) ([Igor Nikonov](https://github.com/devcrafter)).
* Параллельные реплики (экспериментальная возможность): добавлено событие профилирования &#39;ParallelReplicasUsedCount&#39; [#58173](https://github.com/ClickHouse/ClickHouse/pull/58173) ([Igor Nikonov](https://github.com/devcrafter)).
* Непостовые запросы, такие как HEAD, будут выполняться только на чтение, аналогично GET. [#58060](https://github.com/ClickHouse/ClickHouse/pull/58060) ([San](https://github.com/santrancisco)).
* Добавлен столбец `bytes_uncompressed` в `system.part_log` [#58167](https://github.com/ClickHouse/ClickHouse/pull/58167) ([Jordi Villar](https://github.com/jrdi)).
* Добавлено имя базового бэкапа в таблицы `system.backups` и `system.backup_log` [#58178](https://github.com/ClickHouse/ClickHouse/pull/58178) ([Pradeep Chhetri](https://github.com/chhetripradeep)).
* Добавлена поддержка указания параметров запроса в утилите clickhouse-local через командную строку [#58210](https://github.com/ClickHouse/ClickHouse/pull/58210) ([Pradeep Chhetri](https://github.com/chhetripradeep)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement}
* Случайным образом варьировать больше настроек [#39663](https://github.com/ClickHouse/ClickHouse/pull/39663) ([Anton Popov](https://github.com/CurtizJ)).
* Случайным образом отключать оптимизации в CI [#57315](https://github.com/ClickHouse/ClickHouse/pull/57315) ([Raúl Marín](https://github.com/Algunenano)).
* Разрешить использование движков таблиц и функций, связанных с Azure, на macOS. [#51866](https://github.com/ClickHouse/ClickHouse/pull/51866) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* ClickHouse Fast Test теперь использует Musl вместо GLibc. [#57711](https://github.com/ClickHouse/ClickHouse/pull/57711) ([Alexey Milovidov](https://github.com/alexey-milovidov)). Полностью статическая сборка на Musl доступна для скачивания из CI.
* Запускать ClickBench для каждого коммита. Это закрывает [#57708](https://github.com/ClickHouse/ClickHouse/issues/57708). [#57712](https://github.com/ClickHouse/ClickHouse/pull/57712) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Удалить использование небезопасной функции C/POSIX `select` во внешних библиотеках. [#57467](https://github.com/ClickHouse/ClickHouse/pull/57467) ([Igor Nikonov](https://github.com/devcrafter)).
* Настройки, доступные только в ClickHouse Cloud, также будут присутствовать в open source-сборке ClickHouse для удобства. [#57638](https://github.com/ClickHouse/ClickHouse/pull/57638) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).

#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release}

* Исправлено возможное нарушение порядка сортировки в TTL GROUP BY [#49103](https://github.com/ClickHouse/ClickHouse/pull/49103) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправление: изменена стратегия разбиения на бакеты `lttb`, первый и последний бакеты должны содержать только по одной точке [#57003](https://github.com/ClickHouse/ClickHouse/pull/57003) ([FFish](https://github.com/wxybear)).
* Исправлена возможная взаимоблокировка в формате `Template` при синхронизации после ошибки [#57004](https://github.com/ClickHouse/ClickHouse/pull/57004) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена преждевременная остановка при разборе файла с пропуском множества ошибок [#57006](https://github.com/ClickHouse/ClickHouse/pull/57006) ([Kruglov Pavel](https://github.com/Avogar)).
* Предотвращён обход ACL словаря через табличную функцию `dictionary` [#57362](https://github.com/ClickHouse/ClickHouse/pull/57362) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Исправлен ещё один случай ошибки «non-ready set», обнаруженной Fuzzer. [#57423](https://github.com/ClickHouse/ClickHouse/pull/57423) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено несколько ошибок, связанных с использованием PostgreSQL `array_ndims`. [#57436](https://github.com/ClickHouse/ClickHouse/pull/57436) ([Ryan Jacobs](https://github.com/ryanmjacobs)).
* Исправлено неконсистентное состояние RWLock после истечения тайм-аута блокировки на запись [#57454](https://github.com/ClickHouse/ClickHouse/pull/57454) ([Vitaly Baranov](https://github.com/vitlibar)). Исправлено неконсистентное состояние RWLock после истечения тайм-аута блокировки на запись (снова) [#57733](https://github.com/ClickHouse/ClickHouse/pull/57733) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправление: не исключать эфемерный столбец при построении цепочки проталкивания в представление [#57461](https://github.com/ClickHouse/ClickHouse/pull/57461) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* MaterializedPostgreSQL (экспериментальная функция): исправлена ошибка [#41922](https://github.com/ClickHouse/ClickHouse/issues/41922), добавлен тест для [#41923](https://github.com/ClickHouse/ClickHouse/issues/41923) [#57515](https://github.com/ClickHouse/ClickHouse/pull/57515) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Игнорировать предложение ON CLUSTER в запросах GRANT/REVOKE при управлении реплицируемыми объектами доступа.  [#57538](https://github.com/ClickHouse/ClickHouse/pull/57538) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Исправлена ошибка, приводившая к сбою в clickhouse-local [#57553](https://github.com/ClickHouse/ClickHouse/pull/57553) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправление ошибки в Hash JOIN. [#57564](https://github.com/ClickHouse/ClickHouse/pull/57564) ([vdimir](https://github.com/vdimir)).
* Исправлена возможная ошибка в источнике PostgreSQL [#57567](https://github.com/ClickHouse/ClickHouse/pull/57567) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено приведение типов в Hash JOIN для вложенных LowCardinality. [#57614](https://github.com/ClickHouse/ClickHouse/pull/57614) ([vdimir](https://github.com/vdimir)).
* Исключены зависания `system.stack_trace` путём корректного запрета параллельного чтения из него. [#57641](https://github.com/ClickHouse/ClickHouse/pull/57641) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка при агрегации разреженных столбцов с `any(...) RESPECT NULL` [#57710](https://github.com/ClickHouse/ClickHouse/pull/57710) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен разбор унарных операторов [#57713](https://github.com/ClickHouse/ClickHouse/pull/57713) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена загрузка зависимостей для экспериментального табличного движка `MaterializedPostgreSQL`. [#57754](https://github.com/ClickHouse/ClickHouse/pull/57754) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлены повторные попытки для отключённых узлов при выполнении BACKUP/RESTORE ON CLUSTER [#57764](https://github.com/ClickHouse/ClickHouse/pull/57764) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен результат внешней агрегации при частично материализованной проекции [#57790](https://github.com/ClickHouse/ClickHouse/pull/57790) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено слияние в агрегатных функциях с комбинатором `*Map` [#57795](https://github.com/ClickHouse/ClickHouse/pull/57795) ([Anton Popov](https://github.com/CurtizJ)).
* Отключите `system.kafka_consumers` из‑за ошибки. [#57822](https://github.com/ClickHouse/ClickHouse/pull/57822) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена поддержка ключей LowCardinality в Merge JOIN. [#57827](https://github.com/ClickHouse/ClickHouse/pull/57827) ([vdimir](https://github.com/vdimir)).
* Исправление в `InterpreterCreateQuery`, связанное с образцовым блоком. [#57855](https://github.com/ClickHouse/ClickHouse/pull/57855) ([Maksim Kita](https://github.com/kitaisreal)).
* `addresses_expr` игнорировались для именованных коллекций PostgreSQL. [#57874](https://github.com/ClickHouse/ClickHouse/pull/57874) ([joelynch](https://github.com/joelynch)).
* Исправлен некорректный доступ к памяти в BLAKE3 (Rust) [#57876](https://github.com/ClickHouse/ClickHouse/pull/57876) ([Raúl Marín](https://github.com/Algunenano)). После этого реализацию переписали с Rust на C++ для повышения [безопасности работы с памятью](https://www.memorysafety.org/). [#57994](https://github.com/ClickHouse/ClickHouse/pull/57994) ([Raúl Марін](https://github.com/Algunenano)).
* Нормализованы имена функций в `CREATE INDEX` [#57906](https://github.com/ClickHouse/ClickHouse/pull/57906) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена обработка недоступных реплик до выполнения первого запроса [#57933](https://github.com/ClickHouse/ClickHouse/pull/57933) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена ошибка некорректной классификации литерального псевдонима [#57988](https://github.com/ClickHouse/ClickHouse/pull/57988) ([Chen768959](https://github.com/Chen768959)).
* Исправлена некорректная предварительная обработка в Keeper [#58069](https://github.com/ClickHouse/ClickHouse/pull/58069) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено целочисленное переполнение в библиотеке `Poco`, связанное с `UTF32Encoding` [#58073](https://github.com/ClickHouse/ClickHouse/pull/58073) ([Andrey Fedotov](https://github.com/anfedotoff)).
* Исправлена работа параллельных реплик (экспериментальная возможность) при наличии скалярного подзапроса с большим целочисленным значением [#58118](https://github.com/ClickHouse/ClickHouse/pull/58118) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена работа функции `accurateCastOrNull` при выходе значений `DateTime` за допустимый диапазон [#58139](https://github.com/ClickHouse/ClickHouse/pull/58139) ([Andrey Zvonov](https://github.com/zvonand)).
* Исправлена возможная ошибка `PARAMETER_OUT_OF_BOUND` при чтении подстолбцов из wide-части в MergeTree [#58175](https://github.com/ClickHouse/ClickHouse/pull/58175) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено снижение производительности `CREATE VIEW` при огромном количестве подзапросов [#58220](https://github.com/ClickHouse/ClickHouse/pull/58220) ([Tao Wang](https://github.com/wangtZJU)).
* Исправлен параллельный разбор JSONCompactEachRow [#58181](https://github.com/ClickHouse/ClickHouse/pull/58181) ([Alexey Milovidov](https://github.com/alexey-milovidov)). [#58250](https://github.com/ClickHouse/ClickHouse/pull/58250) ([Kruglov Pavel](https://github.com/Avogar)).

### <a id="2311"></a> Релиз ClickHouse 23.11, 2023-12-06 {#2311}

#### Обратно несовместимое изменение {#backward-incompatible-change-1}
* В файле конфигурации сервера ClickHouse по умолчанию включены `access_management` (управление пользователями с помощью SQL‑запросов) и `named_collection_control` (управление именованными коллекциями с помощью SQL‑запросов) для пользователя `default`. Это закрывает [#56482](https://github.com/ClickHouse/ClickHouse/issues/56482). [#56619](https://github.com/ClickHouse/ClickHouse/pull/56619) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Множество улучшений для `RESPECT NULLS`/`IGNORE NULLS` для оконных функций. Если вы используете их как агрегатные функции и храните состояния агрегатных функций с этими модификаторами, они могут стать несовместимыми. [#57189](https://github.com/ClickHouse/ClickHouse/pull/57189) ([Raúl Marín](https://github.com/Algunenano)).
* Удалена оптимизация `optimize_move_functions_out_of_any`. [#57190](https://github.com/ClickHouse/ClickHouse/pull/57190) ([Raúl Marín](https://github.com/Algunenano)).
* Спецификаторы формата `%l`/`%k`/`%c` в функции `parseDateTime` теперь могут разбирать часы/месяцы без ведущих нулей, например, `select parseDateTime('2023-11-26 8:14', '%F %k:%i')` теперь работает. Установите `parsedatetime_parse_without_leading_zeros = 0`, чтобы вернуть прежнее поведение, когда требовались две цифры. Функция `formatDateTime` теперь также может выводить часы/месяцы без ведущих нулей. Это управляется настройкой `formatdatetime_format_without_leading_zeros`, но по умолчанию выключено, чтобы не ломать существующие сценарии использования. [#55872](https://github.com/ClickHouse/ClickHouse/pull/55872) ([Azat Khuzhin](https://github.com/azat)).
* Больше нельзя использовать агрегатную функцию `avgWeighted` с аргументами типа `Decimal`. Обходной путь: преобразовать аргументы в `Float64`. Это закрывает [#43928](https://github.com/ClickHouse/ClickHouse/issues/43928). Это закрывает [#31768](https://github.com/ClickHouse/ClickHouse/issues/31768). Это закрывает [#56435](https://github.com/ClickHouse/ClickHouse/issues/56435). Если вы использовали эту функцию внутри материализованных представлений или проекций с аргументами типа `Decimal`, свяжитесь с support@clickhouse.com. Исправлена ошибка в агрегатной функции `sumMap` и её работа замедлена примерно в 1,5–2 раза. Это не имеет значения, поскольку функция в любом случае мусорная. Это закрывает [#54955](https://github.com/ClickHouse/ClickHouse/issues/54955). Это закрывает [#53134](https://github.com/ClickHouse/ClickHouse/issues/53134). Это закрывает [#55148](https://github.com/ClickHouse/ClickHouse/issues/55148). Исправлена ошибка в функции `groupArraySample` — она использовала один и тот же seed генератора случайных чисел в случае, когда в запросе создаётся более одного агрегатного состояния. [#56350](https://github.com/ClickHouse/ClickHouse/pull/56350) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### Новая возможность {#new-feature-1}

* Добавлена серверная настройка `async_load_databases` для асинхронной загрузки баз данных и таблиц. Сокращает время запуска сервера. Применяется к базам данных с движками `Ordinary`, `Atomic` и `Replicated`. Метаданные их таблиц загружаются асинхронно. Запрос к таблице повышает приоритет задания загрузки и ожидает его завершения. Добавлена новая таблица `system.asynchronous_loader` для интроспекции. [#49351](https://github.com/ClickHouse/ClickHouse/pull/49351) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена системная таблица `blob_storage_log`. Она позволяет вести аудит всех данных, записываемых в S3 и другие объектные хранилища. [#52918](https://github.com/ClickHouse/ClickHouse/pull/52918) ([vdimir](https://github.com/vdimir)).
* Используйте статистику для более оптимального упорядочивания условий PREWHERE. [#53240](https://github.com/ClickHouse/ClickHouse/pull/53240) ([Han Fei](https://github.com/hanfei1991)).
* Добавлена поддержка сжатия в протоколе Keeper. Его можно включить на стороне ClickHouse с помощью флага `use_compression` в секции `zookeeper`. Имейте в виду, что сжатие поддерживается только в ClickHouse Keeper, тогда как Apache ZooKeeper его не поддерживает. Исправляет [#49507](https://github.com/ClickHouse/ClickHouse/issues/49507). [#54957](https://github.com/ClickHouse/ClickHouse/pull/54957) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Добавлен параметр `storage_metadata_write_full_object_key`. Если он установлен в значение `true`, метаданные записываются в новом формате. В этом формате ClickHouse сохраняет полный ключ удалённого объекта в файле метаданных, что обеспечивает большую гибкость и более широкие возможности оптимизации. [#55566](https://github.com/ClickHouse/ClickHouse/pull/55566) ([Sema Checherinda](https://github.com/CheSema)).
* Добавлены новые настройки и синтаксис для защиты полей именованных коллекций от перезаписи. Это позволяет предотвратить получение злоумышленником несанкционированного доступа к секретам. [#55782](https://github.com/ClickHouse/ClickHouse/pull/55782) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Добавлен столбец `hostname` во все таблицы системных журналов — это полезно, если вы делаете системные таблицы реплицируемыми, общими или распределёнными. [#55894](https://github.com/ClickHouse/ClickHouse/pull/55894) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлен запрос `CHECK ALL TABLES`. [#56022](https://github.com/ClickHouse/ClickHouse/pull/56022) ([vdimir](https://github.com/vdimir)).
* Добавлена функция `fromDaysSinceYearZero`, аналогичная функции MySQL `FROM_DAYS`. Например, `SELECT fromDaysSinceYearZero(739136)` возвращает `2023-09-08`. [#56088](https://github.com/ClickHouse/ClickHouse/pull/56088) ([Joanna Hulboj](https://github.com/jh0x)).
* Добавлен внешний Python-инструмент для просмотра резервных копий и извлечения из них информации без использования ClickHouse. [#56268](https://github.com/ClickHouse/ClickHouse/pull/56268) ([Vitaly Baranov](https://github.com/vitlibar)).
* Реализована новая настройка `preferred_optimize_projection_name`. Если ей присвоено непустое строковое значение, при возможности будет использоваться указанная проекция вместо выбора из всех кандидатов. [#56309](https://github.com/ClickHouse/ClickHouse/pull/56309) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена 4-буквенная команда для передачи/отказа от роли лидера ([https://github.com/ClickHouse/ClickHouse/issues/56352](https://github.com/ClickHouse/ClickHouse/issues/56352)). [#56354](https://github.com/ClickHouse/ClickHouse/pull/56354) ([Pradeep Chhetri](https://github.com/chhetripradeep)). [#56620](https://github.com/ClickHouse/ClickHouse/pull/56620) ([Pradeep Chhetri](https://github.com/chhetripradeep)).
* Добавлена новая SQL-функция `arrayRandomSample(arr, k)`, которая возвращает выборку из k элементов входного массива. Ранее аналогичную функциональность можно было реализовать только с помощью менее удобного синтаксиса, например: `SELECT arrayReduce('groupArraySample(3)', range(10))`. [#56416](https://github.com/ClickHouse/ClickHouse/pull/56416) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка данных типа `Float16` для использования в файлах формата `.npy`. Закрывает [#56344](https://github.com/ClickHouse/ClickHouse/issues/56344). [#56424](https://github.com/ClickHouse/ClickHouse/pull/56424) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлено системное представление `information_schema.statistics` для повышения совместимости с Tableau Online. [#56425](https://github.com/ClickHouse/ClickHouse/pull/56425) ([Serge Klochkov](https://github.com/slvrtrn)).
* Добавлена таблица `system.symbols`, полезная для анализа бинарного файла. [#56548](https://github.com/ClickHouse/ClickHouse/pull/56548) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Конфигурируемые дашборды. Теперь данные для диаграмм получаются с помощью запроса, который по умолчанию использует новую таблицу `system.dashboards`. [#56771](https://github.com/ClickHouse/ClickHouse/pull/56771) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена табличная функция `fileCluster` — она полезна, если вы монтируете общую файловую систему (NFS и аналогичные) в каталог `user_files`. [#56868](https://github.com/ClickHouse/ClickHouse/pull/56868) ([Andrey Zvonov](https://github.com/zvonand)).
* Добавлен виртуальный столбец `_size` с размером файла в байтах для движков `s3/file/hdfs/url/azureBlobStorage`. [#57126](https://github.com/ClickHouse/ClickHouse/pull/57126) ([Kruglov Pavel](https://github.com/Avogar)).
* Экспортирует количество ошибок по каждому коду, возникших на сервере с момента последнего перезапуска, через endpoint Prometheus. [#57209](https://github.com/ClickHouse/ClickHouse/pull/57209) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* ClickHouse keeper сообщает о зоне доступности, в которой он запущен, по пути `/keeper/availability-zone`. Это можно настроить с помощью `<availability_zone><value>us-west-1a</value></availability_zone>`. [#56715](https://github.com/ClickHouse/ClickHouse/pull/56715) ([Jianfei Hu](https://github.com/incfly)).
* Сделать ALTER materialized&#95;view MODIFY QUERY неэкспериментальной и объявить устаревшей настройку `allow_experimental_alter_materialized_view_structure`. Исправляет [#15206](https://github.com/ClickHouse/ClickHouse/issues/15206). [#57311](https://github.com/ClickHouse/ClickHouse/pull/57311) ([alesapin](https://github.com/alesapin)).
* Параметр `join_algorithm` учитывает заданный порядок [#51745](https://github.com/ClickHouse/ClickHouse/pull/51745) ([vdimir](https://github.com/vdimir)).
* Добавлена поддержка [стандартных типов Protobuf](https://protobuf.dev/reference/protobuf/google.protobuf/) в формате Protobuf. [#56741](https://github.com/ClickHouse/ClickHouse/pull/56741) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).



#### Повышение производительности {#performance-improvement-1}

* Адаптивные тайм-ауты при взаимодействии с S3. Первая попытка выполняется с короткими тайм-аутами на отправку и получение данных. [#56314](https://github.com/ClickHouse/ClickHouse/pull/56314) ([Sema Checherinda](https://github.com/CheSema)).
* Увеличено значение по умолчанию для `max_concurrent_queries` со 100 до 1000. Это имеет смысл, когда есть большое количество подключающихся клиентов, которые медленно отправляют или получают данные, так что производительность сервера не ограничивается CPU, или когда количество ядер CPU больше 100. Также по умолчанию включено управление параллелизмом, а общее желаемое число потоков обработки запросов установлено равным удвоенному количеству ядер CPU. Это улучшает производительность в сценариях с очень большим количеством параллельных запросов. [#46927](https://github.com/ClickHouse/ClickHouse/pull/46927) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка параллельного вычисления оконных функций. Исправляет [#34688](https://github.com/ClickHouse/ClickHouse/issues/34688). [#39631](https://github.com/ClickHouse/ClickHouse/pull/39631) ([Dmitry Novik](https://github.com/novikd)).
* Движок таблицы `Numbers` (таблицы `system.numbers`) теперь анализирует условие запроса, чтобы сгенерировать нужное подмножество данных, аналогично индексу таблицы. [#50909](https://github.com/ClickHouse/ClickHouse/pull/50909) ([JackyWoo](https://github.com/JackyWoo)).
* Повышена производительность фильтрации по условию `IN (...)` для движка таблицы `Merge`. [#54905](https://github.com/ClickHouse/ClickHouse/pull/54905) ([Nikita Taranov](https://github.com/nickitat)).
* Улучшение, проявляющееся при полностью заполненном кэше файловой системы и выполнении крупных операций чтения. [#55158](https://github.com/ClickHouse/ClickHouse/pull/55158) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена возможность отключать контрольные суммы для S3, чтобы избежать лишнего прохода по файлу (управляется настройкой `s3_disable_checksum`). [#55559](https://github.com/ClickHouse/ClickHouse/pull/55559) ([Azat Khuzhin](https://github.com/azat)).
* Теперь мы синхронно читаем с удалённых таблиц, когда данные находятся в кэше страниц (как и для локальных таблиц). Это быстрее, не требует синхронизации внутри пула потоков, спокойно выполняет операции `seek` на локальной ФС и снижает время ожидания CPU. [#55841](https://github.com/ClickHouse/ClickHouse/pull/55841) ([Nikita Taranov](https://github.com/nickitat)).
* Оптимизация извлечения значений из `map` и `arrayElement`. Она даёт ускорение примерно на 30%: уменьшен объём резервируемой памяти, сокращено количество вызовов `resize`. [#55957](https://github.com/ClickHouse/ClickHouse/pull/55957) ([lgbo](https://github.com/lgbo-ustc)).
* Оптимизация многоэтапной фильтрации с использованием AVX-512. Эксперименты по производительности с набором данных OnTime на устройстве ICX (CPU Intel Xeon Platinum 8380, 80 ядер, 160 потоков) показали, что это изменение может увеличить QPS запросов Q2, Q3, Q4, Q5 и Q6 на 7,4%, 5,9%, 4,7%, 3,0% и 4,6% соответственно, не оказывая влияния на остальные. [#56079](https://github.com/ClickHouse/ClickHouse/pull/56079) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
* Ограничено максимальное количество потоков, работающих в профилировщике запросов. Если потоков больше — они будут пропускать профилирование. [#56105](https://github.com/ClickHouse/ClickHouse/pull/56105) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Снижено количество вызовов виртуальных функций в оконных функциях. [#56120](https://github.com/ClickHouse/ClickHouse/pull/56120) ([Maksim Kita](https://github.com/kitaisreal)).
* Разрешить рекурсивное отсечение полей Tuple в формате данных ORC для ускорения сканирования. [#56122](https://github.com/ClickHouse/ClickHouse/pull/56122) ([李扬](https://github.com/taiyang-li)).
* Тривиальная оптимизация подсчёта для формата данных `Npy`: запросы вида `select count() from 'data.npy'` будут выполняться значительно быстрее благодаря кэшированию результатов. [#56304](https://github.com/ClickHouse/ClickHouse/pull/56304) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Запросы с агрегированием и большим количеством потоков будут использовать меньший объём памяти во время построения плана. [#57074](https://github.com/ClickHouse/ClickHouse/pull/57074) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Повышена производительность выполнения запросов для сценариев с большим количеством пользователей и высокой конкурентностью запросов (&gt;2000 QPS) за счёт оптимизации доступа к ProcessList. [#57106](https://github.com/ClickHouse/ClickHouse/pull/57106) ([Andrej Hoos](https://github.com/adikus)).
* Незначительное улучшение `ARRAY JOIN` с повторным использованием некоторых промежуточных результатов. [#57183](https://github.com/ClickHouse/ClickHouse/pull/57183) ([李扬](https://github.com/taiyang-li)).
* Бывали случаи, когда раскрутка стека выполнялась медленно. Теперь — нет. [#57221](https://github.com/ClickHouse/ClickHouse/pull/57221) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Теперь при значении `max_streams = 1` для чтения из внешнего хранилища по умолчанию используется стандартный пул чтения. Это полезно при включённой опережающей выборке (read prefetch). [#57334](https://github.com/ClickHouse/ClickHouse/pull/57334) ([Nikita Taranov](https://github.com/nickitat)).
* Keeper improvement: снижено потребление памяти при запуске за счет отложенной предварительной обработки логов. [#55660](https://github.com/ClickHouse/ClickHouse/pull/55660) ([Antonio Andelic](https://github.com/antonio2368)).
* Улучшена производительность сопоставления с шаблонами glob для хранилищ `File` и `HDFS`. [#56141](https://github.com/ClickHouse/ClickHouse/pull/56141) ([Andrey Zvonov](https://github.com/zvonand)).
* Списки вхождений в экспериментальных полнотекстовых индексах теперь сжимаются, что уменьшает их размер на 10–30%. [#56226](https://github.com/ClickHouse/ClickHouse/pull/56226) ([Harry Lee](https://github.com/HarryLeeIBM)).
* Параллелизирован `BackupEntriesCollector` при создании резервных копий. [#56312](https://github.com/ClickHouse/ClickHouse/pull/56312) ([Kseniia Sumarokova](https://github.com/kssenii)).



#### Улучшение {#improvement-1}

* Добавлена новая настройка `MergeTree` `add_implicit_sign_column_constraint_for_collapsing_engine` (по умолчанию отключена). При включении добавляется неявное ограничение CHECK для таблиц `CollapsingMergeTree`, которое ограничивает значение столбца `Sign` значениями -1 и 1. [#56701](https://github.com/ClickHouse/ClickHouse/issues/56701). [#56986](https://github.com/ClickHouse/ClickHouse/pull/56986) ([Kevin Mingtarja](https://github.com/kevinmingtarja)).
* Добавлена возможность добавлять новые диски в конфигурацию хранилища без перезапуска. [#56367](https://github.com/ClickHouse/ClickHouse/pull/56367) ([Duc Canh Le](https://github.com/canhld94)).
* Добавлена поддержка создания и материализации индекса в одном запросе ALTER, а также выполнения операций «modify TTL» и «materialize TTL» в одном запросе. Закрывает [#55651](https://github.com/ClickHouse/ClickHouse/issues/55651). [#56331](https://github.com/ClickHouse/ClickHouse/pull/56331) ([flynn](https://github.com/ucasfl)).
* Добавлена новая табличная функция `fuzzJSON`, формирующая строки с искажёнными версиями исходной JSON-строки со случайными вариациями. [#56490](https://github.com/ClickHouse/ClickHouse/pull/56490) ([Julia Kartseva](https://github.com/jkartseva)).
* Движок `Merge` фильтрует записи в соответствии с политиками строк базовых таблиц, так что создавать для таблицы `Merge` отдельную политику строк не требуется. [#50209](https://github.com/ClickHouse/ClickHouse/pull/50209) ([Ilya Golshtein](https://github.com/ilejn)).
* Добавлена настройка `max_execution_time_leaf` для ограничения времени выполнения на шарде при выполнении распределённого запроса и `timeout_overflow_mode_leaf` для управления поведением в случае истечения времени ожидания. [#51823](https://github.com/ClickHouse/ClickHouse/pull/51823) ([Duc Canh Le](https://github.com/canhld94)).
* Добавлена настройка ClickHouse, позволяющая отключить туннелирование HTTPS‑запросов через HTTP‑прокси. [#55033](https://github.com/ClickHouse/ClickHouse/pull/55033) ([Arthur Passos](https://github.com/arthurpassos)).
* Установите `background_fetches_pool_size` в 16 и `background&#95;schedule&#95;pool&#95;size` в 512 — такие значения лучше подходят для эксплуатации в production-среде при частых небольших вставках. [#54327](https://github.com/ClickHouse/ClickHouse/pull/54327) ([Denny Crane](https://github.com/den-crane)).
* При чтении данных из файла в формате CSV, если строка оканчивается на `\r`, за которым не следует `\n`, будет сгенерировано следующее исключение: `Cannot parse CSV format: found \r (CR) not followed by \n (LF). Line must end by \n (LF) or \r\n (CR LF) or \n\r.`. В ClickHouse конец строки в CSV должен быть `\n`, `\r\n` или `\n\r`, поэтому за `\r` всегда должен следовать `\n`, но в некоторых случаях входные CSV‑данные бывают некорректными, как в примере выше — `\r` стоит в конце строки. [#54340](https://github.com/ClickHouse/ClickHouse/pull/54340) ([KevinyhZou](https://github.com/KevinyhZou)).
* Обновлена библиотека Arrow до релиза release-13.0.0, который поддерживает новые кодировки. Закрыта задача [#44505](https://github.com/ClickHouse/ClickHouse/issues/44505). [#54800](https://github.com/ClickHouse/ClickHouse/pull/54800) ([Kruglov Pavel](https://github.com/Avogar)).
* Улучшена производительность запросов `ON CLUSTER` за счёт удаления тяжёлых системных вызовов к получению списка всех сетевых интерфейсов при поиске локального IP-адреса в списке хостов DDL-записи. [#54909](https://github.com/ClickHouse/ClickHouse/pull/54909) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлен учет памяти, выделенной до привязки потока к запросу или пользователю. [#56089](https://github.com/ClickHouse/ClickHouse/pull/56089) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлена поддержка типа `LARGE_LIST` в форматах Apache Arrow. [#56118](https://github.com/ClickHouse/ClickHouse/pull/56118) ([edef](https://github.com/edef1c)).
* Добавлена возможность ручной компакции `EmbeddedRocksDB` с помощью запроса `OPTIMIZE`. [#56225](https://github.com/ClickHouse/ClickHouse/pull/56225) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена возможность задавать BlockBasedTableOptions для таблиц `EmbeddedRocksDB`. [#56264](https://github.com/ClickHouse/ClickHouse/pull/56264) ([Azat Khuzhin](https://github.com/azat)).
* `SHOW COLUMNS` теперь отображает эквивалентное имени типа данных MySQL, когда соединение установлено через протокол MySQL. Ранее это происходило только при установке `use_mysql_types_in_show_columns = 1`. При этом настройка сохранена, но помечена как устаревшая. [#56277](https://github.com/ClickHouse/ClickHouse/pull/56277) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена возможная ошибка `The local set of parts of table doesn't look like the set of parts in ZooKeeper`, возникавшая при перезапуске сервера сразу после выполнения операций `TRUNCATE` или `DROP PARTITION`. [#56282](https://github.com/ClickHouse/ClickHouse/pull/56282) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена обработка неконстантных строк запроса в функциях `formatQuery`/`formatQuerySingleLine`. Также добавлены варианты обеих функций с `OrNull`, которые возвращают NULL, если запрос не удаётся разобрать, вместо генерации исключения. [#56327](https://github.com/ClickHouse/ClickHouse/pull/56327) ([Robert Schulze](https://github.com/rschu1ze)).
* Разрешить создавать бэкап материализованного представления с удалённой внутренней таблицей вместо ошибки при создании бэкапа. [#56387](https://github.com/ClickHouse/ClickHouse/pull/56387) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Запросы к `system.replicas` инициируют обращения к ZooKeeper при выборке некоторых столбцов. Когда таблиц тысячи, эти обращения могут создавать значительную нагрузку на ZooKeeper. Если выполняется несколько одновременных запросов к `system.replicas`, они многократно выполняют одни и те же обращения. Изменение позволяет «устранять дублирование» обращений от конкурентных запросов. [#56420](https://github.com/ClickHouse/ClickHouse/pull/56420) ([Alexander Gololobov](https://github.com/davenger)).
* Исправлена трансляция в MySQL-совместимый запрос при выполнении запросов к внешним базам данных. [#56456](https://github.com/ClickHouse/ClickHouse/pull/56456) ([flynn](https://github.com/ucasfl)).
* Добавлена поддержка резервного копирования и восстановления таблиц с использованием движка `KeeperMap`. [#56460](https://github.com/ClickHouse/ClickHouse/pull/56460) ([Antonio Andelic](https://github.com/antonio2368)).
* Ответ с кодом 404 для CompleteMultipartUpload необходимо повторно проверять. Операция могла успешно выполниться на сервере, даже если клиент получил таймаут или другие сетевые ошибки. При следующей попытке CompleteMultipartUpload возвращается ответ 404. Если ключ объекта существует, операция считается успешной. [#56475](https://github.com/ClickHouse/ClickHouse/pull/56475) ([Sema Checherinda](https://github.com/CheSema)).
* Включить HTTP-метод OPTIONS по умолчанию, что упрощает выполнение запросов к ClickHouse из веб-браузера. [#56483](https://github.com/ClickHouse/ClickHouse/pull/56483) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Значение параметра `dns_max_consecutive_failures` было по ошибке изменено в [#46550](https://github.com/ClickHouse/ClickHouse/issues/46550); это изменение отменено, а значение скорректировано на более подходящее. Также увеличен таймаут HTTP keep-alive до разумного значения из боевого окружения. [#56485](https://github.com/ClickHouse/ClickHouse/pull/56485) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Ленивая загрузка базовых резервных копий (базовая резервная копия загружается только при необходимости). Также добавлены некоторые сообщения в лог и события профилирования для резервных копий. [#56516](https://github.com/ClickHouse/ClickHouse/pull/56516) ([Vitaly Baranov](https://github.com/vitlibar)).
* Настройка `query_cache_store_results_of_queries_with_nondeterministic_functions` (со значениями `false` или `true`) признана устаревшей. Она заменена настройкой `query_cache_nondeterministic_function_handling` — это перечислимый тип с тремя значениями, который определяет, как кэш запросов обрабатывает запросы с недетерминированными функциями: a) выбрасывать исключение (поведение по умолчанию), b) сохранять результат недетерминированного запроса в любом случае или c) игнорировать, то есть не выбрасывать исключение и не кэшировать результат. [#56519](https://github.com/ClickHouse/ClickHouse/pull/56519) ([Robert Schulze](https://github.com/rschu1ze)).
* Переписывать сравнение с проверкой на `is null` в секции JOIN ON. Экспериментально, *только Analyzer*. [#56538](https://github.com/ClickHouse/ClickHouse/pull/56538) ([vdimir](https://github.com/vdimir)).
* Функция `concat` теперь поддерживает аргументы произвольных типов (а не только аргументы типов String и FixedString). Это делает её поведение более похожим на реализацию `concat` в MySQL. Например, `SELECT concat('ab', 42)` теперь возвращает `ab42`. [#56540](https://github.com/ClickHouse/ClickHouse/pull/56540) ([Serge Klochkov](https://github.com/slvrtrn)).
* Добавлена возможность получать конфигурацию кэша из секции &#39;named&#95;collection&#39; в конфигурации или из созданных через SQL именованных коллекций. [#56541](https://github.com/ClickHouse/ClickHouse/pull/56541) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Движок базы данных PostgreSQL: удаление устаревших таблиц стало менее агрессивным при неудачном подключении к Postgres. [#56609](https://github.com/ClickHouse/ClickHouse/pull/56609) ([jsc0218](https://github.com/jsc0218)).
* Подключение к PG занимало слишком много времени при неверном URL, из-за чего соответствующий запрос зависал и затем отменялся. [#56648](https://github.com/ClickHouse/ClickHouse/pull/56648) ([jsc0218](https://github.com/jsc0218)).
* Улучшение Keeper: по умолчанию отключено ведение сжатых логов в Keeper. [#56763](https://github.com/ClickHouse/ClickHouse/pull/56763) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена конфигурационная настройка `wait_dictionaries_load_at_startup`. [#56782](https://github.com/ClickHouse/ClickHouse/pull/56782) ([Vitaly Baranov](https://github.com/vitlibar)).
* В предыдущих версиях ClickHouse существовала потенциальная уязвимость: если пользователь устанавливал соединение и безуспешно пытался аутентифицироваться с помощью метода interserver secret, сервер не разрывал соединение немедленно, а продолжал получать и игнорировать последующие пакеты от клиента. Хотя эти пакеты игнорируются, они всё равно разбираются, и если в них используется метод сжатия с другой известной уязвимостью, это приводит к её эксплуатации без аутентификации. Эта проблема была обнаружена в рамках [ClickHouse Bug Bounty Program](https://github.com/ClickHouse/ClickHouse/issues/38986) пользователем [https://twitter.com/malacupa](https://twitter.com/malacupa). [#56794](https://github.com/ClickHouse/ClickHouse/pull/56794) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Получение части ожидает, пока эта часть не будет полностью закоммичена на удалённой реплике. Лучше не отправлять часть в состоянии PreActive. В случае zero copy это обязательное ограничение. [#56808](https://github.com/ClickHouse/ClickHouse/pull/56808) ([Sema Checherinda](https://github.com/CheSema)).
* Исправлена возможная ошибка преобразования при логической репликации PostgreSQL при использовании экспериментального `MaterializedPostgreSQL`. [#53721](https://github.com/ClickHouse/ClickHouse/pull/53721) ([takakawa](https://github.com/takakawa)).
* Реализована пользовательская настройка `alter_move_to_space_execute_async`, которая позволяет выполнять запросы `ALTER TABLE ... MOVE PARTITION|PART TO DISK|VOLUME` асинхронно. Размер пула для фонового выполнения управляется настройкой `background_move_pool_size`. Поведение по умолчанию — синхронное выполнение. Исправляет [#47643](https://github.com/ClickHouse/ClickHouse/issues/47643). [#56809](https://github.com/ClickHouse/ClickHouse/pull/56809) ([alesapin](https://github.com/alesapin)).
* Возможность фильтровать по движку при сканировании `system.tables`, чтобы избежать ненужного (и потенциально затратного по времени) соединения. [#56813](https://github.com/ClickHouse/ClickHouse/pull/56813) ([jsc0218](https://github.com/jsc0218)).
* Отображать `total_bytes` и `total_rows` в системных таблицах для хранилища RocksDB. [#56816](https://github.com/ClickHouse/ClickHouse/pull/56816) ([Aleksandr Musorin](https://github.com/AVMusorin)).
* Разрешены базовые команды ALTER для временных таблиц. [#56892](https://github.com/ClickHouse/ClickHouse/pull/56892) ([Sergey](https://github.com/icuken)).
* Сжатие LZ4. Теперь сжатый блок буферизуется в редких случаях, когда ёмкости выходного буфера недостаточно для его прямой записи в буфер вывода. [#56938](https://github.com/ClickHouse/ClickHouse/pull/56938) ([Sema Checherinda](https://github.com/CheSema)).
* Добавлены метрики количества задач в очереди, что полезно для пула потоков ввода-вывода. [#56958](https://github.com/ClickHouse/ClickHouse/pull/56958) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена настройка для движка таблиц PostgreSQL в конфигурационный файл. Добавлена проверка этой настройки. Добавлена документация по дополнительной настройке. [#56959](https://github.com/ClickHouse/ClickHouse/pull/56959) ([Peignon Melvyn](https://github.com/melvynator)).
* Функцию `concat` теперь можно вызывать с одним аргументом, например, `SELECT concat('abc')`. Это делает её поведение более согласованным с реализацией функции `concat` в MySQL. [#57000](https://github.com/ClickHouse/ClickHouse/pull/57000) ([Serge Klochkov](https://github.com/slvrtrn)).
* Подписывает все заголовки `x-amz-*` в соответствии с требованиями документации AWS S3. [#57001](https://github.com/ClickHouse/ClickHouse/pull/57001) ([Arthur Passos](https://github.com/arthurpassos)).
* Функция `fromDaysSinceYearZero` (псевдоним: `FROM_DAYS`) теперь может использоваться с целочисленными типами со знаком и без знака (ранее требовалось, чтобы значение было целым числом без знака). Это улучшает совместимость со сторонними инструментами, такими как Tableau Online. [#57002](https://github.com/ClickHouse/ClickHouse/pull/57002) ([Serge Klochkov](https://github.com/slvrtrn)).
* Добавить `system.s3queue_log` в конфигурацию по умолчанию. [#57036](https://github.com/ClickHouse/ClickHouse/pull/57036) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Изменено значение по умолчанию параметра `wait_dictionaries_load_at_startup` на true; используйте его только если `dictionaries_lazy_load` имеет значение false. [#57133](https://github.com/ClickHouse/ClickHouse/pull/57133) ([Vitaly Baranov](https://github.com/vitlibar)).
* Проверять тип источника словаря при создании, даже если включен `dictionaries_lazy_load`. [#57134](https://github.com/ClickHouse/ClickHouse/pull/57134) ([Vitaly Baranov](https://github.com/vitlibar)).
* Оптимизации на уровне плана теперь можно включать и отключать по отдельности. Ранее можно было только отключить их все целиком. Настройка, которая ранее выполняла эту функцию (`query_plan_enable_optimizations`), сохранена и по-прежнему может использоваться для отключения всех оптимизаций. [#57152](https://github.com/ClickHouse/ClickHouse/pull/57152) ([Robert Schulze](https://github.com/rschu1ze)).
* Код завершения сервера будет соответствовать коду исключения. Например, если сервер не может запуститься из-за ограничения по памяти, он завершит работу с кодом 241 = MEMORY&#95;LIMIT&#95;EXCEEDED. В предыдущих версиях код завершения для исключений всегда был 70 = Poco::Util::ExitCode::EXIT&#95;SOFTWARE. [#57153](https://github.com/ClickHouse/ClickHouse/pull/57153) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Не выполнять деманглирование и символизацию кадров стека из заголовочного файла C++ `functional`. [#57201](https://github.com/ClickHouse/ClickHouse/pull/57201) ([Mike Kot](https://github.com/myrrc)).
* Страница HTTP-сервера `/dashboard` теперь поддерживает графики с несколькими линиями данных. [#57236](https://github.com/ClickHouse/ClickHouse/pull/57236) ([Sergei Trifonov](https://github.com/serxa)).
* Опция командной строки `max_memory_usage_in_client` поддерживает строковое значение с суффиксом (K, M, G и т. д.). Закрывает [#56879](https://github.com/ClickHouse/ClickHouse/issues/56879). [#57273](https://github.com/ClickHouse/ClickHouse/pull/57273) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Обновлена Intel QPL (используется кодеком `DEFLATE_QPL`) с v1.2.0 до v1.3.1. Также исправлена ошибка при BOF (Block On Fault) = 0: изменено поведение обработки отказов страниц — теперь выполняется переход на программный путь (SW path). [#57291](https://github.com/ClickHouse/ClickHouse/pull/57291) ([jasperzhu](https://github.com/jinjunzh)).
* Увеличено значение по умолчанию параметра MergeTree `replicated_deduplication_window` со 100 до 1k. [#57335](https://github.com/ClickHouse/ClickHouse/pull/57335) ([sichenzhao](https://github.com/sichenzhao)).
* Старайтесь реже использовать `INCONSISTENT_METADATA_FOR_BACKUP`. По возможности продолжайте сканирование вместо того, чтобы останавливать его и запускать сканирование для резервного копирования заново с самого начала. [#57385](https://github.com/ClickHouse/ClickHouse/pull/57385) ([Vitaly Baranov](https://github.com/vitlibar)).



#### Улучшение сборки/тестирования/упаковки {#buildtestingpackaging-improvement-1}

* Добавлен тест SQLLogic. [#56078](https://github.com/ClickHouse/ClickHouse/pull/56078) ([Han Fei](https://github.com/hanfei1991)).
* Добавлены короткие имена (`ch`, `chl`, `chc`) для удобного использования `clickhouse-local` и `clickhouse-client`. [#56634](https://github.com/ClickHouse/ClickHouse/pull/56634) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Дополнительно уменьшен размер сборки за счет удаления неиспользуемого кода во внешних библиотеках. [#56786](https://github.com/ClickHouse/ClickHouse/pull/56786) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена автоматическая проверка на отсутствие слишком больших единиц трансляции. [#56559](https://github.com/ClickHouse/ClickHouse/pull/56559) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Уменьшен размер однобинарной сборки. Это закрывает [#55181](https://github.com/ClickHouse/ClickHouse/issues/55181). [#56617](https://github.com/ClickHouse/ClickHouse/pull/56617) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Информация о размерах всех единиц трансляции и бинарных файлов после каждой сборки будет отправляться в базу данных CI в ClickHouse Cloud. Это закрывает [#56107](https://github.com/ClickHouse/ClickHouse/issues/56107). [#56636](https://github.com/ClickHouse/ClickHouse/pull/56636) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Некоторые файлы библиотеки &quot;Apache Arrow&quot; (которую мы используем только для второстепенных задач, например разбора формата Arrow) каждый раз пересобирались, независимо от кэша сборки. Это исправлено. [#56657](https://github.com/ClickHouse/ClickHouse/pull/56657) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Избегайте повторной компиляции единиц трансляции, зависящих от автогенерируемого исходного файла с информацией о версии. [#56660](https://github.com/ClickHouse/ClickHouse/pull/56660) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Данные трассировки вызовов компоновщика будут отправляться в CI-базу данных в ClickHouse Cloud. [#56725](https://github.com/ClickHouse/ClickHouse/pull/56725) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Использовать отладочные символы DWARF 5 для исполняемого файла clickhouse (ранее использовался DWARF 4). [#56770](https://github.com/ClickHouse/ClickHouse/pull/56770) ([Michael Kolupaev](https://github.com/al13n321)).
* Добавлен новый параметр сборки `SANITIZE_COVERAGE`. Если он включён, код дополнительно инструментируется для отслеживания покрытия. Собранная информация доступна внутри ClickHouse через: (1) новую функцию `coverage`, которая возвращает массив уникальных адресов в коде, обнаруженных после предыдущего сброса покрытия; (2) запрос `SYSTEM RESET COVERAGE`, который сбрасывает накопленные данные. Это позволяет сравнивать покрытие разных тестов, включая дифференциальное покрытие кода. Продолжение [#20539](https://github.com/ClickHouse/ClickHouse/issues/20539). [#56102](https://github.com/ClickHouse/ClickHouse/pull/56102) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* При сборе стеков некоторые фреймы могут не разрешаться. В таких случаях может быть полезен их необработанный адрес. [#56267](https://github.com/ClickHouse/ClickHouse/pull/56267) ([Alexander Gololobov](https://github.com/davenger)).
* Добавлена возможность отключить `libssh`. [#56333](https://github.com/ClickHouse/ClickHouse/pull/56333) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Включена temporary&#95;data&#95;in&#95;cache в S3-тестах в CI. [#48425](https://github.com/ClickHouse/ClickHouse/pull/48425) ([vdimir](https://github.com/vdimir)).
* Установлен максимальный объём памяти для clickhouse-client (`1G`) в CI. [#56873](https://github.com/ClickHouse/ClickHouse/pull/56873) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).



#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-1}

* Исправлен экспериментальный Analyzer — оператор `INSERT ... SELECT` с подзапросом, ссылающимся на таблицу, в которую выполняется вставка, должен обрабатывать только вставляемый блок данных. [#50857](https://github.com/ClickHouse/ClickHouse/pull/50857) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена ошибка в функции `str_to_map`. [#56423](https://github.com/ClickHouse/ClickHouse/pull/56423) ([Arthur Passos](https://github.com/arthurpassos)).
* Keeper `reconfig`: добавить тайм-аут перед отказом от/получением лидерства [#53481](https://github.com/ClickHouse/ClickHouse/pull/53481) ([Mike Kot](https://github.com/myrrc)).
* Исправлен некорректный заголовок в операциях grace hash join и filter pushdown [#53922](https://github.com/ClickHouse/ClickHouse/pull/53922) ([vdimir](https://github.com/vdimir)).
* Разрешён выбор из системных таблиц, если таблица создана на основе табличной функции. [#55540](https://github.com/ClickHouse/ClickHouse/pull/55540) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* RFC: исправление ошибки «Cannot find column X in source stream» для распределённых запросов с LIMIT BY [#55836](https://github.com/ClickHouse/ClickHouse/pull/55836) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка &#39;Cannot read from file:&#39; при запуске клиента в фоновом режиме [#55976](https://github.com/ClickHouse/ClickHouse/pull/55976) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено аварийное завершение работы clickhouse-local при некорректной настройке send&#95;logs&#95;level [#55994](https://github.com/ClickHouse/ClickHouse/pull/55994) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка EXPLAIN AST с параметризованным представлением [#56004](https://github.com/ClickHouse/ClickHouse/pull/56004) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлена ошибка, приводившая к аварийному завершению работы при загрузке таблиц во время запуска [#56232](https://github.com/ClickHouse/ClickHouse/pull/56232) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлены словари с источником ClickHouse с использованием явного запроса [#56236](https://github.com/ClickHouse/ClickHouse/pull/56236) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена ошибка сегментации (segfault) в обработчике сигналов Keeper [#56266](https://github.com/ClickHouse/ClickHouse/pull/56266) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена проблема неполного результата запроса с UNION в функции view(). [#56274](https://github.com/ClickHouse/ClickHouse/pull/56274) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Устранено несоответствие между &quot;cast(&#39;0&#39; as DateTime64(3))&quot; и &quot;cast(&#39;0&#39; as Nullable(DateTime64(3)))&quot; [#56286](https://github.com/ClickHouse/ClickHouse/pull/56286) ([李扬](https://github.com/taiyang-li)).
* Исправлено редкое состояние гонки, связанное с ошибкой выделения памяти [#56303](https://github.com/ClickHouse/ClickHouse/pull/56303) ([alesapin](https://github.com/alesapin)).
* Исправлено восстановление из резервной копии при использовании `flatten_nested` и `data_type_default_nullable` [#56306](https://github.com/ClickHouse/ClickHouse/pull/56306) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка, приводившая к сбою при добавлении столбца с типом Object(JSON) [#56307](https://github.com/ClickHouse/ClickHouse/pull/56307) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлен сбой в filterPushDown [#56380](https://github.com/ClickHouse/ClickHouse/pull/56380) ([vdimir](https://github.com/vdimir)).
* Исправлено восстановление из бэкапа с материализованным представлением и удалённой исходной таблицей [#56383](https://github.com/ClickHouse/ClickHouse/pull/56383) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка сегментации во время инициализации Kerberos [#56401](https://github.com/ClickHouse/ClickHouse/pull/56401) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлено переполнение буфера в T64 [#56434](https://github.com/ClickHouse/ClickHouse/pull/56434) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлен первичный ключ типа Nullable в final (2) [#56452](https://github.com/ClickHouse/ClickHouse/pull/56452) ([Amos Bird](https://github.com/amosbird)).
* Исправлена работа запросов ON CLUSTER без указанной базы данных на исходном узле [#56484](https://github.com/ClickHouse/ClickHouse/pull/56484) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлен сбой запуска из-за зависимости от TTL [#56489](https://github.com/ClickHouse/ClickHouse/pull/56489) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлены запросы `ALTER COMMENT` с `ON CLUSTER` [#56491](https://github.com/ClickHouse/ClickHouse/pull/56491) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена операция ALTER COLUMN с ALIAS [#56493](https://github.com/ClickHouse/ClickHouse/pull/56493) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена обработка пустых NAMED COLLECTIONs [#56494](https://github.com/ClickHouse/ClickHouse/pull/56494) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлены две проблемы в анализе проекций. [#56502](https://github.com/ClickHouse/ClickHouse/pull/56502) ([Amos Bird](https://github.com/amosbird)).
* Исправлена обработка псевдонимов в кэше запросов [#56545](https://github.com/ClickHouse/ClickHouse/pull/56545) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена ошибка преобразования из `Nullable(Enum)` в `Nullable(String)` [#56644](https://github.com/ClickHouse/ClickHouse/pull/56644) ([Nikolay Degterinsky](https://github.com/evillique)).
* Более надёжная обработка логов в Keeper [#56670](https://github.com/ClickHouse/ClickHouse/pull/56670) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено объединение конфигурации для узлов, использующих атрибуты подстановки [#56694](https://github.com/ClickHouse/ClickHouse/pull/56694) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлено повторное использование табличной функции input(). [#56695](https://github.com/ClickHouse/ClickHouse/pull/56695) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена проблема с динамической загрузкой OpenSSL в RabbitMQ [#56703](https://github.com/ClickHouse/ClickHouse/pull/56703) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлен сбой в кодеке GCD при наличии нулей в данных [#56704](https://github.com/ClickHouse/ClickHouse/pull/56704) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена ошибка &#39;mutex lock failed: Invalid argument&#39; в clickhouse-local при выполнении insert into function [#56710](https://github.com/ClickHouse/ClickHouse/pull/56710) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена обработка текстового представления типа Date в оптимистическом пути [#56765](https://github.com/ClickHouse/ClickHouse/pull/56765) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен сбой кодека FPC [#56795](https://github.com/ClickHouse/ClickHouse/pull/56795) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* DatabaseReplicated: исправлено истечение времени ожидания DDL-запроса после восстановления реплики [#56796](https://github.com/ClickHouse/ClickHouse/pull/56796) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена некорректная передача сведений о столбцах с типом Nullable в бинарном протоколе MySQL [#56799](https://github.com/ClickHouse/ClickHouse/pull/56799) ([Serge Klochkov](https://github.com/slvrtrn)).
* Добавлена поддержка файлов метаданных Iceberg для таблиц metastore [#56810](https://github.com/ClickHouse/ClickHouse/pull/56810) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен отчёт TSAN в transform [#56817](https://github.com/ClickHouse/ClickHouse/pull/56817) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлены запрос SET и форматирование SETTINGS [#56825](https://github.com/ClickHouse/ClickHouse/pull/56825) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена ошибка, приводившая к невозможности запуска из‑за зависимости таблицы в joinGet [#56828](https://github.com/ClickHouse/ClickHouse/pull/56828) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена проблема с разворачиванием существующих столбцов типа Nested при выполнении ADD COLUMN [#56830](https://github.com/ClickHouse/ClickHouse/pull/56830) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена поддержка символа CR в конце строки в CSV [#56901](https://github.com/ClickHouse/ClickHouse/pull/56901) ([KevinyhZou](https://github.com/KevinyhZou)).
* Исправлена работа `tryBase64Decode` с некорректным вводом [#56913](https://github.com/ClickHouse/ClickHouse/pull/56913) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена генерация глубоко вложенных столбцов в схемах CapnProto и Protobuf [#56941](https://github.com/ClickHouse/ClickHouse/pull/56941) ([Kruglov Pavel](https://github.com/Avogar)).
* Предотвращено выполнение несовместимых операций ALTER для столбцов проекций [#56948](https://github.com/ClickHouse/ClickHouse/pull/56948) ([Amos Bird](https://github.com/amosbird)).
* Исправлена проверка корректности пути к файлу SQLite [#56984](https://github.com/ClickHouse/ClickHouse/pull/56984) ([San](https://github.com/santrancisco)).
* S3Queue: исправлен инкремент счётчика ссылок на метаданные [#56990](https://github.com/ClickHouse/ClickHouse/pull/56990) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Небольшое исправление в S3Queue [#56999](https://github.com/ClickHouse/ClickHouse/pull/56999) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проверка пути к файлу для DatabaseFileSystem [#57029](https://github.com/ClickHouse/ClickHouse/pull/57029) ([San](https://github.com/santrancisco)).
* Исправлен `fuzzBits` при использовании `ARRAY JOIN` [#57033](https://github.com/ClickHouse/ClickHouse/pull/57033) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка разыменования nullptr при partial merge join с joined&#95;subquery&#95;re... [#57048](https://github.com/ClickHouse/ClickHouse/pull/57048) ([vdimir](https://github.com/vdimir)).
* Исправлена гонка состояний в RemoteSource [#57052](https://github.com/ClickHouse/ClickHouse/pull/57052) ([Raúl Marín](https://github.com/Algunenano)).
* Реализована функция `bitHammingDistance` для больших целых чисел [#57073](https://github.com/ClickHouse/ClickHouse/pull/57073) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка с ссылками формата S3 [#57075](https://github.com/ClickHouse/ClickHouse/pull/57075) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Исправлена функция JSON&#95;QUERY с несколькими числовыми путями [#57096](https://github.com/ClickHouse/ClickHouse/pull/57096) ([KevinyhZou](https://github.com/KevinyhZou)).
* Исправлено переполнение буфера в кодеке Gorilla [#57107](https://github.com/ClickHouse/ClickHouse/pull/57107) ([Nikolay Degterinsky](https://github.com/evillique)).
* Закрывать межсерверное соединение при возникновении любого исключения до аутентификации [#57142](https://github.com/ClickHouse/ClickHouse/pull/57142) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлен segfault при выполнении ALTER UPDATE со столбцом Nullable MATERIALIZED [#57147](https://github.com/ClickHouse/ClickHouse/pull/57147) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена ошибка в оптимизации плана JOIN при частично материализованной обычной проекции [#57196](https://github.com/ClickHouse/ClickHouse/pull/57196) ([Amos Bird](https://github.com/amosbird)).
* Игнорировать комментарии при сравнении описаний столбцов [#57259](https://github.com/ClickHouse/ClickHouse/pull/57259) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена метрика `ReadonlyReplica` во всех случаях [#57267](https://github.com/ClickHouse/ClickHouse/pull/57267) ([Antonio Andelic](https://github.com/antonio2368)).
* Фоновые слияния теперь корректно используют временное хранилище данных в кэше [#57275](https://github.com/ClickHouse/ClickHouse/pull/57275) ([vdimir](https://github.com/vdimir)).
* Исправление в Keeper для журнала изменений и снимков [#57299](https://github.com/ClickHouse/ClickHouse/pull/57299) ([Antonio Andelic](https://github.com/antonio2368)).
* Игнорировать завершённые задачи ON CLUSTER, если изменилось имя хоста [#57339](https://github.com/ClickHouse/ClickHouse/pull/57339) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Мутации MergeTree повторно используют зернистость индекса исходной части [#57352](https://github.com/ClickHouse/ClickHouse/pull/57352) ([Maksim Kita](https://github.com/kitaisreal)).
* FS cache: добавлено ограничение на фоновую загрузку [#57424](https://github.com/ClickHouse/ClickHouse/pull/57424) ([Kseniia Sumarokova](https://github.com/kssenii)).

### <a id="2310"></a> Релиз ClickHouse 23.10, 2023-11-02 {#2310}

#### Обратно несовместимое изменение {#backward-incompatible-change-2}
* Больше нет возможности автоматически удалять повреждённые куски данных. Это закрывает [#55174](https://github.com/ClickHouse/ClickHouse/issues/55174). [#55184](https://github.com/ClickHouse/ClickHouse/pull/55184) ([Alexey Milovidov](https://github.com/alexey-milovidov)). [#55557](https://github.com/ClickHouse/ClickHouse/pull/55557) ([Jihyuk Bok](https://github.com/tomahawk28)).
* Устаревшие куски данных в памяти больше не могут читаться из журнала предзаписи (write-ahead log). Если вы ранее настраивали части данных в памяти (in-memory parts), их необходимо удалить перед обновлением. [#55186](https://github.com/ClickHouse/ClickHouse/pull/55186) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Удалена интеграция с Meilisearch. Причина: она была совместима только со старой версией 0.18. В новой версии Meilisearch протокол был изменён и больше не совместим. Примечание: мы будем признательны, если вы поможете вернуть её обратно. [#55189](https://github.com/ClickHouse/ClickHouse/pull/55189) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Переименована концепция directory monitor в background INSERT. Все настройки `*directory_monitor*` были переименованы в `distributed_background_insert*`. *Обратная совместимость должна быть сохранена* (так как старые настройки были добавлены как псевдонимы). [#55978](https://github.com/ClickHouse/ClickHouse/pull/55978) ([Azat Khuzhin](https://github.com/azat)).
* `send_timeout`, установленный на стороне клиента, больше не интерпретируется как `receive_timeout` на стороне сервера и наоборот. [#56035](https://github.com/ClickHouse/ClickHouse/pull/56035) ([Azat Khuzhin](https://github.com/azat)).
* Сравнение временных интервалов с разными единицами измерения теперь будет приводить к выбросу исключения. Это закрывает [#55942](https://github.com/ClickHouse/ClickHouse/issues/55942). Возможно, вы иногда полагались на предыдущее поведение, когда сравнивались базовые числовые значения независимо от единиц измерения. [#56090](https://github.com/ClickHouse/ClickHouse/pull/56090) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Экспериментальный движок таблиц `S3Queue` был полностью переработан: изменён способ хранения информации в ZooKeeper, что позволяет выполнять меньше запросов в ZooKeeper, добавлено кэширование состояния ZooKeeper в случаях, когда известно, что состояние не изменится, улучшен процесс опроса S3, чтобы сделать его менее агрессивным, изменён способ сопровождения TTL и максимального набора для отслеживаемых файлов — теперь это фоновый процесс. Добавлены таблицы `system.s3queue` и `system.s3queue_log`. Закрывает [#54998](https://github.com/ClickHouse/ClickHouse/issues/54998). [#54422](https://github.com/ClickHouse/ClickHouse/pull/54422) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Произвольные пути на HTTP-эндпоинте больше не интерпретируются как запрос к эндпоинту `/query`. [#55521](https://github.com/ClickHouse/ClickHouse/pull/55521) ([Konstantin Bogdanov](https://github.com/thevar1able)).

#### Новая возможность {#new-feature-2}

* Добавлена функция `arrayFold(accumulator, x1, ..., xn -> expression, initial, array1, ..., arrayn)`, которая применяет лямбда-функцию к нескольким массивам одинаковой длины и накапливает результат в аккумуляторе. [#49794](https://github.com/ClickHouse/ClickHouse/pull/49794) ([Lirikl](https://github.com/Lirikl)).
* Поддержка формата `Npy`. `SELECT * FROM file('example_array.npy', Npy)`. [#55982](https://github.com/ClickHouse/ClickHouse/pull/55982) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Если таблица имеет в своём ключе кривую, заполняющую пространство (space-filling curve), например `ORDER BY mortonEncode(x, y)`, то условия на её аргументах, например `x >= 10 AND x <= 20 AND y >= 20 AND y <= 30`, могут использоваться для индексации. Добавлена настройка `analyze_index_with_space_filling_curves` для включения или отключения этого анализа. Закрывает [#41195](https://github.com/ClickHouse/ClickHouse/issue/41195). Продолжение [#4538](https://github.com/ClickHouse/ClickHouse/pull/4538). Продолжение [#6286](https://github.com/ClickHouse/ClickHouse/pull/6286). Продолжение [#28130](https://github.com/ClickHouse/ClickHouse/pull/28130). Продолжение [#41753](https://github.com/ClickHouse/ClickHouse/pull/#41753). [#55642](https://github.com/ClickHouse/ClickHouse/pull/55642) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена новая настройка `force_optimize_projection_name`, которая принимает в качестве аргумента имя проекции. Если ей присвоено непустое строковое значение, ClickHouse проверяет, что эта проекция используется в запросе хотя бы один раз. Закрывает [#55331](https://github.com/ClickHouse/ClickHouse/issues/55331). [#56134](https://github.com/ClickHouse/ClickHouse/pull/56134) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Поддержка асинхронных вставок с внешними данными через нативный протокол. Ранее асинхронные вставки работали только, если данные были встроены в запрос. [#54730](https://github.com/ClickHouse/ClickHouse/pull/54730) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена агрегатная функция `lttb`, которая использует алгоритм [Largest-Triangle-Three-Buckets](https://skemman.is/bitstream/1946/15343/3/SS_MSthesis.pdf) для уменьшения объёма данных при визуализации. [#53145](https://github.com/ClickHouse/ClickHouse/pull/53145) ([Sinan](https://github.com/sinsinan)).
* Запрос `CHECK TABLE` теперь работает быстрее и удобнее (показывает прогресс выполнения, его можно отменить). Добавлена поддержка проверки отдельной части с помощью `CHECK TABLE ... PART 'part_name'`. [#53404](https://github.com/ClickHouse/ClickHouse/pull/53404) ([vdimir](https://github.com/vdimir)).
* Добавлена функция `jsonMergePatch`. При работе с JSON-данными в виде строк она позволяет объединять такие строки (с JSON-объектами) в одну строку, содержащую единый JSON-объект. [#54364](https://github.com/ClickHouse/ClickHouse/pull/54364) ([Memo](https://github.com/Joeywzr)).
* Вторая часть поддержки диалекта Kusto Query Language. [Реализация первой фазы](https://github.com/ClickHouse/ClickHouse/pull/37961) уже объединена. [#42510](https://github.com/ClickHouse/ClickHouse/pull/42510) ([larryluogit](https://github.com/larryluogit)).
* Добавлена новая функция SQL `arrayRandomSample(arr, k)`, которая возвращает выборку k элементов из входного массива. Ранее аналогичного результата можно было добиться только с менее удобным синтаксисом, например: &quot;SELECT arrayReduce(&#39;groupArraySample(3)&#39;, range(10))&quot;. [#54391](https://github.com/ClickHouse/ClickHouse/pull/54391) ([itayisraelov](https://github.com/itayisraelov)).
* Введены агрегатные комбинаторы `-ArgMin`/`-ArgMax`, которые позволяют агрегировать по минимальным/максимальным значениям. Один из вариантов применения описан в [#54818](https://github.com/ClickHouse/ClickHouse/issues/54818). Этот PR также реорганизует комбинаторы в отдельную папку. [#54947](https://github.com/ClickHouse/ClickHouse/pull/54947) ([Amos Bird](https://github.com/amosbird)).
* Теперь можно сбрасывать кэш для формата Protobuf с помощью команды `SYSTEM DROP SCHEMA FORMAT CACHE [FOR Protobuf]`. [#55064](https://github.com/ClickHouse/ClickHouse/pull/55064) ([Aleksandr Musorin](https://github.com/AVMusorin)).
* Добавлен внешний аутентификатор HTTP Basic. [#55199](https://github.com/ClickHouse/ClickHouse/pull/55199) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Добавлена функция `byteSwap`, которая переставляет байты беззнаковых целых чисел в обратном порядке. Это особенно полезно для обращения значений типов, которые внутренне хранятся как беззнаковые целые числа, например IPv4. [#55211](https://github.com/ClickHouse/ClickHouse/pull/55211) ([Priyansh Agrawal](https://github.com/Priyansh121096)).
* Добавлена функция `formatQuery`, которая возвращает отформатированный вариант строки SQL-запроса (возможно, с переводами строк). Также добавлена функция `formatQuerySingleLine`, которая делает то же самое, но возвращаемая строка не будет содержать символов перевода строки. [#55239](https://github.com/ClickHouse/ClickHouse/pull/55239) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Добавлен формат входных данных `DWARF`, который считывает отладочные символы из ELF-исполняемого файла, библиотеки или объектного файла. [#55450](https://github.com/ClickHouse/ClickHouse/pull/55450) ([Michael Kolupaev](https://github.com/al13n321)).
* Позволяет сохранять неразобранные записи и ошибки в движках RabbitMQ, NATS и FileLog. Добавляет виртуальные столбцы `_error` и `_raw_message` (для NATS и RabbitMQ), `_raw_record` (для FileLog), которые заполняются, когда ClickHouse не может разобрать новую запись. Поведение контролируется настройками хранилища `nats_handle_error_mode` для NATS, `rabbitmq_handle_error_mode` для RabbitMQ, `handle_error_mode` для FileLog по аналогии с `kafka_handle_error_mode`. Если параметр имеет значение `default`, при невозможности разбора записи в ClickHouse будет сгенерировано исключение; если установлено значение `stream`, ошибка и исходная запись будут сохранены в виртуальные столбцы. Закрывает [#36035](https://github.com/ClickHouse/ClickHouse/issues/36035). [#55477](https://github.com/ClickHouse/ClickHouse/pull/55477) ([Kruglov Pavel](https://github.com/Avogar)).
* Улучшение клиента Keeper: добавлена команда `get_all_children_number`, которая возвращает общее количество дочерних узлов по указанному пути. [#55485](https://github.com/ClickHouse/ClickHouse/pull/55485) ([guoxiaolong](https://github.com/guoxiaolongzte)).
* Улучшение клиента Keeper: добавлена команда `get_direct_children_number`, возвращающая число непосредственных дочерних узлов по указанному пути. [#55898](https://github.com/ClickHouse/ClickHouse/pull/55898) ([xuzifu666](https://github.com/xuzifu666)).
* Добавлен оператор `SHOW SETTING setting_name`, который является упрощённой версией существующего оператора `SHOW SETTINGS`. [#55979](https://github.com/ClickHouse/ClickHouse/pull/55979) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлены столбцы `substreams` и `filenames` в таблицу `system.parts_columns`. [#55108](https://github.com/ClickHouse/ClickHouse/pull/55108) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена поддержка запроса `SHOW MERGES`. [#55815](https://github.com/ClickHouse/ClickHouse/pull/55815) ([megao](https://github.com/jetgm)).
* Добавлена настройка `create_table_empty_primary_key_by_default` для использования `ORDER BY ()` по умолчанию. [#55899](https://github.com/ClickHouse/ClickHouse/pull/55899) ([Srikanth Chekuri](https://github.com/srikanthccv)).



#### Повышение производительности {#performance-improvement-2}

* Добавлена опция `query_plan_preserve_num_streams_after_window_functions` для сохранения числа потоков после вычисления оконных функций, чтобы обеспечить параллельную обработку потоков. [#50771](https://github.com/ClickHouse/ClickHouse/pull/50771) ([frinkr](https://github.com/frinkr)).
* Освобождать больше потоков при небольшом объёме данных. [#53867](https://github.com/ClickHouse/ClickHouse/pull/53867) ([Jiebin Sun](https://github.com/jiebinn)).
* Теперь RoaringBitmaps оптимизируются перед сериализацией. [#55044](https://github.com/ClickHouse/ClickHouse/pull/55044) ([UnamedRus](https://github.com/UnamedRus)).
* Списки вхождений в инвертированных индексах теперь оптимизированы таким образом, чтобы для внутренних битовых карт использовать максимально компактное представление. В зависимости от степени повторяемости данных это может существенно сократить объем, занимаемый инвертированными индексами. [#55069](https://github.com/ClickHouse/ClickHouse/pull/55069) ([Harry Lee](https://github.com/HarryLeeIBM)).
* Устранена конкуренция за блокировку Context, что значительно улучшило производительность большого числа коротких параллельных запросов. [#55121](https://github.com/ClickHouse/ClickHouse/pull/55121) ([Maksim Kita](https://github.com/kitaisreal)).
* Производительность создания инвертированного индекса увеличена на 30 % благодаря замене `std::unordered_map` на `absl::flat_hash_map`. [#55210](https://github.com/ClickHouse/ClickHouse/pull/55210) ([Harry Lee](https://github.com/HarryLeeIBM)).
* Поддержка проталкивания фильтров ORC (на уровне групп строк). [#55330](https://github.com/ClickHouse/ClickHouse/pull/55330) ([李扬](https://github.com/taiyang-li)).
* Улучшена производительность внешней агрегации при большом числе временных файлов. [#55489](https://github.com/ClickHouse/ClickHouse/pull/55489) ([Maksim Kita](https://github.com/kitaisreal)).
* По умолчанию задан разумный размер кэша меток для вторичных индексов, чтобы избежать повторной загрузки меток. [#55654](https://github.com/ClickHouse/ClickHouse/pull/55654) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Избегать ненужной реконструкции гранул индекса при чтении пропускающих индексов. Это устраняет [#55653](https://github.com/ClickHouse/ClickHouse/issues/55653#issuecomment-1763766009). [#55683](https://github.com/ClickHouse/ClickHouse/pull/55683) ([Amos Bird](https://github.com/amosbird)).
* Кэшировать функцию CAST в наборе во время выполнения для повышения производительности функции `IN`, когда тип элементов набора не совпадает с типом столбца. [#55712](https://github.com/ClickHouse/ClickHouse/pull/55712) ([Duc Canh Le](https://github.com/canhld94)).
* Повышена производительность `ColumnVector::insertMany` и `ColumnVector::insertManyFrom`. [#55714](https://github.com/ClickHouse/ClickHouse/pull/55714) ([frinkr](https://github.com/frinkr)).
* Оптимизированы операции обращения по индексу в `Map` за счёт предсказания позиции ключа в следующей строке и сокращения числа сравнений. [#55929](https://github.com/ClickHouse/ClickHouse/pull/55929) ([lgbo](https://github.com/lgbo-ustc)).
* Добавлена поддержка отсечения полей структур в Parquet (в предыдущих версиях в некоторых случаях это не работало). [#56117](https://github.com/ClickHouse/ClickHouse/pull/56117) ([lgbo](https://github.com/lgbo-ustc)).
* Добавлена возможность настраивать число параллельных реплик, используемых при выполнении запроса, в зависимости от оценки числа строк для чтения. [#51692](https://github.com/ClickHouse/ClickHouse/pull/51692) ([Raúl Marín](https://github.com/Algunenano)).
* Оптимизировано потребление памяти при внешней агрегации при большом количестве временных файлов. [#54798](https://github.com/ClickHouse/ClickHouse/pull/54798) ([Nikita Taranov](https://github.com/nickitat)).
* Распределённые запросы, выполняемые в режиме `async_socket_for_remote` (по умолчанию), теперь соблюдают ограничение `max_threads`. Ранее некоторые запросы могли создавать чрезмерное количество потоков (до `max_distributed_connections`), что вызывало проблемы с производительностью сервера. [#53504](https://github.com/ClickHouse/ClickHouse/pull/53504) ([filimonov](https://github.com/filimonov)).
* Кэширование пропускаемых записей при выполнении DDL-операций из распределённой очереди DDL в ZooKeeper. [#54828](https://github.com/ClickHouse/ClickHouse/pull/54828) ([Duc Canh Le](https://github.com/canhld94)).
* Экспериментальные инвертированные индексы не хранят токены со слишком большим числом совпадений (т.е. идентификаторов строк в списке вхождений). Это экономит место и предотвращает неэффективные обращения к индексу в случаях, когда последовательное сканирование будет столь же быстрым или даже быстрее. Предыдущая эвристика (параметр `density`, передаваемый в определение индекса), определяющая, когда токены не должны сохраняться, была слишком запутанной для пользователей. Введена гораздо более простая эвристика на основе параметра `max_rows_per_postings_list` (значение по умолчанию: 64k), который напрямую ограничивает максимально допустимое количество идентификаторов строк в списке вхождений. [#55616](https://github.com/ClickHouse/ClickHouse/pull/55616) ([Harry Lee](https://github.com/HarryLeeIBM)).
* Улучшена производительность операций записи в таблицы `EmbeddedRocksDB`. [#55732](https://github.com/ClickHouse/ClickHouse/pull/55732) ([Duc Canh Le](https://github.com/canhld94)).
* Улучшена общая отказоустойчивость ClickHouse в случае большого количества частей внутри партиции (более 1000). Это может уменьшить число ошибок `TOO_MANY_PARTS`. [#55526](https://github.com/ClickHouse/ClickHouse/pull/55526) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Снижено потребление памяти при загрузке иерархических словарей. [#55838](https://github.com/ClickHouse/ClickHouse/pull/55838) ([Nikita Taranov](https://github.com/nickitat)).
* Все словари поддерживают настройку параметра `dictionary_use_async_executor`. [#55839](https://github.com/ClickHouse/ClickHouse/pull/55839) ([vdimir](https://github.com/vdimir)).
* Предотвращено чрезмерное потребление памяти при десериализации AggregateFunctionTopKGenericData. [#55947](https://github.com/ClickHouse/ClickHouse/pull/55947) ([Raúl Marín](https://github.com/Algunenano)).
* На узле Keeper с большим количеством watches потоки AsyncMetrics могут на заметное время загружать ЦП на 100% в `DB::KeeperStorage::getSessionsWithWatchesCount`. Исправление состоит в том, чтобы избежать обхода тяжёлых множеств `watches` и `list_watches`. [#56054](https://github.com/ClickHouse/ClickHouse/pull/56054) ([Alexander Gololobov](https://github.com/davenger)).
* Добавлена настройка `optimize_trivial_approximate_count_query` для использования приближённого варианта `count` для хранилища EmbeddedRocksDB. Включён тривиальный подсчёт для StorageJoin. [#55806](https://github.com/ClickHouse/ClickHouse/pull/55806) ([Duc Canh Le](https://github.com/canhld94)).



#### Улучшение {#improvement-2}

* Функции `toDayOfWeek` (MySQL-алиас: `DAYOFWEEK`), `toYearWeek` (`YEARWEEK`) и `toWeek` (`WEEK`) теперь поддерживают аргументы типа `String`. Это делает их поведение соответствующим поведению MySQL. [#55589](https://github.com/ClickHouse/ClickHouse/pull/55589) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена настройка `date_time_overflow_behavior` с возможными значениями `ignore`, `throw`, `saturate`, которая определяет поведение при переполнении при преобразовании из типов Date, Date32, DateTime64, Integer или Float в Date, Date32, DateTime или DateTime64. [#55696](https://github.com/ClickHouse/ClickHouse/pull/55696) ([Andrey Zvonov](https://github.com/zvonand)).
* Реализована поддержка параметров запроса в `ALTER TABLE ... ACTION PARTITION [ID] {parameter_name:ParameterType}`. Объединяет изменения из [#49516](https://github.com/ClickHouse/ClickHouse/issues/49516). Закрывает [#49449](https://github.com/ClickHouse/ClickHouse/issues/49449). [#55604](https://github.com/ClickHouse/ClickHouse/pull/55604) ([alesapin](https://github.com/alesapin)).
* Выводить идентификаторы процессоров в EXPLAIN в более удобочитаемом виде. [#48852](https://github.com/ClickHouse/ClickHouse/pull/48852) ([Vlad Seliverstov](https://github.com/behebot)).
* Попытка создать прямой словарь с параметром lifetime будет отклонена на этапе создания (так как срок жизни не имеет смысла для прямых словарей). Исправления: [#27861](https://github.com/ClickHouse/ClickHouse/issues/27861). [#49043](https://github.com/ClickHouse/ClickHouse/pull/49043) ([Rory Crispin](https://github.com/RoryCrispin)).
* Разрешить использование параметров в запросах с партициями, например `ALTER TABLE t DROP PARTITION`. Закрывает [#49449](https://github.com/ClickHouse/ClickHouse/issues/49449). [#49516](https://github.com/ClickHouse/ClickHouse/pull/49516) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлен новый столбец `xid` в таблицу `system.zookeeper_connection`. [#50702](https://github.com/ClickHouse/ClickHouse/pull/50702) ([helifu](https://github.com/helifu)).
* Теперь в `system.server_settings` отображаются корректные настройки сервера после перезагрузки конфигурации. [#53774](https://github.com/ClickHouse/ClickHouse/pull/53774) ([helifu](https://github.com/helifu)).
* Добавлена поддержка математического символа минуса `−` в запросах, так же как для `-`. [#54100](https://github.com/ClickHouse/ClickHouse/pull/54100) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка групп реплик в экспериментальном движке базы данных `Replicated`. Закрывает [#53620](https://github.com/ClickHouse/ClickHouse/issues/53620). [#54421](https://github.com/ClickHouse/ClickHouse/pull/54421) ([Nikolay Degterinsky](https://github.com/evillique)).
* Лучше повторять запрос при повторяемых ошибках S3, чем полностью завершать его с ошибкой. По умолчанию увеличено значение параметра s3&#95;retry&#95;attempts. [#54770](https://github.com/ClickHouse/ClickHouse/pull/54770) ([Sema Checherinda](https://github.com/CheSema)).
* Добавлен режим балансировки нагрузки `hostname_levenshtein_distance`. [#54826](https://github.com/ClickHouse/ClickHouse/pull/54826) ([JackyWoo](https://github.com/JackyWoo)).
* Улучшена маскировка секретов в логах. [#55089](https://github.com/ClickHouse/ClickHouse/pull/55089) ([Vitaly Baranov](https://github.com/vitlibar)).
* На данный момент анализ проекций будет выполняться только на основе плана запроса. Настройка `query_plan_optimize_projection` признана устаревшей (она уже давно включена по умолчанию). [#55112](https://github.com/ClickHouse/ClickHouse/pull/55112) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Если функция `untuple` вызывается для кортежа с именованными элементами и при этом сама имеет псевдоним (например, `select untuple(tuple(1)::Tuple(element_alias Int)) AS untuple_alias`), имя результирующего столбца формируется из псевдонима функции `untuple` и псевдонима элемента кортежа (в примере: `untuple_alias.element_alias`). [#55123](https://github.com/ClickHouse/ClickHouse/pull/55123) ([garcher22](https://github.com/garcher22)).
* Добавлена настройка `describe_include_virtual_columns`, которая позволяет включать в результат запроса `DESCRIBE` виртуальные столбцы таблицы. Добавлена настройка `describe_compact_output`. Если она имеет значение `true`, запрос `DESCRIBE` возвращает только имена и типы столбцов без дополнительной информации. [#55129](https://github.com/ClickHouse/ClickHouse/pull/55129) ([Anton Popov](https://github.com/CurtizJ)).
* Иногда `OPTIMIZE` с `optimize_throw_if_noop=1` может завершаться с ошибкой `unknown reason`, в то время как реальная причина — различные проекции в разных частях данных. Это поведение исправлено. [#55130](https://github.com/ClickHouse/ClickHouse/pull/55130) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Позволяет иметь несколько таблиц `MaterializedPostgreSQL`, реплицирующих одну и ту же таблицу Postgres. По умолчанию это поведение отключено (по соображениям совместимости, так как это обратно несовместимое изменение), но может быть включено с помощью настройки `materialized_postgresql_use_unique_replication_consumer_identifier`. Закрывает [#54918](https://github.com/ClickHouse/ClickHouse/issues/54918). [#55145](https://github.com/ClickHouse/ClickHouse/pull/55145) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена возможность парсить отрицательные значения типов `DateTime64` и `DateTime` с дробной частью из коротких строк. [#55146](https://github.com/ClickHouse/ClickHouse/pull/55146) ([Andrey Zvonov](https://github.com/zvonand)).
* Для улучшения совместимости с MySQL 1. `information_schema.tables` теперь содержит новое поле `table_rows`, а 2. `information_schema.columns` теперь содержит новое поле `extra`. [#55215](https://github.com/ClickHouse/ClickHouse/pull/55215) ([Robert Schulze](https://github.com/rschu1ze)).
* Clickhouse-client больше не будет показывать сообщение &quot;0 rows in set&quot;, если количество строк равно нулю и при этом было выброшено исключение. [#55240](https://github.com/ClickHouse/ClickHouse/pull/55240) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Добавлена поддержка переименования таблицы без ключевого слова `TABLE`, например `RENAME db.t1 to db.t2`. [#55373](https://github.com/ClickHouse/ClickHouse/pull/55373) ([凌涛](https://github.com/lingtaolf)).
* Добавлен `internal_replication` в таблицу `system.clusters`. [#55377](https://github.com/ClickHouse/ClickHouse/pull/55377) ([Konstantin Morozov](https://github.com/k-morozov)).
* Выбор удалённого прокси-резолвера на основе протокола запроса, добавление документации по функциональности прокси и удаление `DB::ProxyConfiguration::Protocol::ANY`. [#55430](https://github.com/ClickHouse/ClickHouse/pull/55430) ([Arthur Passos](https://github.com/arthurpassos)).
* Не повторять операции Keeper при INSERT после остановки таблицы. [#55519](https://github.com/ClickHouse/ClickHouse/pull/55519) ([Azat Khuzhin](https://github.com/azat)).
* `SHOW COLUMNS` теперь корректно отображает тип `FixedString` как `BLOB`, если включена настройка `use_mysql_types_in_show_columns`. Также добавлены две новые настройки — `mysql_map_string_to_text_in_show_columns` и `mysql_map_fixed_string_to_text_in_show_columns` — для переключения вывода типов `String` и `FixedString` как `TEXT` или `BLOB`. [#55617](https://github.com/ClickHouse/ClickHouse/pull/55617) ([Serge Klochkov](https://github.com/slvrtrn)).
* Во время запуска таблиц ReplicatedMergeTree сервер ClickHouse проверяет набор частей (parts) на наличие неожиданных частей (существуют локально, но отсутствуют в ZooKeeper). Все неожиданные части перемещаются в каталог `detached`, и вместо них сервер пытается восстановить некоторые родительские (покрывающие) части. Теперь сервер пытается восстановить ближайшие родительские части вместо случайных покрывающих частей. [#55645](https://github.com/ClickHouse/ClickHouse/pull/55645) ([alesapin](https://github.com/alesapin)).
* Теперь на расширенном дашборде поддерживается перетаскивание графиков на сенсорных устройствах. Это закрывает [#54206](https://github.com/ClickHouse/ClickHouse/issues/54206). [#55649](https://github.com/ClickHouse/ClickHouse/pull/55649) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Используйте формат запроса по умолчанию (если он задан) при выводе исключения с помощью `http_write_exception_in_output_format`. [#55739](https://github.com/ClickHouse/ClickHouse/pull/55739) ([Raúl Marín](https://github.com/Algunenano)).
* Улучшено сообщение об ошибке для распространённых проблем с MATERIALIZED VIEW. [#55826](https://github.com/ClickHouse/ClickHouse/pull/55826) ([Raúl Marín](https://github.com/Algunenano)).
* Если вы удалили текущую базу данных, вы все равно сможете выполнять некоторые запросы в `clickhouse-local` и переключаться на другую базу данных. Это делает поведение аналогичным `clickhouse-client`. Тем самым закрывается [#55834](https://github.com/ClickHouse/ClickHouse/issues/55834). [#55853](https://github.com/ClickHouse/ClickHouse/pull/55853) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Функции `(add|subtract)(Year|Quarter|Month|Week|Day|Hour|Minute|Second|Millisecond|Microsecond|Nanosecond)` теперь поддерживают аргументы с датами в строковом формате, например `SELECT addDays('2023-10-22', 1)`. Это повышает совместимость с MySQL и необходимо для Tableau Online. [#55869](https://github.com/ClickHouse/ClickHouse/pull/55869) ([Robert Schulze](https://github.com/rschu1ze)).
* Настройка `apply_deleted_mask`, будучи отключённой, позволяет читать строки, которые были помечены как удалённые легковесными запросами DELETE. Это полезно для отладки. [#55952](https://github.com/ClickHouse/ClickHouse/pull/55952) ([Alexander Gololobov](https://github.com/davenger)).
* Добавлена возможность пропускать значения `null` при сериализации Tuple в JSON-объекты, что позволяет сохранить совместимость с функцией Spark `to_json` и также полезно для gluten. [#55956](https://github.com/ClickHouse/ClickHouse/pull/55956) ([李扬](https://github.com/taiyang-li)).
* Функции `(add|sub)Date` теперь поддерживают аргументы с датой в строковом формате, например `SELECT addDate('2023-10-22 11:12:13', INTERVAL 5 MINUTE)`. Та же поддержка аргументов с датой в строковом формате добавлена к операторам сложения и вычитания, например `SELECT '2023-10-23' + INTERVAL 1 DAY`. Это повышает совместимость с MySQL и необходимо для Tableau Online. [#55960](https://github.com/ClickHouse/ClickHouse/pull/55960) ([Robert Schulze](https://github.com/rschu1ze)).
* Разрешить строки без кавычек, содержащие CR (`\r`), в формате CSV. Закрывает [#39930](https://github.com/ClickHouse/ClickHouse/issues/39930). [#56046](https://github.com/ClickHouse/ClickHouse/pull/56046) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена возможность запускать `clickhouse-keeper` с использованием встроенной конфигурации. [#56086](https://github.com/ClickHouse/ClickHouse/pull/56086) ([Maksim Kita](https://github.com/kitaisreal)).
* Установлено ограничение максимального значения настройки `queued.min.messages`, чтобы избежать проблем при запуске выборки данных из Kafka. [#56121](https://github.com/ClickHouse/ClickHouse/pull/56121) ([Stas Morozov](https://github.com/r3b-fish)).
* Исправлена опечатка в SQL-функции `minSampleSizeContinous` (переименована в `minSampleSizeContinuous`). Старое имя сохранено для обратной совместимости. Это закрывает: [#56139](https://github.com/ClickHouse/ClickHouse/issues/56139). [#56143](https://github.com/ClickHouse/ClickHouse/pull/56143) ([Dorota Szeremeta](https://github.com/orotaday)).
* Теперь перед завершением работы сервера выводится путь к повреждённым частям данных на диске. До этого изменения, если часть данных была повреждена на диске и сервер не мог запуститься, было почти невозможно понять, какая именно часть сломана. Теперь это исправлено. [#56181](https://github.com/ClickHouse/ClickHouse/pull/56181) ([Duc Canh Le](https://github.com/canhld94)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-2}
* Если база данных в Docker-контейнере уже инициализирована, ее не нужно инициализировать повторно при последующих запусках. Это потенциально может исправить проблему бесконечных перезапусков контейнера, когда базе данных не удается загрузиться в пределах 1000 попыток (актуально для очень больших баз данных и многосерверных конфигураций). [#50724](https://github.com/ClickHouse/ClickHouse/pull/50724) ([Alexander Nikolaev](https://github.com/AlexNik)).
* Ресурс с исходным кодом, включающим подмодули, собирается в специальной задаче сборки для Darwin. Его можно использовать для сборки ClickHouse без отдельной загрузки/клонирования подмодулей. [#51435](https://github.com/ClickHouse/ClickHouse/pull/51435) ([Ilya Yatsishin](https://github.com/qoega)).
* Возникала ошибка при сборке ClickHouse с глобально включенными инструкциями серии AVX (что не рекомендуется). Причина в том, что snappy не включает `SNAPPY_HAVE_X86_CRC32`. [#55049](https://github.com/ClickHouse/ClickHouse/pull/55049) ([monchickey](https://github.com/monchickey)).
* Решена проблема с запуском `clickhouse-keeper` как отдельного сервиса из пакета `clickhouse-server`. [#55226](https://github.com/ClickHouse/ClickHouse/pull/55226) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* В тестах версия RabbitMQ обновлена до 3.12.6. Улучшен сбор логов для тестов RabbitMQ. [#55424](https://github.com/ClickHouse/ClickHouse/pull/55424) ([Ilya Yatsishin](https://github.com/qoega)).
* Скорректированы различия в сообщениях об ошибках между OpenSSL и BoringSSL, чтобы исправить функциональный тест. [#55975](https://github.com/ClickHouse/ClickHouse/pull/55975) ([MeenaRenganathan22](https://github.com/MeenaRenganathan22)).
* Использован upstream‑репозиторий для apache datasketches. [#55787](https://github.com/ClickHouse/ClickHouse/pull/55787) ([Nikita Taranov](https://github.com/nickitat)).

#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-2}

* Пропускать создание жёстких ссылок на файлы инвертированного индекса при выполнении мутации [#47663](https://github.com/ClickHouse/ClickHouse/pull/47663) ([cangyin](https://github.com/cangyin)).
* Исправлена ошибка в функции `match` (regex), из‑за которой шаблон, содержащий альтернативу, приводил к некорректному ключевому условию. Закрывает #53222. [#54696](https://github.com/ClickHouse/ClickHouse/pull/54696) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена ошибка &#39;Cannot find column&#39; в оптимизации чтения по порядку (read-in-order) с ARRAY JOIN [#51746](https://github.com/ClickHouse/ClickHouse/pull/51746) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлена поддержка ранее пропущенных экспериментальных подстолбцов типа `Object(Nullable(json))` в запросах. [#54052](https://github.com/ClickHouse/ClickHouse/pull/54052) ([zps](https://github.com/VanDarkholme7)).
* Повторно применено исправление для `accurateCastOrNull` [#54629](https://github.com/ClickHouse/ClickHouse/pull/54629) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Исправлено определение значения `DEFAULT` для столбцов таблицы типа Distributed, созданной без AS [#55060](https://github.com/ClickHouse/ClickHouse/pull/55060) ([Vitaly Baranov](https://github.com/vitlibar)).
* Корректная очистка при возникновении исключения в конструкторе ShellCommandSource [#55103](https://github.com/ClickHouse/ClickHouse/pull/55103) ([Alexander Gololobov](https://github.com/davenger)).
* Устранена взаимоблокировка при обновлении ролей, назначаемых через LDAP [#55119](https://github.com/ClickHouse/ClickHouse/pull/55119) ([Julian Maicher](https://github.com/jmaicher)).
* Отключено обновление статистики ошибок для внутренних исключений [#55128](https://github.com/ClickHouse/ClickHouse/pull/55128) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена взаимоблокировка при работе с резервными копиями [#55132](https://github.com/ClickHouse/ClickHouse/pull/55132) ([alesapin](https://github.com/alesapin)).
* Исправлено получение файлов Iceberg из хранилища [#55144](https://github.com/ClickHouse/ClickHouse/pull/55144) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено отсечение партиций по дополнительным столбцам в наборе. [#55172](https://github.com/ClickHouse/ClickHouse/pull/55172) ([Amos Bird](https://github.com/amosbird)).
* Исправлен пересчёт пропускающих индексов в запросах ALTER UPDATE для таблиц с адаптивной гранулярностью [#55202](https://github.com/ClickHouse/ClickHouse/pull/55202) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлена фоновая загрузка в fs-кэше [#55252](https://github.com/ClickHouse/ClickHouse/pull/55252) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Предотвращены возможные утечки памяти в компрессорах при отсутствии финализации буфера [#55262](https://github.com/ClickHouse/ClickHouse/pull/55262) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено выполнение функций для разрежённых столбцов [#55275](https://github.com/ClickHouse/ClickHouse/pull/55275) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено некорректное слияние `Nested` для `SELECT FINAL FROM SummingMergeTree` [#55276](https://github.com/ClickHouse/ClickHouse/pull/55276) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, из-за которой было невозможно удалить отсоединённую партицию в `ReplicatedMergeTree` поверх S3 без zero copy [#55309](https://github.com/ClickHouse/ClickHouse/pull/55309) ([alesapin](https://github.com/alesapin)).
* Исправлен сбой в MergeSortingPartialResultTransform (из-за нулевых чанков после `remerge`) [#55335](https://github.com/ClickHouse/ClickHouse/pull/55335) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена гонка данных в CreatingSetsTransform (при ошибках) из-за выбрасывания разделяемого исключения [#55338](https://github.com/ClickHouse/ClickHouse/pull/55338) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена оптимизация очистки мусора (в определённой степени) [#55353](https://github.com/ClickHouse/ClickHouse/pull/55353) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена утечка в StorageHDFS [#55370](https://github.com/ClickHouse/ClickHouse/pull/55370) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен разбор массивов в операторе CAST [#55417](https://github.com/ClickHouse/ClickHouse/pull/55417) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена фильтрация по виртуальным столбцам с условием OR в запросе [#55418](https://github.com/ClickHouse/ClickHouse/pull/55418) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены ошибки подключения к MongoDB [#55419](https://github.com/ClickHouse/ClickHouse/pull/55419) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлено представление булевых значений в интерфейсе MySQL [#55427](https://github.com/ClickHouse/ClickHouse/pull/55427) ([Serge Klochkov](https://github.com/slvrtrn)).
* Исправлено форматирование значений DateTime в текстовом протоколе MySQL и вывод типов LowCardinality(Nullable(T)) [#55479](https://github.com/ClickHouse/ClickHouse/pull/55479) ([Serge Klochkov](https://github.com/slvrtrn)).
* Параметр `use_mysql_types_in_show_columns` теперь влияет только на `SHOW COLUMNS` [#55481](https://github.com/ClickHouse/ClickHouse/pull/55481) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена некорректная обработка `DW_FORM_ref_addr` в символизаторе стека, которая иногда приводила к его падению [#55483](https://github.com/ClickHouse/ClickHouse/pull/55483) ([Michael Kolupaev](https://github.com/al13n321)).
* Уничтожать fiber при возникновении исключения в cancelBefore в AsyncTaskExecutor [#55516](https://github.com/ClickHouse/ClickHouse/pull/55516) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена проблема, из-за которой параметры запросов не работали с пользовательскими HTTP-обработчиками [#55521](https://github.com/ClickHouse/ClickHouse/pull/55521) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлена проверка необрабатываемых данных для формата Values [#55527](https://github.com/ClickHouse/ClickHouse/pull/55527) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка «Invalid cursor state» в ODBC при взаимодействии с MS SQL Server [#55558](https://github.com/ClickHouse/ClickHouse/pull/55558) ([vdimir](https://github.com/vdimir)).
* Исправлены максимальное время выполнения и режим переполнения «break» [#55577](https://github.com/ClickHouse/ClickHouse/pull/55577) ([Alexander Gololobov](https://github.com/davenger)).
* Исправлен сбой QueryNormalizer при циклических алиасах [#55602](https://github.com/ClickHouse/ClickHouse/pull/55602) ([vdimir](https://github.com/vdimir)).
* Отключена некорректная оптимизация и добавлен тест [#55609](https://github.com/ClickHouse/ClickHouse/pull/55609) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Объединены [#52352](https://github.com/ClickHouse/ClickHouse/issues/52352) [#55621](https://github.com/ClickHouse/ClickHouse/pull/55621) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен тест для предотвращения некорректной сортировки десятичных чисел [#55662](https://github.com/ClickHouse/ClickHouse/pull/55662) ([Amos Bird](https://github.com/amosbird)).
* Исправлен индикатор прогресса для функций S3Cluster и AzureCluster при использовании URL-адресов без масок (globs) [#55666](https://github.com/ClickHouse/ClickHouse/pull/55666) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена фильтрация по виртуальным столбцам при использовании оператора OR в запросе (повторная отправка) [#55678](https://github.com/ClickHouse/ClickHouse/pull/55678) ([Azat Khuzhin](https://github.com/azat)).
* Исправления и улучшения в хранилище Iceberg [#55695](https://github.com/ClickHouse/ClickHouse/pull/55695) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена гонка данных в CreatingSetsTransform (v2) [#55786](https://github.com/ClickHouse/ClickHouse/pull/55786) ([Azat Khuzhin](https://github.com/azat)).
* Выбрасывать исключение при разборе некорректной строки как числа с плавающей запятой, если precise&#95;float&#95;parsing установлен в true [#55861](https://github.com/ClickHouse/ClickHouse/pull/55861) ([李扬](https://github.com/taiyang-li)).
* Отключить проталкивание предикатов, если CTE содержит состояния́зависимые функции [#55871](https://github.com/ClickHouse/ClickHouse/pull/55871) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена нормализация ASTSelectWithUnionQuery, которая удаляла `FORMAT` из запроса [#55887](https://github.com/ClickHouse/ClickHouse/pull/55887) ([flynn](https://github.com/ucasfl)).
* Попытка исправить возможную ошибку сегментации в формате ввода Native ORC [#55891](https://github.com/ClickHouse/ClickHouse/pull/55891) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлены оконные функции для разрежённых столбцов. [#55895](https://github.com/ClickHouse/ClickHouse/pull/55895) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* исправлено: StorageNull теперь поддерживает подстолбцы [#55912](https://github.com/ClickHouse/ClickHouse/pull/55912) ([FFish](https://github.com/wxybear)).
* Не записывать повторимые ошибки для операций Replicated mutate/merge в журнал ошибок [#55944](https://github.com/ClickHouse/ClickHouse/pull/55944) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка в `SHOW DATABASES LIMIT &lt;N&gt;` [#55962](https://github.com/ClickHouse/ClickHouse/pull/55962) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена автоматически сгенерированная схема Protobuf с полями, содержащими символ подчеркивания [#55974](https://github.com/ClickHouse/ClickHouse/pull/55974) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена функция `dateTime64ToSnowflake64()` при нестандартном масштабе [#55983](https://github.com/ClickHouse/ClickHouse/pull/55983) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена обработка ввода/вывода словарного столбца Arrow [#55989](https://github.com/ClickHouse/ClickHouse/pull/55989) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено получение схемы из реестра схем в AvroConfluent [#55991](https://github.com/ClickHouse/ClickHouse/pull/55991) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка «Block structure mismatch» при одновременных операциях ALTER и INSERT в таблице Buffer [#55995](https://github.com/ClickHouse/ClickHouse/pull/55995) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлен некорректный учёт свободного места для политики JBOD `least_used` [#56030](https://github.com/ClickHouse/ClickHouse/pull/56030) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема с отсутствующим скалярным значением при вычислении подзапросов внутри табличных функций [#56057](https://github.com/ClickHouse/ClickHouse/pull/56057) ([Amos Bird](https://github.com/amosbird)).
* Исправлен некорректный результат запроса при http&#95;write&#95;exception&#95;in&#95;output&#95;format=1 [#56135](https://github.com/ClickHouse/ClickHouse/pull/56135) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен кэш схемы для резервного варианта JSON-&gt;JSONEachRow при изменении настроек [#56172](https://github.com/ClickHouse/ClickHouse/pull/56172) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен обработчик ошибок в odbc-bridge [#56185](https://github.com/ClickHouse/ClickHouse/pull/56185) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).

### <a id="239"></a> Релиз ClickHouse 23.9, 2023-09-28 {#239}

#### Обратно несовместимые изменения {#backward-incompatible-change-3}
* Удалена опция конфигурации `status_info` и статус словарей из обработчика Prometheus по умолчанию. [#54090](https://github.com/ClickHouse/ClickHouse/pull/54090) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Экспериментальный кэш метаданных частей удалён из кодовой базы. [#54215](https://github.com/ClickHouse/ClickHouse/pull/54215) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* По умолчанию отключена настройка `input_format_json_try_infer_numbers_from_strings`, чтобы по умолчанию не пытаться распознавать числа в строках в форматах JSON и таким образом избежать возможных ошибок парсинга, когда примеры данных содержат строки, похожие на числа. [#55099](https://github.com/ClickHouse/ClickHouse/pull/55099) ([Kruglov Pavel](https://github.com/Avogar)).

#### Новая возможность {#new-feature-3}

* Улучшено определение схемы из JSON-форматов: 1) Теперь можно выводить именованные `Tuple` из JSON-объектов без использования экспериментального типа JSON с помощью настройки `input_format_json_try_infer_named_tuples_from_objects` в JSON-форматах. Ранее без экспериментального типа JSON мы могли выводить JSON-объекты только как `String` или `Map`, теперь мы можем выводить именованный `Tuple`. Итоговый тип `Tuple` будет содержать все ключи объектов, которые были прочитаны в выборке данных во время определения схемы. Это может быть полезно для чтения структурированных JSON-данных без разреженных объектов. Настройка включена по умолчанию. 2) Разрешён разбор JSON-массива в столбец типа `String` с помощью настройки `input_format_json_read_arrays_as_strings`. Это может помочь при чтении массивов с элементами разных типов. 3) Разрешено использовать тип `String` для JSON-ключей с неизвестными типами (`null`/`[]`/`{}`) в выборке данных с помощью настройки `input_format_json_infer_incomplete_types_as_strings`. Теперь в JSON-форматах мы можем читать любое значение в столбец типа `String` и можем избежать ошибки `Cannot determine type for column 'column_name' by first 25000 rows of data, most likely this column contains only Nulls or empty Arrays/Maps` при определении схемы, используя тип `String` для неизвестных типов, так что данные будут успешно прочитаны. [#54427](https://github.com/ClickHouse/ClickHouse/pull/54427) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка планирования операций ввода-вывода (IO scheduling) для удаленных дисков. Конфигурация хранилища для типов дисков `s3`, `s3_plain`, `hdfs` и `azure_blob_storage` теперь может содержать элементы `read_resource` и `write_resource`, в которых задаются имена ресурсов. Политики планирования для этих ресурсов могут быть настроены в отдельной секции конфигурации сервера `resources`. Запросы можно помечать с помощью настройки `workload` и классифицировать с помощью секции конфигурации сервера `workload_classifiers` для достижения различных целей планирования ресурсов. Более подробная информация приведена в [документации](/operations/workload-scheduling). [#47009](https://github.com/ClickHouse/ClickHouse/pull/47009) ([Sergei Trifonov](https://github.com/serxa)). Добавлен тип узла планирования ввода-вывода &quot;bandwidth&#95;limit&quot;. Он позволяет задать ограничения `max_speed` и `max_burst` на трафик, проходящий через этот узел. [#54618](https://github.com/ClickHouse/ClickHouse/pull/54618) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлен новый тип аутентификации с использованием SSH-ключей. Он поддерживается только в нативном протоколе TCP. [#41109](https://github.com/ClickHouse/ClickHouse/pull/41109) ([George Gamezardashvili](https://github.com/InfJoker)).
* В таблицы MergeTree добавлен новый столбец `_block_number`. [#44532](https://github.com/ClickHouse/ClickHouse/issues/44532). [#47532](https://github.com/ClickHouse/ClickHouse/pull/47532) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Добавлена поддержка предложения `IF EMPTY` в запросах `DROP TABLE`. [#48915](https://github.com/ClickHouse/ClickHouse/pull/48915) ([Pavel Novitskiy](https://github.com/pnovitskiy)).
* SQL-функции `toString(datetime, timezone)` и `formatDateTime(datetime, format, timezone)` теперь поддерживают неконстантные значения аргументов часового пояса. [#53680](https://github.com/ClickHouse/ClickHouse/pull/53680) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена поддержка `ALTER TABLE MODIFY COMMENT`. Примечание: что-то подобное было добавлено внешним участником давно, но эта функция совсем не работала и только вводила пользователей в заблуждение. Это закрывает [#36377](https://github.com/ClickHouse/ClickHouse/issues/36377). [#51304](https://github.com/ClickHouse/ClickHouse/pull/51304) ([Alexey Milovidov](https://github.com/alexey-milovidov)). Примечание: эта команда не распространяется на реплики, поэтому реплики одной и той же таблицы могут иметь разные комментарии.
* Добавлен `GCD`, он же &quot;greatest common denominator&quot;, как новый кодек сжатия данных. Кодек вычисляет НОД всех значений столбца, а затем делит каждое значение на НОД. Кодек GCD является кодеком подготовки данных (аналогично Delta и DoubleDelta) и не может использоваться самостоятельно. Он работает с целочисленными, десятичными и типами данных дата/время. Характерный вариант использования кодека GCD — столбцы, значения которых изменяются (увеличиваются/уменьшаются) кратно НОД, например: 24 - 28 - 16 - 24 - 8 - 24 (предполагая, что НОД = 4). [#53149](https://github.com/ClickHouse/ClickHouse/pull/53149) ([Alexander Nam](https://github.com/seshWCS)).
* Были добавлены два новых псевдонима типа: `DECIMAL(P)` (как сокращённая запись для `DECIMAL(P, 0)`) и `DECIMAL` (как сокращённая запись для `DECIMAL(10, 0)`). Это делает ClickHouse более совместимым с SQL-диалектом MySQL. [#53328](https://github.com/ClickHouse/ClickHouse/pull/53328) ([Val Doroshchuk](https://github.com/valbok)).
* Добавлена новая системная таблица журнала `backup_log` для регистрации всех операций `BACKUP` и `RESTORE`. [#53638](https://github.com/ClickHouse/ClickHouse/pull/53638) ([Victor Krasnov](https://github.com/sirvickr)).
* Добавлена настройка формата `output_format_markdown_escape_special_characters` (по умолчанию: false). Настройка управляет тем, экранируются ли специальные символы, такие как `!`, `#`, `$` и т. д. (то есть предваряются обратной косой чертой) в формате вывода `Markdown`. [#53860](https://github.com/ClickHouse/ClickHouse/pull/53860) ([irenjj](https://github.com/irenjj)).
* Добавлена функция `decodeHTMLComponent`. [#54097](https://github.com/ClickHouse/ClickHouse/pull/54097) ([Bharat Nallan](https://github.com/bharatnc)).
* В таблицу query&#95;log добавлен `peak_threads_usage`. [#54335](https://github.com/ClickHouse/ClickHouse/pull/54335) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
* Добавлена поддержка команды `SHOW FUNCTIONS` в clickhouse-client. [#54337](https://github.com/ClickHouse/ClickHouse/pull/54337) ([Julia Kartseva](https://github.com/wat-ze-hex)).
* Добавлена функция `toDaysSinceYearZero` с псевдонимом `TO_DAYS` (для совместимости с MySQL), которая возвращает количество дней, прошедших с `0001-01-01` (в пролептическом григорианском календаре). [#54479](https://github.com/ClickHouse/ClickHouse/pull/54479) ([Robert Schulze](https://github.com/rschu1ze)). Функция `toDaysSinceYearZero` теперь поддерживает аргументы типов `DateTime` и `DateTime64`. [#54856](https://github.com/ClickHouse/ClickHouse/pull/54856) ([Serge Klochkov](https://github.com/slvrtrn)).
* Добавлены функции `YYYYMMDDtoDate`, `YYYYMMDDtoDate32`, `YYYYMMDDhhmmssToDateTime` и `YYYYMMDDhhmmssToDateTime64`. Они преобразуют дату или дату со временем, представленную в виде целого числа (например, 20230911), в нативный тип даты или даты со временем. Тем самым они предоставляют функциональность, противоположную существующим функциям `YYYYMMDDToDate`, `YYYYMMDDToDateTime`, `YYYYMMDDhhmmddToDateTime`, `YYYYMMDDhhmmddToDateTime64`. [#54509](https://github.com/ClickHouse/ClickHouse/pull/54509) ([Quanfa Fu](https://github.com/dentiscalprum)) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлены несколько функций расстояния между строками, включая `byteHammingDistance`, `editDistance`. [#54935](https://github.com/ClickHouse/ClickHouse/pull/54935) ([flynn](https://github.com/ucasfl)).
* Добавлена возможность указывать дату истечения срока действия, а при необходимости — и время для учетных данных пользователя с помощью предложения `VALID UNTIL datetime`. [#51261](https://github.com/ClickHouse/ClickHouse/pull/51261) ([Nikolay Degterinsky](https://github.com/evillique)).
* Разрешено использование URL-адресов формата S3 для табличных функций `s3`, `gcs`, `oss`. URL-адрес автоматически преобразуется в HTTP. Пример: `'s3://clickhouse-public-datasets/hits.csv'` преобразуется в `'https://clickhouse-public-datasets.s3.amazonaws.com/hits.csv'`. [#54931](https://github.com/ClickHouse/ClickHouse/pull/54931) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена новая настройка `print_pretty_type_names` для красивого вывода глубоко вложенных типов данных, например Tuple/Maps/Arrays. [#55095](https://github.com/ClickHouse/ClickHouse/pull/55095) ([Kruglov Pavel](https://github.com/Avogar)).



#### Повышение производительности {#performance-improvement-3}

* Ускорено чтение из S3 за счет включения опережающей выборки (prefetch) по умолчанию. [#53709](https://github.com/ClickHouse/ClickHouse/pull/53709) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Не считывать неявно столбцы первичного ключа и версии в отдельных партах, если это не требуется для запросов с FINAL. [#53919](https://github.com/ClickHouse/ClickHouse/pull/53919) ([Duc Canh Le](https://github.com/canhld94)).
* Оптимизировано `GROUP BY` с константными ключами. Оптимизирует запросы с `GROUP BY` по `_file/_path` после [https://github.com/ClickHouse/ClickHouse/pull/53529](https://github.com/ClickHouse/ClickHouse/pull/53529). [#53549](https://github.com/ClickHouse/ClickHouse/pull/53549) ([Kruglov Pavel](https://github.com/Avogar)).
* Улучшена производительность сортировки для столбцов `Decimal`. Повышена производительность вставки в `MergeTree`, если в `ORDER BY` присутствует столбец `Decimal`. Также улучшена производительность сортировки, когда данные уже отсортированы или почти отсортированы. [#35961](https://github.com/ClickHouse/ClickHouse/pull/35961) ([Maksim Kita](https://github.com/kitaisreal)).
* Улучшена производительность при анализе очень больших запросов. Исправление [#51224](https://github.com/ClickHouse/ClickHouse/issues/51224). [#51469](https://github.com/ClickHouse/ClickHouse/pull/51469) ([frinkr](https://github.com/frinkr)).
* Оптимизация, переписывающая `COUNT(DISTINCT ...)` и различные варианты `uniq` в `count`, если они выбираются из подзапроса с GROUP BY. [#52082](https://github.com/ClickHouse/ClickHouse/pull/52082) [#52645](https://github.com/ClickHouse/ClickHouse/pull/52645) ([JackyWoo](https://github.com/JackyWoo)).
* Удалили ручные вызовы `mmap/mremap/munmap` и делегировали всю эту работу `jemalloc` — это немного улучшило производительность. [#52792](https://github.com/ClickHouse/ClickHouse/pull/52792) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлено чрезмерное потребление CPU при работе с NATS. [#54399](https://github.com/ClickHouse/ClickHouse/pull/54399) ([Vasilev Pyotr](https://github.com/vahpetr)).
* Поскольку для выполнения `toString` с аргументом типа DateTime используется отдельная логика, можно немного повысить производительность для аргументов других типов и сделать часть кода чище. Продолжение [#53680](https://github.com/ClickHouse/ClickHouse/issues/53680). [#54443](https://github.com/ClickHouse/ClickHouse/pull/54443) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Вместо сериализации элементов JSON в `std::stringstream` этот PR записывает результат сериализации напрямую в `ColumnString`. [#54613](https://github.com/ClickHouse/ClickHouse/pull/54613) ([lgbo](https://github.com/lgbo-ustc)).
* Включена оптимизация ORDER BY для чтения данных в соответствующем порядке из таблицы MergeTree, если таблица используется через представление. [#54628](https://github.com/ClickHouse/ClickHouse/pull/54628) ([Vitaly Baranov](https://github.com/vitlibar)).
* Улучшены SQL‑функции для JSON благодаря переиспользованию `GeneratorJSONPath` и удалению нескольких умных указателей с разделяемой собственностью. [#54735](https://github.com/ClickHouse/ClickHouse/pull/54735) ([lgbo](https://github.com/lgbo-ustc)).
* Keeper пытается объединять запросы flush в батчи для повышения производительности. [#53049](https://github.com/ClickHouse/ClickHouse/pull/53049) ([Antonio Andelic](https://github.com/antonio2368)).
* Теперь `clickhouse-client` при использовании `INFILE 'glob_expression'` обрабатывает файлы параллельно. Закрывает [#54218](https://github.com/ClickHouse/ClickHouse/issues/54218). [#54533](https://github.com/ClickHouse/ClickHouse/pull/54533) ([Max K.](https://github.com/mkaynov)).
* Позволяет использовать первичный ключ для функции `IN`, когда типы столбцов первичного ключа отличаются от типов столбцов в правой части выражения `IN`. Пример: `SELECT id FROM test_table WHERE id IN (SELECT '5')`. Исправляет [#48936](https://github.com/ClickHouse/ClickHouse/issues/48936). [#54544](https://github.com/ClickHouse/ClickHouse/pull/54544) ([Maksim Kita](https://github.com/kitaisreal)).
* Hash JOIN пытается сократить размер внутренних буферов, потребляя половину максимально доступной памяти (устанавливается параметром `max_bytes_in_join`). [#54584](https://github.com/ClickHouse/ClickHouse/pull/54584) ([vdimir](https://github.com/vdimir)).
* Соблюдать `max_block_size` при выполнении array join, чтобы избежать возможного OOM. Закрывает [#54290](https://github.com/ClickHouse/ClickHouse/issues/54290). [#54664](https://github.com/ClickHouse/ClickHouse/pull/54664) ([李扬](https://github.com/taiyang-li)).
* Повторное использование HTTP‑соединений в табличной функции `s3`. [#54812](https://github.com/ClickHouse/ClickHouse/pull/54812) ([Michael Kolupaev](https://github.com/al13n321)).
* Линейный поиск в `MergeTreeRangeReader::Stream::ceilRowsToCompleteGranules` заменён бинарным поиском. [#54869](https://github.com/ClickHouse/ClickHouse/pull/54869) ([usurai](https://github.com/usurai)).

#### Экспериментальная возможность {#experimental-feature}
* Создание индексов `Annoy` теперь может выполняться параллельно с использованием настройки `max_threads_for_annoy_index_creation`. [#54047](https://github.com/ClickHouse/ClickHouse/pull/54047) ([Robert Schulze](https://github.com/rschu1ze)).
* В режиме parallel replicas при работе с распределёнными таблицами чтение больше не выполняется со всех реплик. [#54199](https://github.com/ClickHouse/ClickHouse/pull/54199) ([Igor Nikonov](https://github.com/devcrafter)).

#### Улучшение {#improvement-3}

* Позволяет заменять слишком длинные имена файлов столбцов в частях данных `MergeTree` на хэши их имен. Это помогает избежать ошибки `File name too long` в некоторых случаях. [#50612](https://github.com/ClickHouse/ClickHouse/pull/50612) ([Anton Popov](https://github.com/CurtizJ)).
* Разбирать данные в формате `JSON` как `JSONEachRow`, если не удалось разобрать метаданные. Это позволит читать файлы с расширением `.json`, даже если фактический формат — `JSONEachRow`. Закрывает [#45740](https://github.com/ClickHouse/ClickHouse/issues/45740). [#54405](https://github.com/ClickHouse/ClickHouse/pull/54405) ([Kruglov Pavel](https://github.com/Avogar)).
* Выводить валидный JSON/XML при возникновении исключения во время выполнения HTTP-запроса. Добавлена настройка `http_write_exception_in_output_format` для включения или отключения этого поведения (по умолчанию включена). [#52853](https://github.com/ClickHouse/ClickHouse/pull/52853) ([Kruglov Pavel](https://github.com/Avogar)).
* Представление `information_schema.tables` теперь содержит новое поле `data_length`, которое показывает приблизительный размер данных на диске. Оно необходимо для выполнения запросов, генерируемых Amazon QuickSight. [#55037](https://github.com/ClickHouse/ClickHouse/pull/55037) ([Robert Schulze](https://github.com/rschu1ze)).
* Интерфейс MySQL получил минимальную реализацию подготовленных выражений, достаточную для подключения Tableau Online к ClickHouse через коннектор MySQL. [#54115](https://github.com/ClickHouse/ClickHouse/pull/54115) ([Serge Klochkov](https://github.com/slvrtrn)). Обратите внимание: реализация подготовленных выражений на данный момент весьма минимальна, мы пока не поддерживаем привязку параметров, так как это не требуется для данного конкретного сценария использования Tableau Online. Поддержка будет реализована дополнительно при необходимости после масштабного тестирования Tableau Online, если мы обнаружим проблемы.
* Добавлена поддержка режимов сопоставления без учета регистра и dot-all в словарях `regexp_tree`. [#50906](https://github.com/ClickHouse/ClickHouse/pull/50906) ([Johann Gan](https://github.com/johanngan)).
* Улучшение Keeper: в Keeper добавлена команда `createIfNotExists`. [#48855](https://github.com/ClickHouse/ClickHouse/pull/48855) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Более точный вывод целочисленных типов, исправление [#51236](https://github.com/ClickHouse/ClickHouse/issues/51236). [#53003](https://github.com/ClickHouse/ClickHouse/pull/53003) ([Chen768959](https://github.com/Chen768959)).
* Реализовано определение кодировок для строковых литералов в MaterializedMySQL. [#53220](https://github.com/ClickHouse/ClickHouse/pull/53220) ([Val Doroshchuk](https://github.com/valbok)).
* Исправлена неочевидная проблема с редко используемым движком таблиц `EmbeddedRocksDB` в крайне редком сценарии, при котором он иногда некорректно закрывал файлы в NFS после выполнения команды `DROP TABLE`. [#53502](https://github.com/ClickHouse/ClickHouse/pull/53502) ([Mingliang Pan](https://github.com/liangliangpan)).
* `RESTORE TABLE ON CLUSTER` должен создавать реплицированные таблицы с одинаковым UUID на всех хостах. Иначе макрос `{uuid}` в пути ZooKeeper не сможет корректно работать после RESTORE. Этот PR реализует такую логику. [#53765](https://github.com/ClickHouse/ClickHouse/pull/53765) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена настройка восстановления `restore_broken_parts_as_detached`: если её значение `true`, процесс RESTORE не будет останавливаться на повреждённых частях во время восстановления, вместо этого все повреждённые части будут скопированы в папку `detached` с префиксом `broken-from-backup`. Если значение `false`, процесс RESTORE остановится на первой повреждённой части (если таковая будет). Значение по умолчанию — `false`. [#53877](https://github.com/ClickHouse/ClickHouse/pull/53877) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлено поле `elapsed_ns` в HTTP-заголовки X-ClickHouse-Progress и X-ClickHouse-Summary. [#54179](https://github.com/ClickHouse/ClickHouse/pull/54179) ([joelynch](https://github.com/joelynch)).
* Реализация команд `reconfig` ([https://github.com/ClickHouse/ClickHouse/pull/49450](https://github.com/ClickHouse/ClickHouse/pull/49450)), `sync` и `exists` в keeper-client. [#54201](https://github.com/ClickHouse/ClickHouse/pull/54201) ([pufit](https://github.com/pufit)).
* `clickhouse-local` и `clickhouse-client` теперь позволяют указывать параметр `--query` несколько раз, например `./clickhouse-client --query "SELECT 1" --query "SELECT 2"`. Такой синтаксис немного более интуитивен, чем `./clickhouse-client --multiquery "SELECT  1;S ELECT 2"`, чуть проще для использования в скриптах (например, `queries.push_back('--query "$q"')`) и лучше соответствует поведению уже существующего параметра `--queries-file` (например, `./clickhouse client --queries-file queries1.sql --queries-file queries2.sql`). [#54249](https://github.com/ClickHouse/ClickHouse/pull/54249) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка субсекундной точности в `formatReadableTimeDelta`. [#54250](https://github.com/ClickHouse/ClickHouse/pull/54250) ([Andrey Zvonov](https://github.com/zvonand)).
* По умолчанию включен параметр `allow_remove_stale_moving_parts`. [#54260](https://github.com/ClickHouse/ClickHouse/pull/54260) ([vdimir](https://github.com/vdimir)).
* Исправлено использование кэшированного значения `count` и улучшен индикатор прогресса при чтении из архивов. [#54271](https://github.com/ClickHouse/ClickHouse/pull/54271) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка использования учетных данных S3 через SSO. Чтобы задать профиль, который будет использоваться с SSO, установите переменную окружения `AWS_PROFILE`. [#54347](https://github.com/ClickHouse/ClickHouse/pull/54347) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена поддержка значения NULL по умолчанию для вложенных типов Array/Tuple/Map во входных форматах. Закрывает [#51100](https://github.com/ClickHouse/ClickHouse/issues/51100). [#54351](https://github.com/ClickHouse/ClickHouse/pull/54351) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка чтения некоторых нетипичных конфигураций чанков из форматов Arrow/Parquet. [#54370](https://github.com/ClickHouse/ClickHouse/pull/54370) ([Arthur Passos](https://github.com/arthurpassos)).
* Добавлен псевдоним `STD` для функции `stddevPop`, чтобы обеспечить совместимость с MySQL. Закрывает [#54274](https://github.com/ClickHouse/ClickHouse/issues/54274). [#54382](https://github.com/ClickHouse/ClickHouse/pull/54382) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлены функции `addDate` для совместимости с MySQL и `subDate` для согласованности. См. [#54275](https://github.com/ClickHouse/ClickHouse/issues/54275). [#54400](https://github.com/ClickHouse/ClickHouse/pull/54400) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлен `modification_time` в `system.detached_parts`. [#54506](https://github.com/ClickHouse/ClickHouse/pull/54506) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена настройка `splitby_max_substrings_includes_remaining_string`, которая определяет, будут ли функции &quot;splitBy*()&quot; с аргументом &quot;max&#95;substring&quot; &gt; 0 включать оставшуюся строку (если она есть) в результирующий массив (семантика Python/Spark) или нет. Поведение по умолчанию осталось прежним. [#54518](https://github.com/ClickHouse/ClickHouse/pull/54518) ([Robert Schulze](https://github.com/rschu1ze)).
* Улучшено определение целочисленных типов для полей `Int64`/`UInt64`. Продолжение [#53003](https://github.com/ClickHouse/ClickHouse/pull/53003). Теперь это также работает для вложенных типов, таких как массивы массивов, и для функций `map/tuple`. Связанная задача: [#51236](https://github.com/ClickHouse/ClickHouse/issues/51236). [#54553](https://github.com/ClickHouse/ClickHouse/pull/54553) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлены операции с массивами для умножения, деления и вычисления остатка от деления на скаляр. Работает в обоих направлениях, например `5 * [5, 5]` и `[5, 5] * 5` — оба варианта возможны. [#54608](https://github.com/ClickHouse/ClickHouse/pull/54608) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* В команду `rm` утилиты `keeper-client` добавлен необязательный аргумент `version` для более безопасного удаления. [#54708](https://github.com/ClickHouse/ClickHouse/pull/54708) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Отключена возможность принудительного завершения сервера через systemd (это могло приводить к потере данных при использовании таблиц типа Buffer). [#54744](https://github.com/ClickHouse/ClickHouse/pull/54744) ([Azat Khuzhin](https://github.com/azat)).
* Добавлено поле `is_deterministic` в системную таблицу `system.functions`, которое указывает, является ли результат функции стабильным между двумя вызовами (при точно таких же входных данных) или нет. [#54766](https://github.com/ClickHouse/ClickHouse/pull/54766) [#55035](https://github.com/ClickHouse/ClickHouse/pull/55035) ([Robert Schulze](https://github.com/rschu1ze)).
* Представления в схеме `information_schema` сделаны более совместимыми с эквивалентными представлениями в MySQL (то есть они были изменены и расширены) до уровня, при котором Tableau Online может подключаться к ClickHouse. В частности: 1. Тип поля `information_schema.tables.table_type` изменён с Enum8 на String. 2. В представление `information_schema.table` добавлены поля `table_comment` и `table_collation`. 3. Добавлены представления `information_schema.key_column_usage` и `referential_constraints`. 4. В представлениях `information_schema` псевдонимы в верхнем регистре заменены на соответствующие реальные столбцы в верхнем регистре. [#54773](https://github.com/ClickHouse/ClickHouse/pull/54773) ([Serge Klochkov](https://github.com/slvrtrn)).
* Кэш запросов теперь возвращает ошибку, если пользователь пытается закэшировать результат запроса с недетерминированной функцией, такой как `now`, `randomString` или `dictGet`. По сравнению с предыдущим поведением (когда результат просто тихо не кэшировался), это снижает путаницу и эффект неожиданности для пользователей. [#54801](https://github.com/ClickHouse/ClickHouse/pull/54801) ([Robert Schulze](https://github.com/rschu1ze)).
* Запрещены специальные столбцы materialized/ephemeral/alias для хранилищ `file`/`s3`/`url`/..., исправлена вставка в столбцы ephemeral из файлов. Закрывает [#53477](https://github.com/ClickHouse/ClickHouse/issues/53477). [#54803](https://github.com/ClickHouse/ClickHouse/pull/54803) ([Kruglov Pavel](https://github.com/Avogar)).
* Более настраиваемый сбор метаданных для резервного копирования. [#54804](https://github.com/ClickHouse/ClickHouse/pull/54804) ([Vitaly Baranov](https://github.com/vitlibar)).
* Файл журнала `clickhouse-local` (если он включён с помощью флага --server&#95;logs&#95;file) теперь будет добавлять к каждой строке префикс с отметкой времени, идентификатором потока и т.д., аналогично `clickhouse-server`. [#54807](https://github.com/ClickHouse/ClickHouse/pull/54807) ([Michael Kolupaev](https://github.com/al13n321)).
* Поле `is_obsolete` в таблице `system.merge_tree_settings` — теперь для устаревших настроек MergeTree имеет значение 1. Ранее об устаревании настройки сообщалось только в её описании. [#54837](https://github.com/ClickHouse/ClickHouse/pull/54837) ([Robert Schulze](https://github.com/rschu1ze)).
* Реализована поддержка формы множественного числа в интервал‑литералах. `INTERVAL 2 HOURS` теперь эквивалентен `INTERVAL 2 HOUR`. [#54860](https://github.com/ClickHouse/ClickHouse/pull/54860) ([Jordi Villar](https://github.com/jrdi)).
* Всегда разрешать создание проекции с первичным ключом типа `Nullable`. Это исправляет [#54814](https://github.com/ClickHouse/ClickHouse/issues/54814). [#54895](https://github.com/ClickHouse/ClickHouse/pull/54895) ([Amos Bird](https://github.com/amosbird)).
* Повторять S3‑операции резервного копирования после сбоя из‑за ошибки сброса соединения. [#54900](https://github.com/ClickHouse/ClickHouse/pull/54900) ([Vitaly Baranov](https://github.com/vitlibar)).
* Уточнено сообщение об исключении на случай, когда максимальное значение настройки меньше минимального. [#54925](https://github.com/ClickHouse/ClickHouse/pull/54925) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Функции сопоставления `LIKE`, `match` и другие функции регулярных выражений теперь позволяют выполнять сопоставление с шаблонами, содержащими подстроки, не являющиеся UTF-8, переходя к двоичному сопоставлению. Например, вы можете использовать `string LIKE '\xFE\xFF%'` для обнаружения BOM. Это закрывает [#54486](https://github.com/ClickHouse/ClickHouse/issues/54486). [#54942](https://github.com/ClickHouse/ClickHouse/pull/54942) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлено событие профилирования `ContextLockWaitMicroseconds`. [#55029](https://github.com/ClickHouse/ClickHouse/pull/55029) ([Maksim Kita](https://github.com/kitaisreal)).
* Keeper динамически изменяет уровни логирования. [#50372](https://github.com/ClickHouse/ClickHouse/pull/50372) ([helifu](https://github.com/helifu)).
* Добавлена функция `timestamp` для совместимости с MySQL. Закрывает [#54275](https://github.com/ClickHouse/ClickHouse/issues/54275). [#54639](https://github.com/ClickHouse/ClickHouse/pull/54639) ([Nikolay Degterinsky](https://github.com/evillique)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-3}
* Обновлён компилятор для официальных сборок ClickHouse и сборок непрерывной интеграции с Clang 16 до Clang 17. [#53831](https://github.com/ClickHouse/ClickHouse/pull/53831) ([Robert Schulze](https://github.com/rschu1ze)).
* Повторно сгенерированы TLD-данные для поиска (`tldLookup.generated.cpp`). [#54269](https://github.com/ClickHouse/ClickHouse/pull/54269) ([Bharat Nallan](https://github.com/bharatnc)).
* Удалена избыточная символьная ссылка `clickhouse-keeper-client`. [#54587](https://github.com/ClickHouse/ClickHouse/pull/54587) ([Tomas Barton](https://github.com/deric)).
* Используется `/usr/bin/env` для поиска интерпретатора bash — теперь поддерживается Nix OS. [#54603](https://github.com/ClickHouse/ClickHouse/pull/54603) ([Fionera](https://github.com/fionera)).
* В CMake добавлена опция `PROFILE_CPU`, необходимая для выполнения `perf record` без использования графа вызовов DWARF. [#54917](https://github.com/ClickHouse/ClickHouse/pull/54917) ([Maksim Kita](https://github.com/kitaisreal)).
* Если компоновщик отличен от LLD, сборка завершается с фатальной ошибкой. [#55036](https://github.com/ClickHouse/ClickHouse/pull/55036) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Заменена библиотека для обработки (кодирования/декодирования) значений base64 с Turbo-Base64 на aklomp-base64. Обе используют SIMD-ускорение на x86 и ARM, но: 1) лицензия последней (BSD-2) более благоприятна для ClickHouse, тогда как Turbo64 за это время перешла на GPL-3; 2) благодаря большему числу звёзд на GitHub aklomp-base64 выглядит более перспективной; 3) aklomp-base64 имеет немного более удобный API (что, возможно, субъективно); и 4) aklomp-base64 не требует от нас обходить ошибки (например, не потокобезопасную инициализацию). Примечание: aklomp-base64 отклоняет значения base64 без padding’а, тогда как Turbo-Base64 пытается декодировать их по принципу best effort. RFC-4648 прямо не устанавливает, является ли padding обязательным, но в зависимости от контекста это может быть изменением поведения, о котором следует помнить. [#54119](https://github.com/ClickHouse/ClickHouse/pull/54119) ([Mikhail Koviazin](https://github.com/mkmkme)).

#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-3}

* Исправлена работа REPLACE/MOVE PARTITION с репликацией без копирования данных (примечание: «zero-copy replication» — экспериментальная возможность) [#54193](https://github.com/ClickHouse/ClickHouse/pull/54193) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлены блокировки zero-copy с помощью жёстких ссылок (примечание: «zero-copy replication» является экспериментальной возможностью) [#54859](https://github.com/ClickHouse/ClickHouse/pull/54859) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена генерация лишних данных при zero copy (примечание: «zero-copy replication» — экспериментальная функция) [#54550](https://github.com/ClickHouse/ClickHouse/pull/54550) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Передавать таймаут повторных HTTP‑запросов в миллисекундах (раньше параметр задавался неверно). [#54438](https://github.com/ClickHouse/ClickHouse/pull/54438) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлено некорректное сообщение об ошибке в OUTFILE при использовании `CapnProto`/`Protobuf` [#52870](https://github.com/ClickHouse/ClickHouse/pull/52870) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено формирование сводной статистики при использовании параллельных реплик и LIMIT [#53050](https://github.com/ClickHouse/ClickHouse/pull/53050) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено ограничение скорости BACKUP&#39;ов в/из S3 (в случаях, когда не использовалось нативное копирование), а также в некоторых других местах [#53336](https://github.com/ClickHouse/ClickHouse/pull/53336) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема с ограничением ввода-вывода (I/O throttling) при копировании целых каталогов [#53338](https://github.com/ClickHouse/ClickHouse/pull/53338) ([Azat Khuzhin](https://github.com/azat)).
* Исправление: при переносе действий в условие PREWHERE мог теряться столбец [#53492](https://github.com/ClickHouse/ClickHouse/pull/53492) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена внутренняя ошибка при замене на байтово идентичные части [#53735](https://github.com/ClickHouse/ClickHouse/pull/53735) ([Pedro Riera](https://github.com/priera)).
* Исправление: требовать наличие столбцов, участвующих в выражении interpolate [#53754](https://github.com/ClickHouse/ClickHouse/pull/53754) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлены инициализация обнаружения кластера и настройка fail points (точек отказа) в конфигурации [#54113](https://github.com/ClickHouse/ClickHouse/pull/54113) ([vdimir](https://github.com/vdimir)).
* Исправлены ошибки в `accurateCastOrNull` [#54136](https://github.com/ClickHouse/ClickHouse/pull/54136) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Исправлена работа nullable-первичного ключа с модификатором FINAL [#54164](https://github.com/ClickHouse/ClickHouse/pull/54164) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка, из-за которой при наличии дубликатов данных не выполнялась вставка новых данных в реплицируемое материализованное представление. [#54184](https://github.com/ClickHouse/ClickHouse/pull/54184) ([Pedro Riera](https://github.com/priera)).
* Исправлено: добавлена поддержка `IPv6` для фильтра Блума [#54200](https://github.com/ClickHouse/ClickHouse/pull/54200) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* устранено возможное несоответствие типов для `IPv4` [#54212](https://github.com/ClickHouse/ClickHouse/pull/54212) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлена работа таблицы `system.data_skipping_indices` с пересозданными индексами [#54225](https://github.com/ClickHouse/ClickHouse/pull/54225) ([Artur Malchanau](https://github.com/Hexta)).
* устранён конфликт имён для multiple join rewriter v2 [#54240](https://github.com/ClickHouse/ClickHouse/pull/54240) ([Tao Wang](https://github.com/wangtZJU)).
* Исправлены неожиданные ошибки в `system.errors` после JOIN [#54306](https://github.com/ClickHouse/ClickHouse/pull/54306) ([vdimir](https://github.com/vdimir)).
* Исправлена работа функции `isZeroOrNull(NULL)` [#54316](https://github.com/ClickHouse/ClickHouse/pull/54316) ([flynn](https://github.com/ucasfl)).
* Исправлено: работа параллельных реплик поверх distributed-таблиц при `prefer_localhost_replica` = 1 [#54334](https://github.com/ClickHouse/ClickHouse/pull/54334) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлена логическая ошибка в вертикальном слиянии, ReplacingMergeTree и очистке после OPTIMIZE [#54368](https://github.com/ClickHouse/ClickHouse/pull/54368) ([alesapin](https://github.com/alesapin)).
* Исправлена потенциальная ошибка `URI contains invalid characters` в табличной функции `s3` [#54373](https://github.com/ClickHouse/ClickHouse/pull/54373) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка сегментации в оптимизации AST функции `arrayExists` [#54379](https://github.com/ClickHouse/ClickHouse/pull/54379) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена проверка на переполнение перед сложением в функции `analysisOfVariance` [#54385](https://github.com/ClickHouse/ClickHouse/pull/54385) ([Antonio Andelic](https://github.com/antonio2368)).
* Воспроизвести и исправить ошибку в removeSharedRecursive [#54430](https://github.com/ClickHouse/ClickHouse/pull/54430) ([Sema Checherinda](https://github.com/CheSema)).
* Исправлена возможная некорректность результата при использовании `SimpleAggregateFunction` в `PREWHERE` и `FINAL` [#54436](https://github.com/ClickHouse/ClickHouse/pull/54436) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена фильтрация частей с indexHint для non analyzer [#54449](https://github.com/ClickHouse/ClickHouse/pull/54449) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены агрегатные проекции с нормализованными состояниями [#54480](https://github.com/ClickHouse/ClickHouse/pull/54480) ([Amos Bird](https://github.com/amosbird)).
* `clickhouse-local`: доработки для параметра multiquery [#54498](https://github.com/ClickHouse/ClickHouse/pull/54498) ([CuiShuoGuo](https://github.com/bakam412)).
* `clickhouse-local` поддерживает аргумент командной строки `--database` [#54503](https://github.com/ClickHouse/ClickHouse/pull/54503) ([vdimir](https://github.com/vdimir)).
* Исправлена потенциальная ошибка парсинга в форматах `-WithNames` при отключённом `input_format_with_names_use_header` [#54513](https://github.com/ClickHouse/ClickHouse/pull/54513) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен редкий случай возникновения ошибки CHECKSUM&#95;DOESNT&#95;MATCH [#54549](https://github.com/ClickHouse/ClickHouse/pull/54549) ([alesapin](https://github.com/alesapin)).
* Исправлена сортировка операции UNION ALL над уже отсортированными результатами [#54564](https://github.com/ClickHouse/ClickHouse/pull/54564) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена установка снапшота в Keeper [#54572](https://github.com/ClickHouse/ClickHouse/pull/54572) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено условие гонки в `ColumnUnique` [#54575](https://github.com/ClickHouse/ClickHouse/pull/54575) ([Nikita Taranov](https://github.com/nickitat)).
* Индекс Annoy/Usearch: исправлена LOGICAL&#95;ERROR при построении с использованием значений по умолчанию [#54600](https://github.com/ClickHouse/ClickHouse/pull/54600) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена сериализация `ColumnDecimal` [#54601](https://github.com/ClickHouse/ClickHouse/pull/54601) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлено определение схемы для функций *Cluster для имён столбцов с пробелами [#54635](https://github.com/ClickHouse/ClickHouse/pull/54635) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено использование структуры таблиц для вставки при значениях по умолчанию и явном указании столбцов вставки [#54655](https://github.com/ClickHouse/ClickHouse/pull/54655) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено: больше не используется сопоставление по регулярному выражению, которое может содержать альтернацию, в качестве ключевого условия. [#54696](https://github.com/ClickHouse/ClickHouse/pull/54696) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлено поведение ReplacingMergeTree при вертикальном слиянии и очистке [#54706](https://github.com/ClickHouse/ClickHouse/pull/54706) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлена проблема, из-за которой виртуальные столбцы содержали некорректные значения после ORDER BY [#54811](https://github.com/ClickHouse/ClickHouse/pull/54811) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена фильтрация частей с indexHint для non-analyzer [#54825](https://github.com/ClickHouse/ClickHouse/pull/54825) [#54449](https://github.com/ClickHouse/ClickHouse/pull/54449) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен сегфолт Keeper при завершении работы [#54841](https://github.com/ClickHouse/ClickHouse/pull/54841) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка `Invalid number of rows in Chunk` в MaterializedPostgreSQL [#54844](https://github.com/ClickHouse/ClickHouse/pull/54844) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Перенесены устаревшие настройки формата в отдельный раздел [#54855](https://github.com/ClickHouse/ClickHouse/pull/54855) ([Kruglov Pavel](https://github.com/Avogar)).
* Перестроить `minmax_count_projection` при изменении ключа разбиения на партиции [#54943](https://github.com/ClickHouse/ClickHouse/pull/54943) ([Amos Bird](https://github.com/amosbird)).
* Исправлено некорректное приведение типа к `ColumnVector<Int128>` в функции `if` [#55019](https://github.com/ClickHouse/ClickHouse/pull/55019) ([Kruglov Pavel](https://github.com/Avogar)).
* Предотвращено присоединение частей из таблиц с разными проекциями или индексами [#55062](https://github.com/ClickHouse/ClickHouse/pull/55062) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Сохранять NULL в карте скалярных результатов при пустом результате подзапроса [#52240](https://github.com/ClickHouse/ClickHouse/pull/52240) ([vdimir](https://github.com/vdimir)).
* Исправлена ошибка, из-за которой `FINAL` в редких случаях формировал некорректные диапазоны чтения [#54934](https://github.com/ClickHouse/ClickHouse/pull/54934) ([Nikita Taranov](https://github.com/nickitat)).
* Fix: вставка с кворумом без повторных попыток Keeper [#55026](https://github.com/ClickHouse/ClickHouse/pull/55026) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлено простое состояние с Nullable [#55030](https://github.com/ClickHouse/ClickHouse/pull/55030) ([Pedro Riera](https://github.com/priera)).

### <a id="238"></a> Релиз ClickHouse 23.8 LTS, 2023-08-31 {#238}

#### Обратно несовместимые изменения {#backward-incompatible-change-4}
* Если динамический диск содержит имя, оно должно быть указано в аргументах функции `disk` как `disk = disk(name = 'disk_name'`, ...). В предыдущей версии его можно было указать как `disk = disk_<disk_name>(...)`, что больше не поддерживается. [#52820](https://github.com/ClickHouse/ClickHouse/pull/52820) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `clickhouse-benchmark` будет устанавливать соединения параллельно при запуске с `--concurrency` больше единицы. Ранее он был непригоден к использованию, если вы запускали его с 1000 одновременными соединениями из Европы в США. Исправлен расчёт QPS для соединений с высокой задержкой. Обратно несовместимое изменение: опция JSON-вывода `clickhouse-benchmark` удалена. Если вы использовали эту опцию, в качестве обходного пути вы можете извлекать данные из `system.query_log` в формате JSON. [#53293](https://github.com/ClickHouse/ClickHouse/pull/53293) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Столбец `microseconds` удалён из `system.text_log`, а столбец `milliseconds` — из `system.metric_log`, так как они избыточны при наличии столбца `event_time_microseconds`. [#53601](https://github.com/ClickHouse/ClickHouse/pull/53601) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Функция кэша метаданных объявлена устаревшей. Она является экспериментальной, и мы никогда её не использовали. Эта возможность опасна: [#51182](https://github.com/ClickHouse/ClickHouse/issues/51182). Удалена системная таблица `system.merge_tree_metadata_cache`. Кэш метаданных всё ещё доступен в этой версии, но будет вскоре удалён. Это закрывает задачу [#39197](https://github.com/ClickHouse/ClickHouse/issues/39197). [#51303](https://github.com/ClickHouse/ClickHouse/pull/51303) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Отключена поддержка 3DES в TLS-соединениях. [#52893](https://github.com/ClickHouse/ClickHouse/pull/52893) ([Kenji Noguchi](https://github.com/knoguchi)).

#### Новая возможность {#new-feature-4}

* Прямой импорт из архивов в форматах zip/7z/tar. Пример: `file('*.zip :: *.csv')`. [#50321](https://github.com/ClickHouse/ClickHouse/pull/50321) ([nikitakeba](https://github.com/nikitakeba)).
* Добавлен столбец `ptr` в `system.trace_log` для `trace_type = 'MemorySample'`. Этот столбец содержит адрес выделения памяти. Добавлена функция `flameGraph`, которая может строить flamegraph, содержащий выделенную, но не освобождённую память. Доработка [#38391](https://github.com/ClickHouse/ClickHouse/issues/38391). [#45322](https://github.com/ClickHouse/ClickHouse/pull/45322) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлена табличная функция `azureBlobStorageCluster`. Поддерживаемый функционал очень похож на функционал табличной функции `s3Cluster`. [#50795](https://github.com/ClickHouse/ClickHouse/pull/50795) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Разрешено использование `cluster`, `clusterAllReplicas`, `remote` и `remoteSecure` без указания имени таблицы в задаче [#50808](https://github.com/ClickHouse/ClickHouse/issues/50808). [#50848](https://github.com/ClickHouse/ClickHouse/pull/50848) ([Yangkuan Liu](https://github.com/LiuYangkuan)).
* Системная таблица для мониторинга потребителей Kafka. [#50999](https://github.com/ClickHouse/ClickHouse/pull/50999) ([Ilya Golshtein](https://github.com/ilejn)).
* Добавлена настройка `max_sessions_for_user`. [#51724](https://github.com/ClickHouse/ClickHouse/pull/51724) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
* Новые функции `toUTCTimestamp/fromUTCTimestamp`, которые работают так же, как функции Spark `to_utc_timestamp/from_utc_timestamp`. [#52117](https://github.com/ClickHouse/ClickHouse/pull/52117) ([KevinyhZou](https://github.com/KevinyhZou)).
* Добавлены новые функции `structureToCapnProtoSchema`/`structureToProtobufSchema`, которые преобразуют структуру таблицы ClickHouse в схему формата CapnProto/Protobuf. Они позволяют вводить и выводить данные в формате CapnProto/Protobuf без внешней схемы формата, используя автоматически сгенерированную схему, построенную по структуре таблицы (управляется настройками `format_capn_proto_use_autogenerated_schema`/`format_protobuf_use_autogenerated_schema`). Добавлена возможность экспорта автоматически сгенерированной схемы при вводе/выводе данных с помощью настройки `output_format_schema`. [#52278](https://github.com/ClickHouse/ClickHouse/pull/52278) ([Kruglov Pavel](https://github.com/Avogar)).
* Новое поле `query_cache_usage` в `system.query_log` теперь показывает, использовался ли кэш запросов и каким образом. [#52384](https://github.com/ClickHouse/ClickHouse/pull/52384) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлены новые функции `startsWithUTF8` и `endsWithUTF8`. [#52555](https://github.com/ClickHouse/ClickHouse/pull/52555) ([李扬](https://github.com/taiyang-li)).
* Добавлена поддержка переменного числа столбцов в форматах TSV/CustomSeparated/JSONCompactEachRow, вывод схемы теперь корректно работает при переменном числе столбцов. Добавлены настройки `input_format_tsv_allow_variable_number_of_columns`, `input_format_custom_allow_variable_number_of_columns`, `input_format_json_compact_allow_variable_number_of_columns`. [#52692](https://github.com/ClickHouse/ClickHouse/pull/52692) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлены запросы вида `SYSTEM STOP/START PULLING REPLICATION LOG` (для тестирования `ReplicatedMergeTree`). [#52881](https://github.com/ClickHouse/ClickHouse/pull/52881) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Разрешено выполнять константные недетерминированные функции в мутациях на инициаторе. [#53129](https://github.com/ClickHouse/ClickHouse/pull/53129) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлен формат ввода данных `One`, который не читает никаких данных и всегда возвращает единственную строку со столбцом `dummy` типа `UInt8` и значением `0`, аналогично `system.one`. Его можно использовать вместе с виртуальными столбцами `_file/_path` для получения списка файлов в табличных функциях file/s3/url/hdfs/etc без чтения данных. [#53209](https://github.com/ClickHouse/ClickHouse/pull/53209) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена функция `tupleConcat`. Закрывает [#52759](https://github.com/ClickHouse/ClickHouse/issues/52759). [#53239](https://github.com/ClickHouse/ClickHouse/pull/53239) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена поддержка операции `TRUNCATE DATABASE`. [#53261](https://github.com/ClickHouse/ClickHouse/pull/53261) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлена настройка `max_threads_for_indexes`, позволяющая ограничить число потоков, используемых при обработке первичного ключа. [#53313](https://github.com/ClickHouse/ClickHouse/pull/53313) ([jorisgio](https://github.com/jorisgio)).
* Вернуть функции SipHash с ключом. [#53525](https://github.com/ClickHouse/ClickHouse/pull/53525) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* ([#52755](https://github.com/ClickHouse/ClickHouse/issues/52755), [#52895](https://github.com/ClickHouse/ClickHouse/issues/52895)) Добавлены функции `arrayRotateLeft`, `arrayRotateRight`, `arrayShiftLeft`, `arrayShiftRight`. [#53557](https://github.com/ClickHouse/ClickHouse/pull/53557) ([Mikhail Koviazin](https://github.com/mkmkme)).
* Добавлен столбец `name` в таблицу `system.clusters` как псевдоним для `cluster`. [#53605](https://github.com/ClickHouse/ClickHouse/pull/53605) ([irenjj](https://github.com/irenjj)).
* Расширенный дашборд теперь поддерживает массовое редактирование (сохранение/загрузку). [#53608](https://github.com/ClickHouse/ClickHouse/pull/53608) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* В расширенной панели мониторинга теперь появилась возможность разворачивать графики на весь экран и перемещать их. [#53622](https://github.com/ClickHouse/ClickHouse/pull/53622) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка сложения и вычитания массивов: `[5,2] + [1,7]`. Деление и умножение не реализованы из-за неоднозначности между поэлементным умножением и скалярным произведением аргументов. Закрывает [#49939](https://github.com/ClickHouse/ClickHouse/issues/49939). [#52625](https://github.com/ClickHouse/ClickHouse/pull/52625) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлена поддержка строковых литералов в качестве имён таблиц. Закрывает [#52178](https://github.com/ClickHouse/ClickHouse/issues/52178). [#52635](https://github.com/ClickHouse/ClickHouse/pull/52635) ([hendrik-m](https://github.com/hendrik-m)).

#### Экспериментальная возможность {#experimental-feature-1}
* Добавлен новый движок таблицы `S3Queue` для потокового импорта данных из S3. Закрывает [#37012](https://github.com/ClickHouse/ClickHouse/issues/37012). [#49086](https://github.com/ClickHouse/ClickHouse/pull/49086) ([s-kat](https://github.com/s-kat)). Он ещё не готов к использованию. Не используйте его.
* Добавлена поддержка параллельного чтения с реплик через распределённую таблицу. Связано с [#49708](https://github.com/ClickHouse/ClickHouse/issues/49708). [#53005](https://github.com/ClickHouse/ClickHouse/pull/53005) ([Igor Nikonov](https://github.com/devcrafter)).
* Добавлена экспериментальная поддержка HNSW как метода приблизительного поиска ближайших соседей. [#53447](https://github.com/ClickHouse/ClickHouse/pull/53447) ([Davit Vardanyan](https://github.com/davvard)). В настоящее время предназначена для тех, кто продолжает работу над реализацией. Не используйте это.

#### Повышение производительности {#performance-improvement-4}

* Проталкивание фильтров в Parquet. То есть при чтении файлов формата Parquet группы строк (части файла) пропускаются в зависимости от условия WHERE и min/max значений в каждом столбце. В частности, если файл примерно отсортирован по определённому столбцу, запросы с фильтрацией по короткому диапазону значений этого столбца будут выполняться значительно быстрее. [#52951](https://github.com/ClickHouse/ClickHouse/pull/52951) ([Michael Kolupaev](https://github.com/al13n321)).
* Оптимизировано чтение небольших групп строк за счёт их объединения в батчи в Parquet. Закрывает [#53069](https://github.com/ClickHouse/ClickHouse/issues/53069). [#53281](https://github.com/ClickHouse/ClickHouse/pull/53281) ([Kruglov Pavel](https://github.com/Avogar)).
* Оптимизирована операция COUNT по файлам в большинстве форматов ввода. Закрывает [#44334](https://github.com/ClickHouse/ClickHouse/issues/44334). [#53637](https://github.com/ClickHouse/ClickHouse/pull/53637) ([Kruglov Pavel](https://github.com/Avogar)).
* Применяйте фильтр по файлу/пути перед чтением с помощью табличных функций `url`/`file`/`hdfs`. [#53529](https://github.com/ClickHouse/ClickHouse/pull/53529) ([Kruglov Pavel](https://github.com/Avogar)).
* Включена JIT-компиляция для архитектур AArch64, PowerPC, SystemZ и RISC-V. [#38217](https://github.com/ClickHouse/ClickHouse/pull/38217) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена настройка `rewrite_count_distinct_if_with_count_distinct_implementation` для замены `countDistinctIf` на `count_distinct_implementation`. Закрывает [#30642](https://github.com/ClickHouse/ClickHouse/issues/30642). [#46051](https://github.com/ClickHouse/ClickHouse/pull/46051) ([flynn](https://github.com/ucasfl)).
* Ускорено слияние состояний агрегатных функций `uniq` и `uniqExact` за счёт параллелизации преобразования перед слиянием. [#50748](https://github.com/ClickHouse/ClickHouse/pull/50748) ([Jiebin Sun](https://github.com/jiebinn)).
* Оптимизирована производительность агрегации по строковому ключу, допускающему NULL, при использовании большого числа ключей переменной длины. [#51399](https://github.com/ClickHouse/ClickHouse/pull/51399) ([LiuNeng](https://github.com/liuneng1994)).
* Добавлен проход в Analyzer для оптимизации временного фильтра с использованием preimage. Эксперименты по производительности SSB на устройстве ICX (CPU Intel Xeon Platinum 8380, 80 ядер, 160 потоков) показывают, что это изменение может дать повышение геометрического среднего значения QPS на 8,5 % при включённом экспериментальном анализаторе. [#52091](https://github.com/ClickHouse/ClickHouse/pull/52091) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
* Оптимизировать операцию слияния в функции `uniqExact` (COUNT DISTINCT), если все хеш-наборы одноуровневые. [#52973](https://github.com/ClickHouse/ClickHouse/pull/52973) ([Jiebin Sun](https://github.com/jiebinn)).
* Движок таблицы `Join`: не клонировать структуру данных хеш‑соединения со всеми столбцами. [#53046](https://github.com/ClickHouse/ClickHouse/pull/53046) ([Duc Canh Le](https://github.com/canhld94)).
* Реализован нативный входной формат `ORC` без использования библиотеки «Apache Arrow» для повышения производительности. [#53324](https://github.com/ClickHouse/ClickHouse/pull/53324) ([李扬](https://github.com/taiyang-li)).
* Дашборд даёт серверу команду сжать данные, что полезно для больших временных диапазонов при медленном подключении к интернету. Например, один график с 86400 точками может занимать 1,5 МБ в несжатом виде и 60 КБ при сжатии с помощью `br`. [#53569](https://github.com/ClickHouse/ClickHouse/pull/53569) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Более эффективное использование пула потоков для операций BACKUP и RESTORE. [#53649](https://github.com/ClickHouse/ClickHouse/pull/53649) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Загружать метаданные файлового кэша при запуске в параллельном режиме. Конфигурируется настройкой кэша `load_metadata_threads` (по умолчанию — 1). Связано с [#52037](https://github.com/ClickHouse/ClickHouse/issues/52037). [#52943](https://github.com/ClickHouse/ClickHouse/pull/52943) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Улучшен `move_primary_key_columns_to_end_of_prewhere`. [#53337](https://github.com/ClickHouse/ClickHouse/pull/53337) ([Han Fei](https://github.com/hanfei1991)).
* Это оптимизирует взаимодействие с ClickHouse Keeper. Ранее вызывающий код мог регистрировать один и тот же watch-callback несколько раз. В этом случае каждая запись потребляла память, а один и тот же callback вызывался несколько раз, что не имело особого смысла. Чтобы избежать этого, вызывающий код мог реализовать некоторую логику, не добавляющую один и тот же watch несколько раз. С этим изменением такая дедупликация выполняется внутри, если watch-callback передаётся через shared&#95;ptr. [#53452](https://github.com/ClickHouse/ClickHouse/pull/53452) ([Alexander Gololobov](https://github.com/davenger)).
* Кэширование числа строк в файлах при выполнении COUNT в функциях file/s3/url/hdfs/azure. Кэш может быть включён или отключён с помощью настройки `use_cache_for_count_from_files` (по умолчанию включён). Продолжение [https://github.com/ClickHouse/ClickHouse/pull/53637](https://github.com/ClickHouse/ClickHouse/pull/53637). [#53692](https://github.com/ClickHouse/ClickHouse/pull/53692) ([Kruglov Pavel](https://github.com/Avogar)).
* Более тщательное управление потоками повышает скорость табличной функции S3 при обработке большого количества файлов более чем на 25 %. [#53668](https://github.com/ClickHouse/ClickHouse/pull/53668) ([pufit](https://github.com/pufit)).



#### Улучшение {#improvement-4}

* Добавлен параметр конфигурации `stderr_reaction` для управления реакцией (`none`, `log` или `throw`) при наличии данных в stderr внешней команды. Это упрощает отладку внешних команд. [#43210](https://github.com/ClickHouse/ClickHouse/pull/43210) ([Amos Bird](https://github.com/amosbird)).
* Добавлен столбец `partition` в таблицу `system part_log` и таблицу Merge. [#48990](https://github.com/ClickHouse/ClickHouse/pull/48990) ([Jianfei Hu](https://github.com/incfly)).
* Размеры кэшей несжатых индексов (index), mark, mmap и query теперь можно динамически конфигурировать во время работы (без перезапуска сервера). [#51446](https://github.com/ClickHouse/ClickHouse/pull/51446) ([Robert Schulze](https://github.com/rschu1ze)).
* Если словарь создаётся со сложным ключом, автоматически выбирается вариант макета «complex key». [#49587](https://github.com/ClickHouse/ClickHouse/pull/49587) ([xiebin](https://github.com/xbthink)).
* Добавлена настройка `use_concurrency_control` для более эффективного тестирования новой функции управления конкурентным доступом. [#49618](https://github.com/ClickHouse/ClickHouse/pull/49618) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлены подсказки для ошибочно введённых имён баз данных и таблиц. [#49801](https://github.com/ClickHouse/ClickHouse/pull/49801) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* При чтении небольших файлов из HDFS с помощью Gluten мы обнаружили, что это занимает больше времени по сравнению с прямым выполнением запроса в Spark. Мы улучшили эту часть. [#50063](https://github.com/ClickHouse/ClickHouse/pull/50063) ([KevinyhZou](https://github.com/KevinyhZou)).
* После истечения срока действия сессии возникало слишком много бесполезных сообщений об ошибках, что нас не устраивало. [#50171](https://github.com/ClickHouse/ClickHouse/pull/50171) ([helifu](https://github.com/helifu)).
* Добавлены резервные сессии ZooKeeper с ограниченным сроком действия. Исправлен столбец `index` в system.zookeeper&#95;connection для DNS-адресов. [#50424](https://github.com/ClickHouse/ClickHouse/pull/50424) ([Anton Kozlov](https://github.com/tonickkozlov)).
* Добавлена возможность записывать в лог при достижении предельного значения max&#95;partitions&#95;per&#95;insert&#95;block. [#50948](https://github.com/ClickHouse/ClickHouse/pull/50948) ([Sean Haynes](https://github.com/seandhaynes)).
* Добавлен ряд дополнительных команд в clickhouse-keeper-client (в основном для упрощения отладки ClickHouse). [#51117](https://github.com/ClickHouse/ClickHouse/pull/51117) ([pufit](https://github.com/pufit)).
* Обновлена проверка строки подключения в табличной функции `azureBlobStorage`, поскольку строка подключения с «sas» не всегда начинается с конечной точки по умолчанию, а также изменён URL подключения: sas‑токен теперь добавляется в URL после контейнера Azure. [#51141](https://github.com/ClickHouse/ClickHouse/pull/51141) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлено описание фильтрации наборов в алгоритме JOIN `full_sorting_merge`. [#51329](https://github.com/ClickHouse/ClickHouse/pull/51329) ([Tanay Tummalapalli](https://github.com/ttanay)).
* Исправлено потребление памяти в `Aggregator`, когда `max_block_size` установлен на очень большое значение. [#51566](https://github.com/ClickHouse/ClickHouse/pull/51566) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлена команда `SYSTEM SYNC FILESYSTEM CACHE`. Она сравнивает состояние файлового кэша в памяти с данными на диске и при необходимости корректирует его. Это требуется только при ручном вмешательстве в данные на диске, что крайне не рекомендуется. [#51622](https://github.com/ClickHouse/ClickHouse/pull/51622) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Попытка реализовать универсальный proxy resolver для ClickHouse при сохранении обратной совместимости с существующим proxy resolver в конфигурации хранилища S3. [#51749](https://github.com/ClickHouse/ClickHouse/pull/51749) ([Arthur Passos](https://github.com/arthurpassos)).
* Поддержано чтение подколонок кортежей из табличных функций file/s3/hdfs/url/azureBlobStorage. [#51806](https://github.com/ClickHouse/ClickHouse/pull/51806) ([Kruglov Pavel](https://github.com/Avogar)).
* Функция `arrayIntersect` теперь возвращает значения в том же порядке, что и в первом аргументе. Закрывает [#27622](https://github.com/ClickHouse/ClickHouse/issues/27622). [#51850](https://github.com/ClickHouse/ClickHouse/pull/51850) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Добавлены новые запросы для создания и удаления объектов доступа в указанном хранилище доступа, а также для перемещения объектов доступа из одного хранилища в другое. [#51912](https://github.com/ClickHouse/ClickHouse/pull/51912) ([pufit](https://github.com/pufit)).
* Запросы `ALTER TABLE FREEZE` больше не реплицируются в движке Replicated. [#52064](https://github.com/ClickHouse/ClickHouse/pull/52064) ([Mike Kot](https://github.com/myrrc)).
* Добавлена возможность сбрасывать системные таблицы при аварийном завершении работы. [#52174](https://github.com/ClickHouse/ClickHouse/pull/52174) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
* Исправлена ситуация, когда табличная функция `s3` отказывалась работать с предварительно подписанными URL-адресами. Закрыта задача [#50846](https://github.com/ClickHouse/ClickHouse/issues/50846). [#52310](https://github.com/ClickHouse/ClickHouse/pull/52310) ([chen](https://github.com/xiedeyantu)).
* Добавлен столбец `name` в качестве псевдонима столбцов `event` и `metric` в таблицах `system.events` и `system.metrics`. Закрывает [#51257](https://github.com/ClickHouse/ClickHouse/issues/51257). [#52315](https://github.com/ClickHouse/ClickHouse/pull/52315) ([chen](https://github.com/xiedeyantu)).
* Добавлена поддержка синтаксиса `CREATE UNIQUE INDEX` в парсере как пустой операции (no-op) для лучшей совместимости с SQL. Индекс `UNIQUE` не поддерживается. Установите `create_index_ignore_unique = 1`, чтобы игнорировать ключевое слово UNIQUE в запросах. [#52320](https://github.com/ClickHouse/ClickHouse/pull/52320) ([Ilya Yatsishin](https://github.com/qoega)).
* Добавлена поддержка предопределённых макросов (`{database}` и `{table}`) в некоторых параметрах движка Kafka, таких как topic, consumer, client&#95;id и т.д. [#52386](https://github.com/ClickHouse/ClickHouse/pull/52386) ([Yury Bogomolov](https://github.com/ybogo)).
* Отключено обновление кэша файловой системы во время резервного копирования и восстановления. Кэш файловой системы не должен обновляться во время резервного копирования и восстановления, поскольку, по-видимому, это только замедляет процесс без какой-либо пользы (так как команда BACKUP может читать большой объём данных, и нет смысла помещать все данные в кэш файловой системы и тут же их вытеснять). [#52402](https://github.com/ClickHouse/ClickHouse/pull/52402) ([Vitaly Baranov](https://github.com/vitlibar)).
* Конфигурация конечной точки S3 позволяет использовать её, начиная с корневого пути, и при необходимости автоматически дописывает в конце символ &#39;/&#39;. [#47809](https://github.com/ClickHouse/ClickHouse/issues/47809). [#52600](https://github.com/ClickHouse/ClickHouse/pull/52600) ([xiaolei565](https://github.com/xiaolei565)).
* Для clickhouse-local разрешено использование позиционных опций и выполняется заполнение глобальных настроек UDF (user&#95;scripts&#95;path и user&#95;defined&#95;executable&#95;functions&#95;config). [#52643](https://github.com/ClickHouse/ClickHouse/pull/52643) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* `system.asynchronous_metrics` теперь содержит метрики &quot;QueryCacheEntries&quot; и &quot;QueryCacheBytes&quot; для анализа кэша запросов. [#52650](https://github.com/ClickHouse/ClickHouse/pull/52650) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена возможность использовать параметр `s3_storage_class` в секции `SETTINGS` оператора `BACKUP` при создании резервных копий в S3. [#52658](https://github.com/ClickHouse/ClickHouse/pull/52658) ([Roman Vasin](https://github.com/rvasin)).
* Добавлена утилита `print-backup-info.py`, которая разбирает файл метаданных резервной копии и выводит информацию о ней. [#52690](https://github.com/ClickHouse/ClickHouse/pull/52690) ([Vitaly Baranov](https://github.com/vitlibar)).
* Закрывает [#49510](https://github.com/ClickHouse/ClickHouse/issues/49510). В настоящее время имена баз данных и таблиц чувствительны к регистру, но BI-инструменты иногда обращаются к `information_schema` в нижнем, а иногда — в верхнем регистре. По этой причине у нас есть база данных `information_schema`, содержащая таблицы в нижнем регистре, такие как `information_schema.tables`, и база данных `INFORMATION_SCHEMA`, содержащая таблицы в верхнем регистре, такие как `INFORMATION_SCHEMA.TABLES`. Но некоторые инструменты выполняют запросы к `INFORMATION_SCHEMA.tables` и `information_schema.TABLES`. Предлагаемое решение — продублировать варианты таблиц как в нижнем, так и в верхнем регистре в обеих базах данных `information_schema` и `INFORMATION_SCHEMA`. [#52695](https://github.com/ClickHouse/ClickHouse/pull/52695) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Запрос `CHECK TABLE` обладает более высокой производительностью и удобством использования (отправляет уведомления о прогрессе, выполнение можно отменить). [#52745](https://github.com/ClickHouse/ClickHouse/pull/52745) ([vdimir](https://github.com/vdimir)).
* Добавлена поддержка `modulo`, `intDiv`, `intDivOrZero` для кортежей за счет поэлементного применения этих операций. [#52758](https://github.com/ClickHouse/ClickHouse/pull/52758) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Искать файлы стандартных конфигураций `yaml` и `yml` в clickhouse-client после `xml`. [#52767](https://github.com/ClickHouse/ClickHouse/pull/52767) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* При слиянии с конфигурацией, корневой узел которой отличается от &#39;clickhouse&#39;, конфигурации с другим именем корневого узла просто игнорируются, исключения не генерируются. [#52770](https://github.com/ClickHouse/ClickHouse/pull/52770) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Теперь можно задавать минимальный (`memory_profiler_sample_min_allocation_size`) и максимальный (`memory_profiler_sample_max_allocation_size`) размер выделений памяти, которые будут отслеживаться выборочным профилировщиком памяти. [#52779](https://github.com/ClickHouse/ClickHouse/pull/52779) ([alesapin](https://github.com/alesapin)).
* Добавлена настройка `precise_float_parsing` для переключения методов разбора чисел с плавающей запятой (быстрый/точный). [#52791](https://github.com/ClickHouse/ClickHouse/pull/52791) ([Andrey Zvonov](https://github.com/zvonand)).
* Используйте те же пути по умолчанию для `clickhouse-keeper` (символьная ссылка), как и для `clickhouse-keeper` (исполняемый файл). [#52861](https://github.com/ClickHouse/ClickHouse/pull/52861) ([Vitaly Baranov](https://github.com/vitlibar)).
* Улучшено сообщение об ошибке для табличной функции `remote`. Закрывает [#40220](https://github.com/ClickHouse/ClickHouse/issues/40220). [#52959](https://github.com/ClickHouse/ClickHouse/pull/52959) ([jiyoungyoooo](https://github.com/jiyoungyoooo)).
* Добавлена возможность указывать пользовательскую политику хранения в секции `SETTINGS` в запросах `RESTORE`. [#52970](https://github.com/ClickHouse/ClickHouse/pull/52970) ([Victor Krasnov](https://github.com/sirvickr)).
* Добавлена возможность ограничивать частоту запросов к S3 при выполнении операций резервного копирования (команды `BACKUP` и `RESTORE` теперь учитывают параметры `s3_max_[get/put]_[rps/burst]`). [#52974](https://github.com/ClickHouse/ClickHouse/pull/52974) ([Daniel Pozo Escalona](https://github.com/danipozo)).
* Добавлены настройки для игнорирования предложения ON CLUSTER в запросах при управлении реплицируемыми пользовательскими функциями или объектами управления доступом с реплицируемым хранилищем. [#52975](https://github.com/ClickHouse/ClickHouse/pull/52975) ([Aleksei Filatov](https://github.com/aalexfvk)).
* EXPLAIN действий для шага JOIN. [#53006](https://github.com/ClickHouse/ClickHouse/pull/53006) ([Maksim Kita](https://github.com/kitaisreal)).
* Функции `hasTokenOrNull` и `hasTokenCaseInsensitiveOrNull` теперь возвращают NULL для пустых подстрок. [#53059](https://github.com/ClickHouse/ClickHouse/pull/53059) ([ltrk2](https://github.com/ltrk2)).
* Позволяет ограничить разрешённые пути для файловых кэшей. В основном полезно для динамических дисков. Если в конфигурации сервера указан `filesystem_caches_path`, все пути файловых кэшей будут ограничены этим каталогом. Например, если `path` в конфигурации кэша относительный — он будет размещён внутри `filesystem_caches_path`; если `path` в конфигурации кэша абсолютный, потребуется, чтобы он находился внутри `filesystem_caches_path`. Если параметр `filesystem_caches_path` не указан в конфигурации, поведение останется таким же, как в более ранних версиях. [#53124](https://github.com/ClickHouse/ClickHouse/pull/53124) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлено несколько пользовательских команд (в основном для упрощения отладки ClickHouse). [#53127](https://github.com/ClickHouse/ClickHouse/pull/53127) ([pufit](https://github.com/pufit)).
* Добавлена диагностическая информация о названии файла при выводе схемы — это помогает при обработке множества файлов с использованием glob-шаблонов. [#53135](https://github.com/ClickHouse/ClickHouse/pull/53135) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Клиент будет загружать подсказки через основное подключение, если второму подключению не разрешено создавать сессию. [#53177](https://github.com/ClickHouse/ClickHouse/pull/53177) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
* Добавлено предложение EXCEPT в запрос `SYSTEM STOP/START LISTEN QUERIES [ALL/DEFAULT/CUSTOM]`, например: `SYSTEM STOP LISTEN QUERIES ALL EXCEPT TCP, HTTP`. [#53280](https://github.com/ClickHouse/ClickHouse/pull/53280) ([Nikolay Degterinsky](https://github.com/evillique)).
* Изменено значение по умолчанию параметра `max_concurrent_queries` со 100 до 1000. Допустимо иметь много параллельных запросов, если они не ресурсоёмкие и в основном находятся в ожидании по сети. Примечание: не путайте параллельные запросы и QPS (запросы в секунду): например, сервер ClickHouse может обрабатывать десятки тысяч QPS при количестве параллельных запросов менее 100. [#53285](https://github.com/ClickHouse/ClickHouse/pull/53285) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Ограничено число одновременных фоновых слияний при оптимизации партиций. [#53405](https://github.com/ClickHouse/ClickHouse/pull/53405) ([Duc Canh Le](https://github.com/canhld94)).
* Добавлена настройка `allow_moving_table_directory_to_trash`, которая позволяет игнорировать ошибку `Directory for table data already exists` при репликации или восстановлении базы данных типа `Replicated`. [#53425](https://github.com/ClickHouse/ClickHouse/pull/53425) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Если серверные настройки `asynchronous_metrics_update_period_s` и `asynchronous_heavy_metrics_update_period_s` ошибочно установлены в 0, это теперь приведёт к штатной обработке ошибки, а не к аварийному завершению приложения. [#53428](https://github.com/ClickHouse/ClickHouse/pull/53428) ([Robert Schulze](https://github.com/rschu1ze)).
* Сервер ClickHouse теперь учитывает ограничения памяти, изменённые с помощью cgroups, при перезагрузке конфигурации. [#53455](https://github.com/ClickHouse/ClickHouse/pull/53455) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена возможность отключать выполнение `flush` для Distributed-таблиц при операциях `DETACH`, `DROP` или при остановке сервера. [#53501](https://github.com/ClickHouse/ClickHouse/pull/53501) ([Azat Khuzhin](https://github.com/azat)).
* Функция `domainRFC` теперь поддерживает адреса IPv6 в квадратных скобках. [#53506](https://github.com/ClickHouse/ClickHouse/pull/53506) ([Chen768959](https://github.com/Chen768959)).
* Использовать более длительный таймаут для запросов S3 CopyObject, которые используются при создании резервных копий. [#53533](https://github.com/ClickHouse/ClickHouse/pull/53533) ([Michael Kolupaev](https://github.com/al13n321)).
* Добавлена настройка сервера `aggregate_function_group_array_max_element_size`. Эта настройка используется для ограничения размера массива, возвращаемого функцией `groupArray`, при сериализации. Значение по умолчанию — `16777215`. [#53550](https://github.com/ClickHouse/ClickHouse/pull/53550) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `SCHEMA` был добавлен в качестве псевдонима для `DATABASE` для повышения совместимости с MySQL. [#53587](https://github.com/ClickHouse/ClickHouse/pull/53587) ([Daniël van Eeden](https://github.com/dveeden)).
* Добавлены асинхронные метрики для таблиц в системной базе данных, например `TotalBytesOfMergeTreeTablesSystem`. Тем самым закрыта задача [#53603](https://github.com/ClickHouse/ClickHouse/issues/53603). [#53604](https://github.com/ClickHouse/ClickHouse/pull/53604) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* SQL-редактор в интерфейсах Play и Dashboard больше не использует Grammarly. [#53614](https://github.com/ClickHouse/ClickHouse/pull/53614) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* В качестве настроек экспертного уровня теперь можно (1) настраивать параметр `size_ratio` (т.е. относительный размер защищённой очереди) для кэшей меток [index] и несжатого индекса, (2) настраивать политику кеша для кэшей меток индекса и несжатого индекса. [#53657](https://github.com/ClickHouse/ClickHouse/pull/53657) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена проверка информации о клиенте в пакет запроса TCPHandler. [#53673](https://github.com/ClickHouse/ClickHouse/pull/53673) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
* Повторять загрузку частей в случае сетевых ошибок при работе с Microsoft Azure. [#53750](https://github.com/ClickHouse/ClickHouse/pull/53750) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Стек трассировки для исключений, исключения из материализованных представлений теперь пробрасываются дальше. [#53766](https://github.com/ClickHouse/ClickHouse/pull/53766) ([Ilya Golshtein](https://github.com/ilejn)).
* Если имя хоста или порт не были указаны, клиент Keeper попытается найти строку подключения в файле ClickHouse config.xml. [#53769](https://github.com/ClickHouse/ClickHouse/pull/53769) ([pufit](https://github.com/pufit)).
* Добавлено профильное событие `PartsLockMicroseconds`, отражающее количество микросекунд, в течение которых удерживается блокировка частей данных в семействе движков таблиц MergeTree. [#53797](https://github.com/ClickHouse/ClickHouse/pull/53797) ([alesapin](https://github.com/alesapin)).
* Сделан настраиваемым лимит числа попыток переподключения в RAFT для keeper. Этот параметр конфигурации может помочь keeper быстрее восстанавливать соединение с пирами при обрыве текущего соединения. [#53817](https://github.com/ClickHouse/ClickHouse/pull/53817) ([Pengyuan Bian](https://github.com/bianpengyuan)).
* Игнорировать внешние ключи в определениях таблиц, чтобы повысить совместимость с MySQL и избавить пользователя от необходимости переписывать часть SQL, связанную с внешними ключами, см. [#53380](https://github.com/ClickHouse/ClickHouse/issues/53380). [#53864](https://github.com/ClickHouse/ClickHouse/pull/53864) ([jsc0218](https://github.com/jsc0218)).



#### Улучшение сборки/тестирования/упаковки {#buildtestingpackaging-improvement-4}

* Не экспортировать символы бинарного файла ClickHouse для динамического линковщика. Это может исправить [#43933](https://github.com/ClickHouse/ClickHouse/issues/43933). [#47475](https://github.com/ClickHouse/ClickHouse/pull/47475) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена символьная ссылка `clickhouse-keeper-client` в пакет clickhouse-server. [#51882](https://github.com/ClickHouse/ClickHouse/pull/51882) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Добавить [https://github.com/elliotchance/sqltest](https://github.com/elliotchance/sqltest) в CI для отчётности о соответствии стандарту SQL:2016. [#52293](https://github.com/ClickHouse/ClickHouse/pull/52293) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Обновить PRQL до версии 0.9.3. [#53060](https://github.com/ClickHouse/ClickHouse/pull/53060) ([Maximilian Roos](https://github.com/max-sixty)).
* Системные таблицы, полученные при CI-проверках, экспортируются в ClickHouse Cloud. [#53086](https://github.com/ClickHouse/ClickHouse/pull/53086) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Данные профилирования компилятора (`-ftime-trace`) загружаются в ClickHouse Cloud. [#53100](https://github.com/ClickHouse/ClickHouse/pull/53100) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Ускорены сборки Debug и Tidy. [#53178](https://github.com/ClickHouse/ClickHouse/pull/53178) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Ускорена сборка за счёт удаления огромного количества мусора. Один из часто подключаемых заголовочных файлов был «отравлен» Boost. [#53180](https://github.com/ClickHouse/ClickHouse/pull/53180) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Удалено ещё больше лишнего. [#53182](https://github.com/ClickHouse/ClickHouse/pull/53182) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Функция `arrayAUC` использовала тяжёлые шаблоны C++, от которых отказались. [#53183](https://github.com/ClickHouse/ClickHouse/pull/53183) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Некоторые единицы трансляции всегда перестраивались независимо от использования ccache. Причина найдена и исправлена. [#53184](https://github.com/ClickHouse/ClickHouse/pull/53184) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Профильные данные компилятора (`-ftime-trace`) загружаются в ClickHouse Cloud; вторая попытка после [#53100](https://github.com/ClickHouse/ClickHouse/issues/53100). [#53213](https://github.com/ClickHouse/ClickHouse/pull/53213) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Экспорт логов CI из stateful-тестов в ClickHouse Cloud. [#53351](https://github.com/ClickHouse/ClickHouse/pull/53351) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Экспорт логов CI при стресс-тестах. [#53353](https://github.com/ClickHouse/ClickHouse/pull/53353) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Экспорт логов из CI в fuzzer. [#53354](https://github.com/ClickHouse/ClickHouse/pull/53354) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сохраняет параметры окружения при выполнении команды `clickhouse start`. Исправляет [#51962](https://github.com/ClickHouse/ClickHouse/issues/51962). [#53418](https://github.com/ClickHouse/ClickHouse/pull/53418) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Продолжение к [#53418](https://github.com/ClickHouse/ClickHouse/issues/53418). Небольшие улучшения install&#95;check.py, добавлены тесты для корректной передачи параметров окружения (ENV) в основной процесс при запуске через `init.d start`. [#53457](https://github.com/ClickHouse/ClickHouse/pull/53457) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Реорганизовать работу с файлами в CMake, чтобы избежать возможного дублирования. Например, `indexHint.cpp` дублируется как в `dbms_sources`, так и в `clickhouse_functions_sources`. [#53621](https://github.com/ClickHouse/ClickHouse/pull/53621) ([Amos Bird](https://github.com/amosbird)).
* Обновлён snappy до версии 1.1.10. [#53672](https://github.com/ClickHouse/ClickHouse/pull/53672) ([李扬](https://github.com/taiyang-li)).
* Незначительно улучшена сборка CMake: очищены некоторые зависимости и удалены дубликаты. Каждый коммит содержит краткое описание внесённых изменений. [#53759](https://github.com/ClickHouse/ClickHouse/pull/53759) ([Amos Bird](https://github.com/amosbird)).



#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-4}

* Не сбрасывать (экспериментальный) индекс Annoy во время построения, если имеется более одной метки [#51325](https://github.com/ClickHouse/ClickHouse/pull/51325) ([Tian Xinhui](https://github.com/xinhuitian)).
* Исправлено использование временных каталогов при выполнении RESTORE [#51493](https://github.com/ClickHouse/ClickHouse/pull/51493) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа двоичной арифметики для Nullable(IPv4) [#51642](https://github.com/ClickHouse/ClickHouse/pull/51642) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Поддержка типов данных IPv4 и IPv6 в качестве атрибутов словарей [#51756](https://github.com/ClickHouse/ClickHouse/pull/51756) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправление контрольной суммы маркеров сжатия [#51777](https://github.com/ClickHouse/ClickHouse/pull/51777) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлен ошибочный разбор запятой как части значения datetime при разборе CSV в режиме best effort [#51950](https://github.com/ClickHouse/ClickHouse/pull/51950) ([Kruglov Pavel](https://github.com/Avogar)).
* Не выбрасывать исключение при наличии параметров у исполняемой UDF [#51961](https://github.com/ClickHouse/ClickHouse/pull/51961) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлен перерасчёт пропускающих индексов и проекций в запросах `ALTER DELETE` [#52530](https://github.com/ClickHouse/ClickHouse/pull/52530) ([Anton Popov](https://github.com/CurtizJ)).
* MaterializedMySQL: Исправлен бесконечный цикл в ReadBuffer::read [#52621](https://github.com/ClickHouse/ClickHouse/pull/52621) ([Val Doroshchuk](https://github.com/valbok)).
* Загружать подсказки только с использованием диалекта `clickhouse` [#52628](https://github.com/ClickHouse/ClickHouse/pull/52628) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Инициализировать и уничтожать канал ares по требованию. [#52634](https://github.com/ClickHouse/ClickHouse/pull/52634) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлена фильтрация по виртуальным столбцам с использованием оператора OR [#52653](https://github.com/ClickHouse/ClickHouse/pull/52653) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, приводившая к аварийному завершению работы функции `tuple` при использовании одного разреженного столбца в качестве аргумента [#52659](https://github.com/ClickHouse/ClickHouse/pull/52659) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена работа именованных коллекций в кластере [#52687](https://github.com/ClickHouse/ClickHouse/pull/52687) ([Al Korgun](https://github.com/alkorgun)).
* Исправлено чтение лишнего столбца в случае многоступенчатого `PREWHERE` [#52689](https://github.com/ClickHouse/ClickHouse/pull/52689) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен неожиданный результат сортировки по нескольким столбцам с вариантом размещения NULL-значений сначала (NULLS FIRST) [#52761](https://github.com/ClickHouse/ClickHouse/pull/52761) ([copperybean](https://github.com/copperybean)).
* Исправлена гонка данных при перенастройке Keeper [#52804](https://github.com/ClickHouse/ClickHouse/pull/52804) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена сортировка разреженных столбцов с большим значением `LIMIT` [#52827](https://github.com/ClickHouse/ClickHouse/pull/52827) ([Anton Popov](https://github.com/CurtizJ)).
* clickhouse-keeper: исправлена реализация сервера с использованием poll. [#52833](https://github.com/ClickHouse/ClickHouse/pull/52833) ([Andy Fiddaman](https://github.com/citrus-it)).
* Анализатор regexp теперь распознаёт именованные группы захвата [#52840](https://github.com/ClickHouse/ClickHouse/pull/52840) ([Han Fei](https://github.com/hanfei1991)).
* Исправлен возможный assert в `~PushingAsyncPipelineExecutor` в clickhouse-local [#52862](https://github.com/ClickHouse/ClickHouse/pull/52862) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено чтение пустого `Nested(Array(LowCardinality(...)))` [#52949](https://github.com/ClickHouse/ClickHouse/pull/52949) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлены новые тесты для session&#95;log и исправлено несоответствие между входом и выходом из системы. [#52958](https://github.com/ClickHouse/ClickHouse/pull/52958) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
* Исправлена утечка пароля в выводе `SHOW CREATE TABLE` для MySQL [#52962](https://github.com/ClickHouse/ClickHouse/pull/52962) ([Duc Canh Le](https://github.com/canhld94)).
* Преобразование разреженного формата столбца в полный в CreateSetAndFilterOnTheFlyStep [#53000](https://github.com/ClickHouse/ClickHouse/pull/53000) ([vdimir](https://github.com/vdimir)).
* Исправлено редкое состояние гонки при удалении каталога в fs cache с пустым префиксом ключа [#53055](https://github.com/ClickHouse/ClickHouse/pull/53055) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проблема, из-за которой ZstdDeflatingWriteBuffer иногда усекал выходные данные [#53064](https://github.com/ClickHouse/ClickHouse/pull/53064) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлено поле `query_id` в `part_log` при асинхронном сбросе запросов [#53103](https://github.com/ClickHouse/ClickHouse/pull/53103) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена возможная ошибка из кэша «Read unexpected size» [#53121](https://github.com/ClickHouse/ClickHouse/pull/53121) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отключён новый кодировщик формата Parquet [#53130](https://github.com/ClickHouse/ClickHouse/pull/53130) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено исключение «Not-ready Set» [#53162](https://github.com/ClickHouse/ClickHouse/pull/53162) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено экранирование символов в движке PostgreSQL [#53250](https://github.com/ClickHouse/ClickHouse/pull/53250) ([Nikolay Degterinsky](https://github.com/evillique)).
* Экспериментальная таблица session&#95;log: добавлены новые тесты для session&#95;log и устранено несоответствие между входом в систему и выходом из неё. [#53255](https://github.com/ClickHouse/ClickHouse/pull/53255) ([Alexey Gerasimchuck](https://github.com/Demilivor)). Устранено несоответствие между успешным входом в систему и выходом из неё [#53302](https://github.com/ClickHouse/ClickHouse/pull/53302) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
* Исправлено добавление интервалов с долями секунды к DateTime [#53309](https://github.com/ClickHouse/ClickHouse/pull/53309) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена ошибка «Context has expired» в словарях [#53342](https://github.com/ClickHouse/ClickHouse/pull/53342) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлен некорректный формат AST NORMAL-проекции [#53347](https://github.com/ClickHouse/ClickHouse/pull/53347) ([Amos Bird](https://github.com/amosbird)).
* Запрещено использование параметра use&#95;structure&#95;from&#95;insertion&#95;table&#95;in&#95;table&#95;functions при выполнении Scalar [#53348](https://github.com/ClickHouse/ClickHouse/pull/53348) ([flynn](https://github.com/ucasfl)).
* Исправлена загрузка «ленивой» базы данных во время выполнения запроса SELECT к таблице system.table [#53372](https://github.com/ClickHouse/ClickHouse/pull/53372) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлены `system.data_skipping_indices` для MaterializedMySQL [#53381](https://github.com/ClickHouse/ClickHouse/pull/53381) ([Filipp Ozinov](https://github.com/bakwc)).
* Исправлена обработка одиночного символа возврата каретки в движке сегментации файлов TSV [#53407](https://github.com/ClickHouse/ClickHouse/pull/53407) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка `Context has expired` [#53433](https://github.com/ClickHouse/ClickHouse/pull/53433) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена работа `timeout_overflow_mode` при наличии подзапроса в правой части выражения IN [#53439](https://github.com/ClickHouse/ClickHouse/pull/53439) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлено неожиданное поведение в [#53152](https://github.com/ClickHouse/ClickHouse/issues/53152) [#53440](https://github.com/ClickHouse/ClickHouse/pull/53440) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
* Исправлена ошибка разбора функции JSON&#95;QUERY, возникающая, если путь состоит только из цифр [#53470](https://github.com/ClickHouse/ClickHouse/pull/53470) ([KevinyhZou](https://github.com/KevinyhZou)).
* Исправлен некорректный порядок столбцов для запросов с параллельным FINAL. [#53489](https://github.com/ClickHouse/ClickHouse/pull/53489) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена выборка (SELECT) из ReplacingMergeTree при использовании do&#95;not&#95;merge&#95;across&#95;partitions&#95;select&#95;final [#53511](https://github.com/ClickHouse/ClickHouse/pull/53511) ([Vasily Nemkov](https://github.com/Enmk)).
* Сначала очищать очередь асинхронных вставок при завершении работы [#53547](https://github.com/ClickHouse/ClickHouse/pull/53547) ([joelynch](https://github.com/joelynch)).
* Исправлен сбой при выполнении JOIN по разреженному столбцу [#53548](https://github.com/ClickHouse/ClickHouse/pull/53548) ([vdimir](https://github.com/vdimir)).
* Исправлено возможное неопределённое поведение в пропускающем индексе Set для функций с некорректными аргументами [#53559](https://github.com/ClickHouse/ClickHouse/pull/53559) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено возможное неопределённое поведение (UB) в инвертированных индексах (экспериментальная функция) [#53560](https://github.com/ClickHouse/ClickHouse/pull/53560) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено: выражение `interpolate` берет исходный столбец вместо одноимённого столбца с алиасом из выражения `SELECT`. [#53572](https://github.com/ClickHouse/ClickHouse/pull/53572) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлено число отброшенных гранул в EXPLAIN PLAN index=1 [#53616](https://github.com/ClickHouse/ClickHouse/pull/53616) ([wangxiaobo](https://github.com/wzb5212)).
* Корректная обработка разделов TOTALS и EXTREMES с помощью `DelayedSource` [#53644](https://github.com/ClickHouse/ClickHouse/pull/53644) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено зависание кэша подготовленных наборов в конвейере мутаций [#53645](https://github.com/ClickHouse/ClickHouse/pull/53645) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка в мутациях с подколонками типа JSON в предикатах запросов UPDATE и DELETE. [#53677](https://github.com/ClickHouse/ClickHouse/pull/53677) ([VanDarkholme7](https://github.com/VanDarkholme7)).
* Исправлено проталкивание фильтров для соединения full&#95;sorting&#95;merge join [#53699](https://github.com/ClickHouse/ClickHouse/pull/53699) ([vdimir](https://github.com/vdimir)).
* Попытка исправить ошибку в `NULL::LowCardinality(Nullable(...)) NOT IN` [#53706](https://github.com/ClickHouse/ClickHouse/pull/53706) ([Andrey Zvonov](https://github.com/zvonand)).
* Исправление: сортированного DISTINCT с разрежёнными столбцами [#53711](https://github.com/ClickHouse/ClickHouse/pull/53711) ([Igor Nikonov](https://github.com/devcrafter)).
* `transform`: корректная обработка столбца по умолчанию с несколькими строками [#53742](https://github.com/ClickHouse/ClickHouse/pull/53742) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Исправлен сбой фаззера в функции parseDateTime [#53764](https://github.com/ClickHouse/ClickHouse/pull/53764) ([Robert Schulze](https://github.com/rschu1ze)).
* MaterializedPostgreSQL: исправлено неперехваченное исключение в getCreateTableQueryImpl [#53832](https://github.com/ClickHouse/ClickHouse/pull/53832) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена потенциальная ошибка сегментации при использовании движка PostgreSQL [#53847](https://github.com/ClickHouse/ClickHouse/pull/53847) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен алиас named&#95;collection&#95;admin [#54066](https://github.com/ClickHouse/ClickHouse/pull/54066) ([Kseniia Sumarokova](https://github.com/kssenii)).

### <a id="237"></a> Релиз ClickHouse 23.7, 2023-07-27 {#237}

#### Обратно несовместимое изменение {#backward-incompatible-change-5}
* Добавлен тип доступа `NAMED COLLECTION` (псевдонимы `USE NAMED COLLECTION`, `NAMED COLLECTION USAGE`). Этот PR обратно несовместим, потому что этот тип доступа по умолчанию отключен (так как родительский тип доступа `NAMED COLLECTION ADMIN` также по умолчанию отключен). Предложено в [#50277](https://github.com/ClickHouse/ClickHouse/issues/50277). Для выдачи прав используйте `GRANT NAMED COLLECTION ON collection_name TO user` или `GRANT NAMED COLLECTION ON * TO user`; чтобы иметь возможность выдавать эти права, в конфигурации требуется `named_collection_admin` (ранее он назывался `named_collection_control`, поэтому останется как псевдоним). [#50625](https://github.com/ClickHouse/ClickHouse/pull/50625) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена опечатка в названии столбца `system.parts` `last_removal_attemp_time`. Теперь он называется `last_removal_attempt_time`. [#52104](https://github.com/ClickHouse/ClickHouse/pull/52104) ([filimonov](https://github.com/filimonov)).
* По умолчанию увеличена версия `distributed_ddl_entry_format_version` до 5 (включает проброс OpenTelemetry и `initial_query_idd`). Это не позволит обрабатывать существующие записи для распределенного DDL после *понижения версии* (но обратите внимание, что обычно таких необработанных записей быть не должно). [#52128](https://github.com/ClickHouse/ClickHouse/pull/52128) ([Azat Khuzhin](https://github.com/azat)).
* Проверка метаданных проекций теперь выполняется так же, как проверка обычных метаданных. Это изменение может помешать запуску сервера в случае, если была таблица с некорректной проекцией. Пример — проекция, которая создала позиционные столбцы в PK (например, `projection p (select * order by 1, 4)`, что не допускается в PK таблицы и может вызвать сбой при вставке/слиянии). Удалите такие проекции до обновления. Исправляет [#52353](https://github.com/ClickHouse/ClickHouse/issues/52353). [#52361](https://github.com/ClickHouse/ClickHouse/pull/52361) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Экспериментальная функция `hashid` удалена из-за ошибки. Качество реализации было сомнительным с самого начала, и она так и не вышла из экспериментального статуса. Закрывает [#52406](https://github.com/ClickHouse/ClickHouse/issues/52406). [#52449](https://github.com/ClickHouse/ClickHouse/pull/52449) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### Новая возможность {#new-feature-5}

* Добавлен движок базы данных `Overlay` для объединения нескольких баз данных в одну. Добавлен движок базы данных `Filesystem` для представления каталога в файловой системе в виде набора неявно доступных таблиц с автоматически определяемыми форматами и структурами. Новый движок базы данных `S3` позволяет в режиме «только чтение» взаимодействовать с хранилищем S3, представляя префикс в виде набора таблиц. Новый движок базы данных `HDFS` позволяет взаимодействовать с хранилищем HDFS аналогичным образом. [#48821](https://github.com/ClickHouse/ClickHouse/pull/48821) ([alekseygolub](https://github.com/alekseygolub)).
* Добавлена поддержка внешних дисков в Keeper для хранения снепшотов и логов. [#50098](https://github.com/ClickHouse/ClickHouse/pull/50098) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена поддержка glob-шаблонов с фигурными скобками (`{}`) для выбора нескольких каталогов. [#50559](https://github.com/ClickHouse/ClickHouse/pull/50559) ([Andrey Zvonov](https://github.com/zvonand)).
* Коннектор Kafka может получать Avro-схему из реестра схем, защищённого базовой аутентификацией с использованием URL-кодированных учётных данных. [#49664](https://github.com/ClickHouse/ClickHouse/pull/49664) ([Ilya Golshtein](https://github.com/ilejn)).
* Добавлена функция `arrayJaccardIndex`, которая вычисляет коэффициент Жаккара между двумя массивами. [#50076](https://github.com/ClickHouse/ClickHouse/pull/50076) ([FFFFFFFHHHHHHH](https://github.com/FFFFFFFHHHHHHH)).
* В таблицу `system.settings` и аналогичные таблицы добавлен столбец `is_obsolete`. Закрывает [#50819](https://github.com/ClickHouse/ClickHouse/issues/50819). [#50826](https://github.com/ClickHouse/ClickHouse/pull/50826) ([flynn](https://github.com/ucasfl)).
* Реализована поддержка зашифрованных элементов в файле конфигурации. Добавлена возможность использовать зашифрованный текст в листовых элементах конфигурационного файла. Текст шифруется с использованием кодеков шифрования из раздела `<encryption_codecs>`. [#50986](https://github.com/ClickHouse/ClickHouse/pull/50986) ([Roman Vasin](https://github.com/rvasin)).
* Алгоритм Grace Hash Join теперь применим к операторам FULL и RIGHT JOIN. [#49483](https://github.com/ClickHouse/ClickHouse/issues/49483). [#51013](https://github.com/ClickHouse/ClickHouse/pull/51013) ([lgbo](https://github.com/lgbo-ustc)).
* Добавлен запрос `SYSTEM STOP LISTEN` для более корректного завершения работы. Закрывает [#47972](https://github.com/ClickHouse/ClickHouse/issues/47972). [#51016](https://github.com/ClickHouse/ClickHouse/pull/51016) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена опция `input_format_csv_allow_variable_number_of_columns`. [#51273](https://github.com/ClickHouse/ClickHouse/pull/51273) ([Dmitry Kardymon](https://github.com/kardymonds)).
* Ещё одна скучная фича: добавлена функция `substring_index`, как в Spark или MySQL. [#51472](https://github.com/ClickHouse/ClickHouse/pull/51472) ([李扬](https://github.com/taiyang-li)).
* Системная таблица `jemalloc_bins` для отображения статистики по бинам jemalloc. Пример: `SELECT *, size * (nmalloc - ndalloc) AS allocated_bytes FROM system.jemalloc_bins WHERE allocated_bytes > 0 ORDER BY allocated_bytes DESC LIMIT 10`. Пользуйтесь. [#51674](https://github.com/ClickHouse/ClickHouse/pull/51674) ([Alexander Gololobov](https://github.com/davenger)).
* Добавлен формат `RowBinaryWithDefaults`, в котором перед каждым столбцом добавляется дополнительный байт — флаг использования значения столбца по умолчанию. Закрывает [#50854](https://github.com/ClickHouse/ClickHouse/issues/50854). [#51695](https://github.com/ClickHouse/ClickHouse/pull/51695) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена настройка `default_temporary_table_engine`. Аналогична `default_table_engine`, но для временных таблиц. [#51292](https://github.com/ClickHouse/ClickHouse/issues/51292). [#51708](https://github.com/ClickHouse/ClickHouse/pull/51708) ([velavokr](https://github.com/velavokr)).
* Добавлены новые функции `initcap` / `initcapUTF8`, которые преобразуют первую букву каждого слова в верхний регистр, а остальные — в нижний. [#51735](https://github.com/ClickHouse/ClickHouse/pull/51735) ([Dmitry Kardymon](https://github.com/kardymonds)).
* CREATE TABLE теперь поддерживает синтаксис `PRIMARY KEY` в определении столбца. Столбцы добавляются в первичный индекс в том же порядке, в котором они определены. [#51881](https://github.com/ClickHouse/ClickHouse/pull/51881) ([Ilya Yatsishin](https://github.com/qoega)).
* Добавлена возможность использовать спецификаторы формата даты и времени в именах файлов журнала и журнала ошибок как в конфигурационных файлах (теги `log` и `errorlog`), так и в аргументах командной строки (`--log-file` и `--errorlog-file`). [#51945](https://github.com/ClickHouse/ClickHouse/pull/51945) ([Victor Krasnov](https://github.com/sirvickr)).
* В HTTP-заголовки добавлена статистика пикового потребления памяти. [#51946](https://github.com/ClickHouse/ClickHouse/pull/51946) ([Dmitry Kardymon](https://github.com/kardymonds)).
* Добавлены функции `hasSubsequence`, включая варианты `CaseInsensitive` и `UTF8`, для поиска подпоследовательностей в строках. [#52050](https://github.com/ClickHouse/ClickHouse/pull/52050) ([Dmitry Kardymon](https://github.com/kardymonds)).
* Добавлен `array_agg` как синоним `groupArray` для совместимости с PostgreSQL. Закрывает [#52100](https://github.com/ClickHouse/ClickHouse/issues/52100). ### Запись в документации об изменениях, видимых пользователю. [#52135](https://github.com/ClickHouse/ClickHouse/pull/52135) ([flynn](https://github.com/ucasfl)).
* Добавлен псевдоним совместимости `any_value` для агрегатной функции `any`. Закрывает [#52140](https://github.com/ClickHouse/ClickHouse/issues/52140). [#52147](https://github.com/ClickHouse/ClickHouse/pull/52147) ([flynn](https://github.com/ucasfl)).
* Добавлена агрегатная функция `array_concat_agg` для совместимости с BigQuery, она является синонимом `groupArrayArray`. Закрывает [#52139](https://github.com/ClickHouse/ClickHouse/issues/52139). [#52149](https://github.com/ClickHouse/ClickHouse/pull/52149) ([flynn](https://github.com/ucasfl)).
* Добавлен псевдоним `OCTET_LENGTH` для `length`. Закрывает [#52153](https://github.com/ClickHouse/ClickHouse/issues/52153). [#52176](https://github.com/ClickHouse/ClickHouse/pull/52176) ([FFFFFFFHHHHHHH](https://github.com/FFFFFFFHHHHHHH)).
* Добавлена функция `firstLine` для извлечения первой строки из многострочного текста. Тем самым закрывается [#51172](https://github.com/ClickHouse/ClickHouse/issues/51172). [#52209](https://github.com/ClickHouse/ClickHouse/pull/52209) ([Mikhail Koviazin](https://github.com/mkmkme)).
* Реализовано форматирование в стиле KQL для типа данных `Interval`. Это требуется только для совместимости с языком запросов `Kusto`. [#45671](https://github.com/ClickHouse/ClickHouse/pull/45671) ([ltrk2](https://github.com/ltrk2)).
* Добавлен запрос `SYSTEM FLUSH ASYNC INSERT QUEUE`, который сбрасывает все ожидающие асинхронные вставки в целевые таблицы. Добавлена серверная настройка `async_insert_queue_flush_on_shutdown` (по умолчанию `true`), которая определяет, нужно ли сбрасывать очередь асинхронных вставок при корректном завершении работы. Настройка `async_insert_threads` теперь является серверной настройкой. [#49160](https://github.com/ClickHouse/ClickHouse/pull/49160) ([Anton Popov](https://github.com/CurtizJ)).
* Псевдонимы `current_database` и новая функция `current_schemas` для совместимости с PostgreSQL. [#51076](https://github.com/ClickHouse/ClickHouse/pull/51076) ([Pedro Riera](https://github.com/priera)).
* Добавлены псевдонимы для функций `today` (теперь также доступна под именами `curdate`/`current_date`) и `now` (под именем `current_timestamp`). [#52106](https://github.com/ClickHouse/ClickHouse/pull/52106) ([Lloyd-Pottiger](https://github.com/Lloyd-Pottiger)).
* Добавлена поддержка `async_deduplication_token` для асинхронной вставки. [#52136](https://github.com/ClickHouse/ClickHouse/pull/52136) ([Han Fei](https://github.com/hanfei1991)).
* Добавлена новая настройка `disable_url_encoding`, которая позволяет отключить кодирование и декодирование пути в URI в движке URL. [#52337](https://github.com/ClickHouse/ClickHouse/pull/52337) ([Kruglov Pavel](https://github.com/Avogar)).



#### Повышение производительности {#performance-improvement-5}

* Включить автоматический выбор разреженного формата сериализации по умолчанию. Это улучшает производительность. Формат поддерживается, начиная с версии 22.1. После этого изменения откат на версии ниже 22.1 может быть невозможен. Для отката может потребоваться установить `ratio_of_defaults_for_sparse_serialization=0.9375` [55153](https://github.com/ClickHouse/ClickHouse/issues/55153). Вы можете отключить использование разреженного формата сериализации, задав настройку `ratio_of_defaults_for_sparse_serialization = 1` для ваших таблиц MergeTree. [#49631](https://github.com/ClickHouse/ClickHouse/pull/49631) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Включены параметры `move_all_conditions_to_prewhere` и `enable_multiple_prewhere_read_steps` по умолчанию. [#46365](https://github.com/ClickHouse/ClickHouse/pull/46365) ([Alexander Gololobov](https://github.com/davenger)).
* Улучшает производительность некоторых запросов за счёт настройки аллокатора памяти. [#46416](https://github.com/ClickHouse/ClickHouse/pull/46416) ([Azat Khuzhin](https://github.com/azat)).
* Теперь в `MergeTreePrefetchedReadPool` используются задачи фиксированного размера, аналогично `MergeTreeReadPool`. Кроме того, для запросов к S3 теперь используется пул подключений. [#49732](https://github.com/ClickHouse/ClickHouse/pull/49732) ([Nikita Taranov](https://github.com/nickitat)).
* Расширено проталкивание условий на правую сторону соединения. [#50532](https://github.com/ClickHouse/ClickHouse/pull/50532) ([Nikita Taranov](https://github.com/nickitat)).
* Улучшено соединение grace&#95;hash за счёт резервирования размера хеш-таблицы (повторная отправка). [#50875](https://github.com/ClickHouse/ClickHouse/pull/50875) ([lgbo](https://github.com/lgbo-ustc)).
* Ожидание блокировки в `OpenedFileCache` иногда заметно сказывалось. Мы шардировали его на несколько подотображений (каждое со своей блокировкой), чтобы уменьшить конкуренцию за блокировку. [#51341](https://github.com/ClickHouse/ClickHouse/pull/51341) ([Nikita Taranov](https://github.com/nickitat)).
* Перемещайте условия со столбцами первичного ключа (PK) в конец цепочки PREWHERE. Идея в том, что условия со столбцами PK, скорее всего, будут использоваться в PK-анализе и не дадут заметного дополнительного эффекта для фильтрации PREWHERE. [#51958](https://github.com/ClickHouse/ClickHouse/pull/51958) ([Alexander Gololobov](https://github.com/davenger)).
* Ускорена операция `COUNT(DISTINCT)` для типов String за счёт инлайнинга SipHash. Эксперименты по производительности *OnTime* на устройстве ICX (процессор Intel Xeon Platinum 8380, 80 ядер, 160 потоков) показывают, что это изменение даёт улучшение *на 11.6%* по QPS запроса *Q8* без влияния на другие запросы. [#52036](https://github.com/ClickHouse/ClickHouse/pull/52036) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
* По умолчанию включена настройка `allow_vertical_merges_from_compact_to_wide_parts`. Это снижает потребление памяти во время слияний. [#52295](https://github.com/ClickHouse/ClickHouse/pull/52295) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлен некорректный анализ проекций, который делал первичные ключи недействительными. Эта проблема возникала только при `query_plan_optimize_primary_key = 1, query_plan_optimize_projection = 1`. Исправлена ошибка [#48823](https://github.com/ClickHouse/ClickHouse/issues/48823). Исправлена ошибка [#51173](https://github.com/ClickHouse/ClickHouse/issues/51173). [#52308](https://github.com/ClickHouse/ClickHouse/pull/52308) ([Amos Bird](https://github.com/amosbird)).
* Уменьшено количество системных вызовов в `FileCache::loadMetadata` — это ускоряет запуск сервера, если настроен кэш файловой системы. [#52435](https://github.com/ClickHouse/ClickHouse/pull/52435) ([Raúl Marín](https://github.com/Algunenano)).
* Позволяет задать строгую нижнюю границу размера файлового сегмента за счёт догрузки оставшихся данных в фоновом режиме. Минимальный размер файлового сегмента (если фактический размер файла больше) задаётся параметром конфигурации кэша `boundary_alignment`, по умолчанию `4Mi`. Количество фоновых потоков загрузки настраивается параметром конфигурации кэша `background_download_threads`, по умолчанию `2`. Также `max_file_segment_size` был увеличен с `8Mi` до `32Mi` в этом PR. [#51000](https://github.com/ClickHouse/ClickHouse/pull/51000) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Уменьшены значения таймаутов по умолчанию для S3 с 30 до 3 секунд, а для прочих HTTP-запросов — со 180 до 30 секунд. [#51171](https://github.com/ClickHouse/ClickHouse/pull/51171) ([Michael Kolupaev](https://github.com/al13n321)).
* Добавлена новая настройка `merge_tree_determine_task_size_by_prewhere_columns`. Если установлена в значение `true`, при определении размера задания на чтение будут учитываться только размеры столбцов из секции `PREWHERE`. В противном случае учитываются все столбцы из запроса. [#52606](https://github.com/ClickHouse/ClickHouse/pull/52606) ([Nikita Taranov](https://github.com/nickitat)).



#### Улучшение {#improvement-5}

* Используйте read&#95;bytes/total&#95;bytes&#95;to&#95;read для индикатора выполнения в табличных функциях s3/file/url/... для более наглядного отображения прогресса. [#51286](https://github.com/ClickHouse/ClickHouse/pull/51286) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена настройка таблицы `wait_for_unique_parts_send_before_shutdown_ms`, которая задаёт время, в течение которого реплика будет ждать перед закрытием межсерверного обработчика для реплицированных отправок. Также исправлена несогласованность в порядке завершения работы таблиц и межсерверных обработчиков: теперь сервер сначала завершает работу таблиц и только после этого останавливает межсерверные обработчики. [#51851](https://github.com/ClickHouse/ClickHouse/pull/51851) ([alesapin](https://github.com/alesapin)).
* Разрешено использование оператора `FETCH` стандарта SQL без `OFFSET`. См. [https://antonz.org/sql-fetch/](https://antonz.org/sql-fetch/). [#51293](https://github.com/ClickHouse/ClickHouse/pull/51293) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность фильтрации HTTP-заголовков для табличных функций URL/S3 с помощью нового раздела `http_forbid_headers` в конфигурации. Доступны как точное соответствие, так и фильтры на основе регулярных выражений. [#51038](https://github.com/ClickHouse/ClickHouse/pull/51038) ([Nikolay Degterinsky](https://github.com/evillique)).
* Не отображать в логах сообщения о `16 EiB` свободного места, так как они не имеют смысла. Это закрывает [#49320](https://github.com/ClickHouse/ClickHouse/issues/49320). [#49342](https://github.com/ClickHouse/ClickHouse/pull/49342) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена проверка ограничения для функции `sleepEachRow`. Добавлена настройка `function_sleep_max_microseconds_per_block`. Это необходимо для универсального фаззера запросов. [#49343](https://github.com/ClickHouse/ClickHouse/pull/49343) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлены две ошибки в функциях `geoHash`. [#50066](https://github.com/ClickHouse/ClickHouse/pull/50066) ([李扬](https://github.com/taiyang-li)).
* Логировать запросы сброса асинхронных вставок в `system.query_log`. [#51160](https://github.com/ClickHouse/ClickHouse/pull/51160) ([Raúl Marín](https://github.com/Algunenano)).
* Функции `date_diff` и `age` теперь поддерживают единицы измерения миллисекунды и микросекунды и работают с микросекундной точностью. [#51291](https://github.com/ClickHouse/ClickHouse/pull/51291) ([Dmitry Kardymon](https://github.com/kardymonds)).
* Улучшен парсинг пути в clickhouse-keeper-client. [#51359](https://github.com/ClickHouse/ClickHouse/pull/51359) ([Azat Khuzhin](https://github.com/azat)).
* В стороннем продукте, который зависит от ClickHouse (Gluten: плагин для двукратного увеличения производительности Spark SQL), была ошибка. Это исправление позволяет избежать переполнения кучи в этом стороннем продукте при чтении из HDFS. [#51386](https://github.com/ClickHouse/ClickHouse/pull/51386) ([李扬](https://github.com/taiyang-li)).
* Добавлена возможность отключить нативное копирование для S3 (настройка для BACKUP/RESTORE `allow_s3_native_copy` и `s3_allow_native_copy` для дисков `s3`/`s3_plain`). [#51448](https://github.com/ClickHouse/ClickHouse/pull/51448) ([Azat Khuzhin](https://github.com/azat)).
* Добавлен столбец `primary_key_size` в таблицу `system.parts`, отображающий сжатый размер первичного ключа на диске. Закрывает [#51400](https://github.com/ClickHouse/ClickHouse/issues/51400). [#51496](https://github.com/ClickHouse/ClickHouse/pull/51496) ([Yarik Briukhovetskyi](https://github.com/yariks5s)).
* Позволяет запускать `clickhouse-local` без procfs, без домашнего каталога и без плагинов разрешения имён из glibc. [#51518](https://github.com/ClickHouse/ClickHouse/pull/51518) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен плейсхолдер `%a` для полного имени файла в настройке rename&#95;files&#95;after&#95;processing. [#51603](https://github.com/ClickHouse/ClickHouse/pull/51603) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен столбец `modification_time` в таблицу `system.parts_columns`. [#51685](https://github.com/ClickHouse/ClickHouse/pull/51685) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена новая настройка `input_format_csv_use_default_on_bad_values` для формата CSV, которая позволяет вставлять значение по умолчанию, если разбор отдельного поля не удался. [#51716](https://github.com/ClickHouse/ClickHouse/pull/51716) ([KevinyhZou](https://github.com/KevinyhZou)).
* Добавлена принудительная запись журнала аварий на диск после непредвиденного сбоя. [#51720](https://github.com/ClickHouse/ClickHouse/pull/51720) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
* Исправлено поведение на странице дашборда, при котором ошибки, не связанные с аутентификацией, не отображались. Также исправлено поведение диаграммы в режиме «overlapping». [#51744](https://github.com/ClickHouse/ClickHouse/pull/51744) ([Zach Naimon](https://github.com/ArctypeZach)).
* Добавлено преобразование UUID в UInt128. [#51765](https://github.com/ClickHouse/ClickHouse/pull/51765) ([Dmitry Kardymon](https://github.com/kardymonds)).
* Добавлена поддержка функции `range` для аргументов типа Nullable. [#51767](https://github.com/ClickHouse/ClickHouse/pull/51767) ([Dmitry Kardymon](https://github.com/kardymonds)).
* Условия вида `toyear(x) = c` теперь преобразуются в `c1 <= x < c2`. [#51795](https://github.com/ClickHouse/ClickHouse/pull/51795) ([Han Fei](https://github.com/hanfei1991)).
* Улучшена совместимость оператора `SHOW INDEX` с MySQL. [#51796](https://github.com/ClickHouse/ClickHouse/pull/51796) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена проблема, из-за которой `use_structure_from_insertion_table_in_table_functions` не работала со столбцами `MATERIALIZED` и `ALIAS`. Закрывает [#51817](https://github.com/ClickHouse/ClickHouse/issues/51817). Закрывает [#51019](https://github.com/ClickHouse/ClickHouse/issues/51019). [#51825](https://github.com/ClickHouse/ClickHouse/pull/51825) ([flynn](https://github.com/ucasfl)).
* Кэширующий словарь теперь запрашивает только уникальные ключи из источника. Закрывает [#51762](https://github.com/ClickHouse/ClickHouse/issues/51762). [#51853](https://github.com/ClickHouse/ClickHouse/pull/51853) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена проблема, при которой настройки не применялись для запроса EXPLAIN при указании FORMAT. [#51859](https://github.com/ClickHouse/ClickHouse/pull/51859) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлена возможность указывать SETTINGS перед FORMAT в запросе DESCRIBE TABLE для совместимости с запросом SELECT. Закрывает [#51544](https://github.com/ClickHouse/ClickHouse/issues/51544). [#51899](https://github.com/ClickHouse/ClickHouse/pull/51899) ([Nikolay Degterinsky](https://github.com/evillique)).
* Целые числа, кодируемые с помощью VarInt (например, используемого нативным протоколом), теперь могут использовать весь 64-битный диапазон значений. Сторонним клиентам рекомендуется обновить свой код работы с VarInt соответствующим образом. [#51905](https://github.com/ClickHouse/ClickHouse/pull/51905) ([Robert Schulze](https://github.com/rschu1ze)).
* Сертификаты обновляются при их изменении без необходимости вручную выполнять SYSTEM RELOAD CONFIG. [#52030](https://github.com/ClickHouse/ClickHouse/pull/52030) ([Mike Kot](https://github.com/myrrc)).
* Добавлена настройка `allow_create_index_without_type`, позволяющая игнорировать запросы `ADD INDEX` без указанного `TYPE`. Стандартные SQL-запросы будут успешно выполняться без изменения схемы таблицы. [#52056](https://github.com/ClickHouse/ClickHouse/pull/52056) ([Ilya Yatsishin](https://github.com/qoega)).
* Сообщения журнала записываются в `system.text_log` с момента запуска сервера. [#52113](https://github.com/ClickHouse/ClickHouse/pull/52113) ([Dmitry Kardymon](https://github.com/kardymonds)).
* Если HTTP-эндпоинт имеет несколько IP-адресов и первый из них недоступен, возникало исключение по таймауту. Реализовано создание сессии с обработкой всех разрешённых IP-адресов. [#52116](https://github.com/ClickHouse/ClickHouse/pull/52116) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Формат ввода Avro теперь поддерживает тип Union даже если он содержит только один тип. Закрывает [#52131](https://github.com/ClickHouse/ClickHouse/issues/52131). [#52137](https://github.com/ClickHouse/ClickHouse/pull/52137) ([flynn](https://github.com/ucasfl)).
* Добавлена настройка `optimize_use_implicit_projections` для отключения неявных проекций (на текущий момент — только проекции `min_max_count`). [#52152](https://github.com/ClickHouse/ClickHouse/pull/52152) ([Amos Bird](https://github.com/amosbird)).
* Ранее функцию `hasToken` можно было использовать для создания бесконечного цикла. Теперь эта возможность устранена. Это закрывает [#52156](https://github.com/ClickHouse/ClickHouse/issues/52156). [#52160](https://github.com/ClickHouse/ClickHouse/pull/52160) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Оптимистичное создание узлов-предков в ZK. [#52195](https://github.com/ClickHouse/ClickHouse/pull/52195) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена проблема из [#50582](https://github.com/ClickHouse/ClickHouse/issues/50582). Устранена ошибка `Not found column ... in block` в некоторых случаях при упорядоченном чтении и работе с константами. [#52259](https://github.com/ClickHouse/ClickHouse/pull/52259) ([Chen768959](https://github.com/Chen768959)).
* Проверять, являются ли геопримитивы S2 некорректными, как можно раньше на стороне ClickHouse. Это закрывает: [#27090](https://github.com/ClickHouse/ClickHouse/issues/27090). [#52260](https://github.com/ClickHouse/ClickHouse/pull/52260) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Возвращён отсутствующий projection QueryAccessInfo при `query_plan_optimize_projection = 1`, что исправляет [#50183](https://github.com/ClickHouse/ClickHouse/issues/50183). Это также исправляет [#50093](https://github.com/ClickHouse/ClickHouse/issues/50093). [#52327](https://github.com/ClickHouse/ClickHouse/pull/52327) ([Amos Bird](https://github.com/amosbird)).
* Когда `ZooKeeperRetriesControl` повторно выбрасывает ошибку, гораздо полезнее видеть её исходный стек-трейс, а не тот, который формируется в самом `ZooKeeperRetriesControl`. [#52347](https://github.com/ClickHouse/ClickHouse/pull/52347) ([Vitaly Baranov](https://github.com/vitlibar)).
* Ожидать блокировку zero-copy репликации, даже если некоторые диски её не поддерживают. [#52376](https://github.com/ClickHouse/ClickHouse/pull/52376) ([Raúl Marín](https://github.com/Algunenano)).
* Теперь межсерверный порт будет закрываться только после остановки таблиц. [#52498](https://github.com/ClickHouse/ClickHouse/pull/52498) ([alesapin](https://github.com/alesapin)).

#### Экспериментальная возможность {#experimental-feature-2}
* Запись файлов Parquet выполняется в 10 раз быстрее, теперь она многопоточная. Скорость почти такая же, как у чтения. [#49367](https://github.com/ClickHouse/ClickHouse/pull/49367) ([Michael Kolupaev](https://github.com/al13n321)). Это управляется настройкой `output_format_parquet_use_custom_encoder`, которая по умолчанию отключена, поскольку возможность пока реализована неидеально.
* Добавлена поддержка [PRQL](https://prql-lang.org/) как языка запросов. [#50686](https://github.com/ClickHouse/ClickHouse/pull/50686) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Разрешено указывать имя диска для пользовательских дисков. Ранее пользовательские диски использовали внутренне сгенерированное имя диска. Теперь это можно сделать с помощью `disk = disk_<name>(...)` (например, диск будет иметь имя `name`). [#51552](https://github.com/ClickHouse/ClickHouse/pull/51552) ([Kseniia Sumarokova](https://github.com/kssenii)). Этот синтаксис может быть изменён в этом релизе.
* (экспериментальный MaterializedMySQL) Исправлен сбой при использовании `mysqlxx::Pool::Entry` после его отключения. [#52063](https://github.com/ClickHouse/ClickHouse/pull/52063) ([Val Doroshchuk](https://github.com/valbok)).
* (экспериментальный MaterializedMySQL) `CREATE TABLE ... AS SELECT` теперь поддерживается в MaterializedMySQL. [#52067](https://github.com/ClickHouse/ClickHouse/pull/52067) ([Val Doroshchuk](https://github.com/valbok)).
* (экспериментальный MaterializedMySQL) Введена автоматическая конверсия текстовых типов в UTF-8 для MaterializedMySQL. [#52084](https://github.com/ClickHouse/ClickHouse/pull/52084) ([Val Doroshchuk](https://github.com/valbok)).
* (экспериментальный MaterializedMySQL) Теперь в DDL для MaterializedMySQL поддерживаются строки в UTF-8, не заключённые в кавычки. [#52318](https://github.com/ClickHouse/ClickHouse/pull/52318) ([Val Doroshchuk](https://github.com/valbok)).
* (экспериментальный MaterializedMySQL) Теперь в MaterializedMySQL поддерживаются комментарии в двойных кавычках. [#52355](https://github.com/ClickHouse/ClickHouse/pull/52355) ([Val Doroshchuk](https://github.com/valbok)).
* Обновлён Intel QPL с v1.1.0 до v1.2.0, обновлён Intel accel-config с v3.5 до v4.0, исправлена проблема, при которой пропуск Device IOTLB сильно влиял на производительность ускорителей IAA. [#52180](https://github.com/ClickHouse/ClickHouse/pull/52180) ([jasperzhu](https://github.com/jinjunzh)).
* Настройка `session_timezone` (новая в версии 23.6) переведена в разряд экспериментальных. [#52445](https://github.com/ClickHouse/ClickHouse/pull/52445) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка команды ZooKeeper `reconfig` для ClickHouse Keeper с инкрементальной переконфигурацией, которую можно включить с помощью настройки `keeper_server.enable_reconfiguration`. Поддерживается добавление серверов, удаление серверов и изменение приоритетов серверов. [#49450](https://github.com/ClickHouse/ClickHouse/pull/49450) ([Mike Kot](https://github.com/myrrc)). Предполагается, что эта возможность реализована не полностью.

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-5}
* Добавлены экспериментальные сборки ClickHouse для Linux RISC-V 64 в CI. [#31398](https://github.com/ClickHouse/ClickHouse/pull/31398) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена проверка интеграционных тестов с включённым Analyzer. [#50926](https://github.com/ClickHouse/ClickHouse/pull/50926) [#52210](https://github.com/ClickHouse/ClickHouse/pull/52210) ([Dmitry Novik](https://github.com/novikd)).
* Обеспечена воспроизводимость сборок для Rust. [#52395](https://github.com/ClickHouse/ClickHouse/pull/52395) ([Azat Khuzhin](https://github.com/azat)).
* Обновлены зависимости Cargo. [#51721](https://github.com/ClickHouse/ClickHouse/pull/51721) ([Raúl Marín](https://github.com/Algunenano)).
* Функция `CHColumnToArrowColumn::fillArrowArrayWithArrayColumnData` теперь работает с nullable-массивами, которые невозможны в ClickHouse, но необходимы для Gluten. [#52112](https://github.com/ClickHouse/ClickHouse/pull/52112) ([李扬](https://github.com/taiyang-li)).
* Мы обновили библиотеку CCTZ до состояния ветки master, но изменений, заметных пользователям, нет. [#52124](https://github.com/ClickHouse/ClickHouse/pull/52124) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Таблица `system.licenses` теперь включает жёстко форкнутую библиотеку Poco. Это закрывает [#52066](https://github.com/ClickHouse/ClickHouse/issues/52066). [#52127](https://github.com/ClickHouse/ClickHouse/pull/52127) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена проверка на отсутствие неправильной пунктуации: пробела перед запятой, как в `Hello ,world`, вместо `Hello, world`. [#52549](https://github.com/ClickHouse/ClickHouse/pull/52549) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-5}

* Исправлена синхронизация таблиц в MaterializedPostgreSQL [#49698](https://github.com/ClickHouse/ClickHouse/pull/49698) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена работа проекций с параметром optimize&#95;aggregators&#95;of&#95;group&#95;by&#95;keys [#49709](https://github.com/ClickHouse/ClickHouse/pull/49709) ([Amos Bird](https://github.com/amosbird)).
* Исправлена работа `optimize_skip_unused_shards` с `JOIN` [#51037](https://github.com/ClickHouse/ClickHouse/pull/51037) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена функция formatDateTime() для отрицательных значений типа datetime64 с дробной частью [#51290](https://github.com/ClickHouse/ClickHouse/pull/51290) ([Dmitry Kardymon](https://github.com/kardymonds)).
* Функции `hasToken*` работали совершенно некорректно. Добавлен тест для [#43358](https://github.com/ClickHouse/ClickHouse/issues/43358) [#51378](https://github.com/ClickHouse/ClickHouse/pull/51378) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена оптимизация перемещения функций перед сортировкой. [#51481](https://github.com/ClickHouse/ClickHouse/pull/51481) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено несоответствие структуры Block в Pipe::unitePipes при использовании FINAL [#51492](https://github.com/ClickHouse/ClickHouse/pull/51492) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена ошибка SIGSEGV для кластеров, у которых на всех шардах вес равен нулю (исправляет INSERT INTO FUNCTION clusterAllReplicas()) [#51545](https://github.com/ClickHouse/ClickHouse/pull/51545) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен таймаут для резервных запросов (hedged requests) [#51582](https://github.com/ClickHouse/ClickHouse/pull/51582) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена логическая ошибка в соединении ANTI JOIN с NULL [#51601](https://github.com/ClickHouse/ClickHouse/pull/51601) ([vdimir](https://github.com/vdimir)).
* Исправлен перенос условий IN в PREWHERE [#51610](https://github.com/ClickHouse/ClickHouse/pull/51610) ([Alexander Gololobov](https://github.com/davenger)).
* Не применять оптимизатор PredicateExpressionsOptimizer к ASOF/ANTI join [#51633](https://github.com/ClickHouse/ClickHouse/pull/51633) ([vdimir](https://github.com/vdimir)).
* Исправлена асинхронная вставка с дедупликацией в ReplicatedMergeTree с использованием алгоритмов слияния [#51676](https://github.com/ClickHouse/ClickHouse/pull/51676) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено чтение из пустого столбца в функции `parseSipHashKey` [#51804](https://github.com/ClickHouse/ClickHouse/pull/51804) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена ошибка сегментации (segfault) при создании некорректной таблицы EmbeddedRocksdb [#51847](https://github.com/ClickHouse/ClickHouse/pull/51847) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлены операции вставки в таблицы MongoDB [#51876](https://github.com/ClickHouse/ClickHouse/pull/51876) ([Nikolay Degterinsky](https://github.com/evillique)).
* Устранена взаимоблокировка при завершении работы DatabaseCatalog [#51908](https://github.com/ClickHouse/ClickHouse/pull/51908) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена ошибка в операторах подзапросов [#51922](https://github.com/ClickHouse/ClickHouse/pull/51922) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено асинхронное подключение к хостам с несколькими IP-адресами [#51934](https://github.com/ClickHouse/ClickHouse/pull/51934) ([Kruglov Pavel](https://github.com/Avogar)).
* Не удалять входы после вызова ActionsDAG::merge [#51947](https://github.com/ClickHouse/ClickHouse/pull/51947) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Проверять счётчик ссылок в `RemoveManyObjectStorageOperation::finalize` вместо `execute` [#51954](https://github.com/ClickHouse/ClickHouse/pull/51954) ([vdimir](https://github.com/vdimir)).
* Добавлена поддержка параметрических UDF [#51964](https://github.com/ClickHouse/ClickHouse/pull/51964) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Небольшое исправление функции toDateTime64() для дат после 2283-12-31 [#52130](https://github.com/ClickHouse/ClickHouse/pull/52130) ([Andrey Zvonov](https://github.com/zvonand)).
* Исправлен кортеж ORDER BY в оконных функциях [#52145](https://github.com/ClickHouse/ClickHouse/pull/52145) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлен некорректный анализ проекций, когда выражение агрегации содержит монотонные функции [#52151](https://github.com/ClickHouse/ClickHouse/pull/52151) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка в функциях `groupArrayMoving` [#52161](https://github.com/ClickHouse/ClickHouse/pull/52161) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Отключено прямое соединение (direct join) для словаря диапазонов (range dictionary) [#52187](https://github.com/ClickHouse/ClickHouse/pull/52187) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлен тест sticky mutations (и крайне редкое условие гонки) [#52197](https://github.com/ClickHouse/ClickHouse/pull/52197) ([alesapin](https://github.com/alesapin)).
* Устранена гонка в Web-диске [#52211](https://github.com/ClickHouse/ClickHouse/pull/52211) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена гонка данных в Connection::setAsyncCallback при обработке неизвестного пакета от сервера [#52219](https://github.com/ClickHouse/ClickHouse/pull/52219) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено удаление временных данных при запуске, добавлен тест [#52275](https://github.com/ClickHouse/ClickHouse/pull/52275) ([vdimir](https://github.com/vdimir)).
* Не используйте проекции minmax&#95;count при подсчёте столбцов типа Nullable [#52297](https://github.com/ClickHouse/ClickHouse/pull/52297) ([Amos Bird](https://github.com/amosbird)).
* MergeTree/ReplicatedMergeTree должны использовать часовой пояс сервера для записей логов [#52325](https://github.com/ClickHouse/ClickHouse/pull/52325) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено параметризованное представление с CTE при многократном использовании [#52328](https://github.com/ClickHouse/ClickHouse/pull/52328) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Отключить шаблоны выражений для временных интервалов [#52335](https://github.com/ClickHouse/ClickHouse/pull/52335) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена функция `apply_snapshot` в Keeper [#52358](https://github.com/ClickHouse/ClickHouse/pull/52358) ([Antonio Andelic](https://github.com/antonio2368)).
* Обновлён build-osx.md [#52377](https://github.com/ClickHouse/ClickHouse/pull/52377) ([AlexBykovski](https://github.com/AlexBykovski)).
* Исправлено зависание `countSubstrings` при пустой подстроке и столбце `haystack` [#52409](https://github.com/ClickHouse/ClickHouse/pull/52409) ([Sergei Trifonov](https://github.com/serxa)).
* Исправлена работа обычной проекции с таблицей типа Merge  [#52432](https://github.com/ClickHouse/ClickHouse/pull/52432) ([Amos Bird](https://github.com/amosbird)).
* Исправлено потенциальное двойное освобождение памяти в Aggregator [#52439](https://github.com/ClickHouse/ClickHouse/pull/52439) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена ошибка при вставке в движок Buffer [#52440](https://github.com/ClickHouse/ClickHouse/pull/52440) ([Vasily Nemkov](https://github.com/Enmk)).
* Реализация AnyHash не соответствовала спецификации. [#52448](https://github.com/ClickHouse/ClickHouse/pull/52448) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Проверять глубину рекурсии в OptimizedRegularExpression [#52451](https://github.com/ClickHouse/ClickHouse/pull/52451) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена гонка данных в DatabaseReplicated::startupTables()/canExecuteReplicatedMetadataAlter() [#52490](https://github.com/ClickHouse/ClickHouse/pull/52490) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено аварийное завершение работы функции `transform` [#52513](https://github.com/ClickHouse/ClickHouse/pull/52513) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена проблема с выполнением операции LIGHTWEIGHT DELETE после удаления проекции [#52517](https://github.com/ClickHouse/ClickHouse/pull/52517) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена потенциальная ошибка &quot;Cannot drain connections: cancel first&quot; [#52585](https://github.com/ClickHouse/ClickHouse/pull/52585) ([Kruglov Pavel](https://github.com/Avogar)).

### <a id="236"></a> Релиз ClickHouse 23.6, 2023-06-29 {#236}

#### Обратно несовместимые изменения {#backward-incompatible-change-6}
* Удалена функция `do_not_evict_index_and_mark_files` в fs-кэше. Она только ухудшала работу. [#51253](https://github.com/ClickHouse/ClickHouse/pull/51253) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Удалена поддержка ALTER для экспериментального LIVE VIEW. [#51287](https://github.com/ClickHouse/ClickHouse/pull/51287) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Значения по умолчанию для `http_max_field_value_size` и `http_max_field_name_size` уменьшены до 128 KiB. [#51163](https://github.com/ClickHouse/ClickHouse/pull/51163) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Метрики CGroups, связанные с CPU, заменены одной метрикой `CGroupMaxCPU` для повышения удобства использования. Метрики использования CPU `Normalized` теперь нормализуются по лимитам CGroups вместо общего количества CPU, когда такие лимиты установлены. Это закрывает [#50836](https://github.com/ClickHouse/ClickHouse/issues/50836). [#50835](https://github.com/ClickHouse/ClickHouse/pull/50835) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### Новая возможность {#new-feature-6}
* Функция `transform`, а также `CASE` с сопоставлением по значению теперь поддерживают все типы данных. Это закрывает [#29730](https://github.com/ClickHouse/ClickHouse/issues/29730). Это закрывает [#32387](https://github.com/ClickHouse/ClickHouse/issues/32387). Это закрывает [#50827](https://github.com/ClickHouse/ClickHouse/issues/50827). Это закрывает [#31336](https://github.com/ClickHouse/ClickHouse/issues/31336). Это закрывает [#40493](https://github.com/ClickHouse/ClickHouse/issues/40493). [#51351](https://github.com/ClickHouse/ClickHouse/pull/51351) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен параметр `--rename_files_after_processing <pattern>`. Это закрывает [#34207](https://github.com/ClickHouse/ClickHouse/issues/34207). [#49626](https://github.com/ClickHouse/ClickHouse/pull/49626) ([alekseygolub](https://github.com/alekseygolub)).
* Добавлена поддержка модификатора `TRUNCATE` в предложении `INTO OUTFILE`. Рекомендуется использовать `APPEND` или `TRUNCATE` для `INTO OUTFILE`, когда файл уже существует. [#50950](https://github.com/ClickHouse/ClickHouse/pull/50950) ([alekar](https://github.com/alekar)).
* Добавлен движок таблицы `Redis` и табличная функция `redis`. Это позволяет выполнять запросы к внешним серверам Redis. [#50150](https://github.com/ClickHouse/ClickHouse/pull/50150) ([JackyWoo](https://github.com/JackyWoo)).
* Добавлена возможность пропускать пустые файлы в табличных функциях file/s3/url/hdfs с помощью настроек `s3_skip_empty_files`, `hdfs_skip_empty_files`, `engine_file_skip_empty_files`, `engine_url_skip_empty_files`. [#50364](https://github.com/ClickHouse/ClickHouse/pull/50364) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена новая настройка `use_mysql_types_in_show_columns` для изменения SQL‑оператора `SHOW COLUMNS` с целью отображения эквивалентных типов MySQL, когда клиент подключён через порт совместимости с MySQL. [#49577](https://github.com/ClickHouse/ClickHouse/pull/49577) ([Thomas Panetti](https://github.com/tpanetti)).
* Clickhouse-client теперь можно запускать со строкой подключения вместо параметров `--host`, `--port`, `--user` и т.д. [#50689](https://github.com/ClickHouse/ClickHouse/pull/50689) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
* Добавлена настройка `session_timezone`; она используется как часовой пояс по умолчанию для сессии, когда он явно не указан. [#44149](https://github.com/ClickHouse/ClickHouse/pull/44149) ([Andrey Zvonov](https://github.com/zvonand)).
* Кодек DEFLATE_QPL теперь управляется серверной настройкой `enable_deflate_qpl_codec` (по умолчанию: false) вместо настройки `allow_experimental_codecs`. Это означает, что DEFLATE_QPL больше не считается экспериментальным. [#50775](https://github.com/ClickHouse/ClickHouse/pull/50775) ([Robert Schulze](https://github.com/rschu1ze)).

#### Улучшение производительности {#performance-improvement-6}
* Улучшено планирование задач выбора слияний и очистки в `ReplicatedMergeTree`. Задачи не будут выполняться слишком часто, когда нет данных для слияния или очистки. Добавлены настройки `max_merge_selecting_sleep_ms`, `merge_selecting_sleep_slowdown_factor`, `max_cleanup_delay_period` и `cleanup_thread_preferred_points_per_iteration`. Это изменение должно закрыть [#31919](https://github.com/ClickHouse/ClickHouse/issues/31919). [#50107](https://github.com/ClickHouse/ClickHouse/pull/50107) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Реализовано проталкивание фильтра через `CROSS JOIN`. [#50605](https://github.com/ClickHouse/ClickHouse/pull/50605) ([Han Fei](https://github.com/hanfei1991)).
* Повышена производительность при включённом QueryProfiler за счёт использования `thread-local` `timer_id` вместо глобального объекта. [#48778](https://github.com/ClickHouse/ClickHouse/pull/48778) ([Jiebin Sun](https://github.com/jiebinn)).
* Переписан формат ввода/вывода CapnProto для повышения его производительности. Имена столбцов и поля CapnProto сопоставляются без учёта регистра, исправлено чтение/запись полей вложенных структур. [#49752](https://github.com/ClickHouse/ClickHouse/pull/49752) ([Kruglov Pavel](https://github.com/Avogar)).
* Оптимизирована производительность записи в Parquet при работе параллельных потоков. [#50102](https://github.com/ClickHouse/ClickHouse/pull/50102) ([Hongbin Ma](https://github.com/binmahone)).
* Отключён `parallelize_output_from_storages` для обработки материализованных представлений (MATERIALIZED VIEW) и хранилищ только с одним блоком. [#50214](https://github.com/ClickHouse/ClickHouse/pull/50214) ([Azat Khuzhin](https://github.com/azat)).
* Объединён PR [#46558](https://github.com/ClickHouse/ClickHouse/pull/46558). Теперь перестановка блоков при сортировке не выполняется, если блок уже отсортирован. [#50697](https://github.com/ClickHouse/ClickHouse/pull/50697) ([Alexey Milovidov](https://github.com/alexey-milovidov), [Maksim Kita](https://github.com/kitaisreal)).
* Выполняются несколько запросов на получение списка в ZooKeeper параллельно для ускорения чтения из таблицы system.zookeeper. [#51042](https://github.com/ClickHouse/ClickHouse/pull/51042) ([Alexander Gololobov](https://github.com/davenger)).
* Ускорена инициализация таблиц поиска значений DateTime для часовых поясов. Это должно сократить время запуска/подключения clickhouse-client, особенно в debug-сборке, так как операция достаточно тяжёлая. [#51347](https://github.com/ClickHouse/ClickHouse/pull/51347) ([Alexander Gololobov](https://github.com/davenger)).
* Исправлено снижение производительности в озёрах данных (data lakes) из‑за синхронных запросов HEAD (связано с медленной работой Iceberg/Deltalake/Hudi при большом количестве файлов). [#50976](https://github.com/ClickHouse/ClickHouse/pull/50976) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Не выполняется чтение всех столбцов из правой таблицы `GLOBAL JOIN`. [#50721](https://github.com/ClickHouse/ClickHouse/pull/50721) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).

#### Экспериментальная функциональность {#experimental-feature-3}
* Добавлена поддержка параллельных реплик с использованием анализатора (analyzer). [#50441](https://github.com/ClickHouse/ClickHouse/pull/50441) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлено случайное ожидание перед выполнением крупных слияний/мутаций для более равномерного распределения нагрузки между репликами в случае репликации без копирования (zero-copy replication). [#51282](https://github.com/ClickHouse/ClickHouse/pull/51282) ([alesapin](https://github.com/alesapin)).
* Запросы `ALTER PARTITION` и мутации не реплицируются через базу данных `Replicated`, если у неё только один шард и базовая таблица — `ReplicatedMergeTree`. [#51049](https://github.com/ClickHouse/ClickHouse/pull/51049) ([Alexander Tokmakov](https://github.com/tavplubix)).

#### Улучшение {#improvement-6}

* Ослаблены пороги для состояния «too many parts», чтобы соответствовать современным требованиям. Восстановлен механизм обратного давления (backpressure) во время длительных запросов INSERT. [#50856](https://github.com/ClickHouse/ClickHouse/pull/50856) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Разрешено приводить IPv6-адреса к IPv4-адресам для CIDR ::ffff:0:0/96 (IPv4-отображаемые адреса). [#49759](https://github.com/ClickHouse/ClickHouse/pull/49759) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Обновлён протокол MongoDB для поддержки версий MongoDB 5.1 и новее. Поддержка версий со старым протоколом (&lt;3.6) сохранена. Закрывает [#45621](https://github.com/ClickHouse/ClickHouse/issues/45621), [#49879](https://github.com/ClickHouse/ClickHouse/issues/49879). [#50061](https://github.com/ClickHouse/ClickHouse/pull/50061) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена настройка `input_format_max_bytes_to_read_for_schema_inference` для ограничения объёма данных (в байтах), читаемых при выводе схемы. Закрывает [#50577](https://github.com/ClickHouse/ClickHouse/issues/50577). [#50592](https://github.com/ClickHouse/ClickHouse/pull/50592) ([Kruglov Pavel](https://github.com/Avogar)).
* Учитывать настройку `input_format_null_as_default` при определении схемы. [#50602](https://github.com/ClickHouse/ClickHouse/pull/50602) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена возможность пропускать завершающие пустые строки в форматах CSV/TSV/CustomSeparated с помощью настроек `input_format_csv_skip_trailing_empty_lines`, `input_format_tsv_skip_trailing_empty_lines` и `input_format_custom_skip_trailing_empty_lines` (по умолчанию отключены). Закрывает [#49315](https://github.com/ClickHouse/ClickHouse/issues/49315). [#50635](https://github.com/ClickHouse/ClickHouse/pull/50635) ([Kruglov Pavel](https://github.com/Avogar)).
* Функции &quot;toDateOrDefault|OrNull&quot; и &quot;accuateCast[OrDefault|OrNull]&quot; теперь корректно интерпретируют числовые аргументы. [#50709](https://github.com/ClickHouse/ClickHouse/pull/50709) ([Dmitry Kardymon](https://github.com/kardymonds)).
* Добавлена поддержка CSV с разделителями полей в виде пробельного символа или `\t`; такие разделители поддерживаются и в Spark. [#50712](https://github.com/ClickHouse/ClickHouse/pull/50712) ([KevinyhZou](https://github.com/KevinyhZou)).
* Параметры `number_of_mutations_to_delay` и `number_of_mutations_to_throw` теперь по умолчанию включены со значениями 500 и 1000 соответственно. [#50726](https://github.com/ClickHouse/ClickHouse/pull/50726) ([Anton Popov](https://github.com/CurtizJ)).
* Дашборд корректно отображает пропущенные значения. Тем самым закрывается [#50831](https://github.com/ClickHouse/ClickHouse/issues/50831). [#50832](https://github.com/ClickHouse/ClickHouse/pull/50832) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность использовать аргументы даты и времени в формате отметки времени syslog в функциях `parseDateTimeBestEffort*` и `parseDateTime64BestEffort*`. [#50925](https://github.com/ClickHouse/ClickHouse/pull/50925) ([Victor Krasnov](https://github.com/sirvickr)).
* Параметр командной строки «--password» в утилите clickhouse-client теперь может быть указан только один раз. [#50966](https://github.com/ClickHouse/ClickHouse/pull/50966) ([Alexey Gerasimchuck](https://github.com/Demilivor)).
* Используйте `hash_of_all_files` из `system.parts` для проверки идентичности частей во время резервного копирования на кластере. [#50997](https://github.com/ClickHouse/ClickHouse/pull/50997) ([Vitaly Baranov](https://github.com/vitlibar)).
* Системная таблица zookeeper&#95;connection connected&#95;time фиксирует время установления подключения (в стандартном формате), а также добавлен столбец session&#95;uptime&#95;elapsed&#95;seconds, который показывает продолжительность установленного сеанса подключения (в секундах). [#51026](https://github.com/ClickHouse/ClickHouse/pull/51026) ([郭小龙](https://github.com/guoxiaolongzte)).
* Улучшен индикатор прогресса для табличных функций file/s3/hdfs/url за счёт использования размера чанков из исходных данных и инкрементального подсчёта общего размера в каждом потоке. Исправлен индикатор прогресса для функций *Cluster. Закрывает [#47250](https://github.com/ClickHouse/ClickHouse/issues/47250). [#51088](https://github.com/ClickHouse/ClickHouse/pull/51088) ([Kruglov Pavel](https://github.com/Avogar)).
* Поле total&#95;bytes&#95;to&#95;read добавлено в пакет Progress протокола TCP для улучшения индикатора прогресса. [#51158](https://github.com/ClickHouse/ClickHouse/pull/51158) ([Kruglov Pavel](https://github.com/Avogar)).
* Улучшена проверка частей данных на дисках с файловым кэшем. [#51164](https://github.com/ClickHouse/ClickHouse/pull/51164) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено периодически некорректное значение `current_elements_num` в кэше файловой системы. [#51242](https://github.com/ClickHouse/ClickHouse/pull/51242) ([Kseniia Sumarokova](https://github.com/kssenii)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-6}
* Во встроенный standalone-бинарник keeper добавлен embedded keeper-client. [#50964](https://github.com/ClickHouse/ClickHouse/pull/50964) ([pufit](https://github.com/pufit)).
* Теперь используется актуальная версия LZ4. [#50621](https://github.com/ClickHouse/ClickHouse/pull/50621) ([Nikita Taranov](https://github.com/nickitat)).
* Сервер ClickHouse будет выводить список изменённых настроек при фатальных ошибках. Это закрывает [#51137](https://github.com/ClickHouse/ClickHouse/issues/51137). [#51138](https://github.com/ClickHouse/ClickHouse/pull/51138) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Разрешена сборка ClickHouse с clang-17. [#51300](https://github.com/ClickHouse/ClickHouse/pull/51300) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Проверка [SQLancer](https://github.com/sqlancer/sqlancer) считается стабильной, так как ошибки, которые ею выявлялись, исправлены. Теперь сбои проверки SQLancer будут помечаться как неуспешный статус проверки. [#51340](https://github.com/ClickHouse/ClickHouse/pull/51340) ([Ilya Yatsishin](https://github.com/qoega)).
* Один большой `RUN` в Dockerfile разделён на несколько меньших условных команд. Необходимые инструменты устанавливаются по требованию в том же слое `RUN` и затем удаляются. Обновление ОС выполняется только один раз в начале. Используется современный способ проверки подписанного репозитория. Базовый образ понижен до ubuntu:20.04 для устранения проблем на старых версиях Docker. Обновлена версия golang для устранения уязвимостей golang. [#51504](https://github.com/ClickHouse/ClickHouse/pull/51504) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).

#### Исправление ошибок (заметное пользователю некорректное поведение в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-6}

* Корректно отображать статус загрузки исполняемых словарей [#48775](https://github.com/ClickHouse/ClickHouse/pull/48775) ([Anton Kozlov](https://github.com/tonickkozlov)).
* Корректная мутация индексов пропуска и проекций [#50104](https://github.com/ClickHouse/ClickHouse/pull/50104) ([Amos Bird](https://github.com/amosbird)).
* Рефакторинг изменяемых компонентов [#50489](https://github.com/ClickHouse/ClickHouse/pull/50489) ([vdimir](https://github.com/vdimir)).
* Исправлена обратная совместимость хеширования IP-типов в агрегатных функциях [#50551](https://github.com/ClickHouse/ClickHouse/pull/50551) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена проблема, из-за которой таблица семейства Log возвращала неверное количество строк после операции `TRUNCATE` [#50585](https://github.com/ClickHouse/ClickHouse/pull/50585) ([flynn](https://github.com/ucasfl)).
* Исправлена ошибка при параллельном слиянии в `uniqExact` [#50590](https://github.com/ClickHouse/ClickHouse/pull/50590) ([Nikita Taranov](https://github.com/nickitat)).
* Отмена последних изменений в механизме grace hash join [#50699](https://github.com/ClickHouse/ClickHouse/pull/50699) ([vdimir](https://github.com/vdimir)).
* Кэш запросов: попытка исправить некорректное приведение типов из `ColumnConst` к `ColumnVector<char8_t>` [#50704](https://github.com/ClickHouse/ClickHouse/pull/50704) ([Robert Schulze](https://github.com/rschu1ze)).
* Исключено сохранение логов в Keeper, содержащих неизвестную операцию [#50751](https://github.com/ClickHouse/ClickHouse/pull/50751) ([Antonio Andelic](https://github.com/antonio2368)).
* Поддержка DateTime64 в SummingMergeTree [#50797](https://github.com/ClickHouse/ClickHouse/pull/50797) ([Jordi Villar](https://github.com/jrdi)).
* Добавлена настройка совместимости для неконстантных часовых поясов [#50834](https://github.com/ClickHouse/ClickHouse/pull/50834) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлено хеширование параметров LDAP в элементах кэша [#50865](https://github.com/ClickHouse/ClickHouse/pull/50865) ([Julian Maicher](https://github.com/jmaicher)).
* Резервный вариант: разбор большого целого из String вместо генерации исключения в формате Parquet [#50873](https://github.com/ClickHouse/ClickHouse/pull/50873) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено слишком частое обращение к файлу блокировки при создании резервной копии [#50889](https://github.com/ClickHouse/ClickHouse/pull/50889) ([Vitaly Baranov](https://github.com/vitlibar)).
* Не применять проекцию, если включён режим последовательного чтения (read-in-order). [#50923](https://github.com/ClickHouse/ClickHouse/pull/50923) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена гонка данных в итераторе Azure Blob Storage [#50936](https://github.com/ClickHouse/ClickHouse/pull/50936) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлено некорректное распространение `sort_description` в `CreatingSets` [#50955](https://github.com/ClickHouse/ClickHouse/pull/50955) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлен разбор необязательных метаданных Iceberg v2 [#50974](https://github.com/ClickHouse/ClickHouse/pull/50974) ([Kseniia Sumarokova](https://github.com/kssenii)).
* MaterializedMySQL: оставлять круглые скобки для переопределения пустых таблиц [#50977](https://github.com/ClickHouse/ClickHouse/pull/50977) ([Val Doroshchuk](https://github.com/valbok)).
* Исправлено падение в BackupCoordinationStageSync::setError() [#51012](https://github.com/ClickHouse/ClickHouse/pull/51012) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена малозаметная ошибка в механизме copy-on-write словаря ColumnLowCardinality [#51064](https://github.com/ClickHouse/ClickHouse/pull/51064) ([Michael Kolupaev](https://github.com/al13n321)).
* Генерировать безопасные векторы инициализации (IV) [#51086](https://github.com/ClickHouse/ClickHouse/pull/51086) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Исправлена неэффективная работа кэша запросов для запросов SELECT с подзапросами [#51132](https://github.com/ClickHouse/ClickHouse/pull/51132) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена работа индекса Set при сравнении с константой Nullable. [#51205](https://github.com/ClickHouse/ClickHouse/pull/51205) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено аварийное завершение работы функций s3 и s3Cluster [#51209](https://github.com/ClickHouse/ClickHouse/pull/51209) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлен сбой при работе со скомпилированными выражениями [#51231](https://github.com/ClickHouse/ClickHouse/pull/51231) ([LiuNeng](https://github.com/liuneng1994)).
* Исправлена ошибка use-after-free в StorageURL при переключении URL-адресов [#51260](https://github.com/ClickHouse/ClickHouse/pull/51260) ([Michael Kolupaev](https://github.com/al13n321)).
* Обновлена проверка для параметризованного представления [#51272](https://github.com/ClickHouse/ClickHouse/pull/51272) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлена проблема многократной записи одного и того же файла в резервную копию [#51299](https://github.com/ClickHouse/ClickHouse/pull/51299) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен сбой фаззера в ActionsDAG [#51301](https://github.com/ClickHouse/ClickHouse/pull/51301) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Удалён лишний код из функции `transform` [#51350](https://github.com/ClickHouse/ClickHouse/pull/51350) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

### <a id="235"></a> Релиз ClickHouse 23.5, 2023-06-08 {#235}

#### Заметки по обновлению {#upgrade-notes}
* По умолчанию включено сжатие меток и первичного ключа. Это значительно сокращает время выполнения холодных запросов. Заметки по обновлению: поддержка сжатых меток и первичного ключа была добавлена в версии 22.9. Если вы включили сжатые метки или первичный ключ или установили версию 23.5 или новее, в которой сжатые метки или первичный ключ включены по умолчанию, вы не сможете выполнить откат на версию 22.8 или более раннюю. Вы также можете явно отключить сжатие меток или первичного ключа, указав настройки `compress_marks` и `compress_primary_key` в секции `<merge_tree>` файла конфигурации сервера. **Заметки по обновлению:** Если вы обновляетесь с версий до 22.9 включительно, вам следует либо обновить все реплики одновременно, либо отключить сжатие перед обновлением, либо выполнить обновление через промежуточную версию, в которой сжатые метки поддерживаются, но не включены по умолчанию, например 23.3. [#42587](https://github.com/ClickHouse/ClickHouse/pull/42587) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Обеспечить единообразную работу локального объектного хранилища и объектного хранилища S3, исправить проблему с добавлением (закрывает [#48465](https://github.com/ClickHouse/ClickHouse/issues/48465)), сделать его настраиваемым как независимое хранилище. Изменение не обратно совместимо, поскольку кэш поверх локального объектного хранилища не совместим с предыдущими версиями. [#48791](https://github.com/ClickHouse/ClickHouse/pull/48791) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Экспериментальная функция "in-memory data parts" удалена. Формат данных по‑прежнему поддерживается, но настройки больше не оказывают эффекта, и вместо него будут использоваться compact‑ или wide‑части. Это закрывает [#45409](https://github.com/ClickHouse/ClickHouse/issues/45409). [#49429](https://github.com/ClickHouse/ClickHouse/pull/49429) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Изменены значения по умолчанию для настроек `parallelize_output_from_storages` и `input_format_parquet_preserve_order`. Это позволяет ClickHouse переупорядочивать строки при чтении из файлов (например, CSV или Parquet), что во многих случаях существенно повышает производительность. Чтобы вернуть прежнее поведение с сохранением порядка, используйте `parallelize_output_from_storages = 0`, `input_format_parquet_preserve_order = 1`. [#49479](https://github.com/ClickHouse/ClickHouse/pull/49479) ([Michael Kolupaev](https://github.com/al13n321)).
* Проекции переведены в статус готовых к промышленной эксплуатации. Добавлена настройка `optimize_use_projections` для управления тем, будут ли проекции выбираться для запросов SELECT. Настройка `allow_experimental_projection_optimization` устарела и больше не оказывает эффекта. [#49719](https://github.com/ClickHouse/ClickHouse/pull/49719) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Пометить `joinGet` как недетерминированную функцию (так же, как `dictGet`). Это позволяет использовать их в мутациях без дополнительной настройки. [#49843](https://github.com/ClickHouse/ClickHouse/pull/49843) ([Azat Khuzhin](https://github.com/azat)).
* Отменить изменение "`groupArray` returns cannot be nullable" (из‑за нарушения двоичной совместимости для `groupArray`/`groupArrayLast`/`groupArraySample` над типами `Nullable`, что, вероятно, приведет к ошибкам `TOO_LARGE_ARRAY_SIZE` или `CANNOT_READ_ALL_DATA`). [#49971](https://github.com/ClickHouse/ClickHouse/pull/49971) ([Azat Khuzhin](https://github.com/azat)).
* Настройка `enable_memory_bound_merging_of_aggregation_results` включена по умолчанию. Если вы обновляетесь с версии до 22.12 включительно, мы рекомендуем установить этот флаг в значение `false` до завершения обновления. [#50319](https://github.com/ClickHouse/ClickHouse/pull/50319) ([Nikita Taranov](https://github.com/nickitat)).

#### Новая возможность {#new-feature-7}

* Добавлен движок хранения AzureBlobStorage и табличная функция azureBlobStorage. Набор поддерживаемых возможностей во многом аналогичен движку/табличной функции S3 [#50604] ([https://github.com/ClickHouse/ClickHouse/pull/50604](https://github.com/ClickHouse/ClickHouse/pull/50604)) ([alesapin](https://github.com/alesapin)) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni).
* Добавлен встроенный CLI‑клиент ClickHouse Keeper, доступный как `clickhouse keeper-client` [#47414](https://github.com/ClickHouse/ClickHouse/pull/47414) ([pufit](https://github.com/pufit)).
* Добавлена табличная функция `urlCluster`. Выполнен рефакторинг всех табличных функций *Cluster для уменьшения дублирования кода. Реализован вывод схемы (schema inference) для всех возможных сигнатур функций *Cluster и для именованных коллекций. Закрывает [#38499](https://github.com/ClickHouse/ClickHouse/issues/38499). [#45427](https://github.com/ClickHouse/ClickHouse/pull/45427) ([attack204](https://github.com/attack204)), Pavel Kruglov.
* Кэш запросов теперь можно использовать в продакшене. [#47977](https://github.com/ClickHouse/ClickHouse/pull/47977) ([Robert Schulze](https://github.com/rschu1ze)). Кэш запросов теперь поддерживает запросы с модификаторами totals и extremes. [#48853](https://github.com/ClickHouse/ClickHouse/pull/48853) ([Robert Schulze](https://github.com/rschu1ze)). Настройка `allow_experimental_query_cache` помечена как устаревшая для обеспечения обратной совместимости. Она была удалена в [https://github.com/ClickHouse/ClickHouse/pull/47977](https://github.com/ClickHouse/ClickHouse/pull/47977). [#49934](https://github.com/ClickHouse/ClickHouse/pull/49934) ([Timur Solodovnikov](https://github.com/tsolodov)).
* Географические типы данных (`Point`, `Ring`, `Polygon` и `MultiPolygon`) готовы для промышленной эксплуатации. [#50022](https://github.com/ClickHouse/ClickHouse/pull/50022) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлен автоматический вывод схемы для движков таблиц PostgreSQL, MySQL, MeiliSearch и SQLite. Закрывает [#49972](https://github.com/ClickHouse/ClickHouse/issues/49972). [#50000](https://github.com/ClickHouse/ClickHouse/pull/50000) ([Nikolay Degterinsky](https://github.com/evillique)).
* Тип пароля в запросах наподобие `CREATE USER u IDENTIFIED BY 'p'` будет автоматически установлен в соответствии с настройкой `default_password_type` в файле `config.xml` на сервере. Закрывает [#42915](https://github.com/ClickHouse/ClickHouse/issues/42915). [#44674](https://github.com/ClickHouse/ClickHouse/pull/44674) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлен тип аутентификации по паролю с использованием bcrypt. Закрывает [#34599](https://github.com/ClickHouse/ClickHouse/issues/34599). [#44905](https://github.com/ClickHouse/ClickHouse/pull/44905) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлено новое ключевое слово `INTO OUTFILE 'file.txt' APPEND`. [#48880](https://github.com/ClickHouse/ClickHouse/pull/48880) ([alekar](https://github.com/alekar)).
* Добавлена таблица `system.zookeeper_connection`, которая показывает информацию о соединениях с Keeper. [#45245](https://github.com/ClickHouse/ClickHouse/pull/45245) ([mateng915](https://github.com/mateng0915)).
* Добавлена новая функция `generateRandomStructure`, которая генерирует случайную структуру таблицы. Она может использоваться в сочетании с табличной функцией `generateRandom`. [#47409](https://github.com/ClickHouse/ClickHouse/pull/47409) ([Kruglov Pavel](https://github.com/Avogar)).
* Теперь допускается использование `CASE` без ветви `ELSE`, а также расширена функция `transform()` для обработки большего числа типов. Также исправлены некоторые ошибки, из-за которых `transform()` возвращала некорректные результаты при смешанном использовании десятичных и других числовых типов. [#48300](https://github.com/ClickHouse/ClickHouse/pull/48300) ([Salvatore Mesoraca](https://github.com/aiven-sal)). Это закрывает #2655. Это закрывает #9596. Это закрывает #38666.
* Добавлено [серверное шифрование с использованием ключей KMS](https://docs.aws.amazon.com/AmazonS3/latest/userguide/UsingKMSEncryption.html) для таблиц S3, а также параметр `header` для дисков S3. Закрывает [#48723](https://github.com/ClickHouse/ClickHouse/issues/48723). [#48724](https://github.com/ClickHouse/ClickHouse/pull/48724) ([Johann Gan](https://github.com/johanngan)).
* Добавлен MemoryTracker для фоновых задач (слияния и мутации). Добавлены настройки `merges_mutations_memory_usage_soft_limit` и `merges_mutations_memory_usage_to_ram_ratio`, которые задают мягкий лимит памяти для слияний и мутаций. Если этот лимит достигнут, ClickHouse не будет планировать новые задачи слияния или мутации. Также добавлена метрика `MergesMutationsMemoryTracking`, позволяющая отслеживать текущее потребление памяти фоновыми задачами. Повторяет изменения из [#46089](https://github.com/ClickHouse/ClickHouse/issues/46089). Закрывает [#48774](https://github.com/ClickHouse/ClickHouse/issues/48774). [#48787](https://github.com/ClickHouse/ClickHouse/pull/48787) ([Dmitry Novik](https://github.com/novikd)).
* Функция `dotProduct` теперь работает с массивами. [#49050](https://github.com/ClickHouse/ClickHouse/pull/49050) ([FFFFFFFHHHHHHH](https://github.com/FFFFFFFHHHHHHH)).
* Добавлена поддержка `SHOW INDEX` для улучшения совместимости с MySQL. [#49158](https://github.com/ClickHouse/ClickHouse/pull/49158) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка виртуальных столбцов `_file` и `_path` в табличной функции `url`. - Улучшено сообщение об ошибке для табличной функции `url`. - Исправляет [#49231](https://github.com/ClickHouse/ClickHouse/issues/49231) - Исправляет [#49232](https://github.com/ClickHouse/ClickHouse/issues/49232). [#49356](https://github.com/ClickHouse/ClickHouse/pull/49356) ([Ziyi Tan](https://github.com/Ziy1-Tan)).
* Добавлено поле `grants` в файл users.xml, которое позволяет задавать привилегии пользователям. [#49381](https://github.com/ClickHouse/ClickHouse/pull/49381) ([pufit](https://github.com/pufit)).
* Добавлена поддержка полного и правого соединения с использованием алгоритма Grace Hash Join. [#49483](https://github.com/ClickHouse/ClickHouse/pull/49483) ([lgbo](https://github.com/lgbo-ustc)).
* Модификатор `WITH FILL` выполняет заполнение, группируя его по префиксу сортировки. Управляется настройкой `use_with_fill_by_sorting_prefix` (по умолчанию включена). Связан с [#33203](https://github.com/ClickHouse/ClickHouse/issues/33203)#issuecomment-1418736794. [#49503](https://github.com/ClickHouse/ClickHouse/pull/49503) ([Igor Nikonov](https://github.com/devcrafter)).
* Clickhouse-client теперь принимает запросы, указанные после &quot;--multiquery&quot;, если не задан &quot;--query&quot; (или &quot;-q&quot;). Пример: clickhouse-client --multiquery &quot;select 1; select 2;&quot;. [#49870](https://github.com/ClickHouse/ClickHouse/pull/49870) ([Alexey Gerasimchuk](https://github.com/Demilivor)).
* Добавлен отдельный таймаут `handshake_timeout` для получения пакета `Hello` от реплики. Закрывает [#48854](https://github.com/ClickHouse/ClickHouse/issues/48854). [#49948](https://github.com/ClickHouse/ClickHouse/pull/49948) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена функция &quot;space&quot;, которая повторяет пробел заданное количество раз. [#50103](https://github.com/ClickHouse/ClickHouse/pull/50103) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлен параметр --input&#95;format&#95;csv&#95;trim&#95;whitespaces. [#50215](https://github.com/ClickHouse/ClickHouse/pull/50215) ([Alexey Gerasimchuk](https://github.com/Demilivor)).
* Разрешить функции `dictGetAll` для словарей на основе деревьев regexp возвращать значения для нескольких совпадений в виде массивов. Закрывает [#50254](https://github.com/ClickHouse/ClickHouse/issues/50254). [#50255](https://github.com/ClickHouse/ClickHouse/pull/50255) ([Johann Gan](https://github.com/johanngan)).
* Добавлена функция `toLastDayOfWeek` для округления даты или даты со временем вверх до ближайшей субботы или воскресенья. [#50315](https://github.com/ClickHouse/ClickHouse/pull/50315) ([Victor Krasnov](https://github.com/sirvickr)).
* Возможность игнорировать индексы пропуска данных с помощью параметра `ignore_data_skipping_indices`. [#50329](https://github.com/ClickHouse/ClickHouse/pull/50329) ([Boris Kuschel](https://github.com/bkuschel)).
* Добавлена таблица `system.user_processes` и запрос `SHOW USER PROCESSES` для отображения сведений об использовании памяти и ProfileEvents на уровне пользователей. [#50492](https://github.com/ClickHouse/ClickHouse/pull/50492) ([János Benjamin Antal](https://github.com/antaljanosbenjamin)).
* Добавлены серверные настройки и настройки формата `display_secrets_in_show_and_select` для отображения секретов таблиц, баз данных, табличных функций и словарей. Добавлена привилегия `displaySecretsInShowAndSelect`, управляющая тем, какие пользователи могут просматривать секреты. [#46528](https://github.com/ClickHouse/ClickHouse/pull/46528) ([Mike Kot](https://github.com/myrrc)).
* Добавлена возможность настроить ROW POLICY для всех таблиц, принадлежащих DATABASE. [#47640](https://github.com/ClickHouse/ClickHouse/pull/47640) ([Ilya Golshtein](https://github.com/ilejn)).



#### Повышение производительности {#performance-improvement-7}

* Метки и первичный ключ по умолчанию сжимаются. Это значительно сокращает время выполнения холодных запросов. Примечания по обновлению: поддержка сжатых меток и первичного ключа была добавлена в версии 22.9. Если вы включили сжатые метки или первичный ключ или установили версию 23.5 или новее, в которых сжатые метки и первичный ключ включены по умолчанию, вы не сможете выполнить откат на версию 22.8 или более раннюю. Вы также можете явно отключить сжатые метки или первичный ключ, указав настройки `compress_marks` и `compress_primary_key` в секции `<merge_tree>` конфигурационного файла сервера. [#42587](https://github.com/ClickHouse/ClickHouse/pull/42587) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Новая настройка s3&#95;max&#95;inflight&#95;parts&#95;for&#95;one&#95;file задаёт ограничение на число одновременно загружаемых частей при multipart-запросе на загрузку одного файла. [#49961](https://github.com/ClickHouse/ClickHouse/pull/49961) ([Sema Checherinda](https://github.com/CheSema)).
* При чтении из нескольких файлов уменьшено количество параллельных потоков разбора для каждого файла. Исправляет проблему [#42192](https://github.com/ClickHouse/ClickHouse/issues/42192). [#46661](https://github.com/ClickHouse/ClickHouse/pull/46661) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Используйте агрегирующую проекцию только в том случае, если при чтении она затрагивает меньше гранул, чем обычное чтение таблицы. Это должно помочь, если запрос попадает в первичный ключ (PK) таблицы, но не в проекцию. Исправляет [#49150](https://github.com/ClickHouse/ClickHouse/issues/49150). [#49417](https://github.com/ClickHouse/ClickHouse/pull/49417) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Не хранить блоки в `ANY` hash join, если ничего не вставлено. [#48633](https://github.com/ClickHouse/ClickHouse/pull/48633) ([vdimir](https://github.com/vdimir)).
* Исправлена работа агрегатного комбинатора `-If` при JIT-компиляции и включена JIT-компиляция агрегатных функций. Закрывает [#48120](https://github.com/ClickHouse/ClickHouse/issues/48120). [#49083](https://github.com/ClickHouse/ClickHouse/pull/49083) ([Igor Nikonov](https://github.com/devcrafter)).
* Для чтения из удалённых таблиц мы используем более мелкие задачи (вместо чтения целой части), чтобы эффективнее работал механизм task stealing; * размер задачи определяется размером читаемых столбцов; * всегда используем буферы размером 1 МБ для чтения из S3; * границы сегментов кэша выровнены по 1 МБ, чтобы они имели приемлемый размер даже для маленьких задач; это также должно предотвратить фрагментацию. [#49287](https://github.com/ClickHouse/ClickHouse/pull/49287) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлены настройки: - `merge_max_block_size_bytes` для ограничения объёма памяти, используемой фоновыми операциями. - `vertical_merge_algorithm_min_bytes_to_activate`, чтобы добавить дополнительное условие для активации вертикальных слияний. [#49313](https://github.com/ClickHouse/ClickHouse/pull/49313) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Размер буфера чтения по умолчанию для чтения из локальной файловой системы изменён на слегка более оптимальное значение. Также введены две новые настройки: `max_read_buffer_size_local_fs` и `max_read_buffer_size_remote_fs`. [#49321](https://github.com/ClickHouse/ClickHouse/pull/49321) ([Nikita Taranov](https://github.com/nickitat)).
* Улучшено использование памяти и скорость работы словарей `SPARSE_HASHED`/`HASHED` (например, `SPARSE_HASHED` теперь потребляет в 2,6 раза меньше памяти и работает примерно в 2 раза быстрее). [#49380](https://github.com/ClickHouse/ClickHouse/pull/49380) ([Azat Khuzhin](https://github.com/azat)).
* Оптимизируйте таблицы `system.query_log` и `system.query_thread_log`, применяя `LowCardinality`, когда это уместно. Запросы к этим таблицам будут выполняться быстрее. [#49530](https://github.com/ClickHouse/ClickHouse/pull/49530) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшена производительность чтения локальных файлов `Parquet` (за счёт параллельного чтения). [#49539](https://github.com/ClickHouse/ClickHouse/pull/49539) ([Michael Kolupaev](https://github.com/al13n321)).
* Улучшена производительность `RIGHT/FULL JOIN` до двух раз в отдельных сценариях, особенно при соединении небольшой левой таблицы с большой правой. [#49585](https://github.com/ClickHouse/ClickHouse/pull/49585) ([lgbo](https://github.com/lgbo-ustc)).
* Улучшена производительность BLAKE3 на 11% за счёт включения LTO для Rust. [#49600](https://github.com/ClickHouse/ClickHouse/pull/49600) ([Azat Khuzhin](https://github.com/azat)). Теперь производительность сопоставима с C++.
* Оптимизируйте структуру таблицы `system.opentelemetry_span_log`. Используйте `LowCardinality`, где это уместно. Хотя эта таблица в целом неудачно устроена (она использует тип данных Map даже для общих атрибутов), это сделает её немного лучше. [#49647](https://github.com/ClickHouse/ClickHouse/pull/49647) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Попытка зарезервировать размер хеш-таблицы в соединении `grace_hash`. [#49816](https://github.com/ClickHouse/ClickHouse/pull/49816) ([lgbo](https://github.com/lgbo-ustc)).
* Параллельное слияние состояний `uniqExactIf`. Закрытие [#49885](https://github.com/ClickHouse/ClickHouse/issues/49885). [#50285](https://github.com/ClickHouse/ClickHouse/pull/50285) ([flynn](https://github.com/ucasfl)).
* Улучшение Keeper: добавлен запрос `CheckNotExists`, что позволяет повысить производительность реплицируемых таблиц. [#48897](https://github.com/ClickHouse/ClickHouse/pull/48897) ([Antonio Andelic](https://github.com/antonio2368)).
* Улучшена производительность Keeper: при обработке запросов больше не выполняется повторная сериализация одного и того же запроса. Результаты десериализации больших запросов кэшируются. Поведение регулируется новым параметром координации `min_request_size_for_cache`. [#49004](https://github.com/ClickHouse/ClickHouse/pull/49004) ([Antonio Andelic](https://github.com/antonio2368)).
* Снижено количество `List`-запросов к ZooKeeper при выборе кусков для слияния, когда во многих партициях нечего сливать. [#49637](https://github.com/ClickHouse/ClickHouse/pull/49637) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Переработана система блокировок в кэше файловой системы [#44985](https://github.com/ClickHouse/ClickHouse/pull/44985) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отключать чистые параллельные реплики, если возможна простая оптимизация `count`. [#50594](https://github.com/ClickHouse/ClickHouse/pull/50594) ([Raúl Marín](https://github.com/Algunenano)).
* Не отправлять `HEAD`‑запросы для всех ключей при определении схемы Iceberg, а только для ключей, используемых для чтения данных. [#50203](https://github.com/ClickHouse/ClickHouse/pull/50203) ([Kruglov Pavel](https://github.com/Avogar)).
* Параметр `enable_memory_bound_merging_of_aggregation_results` включен по умолчанию. [#50319](https://github.com/ClickHouse/ClickHouse/pull/50319) ([Nikita Taranov](https://github.com/nickitat)).

#### Экспериментальная функция {#experimental-feature-4}
* Кодек `DEFLATE_QPL` снижает минимальные требования к версии SIMD до SSE 4.2. [изменение документации в qpl](https://github.com/intel/qpl/commit/3f8f5cea27739f5261e8fd577dc233ffe88bf679) — Intel® QPL использует диспетчер ядер на этапе выполнения и проверку CPUID для выбора наилучшей доступной реализации (sse/avx2/avx512) — переработан CMake-файл для сборки qpl в ClickHouse, чтобы привести его в соответствие с последней версией upstream qpl. [#49811](https://github.com/ClickHouse/ClickHouse/pull/49811) ([jasperzhu](https://github.com/jinjunzh)).
* Добавлена начальная поддержка выполнения операций JOIN с исключительно параллельными репликами. [#49544](https://github.com/ClickHouse/ClickHouse/pull/49544) ([Raúl Marín](https://github.com/Algunenano)).
* Увеличен уровень параллелизма при удалении устаревших частей с использованием репликации без копирования (zero-copy replication). [#49630](https://github.com/ClickHouse/ClickHouse/pull/49630) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Parallel Replicas: 1) Исправлена ошибка `NOT_FOUND_COLUMN_IN_BLOCK` при использовании параллельных реплик с нереплицируемым хранилищем и отключённой настройкой `parallel_replicas_for_non_replicated_merge_tree`. 2) Теперь `allow_experimental_parallel_reading_from_replicas` может принимать 3 значения — 0, 1 и 2. 0 — отключено, 1 — включено, при ошибке они бесшумно отключаются (в случае FINAL или JOIN), 2 — включено, при ошибке выбрасывается исключение. 3) Если модификатор FINAL используется в запросе SELECT и параллельные реплики включены, ClickHouse попытается отключить их, если `allow_experimental_parallel_reading_from_replicas` установлено в 1, и выбросит исключение в противном случае. [#50195](https://github.com/ClickHouse/ClickHouse/pull/50195) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* При включённых параллельных репликах они всегда будут пропускать недоступные серверы (поведение управляется настройкой `skip_unavailable_shards`, которая включена по умолчанию и может быть только отключена). Это закрывает задачу: [#48565](https://github.com/ClickHouse/ClickHouse/issues/48565). [#50293](https://github.com/ClickHouse/ClickHouse/pull/50293) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).

#### Улучшение {#improvement-7}

* Команда `BACKUP` не расшифровывает данные с зашифрованных дисков при создании резервной копии. Вместо этого данные будут сохранены в резервной копии в зашифрованном виде. Такие резервные копии можно восстановить только на зашифрованный диск с тем же (или расширенным) списком ключей шифрования. [#48896](https://github.com/ClickHouse/ClickHouse/pull/48896) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена возможность использовать временные таблицы в предложении FROM операторов ATTACH PARTITION FROM и REPLACE PARTITION FROM. [#49436](https://github.com/ClickHouse/ClickHouse/pull/49436) ([Roman Vasin](https://github.com/rvasin)).
* Добавлена настройка `async_insert` для таблиц `MergeTree`. Она эквивалентна настройке `async_insert` на уровне запроса и включает асинхронные вставки для конкретной таблицы. Примечание: она не действует для запросов INSERT, выполняемых через `clickhouse-client`; в этом случае используйте настройку на уровне запроса. [#49122](https://github.com/ClickHouse/ClickHouse/pull/49122) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена поддержка суффиксов размеров в параметрах оператора создания квоты. [#49087](https://github.com/ClickHouse/ClickHouse/pull/49087) ([Eridanus](https://github.com/Eridanus117)).
* Расширены функции `first_value` и `last_value` для поддержки значения NULL. [#46467](https://github.com/ClickHouse/ClickHouse/pull/46467) ([lgbo](https://github.com/lgbo-ustc)).
* Добавлены псевдонимы `str_to_map` и `mapFromString` для `extractKeyValuePairs`. Закрыта задача [https://github.com/clickhouse/clickhouse/issues/47185](https://github.com/clickhouse/clickhouse/issues/47185). [#49466](https://github.com/ClickHouse/ClickHouse/pull/49466) ([flynn](https://github.com/ucasfl)).
* Добавлена поддержка CGroup версии 2 для асинхронного сбора метрик использования и доступности памяти. Это закрывает [#37983](https://github.com/ClickHouse/ClickHouse/issues/37983). [#45999](https://github.com/ClickHouse/ClickHouse/pull/45999) ([sichenzhao](https://github.com/sichenzhao)).
* Табличные функции `cluster` всегда должны пропускать недоступные шарды. Закрывает [#46314](https://github.com/ClickHouse/ClickHouse/issues/46314). [#46765](https://github.com/ClickHouse/ClickHouse/pull/46765) ([zk&#95;kiger](https://github.com/zk-kiger)).
* Разрешить наличие пустых столбцов в заголовке CSV-файла. [#47496](https://github.com/ClickHouse/ClickHouse/pull/47496) ([你不要过来啊](https://github.com/iiiuwioajdks)).
* Добавлена табличная функция `gcs`, совместимая с S3, для Google Cloud Storage. Как и функции `oss` и `cosn`, она является лишь псевдонимом для табличной функции `s3` и не добавляет новых возможностей. [#47815](https://github.com/ClickHouse/ClickHouse/pull/47815) ([Kuba Kaflik](https://github.com/jkaflik)).
* Добавлена возможность использовать строгий размер частей для S3 (совместимость с Cloudflare R2 S3 Storage). [#48492](https://github.com/ClickHouse/ClickHouse/pull/48492) ([Azat Khuzhin](https://github.com/azat)).
* Добавлены новые столбцы с информацией о репликах базы данных `Replicated` в таблицу `system.clusters`: `database_shard_name`, `database_replica_name`, `is_active`. Добавлена необязательная клауза `FROM SHARD` в запросе `SYSTEM DROP DATABASE REPLICA`. [#48548](https://github.com/ClickHouse/ClickHouse/pull/48548) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Добавлен новый столбец `zookeeper_name` в system.replicas для указания, в каком (вспомогательном) кластере ZooKeeper хранятся метаданные реплицируемой таблицы. [#48549](https://github.com/ClickHouse/ClickHouse/pull/48549) ([cangyin](https://github.com/cangyin)).
* Оператор `IN` теперь поддерживает сравнение типов `Date` и `Date32`. Закрывает [#48736](https://github.com/ClickHouse/ClickHouse/issues/48736). [#48806](https://github.com/ClickHouse/ClickHouse/pull/48806) ([flynn](https://github.com/ucasfl)).
* Поддержка кодирования стиранием в `HDFS`, авторы: @M1eyu2018, @tomscut. [#48833](https://github.com/ClickHouse/ClickHouse/pull/48833) ([M1eyu](https://github.com/M1eyu2018)).
* Реализована команда SYSTEM DROP REPLICA из вспомогательных кластеров ZooKeeper, возможно, это позволит закрыть [#48931](https://github.com/ClickHouse/ClickHouse/issues/48931). [#48932](https://github.com/ClickHouse/ClickHouse/pull/48932) ([wangxiaobo](https://github.com/wzb5212)).
* Добавлен тип данных Array для MongoDB. Закрыта задача [#48598](https://github.com/ClickHouse/ClickHouse/issues/48598). [#48983](https://github.com/ClickHouse/ClickHouse/pull/48983) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена поддержка хранения типов данных `Interval` в таблицах. [#49085](https://github.com/ClickHouse/ClickHouse/pull/49085) ([larryluogit](https://github.com/larryluogit)).
* Теперь можно использовать оконную функцию `ntile` без явного определения рамки окна: `ntile(3) OVER (ORDER BY a)`, что закрывает [#46763](https://github.com/ClickHouse/ClickHouse/issues/46763). [#49093](https://github.com/ClickHouse/ClickHouse/pull/49093) ([vdimir](https://github.com/vdimir)).
* Добавлены настройки (`number_of_mutations_to_delay`, `number_of_mutations_to_throw`) для откладывания выполнения или выбрасывания исключения для запросов `ALTER`, которые создают мутации (`ALTER UPDATE`, `ALTER DELETE`, `ALTER MODIFY COLUMN`, ...), в случае, если в таблице уже накопилось много незавершённых мутаций. [#49117](https://github.com/ClickHouse/ClickHouse/pull/49117) ([Anton Popov](https://github.com/CurtizJ)).
* Перехватывать исключение, возникающее при вызове `create_directories`, в файловом кэше. [#49203](https://github.com/ClickHouse/ClickHouse/pull/49203) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Копирует встроенные примеры в новое поле `example` в таблице `system.functions`, чтобы дополнить поле `description`. [#49222](https://github.com/ClickHouse/ClickHouse/pull/49222) ([Dan Roscigno](https://github.com/DanRoscigno)).
* Включите параметры подключения для словаря MongoDB. Пример: `xml <source> <mongodb> <host>localhost</host> <port>27017</port> <user></user> <password></password> <db>test</db> <collection>dictionary_source</collection> <options>ssl=true</options> </mongodb> </source>` ### Запись в документации об изменениях, заметных пользователям. [#49225](https://github.com/ClickHouse/ClickHouse/pull/49225) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Добавлен псевдоним `asymptotic` для вычислительного метода `asymp` функции `kolmogorovSmirnovTest`. Улучшена документация. [#49286](https://github.com/ClickHouse/ClickHouse/pull/49286) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Агрегатные функции groupBitAnd/Or/Xor теперь работают со знаковыми целочисленными данными, что согласует их поведение с поведением скалярных функций bitAnd/Or/Xor. [#49292](https://github.com/ClickHouse/ClickHouse/pull/49292) ([exmy](https://github.com/exmy)).
* Документация по функциям разбита на более детализированные поля. [#49300](https://github.com/ClickHouse/ClickHouse/pull/49300) ([Robert Schulze](https://github.com/rschu1ze)).
* Используйте несколько потоков, общих для всех таблиц на сервере, для загрузки устаревших частей данных. Размер пула и очереди его задач контролируется настройками `max_outdated_parts_loading_thread_pool_size` и `outdated_part_loading_thread_pool_queue_size`. [#49317](https://github.com/ClickHouse/ClickHouse/pull/49317) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Не переоценивать размер обработанных данных для столбцов `LowCardinality`, когда они используют общие словари между блоками. Это закрывает [#49322](https://github.com/ClickHouse/ClickHouse/issues/49322). См. также [#48745](https://github.com/ClickHouse/ClickHouse/issues/48745). [#49323](https://github.com/ClickHouse/ClickHouse/pull/49323) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Parquet writer теперь использует более подходящий размер группы строк при использовании через `OUTFILE`. [#49325](https://github.com/ClickHouse/ClickHouse/pull/49325) ([Michael Kolupaev](https://github.com/al13n321)).
* Разрешить использование зарезервированных ключевых слов, таких как `ARRAY`, в качестве псевдонима, если псевдоним заключён в кавычки. Закрывает [#49324](https://github.com/ClickHouse/ClickHouse/issues/49324). [#49360](https://github.com/ClickHouse/ClickHouse/pull/49360) ([Nikolay Degterinsky](https://github.com/evillique)).
* Задачи загрузки и удаления частей данных были перенесены в общие серверные пулы вместо пулов на уровне отдельных таблиц. Размеры пулов управляются настройками `max_active_parts_loading_thread_pool_size`, `max_outdated_parts_loading_thread_pool_size` и `max_parts_cleaning_thread_pool_size` в конфигурации верхнего уровня. Настройки на уровне таблиц `max_part_loading_threads` и `max_part_removal_threads` объявлены устаревшими. [#49474](https://github.com/ClickHouse/ClickHouse/pull/49474) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Разрешено использование параметра `?password=pass` в URL интерфейса Play. Пароль заменяется в истории браузера. [#49505](https://github.com/ClickHouse/ClickHouse/pull/49505) ([Mike Kot](https://github.com/myrrc)).
* Добавлена возможность чтения объектов нулевого размера из удалённых файловых систем (так как пустые файлы не попадают в резервную копию, в результате в файле метаданных могут оказаться блобы нулевого размера). Закрывает [#49480](https://github.com/ClickHouse/ClickHouse/issues/49480). [#49519](https://github.com/ClickHouse/ClickHouse/pull/49519) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Присоединить `MemoryTracker` потока к `total_memory_tracker` после отсоединения `ThreadGroup`. [#49527](https://github.com/ClickHouse/ClickHouse/pull/49527) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена работа параметризованных представлений при повторном использовании одного и того же параметра в запросе. [#49556](https://github.com/ClickHouse/ClickHouse/pull/49556) ([Azat Khuzhin](https://github.com/azat)).
* Освобождает память, выделенную под последний отправленный снимок ProfileEvents в контексте запроса. Продолжение [#47564](https://github.com/ClickHouse/ClickHouse/issues/47564). [#49561](https://github.com/ClickHouse/ClickHouse/pull/49561) ([Dmitry Novik](https://github.com/novikd)).
* Функция «makeDate» теперь поддерживает перегрузку, совместимую с MySQL (аргументы: год и день года). [#49603](https://github.com/ClickHouse/ClickHouse/pull/49603) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена поддержка табличной функции `dictionary` для `RegExpTreeDictionary`. [#49666](https://github.com/ClickHouse/ClickHouse/pull/49666) ([Han Fei](https://github.com/hanfei1991)).
* Добавлена политика взвешенного справедливого планирования ввода-вывода. Добавлен динамический диспетчер ресурсов, который позволяет обновлять иерархию планирования ввода-вывода во время работы без перезапуска сервера. [#49671](https://github.com/ClickHouse/ClickHouse/pull/49671) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлен запрос compose после многокомпонентной загрузки в GCS. Это позволяет использовать операцию копирования для объектов, загруженных с помощью многокомпонентной загрузки. Рекомендуется задать для `s3_strict_upload_part_size` некоторое значение, поскольку запрос compose может завершиться с ошибкой для объектов, созданных из частей разного размера. [#49693](https://github.com/ClickHouse/ClickHouse/pull/49693) ([Antonio Andelic](https://github.com/antonio2368)).
* Для функции `extractKeyValuePairs`: улучшена логика разбора «по принципу best-effort», чтобы считать `key_value_delimiter` допустимой частью значения. Это также упрощает ветвление и может немного ускорить выполнение. [#49760](https://github.com/ClickHouse/ClickHouse/pull/49760) ([Arthur Passos](https://github.com/arthurpassos)).
* Добавлено поле `initial_query_id` в system.processors&#95;profile&#95;log [#49777](https://github.com/ClickHouse/ClickHouse/pull/49777) ([helifu](https://github.com/helifu)).
* Таблицы системных логов теперь могут иметь пользовательские ключи сортировки. [#49778](https://github.com/ClickHouse/ClickHouse/pull/49778) ([helifu](https://github.com/helifu)).
* Новое поле `partitions` в `system.query_log` используется для указания, какие партиции участвуют в вычислении. [#49779](https://github.com/ClickHouse/ClickHouse/pull/49779) ([helifu](https://github.com/helifu)).
* Добавлена настройка `enable_the_endpoint_id_with_zookeeper_name_prefix` для `ReplicatedMergeTree` (по умолчанию отключена). При включении к межсерверной конечной точке таблицы добавляется имя кластера ZooKeeper. Это позволяет избежать ошибок `Duplicate interserver IO endpoint` при наличии реплицированных таблиц с одинаковым путём, но разными дополнительными кластерами ZooKeeper. [#49780](https://github.com/ClickHouse/ClickHouse/pull/49780) ([helifu](https://github.com/helifu)).
* Добавлена поддержка параметров запроса в `clickhouse-local`. Закрывает [#46561](https://github.com/ClickHouse/ClickHouse/issues/46561). [#49785](https://github.com/ClickHouse/ClickHouse/pull/49785) ([Nikolay Degterinsky](https://github.com/evillique)).
* Теперь по умолчанию можно загружать словари и функции из YAML. В предыдущих версиях для этого требовалось отредактировать `dictionaries_config` или `user_defined_executable_functions_config` в файле конфигурации, так как они ожидали файлы `*.xml`. [#49812](https://github.com/ClickHouse/ClickHouse/pull/49812) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Табличный движок Kafka теперь позволяет использовать алиасы столбцов. [#49824](https://github.com/ClickHouse/ClickHouse/pull/49824) ([Aleksandr Musorin](https://github.com/AVMusorin)).
* Добавлена настройка для ограничения максимального числа пар, порождаемых `extractKeyValuePairs`, как предохранительная мера, чтобы избежать чрезмерного использования памяти. [#49836](https://github.com/ClickHouse/ClickHouse/pull/49836) ([Arthur Passos](https://github.com/arthurpassos)).
* Добавлена поддержка (необычного) случая, когда в операторе `IN` используются аргументы-одноэлементные кортежи. [#49844](https://github.com/ClickHouse/ClickHouse/pull/49844) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Функция `bitHammingDistance` теперь поддерживает типы данных `String` и `FixedString`. Закрывает [#48827](https://github.com/ClickHouse/ClickHouse/issues/48827). [#49858](https://github.com/ClickHouse/ClickHouse/pull/49858) ([flynn](https://github.com/ucasfl)).
* Исправлены ошибки сброса тайм-аута в клиенте под OS X. [#49863](https://github.com/ClickHouse/ClickHouse/pull/49863) ([alekar](https://github.com/alekar)).
* Добавлена поддержка больших целых чисел, таких как UInt128, Int128, UInt256 и Int256, для функции `bitCount`. Это позволяет вычислять расстояние Хэмминга по большим битовым маскам в приложениях ИИ. [#49867](https://github.com/ClickHouse/ClickHouse/pull/49867) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Отпечатки можно использовать вместо идентификаторов ключей для зашифрованных дисков. Это упрощает конфигурацию зашифрованных дисков. [#49882](https://github.com/ClickHouse/ClickHouse/pull/49882) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлен тип данных UUID в PostgreSQL. Закрывает [#49739](https://github.com/ClickHouse/ClickHouse/issues/49739). [#49894](https://github.com/ClickHouse/ClickHouse/pull/49894) ([Nikolay Degterinsky](https://github.com/evillique)).
* Функция `toUnixTimestamp` теперь принимает аргументы типов `Date` и `Date32`. [#49989](https://github.com/ClickHouse/ClickHouse/pull/49989) ([Victor Krasnov](https://github.com/sirvickr)).
* Начислять плату только за память сервера, используемую словарями. [#49995](https://github.com/ClickHouse/ClickHouse/pull/49995) ([Azat Khuzhin](https://github.com/azat)).
* Сервер будет разрешать использовать параметры `SQL_*`, такие как `SQL_AUTO_IS_NULL`, в качестве no-op (без эффекта) для совместимости с MySQL. Это закрывает [#49927](https://github.com/ClickHouse/ClickHouse/issues/49927). [#50013](https://github.com/ClickHouse/ClickHouse/pull/50013) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сохранять initial&#95;query&#95;id для запросов ON CLUSTER, что полезно для интроспекции (при `distributed_ddl_entry_format_version=5`). [#50015](https://github.com/ClickHouse/ClickHouse/pull/50015) ([Azat Khuzhin](https://github.com/azat)).
* Сохранить обратную несовместимость для переименованных настроек с помощью алиасов (`allow_experimental_projection_optimization` для `optimize_use_projections`, `allow_experimental_lightweight_delete` для `enable_lightweight_delete`). [#50044](https://github.com/ClickHouse/ClickHouse/pull/50044) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка передачи FQDN через настройку my&#95;hostname для регистрации узла кластера в Keeper. Добавлена настройка invisible для поддержки нескольких compute-групп. Compute-группа, рассматриваемая как кластер, невидима для других compute-групп. [#50186](https://github.com/ClickHouse/ClickHouse/pull/50186) ([Yangkuan Liu](https://github.com/LiuYangkuan)).
* Исправлена проблема, из-за которой PostgreSQL считывал все данные, даже когда мог быть указан `LIMIT n`. [#50187](https://github.com/ClickHouse/ClickHouse/pull/50187) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлены новые события профилирования для запросов с подзапросами (`QueriesWithSubqueries`/`SelectQueriesWithSubqueries`/`InsertQueriesWithSubqueries`). [#50204](https://github.com/ClickHouse/ClickHouse/pull/50204) ([Azat Khuzhin](https://github.com/azat)).
* Добавлено поле roles в файл users.xml, позволяющее задавать роли с правами доступа через конфигурационный файл. [#50278](https://github.com/ClickHouse/ClickHouse/pull/50278) ([pufit](https://github.com/pufit)).
* Сообщать `CGroupCpuCfsPeriod` и `CGroupCpuCfsQuota` в AsynchronousMetrics. — Учитывать ограничения памяти cgroup v2 при запуске сервера. [#50379](https://github.com/ClickHouse/ClickHouse/pull/50379) ([alekar](https://github.com/alekar)).
* Добавлен обработчик сигнала SIGQUIT, который работает так же, как SIGINT. Закрыта задача [#50298](https://github.com/ClickHouse/ClickHouse/issues/50298). [#50435](https://github.com/ClickHouse/ClickHouse/pull/50435) ([Nikolay Degterinsky](https://github.com/evillique)).
* В случае, если разбор JSON завершается с ошибкой из‑за слишком большого размера объекта, выводится последняя позиция для упрощения отладки. [#50474](https://github.com/ClickHouse/ClickHouse/pull/50474) ([Valentin Alexeev](https://github.com/valentinalexeev)).
* Добавлена поддержка десятичных чисел произвольного размера. Закрывает [#49130](https://github.com/ClickHouse/ClickHouse/issues/49130). [#50586](https://github.com/ClickHouse/ClickHouse/pull/50586) ([Kruglov Pavel](https://github.com/Avogar)).



#### Улучшение сборки/тестирования/упаковки {#buildtestingpackaging-improvement-7}

* Новый и улучшенный `keeper-bench`. Все настраивается из YAML/XML-файла: - генератор запросов - каждый тип генератора запросов может иметь собственный набор полей - multi-запросы могут быть сгенерированы просто задав ту же структуру под ключом `multi` - для каждого запроса или подзапроса в multi можно определить поле `weight` для управления распределением - можно задать деревья, которые нужно подготовить для тестового прогона - хосты можно задать с полностью настраиваемыми тайм-аутами и управлять количеством сессий, генерируемых для каждого хоста - целые числа, определенные полями `min_value` и `max_value`, являются генераторами случайных чисел. [#48547](https://github.com/ClickHouse/ClickHouse/pull/48547) ([Antonio Andelic](https://github.com/antonio2368)).
* Io&#95;uring не поддерживается на macOS, не выбирайте его при локальном запуске тестов, чтобы избежать случайных сбоев. [#49250](https://github.com/ClickHouse/ClickHouse/pull/49250) ([Frank Chen](https://github.com/FrankChen021)).
* Реализована поддержка именованной инъекции сбоев для тестирования. [#49361](https://github.com/ClickHouse/ClickHouse/pull/49361) ([Han Fei](https://github.com/hanfei1991)).
* Добавлена возможность запуска ClickHouse в ОС, где системный вызов `prctl` (process control) недоступен, например в AWS Lambda. [#49538](https://github.com/ClickHouse/ClickHouse/pull/49538) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена проблема конфликта при сборке между contrib/isa-l и isa-l в qpl [49296](https://github.com/ClickHouse/ClickHouse/issues/49296). [#49584](https://github.com/ClickHouse/ClickHouse/pull/49584) ([jasperzhu](https://github.com/jinjunzh)).
* Утилиты теперь собираются только при явном указании флага (&quot;-DENABLE&#95;UTILS=1&quot;), а не по умолчанию, что уменьшает время компоновки в типичных сборках для разработки. [#49620](https://github.com/ClickHouse/ClickHouse/pull/49620) ([Robert Schulze](https://github.com/rschu1ze)).
* Вынесено описание сборки idxd-config в отдельный файл CMake, чтобы избежать его случайного удаления в будущем. [#49651](https://github.com/ClickHouse/ClickHouse/pull/49651) ([jasperzhu](https://github.com/jinjunzh)).
* Добавлена проверка CI с включённым анализатором в ветке master. Продолжение [#49562](https://github.com/ClickHouse/ClickHouse/issues/49562). [#49668](https://github.com/ClickHouse/ClickHouse/pull/49668) ([Dmitry Novik](https://github.com/novikd)).
* Переход на LLVM/Clang 16. [#49678](https://github.com/ClickHouse/ClickHouse/pull/49678) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка сборки ClickHouse с clang-17. [#49851](https://github.com/ClickHouse/ClickHouse/pull/49851) ([Alexey Milovidov](https://github.com/alexey-milovidov)). [#50410](https://github.com/ClickHouse/ClickHouse/pull/50410) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Теперь ClickHouse проще интегрировать в другие проекты на CMake. [#49991](https://github.com/ClickHouse/ClickHouse/pull/49991) ([Amos Bird](https://github.com/amosbird)). (Что делать настоятельно не рекомендуется — Alexey Milovidov).
* Устранить странное дополнительное логирование QEMU после [#47151](https://github.com/ClickHouse/ClickHouse/issues/47151), см. [https://s3.amazonaws.com/clickhouse-test-reports/50078/a4743996ee4f3583884d07bcd6501df0cfdaa346/stateless&#95;tests&#95;&#95;release&#95;&#95;databasereplicated&#95;&#95;[3&#95;4].html](https://s3.amazonaws.com/clickhouse-test-reports/50078/a4743996ee4f3583884d07bcd6501df0cfdaa346/stateless_tests__release__databasereplicated__\[3_4].html). [#50442](https://github.com/ClickHouse/ClickHouse/pull/50442) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Теперь ClickHouse может работать на Linux RISC-V 6.1.22. Это закрывает [#50456](https://github.com/ClickHouse/ClickHouse/issues/50456). [#50457](https://github.com/ClickHouse/ClickHouse/pull/50457) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Обновлена внутренняя библиотека protobuf до v3.18 (исправляет ошибочно присвоенный CVE-2022-1941). [#50400](https://github.com/ClickHouse/ClickHouse/pull/50400) ([Robert Schulze](https://github.com/rschu1ze)).
* Обновлён внутренний libxml2 до версии v2.10.4 (исправляет ошибочно зарегистрированные уязвимости CVE-2023-28484 и CVE-2023-29469). [#50402](https://github.com/ClickHouse/ClickHouse/pull/50402) ([Robert Schulze](https://github.com/rschu1ze)).
* Обновлён c-ares до версии 1.19.1 (ложные CVE-2023-32067, CVE-2023-31130, CVE-2023-31147). [#50403](https://github.com/ClickHouse/ClickHouse/pull/50403) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлено ложное сообщение об уязвимости CVE-2022-2469 в libgsasl. [#50404](https://github.com/ClickHouse/ClickHouse/pull/50404) ([Robert Schulze](https://github.com/rschu1ze)).

#### Исправление ошибки (некорректное поведение, заметное пользователю, в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-7}

* ActionsDAG: исправлена некорректная оптимизация [#47584](https://github.com/ClickHouse/ClickHouse/pull/47584) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Корректно обрабатывать конкурентные снапшоты в Keeper [#48466](https://github.com/ClickHouse/ClickHouse/pull/48466) ([Antonio Andelic](https://github.com/antonio2368)).
* MergeTreeMarksLoader теперь содержит DataPart вместо DataPartStorage [#48515](https://github.com/ClickHouse/ClickHouse/pull/48515) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправление состояния последовательности [#48603](https://github.com/ClickHouse/ClickHouse/pull/48603) ([Ilya Golshtein](https://github.com/ilejn)).
* Проверка конкурентного выполнения операций Back/Restore при предыдущих сбоях [#48726](https://github.com/ClickHouse/ClickHouse/pull/48726) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлена ошибка, из-за которой присоединение таблицы с несуществующим ZK-путём не увеличивало метрику ReadonlyReplica [#48954](https://github.com/ClickHouse/ClickHouse/pull/48954) ([wangxiaobo](https://github.com/wzb5212)).
* Исправлены возможные вызовы функции terminate при необработанных исключениях в некоторых местах [#49112](https://github.com/ClickHouse/ClickHouse/pull/49112) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка «ключ не найден» для запросов с несколькими StorageJoin [#49137](https://github.com/ClickHouse/ClickHouse/pull/49137) ([vdimir](https://github.com/vdimir)).
* Исправлен неверный результат запроса при использовании первичного ключа с типом Nullable [#49172](https://github.com/ClickHouse/ClickHouse/pull/49172) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлена работа функций reinterpretAs*() на машинах с порядком байт big-endian [#49198](https://github.com/ClickHouse/ClickHouse/pull/49198) ([Suzy Wang](https://github.com/SuzyWangIBMer)).
* (Экспериментальная репликация zero-copy) Обеспечить более атомарную блокировку частей zero-copy [#49211](https://github.com/ClickHouse/ClickHouse/pull/49211) ([alesapin](https://github.com/alesapin)).
* Устранена гонка при загрузке устаревших частей [#49223](https://github.com/ClickHouse/ClickHouse/pull/49223) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена проблема, при которой, если все значения ключа были `NULL`, группировка с `ROLLUP` возвращала неверный результат [#49282](https://github.com/ClickHouse/ClickHouse/pull/49282) ([Shuai li](https://github.com/loneylee)).
* Исправлен расчёт `load_factor` для HASHED-словарей с SHARDS [#49319](https://github.com/ClickHouse/ClickHouse/pull/49319) ([Azat Khuzhin](https://github.com/azat)).
* Запретить настройку кодеков сжатия для столбцов-алиасов [#49363](https://github.com/ClickHouse/ClickHouse/pull/49363) ([Timur Solodovnikov](https://github.com/tsolodov)).
* Исправлена ошибка при удалении каталога существующей части [#49365](https://github.com/ClickHouse/ClickHouse/pull/49365) ([alesapin](https://github.com/alesapin)).
* Исправлена работа GCS при использовании HMAC [#49390](https://github.com/ClickHouse/ClickHouse/pull/49390) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка fuzz‑тестирования, из‑за которой набор подзапроса не строился при чтении из remote() [#49425](https://github.com/ClickHouse/ClickHouse/pull/49425) ([Alexander Gololobov](https://github.com/davenger)).
* Инвертировано значение настройки `shutdown_wait_unfinished_queries` [#49427](https://github.com/ClickHouse/ClickHouse/pull/49427) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* (Экспериментальная репликация с нулевым копированием) Исправлена ещё одна ошибка, связанная с нулевым копированием [#49473](https://github.com/ClickHouse/ClickHouse/pull/49473) ([alesapin](https://github.com/alesapin)).
* Исправлена настройка базы данных Postgres [#49481](https://github.com/ClickHouse/ClickHouse/pull/49481) ([Mal Curtis](https://github.com/snikch)).
* Исправлена обработка аргументов `s3Cluster` [#49490](https://github.com/ClickHouse/ClickHouse/pull/49490) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка в деструкторе TraceCollector. [#49508](https://github.com/ClickHouse/ClickHouse/pull/49508) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена ошибка, из-за которой AsynchronousReadIndirectBufferFromRemoteFS некорректно работал при коротких операциях seek [#49525](https://github.com/ClickHouse/ClickHouse/pull/49525) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлен порядок загрузки словарей [#49560](https://github.com/ClickHouse/ClickHouse/pull/49560) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Запретить изменение типа данных для столбца Object(&#39;json&#39;) [#49563](https://github.com/ClickHouse/ClickHouse/pull/49563) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлен стресс-тест (логическая ошибка: Expected 7134 &gt;= 11030) [#49623](https://github.com/ClickHouse/ClickHouse/pull/49623) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка в операторе DISTINCT [#49628](https://github.com/ClickHouse/ClickHouse/pull/49628) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено: DISTINCT в ORDER BY с нулевыми значениями в неотсортированных столбцах [#49636](https://github.com/ClickHouse/ClickHouse/pull/49636) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлена off-by-one ошибка в больших целых числах, обнаруженная UBSan вместе с фаззером [#49645](https://github.com/ClickHouse/ClickHouse/pull/49645) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка чтения разрежённых столбцов после перезапуска [#49660](https://github.com/ClickHouse/ClickHouse/pull/49660) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен assert в SpanHolder::finish() при работе с fibers [#49673](https://github.com/ClickHouse/ClickHouse/pull/49673) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлены функции с укороченным вычислением и мутации с разрежёнными аргументами [#49716](https://github.com/ClickHouse/ClickHouse/pull/49716) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена запись добавленных файлов при создании инкрементных резервных копий [#49725](https://github.com/ClickHouse/ClickHouse/pull/49725) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена ошибка &quot;There is no physical column &#95;row&#95;exists in table&quot;, возникающая при выполнении мутации lightweight delete над таблицей с колонкой типа Object. [#49737](https://github.com/ClickHouse/ClickHouse/pull/49737) ([Alexander Gololobov](https://github.com/davenger)).
* Устранена ошибка msan в randomStringUTF8(uneven number) [#49750](https://github.com/ClickHouse/ClickHouse/pull/49750) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена агрегатная функция kolmogorovSmirnovTest [#49768](https://github.com/ClickHouse/ClickHouse/pull/49768) ([FFFFFFFHHHHHHH](https://github.com/FFFFFFFHHHHHHH)).
* Исправлены алиасы настроек в нативном протоколе [#49776](https://github.com/ClickHouse/ClickHouse/pull/49776) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа `arrayMap` с массивом кортежей из одного элемента [#49789](https://github.com/ClickHouse/ClickHouse/pull/49789) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены настройки лимитирования ввода-вывода и резервного копирования для отдельных запросов [#49797](https://github.com/ClickHouse/ClickHouse/pull/49797) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена обработка значения NULL в определении профиля [#49831](https://github.com/ClickHouse/ClickHouse/pull/49831) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена ошибка, связанная с проекциями и настройкой aggregate&#95;functions&#95;null&#95;for&#95;empty (для query&#95;plan&#95;optimize&#95;projection) [#49873](https://github.com/ClickHouse/ClickHouse/pull/49873) ([Amos Bird](https://github.com/amosbird)).
* Исправлена обработка ожидающего батча для асинхронного INSERT в Distributed после перезапуска [#49884](https://github.com/ClickHouse/ClickHouse/pull/49884) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проверка assert в CacheMetadata::doCleanup [#49914](https://github.com/ClickHouse/ClickHouse/pull/49914) ([Kseniia Sumarokova](https://github.com/kssenii)).
* исправлен параметр `is_prefix` в OptimizeRegularExpression [#49919](https://github.com/ClickHouse/ClickHouse/pull/49919) ([Han Fei](https://github.com/hanfei1991)).
* Исправлены метрики `WriteBufferFromS3Bytes`, `WriteBufferFromS3Microseconds` и `WriteBufferFromS3RequestsErrors` [#49930](https://github.com/ClickHouse/ClickHouse/pull/49930) ([Aleksandr Musorin](https://github.com/AVMusorin)).
* Исправлена кодировка IPv6 в Protobuf [#49933](https://github.com/ClickHouse/ClickHouse/pull/49933) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена возможная логическая ошибка при некорректном разборе `Nullable` в текстовых форматах [#49960](https://github.com/ClickHouse/ClickHouse/pull/49960) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена настройка output&#95;format&#95;parquet&#95;compliant&#95;nested&#95;types для создания более совместимых файлов Parquet [#50001](https://github.com/ClickHouse/ClickHouse/pull/50001) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена логическая ошибка в стресс-тесте &quot;Not enough space to add ...&quot; [#50021](https://github.com/ClickHouse/ClickHouse/pull/50021) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Предотвращена взаимоблокировка при запуске таблицы в потоке attach `ReplicatedMergeTree` [#50026](https://github.com/ClickHouse/ClickHouse/pull/50026) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлен assert в SpanHolder::finish() при использовании fibers, попытка 2 [#50034](https://github.com/ClickHouse/ClickHouse/pull/50034) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлено корректное экранирование контекста OpenTelemetry при сериализации в DDL [#50045](https://github.com/ClickHouse/ClickHouse/pull/50045) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено формирование отчётов о повреждённых частях проекций [#50052](https://github.com/ClickHouse/ClickHouse/pull/50052) ([Amos Bird](https://github.com/amosbird)).
* Исправление JIT-компиляции оператора «!= NaN» [#50056](https://github.com/ClickHouse/ClickHouse/pull/50056) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлен сбой при использовании базы данных Replicated без аргументов [#50058](https://github.com/ClickHouse/ClickHouse/pull/50058) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено падение при использовании `multiIf` с константным условием и nullable-аргументами [#50123](https://github.com/ClickHouse/ClickHouse/pull/50123) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка некорректного анализа индекса для ключей, связанных с датой [#50153](https://github.com/ClickHouse/ClickHouse/pull/50153) ([Amos Bird](https://github.com/amosbird)).
* не разрешать изменять ORDER BY, когда нет столбцов ORDER BY [#50154](https://github.com/ClickHouse/ClickHouse/pull/50154) ([Han Fei](https://github.com/hanfei1991)).
* Исправлен некорректный анализ индекса при использовании бинарного оператора с константным аргументом NULL [#50177](https://github.com/ClickHouse/ClickHouse/pull/50177) ([Amos Bird](https://github.com/amosbird)).
* clickhouse-client: запрещено одновременное использование `--query` и `--queries-file` [#50210](https://github.com/ClickHouse/ClickHouse/pull/50210) ([Alexey Gerasimchuk](https://github.com/Demilivor)).
* Исправлено неопределённое поведение в расширениях INTO OUTFILE (APPEND / AND STDOUT) и WATCH EVENTS [#50216](https://github.com/ClickHouse/ClickHouse/pull/50216) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен пропуск пробелов в конце строки в формате CustomSeparatedIgnoreSpaces [#50224](https://github.com/ClickHouse/ClickHouse/pull/50224) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен разбор метаданных Iceberg [#50232](https://github.com/ClickHouse/ClickHouse/pull/50232) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен вложенный распределённый SELECT в предложении WITH [#50234](https://github.com/ClickHouse/ClickHouse/pull/50234) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема msan в keyed SipHash [#50245](https://github.com/ClickHouse/ClickHouse/pull/50245) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлены ошибки в сокетах Poco в неблокирующем режиме и теперь используются по-настоящему неблокирующие сокеты [#50252](https://github.com/ClickHouse/ClickHouse/pull/50252) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено вычисление контрольной суммы для записей в резервной копии [#50264](https://github.com/ClickHouse/ClickHouse/pull/50264) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправление обработки NaN в функциях сравнения [#50287](https://github.com/ClickHouse/ClickHouse/pull/50287) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправление JIT-агрегации с ключом типа Nullable [#50291](https://github.com/ClickHouse/ClickHouse/pull/50291) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена ошибка, из-за которой clickhouse-local падал при записи пустого вывода в форматах Arrow или Parquet [#50328](https://github.com/ClickHouse/ClickHouse/pull/50328) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлено падение при вызове Pool::Entry::disconnect() [#50334](https://github.com/ClickHouse/ClickHouse/pull/50334) ([Val Doroshchuk](https://github.com/valbok)).
* Улучшена операция fetch части за счёт более длительного удержания блокировки каталога [#50339](https://github.com/ClickHouse/ClickHouse/pull/50339) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлены функции bitShift* при использовании двух константных аргументов [#50343](https://github.com/ClickHouse/ClickHouse/pull/50343) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена взаимоблокировка Keeper при возникновении исключения в процессе предварительной обработки запросов. [#50387](https://github.com/ClickHouse/ClickHouse/pull/50387) ([frinkr](https://github.com/frinkr)).
* Исправлено хеширование константных целочисленных значений [#50421](https://github.com/ClickHouse/ClickHouse/pull/50421) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлены настройки merge&#95;tree&#95;min&#95;rows&#95;for&#95;seek/merge&#95;tree&#95;min&#95;bytes&#95;for&#95;seek для индексов пропуска данных [#50432](https://github.com/ClickHouse/ClickHouse/pull/50432) ([Azat Khuzhin](https://github.com/azat)).
* Ограничено число одновременно выполняющихся задач загрузки устаревших частей [#50450](https://github.com/ClickHouse/ClickHouse/pull/50450) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправление в Keeper: применять незакоммиченное состояние после установки снапшота [#50483](https://github.com/ClickHouse/ClickHouse/pull/50483) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка некорректной свёртки констант [#50536](https://github.com/ClickHouse/ClickHouse/pull/50536) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена логическая ошибка в стресс-тесте (Not enough space to add ...) [#50583](https://github.com/ClickHouse/ClickHouse/pull/50583) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено преобразование значения Null в LowCardinality(Nullable) в табличной функции values [#50637](https://github.com/ClickHouse/ClickHouse/pull/50637) ([Kruglov Pavel](https://github.com/Avogar)).
* Отменена некорректная оптимизация для RegExpTreeDictionary [#50642](https://github.com/ClickHouse/ClickHouse/pull/50642) ([Johann Gan](https://github.com/johanngan)).

### <a id="234"></a> Релиз ClickHouse 23.4, 2023-04-26 {#234}

#### Изменения, несовместимые с предыдущими версиями {#backward-incompatible-change-7}
* Форматтер `%M` в функции `formatDateTime()` теперь выводит название месяца вместо минут. Это делает поведение согласованным с MySQL. Предыдущее поведение можно восстановить, используя настройку `formatdatetime_parsedatetime_m_is_month_name = 0`. [#47246](https://github.com/ClickHouse/ClickHouse/pull/47246) ([Robert Schulze](https://github.com/rschu1ze)).
* Это изменение имеет смысл только если вы используете кэш виртуальной файловой системы. Если `path` в конфигурации кэша виртуальной файловой системы не пуст и не является абсолютным путем, то он будет размещен в `<clickhouse server data directory>/caches/<path_from_cache_config>`. [#48784](https://github.com/ClickHouse/ClickHouse/pull/48784) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Первичные/вторичные индексы и ключи сортировки с идентичными выражениями теперь отклоняются. Это поведение можно отключить с помощью настройки `allow_suspicious_indices`. [#48536](https://github.com/ClickHouse/ClickHouse/pull/48536) ([凌涛](https://github.com/lingtaolf)).

#### Новая возможность {#new-feature-8}

* Поддержка новой агрегатной функции `quantileGK`/`quantilesGK`, подобной [approx&#95;percentile](https://spark.apache.org/docs/latest/api/sql/index.html#approx_percentile) в Spark. Алгоритм Greenwald–Khanna описан в [http://infolab.stanford.edu/~datar/courses/cs361a/papers/quantiles.pdf](http://infolab.stanford.edu/~datar/courses/cs361a/papers/quantiles.pdf). [#46428](https://github.com/ClickHouse/ClickHouse/pull/46428) ([李扬](https://github.com/taiyang-li)).
* Добавлен оператор `SHOW COLUMNS`, показывающий сводную информацию из system.columns. [#48017](https://github.com/ClickHouse/ClickHouse/pull/48017) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлены модификаторы `LIGHTWEIGHT` и `PULL` для запроса `SYSTEM SYNC REPLICA`. Версия `LIGHTWEIGHT` ожидает только загрузки данных (fetches) и операции удаления диапазонов (drop-ranges) (слияния и мутации игнорируются). Версия `PULL` получает новые записи из ZooKeeper и не дожидается их обработки. Исправлена [#47794](https://github.com/ClickHouse/ClickHouse/issues/47794). [#48085](https://github.com/ClickHouse/ClickHouse/pull/48085) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Добавлена функция `kafkaMurmurHash` для совместимости со стандартным партиционером Kafka (DefaultPartitioner). Закрывает [#47834](https://github.com/ClickHouse/ClickHouse/issues/47834). [#48185](https://github.com/ClickHouse/ClickHouse/pull/48185) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена возможность легко создавать пользователя с теми же правами, что и у текущего пользователя, с помощью `GRANT CURRENT GRANTS`. [#48262](https://github.com/ClickHouse/ClickHouse/pull/48262) ([pufit](https://github.com/pufit)).
* Добавлена статистическая агрегатная функция `kolmogorovSmirnovTest`. Закрывает [#48228](https://github.com/ClickHouse/ClickHouse/issues/48228). [#48325](https://github.com/ClickHouse/ClickHouse/pull/48325) ([FFFFFFFHHHHHHH](https://github.com/FFFFFFFHHHHHHH)).
* Добавлен столбец `lost_part_count` в таблицу `system.replicas`. Значение столбца показывает общее количество потерянных частей в соответствующей таблице. Значение хранится в ZooKeeper и может использоваться вместо неперсистентного события профиля `ReplicatedDataLoss` для мониторинга. [#48526](https://github.com/ClickHouse/ClickHouse/pull/48526) ([Sergei Trifonov](https://github.com/serxa)).
* Добавлена функция `soundex` для обеспечения совместимости. Закрывает [#39880](https://github.com/ClickHouse/ClickHouse/issues/39880). [#48567](https://github.com/ClickHouse/ClickHouse/pull/48567) ([FriendLey](https://github.com/FriendLey)).
* Добавлена поддержка типа `Map` для JSONExtract. [#48629](https://github.com/ClickHouse/ClickHouse/pull/48629) ([李扬](https://github.com/taiyang-li)).
* Добавлен формат `PrettyJSONEachRow` для вывода красиво отформатированного JSON с разделителями в виде переводов строки и отступом в 4 пробела. [#48898](https://github.com/ClickHouse/ClickHouse/pull/48898) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен формат ввода `ParquetMetadata` для чтения метаданных файлов Parquet. [#48911](https://github.com/ClickHouse/ClickHouse/pull/48911) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена функция `extractKeyValuePairs` для извлечения пар ключ-значение из строк. Входные строки могут содержать шум (например, из файлов логов и не обязаны быть на 100% отформатированы в виде пар ключ-значение), алгоритм будет искать пары ключ-значение, соответствующие аргументам, переданным в функцию. В настоящее время функция принимает следующие аргументы: `data_column` (обязательный), `key_value_pair_delimiter` (по умолчанию `:`), `pair_delimiters` (по умолчанию `\space \, \;`) и `quoting_character` (по умолчанию двойные кавычки). [#43606](https://github.com/ClickHouse/ClickHouse/pull/43606) ([Arthur Passos](https://github.com/arthurpassos)).
* Функции replaceOne(), replaceAll(), replaceRegexpOne() и replaceRegexpAll() теперь могут вызываться с неконстантными аргументами шаблона и замены. [#46589](https://github.com/ClickHouse/ClickHouse/pull/46589) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлены функции для работы со столбцами типа `Map`: `mapConcat`, `mapSort`, `mapExists`. [#48071](https://github.com/ClickHouse/ClickHouse/pull/48071) ([Anton Popov](https://github.com/CurtizJ)).

#### Улучшение производительности {#performance-improvement-8}
* Чтение файлов в формате `Parquet` теперь существенно быстрее. Операции ввода-вывода и декодирование выполняются параллельно (управляется настройкой `max_threads`), и считываются только необходимые диапазоны данных. [#47964](https://github.com/ClickHouse/ClickHouse/pull/47964) ([Michael Kolupaev](https://github.com/al13n321)).
* При запуске мутации с IN (подзапросом) вида: `ALTER TABLE t UPDATE col='new value' WHERE id IN (SELECT id FROM huge_table)` и наличии у таблицы `t` нескольких частей для каждой части в памяти строится множество для подзапроса `SELECT id FROM huge_table`. Если частей много, это может потреблять значительный объём памяти (и приводить к OOM) и CPU. Решение — ввести краткоживущий кэш множеств, которые в данный момент строятся задачами мутации. Если другая задача той же мутации выполняется параллельно, она может найти множество в кэше, дождаться завершения его построения и переиспользовать его. [#46835](https://github.com/ClickHouse/ClickHouse/pull/46835) ([Alexander Gololobov](https://github.com/davenger)).
* Проверять зависимости только при необходимости при выполнении запросов `ALTER TABLE`. [#48062](https://github.com/ClickHouse/ClickHouse/pull/48062) ([Raúl Marín](https://github.com/Algunenano)).
* Оптимизирована функция `mapUpdate`. [#48118](https://github.com/ClickHouse/ClickHouse/pull/48118) ([Anton Popov](https://github.com/CurtizJ)).
* Теперь внутренний запрос к локальной реплике отправляется явно, а данные из него принимаются через loopback-интерфейс. Настройка `prefer_localhost_replica` не учитывается для параллельных реплик. Это нужно для более эффективного планирования и делает код более чистым: инициатор отвечает только за координацию процесса чтения и слияние результатов, непрерывно отвечая на запросы, в то время как все вторичные запросы читают данные. Примечание: использование loopback-интерфейса само по себе менее производительно, но без него некоторые реплики могли бы «голодать» по задачам, что приводило бы к ещё более медленному выполнению запросов и недоиспользованию доступных ресурсов. Инициализация координатора теперь ещё более ленивaя. Все входящие запросы содержат информацию об алгоритме чтения; мы инициализируем координатора этим алгоритмом при поступлении первого запроса. Если какая-либо реплика решит читать с другим алгоритмом — будет выброшено исключение, и запрос будет прерван. [#48246](https://github.com/ClickHouse/ClickHouse/pull/48246) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Не строить множество для правой части выражения `IN` с подзапросом, когда оно используется только для анализа skip-индексов и эти индексы отключены настройкой (`use_skip_indexes=0`). Ранее это могло отрицательно влиять на производительность запросов. [#48299](https://github.com/ClickHouse/ClickHouse/pull/48299) ([Anton Popov](https://github.com/CurtizJ)).
* Обработка запроса распараллеливается сразу после чтения `FROM file(...)`. Связано с [#38755](https://github.com/ClickHouse/ClickHouse/issues/38755). [#48525](https://github.com/ClickHouse/ClickHouse/pull/48525) ([Igor Nikonov](https://github.com/devcrafter)). Обработка запроса распараллеливается сразу после чтения из любого источника данных. Затронуты в основном простые или внешние хранилища, такие как табличные функции `url`, `file`. [#48727](https://github.com/ClickHouse/ClickHouse/pull/48727) ([Igor Nikonov](https://github.com/devcrafter)). Это контролируется настройкой `parallelize_output_from_storages`, которая по умолчанию отключена.
* Уменьшена конкуренция за мьютекс в ThreadPool (может повысить производительность при очень большом количестве мелких задач). [#48750](https://github.com/ClickHouse/ClickHouse/pull/48750) ([Sergei Trifonov](https://github.com/serxa)).
* Снижено потребление памяти при нескольких мутациях `ALTER DELETE`. [#48522](https://github.com/ClickHouse/ClickHouse/pull/48522) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Удалены избыточные попытки подключения, если включена настройка `skip_unavailable_shards`. [#48771](https://github.com/ClickHouse/ClickHouse/pull/48771) ([Azat Khuzhin](https://github.com/azat)).

#### Экспериментальная функция {#experimental-feature-5}
* Записи в кэше запросов теперь схлопываются до max_block_size и сжимаются. [#45912](https://github.com/ClickHouse/ClickHouse/pull/45912) ([Robert Schulze](https://github.com/rschu1ze)).
* Теперь можно задавать квоты в кэше запросов для отдельных пользователей. [#48284](https://github.com/ClickHouse/ClickHouse/pull/48284) ([Robert Schulze](https://github.com/rschu1ze)).
* Некоторые исправления механизма параллельных реплик. [#48433](https://github.com/ClickHouse/ClickHouse/pull/48433) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Реализована zero-copy-replication (экспериментальная функция) на зашифрованных дисках. [#48741](https://github.com/ClickHouse/ClickHouse/pull/48741) ([Vitaly Baranov](https://github.com/vitlibar)).

#### Улучшение {#improvement-8}

* Увеличено значение по умолчанию для `connect_timeout_with_failover_ms` до 1000 мс (в связи с добавлением асинхронных подключений в [https://github.com/ClickHouse/ClickHouse/pull/47229](https://github.com/ClickHouse/ClickHouse/pull/47229)). Закрывает [#5188](https://github.com/ClickHouse/ClickHouse/issues/5188). [#49009](https://github.com/ClickHouse/ClickHouse/pull/49009) ([Kruglov Pavel](https://github.com/Avogar)).
* Несколько улучшений, связанных с озёрами данных: - Обеспечена работа `Iceberg` с данными без разбиения на разделы (non-partitioned). - Добавлена поддержка формата `Iceberg` версии v2 (ранее поддерживалась только v1). - Добавлена поддержка чтения данных с разбиением на разделы (partitioned) для `DeltaLake`/`Hudi`. - Ускорено чтение метаданных `DeltaLake` за счёт использования файлов контрольных точек Delta (checkpoint-файлов). - Исправлено некорректное чтение `Hudi`: ранее неправильно выбиралось, какие данные читать, и поэтому корректно обрабатывались только таблицы небольшого размера. - Эти движки теперь подхватывают обновления изменённых данных (ранее состояние фиксировалось при создании таблицы). - Организовано корректное тестирование `Iceberg`/`DeltaLake`/`Hudi` с использованием Spark. [#47307](https://github.com/ClickHouse/ClickHouse/pull/47307) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавить асинхронное соединение по сокету и асинхронную запись в сокет. Сделать создание соединений и отправку запросов и внешних таблиц асинхронными по всем шардам. Рефакторинг кода с использованием fibers. Закрывает [#46931](https://github.com/ClickHouse/ClickHouse/issues/46931). После этого PR мы сможем увеличить значение `connect_timeout_with_failover_ms` по умолчанию ([https://github.com/ClickHouse/ClickHouse/issues/5188](https://github.com/ClickHouse/ClickHouse/issues/5188)). [#47229](https://github.com/ClickHouse/ClickHouse/pull/47229) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка конфигурационных секций `keeper`/`keeper_server` в качестве альтернативы `zookeeper`. Закрыты [#34766](https://github.com/ClickHouse/ClickHouse/issues/34766), [#34767](https://github.com/ClickHouse/ClickHouse/issues/34767). [#35113](https://github.com/ClickHouse/ClickHouse/pull/35113) ([李扬](https://github.com/taiyang-li)).
* Теперь можно устанавливать флаг *secure* в named&#95;collections для словаря с источником типа таблицы ClickHouse. См. [#38450](https://github.com/ClickHouse/ClickHouse/issues/38450). [#46323](https://github.com/ClickHouse/ClickHouse/pull/46323) ([Ilya Golshtein](https://github.com/ilejn)).
* Функция `bitCount` поддерживает типы данных `FixedString` и `String`. [#49044](https://github.com/ClickHouse/ClickHouse/pull/49044) ([flynn](https://github.com/ucasfl)).
* Добавлены настраиваемые повторные попытки для всех операций с [Zoo]Keeper в запросах резервного копирования. [#47224](https://github.com/ClickHouse/ClickHouse/pull/47224) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Включить `use_environment_credentials` для S3 по умолчанию, чтобы по умолчанию формировалась полная цепочка провайдеров учетных данных. [#47397](https://github.com/ClickHouse/ClickHouse/pull/47397) ([Antonio Andelic](https://github.com/antonio2368)).
* В настоящее время функция JSON&#95;VALUE по своей семантике близка к функции Spark get&#95;json&#95;object, которая позволяет получать значение из JSON-строки по пути вида &#39;$.key&#39;. Однако есть отличия: 1) в Spark get&#95;json&#95;object возвращается null, если путь не существует, тогда как JSON&#95;VALUE возвращает пустую строку; 2) в Spark get&#95;json&#95;object может возвращаться значение сложного типа, например объект/массив JSON, тогда как JSON&#95;VALUE в этом случае возвращает пустую строку. [#47494](https://github.com/ClickHouse/ClickHouse/pull/47494) ([KevinyhZou](https://github.com/KevinyhZou)).
* Для `use_structure_from_insertion_table_in_table_functions` реализована более гибкая передача структуры таблицы-вставки в табличную функцию. Исправлена проблема с сопоставлением имён и использованием виртуальных столбцов. Больше нет необходимости в параметре &#39;auto&#39;. [#47962](https://github.com/ClickHouse/ClickHouse/pull/47962) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Не продолжать повторные попытки подключиться к Keeper, если запрос был принудительно остановлен или превысил ограничения. [#47985](https://github.com/ClickHouse/ClickHouse/pull/47985) ([Raúl Marín](https://github.com/Algunenano)).
* Реализована поддержка чтения и записи Enum в `BSONEachRow`, разрешены все типы ключей Map и устранены лишние вычисления при выводе. [#48122](https://github.com/ClickHouse/ClickHouse/pull/48122) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка большего числа типов данных ClickHouse в форматах `ORC`/`Arrow`/`Parquet`: Enum(8|16), (U)Int(128|256), Decimal256 (для ORC), добавлена возможность чтения IPv4 из значений Int32 (ORC выводит IPv4 как Int32, и ранее мы не могли прочитать его обратно), исправлено чтение Nullable(IPv6) из двоичных данных для `ORC`. [#48126](https://github.com/ClickHouse/ClickHouse/pull/48126) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлены столбцы `perform_ttl_move_on_insert`, `load_balancing` в таблице `system.storage_policies`, изменён тип столбца `volume_type` на `Enum8`. [#48167](https://github.com/ClickHouse/ClickHouse/pull/48167) ([lizhuoyu5](https://github.com/lzydmxy)).
* Добавлена поддержка команды `BACKUP ALL`, которая выполняет резервное копирование всех таблиц и баз данных, включая временные и системные. [#48189](https://github.com/ClickHouse/ClickHouse/pull/48189) ([Vitaly Baranov](https://github.com/vitlibar)).
* Функция mapFromArrays поддерживает тип `Map` в качестве входного типа. [#48207](https://github.com/ClickHouse/ClickHouse/pull/48207) ([李扬](https://github.com/taiyang-li)).
* Теперь вывод некоторых SHOW PROCESSLIST теперь сортируется. [#48241](https://github.com/ClickHouse/ClickHouse/pull/48241) ([Robert Schulze](https://github.com/rschu1ze)).
* Ограничение скорости на уровне запроса/сервера для удалённого ввода-вывода, локального ввода-вывода и операций BACKUP (настройки сервера: `max_remote_read_network_bandwidth_for_server`, `max_remote_write_network_bandwidth_for_server`, `max_local_read_bandwidth_for_server`, `max_local_write_bandwidth_for_server`, `max_backup_bandwidth_for_server`, настройки запроса: `max_remote_read_network_bandwidth`, `max_remote_write_network_bandwidth`, `max_local_read_bandwidth`, `max_local_write_bandwidth`, `max_backup_bandwidth`). [#48242](https://github.com/ClickHouse/ClickHouse/pull/48242) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка большего числа типов в формате `CapnProto`: Map, (U)Int(128|256), Decimal(128|256). Разрешены преобразования целочисленных типов при вводе/выводе. [#48257](https://github.com/ClickHouse/ClickHouse/pull/48257) ([Kruglov Pavel](https://github.com/Avogar)).
* Не выбрасывать исключение CURRENT&#95;WRITE&#95;BUFFER&#95;IS&#95;EXHAUSTED при нормальном поведении. [#48288](https://github.com/ClickHouse/ClickHouse/pull/48288) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлена новая настройка `keeper_map_strict_mode`, которая обеспечивает дополнительные гарантии при операциях, выполняемых над таблицами `KeeperMap`. [#48293](https://github.com/ClickHouse/ClickHouse/pull/48293) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена проверка того, что тип первичного ключа для простого словаря является нативным беззнаковым целочисленным типом. Добавлена настройка `check_dictionary_primary_key` для обратной совместимости (установите `check_dictionary_primary_key = false`, чтобы отключить проверку). [#48335](https://github.com/ClickHouse/ClickHouse/pull/48335) ([lizhuoyu5](https://github.com/lzydmxy)).
* Не реплицируйте мутации для `KeeperMap` — в этом нет необходимости. [#48354](https://github.com/ClickHouse/ClickHouse/pull/48354) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена поддержка записи и чтения безымянного Tuple как вложенного Message в формате Protobuf. Элементы Tuple и поля Message сопоставляются по позиции. [#48390](https://github.com/ClickHouse/ClickHouse/pull/48390) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка настроек `additional_table_filters` и `additional_result_filter` в новом планировщике. Также добавлено описание `additional_result_filter` в документации. [#48405](https://github.com/ClickHouse/ClickHouse/pull/48405) ([Dmitry Novik](https://github.com/novikd)).
* `parseDateTime` теперь поддерживает спецификатор формата &#39;%f&#39; (дробные секунды). [#48420](https://github.com/ClickHouse/ClickHouse/pull/48420) ([Robert Schulze](https://github.com/rschu1ze)).
* Спецификатор формата &quot;%f&quot; в функции formatDateTime() теперь выводит &quot;000000&quot;, если форматируемое значение не содержит долей секунды; предыдущее поведение (один ноль) можно восстановить с помощью настройки &quot;formatdatetime&#95;f&#95;prints&#95;single&#95;zero = 1&quot;. [#48422](https://github.com/ClickHouse/ClickHouse/pull/48422) ([Robert Schulze](https://github.com/rschu1ze)).
* Не реплицировать операции DELETE и TRUNCATE для KeeperMap. [#48434](https://github.com/ClickHouse/ClickHouse/pull/48434) ([Antonio Andelic](https://github.com/antonio2368)).
* Генерировать корректные значения типов Decimal и Bool в функции generateRandom. [#48436](https://github.com/ClickHouse/ClickHouse/pull/48436) ([Kruglov Pavel](https://github.com/Avogar)).
* Разрешено использование завершающих запятых в списке выражений запроса SELECT, например `SELECT a, b, c, FROM table`. Закрывает [#37802](https://github.com/ClickHouse/ClickHouse/issues/37802). [#48438](https://github.com/ClickHouse/ClickHouse/pull/48438) ([Nikolay Degterinsky](https://github.com/evillique)).
* Переопределяет переменные окружения `CLICKHOUSE_USER` и `CLICKHOUSE_PASSWORD` значениями клиентских параметров `--user` и `--password`. Закрывает [#38909](https://github.com/ClickHouse/ClickHouse/issues/38909). [#48440](https://github.com/ClickHouse/ClickHouse/pull/48440) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлены повторные попытки загрузки частей данных в таблицах `MergeTree` в случае повторяемых ошибок. [#48442](https://github.com/ClickHouse/ClickHouse/pull/48442) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена поддержка типов данных `Date`, `Date32`, `DateTime`, `DateTime64` в функциях `arrayMin`, `arrayMax`, `arrayDifference`. Закрывает [#21645](https://github.com/ClickHouse/ClickHouse/issues/21645). [#48445](https://github.com/ClickHouse/ClickHouse/pull/48445) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена поддержка макроса `{server_uuid}`. Он полезен для идентификации реплик в автомасштабируемых кластерах, когда новые реплики постоянно добавляются и удаляются в процессе работы. Закрывает [#48554](https://github.com/ClickHouse/ClickHouse/issues/48554). [#48563](https://github.com/ClickHouse/ClickHouse/pull/48563) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Скрипт установки будет создавать жёсткую ссылку вместо копирования, если это возможно. [#48578](https://github.com/ClickHouse/ClickHouse/pull/48578) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка синтаксиса `SHOW TABLE`, эквивалентного `SHOW CREATE TABLE`. Закрывает [#48580](https://github.com/ClickHouse/ClickHouse/issues/48580). [#48591](https://github.com/ClickHouse/ClickHouse/pull/48591) ([flynn](https://github.com/ucasfl)).
* HTTP временные буферы теперь поддерживают вытеснение данных из кеша виртуальной файловой системы. [#48664](https://github.com/ClickHouse/ClickHouse/pull/48664) ([Vladimir C](https://github.com/vdimir)).
* Реализован вывод схемы для `CREATE AS SELECT`. Closes [#47599](https://github.com/ClickHouse/ClickHouse/issues/47599). [#48679](https://github.com/ClickHouse/ClickHouse/pull/48679) ([flynn](https://github.com/ucasfl)).
* Добавлен параметр `replicated_max_mutations_in_one_entry` для `ReplicatedMergeTree`, который позволяет ограничить число команд мутации в одной записи `MUTATE_PART` (значение по умолчанию — 10000). [#48731](https://github.com/ClickHouse/ClickHouse/pull/48731) ([Alexander Tokmakov](https://github.com/tavplubix)).
* В типах AggregateFunction больше не учитываются неиспользованные байты арены при вычислении `read_bytes`. [#48745](https://github.com/ClickHouse/ClickHouse/pull/48745) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена проблема, из-за которой некоторые настройки MySQL не обрабатывались при использовании источника словаря MySQL вместе с именованной коллекцией. Закрывает [#48402](https://github.com/ClickHouse/ClickHouse/issues/48402). [#48759](https://github.com/ClickHouse/ClickHouse/pull/48759) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Если пользователь установил параметр `max_single_part_upload_size` в слишком большое значение, это может привести к аварийному завершению работы из-за ошибки в AWS S3 SDK. Это исправляет [#47679](https://github.com/ClickHouse/ClickHouse/issues/47679). [#48816](https://github.com/ClickHouse/ClickHouse/pull/48816) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена гонка данных в `RabbitMQ` ([отчёт](https://pastila.nl/?004f7100/de1505289ab5bb355e67ebe6c7cc8707)), выполнен рефакторинг кода. [#48845](https://github.com/ClickHouse/ClickHouse/pull/48845) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлены псевдонимы `name` и `part_name` в таблицах `system.parts` и `system.part_log`. Закрывает [#48718](https://github.com/ClickHouse/ClickHouse/issues/48718). [#48850](https://github.com/ClickHouse/ClickHouse/pull/48850) ([sichenzhao](https://github.com/sichenzhao)).
* Функции &quot;arrayDifferenceSupport()&quot;, &quot;arrayCumSum()&quot; и &quot;arrayCumSumNonNegative()&quot; теперь поддерживают входные массивы целочисленных типов расширенной разрядности (U)Int128/256. [#48866](https://github.com/ClickHouse/ClickHouse/pull/48866) ([cluster](https://github.com/infdahai)).
* Многострочная история в clickhouse-client теперь больше не заполняется пробелами. Это делает вставку текста более естественной. [#48870](https://github.com/ClickHouse/ClickHouse/pull/48870) ([Joanna Hulboj](https://github.com/jh0x)).
* Реализовано небольшое улучшение для редкого случая, когда ClickHouse запускается внутри LXC и используется LXCFS. У LXCFS есть проблема: иногда при чтении файла внутри `/proc` он возвращает ошибку «Transport endpoint is not connected». Эта ошибка корректно записывалась в лог сервера ClickHouse. Дополнительно мы реализовали обход этой проблемы, повторно открывая файл. Это незначительное изменение. [#48922](https://github.com/ClickHouse/ClickHouse/pull/48922) ([Real](https://github.com/RunningXie)).
* Улучшен учет памяти для операций предварительной выборки. Настройки предварительной выборки в CI теперь случайным образом варьируются. [#48973](https://github.com/ClickHouse/ClickHouse/pull/48973) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена установка заголовков для нативных операций копирования в GCS. [#48981](https://github.com/ClickHouse/ClickHouse/pull/48981) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена поддержка указания названий настроек в командной строке с использованием дефисов вместо символов подчёркивания, например, `--max-threads` вместо `--max_threads`. Дополнительно добавлена поддержка Юникод-символов дефиса, таких как `—` вместо `--` — это полезно, когда вы взаимодействуете с командой из другой компании, и менеджер из этой команды скопировал код из Microsoft Word и вставил его. [#48985](https://github.com/ClickHouse/ClickHouse/pull/48985) ([alekseygolub](https://github.com/alekseygolub)).
* Добавлено резервное использование аутентификации по паролю, если аутентификация с использованием пользовательского SSL-сертификата завершилась неудачей. Закрывает [#48974](https://github.com/ClickHouse/ClickHouse/issues/48974). [#48989](https://github.com/ClickHouse/ClickHouse/pull/48989) ([Nikolay Degterinsky](https://github.com/evillique)).
* Улучшена встроенная панель мониторинга. Закрыт [#46671](https://github.com/ClickHouse/ClickHouse/issues/46671). [#49036](https://github.com/ClickHouse/ClickHouse/pull/49036) ([Kevin Zhang](https://github.com/Kinzeng)).
* Добавлены профильные события для сообщений журнала, чтобы можно было легко посмотреть количество лог-сообщений по уровням серьезности. [#49042](https://github.com/ClickHouse/ClickHouse/pull/49042) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* В предыдущих версиях формат `LineAsString` работал непоследовательно при включённом или отключённом параллельном разборе в случае переводов строк формата DOS или macOS Classic. Это закрывает [#49039](https://github.com/ClickHouse/ClickHouse/issues/49039). [#49052](https://github.com/ClickHouse/ClickHouse/pull/49052) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сообщение об исключении для неразобранного параметра запроса теперь также содержит имя этого параметра. Повторно реализовать [#48878](https://github.com/ClickHouse/ClickHouse/issues/48878). Закрывает [#48772](https://github.com/ClickHouse/ClickHouse/issues/48772). [#49061](https://github.com/ClickHouse/ClickHouse/pull/49061) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-8}
* Обновлены часовые пояса. Обновлены следующие часовые пояса: Africa/Cairo, Africa/Casablanca, Africa/El_Aaiun, America/Bogota, America/Cambridge_Bay, America/Ciudad_Juarez, America/Godthab, America/Inuvik, America/Iqaluit, America/Nuuk, America/Ojinaga, America/Pangnirtung, America/Rankin_Inlet, America/Resolute, America/Whitehorse, America/Yellowknife, Asia/Gaza, Asia/Hebron, Asia/Kuala_Lumpur, Asia/Singapore, Canada/Yukon, Egypt, Europe/Kirov, Europe/Volgograd, Singapore. [#48572](https://github.com/ClickHouse/ClickHouse/pull/48572) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Сокращено количество зависимостей в заголовочных файлах для ускорения сборки. [#47984](https://github.com/ClickHouse/ClickHouse/pull/47984) ([Dmitry Novik](https://github.com/novikd)).
* Рандомизировано сжатие меток и индексов в тестах. [#48286](https://github.com/ClickHouse/ClickHouse/pull/48286) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Обновлён встроенный ZSTD с версии 1.5.4 до 1.5.5. [#46797](https://github.com/ClickHouse/ClickHouse/pull/46797) ([Robert Schulze](https://github.com/rschu1ze)).
* Рандомизированы вертикальные слияния из компактных частей в широкие в тестах. [#48287](https://github.com/ClickHouse/ClickHouse/pull/48287) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлена поддержка контрольной суммы CRC32 в HDFS. Исправлены проблемы с производительностью. [#48614](https://github.com/ClickHouse/ClickHouse/pull/48614) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Удалены оставшиеся элементы поддержки GCC. [#48671](https://github.com/ClickHouse/ClickHouse/pull/48671) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлен прогон CI с включённой новой инфраструктурой анализатора. [#48719](https://github.com/ClickHouse/ClickHouse/pull/48719) ([Dmitry Novik](https://github.com/novikd)).

#### Исправление ошибки (ошибочное поведение, заметное пользователю, в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-8}

* Исправлен журнал `system.query_views_log` для материализованных представлений (MV), выполняемых в фоновых потоках [#46668](https://github.com/ClickHouse/ClickHouse/pull/46668) ([Azat Khuzhin](https://github.com/azat)).
* Устранены несколько ошибок `RENAME COLUMN` [#46946](https://github.com/ClickHouse/ClickHouse/pull/46946) ([alesapin](https://github.com/alesapin)).
* Исправлены незначительные проблемы с подсветкой в clickhouse-format [#47610](https://github.com/ClickHouse/ClickHouse/pull/47610) ([Natasha Murashkina](https://github.com/murfel)).
* Исправлена ошибка в libc++ из LLVM, приводившая к сбою при загрузке частей в S3, размер которых превышает INT&#95;MAX [#47693](https://github.com/ClickHouse/ClickHouse/pull/47693) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено переполнение в функции `sparkbar` [#48121](https://github.com/ClickHouse/ClickHouse/pull/48121) ([Vladimir C](https://github.com/vdimir)).
* Исправлено состояние гонки в S3 [#48190](https://github.com/ClickHouse/ClickHouse/pull/48190) ([Anton Popov](https://github.com/CurtizJ)).
* Отключена JIT-компиляция для агрегатных функций из‑за нестабильного поведения [#48195](https://github.com/ClickHouse/ClickHouse/pull/48195) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Незначительные исправления форматирования ALTER [#48289](https://github.com/ClickHouse/ClickHouse/pull/48289) ([Natasha Murashkina](https://github.com/murfel)).
* Исправлено потребление CPU в RabbitMQ (ухудшившееся в версии 23.2 после [#44404](https://github.com/ClickHouse/ClickHouse/issues/44404)) [#48311](https://github.com/ClickHouse/ClickHouse/pull/48311) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка, приводившая к сбою EXPLAIN PIPELINE для Merge over Distributed [#48320](https://github.com/ClickHouse/ClickHouse/pull/48320) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема сериализации LowCardinality как словаря Arrow [#48361](https://github.com/ClickHouse/ClickHouse/pull/48361) ([Kruglov Pavel](https://github.com/Avogar)).
* Сброс загрузчика сегмента файла кэша в TemporaryFileStream [#48386](https://github.com/ClickHouse/ClickHouse/pull/48386) ([Vladimir C](https://github.com/vdimir)).
* Исправлена возможная проблема, при которой команда SYSTEM SYNC REPLICA могла зависать при выполнении операций DROP/REPLACE PARTITION [#48391](https://github.com/ClickHouse/ClickHouse/pull/48391) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка запуска при загрузке распределённой таблицы, зависящей от словаря [#48419](https://github.com/ClickHouse/ClickHouse/pull/48419) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Не проверять зависимости при автоматическом переименовании системных таблиц [#48431](https://github.com/ClickHouse/ClickHouse/pull/48431) ([Raúl Marín](https://github.com/Algunenano)).
* Обновлять только затронутые строки в хранилище KeeperMap [#48435](https://github.com/ClickHouse/ClickHouse/pull/48435) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена возможная ошибка сегментации (segfault) в кэше VFS [#48469](https://github.com/ClickHouse/ClickHouse/pull/48469) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Функция `toTimeZone` выбрасывает ошибку, если не передана константная строка [#48471](https://github.com/ClickHouse/ClickHouse/pull/48471) ([Jordi Villar](https://github.com/jrdi)).
* Исправлена логическая ошибка при работе с IPv4 в Protobuf, добавлена поддержка Date32 [#48486](https://github.com/ClickHouse/ClickHouse/pull/48486) ([Kruglov Pavel](https://github.com/Avogar)).
* Флаг &quot;changed&quot; в system.settings некорректно вычислялся для параметров с несколькими значениями [#48516](https://github.com/ClickHouse/ClickHouse/pull/48516) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Исправлена работа хранилища `Memory` при включённом сжатии [#48517](https://github.com/ClickHouse/ClickHouse/pull/48517) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена некорректная работа режима bracketed-paste, из-за которой при переподключении клиента нарушался ввод пароля [#48528](https://github.com/ClickHouse/ClickHouse/pull/48528) ([Michael Kolupaev](https://github.com/al13n321)).
* Исправлена ошибка во вложенном отображении для ключей типов IP и UUID [#48556](https://github.com/ClickHouse/ClickHouse/pull/48556) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлено необработанное исключение при использовании параллельного загрузчика для хешированных словарей [#48571](https://github.com/ClickHouse/ClickHouse/pull/48571) ([Azat Khuzhin](https://github.com/azat)).
* Агрегатная функция `groupArray` корректно работает с пустым результатом для типов, допускающих значение NULL [#48593](https://github.com/ClickHouse/ClickHouse/pull/48593) ([lgbo](https://github.com/lgbo-ustc)).
* Исправлена ошибка в Keeper, из-за которой узел иногда не создавался со схемой `auth` в ACL. [#48595](https://github.com/ClickHouse/ClickHouse/pull/48595) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Разрешено использовать операторы сравнения IPv4 с UInt [#48611](https://github.com/ClickHouse/ClickHouse/pull/48611) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена возможная ошибка кэша [#48636](https://github.com/ClickHouse/ClickHouse/pull/48636) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Асинхронные вставки с пустыми данными больше не будут вызывать исключение. [#48663](https://github.com/ClickHouse/ClickHouse/pull/48663) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены зависимости таблиц при неуспешном выполнении операции RENAME TABLE [#48683](https://github.com/ClickHouse/ClickHouse/pull/48683) ([Azat Khuzhin](https://github.com/azat)).
* Если первичный ключ содержит дублирующиеся столбцы (что возможно только для проекций), в предыдущих версиях это могло приводить к ошибке [#48838](https://github.com/ClickHouse/ClickHouse/pull/48838) ([Amos Bird](https://github.com/amosbird)).
* Исправление условия гонки в ZooKeeper при выполнении join потоков send&#95;thread/receive&#95;thread [#48849](https://github.com/ClickHouse/ClickHouse/pull/48849) ([Alexander Gololobov](https://github.com/davenger)).
* Исправлена ошибка `unexpected part name` при попытке удалить игнорируемую отсоединённую часть при репликации без копирования данных (zero-copy replication) [#48862](https://github.com/ClickHouse/ClickHouse/pull/48862) ([Michael Lex](https://github.com/mlex)).
* Исправлена ошибка чтения столбца `Date32` Parquet/Arrow в столбец другого типа, отличного от `Date32` [#48864](https://github.com/ClickHouse/ClickHouse/pull/48864) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка `UNKNOWN_IDENTIFIER` при выполнении запроса `SELECT` из таблицы с политикой строк и столбцом, в имени которого есть точки [#48976](https://github.com/ClickHouse/ClickHouse/pull/48976) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена агрегация по пустым строкам типа Nullable [#48999](https://github.com/ClickHouse/ClickHouse/pull/48999) ([LiuNeng](https://github.com/liuneng1994)).

### <a id="233"></a> Релиз ClickHouse 23.3 LTS, 2023-03-30 {#233}

#### Заметки по обновлению {#upgrade-notes-1}
* Легковесные операции DELETE готовы к использованию в продакшене и включены по умолчанию. Запрос `DELETE` для таблиц MergeTree теперь доступен по умолчанию.
* Поведение функций `*domain*RFC` и `netloc` немного изменено: расширен набор символов, разрешённых в authority-части URL, для лучшего соответствия спецификациям. [#46841](https://github.com/ClickHouse/ClickHouse/pull/46841) ([Azat Khuzhin](https://github.com/azat)).
* Запрещено создавать таблицы на базе KafkaEngine с выражениями DEFAULT/EPHEMERAL/ALIAS/MATERIALIZED для столбцов. [#47138](https://github.com/ClickHouse/ClickHouse/pull/47138) ([Aleksandr Musorin](https://github.com/AVMusorin)).
* Удалена функциональность «asynchronous connection drain». Соответствующие настройки и метрики также удалены. Это была внутренняя функциональность, поэтому её удаление не должно затронуть пользователей, которые ранее о ней не знали. [#47486](https://github.com/ClickHouse/ClickHouse/pull/47486) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Добавлена поддержка 256-битного типа данных Decimal (более 38 цифр) в функциях `arraySum`/`Min`/`Max`/`Avg`/`Product`, `arrayCumSum`/`CumSumNonNegative`, `arrayDifference`, при конструировании массивов, операторе IN, параметрах запросов, `groupArrayMovingSum`, статистических функциях, `min`/`max`/`any`/`argMin`/`argMax`, в сетевом протоколе PostgreSQL, движке таблиц и функции MySQL, `sumMap`, `mapAdd`, `mapSubtract`, `arrayIntersect`. Добавлена поддержка больших целых чисел в `arrayIntersect`. Статистические агрегатные функции, использующие моменты (такие как `corr` или различные `TTest`), будут использовать `Float64` как внутреннее представление (ранее использовался `Decimal128`, но это не имело смысла), и эти функции могут возвращать `nan` вместо `inf` в случае бесконечной дисперсии. Некоторые функции были разрешены для типов данных `Decimal256`, но в предыдущих версиях возвращали `Decimal128` — теперь это исправлено. Это закрывает [#47569](https://github.com/ClickHouse/ClickHouse/issues/47569). Это закрывает [#44864](https://github.com/ClickHouse/ClickHouse/issues/44864). Это закрывает [#28335](https://github.com/ClickHouse/ClickHouse/issues/28335). [#47594](https://github.com/ClickHouse/ClickHouse/pull/47594) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Параметры backup_threads/restore_threads сделаны серверными настройками (вместо пользовательских). [#47881](https://github.com/ClickHouse/ClickHouse/pull/47881) ([Azat Khuzhin](https://github.com/azat)).
* Запрещены константные и недетерминированные вторичные индексы. [#46839](https://github.com/ClickHouse/ClickHouse/pull/46839) ([Anton Popov](https://github.com/CurtizJ)).

#### Новая возможность {#new-feature-9}

* Добавлен новый режим распределения нагрузки по репликам с помощью настроек `parallel_replicas_custom_key` и `parallel_replicas_custom_key_filter_type`. Если кластер состоит из одного шарда с несколькими репликами, до `max_parallel_replicas` реплик будут случайным образом выбраны и использованы как шарды. Для каждого такого шарда соответствующий фильтр добавляется к запросу на стороне инициатора перед отправкой на шард. Если кластер состоит из нескольких шардов, поведение будет таким же, как у `sample_key`, но с возможностью задать произвольный ключ. [#45108](https://github.com/ClickHouse/ClickHouse/pull/45108) ([Antonio Andelic](https://github.com/antonio2368)).
* Опция отображения частичного результата при отмене: добавлена настройка запроса `partial_result_on_first_cancel`, позволяющая отменённому запросу (например, из‑за Ctrl-C) возвращать частичный результат. [#45689](https://github.com/ClickHouse/ClickHouse/pull/45689) ([Alexey Perevyshin](https://github.com/alexX512)).
* Добавлена поддержка любых движков таблиц для временных таблиц (за исключением движков Replicated и KeeperMap). Закрывает [#31497](https://github.com/ClickHouse/ClickHouse/issues/31497). [#46071](https://github.com/ClickHouse/ClickHouse/pull/46071) ([Roman Vasin](https://github.com/rvasin)).
* Добавлена поддержка репликации определяемых пользователем SQL-функций с использованием централизованного хранилища в Keeper. [#46085](https://github.com/ClickHouse/ClickHouse/pull/46085) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Реализована таблица `system.server_settings` (аналог `system.settings`), содержащая настройки сервера. [#46550](https://github.com/ClickHouse/ClickHouse/pull/46550) ([pufit](https://github.com/pufit)).
* Добавлена поддержка запроса `UNDROP TABLE`. Закрывает [#46811](https://github.com/ClickHouse/ClickHouse/issues/46811). [#47241](https://github.com/ClickHouse/ClickHouse/pull/47241) ([chen](https://github.com/xiedeyantu)).
* Разрешить раздельную выдачу прав для именованных коллекций (например, чтобы можно было предоставить доступ `SHOW/CREATE/ALTER/DROP named collection` только к определённым коллекциям, а не ко всем сразу). Закрывает [#40894](https://github.com/ClickHouse/ClickHouse/issues/40894). Добавлен новый тип доступа `NAMED_COLLECTION_CONTROL`, который по умолчанию не выдаётся пользователю, если он явно не добавлен в конфигурацию пользователя (требуется для выполнения `GRANT ALL`); кроме того, `show_named_collections` больше не нужно вручную указывать для пользователя по умолчанию, чтобы он мог иметь полный набор прав доступа, как это было в 23.2. [#46241](https://github.com/ClickHouse/ClickHouse/pull/46241) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Теперь поддерживаются вложенные пользовательские диски. Ранее пользовательские диски поддерживали только плоскую структуру. [#47106](https://github.com/ClickHouse/ClickHouse/pull/47106) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена функция `widthBucket` (с псевдонимом `WIDTH_BUCKET` для совместимости). [#42974](https://github.com/ClickHouse/ClickHouse/issues/42974). [#46790](https://github.com/ClickHouse/ClickHouse/pull/46790) ([avoiderboi](https://github.com/avoiderboi)).
* Добавлены новые функции `parseDateTime`/`parseDateTimeInJodaSyntax` в соответствии с указанной строкой формата. `parseDateTime` преобразует значение типа `String` в `DateTime`, используя синтаксис MySQL, а `parseDateTimeInJodaSyntax` — используя синтаксис Joda. [#46815](https://github.com/ClickHouse/ClickHouse/pull/46815) ([李扬](https://github.com/taiyang-li)).
* Используйте `dummy UInt8` в качестве структуры по умолчанию табличной функции `null`. Закрывает [#46930](https://github.com/ClickHouse/ClickHouse/issues/46930). [#47006](https://github.com/ClickHouse/ClickHouse/pull/47006) ([flynn](https://github.com/ucasfl)).
* Добавлена поддержка формата даты с запятой, например `Dec 15, 2021`, в функции `parseDateTimeBestEffort`. Закрывает [#46816](https://github.com/ClickHouse/ClickHouse/issues/46816). [#47071](https://github.com/ClickHouse/ClickHouse/pull/47071) ([chen](https://github.com/xiedeyantu)).
* Добавлены настройки `http_wait_end_of_query` и `http_response_buffer_size`, которые соответствуют URL-параметрам `wait_end_of_query` и `buffer_size` для HTTP-интерфейса. Это позволяет изменять эти настройки в профилях. [#47108](https://github.com/ClickHouse/ClickHouse/pull/47108) ([Vladimir C](https://github.com/vdimir)).
* Добавлена таблица `system.dropped_tables`, которая показывает таблицы, удалённые из баз данных типа `Atomic`, но ещё не полностью удалённые. [#47364](https://github.com/ClickHouse/ClickHouse/pull/47364) ([chen](https://github.com/xiedeyantu)).
* Добавлен `INSTR` как псевдоним функции `positionCaseInsensitive` для совместимости с MySQL. Закрывает [#47529](https://github.com/ClickHouse/ClickHouse/issues/47529). [#47535](https://github.com/ClickHouse/ClickHouse/pull/47535) ([flynn](https://github.com/ucasfl)).
* Добавлена функция `toDecimalString`, позволяющая преобразовывать числа в строку с фиксированной точностью. [#47838](https://github.com/ClickHouse/ClickHouse/pull/47838) ([Andrey Zvonov](https://github.com/zvonand)).
* Добавлена настройка MergeTree `max_number_of_mutations_for_replica`. Она ограничивает число мутаций частей на реплику до указанного значения. Ноль означает отсутствие ограничения на количество мутаций на реплику (выполнение всё равно может быть ограничено другими настройками). [#48047](https://github.com/ClickHouse/ClickHouse/pull/48047) ([Vladimir C](https://github.com/vdimir)).
* Добавлена функция для работы с типом Map — `mapFromArrays`, которая позволяет создавать значение типа Map из пары массивов. [#31125](https://github.com/ClickHouse/ClickHouse/pull/31125) ([李扬](https://github.com/taiyang-li)).
* Добавлена возможность управлять сжатием в выходных форматах Parquet/ORC/Arrow, добавлена поддержка большего числа форматов сжатия на входе. Это закрывает [#13541](https://github.com/ClickHouse/ClickHouse/issues/13541). [#47114](https://github.com/ClickHouse/ClickHouse/pull/47114) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка аутентификации по пользовательскому SSL-сертификату в нативном протоколе. Закрывает [#47077](https://github.com/ClickHouse/ClickHouse/issues/47077). [#47596](https://github.com/ClickHouse/ClickHouse/pull/47596) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлены варианты функций *OrNull() и *OrZero() для `parseDateTime`, добавлен псевдоним `str_to_date` для соответствия MySQL. [#48000](https://github.com/ClickHouse/ClickHouse/pull/48000) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлен оператор `REGEXP` (аналог операторов &quot;LIKE&quot;, &quot;IN&quot;, &quot;MOD&quot; и т. д.) для улучшения совместимости с MySQL [#47869](https://github.com/ClickHouse/ClickHouse/pull/47869) ([Robert Schulze](https://github.com/rschu1ze)).



#### Повышение производительности {#performance-improvement-9}

* Метки в памяти теперь хранятся в сжатом виде и занимают в 3–6 раз меньше памяти. [#47290](https://github.com/ClickHouse/ClickHouse/pull/47290) ([Michael Kolupaev](https://github.com/al13n321)).
* Резервное копирование для очень большого числа файлов в предыдущих версиях было невероятно медленным. Теперь это не так. Сейчас оно невероятно быстрое. [#47251](https://github.com/ClickHouse/ClickHouse/pull/47251) ([Alexey Milovidov](https://github.com/alexey-milovidov)). Введён отдельный пул потоков для операций ввода-вывода резервного копирования. Это позволит масштабировать его независимо от других пулов и повысить производительность. [#47174](https://github.com/ClickHouse/ClickHouse/pull/47174) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)). Теперь используется запрос MultiRead и повторные попытки для сбора метаданных на финальном этапе обработки резервного копирования. [#47243](https://github.com/ClickHouse/ClickHouse/pull/47243) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)). Если и резервная копия, и восстанавливаемые данные находятся в S3, то теперь используется серверное копирование. [#47546](https://github.com/ClickHouse/ClickHouse/pull/47546) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено избыточное чтение в запросах с `FINAL`. [#47801](https://github.com/ClickHouse/ClickHouse/pull/47801) ([Nikita Taranov](https://github.com/nickitat)).
* Параметр `max_final_threads` при запуске сервера будет автоматически установлен равным количеству ядер (по тому же алгоритму, который используется для `max_threads`). Это улучшает параллелизм выполнения `final` на серверах с большим количеством процессоров. [#47915](https://github.com/ClickHouse/ClickHouse/pull/47915) ([Nikita Taranov](https://github.com/nickitat)).
* Добавлена возможность выполнять конвейер чтения для словаря DIRECT с источником CLICKHOUSE в нескольких потоках. Чтобы включить её, установите `dictionary_use_async_executor=1` в секции `SETTINGS` для источника в выражении `CREATE DICTIONARY`. [#47986](https://github.com/ClickHouse/ClickHouse/pull/47986) ([Vladimir C](https://github.com/vdimir)).
* Оптимизирована производительность агрегации с одним nullable-ключом. [#45772](https://github.com/ClickHouse/ClickHouse/pull/45772) ([LiuNeng](https://github.com/liuneng1994)).
* Реализовано использование индекса `tokenbf_v1` в нижнем регистре для функций `hasTokenOrNull`, `hasTokenCaseInsensitive` и `hasTokenCaseInsensitiveOrNull`. [#46252](https://github.com/ClickHouse/ClickHouse/pull/46252) ([ltrk2](https://github.com/ltrk2)).
* Оптимизированы функции `position` и `LIKE` путём поиска первых двух символов с использованием SIMD. [#46289](https://github.com/ClickHouse/ClickHouse/pull/46289) ([Jiebin Sun](https://github.com/jiebinn)).
* Оптимизированы запросы к `system.detached_parts`, результаты которых могут быть очень большими. Добавлено несколько источников чтения с учётом ограничения размера блока; для каждого блока используется пул потоков ввода-вывода для вычисления размера части, то есть для параллельного выполнения системных вызовов. [#46624](https://github.com/ClickHouse/ClickHouse/pull/46624) ([Sema Checherinda](https://github.com/CheSema)).
* Увеличено значение по умолчанию параметра `max_replicated_merges_in_queue` для таблиц ReplicatedMergeTree с 16 до 1000. Это позволяет ускорить фоновые операции слияния на кластерах с очень большим количеством реплик, например на кластерах с общим хранилищем в ClickHouse Cloud. [#47050](https://github.com/ClickHouse/ClickHouse/pull/47050) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Обновлён `clickhouse-copier`, чтобы использовать `GROUP BY` вместо `DISTINCT` для получения списка партиций. Для больших таблиц это сократило время выполнения запроса с более чем 500 до менее чем 1 секунды. [#47386](https://github.com/ClickHouse/ClickHouse/pull/47386) ([Clayton McClure](https://github.com/cmcclure-twilio)).
* Исправлена деградация производительности в `ASOF JOIN`. [#47544](https://github.com/ClickHouse/ClickHouse/pull/47544) ([Ongkong](https://github.com/ongkong)).
* Ещё больше батчирования в Keeper. Производительность улучшена за счёт того, что батчи не разбиваются при запросах на чтение. [#47978](https://github.com/ClickHouse/ClickHouse/pull/47978) ([Antonio Andelic](https://github.com/antonio2368)).
* Разрешено использовать PREWHERE для таблиц Merge с различными выражениями DEFAULT для столбцов. [#46831](https://github.com/ClickHouse/ClickHouse/pull/46831) ([Azat Khuzhin](https://github.com/azat)).

#### Экспериментальная возможность {#experimental-feature-6}
* Параллельные реплики: улучшена общая производительность за счет более эффективного использования локальной реплики и по умолчанию запрещено чтение с использованием параллельных реплик из нереплицируемых таблиц MergeTree. [#47858](https://github.com/ClickHouse/ClickHouse/pull/47858) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлена поддержка проталкивания фильтра в левую таблицу для JOIN с таблицами `Join`, `Dictionary` и `EmbeddedRocksDB`, если включен экспериментальный Analyzer. [#47280](https://github.com/ClickHouse/ClickHouse/pull/47280) ([Maksim Kita](https://github.com/kitaisreal)).
* Теперь ReplicatedMergeTree с репликацией без копирования (zero-copy replication) меньше нагружает Keeper. [#47676](https://github.com/ClickHouse/ClickHouse/pull/47676) ([alesapin](https://github.com/alesapin)).
* Исправлено создание материализованного представления с MaterializedPostgreSQL. [#40807](https://github.com/ClickHouse/ClickHouse/pull/40807) ([Maksim Buren](https://github.com/maks-buren630501)).

#### Улучшение {#improvement-9}

* Настройка `input_format_json_ignore_unknown_keys_in_named_tuple` включена по умолчанию. [#46742](https://github.com/ClickHouse/ClickHouse/pull/46742) ([Kruglov Pavel](https://github.com/Avogar)).
* Разрешить игнорирование ошибок при вставке в MATERIALIZED VIEW (добавлена новая настройка `materialized_views_ignore_errors`, по умолчанию имеет значение `false`, но для сброса логов в таблицы `system.*_log` всегда устанавливается в `true`). [#46658](https://github.com/ClickHouse/ClickHouse/pull/46658) ([Azat Khuzhin](https://github.com/azat)).
* Отслеживать в памяти файловую очередь распределённых отправок. [#45491](https://github.com/ClickHouse/ClickHouse/pull/45491) ([Azat Khuzhin](https://github.com/azat)).
* Теперь заголовки `X-ClickHouse-Query-Id` и `X-ClickHouse-Timezone` добавляются в ответы на все запросы по протоколу HTTP. Ранее это делалось только для запросов `SELECT`. [#46364](https://github.com/ClickHouse/ClickHouse/pull/46364) ([Anton Popov](https://github.com/CurtizJ)).
* Внешние таблицы из `MongoDB`: поддержка подключения к реплика-сету через URI со списком пар host:port и поддержка параметра readPreference в словарях MongoDB. Пример URI: mongodb://db0.example.com:27017,db1.example.com:27017,db2.example.com:27017/?replicaSet=myRepl&amp;readPreference=primary. [#46524](https://github.com/ClickHouse/ClickHouse/pull/46524) ([artem-yadr](https://github.com/artem-yadr)).
* Это улучшение должно быть незаметным для пользователей. Анализ проекций переосуществлён на основе плана запроса. Добавлена настройка `query_plan_optimize_projection=1` для переключения между старой и новой версиями. Исправляет [#44963](https://github.com/ClickHouse/ClickHouse/issues/44963). [#46537](https://github.com/ClickHouse/ClickHouse/pull/46537) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* По умолчанию для выходного формата использовать Parquet v2 вместо v1. Добавлена настройка `output_format_parquet_version` для управления версией Parquet, возможные значения: `1.0`, `2.4`, `2.6`, `2.latest` (по умолчанию). [#46617](https://github.com/ClickHouse/ClickHouse/pull/46617) ([Kruglov Pavel](https://github.com/Avogar)).
* Теперь можно использовать новый синтаксис конфигурации для настройки топиков Kafka с точками (`.`) в их именах. [#46752](https://github.com/ClickHouse/ClickHouse/pull/46752) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлены эвристики, которые проверяют шаблоны Hyperscan на проблемные повторы. [#46819](https://github.com/ClickHouse/ClickHouse/pull/46819) ([Robert Schulze](https://github.com/rschu1ze)).
* Не сообщать в system.errors о существовании узла ZK, если блок был конкурентно создан другой репликой. [#46820](https://github.com/ClickHouse/ClickHouse/pull/46820) ([Raúl Marín](https://github.com/Algunenano)).
* Увеличен лимит на количество открытых файлов в `clickhouse-local`. Это позволит читать данные из таблиц `web` на серверах с очень большим количеством ядер CPU. Теперь чтение из движка таблиц URL не прекращается при слишком большом числе открытых файлов. Исправляет [#46852](https://github.com/ClickHouse/ClickHouse/issues/46852). [#46853](https://github.com/ClickHouse/ClickHouse/pull/46853) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Теперь сообщения об исключениях, возникающих при невозможности разобрать числа, стали более понятными. [#46917](https://github.com/ClickHouse/ClickHouse/pull/46917) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлено обновление таблицы `system.backups` после каждой обработанной задачи для отслеживания хода создания резервных копий. [#46989](https://github.com/ClickHouse/ClickHouse/pull/46989) ([Aleksandr Musorin](https://github.com/AVMusorin)).
* Разрешено преобразование типов во входном формате Native. Добавлена настройка `input_format_native_allow_types_conversion`, управляющая этим поведением (по умолчанию включена). [#46990](https://github.com/ClickHouse/ClickHouse/pull/46990) ([Kruglov Pavel](https://github.com/Avogar)).
* Разрешена поддержка IPv4 в функции `range` для генерации IP-диапазонов. [#46995](https://github.com/ClickHouse/ClickHouse/pull/46995) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Улучшено сообщение об исключении, если невозможно переместить часть с одного тома/диска на другой. [#47032](https://github.com/ClickHouse/ClickHouse/pull/47032) ([alesapin](https://github.com/alesapin)).
* Добавлена поддержка типа `Bool` в функции `JSONType`. Ранее для булевых значений по ошибке возвращался тип `Null`. [#47046](https://github.com/ClickHouse/ClickHouse/pull/47046) ([Anton Popov](https://github.com/CurtizJ)).
* Используйте параметр `_request_body` для настройки предопределённых HTTP‑запросов. [#47086](https://github.com/ClickHouse/ClickHouse/pull/47086) ([Constantine Peresypkin](https://github.com/pkit)).
* Автоматическое добавление отступов во встроенном SQL-редакторе UI при нажатии Enter. [#47113](https://github.com/ClickHouse/ClickHouse/pull/47113) ([Alexey Korepanov](https://github.com/alexkorep)).
* Самоизвлечение с помощью &#39;sudo&#39; попытается установить uid и gid извлечённых файлов равными идентификаторам текущего пользователя. [#47116](https://github.com/ClickHouse/ClickHouse/pull/47116) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Ранее второй аргумент функции `repeat` принимал только тип беззнакового целого числа, поэтому нельзя было передавать значения вроде -1. Такое поведение отличалось от поведения одноимённой функции в Spark. В этом обновлении функция `repeat` была изменена, чтобы соответствовать поведению функции Spark. Теперь она принимает те же типы входных данных, включая отрицательные целые числа. Для проверки корректности обновлённой реализации были проведены обширные тесты. [#47134](https://github.com/ClickHouse/ClickHouse/pull/47134) ([KevinyhZou](https://github.com/KevinyhZou)). Примечание: запись в журнале изменений была переписана с помощью ChatGPT.
* Удалена часть `::__1` из стек-трейсов. В стек-трейсах отображать `std::basic_string&lt;char, ...` как `String`. [#47171](https://github.com/ClickHouse/ClickHouse/pull/47171) ([Mike Kot](https://github.com/myrrc)).
* Межсерверный режим реализован заново, чтобы предотвратить атаки воспроизведения (обратите внимание, что это изменение обратно совместимо со старыми серверами). [#47213](https://github.com/ClickHouse/ClickHouse/pull/47213) ([Azat Khuzhin](https://github.com/azat)).
* Улучшено распознавание групп в регулярных выражениях и уточнён словарь regexp&#95;tree. [#47218](https://github.com/ClickHouse/ClickHouse/pull/47218) ([Han Fei](https://github.com/hanfei1991)).
* Улучшение в Keeper: добавлена новая команда 4LW `clrs` для очистки ресурсов, используемых Keeper (например, для освобождения неиспользуемой памяти). [#47256](https://github.com/ClickHouse/ClickHouse/pull/47256) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлены необязательные аргументы кодеков `DoubleDelta(bytes_size)`, `Gorilla(bytes_size)`, `FPC(level, float_size)`, что позволяет использовать эти кодеки без указания типа столбца в `clickhouse-compressor`. Исправлены потенциальные аварийные завершения и арифметические ошибки в `clickhouse-compressor` при использовании этих кодеков. Исправления: [https://github.com/ClickHouse/ClickHouse/discussions/47262](https://github.com/ClickHouse/ClickHouse/discussions/47262). [#47271](https://github.com/ClickHouse/ClickHouse/pull/47271) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка типов big int в функции `runningDifference`. Закрывает [#47194](https://github.com/ClickHouse/ClickHouse/issues/47194). [#47322](https://github.com/ClickHouse/ClickHouse/pull/47322) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлено окно досрочного истечения срока действия для учетных данных S3 с ограниченным сроком действия, чтобы избежать ошибок `ExpiredToken` в некоторых пограничных случаях. Его можно настроить параметром `expiration_window_seconds`, значение по умолчанию — 120 секунд. [#47423](https://github.com/ClickHouse/ClickHouse/pull/47423) ([Antonio Andelic](https://github.com/antonio2368)).
* Реализована поддержка типов `Decimal` и `Date32` в формате `Avro`. [#47434](https://github.com/ClickHouse/ClickHouse/pull/47434) ([Kruglov Pavel](https://github.com/Avogar)).
* Если обнаружено прерванное преобразование из `Ordinary` в `Atomic`, не запускать сервер и выводить более информативное сообщение об ошибке с инструкциями по устранению неполадок. [#47487](https://github.com/ClickHouse/ClickHouse/pull/47487) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Добавлен новый столбец `kind` в таблицу `system.opentelemetry_span_log`. Этот столбец хранит значение [SpanKind](https://opentelemetry.io/docs/reference/specification/trace/api/#spankind), определённое в OpenTelemetry. [#47499](https://github.com/ClickHouse/ClickHouse/pull/47499) ([Frank Chen](https://github.com/FrankChen021)).
* Теперь разрешено чтение и запись вложенных массивов в формате `Protobuf`, используя в качестве имени столбца только имя корневого поля. Ранее имя столбца должно было содержать все вложенные имена полей (например, `a.b.c Array(Array(Array(UInt32)))`), теперь можно использовать только `a Array(Array(Array(UInt32)))`. [#47650](https://github.com/ClickHouse/ClickHouse/pull/47650) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен необязательный модификатор `STRICT` для `SYSTEM SYNC REPLICA`, при котором запрос ожидает, пока очередь репликации не опустеет (как и работало до [https://github.com/ClickHouse/ClickHouse/pull/45648](https://github.com/ClickHouse/ClickHouse/pull/45648)). [#47659](https://github.com/ClickHouse/ClickHouse/pull/47659) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Улучшены названия некоторых логов спанов OpenTelemetry. [#47667](https://github.com/ClickHouse/ClickHouse/pull/47667) ([Frank Chen](https://github.com/FrankChen021)).
* Предотвращено использование слишком длинных цепочек комбинаторов агрегатных функций (они могут приводить к медленной обработке запросов на стадии анализа). Исправляет [#47715](https://github.com/ClickHouse/ClickHouse/issues/47715). [#47716](https://github.com/ClickHouse/ClickHouse/pull/47716) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Поддержка подзапросов в параметризованных представлениях; решает [#46741](https://github.com/ClickHouse/ClickHouse/issues/46741) [#47725](https://github.com/ClickHouse/ClickHouse/pull/47725) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлена утечка памяти в интеграции с MySQL (воспроизводится при `connection_auto_close=1`). [#47732](https://github.com/ClickHouse/ClickHouse/pull/47732) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Улучшена обработка ошибок в коде, связанном с параметрами `Decimal`, благодаря чему сообщения об ошибках стали более информативными. Ранее при передаче некорректных параметров `Decimal` выводимое сообщение об ошибке было неясным или малополезным. В этом обновлении сообщение об ошибке исправлено и теперь содержит более подробную и полезную информацию, что упрощает выявление и устранение проблем, связанных с параметрами `Decimal`. [#47812](https://github.com/ClickHouse/ClickHouse/pull/47812) ([Yu Feng](https://github.com/Vigor-jpg)). Примечание: эта запись в журнале изменений переписана с помощью ChatGPT.
* Параметр `exact_rows_before_limit` используется для того, чтобы `rows_before_limit_at_least` точно отражал количество строк, возвращённых до достижения лимита. Этот pull request исправляет проблемы, возникавшие при выполнении запросов с распределённой обработкой по нескольким шардам или с операциями сортировки. До этого обновления такие сценарии работали не так, как предполагалось. [#47874](https://github.com/ClickHouse/ClickHouse/pull/47874) ([Amos Bird](https://github.com/amosbird)).
* Интроспекция метрик пулов потоков. [#47880](https://github.com/ClickHouse/ClickHouse/pull/47880) ([Azat Khuzhin](https://github.com/azat)).
* Добавлены события профиля `WriteBufferFromS3Microseconds` и `WriteBufferFromS3RequestsErrors`. [#47885](https://github.com/ClickHouse/ClickHouse/pull/47885) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлены опции `--link` и `--noninteractive` (`-y`) в установщик ClickHouse. Закрывает [#47750](https://github.com/ClickHouse/ClickHouse/issues/47750). [#47887](https://github.com/ClickHouse/ClickHouse/pull/47887) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлено исключение `UNKNOWN_TABLE` при выполнении ATTACH к материализованному представлению, у которого есть зависимые таблицы, недоступные в данный момент. Это может быть полезно при попытке восстановить состояние из резервной копии. [#47975](https://github.com/ClickHouse/ClickHouse/pull/47975) ([MikhailBurdukov](https://github.com/MikhailBurdukov)).
* Исправлен случай, когда (необязательный) путь не добавлялся в конфигурацию зашифрованного диска. [#47981](https://github.com/ClickHouse/ClickHouse/pull/47981) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Поддержка CTE (общих табличных выражений) в параметризованных представлениях. Реализация: обновлена, чтобы разрешить параметры запроса при вычислении скалярных подзапросов. [#48065](https://github.com/ClickHouse/ClickHouse/pull/48065) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Добавлена поддержка больших целых чисел `(U)Int128/(U)Int256`, `Map` с любым типом ключа и `DateTime64` с любой точностью (не только 3 и 6). [#48119](https://github.com/ClickHouse/ClickHouse/pull/48119) ([Kruglov Pavel](https://github.com/Avogar)).
* Разрешить пропуск ошибок, связанных с неизвестными значениями enum, в построчных форматах ввода. [#48133](https://github.com/ClickHouse/ClickHouse/pull/48133) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-9}
* ClickHouse теперь собирается с `C++23`. [#47424](https://github.com/ClickHouse/ClickHouse/pull/47424) ([Robert Schulze](https://github.com/rschu1ze)).
* Фаззинг запросов `EXPLAIN` в AST Fuzzer. [#47803](https://github.com/ClickHouse/ClickHouse/pull/47803) [#47852](https://github.com/ClickHouse/ClickHouse/pull/47852) ([flynn](https://github.com/ucasfl)).
* Разделены стресс‑тест и автоматическая проверка обратной совместимости (теперь Upgrade check). [#44879](https://github.com/ClickHouse/ClickHouse/pull/44879) ([Kruglov Pavel](https://github.com/Avogar)).
* Обновлён образ Ubuntu для Docker, чтобы подавить некоторые ложные отчёты систем безопасности. [#46784](https://github.com/ClickHouse/ClickHouse/pull/46784) ([Julio Jimenez](https://github.com/juliojimenez)). Обратите внимание, что ClickHouse не имеет зависимостей и не требует Docker.
* Добавлен запрос подтверждения для удаления существующего скачанного бинарника `clickhouse` при использовании установки ClickHouse через "curl | sh". Сообщение: "ClickHouse binary clickhouse already exists. Overwrite? \[y/N\]". [#46859](https://github.com/ClickHouse/ClickHouse/pull/46859) ([Dan Roscigno](https://github.com/DanRoscigno)).
* Исправлена ошибка при запуске сервера на старых дистрибутивах (например, Amazon Linux 2) и на ARM, когда символы glibc 2.28 не обнаруживаются. [#47008](https://github.com/ClickHouse/ClickHouse/pull/47008) ([Robert Schulze](https://github.com/rschu1ze)).
* Подготовка к поддержке clang 16. [#47027](https://github.com/ClickHouse/ClickHouse/pull/47027) ([Amos Bird](https://github.com/amosbird)).
* Добавлена проверка в CI, гарантирующая, что ClickHouse может работать со старой glibc на ARM. [#47063](https://github.com/ClickHouse/ClickHouse/pull/47063) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена проверка стиля, предотвращающая некорректное использование макроса `NDEBUG`. [#47699](https://github.com/ClickHouse/ClickHouse/pull/47699) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Небольшое ускорение сборки. [#47714](https://github.com/ClickHouse/ClickHouse/pull/47714) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Обновлён `vectorscan` до версии 5.4.9. [#47955](https://github.com/ClickHouse/ClickHouse/pull/47955) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлен модульный тест, проверяющий, что фатальные сообщения логирования Apache Arrow не приводят к аварийному завершению процесса. Он покрывает изменения в [ClickHouse/arrow#16](https://github.com/ClickHouse/arrow/pull/16). [#47958](https://github.com/ClickHouse/ClickHouse/pull/47958) ([Arthur Passos](https://github.com/arthurpassos)).
* Восстановлена возможность запуска нативной отладочной сборки сервера для macOS. [#48050](https://github.com/ClickHouse/ClickHouse/pull/48050) ([Robert Schulze](https://github.com/rschu1ze)). Примечание: это изменение актуально только для разработки, так как официальные сборки ClickHouse выполняются с использованием кросс‑компиляции.

#### Исправление ошибки (видимая пользователю неисправность в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-an-official-stable-release-9}

* Исправлен сброс парсера форматов, протестирована обработка некорректных сообщений в `Kafka` [#45693](https://github.com/ClickHouse/ClickHouse/pull/45693) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен подсчёт размера данных в Keeper [#46086](https://github.com/ClickHouse/ClickHouse/pull/46086) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка в автоматических повторных попытках выполнения запроса `DROP TABLE` для таблиц `ReplicatedMergeTree` и баз данных `Atomic`. В редких случаях это могло приводить к ошибкам `Can't get data for node /zk_path/log_pointer` и `The specified key does not exist`, если сессия ZooKeeper истекала во время выполнения DROP, а новая реплицированная таблица с тем же путем в ZooKeeper создавалась параллельно. [#46384](https://github.com/ClickHouse/ClickHouse/pull/46384) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена некорректная рекурсия псевдонимов при нормализации запросов, которая мешала выполнению некоторых запросов. [#46609](https://github.com/ClickHouse/ClickHouse/pull/46609) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена сериализация и десериализация IPv4/IPv6 в бинарных форматах [#46616](https://github.com/ClickHouse/ClickHouse/pull/46616) ([Kruglov Pavel](https://github.com/Avogar)).
* ActionsDAG: не изменять результат `and` при оптимизации [#46653](https://github.com/ClickHouse/ClickHouse/pull/46653) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Улучшена отмена запросов при аварийном завершении работы клиента [#46681](https://github.com/ClickHouse/ClickHouse/pull/46681) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлены арифметические операции при оптимизации агрегатных функций [#46705](https://github.com/ClickHouse/ClickHouse/pull/46705) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлено возможное аварийное завершение `clickhouse-local` при выводе схемы JSONEachRow [#46731](https://github.com/ClickHouse/ClickHouse/pull/46731) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено изменение просроченной роли [#46772](https://github.com/ClickHouse/ClickHouse/pull/46772) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена проблема с накоплением объединённых столбцов PREWHERE на нескольких шагах [#46785](https://github.com/ClickHouse/ClickHouse/pull/46785) ([Alexander Gololobov](https://github.com/davenger)).
* Использовать начальный диапазон для определения размера файла в HTTP-буфере чтения. Без этого изменения некоторые удалённые файлы не могли быть обработаны. [#46824](https://github.com/ClickHouse/ClickHouse/pull/46824) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлен некорректный индикатор прогресса при использовании URL-таблиц [#46830](https://github.com/ClickHouse/ClickHouse/pull/46830) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено предупреждение MSan в функции `maxIntersections` [#46847](https://github.com/ClickHouse/ClickHouse/pull/46847) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка в типе данных `Map` [#46856](https://github.com/ClickHouse/ClickHouse/pull/46856) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлены некорректные результаты некоторых запросов с оператором LIKE, когда шаблон LIKE содержит заключённые в кавычки неэкранируемые символы [#46875](https://github.com/ClickHouse/ClickHouse/pull/46875) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправление: `WITH FILL` мог приводить к аварийному завершению при обработке пустого блока в `FillingTransform` [#46897](https://github.com/ClickHouse/ClickHouse/pull/46897) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлено определение типов date и int из строк в JSON [#46972](https://github.com/ClickHouse/ClickHouse/pull/46972) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка при выборе диска для zero-copy репликации во время операции fetch [#47010](https://github.com/ClickHouse/ClickHouse/pull/47010) ([alesapin](https://github.com/alesapin)).
* Исправлена опечатка в определении службы systemd [#47051](https://github.com/ClickHouse/ClickHouse/pull/47051) ([Palash Goel](https://github.com/palash-goel)).
* Исправлена ошибка NOT&#95;IMPLEMENTED при использовании CROSS JOIN с algorithm = auto [#47068](https://github.com/ClickHouse/ClickHouse/pull/47068) ([Vladimir C](https://github.com/vdimir)).
* Исправлена проблема, из-за которой таблице &#39;ReplicatedMergeTree&#39; не удавалось вставить две похожие записи при настроенном режиме &#39;InMemory&#39; для параметра &#39;part&#95;type&#39; (экспериментальная возможность). [#47121](https://github.com/ClickHouse/ClickHouse/pull/47121) ([liding1992](https://github.com/liding1992)).
* Внешние словари / library-bridge: исправлена ошибка «unknown library method &#39;extDict&#95;libClone&#39;» [#47136](https://github.com/ClickHouse/ClickHouse/pull/47136) ([alex filatov](https://github.com/phil-88)).
* Исправлено состояние гонки в алгоритме grace hash join с LIMIT [#47153](https://github.com/ClickHouse/ClickHouse/pull/47153) ([Vladimir C](https://github.com/vdimir)).
* Исправлена поддержка PREWHERE для конкретных столбцов [#47154](https://github.com/ClickHouse/ClickHouse/pull/47154) ([Azat Khuzhin](https://github.com/azat)).
* Устранена возможная взаимоблокировка в Query Status [#47161](https://github.com/ClickHouse/ClickHouse/pull/47161) ([Kruglov Pavel](https://github.com/Avogar)).
* Запрещён `INSERT SELECT` для той же таблицы `Join`, так как это приводит к дедлоку [#47260](https://github.com/ClickHouse/ClickHouse/pull/47260) ([Vladimir C](https://github.com/vdimir)).
* Пропускать уже объединённые партиции при слияниях по параметру `min_age_to_force_merge_seconds` [#47303](https://github.com/ClickHouse/ClickHouse/pull/47303) ([Antonio Andelic](https://github.com/antonio2368)).
* Изменена функция `find&#95;first&#95;symbols`, чтобы она работала как ожидается с `find&#95;first&#95;not&#95;symbols` [#47304](https://github.com/ClickHouse/ClickHouse/pull/47304) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлен вывод типов для больших чисел в CSV [#47410](https://github.com/ClickHouse/ClickHouse/pull/47410) ([Kruglov Pavel](https://github.com/Avogar)).
* Отключена оптимизация логических выражений для выражений с псевдонимами. [#47451](https://github.com/ClickHouse/ClickHouse/pull/47451) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка в `decodeURLComponent` [#47457](https://github.com/ClickHouse/ClickHouse/pull/47457) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлен граф EXPLAIN с проекциями [#47473](https://github.com/ClickHouse/ClickHouse/pull/47473) ([flynn](https://github.com/ucasfl)).
* Исправлены параметры запроса [#47488](https://github.com/ClickHouse/ClickHouse/pull/47488) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Параметризованное представление: исправление ошибки. [#47495](https://github.com/ClickHouse/ClickHouse/pull/47495) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Фаззер для форматов данных и соответствующие исправления. [#47519](https://github.com/ClickHouse/ClickHouse/pull/47519) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена проверка монотонности для `DateTime64` [#47526](https://github.com/ClickHouse/ClickHouse/pull/47526) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка «несоответствие структуры блока» для столбца Nullable LowCardinality [#47537](https://github.com/ClickHouse/ClickHouse/pull/47537) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Корректное устранение ошибки в Apache Parquet [#45878](https://github.com/ClickHouse/ClickHouse/issues/45878) [#47538](https://github.com/ClickHouse/ClickHouse/pull/47538) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен параллельный парсинг формата `BSONEachRow` при некорректном размере документа [#47540](https://github.com/ClickHouse/ClickHouse/pull/47540) ([Kruglov Pavel](https://github.com/Avogar)).
* Сохранять информацию об ошибке в `system.distribution_queue` при выполнении `SYSTEM FLUSH DISTRIBUTED` [#47541](https://github.com/ClickHouse/ClickHouse/pull/47541) ([Azat Khuzhin](https://github.com/azat)).
* Проверка на наличие дублирующегося столбца в формате `BSONEachRow` [#47609](https://github.com/ClickHouse/ClickHouse/pull/47609) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено ожидание блокировки zero-copy во время операции перемещения [#47631](https://github.com/ClickHouse/ClickHouse/pull/47631) ([alesapin](https://github.com/alesapin)).
* Исправлена агрегация по партициям [#47634](https://github.com/ClickHouse/ClickHouse/pull/47634) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена ошибка сериализации кортежа как массива в формате `BSONEachRow` [#47690](https://github.com/ClickHouse/ClickHouse/pull/47690) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено падение в `polygonsSymDifferenceCartesian` [#47702](https://github.com/ClickHouse/ClickHouse/pull/47702) ([pufit](https://github.com/pufit)).
* Исправлено чтение сжатых файлов в хранилище `File` с использованием сжатия `zlib` и `gzip` [#47796](https://github.com/ClickHouse/ClickHouse/pull/47796) ([Anton Popov](https://github.com/CurtizJ)).
* Улучшено обнаружение пустых запросов для PostgreSQL (для драйвера pgx для Go) [#47854](https://github.com/ClickHouse/ClickHouse/pull/47854) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проверка монотонности DateTime для типов LowCardinality [#47860](https://github.com/ClickHouse/ClickHouse/pull/47860) ([Antonio Andelic](https://github.com/antonio2368)).
* Использовать restore&#95;threads (вместо backup&#95;threads) для операции RESTORE ASYNC [#47861](https://github.com/ClickHouse/ClickHouse/pull/47861) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа `DROP COLUMN` для ReplicatedMergeTree, содержащего проекции [#47883](https://github.com/ClickHouse/ClickHouse/pull/47883) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправление механизма восстановления реплицируемой базы данных [#47901](https://github.com/ClickHouse/ClickHouse/pull/47901) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Хотфикс для излишне подробных предупреждений в HTTP [#47903](https://github.com/ClickHouse/ClickHouse/pull/47903) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена ошибка «Field value too long» в `catboostEvaluate` [#47970](https://github.com/ClickHouse/ClickHouse/pull/47970) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена проблема [#36971](https://github.com/ClickHouse/ClickHouse/issues/36971): Watchdog: завершать работу с ненулевым кодом при завершении дочернего процесса [#47973](https://github.com/ClickHouse/ClickHouse/pull/47973) ([Коренберг Марк](https://github.com/socketpair)).
* Исправление ошибки «index file `cidx` is unexpectedly long» [#48010](https://github.com/ClickHouse/ClickHouse/pull/48010) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлен запрос в MaterializedPostgreSQL для получения атрибутов (replica-identity) [#48015](https://github.com/ClickHouse/ClickHouse/pull/48015) ([Solomatov Sergei](https://github.com/solomatovs)).
* parseDateTime(): исправлено неопределённое поведение (переполнение знакового целого) [#48019](https://github.com/ClickHouse/ClickHouse/pull/48019) ([Robert Schulze](https://github.com/rschu1ze)).
* Используйте уникальные имена для записей (Record) в Avro, чтобы избежать повторного использования их схем [#48057](https://github.com/ClickHouse/ClickHouse/pull/48057) ([Kruglov Pavel](https://github.com/Avogar)).
* Корректно настроены тайм-ауты TCP/HTTP-сокетов в Keeper [#48108](https://github.com/ClickHouse/ClickHouse/pull/48108) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлен потенциальный вызов метода через нулевой указатель в формате `Avro` [#48184](https://github.com/ClickHouse/ClickHouse/pull/48184) ([Kruglov Pavel](https://github.com/Avogar)).

### <a id="232"></a> Релиз ClickHouse 23.2, 2023-02-23 {#232}

#### Изменения, нарушающие обратную совместимость {#backward-incompatible-change-8}
* Функция "toDayOfWeek()" (псевдоним: "DAYOFWEEK") расширена аргументом режима, который задаёт, начинается ли неделя с понедельника или воскресенья и начинается ли счёт с 0 или 1. Для согласованности с другими функциями работы с датой и временем аргумент режима был вставлен между аргументами времени и часового пояса. Это нарушает существующее использование (ранее недокументированного) двухаргументного синтаксиса "toDayOfWeek(time, time_zone)". Исправление — переписать вызов функции как "toDayOfWeek(time, 0, time_zone)". [#45233](https://github.com/ClickHouse/ClickHouse/pull/45233) ([Robert Schulze](https://github.com/rschu1ze)).
* Настройка `max_query_cache_size` переименована в `filesystem_cache_max_download_size`. [#45614](https://github.com/ClickHouse/ClickHouse/pull/45614) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Пользователь `default` по умолчанию больше не будет иметь права доступа типа `SHOW NAMED COLLECTION` (например, пользователь `default` больше не сможет выдавать привилегию ALL другим пользователям, как это было раньше, поэтому этот PR является обратно несовместимым). [#46010](https://github.com/ClickHouse/ClickHouse/pull/46010) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Если предложение SETTINGS указано перед предложением FORMAT, настройки будут применены и к форматированию. [#46003](https://github.com/ClickHouse/ClickHouse/pull/46003) ([Azat Khuzhin](https://github.com/azat)).
* Удалена поддержка настройки `materialized_postgresql_allow_automatic_update` (которая по умолчанию была выключена). [#46106](https://github.com/ClickHouse/ClickHouse/pull/46106) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Незначительно улучшена производительность `countDigits` на реалистичных наборах данных. Это закрыло [#44518](https://github.com/ClickHouse/ClickHouse/issues/44518). В предыдущих версиях `countDigits(0)` возвращала `0`; теперь она возвращает `1`, что более корректно и соответствует существующей документации. [#46187](https://github.com/ClickHouse/ClickHouse/pull/46187) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Запрещено создание новых столбцов, сжатых комбинацией кодеков "Delta" или "DoubleDelta" с последующим применением кодеков "Gorilla" или "FPC". Это ограничение можно обойти, используя настройку "allow_suspicious_codecs = true". [#45652](https://github.com/ClickHouse/ClickHouse/pull/45652) ([Robert Schulze](https://github.com/rschu1ze)).

#### Новая возможность {#new-feature-10}

* Добавлены движок таблиц `StorageIceberg` и табличная функция `iceberg` для доступа к хранилищу таблиц Iceberg в S3. [#45384](https://github.com/ClickHouse/ClickHouse/pull/45384) ([flynn](https://github.com/ucasfl)).
* Добавлена возможность настраивать хранилище с помощью `SETTINGS disk = '<disk_name>'` (вместо `storage_policy`), а также с явным созданием диска `SETTINGS disk = disk(type=s3, ...)`. [#41976](https://github.com/ClickHouse/ClickHouse/pull/41976) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлены счетчики `ProfileEvents` в `system.part_log`. [#38614](https://github.com/ClickHouse/ClickHouse/pull/38614) ([Bharat Nallan](https://github.com/bharatnc)).
* Расширение существующего движка `ReplacingMergeTree`, позволяющее выполнять дублирующие вставки. Он объединяет возможности `ReplacingMergeTree` и `CollapsingMergeTree` в одном движке семейства MergeTree. Удалённые данные не возвращаются при запросах, но и с диска не удаляются. [#41005](https://github.com/ClickHouse/ClickHouse/pull/41005) ([youennL-cs](https://github.com/youennL-cs)).
* Добавлена функция `generateULID`. Закрыта задача [#36536](https://github.com/ClickHouse/ClickHouse/issues/36536). [#44662](https://github.com/ClickHouse/ClickHouse/pull/44662) ([Nikolay Degterinsky](https://github.com/evillique)).
* Добавлена агрегатная функция `corrMatrix`, вычисляющая корреляцию для каждой пары столбцов. Кроме того, поскольку агрегатные функции `covarSamp` и `covarPop` схожи с `corr`, заодно добавлены `covarSampMatrix` и `covarPopMatrix`. @alexey-milovidov закрыл [#44587](https://github.com/ClickHouse/ClickHouse/issues/44587). [#44680](https://github.com/ClickHouse/ClickHouse/pull/44680) ([FFFFFFFHHHHHHH](https://github.com/FFFFFFFHHHHHHH)).
* Добавлена функция arrayShuffle для случайного перемешивания элементов массива. [#45271](https://github.com/ClickHouse/ClickHouse/pull/45271) ([Joanna Hulboj](https://github.com/jh0x)).
* Добавлена поддержка типов `FIXED_SIZE_BINARY` в Arrow и `FIXED_LENGTH_BYTE_ARRAY` в `Parquet` с отображением их в `FixedString`. Добавлены настройки `output_format_parquet_fixed_string_as_fixed_byte_array/output_format_arrow_fixed_string_as_fixed_byte_array` для управления типом вывода FixedString по умолчанию. Закрывает [#45326](https://github.com/ClickHouse/ClickHouse/issues/45326). [#45340](https://github.com/ClickHouse/ClickHouse/pull/45340) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен новый столбец `last_exception_time` в системную таблицу system.replication&#95;queue. [#45457](https://github.com/ClickHouse/ClickHouse/pull/45457) ([Frank Chen](https://github.com/FrankChen021)).
* Добавлены две новые функции, которые позволяют использовать пользовательские ключи и seed-значения с SipHash{64,128}. [#45513](https://github.com/ClickHouse/ClickHouse/pull/45513) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Разрешена трёхаргументная версия табличной функции `format`. Закрывает [#45808](https://github.com/ClickHouse/ClickHouse/issues/45808). [#45873](https://github.com/ClickHouse/ClickHouse/pull/45873) ([FFFFFFFHHHHHHH](https://github.com/FFFFFFFHHHHHHH)).
* Добавлена поддержка формата `JodaTime` для спецификаторов &#39;x&#39;, &#39;w&#39;, &#39;S&#39;. См. [https://joda-time.sourceforge.net/apidocs/org/joda/time/format/DateTimeFormat.html](https://joda-time.sourceforge.net/apidocs/org/joda/time/format/DateTimeFormat.html). [#46073](https://github.com/ClickHouse/ClickHouse/pull/46073) ([zk&#95;kiger](https://github.com/zk-kiger)).
* Добавлена поддержка оконной функции `ntile`. ([lgbo](https://github.com/lgbo-ustc)).
* Добавлена настройка `final` для автоматического применения модификатора `FINAL` к каждой таблице. [#40945](https://github.com/ClickHouse/ClickHouse/pull/40945) ([Arthur Passos](https://github.com/arthurpassos)).
* Добавлены функции `arrayPartialSort` и `arrayPartialReverseSort`. [#46296](https://github.com/ClickHouse/ClickHouse/pull/46296) ([Joanna Hulboj](https://github.com/jh0x)).
* Новый HTTP-параметр `client_protocol_version` позволяет задавать версию клиентского протокола для HTTP-ответов в формате Native. [#40397](https://github.com/ClickHouse/ClickHouse/issues/40397). [#46360](https://github.com/ClickHouse/ClickHouse/pull/46360) ([Geoff Genz](https://github.com/genzgd)).
* Добавлена новая функция `regexpExtract`, аналогичная функции Spark `REGEXP_EXTRACT` для обеспечения совместимости. Она похожа на существующую функцию `extract`. [#46469](https://github.com/ClickHouse/ClickHouse/pull/46469) ([李扬](https://github.com/taiyang-li)).
* Добавлена новая функция `JSONArrayLength`, которая возвращает количество элементов во внешнем массиве JSON. Функция возвращает NULL, если входная JSON-строка имеет неверный формат. [#46631](https://github.com/ClickHouse/ClickHouse/pull/46631) ([李扬](https://github.com/taiyang-li)).



#### Повышение производительности {#performance-improvement-10}

* Введённая логика работает, если условие PREWHERE представляет собой конъюнкцию нескольких условий (cond1 AND cond2 AND ... ). Она группирует в шаги те условия, которые требуют чтения одних и тех же столбцов. После каждого шага вычисляется соответствующая часть полного условия, и результирующие строки могут быть отфильтрованы. Это позволяет читать меньше строк на следующих шагах, тем самым экономя пропускную способность ввода-вывода и выполняя меньше вычислений. Эта логика пока по умолчанию отключена. Она будет включена по умолчанию в одном из будущих релизов, когда будет подтверждено отсутствие регрессий, поэтому настоятельно рекомендуется использовать её для тестирования. Её поведение можно контролировать с помощью двух настроек: &quot;enable&#95;multiple&#95;prewhere&#95;read&#95;steps&quot; и &quot;move&#95;all&#95;conditions&#95;to&#95;prewhere&quot;. [#46140](https://github.com/ClickHouse/ClickHouse/pull/46140) ([Alexander Gololobov](https://github.com/davenger)).
* Добавлена опция для независимой агрегации партиций, если ключ партиционирования таблицы совместим с ключом `GROUP BY`. Управляется настройкой `allow_aggregate_partitions_independently`. По умолчанию отключена из-за ограниченной применимости (см. документацию). [#45364](https://github.com/ClickHouse/ClickHouse/pull/45364) ([Nikita Taranov](https://github.com/nickitat)).
* Теперь можно использовать алгоритм вертикального слияния для частей в формате Compact. Это позволит серверу ClickHouse использовать значительно меньше памяти для фоновых операций. Исправление закрывает [#46084](https://github.com/ClickHouse/ClickHouse/issues/46084). [#45681](https://github.com/ClickHouse/ClickHouse/pull/45681) [#46282](https://github.com/ClickHouse/ClickHouse/pull/46282) ([Anton Popov](https://github.com/CurtizJ)).
* Оптимизировать чтение `Parquet` с помощью пакетного ридера. [#45878](https://github.com/ClickHouse/ClickHouse/pull/45878) ([LiuNeng](https://github.com/liuneng1994)).
* Добавлен новый вариант значения параметра `local_filesystem_read_method` — `io_uring`, основанный на асинхронной подсистеме Linux [io&#95;uring](https://kernel.dk/io_uring.pdf), что почти повсеместно улучшает производительность чтения по сравнению с методом `pread` по умолчанию. [#38456](https://github.com/ClickHouse/ClickHouse/pull/38456) ([Saulius Valatka](https://github.com/sauliusvl)).
* Переписывайте агрегатные функции с выражением `if` в качестве аргумента, когда возможно логически эквивалентное преобразование. Например, `avg(if(cond, col, null))` можно переписать как `avgIf(cond, col)`. Это помогает повысить производительность. [#44730](https://github.com/ClickHouse/ClickHouse/pull/44730) ([李扬](https://github.com/taiyang-li)).
* Повышена производительность функций lower и upper с использованием инструкций AVX-512. [#37894](https://github.com/ClickHouse/ClickHouse/pull/37894) ([yaqi-zhao](https://github.com/yaqi-zhao)).
* Снято ограничение, из-за которого на системах с количеством ядер &gt;=32 и отключённым SMT ClickHouse использовал только половину ядер (например, при отключённом в BIOS Hyper-Threading). [#44973](https://github.com/ClickHouse/ClickHouse/pull/44973) ([Robert Schulze](https://github.com/rschu1ze)).
* Улучшена производительность функции `multiIf` за счёт колоночного исполнения, ускорив её в 2,3 раза. [#45296](https://github.com/ClickHouse/ClickHouse/pull/45296) ([李扬](https://github.com/taiyang-li)).
* Добавлен быстрый путь выполнения для функции `position` в случае пустой подстроки. [#45382](https://github.com/ClickHouse/ClickHouse/pull/45382) ([李扬](https://github.com/taiyang-li)).
* Оптимизация `query_plan_remove_redundant_sorting` включена по умолчанию. Оптимизация была реализована в [#45420](https://github.com/ClickHouse/ClickHouse/issues/45420). [#45567](https://github.com/ClickHouse/ClickHouse/pull/45567) ([Igor Nikonov](https://github.com/devcrafter)).
* Увеличен размер чанка HTTP Transfer-Encoding для повышения производительности больших запросов, выполняемых через HTTP-интерфейс. [#45593](https://github.com/ClickHouse/ClickHouse/pull/45593) ([Geoff Genz](https://github.com/genzgd)).
* Повышена производительность коротких запросов `SELECT`, читающих из таблиц с большим количеством столбцов типов `Array`/`Map`/`Nested`. [#45630](https://github.com/ClickHouse/ClickHouse/pull/45630) ([Anton Popov](https://github.com/CurtizJ)).
* Улучшена производительность фильтрации для больших целых чисел и типов Decimal. [#45949](https://github.com/ClickHouse/ClickHouse/pull/45949) ([李扬](https://github.com/taiyang-li)).
* Это изменение может существенно снизить накладные расходы на получение фильтра из ColumnNullable(UInt8) и повысить общую производительность запросов. Чтобы оценить влияние этого изменения, мы использовали бенчмарк TPC-H, но изменили типы столбцов с not nullable на nullable и измеряли QPS его запросов в качестве показателя производительности. [#45962](https://github.com/ClickHouse/ClickHouse/pull/45962) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
* Виртуальные столбцы `_part` и `_partition_id` теперь имеют тип `LowCardinality(String)`. Закрывает [#45964](https://github.com/ClickHouse/ClickHouse/issues/45964). [#45975](https://github.com/ClickHouse/ClickHouse/pull/45975) ([flynn](https://github.com/ucasfl)).
* Улучшена производительность преобразования Decimal, когда масштаб (scale) не изменяется. [#46095](https://github.com/ClickHouse/ClickHouse/pull/46095) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Предоставлена возможность увеличить предвыборку данных при чтении. [#46168](https://github.com/ClickHouse/ClickHouse/pull/46168) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Переписать `arrayExists(x -> x = 1, arr)` -&gt; `has(arr, 1)`, что позволяет повысить производительность в 1,34 раза. [#46188](https://github.com/ClickHouse/ClickHouse/pull/46188) ([李扬](https://github.com/taiyang-li)).
* Исправлено слишком большое использование памяти при вертикальных слияниях на неудалённом диске. Для удалённого диска теперь учитывается параметр `max_insert_delayed_streams_for_parallel_write`. [#46275](https://github.com/ClickHouse/ClickHouse/pull/46275) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Обновлён zstd до v1.5.4. В этой версии есть небольшие улучшения производительности и коэффициента сжатия. Если вы запускаете реплики с разными версиями ClickHouse, вы можете увидеть корректные сообщения об ошибках вида `Data after merge/mutation is not byte-identical to data on another replicas.` с пояснением. Это нормальное поведение, и вам не стоит беспокоиться. [#46280](https://github.com/ClickHouse/ClickHouse/pull/46280) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено ухудшение производительности, вызванное [#39737](https://github.com/ClickHouse/ClickHouse/issues/39737). [#46309](https://github.com/ClickHouse/ClickHouse/pull/46309) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Обработчик `replicas_status` будет отвечать быстро даже при большой очереди репликации. [#46310](https://github.com/ClickHouse/ClickHouse/pull/46310) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка AVX-512 для агрегатной функции `sum`, унарных арифметических функций и функций сравнения. [#37870](https://github.com/ClickHouse/ClickHouse/pull/37870) ([zhao zhou](https://github.com/zzachimed)).
* Переписан код, отвечающий за распределение меток и общую координацию чтения, чтобы добиться максимального прироста производительности. Это закрывает [#34527](https://github.com/ClickHouse/ClickHouse/issues/34527). [#43772](https://github.com/ClickHouse/ClickHouse/pull/43772) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Удаляет избыточные операторы DISTINCT в запросе (подзапросах). Реализовано на уровне плана запроса. Выполняет такую же оптимизацию, как `optimize_duplicate_order_by_and_distinct`, для операторов DISTINCT. Включается с помощью настройки `query_plan_remove_redundant_distinct`. Связано с [#42648](https://github.com/ClickHouse/ClickHouse/issues/42648). [#44176](https://github.com/ClickHouse/ClickHouse/pull/44176) ([Igor Nikonov](https://github.com/devcrafter)).
* Несколько оптимизаций преобразования запросов: `sumIf(123, cond) -> 123 * countIf(1, cond)`, `sum(if(cond, 123, 0)) -> 123 * countIf(cond)`, `sum(if(cond, 0, 123)) -> 123 * countIf(not(cond))` [#44728](https://github.com/ClickHouse/ClickHouse/pull/44728) ([李扬](https://github.com/taiyang-li)).
* Улучшено взаимодействие ограниченных по памяти операций слияния и агрегации с сохранением порядка в верхней части плана запроса. Ранее в некоторых случаях мы переходили к явной сортировке для AIO, хотя в ней фактически не было необходимости. [#45892](https://github.com/ClickHouse/ClickHouse/pull/45892) ([Nikita Taranov](https://github.com/nickitat)).
* Параллельные слияния по умолчанию планируются по круговой схеме (round-robin), чтобы обеспечить справедливую работу без голодания. Ранее на сильно перегруженных шардах крупные слияния могли «голодать» по сравнению с мелкими слияниями из-за использования строгого приоритетного планирования. Добавлен параметр конфигурации сервера `background_merges_mutations_scheduling_policy` для выбора алгоритма планирования (`round_robin` или `shortest_task_first`). [#46247](https://github.com/ClickHouse/ClickHouse/pull/46247) ([Sergei Trifonov](https://github.com/serxa)).



#### Улучшение {#improvement-10}

* Включены повторные попытки выполнения INSERT по умолчанию при потере сессии ZooKeeper. Мы уже используем это в продакшене. [#46308](https://github.com/ClickHouse/ClickHouse/pull/46308) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность игнорировать неизвестные ключи в JSON-объекте для именованных кортежей (`input_format_json_ignore_unknown_keys_in_named_tuple`). [#45678](https://github.com/ClickHouse/ClickHouse/pull/45678) ([Azat Khuzhin](https://github.com/azat)).
* Добавлена поддержка оптимизации условий `where` с переносом выражения сортировочного ключа в `prewhere` для запросов с `final`. [#38893](https://github.com/ClickHouse/ClickHouse/issues/38893). [#38950](https://github.com/ClickHouse/ClickHouse/pull/38950) ([hexiaoting](https://github.com/hexiaoting)).
* Добавлены новые метрики для резервных копий: num&#95;processed&#95;files и processed&#95;files&#95;size, описывающие фактическое количество обработанных файлов и их общий размер. [#42244](https://github.com/ClickHouse/ClickHouse/pull/42244) ([Aleksandr](https://github.com/AVMusorin)).
* Добавлены повторные попытки при DNS-ошибках межсерверного взаимодействия. [#43179](https://github.com/ClickHouse/ClickHouse/pull/43179) ([Anton Kozlov](https://github.com/tonickkozlov)).
* Улучшение Keeper: добавлена попытка предварительно выделять место на диске, чтобы избежать непредсказуемых сбоев из-за нехватки свободного пространства. Добавлена настройка `max_log_file_size` для ограничения максимального размера файлов журнала Raft в Keeper. [#44370](https://github.com/ClickHouse/ClickHouse/pull/44370) ([Antonio Andelic](https://github.com/antonio2368)).
* Оптимизирована логика работы API задержки реплики в случае, когда реплика доступна только для чтения. [#45148](https://github.com/ClickHouse/ClickHouse/pull/45148) ([mateng915](https://github.com/mateng0915)).
* Интерактивно запрашивать пароль в clickhouse-client, если пустой пароль не подходит. Закрывает [#46702](https://github.com/ClickHouse/ClickHouse/issues/46702). [#46730](https://github.com/ClickHouse/ClickHouse/pull/46730) ([Nikolay Degterinsky](https://github.com/evillique)).
* Помечать использование сжатия `Gorilla` для столбцов с типом, отличным от Float*, как подозрительное. [#45376](https://github.com/ClickHouse/ClickHouse/pull/45376) ([Robert Schulze](https://github.com/rschu1ze)).
* Отображать имя реплики, выполняющей слияние, в столбце `postpone_reason`. [#45458](https://github.com/ClickHouse/ClickHouse/pull/45458) ([Frank Chen](https://github.com/FrankChen021)).
* Сохранять трассировку стека исключения в part&#95;log. [#45459](https://github.com/ClickHouse/ClickHouse/pull/45459) ([Frank Chen](https://github.com/FrankChen021)).
* Словарь `regexp_tree` доработан и теперь совместим с [https://github.com/ua-parser/uap-core](https://github.com/ua-parser/uap-core). [#45631](https://github.com/ClickHouse/ClickHouse/pull/45631) ([Han Fei](https://github.com/hanfei1991)).
* Обновлена проверка `SYSTEM SYNC REPLICA`, что позволяет закрыть [#45508](https://github.com/ClickHouse/ClickHouse/issues/45508) и [#45648](https://github.com/ClickHouse/ClickHouse/pull/45648) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Переименована настройка `replication_alter_partitions_sync` в `alter_sync`. [#45659](https://github.com/ClickHouse/ClickHouse/pull/45659) ([Antonio Andelic](https://github.com/antonio2368)).
* Табличная функция `generateRandom` и движок теперь поддерживают типы данных `LowCardinality`. Это полезно для тестирования: например, вы можете выполнить `INSERT INTO table SELECT * FROM generateRandom() LIMIT 1000`. Это нужно для отладки [#45590](https://github.com/ClickHouse/ClickHouse/issues/45590). [#45661](https://github.com/ClickHouse/ClickHouse/pull/45661) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Экспериментальный кэш результатов запросов теперь поддерживает более модульную конфигурацию. [#45679](https://github.com/ClickHouse/ClickHouse/pull/45679) ([Robert Schulze](https://github.com/rschu1ze)).
* «query result cache» переименован в «query cache». [#45682](https://github.com/ClickHouse/ClickHouse/pull/45682) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена команда `SYSTEM SYNC FILE CACHE`, которая выполняет системный вызов `sync`. [#8921](https://github.com/ClickHouse/ClickHouse/issues/8921). [#45685](https://github.com/ClickHouse/ClickHouse/pull/45685) ([DR](https://github.com/freedomDR)).
* Добавлена новая настройка S3 `allow_head_object_request`. Этот PR делает использование запроса `GetObjectAttributes` вместо `HeadObject`, введённого в [https://github.com/ClickHouse/ClickHouse/pull/45288](https://github.com/ClickHouse/ClickHouse/pull/45288), необязательным (и отключённым по умолчанию). [#45701](https://github.com/ClickHouse/ClickHouse/pull/45701) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена возможность переопределять настройки подключения по именам подключений (то есть теперь можно забыть о хранении паролей для каждого подключения: вы можете просто поместить всё в `~/.clickhouse-client/config.xml` и даже использовать для них разные файлы истории, что тоже может быть полезно). [#45715](https://github.com/ClickHouse/ClickHouse/pull/45715) ([Azat Khuzhin](https://github.com/azat)).
* Формат Arrow: добавлена поддержка типа `duration`. Закрывает [#45669](https://github.com/ClickHouse/ClickHouse/issues/45669). [#45750](https://github.com/ClickHouse/ClickHouse/pull/45750) ([flynn](https://github.com/ucasfl)).
* Расширено логирование в Query Cache для улучшения анализа поведения кэша. [#45751](https://github.com/ClickHouse/ClickHouse/pull/45751) ([Robert Schulze](https://github.com/rschu1ze)).
* Серверные настройки кэша запросов теперь могут изменяться во время работы. [#45758](https://github.com/ClickHouse/ClickHouse/pull/45758) ([Robert Schulze](https://github.com/rschu1ze)).
* Скрывать пароль в логах при указании аргументов табличной функции с помощью именованной коллекции. [#45774](https://github.com/ClickHouse/ClickHouse/pull/45774) ([Vitaly Baranov](https://github.com/vitlibar)).
* Улучшен внутренний клиент S3 для корректного определения регионов и перенаправлений для различных типов URL-адресов. [#45783](https://github.com/ClickHouse/ClickHouse/pull/45783) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена поддержка типов Map, IPv4 и IPv6 в функцию generateRandom. В основном полезно для тестирования. [#45785](https://github.com/ClickHouse/ClickHouse/pull/45785) ([Raúl Marín](https://github.com/Algunenano)).
* Добавлена поддержка функций empty/notEmpty для IP-типов данных. [#45799](https://github.com/ClickHouse/ClickHouse/pull/45799) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Столбец `num_processed_files` был разделён на два столбца: `num_files` (для BACKUP) и `files_read` (для RESTORE). Столбец `processed_files_size` был разделён на два столбца: `total_size` (для BACKUP) и `bytes_read` (для RESTORE). [#45800](https://github.com/ClickHouse/ClickHouse/pull/45800) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена поддержка запроса `SHOW ENGINES` для совместимости с MySQL. [#45859](https://github.com/ClickHouse/ClickHouse/pull/45859) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* Улучшена работа обфускатора с запросами. [#45867](https://github.com/ClickHouse/ClickHouse/pull/45867) ([Raúl Marín](https://github.com/Algunenano)).
* Улучшено поведение преобразования в Date для граничного значения 65535 (2149-06-06). [#46042](https://github.com/ClickHouse/ClickHouse/pull/46042) [#45914](https://github.com/ClickHouse/ClickHouse/pull/45914) ([Joanna Hulboj](https://github.com/jh0x)).
* Добавлена настройка `check_referential_table_dependencies` для проверки ссылочных зависимостей таблиц при выполнении `DROP TABLE`. Этот PR закрывает [#38326](https://github.com/ClickHouse/ClickHouse/issues/38326). [#45936](https://github.com/ClickHouse/ClickHouse/pull/45936) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен `tupleElement`, теперь он возвращает `Null`, если аргумент равен `Null`. Закрывает [#45894](https://github.com/ClickHouse/ClickHouse/issues/45894). [#45952](https://github.com/ClickHouse/ClickHouse/pull/45952) ([flynn](https://github.com/ucasfl)).
* Выдавать ошибку, если ни один файл не удовлетворяет шаблону S3. Закрывает [#45587](https://github.com/ClickHouse/ClickHouse/issues/45587). [#45957](https://github.com/ClickHouse/ClickHouse/pull/45957) ([chen](https://github.com/xiedeyantu)).
* Используйте данные о состоянии кластера, чтобы проверить одновременные операции резервного копирования/восстановления. [#45982](https://github.com/ClickHouse/ClickHouse/pull/45982) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* ClickHouse Client: использовать сопоставление «exact» для нечеткого поиска, которое корректно не учитывает регистр и использует более подходящий алгоритм сопоставления SQL-запросов. [#46000](https://github.com/ClickHouse/ClickHouse/pull/46000) ([Azat Khuzhin](https://github.com/azat)).
* Запрещён некорректный синтаксис создания представления `CREATE View X TO Y AS SELECT`. Закрывает [#4331](https://github.com/ClickHouse/ClickHouse/issues/4331). [#46043](https://github.com/ClickHouse/ClickHouse/pull/46043) ([flynn](https://github.com/ucasfl)).
* Семейство движков `Log` теперь поддерживает задание параметра `storage_policy`. Закрывает [#43421](https://github.com/ClickHouse/ClickHouse/issues/43421). [#46044](https://github.com/ClickHouse/ClickHouse/pull/46044) ([flynn](https://github.com/ucasfl)).
* Улучшен формат `JSONColumns` для пустых результатов. Закрывает [#46024](https://github.com/ClickHouse/ClickHouse/issues/46024). [#46053](https://github.com/ClickHouse/ClickHouse/pull/46053) ([flynn](https://github.com/ucasfl)).
* Добавлена эталонная реализация SipHash128. [#46065](https://github.com/ClickHouse/ClickHouse/pull/46065) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Добавлена новая метрика для регистрации времени и объёма выделений памяти с использованием mmap. [#46068](https://github.com/ClickHouse/ClickHouse/pull/46068) ([李扬](https://github.com/taiyang-li)).
* В настоящее время для функций `leftPad`, `rightPad`, `leftPadUTF8`, `rightPadUTF8` второй аргумент `length` должен иметь тип UInt8|16|32|64|128|256. Это ограничение слишком жёсткое для пользователей ClickHouse, к тому же оно не соответствует другим аналогичным функциям, таким как `arrayResize`, `substring` и т. д. [#46103](https://github.com/ClickHouse/ClickHouse/pull/46103) ([李扬](https://github.com/taiyang-li)).
* Исправлена проверка assert в функции `welchTTest` в отладочной сборке, когда результирующая статистика равна NaN. Поведение унифицировано с другими аналогичными функциями. Изменено поведение `studentTTest`, чтобы возвращать NaN вместо выбрасывания исключения, так как предыдущее поведение было неудобным. Это закрывает [#41176](https://github.com/ClickHouse/ClickHouse/issues/41176). Это закрывает [#42162](https://github.com/ClickHouse/ClickHouse/issues/42162). [#46141](https://github.com/ClickHouse/ClickHouse/pull/46141) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Более удобное использование больших целых чисел и ORDER BY WITH FILL. Разрешено использовать обычные целые числа для начальных и конечных точек в WITH FILL при ORDER BY по большим (128-битным и 256-битным) целым числам. Исправлен ошибочный результат для больших целых чисел с отрицательными начальными или конечными точками. Это закрывает [#16733](https://github.com/ClickHouse/ClickHouse/issues/16733). [#46152](https://github.com/ClickHouse/ClickHouse/pull/46152) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлены столбцы `parts`, `active_parts` и `total_marks` в таблицу `system.tables` согласно [issue](https://github.com/ClickHouse/ClickHouse/issues/44336). [#46161](https://github.com/ClickHouse/ClickHouse/pull/46161) ([attack204](https://github.com/attack204)).
* Функции &quot;multi[Fuzzy]Match(Any|AnyIndex|AllIndices&#125;&quot; теперь отклоняют регулярные выражения, которые, вероятнее всего, будут очень медленно обрабатываться в vectorscan. [#46167](https://github.com/ClickHouse/ClickHouse/pull/46167) ([Robert Schulze](https://github.com/rschu1ze)).
* Когда `insert_null_as_default` включён и для столбца не определено значение по умолчанию, будет использовано значение по умолчанию для типа столбца. Также этот PR исправляет использование значений по умолчанию для значений null в случае столбцов типа LowCardinality. [#46171](https://github.com/ClickHouse/ClickHouse/pull/46171) ([Kruglov Pavel](https://github.com/Avogar)).
* Рекомендуется явно задавать ключи доступа для S3‑клиентов. Если `use_environment_credentials` установлен в `true` и пользователь передал ключи доступа через запрос или конфигурацию, они будут использоваться вместо ключей из переменной окружения. [#46191](https://github.com/ClickHouse/ClickHouse/pull/46191) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлен псевдоним `DATE_FORMAT()` для функции `formatDateTime()` для улучшения совместимости с SQL-диалектом MySQL, расширена функция `formatDateTime` спецификаторами формата `a`, `b`, `c`, `h`, `i`, `k`, `l`, `r`, `s`, `W`. ### Документация для изменений, видимых пользователю Краткое описание для пользователя: `DATE_FORMAT` — это псевдоним `formatDateTime`. Форматирует время в соответствии с заданной строкой формата. Параметр `Format` является константным выражением, поэтому вы не можете использовать несколько форматов для одного результирующего столбца. (Предоставьте ссылку на [formatDateTime](/sql-reference/functions/date-time-functions/#formatDateTime)). [#46302](https://github.com/ClickHouse/ClickHouse/pull/46302) ([Jake Bamrah](https://github.com/JakeBamrah)).
* Добавлены `ProfileEvents` и `CurrentMetrics` о задачах обратного вызова при работе с параллельными репликами (таблицы `s3Cluster` и `MergeTree`). [#46313](https://github.com/ClickHouse/ClickHouse/pull/46313) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка `DELETE` и `UPDATE` для таблиц, использующих движок хранения `KeeperMap`. [#46330](https://github.com/ClickHouse/ClickHouse/pull/46330) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена возможность выполнения запросов `RENAME` с параметрами запроса. Исправляет [#45778](https://github.com/ClickHouse/ClickHouse/issues/45778). [#46407](https://github.com/ClickHouse/ClickHouse/pull/46407) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлены параметризованные запросы SELECT с использованием преобразователя REPLACE. Исправлена проблема [#33002](https://github.com/ClickHouse/ClickHouse/issues/33002). [#46420](https://github.com/ClickHouse/ClickHouse/pull/46420) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исключена внутренняя база данных, используемая для временных/внешних таблиц, из расчёта асинхронной метрики «NumberOfDatabases». Это делает поведение согласованным с системной таблицей «system.databases». [#46435](https://github.com/ClickHouse/ClickHouse/pull/46435) ([Robert Schulze](https://github.com/rschu1ze)).
* В таблицу distribution&#95;queue добавлен столбец `last_exception_time`. [#46564](https://github.com/ClickHouse/ClickHouse/pull/46564) ([Aleksandr](https://github.com/AVMusorin)).
* Поддержка оператора IN с параметром в параметризованных представлениях. [#46583](https://github.com/ClickHouse/ClickHouse/pull/46583) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Не загружать именованные коллекции при запуске сервера (загружать их при первом обращении к ним). [#46607](https://github.com/ClickHouse/ClickHouse/pull/46607) ([Kseniia Sumarokova](https://github.com/kssenii)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-10}
* Включён GWP-ASan, реализованный в рантайме LLVM. Это закрывает [#27039](https://github.com/ClickHouse/ClickHouse/issues/27039). [#45226](https://github.com/ClickHouse/ClickHouse/pull/45226) ([Han Fei](https://github.com/hanfei1991)).
* Мы хотим сделать наши тесты менее стабильными и более «хрупкими»: добавлена рандомизация настроек MergeTree в тестах. [#38983](https://github.com/ClickHouse/ClickHouse/pull/38983) ([Anton Popov](https://github.com/CurtizJ)).
* Включена поддержка HDFS на PowerPC, что помогает исправить следующие функциональные тесты: 02113_hdfs_assert.sh, 02244_hdfs_cluster.sql и 02368_cancel_write_into_hdfs.sh. [#44949](https://github.com/ClickHouse/ClickHouse/pull/44949) ([MeenaRenganathan22](https://github.com/MeenaRenganathan22)).
* Добавлен файл unit-файла systemd.service для clickhouse-keeper. Исправляет [#44293](https://github.com/ClickHouse/ClickHouse/issues/44293). [#45568](https://github.com/ClickHouse/ClickHouse/pull/45568) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Форк библиотеки Poco в ClickHouse был перемещён из `contrib/` в `base/poco/`. [#46075](https://github.com/ClickHouse/ClickHouse/pull/46075) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена опция для `clickhouse-watchdog`, позволяющая перезапускать дочерний процесс. Практической пользы это почти не даёт. [#46312](https://github.com/ClickHouse/ClickHouse/pull/46312) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Если переменная окружения `CLICKHOUSE_DOCKER_RESTART_ON_EXIT` установлена в значение 1, Docker-контейнер будет запускать `clickhouse-server` как дочерний процесс вместо процесса с PID 1 и перезапускать его при завершении. [#46391](https://github.com/ClickHouse/ClickHouse/pull/46391) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлен unit-файл службы systemd. [#46461](https://github.com/ClickHouse/ClickHouse/pull/46461) ([SuperDJY](https://github.com/cmsxbc)).
* Минимальная версия Clang, необходимая для сборки ClickHouse, повышена с 12 до 15. [#46710](https://github.com/ClickHouse/ClickHouse/pull/46710) ([Robert Schulze](https://github.com/rschu1ze)).
* Обновлён Intel QPL с v0.3.0 до v1.0.0. Библиотека libaccel-config теперь собирается и статически линкуется с библиотекой QPL вместо динамического связывания. [#45809](https://github.com/ClickHouse/ClickHouse/pull/45809) ([jasperzhu](https://github.com/jinjunzh)).

#### Исправление ошибок (ошибочное поведение, заметное пользователю, в официальном стабильном релизе) {#bug-fix-user-visible-misbehavior-in-official-stable-release}

* Сбрасывать данные строго в соответствии с `rabbitmq_flush_interval_ms` или `rabbitmq_max_block_size` в `StorageRabbitMQ`. Закрывает [#42389](https://github.com/ClickHouse/ClickHouse/issues/42389). Закрывает [#45160](https://github.com/ClickHouse/ClickHouse/issues/45160). [#44404](https://github.com/ClickHouse/ClickHouse/pull/44404) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Использовать PODArray для отрисовки в функции sparkBar, чтобы контролировать расход памяти. Закрывает [#44467](https://github.com/ClickHouse/ClickHouse/issues/44467). [#44489](https://github.com/ClickHouse/ClickHouse/pull/44489) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлена ошибка в функциях quantilesExactExclusive и quantilesExactInclusive, из-за которой возвращался неотсортированный элемент массива. [#45379](https://github.com/ClickHouse/ClickHouse/pull/45379) ([wujunfu](https://github.com/wujunfu)).
* Исправлено необработанное исключение в HTTPHandler при включённом OpenTelemetry. [#45456](https://github.com/ClickHouse/ClickHouse/pull/45456) ([Frank Chen](https://github.com/FrankChen021)).
* Не выводите тип Date из восьмизначных чисел. Это может привести к неверному считыванию данных. [#45581](https://github.com/ClickHouse/ClickHouse/pull/45581) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена работа настройки `odbc_bridge_use_connection_pooling`. [#45591](https://github.com/ClickHouse/ClickHouse/pull/45591) ([Bharat Nallan](https://github.com/bharatnc)).
* Когда вызывается callback в кэше, может случиться, что этот кэш уже уничтожен. Для безопасной работы мы захватываем члены класса по значению. Это также безопасно для планировщика задач, поскольку он будет деактивирован до уничтожения хранилища. Решает [#45548](https://github.com/ClickHouse/ClickHouse/issues/45548). [#45601](https://github.com/ClickHouse/ClickHouse/pull/45601) ([Han Fei](https://github.com/hanfei1991)).
* Исправлено повреждение данных при использовании кодеков Delta или DoubleDelta в сочетании с кодеком Gorilla. [#45615](https://github.com/ClickHouse/ClickHouse/pull/45615) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена проверка типов при использовании индекса блум-фильтра N-gram, чтобы избежать ошибочных чтений. [#45617](https://github.com/ClickHouse/ClickHouse/pull/45617) ([Antonio Andelic](https://github.com/antonio2368)).
* Было сообщено о нескольких сбоях с ошибкой сегментации в `c-ares`. Они появились вследствие моих предыдущих pull request&#39;ов. Я исправил их при помощи Александра Токмакова. [#45629](https://github.com/ClickHouse/ClickHouse/pull/45629) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлено описание ключа при обнаружении дубликатов первичного ключа. Это может происходить в проекциях. Подробности см. в [#45590](https://github.com/ClickHouse/ClickHouse/issues/45590). [#45686](https://github.com/ClickHouse/ClickHouse/pull/45686) ([Amos Bird](https://github.com/amosbird)).
* Задает метод и уровень сжатия для резервного копирования. Закрывает задачу [#45690](https://github.com/ClickHouse/ClickHouse/issues/45690). [#45737](https://github.com/ClickHouse/ClickHouse/pull/45737) ([Pradeep Chhetri](https://github.com/chhetripradeep)).
* Следует использовать `select_query_typed.limitByOffset` вместо `select_query_typed.limitOffset`. [#45817](https://github.com/ClickHouse/ClickHouse/pull/45817) ([刘陶峰](https://github.com/taofengliu)).
* При использовании экспериментального анализатора запросы вида `SELECT number FROM numbers(100) LIMIT 10 OFFSET 10;` возвращают неверные результаты (пустой результат для этого SQL‑запроса). Это вызвано лишним шагом смещения OFFSET, добавленным планировщиком. [#45822](https://github.com/ClickHouse/ClickHouse/pull/45822) ([刘陶峰](https://github.com/taofengliu)).
* Обратная совместимость: разрешено неявное сужающее преобразование из UInt64 в IPv4, необходимое для выражения «INSERT ... VALUES ...». [#45865](https://github.com/ClickHouse/ClickHouse/pull/45865) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена ошибка в парсере IPv6 для смешанных IPv6/IPv4-адресов с пропущенным первым октетом IPv4-части (например, `::.1.2.3`). [#45871](https://github.com/ClickHouse/ClickHouse/pull/45871) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Добавлен столбец `query_kind` в таблицу `system.processes` и в запрос `SHOW PROCESSLIST`. Удалён дублирующийся код. Исправлена ошибка, из-за которой глобальный параметр конфигурации `max_concurrent_select_queries` не применялся к запросам с цепочками `INTERSECT` или `EXCEPT`. [#45872](https://github.com/ClickHouse/ClickHouse/pull/45872) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Устранён сбой в функции `stochasticLinearRegression`. Выявлено с помощью WingFuzz. [#45985](https://github.com/ClickHouse/ClickHouse/pull/45985) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен сбой в запросах `SELECT` с модификаторами `INTERSECT` и `EXCEPT`, которые читают данные из таблиц с включёнными разрежёнными столбцами (их использование определяется настройкой `ratio_of_defaults_for_sparse_serialization`). [#45987](https://github.com/ClickHouse/ClickHouse/pull/45987) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена оптимизация чтения по порядку при сортировке по убыванию (DESC) с FINAL, закрыт [#45815](https://github.com/ClickHouse/ClickHouse/issues/45815). [#46009](https://github.com/ClickHouse/ClickHouse/pull/46009) ([Vladimir C](https://github.com/vdimir)).
* Исправлено чтение несуществующих вложенных столбцов с несколькими уровнями вложенности в compact-частях. [#46045](https://github.com/ClickHouse/ClickHouse/pull/46045) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен столбец elapsed в system.processes (значения отличались в 10 раз). [#46047](https://github.com/ClickHouse/ClickHouse/pull/46047) ([Azat Khuzhin](https://github.com/azat)).
* Последующее исправление для «Replace domain IP types (IPv4, IPv6) with native» [https://github.com/ClickHouse/ClickHouse/pull/43221](https://github.com/ClickHouse/ClickHouse/pull/43221). [#46087](https://github.com/ClickHouse/ClickHouse/pull/46087) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена подстановка переменных окружения в конфигурации, если параметр уже имеет значение. Закрывает [#46131](https://github.com/ClickHouse/ClickHouse/issues/46131). Закрывает [#9547](https://github.com/ClickHouse/ClickHouse/issues/9547). [#46144](https://github.com/ClickHouse/ClickHouse/pull/46144) ([pufit](https://github.com/pufit)).
* Исправлено некорректное проталкивание предикатов (predicate push down) при использовании `GROUPING SETS`. Закрывает [#45947](https://github.com/ClickHouse/ClickHouse/issues/45947). [#46151](https://github.com/ClickHouse/ClickHouse/pull/46151) ([flynn](https://github.com/ucasfl)).
* Исправлена потенциальная ошибка, из-за которой конвейер мог зависать в `fulls_sorting_join` с константными ключами. [#46175](https://github.com/ClickHouse/ClickHouse/pull/46175) ([Vladimir C](https://github.com/vdimir)).
* Не преобразуйте функции `tuple` в литералы при форматировании, чтобы избежать некорректных результатов. [#46232](https://github.com/ClickHouse/ClickHouse/pull/46232) ([Salvatore Mesoraca](https://github.com/aiven-sal)).
* Исправлена возможная ошибка выхода за пределы при чтении LowCardinality(Nullable) в формате Arrow. [#46270](https://github.com/ClickHouse/ClickHouse/pull/46270) ([Kruglov Pavel](https://github.com/Avogar)).
* Устранена проблема, из-за которой запросы `SYSTEM UNFREEZE` завершались с исключением `CANNOT_PARSE_INPUT_ASSERTION_FAILED`. [#46325](https://github.com/ClickHouse/ClickHouse/pull/46325) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Исправлен возможный сбой, который мог быть вызван переполнением целочисленного значения при десериализации агрегатного состояния функции, хранящей HashTable. [#46349](https://github.com/ClickHouse/ClickHouse/pull/46349) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена возможная ошибка `LOGICAL_ERROR` при асинхронных вставках некорректных данных в формате `VALUES`. [#46350](https://github.com/ClickHouse/ClickHouse/pull/46350) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка LOGICAL&#95;ERROR при попытке выполнить `ALTER ... MOVE PART ... TO TABLE`. Такой тип запроса никогда фактически не поддерживался. [#46359](https://github.com/ClickHouse/ClickHouse/pull/46359) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлено определение схемы s3Cluster при параллельной распределённой операции INSERT SELECT, когда включён `parallel_distributed_insert_select`. [#46381](https://github.com/ClickHouse/ClickHouse/pull/46381) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена обработка запросов вида `ALTER TABLE ... UPDATE nested.arr1 = nested.arr2 ...`, где `arr1` и `arr2` являются полями одного и того же столбца типа `Nested`. [#46387](https://github.com/ClickHouse/ClickHouse/pull/46387) ([Anton Popov](https://github.com/CurtizJ)).
* Планировщик может не суметь запланировать задачу. Если это произошло, вся операция MulityPartUpload должна быть отменена, а `UploadHelper` должен дождаться завершения уже запланированных задач. [#46451](https://github.com/ClickHouse/ClickHouse/pull/46451) ([Dmitry Novik](https://github.com/novikd)).
* Исправлен `PREWHERE` для `Merge` с разными типами по умолчанию (исправлены некоторые ошибки `NOT_FOUND_COLUMN_IN_BLOCK`, возникающие, когда тип по умолчанию для столбца отличается; также `PREWHERE` разрешён, когда тип столбца одинаков во всех таблицах, и запрещён, только если он отличается). [#46454](https://github.com/ClickHouse/ClickHouse/pull/46454) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен сбой, который мог возникать при использовании константных значений в `ORDER BY`. Исправление для [#46466](https://github.com/ClickHouse/ClickHouse/issues/46466). [#46493](https://github.com/ClickHouse/ClickHouse/pull/46493) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Не выбрасывать исключение, если на уровне запроса была указана настройка `disk`, но в секции настроек MergeTree в конфигурации была задана настройка `storage_policy`. Настройка `disk` переопределяет значение из конфигурации. [#46533](https://github.com/ClickHouse/ClickHouse/pull/46533) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена некорректная обработка константного аргумента типа `LowCardinality` в функции `arrayMap`. Этот баг мог приводить к сбою с ошибкой сегментации (segfault) в релизной сборке и логической ошибке `Bad cast` в отладочной сборке. [#46569](https://github.com/ClickHouse/ClickHouse/pull/46569) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправляет [#46557](https://github.com/ClickHouse/ClickHouse/issues/46557). [#46611](https://github.com/ClickHouse/ClickHouse/pull/46611) ([Alexander Gololobov](https://github.com/davenger)).
* Исправлены бесконечные перезапуски юнита systemd clickhouse-server, если сервер не успевает запуститься в течение 1 мин 30 сек (отключена логика тайм-аута при запуске clickhouse-server как службы systemd). [#46613](https://github.com/ClickHouse/ClickHouse/pull/46613) ([Azat Khuzhin](https://github.com/azat)).
* Буферы памяти, выделенные во время асинхронных вставок, освобождались в глобальном контексте, и счётчики MemoryTracker для соответствующего пользователя и запроса обновлялись некорректно. Это приводило к ложным срабатываниям исключений OOM. [#46622](https://github.com/ClickHouse/ClickHouse/pull/46622) ([Dmitry Novik](https://github.com/novikd)).
* Обновлено так, чтобы не очищать on&#95;expression из table&#95;join, так как он используется последующими запусками analyze, что решает [#45185](https://github.com/ClickHouse/ClickHouse/issues/45185). [#46487](https://github.com/ClickHouse/ClickHouse/pull/46487) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).

### <a id="231"></a> Релиз ClickHouse 23.1, 2023-01-26 {#231}

### Релиз ClickHouse 23.1 {#clickhouse-release-231}

#### Примечания к обновлению {#upgrade-notes-2}
* Запрос `SYSTEM RESTART DISK` становится операцией, не выполняющей никаких действий (no-op). [#44647](https://github.com/ClickHouse/ClickHouse/pull/44647) ([alesapin](https://github.com/alesapin)).
* Опция `PREALLOCATE` для словарей `HASHED`/`SPARSE_HASHED` становится операцией без эффекта (no-op). [#45388](https://github.com/ClickHouse/ClickHouse/pull/45388) ([Azat Khuzhin](https://github.com/azat)). Она больше не дает существенных преимуществ.
* Кодек `Gorilla` запрещен для столбцов типов, отличных от Float32 или Float64. [#45252](https://github.com/ClickHouse/ClickHouse/pull/45252) ([Robert Schulze](https://github.com/rschu1ze)). Его использование было бессмысленным и приводило к неконсистентности.
* Параллельные вставки с кворумом могут работать некорректно с таблицами `*MergeTree`, созданными с использованием устаревшего синтаксиса. Поэтому поддержка параллельных вставок с кворумом полностью отключена для таких таблиц. Это не затрагивает таблицы, созданные с использованием нового синтаксиса. [#45430](https://github.com/ClickHouse/ClickHouse/pull/45430) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Вместо запроса `HeadObject` используется запрос `GetObjectAttributes` для получения размера объекта в AWS S3. Это изменение, в частности, исправляет обработку конечных точек без явного указания региона после обновления AWS SDK. [#45288](https://github.com/ClickHouse/ClickHouse/pull/45288) ([Vitaly Baranov](https://github.com/vitlibar)). AWS S3 и Minio протестированы, но имейте в виду, что различные S3-совместимые сервисы (GCS, R2, B2) могут иметь тонкие несовместимости. Это изменение также может потребовать от вас настроить ACL так, чтобы разрешить запрос `GetObjectAttributes`.
* Пути в названиях часовых поясов запрещены. Например, имя часового пояса `/usr/share/zoneinfo/Asia/Aden` не допускается; следует использовать имя из базы часовых поясов IANA, например `Asia/Aden`. [#44225](https://github.com/ClickHouse/ClickHouse/pull/44225) ([Kruglov Pavel](https://github.com/Avogar)).
* Запросы, сочетающие equijoin и константные выражения (например, `JOIN ON t1.x = t2.x AND 1 = 1`), запрещены из-за некорректных результатов. [#44016](https://github.com/ClickHouse/ClickHouse/pull/44016) ([Vladimir C](https://github.com/vdimir)).

#### Новая возможность {#new-feature-11}

* Источник словаря для извлечения ключей при обходе дерева регулярных выражений. Может использоваться для парсинга User-Agent. [#40878](https://github.com/ClickHouse/ClickHouse/pull/40878) ([Vage Ogannisian](https://github.com/nooblose)). [#43858](https://github.com/ClickHouse/ClickHouse/pull/43858) ([Han Fei](https://github.com/hanfei1991)).
* Добавлена поддержка параметризованных представлений, теперь можно указывать параметры запроса для табличного движка View. Исправляет [#40907](https://github.com/ClickHouse/ClickHouse/issues/40907). [#41687](https://github.com/ClickHouse/ClickHouse/pull/41687) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Добавлены функции `quantileInterpolatedWeighted`/`quantilesInterpolatedWeighted`. [#38252](https://github.com/ClickHouse/ClickHouse/pull/38252) ([Bharat Nallan](https://github.com/bharatnc)).
* Поддержка `ARRAY JOIN` для типа `Map`, аналогичная функции «explode» в Spark. [#43239](https://github.com/ClickHouse/ClickHouse/pull/43239) ([李扬](https://github.com/taiyang-li)).
* Поддержка двоичных и шестнадцатеричных строковых литералов стандарта SQL. [#43785](https://github.com/ClickHouse/ClickHouse/pull/43785) ([Mo Xuan](https://github.com/mo-avatar)).
* Добавлена поддержка форматирования `DateTime` в стиле Joda-Time. См. [документацию Joda-Time](https://joda-time.sourceforge.net/apidocs/org/joda/time/format/DateTimeFormat.html). [#43818](https://github.com/ClickHouse/ClickHouse/pull/43818) ([李扬](https://github.com/taiyang-li)).
* Реализована поддержка форматирования долей секунды (`%f`) в `formatDateTime`. [#44060](https://github.com/ClickHouse/ClickHouse/pull/44060) ([ltrk2](https://github.com/ltrk2)). [#44497](https://github.com/ClickHouse/ClickHouse/pull/44497) ([Alexander Gololobov](https://github.com/davenger)).
* Добавлена функция `age` для вычисления разницы между двумя датами или датами со временем в виде количества полных единиц. Закрывает [#41115](https://github.com/ClickHouse/ClickHouse/issues/41115). [#44421](https://github.com/ClickHouse/ClickHouse/pull/44421) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлен источник `Null` для словарей. Закрывает [#44240](https://github.com/ClickHouse/ClickHouse/issues/44240). [#44502](https://github.com/ClickHouse/ClickHouse/pull/44502) ([mayamika](https://github.com/mayamika)).
* Добавлена возможность настройки класса хранилища S3 с помощью параметра конфигурации `s3_storage_class`, например: `<s3_storage_class>STANDARD/INTELLIGENT_TIERING</s3_storage_class>`. Закрывает [#44443](https://github.com/ClickHouse/ClickHouse/issues/44443). [#44707](https://github.com/ClickHouse/ClickHouse/pull/44707) ([chen](https://github.com/xiedeyantu)).
* При разборе именованных кортежей вставлять значения по умолчанию при отсутствии элементов в JSON-объекте. Добавлена настройка `input_format_json_defaults_for_missing_elements_in_named_tuple`, которая управляет этим поведением. Закрывает [#45142](https://github.com/ClickHouse/ClickHouse/issues/45142)#issuecomment-1380153217. [#45231](https://github.com/ClickHouse/ClickHouse/pull/45231) ([Kruglov Pavel](https://github.com/Avogar)).
* Записывает время запуска сервера в ProfileEvents (`ServerStartupMilliseconds`). Устраняет [#43188](https://github.com/ClickHouse/ClickHouse/issues/43188). [#45250](https://github.com/ClickHouse/ClickHouse/pull/45250) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Рефакторинг и улучшение стриминговых движков Kafka/RabbitMQ/NATS и добавление поддержки всех форматов, а также частичный рефакторинг самих форматов: - Исправлена генерация сообщений в построчных форматах с суффиксами/префиксами. Теперь каждое сообщение форматируется полностью со всеми разделителями и может быть прочитано обратно с использованием входного формата. - Добавлена поддержка блочных форматов, таких как Native, Parquet, ORC и т. д. Каждый блок форматируется как отдельное сообщение. Количество строк в одном сообщении зависит от размера блока, поэтому вы можете управлять этим через настройку `max_block_size`. - Добавлены новые настройки движков `kafka_max_rows_per_message/rabbitmq_max_rows_per_message/nats_max_rows_per_message`. Они управляют количеством строк, форматируемых в одном сообщении в построчных форматах. Значение по умолчанию: 1. - Исправлено высокое потребление памяти в табличном движке NATS. - Добавлена поддержка произвольных бинарных данных в продюсере NATS (ранее он работал только со строками, содержащими символ \0 в конце). - Добавлены отсутствующие настройки движков Kafka/RabbitMQ/NATS в документацию. - Проведен рефакторинг логики продюсера и консюмера в Kafka/RabbitMQ/NATS, она отделена от семантики WriteBuffers/ReadBuffers. - Рефакторинг выходных форматов: удалены обратные вызовы (callbacks) на каждую строку, использовавшиеся в Kafka/RabbitMQ/NATS (теперь мы не используем там callbacks), разрешено использовать IRowOutputFormat напрямую, уточнены разделители конца строки и разделители между строками, добавлена возможность сбросить выходной формат, чтобы начать форматирование заново. - Добавлена корректная реализация в функцию formatRow (бонус после рефакторинга форматов). [#42777](https://github.com/ClickHouse/ClickHouse/pull/42777) ([Kruglov Pavel](https://github.com/Avogar)).
* Поддержка чтения и записи `Nested`-таблиц как `List` из `Struct` в формате `CapnProto`. Чтение и запись `Decimal32/64` как `Int32/64`. Закрывает [#43319](https://github.com/ClickHouse/ClickHouse/issues/43319). [#43379](https://github.com/ClickHouse/ClickHouse/pull/43379) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлен столбец `message_format_string` в `system.text_log`. В столбце содержится шаблон, который использовался для форматирования сообщения. [#44543](https://github.com/ClickHouse/ClickHouse/pull/44543) ([Alexander Tokmakov](https://github.com/tavplubix)). Это позволяет выполнять различный анализ логов ClickHouse.
* Реализована попытка автоматически определять заголовки с именами столбцов (и, возможно, типами) для форматов ввода CSV/TSV/CustomSeparated.
  Добавлены настройки input&#95;format&#95;tsv/csv/custom&#95;detect&#95;header, которые включают это поведение (по умолчанию включены). Закрывает [#44640](https://github.com/ClickHouse/ClickHouse/issues/44640). [#44953](https://github.com/ClickHouse/ClickHouse/pull/44953) ([Kruglov Pavel](https://github.com/Avogar)).

#### Экспериментальная функция {#experimental-feature-7}
* Добавлен экспериментальный инвертированный индекс как новый тип вторичного индекса для эффективного текстового поиска. [#38667](https://github.com/ClickHouse/ClickHouse/pull/38667) ([larryluogit](https://github.com/larryluogit)).
* Добавлен экспериментальный кэш результатов запросов. [#43797](https://github.com/ClickHouse/ClickHouse/pull/43797) ([Robert Schulze](https://github.com/rschu1ze)).
* Добавлена расширяемая и настраиваемая подсистема планирования для запросов ввода-вывода (пока не интегрирована с самим кодом ввода-вывода). [#41840](https://github.com/ClickHouse/ClickHouse/pull/41840) ([Sergei Trifonov](https://github.com/serxa)). Эта возможность пока ничего не делает — наслаждайтесь.
* Добавлена команда `SYSTEM DROP DATABASE REPLICA`, удаляющая метаданные неработающей (dead) реплики базы данных `Replicated`. Решает проблему [#41794](https://github.com/ClickHouse/ClickHouse/issues/41794). [#42807](https://github.com/ClickHouse/ClickHouse/pull/42807) ([Alexander Tokmakov](https://github.com/tavplubix)).

#### Повышение производительности {#performance-improvement-11}

* Не загружать неактивные части при запуске таблиц `MergeTree`. [#42181](https://github.com/ClickHouse/ClickHouse/pull/42181) ([Anton Popov](https://github.com/CurtizJ)).
* Снижена задержка при чтении из хранилища `S3` и табличной функции `s3` при большом количестве мелких файлов. Теперь настройки `remote_filesystem_read_method` и `remote_filesystem_read_prefetch` применяются при чтении из хранилища `S3`. [#43726](https://github.com/ClickHouse/ClickHouse/pull/43726) ([Anton Popov](https://github.com/CurtizJ)).
* Оптимизация чтения полей структур в файлах Parquet/ORC. Загружаются только необходимые поля. [#44484](https://github.com/ClickHouse/ClickHouse/pull/44484) ([lgbo](https://github.com/lgbo-ustc)).
* Двухуровневый алгоритм агрегации был ошибочно отключён для запросов через HTTP-интерфейс. Его снова включили, что привело к значительному улучшению производительности. [#45450](https://github.com/ClickHouse/ClickHouse/pull/45450) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлена поддержка `mmap` в `StorageFile`, что должно улучшить производительность `clickhouse-local`. [#43927](https://github.com/ClickHouse/ClickHouse/pull/43927) ([pufit](https://github.com/pufit)).
* Добавлена поддержка шардинга в HashedDictionary для параллельной загрузки (обеспечивает почти линейное масштабирование в зависимости от количества шардов). [#40003](https://github.com/ClickHouse/ClickHouse/pull/40003) ([Azat Khuzhin](https://github.com/azat)).
* Ускорен разбор запросов. [#42284](https://github.com/ClickHouse/ClickHouse/pull/42284) ([Raúl Marín](https://github.com/Algunenano)).
* Всегда заменяйте цепочку OR `expr = x1 OR ... OR expr = xN` на `expr IN (x1, ..., xN)` в случае, когда `expr` — это столбец типа `LowCardinality`. В этом случае настройка `optimize_min_equality_disjunction_chain_length` игнорируется. [#42889](https://github.com/ClickHouse/ClickHouse/pull/42889) ([Guo Wangyang](https://github.com/guowangy)).
* Незначительно улучшена производительность за счёт оптимизации кода вокруг ThreadStatus. [#43586](https://github.com/ClickHouse/ClickHouse/pull/43586) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
* Оптимизирована постолбцовая оценка тернарной логики за счёт автовекторизации. В тесте производительности этого [микробенчмарка](https://github.com/ZhiguoZh/ClickHouse/blob/20221123-ternary-logic-opt-example/src/Functions/examples/associative_applier_perf.cpp) мы зафиксировали максимальный **прирост производительности** в **21 раз** на платформе ICX (процессор Intel Xeon Platinum 8380). [#43669](https://github.com/ClickHouse/ClickHouse/pull/43669) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
* По возможности избегайте установки блокировок на чтение в таблице `system.tables`. [#43840](https://github.com/ClickHouse/ClickHouse/pull/43840) ([Raúl Marín](https://github.com/Algunenano)).
* Оптимизация ThreadPool. Эксперименты производительности SSB (Star Schema Benchmark) на платформе ICX (процессор Intel Xeon Platinum 8380, 80 ядер, 160 потоков) показывают, что это изменение позволяет эффективно снизить конкуренцию за мьютекс `ThreadPoolImpl::mutex` на **75%**, увеличить загрузку CPU и улучшить общую производительность на **2,4%**. [#44308](https://github.com/ClickHouse/ClickHouse/pull/44308) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
* Теперь оптимизация прогнозирования размера хеш‑таблицы применяется только если закешированный размер хеш‑таблицы достаточно велик (значения порогов были определены эмпирически и зашиты в коде). [#44455](https://github.com/ClickHouse/ClickHouse/pull/44455) ([Nikita Taranov](https://github.com/nickitat)).
* Небольшое улучшение производительности при асинхронном чтении с удалённых файловых систем. [#44868](https://github.com/ClickHouse/ClickHouse/pull/44868) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлен быстрый путь выполнения для: - `col like '%%'`; - `col like '%'`; - `col not like '%'`; - `col not like '%'`; - `match(col, '.*')`. [#45244](https://github.com/ClickHouse/ClickHouse/pull/45244) ([李扬](https://github.com/taiyang-li)).
* Незначительно улучшена оптимизация типичного случая при фильтрации (в предложении WHERE). [#45289](https://github.com/ClickHouse/ClickHouse/pull/45289) ([Nikita Taranov](https://github.com/nickitat)).
* Предоставить информацию о монотонности функции `toUnixTimestamp64*`, чтобы задействовать больше алгебраических оптимизаций при анализе индексов. [#44116](https://github.com/ClickHouse/ClickHouse/pull/44116) ([Nikita Taranov](https://github.com/nickitat)).
* Разрешена настройка временных данных для обработки запросов (выгрузка на диск) для совместной работы с кэшем файловой системы (занимающим пространство на диске, выделенном под кэш) [#43972](https://github.com/ClickHouse/ClickHouse/pull/43972) ([Vladimir C](https://github.com/vdimir)). Это в основном улучшает [ClickHouse Cloud](https://console.clickhouse.cloud/), но может использоваться и в самоуправляемых развертываниях, если вы знаете, что делаете.
* Теперь таблица `system.replicas` выполняет параллельные запросы статусов реплик. Закрывает [#43918](https://github.com/ClickHouse/ClickHouse/issues/43918). [#43998](https://github.com/ClickHouse/ClickHouse/pull/43998) ([Nikolay Degterinsky](https://github.com/evillique)).
* Оптимизировано потребление памяти во время резервного копирования в S3: файлы теперь копируются в S3 напрямую, без использования `WriteBufferFromS3` (который мог потреблять много памяти). [#45188](https://github.com/ClickHouse/ClickHouse/pull/45188) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлен кэш для идентификаторов асинхронных блоков. Это уменьшит количество запросов к ZooKeeper при включённой дедупликации асинхронных вставок. [#45106](https://github.com/ClickHouse/ClickHouse/pull/45106) ([Han Fei](https://github.com/hanfei1991)).

#### Улучшение {#improvement-11}

* Использовать структуру таблицы, в которую выполняется вставка, в функции generateRandom без аргументов. [#45239](https://github.com/ClickHouse/ClickHouse/pull/45239) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена возможность неявного преобразования чисел с плавающей запятой, хранящихся в строковых полях JSON, в целые числа в функциях `JSONExtract`. Например, `JSONExtract('{"a": "1000.111"}', 'a', 'UInt64')` -&gt; `1000`, ранее возвращалось 0. [#45432](https://github.com/ClickHouse/ClickHouse/pull/45432) ([Anton Popов](https://github.com/CurtizJ)).
* Добавлены поля `supports_parallel_parsing` и `supports_parallel_formatting` в таблицу `system.formats` для улучшения возможностей анализа. [#45499](https://github.com/ClickHouse/ClickHouse/pull/45499) ([Anton Popov](https://github.com/CurtizJ)).
* Улучшено чтение поля CSV в форматах CustomSeparated/Template. Закрывает [#42352](https://github.com/ClickHouse/ClickHouse/issues/42352) Закрывает [#39620](https://github.com/ClickHouse/ClickHouse/issues/39620). [#43332](https://github.com/ClickHouse/ClickHouse/pull/43332) ([Kruglov Pavel](https://github.com/Avogar)).
* Унифицированы измерения времени выполнения запросов. [#43455](https://github.com/ClickHouse/ClickHouse/pull/43455) ([Raúl Marín](https://github.com/Algunenano)).
* Улучшено автоматическое использование структуры из таблицы-вставки в табличных функциях file/hdfs/s3 при наличии виртуальных столбцов в запросе SELECT, что позволяет избежать возможной ошибки «Block structure mismatch» или «number of columns mismatch». [#43695](https://github.com/ClickHouse/ClickHouse/pull/43695) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка знаковых аргументов в функции `range`. Исправлена проблема [#43333](https://github.com/ClickHouse/ClickHouse/issues/43333). [#43733](https://github.com/ClickHouse/ClickHouse/pull/43733) ([sanyu](https://github.com/wineternity)).
* Удаляет избыточную сортировку, например сортировку, связанную с операторами ORDER BY во вложенных запросах. Реализовано на основе плана запроса. Выполняет аналогичную оптимизацию `optimize_duplicate_order_by_and_distinct` для операторов `ORDER BY`, но более универсально, так как применяется к любым избыточным шагам сортировки (не только вызванным оператором ORDER BY) и к подзапросам любой глубины вложенности. Связано с [#42648](https://github.com/ClickHouse/ClickHouse/issues/42648). [#43905](https://github.com/ClickHouse/ClickHouse/pull/43905) ([Igor Nikonov](https://github.com/devcrafter)).
* Добавлена возможность отключать дедупликацию файлов для команды BACKUP (для резервных копий без дедупликации можно использовать ATTACH вместо полного RESTORE). Например, `BACKUP foo TO S3(...) SETTINGS deduplicate_files=0` (по умолчанию `deduplicate_files=1`). [#43947](https://github.com/ClickHouse/ClickHouse/pull/43947) ([Azat Khuzhin](https://github.com/azat)).
* Рефакторинг и улучшение механизма вывода схемы для текстовых форматов. Добавлена новая настройка `schema_inference_make_columns_nullable`, которая управляет приведением результирующих типов к `Nullable` (включена по умолчанию). [#44019](https://github.com/ClickHouse/ClickHouse/pull/44019) ([Kruglov Pavel](https://github.com/Avogar)).
* Улучшена поддержка протокола `PROXYv1`. [#44135](https://github.com/ClickHouse/ClickHouse/pull/44135) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Добавлена информация о последней проверке партиций потоками очистки в таблицу `system.parts`. [#44244](https://github.com/ClickHouse/ClickHouse/pull/44244) ([Dmitry Novik](https://github.com/novikd)).
* Отключены табличные функции для операций вставки в режиме только для чтения. [#44290](https://github.com/ClickHouse/ClickHouse/pull/44290) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Добавлена настройка `simultaneous_parts_removal_limit`, позволяющая ограничить количество частей, обрабатываемых за одну итерацию CleanupThread. [#44461](https://github.com/ClickHouse/ClickHouse/pull/44461) ([Dmitry Novik](https://github.com/novikd)).
* Не инициализируйте ReadBufferFromS3, когда в запросе нужны только виртуальные столбцы. Это может быть полезно для [#44246](https://github.com/ClickHouse/ClickHouse/issues/44246). [#44493](https://github.com/ClickHouse/ClickHouse/pull/44493) ([chen](https://github.com/xiedeyantu)).
* Исключены подсказки с дублирующимися именами столбцов. Закрывает [#44130](https://github.com/ClickHouse/ClickHouse/issues/44130). [#44519](https://github.com/ClickHouse/ClickHouse/pull/44519) ([Joanna Hulboj](https://github.com/jh0x)).
* Разрешена подстановка макросов в endpoint дисков. Исправляет [#40951](https://github.com/ClickHouse/ClickHouse/issues/40951). [#44533](https://github.com/ClickHouse/ClickHouse/pull/44533) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Улучшено определение схемы, когда включен `input_format_json_read_object_as_string`. [#44546](https://github.com/ClickHouse/ClickHouse/pull/44546) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена пользовательская настройка `database_replicated_allow_replicated_engine_arguments`, позволяющая запретить создание таблиц `ReplicatedMergeTree` с аргументами в `DatabaseReplicated`. [#44566](https://github.com/ClickHouse/ClickHouse/pull/44566) ([alesapin](https://github.com/alesapin)).
* Добавлена защита от того, чтобы пользователи по ошибке указывали нулевое (некорректное) значение для `index_granularity`. Это закрывает [#44536](https://github.com/ClickHouse/ClickHouse/issues/44536). [#44578](https://github.com/ClickHouse/ClickHouse/pull/44578) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность указывать путь к служебному keytab-файлу в параметре `keytab` в секции `kerberos` файла config.xml. [#44594](https://github.com/ClickHouse/ClickHouse/pull/44594) ([Roman Vasin](https://github.com/rvasin)).
* Используйте уже набранную часть запроса для нечеткого поиска (передав её в библиотеку `skim`, которая написана на Rust и статически связана с ClickHouse). [#44600](https://github.com/ClickHouse/ClickHouse/pull/44600) ([Azat Khuzhin](https://github.com/azat)).
* По умолчанию включите `input_format_json_read_objects_as_strings`, чтобы можно было читать вложенные JSON-объекты, пока тип JSON Object остается экспериментальным. [#44657](https://github.com/ClickHouse/ClickHouse/pull/44657) ([Kruglov Pavel](https://github.com/Avogar)).
* Улучшена дедупликация асинхронных вставок: при дублирующих асинхронных вставках дедупликация теперь выполняется в памяти до обращения к Keeper. [#44682](https://github.com/ClickHouse/ClickHouse/pull/44682) ([Han Fei](https://github.com/hanfei1991)).
* Формат ввода/вывода `Avro` будет интерпретировать тип bool как тип bool в ClickHouse. [#44684](https://github.com/ClickHouse/ClickHouse/pull/44684) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена поддержка типа Bool в Arrow/Parquet/ORC. Закрывает [#43970](https://github.com/ClickHouse/ClickHouse/issues/43970). [#44698](https://github.com/ClickHouse/ClickHouse/pull/44698) ([Kruglov Pavel](https://github.com/Avogar)).
* Не выполняйте жадный разбор за пределами кавычек при чтении UUID — это может привести к успешному, но ошибочному разбору некорректных данных. [#44686](https://github.com/ClickHouse/ClickHouse/pull/44686) ([Raúl Marín](https://github.com/Algunenano)).
* Выводить UInt64 в случае переполнения Int64 и исправить некоторые преобразования в механизме вывода схемы. [#44696](https://github.com/ClickHouse/ClickHouse/pull/44696) ([Kruglov Pavel](https://github.com/Avogar)).
* Ранее разрешение зависимостей внутри базы данных `Replicated` выполнялось «костыльным» способом, а теперь — корректно, с использованием явного графа. [#44697](https://github.com/ClickHouse/ClickHouse/pull/44697) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена проблема, из-за которой `output_format_pretty_row_numbers` не сохранял значение счётчика между блоками. Закрывает [#44815](https://github.com/ClickHouse/ClickHouse/issues/44815). [#44832](https://github.com/ClickHouse/ClickHouse/pull/44832) ([flynn](https://github.com/ucasfl)).
* Не сообщать об ошибках в `system.errors`, вызванных одновременным слиянием частей с фоновым процессом очистки. [#44874](https://github.com/ClickHouse/ClickHouse/pull/44874) ([Raúl Marín](https://github.com/Algunenano)).
* Оптимизированы и исправлены метрики для Distributed async INSERT. [#44922](https://github.com/ClickHouse/ClickHouse/pull/44922) ([Azat Khuzhin](https://github.com/azat)).
* Добавлены настройки для запрета одновременного выполнения резервного копирования и восстановления, что решает [#43891](https://github.com/ClickHouse/ClickHouse/issues/43891). Реализация: * Добавлены настройки на уровне сервера для запрета одновременного выполнения резервного копирования и восстановления, которые считываются и устанавливаются при создании BackupWorker в Context. * По умолчанию эти настройки имеют значение true. * Перед запуском резервного копирования или восстановления добавлена проверка на выполнение других операций резервного копирования/восстановления. Для внутренних запросов дополнительно проверяется, что запрос поступил с локального узла, с использованием backup&#95;uuid. [#45072](https://github.com/ClickHouse/ClickHouse/pull/45072) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Добавлен конфигурационный параметр `<storage_policy>` для системных логов. [#45320](https://github.com/ClickHouse/ClickHouse/pull/45320) ([Stig Bakken](https://github.com/stigsb)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-11}
* Статически слинкована библиотека `skim` (она написана на Rust) для нечеткого поиска по истории клиента ClickHouse/локальной истории. [#44239](https://github.com/ClickHouse/ClickHouse/pull/44239) ([Azat Khuzhin](https://github.com/azat)).
* Мы удалили поддержку динамического связывания из-за Rust. На самом деле Rust — лишь предлог для этого решения, и мы все равно хотели это убрать. [#44828](https://github.com/ClickHouse/ClickHouse/pull/44828) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Удалена зависимость от утилиты `adduser` из пакетов, потому что мы ее не используем. Это исправляет [#44934](https://github.com/ClickHouse/ClickHouse/issues/44934). [#45011](https://github.com/ClickHouse/ClickHouse/pull/45011) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Библиотека `SQLite` обновлена до последней версии. Она используется для движков интеграции базы данных и таблиц SQLite. Также исправлен ложноположительный отчет TSan. Это закрывает [#45027](https://github.com/ClickHouse/ClickHouse/issues/45027). [#45031](https://github.com/ClickHouse/ClickHouse/pull/45031) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Изменения CRC-32 для устранения проблемы коллизий WeakHash на PowerPC. [#45144](https://github.com/ClickHouse/ClickHouse/pull/45144) ([MeenaRenganathan22](https://github.com/MeenaRenganathan22)).
* Обновлены подмодули aws-c* [#43020](https://github.com/ClickHouse/ClickHouse/pull/43020) ([Vitaly Baranov](https://github.com/vitlibar)).
* Реализовано автоматическое слияние зеленых PR-бэкпортов и зеленых одобренных PR [#41110](https://github.com/ClickHouse/ClickHouse/pull/41110) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* Представлен [веб‑сайт](https://aretestsgreenyet.com/) для отображения статуса ClickHouse CI. [Исходный код](https://github.com/ClickHouse/aretestsgreenyet).

#### Исправление ошибок {#bug-fix}

* Типы IP-адресов домена (IPv4, IPv6) заменены на нативные. [#43221](https://github.com/ClickHouse/ClickHouse/pull/43221) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)). Это автоматически устраняет некоторые пропущенные реализации в коде.
* Исправлен процесс резервного копирования в случае, если мутации принудительно завершаются во время его выполнения. [#45351](https://github.com/ClickHouse/ClickHouse/pull/45351) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлено сообщение об исключении «Invalid number of rows in Chunk». [#41404](https://github.com/ClickHouse/ClickHouse/issues/41404). [#42126](https://github.com/ClickHouse/ClickHouse/pull/42126) ([Alexander Gololobov](https://github.com/davenger)).
* Устранено возможное использование неинициализированного значения после выполнения выражений после сортировки. Закрывает [#43386](https://github.com/ClickHouse/ClickHouse/issues/43386) [#43635](https://github.com/ClickHouse/ClickHouse/pull/43635) ([Kruglov Pavel](https://github.com/Avogar)).
* Улучшена обработка NULL в агрегатных комбинаторах, исправлен возможный сбой (segfault) и логическая ошибка при использовании малоизвестной оптимизации `optimize_rewrite_sum_if_to_count_if`. Закрывает [#43758](https://github.com/ClickHouse/ClickHouse/issues/43758). [#43813](https://github.com/ClickHouse/ClickHouse/pull/43813) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлены ограничения на настройки в запросах CREATE USER/ROLE. [#43993](https://github.com/ClickHouse/ClickHouse/pull/43993) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена ошибка с некорректно разбираемым значением по умолчанию для столбца `EPHEMERAL` в метаданных таблицы. [#44026](https://github.com/ClickHouse/ClickHouse/pull/44026) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлен разбор некорректного значения версии в настройке совместимости. [#44224](https://github.com/ClickHouse/ClickHouse/pull/44224) ([Kruglov Pavel](https://github.com/Avogar)).
* Операция вычитания интервалов из datetime приведена в соответствие с их добавлением. [#44241](https://github.com/ClickHouse/ClickHouse/pull/44241) ([ltrk2](https://github.com/ltrk2)).
* Убрано ограничение на максимальный размер результата представления. [#44261](https://github.com/ClickHouse/ClickHouse/pull/44261) ([lizhuoyu5](https://github.com/lzydmxy)).
* Устранена возможная логическая ошибка в кэше при `do_not_evict_index_and_mrk_files=1`. Закрывает [#42142](https://github.com/ClickHouse/ClickHouse/issues/42142). [#44268](https://github.com/ClickHouse/ClickHouse/pull/44268) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено возможное слишком раннее прерывание записи в кэш в режиме write-through (кэширование могло быть остановлено из-за ошибочного предположения в случаях, когда этого не должно было происходить). [#44289](https://github.com/ClickHouse/ClickHouse/pull/44289) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен возможный сбой при использовании функции `IN` с константными аргументами в качестве константного аргумента совместно с типом `LowCardinality`. Исправлено [#44221](https://github.com/ClickHouse/ClickHouse/issues/44221). [#44346](https://github.com/ClickHouse/ClickHouse/pull/44346) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена поддержка сложных параметров (например, массивов) у параметрических агрегатных функций. Это исправление закрывает [#30975](https://github.com/ClickHouse/ClickHouse/issues/30975). Агрегатная функция `sumMapFiltered` была непригодна для использования в распределённых запросах до этого изменения. [#44358](https://github.com/ClickHouse/ClickHouse/pull/44358) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено чтение ObjectId при выводе схемы BSON. [#44382](https://github.com/ClickHouse/ClickHouse/pull/44382) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена гонка состояний, которая могла приводить к преждевременному удалению временных частей до завершения слияния в ReplicatedMergeTree. Эта проблема могла вызывать ошибки вида `No such file or directory: xxx`. Исправляет [#43983](https://github.com/ClickHouse/ClickHouse/issues/43983). [#44383](https://github.com/ClickHouse/ClickHouse/pull/44383) ([alesapin](https://github.com/alesapin)).
* Некоторые некорректные запросы `SYSTEM ... ON CLUSTER` при отсутствии имени кластера выполнялись неожиданным образом. Это исправлено — теперь такие запросы завершаются с ошибкой синтаксиса `SYNTAX_ERROR`, как и должно быть. Исправляет [#44264](https://github.com/ClickHouse/ClickHouse/issues/44264). [#44387](https://github.com/ClickHouse/ClickHouse/pull/44387) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлено чтение типа Map в формате ORC. [#44400](https://github.com/ClickHouse/ClickHouse/pull/44400) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено чтение столбцов, которых нет во входных данных в форматах Parquet/ORC. Ранее это могло приводить к ошибке `INCORRECT_NUMBER_OF_COLUMNS`. Закрывает [#44333](https://github.com/ClickHouse/ClickHouse/issues/44333). [#44405](https://github.com/ClickHouse/ClickHouse/pull/44405) ([Kruglov Pavel](https://github.com/Avogar)).
* Ранее функция `bar` использовала один и тот же символ &#39;▋&#39; (U+258B &quot;Left five eighths block&quot;) для отображения как 5/8, так и 6/8 части столбика. Это изменение исправляет такое поведение, используя &#39;▊&#39; (U+258A &quot;Left three quarters block&quot;) для отображения 6/8 части столбика. [#44410](https://github.com/ClickHouse/ClickHouse/pull/44410) ([Alexander Gololobov](https://github.com/davenger)).
* Размещение настроек профиля в конфигурационном файле после ограничений профиля делало эти ограничения неэффективными. [#44411](https://github.com/ClickHouse/ClickHouse/pull/44411) ([Konstantin Bogdanov](https://github.com/thevar1able)).
* Исправлена ошибка `SYNTAX_ERROR` при выполнении запросов `EXPLAIN AST INSERT`, содержащих данные. Закрывает [#44207](https://github.com/ClickHouse/ClickHouse/issues/44207). [#44413](https://github.com/ClickHouse/ClickHouse/pull/44413) ([save-my-heart](https://github.com/save-my-heart)).
* Исправлено чтение логических значений в формате CSV при использовании CRLF. Закрывает [#44401](https://github.com/ClickHouse/ClickHouse/issues/44401). [#44442](https://github.com/ClickHouse/ClickHouse/pull/44442) ([Kruglov Pavel](https://github.com/Avogar)).
* Не выполняйте функции and/or/if/multiIf над словарём LowCardinality: тип результата не может быть LowCardinality. В некоторых случаях это могло приводить к ошибке `Illegal column ColumnLowCardinality`. Исправлено [#43603](https://github.com/ClickHouse/ClickHouse/issues/43603). [#44469](https://github.com/ClickHouse/ClickHouse/pull/44469) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлены мутации при использовании настройки `max_streams_for_merge_tree_reading`. [#44472](https://github.com/ClickHouse/ClickHouse/pull/44472) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено потенциальное разыменование нулевого указателя с `GROUPING SETS` в `ASTSelectQuery::formatImpl` ([#43049](https://github.com/ClickHouse/ClickHouse/issues/43049)). [#44479](https://github.com/ClickHouse/ClickHouse/pull/44479) ([Robert Schulze](https://github.com/rschu1ze)).
* Проверять типы в аргументах табличных функций, аргументах функции CAST, а также при выводе схемы JSONAsObject в соответствии с настройками. [#44501](https://github.com/ClickHouse/ClickHouse/pull/44501) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена работа оператора IN с LowCardinality и константным столбцом, закрыта задача [#44503](https://github.com/ClickHouse/ClickHouse/issues/44503). [#44506](https://github.com/ClickHouse/ClickHouse/pull/44506) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлена ошибка в нормализации выражения `DEFAULT` в операторе `CREATE TABLE`. Второй аргумент функции `in` (или правый аргумент оператора `IN`) мог быть заменён результатом его вычисления при выполнении запроса `CREATE TABLE`. Исправляет [#44496](https://github.com/ClickHouse/ClickHouse/issues/44496). [#44547](https://github.com/ClickHouse/ClickHouse/pull/44547) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Проекции не работают при использовании WITH ROLLUP, WITH CUBE и WITH TOTALS. В предыдущих версиях выполнение запроса завершалось исключением вместо того, чтобы просто не использовать проекции. Тем самым закрыты [#44614](https://github.com/ClickHouse/ClickHouse/issues/44614) и [#42772](https://github.com/ClickHouse/ClickHouse/issues/42772). [#44615](https://github.com/ClickHouse/ClickHouse/pull/44615) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Асинхронные блоки не очищались, потому что функция `get all blocks sorted by time` их не возвращала. [#44651](https://github.com/ClickHouse/ClickHouse/pull/44651) ([Han Fei](https://github.com/hanfei1991)).
* Исправлена ошибка `LOGICAL_ERROR` `The top step of the right pipeline should be ExpressionStep` при использовании JOIN с подзапросом, UNION и TOTALS. Исправление для [#43687](https://github.com/ClickHouse/ClickHouse/issues/43687). [#44673](https://github.com/ClickHouse/ClickHouse/pull/44673) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Избежать возникновения исключения `std::out_of_range` в движке таблиц Executable. [#44681](https://github.com/ClickHouse/ClickHouse/pull/44681) ([Kruglov Pavel](https://github.com/Avogar)).
* Не применять `optimize_syntax_fuse_functions` к квантилям в AST, закрывает задачу [#44712](https://github.com/ClickHouse/ClickHouse/issues/44712). [#44713](https://github.com/ClickHouse/ClickHouse/pull/44713) ([Vladimir C](https://github.com/vdimir)).
* Исправлена ошибка с неверным типом данных в таблице Merge и в `PREWHERE`, закрыт [#43324](https://github.com/ClickHouse/ClickHouse/issues/43324). [#44716](https://github.com/ClickHouse/ClickHouse/pull/44716) ([Vladimir C](https://github.com/vdimir)).
* Исправлен возможный сбой при завершении работы (во время уничтожения TraceCollector). Исправляет [#44757](https://github.com/ClickHouse/ClickHouse/issues/44757). [#44758](https://github.com/ClickHouse/ClickHouse/pull/44758) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена возможная аварийная остановка при распределённой обработке запросов. Сбой мог произойти, если запрос с totals или extremes возвращал пустой результат при несоответствии типов в таблицах Distributed и локальной. Исправляет [#44738](https://github.com/ClickHouse/ClickHouse/issues/44738). [#44760](https://github.com/ClickHouse/ClickHouse/pull/44760) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено выполнение `fsync` после выборок (`min_compressed_bytes_to_fsync_after_fetch`) и для маленьких файлов (ttl.txt, columns.txt) при мутациях (`min_rows_to_fsync_after_merge`/`min_compressed_bytes_to_fsync_after_merge`). [#44781](https://github.com/ClickHouse/ClickHouse/pull/44781) ([Azat Khuzhin](https://github.com/azat)).
* Редкая гонка состояний могла возникать при выполнении запросов к таблицам `system.parts` или `system.parts_columns` при одновременном перемещении кусков данных между дисками. Была внесена изменением [#41145](https://github.com/ClickHouse/ClickHouse/issues/41145). Исправлено в [#44809](https://github.com/ClickHouse/ClickHouse/pull/44809) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка `Context has expired`, которая могла возникать при включённой оптимизации проекций. Её можно было воспроизвести для запросов с определёнными функциями, такими как `dictHas/dictGet`, которые используют контекст во время выполнения. Исправляет [#44844](https://github.com/ClickHouse/ClickHouse/issues/44844). [#44850](https://github.com/ClickHouse/ClickHouse/pull/44850) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка `Cannot read all data`, которая могла возникать при чтении словаря `LowCardinality` из удалённой файловой системы. Исправляет [#44709](https://github.com/ClickHouse/ClickHouse/issues/44709). [#44875](https://github.com/ClickHouse/ClickHouse/pull/44875) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Игнорировать ситуации, когда не удаётся прочитать датчики аппаратного мониторинга, и не выводить в логи полное сообщение об исключении. [#44895](https://github.com/ClickHouse/ClickHouse/pull/44895) ([Raúl Marín](https://github.com/Algunenano)).
* Используйте значение `max_delay_to_insert` в случае, если рассчитанное время задержки INSERT превышает значение этой настройки. Связано с [#44902](https://github.com/ClickHouse/ClickHouse/issues/44902). [#44916](https://github.com/ClickHouse/ClickHouse/pull/44916) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлена ошибка `Different order of columns in UNION subquery` для запросов с `UNION`. Исправление для [#44866](https://github.com/ClickHouse/ClickHouse/issues/44866). [#44920](https://github.com/ClickHouse/ClickHouse/pull/44920) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Задержка для операций INSERT может вычисляться некорректно, в результате всегда может использоваться параметр `max_delay_to_insert` в качестве задержки вместо правильного значения. Следует использовать простую формулу `max_delay_to_insert * (parts_over_threshold/max_allowed_parts_over_threshold)`, то есть задержка растет пропорционально количеству частей сверх порога. Закрывает [#44902](https://github.com/ClickHouse/ClickHouse/issues/44902). [#44954](https://github.com/ClickHouse/ClickHouse/pull/44954) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлена ошибка в ALTER TABLE TTL, возникавшая, когда широкая часть имела маску легковесного удаления. [#44959](https://github.com/ClickHouse/ClickHouse/pull/44959) ([Mingliang Pan](https://github.com/liangliangpan)).
* Последующее исправление к замене типов IP-адресов домена (IPv4, IPv6) на нативные [#43221](https://github.com/ClickHouse/ClickHouse/issues/43221). [#45024](https://github.com/ClickHouse/ClickHouse/pull/45024) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Дополнительное исправление к «Replace domain IP types (IPv4, IPv6) with native» [https://github.com/ClickHouse/ClickHouse/pull/43221](https://github.com/ClickHouse/ClickHouse/pull/43221). [#45043](https://github.com/ClickHouse/ClickHouse/pull/45043) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* В парсере было возможно переполнение буфера. Найдено фаззером. [#45047](https://github.com/ClickHouse/ClickHouse/pull/45047) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена потенциальная ошибка «cannot-read-all-data» в хранилище FileLog. Закрывает [#45051](https://github.com/ClickHouse/ClickHouse/issues/45051), [#38257](https://github.com/ClickHouse/ClickHouse/issues/38257). [#45057](https://github.com/ClickHouse/ClickHouse/pull/45057) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Эффективная по памяти агрегация (параметр `distributed_aggregation_memory_efficient`) отключается, если в запросе используются GROUPING SETS. [#45058](https://github.com/ClickHouse/ClickHouse/pull/45058) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлен словарь `RANGE_HASHED`, чтобы при обновлениях учитывать столбцы диапазона как часть первичного ключа, если указан параметр `update_field`. Закрывает [#44588](https://github.com/ClickHouse/ClickHouse/issues/44588). [#45061](https://github.com/ClickHouse/ClickHouse/pull/45061) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена ошибка `Cannot capture column` для захватываемого аргумента типа `LowCardinality` во вложенной лямбда-функции. Исправляет [#45028](https://github.com/ClickHouse/ClickHouse/issues/45028). [#45065](https://github.com/ClickHouse/ClickHouse/pull/45065) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка, из-за которой при использовании проекции minmax/count запрос с `additional_table_filters` возвращал неверный результат (дополнительный фильтр не применялся). [#45133](https://github.com/ClickHouse/ClickHouse/pull/45133) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка в функции `histogram`, которая принимала отрицательные значения. [#45147](https://github.com/ClickHouse/ClickHouse/pull/45147) ([simpleton](https://github.com/rgzntrade)).
* Исправлена неверная nullability столбца в StorageJoin, закрыт [#44940](https://github.com/ClickHouse/ClickHouse/issues/44940). [#45184](https://github.com/ClickHouse/ClickHouse/pull/45184) ([Vladimir C](https://github.com/vdimir)).
* Исправлена перезагрузка настройки `background_fetches_pool_size` при её увеличении во время работы. [#45189](https://github.com/ClickHouse/ClickHouse/pull/45189) ([Raúl Marín](https://github.com/Algunenano)).
* Корректно обрабатывать запросы `SELECT` к KV-движкам (например, KeeperMap, EmbeddedRocksDB), использующие оператор `IN` по ключу с подзапросом, возвращающим значение другого типа. [#45215](https://github.com/ClickHouse/ClickHouse/pull/45215) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена логическая ошибка в SEMI JOIN и join&#95;use&#95;nulls в ряде случаев, закрыты [#45163](https://github.com/ClickHouse/ClickHouse/issues/45163) и [#45209](https://github.com/ClickHouse/ClickHouse/issues/45209). [#45230](https://github.com/ClickHouse/ClickHouse/pull/45230) ([Vladimir C](https://github.com/vdimir)).
* Исправлена ошибка heap-use-after-free при чтении из S3. [#45253](https://github.com/ClickHouse/ClickHouse/pull/45253) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка, возникавшая, когда тип Avro Union имеет форму [&#39;null&#39;, Nested type], закрывает [#45275](https://github.com/ClickHouse/ClickHouse/issues/45275). Исправлена ошибка, из-за которой тип `bytes` некорректно определялся как `Float`. [#45276](https://github.com/ClickHouse/ClickHouse/pull/45276) ([flynn](https://github.com/ucasfl)).
* Выдавать корректное исключение, если явный PREWHERE нельзя использовать для таблицы с движком хранения `Merge`. [#45319](https://github.com/ClickHouse/ClickHouse/pull/45319) ([Antonio Andelic](https://github.com/antonio2368)).
* Под WSL1 Ubuntu самораспаковывающийся дистрибутив ClickHouse не распаковывается из‑за несоответствия: /proc/self/maps сообщает inode 32‑битного файла, тогда как stat — inode 64‑битного. [#45339](https://github.com/ClickHouse/ClickHouse/pull/45339) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлено состояние гонки при запуске таблицы Distributed (которое могло приводить к многократной обработке файла асинхронной операции INSERT). [#45360](https://github.com/ClickHouse/ClickHouse/pull/45360) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена возможная аварийная остановка при чтении из хранилища `S3` и табличной функции `s3`, если запрос `ListObject` завершался с ошибкой. [#45371](https://github.com/ClickHouse/ClickHouse/pull/45371) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено исключение при выполнении запроса `SELECT ... FROM system.dictionaries`, возникавшее при наличии словаря с некорректной структурой (например, с неверным типом в XML-конфигурации). [#45399](https://github.com/ClickHouse/ClickHouse/pull/45399) ([Aleksei Filatov](https://github.com/aalexfvk)).
* Исправлен вывод схемы для s3Cluster, когда структура берётся из таблицы, в которую выполняется вставка, в запросах `INSERT INTO ... SELECT * FROM s3Cluster`. [#45422](https://github.com/ClickHouse/ClickHouse/pull/45422) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка в разборе форматов JSON/BSONEachRow при использовании HTTP, которая могла приводить к использованию значений по умолчанию для некоторых столбцов вместо значений из данных. [#45424](https://github.com/ClickHouse/ClickHouse/pull/45424) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка (Code: 632. DB::Exception: Unexpected data ... after parsed IPv6 value ...) при типизированном разборе типов IP из текстового источника. [#45425](https://github.com/ClickHouse/ClickHouse/pull/45425) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Закрыт [#45297](https://github.com/ClickHouse/ClickHouse/issues/45297) Добавлена проверка на пустые регулярные выражения. [#45428](https://github.com/ClickHouse/ClickHouse/pull/45428) ([Han Fei](https://github.com/hanfei1991)).
* Исправлено возможное зависание (вероятно распределённого) запроса. [#45448](https://github.com/ClickHouse/ClickHouse/pull/45448) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена возможная взаимоблокировка при включённом `allow_asynchronous_read_from_io_pool_for_merge_tree` в случае возникновения исключения, выбрасываемого из `ThreadPool::schedule`. [#45481](https://github.com/ClickHouse/ClickHouse/pull/45481) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена возможная проблема использования таблицы после DETACH. [#45493](https://github.com/ClickHouse/ClickHouse/pull/45493) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено редкое аварийное завершение работы при отмене запроса, если во время его выполнения использовался параллельный парсинг. [#45498](https://github.com/ClickHouse/ClickHouse/pull/45498) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена гонка между созданием таблицы `Distributed` и выполнением `INSERT` в неё (которая могла приводить к ошибке `CANNOT_LINK` при выполнении `INSERT` в таблицу). [#45502](https://github.com/ClickHouse/ClickHouse/pull/45502) ([Azat Khuzhin](https://github.com/azat)).
* Добавлено корректное значение по умолчанию (SLRU) в геттер политики кэширования. Закрывает [#45514](https://github.com/ClickHouse/ClickHouse/issues/45514). [#45524](https://github.com/ClickHouse/ClickHouse/pull/45524) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Запрещено использование `ARRAY JOIN` в мутациях; исправляет [#42637](https://github.com/ClickHouse/ClickHouse/issues/42637) [#44447](https://github.com/ClickHouse/ClickHouse/pull/44447) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправление обработки квалифицированных звёздочек при использовании псевдонима таблицы и трансформера столбца. Устраняет проблему [#44736](https://github.com/ClickHouse/ClickHouse/issues/44736). [#44755](https://github.com/ClickHouse/ClickHouse/pull/44755) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).



## [Журнал изменений за 2022 год](/whats-new/changelog/2022) {#changelog-for-2022}
