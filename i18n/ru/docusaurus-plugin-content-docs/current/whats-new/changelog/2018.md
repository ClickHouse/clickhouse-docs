---
slug: /whats-new/changelog/2018
sidebar_position: 9
sidebar_label: '2018'
title: 'Журнал изменений за 2018 год'
description: 'Журнал изменений за 2018 год'
doc_type: 'changelog'
keywords: ['ClickHouse 2018', 'changelog 2018', 'release notes', 'version history', 'legacy releases']
---



## Релиз ClickHouse 18.16 {#clickhouse-release-18-16}

### Релиз ClickHouse 18.16.1, 2018-12-21 {#clickhouse-release-18-16-1-2018-12-21}

#### Исправления ошибок: {#bug-fixes}

- Исправлена ошибка, приводившая к проблемам при обновлении словарей с источником ODBC. [#3825](https://github.com/ClickHouse/ClickHouse/issues/3825), [#3829](https://github.com/ClickHouse/ClickHouse/issues/3829)
- JIT-компиляция агрегатных функций теперь работает со столбцами LowCardinality. [#3838](https://github.com/ClickHouse/ClickHouse/issues/3838)

#### Улучшения: {#improvements}

- Добавлена настройка `low_cardinality_allow_in_native_format` (включена по умолчанию). При отключении столбцы LowCardinality преобразуются в обычные столбцы для запросов SELECT, а для запросов INSERT ожидаются обычные столбцы. [#3879](https://github.com/ClickHouse/ClickHouse/pull/3879)

#### Улучшения сборки: {#build-improvements}

- Исправления для сборки на macOS и ARM.

### Релиз ClickHouse 18.16.0, 2018-12-14 {#clickhouse-release-18-16-0-2018-12-14}

#### Новые возможности: {#new-features}


- Выражения `DEFAULT` вычисляются для отсутствующих полей при загрузке данных в полуструктурированных форматах ввода (`JSONEachRow`, `TSKV`). Функция включается с помощью настройки `insert_sample_with_metadata`. [#3555](https://github.com/ClickHouse/ClickHouse/pull/3555)
- Запрос `ALTER TABLE` теперь поддерживает действие `MODIFY ORDER BY` для изменения ключа сортировки при добавлении или удалении столбца таблицы. Это полезно для таблиц семейства `MergeTree`, которые выполняют дополнительные операции при слиянии на основе ключа сортировки, например `SummingMergeTree`, `AggregatingMergeTree` и т.д. [#3581](https://github.com/ClickHouse/ClickHouse/pull/3581) [#3755](https://github.com/ClickHouse/ClickHouse/pull/3755)
- Для таблиц семейства `MergeTree` теперь можно указать различные ключ сортировки (`ORDER BY`) и индекс (`PRIMARY KEY`). Ключ сортировки может быть длиннее индекса. [#3581](https://github.com/ClickHouse/ClickHouse/pull/3581)
- Добавлены табличная функция `hdfs` и движок таблиц `HDFS` для импорта и экспорта данных в HDFS. [chenxing-xc](https://github.com/ClickHouse/ClickHouse/pull/3617)
- Добавлены функции для работы с base64: `base64Encode`, `base64Decode`, `tryBase64Decode`. [Alexander Krasheninnikov](https://github.com/ClickHouse/ClickHouse/pull/3350)
- Теперь можно использовать параметр для настройки точности агрегатной функции `uniqCombined` (выбор количества ячеек HyperLogLog). [#3406](https://github.com/ClickHouse/ClickHouse/pull/3406)
- Добавлена таблица `system.contributors`, содержащая имена всех, кто внёс коммиты в ClickHouse. [#3452](https://github.com/ClickHouse/ClickHouse/pull/3452)
- Добавлена возможность не указывать партицию в запросе `ALTER TABLE ... FREEZE`, чтобы создать резервную копию всех партиций одновременно. [#3514](https://github.com/ClickHouse/ClickHouse/pull/3514)
- Добавлены функции `dictGet` и `dictGetOrDefault`, не требующие указания типа возвращаемого значения. Тип определяется автоматически из описания словаря. [Amos Bird](https://github.com/ClickHouse/ClickHouse/pull/3564)
- Теперь можно указывать комментарии для столбца в описании таблицы и изменять их с помощью `ALTER`. [#3377](https://github.com/ClickHouse/ClickHouse/pull/3377)
- Поддерживается чтение из таблиц типа `Join` с простыми ключами. [Amos Bird](https://github.com/ClickHouse/ClickHouse/pull/3728)
- Теперь можно указывать параметры `join_use_nulls`, `max_rows_in_join`, `max_bytes_in_join` и `join_overflow_mode` при создании таблицы типа `Join`. [Amos Bird](https://github.com/ClickHouse/ClickHouse/pull/3728)
- Добавлена функция `joinGet`, позволяющая использовать таблицу типа `Join` как словарь. [Amos Bird](https://github.com/ClickHouse/ClickHouse/pull/3728)
- Добавлены столбцы `partition_key`, `sorting_key`, `primary_key` и `sampling_key` в таблицу `system.tables` для предоставления информации о ключах таблицы. [#3609](https://github.com/ClickHouse/ClickHouse/pull/3609)
- Добавлены столбцы `is_in_partition_key`, `is_in_sorting_key`, `is_in_primary_key` и `is_in_sampling_key` в таблицу `system.columns`. [#3609](https://github.com/ClickHouse/ClickHouse/pull/3609)
- Добавлены столбцы `min_time` и `max_time` в таблицу `system.parts`. Эти столбцы заполняются, когда ключ партиционирования представляет собой выражение, состоящее из столбцов типа `DateTime`. [Emmanuel Donin de Rosière](https://github.com/ClickHouse/ClickHouse/pull/3800)

#### Исправления ошибок: {#bug-fixes-1}


* Исправления и улучшения производительности для типа данных `LowCardinality`. `GROUP BY` с использованием `LowCardinality(Nullable(...))`. Получение значений `extremes`. Обработка функций высшего порядка. `LEFT ARRAY JOIN`. Распределённый `GROUP BY`. Функции, возвращающие `Array`. Выполнение `ORDER BY`. Запись в таблицы `Distributed` (nicelulu). Обратная совместимость для запросов `INSERT` от старых клиентов, использующих протокол `Native`. Поддержка `LowCardinality` для `JOIN`. Повышена производительность при работе в одном потоке. [#3823](https://github.com/ClickHouse/ClickHouse/pull/3823) [#3803](https://github.com/ClickHouse/ClickHouse/pull/3803) [#3799](https://github.com/ClickHouse/ClickHouse/pull/3799) [#3769](https://github.com/ClickHouse/ClickHouse/pull/3769) [#3744](https://github.com/ClickHouse/ClickHouse/pull/3744) [#3681](https://github.com/ClickHouse/ClickHouse/pull/3681) [#3651](https://github.com/ClickHouse/ClickHouse/pull/3651) [#3649](https://github.com/ClickHouse/ClickHouse/pull/3649) [#3641](https://github.com/ClickHouse/ClickHouse/pull/3641) [#3632](https://github.com/ClickHouse/ClickHouse/pull/3632) [#3568](https://github.com/ClickHouse/ClickHouse/pull/3568) [#3523](https://github.com/ClickHouse/ClickHouse/pull/3523) [#3518](https://github.com/ClickHouse/ClickHouse/pull/3518)
* Исправлено поведение настройки `select_sequential_consistency`. Ранее, когда этот параметр был включён, иногда возвращался неполный результат после начала записи в новый раздел. [#2863](https://github.com/ClickHouse/ClickHouse/pull/2863)
* Базы данных теперь корректно указываются при выполнении DDL-запросов `ON CLUSTER` и `ALTER UPDATE/DELETE`. [#3772](https://github.com/ClickHouse/ClickHouse/pull/3772) [#3460](https://github.com/ClickHouse/ClickHouse/pull/3460)
* Для подзапросов внутри VIEW базы данных теперь корректно указываются. [#3521](https://github.com/ClickHouse/ClickHouse/pull/3521)
* Исправлена ошибка в `PREWHERE` с `FINAL` для `VersionedCollapsingMergeTree`. [7167bfd7](https://github.com/ClickHouse/ClickHouse/commit/7167bfd7b365538f7a91c4307ad77e552ab4e8c1)
* Теперь вы можете использовать `KILL QUERY`, чтобы отменять запросы, которые еще не начали выполняться, так как они ожидают захвата блокировки таблицы. [#3517](https://github.com/ClickHouse/ClickHouse/pull/3517)
* Исправлены вычисления даты и времени в случае перевода часов назад в полночь (это происходит в Иране и происходило в Москве с 1981 по 1983 год). Ранее это приводило к тому, что время сбрасывалось на день раньше, чем требовалось, а также вызывало некорректное форматирование даты и времени в текстовом виде. [#3819](https://github.com/ClickHouse/ClickHouse/pull/3819)
* Исправлены ошибки в некоторых случаях использования `VIEW` и подзапросов без указания базы данных. [Winter Zhang](https://github.com/ClickHouse/ClickHouse/pull/3521)
* Исправлена гонка данных при одновременном чтении из `MATERIALIZED VIEW` и удалении `MATERIALIZED VIEW` из-за отсутствия блокировки внутреннего `MATERIALIZED VIEW`. [#3404](https://github.com/ClickHouse/ClickHouse/pull/3404) [#3694](https://github.com/ClickHouse/ClickHouse/pull/3694)
* Исправлена ошибка `Lock handler cannot be nullptr`. [#3689](https://github.com/ClickHouse/ClickHouse/pull/3689)
* Исправлена обработка запросов при включённой опции `compile_expressions` (по умолчанию она включена). Неретенминированные константные выражения, такие как функция `now`, больше не разворачиваются. [#3457](https://github.com/ClickHouse/ClickHouse/pull/3457)
* Исправлено падение при использовании неконстантного аргумента масштаба в функциях `toDecimal32/64/128`.
* Исправлена ошибка, возникавшая при попытке вставить в формате `Values` массив с элементами `NULL` в столбец типа `Array` без `Nullable` (если `input_format_values_interpret_expressions` = 1). [#3487](https://github.com/ClickHouse/ClickHouse/pull/3487) [#3503](https://github.com/ClickHouse/ClickHouse/pull/3503)
* Исправлен непрерывный лог ошибок в `DDLWorker`, если ZooKeeper недоступен. [8f50c620](https://github.com/ClickHouse/ClickHouse/commit/8f50c620334988b28018213ec0092fe6423847e2)
* Исправлен тип возвращаемого значения для функций `quantile*` с аргументами типов `Date` и `DateTime`. [#3580](https://github.com/ClickHouse/ClickHouse/pull/3580)
* Исправлена обработка предложения `WITH`, если в нем указывается простой псевдоним без выражений. [#3570](https://github.com/ClickHouse/ClickHouse/pull/3570)
* Исправлена обработка запросов с именованными подзапросами и квалифицированными именами столбцов при включённой настройке `enable_optimize_predicate_expression`. [Winter Zhang](https://github.com/ClickHouse/ClickHouse/pull/3588)
* Исправлена ошибка `Attempt to attach to nullptr thread group`, возникавшая при работе с материализованными представлениями. [Marek Vavruša](https://github.com/ClickHouse/ClickHouse/pull/3623)
* Исправлена ошибка, приводившая к сбою при передаче некоторых некорректных аргументов в функцию `arrayReverse`. [73e3a7b6](https://github.com/ClickHouse/ClickHouse/commit/73e3a7b662161d6005e7727d8a711b930386b871)
* Исправлено переполнение буфера в функции `extractURLParameter`. Повышена производительность. Добавлена корректная обработка строк, содержащих нулевые байты. [141e9799](https://github.com/ClickHouse/ClickHouse/commit/141e9799e49201d84ea8e951d1bed4fb6d3dacb5)
* Исправлено переполнение буфера в функциях `lowerUTF8` и `upperUTF8`. Убрана возможность выполнять эти функции для аргументов типа `FixedString`. [#3662](https://github.com/ClickHouse/ClickHouse/pull/3662)
* Исправлена редкая гонка состояний при удалении таблиц `MergeTree`. [#3680](https://github.com/ClickHouse/ClickHouse/pull/3680)
* Исправлена гонка при чтении из таблиц `Buffer` и одновременном выполнении `ALTER` или `DROP` целевых таблиц. [#3719](https://github.com/ClickHouse/ClickHouse/pull/3719)
* Исправлено возникновение ошибки сегментации при превышении лимита `max_temporary_non_const_columns`. [#3788](https://github.com/ClickHouse/ClickHouse/pull/3788)

#### Улучшения: {#improvements-1}


* Сервер не записывает обработанные конфигурационные файлы в каталог `/etc/clickhouse-server/`. Вместо этого он сохраняет их в каталоге `preprocessed_configs` внутри `path`. Это означает, что у пользователя `clickhouse` нет прав на запись в каталог `/etc/clickhouse-server/`, что повышает безопасность. [#2443](https://github.com/ClickHouse/ClickHouse/pull/2443)
* Параметр `min_merge_bytes_to_use_direct_io` по умолчанию имеет значение 10 GiB. Слияние, формирующее крупные части таблиц семейства MergeTree, будет выполняться в режиме `O_DIRECT`, что предотвращает чрезмерное вытеснение страниц из кеша. [#3504](https://github.com/ClickHouse/ClickHouse/pull/3504)
* Ускорен запуск сервера при очень большом числе таблиц. [#3398](https://github.com/ClickHouse/ClickHouse/pull/3398)
* Добавлен пул соединений и HTTP `Keep-Alive` для соединений между репликами. [#3594](https://github.com/ClickHouse/ClickHouse/pull/3594)
* Если синтаксис запроса некорректен, в интерфейсе `HTTP` возвращается код `400 Bad Request` (ранее возвращался `500`). [31bc680a](https://github.com/ClickHouse/ClickHouse/commit/31bc680ac5f4bb1d0360a8ba4696fa84bb47d6ab)
* Параметр `join_default_strictness` по умолчанию имеет значение `ALL` для обеспечения совместимости. [120e2cbe](https://github.com/ClickHouse/ClickHouse/commit/120e2cbe2ff4fbad626c28042d9b28781c805afe)
* Убрана запись в `stderr` из библиотеки `re2` для некорректных или слишком сложных регулярных выражений. [#3723](https://github.com/ClickHouse/ClickHouse/pull/3723)
* Добавлено для движка таблицы `Kafka`: проверка наличия подписок перед началом чтения из Kafka; настройка kafka&#95;max&#95;block&#95;size для таблицы. [Marek Vavruša](https://github.com/ClickHouse/ClickHouse/pull/3396)
* Функции `cityHash64`, `farmHash64`, `metroHash64`, `sipHash64`, `halfMD5`, `murmurHash2_32`, `murmurHash2_64`, `murmurHash3_32` и `murmurHash3_64` теперь поддерживают произвольное количество аргументов, а также аргументы в виде кортежей. [#3451](https://github.com/ClickHouse/ClickHouse/pull/3451) [#3519](https://github.com/ClickHouse/ClickHouse/pull/3519)
* Функция `arrayReverse` теперь работает с массивами любых типов. [73e3a7b6](https://github.com/ClickHouse/ClickHouse/commit/73e3a7b662161d6005e7727d8a711b930386b871)
* Добавлен необязательный параметр — размер слота для функции `timeSlots`. [Kirill Shvakov](https://github.com/ClickHouse/ClickHouse/pull/3724)
* Для `FULL` и `RIGHT JOIN` настройка `max_block_size` применяется к потоку неприсоединённых данных из правой таблицы. [Amos Bird](https://github.com/ClickHouse/ClickHouse/pull/3699)
* Добавлен параметр командной строки `--secure` в `clickhouse-benchmark` и `clickhouse-performance-test` для использования TLS. [#3688](https://github.com/ClickHouse/ClickHouse/pull/3688) [#3690](https://github.com/ClickHouse/ClickHouse/pull/3690)
* Преобразование типов, когда структура таблицы типа `Buffer` не совпадает со структурой целевой таблицы. [Vitaly Baranov](https://github.com/ClickHouse/ClickHouse/pull/3603)
* Добавлена опция `tcp_keep_alive_timeout` для отправки keep-alive пакетов после заданного интервала бездействия. [#3441](https://github.com/ClickHouse/ClickHouse/pull/3441)
* Удалено ненужное заключение в кавычки значений ключа партиционирования в таблице `system.parts`, если он состоит из одного столбца. [#3652](https://github.com/ClickHouse/ClickHouse/pull/3652)
* Функция `modulo` поддерживает типы данных `Date` и `DateTime`. [#3385](https://github.com/ClickHouse/ClickHouse/pull/3385)
* Добавлены синонимы для функций `POWER`, `LN`, `LCASE`, `UCASE`, `REPLACE`, `LOCATE`, `SUBSTR` и `MID`. [#3774](https://github.com/ClickHouse/ClickHouse/pull/3774) [#3763](https://github.com/ClickHouse/ClickHouse/pull/3763) Некоторые имена функций не зависят от регистра для совместимости со стандартом SQL. Добавлен синтаксический сахар `SUBSTRING(expr FROM start FOR length)` для совместимости с SQL. [#3804](https://github.com/ClickHouse/ClickHouse/pull/3804)
* Добавлена возможность блокировать в памяти (`mlock`) страницы, соответствующие исполняемому коду `clickhouse-server`, чтобы предотвратить их вытеснение. Эта функция по умолчанию отключена. [#3553](https://github.com/ClickHouse/ClickHouse/pull/3553)
* Улучшена производительность при чтении с использованием `O_DIRECT` (при включённой опции `min_bytes_to_use_direct_io`). [#3405](https://github.com/ClickHouse/ClickHouse/pull/3405)
* Улучшена производительность функции `dictGet...OrDefault` для константного аргумента ключа и неконстантного аргумента значения по умолчанию. [Amos Bird](https://github.com/ClickHouse/ClickHouse/pull/3563)
* Функция `firstSignificantSubdomain` теперь обрабатывает домены `gov`, `mil` и `edu`. [Igor Hatarist](https://github.com/ClickHouse/ClickHouse/pull/3601) Повышена производительность. [#3628](https://github.com/ClickHouse/ClickHouse/pull/3628)
* Возможность задавать пользовательские переменные окружения для запуска `clickhouse-server` с помощью скрипта `SYS-V init.d` через параметр `CLICKHOUSE_PROGRAM_ENV` в `/etc/default/clickhouse`.
  [Pavlo Bashynskyi](https://github.com/ClickHouse/ClickHouse/pull/3612)
* Исправлен код возврата init-скрипта clickhouse-server. [#3516](https://github.com/ClickHouse/ClickHouse/pull/3516)
* В таблицу `system.metrics` добавлена метрика `VersionInteger`, а в `system.build_options` — строка `VERSION_INTEGER`, содержащая числовое представление версии ClickHouse, например `18016000`. [#3644](https://github.com/ClickHouse/ClickHouse/pull/3644)
* Удалена возможность сравнивать тип `Date` с числом, чтобы избежать потенциальных ошибок вроде `date = 2018-12-17`, когда кавычки вокруг даты по ошибке опускаются. [#3687](https://github.com/ClickHouse/ClickHouse/pull/3687)
* Исправлено поведение функций с сохранением состояния, таких как `rowNumberInAllBlocks`. Ранее они возвращали результат, завышенный на единицу, из-за запуска на этапе анализа запроса. [Amos Bird](https://github.com/ClickHouse/ClickHouse/pull/3729)
* Если файл `force_restore_data` не удаётся удалить, выводится сообщение об ошибке. [Amos Bird](https://github.com/ClickHouse/ClickHouse/pull/3794)

#### Улучшения сборки: {#build-improvements-1}

- Обновлена библиотека `jemalloc`, что исправляет потенциальную утечку памяти. [Amos Bird](https://github.com/ClickHouse/ClickHouse/pull/3557)
- Профилирование с `jemalloc` включено по умолчанию для отладочных сборок. [2cc82f5c](https://github.com/ClickHouse/ClickHouse/commit/2cc82f5cbe266421cd4c1165286c2c47e5ffcb15)
- Добавлена возможность запуска интеграционных тестов при наличии только `Docker` в системе. [#3650](https://github.com/ClickHouse/ClickHouse/pull/3650)
- Добавлен фаззинг-тест выражений в запросах SELECT. [#3442](https://github.com/ClickHouse/ClickHouse/pull/3442)
- Добавлен стресс-тест для коммитов, который выполняет функциональные тесты параллельно и в случайном порядке для выявления большего числа состояний гонки. [#3438](https://github.com/ClickHouse/ClickHouse/pull/3438)
- Улучшен метод запуска clickhouse-server в Docker-образе. [Elghazal Ahmed](https://github.com/ClickHouse/ClickHouse/pull/3663)
- Для Docker-образа добавлена поддержка инициализации баз данных с использованием файлов из директории `/docker-entrypoint-initdb.d`. [Konstantin Lebedev](https://github.com/ClickHouse/ClickHouse/pull/3695)
- Исправления для сборок на ARM. [#3709](https://github.com/ClickHouse/ClickHouse/pull/3709)

#### Обратно несовместимые изменения: {#backward-incompatible-changes}

- Удалена возможность сравнения типа `Date` с числом. Вместо `toDate('2018-12-18') = 17883` необходимо использовать явное преобразование типа `= toDate(17883)` [#3687](https://github.com/ClickHouse/ClickHouse/pull/3687)


## Релиз ClickHouse 18.14 {#clickhouse-release-18-14}

### Релиз ClickHouse 18.14.19, 2018-12-19 {#clickhouse-release-18-14-19-2018-12-19}

#### Исправления ошибок: {#bug-fixes-2}

- Исправлена ошибка, приводившая к проблемам при обновлении словарей с источником ODBC. [#3825](https://github.com/ClickHouse/ClickHouse/issues/3825), [#3829](https://github.com/ClickHouse/ClickHouse/issues/3829)
- Базы данных теперь корректно указываются при выполнении DDL‑запросов `ON CLUSTER`. [#3460](https://github.com/ClickHouse/ClickHouse/pull/3460)
- Исправлена ошибка сегментирования при превышении лимита `max_temporary_non_const_columns`. [#3788](https://github.com/ClickHouse/ClickHouse/pull/3788)

#### Улучшения сборки: {#build-improvements-2}

- Исправления для сборок под ARM.

### Релиз ClickHouse 18.14.18, 2018-12-04 {#clickhouse-release-18-14-18-2018-12-04}

#### Исправления ошибок: {#bug-fixes-3}

- Исправлена ошибка в функции `dictGet...` для словарей типа `range`, если один из аргументов является константой, а другой — нет. [#3751](https://github.com/ClickHouse/ClickHouse/pull/3751)
- Исправлена ошибка, из‑за которой в журнал ядра Linux выводились сообщения `netlink: '...': attribute type 1 has an invalid length`; она проявлялась только на достаточно новых версиях ядра Linux. [#3749](https://github.com/ClickHouse/ClickHouse/pull/3749)
- Исправлена ошибка сегментирования в функции `empty` для аргумента типа `FixedString`. [Daniel, Dao Quang Minh](https://github.com/ClickHouse/ClickHouse/pull/3703)
- Исправлено избыточное выделение памяти при использовании большого значения настройки `max_query_size` (блок памяти размером `max_query_size` байт предварительно выделялся целиком). [#3720](https://github.com/ClickHouse/ClickHouse/pull/3720)

#### Изменения в сборке: {#build-changes}

- Исправлена сборка с библиотеками LLVM/Clang версии 7 из пакетов ОС (эти библиотеки используются для JIT‑компиляции запросов). [#3582](https://github.com/ClickHouse/ClickHouse/pull/3582)

### Релиз ClickHouse 18.14.17, 2018-11-30 {#clickhouse-release-18-14-17-2018-11-30}

#### Исправления ошибок: {#bug-fixes-4}

- Исправлены случаи, когда процесс ODBC‑моста не завершался вместе с основным серверным процессом. [#3642](https://github.com/ClickHouse/ClickHouse/pull/3642)
- Исправлена синхронная вставка в таблицу `Distributed`, если список столбцов отличался от списка столбцов удалённой таблицы. [#3673](https://github.com/ClickHouse/ClickHouse/pull/3673)
- Исправлено редкое состояние гонки, которое могло приводить к сбою при удалении таблицы MergeTree. [#3643](https://github.com/ClickHouse/ClickHouse/pull/3643)
- Исправлена взаимная блокировка запроса в случае, когда создание потока запроса завершается ошибкой `Resource temporarily unavailable`. [#3643](https://github.com/ClickHouse/ClickHouse/pull/3643)
- Исправлен разбор секции `ENGINE` при использовании синтаксиса `CREATE AS table`, когда секция `ENGINE` указывалась перед `AS table` (ошибка приводила к игнорированию указанного движка). [#3692](https://github.com/ClickHouse/ClickHouse/pull/3692)

### Релиз ClickHouse 18.14.15, 2018-11-21 {#clickhouse-release-18-14-15-2018-11-21}

#### Исправления ошибок: {#bug-fixes-5}

- При десериализации столбца типа `Array(String)` завышался размер блока памяти, что приводило к ошибкам «Memory limit exceeded». Проблема появилась в версии 18.12.13. [#3589](https://github.com/ClickHouse/ClickHouse/issues/3589)

### Релиз ClickHouse 18.14.14, 2018-11-20 {#clickhouse-release-18-14-14-2018-11-20}

#### Исправления ошибок: {#bug-fixes-6}


- Исправлены запросы `ON CLUSTER` при настройке кластера как защищённого (флаг `<secure>`). [#3599](https://github.com/ClickHouse/ClickHouse/pull/3599)

#### Изменения сборки: {#build-changes-1}

- Исправлены проблемы (llvm-7 из системы, macOS) [#3582](https://github.com/ClickHouse/ClickHouse/pull/3582)

### Релиз ClickHouse 18.14.13, 2018-11-08 {#clickhouse-release-18-14-13-2018-11-08}

#### Исправления ошибок: {#bug-fixes-7}

- Исправлена ошибка `Block structure mismatch in MergingSorted stream`. [#3162](https://github.com/ClickHouse/ClickHouse/issues/3162)
- Исправлены запросы `ON CLUSTER` в случае, когда в конфигурации кластера были включены защищённые соединения (флаг `<secure>`). [#3465](https://github.com/ClickHouse/ClickHouse/pull/3465)
- Исправлена ошибка в запросах, использующих `SAMPLE`, `PREWHERE` и столбцы-алиасы. [#3543](https://github.com/ClickHouse/ClickHouse/pull/3543)
- Исправлена редкая ошибка `unknown compression method` при включённой настройке `min_bytes_to_use_direct_io`. [3544](https://github.com/ClickHouse/ClickHouse/pull/3544)

#### Улучшения производительности: {#performance-improvements}

- Исправлена регрессия производительности запросов с `GROUP BY` по столбцам типа UInt16 или Date при выполнении на процессорах AMD EPYC. [Igor Lapko](https://github.com/ClickHouse/ClickHouse/pull/3512)
- Исправлена регрессия производительности запросов, обрабатывающих длинные строки. [#3530](https://github.com/ClickHouse/ClickHouse/pull/3530)

#### Улучшения сборки: {#build-improvements-3}

- Улучшения для упрощения сборки Arcadia. [#3475](https://github.com/ClickHouse/ClickHouse/pull/3475), [#3535](https://github.com/ClickHouse/ClickHouse/pull/3535)

### Релиз ClickHouse 18.14.12, 2018-11-02 {#clickhouse-release-18-14-12-2018-11-02}

#### Исправления ошибок: {#bug-fixes-8}

- Исправлено падение при соединении двух безымянных подзапросов. [#3505](https://github.com/ClickHouse/ClickHouse/pull/3505)
- Исправлена генерация некорректных запросов (с пустым условием `WHERE`) при обращении к внешним базам данных. [hotid](https://github.com/ClickHouse/ClickHouse/pull/3477)
- Исправлено использование некорректного значения таймаута в ODBC-словарях. [Marek Vavruša](https://github.com/ClickHouse/ClickHouse/pull/3511)

### Релиз ClickHouse 18.14.11, 2018-10-29 {#clickhouse-release-18-14-11-2018-10-29}

#### Исправления ошибок: {#bug-fixes-9}

- Исправлена ошибка `Block structure mismatch in UNION stream: different number of columns` в запросах с LIMIT. [#2156](https://github.com/ClickHouse/ClickHouse/issues/2156)
- Исправлены ошибки при слиянии данных в таблицах, содержащих массивы внутри структур Nested. [#3397](https://github.com/ClickHouse/ClickHouse/pull/3397)
- Исправлены некорректные результаты запросов при отключённой настройке `merge_tree_uniform_read_distribution` (по умолчанию включена). [#3429](https://github.com/ClickHouse/ClickHouse/pull/3429)
- Исправлена ошибка при вставке данных в распределённую таблицу в формате Native. [#3411](https://github.com/ClickHouse/ClickHouse/issues/3411)

### Релиз ClickHouse 18.14.10, 2018-10-23 {#clickhouse-release-18-14-10-2018-10-23}

- Настройка `compile_expressions` (JIT-компиляция выражений) по умолчанию отключена. [#3410](https://github.com/ClickHouse/ClickHouse/pull/3410)
- Настройка `enable_optimize_predicate_expression` по умолчанию отключена.

### Релиз ClickHouse 18.14.9, 2018-10-16 {#clickhouse-release-18-14-9-2018-10-16}

#### Новые возможности: {#new-features-1}


- Модификатор `WITH CUBE` для `GROUP BY` (также доступен альтернативный синтаксис `GROUP BY CUBE(...)`). [#3172](https://github.com/ClickHouse/ClickHouse/pull/3172)
- Добавлена функция `formatDateTime`. [Alexandr Krasheninnikov](https://github.com/ClickHouse/ClickHouse/pull/2770)
- Добавлены движок таблиц `JDBC` и табличная функция `jdbc` (требуется установка clickhouse-jdbc-bridge). [Alexandr Krasheninnikov](https://github.com/ClickHouse/ClickHouse/pull/3210)
- Добавлены функции для работы с номером недели по стандарту ISO: `toISOWeek`, `toISOYear`, `toStartOfISOYear` и `toDayOfYear`. [#3146](https://github.com/ClickHouse/ClickHouse/pull/3146)
- Теперь можно использовать столбцы типа `Nullable` для таблиц `MySQL` и `ODBC`. [#3362](https://github.com/ClickHouse/ClickHouse/pull/3362)
- Вложенные структуры данных могут быть прочитаны как вложенные объекты в формате `JSONEachRow`. Добавлена настройка `input_format_import_nested_json`. [Veloman Yunkan](https://github.com/ClickHouse/ClickHouse/pull/3144)
- Доступна параллельная обработка для нескольких `MATERIALIZED VIEW` при вставке данных. См. настройку `parallel_view_processing`. [Marek Vavruša](https://github.com/ClickHouse/ClickHouse/pull/3208)
- Добавлен запрос `SYSTEM FLUSH LOGS` (принудительная запись логов в системные таблицы, такие как `query_log`). [#3321](https://github.com/ClickHouse/ClickHouse/pull/3321)
- Теперь можно использовать предопределенные макросы `database` и `table` при объявлении таблиц типа `Replicated`. [#3251](https://github.com/ClickHouse/ClickHouse/pull/3251)
- Добавлена возможность чтения значений типа `Decimal` в инженерной нотации (с указанием степеней десяти). [#3153](https://github.com/ClickHouse/ClickHouse/pull/3153)

#### Экспериментальные возможности: {#experimental-features}

- Оптимизация секции GROUP BY для типов данных `LowCardinality`. [#3138](https://github.com/ClickHouse/ClickHouse/pull/3138)
- Оптимизированное вычисление выражений для типов данных `LowCardinality`. [#3200](https://github.com/ClickHouse/ClickHouse/pull/3200)

#### Улучшения: {#improvements-2}


* Значительно снижено потребление памяти для запросов с `ORDER BY` и `LIMIT`. См. параметр `max_bytes_before_remerge_sort`. [#3205](https://github.com/ClickHouse/ClickHouse/pull/3205)
* При отсутствии указания типа `JOIN` (`LEFT`, `INNER`, ...), по умолчанию используется `INNER JOIN`. [#3147](https://github.com/ClickHouse/ClickHouse/pull/3147)
* Квалифицированные звёздочки корректно работают в запросах с `JOIN`. [Winter Zhang](https://github.com/ClickHouse/ClickHouse/pull/3202)
* Движок таблиц `ODBC` корректно выбирает метод кавычения идентификаторов в SQL-диалекте удалённой базы данных. [Alexandr Krasheninnikov](https://github.com/ClickHouse/ClickHouse/pull/3210)
* Настройка `compile_expressions` (JIT-компиляция выражений) включена по умолчанию.
* Исправлено поведение при одновременном выполнении `DROP DATABASE/TABLE IF EXISTS` и `CREATE DATABASE/TABLE IF NOT EXISTS`. Ранее запрос `CREATE DATABASE ... IF NOT EXISTS` мог возвращать сообщение об ошибке «File ... already exists», а запросы `CREATE TABLE ... IF NOT EXISTS` и `DROP TABLE IF EXISTS` могли возвращать `Table ... is creating or attaching right now`. [#3101](https://github.com/ClickHouse/ClickHouse/pull/3101)
* Выражения LIKE и IN с константной правой частью передаются на удалённый сервер при выполнении запросов к таблицам MySQL или ODBC. [#3182](https://github.com/ClickHouse/ClickHouse/pull/3182)
* Сравнения с константными выражениями в секции WHERE передаются на удалённый сервер при запросах к таблицам MySQL и ODBC. Ранее передавались только сравнения с константами. [#3182](https://github.com/ClickHouse/ClickHouse/pull/3182)
* Корректный расчёт ширины строк в терминале для форматов `Pretty`, в том числе для строк с иероглифами. [Amos Bird](https://github.com/ClickHouse/ClickHouse/pull/3257).
* `ON CLUSTER` можно указывать в запросах `ALTER UPDATE`.
* Улучшена производительность чтения данных в формате `JSONEachRow`. [#3332](https://github.com/ClickHouse/ClickHouse/pull/3332)
* Добавлены синонимы для функций `LENGTH` и `CHARACTER_LENGTH` для обеспечения совместимости. Функция `CONCAT` больше не чувствительна к регистру. [#3306](https://github.com/ClickHouse/ClickHouse/pull/3306)
* Добавлен синоним `TIMESTAMP` для типа `DateTime`. [#3390](https://github.com/ClickHouse/ClickHouse/pull/3390)
* В серверных логах всегда зарезервировано место под query&#95;id, даже если строка лога не относится к запросу. Это упрощает разбор текстовых логов сервера с помощью сторонних инструментов.
* Информация о потреблении памяти запросом записывается в лог, когда оно превышает очередной целый гигабайт. [#3205](https://github.com/ClickHouse/ClickHouse/pull/3205)
* Добавлен режим совместимости на случай, когда клиентская библиотека, использующая протокол Native, по ошибке отправляет меньше столбцов, чем сервер ожидает в запросе INSERT. Такая ситуация могла возникнуть при использовании библиотеки clickhouse-cpp. Ранее это приводило к сбою сервера. [#3171](https://github.com/ClickHouse/ClickHouse/pull/3171)
* В пользовательском выражении WHERE в `clickhouse-copier` теперь можно использовать псевдоним `partition_key` (для дополнительной фильтрации по партиции исходной таблицы). Это полезно, если схема партиционирования во время копирования изменяется, но меняется лишь незначительно. [#3166](https://github.com/ClickHouse/ClickHouse/pull/3166)
* Работа движка `Kafka` была перенесена в пул фоновых потоков, чтобы автоматически снижать скорость чтения данных при высоких нагрузках. [Marek Vavruša](https://github.com/ClickHouse/ClickHouse/pull/3215).
* Поддержка чтения значений типов `Tuple` и `Nested` для структур наподобие `struct` в формате `Cap'n'Proto`. [Marek Vavruša](https://github.com/ClickHouse/ClickHouse/pull/3216)
* Список доменов верхнего уровня для функции `firstSignificantSubdomain` теперь включает домен `biz`. [decaseal](https://github.com/ClickHouse/ClickHouse/pull/3219)
* В конфигурации внешних словарей `null_value` интерпретируется как значение типа данных по умолчанию. [#3330](https://github.com/ClickHouse/ClickHouse/pull/3330)
* Реализована поддержка функций `intDiv` и `intDivOrZero` для `Decimal`. [b48402e8](https://github.com/ClickHouse/ClickHouse/commit/b48402e8712e2b9b151e0eef8193811d433a1264)
* Поддержка типов `Date`, `DateTime`, `UUID` и `Decimal` в качестве ключей для агрегатной функции `sumMap`. [#3281](https://github.com/ClickHouse/ClickHouse/pull/3281)
* Поддержка типа данных `Decimal` во внешних словарях. [#3324](https://github.com/ClickHouse/ClickHouse/pull/3324)
* Поддержка типа данных `Decimal` в таблицах `SummingMergeTree`. [#3348](https://github.com/ClickHouse/ClickHouse/pull/3348)
* Добавлены специализации для `UUID` в функции `if`. [#3366](https://github.com/ClickHouse/ClickHouse/pull/3366)
* Уменьшено количество системных вызовов `open` и `close` при чтении из таблицы `MergeTree`. [#3283](https://github.com/ClickHouse/ClickHouse/pull/3283)
* Запрос `TRUNCATE TABLE` можно выполнять на любой реплике (запрос передаётся на ведущую реплику). [Kirill Shvakov](https://github.com/ClickHouse/ClickHouse/pull/3375)

#### Исправления ошибок: {#bug-fixes-10}


* Исправлена ошибка с таблицами `Dictionary` для словарей `range_hashed`. Эта ошибка возникала в версии 18.12.17. [#1702](https://github.com/ClickHouse/ClickHouse/pull/1702)
* Исправлена ошибка при загрузке словарей `range_hashed` (сообщение `Unsupported type Nullable (...)`). Эта ошибка проявлялась в версии 18.12.17. [#3362](https://github.com/ClickHouse/ClickHouse/pull/3362)
* Исправлены ошибки в функции `pointInPolygon`, вызванные накоплением погрешностей вычислений для многоугольников с большим количеством вершин, расположенных близко друг к другу. [#3331](https://github.com/ClickHouse/ClickHouse/pull/3331) [#3341](https://github.com/ClickHouse/ClickHouse/pull/3341)
* Если после слияния кусков данных контрольная сумма результирующего куска отличается от результата того же слияния на другой реплике, результат слияния удаляется, а кусок данных скачивается с другой реплики (это корректное поведение). Но после скачивания кусок данных не удавалось добавить в рабочий набор из‑за ошибки о том, что такой кусок уже существует (потому что кусок данных был удалён с некоторой задержкой после слияния). Это приводило к циклическим попыткам скачивания одних и тех же данных. [#3194](https://github.com/ClickHouse/ClickHouse/pull/3194)
* Исправлен некорректный расчёт общего потребления памяти запросами (из‑за неверного расчёта настройка `max_memory_usage_for_all_queries` работала неправильно, а метрика `MemoryTracking` имела неверное значение). Эта ошибка появилась в версии 18.12.13. [Marek Vavruša](https://github.com/ClickHouse/ClickHouse/pull/3344)
* Исправлена работа `CREATE TABLE ... ON CLUSTER ... AS SELECT ...`. Ошибка проявлялась в версии 18.12.13. [#3247](https://github.com/ClickHouse/ClickHouse/pull/3247)
* Исправлена ненужная подготовка структур данных для `JOIN` на сервере, инициирующем запрос, если `JOIN` выполняется только на удалённых серверах. [#3340](https://github.com/ClickHouse/ClickHouse/pull/3340)
* Исправлены ошибки в движке `Kafka`: взаимоблокировки после возникновения исключений при начале чтения данных и блокировки при завершении работы [Marek Vavruša](https://github.com/ClickHouse/ClickHouse/pull/3215).
* Для таблиц `Kafka` не передавался необязательный параметр `schema` (схема формата `Cap'n'Proto`). [Vojtech Splichal](https://github.com/ClickHouse/ClickHouse/pull/3150)
* Если в ансамбле серверов ZooKeeper есть серверы, которые принимают подключение, но затем сразу же закрывают его вместо ответа на handshake, ClickHouse выбирает другой сервер для подключения. Ранее это приводило к ошибке `Cannot read all data. Bytes read: 0. Bytes expected: 4.` и сервер не мог запуститься. [8218cf3a](https://github.com/ClickHouse/ClickHouse/commit/8218cf3a5f39a43401953769d6d12a0bb8d29da9)
* Если в ансамбле серверов ZooKeeper есть серверы, для которых DNS‑запрос возвращает ошибку, такие серверы игнорируются. [17b8e209](https://github.com/ClickHouse/ClickHouse/commit/17b8e209221061325ad7ba0539f03c6e65f87f29)
* Исправлено преобразование типов между `Date` и `DateTime` при вставке данных в формате `VALUES` (если `input_format_values_interpret_expressions = 1`). Ранее преобразование выполнялось между числовым значением количества дней c начала эпохи Unix и Unix‑меткой времени, что приводило к неожиданным результатам. [#3229](https://github.com/ClickHouse/ClickHouse/pull/3229)
* Исправлено преобразование типов между `Decimal` и целочисленными значениями. [#3211](https://github.com/ClickHouse/ClickHouse/pull/3211)
* Исправлены ошибки в параметре `enable_optimize_predicate_expression`. [Winter Zhang](https://github.com/ClickHouse/ClickHouse/pull/3231)
* Исправлена ошибка разбора формата CSV с числами с плавающей запятой при использовании нестандартного разделителя, например `;` [#3155](https://github.com/ClickHouse/ClickHouse/pull/3155)
* Исправлена функция `arrayCumSumNonNegative` (она не накапливает отрицательные значения, если накопленная сумма меньше нуля). [Aleksey Studnev](https://github.com/ClickHouse/ClickHouse/pull/3163)
* Исправлена работа таблиц `Merge` поверх таблиц `Distributed` при использовании `PREWHERE`. [#3165](https://github.com/ClickHouse/ClickHouse/pull/3165)
* Исправлены ошибки в запросе `ALTER UPDATE`.
* Исправлены ошибки в табличной функции `odbc`, появившиеся в версии 18.12. [#3197](https://github.com/ClickHouse/ClickHouse/pull/3197)
* Исправлена работа агрегатных функций с комбинаторами `StateArray`. [#3188](https://github.com/ClickHouse/ClickHouse/pull/3188)
* Исправлена ошибка, приводившая к сбою при делении значения типа `Decimal` на ноль. [69dd6609](https://github.com/ClickHouse/ClickHouse/commit/69dd6609193beb4e7acd3e6ad216eca0ccfb8179)
* Исправлен вывод типов для операций с аргументами `Decimal` и целочисленных типов. [#3224](https://github.com/ClickHouse/ClickHouse/pull/3224)
* Исправлено падение с `segfault` при выполнении `GROUP BY` над `Decimal128`. [3359ba06](https://github.com/ClickHouse/ClickHouse/commit/3359ba06c39fcd05bfdb87d6c64154819621e13a)
* Настройка `log_query_threads` (логирование информации о каждом потоке выполнения запроса) теперь действует только в том случае, если параметр `log_queries` (логирование информации о запросах) установлен в 1. Поскольку параметр `log_query_threads` по умолчанию включён, ранее информация о потоках логировалась даже при отключённом логировании запросов. [#3241](https://github.com/ClickHouse/ClickHouse/pull/3241)
* Исправлена ошибка в распределённой работе агрегатной функции quantiles (сообщение об ошибке `Not found column quantile...`). [292a8855](https://github.com/ClickHouse/ClickHouse/commit/292a885533b8e3b41ce8993867069d14cbd5a664)
* Исправлена проблема совместимости при одновременной работе в кластере с серверами версии 18.12.17 и более старыми серверами. Для распределённых запросов с ключами GROUP BY как фиксированной, так и переменной длины, если объём агрегируемых данных был большим, возвращаемые данные не всегда были полностью агрегированы (две разные строки содержали одинаковые ключи агрегации). [#3254](https://github.com/ClickHouse/ClickHouse/pull/3254)
* Исправлена обработка подстановок в `clickhouse-performance-test` в случае, когда запрос содержит только часть подстановок, объявленных в тесте. [#3263](https://github.com/ClickHouse/ClickHouse/pull/3263)
* Исправлена ошибка при использовании `FINAL` вместе с `PREWHERE`. [#3298](https://github.com/ClickHouse/ClickHouse/pull/3298)
* Исправлена ошибка при использовании `PREWHERE` для столбцов, добавленных с помощью `ALTER`. [#3298](https://github.com/ClickHouse/ClickHouse/pull/3298)
* Добавлена проверка, запрещающая использование `arrayJoin` в выражениях `DEFAULT` и `MATERIALIZED`. Ранее `arrayJoin` приводил к ошибке при вставке данных. [#3337](https://github.com/ClickHouse/ClickHouse/pull/3337)
* Добавлена проверка на отсутствие `arrayJoin` в секции `PREWHERE`. Ранее это приводило к сообщениям вида `Size ... does not match` или `Unknown compression method` при выполнении запросов. [#3357](https://github.com/ClickHouse/ClickHouse/pull/3357)
* Исправлена ошибка сегментации, которая в редких случаях могла возникать после оптимизации, заменяющей цепочки AND из сравнений на равенство соответствующим выражением IN. [liuyimin-bytedance](https://github.com/ClickHouse/ClickHouse/pull/3339)
* Незначительные исправления в `clickhouse-benchmark`: ранее информация о клиенте не отправлялась на сервер; теперь количество выполненных запросов при завершении работы и при ограничении числа итераций определяется более точно. [#3351](https://github.com/ClickHouse/ClickHouse/pull/3351) [#3352](https://github.com/ClickHouse/ClickHouse/pull/3352)

#### Обратно несовместимые изменения: {#backward-incompatible-changes-1}

- Удалена настройка `allow_experimental_decimal_type`. Тип данных `Decimal` доступен для использования по умолчанию. [#3329](https://github.com/ClickHouse/ClickHouse/pull/3329)


## Релиз ClickHouse 18.12 {#clickhouse-release-18-12}

### Релиз ClickHouse 18.12.17, 2018-09-16 {#clickhouse-release-18-12-17-2018-09-16}

#### Новые возможности: {#new-features-2}

- Для источника `clickhouse` реализован параметр `invalidate_query` (возможность указать запрос для проверки необходимости обновления внешнего словаря). [#3126](https://github.com/ClickHouse/ClickHouse/pull/3126)
- Добавлена возможность использовать типы данных `UInt*`, `Int*` и `DateTime` (наряду с типом `Date`) в качестве ключа внешнего словаря `range_hashed`, определяющего границы диапазонов. Теперь `NULL` можно использовать для обозначения открытого диапазона. [Vasily Nemkov](https://github.com/ClickHouse/ClickHouse/pull/3123)
- Тип `Decimal` теперь поддерживает агрегатные функции `var*` и `stddev*`. [#3129](https://github.com/ClickHouse/ClickHouse/pull/3129)
- Тип `Decimal` теперь поддерживает математические функции (`exp`, `sin` и т. д.) [#3129](https://github.com/ClickHouse/ClickHouse/pull/3129)
- Таблица `system.part_log` теперь содержит столбец `partition_id`. [#3089](https://github.com/ClickHouse/ClickHouse/pull/3089)

#### Исправления ошибок: {#bug-fixes-11}

- `Merge` теперь корректно работает с таблицами `Distributed`. [Winter Zhang](https://github.com/ClickHouse/ClickHouse/pull/3159)
- Исправлена несовместимость (ненужная зависимость от версии `glibc`), из-за которой было невозможно запустить ClickHouse на `Ubuntu Precise` и более старых версиях. Несовместимость возникла в версии 18.12.13. [#3130](https://github.com/ClickHouse/ClickHouse/pull/3130)
- Исправлены ошибки в настройке `enable_optimize_predicate_expression`. [Winter Zhang](https://github.com/ClickHouse/ClickHouse/pull/3107)
- Исправлена незначительная проблема с обратной совместимостью, которая возникала при работе с кластером реплик на версиях ранее 18.12.13 и одновременном создании новой реплики таблицы на сервере с более новой версией (отображалась в сообщении `Can not clone replica, because the ... updated to new ClickHouse version`, что логично, но не должно происходить). [#3122](https://github.com/ClickHouse/ClickHouse/pull/3122)

#### Обратно несовместимые изменения: {#backward-incompatible-changes-2}

- Опция `enable_optimize_predicate_expression` включена по умолчанию (что довольно оптимистично). Если возникают ошибки анализа запросов, связанные с поиском имен столбцов, установите `enable_optimize_predicate_expression` в 0. [Winter Zhang](https://github.com/ClickHouse/ClickHouse/pull/3107)

### Релиз ClickHouse 18.12.14, 2018-09-13 {#clickhouse-release-18-12-14-2018-09-13}

#### Новые возможности: {#new-features-3}

- Добавлена поддержка запросов `ALTER UPDATE`. [#3035](https://github.com/ClickHouse/ClickHouse/pull/3035)
- Добавлена опция `allow_ddl`, которая ограничивает доступ пользователя к DDL-запросам. [#3104](https://github.com/ClickHouse/ClickHouse/pull/3104)
- Добавлена опция `min_merge_bytes_to_use_direct_io` для движков `MergeTree`, которая позволяет установить пороговое значение для общего размера слияния (при превышении порога файлы частей данных будут обрабатываться с использованием O_DIRECT). [#3117](https://github.com/ClickHouse/ClickHouse/pull/3117)
- Системная таблица `system.merges` теперь содержит столбец `partition_id`. [#3099](https://github.com/ClickHouse/ClickHouse/pull/3099)

#### Улучшения {#improvements-3}

- Если часть данных остается неизменной во время мутации, она не загружается репликами. [#3103](https://github.com/ClickHouse/ClickHouse/pull/3103)
- Доступно автодополнение для имен настроек при работе с `clickhouse-client`. [#3106](https://github.com/ClickHouse/ClickHouse/pull/3106)

#### Исправления ошибок: {#bug-fixes-12}


- Добавлена проверка размеров массивов, являющихся элементами полей типа `Nested`, при вставке. [#3118](https://github.com/ClickHouse/ClickHouse/pull/3118)
- Исправлена ошибка обновления внешних словарей с источником `ODBC` и типом хранилища `hashed`. Эта ошибка появилась в версии 18.12.13.
- Исправлено аварийное завершение при создании временной таблицы из запроса с условием `IN`. [Winter Zhang](https://github.com/ClickHouse/ClickHouse/pull/3098)
- Исправлена ошибка в агрегатных функциях для массивов, которые могут содержать элементы `NULL`. [Winter Zhang](https://github.com/ClickHouse/ClickHouse/pull/3097)

### Релиз ClickHouse 18.12.13, 2018-09-10 {#clickhouse-release-18-12-13-2018-09-10}

#### Новые возможности: {#new-features-4}


* Добавлен тип данных `DECIMAL(digits, scale)` (`Decimal32(scale)`, `Decimal64(scale)`, `Decimal128(scale)`). Чтобы его включить, используйте настройку `allow_experimental_decimal_type`. [#2846](https://github.com/ClickHouse/ClickHouse/pull/2846) [#2970](https://github.com/ClickHouse/ClickHouse/pull/2970) [#3008](https://github.com/ClickHouse/ClickHouse/pull/3008) [#3047](https://github.com/ClickHouse/ClickHouse/pull/3047)
* Новый модификатор `WITH ROLLUP` для `GROUP BY` (альтернативный синтаксис: `GROUP BY ROLLUP(...)`). [#2948](https://github.com/ClickHouse/ClickHouse/pull/2948)
* В запросах с JOIN символ «звёздочка» разворачивается в список столбцов во всех таблицах, в соответствии со стандартом SQL. Вы можете восстановить прежнее поведение, установив `asterisk_left_columns_only` в 1 на уровне конфигурации пользователя. [Winter Zhang](https://github.com/ClickHouse/ClickHouse/pull/2787)
* Добавлена поддержка JOIN с табличными функциями. [Winter Zhang](https://github.com/ClickHouse/ClickHouse/pull/2907)
* Автодополнение по клавише Tab в clickhouse-client. [Sergey Shcherbin](https://github.com/ClickHouse/ClickHouse/pull/2447)
* Ctrl+C в clickhouse-client очищает уже введённый запрос. [#2877](https://github.com/ClickHouse/ClickHouse/pull/2877)
* Добавлена настройка `join_default_strictness` (допустимые значения: `"`, `'any'`, `'all'`). Она позволяет не указывать `ANY` или `ALL` в `JOIN`. [#2982](https://github.com/ClickHouse/ClickHouse/pull/2982)
* Каждая строка серверного журнала, связанная с обработкой запроса, содержит идентификатор запроса. [#2482](https://github.com/ClickHouse/ClickHouse/pull/2482)
* Теперь вы можете получать журналы выполнения запросов в clickhouse-client (используйте настройку `send_logs_level`). При распределённой обработке запросов журналы каскадно собираются со всех серверов. [#2482](https://github.com/ClickHouse/ClickHouse/pull/2482)
* Таблицы `system.query_log` и `system.processes` (`SHOW PROCESSLIST`) теперь содержат информацию обо всех изменённых настройках при выполнении запроса (вложенная структура данных `Settings`). Добавлена настройка `log_query_settings`. [#2482](https://github.com/ClickHouse/ClickHouse/pull/2482)
* Таблицы `system.query_log` и `system.processes` теперь содержат информацию о количестве потоков, участвующих в выполнении запроса (см. столбец `thread_numbers`). [#2482](https://github.com/ClickHouse/ClickHouse/pull/2482)
* Добавлены счетчики `ProfileEvents`, измеряющие время, затраченное на чтение и запись по сети, чтение и запись на диск, количество сетевых ошибок и время ожидания при ограничении пропускной способности сети. [#2482](https://github.com/ClickHouse/ClickHouse/pull/2482)
* Добавлены счётчики `ProfileEvents`, которые содержат системные метрики из rusage (их можно использовать для получения информации об использовании CPU в пространстве пользователя и ядра, о сбоях страниц и переключениях контекста), а также метрики taskstats (их можно использовать для получения информации о времени ожидания I/O, времени ожидания CPU и объёме прочитанных и записанных данных — как с использованием кэша страниц, так и без него). [#2482](https://github.com/ClickHouse/ClickHouse/pull/2482)
* Счётчики `ProfileEvents` применяются глобально, для каждого запроса, а также для каждого потока его выполнения, что позволяет детально профилировать потребление ресурсов по запросам. [#2482](https://github.com/ClickHouse/ClickHouse/pull/2482)
* Добавлена таблица `system.query_thread_log`, содержащая информацию о каждом потоке выполнения запроса. Добавлена настройка `log_query_threads`. [#2482](https://github.com/ClickHouse/ClickHouse/pull/2482)
* В таблицах `system.metrics` и `system.events` теперь есть встроенная документация. [#3016](https://github.com/ClickHouse/ClickHouse/pull/3016)
* Добавлена функция `arrayEnumerateDense`. [Amos Bird](https://github.com/ClickHouse/ClickHouse/pull/2975)
* Добавлены функции `arrayCumSumNonNegative` и `arrayDifference`. [Aleksey Studnev](https://github.com/ClickHouse/ClickHouse/pull/2942)
* Добавлена агрегатная функция `retention`. [Sundy Li](https://github.com/ClickHouse/ClickHouse/pull/2887)
* Теперь вы можете складывать (объединять) состояния агрегатных функций с помощью оператора сложения и умножать состояния агрегатных функций на неотрицательную константу. [#3062](https://github.com/ClickHouse/ClickHouse/pull/3062) [#3034](https://github.com/ClickHouse/ClickHouse/pull/3034)
* Таблицам семейства MergeTree теперь доступен виртуальный столбец `_partition_id`. [#3089](https://github.com/ClickHouse/ClickHouse/pull/3089)

#### Экспериментальные возможности: {#experimental-features-1}

- Добавлен тип данных `LowCardinality(T)`. Этот тип данных автоматически создаёт локальный словарь значений и позволяет обрабатывать данные без распаковки словаря. [#2830](https://github.com/ClickHouse/ClickHouse/pull/2830)
- Добавлен кеш JIT-скомпилированных функций и счётчик количества использований перед компиляцией. Для JIT-компиляции выражений включите настройку `compile_expressions`. [#2990](https://github.com/ClickHouse/ClickHouse/pull/2990) [#3077](https://github.com/ClickHouse/ClickHouse/pull/3077)

#### Улучшения: {#improvements-4}


* Исправлена проблема с неограниченным ростом журнала репликации при наличии заброшенных реплик. Добавлен эффективный режим восстановления для реплик с большой задержкой.
* Повышена производительность `GROUP BY` с несколькими полями агрегации, когда одно из них имеет строковый тип, а остальные — фиксированной длины.
* Улучшена производительность при использовании `PREWHERE` и при неявной передаче выражений в `PREWHERE`.
* Улучшена производительность парсинга текстовых форматов (`CSV`, `TSV`). [Amos Bird](https://github.com/ClickHouse/ClickHouse/pull/2977) [#2980](https://github.com/ClickHouse/ClickHouse/pull/2980)
* Повышена производительность чтения строк и массивов в бинарных форматах. [Amos Bird](https://github.com/ClickHouse/ClickHouse/pull/2955)
* Повышена производительность и снижено потребление памяти для запросов к `system.tables` и `system.columns`, когда на одном сервере очень большое число таблиц. [#2953](https://github.com/ClickHouse/ClickHouse/pull/2953)
* Исправлена проблема с производительностью при большом потоке запросов, завершающихся ошибкой (функция `_dl_addr` видна в `perf top`, но сервер почти не использует CPU). [#2938](https://github.com/ClickHouse/ClickHouse/pull/2938)
* Условия переносятся во View (когда включен `enable_optimize_predicate_expression`). [Winter Zhang](https://github.com/ClickHouse/ClickHouse/pull/2907)
* Улучшена функциональность для типа данных `UUID`. [#3074](https://github.com/ClickHouse/ClickHouse/pull/3074) [#2985](https://github.com/ClickHouse/ClickHouse/pull/2985)
* Тип данных `UUID` поддерживается в словарях The Alchemist. [#2822](https://github.com/ClickHouse/ClickHouse/pull/2822)
* Функция `visitParamExtractRaw` корректно работает с вложенными структурами. [Winter Zhang](https://github.com/ClickHouse/ClickHouse/pull/2974)
* При включённой настройке `input_format_skip_unknown_fields` поля объекта в формате `JSONEachRow` корректно пропускаются. [BlahGeek](https://github.com/ClickHouse/ClickHouse/pull/2958)
* Для выражения `CASE` с условиями теперь можно опускать `ELSE`, что эквивалентно `ELSE NULL`. [#2920](https://github.com/ClickHouse/ClickHouse/pull/2920)
* Тайм-аут операций теперь можно настраивать при работе с ZooKeeper. [urykhy](https://github.com/ClickHouse/ClickHouse/pull/2971)
* Вы можете задать смещение для `LIMIT n, m` с помощью `LIMIT n OFFSET m`. [#2840](https://github.com/ClickHouse/ClickHouse/pull/2840)
* Вы можете использовать синтаксис `SELECT TOP n` в качестве альтернативы `LIMIT`. [#2840](https://github.com/ClickHouse/ClickHouse/pull/2840)
* Увеличен размер очереди записи в системные таблицы, чтобы ошибка `SystemLog parameter queue is full` возникала реже.
* Агрегатная функция `windowFunnel` теперь поддерживает события, удовлетворяющие нескольким условиям. [Amos Bird](https://github.com/ClickHouse/ClickHouse/pull/2801)
* Дублирующие столбцы могут использоваться в конструкции `USING` для `JOIN`. [#3006](https://github.com/ClickHouse/ClickHouse/pull/3006)
* Форматы `Pretty` теперь имеют ограничение на выравнивание столбцов по ширине. Используйте настройку `output_format_pretty_max_column_pad_width`. Если значение шире этого ограничения, оно по-прежнему будет отображаться целиком, но другие ячейки в таблице не будут чрезмерно широкими. [#3003](https://github.com/ClickHouse/ClickHouse/pull/3003)
* Табличная функция `odbc` теперь позволяет указывать имя базы данных/схемы. [Amos Bird](https://github.com/ClickHouse/ClickHouse/pull/2885)
* Добавлена возможность использовать имя пользователя, заданное в конфигурационном файле `clickhouse-client`. [Vladimir Kozbin](https://github.com/ClickHouse/ClickHouse/pull/2909)
* Счётчик `ZooKeeperExceptions` разделили на три счётчика: `ZooKeeperUserExceptions`, `ZooKeeperHardwareExceptions` и `ZooKeeperOtherExceptions`.
* Запросы `ALTER DELETE` поддерживаются для материализованных представлений.
* Добавлена случайность в периодический запуск потока очистки для таблиц `ReplicatedMergeTree`, чтобы избежать регулярных пиков нагрузки при очень большом количестве таблиц `ReplicatedMergeTree`.
* Поддержка запросов `ATTACH TABLE ... ON CLUSTER`. [#3025](https://github.com/ClickHouse/ClickHouse/pull/3025)

#### Исправления ошибок: {#bug-fixes-13}


* Исправлена проблема с таблицами `Dictionary` (возникало исключение `Size of offsets does not match size of column` или `Unknown compression method`). Эта ошибка появилась в версии 18.10.3. [#2913](https://github.com/ClickHouse/ClickHouse/issues/2913)
* Исправлена ошибка при слиянии таблиц `CollapsingMergeTree`, если одна из частей данных пуста (эти части формируются во время слияния или `ALTER DELETE`, если все данные были удалены) и для слияния использовался алгоритм `vertical`. [#3049](https://github.com/ClickHouse/ClickHouse/pull/3049)
* Исправлена гонка при выполнении `DROP` или `TRUNCATE` для таблиц `Memory` при одновременном `SELECT`, которая могла приводить к сбоям сервера. Эта ошибка появилась в версии 1.1.54388. [#3038](https://github.com/ClickHouse/ClickHouse/pull/3038)
* Исправлена потенциальная потеря данных при вставке в реплицируемые таблицы (`Replicated`) при возникновении ошибки `Session is expired` (потерю данных можно обнаружить по метрике `ReplicatedDataLoss`). Эта ошибка наблюдалась в версии 1.1.54378. [#2939](https://github.com/ClickHouse/ClickHouse/pull/2939) [#2949](https://github.com/ClickHouse/ClickHouse/pull/2949) [#2964](https://github.com/ClickHouse/ClickHouse/pull/2964)
* Исправлен сегфолт, возникавший при выполнении `JOIN ... ON`. [#3000](https://github.com/ClickHouse/ClickHouse/pull/3000)
* Исправлена ошибка при поиске имён столбцов, когда выражение `WHERE` состоит только из квалифицированного имени столбца, например `WHERE table.column`. [#2994](https://github.com/ClickHouse/ClickHouse/pull/2994)
* Исправлена ошибка &quot;Not found column&quot;, возникавшая при выполнении распределённых запросов, если с удалённого сервера запрашивался единственный столбец, являющийся выражением IN с подзапросом. [#3087](https://github.com/ClickHouse/ClickHouse/pull/3087)
* Исправлена ошибка `Block structure mismatch in UNION stream: different number of columns`, возникавшая в распределённых запросах, если один из шардов был локальным, а другой — нет, при срабатывании оптимизации переноса в `PREWHERE`. [#2226](https://github.com/ClickHouse/ClickHouse/pull/2226) [#3037](https://github.com/ClickHouse/ClickHouse/pull/3037) [#3055](https://github.com/ClickHouse/ClickHouse/pull/3055) [#3065](https://github.com/ClickHouse/ClickHouse/pull/3065) [#3073](https://github.com/ClickHouse/ClickHouse/pull/3073) [#3090](https://github.com/ClickHouse/ClickHouse/pull/3090) [#3093](https://github.com/ClickHouse/ClickHouse/pull/3093)
* Исправлена работа функции `pointInPolygon` для некоторых видов невыпуклых многоугольников. [#2910](https://github.com/ClickHouse/ClickHouse/pull/2910)
* Исправлена ошибка неверного результата при сравнении `nan` с целыми числами. [#3024](https://github.com/ClickHouse/ClickHouse/pull/3024)
* Исправлена ошибка в библиотеке `zlib-ng`, которая в редких случаях могла приводить к ошибке сегментации (segfault). [#2854](https://github.com/ClickHouse/ClickHouse/pull/2854)
* Исправлена утечка памяти при вставке в таблицу с колонками типа `AggregateFunction`, если состояние агрегатной функции не является простым (выделяет память отдельно) и один запрос вставки приводит к нескольким небольшим блокам. [#3084](https://github.com/ClickHouse/ClickHouse/pull/3084)
* Исправлена состояние гонки при одновременном создании и удалении одной и той же таблицы `Buffer` или `MergeTree`.
* Исправлена потенциальная ошибка сегфолта при сравнении кортежей, составленных из некоторых нетривиальных типов, например кортежей. [#2989](https://github.com/ClickHouse/ClickHouse/pull/2989)
* Исправлена потенциальная причина возникновения segfault при выполнении некоторых запросов `ON CLUSTER`. [Winter Zhang](https://github.com/ClickHouse/ClickHouse/pull/2960)
* Исправлена ошибка в функции `arrayDistinct` для элементов массивов с типом `Nullable`. [#2845](https://github.com/ClickHouse/ClickHouse/pull/2845) [#2937](https://github.com/ClickHouse/ClickHouse/pull/2937)
* Опция `enable_optimize_predicate_expression` теперь корректно работает и в случаях с `SELECT *`. [Winter Zhang](https://github.com/ClickHouse/ClickHouse/pull/2929)
* Исправлено падение (segfault) при повторной инициализации сессии ZooKeeper. [#2917](https://github.com/ClickHouse/ClickHouse/pull/2917)
* Исправлена возможная блокировка при работе с ZooKeeper.
* Исправлен неверный код для добавления вложенных структур данных в `SummingMergeTree`.
* При выделении памяти для состояний агрегатных функций корректно учитывается выравнивание, что позволяет использовать операции, требующие выравнивания, при реализации этих состояний. [chenxing-xc](https://github.com/ClickHouse/ClickHouse/pull/2808)

#### Исправление безопасности: {#security-fix}

- Безопасное использование источников данных ODBC. Взаимодействие с драйверами ODBC осуществляется через отдельный процесс `clickhouse-odbc-bridge`. Ошибки в сторонних драйверах ODBC больше не приводят к проблемам со стабильностью сервера или уязвимостям. [#2828](https://github.com/ClickHouse/ClickHouse/pull/2828) [#2879](https://github.com/ClickHouse/ClickHouse/pull/2879) [#2886](https://github.com/ClickHouse/ClickHouse/pull/2886) [#2893](https://github.com/ClickHouse/ClickHouse/pull/2893) [#2921](https://github.com/ClickHouse/ClickHouse/pull/2921)
- Исправлена некорректная проверка пути к файлу в табличной функции `catBoostPool`. [#2894](https://github.com/ClickHouse/ClickHouse/pull/2894)
- Содержимое системных таблиц (`tables`, `databases`, `parts`, `columns`, `parts_columns`, `merges`, `mutations`, `replicas` и `replication_queue`) фильтруется в соответствии с настроенными правами доступа пользователя к базам данных (`allow_databases`). [Winter Zhang](https://github.com/ClickHouse/ClickHouse/pull/2856)

#### Обратно несовместимые изменения: {#backward-incompatible-changes-3}

- В запросах с JOIN символ звездочки раскрывается в список столбцов из всех таблиц в соответствии со стандартом SQL. Прежнее поведение можно восстановить, установив параметр `asterisk_left_columns_only` в значение 1 на уровне конфигурации пользователя.

#### Изменения сборки: {#build-changes-2}

- Большинство интеграционных тестов теперь можно запускать для каждого коммита.
- Проверки стиля кода также можно запускать для каждого коммита.
- Реализация `memcpy` выбирается корректно при сборке на CentOS7/Fedora. [Etienne Champetier](https://github.com/ClickHouse/ClickHouse/pull/2912)
- При использовании clang для сборки добавлены некоторые предупреждения из `-Weverything` в дополнение к стандартным `-Wall-Wextra -Werror`. [#2957](https://github.com/ClickHouse/ClickHouse/pull/2957)
- При отладке сборки используется опция отладки `jemalloc`.
- Интерфейс библиотеки для взаимодействия с ZooKeeper объявлен абстрактным. [#2950](https://github.com/ClickHouse/ClickHouse/pull/2950)


## Релиз ClickHouse 18.10 {#clickhouse-release-18-10}

### Релиз ClickHouse 18.10.3, 2018-08-13 {#clickhouse-release-18-10-3-2018-08-13}

#### Новые возможности: {#new-features-5}

- Добавлена возможность использования HTTPS для репликации. [#2760](https://github.com/ClickHouse/ClickHouse/pull/2760)
- Добавлены функции `murmurHash2_64`, `murmurHash3_32`, `murmurHash3_64` и `murmurHash3_128` в дополнение к существующей `murmurHash2_32`. [#2791](https://github.com/ClickHouse/ClickHouse/pull/2791)
- Добавлена поддержка типов Nullable в драйвере ODBC для ClickHouse (формат вывода `ODBCDriver2`). [#2834](https://github.com/ClickHouse/ClickHouse/pull/2834)
- Добавлена поддержка `UUID` в ключевых столбцах.

#### Улучшения: {#improvements-5}

- Кластеры можно удалять без перезапуска сервера при удалении из конфигурационных файлов. [#2777](https://github.com/ClickHouse/ClickHouse/pull/2777)
- Внешние словари можно удалять без перезапуска сервера при удалении из конфигурационных файлов. [#2779](https://github.com/ClickHouse/ClickHouse/pull/2779)
- Добавлена поддержка `SETTINGS` для движка таблиц `Kafka`. [Alexander Marshalov](https://github.com/ClickHouse/ClickHouse/pull/2781)
- Улучшения для типа данных `UUID` (пока не завершены). [#2618](https://github.com/ClickHouse/ClickHouse/pull/2618)
- Добавлена поддержка пустых кусков после слияний в движках `SummingMergeTree`, `CollapsingMergeTree` и `VersionedCollapsingMergeTree`. [#2815](https://github.com/ClickHouse/ClickHouse/pull/2815)
- Старые записи о завершённых мутациях удаляются (`ALTER DELETE`). [#2784](https://github.com/ClickHouse/ClickHouse/pull/2784)
- Добавлена таблица `system.merge_tree_settings`. [Kirill Shvakov](https://github.com/ClickHouse/ClickHouse/pull/2841)
- В таблицу `system.tables` добавлены столбцы зависимостей: `dependencies_database` и `dependencies_table`. [Winter Zhang](https://github.com/ClickHouse/ClickHouse/pull/2851)
- Добавлена опция конфигурации `max_partition_size_to_drop`. [#2782](https://github.com/ClickHouse/ClickHouse/pull/2782)
- Добавлена опция `output_format_json_escape_forward_slashes`. [Alexander Bocharov](https://github.com/ClickHouse/ClickHouse/pull/2812)
- Добавлена настройка `max_fetch_partition_retries_count`. [#2831](https://github.com/ClickHouse/ClickHouse/pull/2831)
- Добавлена настройка `prefer_localhost_replica` для отключения предпочтения локальной реплики и обращения к локальной реплике без межпроцессного взаимодействия. [#2832](https://github.com/ClickHouse/ClickHouse/pull/2832)
- Агрегатная функция `quantileExact` возвращает `nan` при агрегации по пустому набору `Float32` или `Float64`. [Sundy Li](https://github.com/ClickHouse/ClickHouse/pull/2855)

#### Исправления ошибок: {#bug-fixes-14}


- Удалено ненужное экранирование параметров строки подключения для ODBC, из-за которого было невозможно установить соединение. Эта ошибка возникла в версии 18.6.0.
- Исправлена логика обработки команд `REPLACE PARTITION` в очереди репликации. Если для одной и той же партиции существуют две команды `REPLACE`, некорректная логика могла привести к тому, что одна из них оставалась в очереди репликации и не выполнялась. [#2814](https://github.com/ClickHouse/ClickHouse/pull/2814)
- Исправлена ошибка слияния, когда все куски данных были пустыми (куски, сформированные в результате слияния или команды `ALTER DELETE`, если все данные были удалены). Эта ошибка появилась в версии 18.1.0. [#2930](https://github.com/ClickHouse/ClickHouse/pull/2930)
- Исправлена ошибка при конкурентном использовании `Set` или `Join`. [Amos Bird](https://github.com/ClickHouse/ClickHouse/pull/2823)
- Исправлена ошибка `Block structure mismatch in UNION stream: different number of columns`, которая возникала для запросов `UNION ALL` внутри подзапроса, если один из запросов `SELECT` содержал дублирующиеся имена столбцов. [Winter Zhang](https://github.com/ClickHouse/ClickHouse/pull/2094)
- Исправлена утечка памяти при возникновении исключения во время подключения к серверу MySQL.
- Исправлен некорректный код ответа clickhouse-client в случае ошибки запроса.
- Исправлено некорректное поведение материализованных представлений, содержащих DISTINCT. [#2795](https://github.com/ClickHouse/ClickHouse/issues/2795)

#### Обратно несовместимые изменения {#backward-incompatible-changes-4}

- Удалена поддержка запросов CHECK TABLE для распределённых таблиц (Distributed).

#### Изменения сборки: {#build-changes-3}

- Заменён аллокатор памяти: теперь используется `jemalloc` вместо `tcmalloc`. В некоторых сценариях это увеличивает скорость до 20%. Однако есть запросы, которые замедлились до 20%. Потребление памяти снижено примерно на 10% в некоторых сценариях с улучшенной стабильностью. При высококонкурентных нагрузках использование CPU в пользовательском пространстве и в системе показывает лишь незначительное увеличение. [#2773](https://github.com/ClickHouse/ClickHouse/pull/2773)
- Использование libressl из подмодуля. [#1983](https://github.com/ClickHouse/ClickHouse/pull/1983) [#2807](https://github.com/ClickHouse/ClickHouse/pull/2807)
- Использование unixodbc из подмодуля. [#2789](https://github.com/ClickHouse/ClickHouse/pull/2789)
- Использование mariadb-connector-c из подмодуля. [#2785](https://github.com/ClickHouse/ClickHouse/pull/2785)
- Добавлены файлы функциональных тестов в репозиторий, которые зависят от наличия тестовых данных (пока без самих тестовых данных).


## Релиз ClickHouse 18.6 {#clickhouse-release-18-6}

### Релиз ClickHouse 18.6.0, 2018-08-02 {#clickhouse-release-18-6-0-2018-08-02}

#### Новые возможности: {#new-features-6}

- Добавлена поддержка выражений ON для синтаксиса JOIN ON:
  `JOIN ON Expr([table.]column ...) = Expr([table.]column, ...) [AND Expr([table.]column, ...) = Expr([table.]column, ...) ...]`
  Выражение должно представлять собой цепочку равенств, объединённых оператором AND. Каждая сторона равенства может быть произвольным выражением над столбцами одной из таблиц. Для правой таблицы поддерживается использование полностью квалифицированных имён столбцов (`table.name`, `database.table.name`, `table_alias.name`, `subquery_alias.name`). [#2742](https://github.com/ClickHouse/ClickHouse/pull/2742)
- Для репликации можно включить HTTPS. [#2760](https://github.com/ClickHouse/ClickHouse/pull/2760)

#### Улучшения: {#improvements-6}

- Сервер передаёт клиенту patch-компонент своей версии. Данные о patch-компоненте версии находятся в `system.processes` и `query_log`. [#2646](https://github.com/ClickHouse/ClickHouse/pull/2646)


## Релиз ClickHouse 18.5 {#clickhouse-release-18-5}

### Релиз ClickHouse 18.5.1, 2018-07-31 {#clickhouse-release-18-5-1-2018-07-31}

#### Новые возможности: {#new-features-7}

- Добавлена хеш-функция `murmurHash2_32` [#2756](https://github.com/ClickHouse/ClickHouse/pull/2756).

#### Улучшения: {#improvements-7}

- Теперь можно использовать атрибут `from_env` [#2741](https://github.com/ClickHouse/ClickHouse/pull/2741) для задания значений в конфигурационных файлах из переменных окружения.
- Добавлены регистронезависимые версии функций `coalesce`, `ifNull` и `nullIf` [#2752](https://github.com/ClickHouse/ClickHouse/pull/2752).

#### Исправление ошибок: {#bug-fixes-15}

- Исправлена возможная ошибка при запуске реплики [#2759](https://github.com/ClickHouse/ClickHouse/pull/2759).


## Релиз ClickHouse 18.4 {#clickhouse-release-18-4}

### Релиз ClickHouse 18.4.0, 2018-07-28 {#clickhouse-release-18-4-0-2018-07-28}

#### Новые возможности: {#new-features-8}

- Добавлены системные таблицы: `formats`, `data_type_families`, `aggregate_function_combinators`, `table_functions`, `table_engines`, `collations` [#2721](https://github.com/ClickHouse/ClickHouse/pull/2721).
- Добавлена возможность использовать табличную функцию вместо таблицы в качестве аргумента функций `remote` или `cluster table function` [#2708](https://github.com/ClickHouse/ClickHouse/pull/2708).
- Поддержка аутентификации `HTTP Basic` в протоколе репликации [#2727](https://github.com/ClickHouse/ClickHouse/pull/2727).
- Функция `has` теперь позволяет искать числовое значение в массиве значений `Enum` [Maxim Khrisanfov](https://github.com/ClickHouse/ClickHouse/pull/2699).
- Поддержка добавления произвольных разделителей сообщений при чтении из `Kafka` [Amos Bird](https://github.com/ClickHouse/ClickHouse/pull/2701).

#### Улучшения: {#improvements-8}

- Запрос `ALTER TABLE t DELETE WHERE` не перезаписывает куски данных, на которые не влияет условие WHERE [#2694](https://github.com/ClickHouse/ClickHouse/pull/2694).
- Опция `use_minimalistic_checksums_in_zookeeper` для таблиц `ReplicatedMergeTree` включена по умолчанию. Эта настройка была добавлена в версии 1.1.54378, 2018-04-16. Версии старше 1.1.54378 больше не могут быть установлены.
- Поддержка выполнения запросов `KILL` и `OPTIMIZE` с указанием `ON CLUSTER` [Winter Zhang](https://github.com/ClickHouse/ClickHouse/pull/2689).

#### Исправления ошибок: {#bug-fixes-16}

- Исправлена ошибка `Column ... is not under an aggregate function and not in GROUP BY` при агрегации с выражением IN. Эта ошибка появилась в версии 18.1.0. ([bbdd780b](https://github.com/ClickHouse/ClickHouse/commit/bbdd780be0be06a0f336775941cdd536878dd2c2))
- Исправлена ошибка в агрегатной функции `windowFunnel` [Winter Zhang](https://github.com/ClickHouse/ClickHouse/pull/2735).
- Исправлена ошибка в агрегатной функции `anyHeavy` ([a2101df2](https://github.com/ClickHouse/ClickHouse/commit/a2101df25a6a0fba99aa71f8793d762af2b801ee))
- Исправлено падение сервера при использовании агрегатной функции `countArray()`.

#### Обратно несовместимые изменения: {#backward-incompatible-changes-5}

- Параметры движка `Kafka` изменены с `Kafka(kafka_broker_list, kafka_topic_list, kafka_group_name, kafka_format[, kafka_schema, kafka_num_consumers])` на `Kafka(kafka_broker_list, kafka_topic_list, kafka_group_name, kafka_format[, kafka_row_delimiter, kafka_schema, kafka_num_consumers])`. Если ваши таблицы используют параметры `kafka_schema` или `kafka_num_consumers`, необходимо вручную отредактировать файлы метаданных `path/metadata/database/table.sql` и добавить параметр `kafka_row_delimiter` со значением `''`.


## Релиз ClickHouse 18.1 {#clickhouse-release-18-1}

### Релиз ClickHouse 18.1.0, 2018-07-23 {#clickhouse-release-18-1-0-2018-07-23}

#### Новые возможности: {#new-features-9}

- Поддержка запроса `ALTER TABLE t DELETE WHERE` для нереплицируемых таблиц MergeTree ([#2634](https://github.com/ClickHouse/ClickHouse/pull/2634)).
- Поддержка произвольных типов для семейства агрегатных функций `uniq*` ([#2010](https://github.com/ClickHouse/ClickHouse/issues/2010)).
- Поддержка произвольных типов в операторах сравнения ([#2026](https://github.com/ClickHouse/ClickHouse/issues/2026)).
- Файл `users.xml` позволяет задавать маску подсети в формате `10.0.0.1/255.255.255.0`. Это необходимо для использования масок в сетях IPv6 с нулями в середине ([#2637](https://github.com/ClickHouse/ClickHouse/pull/2637)).
- Добавлена функция `arrayDistinct` ([#2670](https://github.com/ClickHouse/ClickHouse/pull/2670)).
- Движок SummingMergeTree теперь может работать со столбцами типа AggregateFunction ([Constantin S. Pan](https://github.com/ClickHouse/ClickHouse/pull/2566)).

#### Улучшения: {#improvements-9}

- Изменена схема нумерации версий релизов. Теперь первая часть содержит год выпуска (н.э., московский часовой пояс, минус 2000), вторая часть содержит номер для основных изменений (увеличивается для большинства релизов), а третья часть — версию патча. Релизы по-прежнему обратно совместимы, если иное не указано в журнале изменений.
- Ускорено преобразование чисел с плавающей точкой в строку ([Amos Bird](https://github.com/ClickHouse/ClickHouse/pull/2664)).
- Если некоторые строки были пропущены во время вставки из-за ошибок парсинга (это возможно при включенных настройках `input_allow_errors_num` и `input_allow_errors_ratio`), количество пропущенных строк теперь записывается в журнал сервера ([Leonardo Cecchi](https://github.com/ClickHouse/ClickHouse/pull/2669)).

#### Исправления ошибок: {#bug-fixes-17}

- Исправлена команда TRUNCATE для временных таблиц ([Amos Bird](https://github.com/ClickHouse/ClickHouse/pull/2624)).
- Исправлена редкая взаимная блокировка в клиентской библиотеке ZooKeeper, которая возникала при сетевой ошибке во время чтения ответа ([c315200](https://github.com/ClickHouse/ClickHouse/commit/c315200e64b87e44bdf740707fc857d1fdf7e947)).
- Исправлена ошибка при выполнении CAST к типам Nullable ([#1322](https://github.com/ClickHouse/ClickHouse/issues/1322)).
- Исправлен неверный результат функции `maxIntersection()`, когда границы интервалов совпадали ([Michael Furmur](https://github.com/ClickHouse/ClickHouse/pull/2657)).
- Исправлено неверное преобразование цепочки выражений OR в аргументе функции ([chenxing-xc](https://github.com/ClickHouse/ClickHouse/pull/2663)).
- Исправлено снижение производительности для запросов, содержащих выражения `IN (subquery)` внутри другого подзапроса ([#2571](https://github.com/ClickHouse/ClickHouse/issues/2571)).
- Исправлена несовместимость между серверами с разными версиями в распределенных запросах, использующих функцию `CAST`, написанную не заглавными буквами ([fe8c4d6](https://github.com/ClickHouse/ClickHouse/commit/fe8c4d64e434cacd4ceef34faa9005129f2190a5)).
- Добавлено отсутствующее экранирование идентификаторов для запросов к внешней СУБД ([#2635](https://github.com/ClickHouse/ClickHouse/issues/2635)).

#### Обратно несовместимые изменения: {#backward-incompatible-changes-6}

- Преобразование строки, содержащей число ноль, в DateTime не работает. Пример: `SELECT toDateTime('0')`. Это также причина того, что `DateTime DEFAULT '0'` не работает в таблицах, а также `<null_value>0</null_value>` в словарях. Решение: замените `0` на `0000-00-00 00:00:00`.


## ClickHouse релиз 1.1 {#clickhouse-release-1-1}

### ClickHouse релиз 1.1.54394, 2018-07-12 {#clickhouse-release-1-1-54394-2018-07-12}

#### Новые возможности: {#new-features-10}

- Добавлена агрегатная функция `histogram` ([Mikhail Surin](https://github.com/ClickHouse/ClickHouse/pull/2521)).
- Теперь `OPTIMIZE TABLE ... FINAL` можно использовать без указания партиций для `ReplicatedMergeTree` ([Amos Bird](https://github.com/ClickHouse/ClickHouse/pull/2600)).

#### Исправления ошибок: {#bug-fixes-18}

- Исправлена проблема с очень малым таймаутом для сокетов (одна секунда) при чтении и записи во время отправки и загрузки реплицируемых данных, из-за которой невозможно было загрузить большие куски при наличии нагрузки на сеть или диск (это приводило к циклическим попыткам загрузки кусков). Эта ошибка появилась в версии 1.1.54388.
- Исправлены проблемы при использовании chroot в ZooKeeper при вставке дублирующихся блоков данных в таблицу.
- Функция `has` теперь корректно работает для массива с элементами типа Nullable ([#2115](https://github.com/ClickHouse/ClickHouse/issues/2115)).
- Таблица `system.tables` теперь корректно работает при использовании в распределённых запросах. Столбцы `metadata_modification_time` и `engine_full` теперь не являются виртуальными. Исправлена ошибка, которая возникала при запросе только этих столбцов из таблицы.
- Исправлена работа пустой таблицы `TinyLog` после вставки пустого блока данных ([#2563](https://github.com/ClickHouse/ClickHouse/issues/2563)).
- Таблица `system.zookeeper` работает, если значение узла в ZooKeeper равно NULL.

### ClickHouse релиз 1.1.54390, 2018-07-06 {#clickhouse-release-1-1-54390-2018-07-06}

#### Новые возможности: {#new-features-11}

- Запросы можно отправлять в формате `multipart/form-data` (в поле `query`), что полезно, если для обработки запроса также отправляются внешние данные ([Olga Hvostikova](https://github.com/ClickHouse/ClickHouse/pull/2490)).
- Добавлена возможность включать или отключать обработку одинарных или двойных кавычек при чтении данных в формате CSV. Это можно настроить с помощью параметров `format_csv_allow_single_quotes` и `format_csv_allow_double_quotes` ([Amos Bird](https://github.com/ClickHouse/ClickHouse/pull/2574)).
- Теперь `OPTIMIZE TABLE ... FINAL` можно использовать без указания партиции для нереплицируемых вариантов `MergeTree` ([Amos Bird](https://github.com/ClickHouse/ClickHouse/pull/2599)).

#### Улучшения: {#improvements-10}

- Улучшена производительность, снижено потребление памяти и обеспечено корректное отслеживание потребления памяти при использовании оператора IN, когда может быть использован индекс таблицы ([#2584](https://github.com/ClickHouse/ClickHouse/pull/2584)).
- Удалена избыточная проверка контрольных сумм при добавлении куска данных. Это важно при большом количестве реплик, поскольку в таких случаях общее число проверок было равно N^2.
- Добавлена поддержка аргументов `Array(Tuple(...))` для функции `arrayEnumerateUniq` ([#2573](https://github.com/ClickHouse/ClickHouse/pull/2573)).
- Добавлена поддержка `Nullable` для функции `runningDifference` ([#2594](https://github.com/ClickHouse/ClickHouse/pull/2594)).
- Улучшена производительность анализа запросов при очень большом количестве выражений ([#2572](https://github.com/ClickHouse/ClickHouse/pull/2572)).
- Ускорен выбор кусков данных для слияния в таблицах `ReplicatedMergeTree`. Ускорено восстановление сессии ZooKeeper ([#2597](https://github.com/ClickHouse/ClickHouse/pull/2597)).
- Файл `format_version.txt` для таблиц `MergeTree` пересоздаётся, если он отсутствует, что имеет смысл при запуске ClickHouse после копирования структуры каталогов без файлов ([Ciprian Hacman](https://github.com/ClickHouse/ClickHouse/pull/2593)).

#### Исправления ошибок: {#bug-fixes-19}


- Исправлена ошибка при работе с ZooKeeper, из-за которой было невозможно восстановить сессию и состояния readonly таблиц без перезапуска сервера.
- Исправлена ошибка при работе с ZooKeeper, из-за которой старые узлы могли не удаляться при прерывании сессии.
- Исправлена ошибка в функции `quantileTDigest` для аргументов типа Float (эта ошибка была внесена в версии 1.1.54388) ([Mikhail Surin](https://github.com/ClickHouse/ClickHouse/pull/2553)).
- Исправлена ошибка в индексе для таблиц MergeTree, если столбец первичного ключа находится внутри функции преобразования типов между знаковыми и беззнаковыми целыми числами одинакового размера ([#2603](https://github.com/ClickHouse/ClickHouse/pull/2603)).
- Исправлена ошибка segfault при использовании `macros`, если они отсутствуют в конфигурационном файле ([#2570](https://github.com/ClickHouse/ClickHouse/pull/2570)).
- Исправлено переключение на базу данных по умолчанию при переподключении клиента ([#2583](https://github.com/ClickHouse/ClickHouse/pull/2583)).
- Исправлена ошибка, возникавшая при отключении настройки `use_index_for_in_with_subqueries`.

#### Исправление безопасности: {#security-fix-1}

- Отправка файлов больше невозможна при подключении к MySQL (`LOAD DATA LOCAL INFILE`).

### ClickHouse релиз 1.1.54388, 2018-06-28 {#clickhouse-release-1-1-54388-2018-06-28}

#### Новые возможности: {#new-features-12}

- Поддержка запроса `ALTER TABLE t DELETE WHERE` для реплицируемых таблиц. Добавлена таблица `system.mutations` для отслеживания прогресса выполнения запросов этого типа.
- Поддержка запроса `ALTER TABLE t [REPLACE|ATTACH] PARTITION` для таблиц семейства \*MergeTree.
- Поддержка запроса `TRUNCATE TABLE` ([Winter Zhang](https://github.com/ClickHouse/ClickHouse/pull/2260))
- Несколько новых запросов `SYSTEM` для реплицируемых таблиц (`RESTART REPLICAS`, `SYNC REPLICA`, `[STOP|START] [MERGES|FETCHES|SENDS REPLICATED|REPLICATION QUEUES]`).
- Добавлена возможность записи в таблицу с движком MySQL и соответствующей табличной функцией ([sundy-li](https://github.com/ClickHouse/ClickHouse/pull/2294)).
- Добавлены табличная функция `url()` и движок таблиц `URL` ([Alexander Sapin](https://github.com/ClickHouse/ClickHouse/pull/2501)).
- Добавлена агрегатная функция `windowFunnel` ([sundy-li](https://github.com/ClickHouse/ClickHouse/pull/2352)).
- Новые функции `startsWith` и `endsWith` для строк ([Vadim Plakhtinsky](https://github.com/ClickHouse/ClickHouse/pull/2429)).
- Табличная функция `numbers()` теперь позволяет указывать смещение ([Winter Zhang](https://github.com/ClickHouse/ClickHouse/pull/2535)).
- Пароль для `clickhouse-client` можно вводить в интерактивном режиме.
- Логи сервера теперь могут отправляться в syslog ([Alexander Krasheninnikov](https://github.com/ClickHouse/ClickHouse/pull/2459)).
- Поддержка логирования в словарях с источником в виде разделяемой библиотеки ([Alexander Sapin](https://github.com/ClickHouse/ClickHouse/pull/2472)).
- Поддержка пользовательских разделителей CSV ([Ivan Zhukov](https://github.com/ClickHouse/ClickHouse/pull/2263))
- Добавлена настройка `date_time_input_format`. Если установить эту настройку в значение `'best_effort'`, значения DateTime будут читаться в широком диапазоне форматов.
- Добавлена утилита `clickhouse-obfuscator` для обфускации данных. Пример использования: публикация данных, используемых в тестах производительности.

#### Экспериментальные возможности: {#experimental-features-2}

- Добавлена возможность вычисления аргументов `and` только там, где они необходимы ([Anastasia Tsarkova](https://github.com/ClickHouse/ClickHouse/pull/2272))
- JIT-компиляция в нативный код теперь доступна для некоторых выражений ([pyos](https://github.com/ClickHouse/ClickHouse/pull/2277)).

#### Исправления ошибок: {#bug-fixes-20}


- Дубликаты больше не появляются в запросах с `DISTINCT` и `ORDER BY`.
- Запросы с `ARRAY JOIN` и `arrayFilter` больше не возвращают некорректный результат.
- Исправлена ошибка при чтении столбца-массива из структуры Nested ([#2066](https://github.com/ClickHouse/ClickHouse/issues/2066)).
- Исправлена ошибка при анализе запросов с условием HAVING вида `HAVING tuple IN (...)`.
- Исправлена ошибка при анализе запросов с рекурсивными алиасами.
- Исправлена ошибка при чтении из ReplacingMergeTree с условием в PREWHERE, которое фильтрует все строки ([#2525](https://github.com/ClickHouse/ClickHouse/issues/2525)).
- Настройки профиля пользователя не применялись при использовании сессий в HTTP-интерфейсе.
- Исправлено применение настроек из параметров командной строки в clickhouse-local.
- Клиентская библиотека ZooKeeper теперь использует таймаут сессии, полученный от сервера.
- Исправлена ошибка в клиентской библиотеке ZooKeeper, когда клиент ожидал ответ сервера дольше таймаута.
- Исправлена отсечка кусков данных для запросов с условиями на столбцы ключа партиционирования ([#2342](https://github.com/ClickHouse/ClickHouse/issues/2342)).
- Слияния теперь возможны после `CLEAR COLUMN IN PARTITION` ([#2315](https://github.com/ClickHouse/ClickHouse/issues/2315)).
- Исправлено сопоставление типов в табличной функции ODBC ([sundy-li](https://github.com/ClickHouse/ClickHouse/pull/2268)).
- Исправлено сравнение типов для `DateTime` с часовым поясом и без него ([Alexander Bocharov](https://github.com/ClickHouse/ClickHouse/pull/2400)).
- Исправлен синтаксический разбор и форматирование оператора `CAST`.
- Исправлена вставка в материализованное представление для движка таблиц Distributed ([Babacar Diassé](https://github.com/ClickHouse/ClickHouse/pull/2411)).
- Исправлено состояние гонки при записи данных из движка `Kafka` в материализованные представления ([Yangkuan Liu](https://github.com/ClickHouse/ClickHouse/pull/2448)).
- Исправлена уязвимость SSRF в табличной функции remote().
- Исправлено поведение при выходе из `clickhouse-client` в многострочном режиме ([#2510](https://github.com/ClickHouse/ClickHouse/issues/2510)).

#### Улучшения: {#improvements-11}

- Фоновые задачи в реплицируемых таблицах теперь выполняются в пуле потоков вместо отдельных потоков ([Silviu Caragea](https://github.com/ClickHouse/ClickHouse/pull/1722)).
- Улучшена производительность сжатия LZ4.
- Ускорен анализ запросов с большим количеством JOIN и подзапросов.
- Кэш DNS теперь обновляется автоматически при большом количестве сетевых ошибок.
- Вставка в таблицу больше не происходит, если вставка в одно из материализованных представлений невозможна из-за слишком большого количества кусков данных.
- Исправлено расхождение в счётчиках событий `Query`, `SelectQuery` и `InsertQuery`.
- Выражения вида `tuple IN (SELECT tuple)` разрешены, если типы кортежей совпадают.
- Сервер с реплицируемыми таблицами может запуститься, даже если ZooKeeper не настроен.
- При вычислении количества доступных ядер CPU теперь учитываются ограничения cgroups ([Atri Sharma](https://github.com/ClickHouse/ClickHouse/pull/2325)).
- Добавлен chown для директорий конфигурации в конфигурационном файле systemd ([Mikhail Shiryaev](https://github.com/ClickHouse/ClickHouse/pull/2421)).

#### Изменения сборки: {#build-changes-4}

- Для сборки можно использовать компилятор gcc8.
- Добавлена возможность сборки llvm из подмодуля.
- Версия библиотеки librdkafka обновлена до v0.11.4.
- Добавлена возможность использования системной библиотеки libcpuid. Версия библиотеки обновлена до 0.4.0.
- Исправлена сборка с использованием библиотеки vectorclass ([Babacar Diassé](https://github.com/ClickHouse/ClickHouse/pull/2274)).
- Cmake теперь по умолчанию генерирует файлы для ninja (как при использовании `-G Ninja`).
- Добавлена возможность использования библиотеки libtinfo вместо libtermcap ([Georgy Kondratiev](https://github.com/ClickHouse/ClickHouse/pull/2519)).
- Исправлен конфликт заголовочных файлов в Fedora Rawhide ([#2520](https://github.com/ClickHouse/ClickHouse/issues/2520)).

#### Обратно несовместимые изменения: {#backward-incompatible-changes-7}


- Удалено экранирование в форматах `Vertical` и `Pretty*`, а также удалён формат `VerticalRaw`.
- Если серверы версии 1.1.54388 (или новее) и серверы более старой версии используются одновременно в распределённом запросе, и запрос содержит выражение `cast(x, 'Type')` без ключевого слова `AS` и не содержит слово `cast` в верхнем регистре, будет выброшено исключение с сообщением вида `Not found column cast(0, 'UInt8') in block`. Решение: обновите сервер на всём кластере.

### Релиз ClickHouse 1.1.54385, 2018-06-01 {#clickhouse-release-1-1-54385-2018-06-01}

#### Исправления ошибок: {#bug-fixes-21}

- Исправлена ошибка, которая в некоторых случаях приводила к блокировке операций ZooKeeper.

### Релиз ClickHouse 1.1.54383, 2018-05-22 {#clickhouse-release-1-1-54383-2018-05-22}

#### Исправления ошибок: {#bug-fixes-22}

- Исправлено замедление очереди репликации при наличии большого количества реплик таблицы.

### Релиз ClickHouse 1.1.54381, 2018-05-14 {#clickhouse-release-1-1-54381-2018-05-14}

#### Исправления ошибок: {#bug-fixes-23}

- Исправлена утечка узлов в ZooKeeper при потере соединения ClickHouse с сервером ZooKeeper.

### Релиз ClickHouse 1.1.54380, 2018-04-21 {#clickhouse-release-1-1-54380-2018-04-21}

#### Новые возможности: {#new-features-13}

- Добавлена табличная функция `file(path, format, structure)`. Пример чтения байтов из `/dev/urandom`: `ln -s /dev/urandom /var/lib/clickhouse/user_files/random``clickhouse-client -q "SELECT * FROM file('random', 'RowBinary', 'd UInt8') LIMIT 10"`.

#### Улучшения: {#improvements-12}

- Подзапросы могут быть заключены в скобки `()` для улучшения читаемости запроса. Например: `(SELECT 1) UNION ALL (SELECT 1)`.
- Простые запросы `SELECT` из таблицы `system.processes` не учитываются в ограничении `max_concurrent_queries`.

#### Исправления ошибок: {#bug-fixes-24}

- Исправлено некорректное поведение оператора `IN` при выборке из `MATERIALIZED VIEW`.
- Исправлена некорректная фильтрация по индексу партиций в выражениях вида `partition_key_column IN (...)`.
- Исправлена невозможность выполнения запроса `OPTIMIZE` на реплике-последователе, если для таблицы была выполнена операция `RENAME`.
- Исправлена ошибка авторизации при выполнении запросов `OPTIMIZE` или `ALTER` на реплике-последователе.
- Исправлено зависание `KILL QUERY`.
- Исправлена ошибка в клиентской библиотеке ZooKeeper, которая приводила к потере отслеживаний, зависанию очереди распределённых DDL-запросов и замедлению очереди репликации при использовании непустого префикса `chroot` в конфигурации ZooKeeper.

#### Обратно несовместимые изменения: {#backward-incompatible-changes-8}

- Удалена поддержка выражений вида `(a, b) IN (SELECT (a, b))` (можно использовать эквивалентное выражение `(a, b) IN (SELECT a, b)`). В предыдущих релизах такие выражения приводили к неопределённой фильтрации `WHERE` или вызывали ошибки.

### Релиз ClickHouse 1.1.54378, 2018-04-16 {#clickhouse-release-1-1-54378-2018-04-16}

#### Новые возможности: {#new-features-14}


- Уровень логирования можно изменить без перезапуска сервера.
- Добавлен запрос `SHOW CREATE DATABASE`.
- Параметр `query_id` можно передать в `clickhouse-client` (elBroom).
- Новая настройка: `max_network_bandwidth_for_all_users`.
- Добавлена поддержка `ALTER TABLE ... PARTITION ...` для `MATERIALIZED VIEW`.
- Добавлена информация о размере кусков данных в несжатом виде в системную таблицу.
- Поддержка шифрования между серверами для распределённых таблиц (`<secure>1</secure>` в конфигурации реплики в `<remote_servers>`).
- Настройка на уровне таблицы для семейства `ReplicatedMergeTree` для минимизации объёма данных, хранящихся в Zookeeper: `use_minimalistic_checksums_in_zookeeper = 1`
- Настройка приглашения командной строки `clickhouse-client`. По умолчанию имена серверов теперь выводятся в приглашении. Отображаемое имя сервера можно изменить. Оно также отправляется в HTTP-заголовке `X-ClickHouse-Display-Name` (Kirill Shvakov).
- Для движка `Kafka` можно указать несколько `topics`, разделённых запятыми (Tobias Adamson)
- Когда запрос останавливается командой `KILL QUERY` или `replace_running_query`, клиент получает исключение `Query was canceled` вместо неполного результата.

#### Улучшения: {#improvements-13}

- Запросы `ALTER TABLE ... DROP/DETACH PARTITION` выполняются в начале очереди репликации.
- `SELECT ... FINAL` и `OPTIMIZE ... FINAL` можно использовать, даже когда таблица содержит только один кусок данных.
- Таблица `query_log` пересоздаётся на лету, если она была удалена вручную (Kirill Shvakov).
- Функция `lengthUTF8` работает быстрее (zhang2014).
- Улучшена производительность синхронных вставок в таблицы `Distributed` (`insert_distributed_sync = 1`) при очень большом количестве шардов.
- Сервер принимает настройки `send_timeout` и `receive_timeout` от клиента и применяет их при подключении к клиенту (они применяются в обратном порядке: `send_timeout` сокета сервера устанавливается в значение `receive_timeout`, полученное от клиента, и наоборот).
- Более надёжное восстановление после сбоев при асинхронной вставке в таблицы `Distributed`.
- Тип возвращаемого значения функции `countEqual` изменён с `UInt32` на `UInt64` (谢磊).

#### Исправления ошибок: {#bug-fixes-25}

- Исправлена ошибка с `IN`, когда левая часть выражения имеет тип `Nullable`.
- Теперь возвращаются корректные результаты при использовании кортежей с `IN`, когда некоторые компоненты кортежа находятся в индексе таблицы.
- Ограничение `max_execution_time` теперь корректно работает с распределёнными запросами.
- Исправлены ошибки при вычислении размера составных столбцов в таблице `system.columns`.
- Исправлена ошибка при создании временной таблицы `CREATE TEMPORARY TABLE IF NOT EXISTS`.
- Исправлены ошибки в `StorageKafka` (##2075)
- Исправлены сбои сервера из-за некорректных аргументов некоторых агрегатных функций.
- Исправлена ошибка, которая не позволяла запросу `DETACH DATABASE` останавливать фоновые задачи для таблиц `ReplicatedMergeTree`.
- Состояние `Too many parts` теперь возникает реже при вставке в агрегированные материализованные представления (##2084).
- Исправлена рекурсивная обработка подстановок в конфигурации, когда за одной подстановкой должна следовать другая подстановка на том же уровне.
- Исправлен синтаксис в файле метаданных при создании `VIEW`, использующего запрос с `UNION ALL`.
- `SummingMergeTree` теперь корректно работает для суммирования вложенных структур данных с составным ключом.
- Исправлена возможность состояния гонки при выборе лидера для таблиц `ReplicatedMergeTree`.

#### Изменения сборки: {#build-changes-5}

- Сборка поддерживает `ninja` вместо `make` и использует `ninja` по умолчанию для сборки релизов.
- Переименованы пакеты: `clickhouse-server-base` в `clickhouse-common-static`; `clickhouse-server-common` в `clickhouse-server`; `clickhouse-common-dbg` в `clickhouse-common-static-dbg`. Для установки используйте `clickhouse-server clickhouse-client`. Пакеты со старыми именами по-прежнему будут доступны в репозиториях для обратной совместимости.

#### Обратно несовместимые изменения: {#backward-incompatible-changes-9}


- Удалена специальная интерпретация выражения IN, если слева указан массив. Ранее выражение `arr IN (set)` интерпретировалось как «хотя бы один элемент `arr` принадлежит `set`». Чтобы получить аналогичное поведение в новой версии, используйте `arrayExists(x -> x IN (set), arr)`.
- Отключено некорректное использование опции сокета `SO_REUSEPORT`, которая была ошибочно включена по умолчанию в библиотеке Poco. Обратите внимание, что в Linux больше нет необходимости одновременно указывать адреса `::` и `0.0.0.0` для прослушивания – используйте только `::`, что позволяет принимать соединения как по IPv4, так и по IPv6 (при настройках ядра по умолчанию). Вы также можете вернуться к поведению предыдущих версий, указав `<listen_reuse_port>1</listen_reuse_port>` в конфигурации.

### Релиз ClickHouse 1.1.54370, 2018-03-16 {#clickhouse-release-1-1-54370-2018-03-16}

#### Новые возможности: {#new-features-15}

- Добавлена таблица `system.macros` и автоматическое обновление макросов при изменении конфигурационного файла.
- Добавлен запрос `SYSTEM RELOAD CONFIG`.
- Добавлена агрегатная функция `maxIntersections(left_col, right_col)`, которая возвращает максимальное количество одновременно пересекающихся интервалов `[left; right]`. Функция `maxIntersectionsPosition(left, right)` возвращает начало «максимального» интервала. ([Michael Furmur](https://github.com/ClickHouse/ClickHouse/pull/2012)).

#### Улучшения: {#improvements-14}

- При вставке данных в таблицу `Replicated` выполняется меньше запросов к `ZooKeeper` (и большинство пользовательских ошибок исчезло из лога `ZooKeeper`).
- Добавлена возможность создавать псевдонимы для наборов данных. Пример: `WITH (1, 2, 3) AS set SELECT number IN set FROM system.numbers LIMIT 10`.

#### Исправления ошибок: {#bug-fixes-26}

- Исправлена ошибка `Illegal PREWHERE` при чтении из таблиц Merge для таблиц `Distributed`.
- Добавлены исправления, позволяющие запускать clickhouse-server в Docker-контейнерах только с IPv4.
- Исправлено состояние гонки при чтении из системных таблиц `system.parts_columns`.
- Удалена двойная буферизация при синхронной вставке в таблицу `Distributed`, которая могла приводить к таймауту соединения.
- Исправлена ошибка, вызывавшая чрезмерно долгое ожидание недоступной реплики перед началом выполнения запроса `SELECT`.
- Исправлены некорректные даты в таблице `system.parts`.
- Исправлена ошибка, делавшая невозможной вставку данных в таблицу `Replicated`, если `chroot` был непустым в конфигурации кластера `ZooKeeper`.
- Исправлен алгоритм вертикального слияния для таблицы с пустым `ORDER BY`.
- Восстановлена возможность использовать словари в запросах к удалённым таблицам, даже если эти словари отсутствуют на сервере-инициаторе запроса. Эта функциональность была утрачена в релизе 1.1.54362.
- Восстановлено поведение для запросов вида `SELECT * FROM remote('server2', default.table) WHERE col IN (SELECT col2 FROM default.table)`, когда правая часть `IN` должна использовать удалённую таблицу `default.table` вместо локальной. Это поведение было нарушено в версии 1.1.54358.
- Удалено избыточное логирование на уровне ошибок `Not found column ... in block`.

### Релиз ClickHouse 1.1.54362, 2018-03-11 {#clickhouse-release-1-1-54362-2018-03-11}

#### Новые возможности: {#new-features-16}


* Агрегация без `GROUP BY` для пустого множества (например, `SELECT count(*) FROM table WHERE 0`) теперь возвращает результат с одной строкой, в которой агрегатные функции имеют значение NULL, в соответствии со стандартом SQL. Чтобы вернуть старое поведение (возвращать пустой результат), установите `empty_result_for_aggregation_by_empty_set` в 1.
* Добавлено приведение типов для `UNION ALL`. В выражениях `SELECT` в `UNION ALL` теперь допускаются разные псевдонимы столбцов в соответствии со стандартом SQL.
* В предложениях `LIMIT BY` поддерживаются произвольные выражения. Ранее было возможно использовать только столбцы, полученные из `SELECT`.
* Индекс таблиц `MergeTree` используется, когда `IN` применяется к кортежу выражений из столбцов составного ключа. Пример: `WHERE (UserID, EventDate) IN ((123, '2000-01-01'), ...)` (Anastasiya Tsarkova).
* Добавлен инструмент `clickhouse-copier` для копирования данных между кластерами и перешардирования данных (бета).
* Добавлены функции консистентного хеширования: `yandexConsistentHash`, `jumpConsistentHash`, `sumburConsistentHash`. Их можно использовать в качестве ключа шардирования, чтобы уменьшить объём сетевого трафика при последующих перераспределениях шардинга.
* Добавлены функции: `arrayAny`, `arrayAll`, `hasAny`, `hasAll`, `arrayIntersect`, `arrayResize`.
* Добавлена функция `arrayCumSum` (Хави Сантана).
* Добавлены функции `parseDateTimeBestEffort`, `parseDateTimeBestEffortOrZero` и `parseDateTimeBestEffortOrNull` для чтения значения DateTime из строки с текстом в самом широком диапазоне возможных форматов.
* Данные могут частично перезагружаться из внешних словарей во время обновления (загружаются только записи, для которых значение указанного поля больше, чем при предыдущей загрузке) (Arsen Hakobyan).
* Добавлена табличная функция `cluster`. Пример: `cluster(cluster_name, db, table)`. Табличная функция `remote` может принимать имя кластера в качестве первого аргумента, если оно задано как идентификатор.
* Табличные функции `remote` и `cluster` можно использовать в запросах `INSERT`.
* Добавлены виртуальные столбцы `create_table_query` и `engine_full` в таблицу `system.tables`. Столбец `metadata_modification_time` также является виртуальным.
* Добавлены столбцы `data_path` и `metadata_path` в таблицы `system.tables` и `system.databases`, а также столбец `path` в таблицы `system.parts` и `system.parts_columns`.
* Добавлена новая информация о слияниях в таблице `system.part_log`.
* Для таблицы `system.query_log` теперь можно использовать произвольный ключ партиционирования (Kirill Shvakov).
* Запрос `SHOW TABLES` теперь также показывает временные таблицы. В `system.tables` добавлены временные таблицы и столбец `is_temporary` (zhang2014).
* Добавлены запросы `DROP TEMPORARY TABLE` и `EXISTS TEMPORARY TABLE` (zhang2014).
* Поддержка оператора `SHOW CREATE TABLE` для временных таблиц (zhang2014).
* Добавлен параметр конфигурации `system_profile` для управления настройками, используемыми внутренними процессами.
* Реализована поддержка загрузки `object_id` как атрибута в словарях `MongoDB` (Pavel Litvinenko).
* Использование `null` как значения по умолчанию при загрузке данных во внешний словарь из источника `MongoDB` (Pavel Litvinenko).
* Чтение значений `DateTime` в формате `Values` из Unix-времени без одинарных кавычек.
* Механизм отказоустойчивого переключения поддерживается в табличных функциях `remote` на случай, когда на некоторых репликах отсутствует запрошенная таблица.
* Параметры конфигурации можно переопределить в командной строке при запуске `clickhouse-server`. Например: `clickhouse-server -- --logger.level=information`.
* Реализована функция `empty` для аргумента типа `FixedString`: она возвращает 1, если строка полностью состоит из нулевых байтов (zhang2014).
* Добавлен параметр конфигурации `listen_try`, позволяющий продолжать работу при невозможности слушать некоторые из указанных адресов, если удаётся открыть хотя бы один из них (полезно для систем с отключённой поддержкой IPv4 или IPv6).
* Добавлен движок таблицы `VersionedCollapsingMergeTree`.
* Поддержка строковых ключей и произвольных числовых типов для источника словаря `library`.
* Таблицы `MergeTree` можно использовать без первичного ключа (для этого нужно указать `ORDER BY tuple()`).
* Тип `Nullable` можно привести с помощью `CAST` к типу без `Nullable`, если аргумент не равен `NULL`.
* `RENAME TABLE` может быть выполнен для `VIEW`.
* Добавлена функция `throwIf`.
* Добавлен параметр `odbc_default_field_size`, который позволяет увеличить максимальный размер значения, загружаемого из источника ODBC (по умолчанию — 1024).
* В таблице `system.processes` и выводе `SHOW PROCESSLIST` теперь есть столбцы `is_cancelled` и `peak_memory_usage`.

#### Улучшения: {#improvements-15}

- Ограничения и квоты на результат больше не применяются к промежуточным данным для запросов `INSERT SELECT` и подзапросов `SELECT`.
- Уменьшено количество ложных срабатываний `force_restore_data` при проверке статуса реплицируемых таблиц во время запуска сервера.
- Добавлена настройка `allow_distributed_ddl`.
- Недетерминированные функции запрещены в выражениях для ключей таблиц `MergeTree`.
- Файлы с подстановками из каталогов `config.d` загружаются в алфавитном порядке.
- Улучшена производительность функции `arrayElement` для константных многомерных массивов с пустым массивом в качестве одного из элементов. Пример: `[[1], []][x]`.
- Сервер теперь запускается быстрее при использовании конфигурационных файлов с очень большими подстановками (например, очень большими списками IP-сетей).
- При выполнении запроса табличные функции выполняются один раз. Ранее табличные функции `remote` и `mysql` выполняли один и тот же запрос дважды для получения структуры таблицы с удалённого сервера.
- Используется генератор документации `MkDocs`.
- При попытке удалить столбец таблицы, от которого зависят выражения `DEFAULT`/`MATERIALIZED` других столбцов, выбрасывается исключение (zhang2014).
- Добавлена возможность интерпретировать пустую строку в текстовых форматах как число 0 для типов данных `Float`. Эта функциональность была доступна ранее, но была утрачена в релизе 1.1.54342.
- Значения `Enum` могут использоваться в функциях `min`, `max`, `sum` и некоторых других. В этих случаях используются соответствующие числовые значения. Эта функциональность была доступна ранее, но была утрачена в релизе 1.1.54337.
- Добавлена настройка `max_expanded_ast_elements` для ограничения размера AST после рекурсивного раскрытия алиасов.

#### Исправления ошибок: {#bug-fixes-27}

- Исправлены случаи, когда ненужные столбцы ошибочно удалялись из подзапросов или не удалялись из подзапросов, содержащих `UNION ALL`.
- Исправлена ошибка в слияниях для таблиц `ReplacingMergeTree`.
- Исправлены синхронные вставки в таблицы `Distributed` (`insert_distributed_sync = 1`).
- Исправлен segfault при определённых использованиях `FULL` и `RIGHT JOIN` с дублирующимися столбцами в подзапросах.
- Исправлен segfault при определённых использованиях `replace_running_query` и `KILL QUERY`.
- Исправлен порядок столбцов `source` и `last_exception` в таблице `system.dictionaries`.
- Исправлена ошибка, когда запрос `DROP DATABASE` не удалял файл с метаданными.
- Исправлен запрос `DROP DATABASE` для баз данных типа `Dictionary`.
- Исправлена низкая точность функций `uniqHLL12` и `uniqCombined` для кардинальностей более 100 миллионов элементов (Alex Bocharov).
- Исправлен расчёт неявных значений по умолчанию при необходимости одновременного вычисления явных выражений по умолчанию в запросах `INSERT` (zhang2014).
- Исправлен редкий случай, когда запрос к таблице `MergeTree` не мог завершиться (chenxing-xc).
- Исправлено падение при выполнении запроса `CHECK` для таблиц `Distributed`, если все шарды локальные (chenxing.xc).
- Исправлена небольшая регрессия производительности функций, использующих регулярные выражения.
- Исправлена регрессия производительности при создании многомерных массивов из сложных выражений.
- Исправлена ошибка, которая могла привести к появлению лишней секции `FORMAT` в `.sql`-файле с метаданными.
- Исправлена ошибка, из-за которой ограничение `max_table_size_to_drop` применялось при попытке удалить материализованное представление (`MATERIALIZED VIEW`), ссылающееся на явно указанную таблицу.
- Исправлена несовместимость со старыми клиентами (старым клиентам иногда отправлялись данные с типом `DateTime('timezone')`, который они не понимают).
- Исправлена ошибка при чтении элементов вложенных столбцов (`Nested`) структур, которые были добавлены с помощью `ALTER`, но пусты для старых партиций, когда условия для этих столбцов перемещались в `PREWHERE`.
- Исправлена ошибка при фильтрации таблиц по виртуальным столбцам `_table` в запросах к таблицам `Merge`.
- Исправлена ошибка при использовании столбцов `ALIAS` в таблицах `Distributed`.
- Исправлена ошибка, которая делала невозможной динамическую компиляцию для запросов с агрегатными функциями из семейства `quantile`.
- Исправлено состояние гонки в конвейере выполнения запросов, которое возникало в очень редких случаях при использовании таблиц `Merge` с большим количеством таблиц и при использовании подзапросов `GLOBAL`.
- Исправлено падение при передаче массивов разных размеров в функцию `arrayReduce` при использовании агрегатных функций с несколькими аргументами.
- Запрещено использование запросов с `UNION ALL` в материализованных представлениях (`MATERIALIZED VIEW`).
- Исправлена ошибка при инициализации системной таблицы `part_log` во время запуска сервера (по умолчанию `part_log` отключён).

#### Обратно несовместимые изменения: {#backward-incompatible-changes-10}


- Удалена опция `distributed_ddl_allow_replicated_alter`. Это поведение включено по умолчанию.
- Удалена настройка `strict_insert_defaults`. Если вы использовали эту функциональность, напишите на `feedback@clickhouse.com`.
- Удалён движок `UnsortedMergeTree`.

### ClickHouse Release 1.1.54343, 2018-02-05 {#clickhouse-release-1-1-54343-2018-02-05}

- Добавлена поддержка макросов для определения имён кластеров в распределённых DDL-запросах и конструкторах таблиц Distributed: `CREATE TABLE distr ON CLUSTER '{cluster}' (...) ENGINE = Distributed('{cluster}', 'db', 'table')`.
- Теперь запросы вида `SELECT ... FROM table WHERE expr IN (subquery)` обрабатываются с использованием индекса таблицы `table`.
- Улучшена обработка дубликатов при вставке в реплицируемые таблицы, теперь они не замедляют выполнение очереди репликации.

### ClickHouse Release 1.1.54342, 2018-01-22 {#clickhouse-release-1-1-54342-2018-01-22}

Этот релиз содержит исправления ошибок предыдущего релиза 1.1.54337:

- Исправлена регрессия в 1.1.54337: если пользователь по умолчанию имеет доступ только для чтения, сервер отказывается запускаться с сообщением `Cannot create database in readonly mode`.
- Исправлена регрессия в 1.1.54337: в системах с systemd логи всегда записываются в syslog независимо от конфигурации; скрипт watchdog по-прежнему использует init.d.
- Исправлена регрессия в 1.1.54337: неправильная конфигурация по умолчанию в Docker-образе.
- Исправлено недетерминированное поведение GraphiteMergeTree (это можно увидеть в сообщениях лога `Data after merge is not byte-identical to the data on another replicas`).
- Исправлена ошибка, которая может привести к несогласованным слияниям после запроса OPTIMIZE к реплицируемым таблицам (это можно увидеть в сообщениях лога `Part ... intersects the previous part`).
- Таблицы Buffer теперь работают корректно при наличии столбцов MATERIALIZED в целевой таблице (автор: zhang2014).
- Исправлена ошибка в реализации NULL.

### ClickHouse Release 1.1.54337, 2018-01-18 {#clickhouse-release-1-1-54337-2018-01-18}

#### Новые возможности: {#new-features-17}


- Добавлена поддержка хранения многомерных массивов и кортежей (тип данных `Tuple`) в таблицах.
- Поддержка табличных функций в запросах `DESCRIBE` и `INSERT`. Добавлена поддержка подзапросов в `DESCRIBE`. Примеры: `DESC TABLE remote('host', default.hits)`; `DESC TABLE (SELECT 1)`; `INSERT INTO TABLE FUNCTION remote('host', default.hits)`. Поддержка `INSERT INTO TABLE` в дополнение к `INSERT INTO`.
- Улучшена поддержка часовых поясов. Тип данных `DateTime` может быть аннотирован часовым поясом, который используется для парсинга и форматирования в текстовых форматах. Пример: `DateTime('Asia/Istanbul')`. Когда часовые пояса указаны в функциях для аргументов `DateTime`, возвращаемый тип будет отслеживать часовой пояс, и значение будет отображаться корректно.
- Добавлены функции `toTimeZone`, `timeDiff`, `toQuarter`, `toRelativeQuarterNum`. Функции `toRelativeHour`/`Minute`/`Second` могут принимать значение типа `Date` в качестве аргумента. Имя функции `now` чувствительно к регистру.
- Добавлена функция `toStartOfFifteenMinutes` (Kirill Shvakov).
- Добавлен инструмент `clickhouse format` для форматирования запросов.
- Добавлен конфигурационный параметр `format_schema_path` (Marek Vavruşa). Он используется для указания схемы в формате `Cap'n Proto`. Файлы схем могут находиться только в указанной директории.
- Добавлена поддержка подстановок в конфигурации (`incl` и `conf.d`) для настройки внешних словарей и моделей (Pavel Yakunin).
- Добавлен столбец с документацией в таблицу `system.settings` (Kirill Shvakov).
- Добавлена таблица `system.parts_columns` с информацией о размерах столбцов в каждом куске данных таблиц `MergeTree`.
- Добавлена таблица `system.models` с информацией о загруженных моделях машинного обучения `CatBoost`.
- Добавлены табличные функции `mysql` и `odbc`, а также соответствующие движки таблиц `MySQL` и `ODBC` для доступа к удалённым базам данных. Эта функциональность находится на стадии бета-тестирования.
- Добавлена возможность передавать аргумент типа `AggregateFunction` в агрегатную функцию `groupArray` (что позволяет создать массив состояний агрегатной функции).
- Сняты ограничения на различные комбинации комбинаторов агрегатных функций. Например, можно использовать агрегатные функции `avgForEachIf` и `avgIfForEach`, которые имеют разное поведение.
- Комбинатор агрегатных функций `-ForEach` расширен для случая агрегатных функций с несколькими аргументами.
- Добавлена поддержка агрегатных функций с аргументами `Nullable` даже для случаев, когда функция возвращает не-`Nullable` результат (добавлено при участии Silviu Caragea). Примеры: `groupArray`, `groupUniqArray`, `topK`.
- Добавлена настройка `max_client_network_bandwidth` для `clickhouse-client` (Kirill Shvakov).
- Пользователям с настройкой `readonly = 2` разрешено работать с временными таблицами (CREATE, DROP, INSERT...) (Kirill Shvakov).
- Добавлена поддержка использования нескольких потребителей с движком `Kafka`. Расширены параметры конфигурации для `Kafka` (Marek Vavruša).
- Добавлены функции `intExp3` и `intExp4`.
- Добавлена агрегатная функция `sumKahan`.
- Добавлены функции to*Number*OrNull, где *Number* — числовой тип.
- Добавлена поддержка секций `WITH` в запросах `INSERT SELECT` (автор: zhang2014).
- Добавлены настройки: `http_connection_timeout`, `http_send_timeout`, `http_receive_timeout`. В частности, эти настройки используются для загрузки кусков данных при репликации. Изменение этих настроек позволяет быстрее выполнять переключение при отказе в случае перегрузки сети.
- Добавлена поддержка `ALTER` для таблиц типа `Null` (Anastasiya Tsarkova).
- Функция `reinterpretAsString` расширена для всех типов данных, которые хранятся непрерывно в памяти.
- Добавлена опция `--silent` для инструмента `clickhouse-local`. Она подавляет вывод информации о выполнении запроса в stderr.
- Добавлена поддержка чтения значений типа `Date` из текста в формате, где месяц и/или день месяца указаны одной цифрой вместо двух (Amos Bird).

#### Оптимизации производительности: {#performance-optimizations}


- Улучшена производительность агрегатных функций `min`, `max`, `any`, `anyLast`, `anyHeavy`, `argMin`, `argMax` для строковых аргументов.
- Улучшена производительность функций `isInfinite`, `isFinite`, `isNaN`, `roundToExp2`.
- Улучшена производительность парсинга и форматирования значений типов `Date` и `DateTime` в текстовом формате.
- Улучшена производительность и точность парсинга чисел с плавающей запятой.
- Снижено потребление памяти для `JOIN` в случае, когда левая и правая части содержат столбцы с одинаковыми именами, не указанные в `USING`.
- Улучшена производительность агрегатных функций `varSamp`, `varPop`, `stddevSamp`, `stddevPop`, `covarSamp`, `covarPop`, `corr` за счёт снижения вычислительной стабильности. Прежние функции доступны под именами `varSampStable`, `varPopStable`, `stddevSampStable`, `stddevPopStable`, `covarSampStable`, `covarPopStable`, `corrStable`.

#### Исправления ошибок: {#bug-fixes-28}


- Исправлена дедупликация данных после выполнения запроса `DROP` или `DETACH PARTITION`. В предыдущей версии удаление партиции и повторная вставка тех же данных не работали, так как вставляемые блоки считались дубликатами.
- Исправлена ошибка, которая могла привести к некорректной интерпретации условия `WHERE` для запросов `CREATE MATERIALIZED VIEW` с `POPULATE`.
- Исправлена ошибка при использовании параметра `root_path` в конфигурации `zookeeper_servers`.
- Исправлены неожиданные результаты при передаче аргумента типа `Date` в функцию `toStartOfDay`.
- Исправлены функции `addMonths` и `subtractMonths`, а также арифметика для `INTERVAL n MONTH` в случаях, когда результат относится к предыдущему году.
- Добавлена недостающая поддержка типа данных `UUID` для операций `DISTINCT`, `JOIN`, агрегатной функции `uniq` и внешних словарей (Evgeniy Ivanov). Поддержка `UUID` всё ещё неполная.
- Исправлено поведение `SummingMergeTree` в случаях, когда строки суммируются в ноль.
- Различные исправления для движка `Kafka` (Marek Vavruša).
- Исправлено некорректное поведение табличного движка `Join` (Amos Bird).
- Исправлено некорректное поведение аллокатора во FreeBSD и OS X.
- Функция `extractAll` теперь поддерживает пустые совпадения.
- Исправлена ошибка, которая блокировала использование `libressl` вместо `openssl`.
- Исправлен запрос `CREATE TABLE AS SELECT` из временных таблиц.
- Исправлена неатомарность обновления очереди репликации. Это могло приводить к рассинхронизации реплик до перезапуска сервера.
- Исправлено возможное переполнение в функциях `gcd`, `lcm` и `modulo` (оператор `%`) (Maks Skorokhod).
- Файлы `-preprocessed` теперь создаются после изменения `umask` (`umask` можно изменить в конфигурации).
- Исправлена ошибка в фоновой проверке кусков (`MergeTreePartChecker`) при использовании пользовательского ключа партиционирования.
- Исправлен парсинг кортежей (значений типа данных `Tuple`) в текстовых форматах.
- Улучшены сообщения об ошибках при передаче несовместимых типов в функции `multiIf`, `array` и некоторые другие функции.
- Переработана поддержка типов `Nullable`. Исправлены ошибки, которые могли приводить к падению сервера. Исправлены почти все остальные ошибки, связанные с поддержкой `NULL`: некорректные преобразования типов в INSERT SELECT, недостаточная поддержка Nullable в HAVING и PREWHERE, режим `join_use_nulls`, типы Nullable в качестве аргументов оператора `OR` и т. д.
- Исправлены различные ошибки, связанные с внутренней семантикой типов данных. Примеры: ненужное суммирование полей типа `Enum` в `SummingMergeTree`; выравнивание типов `Enum` в форматах `Pretty` и т. д.
- Более строгие проверки допустимых комбинаций составных столбцов.
- Исправлено переполнение при указании очень большого параметра для типа данных `FixedString`.
- Исправлена ошибка в агрегатной функции `topK` в общем случае.
- Добавлена недостающая проверка равенства размеров массивов в аргументах n-арных вариантов агрегатных функций с комбинатором `-Array`.
- Исправлена ошибка в `--pager` для `clickhouse-client` (автор: ks1322).
- Исправлена точность функции `exp10`.
- Исправлено поведение функции `visitParamExtract` для лучшего соответствия документации.
- Исправлено падение при указании некорректных типов данных.
- Исправлено поведение `DISTINCT` в случае, когда все столбцы являются константами.
- Исправлено форматирование запроса при использовании функции `tupleElement` со сложным константным выражением в качестве индекса элемента кортежа.
- Исправлена ошибка в таблицах `Dictionary` для словарей типа `range_hashed`.
- Исправлена ошибка, которая приводила к избыточным строкам в результате `FULL` и `RIGHT JOIN` (Amos Bird).
- Исправлено падение сервера при создании и удалении временных файлов в директориях `config.d` во время перезагрузки конфигурации.
- Исправлен запрос `SYSTEM DROP DNS CACHE`: кеш очищался, но адреса узлов кластера не обновлялись.
- Исправлено поведение `MATERIALIZED VIEW` после выполнения `DETACH TABLE` для таблицы, на которой основано представление (Marek Vavruša).

#### Улучшения сборки: {#build-improvements-4}


- Для сборки используется инструмент `pbuilder`. Процесс сборки практически полностью независим от окружения хост-системы.
- Одна сборка используется для разных версий ОС. Пакеты и бинарные файлы совместимы с широким спектром Linux-систем.
- Добавлен пакет `clickhouse-test`. Он может использоваться для запуска функциональных тестов.
- Архив с исходным кодом теперь может публиковаться в репозиторий. Его можно использовать для воспроизведения сборки без использования GitHub.
- Добавлена ограниченная интеграция с Travis CI. Из-за ограничений времени сборки в Travis тестируется только отладочная сборка и выполняется ограниченное подмножество тестов.
- Добавлена поддержка `Cap'n'Proto` в стандартной сборке.
- Изменён формат исходников документации с `Restricted Text` на `Markdown`.
- Добавлена поддержка `systemd` (Vladimir Smirnov). По умолчанию отключена из-за несовместимости с некоторыми образами ОС и может быть включена вручную.
- Для динамической генерации кода `clang` и `lld` встроены в бинарный файл `clickhouse`. Они также могут вызываться как `clickhouse clang` и `clickhouse lld`.
- Удалено использование расширений GNU из кода. Включена опция `-Wextra`. При сборке с `clang` по умолчанию используется `libc++` вместо `libstdc++`.
- Выделены библиотеки `clickhouse_parsers` и `clickhouse_common_io` для ускорения сборки различных инструментов.

#### Обратно несовместимые изменения: {#backward-incompatible-changes-11}

- Формат меток в таблицах типа `Log`, содержащих столбцы `Nullable`, был изменён обратно несовместимым образом. Если у вас есть такие таблицы, необходимо преобразовать их в тип `TinyLog` перед запуском новой версии сервера. Для этого замените `ENGINE = Log` на `ENGINE = TinyLog` в соответствующем `.sql` файле в директории `metadata`. Если ваша таблица не содержит столбцов `Nullable` или если тип вашей таблицы не `Log`, то никаких действий не требуется.
- Удалена настройка `experimental_allow_extended_storage_definition_syntax`. Теперь эта функция включена по умолчанию.
- Функция `runningIncome` переименована в `runningDifferenceStartingWithFirstvalue` во избежание путаницы.
- Удалён синтаксис `FROM ARRAY JOIN arr`, когда ARRAY JOIN указывается непосредственно после FROM без таблицы (Amos Bird).
- Удалён формат `BlockTabSeparated`, который использовался исключительно в демонстрационных целях.
- Изменён формат состояния для агрегатных функций `varSamp`, `varPop`, `stddevSamp`, `stddevPop`, `covarSamp`, `covarPop`, `corr`. Если вы сохранили состояния этих агрегатных функций в таблицах (используя тип данных `AggregateFunction` или материализованные представления с соответствующими состояниями), пожалуйста, напишите на feedback@clickhouse.com.
- В предыдущих версиях сервера существовала недокументированная возможность: если агрегатная функция зависит от параметров, её всё равно можно было указать без параметров в типе данных AggregateFunction. Пример: `AggregateFunction(quantiles, UInt64)` вместо `AggregateFunction(quantiles(0.5, 0.9), UInt64)`. Эта возможность была утрачена. Хотя она не была документирована, мы планируем снова поддержать её в будущих релизах.
- Типы данных Enum не могут использоваться в агрегатных функциях min/max. Эта возможность будет возвращена в следующем релизе.

#### Обратите внимание при обновлении: {#please-note-when-upgrading}

- При выполнении последовательного обновления кластера, в момент, когда некоторые реплики работают на старой версии ClickHouse, а некоторые на новой, репликация временно останавливается и в логе появляется сообщение `unknown parameter 'shard'`. Репликация продолжится после обновления всех реплик кластера.
- Если на серверах кластера работают разные версии ClickHouse, возможно, что распределённые запросы, использующие следующие функции, будут давать некорректные результаты: `varSamp`, `varPop`, `stddevSamp`, `stddevPop`, `covarSamp`, `covarPop`, `corr`. Необходимо обновить все узлы кластера.


## [Журнал изменений за 2017 год](./2017.md) {#changelog-for-2017}
