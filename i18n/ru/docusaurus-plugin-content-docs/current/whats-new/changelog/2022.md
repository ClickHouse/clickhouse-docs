---
slug: /whats-new/changelog/2022
sidebar_position: 5
sidebar_label: "2022"
title: "Журнал изменений 2022"
description: "Журнал изменений за 2022 год"
keywords:
  [
    "ClickHouse 2022",
    "журнал изменений 2022",
    "примечания к выпуску",
    "история версий",
    "обновления функций"
  ]
doc_type: "changelog"
---

### <a id="2212"></a> Выпуск ClickHouse 22.12, 2022-12-15 {#a-id2212a-clickhouse-release-2212-2022-12-15}

:::warning

Этот выпуск содержит ошибочный комментарий службы systemd, который может нарушить работу установки ClickHouse при обновлении в некоторых дистрибутивах Linux. Служба systemd изменяет права владельца каталога `/run/systemd`, что приводит к сбою всех последующих операций systemd. Рекомендуется пропустить обновление до этой версии и вместо этого обновиться до более новой версии ClickHouse.

Подробнее см. в этой проблеме на GitHub: https://github.com/ClickHouse/ClickHouse/issues/48285

:::

#### Примечания к обновлению {#upgrade-notes}

- Исправлена обратная несовместимость в (де)сериализации состояний агрегатных функций `min`, `max`, `any*`, `argMin`, `argMax` с аргументом типа `String`. Несовместимость затрагивает ветки 22.9, 22.10 и 22.11 (исправлено начиная с версий 22.9.6, 22.10.4 и 22.11.2 соответственно). Также затронуты некоторые минорные выпуски веток 22.3, 22.7 и 22.8: 22.3.13...22.3.14 (исправлено начиная с 22.3.15), 22.8.6...22.8.9 (исправлено начиная с 22.8.10), 22.7.6 и новее (не будет исправлено в 22.7, рекомендуется обновиться с 22.7.* до 22.8.10 или новее). Это примечание к выпуску не касается пользователей, которые никогда не использовали затронутые версии. Несовместимые версии добавляют дополнительный символ `'\0'` к строкам при чтении состояний упомянутых выше агрегатных функций. Например, если старая версия сохранила состояние `anyState('foobar')` в `state_column`, то несовместимая версия выведет `'foobar\0'` при выполнении `anyMerge(state_column)`. Также несовместимые версии записывают состояния агрегатных функций без завершающего `'\0'`. Новые версии (с исправлением) могут корректно читать данные, записанные всеми версиями, включая несовместимые, за исключением одного граничного случая. Если несовместимая версия сохранила состояние со строкой, которая фактически заканчивается нулевым символом, то новая версия обрежет завершающий `'\0'` при чтении состояния затронутой агрегатной функции. Например, если несовместимая версия сохранила состояние `anyState('abrac\0dabra\0')` в `state_column`, то новые версии выведут `'abrac\0dabra'` при выполнении `anyMerge(state_column)`. Проблема также затрагивает распределенные запросы, когда несовместимая версия работает в кластере вместе со старыми или новыми версиями. [#43038](https://github.com/ClickHouse/ClickHouse/pull/43038) ([Alexander Tokmakov](https://github.com/tavplubix), [Raúl Marín](https://github.com/Algunenano)). Примечание: все официальные сборки ClickHouse уже включают исправления. Это не обязательно верно для неофициальных сторонних сборок, которых следует избегать.


#### Новые возможности {#new-feature}

- Добавлен формат ввода/вывода `BSONEachRow`. В этом формате ClickHouse форматирует/парсит каждую строку как отдельный BSON-документ, а каждый столбец форматируется/парсится как одно BSON-поле с именем столбца в качестве ключа. [#42033](https://github.com/ClickHouse/ClickHouse/pull/42033) ([mark-polokhov](https://github.com/mark-polokhov)).
- Добавлен алгоритм JOIN `grace_hash`, который можно включить с помощью `SET join_algorithm = 'grace_hash'`. [#38191](https://github.com/ClickHouse/ClickHouse/pull/38191) ([BigRedEye](https://github.com/BigRedEye), [Vladimir C](https://github.com/vdimir)).
- Добавлена возможность настройки правил сложности паролей и проверок при создании и изменении пользователей. [#43719](https://github.com/ClickHouse/ClickHouse/pull/43719) ([Nikolay Degterinsky](https://github.com/evillique)).
- Маскировка конфиденциальной информации в логах; маскировка секретных частей в выводе запросов `SHOW CREATE TABLE` и `SELECT FROM system.tables`. Также решает проблему [#41418](https://github.com/ClickHouse/ClickHouse/issues/41418). [#43227](https://github.com/ClickHouse/ClickHouse/pull/43227) ([Vitaly Baranov](https://github.com/vitlibar)).
- Добавлен синтаксис `GROUP BY ALL`: [#37631](https://github.com/ClickHouse/ClickHouse/issues/37631). [#42265](https://github.com/ClickHouse/ClickHouse/pull/42265) ([刘陶峰](https://github.com/taofengliu)).
- Добавлен синтаксис `FROM table SELECT column`. [#41095](https://github.com/ClickHouse/ClickHouse/pull/41095) ([Nikolay Degterinsky](https://github.com/evillique)).
- Добавлена функция `concatWithSeparator` и псевдоним `concat_ws` для совместимости со Spark SQL. Добавлена функция `concatWithSeparatorAssumeInjective` как вариант для включения оптимизации GROUP BY, аналогично `concatAssumeInjective`. [#43749](https://github.com/ClickHouse/ClickHouse/pull/43749) ([李扬](https://github.com/taiyang-li)).
- Добавлены функции `multiplyDecimal` и `divideDecimal` для операций с десятичными числами с фиксированной точностью. [#42438](https://github.com/ClickHouse/ClickHouse/pull/42438) ([Andrey Zvonov](https://github.com/zvonand)).
- Добавлена таблица `system.moves` со списком перемещаемых в данный момент кусков данных. [#42660](https://github.com/ClickHouse/ClickHouse/pull/42660) ([Sergei Trifonov](https://github.com/serxa)).
- Добавлена поддержка встроенной конечной точки Prometheus для ClickHouse Keeper. [#43087](https://github.com/ClickHouse/ClickHouse/pull/43087) ([Antonio Andelic](https://github.com/antonio2368)).
- Поддержка числовых литералов с `_` в качестве разделителя, например `1_000_000`. [#43925](https://github.com/ClickHouse/ClickHouse/pull/43925) ([jh0x](https://github.com/jh0x)).
- Добавлена возможность использовать массив в качестве второго параметра для функции `cutURLParameter`. Это позволяет удалять несколько параметров. Закрывает [#6827](https://github.com/ClickHouse/ClickHouse/issues/6827). [#43788](https://github.com/ClickHouse/ClickHouse/pull/43788) ([Roman Vasin](https://github.com/rvasin)).
- Добавлен столбец с выражением индекса в таблице `system.data_skipping_indices`. [#43308](https://github.com/ClickHouse/ClickHouse/pull/43308) ([Guillaume Tassery](https://github.com/YiuRULE)).
- Добавлен столбец `engine_full` в системную таблицу `databases`, чтобы пользователи могли получить доступ к полному определению движка базы данных через системные таблицы. [#43468](https://github.com/ClickHouse/ClickHouse/pull/43468) ([凌涛](https://github.com/lingtaolf)).
- Добавлена новая хеш-функция [xxh3](https://github.com/Cyan4973/xxHash). Также улучшена производительность `xxHash32` и `xxHash64` на ARM благодаря обновлению библиотеки. [#43411](https://github.com/ClickHouse/ClickHouse/pull/43411) ([Nikita Taranov](https://github.com/nickitat)).
- Добавлена поддержка определения ограничений для настроек merge tree. Например, можно запретить пользователям переопределять `storage_policy`. [#43903](https://github.com/ClickHouse/ClickHouse/pull/43903) ([Sergei Trifonov](https://github.com/serxa)).
- Добавлена новая настройка `input_format_json_read_objects_as_strings`, которая позволяет парсить вложенные JSON-объекты в строки во всех форматах ввода JSON. Эта настройка по умолчанию отключена. [#44052](https://github.com/ClickHouse/ClickHouse/pull/44052) ([Kruglov Pavel](https://github.com/Avogar)).

#### Экспериментальная функциональность {#experimental-feature}

- Добавлена поддержка дедупликации для асинхронных вставок. До этого изменения асинхронные вставки не поддерживали дедупликацию, так как несколько небольших вставок объединялись в один пакет. Закрывает [#38075](https://github.com/ClickHouse/ClickHouse/issues/38075). [#43304](https://github.com/ClickHouse/ClickHouse/pull/43304) ([Han Fei](https://github.com/hanfei1991)).
- Добавлена поддержка косинусного расстояния для экспериментального индекса Annoy (поиск по векторному сходству). [#42778](https://github.com/ClickHouse/ClickHouse/pull/42778) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
- Добавлены запросы `CREATE / ALTER / DROP NAMED COLLECTION`. [#43252](https://github.com/ClickHouse/ClickHouse/pull/43252) ([Kseniia Sumarokova](https://github.com/kssenii)). Эта функциональность находится в разработке, и запросы не действуют в версии 22.12. Эта запись в журнале изменений добавлена только во избежание путаницы. Ограничен доступ по умолчанию к именованным коллекциям для пользователя, определенного в конфигурации. Для их просмотра необходимо установить `show_named_collections = 1`. [#43325](https://github.com/ClickHouse/ClickHouse/pull/43325) ([Kseniia Sumarokova](https://github.com/kssenii)). Введена таблица `system.named_collections` [#43147](https://github.com/ClickHouse/ClickHouse/pull/43147) ([Kseniia Sumarokova](https://github.com/kssenii)).


#### Улучшение производительности {#performance-improvement}

- Добавлены настройки `max_streams_for_merge_tree_reading` и `allow_asynchronous_read_from_io_pool_for_merge_tree`. Настройка `max_streams_for_merge_tree_reading` ограничивает количество потоков чтения для таблиц MergeTree. Настройка `allow_asynchronous_read_from_io_pool_for_merge_tree` включает фоновый пул ввода-вывода для чтения из таблиц `MergeTree`. Это может повысить производительность запросов, ограниченных операциями ввода-вывода, при совместном использовании с `max_streams_to_max_threads_ratio` или `max_streams_for_merge_tree_reading`. [#43260](https://github.com/ClickHouse/ClickHouse/pull/43260) ([Nikolai Kochetov](https://github.com/KochetovNicolai)). Это улучшает производительность до 100 раз в случае хранилища с высокой задержкой, небольшого количества процессоров и большого количества частей данных.
- Настройки `merge_tree_min_rows_for_concurrent_read_for_remote_filesystem/merge_tree_min_bytes_for_concurrent_read_for_remote_filesystem` не учитывали адаптивную гранулярность. Крупные строки не уменьшали количество прочитанных строк (как это было реализовано для `merge_tree_min_rows_for_concurrent_read/merge_tree_min_bytes_for_concurrent_read`), что могло привести к высокому потреблению памяти при использовании удаленных файловых систем. [#43965](https://github.com/ClickHouse/ClickHouse/pull/43965) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Оптимизировано количество запросов списков к ZooKeeper или ClickHouse Keeper при выборе части для слияния. Ранее в некоторых случаях могло создаваться тысячи запросов. Исправляет [#43647](https://github.com/ClickHouse/ClickHouse/issues/43647). [#43675](https://github.com/ClickHouse/ClickHouse/pull/43675) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Оптимизация теперь пропускается, если `max_size_to_preallocate_for_aggregation` имеет слишком малое значение. Значение по умолчанию этой настройки увеличено до `10^8`. [#43945](https://github.com/ClickHouse/ClickHouse/pull/43945) ([Nikita Taranov](https://github.com/nickitat)).
- Ускорено завершение работы сервера за счет отказа от очистки старых частей данных. Это стало ненужным после https://github.com/ClickHouse/ClickHouse/pull/41145. [#43760](https://github.com/ClickHouse/ClickHouse/pull/43760) ([Sema Checherinda](https://github.com/CheSema)).
- Слияние на инициаторе теперь использует тот же подход с ограничением памяти, что и слияние локальных результатов агрегации, если установлена настройка `enable_memory_bound_merging_of_aggregation_results`. [#40879](https://github.com/ClickHouse/ClickHouse/pull/40879) ([Nikita Taranov](https://github.com/nickitat)).
- Улучшение Keeper: синхронизация журналов на диск выполняется параллельно с репликацией. [#43450](https://github.com/ClickHouse/ClickHouse/pull/43450) ([Antonio Andelic](https://github.com/antonio2368)).
- Улучшение Keeper: запросы группируются чаще. Группировкой можно управлять с помощью новой настройки `max_requests_quick_batch_size`. [#43686](https://github.com/ClickHouse/ClickHouse/pull/43686) ([Antonio Andelic](https://github.com/antonio2368)).


#### Улучшения {#improvement}

- Реализованы ссылочные зависимости и их использование для создания таблиц в правильном порядке при восстановлении из резервной копии. [#43834](https://github.com/ClickHouse/ClickHouse/pull/43834) ([Vitaly Baranov](https://github.com/vitlibar)).
- Подстановка пользовательских функций (UDF) в запросах `CREATE` для предотвращения сбоев при загрузке во время запуска. Кроме того, UDF теперь могут использоваться в качестве выражений `DEFAULT` для столбцов. [#43539](https://github.com/ClickHouse/ClickHouse/pull/43539) ([Antonio Andelic](https://github.com/antonio2368)).
- Изменен механизм удаления частей для следующих запросов: TRUNCATE TABLE, ALTER TABLE DROP PART, ALTER TABLE DROP PARTITION. Теперь эти запросы создают пустые части, которые покрывают старые части. Это позволяет запросу TRUNCATE работать без последующей эксклюзивной блокировки, что означает отсутствие блокировки параллельных операций чтения. Также обеспечена устойчивость во всех этих запросах. Если запрос выполнен успешно, то воскрешенные части не появятся позже. Обратите внимание, что атомарность достигается только в рамках транзакции. [#41145](https://github.com/ClickHouse/ClickHouse/pull/41145) ([Sema Checherinda](https://github.com/CheSema)).
- Запрос `SET param_x` больше не требует ручной сериализации строки для значения параметра. Например, запрос `SET param_a = '[\'a\', \'b\']'` теперь может быть записан как `SET param_a = ['a', 'b']`. [#41874](https://github.com/ClickHouse/ClickHouse/pull/41874) ([Nikolay Degterinsky](https://github.com/evillique)).
- Отображение прочитанных строк в индикаторе прогресса при чтении из STDIN от клиента. Закрывает [#43423](https://github.com/ClickHouse/ClickHouse/issues/43423). [#43442](https://github.com/ClickHouse/ClickHouse/pull/43442) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Отображение индикатора прогресса при чтении из табличной функции / движка s3. [#43454](https://github.com/ClickHouse/ClickHouse/pull/43454) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Индикатор прогресса будет показывать как прочитанные, так и записанные строки. [#43496](https://github.com/ClickHouse/ClickHouse/pull/43496) ([Ilya Yatsishin](https://github.com/qoega)).
- Функции `filesystemAvailable` и связанные с ними поддерживают один необязательный аргумент с именем диска, а `filesystemFree` переименована в `filesystemUnreserved`. Закрывает [#35076](https://github.com/ClickHouse/ClickHouse/issues/35076). [#42064](https://github.com/ClickHouse/ClickHouse/pull/42064) ([flynn](https://github.com/ucasfl)).
- Интеграция с LDAP: увеличено значение по умолчанию для search_limit до 256, добавлена опция конфигурации сервера LDAP для изменения этого значения на произвольное. Закрывает: [#42276](https://github.com/ClickHouse/ClickHouse/issues/42276). [#42461](https://github.com/ClickHouse/ClickHouse/pull/42461) ([Vasily Nemkov](https://github.com/Enmk)).
- Разрешено удаление конфиденциальной информации (см. `query_masking_rules` в конфигурационном файле) также из сообщений об исключениях. Решает [#41418](https://github.com/ClickHouse/ClickHouse/issues/41418). [#42940](https://github.com/ClickHouse/ClickHouse/pull/42940) ([filimonov](https://github.com/filimonov)).
- Поддержка запросов вида `SHOW FULL TABLES ...` для совместимости с MySQL. [#43910](https://github.com/ClickHouse/ClickHouse/pull/43910) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
- Улучшение Keeper: добавлена команда 4lw `rqld`, которая позволяет вручную назначить узел лидером. [#43026](https://github.com/ClickHouse/ClickHouse/pull/43026) ([JackyWoo](https://github.com/JackyWoo)).
- Применение настроек тайм-аута соединения для асинхронных INSERT в Distributed из запроса. [#43156](https://github.com/ClickHouse/ClickHouse/pull/43156) ([Azat Khuzhin](https://github.com/azat)).
- Функция `unhex` теперь поддерживает аргументы типа `FixedString`. [issue42369](https://github.com/ClickHouse/ClickHouse/issues/42369). [#43207](https://github.com/ClickHouse/ClickHouse/pull/43207) ([DR](https://github.com/freedomDR)).
- Приоритет отдается удалению полностью истекших частей в соответствии с правилами TTL, см. [#42869](https://github.com/ClickHouse/ClickHouse/issues/42869). [#43222](https://github.com/ClickHouse/ClickHouse/pull/43222) ([zhongyuankai](https://github.com/zhongyuankai)).
- Более точная и отзывчивая индикация загрузки CPU в clickhouse-client. [#43307](https://github.com/ClickHouse/ClickHouse/pull/43307) ([Sergei Trifonov](https://github.com/serxa)).
- Поддержка чтения подстолбцов вложенных типов из хранилища `S3` и табличной функции `s3` с форматами `Parquet`, `Arrow` и `ORC`. [#43329](https://github.com/ClickHouse/ClickHouse/pull/43329) ([chen](https://github.com/xiedeyantu)).
- Добавлен столбец `table_uuid` в таблицу `system.parts`. [#43404](https://github.com/ClickHouse/ClickHouse/pull/43404) ([Azat Khuzhin](https://github.com/azat)).
- Добавлена опция клиента для отображения количества локально обработанных строк в неинтерактивном режиме (`--print-num-processed-rows`). [#43407](https://github.com/ClickHouse/ClickHouse/pull/43407) ([jh0x](https://github.com/jh0x)).
- Реализована оптимизация `aggregation-in-order` на основе плана запроса. Она включена по умолчанию (но работает только вместе с `optimize_aggregation_in_order`, которая отключена по умолчанию). Установите `query_plan_aggregation_in_order = 0` для использования предыдущей версии на основе AST. [#43592](https://github.com/ClickHouse/ClickHouse/pull/43592) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Разрешен сбор событий профилирования с `trace_type = 'ProfileEvent'` в `system.trace_log` при каждом приращении с текущим стеком, именем события профилирования и значением приращения. Это можно включить с помощью настройки `trace_profile_events` и использовать для исследования производительности запросов. [#43639](https://github.com/ClickHouse/ClickHouse/pull/43639) ([Anton Popov](https://github.com/CurtizJ)).
- Добавлена новая настройка `input_format_max_binary_string_size` для ограничения размера строки в формате RowBinary. [#43842](https://github.com/ClickHouse/ClickHouse/pull/43842) ([Kruglov Pavel](https://github.com/Avogar)).
- Когда ClickHouse выполняет запрос к удаленному HTTP-серверу, и тот возвращает ошибку, числовой HTTP-код не отображался корректно в сообщении об исключении. Закрывает [#43919](https://github.com/ClickHouse/ClickHouse/issues/43919). [#43920](https://github.com/ClickHouse/ClickHouse/pull/43920) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Корректное сообщение об ошибках в запросах даже при выполнении оптимизации множественных JOIN. [#43583](https://github.com/ClickHouse/ClickHouse/pull/43583) ([Salvatore](https://github.com/tbsal)).

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement}

- Интеграция с systemd теперь корректно уведомляет systemd о том, что служба действительно запущена и готова к обработке запросов. [#43400](https://github.com/ClickHouse/ClickHouse/pull/43400) ([Коренберг Марк](https://github.com/socketpair)).
- Добавлена возможность сборки ClickHouse с OpenSSL с использованием [OpenSSL FIPS Module](https://www.openssl.org/docs/man3.0/man7/fips_module.html). Данный тип сборки не был протестирован на соответствие требованиям безопасности и не поддерживается. [#43991](https://github.com/ClickHouse/ClickHouse/pull/43991) ([Boris Kuschel](https://github.com/bkuschel)).
- Обновление кодека сжатия `DeflateQpl`, который был реализован в предыдущем PR (подробности: https://github.com/ClickHouse/ClickHouse/pull/39494). Данное обновление улучшает кодек в следующих аспектах: 1. Обновление QPL с версии v0.2.0 до v0.3.0 [Intel® Query Processing Library (QPL)](https://github.com/intel/qpl) 2. Улучшение файла CMake для устранения проблем сборки QPL версии v0.3.0. 3. Связывание библиотеки QPL с libaccel-config во время сборки вместо динамической загрузки во время выполнения в QPL v0.2.0 (dlopen) 4. Исправлена проблема вывода логов в CompressionCodecDeflateQpl.cpp. [#44024](https://github.com/ClickHouse/ClickHouse/pull/44024) ([jasperzhu](https://github.com/jinjunzh)).

#### Исправление ошибок (видимые пользователю некорректные поведения в официальных стабильных или предварительных релизах) {#bug-fix-user-visible-misbehavior-in-official-stable-or-prestable-release}


* Исправлена ошибка, которая могла приводить к взаимоблокировке при использовании асинхронных вставок. [#43233](https://github.com/ClickHouse/ClickHouse/pull/43233) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибочная логика оптимизации на уровне AST `optimize_normalize_count_variants`. [#43873](https://github.com/ClickHouse/ClickHouse/pull/43873) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлена проблема, при которой мутации не выполнялись, если контрольные суммы не совпадали между репликами (например, из‑за изменения формата данных при обновлении). [#36877](https://github.com/ClickHouse/ClickHouse/pull/36877) ([nvartolomei](https://github.com/nvartolomei)).
* Исправлена оптимизация `skip_unavailable_shards`, которая не работала при использовании с табличной функцией `hdfsCluster`. [#43236](https://github.com/ClickHouse/ClickHouse/pull/43236) ([chen](https://github.com/xiedeyantu)).
* Исправлена поддержка символа подстановки `?` в `s3`. Закрывает [#42731](https://github.com/ClickHouse/ClickHouse/issues/42731). [#43253](https://github.com/ClickHouse/ClickHouse/pull/43253) ([chen](https://github.com/xiedeyantu)).
* Исправлены функции `arrayFirstOrNull` и `arrayLastOrNull` для корректной обработки `NULL`, когда массив содержит элементы типа `Nullable`. [#43274](https://github.com/ClickHouse/ClickHouse/pull/43274) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлен некорректный учет `UserTimeMicroseconds`/`SystemTimeMicroseconds` для таблиц Kafka. [#42791](https://github.com/ClickHouse/ClickHouse/pull/42791) ([Azat Khuzhin](https://github.com/azat)).
* Не подавлять исключения на дисках `web`. Исправлены повторные попытки для диска `web`. [#42800](https://github.com/ClickHouse/ClickHouse/pull/42800) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена (логическая) гонка между операциями вставки и удалением материализованных представлений. Гонка возникала, когда материализованное представление удалялось одновременно с выполнением `INSERT`: в начале выполнения материализованные представления присутствовали как зависимость операции вставки, но к моменту, когда цепочка вставки пыталась получить к ним доступ, таблица уже была удалена, что приводило к возникновению исключения `UNKNOWN_TABLE` или `TABLE_IS_DROPPED` и остановке вставки. После этого изменения такие исключения не возникают, и выполнение вставки продолжается, если зависимость к этому моменту уже отсутствует. [#43161](https://github.com/ClickHouse/ClickHouse/pull/43161) ([AlfVII](https://github.com/AlfVII)).
* Исправлено неопределённое поведение в функции `quantiles`, которое могло приводить к использованию неинициализированной памяти. Обнаружено фаззером. Исправление закрывает [#44066](https://github.com/ClickHouse/ClickHouse/issues/44066). [#44067](https://github.com/ClickHouse/ClickHouse/pull/44067) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* В `CompressionCodecDelta` добавлена дополнительная проверка на нулевой несжатый размер. [#43255](https://github.com/ClickHouse/ClickHouse/pull/43255) ([Nikita Taranov](https://github.com/nickitat)).
* Реализовано разворачивание массивов в файлах Parquet, чтобы избежать проблемы с неконсистентными данными в массивах. Такие некорректные файлы может генерировать Apache Iceberg. [#43297](https://github.com/ClickHouse/ClickHouse/pull/43297) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлено неправильное приведение типа из столбца `LowCardinality` при использовании короткого вычисления функций. [#43311](https://github.com/ClickHouse/ClickHouse/pull/43311) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлены запросы с `SAMPLE BY` с оптимизацией `PREWHERE` для таблиц с движком `Merge`. [#43315](https://github.com/ClickHouse/ClickHouse/pull/43315) ([Antonio Andelic](https://github.com/antonio2368)).
* Проверять и сравнивать содержимое файла `format_version` в `MergeTreeData`, чтобы таблицы можно было загрузить даже если политика хранения была изменена. [#43328](https://github.com/ClickHouse/ClickHouse/pull/43328) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена возможная (хотя и маловероятная) логическая ошибка «No column to rollback» при выполнении операции INSERT в таблицы `Buffer`. [#43336](https://github.com/ClickHouse/ClickHouse/pull/43336) ([Azат Khuzhin](https://github.com/azat)).
* Исправлена ошибка, из-за которой парсер мог разобрать неограниченное количество круглых скобок в один вызов функции при включённом параметре `allow_function_parameters`. [#43350](https://github.com/ClickHouse/ClickHouse/pull/43350) ([Nikolay Degterinsky](https://github.com/evillique)).
* `MaterializeMySQL` (экспериментальная функция) поддерживает DDL: `drop table t1, t2` и совместим с большинством операторов DROP в MySQL. [#43366](https://github.com/ClickHouse/ClickHouse/pull/43366) ([zzsmdfj](https://github.com/zzsmdfj)).
* `session_log` (экспериментальная функция): Исправлена невозможность входа (из-за сбоя при создании записи в `session_log`) в крайне редком случае некорректно настроенных профилей. [#42641](https://github.com/ClickHouse/ClickHouse/pull/42641) ([Vasily Nemkov](https://github.com/Enmk)).
* Исправлена потенциальная ошибка `Cannot create non-empty column with type Nothing` в функциях `if` и `multiIf`. Закрывает [#43356](https://github.com/ClickHouse/ClickHouse/issues/43356). [#43368](https://github.com/ClickHouse/ClickHouse/pull/43368) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка, возникавшая, когда фильтр на уровне строк использовал значение по умолчанию столбца. [#43387](https://github.com/ClickHouse/ClickHouse/pull/43387) ([Alexander Gololobov](https://github.com/davenger)).
* Исправлена ошибка, из-за которой запрос с `DISTINCT` + `LIMIT BY` + `LIMIT` мог возвращать меньше строк, чем ожидалось. Исправляет [#43377](https://github.com/ClickHouse/ClickHouse/issues/43377). [#43410](https://github.com/ClickHouse/ClickHouse/pull/43410) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлена работа функции `sumMap` с `Nullable(Decimal(...))`. [#43414](https://github.com/ClickHouse/ClickHouse/pull/43414) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено вычисление `date_diff` для часов и минут на macOS. Закрывает [#42742](https://github.com/ClickHouse/ClickHouse/issues/42742). [#43466](https://github.com/ClickHouse/ClickHouse/pull/43466) ([zzsmdfj](https://github.com/zzsmdfj)).
* Исправлен некорректный учёт памяти из-за слияний/мутаций. [#43516](https://github.com/ClickHouse/ClickHouse/pull/43516) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен анализ первичного ключа с условиями, включающими `toString(enum)`. [#43596](https://github.com/ClickHouse/ClickHouse/pull/43596) ([Nikita Taranov](https://github.com/nickitat)). Эта ошибка была найдена пользователем @tisonkun.
* Обеспечена согласованность при обновлении статуса `clickhouse-copier` и флага `attach_is_done` в Keeper после завершения присоединения партиции. [#43602](https://github.com/ClickHouse/ClickHouse/pull/43602) ([lzydmxy](https://github.com/lzydmxy)).
* Во время восстановления потерянной реплики базы данных `Replicated` (экспериментальная возможность) может возникнуть ситуация, когда необходимо атомарно поменять местами имена двух таблиц (следует использовать EXCHANGE). Ранее мы пытались использовать два запроса RENAME, что, очевидно, не работало и, более того, приводило к сбою всего процесса восстановления реплики базы данных. [#43628](https://github.com/ClickHouse/ClickHouse/pull/43628) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена проблема, при которой функция `s3Cluster` выбрасывала ошибку `NOT_FOUND_COLUMN_IN_BLOCK`. Закрывает [#43534](https://github.com/ClickHouse/ClickHouse/issues/43534). [#43629](https://github.com/ClickHouse/ClickHouse/pull/43629) ([chen](https://github.com/xiedeyantu)).
* Исправлена возможная логическая ошибка `Array sizes mismatched` при разборе JSON-объекта, содержащего массивы с одинаковыми именами ключей, но на разном уровне вложенности. Закрывает [#43569](https://github.com/ClickHouse/ClickHouse/issues/43569). [#43693](https://github.com/ClickHouse/ClickHouse/pull/43693) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена возможная ошибка выполнения в распределённом `GROUP BY` при наличии столбца `ALIAS` среди ключей агрегации. [#43709](https://github.com/ClickHouse/ClickHouse/pull/43709) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена ошибка, которая могла приводить к некорректным проекциям при включённой и используемой репликации без копирования данных (экспериментальная функция). [#43764](https://github.com/ClickHouse/ClickHouse/pull/43764) ([alesapin](https://github.com/alesapin)).
* Исправлено использование механизма многокомпонентной (multipart) загрузки для очень больших объектов в AWS S3. [#43824](https://github.com/ClickHouse/ClickHouse/pull/43824) ([ianton-ru](https://github.com/ianton-ru)).
* Исправлена работа `ALTER ... RESET SETTING` с `ON CLUSTER`. Ранее эта команда могла быть применена только к одной реплике. Исправляет [#43843](https://github.com/ClickHouse/ClickHouse/issues/43843). [#43848](https://github.com/ClickHouse/ClickHouse/pull/43848) ([Elena Torró](https://github.com/elenatorro)).
* Исправлена логическая ошибка в JOIN с движком таблицы `Join` в правой части, если используется `USING`. [#43963](https://github.com/ClickHouse/ClickHouse/pull/43963) ([Vladimir C](https://github.com/vdimir)). Исправлена ошибка неправильного порядка ключей в движке таблицы `Join`. [#44012](https://github.com/ClickHouse/ClickHouse/pull/44012) ([Vladimir C](https://github.com/vdimir)).
* Исправление в Keeper: генерировать исключение, если межсерверный порт Raft уже занят. [#43984](https://github.com/ClickHouse/ClickHouse/pull/43984) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена обработка позиционного аргумента ORDER BY (пример: `ORDER BY 1, 2`) в случае удаления ненужных столбцов в подзапросах. Закрывает [#43964](https://github.com/ClickHouse/ClickHouse/issues/43964). [#43987](https://github.com/ClickHouse/ClickHouse/pull/43987) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено исключение, возникавшее, когда подзапрос содержал HAVING, но не содержал реальной агрегации. [#44051](https://github.com/ClickHouse/ClickHouse/pull/44051) ([Nikita Taranov](https://github.com/nickitat)).
* Устранена гонка данных при многочастичной загрузке в S3. Эта проблема могла приводить к ошибке `Part number must be an integer between 1 and 10000, inclusive. (S3_ERROR)` при восстановлении из резервной копии. [#44065](https://github.com/ClickHouse/ClickHouse/pull/44065) ([Vitaly Baranov](https://github.com/vitlibar)).

### <a id="2211"></a> ClickHouse release 22.11, 2022-11-17 {#a-id2211a-clickhouse-release-2211-2022-11-17}

#### Обратно несовместимое изменение {#backward-incompatible-change}

- Семейство функций `JSONExtract` теперь будет пытаться привести к запрашиваемому типу. [#41502](https://github.com/ClickHouse/ClickHouse/pull/41502) ([Márcio Martins](https://github.com/marcioapm)).


#### Новая функциональность {#new-feature-1}

- Добавлена поддержка повторных попыток при выполнении INSERT в ReplicatedMergeTree в случае потери сессии с ClickHouse Keeper. Помимо отказоустойчивости, это улучшает пользовательский опыт — позволяет избежать возврата ошибки пользователю во время вставки при перезапуске Keeper (например, при обновлении). [#42607](https://github.com/ClickHouse/ClickHouse/pull/42607) ([Igor Nikonov](https://github.com/devcrafter)).
- Добавлены движки таблиц `Hudi` и `DeltaLake`, только для чтения, только для таблиц на S3. [#41054](https://github.com/ClickHouse/ClickHouse/pull/41054) ([Daniil Rubin](https://github.com/rubin-do), [Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлены табличные функции `hudi` и `deltaLake`. [#43080](https://github.com/ClickHouse/ClickHouse/pull/43080) ([flynn](https://github.com/ucasfl)).
- Поддержка составных временных интервалов. 1. Операции сложения, вычитания и отрицания теперь доступны для интервалов. Если типы интервалов различаются, они будут преобразованы в кортеж этих типов. 2. Кортеж интервалов может быть добавлен к полю Date/DateTime или вычтен из него. 3. Добавлен парсинг интервалов с различными типами, например: `INTERVAL '1 HOUR 1 MINUTE 1 SECOND'`. [#42195](https://github.com/ClickHouse/ClickHouse/pull/42195) ([Nikolay Degterinsky](https://github.com/evillique)).
- Добавлена поддержка glob-шаблона `**` для рекурсивного обхода директорий в файловой системе и S3. Решает [#36316](https://github.com/ClickHouse/ClickHouse/issues/36316). [#42376](https://github.com/ClickHouse/ClickHouse/pull/42376) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Представлен тип диска `s3_plain` для операций однократной записи и многократного чтения. Реализована операция `ATTACH` таблицы `MergeTree` для диска `s3_plain`. [#42628](https://github.com/ClickHouse/ClickHouse/pull/42628) ([Azat Khuzhin](https://github.com/azat)).
- Добавлена информация о примененных политиках на уровне строк в `system.query_log`. [#39819](https://github.com/ClickHouse/ClickHouse/pull/39819) ([Vladimir Chebotaryov](https://github.com/quickhouse)).
- Добавлена четырехбуквенная команда `csnp` для ручного создания снимков в ClickHouse Keeper. Дополнительно добавлена команда `lgif` для получения информации Raft для конкретного узла (например, индекс последнего созданного снимка, индекс последней зафиксированной записи в логе). [#41766](https://github.com/ClickHouse/ClickHouse/pull/41766) ([JackyWoo](https://github.com/JackyWoo)).
- Добавлена функция `ascii`, аналогичная функции в Apache Spark: https://spark.apache.org/docs/latest/api/sql/#ascii. [#42670](https://github.com/ClickHouse/ClickHouse/pull/42670) ([李扬](https://github.com/taiyang-li)).
- Добавлена функция `pmod`, которая возвращает неотрицательный результат на основе операции взятия остатка от деления. [#42755](https://github.com/ClickHouse/ClickHouse/pull/42755) ([李扬](https://github.com/taiyang-li)).
- Добавлена функция `formatReadableDecimalSize`. [#42774](https://github.com/ClickHouse/ClickHouse/pull/42774) ([Alejandro](https://github.com/alexon1234)).
- Добавлена функция `randCanonical`, аналогичная функции `rand` в Apache Spark или Impala. Функция генерирует псевдослучайные значения, независимые и одинаково распределенные равномерно в диапазоне [0, 1). [#43124](https://github.com/ClickHouse/ClickHouse/pull/43124) ([李扬](https://github.com/taiyang-li)).
- Добавлена функция `displayName`, закрывает [#36770](https://github.com/ClickHouse/ClickHouse/issues/36770). [#37681](https://github.com/ClickHouse/ClickHouse/pull/37681) ([hongbin](https://github.com/xlwh)).
- Добавлена настройка `min_age_to_force_merge_on_partition_only` для оптимизации старых кусков только для всей партиции целиком. [#42659](https://github.com/ClickHouse/ClickHouse/pull/42659) ([Antonio Andelic](https://github.com/antonio2368)).
- Добавлена универсальная реализация для произвольных структурированных именованных коллекций, типа доступа и `system.named_collections`. [#43147](https://github.com/ClickHouse/ClickHouse/pull/43147) ([Kseniia Sumarokova](https://github.com/kssenii)).

#### Улучшение производительности {#performance-improvement-1}

- Функция `match` может использовать индекс, если это условие на префикс строки. Закрывает [#37333](https://github.com/ClickHouse/ClickHouse/issues/37333). [#42458](https://github.com/ClickHouse/ClickHouse/pull/42458) ([clarkcaoliu](https://github.com/Clark0)).
- Ускорение операторов AND и OR при их последовательном использовании. [#42214](https://github.com/ClickHouse/ClickHouse/pull/42214) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
- Поддержка параллельного разбора для входного формата `LineAsString`. Незначительно улучшает производительность. Закрывает [#42502](https://github.com/ClickHouse/ClickHouse/issues/42502). [#42780](https://github.com/ClickHouse/ClickHouse/pull/42780) ([Kruglov Pavel](https://github.com/Avogar)).
- Улучшение производительности ClickHouse Keeper: улучшена производительность фиксации для случаев, когда множество различных узлов имеют незафиксированные состояния. Это должно помочь в случаях, когда узел-последователь не может синхронизироваться достаточно быстро. [#42926](https://github.com/ClickHouse/ClickHouse/pull/42926) ([Antonio Andelic](https://github.com/antonio2368)).
- Условие вида `NOT LIKE 'prefix%'` может использовать первичный индекс. [#42209](https://github.com/ClickHouse/ClickHouse/pull/42209) ([Duc Canh Le](https://github.com/canhld94)).

#### Экспериментальная функциональность {#experimental-feature-1}

- Поддержка типа `Object` внутри других типов, например `Array(JSON)`. [#36969](https://github.com/ClickHouse/ClickHouse/pull/36969) ([Anton Popov](https://github.com/CurtizJ)).
- Игнорирование события SAVEPOINT из MySQL binlog для MaterializedMySQL. [#42931](https://github.com/ClickHouse/ClickHouse/pull/42931) ([zzsmdfj](https://github.com/zzsmdfj)). Обработка (игнорирование) запросов SAVEPOINT в MaterializedMySQL. [#43086](https://github.com/ClickHouse/ClickHouse/pull/43086) ([Stig Bakken](https://github.com/stigsb)).


#### Улучшения {#improvement-1}

- Тривиальные запросы с небольшим LIMIT теперь правильно определяют количество строк для чтения, благодаря чему порог проверяется корректно. Закрывает [#7071](https://github.com/ClickHouse/ClickHouse/issues/7071). [#42580](https://github.com/ClickHouse/ClickHouse/pull/42580) ([Han Fei](https://github.com/hanfei1991)).
- Добавлена поддержка интерактивных параметров в запросах INSERT VALUES. [#43077](https://github.com/ClickHouse/ClickHouse/pull/43077) ([Nikolay Degterinsky](https://github.com/evillique)).
- Добавлено новое поле `allow_readonly` в `system.table_functions` для использования табличных функций в режиме только для чтения. Решает [#42414](https://github.com/ClickHouse/ClickHouse/issues/42414) Реализация: _ Добавлено новое поле allow_readonly в таблицу system.table_functions. _ Обновлено для использования нового поля allow_readonly, позволяющего использовать табличные функции в режиме только для чтения. Тестирование: _ Добавлен тест для файловой системы tests/queries/0_stateless/02473_functions_in_readonly_mode.sh Документация: _ Обновлена английская документация для табличных функций. [#42708](https://github.com/ClickHouse/ClickHouse/pull/42708) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Таблица `system.asynchronous_metrics` получила встроенную документацию. Эта документация также экспортируется в Prometheus. Исправлена ошибка с метриками дисков `cache` — они рассчитывались только для одного произвольного кэш-диска вместо всех. Закрывает [#7644](https://github.com/ClickHouse/ClickHouse/issues/7644). [#43194](https://github.com/ClickHouse/ClickHouse/pull/43194) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Алгоритм регулирования изменен на алгоритм корзины токенов (token bucket). [#42665](https://github.com/ClickHouse/ClickHouse/pull/42665) ([Sergei Trifonov](https://github.com/serxa)).
- Маскировка паролей и секретных ключей в `system.query_log` и `/var/log/clickhouse-server/*.log`, а также в сообщениях об ошибках. [#42484](https://github.com/ClickHouse/ClickHouse/pull/42484) ([Vitaly Baranov](https://github.com/vitlibar)).
- Удаление покрытых частей для полученной части (для предотвращения возможного увеличения задержки репликации). [#39737](https://github.com/ClickHouse/ClickHouse/pull/39737) ([Azat Khuzhin](https://github.com/azat)).
- Если доступен `/dev/tty`, прогресс в clickhouse-client и clickhouse-local будет отображаться непосредственно в терминале без записи в STDERR. Это позволяет получать информацию о прогрессе, даже если STDERR перенаправлен в файл, при этом файл не будет загрязнен управляющими последовательностями терминала. Прогресс можно отключить с помощью `--progress false`. Закрывает [#32238](https://github.com/ClickHouse/ClickHouse/issues/32238). [#42003](https://github.com/ClickHouse/ClickHouse/pull/42003) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлена поддержка входных данных типа `FixedString` для функций кодирования base64. [#42285](https://github.com/ClickHouse/ClickHouse/pull/42285) ([ltrk2](https://github.com/ltrk2)).
- Добавлены столбцы `bytes_on_disk` и `path` в `system.detached_parts`. Закрывает [#42264](https://github.com/ClickHouse/ClickHouse/issues/42264). [#42303](https://github.com/ClickHouse/ClickHouse/pull/42303) ([chen](https://github.com/xiedeyantu)).
- Улучшено использование структуры из таблицы вставки в табличных функциях. Теперь настройка `use_structure_from_insertion_table_in_table_functions` имеет новое возможное значение — `2`, что означает, что ClickHouse попытается автоматически определить, можно ли использовать структуру из таблицы вставки. Закрывает [#40028](https://github.com/ClickHouse/ClickHouse/issues/40028). [#42320](https://github.com/ClickHouse/ClickHouse/pull/42320) ([Kruglov Pavel](https://github.com/Avogar)).
- Исправлено отсутствие индикации прогресса при INSERT FROM INFILE. Закрывает [#42548](https://github.com/ClickHouse/ClickHouse/issues/42548). [#42634](https://github.com/ClickHouse/ClickHouse/pull/42634) ([chen](https://github.com/xiedeyantu)).
- Рефакторинг функции `tokens` для включения максимального количества возвращаемых токенов для связанных функций (по умолчанию отключено). [#42673](https://github.com/ClickHouse/ClickHouse/pull/42673) ([李扬](https://github.com/taiyang-li)).
- Разрешено использование аргументов типа `Date32` для функций `formatDateTime` и `FROM_UNIXTIME`. [#42737](https://github.com/ClickHouse/ClickHouse/pull/42737) ([Roman Vasin](https://github.com/rvasin)).
- Обновление tzdata до версии 2022f. Мексика больше не будет переходить на летнее время, за исключением районов вблизи границы с США: https://www.timeanddate.com/news/time/mexico-abolishes-dst-2022.html. Чиуауа переходит на круглогодичный UTC-6 с 30 октября 2022 года. Фиджи больше не переходит на летнее время. См. https://github.com/google/cctz/pull/235 и https://bugs.launchpad.net/ubuntu/+source/tzdata/+bug/1995209. [#42796](https://github.com/ClickHouse/ClickHouse/pull/42796) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлена метрика события `FailedAsyncInsertQuery` для асинхронных вставок. [#42814](https://github.com/ClickHouse/ClickHouse/pull/42814) ([Krzysztof Góralski](https://github.com/kgoralski)).
- Реализована оптимизация `read-in-order` на основе плана запроса. Она включена по умолчанию. Установите `query_plan_read_in_order = 0` для использования предыдущей версии на основе AST. [#42829](https://github.com/ClickHouse/ClickHouse/pull/42829) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Экспоненциальное увеличение размера загружаемой части для резервного копирования в S3 для предотвращения ошибок, связанных с ограничением в 10 000 частей при многочастной загрузке в S3. [#42833](https://github.com/ClickHouse/ClickHouse/pull/42833) ([Vitaly Baranov](https://github.com/vitlibar)).
- Когда задача слияния постоянно занята и дискового пространства недостаточно, полностью истекшие части не могут быть выбраны и удалены, что приводит к нехватке дискового пространства. Идея заключается в том, что когда вся часть истекает, нет необходимости гарантировать дополнительное дисковое пространство для обеспечения нормального выполнения TTL. [#42869](https://github.com/ClickHouse/ClickHouse/pull/42869) ([zhongyuankai](https://github.com/zhongyuankai)).
- Добавлены функция `oss` и движок таблиц `OSS` (это удобно для пользователей). OSS полностью совместим с S3. [#43155](https://github.com/ClickHouse/ClickHouse/pull/43155) ([zzsmdfj](https://github.com/zzsmdfj)).
- Улучшена отчетность об ошибках при сборе информации, связанной с ОС, для таблицы `system.asynchronous_metrics`. [#43192](https://github.com/ClickHouse/ClickHouse/pull/43192) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Изменены таблицы `INFORMATION_SCHEMA` таким образом, чтобы ClickHouse мог подключаться к самому себе с использованием протокола совместимости с MySQL. Добавлены столбцы вместо псевдонимов (связано с [#9769](https://github.com/ClickHouse/ClickHouse/issues/9769)). Это улучшит совместимость с различными клиентами MySQL. [#43198](https://github.com/ClickHouse/ClickHouse/pull/43198) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
- Добавлены некоторые функции для совместимости с PowerBI при подключении через протокол MySQL [#42612](https://github.com/ClickHouse/ClickHouse/pull/42612) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
- Улучшено удобство использования панели управления при изменениях [#42872](https://github.com/ClickHouse/ClickHouse/pull/42872) ([Vladimir C](https://github.com/vdimir)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-1}

- Запуск SQLancer для каждого pull request и коммита в master. [SQLancer](https://github.com/sqlancer/sqlancer) — это фаззер с открытым исходным кодом, ориентированный на автоматическое обнаружение логических ошибок. [#42397](https://github.com/ClickHouse/ClickHouse/pull/42397) ([Ilya Yatsishin](https://github.com/qoega)).
- Обновление до последней версии zlib-ng. [#42463](https://github.com/ClickHouse/ClickHouse/pull/42463) ([Boris Kuschel](https://github.com/bkuschel)).
- Добавлена поддержка тестирования сервера ClickHouse с помощью Jepsen. Кстати, у нас уже есть поддержка тестирования ClickHouse Keeper с помощью Jepsen. Этот pull request расширяет её на реплицируемые таблицы. [#42619](https://github.com/ClickHouse/ClickHouse/pull/42619) ([Antonio Andelic](https://github.com/antonio2368)).
- Использование https://github.com/matus-chochlik/ctcache для кэширования результатов clang-tidy. [#42913](https://github.com/ClickHouse/ClickHouse/pull/42913) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- До исправления пользовательская конфигурация сохранялась RPM в `$file.rpmsave`. Данный PR исправляет это и больше не будет заменять пользовательские файлы из пакетов. [#42936](https://github.com/ClickHouse/ClickHouse/pull/42936) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Удаление некоторых библиотек из Docker-образа Ubuntu. [#42622](https://github.com/ClickHouse/ClickHouse/pull/42622) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### Исправление ошибок (видимое пользователю некорректное поведение в официальном стабильном или предварительном релизе) {#bug-fix-user-visible-misbehavior-in-official-stable-or-prestable-release-1}


* Обновлён нормализатор для клонирования AST-узла алиаса. Исправляет [#42452](https://github.com/ClickHouse/ClickHouse/issues/42452). Реализация: * Обновлён `QueryNormalizer` для клонирования AST-узла алиаса при его замене. Ранее простое присваивание того же узла приводило к исключению в `LogicalExpressinsOptimizer`, так как тот же родительский узел вставлялся повторно. * Эта ошибка не проявляется с новым анализатором (`allow&#95;experimental&#95;analyzer`), поэтому для него изменений нет. Добавлен тест для этого случая. [#42827](https://github.com/ClickHouse/ClickHouse/pull/42827) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
* Исправлена гонка состояний при создании резервных копий таблиц в базах данных `Lazy`. [#43104](https://github.com/ClickHouse/ClickHouse/pull/43104) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен `skip_unavailable_shards`: он не работал с табличной функцией `s3Cluster`. [#43131](https://github.com/ClickHouse/ClickHouse/pull/43131) ([chen](https://github.com/xiedeyantu)).
* Исправлено определение схемы в `s3Cluster` и выполнены улучшения в `hdfsCluster`. [#41979](https://github.com/ClickHouse/ClickHouse/pull/41979) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлены повторные попытки при чтении из движков таблиц URL / табличной функции (ошибки, допускающие повтор, могли приводить к большему количеству повторных попыток, чем требовалось, а ошибки, не допускающие повтор, приводили к аварийному срабатыванию assert в коде). [#42224](https://github.com/ClickHouse/ClickHouse/pull/42224) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Была обнаружена и исправлена ошибка сегментации, связанная с DNS и c-ares. [#42234](https://github.com/ClickHouse/ClickHouse/pull/42234) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлена ошибка `LOGICAL_ERROR` `Arguments of 'plus' have incorrect data types`, которая могла возникать при анализе PK (проверка монотонности). Исправлен некорректный анализ PK для монотонных бинарных функций с первым аргументом-константой. [#42410](https://github.com/ClickHouse/ClickHouse/pull/42410) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлен некорректный анализ ключей в случаях, когда типы ключей не могут быть Nullable. Это устраняет [#42456](https://github.com/ClickHouse/ClickHouse/issues/42456). [#42469](https://github.com/ClickHouse/ClickHouse/pull/42469) ([Amos Bird](https://github.com/amosbird)).
* Исправлена опечатка в имени настройки, из-за которой некорректно использовался кэш автоматического определения схемы при использовании настройки `input_format_csv_use_best_effort_in_schema_inference`. Закрывает [#41735](https://github.com/ClickHouse/ClickHouse/issues/41735). [#42536](https://github.com/ClickHouse/ClickHouse/pull/42536) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено создание Set с некорректным заголовком для типа данных LowCardinality. Закрывает [#42460](https://github.com/ClickHouse/ClickHouse/issues/42460). [#42579](https://github.com/ClickHouse/ClickHouse/pull/42579) ([flynn](https://github.com/ucasfl)).
* Значения `(U)Int128` и `(U)Int256` стали корректно проверяться в `PREWHERE`. [#42605](https://github.com/ClickHouse/ClickHouse/pull/42605) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка в парсере функций, которая могла приводить к ошибке сегментации памяти. [#42724](https://github.com/ClickHouse/ClickHouse/pull/42724) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена работа блокировок в `TRUNCATE TABLE`. [#42728](https://github.com/ClickHouse/ClickHouse/pull/42728) ([flynn](https://github.com/ucasfl)).
* Исправлено возможное падение при работе с дисками `web`, возникавшее при отсутствии файла (или при выполнении `OPTIMIZE TABLE FINAL`, которое также могло приводить к той же ошибке). [#42767](https://github.com/ClickHouse/ClickHouse/pull/42767) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено сопоставление `auth_type` в `system.session_log` за счёт добавления значения `SSL_CERTIFICATE` в перечисление. [#42782](https://github.com/ClickHouse/ClickHouse/pull/42782) ([Miel Donkers](https://github.com/mdonkers)).
* Исправлена проблема stack-use-after-return при сборке с ASan в парсере запроса CREATE USER. [#42804](https://github.com/ClickHouse/ClickHouse/pull/42804) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена ошибка в работе `lowerUTF8`/`upperUTF8` в случае, когда символ пересекает 16-байтную границу (очень частая ситуация, если строки длиннее 16 байт). [#42812](https://github.com/ClickHouse/ClickHouse/pull/42812) ([Azat Khuzhin](https://github.com/azat)).
* В процедуру декомпрессии LZ4 была добавлена дополнительная проверка границ для исправления некорректного поведения в случае повреждённых входных данных. [#42868](https://github.com/ClickHouse/ClickHouse/pull/42868) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлено редкое возможное зависание при отмене запроса. [#42874](https://github.com/ClickHouse/ClickHouse/pull/42874) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено некорректное поведение при использовании нескольких дизъюнктивных условий в хеш-соединении, закрыт [#42832](https://github.com/ClickHouse/ClickHouse/issues/42832). [#42876](https://github.com/ClickHouse/ClickHouse/pull/42876) ([Vladimir C](https://github.com/vdimir)).
* Нулевой указатель создаётся при выполнении `select if as from 'three table join'`. Например, для следующего SQL‑запроса: [#42883](https://github.com/ClickHouse/ClickHouse/pull/42883) ([zzsmdfj](https://github.com/zzsmdfj)).
* Исправлен отчёт санитайзера памяти в Cluster Discovery, закрыта задача [#42763](https://github.com/ClickHouse/ClickHouse/issues/42763). [#42905](https://github.com/ClickHouse/ClickHouse/pull/42905) ([Vladimir C](https://github.com/vdimir)).
* Улучшено определение схемы DateTime в случае пустой строки. [#42911](https://github.com/ClickHouse/ClickHouse/pull/42911) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена редкая ошибка NOT&#95;FOUND&#95;COLUMN&#95;IN&#95;BLOCK, возникавшая, когда проекцию можно использовать, но проекция отсутствует. Это исправляет [#42771](https://github.com/ClickHouse/ClickHouse/issues/42771). Ошибка была внесена в [https://github.com/ClickHouse/ClickHouse/pull/25563](https://github.com/ClickHouse/ClickHouse/pull/25563). [#42938](https://github.com/ClickHouse/ClickHouse/pull/42938) ([Amos Bird](https://github.com/amosbird)).
* Исправлена операция `ATTACH TABLE` в движке базы данных `PostgreSQL` для таблиц, содержащих тип данных DATETIME. Закрывает [#42817](https://github.com/ClickHouse/ClickHouse/issues/42817). [#42960](https://github.com/ClickHouse/ClickHouse/pull/42960) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен разбор лямбда-выражений. Закрывает [#41848](https://github.com/ClickHouse/ClickHouse/issues/41848). [#42979](https://github.com/ClickHouse/ClickHouse/pull/42979) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлен некорректный анализ ключей, когда Nullable-ключи находятся в середине гиперпрямоугольника. Это исправляет [#43111](https://github.com/ClickHouse/ClickHouse/issues/43111). [#43133](https://github.com/ClickHouse/ClickHouse/pull/43133) ([Amos Bird](https://github.com/amosbird)).
* Исправлены несколько случаев чтения за пределы буфера при десериализации специально подготовленных состояний агрегатных функций. [#43159](https://github.com/ClickHouse/ClickHouse/pull/43159) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлена работа функции `if` для аргументов NULL и константных Nullable. Закрывает [#43069](https://github.com/ClickHouse/ClickHouse/issues/43069). [#43178](https://github.com/ClickHouse/ClickHouse/pull/43178) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено переполнение десятичной арифметики при разборе DateTime с использованием алгоритма &#39;best effort&#39;. Закрывает [#43061](https://github.com/ClickHouse/ClickHouse/issues/43061). [#43180](https://github.com/ClickHouse/ClickHouse/pull/43180) ([Kruglov Pavel](https://github.com/Avogar)).
* Поле `indent`, создаваемое инструментом `git-import`, вычислялось некорректно. См. [https://clickhouse.com/docs/getting-started/example-datasets/github/](https://clickhouse.com/docs/getting-started/example-datasets/github/). [#43191](https://github.com/ClickHouse/ClickHouse/pull/43191) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено неожиданное поведение типов данных `Interval` в подзапросах и при приведении типов. [#43193](https://github.com/ClickHouse/ClickHouse/pull/43193) ([jh0x](https://github.com/jh0x)).

### <a id="2210"></a> Релиз ClickHouse 22.10, 2022-10-25 {#a-id2210a-clickhouse-release-2210-2022-10-25}

#### Обратно несовместимые изменения {#backward-incompatible-change-1}

- Переименованы команды для работы с кешем: `show caches` -> `show filesystem caches`, `describe cache` -> `describe filesystem cache`. [#41508](https://github.com/ClickHouse/ClickHouse/pull/41508) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Удалена поддержка секции `WITH TIMEOUT` для `LIVE VIEW`. Закрывает issue [#40557](https://github.com/ClickHouse/ClickHouse/issues/40557). [#42173](https://github.com/ClickHouse/ClickHouse/pull/42173) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Удалена поддержка макроса `{database}` в приглашении командной строки клиента. Он отображался некорректно, если база данных не была указана, и не обновлялся при выполнении команд `USE`. Закрывает issue [#25891](https://github.com/ClickHouse/ClickHouse/issues/25891). [#42508](https://github.com/ClickHouse/ClickHouse/pull/42508) ([Alexey Milovidov](https://github.com/alexey-milovidov)).


#### Новая функциональность {#new-feature-2}

- Добавлена композируемая конфигурация протоколов. Теперь различные протоколы могут быть настроены с разными хостами для прослушивания. Обёртки протоколов, такие как PROXYv1, могут быть настроены поверх любых других протоколов (TCP, TCP secure, MySQL, Postgres). [#41198](https://github.com/ClickHouse/ClickHouse/pull/41198) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Добавлен `S3` в качестве нового типа назначения для резервных копий. Поддержка BACKUP в S3 с сохранением исходной структуры путей/данных. [#42333](https://github.com/ClickHouse/ClickHouse/pull/42333) ([Vitaly Baranov](https://github.com/vitlibar)), [#42232](https://github.com/ClickHouse/ClickHouse/pull/42232) ([Azat Khuzhin](https://github.com/azat)).
- Добавлены функции (`randUniform`, `randNormal`, `randLogNormal`, `randExponential`, `randChiSquared`, `randStudentT`, `randFisherF`, `randBernoulli`, `randBinomial`, `randNegativeBinomial`, `randPoisson`) для генерации случайных значений в соответствии с заданными распределениями. Закрывает [#21834](https://github.com/ClickHouse/ClickHouse/issues/21834). [#42411](https://github.com/ClickHouse/ClickHouse/pull/42411) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Улучшение для ClickHouse Keeper: добавлена поддержка загрузки снимков в S3. Информация о S3 может быть определена в `keeper_server.s3_snapshot`. [#41342](https://github.com/ClickHouse/ClickHouse/pull/41342) ([Antonio Andelic](https://github.com/antonio2368)).
- Добавлена агрегатная функция `analysisOfVariance` (`anova`) для выполнения статистического теста над несколькими группами нормально распределённых наблюдений с целью определения, имеют ли все группы одинаковое среднее значение. Исходный PR [#37872](https://github.com/ClickHouse/ClickHouse/issues/37872). [#42131](https://github.com/ClickHouse/ClickHouse/pull/42131) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Поддержка ограничения временных данных, хранящихся на диске, с помощью настроек `max_temporary_data_on_disk_size_for_user`/`max_temporary_data_on_disk_size_for_query`. [#40893](https://github.com/ClickHouse/ClickHouse/pull/40893) ([Vladimir C](https://github.com/vdimir)).
- Добавлена настройка `format_json_object_each_row_column_for_object_name` для записи/парсинга имени объекта в качестве значения столбца в формате JSONObjectEachRow. [#41703](https://github.com/ClickHouse/ClickHouse/pull/41703) ([Kruglov Pavel](https://github.com/Avogar)).
- Добавлена хеш-функция BLAKE3 в SQL. [#33435](https://github.com/ClickHouse/ClickHouse/pull/33435) ([BoloniniD](https://github.com/BoloniniD)).
- Функция `javaHash` расширена для работы с целыми числами. [#41131](https://github.com/ClickHouse/ClickHouse/pull/41131) ([JackyWoo](https://github.com/JackyWoo)).
- Добавлена поддержка OpenTelemetry для ON CLUSTER DDL (требуется установить `distributed_ddl_entry_format_version` в значение 4). [#41484](https://github.com/ClickHouse/ClickHouse/pull/41484) ([Frank Chen](https://github.com/FrankChen021)).
- Добавлена системная таблица `asynchronous_insert_log`. Она содержит информацию об асинхронных вставках (включая результаты запросов в режиме fire-and-forget (с `wait_for_async_insert=0`)) для улучшенной интроспекции. [#42040](https://github.com/ClickHouse/ClickHouse/pull/42040) ([Anton Popov](https://github.com/CurtizJ)).
- Добавлена поддержка методов `lz4`, `bz2`, `snappy` в HTTP-заголовке `Accept-Encoding`, что является нестандартным расширением протокола HTTP. [#42071](https://github.com/ClickHouse/ClickHouse/pull/42071) ([Nikolay Degterinsky](https://github.com/evillique)).
- Добавлены функции кодирования/декодирования Morton Coding (ZCurve). [#41753](https://github.com/ClickHouse/ClickHouse/pull/41753) ([Constantine Peresypkin](https://github.com/pkit)).
- Добавлена поддержка `SET setting_name = DEFAULT`. [#42187](https://github.com/ClickHouse/ClickHouse/pull/42187) ([Filatenkov Artur](https://github.com/FArthur-cmd)).

#### Экспериментальная функциональность {#experimental-feature-2}

- Добавлена новая инфраструктура для анализа и планирования запросов в рамках настройки `allow_experimental_analyzer`. [#31796](https://github.com/ClickHouse/ClickHouse/pull/31796) ([Maksim Kita](https://github.com/kitaisreal)).
- Начальная реализация языка запросов Kusto. Пожалуйста, не используйте её. [#37961](https://github.com/ClickHouse/ClickHouse/pull/37961) ([Yong Wang](https://github.com/kashwy)).

#### Улучшение производительности {#performance-improvement-2}

- Смягчён порог «Слишком много частей». Это закрывает [#6551](https://github.com/ClickHouse/ClickHouse/issues/6551). Теперь ClickHouse будет допускать больше частей в партиции, если средний размер части достаточно велик (не менее 10 ГиБ). Это позволяет хранить до петабайтов данных в одной партиции одной таблицы на одном сервере, что возможно при использовании дисковых полок или объектного хранилища. [#42002](https://github.com/ClickHouse/ClickHouse/pull/42002) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Реализован парсер элементов с учётом приоритета операторов для уменьшения требуемого размера стека. [#34892](https://github.com/ClickHouse/ClickHouse/pull/34892) ([Nikolay Degterinsky](https://github.com/evillique)).
- Оптимизация DISTINCT с учётом порядка использует свойства сортировки потоков данных. Это улучшение позволит выполнять чтение с сохранением порядка для DISTINCT, если применимо (ранее было необходимо указывать ORDER BY для столбцов в DISTINCT). [#41014](https://github.com/ClickHouse/ClickHouse/pull/41014) ([Igor Nikonov](https://github.com/devcrafter)).
- ColumnVector: оптимизирован индекс UInt8 с использованием AVX512VBMI. [#41247](https://github.com/ClickHouse/ClickHouse/pull/41247) ([Guo Wangyang](https://github.com/guowangy)).
- Оптимизированы конфликты блокировок для `ThreadGroupStatus::mutex`. Эксперименты по производительности **SSB** (Star Schema Benchmark) на устройстве ICX (Intel Xeon Platinum 8380 CPU, 80 ядер, 160 потоков) показывают, что это изменение может обеспечить улучшение среднего геометрического QPS всех подслучаев в **2,95 раза**. [#41675](https://github.com/ClickHouse/ClickHouse/pull/41675) ([Zhiguo Zhou](https://github.com/ZhiguoZh)).
- Добавлены возможности `ldapr` в сборки AArch64. Это поддерживается начиная с Graviton 2+, экземпляров Azure и GCP. Появилось в clang-15 [не так давно](https://github.com/llvm/llvm-project/commit/9609b5daffe9fd28d83d83da895abc5113f76c24). [#41778](https://github.com/ClickHouse/ClickHouse/pull/41778) ([Daniel Kutenin](https://github.com/danlark1)).
- Улучшена производительность при сравнении строк, когда один из аргументов является пустой константной строкой. [#41870](https://github.com/ClickHouse/ClickHouse/pull/41870) ([Jiebin Sun](https://github.com/jiebinn)).
- Оптимизирован `insertFrom` для ColumnAggregateFunction для совместного использования агрегатного состояния в некоторых случаях. [#41960](https://github.com/ClickHouse/ClickHouse/pull/41960) ([flynn](https://github.com/ucasfl)).
- Ускорена запись на диски `azure_blob_storage` (учитывается `max_single_part_upload_size` вместо записи блока для каждого размера буфера). Неэффективность упомянута в [#41754](https://github.com/ClickHouse/ClickHouse/issues/41754). [#42041](https://github.com/ClickHouse/ClickHouse/pull/42041) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Идентификаторы потоков в списке процессов и query_log сделаны уникальными для предотвращения потерь. [#42180](https://github.com/ClickHouse/ClickHouse/pull/42180) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлена поддержка полного пропуска кеша (как загрузки в кеш, так и чтения кешированных данных) в случае, если запрошенный диапазон чтения превышает порог, определённый настройкой кеша `bypass_cache_threashold`; требует включения с помощью `enable_bypass_cache_with_threshold`. [#42418](https://github.com/ClickHouse/ClickHouse/pull/42418) ([Han Shukai](https://github.com/KinderRiven)). Это помогает при работе с медленными локальными дисками.


#### Улучшение {#improvement-2}

- Добавлена настройка `allow_implicit_no_password`: в сочетании с `allow_no_password` запрещает создание пользователя без пароля, если явно не указано `IDENTIFIED WITH no_password`. [#41341](https://github.com/ClickHouse/ClickHouse/pull/41341) ([Nikolay Degterinsky](https://github.com/evillique)).
- Встроенный Keeper теперь всегда запускается в фоновом режиме, позволяя ClickHouse запускаться без достижения кворума. [#40991](https://github.com/ClickHouse/ClickHouse/pull/40991) ([Antonio Andelic](https://github.com/antonio2368)).
- Улучшена реактивность восстановления нового соединения с ZooKeeper в случае истечения срока действия предыдущего. Ранее задача запускалась каждую минуту по умолчанию, и таким образом таблица могла находиться в режиме только для чтения примерно в течение этого времени. [#41092](https://github.com/ClickHouse/ClickHouse/pull/41092) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Теперь проекции можно использовать с репликацией с нулевым копированием (репликация с нулевым копированием является экспериментальной функцией). [#41147](https://github.com/ClickHouse/ClickHouse/pull/41147) ([alesapin](https://github.com/alesapin)).
- Добавлена поддержка выражения `(EXPLAIN SELECT ...)` в подзапросе. Запросы вида `SELECT * FROM (EXPLAIN PIPELINE SELECT col FROM TABLE ORDER BY col)` стали допустимыми. [#40630](https://github.com/ClickHouse/ClickHouse/pull/40630) ([Vladimir C](https://github.com/vdimir)).
- Разрешено изменение `async_insert_max_data_size` или `async_insert_busy_timeout_ms` в области видимости запроса. Например, пользователь хочет вставлять данные редко и не имеет доступа к конфигурации сервера для настройки параметров по умолчанию. [#40668](https://github.com/ClickHouse/ClickHouse/pull/40668) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Улучшения для чтения из удаленных файловых систем, размер пула потоков для чтения/записи теперь настраивается. Закрывает [#41070](https://github.com/ClickHouse/ClickHouse/issues/41070). [#41011](https://github.com/ClickHouse/ClickHouse/pull/41011) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлена поддержка всех комбинаций комбинаторов в WindowTransform/arratReduce\*/initializeAggregation/версионировании агрегатных функций. Ранее комбинаторы типа `ForEach/Resample/Map` не работали в этих местах, их использование приводило к исключению вида `State function ... inserts results into non-state column`. [#41107](https://github.com/ClickHouse/ClickHouse/pull/41107) ([Kruglov Pavel](https://github.com/Avogar)).
- Добавлена функция `tryDecrypt`, которая возвращает NULL при неудачной расшифровке (например, расшифровка с неправильным ключом) вместо выброса исключения. [#41206](https://github.com/ClickHouse/ClickHouse/pull/41206) ([Duc Canh Le](https://github.com/canhld94)).
- Добавлен столбец `unreserved_space` в таблицу `system.disks` для проверки объема пространства, не занятого резервированиями, на каждом диске. [#41254](https://github.com/ClickHouse/ClickHouse/pull/41254) ([filimonov](https://github.com/filimonov)).
- Добавлена поддержка заголовков авторизации s3 в аргументах табличных функций. [#41261](https://github.com/ClickHouse/ClickHouse/pull/41261) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлена поддержка MultiRead в Keeper и внутреннем клиенте ZooKeeper (это расширение протокола ZooKeeper, доступное только в ClickHouse Keeper). [#41410](https://github.com/ClickHouse/ClickHouse/pull/41410) ([Antonio Andelic](https://github.com/antonio2368)).
- Добавлена поддержка сравнения типа decimal с литералом с плавающей точкой в операторе IN. [#41544](https://github.com/ClickHouse/ClickHouse/pull/41544) ([liang.huang](https://github.com/lhuang09287750)).
- Разрешены читаемые значения размера (например, `1TB`) в конфигурации кеша. [#41688](https://github.com/ClickHouse/ClickHouse/pull/41688) ([Kseniia Sumarokova](https://github.com/kssenii)).
- ClickHouse мог кешировать устаревшие DNS-записи в течение некоторого времени (15 секунд по умолчанию), пока кеш не будет обновлен асинхронно. В течение этих периодов ClickHouse тем не менее мог пытаться установить соединение и генерировать ошибки. Это поведение исправлено. [#41707](https://github.com/ClickHouse/ClickHouse/pull/41707) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Добавлен интерактивный поиск по истории с утилитой типа fzf (fzf/sk) для `clickhouse-client`/`clickhouse-local` (обратите внимание, что можно использовать `FZF_DEFAULT_OPTS`/`SKIM_DEFAULT_OPTIONS` для дополнительной настройки поведения). [#41730](https://github.com/ClickHouse/ClickHouse/pull/41730) ([Azat Khuzhin](https://github.com/azat)).
- Разрешено подключение клиентов к защищенному серверу с недействительным сертификатом только при использовании флага '--accept-certificate'. [#41743](https://github.com/ClickHouse/ClickHouse/pull/41743) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Добавлена функция `tryBase58Decode`, аналогичная существующей функции `tryBase64Decode`. [#41824](https://github.com/ClickHouse/ClickHouse/pull/41824) ([Robert Schulze](https://github.com/rschu1ze)).
- Улучшена обратная связь при замене партиции с другим первичным ключом. Исправляет [#34798](https://github.com/ClickHouse/ClickHouse/issues/34798). [#41838](https://github.com/ClickHouse/ClickHouse/pull/41838) ([Salvatore](https://github.com/tbsal)).
- Исправлен параллельный парсинг: сегментатор теперь проверяет `max_block_size`. Это исправило избыточное выделение памяти в случае параллельного парсинга и малого LIMIT. [#41852](https://github.com/ClickHouse/ClickHouse/pull/41852) ([Vitaly Baranov](https://github.com/vitlibar)).
- Исключение "TABLE_IS_DROPPED" больше не добавляется в `system.errors`, если оно произошло во время SELECT из системной таблицы и было проигнорировано. [#41908](https://github.com/ClickHouse/ClickHouse/pull/41908) ([AlfVII](https://github.com/AlfVII)).
- Улучшена опция `enable_extended_results_for_datetime_functions` для возврата результатов типа DateTime64 для функций `toStartOfDay`, `toStartOfHour`, `toStartOfFifteenMinutes`, `toStartOfTenMinutes`, `toStartOfFiveMinutes`, `toStartOfMinute` и `timeSlot`. [#41910](https://github.com/ClickHouse/ClickHouse/pull/41910) ([Roman Vasin](https://github.com/rvasin)).
- Улучшен вывод типа `DateTime` для текстовых форматов. Теперь учитывается настройка `date_time_input_format` и не происходит попытка вывести datetime из чисел как временные метки. Закрывает [#41389](https://github.com/ClickHouse/ClickHouse/issues/41389) Закрывает [#42206](https://github.com/ClickHouse/ClickHouse/issues/42206). [#41912](https://github.com/ClickHouse/ClickHouse/pull/41912) ([Kruglov Pavel](https://github.com/Avogar)).
- Удалено вводящее в заблуждение предупреждение при вставке с `perform_ttl_move_on_insert` = false. [#41980](https://github.com/ClickHouse/ClickHouse/pull/41980) ([Vitaly Baranov](https://github.com/vitlibar)).
- Разрешено пользователю писать `countState(*)` аналогично `count(*)`. Это закрывает [#9338](https://github.com/ClickHouse/ClickHouse/issues/9338). [#41983](https://github.com/ClickHouse/ClickHouse/pull/41983) ([Amos Bird](https://github.com/amosbird)).
- Исправлено переполнение размера `rankCorr`. [#42020](https://github.com/ClickHouse/ClickHouse/pull/42020) ([Duc Canh Le](https://github.com/canhld94)).
- Добавлена опция для указания произвольной строки в качестве имени окружения в конфигурации Sentry для более удобных отчетов. [#42037](https://github.com/ClickHouse/ClickHouse/pull/42037) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Исправлен парсинг Date вне диапазона из CSV. [#42044](https://github.com/ClickHouse/ClickHouse/pull/42044) ([Andrey Zvonov](https://github.com/zvonand)).
- `parseDataTimeBestEffort` теперь поддерживает запятую между датой и временем. Закрывает [#42038](https://github.com/ClickHouse/ClickHouse/issues/42038). [#42049](https://github.com/ClickHouse/ClickHouse/pull/42049) ([flynn](https://github.com/ucasfl)).
- Улучшен процесс восстановления устаревшей реплики для `ReplicatedMergeTree`. Если потерянная реплика имеет некоторые части, которые отсутствуют в здоровой реплике, но эти части должны появиться в будущем согласно очереди репликации здоровой реплики, то потерянная реплика сохранит такие части вместо их отсоединения. [#42134](https://github.com/ClickHouse/ClickHouse/pull/42134) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Добавлена возможность использования аргументов `Date32` для функции date_diff. Исправлена проблема в функции date_diff при использовании аргументов DateTime64 с начальной датой до эпохи Unix и конечной датой после эпохи Unix. [#42308](https://github.com/ClickHouse/ClickHouse/pull/42308) ([Roman Vasin](https://github.com/rvasin)).
- При загрузке больших частей в Minio операция 'Complete Multipart Upload' может занимать много времени. Minio отправляет heartbeat каждые 10 секунд (см. https://github.com/minio/minio/pull/7198). Но ClickHouse завершается по таймауту раньше, потому что таймаут отправки/получения по умолчанию [установлен](https://github.com/ClickHouse/ClickHouse/blob/cc24fcd6d5dfb67f5f66f5483e986bd1010ad9cf/src/IO/S3/PocoHTTPClient.cpp#L123) на 5 секунд. [#42321](https://github.com/ClickHouse/ClickHouse/pull/42321) ([filimonov](https://github.com/filimonov)).
- Исправлено редкое некорректное приведение типов состояния агрегатов со сложными типами, такими как Decimal. Это исправляет [#42408](https://github.com/ClickHouse/ClickHouse/issues/42408). [#42417](https://github.com/ClickHouse/ClickHouse/pull/42417) ([Amos Bird](https://github.com/amosbird)).
- Разрешено использование аргументов `Date32` для функции `dateName`. [#42554](https://github.com/ClickHouse/ClickHouse/pull/42554) ([Roman Vasin](https://github.com/rvasin)).
- Теперь фильтры с литералами NULL будут использоваться при анализе индексов. [#34063](https://github.com/ClickHouse/ClickHouse/issues/34063). [#41842](https://github.com/ClickHouse/ClickHouse/pull/41842) ([Amos Bird](https://github.com/amosbird)).
- Слияние частей, если каждая часть в диапазоне старше определенного порога. Порог можно установить с помощью `min_age_to_force_merge_seconds`. Это закрывает [#35836](https://github.com/ClickHouse/ClickHouse/issues/35836). [#42423](https://github.com/ClickHouse/ClickHouse/pull/42423) ([Antonio Andelic](https://github.com/antonio2368)). Это продолжение [#39550i](https://github.com/ClickHouse/ClickHouse/pull/39550) от [@fastio](https://github.com/fastio), который реализовал большую часть логики.
- Добавлена новая инфраструктура для анализа и планирования запросов под настройкой `allow_experimental_analyzer`. [#31796](https://github.com/ClickHouse/ClickHouse/pull/31796) ([Maksim Kita](https://github.com/kitaisreal)).
- Улучшено время восстановления потерянных соединений keeper. [#42541](https://github.com/ClickHouse/ClickHouse/pull/42541) ([Raúl Marín](https://github.com/Algunenano)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-2}

- Добавлен фаззер для определений таблиц [#40096](https://github.com/ClickHouse/ClickHouse/pull/40096) ([Anton Popov](https://github.com/CurtizJ)). Это самое значительное улучшение в тестировании ClickHouse за текущий год.
- Выпущена бета-версия сервиса ClickHouse Cloud: [https://console.clickhouse.cloud/](https://console.clickhouse.cloud/). Это самый простой способ использования ClickHouse (даже проще, чем установка одной командой).
- Добавлена поддержка генерации условий WHERE в AST Fuzzer и возможность добавления или удаления условий ORDER BY и WHERE. [#38519](https://github.com/ClickHouse/ClickHouse/pull/38519) ([Ilya Yatsishin](https://github.com/qoega)).
- Бинарные файлы Aarch64 теперь требуют как минимум ARMv8.2, выпущенную в 2016 году. Наиболее важно, что это позволяет использовать ARM LSE, т.е. нативные атомарные операции. Также добавлена опция сборки CMake "NO_ARMV81_OR_HIGHER", позволяющая компилировать бинарные файлы для более старого оборудования ARMv8.0, например Raspberry Pi 4. [#41610](https://github.com/ClickHouse/ClickHouse/pull/41610) ([Robert Schulze](https://github.com/rschu1ze)).
- Разрешена сборка ClickHouse с Musl (небольшие изменения после того, как поддержка уже была реализована, но не работала). [#41987](https://github.com/ClickHouse/ClickHouse/pull/41987) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлена проверка файла `$CLICKHOUSE_CRONFILE`, чтобы избежать выполнения команды `sed` и получения ошибки "файл не найден" при установке. [#42081](https://github.com/ClickHouse/ClickHouse/pull/42081) ([Chun-Sheng, Li](https://github.com/peter279k)).
- Обновление cctz до версии `2022e` для поддержки новых изменений часовых поясов. Переходы в Палестине теперь происходят по субботам в 02:00. Три украинских часовых пояса объединены в один. Иордания и Сирия переходят с +02/+03 с летним временем на круглогодичный +03. (https://data.iana.org/time-zones/tzdb/NEWS). Это закрывает [#42252](https://github.com/ClickHouse/ClickHouse/issues/42252). [#42327](https://github.com/ClickHouse/ClickHouse/pull/42327) ([Alexey Milovidov](https://github.com/alexey-milovidov)). [#42273](https://github.com/ClickHouse/ClickHouse/pull/42273) ([Dom Del Nano](https://github.com/ddelnano)).
- Добавлена поддержка кода Rust в ClickHouse с библиотекой хеш-функции BLAKE3 в качестве примера. [#33435](https://github.com/ClickHouse/ClickHouse/pull/33435) ([BoloniniD](https://github.com/BoloniniD)).

#### Исправление ошибок (видимые пользователю неполадки в официальном стабильном или предварительном релизе) {#bug-fix-user-visible-misbehavior-in-official-stable-or-prestable-release-2}


* Выбран корректный метод агрегации для `LowCardinality` с целочисленными типами большой разрядности. [#42342](https://github.com/ClickHouse/ClickHouse/pull/42342) ([Duc Canh Le](https://github.com/canhld94)).
* Несколько исправлений в реализации диска `web`. [#41652](https://github.com/ClickHouse/ClickHouse/pull/41652) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправляет проблему, из-за которой выполнение `docker run` завершалось с ошибкой, если в конфигурации отсутствовал `https_port`. [#41693](https://github.com/ClickHouse/ClickHouse/pull/41693) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Мутации некорректно отменялись при завершении работы сервера или выполнении запроса `SYSTEM STOP MERGES`, и их отмена могла занимать много времени; это исправлено. [#41699](https://github.com/ClickHouse/ClickHouse/pull/41699) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена ошибка неверных результатов запросов с `ORDER BY` или `GROUP BY` по столбцам из префикса ключа сортировки, к которым применены монотонные функции, при включённой оптимизации &quot;read in order&quot; (настройки `optimize_read_in_order` и `optimize_aggregation_in_order`). [#41701](https://github.com/ClickHouse/ClickHouse/pull/41701) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено возможное падение при выполнении `SELECT` из таблицы `Merge` с включённой настройкой `optimize_monotonous_functions_in_order_by`. Исправляет [#41269](https://github.com/ClickHouse/ClickHouse/issues/41269). [#41740](https://github.com/ClickHouse/ClickHouse/pull/41740) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка &quot;Part ... intersects part ...&quot;, которая могла возникать в крайне редких случаях, если сразу после отключения некоторой части как повреждённой была перезапущена реплика. [#41741](https://github.com/ClickHouse/ClickHouse/pull/41741) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Не допускается создавать или изменять таблицы MergeTree со столбцом `_row_exists`, который зарезервирован под механизм лёгких удалений. Исправлено [#41716](https://github.com/ClickHouse/ClickHouse/issues/41716). [#41763](https://github.com/ClickHouse/ClickHouse/pull/41763) ([Jianmei Zhang](https://github.com/zhangjmruc)).
* Исправлена ошибка, из-за которой в некоторых HTTP-ответах отсутствовали заголовки CORS. [#41792](https://github.com/ClickHouse/ClickHouse/pull/41792) ([Frank Chen](https://github.com/FrankChen021)).
* Версия 22.9 могла не запускаться при наличии таблицы `ReplicatedMergeTree`, если эта таблица была создана в версии 20.3 или более ранней и ни разу не изменялась; это исправлено. Исправляет [#41742](https://github.com/ClickHouse/ClickHouse/issues/41742). [#41796](https://github.com/ClickHouse/ClickHouse/pull/41796) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Когда по какой-либо причине не удаётся отправить пакет, он не может быть автоматически восстановлен, и, если не обработать его вовремя, это приведёт к накоплению. Выводимое сообщение об ошибке будет становиться всё длиннее и длиннее, что вызовет блокировку HTTP-потока. [#41813](https://github.com/ClickHouse/ClickHouse/pull/41813) ([zhongyuankai](https://github.com/zhongyuankai)).
* Исправлены проблемы с компактными частями при использовании настройки сжатых меток (compressed marks). Исправляет [#41783](https://github.com/ClickHouse/ClickHouse/issues/41783) и [#41746](https://github.com/ClickHouse/ClickHouse/issues/41746). [#41823](https://github.com/ClickHouse/ClickHouse/pull/41823) ([alesapin](https://github.com/alesapin)).
* Старые версии реплицируемой базы данных не имеют специального маркера в [Zoo]Keeper. Нужно лишь проверять, что узел содержит какие‑то данные, а не специальный маркер. [#41875](https://github.com/ClickHouse/ClickHouse/pull/41875) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлено возможное исключение в файловом кэше. [#41884](https://github.com/ClickHouse/ClickHouse/pull/41884) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена работа параметра `use_environment_credentials` для табличной функции S3. [#41970](https://github.com/ClickHouse/ClickHouse/pull/41970) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка «Directory already exists and is not empty» при отсоединении повреждённой части, которая могла помешать запуску репликации таблицы `ReplicatedMergeTree`. Исправляет [#40957](https://github.com/ClickHouse/ClickHouse/issues/40957). [#41981](https://github.com/ClickHouse/ClickHouse/pull/41981) ([Alexander Tokmakov](https://github.com/tavplubix)).
* `toDateTime64` теперь возвращает одинаковый результат для отрицательных аргументов целого и вещественного типов. [#42025](https://github.com/ClickHouse/ClickHouse/pull/42025) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена операция записи в `azure_blob_storage`. Частично закрывает [#41754](https://github.com/ClickHouse/ClickHouse/issues/41754). [#42034](https://github.com/ClickHouse/ClickHouse/pull/42034) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проблема декодирования `bzip2` для некоторых файлов формата `bzip2`. [#42046](https://github.com/ClickHouse/ClickHouse/pull/42046) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлена SQL-функция `toLastDayOfMonth` при включённой настройке &quot;enable&#95;extended&#95;results&#95;for&#95;datetime&#95;functions = 1&quot; в начале расширенного диапазона (в январе 1900 года). - Исправлена SQL-функция &quot;toRelativeWeekNum()&quot; при включённой настройке &quot;enable&#95;extended&#95;results&#95;for&#95;datetime&#95;functions = 1&quot; в конце расширенного диапазона (в декабре 2299 года). - Улучшена производительность SQL-функций &quot;toISOYear()&quot;, &quot;toFirstDayNumOfISOYearIndex()&quot; и &quot;toYearWeekOfNewyearMode()&quot; за счёт устранения лишних арифметических операций с индексами. [#42084](https://github.com/ClickHouse/ClickHouse/pull/42084) ([Roman Vasin](https://github.com/rvasin)).
* Максимальный размер выборок для каждой таблицы по ошибке был установлен в 8, хотя размер пула мог быть больше. Теперь максимальный размер выборок для таблицы равен размеру пула. [#42090](https://github.com/ClickHouse/ClickHouse/pull/42090) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Таблица могла быть остановлена, а словарь отсоединён до проверки того, можно ли их удалить, не нарушив зависимости между таблицами; теперь это исправлено. Исправляет [#41982](https://github.com/ClickHouse/ClickHouse/issues/41982). [#42106](https://github.com/ClickHouse/ClickHouse/pull/42106) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена значительная неэффективность `remote_filesystem_read_method=read` при использовании кэша файловой системы. Закрывает [#42125](https://github.com/ClickHouse/ClickHouse/issues/42125). [#42129](https://github.com/ClickHouse/ClickHouse/pull/42129) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Устранено возможное исключение тайм-аута для распределённых запросов при use&#95;hedged&#95;requests = 0. [#42130](https://github.com/ClickHouse/ClickHouse/pull/42130) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена небольшая ошибка в функции `runningDifference` при использовании её с типом данных `Date32`. Ранее использовался тип `Date`, что могло приводить к логическим ошибкам, таким как `Bad cast from type DB::ColumnVector<int> to DB::ColumnVector<unsigned short>'`. [#42143](https://github.com/ClickHouse/ClickHouse/pull/42143) ([Alfred Xu](https://github.com/sperlingxx)).
* Исправлено повторное использование файлов размером &gt; 4 ГБ из базовой резервной копии. [#42146](https://github.com/ClickHouse/ClickHouse/pull/42146) ([Azat Khuzhin](https://github.com/azat)).
* DISTINCT в ORDER BY завершается с LOGICAL&#95;ERROR, если первый столбец сортировочного ключа содержит функцию. [#42186](https://github.com/ClickHouse/ClickHouse/pull/42186) ([Igor Nikonov](https://github.com/devcrafter)).
* Исправлена ошибка с проекциями и настройкой `aggregate_functions_null_for_empty`. Эта ошибка встречается очень редко и проявляется только в том случае, если в конфигурации сервера включена настройка `aggregate_functions_null_for_empty`. Закрывает [#41647](https://github.com/ClickHouse/ClickHouse/issues/41647). [#42198](https://github.com/ClickHouse/ClickHouse/pull/42198) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлено чтение из таблиц `Buffer` при чтении в порядке убывания. [#42236](https://github.com/ClickHouse/ClickHouse/pull/42236) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлена ошибка, из-за которой ClickHouse не запускался, когда в профиле по умолчанию была задана настройка `background_pool_size`, а `background_merges_mutations_concurrency_ratio` — нет. [#42315](https://github.com/ClickHouse/ClickHouse/pull/42315) ([nvartolomei](https://github.com/nvartolomei)).
* Операция `ALTER UPDATE` для присоединённой части (с колонками, отличающимися от схемы таблицы) могла создавать некорректный файл метаданных `columns.txt` на диске. Чтение из такой части могло завершаться с ошибками или приводить к возврату некорректных данных. Исправляет [#42161](https://github.com/ClickHouse/ClickHouse/issues/42161). [#42319](https://github.com/ClickHouse/ClickHouse/pull/42319) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Настройка `additional_table_filters` не применялась к хранилищу `Distributed`. Исправлена [#41692](https://github.com/ClickHouse/ClickHouse/issues/41692). [#42322](https://github.com/ClickHouse/ClickHouse/pull/42322) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Устранена гонка данных при завершении или отмене запроса. Это закрывает [#42346](https://github.com/ClickHouse/ClickHouse/issues/42346). [#42362](https://github.com/ClickHouse/ClickHouse/pull/42362) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Отменяет изменения из [#40217](https://github.com/ClickHouse/ClickHouse/issues/40217), которые привели к регрессии в функциях работы с датой и временем. [#42367](https://github.com/ClickHouse/ClickHouse/pull/42367) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена проверка assert при приведении типов (cast) при `JOIN` с ложным условием, закрыт [#42380](https://github.com/ClickHouse/ClickHouse/issues/42380). [#42407](https://github.com/ClickHouse/ClickHouse/pull/42407) ([Vladimir C](https://github.com/vdimir)).
* Исправлено переполнение буфера при обработке типов данных Decimal. Исправление закрывает [#42451](https://github.com/ClickHouse/ClickHouse/issues/42451). [#42465](https://github.com/ClickHouse/ClickHouse/pull/42465) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* `AggregateFunctionQuantile` теперь корректно работает со столбцами типа `UInt128`. Ранее состояние квантиля интерпретировало столбцы `UInt128` как `Int128`, что могло приводить к неверным результатам. [#42473](https://github.com/ClickHouse/ClickHouse/pull/42473) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена ошибка assert bad&#95;cast при выполнении INSERT в индексы `Annoy` по столбцам с типом, отличным от Float32. Индексы `Annoy` являются экспериментальной функциональностью. [#42485](https://github.com/ClickHouse/ClickHouse/pull/42485) ([Robert Schulze](https://github.com/rschu1ze)).
* Арифметический оператор над `Date` или `DateTime` и 128- или 256-битным целым числом обращался к неинициализированной памяти. [#42453](https://github.com/ClickHouse/ClickHouse/issues/42453). [#42573](https://github.com/ClickHouse/ClickHouse/pull/42573) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка загрузки таблицы, возникающая при обновлении сервера, если ключ партиционирования содержит имена функций-алиасов. [#36379](https://github.com/ClickHouse/ClickHouse/pull/36379) ([Amos Bird](https://github.com/amosbird)).

### <a id="229"></a> Релиз ClickHouse 22.9, 2022-09-22 {#a-id229a-clickhouse-release-229-2022-09-22}

#### Обратно несовместимые изменения {#backward-incompatible-change-2}

- Обновление с версии 20.3 и старше до версии 22.9 и новее должно выполняться через промежуточную версию при наличии таблиц `ReplicatedMergeTree`, иначе сервер с новой версией не запустится. [#40641](https://github.com/ClickHouse/ClickHouse/pull/40641) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Удалены функции `accurate_Cast` и `accurate_CastOrNull` (они отличаются от `accurateCast` и `accurateCastOrNull` символом подчёркивания в названии и на них не влияет значение настройки `cast_keep_nullable`). Эти функции не были документированы, не тестировались, не использовались и были не нужны. Они сохранились из-за обобщения кода. [#40682](https://github.com/ClickHouse/ClickHouse/pull/40682) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлен тест для обеспечения документирования каждой новой табличной функции. См. [#40649](https://github.com/ClickHouse/ClickHouse/issues/40649). Табличная функция `MeiliSearch` переименована в `meilisearch`. [#40709](https://github.com/ClickHouse/ClickHouse/pull/40709) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлен тест для обеспечения документирования каждой новой функции. См. [#40649](https://github.com/ClickHouse/ClickHouse/pull/40649). Функции `lemmatize`, `synonyms`, `stem` по ошибке были регистронезависимыми. Теперь они чувствительны к регистру. [#40711](https://github.com/ClickHouse/ClickHouse/pull/40711) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- По соображениям безопасности и стабильности модели catboost больше не выполняются внутри сервера ClickHouse. Вместо этого выполнение теперь
  происходит в clickhouse-library-bridge — отдельном процессе, который загружает библиотеку catboost и взаимодействует с серверным процессом через
  HTTP. [#40897](https://github.com/ClickHouse/ClickHouse/pull/40897) ([Robert Schulze](https://github.com/rschu1ze)).
- Интерпретация конфигурационных файлов YAML приведена к более стандартному виду. [#41044](https://github.com/ClickHouse/ClickHouse/pull/41044) ([Vitaly Baranov](https://github.com/vitlibar)).


#### Новая функциональность {#new-feature-3}

- Поддержка `insert_quorum = 'auto'` для использования большинства узлов. [#39970](https://github.com/ClickHouse/ClickHouse/pull/39970) ([Sachin](https://github.com/SachinSetiya)).
- Добавлены встроенные дашборды в сервер ClickHouse. Это демонстрационный проект о том, как достичь 90% результата при 1% усилий, используя возможности ClickHouse. [#40461](https://github.com/ClickHouse/ClickHouse/pull/40461) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлен новый тип ограничения изменяемости настроек `changeable_in_readonly`. [#40631](https://github.com/ClickHouse/ClickHouse/pull/40631) ([Sergei Trifonov](https://github.com/serxa)).
- Добавлена поддержка `INTERSECT DISTINCT` и `EXCEPT DISTINCT`. [#40792](https://github.com/ClickHouse/ClickHouse/pull/40792) ([Duc Canh Le](https://github.com/canhld94)).
- Добавлен новый формат ввода/вывода `JSONObjectEachRow` - Поддержка импорта для форматов `JSON/JSONCompact/JSONColumnsWithMetadata`. Добавлена новая настройка `input_format_json_validate_types_from_metadata`, которая контролирует, следует ли проверять соответствие типов данных из метаданных типам данных из заголовка. - Добавлена новая настройка `input_format_json_validate_utf8`; при её включении все форматы `JSON` будут проверять последовательности UTF-8. По умолчанию она отключена. Обратите внимание, что эта настройка не влияет на форматы вывода `JSON/JSONCompact/JSONColumnsWithMetadata` — они всегда проверяют последовательности UTF-8 (это исключение было сделано по соображениям совместимости). - Добавлена новая настройка `input_format_json_read_numbers_as_strings`, которая позволяет парсить числа в столбце String; настройка по умолчанию отключена. - Добавлена новая настройка `output_format_json_quote_decimals`, которая позволяет выводить десятичные числа в двойных кавычках; по умолчанию отключена. - Разрешён парсинг десятичных чисел в двойных кавычках при импорте данных. [#40910](https://github.com/ClickHouse/ClickHouse/pull/40910) ([Kruglov Pavel](https://github.com/Avogar)).
- Параметры запроса поддерживаются в запросе DESCRIBE TABLE. [#40952](https://github.com/ClickHouse/ClickHouse/pull/40952) ([Nikita Taranov](https://github.com/nickitat)).
- Добавлена поддержка Parquet Time32/64 путём преобразования в DateTime64. Parquet time32/64 представляет время, прошедшее с полуночи, в то время как DateTime32/64 представляет фактическую временную метку Unix. Преобразование просто выполняет смещение от `0`. [#41333](https://github.com/ClickHouse/ClickHouse/pull/41333) ([Arthur Passos](https://github.com/arthurpassos)).
- Реализованы операции над множествами для Apache Datasketches. [#39919](https://github.com/ClickHouse/ClickHouse/pull/39919) ([Fangyuan Deng](https://github.com/pzhdfy)). Примечание: использование Apache Datasketches не имеет смысла, они уступают ClickHouse и имеют значение только для интеграции с другими системами.
- Разрешена запись ошибок в указанный файл при чтении текстовых форматов (`CSV`, `TSV`). [#40516](https://github.com/ClickHouse/ClickHouse/pull/40516) ([zjial](https://github.com/zjial)).

#### Экспериментальная функциональность {#experimental-feature-3}

- Добавлен индекс ANN (приближённого поиска ближайших соседей) на основе `Annoy`. [#40818](https://github.com/ClickHouse/ClickHouse/pull/40818) ([Filatenkov Artur](https://github.com/FArthur-cmd)). [#37215](https://github.com/ClickHouse/ClickHouse/pull/37215) ([VVMak](https://github.com/VVMak)).
- Добавлен новый движок таблиц `KeeperMap`, который использует ClickHouse Keeper или ZooKeeper в качестве хранилища ключ-значение. [#39976](https://github.com/ClickHouse/ClickHouse/pull/39976) ([Antonio Andelic](https://github.com/antonio2368)). Этот движок таблиц предназначен для хранения небольшого объёма метаданных.
- Улучшение для кусков данных в памяти: удаление полностью обработанных файлов WAL. [#40592](https://github.com/ClickHouse/ClickHouse/pull/40592) ([Azat Khuzhin](https://github.com/azat)).


#### Улучшение производительности {#performance-improvement-3}

- Реализовано сжатие меток и первичного ключа. Закрывает [#34437](https://github.com/ClickHouse/ClickHouse/issues/34437). [#37693](https://github.com/ClickHouse/ClickHouse/pull/37693) ([zhongyuankai](https://github.com/zhongyuankai)).
- Добавлена возможность предварительной загрузки меток с использованием пула потоков. Регулируется настройкой `load_marks_asynchronously` (по умолчанию: 0). [#40821](https://github.com/ClickHouse/ClickHouse/pull/40821) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Виртуальная файловая система поверх S3 теперь использует случайные имена объектов, распределённые по нескольким префиксам путей, для повышения производительности на AWS. [#40968](https://github.com/ClickHouse/ClickHouse/pull/40968) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Значение `max_block_size` теперь учитывается при формировании результатов одноуровневой агрегации. Это позволяет выполнять последующие шаги плана запроса с использованием большего количества потоков. [#39138](https://github.com/ClickHouse/ClickHouse/pull/39138) ([Nikita Taranov](https://github.com/nickitat)).
- Программная предвыборка используется в агрегации для ускорения операций с хеш-таблицами. Управляется настройкой `enable_software_prefetch_in_aggregation`, включена по умолчанию. [#39304](https://github.com/ClickHouse/ClickHouse/pull/39304) ([Nikita Taranov](https://github.com/nickitat)).
- Улучшена поддержка `optimize_read_in_order` в случае, когда некоторые столбцы ключа сортировки всегда являются константами после применения условия `WHERE`. Например, запрос вида `SELECT ... FROM table WHERE a = 'x' ORDER BY a, b`, где `table` имеет определение хранилища: `MergeTree ORDER BY (a, b)`. [#38715](https://github.com/ClickHouse/ClickHouse/pull/38715) ([Anton Popov](https://github.com/CurtizJ)).
- Объединяемые потоки для `full_sorting_join` теперь фильтруются друг другом перед сортировкой. [#39418](https://github.com/ClickHouse/ClickHouse/pull/39418) ([Vladimir C](https://github.com/vdimir)).
- Декомпрессия LZ4 оптимизирована за счёт пропуска обработки пустых литералов. [#40142](https://github.com/ClickHouse/ClickHouse/pull/40142) ([Nikita Taranov](https://github.com/nickitat)).
- Ускорен процесс резервного копирования за счёт использования нативного `copy` там, где это возможно, вместо копирования через память `clickhouse-server`. [#40395](https://github.com/ClickHouse/ClickHouse/pull/40395) ([alesapin](https://github.com/alesapin)).
- Снимок хранилища больше не создаётся для каждого блока INSERT (незначительно улучшает производительность). [#40638](https://github.com/ClickHouse/ClickHouse/pull/40638) ([Azat Khuzhin](https://github.com/azat)).
- Реализована пакетная обработка для агрегатных функций с несколькими nullable-аргументами. [#41058](https://github.com/ClickHouse/ClickHouse/pull/41058) ([Raúl Marín](https://github.com/Algunenano)).
- Ускорено чтение UniquesHashSet (например, `uniqState` с диска). [#41089](https://github.com/ClickHouse/ClickHouse/pull/41089) ([Raúl Marín](https://github.com/Algunenano)).
- Исправлено высокое потребление памяти при выполнении мутаций компактных кусков в таблицах с большим количеством столбцов. [#41122](https://github.com/ClickHouse/ClickHouse/pull/41122) ([lthaooo](https://github.com/lthaooo)).
- Включена библиотека vectorscan на ARM, что ускоряет вычисление регулярных выражений. [#41033](https://github.com/ClickHouse/ClickHouse/pull/41033) ([Robert Schulze](https://github.com/rschu1ze)).
- Обновление vectorscan до версии 5.4.8, которая содержит множество оптимизаций производительности для ускорения вычисления регулярных выражений. [#41270](https://github.com/ClickHouse/ClickHouse/pull/41270) ([Robert Schulze](https://github.com/rschu1ze)).
- Исправлен некорректный откат к пропуску кеша локальной файловой системы для VFS (например, S3), который происходил при очень высоком уровне параллелизма. [#40420](https://github.com/ClickHouse/ClickHouse/pull/40420) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Если фильтр политики строк всегда ложный, немедленно возвращается пустой результат без чтения каких-либо данных. Закрывает [#24012](https://github.com/ClickHouse/ClickHouse/issues/24012). [#40740](https://github.com/ClickHouse/ClickHouse/pull/40740) ([Amos Bird](https://github.com/amosbird)).
- Параллельный хеш-JOIN для типов данных Float мог быть неоптимальным. Улучшено. [#41183](https://github.com/ClickHouse/ClickHouse/pull/41183) ([Alexey Milovidov](https://github.com/alexey-milovidov)).





#### Улучшение {#improvement-3}

- During startup and ATTACH call, `ReplicatedMergeTree` tables will be readonly until the ZooKeeper connection is made and the setup is finished. [#40148](https://github.com/ClickHouse/ClickHouse/pull/40148) ([Antonio Andelic](https://github.com/antonio2368)).
- Add `enable_extended_results_for_datetime_functions` option to return results of type Date32 for functions toStartOfYear, toStartOfISOYear, toStartOfQuarter, toStartOfMonth, toStartOfWeek, toMonday and toLastDayOfMonth when argument is Date32 or DateTime64, otherwise results of Date type are returned. For compatibility reasons default value is '0'. [#41214](https://github.com/ClickHouse/ClickHouse/pull/41214) ([Roman Vasin](https://github.com/rvasin)).
- For security and stability reasons, CatBoost models are no longer evaluated within the ClickHouse server. Instead, the evaluation is now done in the clickhouse-library-bridge, a separate process that loads the catboost library and communicates with the server process via HTTP. Function `modelEvaluate()` was replaced by `catboostEvaluate()`. [#40897](https://github.com/ClickHouse/ClickHouse/pull/40897) ([Robert Schulze](https://github.com/rschu1ze)). [#39629](https://github.com/ClickHouse/ClickHouse/pull/39629) ([Robert Schulze](https://github.com/rschu1ze)).
- Add more metrics for on-disk temporary data, close [#40206](https://github.com/ClickHouse/ClickHouse/issues/40206). [#40239](https://github.com/ClickHouse/ClickHouse/pull/40239) ([Vladimir C](https://github.com/vdimir)).
- Add config option `warning_supress_regexp`, close [#40330](https://github.com/ClickHouse/ClickHouse/issues/40330). [#40548](https://github.com/ClickHouse/ClickHouse/pull/40548) ([Vladimir C](https://github.com/vdimir)).
- Add setting to disable limit on kafka_num_consumers. Closes [#40331](https://github.com/ClickHouse/ClickHouse/issues/40331). [#40670](https://github.com/ClickHouse/ClickHouse/pull/40670) ([Kruglov Pavel](https://github.com/Avogar)).
- Support `SETTINGS` in `DELETE ...` query. [#41533](https://github.com/ClickHouse/ClickHouse/pull/41533) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Detailed S3 profile events `DiskS3*` per S3 API call split for S3 ObjectStorage. [#41532](https://github.com/ClickHouse/ClickHouse/pull/41532) ([Sergei Trifonov](https://github.com/serxa)).
- Two new metrics in `system.asynchronous_metrics`. `NumberOfDetachedParts` and `NumberOfDetachedByUserParts`. [#40779](https://github.com/ClickHouse/ClickHouse/pull/40779) ([Sema Checherinda](https://github.com/CheSema)).
- Allow CONSTRAINTs for ODBC and JDBC tables. [#34551](https://github.com/ClickHouse/ClickHouse/pull/34551) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Don't print `SETTINGS` more than once during query formatting if it didn't appear multiple times in the original query. [#38900](https://github.com/ClickHouse/ClickHouse/pull/38900) ([Raúl Marín](https://github.com/Algunenano)).
- Improve the tracing (OpenTelemetry) context propagation across threads. [#39010](https://github.com/ClickHouse/ClickHouse/pull/39010) ([Frank Chen](https://github.com/FrankChen021)).
- ClickHouse Keeper: add listeners for `interserver_listen_host` only in Keeper if specified. [#39973](https://github.com/ClickHouse/ClickHouse/pull/39973) ([Antonio Andelic](https://github.com/antonio2368)).
- Improve recovery of Replicated user access storage after errors. [#39977](https://github.com/ClickHouse/ClickHouse/pull/39977) ([Vitaly Baranov](https://github.com/vitlibar)).
- Add support for TTL in `EmbeddedRocksDB`. [#39986](https://github.com/ClickHouse/ClickHouse/pull/39986) ([Lloyd-Pottiger](https://github.com/Lloyd-Pottiger)).
- Add schema inference to `clickhouse-obfuscator`, so the `--structure` argument is no longer required. [#40120](https://github.com/ClickHouse/ClickHouse/pull/40120) ([Nikolay Degterinsky](https://github.com/evillique)).
- Improve and fix dictionaries in `Arrow` format. [#40173](https://github.com/ClickHouse/ClickHouse/pull/40173) ([Kruglov Pavel](https://github.com/Avogar)).
- More natural conversion of `Date32`, `DateTime64`, `Date` to narrower types: upper or lower normal value is considered when out of normal range. [#40217](https://github.com/ClickHouse/ClickHouse/pull/40217) ([Andrey Zvonov](https://github.com/zvonand)).
- Fix the case when `Merge` table over `View` cannot use index. [#40233](https://github.com/ClickHouse/ClickHouse/pull/40233) ([Duc Canh Le](https://github.com/canhld94)).
- Custom key names for JSON server logs. [#40251](https://github.com/ClickHouse/ClickHouse/pull/40251) ([Mallik Hassan](https://github.com/SadiHassan)).
- It is now possible to set a custom error code for the exception thrown by function `throwIf`. [#40319](https://github.com/ClickHouse/ClickHouse/pull/40319) ([Robert Schulze](https://github.com/rschu1ze)).
- Improve schema inference cache, respect format settings that can change the schema. [#40414](https://github.com/ClickHouse/ClickHouse/pull/40414) ([Kruglov Pavel](https://github.com/Avogar)).
- Allow parsing `Date` as `DateTime` and `DateTime64`. This implements the enhancement proposed in [#36949](https://github.com/ClickHouse/ClickHouse/issues/36949). [#40474](https://github.com/ClickHouse/ClickHouse/pull/40474) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Allow conversion from `String` with `DateTime64` like `2022-08-22 01:02:03.456` to `Date` and `Date32`. Allow conversion from String with DateTime like `2022-08-22 01:02:03` to `Date32`. This closes [#39598](https://github.com/ClickHouse/ClickHouse/issues/39598). [#40475](https://github.com/ClickHouse/ClickHouse/pull/40475) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Better support for nested data structures in Parquet format [#40485](https://github.com/ClickHouse/ClickHouse/pull/40485) ([Arthur Passos](https://github.com/arthurpassos)).
- Support reading Array(Record) into flatten nested table in Avro. [#40534](https://github.com/ClickHouse/ClickHouse/pull/40534) ([Kruglov Pavel](https://github.com/Avogar)).
- Add read-only support for `EmbeddedRocksDB`. [#40543](https://github.com/ClickHouse/ClickHouse/pull/40543) ([Lloyd-Pottiger](https://github.com/Lloyd-Pottiger)).
- Validate the compression method parameter of URL table engine. [#40600](https://github.com/ClickHouse/ClickHouse/pull/40600) ([Frank Chen](https://github.com/FrankChen021)).
- Better format detection for url table function/engine in presence of a query string after a file name. Closes [#40315](https://github.com/ClickHouse/ClickHouse/issues/40315). [#40636](https://github.com/ClickHouse/ClickHouse/pull/40636) ([Kruglov Pavel](https://github.com/Avogar)).
- Disable projection when grouping set is used. It generated wrong result. This fixes [#40635](https://github.com/ClickHouse/ClickHouse/issues/40635). [#40726](https://github.com/ClickHouse/ClickHouse/pull/40726) ([Amos Bird](https://github.com/amosbird)).
- Fix incorrect format of `APPLY` column transformer which can break metadata if used in table definition. This fixes [#37590](https://github.com/ClickHouse/ClickHouse/issues/37590). [#40727](https://github.com/ClickHouse/ClickHouse/pull/40727) ([Amos Bird](https://github.com/amosbird)).
- Support the `%z` descriptor for formatting the timezone offset in `formatDateTime`. [#40736](https://github.com/ClickHouse/ClickHouse/pull/40736) ([Cory Levy](https://github.com/LevyCory)).
- The interactive mode in `clickhouse-client` now interprets `.` and `/` as "run the last command". [#40750](https://github.com/ClickHouse/ClickHouse/pull/40750) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix issue with passing MySQL timeouts for MySQL database engine and MySQL table function. Closes [#34168](https://github.com/ClickHouse/ClickHouse/issues/34168). [#40751](https://github.com/ClickHouse/ClickHouse/pull/40751) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Create status file for filesystem cache directory to make sure that cache directories are not shared between different servers or caches. [#40820](https://github.com/ClickHouse/ClickHouse/pull/40820) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Add support for `DELETE` and `UPDATE` for `EmbeddedRocksDB` storage. [#40853](https://github.com/ClickHouse/ClickHouse/pull/40853) ([Antonio Andelic](https://github.com/antonio2368)).
- ClickHouse Keeper: fix shutdown during long commit and increase allowed request size. [#40941](https://github.com/ClickHouse/ClickHouse/pull/40941) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix race in WriteBufferFromS3, add TSA annotations. [#40950](https://github.com/ClickHouse/ClickHouse/pull/40950) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Grouping sets with group_by_use_nulls should only convert key columns to nullable. [#40997](https://github.com/ClickHouse/ClickHouse/pull/40997) ([Duc Canh Le](https://github.com/canhld94)).
- Improve the observability of INSERT on distributed table. [#41034](https://github.com/ClickHouse/ClickHouse/pull/41034) ([Frank Chen](https://github.com/FrankChen021)).
- More low-level metrics for S3 interaction. [#41039](https://github.com/ClickHouse/ClickHouse/pull/41039) ([mateng915](https://github.com/mateng0915)).
- Support relative path in Location header after HTTP redirect. Closes [#40985](https://github.com/ClickHouse/ClickHouse/issues/40985). [#41162](https://github.com/ClickHouse/ClickHouse/pull/41162) ([Kruglov Pavel](https://github.com/Avogar)).
- Apply changes to HTTP handlers on fly without server restart. [#41177](https://github.com/ClickHouse/ClickHouse/pull/41177) ([Azat Khuzhin](https://github.com/azat)).
- ClickHouse Keeper: properly close active sessions during shutdown. [#41215](https://github.com/ClickHouse/ClickHouse/pull/41215) ([Antonio Andelic](https://github.com/antonio2368)). This lowers the period of "table is read-only" errors.
- Add ability to automatically comment SQL queries in clickhouse-client/local (with `Alt-#`, like in readline). [#41224](https://github.com/ClickHouse/ClickHouse/pull/41224) ([Azat Khuzhin](https://github.com/azat)).
- Fix incompatibility of cache after switching setting `do_no_evict_index_and_mark_files` from 1 to 0, 0 to 1. [#41330](https://github.com/ClickHouse/ClickHouse/pull/41330) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Add a setting `allow_suspicious_fixed_string_types` to prevent users from creating columns of type FixedString with size > 256. [#41495](https://github.com/ClickHouse/ClickHouse/pull/41495) ([Duc Canh Le](https://github.com/canhld94)).
- Add `has_lightweight_delete` to system.parts. [#41564](https://github.com/ClickHouse/ClickHouse/pull/41564) ([Kseniia Sumarokova](https://github.com/kssenii)).





#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-3}

- Обязательная документация для каждой настройки. [#40644](https://github.com/ClickHouse/ClickHouse/pull/40644) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Обязательная документация для каждой текущей метрики. [#40645](https://github.com/ClickHouse/ClickHouse/pull/40645) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Обязательная документация для каждого счётчика событий профилирования. Документация добавлена там, где она отсутствовала. [#40646](https://github.com/ClickHouse/ClickHouse/pull/40646) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Возможность минимальной сборки `clickhouse-local` путём исправления некоторых зависимостей. [#40460](https://github.com/ClickHouse/ClickHouse/pull/40460) ([Alexey Milovidov](https://github.com/alexey-milovidov)). Размер составляет менее 50 МиБ.
- Вычисление и отчёт о покрытии SQL-функций в тестах. [#40593](https://github.com/ClickHouse/ClickHouse/issues/40593). [#40647](https://github.com/ClickHouse/ClickHouse/pull/40647) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Обязательная документация для каждой настройки MergeTree. [#40648](https://github.com/ClickHouse/ClickHouse/pull/40648) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Прототип встроенной справочной документации для высокоуровневых унифицированных серверных компонентов. [#40649](https://github.com/ClickHouse/ClickHouse/pull/40649) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Проверка всех запросов из изменённых тестов производительности для обеспечения тестирования всех изменённых запросов. [#40322](https://github.com/ClickHouse/ClickHouse/pull/40322) ([Nikita Taranov](https://github.com/nickitat)).
- Исправление TGZ-пакетов. [#40681](https://github.com/ClickHouse/ClickHouse/pull/40681) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Исправление отладочных символов. [#40873](https://github.com/ClickHouse/ClickHouse/pull/40873) ([Azat Khuzhin](https://github.com/azat)).
- Расширение конфигурации CI для создания сборки x86 только с SSE2. Полезно для старого или встраиваемого оборудования. [#40999](https://github.com/ClickHouse/ClickHouse/pull/40999) ([Robert Schulze](https://github.com/rschu1ze)).
- Переход на llvm/clang 15. [#41046](https://github.com/ClickHouse/ClickHouse/pull/41046) ([Azat Khuzhin](https://github.com/azat)).
- Продолжение [#40938](https://github.com/ClickHouse/ClickHouse/issues/40938). Исправление нарушения ODR для класса `Loggers`. Исправляет [#40398](https://github.com/ClickHouse/ClickHouse/issues/40398), [#40937](https://github.com/ClickHouse/ClickHouse/issues/40937). [#41060](https://github.com/ClickHouse/ClickHouse/pull/41060) ([Dmitry Novik](https://github.com/novikd)).
- Добавление бинарных файлов macOS в ресурсы релиза GitHub, исправляет [#37718](https://github.com/ClickHouse/ClickHouse/issues/37718). [#41088](https://github.com/ClickHouse/ClickHouse/pull/41088) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Библиотека c-ares теперь включена в систему сборки ClickHouse. [#41239](https://github.com/ClickHouse/ClickHouse/pull/41239) ([Robert Schulze](https://github.com/rschu1ze)).
- Удаление `dlopen` из основного кода ClickHouse. Остаётся в library-bridge и odbc-bridge. [#41428](https://github.com/ClickHouse/ClickHouse/pull/41428) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Запрет `dlopen` в основном бинарном файле ClickHouse, поскольку это вредно и небезопасно. Мы его не используем. Но он может использоваться некоторыми библиотеками для реализации «плагинов». Мы категорически не рекомендуем устаревшую технику загрузки сторонних неконтролируемых опасных библиотек в адресное пространство процесса, поскольку это безрассудно. [#41429](https://github.com/ClickHouse/ClickHouse/pull/41429) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавление поля `source` в deb-пакеты, обновление `nfpm`. [#41531](https://github.com/ClickHouse/ClickHouse/pull/41531) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Поддержка DWARF-5 во внутреннем парсере DWARF. [#40710](https://github.com/ClickHouse/ClickHouse/pull/40710) ([Azat Khuzhin](https://github.com/azat)).
- Добавление внедрения сбоев в клиент ZooKeeper для тестирования [#30498](https://github.com/ClickHouse/ClickHouse/pull/30498) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Добавление stateless-тестов с хранилищем s3 с debug и tsan [#35262](https://github.com/ClickHouse/ClickHouse/pull/35262) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Попытка стресс-тестирования поверх S3 [#36837](https://github.com/ClickHouse/ClickHouse/pull/36837) ([alesapin](https://github.com/alesapin)).
- Включение `concurrency-mt-unsafe` в `clang-tidy` [#40224](https://github.com/ClickHouse/ClickHouse/pull/40224) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### Исправление ошибок {#bug-fix}


* Исправлена потенциальная потеря данных, связанная с [ошибкой в AWS SDK](https://github.com/aws/aws-sdk-cpp/issues/658). Ошибка проявляется только при использовании ClickHouse с S3. [#40506](https://github.com/ClickHouse/ClickHouse/pull/40506) ([alesapin](https://github.com/alesapin)). Эта ошибка оставалась открытой в AWS SDK на протяжении 5 лет и была закрыта после нашего обращения.
* Вредоносные данные в формате Native могут приводить к аварийному завершению работы. [#41441](https://github.com/ClickHouse/ClickHouse/pull/41441) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Агрегатная функция `categorialInformationValue` имела некорректно определённые свойства, что могло приводить к разыменованию нулевого указателя во время выполнения. Это закрывает [#41443](https://github.com/ClickHouse/ClickHouse/issues/41443). [#41449](https://github.com/ClickHouse/ClickHouse/pull/41449) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Запись данных в формате Apache `ORC` могла приводить к переполнению буфера. [#41458](https://github.com/ClickHouse/ClickHouse/pull/41458) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлены проблемы с безопасностью памяти в функциях `encrypt` и `contingency`, если в качестве аргумента используется массив типа Array of Nullable. Это исправляет [#41004](https://github.com/ClickHouse/ClickHouse/issues/41004). [#40195](https://github.com/ClickHouse/ClickHouse/pull/40195) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлены ошибки в MergeJoin, если &#39;not&#95;processed&#39; не равен null. [#40335](https://github.com/ClickHouse/ClickHouse/pull/40335) ([liql2007](https://github.com/liql2007)).
* Исправлен некорректный результат при потере точности значений типа `Decimal` в операторе `IN`, см. [#41125](https://github.com/ClickHouse/ClickHouse/issues/41125). [#41130](https://github.com/ClickHouse/ClickHouse/pull/41130) ([Vladimir C](https://github.com/vdimir)).
* Исправлено заполнение пропущенных столбцов типа `Nested` с несколькими уровнями вложенности. [#37152](https://github.com/ClickHouse/ClickHouse/pull/37152) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен запрос SYSTEM UNFREEZE для устаревшей базы данных Ordinary. Исправление для [https://github.com/ClickHouse/ClickHouse/pull/36424](https://github.com/ClickHouse/ClickHouse/pull/36424). [#38262](https://github.com/ClickHouse/ClickHouse/pull/38262) ([Vadim Volodin](https://github.com/PolyProgrammist)).
* Исправлена проблема с неиспользуемыми неизвестными столбцами, добавленными оператором WITH. Это исправляет [#37812](https://github.com/ClickHouse/ClickHouse/issues/37812). [#39131](https://github.com/ClickHouse/ClickHouse/pull/39131) ([Amos Bird](https://github.com/amosbird)).
* Исправлен анализ запросов с `ORDER BY` при наличии оконных функций. Исправлены [#38741](https://github.com/ClickHouse/ClickHouse/issues/38741) и [#24892](https://github.com/ClickHouse/ClickHouse/issues/24892). [#39354](https://github.com/ClickHouse/ClickHouse/pull/39354) ([Dmitry Novik](https://github.com/novikd)).
* Исправлено исключение `Unknown identifier (aggregate-function)`, возникавшее при вычислении выражений WINDOW ORDER BY/PARTITION BY над агрегатными функциями. [#39762](https://github.com/ClickHouse/ClickHouse/pull/39762) ([Vladimir Chebotaryov](https://github.com/quickhouse)).
* Ограничена глубина анализа одного запроса с помощью настройки `max_analyze_depth`. Это предотвращает экспоненциальный рост времени анализа для запросов с чрезмерно большим числом подзапросов. [#40334](https://github.com/ClickHouse/ClickHouse/pull/40334) ([Vladimir C](https://github.com/vdimir)).
* Исправлена редкая ошибка с TTL столбца в семействе движков MergeTree: при повторном вертикальном слиянии могла возникать ошибка `Cannot unlink file ColumnName.bin ... No such file or directory.`. [#40346](https://github.com/ClickHouse/ClickHouse/pull/40346) ([alesapin](https://github.com/alesapin)).
* Используйте DNS-записи для IPv4 и IPv6 при их наличии. [#40353](https://github.com/ClickHouse/ClickHouse/pull/40353) ([Maksim Kita](https://github.com/kitaisreal)).
* Разрешить чтение файлов из Hadoop, сжатых с помощью Snappy. [#40482](https://github.com/ClickHouse/ClickHouse/pull/40482) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен сбой при разборе значений экспериментального типа `Object`, содержащих массивы переменной размерности. [#40483](https://github.com/ClickHouse/ClickHouse/pull/40483) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлена настройка `input_format_tsv_skip_first_lines`. [#40491](https://github.com/ClickHouse/ClickHouse/pull/40491) ([mini4](https://github.com/mini4)).
* Исправлена ошибка (состояние гонки), возникающая при инициализации движка базы данных/таблицы MaterializedPostgreSQL. [#40262](https://github.com/ClickHouse/ClickHouse/issues/40262). Исправлена ошибка при исчерпании лимита слотов relcache&#95;callback&#95;list. [#40511](https://github.com/ClickHouse/ClickHouse/pull/40511) ([Maksim Buren](https://github.com/maks-buren630501)).
* Исправлена возможная ошибка «Decimal math overflow» при парсинге DateTime64. [#40546](https://github.com/ClickHouse/ClickHouse/pull/40546) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено вертикальное слияние частей с легковесно удалёнными строками. [#40559](https://github.com/ClickHouse/ClickHouse/pull/40559) ([Alexander Gololobov](https://github.com/davenger)).
* Исправлена ошибка сегментации при записи данных в движок таблицы URL при включённом сжатии. [#40565](https://github.com/ClickHouse/ClickHouse/pull/40565) ([Frank Chen](https://github.com/FrankChen021)).
* Исправлена возможная логическая ошибка `'Invalid Field get from type UInt64 to type String'` в функции arrayElement при работе с Map. [#40572](https://github.com/ClickHouse/ClickHouse/pull/40572) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена возможная гонка в кэше файловой системы. [#40586](https://github.com/ClickHouse/ClickHouse/pull/40586) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отменено пропускание мутаций в незатронутых партициях таблиц `MergeTree`, поскольку эта возможность никогда не работала корректно и могла приводить к «воскрешению» завершённых мутаций. [#40589](https://github.com/ClickHouse/ClickHouse/pull/40589) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Сервер ClickHouse аварийно завершится, если во время работы добавить в конфигурацию уже занятый gRPC-порт. [#40597](https://github.com/ClickHouse/ClickHouse/pull/40597) ([何李夫](https://github.com/helifu)).
* Исправлена обработка ведущего символа 0 / &#39;1&#39; в `base58Encode / base58Decode`. [#40620](https://github.com/ClickHouse/ClickHouse/pull/40620) ([Andrey Zvonov](https://github.com/zvonand)).
* keeper-fix: исправлено состояние гонки при доступе к журналам во время установки снапшота. [#40627](https://github.com/ClickHouse/ClickHouse/pull/40627) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено преждевременное прекращение выполнения функции toFixedString. Частично решает [#40622](https://github.com/ClickHouse/ClickHouse/issues/40622). [#40628](https://github.com/ClickHouse/ClickHouse/pull/40628) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено преобразование столбца int8 в SQLite в столбец int64 в ClickHouse. Исправлена проблема [#40639](https://github.com/ClickHouse/ClickHouse/issues/40639). [#40642](https://github.com/ClickHouse/ClickHouse/pull/40642) ([Barum Rho](https://github.com/barumrho)).
* Исправлено переполнение стека в рекурсивных таблицах `Buffer`. Это закрывает [#40637](https://github.com/ClickHouse/ClickHouse/issues/40637). [#40643](https://github.com/ClickHouse/ClickHouse/pull/40643) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Во время добавления нового запроса в `ProcessList` выполняются выделения памяти. Если при этих выделениях достигается лимит памяти, мы не можем использовать `OvercommitTracker`, потому что `ProcessList::mutex` уже захвачен. Исправляет [#40611](https://github.com/ClickHouse/ClickHouse/issues/40611). [#40677](https://github.com/ClickHouse/ClickHouse/pull/40677) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена ошибка LOGICAL&#95;ERROR при чтении меток с параметром max&#95;read&#95;buffer&#95;size=0. [#40705](https://github.com/ClickHouse/ClickHouse/pull/40705) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена утечка памяти при отправке данных в материализованные представления (MV) без контекста запроса (из Kafka/...). [#40732](https://github.com/ClickHouse/ClickHouse/pull/40732) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена возможная ошибка Attempt to read after eof при выводе схемы CSV. [#40746](https://github.com/ClickHouse/ClickHouse/pull/40746) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена логическая ошибка в кэше сквозной записи: «завершение файлового сегмента может выполняться только загрузчиком». Закрыта задача [#40748](https://github.com/ClickHouse/ClickHouse/issues/40748). [#40759](https://github.com/ClickHouse/ClickHouse/pull/40759) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Результат функции GROUPING приведён в соответствие с SQL и другими СУБД. [#40762](https://github.com/ClickHouse/ClickHouse/pull/40762) ([Dmitry Novik](https://github.com/novikd)).
* В [#40595](https://github.com/ClickHouse/ClickHouse/issues/40595) было сообщено, что функция `host_regexp` некорректно работала при разрешении имён в адреса с использованием `/etc/hosts`. Проблема исправлена. [#40769](https://github.com/ClickHouse/ClickHouse/pull/40769) ([Arthur Passos](https://github.com/arthurpassos)).
* Исправлены инкрементные резервные копии для семейства движков Log. [#40827](https://github.com/ClickHouse/ClickHouse/pull/40827) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена крайне редкая ошибка, которая могла привести к потере данных при репликации с нулевым копированием. [#40844](https://github.com/ClickHouse/ClickHouse/pull/40844) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка, из-за которой при анализе ключевого условия происходил сбой, если одно и то же выражение множества строилось из разных столбцов. [#40850](https://github.com/ClickHouse/ClickHouse/pull/40850) ([Duc Canh Le](https://github.com/canhld94)).
* Исправлен вывод схемы для вложенных объектов JSON. [#40851](https://github.com/ClickHouse/ClickHouse/pull/40851) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка, из-за которой каталоги с трехзначным префиксом для файлов кеша файловой системы не удалялись, если были пустыми. Закрывает [#40797](https://github.com/ClickHouse/ClickHouse/issues/40797). [#40867](https://github.com/ClickHouse/ClickHouse/pull/40867) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проблема, из-за которой возникала необработанная ошибка DNS&#95;ERROR при неудачном подключении к репликам. [#40881](https://github.com/ClickHouse/ClickHouse/pull/40881) ([Robert Coelho](https://github.com/coelho)).
* Исправлена ошибка при удалении ненужных столбцов в подзапросе. [#40884](https://github.com/ClickHouse/ClickHouse/pull/40884) ([luocongkai](https://github.com/TKaxe)).
* Исправлено избыточное выделение памяти для буферов удалённого чтения. [#40896](https://github.com/ClickHouse/ClickHouse/pull/40896) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено поведение, при котором пользователь, у которого было явно отозвано право на удаление баз данных, всё ещё мог их удалять. [#40906](https://github.com/ClickHouse/ClickHouse/pull/40906) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправление в ClickHouse Keeper: теперь пути в запросах на запись корректно сравниваются с путями внутренних системных узлов Keeper. [#40918](https://github.com/ClickHouse/ClickHouse/pull/40918) ([Antonio Andelic](https://github.com/antonio2368)).
* Устранена взаимоблокировка в WriteBufferFromS3. [#40943](https://github.com/ClickHouse/ClickHouse/pull/40943) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлены права доступа для `DESCRIBE TABLE url()` и некоторых других вариантов `DESCRIBE TABLE <table_function>()`. [#40975](https://github.com/ClickHouse/ClickHouse/pull/40975) ([Vitaly Baranov](https://github.com/vitlibar)).
* Удалена некорректная логика парсера конструкции `WITH GROUPING SETS`, которая могла приводить к разыменованию нулевого указателя. [#41049](https://github.com/ClickHouse/ClickHouse/pull/41049) ([Duc Canh Le](https://github.com/canhld94)).
* Исправление в ClickHouse Keeper: устранена возможная ошибка сегментации при остановке Keeper. [#41075](https://github.com/ClickHouse/ClickHouse/pull/41075) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлены возможные сегфолты, ошибка use-heap-after-free и утечки памяти в комбинаторах агрегатных функций. Закрывает [#40848](https://github.com/ClickHouse/ClickHouse/issues/40848). [#41083](https://github.com/ClickHouse/ClickHouse/pull/41083) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен query&#95;views&#95;log для Window Views. [#41132](https://github.com/ClickHouse/ClickHouse/pull/41132) ([Raúl Marín](https://github.com/Algunenano)).
* По умолчанию отключает `optimize&#95;monotonous&#95;functions&#95;in&#95;order&#95;by`, что смягчает проблему: [#40094](https://github.com/ClickHouse/ClickHouse/issues/40094). [#41136](https://github.com/ClickHouse/ClickHouse/pull/41136) ([Denny Crane](https://github.com/den-crane)).
* Исправлена ошибка «possible deadlock avoided» при автоматическом преобразовании движка базы данных с Ordinary на Atomic. [#41146](https://github.com/ClickHouse/ClickHouse/pull/41146) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена ошибка SIGSEGV в `SortedBlocksWriter` в случае пустого блока (возможна при `optimize_aggregation_in_order` и `join_algorithm=auto`). [#41154](https://github.com/ClickHouse/ClickHouse/pull/41154) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен неверный результат запроса при включённой тривиальной оптимизации `count` в сочетании с операцией `ARRAY JOIN`. Это исправляет [#39431](https://github.com/ClickHouse/ClickHouse/issues/39431). [#41158](https://github.com/ClickHouse/ClickHouse/pull/41158) ([Denny Crane](https://github.com/den-crane)).
* Устранена проблема stack-use-after-return в GetPriorityForLoadBalancing::getPriorityFunc(). [#41159](https://github.com/ClickHouse/ClickHouse/pull/41159) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено исключение `Positional argument out of bounds` при использовании позиционных аргументов. Закрывает [#40634](https://github.com/ClickHouse/ClickHouse/issues/40634). [#41189](https://github.com/ClickHouse/ClickHouse/pull/41189) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена фоновая очистка повреждённых отсоединённых частей. [#41190](https://github.com/ClickHouse/ClickHouse/pull/41190) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено экспоненциальное переписывание запроса при большом количестве `CROSS JOIN` с условиями `WHERE`, закрыт [#21557](https://github.com/ClickHouse/ClickHouse/issues/21557). [#41223](https://github.com/ClickHouse/ClickHouse/pull/41223) ([Vladimir C](https://github.com/vdimir)).
* Исправлена потенциальная логическая ошибка в кэше сквозной записи, которая возникала из-за того, что не все типы исключений корректно обрабатывались. Закрывает [#41208](https://github.com/ClickHouse/ClickHouse/issues/41208). [#41232](https://github.com/ClickHouse/ClickHouse/pull/41232) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена запись журнала с типом String в таблице system.filesystem&#95;cache&#95;log. [#41233](https://github.com/ClickHouse/ClickHouse/pull/41233) ([jmimbrero](https://github.com/josemimbrero-tinybird)).
* Запросы с предложением `OFFSET` в подзапросе и предложением `WHERE` во внешнем запросе могли возвращать некорректный результат, это исправлено. Исправление для [#40416](https://github.com/ClickHouse/ClickHouse/issues/40416). [#41280](https://github.com/ClickHouse/ClickHouse/pull/41280) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлена возможная ошибка в результате выполнения запроса при включённой настройке `query_plan_optimize_primary_key`. Исправляет [#40599](https://github.com/ClickHouse/ClickHouse/issues/40599). [#41281](https://github.com/ClickHouse/ClickHouse/pull/41281) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Не допускать, чтобы некорректные последовательности влияли на другие строки в lowerUTF8/upperUTF8. [#41286](https://github.com/ClickHouse/ClickHouse/pull/41286) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены запросы `ALTER <table> ADD COLUMN` со столбцами типа `Object`. [#41290](https://github.com/ClickHouse/ClickHouse/pull/41290) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка &quot;No node&quot; при выборке из `system.distributed_ddl_queue` при отсутствии параметра `distributed_ddl.path` в конфигурации. Исправление для [#41096](https://github.com/ClickHouse/ClickHouse/issues/41096). [#41296](https://github.com/ClickHouse/ClickHouse/pull/41296) ([young scott](https://github.com/young-scott)).
* Исправлено некорректное сообщение логической ошибки `Expected relative path` в объектном хранилище диска. Связано с [#41246](https://github.com/ClickHouse/ClickHouse/issues/41246). [#41297](https://github.com/ClickHouse/ClickHouse/pull/41297) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена проверка типа столбца перед вставкой UUID в формате MsgPack. [#41309](https://github.com/ClickHouse/ClickHouse/pull/41309) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена возможная аварийная остановка после асинхронной вставки (при включённой настройке `async_insert`) некорректных данных в столбцы типа `Object`. Она могла происходить, если JSON-данные во всех пакетах асинхронных вставок были некорректными и не могли быть разобраны. [#41336](https://github.com/ClickHouse/ClickHouse/pull/41336) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена возможная взаимоблокировка при использовании async&#95;socket&#95;for&#95;remote/use&#95;hedged&#95;requests и параллельном выполнении команды KILL. [#41343](https://github.com/ClickHouse/ClickHouse/pull/41343) ([Azat Khuzhin](https://github.com/azat)).
* По умолчанию отключает optimize&#95;rewrite&#95;sum&#95;if&#95;to&#95;count&#95;if, снижает влияние проблем: [#38605](https://github.com/ClickHouse/ClickHouse/issues/38605) [#38683](https://github.com/ClickHouse/ClickHouse/issues/38683). [#41388](https://github.com/ClickHouse/ClickHouse/pull/41388) ([Denny Crane](https://github.com/den-crane)).
* Начиная с версии 22.8 предложение `ON CLUSTER` игнорируется, если база данных имеет тип `Replicated`, а имя кластера и имя базы данных совпадают. Из-за этого `DROP PARTITION ON CLUSTER` работал непредсказуемым образом с `Replicated`. Это исправлено, теперь предложение `ON CLUSTER` игнорируется только для запросов, которые реплицируются на уровне базы данных. Исправлена ошибка [#41299](https://github.com/ClickHouse/ClickHouse/issues/41299). [#41390](https://github.com/ClickHouse/ClickHouse/pull/41390) ([Alexander Tokmakov](https://github.com/tavplubix)).
* Исправлено возможное зависание/взаимная блокировка при отмене запроса (`KILL QUERY` или остановке сервера). [#41467](https://github.com/ClickHouse/ClickHouse/pull/41467) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена возможная причина сбоя сервера при использовании функции JBOD. Это исправляет [#41365](https://github.com/ClickHouse/ClickHouse/issues/41365). [#41483](https://github.com/ClickHouse/ClickHouse/pull/41483) ([Amos Bird](https://github.com/amosbird)).
* Исправлено преобразование из Nullable(FixedString) в String. [#41541](https://github.com/ClickHouse/ClickHouse/pull/41541) ([Duc Canh Le](https://github.com/canhld94)).
* Предотвращен сбой при передаче некорректных состояний агрегации в groupBitmap*. [#41563](https://github.com/ClickHouse/ClickHouse/pull/41563) ([Raúl Marín](https://github.com/Algunenano)).
* Запросы с `ORDER BY` и `1500 <= LIMIT <= max_block_size` могли возвращать некорректный результат с пропущенными строками в начале. Исправлена [#41182](https://github.com/ClickHouse/ClickHouse/issues/41182). [#41576](https://github.com/ClickHouse/ClickHouse/pull/41576) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлены значения прочитанных байт/строк в X-ClickHouse-Summary при использовании материализованных представлений. [#41586](https://github.com/ClickHouse/ClickHouse/pull/41586) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлено возможное возникновение исключения `pipeline stuck` для запросов с `OFFSET`. Ошибка проявлялась при `enable_optimize_predicate_expression = 0` и всегда ложном условии в `WHERE`. Исправляет [#41383](https://github.com/ClickHouse/ClickHouse/issues/41383). [#41588](https://github.com/ClickHouse/ClickHouse/pull/41588) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).

### <a id="228"></a> Релиз ClickHouse 22.8, 2022-08-18 {#a-id228a-clickhouse-release-228-2022-08-18}

#### Обратно несовместимые изменения {#backward-incompatible-change-3}

- Расширен диапазон типов `Date32` и `DateTime64` для поддержки дат с 1900 по 2299 год. В предыдущих версиях поддерживался только интервал с 1925 по 2283 год. В реализации используется пролептический григорианский календарь (соответствующий стандарту [ISO 8601](https://en.wikipedia.org/wiki/ISO_8601):2004 (раздел 3.2.1 «Григорианский календарь»)) вместо учёта исторических переходов от юлианского к григорианскому календарю. Это изменение влияет на поведение реализации для аргументов вне допустимого диапазона. Например, если в предыдущих версиях значение `1899-01-01` ограничивалось значением `1925-01-01`, то в новой версии оно будет ограничено значением `1900-01-01`. Изменяется поведение округления с помощью `toStartOfInterval` при передаче `INTERVAL 3 QUARTER` с точностью до одного квартала, поскольку интервалы отсчитываются от определённой в реализации точки времени. Закрывает [#28216](https://github.com/ClickHouse/ClickHouse/issues/28216), улучшает [#38393](https://github.com/ClickHouse/ClickHouse/issues/38393). [#39425](https://github.com/ClickHouse/ClickHouse/pull/39425) ([Roman Vasin](https://github.com/rvasin)).
- Теперь все соответствующие источники словарей учитывают настройку `remote_url_allow_hosts`. Ранее это было реализовано для HTTP, Cassandra, Redis. Добавлена поддержка для ClickHouse, MongoDB, MySQL, PostgreSQL. Хост проверяется только для словарей, созданных с помощью DDL. [#39184](https://github.com/ClickHouse/ClickHouse/pull/39184) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Предварительно собранные бинарные файлы ClickHouse для x86 теперь требуют поддержки инструкций AVX, то есть процессор не старше Intel Sandy Bridge / AMD Bulldozer (оба выпущены в 2011 году). [#39000](https://github.com/ClickHouse/ClickHouse/pull/39000) ([Robert Schulze](https://github.com/rschu1ze)).
- Кеш удалённой файловой системы сделан компонуемым, добавлена возможность не вытеснять определённые файлы (например, idx, mrk и т. д.), удалена старая версия кеша. Теперь можно настроить кеш поверх диска Azure Blob Storage, локального диска, диска StaticWeb и т. д. Этот PR отмечен как обратно несовместимый, поскольку изменяется конфигурация кеша, и для его работы необходимо обновить конфигурационный файл. Старый кеш по-прежнему будет использоваться с новой конфигурацией. Сервер запустится без проблем со старой конфигурацией кеша. Закрывает https://github.com/ClickHouse/ClickHouse/issues/36140. Закрывает https://github.com/ClickHouse/ClickHouse/issues/37889. ([Kseniia Sumarokova](https://github.com/kssenii)). [#36171](https://github.com/ClickHouse/ClickHouse/pull/36171))


#### Новая функциональность {#new-feature-4}

- Поддержка стандартного SQL-синтаксиса DELETE FROM для таблиц семейства MergeTree и облегченная реализация удаления для семейства MergeTree. [#37893](https://github.com/ClickHouse/ClickHouse/pull/37893) ([Jianmei Zhang](https://github.com/zhangjmruc)) ([Alexander Gololobov](https://github.com/davenger)). Примечание: эта новая функциональность не делает ClickHouse HTAP-СУБД.
- Параметры запроса можно задавать в интерактивном режиме как `SET param_abc = 'def'` и передавать через нативный протокол в качестве настроек. [#39906](https://github.com/ClickHouse/ClickHouse/pull/39906) ([Nikita Taranov](https://github.com/nickitat)).
- Ключ квоты можно задавать в нативном протоколе ([Yakov Olkhovsky](https://github.com/ClickHouse/ClickHouse/pull/39874)).
- Добавлена настройка `exact_rows_before_limit` (0/1). При включении ClickHouse будет предоставлять точное значение для статистики `rows_before_limit_at_least`, но ценой полного чтения данных до применения лимита. Закрывает [#6613](https://github.com/ClickHouse/ClickHouse/issues/6613). [#25333](https://github.com/ClickHouse/ClickHouse/pull/25333) ([kevin wan](https://github.com/MaxWk)).
- Добавлена поддержка параллельного распределенного INSERT SELECT с табличной функцией `s3Cluster` в таблицы с движками `Distributed` и `Replicated` [#34670](https://github.com/ClickHouse/ClickHouse/issues/34670). [#39107](https://github.com/ClickHouse/ClickHouse/pull/39107) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Добавлены новые настройки для управления автоматическим определением схемы из текстовых форматов: - `input_format_try_infer_dates` — попытка определить даты из строк. - `input_format_try_infer_datetimes` — попытка определить дату и время из строк. - `input_format_try_infer_integers` — попытка определить `Int64` вместо `Float64`. - `input_format_json_try_infer_numbers_from_strings` — попытка определить числа из JSON-строк в форматах JSON. [#39186](https://github.com/ClickHouse/ClickHouse/pull/39186) ([Kruglov Pavel](https://github.com/Avogar)).
- Опция для вывода логов в формате JSON. Цель — упростить загрузку и выполнение запросов в инструментах анализа логов. [#39277](https://github.com/ClickHouse/ClickHouse/pull/39277) ([Mallik Hassan](https://github.com/SadiHassan)).
- Добавлена функция `nowInBlock`, которая позволяет получать текущее время во время выполнения длительных и непрерывных запросов. Закрывает [#39522](https://github.com/ClickHouse/ClickHouse/issues/39522). Примечание: функции `now64InBlock` и `todayInBlock` не существуют. [#39533](https://github.com/ClickHouse/ClickHouse/pull/39533) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлена возможность указывать настройки для табличной функции `executable()`. [#39681](https://github.com/ClickHouse/ClickHouse/pull/39681) ([Constantine Peresypkin](https://github.com/pkit)).
- Реализовано автоматическое преобразование движка базы данных из `Ordinary` в `Atomic`. Создайте пустой файл `convert_ordinary_to_atomic` в директории `flags`, и все базы данных `Ordinary` будут автоматически преобразованы при следующем запуске сервера. Решает [#39546](https://github.com/ClickHouse/ClickHouse/issues/39546). [#39933](https://github.com/ClickHouse/ClickHouse/pull/39933) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Поддержка `SELECT ... INTO OUTFILE '...' AND STDOUT`. [#37490](https://github.com/ClickHouse/ClickHouse/issues/37490). [#39054](https://github.com/ClickHouse/ClickHouse/pull/39054) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni)).
- Добавлены форматы `PrettyMonoBlock`, `PrettyNoEscapesMonoBlock`, `PrettyCompactNoEscapes`, `PrettyCompactNoEscapesMonoBlock`, `PrettySpaceNoEscapes`, `PrettySpaceMonoBlock`, `PrettySpaceNoEscapesMonoBlock`. [#39646](https://github.com/ClickHouse/ClickHouse/pull/39646) ([Kruglov Pavel](https://github.com/Avogar)).


#### Улучшение производительности {#performance-improvement-4}

- Улучшено использование памяти при эффективном по памяти слиянии результатов агрегации. [#39429](https://github.com/ClickHouse/ClickHouse/pull/39429) ([Nikita Taranov](https://github.com/nickitat)).
- Добавлена логика управления параллелизмом для ограничения общего количества одновременных потоков, создаваемых запросами. [#37558](https://github.com/ClickHouse/ClickHouse/pull/37558) ([Sergei Trifonov](https://github.com/serxa)). Добавлен параметр `concurrent_threads_soft_limit` для повышения производительности при высоком QPS путем ограничения общего количества потоков для всех запросов. [#37285](https://github.com/ClickHouse/ClickHouse/pull/37285) ([Roman Vasin](https://github.com/rvasin)).
- Добавлена политика кэширования `SLRU` для кэша несжатых данных и кэша меток. ([Kseniia Sumarokova](https://github.com/kssenii)). [#34651](https://github.com/ClickHouse/ClickHouse/pull/34651) ([alexX512](https://github.com/alexX512)). Разделение функции локального кэша и алгоритма кэширования [#38048](https://github.com/ClickHouse/ClickHouse/pull/38048) ([Han Shukai](https://github.com/KinderRiven)).
- Intel® In-Memory Analytics Accelerator (Intel® IAA) — это аппаратный ускоритель, доступный в следующем поколении процессоров Intel® Xeon® Scalable («Sapphire Rapids»). Его цель — ускорить распространенные операции в аналитике, такие как сжатие/распаковка данных и фильтрация. В ClickHouse добавлен новый кодек сжатия «DeflateQpl», который использует технологию аппаратной разгрузки Intel® IAA для обеспечения высокопроизводительной реализации DEFLATE. Кодек использует [Intel® Query Processing Library (QPL)](https://github.com/intel/qpl), которая абстрагирует доступ к аппаратному ускорителю или к программному резервному варианту в случае недоступности аппаратного ускорителя. DEFLATE обеспечивает в целом более высокие степени сжатия, чем стандартный кодек LZ4 в ClickHouse, и в результате снижает количество операций ввода-вывода на диске и потребление основной памяти. [#36654](https://github.com/ClickHouse/ClickHouse/pull/36654) ([jasperzhu](https://github.com/jinjunzh)). [#39494](https://github.com/ClickHouse/ClickHouse/pull/39494) ([Robert Schulze](https://github.com/rschu1ze)).
- `DISTINCT` в сочетании с `ORDER BY`: определение способа сортировки на основе описания сортировки входного потока. Пропуск сортировки, если входной поток уже отсортирован. [#38719](https://github.com/ClickHouse/ClickHouse/pull/38719) ([Igor Nikonov](https://github.com/devcrafter)). Улучшение использования памяти (значительное) и времени выполнения запроса + использование `DistinctSortedChunkTransform` для финального distinct, когда столбцы `DISTINCT` совпадают со столбцами `ORDER BY`, с переименованием в `DistinctSortedStreamTransform` в `EXPLAIN PIPELINE` → это значительно улучшает использование памяти + удаление ненужных выделений памяти в горячем цикле в `DistinctSortedChunkTransform`. [#39432](https://github.com/ClickHouse/ClickHouse/pull/39432) ([Igor Nikonov](https://github.com/devcrafter)). Использование `DistinctSortedTransform` только когда описание сортировки применимо к столбцам DISTINCT, в противном случае возврат к обычной реализации DISTINCT + это позволяет выполнять меньше проверок во время выполнения `DistinctSortedTransform`. [#39528](https://github.com/ClickHouse/ClickHouse/pull/39528) ([Igor Nikonov](https://github.com/devcrafter)). Исправление: `DistinctSortedTransform` не использовал преимущества сортировки. Он никогда не очищал HashSet, поскольку clearing_columns определялись неправильно (всегда пустые). Таким образом, он фактически работал как обычный `DISTINCT` (`DistinctTransform`). Исправление значительно снижает использование памяти. [#39538](https://github.com/ClickHouse/ClickHouse/pull/39538) ([Igor Nikonov](https://github.com/devcrafter)).
- Использование локального узла в качестве первого приоритета для получения структуры удаленной таблицы при выполнении табличных функций `cluster` и подобных. [#39440](https://github.com/ClickHouse/ClickHouse/pull/39440) ([Mingliang Pan](https://github.com/liangliangpan)).
- Оптимизация фильтрации по числовым столбцам с использованием сжатого хранения AVX512VBMI2. [#39633](https://github.com/ClickHouse/ClickHouse/pull/39633) ([Guo Wangyang](https://github.com/guowangy)). Для систем с AVX512 VBMI2 это изменение улучшает производительность примерно на 6% для запросов бенчмарка SSB 3.1, 3.2 и 3.3 (SF=100). Протестировано на Intel Icelake Xeon 8380 \* 2 сокета. [#40033](https://github.com/ClickHouse/ClickHouse/pull/40033) ([Robert Schulze](https://github.com/rschu1ze)).
- Оптимизация анализа индексов с функциональными выражениями в многопоточном сценарии. [#39812](https://github.com/ClickHouse/ClickHouse/pull/39812) ([Guo Wangyang](https://github.com/guowangy)).
- Оптимизации для сложных запросов: не обходить AST для пользовательских функций, если они не зарегистрированы. [#40069](https://github.com/ClickHouse/ClickHouse/pull/40069) ([Raúl Marín](https://github.com/Algunenano)). Оптимизация выделения и освобождения памяти в CurrentMemoryTracker. [#40078](https://github.com/ClickHouse/ClickHouse/pull/40078) ([Raúl Marín](https://github.com/Algunenano)).
- Улучшено кодирование/декодирование Base58. [#39292](https://github.com/ClickHouse/ClickHouse/pull/39292) ([Andrey Zvonov](https://github.com/zvonand)).
- Улучшено преобразование байтов в битовую маску для SSE/AVX/AVX512. [#39586](https://github.com/ClickHouse/ClickHouse/pull/39586) ([Guo Wangyang](https://github.com/guowangy)).





#### Улучшение {#improvement-4}

- Нормализация типов `AggregateFunction` и представлений состояний, поскольку оптимизации, такие как [#35788](https://github.com/ClickHouse/ClickHouse/pull/35788), будут обрабатывать `count(not null columns)` как `count()`, что может привести к путанице распределённых интерпретаторов со следующей ошибкой: `Conversion from AggregateFunction(count) to AggregateFunction(count, Int64) is not supported`. [#39420](https://github.com/ClickHouse/ClickHouse/pull/39420) ([Amos Bird](https://github.com/amosbird)). Функции с идентичными состояниями могут использоваться в материализованных представлениях взаимозаменяемо.
- Переработка и упрощение таблицы `system.backups`, удаление столбца `internal`, возможность для пользователя задавать идентификатор операции, добавление столбцов `num_files`, `uncompressed_size`, `compressed_size`, `start_time`, `end_time`. [#39503](https://github.com/ClickHouse/ClickHouse/pull/39503) ([Vitaly Baranov](https://github.com/vitlibar)).
- Улучшенная структура таблицы результатов DDL-запросов для базы данных `Replicated` (отдельные столбцы с именем шарда и реплики, более понятный статус) - запросы `CREATE TABLE ... ON CLUSTER` могут быть нормализованы сначала на инициаторе, если `distributed_ddl_entry_format_version` установлен в 3 (значение по умолчанию). Это означает, что запросы `ON CLUSTER` могут не работать, если инициатор не принадлежит кластеру, указанному в запросе. Исправляет [#37318](https://github.com/ClickHouse/ClickHouse/issues/37318), [#39500](https://github.com/ClickHouse/ClickHouse/issues/39500) - Игнорирование конструкции `ON CLUSTER`, если база данных является `Replicated` и имя кластера совпадает с именем базы данных. Связано с [#35570](https://github.com/ClickHouse/ClickHouse/issues/35570) - Различные мелкие исправления для движка базы данных `Replicated` - Проверка согласованности метаданных при запуске базы данных `Replicated`, запуск восстановления реплики в случае несоответствия локальных метаданных и метаданных в Keeper. Решает [#24880](https://github.com/ClickHouse/ClickHouse/issues/24880). [#37198](https://github.com/ClickHouse/ClickHouse/pull/37198) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Добавление result_rows и result_bytes в отчёты о прогрессе (`X-ClickHouse-Summary`). [#39567](https://github.com/ClickHouse/ClickHouse/pull/39567) ([Raúl Marín](https://github.com/Algunenano)).
- Улучшение анализа первичного ключа для MergeTree. [#25563](https://github.com/ClickHouse/ClickHouse/pull/25563) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- `timeSlots` теперь работает с DateTime64; доступны длительность и размер слота с точностью до долей секунды при работе с DateTime64. [#37951](https://github.com/ClickHouse/ClickHouse/pull/37951) ([Andrey Zvonov](https://github.com/zvonand)).
- Добавлена поддержка прямого соединения `LEFT SEMI` и `LEFT ANTI` с таблицами `EmbeddedRocksDB`. [#38956](https://github.com/ClickHouse/ClickHouse/pull/38956) ([Vladimir C](https://github.com/vdimir)).
- Добавление событий профилирования для операций fsync. [#39179](https://github.com/ClickHouse/ClickHouse/pull/39179) ([Azat Khuzhin](https://github.com/azat)).
- Добавление второго аргумента к обычной функции `file(path[, default])`, который функция возвращает в случае, когда файл не существует. [#39218](https://github.com/ClickHouse/ClickHouse/pull/39218) ([Nikolay Degterinsky](https://github.com/evillique)).
- Несколько небольших исправлений для чтения через http, разрешение повторной попытки получения частичного содержимого в случае 200 OK. [#39244](https://github.com/ClickHouse/ClickHouse/pull/39244) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Поддержка запросов `CREATE TEMPORARY TABLE ... (<list of columns>) AS ...`. [#39462](https://github.com/ClickHouse/ClickHouse/pull/39462) ([Kruglov Pavel](https://github.com/Avogar)).
- Добавление поддержки `!`/`*` (восклицательный знак/звёздочка) в пользовательских доменах верхнего уровня (`cutToFirstSignificantSubdomainCustom()`/`cutToFirstSignificantSubdomainCustomWithWWW()`/`firstSignificantSubdomainCustom()`). [#39496](https://github.com/ClickHouse/ClickHouse/pull/39496) ([Azat Khuzhin](https://github.com/azat)).
- Добавление поддержки TLS-соединений с NATS. Реализует [#39525](https://github.com/ClickHouse/ClickHouse/issues/39525). [#39527](https://github.com/ClickHouse/ClickHouse/pull/39527) ([Constantine Peresypkin](https://github.com/pkit)).
- `clickhouse-obfuscator` (инструмент для обфускации базы данных для тестирования и генерации нагрузки) теперь имеет новые параметры `--save` и `--load` для работы с предварительно обученными моделями. Закрывает [#39534](https://github.com/ClickHouse/ClickHouse/issues/39534). [#39541](https://github.com/ClickHouse/ClickHouse/pull/39541) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Исправление некорректного поведения ротации логов при перезапуске. [#39558](https://github.com/ClickHouse/ClickHouse/pull/39558) ([Nikolay Degterinsky](https://github.com/evillique)).
- Исправление построения агрегатных проекций при включённой внешней агрегации. Отмечено как улучшение, поскольку случай редкий и существует простое обходное решение через изменение настроек. Исправляет [#39667](https://github.com/ClickHouse/ClickHouse/issues/39667) . [#39671](https://github.com/ClickHouse/ClickHouse/pull/39671) ([Amos Bird](https://github.com/amosbird)).
- Разрешение выполнения хеш-функций с аргументами типа `Map`. [#39685](https://github.com/ClickHouse/ClickHouse/pull/39685) ([Anton Popov](https://github.com/CurtizJ)).
- Добавление параметра конфигурации для сокрытия адресов в трассировках стека. Это может немного улучшить безопасность, но в целом это вредно и не должно использоваться. [#39690](https://github.com/ClickHouse/ClickHouse/pull/39690) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Изменение размера префикса AggregateFunctionDistinct для обеспечения выравнивания сегмента памяти данных вложенной функции. [#39696](https://github.com/ClickHouse/ClickHouse/pull/39696) ([Pxl](https://github.com/BiteTheDDDDt)).
- Правильное экранирование учётных данных, передаваемых инструменту `clickhouse-diagnostic`. [#39707](https://github.com/ClickHouse/ClickHouse/pull/39707) ([Dale McDiarmid](https://github.com/gingerwizard)).
- Улучшение ClickHouse Keeper: создание снимка при выходе. Управляется параметром конфигурации `keeper_server.create_snapshot_on_exit`, по умолчанию `true`. [#39755](https://github.com/ClickHouse/ClickHouse/pull/39755) ([Antonio Andelic](https://github.com/antonio2368)).
- Поддержка анализа первичного ключа для `row_policy_filter` и `additional_filter`. Также помогает исправить проблемы, подобные [#37454](https://github.com/ClickHouse/ClickHouse/issues/37454) . [#39826](https://github.com/ClickHouse/ClickHouse/pull/39826) ([Amos Bird](https://github.com/amosbird)).
- Исправление двух проблем удобства использования в Play UI: - отображение было неточным на iPad из-за паразитных радиусов границ и отступов; - индикатор прогресса не отображался после первого запроса. Закрывает [#39957](https://github.com/ClickHouse/ClickHouse/issues/39957). Закрывает [#39960](https://github.com/ClickHouse/ClickHouse/issues/39960). [#39961](https://github.com/ClickHouse/ClickHouse/pull/39961) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Play UI: добавление номеров строк; добавление выбора ячейки по клику; добавление гистерезиса для ячеек таблицы. [#39962](https://github.com/ClickHouse/ClickHouse/pull/39962) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Play UI: распознавание клавиши Tab в текстовой области, но при этом без нарушения навигации по вкладкам. [#40053](https://github.com/ClickHouse/ClickHouse/pull/40053) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Клиент будет показывать время выполнения на стороне сервера. Это важно для сравнения производительности сервисов ClickHouse в удалённых дата-центрах. Закрывает [#38070](https://github.com/ClickHouse/ClickHouse/issues/38070). См. также [это](https://github.com/ClickHouse/ClickBench/blob/main/hardware/benchmark-cloud.sh#L37) для понимания мотивации. [#39968](https://github.com/ClickHouse/ClickHouse/pull/39968) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавление функций `parseDateTime64BestEffortUS`, `parseDateTime64BestEffortUSOrNull`, `parseDateTime64BestEffortUSOrZero`, закрывает [#37492](https://github.com/ClickHouse/ClickHouse/issues/37492). [#40015](https://github.com/ClickHouse/ClickHouse/pull/40015) ([Tanya Bragin](https://github.com/tbragin)).
- Расширение `system.processors_profile_log` дополнительной информацией, такой как входные строки. [#40121](https://github.com/ClickHouse/ClickHouse/pull/40121) ([Amos Bird](https://github.com/amosbird)).
- Отображение времени на стороне сервера в `clickhouse-benchmark` по умолчанию, если оно доступно (начиная с версии ClickHouse 22.8). Это необходимо для корректного сравнения производительности облачных решений. Это поведение можно изменить с помощью новой опции командной строки `--client-side-time`. Изменение опции командной строки `--randomize` с `--randomize 1` на форму без аргумента. [#40193](https://github.com/ClickHouse/ClickHouse/pull/40193) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавление счётчиков (ProfileEvents) для случаев, когда установлено ограничение сложности запроса и оно достигнуто (отдельный счётчик для `overflow_mode` = `break` и `throw`). Например, если вы настроили `max_rows_to_read` с `read_overflow_mode = 'break'`, просмотр значения счётчика `OverflowBreak` позволит различать неполные результаты. [#40205](https://github.com/ClickHouse/ClickHouse/pull/40205) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Исправление учёта памяти в случае ошибок «Memory limit exceeded» (ранее [пиковое] использование памяти учитывало неудачные выделения). [#40249](https://github.com/ClickHouse/ClickHouse/pull/40249) ([Azat Khuzhin](https://github.com/azat)).
- Добавление метрик для кеша файловой системы: `FilesystemCacheSize` и `FilesystemCacheElements`. [#40260](https://github.com/ClickHouse/ClickHouse/pull/40260) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Поддержка безопасной передачи RPC hadoop (hadoop.rpc.protection=privacy и hadoop.rpc.protection=integrity). [#39411](https://github.com/ClickHouse/ClickHouse/pull/39411) ([michael1589](https://github.com/michael1589)).
- Предотвращение непрерывного роста потребления памяти кешем шаблонов при использовании функций multi(Fuzzy)Match(Any|AllIndices|AnyIndex)(). [#40264](https://github.com/ClickHouse/ClickHouse/pull/40264) ([Robert Schulze](https://github.com/rschu1ze)).





#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-4}

- [ClickFiddle](https://fiddle.clickhouse.com/): Новый инструмент для тестирования версий ClickHouse в режиме чтения/записи (**Igor Baliuk**).
- Бинарный файл ClickHouse теперь является самораспаковывающимся [#35775](https://github.com/ClickHouse/ClickHouse/pull/35775) ([Yakov Olkhovskiy, Arthur Filatenkov](https://github.com/yakov-olkhovskiy)).
- Обновление tzdata до версии 2022b для поддержки новых изменений часовых поясов. См. https://github.com/google/cctz/pull/226. Начало перехода на летнее время в Чили в 2022 году перенесено с 4 сентября на 11 сентября. Иран планирует окончательно прекратить переход на летнее время после возврата на зимнее время 21 сентября 2022 года. Внесены исправления в исторический часовой пояс Asia/Tehran за 1977 год: Иран принял стандартное время в 1935 году, а не в 1946. В 1977 году летнее время действовало с 21 марта 23:00 до 20 октября 24:00; переходы в 1978 году произошли 24 марта и 5 августа, а не 20 марта и 20 октября; весенний переход 1979 года состоялся 27 мая, а не 21 марта (https://data.iana.org/time-zones/tzdb/NEWS). ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Ранее пакеты устанавливали файл systemd.service в `/etc`. Файлы там помечаются как `conf` и не удаляются, а также не обновляются автоматически. Данный PR удаляет их. [#39323](https://github.com/ClickHouse/ClickHouse/pull/39323) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Обеспечена эффективность работы LSan. [#39430](https://github.com/ClickHouse/ClickHouse/pull/39430) ([Azat Khuzhin](https://github.com/azat)).
- TSAN имеет проблемы с clang-14 (https://github.com/google/sanitizers/issues/1552, https://github.com/google/sanitizers/issues/1540), поэтому здесь мы собираем бинарные файлы TSAN с использованием clang-15. [#39450](https://github.com/ClickHouse/ClickHouse/pull/39450) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Удалена опция сборки инструментов ClickHouse в виде отдельных исполняемых программ. Это исправляет [#37847](https://github.com/ClickHouse/ClickHouse/issues/37847). [#39520](https://github.com/ClickHouse/ClickHouse/pull/39520) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Небольшая подготовка к сборке на s390x (архитектура с обратным порядком байтов). [#39627](https://github.com/ClickHouse/ClickHouse/pull/39627) ([Harry Lee](https://github.com/HarryLeeIBM)). [#39656](https://github.com/ClickHouse/ClickHouse/pull/39656) ([Harry Lee](https://github.com/HarryLeeIBM)). Исправлена проблема с порядком байтов в BitHelpers для s390x. [#39656](https://github.com/ClickHouse/ClickHouse/pull/39656) ([Harry Lee](https://github.com/HarryLeeIBM)). Реализован фрагмент кода, связанный с SipHash, для архитектуры s390x (которая не поддерживается ClickHouse). [#39732](https://github.com/ClickHouse/ClickHouse/pull/39732) ([Harry Lee](https://github.com/HarryLeeIBM)). Исправлена проблема с порядком байтов в коде снимков Coordination для архитектуры s390x (которая не поддерживается ClickHouse). [#39931](https://github.com/ClickHouse/ClickHouse/pull/39931) ([Harry Lee](https://github.com/HarryLeeIBM)). Исправлены проблемы с порядком байтов в коде Codec для архитектуры s390x (которая не поддерживается ClickHouse). [#40008](https://github.com/ClickHouse/ClickHouse/pull/40008) ([Harry Lee](https://github.com/HarryLeeIBM)). Исправлены проблемы с порядком байтов при чтении/записи двоичных данных BigEndian в коде ReadHelpers и WriteHelpers для архитектуры s390x (которая не поддерживается ClickHouse). [#40179](https://github.com/ClickHouse/ClickHouse/pull/40179) ([Harry Lee](https://github.com/HarryLeeIBM)).
- Поддержка сборки с `clang-16` (trunk). Это закрывает [#39949](https://github.com/ClickHouse/ClickHouse/issues/39949). [#40181](https://github.com/ClickHouse/ClickHouse/pull/40181) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Подготовка сборки RISC-V 64 для запуска в CI. Это для [#40141](https://github.com/ClickHouse/ClickHouse/issues/40141). [#40197](https://github.com/ClickHouse/ClickHouse/pull/40197) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Упрощен интерфейс макросов регистрации функций (`FUNCTION_REGISTER*`) для устранения необходимости добавления и вызова внешней функции в registerFunctions.cpp, что также ускоряет инкрементальные сборки новых функций. [#38615](https://github.com/ClickHouse/ClickHouse/pull/38615) ([Li Yin](https://github.com/liyinsg)).
- Docker: Теперь entrypoint.sh в образе Docker создает и выполняет chown для всех папок, найденных в конфигурации для многодисковой настройки [#17717](https://github.com/ClickHouse/ClickHouse/issues/17717). [#39121](https://github.com/ClickHouse/ClickHouse/pull/39121) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).





#### Исправление ошибок {#bug-fix-1}

- Fix possible segfault in `CapnProto` input format. This bug was found and send through ClickHouse bug-bounty [program](https://github.com/ClickHouse/ClickHouse/issues/38986) by _kiojj_. [#40241](https://github.com/ClickHouse/ClickHouse/pull/40241) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix a very rare case of incorrect behavior of array subscript operator. This closes [#28720](https://github.com/ClickHouse/ClickHouse/issues/28720). [#40185](https://github.com/ClickHouse/ClickHouse/pull/40185) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix insufficient argument check for encryption functions (found by query fuzzer). This closes [#39987](https://github.com/ClickHouse/ClickHouse/issues/39987). [#40194](https://github.com/ClickHouse/ClickHouse/pull/40194) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix the case when the order of columns can be incorrect if the `IN` operator is used with a table with `ENGINE = Set` containing multiple columns. This fixes [#13014](https://github.com/ClickHouse/ClickHouse/issues/13014). [#40225](https://github.com/ClickHouse/ClickHouse/pull/40225) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix seeking while reading from encrypted disk. This PR fixes [#38381](https://github.com/ClickHouse/ClickHouse/issues/38381). [#39687](https://github.com/ClickHouse/ClickHouse/pull/39687) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix duplicate columns in join plan. Finally, solve [#26809](https://github.com/ClickHouse/ClickHouse/issues/26809). [#40009](https://github.com/ClickHouse/ClickHouse/pull/40009) ([Vladimir C](https://github.com/vdimir)).
- Fixed query hanging for SELECT with ORDER BY WITH FILL with different date/time types. [#37849](https://github.com/ClickHouse/ClickHouse/pull/37849) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix ORDER BY that matches projections ORDER BY (before it simply returns unsorted result). [#38725](https://github.com/ClickHouse/ClickHouse/pull/38725) ([Azat Khuzhin](https://github.com/azat)).
- Do not optimise functions in GROUP BY statements if they shadow one of the table columns or expressions. Fixes [#37032](https://github.com/ClickHouse/ClickHouse/issues/37032). [#39103](https://github.com/ClickHouse/ClickHouse/pull/39103) ([Anton Kozlov](https://github.com/tonickkozlov)).
- Fix wrong table name in logs after RENAME TABLE. This fixes [#38018](https://github.com/ClickHouse/ClickHouse/issues/38018). [#39227](https://github.com/ClickHouse/ClickHouse/pull/39227) ([Amos Bird](https://github.com/amosbird)).
- Fix positional arguments in case of columns pruning when optimising the query. Closes [#38433](https://github.com/ClickHouse/ClickHouse/issues/38433). [#39293](https://github.com/ClickHouse/ClickHouse/pull/39293) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix bug in schema inference in case of empty messages in Protobuf/CapnProto formats that allowed to create column with empty `Tuple` type. Closes [#39051](https://github.com/ClickHouse/ClickHouse/issues/39051) Add 2 new settings `input_format_{protobuf/capnproto}_skip_fields_with_unsupported_types_in_schema_inference` that allow to skip fields with unsupported types while schema inference for Protobuf and CapnProto formats. [#39357](https://github.com/ClickHouse/ClickHouse/pull/39357) ([Kruglov Pavel](https://github.com/Avogar)).
- (Window View is an experimental feature) Fix segmentation fault on `CREATE WINDOW VIEW .. ON CLUSTER ... INNER`. Closes [#39363](https://github.com/ClickHouse/ClickHouse/issues/39363). [#39384](https://github.com/ClickHouse/ClickHouse/pull/39384) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix WriteBuffer finalize when cancelling insert into function (in previous versions it may leat to std::terminate). [#39458](https://github.com/ClickHouse/ClickHouse/pull/39458) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix storing of columns of type `Object` in sparse serialization. [#39464](https://github.com/ClickHouse/ClickHouse/pull/39464) ([Anton Popov](https://github.com/CurtizJ)).
- Fix possible "Not found column in block" exception when using projections. This closes [#39469](https://github.com/ClickHouse/ClickHouse/issues/39469). [#39470](https://github.com/ClickHouse/ClickHouse/pull/39470) ([小路](https://github.com/nicelulu)).
- Fix exception on race between DROP and INSERT with materialized views. [#39477](https://github.com/ClickHouse/ClickHouse/pull/39477) ([Azat Khuzhin](https://github.com/azat)).
- A bug in Apache Avro library: fix data race and possible heap-buffer-overflow in Avro format. Closes [#39094](https://github.com/ClickHouse/ClickHouse/issues/39094) Closes [#33652](https://github.com/ClickHouse/ClickHouse/issues/33652). [#39498](https://github.com/ClickHouse/ClickHouse/pull/39498) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix rare bug in asynchronous reading (with setting `local_filesystem_read_method='pread_threadpool'`) with enabled `O_DIRECT` (enabled by setting `min_bytes_to_use_direct_io`). [#39506](https://github.com/ClickHouse/ClickHouse/pull/39506) ([Anton Popov](https://github.com/CurtizJ)).
- (only on FreeBSD) Fixes "Code: 49. DB::Exception: FunctionFactory: the function name '' is not unique. (LOGICAL_ERROR)" observed on FreeBSD when starting clickhouse. [#39551](https://github.com/ClickHouse/ClickHouse/pull/39551) ([Alexander Gololobov](https://github.com/davenger)).
- Fix bug with the recently introduced "maxsplit" argument for `splitByChar`, which was not working correctly. [#39552](https://github.com/ClickHouse/ClickHouse/pull/39552) ([filimonov](https://github.com/filimonov)).
- Fix bug in ASOF JOIN with `enable_optimize_predicate_expression`, close [#37813](https://github.com/ClickHouse/ClickHouse/issues/37813). [#39556](https://github.com/ClickHouse/ClickHouse/pull/39556) ([Vladimir C](https://github.com/vdimir)).
- Fixed `CREATE/DROP INDEX` query with `ON CLUSTER` or `Replicated` database and `ReplicatedMergeTree`. It used to be executed on all replicas (causing error or DDL queue stuck). Fixes [#39511](https://github.com/ClickHouse/ClickHouse/issues/39511). [#39565](https://github.com/ClickHouse/ClickHouse/pull/39565) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix "column not found" error for push down with join, close [#39505](https://github.com/ClickHouse/ClickHouse/issues/39505). [#39575](https://github.com/ClickHouse/ClickHouse/pull/39575) ([Vladimir C](https://github.com/vdimir)).
- Fix the wrong `REGEXP_REPLACE` alias. This fixes https://github.com/ClickHouse/ClickBench/issues/9. [#39592](https://github.com/ClickHouse/ClickHouse/pull/39592) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fixed point of origin for exponential decay window functions to the last value in window. Previously, decay was calculated by formula `exp((t - curr_row_t) / decay_length)`, which is incorrect when right boundary of window is not `CURRENT ROW`. It was changed to: `exp((t - last_row_t) / decay_length)`. There is no change in results for windows with `ROWS BETWEEN (smth) AND CURRENT ROW`. [#39593](https://github.com/ClickHouse/ClickHouse/pull/39593) ([Vladimir Chebotaryov](https://github.com/quickhouse)).
- Fix Decimal division overflow, which can be detected based on operands scale. [#39600](https://github.com/ClickHouse/ClickHouse/pull/39600) ([Andrey Zvonov](https://github.com/zvonand)).
- Fix settings `output_format_arrow_string_as_string` and `output_format_arrow_low_cardinality_as_dictionary` work in combination. Closes [#39624](https://github.com/ClickHouse/ClickHouse/issues/39624). [#39647](https://github.com/ClickHouse/ClickHouse/pull/39647) ([Kruglov Pavel](https://github.com/Avogar)).
- Fixed a bug in default database resolution in distributed table reads. [#39674](https://github.com/ClickHouse/ClickHouse/pull/39674) ([Anton Kozlov](https://github.com/tonickkozlov)).
- (Only with the obsolete Ordinary databases) Select might read data of dropped table if cache for mmap IO is used and database engine is Ordinary and new tables was created with the same name as dropped one had. It's fixed. [#39708](https://github.com/ClickHouse/ClickHouse/pull/39708) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix possible error `Invalid column type for ColumnUnique::insertRangeFrom. Expected String, got ColumnLowCardinality` Fixes [#38460](https://github.com/ClickHouse/ClickHouse/issues/38460). [#39716](https://github.com/ClickHouse/ClickHouse/pull/39716) ([Arthur Passos](https://github.com/arthurpassos)).
- Field names in the `meta` section of JSON format were erroneously double escaped. This closes [#39693](https://github.com/ClickHouse/ClickHouse/issues/39693). [#39747](https://github.com/ClickHouse/ClickHouse/pull/39747) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix wrong index analysis with tuples and operator `IN`, which could lead to wrong query result. [#39752](https://github.com/ClickHouse/ClickHouse/pull/39752) ([Anton Popov](https://github.com/CurtizJ)).
- Fix `EmbeddedRocksDB` tables filtering by key using params. [#39757](https://github.com/ClickHouse/ClickHouse/pull/39757) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix error `Invalid number of columns in chunk pushed to OutputPort` which was caused by ARRAY JOIN optimization. Fixes [#39164](https://github.com/ClickHouse/ClickHouse/issues/39164). [#39799](https://github.com/ClickHouse/ClickHouse/pull/39799) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- A workaround for a bug in Linux kernel. Fix `CANNOT_READ_ALL_DATA` exception with `local_filesystem_read_method=pread_threadpool`. This bug affected only Linux kernel version 5.9 and 5.10 according to [man](https://manpages.debian.org/testing/manpages-dev/preadv2.2.en.html#BUGS). [#39800](https://github.com/ClickHouse/ClickHouse/pull/39800) ([Anton Popov](https://github.com/CurtizJ)).
- (Only on NFS) Fix broken NFS mkdir for root-squashed volumes. [#39898](https://github.com/ClickHouse/ClickHouse/pull/39898) ([Constantine Peresypkin](https://github.com/pkit)).
- Remove dictionaries from prometheus metrics on DETACH/DROP. [#39926](https://github.com/ClickHouse/ClickHouse/pull/39926) ([Azat Khuzhin](https://github.com/azat)).
- Fix read of StorageFile with virtual columns. Closes [#39907](https://github.com/ClickHouse/ClickHouse/issues/39907). [#39943](https://github.com/ClickHouse/ClickHouse/pull/39943) ([flynn](https://github.com/ucasfl)).
- Fix big memory usage during fetches. Fixes [#39915](https://github.com/ClickHouse/ClickHouse/issues/39915). [#39990](https://github.com/ClickHouse/ClickHouse/pull/39990) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- (experimental feature) Fix `hashId` crash and salt parameter not being used. [#40002](https://github.com/ClickHouse/ClickHouse/pull/40002) ([Raúl Marín](https://github.com/Algunenano)).
- `EXCEPT` and `INTERSECT` operators may lead to crash if a specific combination of constant and non-constant columns were used. [#40020](https://github.com/ClickHouse/ClickHouse/pull/40020) ([Duc Canh Le](https://github.com/canhld94)).
- Fixed "Part directory doesn't exist" and "`tmp_<part_name>` ... No such file or directory" errors during too slow INSERT or too long merge/mutation. Also fixed issue that may cause some replication queue entries to stuck without any errors or warnings in logs if previous attempt to fetch part failed, but `tmp-fetch_<part_name>` directory was not cleaned up. [#40031](https://github.com/ClickHouse/ClickHouse/pull/40031) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix rare cases of parsing of arrays of tuples in format `Values`. [#40034](https://github.com/ClickHouse/ClickHouse/pull/40034) ([Anton Popov](https://github.com/CurtizJ)).
- Fixes ArrowColumn format Dictionary(X) & Dictionary(Nullable(X)) conversion to ClickHouse LowCardinality(X) & LowCardinality(Nullable(X)) respectively. [#40037](https://github.com/ClickHouse/ClickHouse/pull/40037) ([Arthur Passos](https://github.com/arthurpassos)).
- Fix potential deadlock in writing to S3 during task scheduling failure. [#40070](https://github.com/ClickHouse/ClickHouse/pull/40070) ([Maksim Kita](https://github.com/kitaisreal)).
- Fix bug in collectFilesToSkip() by adding correct file extension (.idx or idx2) for indexes to be recalculated, avoid wrong hard links. Fixed [#39896](https://github.com/ClickHouse/ClickHouse/issues/39896). [#40095](https://github.com/ClickHouse/ClickHouse/pull/40095) ([Jianmei Zhang](https://github.com/zhangjmruc)).
- A fix for reverse DNS resolution. [#40134](https://github.com/ClickHouse/ClickHouse/pull/40134) ([Arthur Passos](https://github.com/arthurpassos)).
- Fix unexpected result `arrayDifference` of `Array(UInt32). [#40211](https://github.com/ClickHouse/ClickHouse/pull/40211) ([Duc Canh Le](https://github.com/canhld94)).

### <a id="227"></a> Релиз ClickHouse 22.7, 2022-07-21 {#a-id227a-clickhouse-release-227-2022-07-21}

#### Примечания к обновлению {#upgrade-notes-1}

- Настройка `enable_positional_arguments` включена по умолчанию. Она позволяет использовать запросы вида `SELECT ... ORDER BY 1, 2`, где 1, 2 — это ссылки на элементы секции select. Если необходимо вернуть прежнее поведение, отключите эту настройку. [#38204](https://github.com/ClickHouse/ClickHouse/pull/38204) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Настройка `format_csv_allow_single_quotes` отключена по умолчанию. См. [#37096](https://github.com/ClickHouse/ClickHouse/issues/37096). ([Kruglov Pavel](https://github.com/Avogar)).
- Движок баз данных `Ordinary` и старый синтаксис определения хранилища для таблиц `*MergeTree` объявлены устаревшими. По умолчанию создание новых баз данных с движком `Ordinary` невозможно. Если база данных `system` использует движок `Ordinary`, она будет автоматически преобразована в `Atomic` при запуске сервера. Существуют настройки для сохранения прежнего поведения (`allow_deprecated_database_ordinary` и `allow_deprecated_syntax_for_merge_tree`), однако эти настройки могут быть удалены в будущих релизах. [#38335](https://github.com/ClickHouse/ClickHouse/pull/38335) ([Alexander Tokmakov](https://github.com/tavplubix)).
- По умолчанию включено принудительное преобразование соединений через запятую во внутренние соединения (установлено значение по умолчанию `cross_to_inner_join_rewrite = 2`). Для возврата к прежнему поведению установите `cross_to_inner_join_rewrite = 1`. [#39326](https://github.com/ClickHouse/ClickHouse/pull/39326) ([Vladimir C](https://github.com/vdimir)). При возникновении проблем совместимости можно вернуть эту настройку к прежнему значению.


#### Новая функциональность {#new-feature-5}

- Поддержка выражений с оконными функциями. Закрывает [#19857](https://github.com/ClickHouse/ClickHouse/issues/19857). [#37848](https://github.com/ClickHouse/ClickHouse/pull/37848) ([Dmitry Novik](https://github.com/novikd)).
- Добавлен новый алгоритм соединения `direct` для таблиц `EmbeddedRocksDB`, см. [#33582](https://github.com/ClickHouse/ClickHouse/issues/33582). [#35363](https://github.com/ClickHouse/ClickHouse/pull/35363) ([Vladimir C](https://github.com/vdimir)).
- Добавлен алгоритм соединения с полной сортировкой и слиянием. [#35796](https://github.com/ClickHouse/ClickHouse/pull/35796) ([Vladimir C](https://github.com/vdimir)).
- Реализован движок таблиц NATS, который позволяет публиковать сообщения и подписываться на них в NATS. Закрывает [#32388](https://github.com/ClickHouse/ClickHouse/issues/32388). [#37171](https://github.com/ClickHouse/ClickHouse/pull/37171) ([tchepavel](https://github.com/tchepavel)). ([Kseniia Sumarokova](https://github.com/kssenii))
- Реализована табличная функция `mongodb`. Добавлена возможность записи в хранилище / табличную функцию `MongoDB`. [#37213](https://github.com/ClickHouse/ClickHouse/pull/37213) ([aaapetrenko](https://github.com/aaapetrenko)). ([Kseniia Sumarokova](https://github.com/kssenii))
- Добавлен выходной формат `SQLInsert`. Закрывает [#38441](https://github.com/ClickHouse/ClickHouse/issues/38441). [#38477](https://github.com/ClickHouse/ClickHouse/pull/38477) ([Kruglov Pavel](https://github.com/Avogar)).
- Введена настройка `additional_table_filters`. С помощью этой настройки можно указать дополнительное условие фильтрации для таблицы, которое будет применено непосредственно после чтения. Пример: `select number, x, y from (select number from system.numbers limit 5) f any left join (select x, y from table_1) s on f.number = s.x settings additional_table_filters={'system.numbers : 'number != 3', 'table_1' : 'x != 2'}`. Введена настройка `additional_result_filter`, которая задаёт дополнительное условие фильтрации для результата запроса. Закрывает [#37918](https://github.com/ClickHouse/ClickHouse/issues/37918). [#38475](https://github.com/ClickHouse/ClickHouse/pull/38475) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Добавлена настройка `compatibility` и системная таблица `system.settings_changes`, которая содержит информацию об изменениях настроек в различных версиях ClickHouse. Закрывает [#35972](https://github.com/ClickHouse/ClickHouse/issues/35972). [#38957](https://github.com/ClickHouse/ClickHouse/pull/38957) ([Kruglov Pavel](https://github.com/Avogar)).
- Добавлены функции `translate(string, from_string, to_string)` и `translateUTF8(string, from_string, to_string)`. Они заменяют одни символы на другие. [#38935](https://github.com/ClickHouse/ClickHouse/pull/38935) ([Nikolay Degterinsky](https://github.com/evillique)).
- Поддержка функции `parseTimeDelta`. В качестве разделителей можно использовать символы ` ;-+,:`, например `1yr-2mo`, `2m:6s`: `SELECT parseTimeDelta('1yr-2mo-4w + 12 days, 3 hours : 1 minute ; 33 seconds')`. [#39071](https://github.com/ClickHouse/ClickHouse/pull/39071) ([jiahui-97](https://github.com/jiahui-97)).
- Добавлен запрос `CREATE TABLE ... EMPTY AS SELECT`. Он автоматически определяет структуру таблицы из запроса SELECT, но не заполняет таблицу после создания. Решает [#38049](https://github.com/ClickHouse/ClickHouse/issues/38049). [#38272](https://github.com/ClickHouse/ClickHouse/pull/38272) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Добавлены параметры для ограничения операций ввода-вывода с удалённым хранилищем: `max_remote_read_network_bandwidth_for_server` и `max_remote_write_network_bandwidth_for_server`. [#39095](https://github.com/ClickHouse/ClickHouse/pull/39095) ([Sergei Trifonov](https://github.com/serxa)).
- Добавлена настройка `group_by_use_nulls`, которая делает столбцы ключей агрегации nullable в случае использования ROLLUP, CUBE и GROUPING SETS. Закрывает [#37359](https://github.com/ClickHouse/ClickHouse/issues/37359). [#38642](https://github.com/ClickHouse/ClickHouse/pull/38642) ([Dmitry Novik](https://github.com/novikd)).
- Добавлена возможность указывать уровень сжатия при экспорте данных. [#38907](https://github.com/ClickHouse/ClickHouse/pull/38907) ([Nikolay Degterinsky](https://github.com/evillique)).
- Добавлена опция, требующая явных разрешений на SELECT из базы данных `system`. Подробности: [#38970](https://github.com/ClickHouse/ClickHouse/pull/38970) ([Vitaly Baranov](https://github.com/vitlibar)).
- Функции `multiMatchAny`, `multiMatchAnyIndex`, `multiMatchAllIndices` и их нечёткие варианты теперь принимают неконстантный аргумент массива шаблонов. [#38485](https://github.com/ClickHouse/ClickHouse/pull/38485) ([Robert Schulze](https://github.com/rschu1ze)). SQL-функция `multiSearchAllPositions` теперь принимает неконстантные аргументы для поиска. [#39167](https://github.com/ClickHouse/ClickHouse/pull/39167) ([Robert Schulze](https://github.com/rschu1ze)).
- Добавлена настройка `zstd_window_log_max` для настройки максимального использования памяти при декодировании zstd во время импорта внешних файлов. Закрывает [#35693](https://github.com/ClickHouse/ClickHouse/issues/35693). [#37015](https://github.com/ClickHouse/ClickHouse/pull/37015) ([wuxiaobai24](https://github.com/wuxiaobai24)).
- Добавлена настройка `send_logs_source_regexp`. Отправка текстовых логов сервера с указанным регулярным выражением для соответствия имени источника лога. Пустое значение означает все источники. [#39161](https://github.com/ClickHouse/ClickHouse/pull/39161) ([Amos Bird](https://github.com/amosbird)).
- Поддержка `ALTER` для таблиц `Hive`. [#38214](https://github.com/ClickHouse/ClickHouse/pull/38214) ([lgbo](https://github.com/lgbo-ustc)).
- Поддержка функции `isNullable`. Эта функция проверяет, является ли её аргумент nullable, и возвращает 1 или 0. Закрывает [#38611](https://github.com/ClickHouse/ClickHouse/issues/38611). [#38841](https://github.com/ClickHouse/ClickHouse/pull/38841) ([lokax](https://github.com/lokax)).
- Добавлены функции для кодирования/декодирования base58. [#38159](https://github.com/ClickHouse/ClickHouse/pull/38159) ([Andrey Zvonov](https://github.com/zvonand)).
- Добавлена визуализация графиков в интерфейс Play. [#38197](https://github.com/ClickHouse/ClickHouse/pull/38197) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлены функции квадрата расстояния L2 и нормы для массивов и кортежей. [#38545](https://github.com/ClickHouse/ClickHouse/pull/38545) ([Julian Gilyadov](https://github.com/israelg99)).
- Добавлена возможность передавать HTTP-заголовки в табличную функцию / хранилище `url` через SQL. Закрывает [#37897](https://github.com/ClickHouse/ClickHouse/issues/37897). [#38176](https://github.com/ClickHouse/ClickHouse/pull/38176) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлен исполняемый файл `clickhouse-diagnostics` в пакеты. [#38647](https://github.com/ClickHouse/ClickHouse/pull/38647) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).

#### Экспериментальная функция {#experimental-feature-4}

- Добавлена новая настройка `implicit_transaction` для выполнения отдельных запросов внутри транзакции. Она автоматически управляет как созданием, так и закрытием транзакции (через COMMIT при успешном выполнении запроса или ROLLBACK при неудаче). [#38344](https://github.com/ClickHouse/ClickHouse/pull/38344) ([Raúl Marín](https://github.com/Algunenano)).


#### Улучшение производительности {#performance-improvement-5}

- Оптимизация DISTINCT для отсортированных столбцов. Используется специализированное преобразование DISTINCT, когда входной поток отсортирован по столбцу(ам) в DISTINCT. Оптимизация может применяться к предварительному DISTINCT, финальному DISTINCT или к обоим. Первоначальная реализация @dimarub2000. [#37803](https://github.com/ClickHouse/ClickHouse/pull/37803) ([Igor Nikonov](https://github.com/devcrafter)).
- Улучшена производительность `ORDER BY`, слияний `MergeTree`, оконных функций за счёт использования пакетной версии `BinaryHeap`. [#38022](https://github.com/ClickHouse/ClickHouse/pull/38022) ([Maksim Kita](https://github.com/kitaisreal)).
- Увеличена степень параллелизма при выполнении запросов с `FINAL` [#36396](https://github.com/ClickHouse/ClickHouse/pull/36396) ([Nikita Taranov](https://github.com/nickitat)).
- Исправлена значительная регрессия производительности соединений, внесённая в [#35616](https://github.com/ClickHouse/ClickHouse/pull/35616). Интересно, что обычные запросы с соединениями, такие как запросы SSB, работали в 10 раз медленнее почти 3 месяца, и никто не жаловался. [#38052](https://github.com/ClickHouse/ClickHouse/pull/38052) ([Amos Bird](https://github.com/amosbird)).
- Переход от библиотеки Intel hyperscan к vectorscan, что ускоряет многие операции сопоставления строк на платформах, отличных от x86. [#38171](https://github.com/ClickHouse/ClickHouse/pull/38171) ([Robert Schulze](https://github.com/rschu1ze)).
- Увеличен параллелизм шагов плана запроса, выполняемых после агрегации. [#38295](https://github.com/ClickHouse/ClickHouse/pull/38295) ([Nikita Taranov](https://github.com/nickitat)).
- Улучшена производительность вставки в столбцы типа `JSON`. [#38320](https://github.com/ClickHouse/ClickHouse/pull/38320) ([Anton Popov](https://github.com/CurtizJ)).
- Оптимизированы вставка и поиск в HashTable. [#38413](https://github.com/ClickHouse/ClickHouse/pull/38413) ([Nikita Taranov](https://github.com/nickitat)).
- Исправлено снижение производительности из [#32493](https://github.com/ClickHouse/ClickHouse/issues/32493). [#38417](https://github.com/ClickHouse/ClickHouse/pull/38417) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Улучшена производительность соединения с числовыми столбцами за счёт использования инструкций SIMD. [#37235](https://github.com/ClickHouse/ClickHouse/pull/37235) ([zzachimed](https://github.com/zzachimed)). [#38565](https://github.com/ClickHouse/ClickHouse/pull/38565) ([Maksim Kita](https://github.com/kitaisreal)).
- Функции Norm и Distance для массивов ускорены в 1,2–2 раза. [#38740](https://github.com/ClickHouse/ClickHouse/pull/38740) ([Alexander Gololobov](https://github.com/davenger)).
- Добавлена оптимизированная с помощью AVX-512 VBMI функция `copyOverlap32Shuffle` для декомпрессии LZ4. Другими словами, производительность декомпрессии LZ4 улучшена. [#37891](https://github.com/ClickHouse/ClickHouse/pull/37891) ([Guo Wangyang](https://github.com/guowangy)).
- `ORDER BY (a, b)` теперь использует все те же преимущества, что и `ORDER BY a, b`. [#38873](https://github.com/ClickHouse/ClickHouse/pull/38873) ([Igor Nikonov](https://github.com/devcrafter)).
- Выравнивание ветвей в пределах границы 32 байта для повышения стабильности тестов производительности. [#38988](https://github.com/ClickHouse/ClickHouse/pull/38988) ([Guo Wangyang](https://github.com/guowangy)). Это улучшает производительность в среднем на 1–2% для Intel.
- Исполняемые UDF, исполняемые словари и таблицы Executable теперь не тратят одну секунду при ожидании завершения подпроцесса. [#38929](https://github.com/ClickHouse/ClickHouse/pull/38929) ([Constantine Peresypkin](https://github.com/pkit)).
- Оптимизирован доступ к таблице `system.stack_trace`, если выбраны не все столбцы. [#39177](https://github.com/ClickHouse/ClickHouse/pull/39177) ([Azat Khuzhin](https://github.com/azat)).
- Улучшена производительность функций isNullable/isConstant/isNull/isNotNull для аргумента LowCardinality. [#39192](https://github.com/ClickHouse/ClickHouse/pull/39192) ([Kruglov Pavel](https://github.com/Avogar)).
- Оптимизирована обработка ORDER BY в оконных функциях. [#34632](https://github.com/ClickHouse/ClickHouse/pull/34632) ([Vladimir Chebotarev](https://github.com/excitoon)).
- Таблица `system.asynchronous_metric_log` дополнительно оптимизирована для экономии места хранения. Это закрывает [#38134](https://github.com/ClickHouse/ClickHouse/issues/38134). См. [видео на YouTube](https://www.youtube.com/watch?v=0fSp9SF8N8A). [#38428](https://github.com/ClickHouse/ClickHouse/pull/38428) ([Alexey Milovidov](https://github.com/alexey-milovidov)).





#### Улучшение {#improvement-5}

- Поддержка стандартного синтаксиса SQL CREATE INDEX и DROP INDEX. [#35166](https://github.com/ClickHouse/ClickHouse/pull/35166) ([Jianmei Zhang](https://github.com/zhangjmruc)).
- Отправка событий профилирования для запросов INSERT (ранее поддерживался только SELECT). [#37391](https://github.com/ClickHouse/ClickHouse/pull/37391) ([Azat Khuzhin](https://github.com/azat)).
- Реализована упорядоченная агрегация (`optimize_aggregation_in_order`) для полностью материализованных проекций. [#37469](https://github.com/ClickHouse/ClickHouse/pull/37469) ([Azat Khuzhin](https://github.com/azat)).
- Удалён запуск подпроцесса для инициализации kerberos. Добавлен новый интеграционный тест. Закрывает [#27651](https://github.com/ClickHouse/ClickHouse/issues/27651). [#38105](https://github.com/ClickHouse/ClickHouse/pull/38105) ([Roman Vasin](https://github.com/rvasin)).
- Добавлена настройка `multiple_joins_try_to_keep_original_names` для сохранения исходных имён идентификаторов при переписывании множественных JOIN, закрывает [#34697](https://github.com/ClickHouse/ClickHouse/issues/34697). [#38149](https://github.com/ClickHouse/ClickHouse/pull/38149) ([Vladimir C](https://github.com/vdimir)).
- Улучшен пользовательский интерфейс визуализатора трассировок. [#38169](https://github.com/ClickHouse/ClickHouse/pull/38169) ([Sergei Trifonov](https://github.com/serxa)).
- Включён сбор трассировок стека и профилировщик запросов для AArch64. [#38181](https://github.com/ClickHouse/ClickHouse/pull/38181) ([Maksim Kita](https://github.com/kitaisreal)).
- Символические ссылки в директории `user_defined` больше не пропускаются при загрузке пользовательских SQL-функций. Закрывает [#38042](https://github.com/ClickHouse/ClickHouse/issues/38042). [#38184](https://github.com/ClickHouse/ClickHouse/pull/38184) ([Maksim Kita](https://github.com/kitaisreal)).
- Добавлена фоновая очистка поддиректорий в `store/`. В некоторых случаях clickhouse-server мог оставлять мусорные поддиректории в `store/` (например, при неудачном создании таблицы), и эти директории никогда не удалялись. Исправляет [#33710](https://github.com/ClickHouse/ClickHouse/issues/33710). [#38265](https://github.com/ClickHouse/ClickHouse/pull/38265) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Добавлен запрос `DESCRIBE CACHE` для отображения настроек кеша из конфигурации. Добавлен запрос `SHOW CACHES` для отображения списка доступных файловых кешей. [#38279](https://github.com/ClickHouse/ClickHouse/pull/38279) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Добавлена проверка прав доступа для `system drop filesystem cache`. Поддержка ON CLUSTER. [#38319](https://github.com/ClickHouse/ClickHouse/pull/38319) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Исправлена несовместимость движка базы данных PostgreSQL при обновлении с версии 21.3 до 22.3. Закрывает [#36659](https://github.com/ClickHouse/ClickHouse/issues/36659). [#38369](https://github.com/ClickHouse/ClickHouse/pull/38369) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Функции `filesystemAvailable` и аналогичные теперь работают в `clickhouse-local`. Это закрывает [#38423](https://github.com/ClickHouse/ClickHouse/issues/38423). [#38424](https://github.com/ClickHouse/ClickHouse/pull/38424) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлена функция `revision`. [#38555](https://github.com/ClickHouse/ClickHouse/pull/38555) ([Azat Khuzhin](https://github.com/azat)).
- Исправлено использование GCS через прокси-туннель. [#38726](https://github.com/ClickHouse/ClickHouse/pull/38726) ([Azat Khuzhin](https://github.com/azat)).
- Поддержка `\i file` в clickhouse client / local (аналогично psql \i). [#38813](https://github.com/ClickHouse/ClickHouse/pull/38813) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Новая опция `optimize = 1` в `EXPLAIN AST`. Если включена, показывает AST после переписывания, иначе AST исходного запроса. По умолчанию отключена. [#38910](https://github.com/ClickHouse/ClickHouse/pull/38910) ([Igor Nikonov](https://github.com/devcrafter)).
- Разрешена завершающая запятая в списке столбцов. Закрывает [#38425](https://github.com/ClickHouse/ClickHouse/issues/38425). [#38440](https://github.com/ClickHouse/ClickHouse/pull/38440) ([chen](https://github.com/xiedeyantu)).
- Исправления ошибок и улучшения производительности для метода JOIN `parallel_hash`. [#37648](https://github.com/ClickHouse/ClickHouse/pull/37648) ([Vladimir C](https://github.com/vdimir)).
- Поддержка защищённой передачи RPC hadoop (hadoop.rpc.protection=privacy и hadoop.rpc.protection=integrity). [#37852](https://github.com/ClickHouse/ClickHouse/pull/37852) ([Peng Liu](https://github.com/michael1589)).
- Добавлена поддержка типа struct в `StorageHive`. [#38118](https://github.com/ClickHouse/ClickHouse/pull/38118) ([lgbo](https://github.com/lgbo-ustc)).
- Одиночные объекты S3 теперь удаляются с помощью `RemoveObjectRequest`. Реализована совместимость с GCP, который не позволял использовать `removeFileIfExists`, что фактически нарушало примерно половину функциональности `remove`. Автоматическое определение API S3 `DeleteObjects`, который не поддерживается GCS. Это позволит использовать GCS без явного указания `support_batch_delete=0` в конфигурации. [#37882](https://github.com/ClickHouse/ClickHouse/pull/37882) ([Vladimir Chebotarev](https://github.com/excitoon)).
- Предоставление базовых данных мониторинга ClickHouse Keeper (через ProfileEvents и CurrentMetrics). [#38072](https://github.com/ClickHouse/ClickHouse/pull/38072) ([lingpeng0314](https://github.com/lingpeng0314)).
- Поддержка опции `auto_close` для подключения движка PostgreSQL. Закрывает [#31486](https://github.com/ClickHouse/ClickHouse/issues/31486). [#38363](https://github.com/ClickHouse/ClickHouse/pull/38363) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Разрешён модификатор `NULL` в объявлении столбцов для табличных функций. [#38816](https://github.com/ClickHouse/ClickHouse/pull/38816) ([Kruglov Pavel](https://github.com/Avogar)).
- Деактивация `mutations_finalizing_task` перед завершением работы для предотвращения безвредных ошибок `TABLE_IS_READ_ONLY` при завершении работы. [#38851](https://github.com/ClickHouse/ClickHouse/pull/38851) ([Raúl Marín](https://github.com/Algunenano)).
- Устранено ненужное ожидание запросов SELECT после запросов ALTER при наличии запросов INSERT, если вы используете устаревшие базы данных Ordinary. [#38864](https://github.com/ClickHouse/ClickHouse/pull/38864) ([Azat Khuzhin](https://github.com/azat)).
- Новая опция `rewrite` в `EXPLAIN AST`. Если включена, показывает AST после переписывания, иначе AST исходного запроса. По умолчанию отключена. [#38910](https://github.com/ClickHouse/ClickHouse/pull/38910) ([Igor Nikonov](https://github.com/devcrafter)).
- Прекращена регистрация исключений Zookeeper «Node exists» в system.errors, когда они ожидаемы. [#38961](https://github.com/ClickHouse/ClickHouse/pull/38961) ([Raúl Marín](https://github.com/Algunenano)).
- `clickhouse-keeper`: добавлена поддержка вычисления и проверки контрольных сумм в реальном времени. По умолчанию отключена. [#37555](https://github.com/ClickHouse/ClickHouse/pull/37555) ([Antonio Andelic](https://github.com/antonio2368)).
- Разрешено указывать шаблоны `* или {expr1, expr2, expr3}` внутри ключа для инструмента `clickhouse-extract-from-config`. [#38966](https://github.com/ClickHouse/ClickHouse/pull/38966) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- clearOldLogs: не регистрировать KEEPER_EXCEPTION при параллельных удалениях. [#39016](https://github.com/ClickHouse/ClickHouse/pull/39016) ([Raúl Marín](https://github.com/Algunenano)).
- Улучшение clickhouse-keeper: сохранение метаинформации о серверах keeper на диск. [#39069](https://github.com/ClickHouse/ClickHouse/pull/39069) ([Antonio Andelic](https://github.com/antonio2368)). Это упростит эксплуатацию при одновременном завершении работы или перезапуске всех узлов keeper.
- Продолжение работы без исключения при нехватке дискового пространства при использовании файлового кеша. [#39106](https://github.com/ClickHouse/ClickHouse/pull/39106) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Обработка сигналов SIGTERM от k8s. [#39130](https://github.com/ClickHouse/ClickHouse/pull/39130) ([Timur Solodovnikov](https://github.com/tsolodov)).
- Добавлен столбец `merge_algorithm` (Undecided, Horizontal, Vertical) в system.part_log. [#39181](https://github.com/ClickHouse/ClickHouse/pull/39181) ([Azat Khuzhin](https://github.com/azat)).
- Не увеличивать счётчик в `system.errors`, когда диск не является вращающимся. [#39216](https://github.com/ClickHouse/ClickHouse/pull/39216) ([Raúl Marín](https://github.com/Algunenano)).
- Метрика `result_bytes` для запросов `INSERT` в `system.query_log` показывает количество вставленных байтов. Ранее значение было неверным и хранило то же значение, что и `result_rows`. [#39225](https://github.com/ClickHouse/ClickHouse/pull/39225) ([Ilya Yatsishin](https://github.com/qoega)).
- Метрика использования CPU в clickhouse-client будет отображаться более удобным способом. Исправляет [#38756](https://github.com/ClickHouse/ClickHouse/issues/38756). [#39280](https://github.com/ClickHouse/ClickHouse/pull/39280) ([Sergei Trifonov](https://github.com/serxa)).
- Повторное выбрасывание исключения при инициализации файлового кеша при запуске сервера, улучшенное сообщение об ошибке. [#39386](https://github.com/ClickHouse/ClickHouse/pull/39386) ([Kseniia Sumarokova](https://github.com/kssenii)).
- OpenTelemetry теперь собирает трассировки без промежутков Processors по умолчанию (их слишком много). Для включения сбора промежутков Processors используйте настройку `opentelemetry_trace_processors`. [#39170](https://github.com/ClickHouse/ClickHouse/pull/39170) ([Ilya Yatsishin](https://github.com/qoega)).
- Функции `multiMatch[Fuzzy](AllIndices/Any/AnyIndex)` — не выбрасывать логическую ошибку, если аргумент needle пуст. [#39012](https://github.com/ClickHouse/ClickHouse/pull/39012) ([Robert Schulze](https://github.com/rschu1ze)).
- Разрешено объявлять очередь `RabbitMQ` без аргументов по умолчанию `x-max-length` и `x-overflow`. [#39259](https://github.com/ClickHouse/ClickHouse/pull/39259) ([rnbondarenko](https://github.com/rnbondarenko)).

#### Улучшение сборки/тестирования/упаковки {#buildtestingpackaging-improvement-5}

- Применены аннотации Clang Thread Safety Analysis (TSA) к ClickHouse. [#38068](https://github.com/ClickHouse/ClickHouse/pull/38068) ([Robert Schulze](https://github.com/rschu1ze)).
- Адаптирован универсальный скрипт установки для FreeBSD. [#39302](https://github.com/ClickHouse/ClickHouse/pull/39302) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Подготовка к сборке на платформе `s390x`. [#39193](https://github.com/ClickHouse/ClickHouse/pull/39193) ([Harry Lee](https://github.com/HarryLeeIBM)).
- Исправлена ошибка в библиотеке `jemalloc` [#38757](https://github.com/ClickHouse/ClickHouse/pull/38757) ([Azat Khuzhin](https://github.com/azat)).
- Аппаратный бенчмарк теперь поддерживает автоматическую загрузку результатов. [#38427](https://github.com/ClickHouse/ClickHouse/pull/38427) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Системная таблица "system.licenses" теперь корректно заполняется на Mac (Darwin). [#38294](https://github.com/ClickHouse/ClickHouse/pull/38294) ([Robert Schulze](https://github.com/rschu1ze)).
- Изменены пакеты `all|noarch` на зависимые от архитектуры - Исправлена соответствующая документация - Публикация пакетов aarch64|arm64 в artifactory и релизные ресурсы - Исправляет [#36443](https://github.com/ClickHouse/ClickHouse/issues/36443). [#38580](https://github.com/ClickHouse/ClickHouse/pull/38580) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).


#### Исправление ошибки (видимое пользователю некорректное поведение в официальной стабильной или предварительной версии) {#bug-fix-user-visible-misbehavior-in-official-stable-or-prestable-release-3}

- Fix rounding for `Decimal128/Decimal256` with more than 19-digits long scale. [#38027](https://github.com/ClickHouse/ClickHouse/pull/38027) ([Igor Nikonov](https://github.com/devcrafter)).
- Fixed crash caused by data race in storage `Hive` (integration table engine). [#38887](https://github.com/ClickHouse/ClickHouse/pull/38887) ([lgbo](https://github.com/lgbo-ustc)).
- Fix crash when executing GRANT ALL ON _._ with ON CLUSTER. It was broken in https://github.com/ClickHouse/ClickHouse/pull/35767. This closes [#38618](https://github.com/ClickHouse/ClickHouse/issues/38618). [#38674](https://github.com/ClickHouse/ClickHouse/pull/38674) ([Vitaly Baranov](https://github.com/vitlibar)).
- Correct glob expansion in case of `{0..10}` forms. Fixes [#38498](https://github.com/ClickHouse/ClickHouse/issues/38498) Current Implementation is similar to what shell does mentiond by @rschu1ze [here](https://github.com/ClickHouse/ClickHouse/pull/38502#issuecomment-1169057723). [#38502](https://github.com/ClickHouse/ClickHouse/pull/38502) ([Heena Bansal](https://github.com/HeenaBansal2009)).
- Fix crash for `mapUpdate`, `mapFilter` functions when using with constant map argument. Closes [#38547](https://github.com/ClickHouse/ClickHouse/issues/38547). [#38553](https://github.com/ClickHouse/ClickHouse/pull/38553) ([hexiaoting](https://github.com/hexiaoting)).
- Fix `toHour` monotonicity information for query optimization which can lead to incorrect query result (incorrect index analysis). This fixes [#38333](https://github.com/ClickHouse/ClickHouse/issues/38333). [#38675](https://github.com/ClickHouse/ClickHouse/pull/38675) ([Amos Bird](https://github.com/amosbird)).
- Fix checking whether s3 storage support parallel writes. It resulted in s3 parallel writes not working. [#38792](https://github.com/ClickHouse/ClickHouse/pull/38792) ([chen](https://github.com/xiedeyantu)).
- Fix s3 seekable reads with parallel read buffer. (Affected memory usage during query). Closes [#38258](https://github.com/ClickHouse/ClickHouse/issues/38258). [#38802](https://github.com/ClickHouse/ClickHouse/pull/38802) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Update `simdjson`. This fixes [#38621](https://github.com/ClickHouse/ClickHouse/issues/38621) - a buffer overflow on machines with the latest Intel CPUs with AVX-512 VBMI. [#38838](https://github.com/ClickHouse/ClickHouse/pull/38838) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix possible logical error for Vertical merges. [#38859](https://github.com/ClickHouse/ClickHouse/pull/38859) ([Maksim Kita](https://github.com/kitaisreal)).
- Fix settings profile with seconds unit. [#38896](https://github.com/ClickHouse/ClickHouse/pull/38896) ([Raúl Marín](https://github.com/Algunenano)).
- Fix incorrect partition pruning when there is a nullable partition key. Note: most likely you don't use nullable partition keys - this is an obscure feature you should not use. Nullable keys are a nonsense and this feature is only needed for some crazy use-cases. This fixes [#38941](https://github.com/ClickHouse/ClickHouse/issues/38941). [#38946](https://github.com/ClickHouse/ClickHouse/pull/38946) ([Amos Bird](https://github.com/amosbird)).
- Improve `fsync_part_directory` for fetches. [#38993](https://github.com/ClickHouse/ClickHouse/pull/38993) ([Azat Khuzhin](https://github.com/azat)).
- Fix possible dealock inside `OvercommitTracker`. Fixes [#37794](https://github.com/ClickHouse/ClickHouse/issues/37794). [#39030](https://github.com/ClickHouse/ClickHouse/pull/39030) ([Dmitry Novik](https://github.com/novikd)).
- Fix bug in filesystem cache that could happen in some corner case which coincided with cache capacity hitting the limit. Closes [#39066](https://github.com/ClickHouse/ClickHouse/issues/39066). [#39070](https://github.com/ClickHouse/ClickHouse/pull/39070) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix some corner cases of interpretation of the arguments of window expressions. Fixes [#38538](https://github.com/ClickHouse/ClickHouse/issues/38538) Allow using of higher-order functions in window expressions. [#39112](https://github.com/ClickHouse/ClickHouse/pull/39112) ([Dmitry Novik](https://github.com/novikd)).
- Keep `LowCardinality` type in `tuple` function. Previously `LowCardinality` type was dropped and elements of created tuple had underlying type of `LowCardinality`. [#39113](https://github.com/ClickHouse/ClickHouse/pull/39113) ([Anton Popov](https://github.com/CurtizJ)).
- Fix error `Block structure mismatch` which could happen for INSERT into table with attached MATERIALIZED VIEW and enabled setting `extremes = 1`. Closes [#29759](https://github.com/ClickHouse/ClickHouse/issues/29759) and [#38729](https://github.com/ClickHouse/ClickHouse/issues/38729). [#39125](https://github.com/ClickHouse/ClickHouse/pull/39125) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix unexpected query result when both `optimize_trivial_count_query` and `empty_result_for_aggregation_by_empty_set` are set to true. This fixes [#39140](https://github.com/ClickHouse/ClickHouse/issues/39140). [#39155](https://github.com/ClickHouse/ClickHouse/pull/39155) ([Amos Bird](https://github.com/amosbird)).
- Fixed error `Not found column Type in block` in selects with `PREWHERE` and read-in-order optimizations. [#39157](https://github.com/ClickHouse/ClickHouse/pull/39157) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix extremely rare race condition in during hardlinks for remote filesystem. The only way to reproduce it is concurrent run of backups. [#39190](https://github.com/ClickHouse/ClickHouse/pull/39190) ([alesapin](https://github.com/alesapin)).
- (zero-copy replication is an experimental feature that should not be used in production) Fix fetch of in-memory part with `allow_remote_fs_zero_copy_replication`. [#39214](https://github.com/ClickHouse/ClickHouse/pull/39214) ([Azat Khuzhin](https://github.com/azat)).
- (MaterializedPostgreSQL - experimental feature). Fix segmentation fault in MaterializedPostgreSQL database engine, which could happen if some exception occurred at replication initialisation. Closes [#36939](https://github.com/ClickHouse/ClickHouse/issues/36939). [#39272](https://github.com/ClickHouse/ClickHouse/pull/39272) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix incorrect fetch of table metadata from PostgreSQL database engine. Closes [#33502](https://github.com/ClickHouse/ClickHouse/issues/33502). [#39283](https://github.com/ClickHouse/ClickHouse/pull/39283) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix projection exception when aggregation keys are wrapped inside other functions. This fixes [#37151](https://github.com/ClickHouse/ClickHouse/issues/37151). [#37155](https://github.com/ClickHouse/ClickHouse/pull/37155) ([Amos Bird](https://github.com/amosbird)).
- Fix possible logical error `... with argument with type Nothing and default implementation for Nothing is expected to return result with type Nothing, got ...` in some functions. Closes: [#37610](https://github.com/ClickHouse/ClickHouse/issues/37610) Closes: [#37741](https://github.com/ClickHouse/ClickHouse/issues/37741). [#37759](https://github.com/ClickHouse/ClickHouse/pull/37759) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix incorrect columns order in subqueries of UNION (in case of duplicated columns in subselects may produce incorrect result). [#37887](https://github.com/ClickHouse/ClickHouse/pull/37887) ([Azat Khuzhin](https://github.com/azat)).
- Fix incorrect work of MODIFY ALTER Column with column names that contain dots. Closes [#37907](https://github.com/ClickHouse/ClickHouse/issues/37907). [#37971](https://github.com/ClickHouse/ClickHouse/pull/37971) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix reading of sparse columns from `MergeTree` tables that store their data in S3. [#37978](https://github.com/ClickHouse/ClickHouse/pull/37978) ([Anton Popov](https://github.com/CurtizJ)).
- Fix possible crash in `Distributed` async insert in case of removing a replica from config. [#38029](https://github.com/ClickHouse/ClickHouse/pull/38029) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix "Missing columns" for GLOBAL JOIN with CTE without alias. [#38056](https://github.com/ClickHouse/ClickHouse/pull/38056) ([Azat Khuzhin](https://github.com/azat)).
- Rewrite tuple functions as literals in backwards-compatibility mode. [#38096](https://github.com/ClickHouse/ClickHouse/pull/38096) ([Anton Kozlov](https://github.com/tonickkozlov)).
- Fix redundant memory reservation for output block during `ORDER BY`. [#38127](https://github.com/ClickHouse/ClickHouse/pull/38127) ([iyupeng](https://github.com/iyupeng)).
- Fix possible logical error `Bad cast from type DB::IColumn* to DB::ColumnNullable*` in array mapped functions. Closes [#38006](https://github.com/ClickHouse/ClickHouse/issues/38006). [#38132](https://github.com/ClickHouse/ClickHouse/pull/38132) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix temporary name clash in partial merge join, close [#37928](https://github.com/ClickHouse/ClickHouse/issues/37928). [#38135](https://github.com/ClickHouse/ClickHouse/pull/38135) ([Vladimir C](https://github.com/vdimir)).
- Some minr issue with queries like `CREATE TABLE nested_name_tuples (`a` Tuple(x String, y Tuple(i Int32, j String))) ENGINE = Memory;` [#38136](https://github.com/ClickHouse/ClickHouse/pull/38136) ([lgbo](https://github.com/lgbo-ustc)).
- Fix bug with nested short-circuit functions that led to execution of arguments even if condition is false. Closes [#38040](https://github.com/ClickHouse/ClickHouse/issues/38040). [#38173](https://github.com/ClickHouse/ClickHouse/pull/38173) ([Kruglov Pavel](https://github.com/Avogar)).
- (Window View is a experimental feature) Fix LOGICAL_ERROR for WINDOW VIEW with incorrect structure. [#38205](https://github.com/ClickHouse/ClickHouse/pull/38205) ([Azat Khuzhin](https://github.com/azat)).
- Update librdkafka submodule to fix crash when an OAUTHBEARER refresh callback is set. [#38225](https://github.com/ClickHouse/ClickHouse/pull/38225) ([Rafael Acevedo](https://github.com/racevedoo)).
- Fix INSERT into Distributed hung due to ProfileEvents. [#38307](https://github.com/ClickHouse/ClickHouse/pull/38307) ([Azat Khuzhin](https://github.com/azat)).
- Fix retries in PostgreSQL engine. [#38310](https://github.com/ClickHouse/ClickHouse/pull/38310) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix optimization in PartialSortingTransform (SIGSEGV and possible incorrect result). [#38324](https://github.com/ClickHouse/ClickHouse/pull/38324) ([Azat Khuzhin](https://github.com/azat)).
- Fix RabbitMQ with formats based on PeekableReadBuffer. Closes [#38061](https://github.com/ClickHouse/ClickHouse/issues/38061). [#38356](https://github.com/ClickHouse/ClickHouse/pull/38356) ([Kseniia Sumarokova](https://github.com/kssenii)).
- MaterializedPostgreSQL - experimentail feature. Fix possible `Invalid number of rows in Chunk` in MaterializedPostgreSQL. Closes [#37323](https://github.com/ClickHouse/ClickHouse/issues/37323). [#38360](https://github.com/ClickHouse/ClickHouse/pull/38360) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix RabbitMQ configuration with connection string setting. Closes [#36531](https://github.com/ClickHouse/ClickHouse/issues/36531). [#38365](https://github.com/ClickHouse/ClickHouse/pull/38365) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix PostgreSQL engine not using PostgreSQL schema when retrieving array dimension size. Closes [#36755](https://github.com/ClickHouse/ClickHouse/issues/36755). Closes [#36772](https://github.com/ClickHouse/ClickHouse/issues/36772). [#38366](https://github.com/ClickHouse/ClickHouse/pull/38366) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix possibly incorrect result of distributed queries with `DISTINCT` and `LIMIT`. Fixes [#38282](https://github.com/ClickHouse/ClickHouse/issues/38282). [#38371](https://github.com/ClickHouse/ClickHouse/pull/38371) ([Anton Popov](https://github.com/CurtizJ)).
- Fix wrong results of countSubstrings() & position() on patterns with 0-bytes. [#38589](https://github.com/ClickHouse/ClickHouse/pull/38589) ([Robert Schulze](https://github.com/rschu1ze)).
- Now it's possible to start a clickhouse-server and attach/detach tables even for tables with the incorrect values of IPv4/IPv6 representation. Proper fix for issue [#35156](https://github.com/ClickHouse/ClickHouse/issues/35156). [#38590](https://github.com/ClickHouse/ClickHouse/pull/38590) ([alesapin](https://github.com/alesapin)).
- `rankCorr` function will work correctly if some arguments are NaNs. This closes [#38396](https://github.com/ClickHouse/ClickHouse/issues/38396). [#38722](https://github.com/ClickHouse/ClickHouse/pull/38722) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix `parallel_view_processing=1` with `optimize_trivial_insert_select=1`. Fix `max_insert_threads` while pushing to views. [#38731](https://github.com/ClickHouse/ClickHouse/pull/38731) ([Azat Khuzhin](https://github.com/azat)).
- Fix use-after-free for aggregate functions with `Map` combinator that leads to incorrect result. [#38748](https://github.com/ClickHouse/ClickHouse/pull/38748) ([Azat Khuzhin](https://github.com/azat)).

### <a id="226"></a> Релиз ClickHouse 22.6, 2022-06-16 {#a-id226a-clickhouse-release-226-2022-06-16}

#### Обратно несовместимые изменения {#backward-incompatible-change-4}

- Удалена поддержка восьмеричных числовых литералов в SQL. В предыдущих версиях они парсились как Float64. [#37765](https://github.com/ClickHouse/ClickHouse/pull/37765) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Изменен способ парсинга настроек с типом `seconds` для поддержки значений с плавающей точкой (например: `max_execution_time=0.5`). Значения Infinity или NaN будут вызывать исключение. [#37187](https://github.com/ClickHouse/ClickHouse/pull/37187) ([Raúl Marín](https://github.com/Algunenano)).
- Изменен формат бинарной сериализации столбцов экспериментального типа `Object`. Новый формат удобнее для реализации в сторонних клиентах. [#37482](https://github.com/ClickHouse/ClickHouse/pull/37482) ([Anton Popov](https://github.com/CurtizJ)).
- Настройка `output_format_json_named_tuples_as_objects` включена по умолчанию. Она позволяет сериализовать именованные кортежи как JSON-объекты в JSON-форматах. [#37756](https://github.com/ClickHouse/ClickHouse/pull/37756) ([Anton Popov](https://github.com/CurtizJ)).
- Шаблоны LIKE с завершающим символом экранирования ('\\') теперь запрещены (в соответствии со стандартом SQL). [#37764](https://github.com/ClickHouse/ClickHouse/pull/37764) ([Robert Schulze](https://github.com/rschu1ze)).
- Если вы используете разные версии ClickHouse на кластере с процессором AArch64 или смешиваете AArch64 и amd64 на кластере, и выполняете распределенные запросы с GROUP BY по нескольким ключам фиксированного размера, которые помещаются в 256 бит, но не помещаются в 64 бита, и размер результата очень большой, данные не будут полностью агрегированы в результате этих запросов во время обновления. Решение: выполните обновление с простоем вместо последовательного обновления.


#### Новая функциональность {#new-feature-6}

- Добавлена функция `GROUPING`. Она позволяет однозначно идентифицировать записи в запросах с `ROLLUP`, `CUBE` или `GROUPING SETS`. Закрывает [#19426](https://github.com/ClickHouse/ClickHouse/issues/19426). [#37163](https://github.com/ClickHouse/ClickHouse/pull/37163) ([Dmitry Novik](https://github.com/novikd)).
- Новый кодек [FPC](https://userweb.cs.txstate.edu/~burtscher/papers/dcc07a.pdf) — алгоритм для сжатия данных с плавающей точкой. [#37553](https://github.com/ClickHouse/ClickHouse/pull/37553) ([Mikhail Guzov](https://github.com/koloshmet)).
- Добавлены новые колоночные форматы JSON: `JSONColumns`, `JSONCompactColumns`, `JSONColumnsWithMetadata`. Закрывает [#36338](https://github.com/ClickHouse/ClickHouse/issues/36338), [#34509](https://github.com/ClickHouse/ClickHouse/issues/34509). [#36975](https://github.com/ClickHouse/ClickHouse/pull/36975) ([Kruglov Pavel](https://github.com/Avogar)).
- Добавлен инструмент визуализации трассировок OpenTelemetry на основе d3js. [#37810](https://github.com/ClickHouse/ClickHouse/pull/37810) ([Sergei Trifonov](https://github.com/serxa)).
- Добавлена поддержка операций INSERT в таблицу `system.zookeeper`. Закрывает [#22130](https://github.com/ClickHouse/ClickHouse/issues/22130). [#37596](https://github.com/ClickHouse/ClickHouse/pull/37596) ([Han Fei](https://github.com/hanfei1991)).
- Добавлена поддержка неконстантного аргумента шаблона для функций `LIKE`, `ILIKE` и `match`. [#37251](https://github.com/ClickHouse/ClickHouse/pull/37251) ([Robert Schulze](https://github.com/rschu1ze)).
- Исполняемые пользовательские функции теперь поддерживают параметры. Пример: `SELECT test_function(parameters)(arguments)`. Закрывает [#37578](https://github.com/ClickHouse/ClickHouse/issues/37578). [#37720](https://github.com/ClickHouse/ClickHouse/pull/37720) ([Maksim Kita](https://github.com/kitaisreal)).
- Добавлен столбец `merge_reason` в таблицу `system.part_log`. [#36912](https://github.com/ClickHouse/ClickHouse/pull/36912) ([Sema Checherinda](https://github.com/CheSema)).
- Добавлена поддержка типов Map и Record в формате Avro. Добавлена новая настройка `input_format_avro_null_as_default`, которая позволяет вставлять null как значение по умолчанию в формате Avro. Закрывает [#18925](https://github.com/ClickHouse/ClickHouse/issues/18925), [#37378](https://github.com/ClickHouse/ClickHouse/issues/37378), [#32899](https://github.com/ClickHouse/ClickHouse/issues/32899). [#37525](https://github.com/ClickHouse/ClickHouse/pull/37525) ([Kruglov Pavel](https://github.com/Avogar)).
- Добавлен инструмент `clickhouse-disks` для анализа и работы с виртуальными файловыми системами, настроенными для ClickHouse. [#36060](https://github.com/ClickHouse/ClickHouse/pull/36060) ([Artyom Yurkov](https://github.com/Varinara)).
- Добавлены функции для работы с однонаправленными рёбрами H3. [#36843](https://github.com/ClickHouse/ClickHouse/pull/36843) ([Bharat Nallan](https://github.com/bharatnc)).
- Добавлена поддержка вычисления [hashids](https://hashids.org/) из беззнаковых целых чисел. [#37013](https://github.com/ClickHouse/ClickHouse/pull/37013) ([Michael Nutt](https://github.com/mnutt)).
- Разрешено явное указание `SALT` для `CREATE USER <user> IDENTIFIED WITH sha256_hash`. [#37377](https://github.com/ClickHouse/ClickHouse/pull/37377) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Добавлены две новые настройки `input_format_csv_skip_first_lines`/`input_format_tsv_skip_first_lines`, позволяющие пропускать указанное количество строк в начале файла в форматах CSV/TSV. [#37537](https://github.com/ClickHouse/ClickHouse/pull/37537) ([Kruglov Pavel](https://github.com/Avogar)).
- Функция `showCertificate` отображает SSL-сертификат текущего сервера. [#37540](https://github.com/ClickHouse/ClickHouse/pull/37540) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Добавлена поддержка HTTP-источника для словарей данных в именованных коллекциях. [#37581](https://github.com/ClickHouse/ClickHouse/pull/37581) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Добавлена новая оконная функция `nonNegativeDerivative(metric_column, timestamp_column[, INTERVAL x SECOND])`. [#37628](https://github.com/ClickHouse/ClickHouse/pull/37628) ([Andrey Zvonov](https://github.com/zvonand)).
- Реализовано изменение комментария для таблиц `ReplicatedMergeTree`. [#37416](https://github.com/ClickHouse/ClickHouse/pull/37416) ([Vasily Nemkov](https://github.com/Enmk)).
- Добавлен запрос `SYSTEM UNFREEZE`, который удаляет всю резервную копию независимо от того, удалена соответствующая таблица или нет. [#36424](https://github.com/ClickHouse/ClickHouse/pull/36424) ([Vadim Volodin](https://github.com/PolyProgrammist)).

#### Экспериментальная функция {#experimental-feature-5}

- Включена поддержка `POPULATE` для `WINDOW VIEW`. [#36945](https://github.com/ClickHouse/ClickHouse/pull/36945) ([vxider](https://github.com/Vxider)).
- Поддержка `ALTER TABLE ... MODIFY QUERY` для `WINDOW VIEW`. [#37188](https://github.com/ClickHouse/ClickHouse/pull/37188) ([vxider](https://github.com/Vxider)).
- Изменено поведение синтаксиса `ENGINE` в `WINDOW VIEW` для соответствия `MATERIALIZED VIEW`. [#37214](https://github.com/ClickHouse/ClickHouse/pull/37214) ([vxider](https://github.com/Vxider)).


#### Улучшение производительности {#performance-improvement-6}

- Добавлены многочисленные оптимизации для ARM NEON [#38093](https://github.com/ClickHouse/ClickHouse/pull/38093)([Daniel Kutenin](https://github.com/danlark1)), ([Alexandra Pilipyuk](https://github.com/chalice19)) Примечание: если вы используете разные версии ClickHouse в кластере с процессором ARM и выполняете распределённые запросы с GROUP BY по нескольким ключам фиксированного размера, которые помещаются в 256 бит, но не помещаются в 64 бита, результат агрегационного запроса будет неверным во время обновления. Решение: выполняйте обновление с простоем вместо последовательного обновления.
- Улучшена производительность и использование памяти при выборке подмножества столбцов для форматов Native, Protobuf, CapnProto, JSONEachRow, TSKV и всех форматов с суффиксами WithNames/WithNamesAndTypes. Ранее при выборке только подмножества столбцов из файлов в этих форматах все столбцы считывались и сохранялись в памяти. Теперь считываются только необходимые столбцы. Этот PR включает настройку `input_format_skip_unknown_fields` по умолчанию, поскольку в противном случае при выборке подмножества столбцов будет выброшено исключение. [#37192](https://github.com/ClickHouse/ClickHouse/pull/37192) ([Kruglov Pavel](https://github.com/Avogar)).
- Теперь больше фильтров может быть протолкнуто вниз для соединений. [#37472](https://github.com/ClickHouse/ClickHouse/pull/37472) ([Amos Bird](https://github.com/amosbird)).
- Загрузка меток только для необходимых столбцов при чтении широких частей. [#36879](https://github.com/ClickHouse/ClickHouse/pull/36879) ([Anton Kozlov](https://github.com/tonickkozlov)).
- Улучшена производительность агрегации в случае, когда разреженные столбцы (могут быть включены экспериментальной настройкой `ratio_of_defaults_for_sparse_serialization` в таблицах `MergeTree`) используются в качестве аргументов в агрегатных функциях. [#37617](https://github.com/ClickHouse/ClickHouse/pull/37617) ([Anton Popov](https://github.com/CurtizJ)).
- Оптимизирована функция `COALESCE` с двумя аргументами. [#37666](https://github.com/ClickHouse/ClickHouse/pull/37666) ([Anton Popov](https://github.com/CurtizJ)).
- Замена `multiIf` на `if` в случае, когда `multiIf` имеет только одно условие, поскольку функция `if` более производительна. [#37695](https://github.com/ClickHouse/ClickHouse/pull/37695) ([Anton Popov](https://github.com/CurtizJ)).
- Улучшена производительность функций `dictGetDescendants`, `dictGetChildren`: создание временного иерархического индекса от родителя к потомкам выполняется один раз на запрос, а не при каждом вызове функции во время запроса. Добавлена возможность указать `BIDIRECTIONAL` для атрибутов `HIERARHICAL` — словарь будет поддерживать индекс от родителя к потомкам в памяти, таким образом функции `dictGetDescendants`, `dictGetChildren` не будут создавать временный индекс для каждого запроса. Закрывает [#32481](https://github.com/ClickHouse/ClickHouse/issues/32481). [#37148](https://github.com/ClickHouse/ClickHouse/pull/37148) ([Maksim Kita](https://github.com/kitaisreal)).
- Уничтожение состояния агрегатов теперь может быть передано в пул потоков. Для запросов с LIMIT и большим состоянием это обеспечивает значительное ускорение, например, `select uniq(number) from numbers_mt(1e7) group by number limit 100` стал примерно в 2,5 раза быстрее. [#37855](https://github.com/ClickHouse/ClickHouse/pull/37855) ([Nikita Taranov](https://github.com/nickitat)).
- Улучшена производительность сортировки по одному столбцу. [#37195](https://github.com/ClickHouse/ClickHouse/pull/37195) ([Maksim Kita](https://github.com/kitaisreal)).
- Улучшена производительность сортировки по одному столбцу с использованием специализаций очереди сортировки. [#37990](https://github.com/ClickHouse/ClickHouse/pull/37990) ([Maksim Kita](https://github.com/kitaisreal)).
- Улучшена производительность функций нормы и расстояния для массивов в 2–4 раза. [#37394](https://github.com/ClickHouse/ClickHouse/pull/37394) ([Alexander Gololobov](https://github.com/davenger)).
- Улучшена производительность функций сравнения чисел с использованием динамической диспетчеризации. [#37399](https://github.com/ClickHouse/ClickHouse/pull/37399) ([Maksim Kita](https://github.com/kitaisreal)).
- Улучшена производительность ORDER BY с LIMIT. [#37481](https://github.com/ClickHouse/ClickHouse/pull/37481) ([Maksim Kita](https://github.com/kitaisreal)).
- Улучшена производительность функции `hasAll` с использованием инфраструктуры динамической диспетчеризации. [#37484](https://github.com/ClickHouse/ClickHouse/pull/37484) ([Maksim Kita](https://github.com/kitaisreal)).
- Улучшена производительность функций `greatCircleAngle`, `greatCircleDistance`, `geoDistance`. [#37524](https://github.com/ClickHouse/ClickHouse/pull/37524) ([Maksim Kita](https://github.com/kitaisreal)).
- Улучшена производительность вставки в MergeTree при наличии нескольких столбцов в ORDER BY. [#35762](https://github.com/ClickHouse/ClickHouse/pull/35762) ([Maksim Kita](https://github.com/kitaisreal)).
- Исправлено чрезмерное использование CPU в фоновом режиме при наличии большого количества таблиц. [#38028](https://github.com/ClickHouse/ClickHouse/pull/38028) ([Maksim Kita](https://github.com/kitaisreal)).
- Улучшена производительность функции `not` с использованием динамической диспетчеризации. [#38058](https://github.com/ClickHouse/ClickHouse/pull/38058) ([Maksim Kita](https://github.com/kitaisreal)).
- Оптимизировано внутреннее кэширование шаблонов re2, которые используются, например, в функциях LIKE и MATCH. [#37544](https://github.com/ClickHouse/ClickHouse/pull/37544) ([Robert Schulze](https://github.com/rschu1ze)).
- Улучшена функция генератора битовой маски фильтра «всё-в-одном» с инструкциями AVX-512. [#37588](https://github.com/ClickHouse/ClickHouse/pull/37588) ([yaqi-zhao](https://github.com/yaqi-zhao)).
- Применён метод чтения `threadpool` для движка интеграции Hive. Это значительно ускорит чтение. [#36328](https://github.com/ClickHouse/ClickHouse/pull/36328) ([李扬](https://github.com/taiyang-li)).
- Когда все столбцы для чтения являются ключами партиций, столбцы создаются по номеру строки файла без фактического чтения файла Hive. [#37103](https://github.com/ClickHouse/ClickHouse/pull/37103) ([lgbo](https://github.com/lgbo-ustc)).
- Поддержка нескольких дисков для кэширования файлов Hive. [#37279](https://github.com/ClickHouse/ClickHouse/pull/37279) ([lgbo](https://github.com/lgbo-ustc)).
- Ограничение максимального использования кэша на запрос может эффективно предотвратить загрязнение пула кэша. [Связанные задачи](https://github.com/ClickHouse/ClickHouse/issues/28961). [#37859](https://github.com/ClickHouse/ClickHouse/pull/37859) ([Han Shukai](https://github.com/KinderRiven)).
- В настоящее время ClickHouse напрямую загружает все удалённые файлы в локальный кэш (даже если они читаются только один раз), что часто вызывает операции ввода-вывода на локальном жёстком диске. В некоторых сценариях эти операции ввода-вывода могут быть не нужны и легко могут привести к отрицательной оптимизации. Как показано на рисунке ниже, при выполнении SSB Q1-Q4 производительность кэша привела к отрицательной оптимизации. [#37516](https://github.com/ClickHouse/ClickHouse/pull/37516) ([Han Shukai](https://github.com/KinderRiven)).
- Разрешена обрезка списка файлов через виртуальные столбцы, такие как `_file` и `_path`, при чтении из S3. Это для [#37174](https://github.com/ClickHouse/ClickHouse/issues/37174), [#23494](https://github.com/ClickHouse/ClickHouse/issues/23494). [#37356](https://github.com/ClickHouse/ClickHouse/pull/37356) ([Amos Bird](https://github.com/amosbird)).
- В функции CompressedWriteBuffer::nextImpl() присутствует ненужный шаг записи-копирования, который часто происходит при вставке данных. Ниже показано различие с этим патчем: - До: 1. Сжатие "working_buffer" в "compressed_buffer" 2. запись-копирование в "out" - После: Прямое сжатие "working_buffer" в "out". [#37242](https://github.com/ClickHouse/ClickHouse/pull/37242) ([jasperzhu](https://github.com/jinjunzh)).





#### Улучшение {#improvement-6}

- Support types with non-standard defaults in ROLLUP, CUBE, GROUPING SETS. Closes [#37360](https://github.com/ClickHouse/ClickHouse/issues/37360). [#37667](https://github.com/ClickHouse/ClickHouse/pull/37667) ([Dmitry Novik](https://github.com/novikd)).
- Fix stack traces collection on ARM. Closes [#37044](https://github.com/ClickHouse/ClickHouse/issues/37044). Closes [#15638](https://github.com/ClickHouse/ClickHouse/issues/15638). [#37797](https://github.com/ClickHouse/ClickHouse/pull/37797) ([Maksim Kita](https://github.com/kitaisreal)).
- Client will try every IP address returned by DNS resolution until successful connection. [#37273](https://github.com/ClickHouse/ClickHouse/pull/37273) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Allow to use String type instead of Binary in Arrow/Parquet/ORC formats. This PR introduces 3 new settings for it: `output_format_arrow_string_as_string`, `output_format_parquet_string_as_string`, `output_format_orc_string_as_string`. Default value for all settings is `false`. [#37327](https://github.com/ClickHouse/ClickHouse/pull/37327) ([Kruglov Pavel](https://github.com/Avogar)).
- Apply setting `input_format_max_rows_to_read_for_schema_inference` for all read rows in total from all files in globs. Previously setting `input_format_max_rows_to_read_for_schema_inference` was applied for each file in glob separately and in case of huge number of nulls we could read first `input_format_max_rows_to_read_for_schema_inference` rows from each file and get nothing. Also increase default value for this setting to 25000. [#37332](https://github.com/ClickHouse/ClickHouse/pull/37332) ([Kruglov Pavel](https://github.com/Avogar)).
- Add separate `CLUSTER` grant (and `access_control_improvements.on_cluster_queries_require_cluster_grant` configuration directive, for backward compatibility, default to `false`). [#35767](https://github.com/ClickHouse/ClickHouse/pull/35767) ([Azat Khuzhin](https://github.com/azat)).
- Added support for schema inference for `hdfsCluster`. [#35812](https://github.com/ClickHouse/ClickHouse/pull/35812) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Implement `least_used` load balancing algorithm for disks inside volume (multi disk configuration). [#36686](https://github.com/ClickHouse/ClickHouse/pull/36686) ([Azat Khuzhin](https://github.com/azat)).
- Modify the HTTP Endpoint to return the full stats under the `X-ClickHouse-Summary` header when `send_progress_in_http_headers=0` (before it would return all zeros). - Modify the HTTP Endpoint to return `X-ClickHouse-Exception-Code` header when progress has been sent before (`send_progress_in_http_headers=1`) - Modify the HTTP Endpoint to return `HTTP_REQUEST_TIMEOUT` (408) instead of `HTTP_INTERNAL_SERVER_ERROR` (500) on `TIMEOUT_EXCEEDED` errors. [#36884](https://github.com/ClickHouse/ClickHouse/pull/36884) ([Raúl Marín](https://github.com/Algunenano)).
- Allow a user to inspect grants from granted roles. [#36941](https://github.com/ClickHouse/ClickHouse/pull/36941) ([nvartolomei](https://github.com/nvartolomei)).
- Do not calculate an integral numerically but use CDF functions instead. This will speed up execution and will increase the precision. This fixes [#36714](https://github.com/ClickHouse/ClickHouse/issues/36714). [#36953](https://github.com/ClickHouse/ClickHouse/pull/36953) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Add default implementation for Nothing in functions. Now most of the functions will return column with type Nothing in case one of it's arguments is Nothing. It also solves problem with functions like arrayMap/arrayFilter and similar when they have empty array as an argument. Previously queries like `select arrayMap(x -> 2 * x, []);` failed because function inside lambda cannot work with type `Nothing`, now such queries return empty array with type `Array(Nothing)`. Also add support for arrays of nullable types in functions like arrayFilter/arrayFill. Previously, queries like `select arrayFilter(x -> x % 2, [1, NULL])` failed, now they work (if the result of lambda is NULL, then this value won't be included in the result). Closes [#37000](https://github.com/ClickHouse/ClickHouse/issues/37000). [#37048](https://github.com/ClickHouse/ClickHouse/pull/37048) ([Kruglov Pavel](https://github.com/Avogar)).
- Now if a shard has local replica we create a local plan and a plan to read from all remote replicas. They have shared initiator which coordinates reading. [#37204](https://github.com/ClickHouse/ClickHouse/pull/37204) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Do no longer abort server startup if configuration option "mark_cache_size" is not explicitly set. [#37326](https://github.com/ClickHouse/ClickHouse/pull/37326) ([Robert Schulze](https://github.com/rschu1ze)).
- Allows providing `NULL`/`NOT NULL` right after type in column declaration. [#37337](https://github.com/ClickHouse/ClickHouse/pull/37337) ([Igor Nikonov](https://github.com/devcrafter)).
- optimize file segment PARTIALLY_DOWNLOADED get read buffer. [#37338](https://github.com/ClickHouse/ClickHouse/pull/37338) ([xiedeyantu](https://github.com/xiedeyantu)).
- Try to improve short circuit functions processing to fix problems with stress tests. [#37384](https://github.com/ClickHouse/ClickHouse/pull/37384) ([Kruglov Pavel](https://github.com/Avogar)).
- Closes [#37395](https://github.com/ClickHouse/ClickHouse/issues/37395). [#37415](https://github.com/ClickHouse/ClickHouse/pull/37415) ([Memo](https://github.com/Joeywzr)).
- Fix extremely rare deadlock during part fetch in zero-copy replication. Fixes [#37423](https://github.com/ClickHouse/ClickHouse/issues/37423). [#37424](https://github.com/ClickHouse/ClickHouse/pull/37424) ([metahys](https://github.com/metahys)).
- Don't allow to create storage with unknown data format. [#37450](https://github.com/ClickHouse/ClickHouse/pull/37450) ([Kruglov Pavel](https://github.com/Avogar)).
- Set `global_memory_usage_overcommit_max_wait_microseconds` default value to 5 seconds. Add info about `OvercommitTracker` to OOM exception message. Add `MemoryOvercommitWaitTimeMicroseconds` profile event. [#37460](https://github.com/ClickHouse/ClickHouse/pull/37460) ([Dmitry Novik](https://github.com/novikd)).
- Do not display `-0.0` CPU time in clickhouse-client. It can appear due to rounding errors. This closes [#38003](https://github.com/ClickHouse/ClickHouse/issues/38003). This closes [#38038](https://github.com/ClickHouse/ClickHouse/issues/38038). [#38064](https://github.com/ClickHouse/ClickHouse/pull/38064) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Play UI: Keep controls in place when the page is scrolled horizontally. This makes edits comfortable even if the table is wide and it was scrolled far to the right. The feature proposed by Maksym Tereshchenko from CaspianDB. [#37470](https://github.com/ClickHouse/ClickHouse/pull/37470) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Modify query div in play.html to be extendable beyond 20% height. In case of very long queries it is helpful to extend the textarea element, only today, since the div is fixed height, the extended textarea hides the data div underneath. With this fix, extending the textarea element will push the data div down/up such the extended textarea won't hide it. Also, keeps query box width 100% even when the user adjusting the size of the query textarea. [#37488](https://github.com/ClickHouse/ClickHouse/pull/37488) ([guyco87](https://github.com/guyco87)).
- Added `ProfileEvents` for introspection of type of written (inserted or merged) parts (`Inserted{Wide/Compact/InMemory}Parts`, `MergedInto{Wide/Compact/InMemory}Parts`. Added column `part_type` to `system.part_log`. Resolves [#37495](https://github.com/ClickHouse/ClickHouse/issues/37495). [#37536](https://github.com/ClickHouse/ClickHouse/pull/37536) ([Anton Popov](https://github.com/CurtizJ)).
- clickhouse-keeper improvement: move broken logs to a timestamped folder. [#37565](https://github.com/ClickHouse/ClickHouse/pull/37565) ([Antonio Andelic](https://github.com/antonio2368)).
- Do not write expired columns by TTL after subsequent merges (before only first merge/optimize of the part will not write expired by TTL columns, all other will do). [#37570](https://github.com/ClickHouse/ClickHouse/pull/37570) ([Azat Khuzhin](https://github.com/azat)).
- More precise result of the `dumpColumnStructure` miscellaneous function in presence of LowCardinality or Sparse columns. In previous versions, these functions were converting the argument to a full column before returning the result. This is needed to provide an answer in [#6935](https://github.com/ClickHouse/ClickHouse/issues/6935). [#37633](https://github.com/ClickHouse/ClickHouse/pull/37633) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- clickhouse-keeper: store only unique session IDs for watches. [#37641](https://github.com/ClickHouse/ClickHouse/pull/37641) ([Azat Khuzhin](https://github.com/azat)).
- Fix possible "Cannot write to finalized buffer". [#37645](https://github.com/ClickHouse/ClickHouse/pull/37645) ([Azat Khuzhin](https://github.com/azat)).
- Add setting `support_batch_delete` for `DiskS3` to disable multiobject delete calls, which Google Cloud Storage doesn't support. [#37659](https://github.com/ClickHouse/ClickHouse/pull/37659) ([Fred Wulff](https://github.com/frew)).
- Add an option to disable connection pooling in ODBC bridge. [#37705](https://github.com/ClickHouse/ClickHouse/pull/37705) ([Anton Kozlov](https://github.com/tonickkozlov)).
- Functions `dictGetHierarchy`, `dictIsIn`, `dictGetChildren`, `dictGetDescendants` added support nullable `HIERARCHICAL` attribute in dictionaries. Closes [#35521](https://github.com/ClickHouse/ClickHouse/issues/35521). [#37805](https://github.com/ClickHouse/ClickHouse/pull/37805) ([Maksim Kita](https://github.com/kitaisreal)).
- Expose BoringSSL version related info in the `system.build_options` table. [#37850](https://github.com/ClickHouse/ClickHouse/pull/37850) ([Bharat Nallan](https://github.com/bharatnc)).
- Now clickhouse-server removes `delete_tmp` directories on server start. Fixes [#26503](https://github.com/ClickHouse/ClickHouse/issues/26503). [#37906](https://github.com/ClickHouse/ClickHouse/pull/37906) ([alesapin](https://github.com/alesapin)).
- Clean up broken detached parts after timeout. Closes [#25195](https://github.com/ClickHouse/ClickHouse/issues/25195). [#37975](https://github.com/ClickHouse/ClickHouse/pull/37975) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Now in MergeTree table engines family failed-to-move parts will be removed instantly. [#37994](https://github.com/ClickHouse/ClickHouse/pull/37994) ([alesapin](https://github.com/alesapin)).
- Now if setting `always_fetch_merged_part` is enabled for ReplicatedMergeTree merges will try to find parts on other replicas rarely with smaller load for [Zoo]Keeper. [#37995](https://github.com/ClickHouse/ClickHouse/pull/37995) ([alesapin](https://github.com/alesapin)).
- Add implicit grants with grant option too. For example `GRANT CREATE TABLE ON test.* TO A WITH GRANT OPTION` now allows `A` to execute `GRANT CREATE VIEW ON test.* TO B`. [#38017](https://github.com/ClickHouse/ClickHouse/pull/38017) ([Vitaly Baranov](https://github.com/vitlibar)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-6}

- Использование `clang-14` и инфраструктуры LLVM версии 14 для сборки. Закрывает [#34681](https://github.com/ClickHouse/ClickHouse/issues/34681). [#34754](https://github.com/ClickHouse/ClickHouse/pull/34754) ([Alexey Milovidov](https://github.com/alexey-milovidov)). Примечание: в `clang-14` есть [ошибка](https://github.com/google/sanitizers/issues/1540) в ThreadSanitizer, которая ухудшает работу нашего CI.
- Возможность сброса привилегий при запуске. Упрощает Docker-образы. Закрывает [#36293](https://github.com/ClickHouse/ClickHouse/issues/36293). [#36341](https://github.com/ClickHouse/ClickHouse/pull/36341) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Добавлена проверка орфографии документации в CI. [#37790](https://github.com/ClickHouse/ClickHouse/pull/37790) ([Vladimir C](https://github.com/vdimir)).
- Исправлено чрезмерно агрессивное удаление отладочных символов, которое удаляло встроенный хеш, необходимый для проверки целостности исполняемого файла. [#37993](https://github.com/ClickHouse/ClickHouse/pull/37993) ([Robert Schulze](https://github.com/rschu1ze)).

#### Исправления ошибок {#bug-fix-2}


* Исправлена обработка запросов `SELECT ... INTERSECT` и `EXCEPT SELECT` с константными строковыми типами. [#37738](https://github.com/ClickHouse/ClickHouse/pull/37738) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена поддержка `GROUP BY` для `AggregateFunction` (т.е. когда вы выполняете `GROUP BY` по столбцу типа `AggregateFunction`). [#37093](https://github.com/ClickHouse/ClickHouse/pull/37093) ([Azat Khuzhin](https://github.com/azat)).
* (экспериментальный WINDOW VIEW) Исправлен `addDependency` в WindowView. Эту ошибку можно воспроизвести так же, как в [#37237](https://github.com/ClickHouse/ClickHouse/issues/37237). [#37224](https://github.com/ClickHouse/ClickHouse/pull/37224) ([vxider](https://github.com/Vxider)).
* Исправлено несоответствие в работе конструкции ORDER BY ... WITH FILL. Запрос, содержащий ORDER BY ... WITH FILL, мог создавать лишние строки при наличии нескольких столбцов WITH FILL. [#38074](https://github.com/ClickHouse/ClickHouse/pull/38074) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Этот PR переносит `addDependency` из конструктора в `startup()`, чтобы избежать добавления зависимости к *удалённой* таблице и исправить [#37237](https://github.com/ClickHouse/ClickHouse/issues/37237). [#37243](https://github.com/ClickHouse/ClickHouse/pull/37243) ([vxider](https://github.com/Vxider)).
* Исправлена вставка значений по умолчанию при отсутствии данных в колоночных форматах. Ранее отсутствующие столбцы заполнялись значениями по умолчанию для типов, а не для самих столбцов. [#37253](https://github.com/ClickHouse/ClickHouse/pull/37253) ([Kruglov Pavel](https://github.com/Avogar)).
* (экспериментальный тип `Object`) Исправлены некоторые случаи вставки вложенных массивов в столбцы типа `Object`. [#37305](https://github.com/ClickHouse/ClickHouse/pull/37305) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены неожиданные ошибки, связанные с конфликтом константных строковых значений в агрегатных функциях, PREWHERE и JOIN. Закрывает [#36891](https://github.com/ClickHouse/ClickHouse/issues/36891). [#37336](https://github.com/ClickHouse/ClickHouse/pull/37336) ([Vladimir C](https://github.com/vdimir)).
* Исправлены проекции с GROUP/ORDER BY в запросе и параметр optimize&#95;aggregation&#95;in&#95;order (ранее результат был некорректным, так как выполнялась только финальная сортировка). [#37342](https://github.com/ClickHouse/ClickHouse/pull/37342) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка, связанная с символами в имени ключа в S3. Исправление для [#33009](https://github.com/ClickHouse/ClickHouse/issues/33009). [#37344](https://github.com/ClickHouse/ClickHouse/pull/37344) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Выбрасывать исключение при использовании GROUPING SETS вместе с ROLLUP или CUBE. [#37367](https://github.com/ClickHouse/ClickHouse/pull/37367) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена ошибка LOGICAL&#95;ERROR в getMaxSourcePartsSizeForMerge во время слияний (в случае нестандартных, увеличенных значений `background_pool_size`/`background_merges_mutations_concurrency_ratio`, заданных в `config.xml` (новый способ), а не в `users.xml` (устаревший способ)). [#37413](https://github.com/ClickHouse/ClickHouse/pull/37413) ([Azat Khuzhin](https://github.com/azat)).
* Перестали удалять BOM UTF-8 в формате RowBinary. [#37428](https://github.com/ClickHouse/ClickHouse/pull/37428) ([Paul Loyd](https://github.com/loyd)). [#37428](https://github.com/ClickHouse/ClickHouse/pull/37428) ([Paul Loyd](https://github.com/loyd)).
* Исправление в clickhouse-keeper: исправлено принудительное восстановление для одноузлового кластера. [#37440](https://github.com/ClickHouse/ClickHouse/pull/37440) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена логическая ошибка в функциях normalizeUTF8. Закрывает [#37298](https://github.com/ClickHouse/ClickHouse/issues/37298). [#37443](https://github.com/ClickHouse/ClickHouse/pull/37443) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлено приведение LowCardinality с Nullable в JoinSwitcher, закрыт [#37385](https://github.com/ClickHouse/ClickHouse/issues/37385). [#37453](https://github.com/ClickHouse/ClickHouse/pull/37453) ([Vladimir C](https://github.com/vdimir)).
* Исправлен вывод именованных кортежей в форматах ORC/Arrow/Parquet. [#37458](https://github.com/ClickHouse/ClickHouse/pull/37458) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена оптимизация монотонных функций в предложении ORDER BY при наличии GROUPING SETS. Исправляет [#37401](https://github.com/ClickHouse/ClickHouse/issues/37401). [#37493](https://github.com/ClickHouse/ClickHouse/pull/37493) ([Dmitry Novik](https://github.com/novikd)).
* Исправлена ошибка при соединении со словарём в определённых условиях. Закрывает [#37386](https://github.com/ClickHouse/ClickHouse/issues/37386). [#37530](https://github.com/ClickHouse/ClickHouse/pull/37530) ([Vladimir C](https://github.com/vdimir)).
* Запретить использование `optimize_aggregation_in_order` с `GROUPING SETS` (исправляет `LOGICAL_ERROR`). [#37542](https://github.com/ClickHouse/ClickHouse/pull/37542) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена некорректная информация в дампе ActionsDAG. [#37587](https://github.com/ClickHouse/ClickHouse/pull/37587) ([zhanglistar](https://github.com/zhanglistar)).
* Исправлено преобразование типов в запросах UNION (могло приводить к LOGICAL&#95;ERROR). [#37593](https://github.com/ClickHouse/ClickHouse/pull/37593) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена работа модификатора `WITH FILL` с отрицательными интервалами в секции `STEP`. Устранена проблема [#37514](https://github.com/ClickHouse/ClickHouse/issues/37514). [#37600](https://github.com/ClickHouse/ClickHouse/pull/37600) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено некорректное использование joinGet с массивами при `join_use_nulls = 1`. Это исправляет [#37562](https://github.com/ClickHouse/ClickHouse/issues/37562). [#37650](https://github.com/ClickHouse/ClickHouse/pull/37650) ([Amos Bird](https://github.com/amosbird)).
* Исправлено несоответствие числа столбцов в CROSS JOIN, закрыта задача [#37561](https://github.com/ClickHouse/ClickHouse/issues/37561). [#37653](https://github.com/ClickHouse/ClickHouse/pull/37653) ([Vladimir C](https://github.com/vdimir)).
* Устранена ошибка сегментации в `SHOW CREATE TABLE` для базы данных MySQL, настроенной с именованными коллекциями. Закрывает [#37683](https://github.com/ClickHouse/ClickHouse/issues/37683). [#37690](https://github.com/ClickHouse/ClickHouse/pull/37690) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проблема, из-за которой хранилище RabbitMQ не могло запуститься при перезапуске сервера, если оно было создано без клаузы SETTINGS. Закрывает [#37463](https://github.com/ClickHouse/ClickHouse/issues/37463). [#37691](https://github.com/ClickHouse/ClickHouse/pull/37691) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Пользовательские SQL-функции отключают CREATE/DROP в режиме только чтения. Закрывает [#37280](https://github.com/ClickHouse/ClickHouse/issues/37280). [#37699](https://github.com/ClickHouse/ClickHouse/pull/37699) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлено форматирование аргументов `Nullable` для исполняемых пользовательских функций. Закрывает [#35897](https://github.com/ClickHouse/ClickHouse/issues/35897). [#37711](https://github.com/ClickHouse/ClickHouse/pull/37711) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена оптимизация, включаемая параметром `optimize_monotonous_functions_in_order_by` в распределённых запросах. Устраняет [#36037](https://github.com/ClickHouse/ClickHouse/issues/36037). [#37724](https://github.com/ClickHouse/ClickHouse/pull/37724) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена возможная логическая ошибка: `Invalid Field get from type UInt64 to type Float64` в табличной функции `values`. Закрывает [#37602](https://github.com/ClickHouse/ClickHouse/issues/37602). [#37754](https://github.com/ClickHouse/ClickHouse/pull/37754) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена возможная ошибка сегментации при определении схемы в случае возникновения исключения в конструкторе `SchemaReader`. Закрывает [#37680](https://github.com/ClickHouse/ClickHouse/issues/37680). [#37760](https://github.com/ClickHouse/ClickHouse/pull/37760) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена обработка настройки cast&#95;ipv4&#95;ipv6&#95;default&#95;on&#95;conversion&#95;error во внутренней функции приведения типов. Закрывает [#35156](https://github.com/ClickHouse/ClickHouse/issues/35156). [#37761](https://github.com/ClickHouse/ClickHouse/pull/37761) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена ошибка функции toString для DatatypeDate32. [#37775](https://github.com/ClickHouse/ClickHouse/pull/37775) ([LiuNeng](https://github.com/liuneng1994)).
* Настройка clickhouse-keeper `dead_session_check_period_ms` была преобразована в микросекунды (умножена на 1000), что привело к очистке мёртвых сессий только спустя несколько минут (вместо 500 мс). [#37824](https://github.com/ClickHouse/ClickHouse/pull/37824) ([Michael Lex](https://github.com/mlex)).
* Исправлена возможная ошибка &quot;No more packets are available&quot; для распределённых запросов (в случае, когда `async_socket_for_remote`/`use_hedged_requests` отключены). [#37826](https://github.com/ClickHouse/ClickHouse/pull/37826) ([Azat Khuzhin](https://github.com/azat)).
* (экспериментальный WINDOW VIEW) В WindowView при выполнении `ALTER TABLE ... MODIFY QUERY` внутренняя целевая таблица больше не удаляется. [#37879](https://github.com/ClickHouse/ClickHouse/pull/37879) ([vxider](https://github.com/Vxider)).
* Исправлены права владения каталогом coordination в Docker-образе clickhouse-keeper. Исправляет проблему [#37914](https://github.com/ClickHouse/ClickHouse/issues/37914). [#37915](https://github.com/ClickHouse/ClickHouse/pull/37915) ([James Maidment](https://github.com/jamesmaidment)).
* Словари: исправлен пользовательский запрос с полем обновления и `{condition}`. Закрывает [#33746](https://github.com/ClickHouse/ClickHouse/issues/33746). [#37947](https://github.com/ClickHouse/ClickHouse/pull/37947) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена возможная ошибка в результате выполнения `SELECT ... WITH FILL` в случае, когда `ORDER BY` должен применяться к результату `WITH FILL` (например, во внешнем запросе). Некорректный результат был вызван оптимизацией выражений `ORDER BY` ([#35623](https://github.com/ClickHouse/ClickHouse/issues/35623)). Закрывает [#37904](https://github.com/ClickHouse/ClickHouse/issues/37904). [#37959](https://github.com/ClickHouse/ClickHouse/pull/37959) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* (экспериментальная WINDOW VIEW) Теперь при передаче данных в целевую таблицу из WindowView автоматически добавляются отсутствующие столбцы по умолчанию, исправлена проблема [#37815](https://github.com/ClickHouse/ClickHouse/issues/37815). [#37965](https://github.com/ClickHouse/ClickHouse/pull/37965) ([vxider](https://github.com/Vxider)).
* Исправлен слишком большой кадр стека, который приводил к ошибке компиляции. [#37996](https://github.com/ClickHouse/ClickHouse/pull/37996) ([Han Shukai](https://github.com/KinderRiven)).
* При включении параметра enable&#95;filesystem&#95;query&#95;cache&#95;limit генерировать ошибку «Зарезервированный размер кэша превышает оставшийся размер кэша». [#38004](https://github.com/ClickHouse/ClickHouse/pull/38004) ([xiedeyantu](https://github.com/xiedeyantu)).
* Исправлено преобразование типов в запросах UNION, что могло приводить к LOGICAL&#95;ERROR. [#34775](https://github.com/ClickHouse/ClickHouse/pull/34775) ([Azat Khuzhin](https://github.com/azat)).
* Слияние по TTL может не быть повторно запланировано, если BackgroundExecutor занят. --merges&#95;with&#95;ttl&#95;counter увеличивается в selectPartsToMerge() --задача слияния будет проигнорирована, если BackgroundExecutor занят --merges&#95;with&#95;ttl&#95;counter не будет уменьшаться. [#36387](https://github.com/ClickHouse/ClickHouse/pull/36387) ([lthaooo](https://github.com/lthaooo)).
* Исправлена ошибка с переопределённым значением настройки `normalize_function_names`. [#36937](https://github.com/ClickHouse/ClickHouse/pull/36937) ([李扬](https://github.com/taiyang-li)).
* Исправлена ошибка в оконных функциях с экспоненциальным затуханием по времени. Теперь корректно учитываются границы окна. [#36944](https://github.com/ClickHouse/ClickHouse/pull/36944) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Исправлена потенциальная ошибка heap-use-after-free при чтении system.projection&#95;parts и system.projection&#95;parts&#95;columns. Это исправляет [#37184](https://github.com/ClickHouse/ClickHouse/issues/37184). [#37185](https://github.com/ClickHouse/ClickHouse/pull/37185) ([Amos Bird](https://github.com/amosbird)).
* Исправлено поведение дробной части секунд в `DateTime64` для значений до начала эпохи Unix. [#37697](https://github.com/ClickHouse/ClickHouse/pull/37697) ([Andrey Zvonov](https://github.com/zvonand)). [#37039](https://github.com/ClickHouse/ClickHouse/pull/37039) ([李扬](https://github.com/taiyang-li)).

### <a id="225"></a> Релиз ClickHouse 22.5, 2022-05-19 {#a-id225a-clickhouse-release-225-2022-05-19}

#### Примечания к обновлению {#upgrade-notes-2}

- Теперь фоновые слияния, мутации и `OPTIMIZE` не будут увеличивать метрики `SelectedRows` и `SelectedBytes`. Они по-прежнему будут увеличивать `MergedRows` и `MergedUncompressedBytes`, как и раньше. Это влияет только на значения метрик и делает их более точными. Данное изменение не вносит несовместимости, но вы можете заметить изменения в метриках, поэтому мы включили его в эту категорию. [#37040](https://github.com/ClickHouse/ClickHouse/pull/37040) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Модуль BoringSSL обновлен до официальной версии, соответствующей стандарту FIPS. Это делает ClickHouse совместимым с FIPS. [#35914](https://github.com/ClickHouse/ClickHouse/pull/35914) ([Meena-Renganathan](https://github.com/Meena-Renganathan)). Шифры `aes-192-cfb128` и `aes-256-cfb128` были удалены, так как они не включены в сертифицированную FIPS версию BoringSSL.
- Настройка `max_memory_usage` удалена из профиля пользователя по умолчанию в `users.xml`. Это позволяет использовать гибкие ограничения памяти для запросов вместо прежнего жесткого ограничения в 10 ГБ.
- Настройка `log_query_threads` отключена по умолчанию. Она управляет логированием статистики о каждом потоке, участвующем в выполнении запроса. После добавления поддержки асинхронного чтения общее количество различных идентификаторов потоков стало слишком большим, и запись в `query_thread_log` стала слишком ресурсоемкой. [#37077](https://github.com/ClickHouse/ClickHouse/pull/37077) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Удалена функция `groupArraySorted`, содержащая ошибку. [#36822](https://github.com/ClickHouse/ClickHouse/pull/36822) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### Новые возможности {#new-feature-7}


- Включен механизм memory overcommit по умолчанию. [#35921](https://github.com/ClickHouse/ClickHouse/pull/35921) ([Dmitry Novik](https://github.com/novikd)).
- Добавлена поддержка GROUPING SETS в предложении GROUP BY. Данная реализация поддерживает параллельную обработку наборов группировки. [#33631](https://github.com/ClickHouse/ClickHouse/pull/33631) ([Dmitry Novik](https://github.com/novikd)).
- Добавлена таблица `system.certificates`. [#37142](https://github.com/ClickHouse/ClickHouse/pull/37142) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Добавлены функции `h3Line`, `h3Distance` и `h3HexRing`. [#37030](https://github.com/ClickHouse/ClickHouse/pull/37030) ([Bharat Nallan](https://github.com/bharatnc)).
- Новый инструмент диагностики на основе единого бинарного файла (clickhouse-diagnostics). [#36705](https://github.com/ClickHouse/ClickHouse/pull/36705) ([Dale McDiarmid](https://github.com/gingerwizard)).
- Добавлен выходной формат `Prometheus` [#36051](https://github.com/ClickHouse/ClickHouse/issues/36051). [#36206](https://github.com/ClickHouse/ClickHouse/pull/36206) ([Vladimir C](https://github.com/vdimir)).
- Добавлен входной формат `MySQLDump`. Он читает все данные из запросов INSERT, относящихся к одной таблице в дампе. Если таблиц больше одной, по умолчанию читаются данные из первой таблицы. [#36667](https://github.com/ClickHouse/ClickHouse/pull/36667) ([Kruglov Pavel](https://github.com/Avogar)).
- Добавлено отображение полей `total_rows` и `total_bytes` в `system.tables` для временных таблиц. [#36401](https://github.com/ClickHouse/ClickHouse/issues/36401). [#36439](https://github.com/ClickHouse/ClickHouse/pull/36439) ([xiedeyantu](https://github.com/xiedeyantu)).
- Добавлена возможность переопределения `parts_to_delay_insert` и `parts_to_throw_insert` настройками уровня запроса. Если они определены, они переопределят настройки уровня таблицы. [#36371](https://github.com/ClickHouse/ClickHouse/pull/36371) ([Memo](https://github.com/Joeywzr)).

#### Экспериментальная функциональность {#experimental-feature-6}


- Реализованы функции расстояния L1, L2, Linf, косинусного расстояния для массивов, а также функции норм L1, L2, Linf для массивов.
  [#37033](https://github.com/ClickHouse/ClickHouse/pull/37033) ([qieqieplus](https://github.com/qieqieplus)). Предупреждение: функции будут переименованы.
- Улучшен запрос `WATCH` в WindowView: 1. Снижена задержка предоставления результатов запроса за счёт вызова сигнала `fire_condition`. 2. Ускорена операция отмены запроса (ctrl-c) за счёт более частой проверки `isCancelled()`. [#37226](https://github.com/ClickHouse/ClickHouse/pull/37226) ([vxider](https://github.com/Vxider)).
- Интроспекция для удаления кеша файловой системы. [#36802](https://github.com/ClickHouse/ClickHouse/pull/36802) ([Han Shukai](https://github.com/KinderRiven)).
- Добавлена новая хеш-функция `wyHash64` для SQL. [#36467](https://github.com/ClickHouse/ClickHouse/pull/36467) ([olevino](https://github.com/olevino)).
- Улучшение для реплицируемых баз данных: добавлен запрос `SYSTEM SYNC DATABASE REPLICA`, который позволяет синхронизировать метаданные таблиц внутри реплицируемой базы данных, поскольку в настоящее время синхронизация выполняется асинхронно. [#35944](https://github.com/ClickHouse/ClickHouse/pull/35944) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Улучшение для кеша удалённой файловой системы: улучшено чтение из кеша. [#37054](https://github.com/ClickHouse/ClickHouse/pull/37054) ([Kseniia Sumarokova](https://github.com/kssenii)). Улучшен запрос `SYSTEM DROP FILESYSTEM CACHE`: добавлены опции `<path>` и `FORCE`. [#36639](https://github.com/ClickHouse/ClickHouse/pull/36639) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Улучшение для полуструктурированных данных: разрешено приведение столбцов типа `Object(...)` к типу `Object(Nullable(...))`. [#36564](https://github.com/ClickHouse/ClickHouse/pull/36564) ([awakeljw](https://github.com/awakeljw)).
- Улучшение для параллельных реплик: локальный интерпретатор создаётся при выполнении запроса на реплике localhost. Однако при выполнении запроса на нескольких репликах требуется наличие соединения, чтобы реплики могли взаимодействовать с координатором. Теперь реплика localhost может взаимодействовать с координатором напрямую в том же процессе. [#36281](https://github.com/ClickHouse/ClickHouse/pull/36281) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).

#### Улучшения производительности {#performance-improvement-7}


- Улучшена производительность агрегатных функций `avg`, `sum` при использовании без выражения GROUP BY. [#37257](https://github.com/ClickHouse/ClickHouse/pull/37257) ([Maksim Kita](https://github.com/kitaisreal)).
- Улучшена производительность унарных арифметических функций (`bitCount`, `bitNot`, `abs`, `intExp2`, `intExp10`, `negate`, `roundAge`, `roundDuration`, `roundToExp2`, `sign`) за счёт использования динамической диспетчеризации. [#37289](https://github.com/ClickHouse/ClickHouse/pull/37289) ([Maksim Kita](https://github.com/kitaisreal)).
- Улучшена производительность ORDER BY, MergeJoin, вставки в MergeTree за счёт JIT-компиляции компаратора столбцов сортировки. [#34469](https://github.com/ClickHouse/ClickHouse/pull/34469) ([Maksim Kita](https://github.com/kitaisreal)).
- Изменена структура `system.asynchronous_metric_log`. Теперь она занимает примерно в 10 раз меньше места. Это закрывает [#36357](https://github.com/ClickHouse/ClickHouse/issues/36357). Поле `event_time_microseconds` удалено, так как оно не используется. [#36360](https://github.com/ClickHouse/ClickHouse/pull/36360) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Загрузка меток только для необходимых столбцов при чтении широких кусков данных. [#36879](https://github.com/ClickHouse/ClickHouse/pull/36879) ([Anton Kozlov](https://github.com/tonickkozlov)).
- Улучшена производительность кэша файловых дескрипторов за счёт сужения областей действия мьютексов. [#36682](https://github.com/ClickHouse/ClickHouse/pull/36682) ([Anton Kozlov](https://github.com/tonickkozlov)).
- Улучшена производительность чтения из хранилища `File` и табличных функций `file` в случае, когда путь содержит шаблоны и соответствующий каталог содержит большое количество файлов. [#36647](https://github.com/ClickHouse/ClickHouse/pull/36647) ([Anton Popov](https://github.com/CurtizJ)).
- Применён параллельный парсинг для входного формата `HiveText`, что позволяет ускорить разбор HiveText в 2 раза при чтении локального файла. [#36650](https://github.com/ClickHouse/ClickHouse/pull/36650) ([李扬](https://github.com/taiyang-li)).
- По умолчанию `HashJoin` не является потокобезопасным для вставки строк правой таблицы и выполняется в одном потоке. Когда правая таблица большая, процесс соединения выполняется слишком медленно с низкой загрузкой процессора. [#36415](https://github.com/ClickHouse/ClickHouse/pull/36415) ([lgbo](https://github.com/lgbo-ustc)).
- Добавлена возможность переписывать `select countDistinct(a) from t` в `select count(1) from (select a from t groupBy a)`. [#35993](https://github.com/ClickHouse/ClickHouse/pull/35993) ([zhanglistar](https://github.com/zhanglistar)).
- Преобразование цепочки OR LIKE в multiMatchAny. Будет включено после дополнительного тестирования. [#34932](https://github.com/ClickHouse/ClickHouse/pull/34932) ([Daniel Kutenin](https://github.com/danlark1)).
- Улучшена производительность некоторых функций за счёт встраивания. [#34544](https://github.com/ClickHouse/ClickHouse/pull/34544) ([Daniel Kutenin](https://github.com/danlark1)).
- Добавлена ветвь для предотвращения ненужного memcpy в readBig. Это несколько улучшает производительность. [#36095](https://github.com/ClickHouse/ClickHouse/pull/36095) ([jasperzhu](https://github.com/jinjunzh)).
- Реализован частичный ключ GROUP BY для optimize_aggregation_in_order. [#35111](https://github.com/ClickHouse/ClickHouse/pull/35111) ([Azat Khuzhin](https://github.com/azat)).

#### Улучшения {#improvement-7}


* Показывать имена файлов, для которых возникли ошибки парсинга, при выполнении табличных функций `file`, `s3` и `url`. [#36314](https://github.com/ClickHouse/ClickHouse/pull/36314) ([Anton Popov](https://github.com/CurtizJ)).
* Разрешено динамически увеличивать число потоков для выполнения фоновых операций (слияний, мутаций, перемещений и выборок), если соответствующие настройки заданы в конфигурации верхнего уровня. [#36425](https://github.com/ClickHouse/ClickHouse/pull/36425) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Теперь функции преобразования даты и времени, которые генерируют значения до 1970-01-01 00:00:00 с часовыми поясами с дробным смещением по часам/минутам, будут обрезать результат до нуля вместо переполнения. Это продолжение [https://github.com/ClickHouse/ClickHouse/pull/29953](https://github.com/ClickHouse/ClickHouse/pull/29953), которое касается обсуждения [https://github.com/ClickHouse/ClickHouse/pull/29953#discussion&#95;r800550280](https://github.com/ClickHouse/ClickHouse/pull/29953#discussion_r800550280). Отмечено как улучшение, поскольку это поведение определяется реализацией (и является крайне редким случаем), и мы можем позволить себе его изменить. [#36656](https://github.com/ClickHouse/ClickHouse/pull/36656) ([Amos Bird](https://github.com/amosbird)).
* Добавлено предупреждение при запуске clickhouse-server с уровнем логирования &quot;test&quot;. Уровень логирования &quot;test&quot; был добавлен недавно и не может использоваться в продакшене из-за неизбежного, неустранимого, фатального и, без преувеличения, катастрофического падения производительности. [#36824](https://github.com/ClickHouse/ClickHouse/pull/36824) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Разбор параметров сортировки (collations) в CREATE TABLE: выбрасывать исключение или игнорировать их. Закрывает [#35892](https://github.com/ClickHouse/ClickHouse/issues/35892). [#36271](https://github.com/ClickHouse/ClickHouse/pull/36271) ([yuuch](https://github.com/yuuch)).
* Параметр `compatibility_ignore_auto_increment_in_create_table` позволяет игнорировать ключевое слово `AUTO_INCREMENT` при объявлении столбца, упрощая миграцию с MySQL. [#37178](https://github.com/ClickHouse/ClickHouse/pull/37178) ([Igor Nikonov](https://github.com/devcrafter)).
* Добавлены псевдонимы `JSONLines` и `NDJSON` для `JSONEachRow`. Закрыта задача [#36303](https://github.com/ClickHouse/ClickHouse/issues/36303). [#36327](https://github.com/ClickHouse/ClickHouse/pull/36327) ([flynn](https://github.com/ucasfl)).
* Ограничено максимальное количество партиций, которые можно запрашивать для каждой таблицы Hive, чтобы избежать перерасхода ресурсов. [#37281](https://github.com/ClickHouse/ClickHouse/pull/37281) ([lgbo](https://github.com/lgbo-ustc)).
* Добавлено неявное приведение типа для второго аргумента функции `h3kRing` для улучшения удобства использования. Закрывает [#35432](https://github.com/ClickHouse/ClickHouse/issues/35432). [#37189](https://github.com/ClickHouse/ClickHouse/pull/37189) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена индикация прогресса для `INSERT SELECT` в `clickhouse-local` для любых запросов, а также прогресса чтения файлов в клиенте; обеспечена более корректная индикация прогресса для файлов. [#37075](https://github.com/ClickHouse/ClickHouse/pull/37075) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка, которая могла приводить к тому, что устаревшие части в семействе движков таблиц MergeTree оставались в случае сбоев файловой системы во время их удаления. До исправления они удалялись только после первой перезагрузки сервера. [#37014](https://github.com/ClickHouse/ClickHouse/pull/37014) ([alesapin](https://github.com/alesapin)).
* Реализован новый режим обработки политик строк, который можно включить в основной конфигурации и который позволяет пользователям читать строки даже при отсутствии разрешающих политик строк. [#36997](https://github.com/ClickHouse/ClickHouse/pull/36997) ([Vitaly Baranov](https://github.com/vitlibar)).
* Play UI: значения числовых типов Nullable будут выравниваться по правому краю в ячейках таблицы. Это закрывает [#36982](https://github.com/ClickHouse/ClickHouse/issues/36982). [#36988](https://github.com/ClickHouse/ClickHouse/pull/36988) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Play UI: если результат содержит одну строку и много столбцов, отображать его в вертикальном виде. Продолжение [#36811](https://github.com/ClickHouse/ClickHouse/issues/36811). [#36842](https://github.com/ClickHouse/ClickHouse/pull/36842) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Приведён в порядок CSS в интерфейсе Play UI. Пиксели размещены более равномерно. Улучшено удобство работы с длинным содержимым в ячейках таблицы. [#36569](https://github.com/ClickHouse/ClickHouse/pull/36569) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Финализируем буферы записи при возникновении исключения, чтобы не делать это в деструкторах. Надеемся, это исправит проблему: [#36907](https://github.com/ClickHouse/ClickHouse/issues/36907). [#36979](https://github.com/ClickHouse/ClickHouse/pull/36979) ([Kruglov Pavel](https://github.com/Avogar)).
* После [#36425](https://github.com/ClickHouse/ClickHouse/issues/36425) такие настройки, как `background_fetches_pool_size`, стали считаться устаревшими и могут располагаться в конфигурации верхнего уровня, однако ClickHouse выдаёт исключение вида `Error updating configuration from '/etc/clickhouse-server/config.xml' config.: Code: 137. DB::Exception: A setting 'background_fetches_pool_size' appeared at top level in config /etc/clickhouse-server/config.xml.` Это исправлено. [#36917](https://github.com/ClickHouse/ClickHouse/pull/36917) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлена дополнительная диагностическая информация (если применимо) при отправке исключения на другой сервер. [#36872](https://github.com/ClickHouse/ClickHouse/pull/36872) ([tavplubix](https://github.com/tavplubix)).
* Добавлена возможность выполнения хэш-функций с аргументами типа `Array(Tuple(..))`. [#36812](https://github.com/ClickHouse/ClickHouse/pull/36812) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлен параметр конфигурации `user_defined_path`. [#36753](https://github.com/ClickHouse/ClickHouse/pull/36753) ([Maksim Kita](https://github.com/kitaisreal)).
* Разрешено использование кластерного макроса в табличной функции `s3Cluster`. [#36726](https://github.com/ClickHouse/ClickHouse/pull/36726) ([Vadim Volodin](https://github.com/PolyProgrammist)).
* Корректная отмена запросов INSERT в `clickhouse-client`/`clickhouse-local`. [#36710](https://github.com/ClickHouse/ClickHouse/pull/36710) ([Azat Khuzhin](https://github.com/azat)).
* Позволяет отменять запрос, при этом сохраняя корректный идентификатор запроса в `MySQLHandler`. [#36699](https://github.com/ClickHouse/ClickHouse/pull/36699) ([Amos Bird](https://github.com/amosbird)).
* Добавлен столбец `is_all_data_sent` в `system.processes` и улучшена внутренняя проверка надежности тестирования на его основе. [#36649](https://github.com/ClickHouse/ClickHouse/pull/36649) ([Azat Khuzhin](https://github.com/azat)).
* Метрики, отражающие время, затраченное на чтение из S3, теперь вычисляются корректно. Закрывает [#35483](https://github.com/ClickHouse/ClickHouse/issues/35483). [#36572](https://github.com/ClickHouse/ClickHouse/pull/36572) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Разрешить использование файловых дескрипторов в табличной функции file, если она выполняется в clickhouse-local. [#36562](https://github.com/ClickHouse/ClickHouse/pull/36562) ([wuxiaobai24](https://github.com/wuxiaobai24)).
* Разрешены имена элементов `tuple`, начинающиеся с цифр. [#36544](https://github.com/ClickHouse/ClickHouse/pull/36544) ([Anton Popov](https://github.com/CurtizJ)).
* Теперь clickhouse-benchmark может считывать данные для аутентификации из переменных окружения. [#36497](https://github.com/ClickHouse/ClickHouse/pull/36497) ([Anton Kozlov](https://github.com/tonickkozlov)).
* Улучшение `clickhouse-keeper`: добавлена поддержка принудительного восстановления (force recovery), которая позволяет изменять конфигурацию кластера без кворума. [#36258](https://github.com/ClickHouse/ClickHouse/pull/36258) ([Antonio Andelic](https://github.com/antonio2368)).
* Улучшен вывод схемы для объектов JSON. [#36207](https://github.com/ClickHouse/ClickHouse/pull/36207) ([Kruglov Pavel](https://github.com/Avogar)).
* Рефакторинг кода, связанного с выводом схемы при использовании glob-шаблонов. Переход к следующему файлу из glob-шаблона выполняется только если это имеет смысл (ранее мы переходили к следующему файлу при любой ошибке). Также это исправляет [#36317](https://github.com/ClickHouse/ClickHouse/issues/36317). [#36205](https://github.com/ClickHouse/ClickHouse/pull/36205) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлено отдельное право `CLUSTER` (и конфигурационная директива `access_control_improvements.on_cluster_queries_require_cluster_grant` для обратной совместимости, по умолчанию — `false`). [#35767](https://github.com/ClickHouse/ClickHouse/pull/35767) ([Azat Khuzhin](https://github.com/azat)).
* Если необходимый объем памяти становится доступен до того, как выбранный запрос будет остановлен, все ожидающие запросы продолжают выполняться. Теперь мы не останавливаем ни один запрос, если память освобождается раньше, чем выбранный запрос узнаёт об отмене. [#35637](https://github.com/ClickHouse/ClickHouse/pull/35637) ([Dmitry Novik](https://github.com/novikd)).
* Определение `Nullable` в protobuf. В proto3 значения по умолчанию не передаются по сети. Это усложняет различение `null` и значений по умолчанию для столбцов типа `Nullable`. Стандартный способ решить эту проблему — использовать обёртки Google, помещая целевое значение во вложенное сообщение (см. [https://github.com/protocolbuffers/protobuf/blob/master/src/google/protobuf/wrappers.proto](https://github.com/protocolbuffers/protobuf/blob/master/src/google/protobuf/wrappers.proto)). В этом случае отсутствующее поле интерпретируется как значение `null`, поле с отсутствующим значением интерпретируется как значение по умолчанию, а поле с обычным значением интерпретируется как обычное значение. Однако ClickHouse интерпретирует обёртки Google как вложенные столбцы. Мы предлагаем ввести особое поведение для обнаружения обёрток Google и интерпретировать их так, как описано выше. Например, для сериализации значений столбца `Nullable` `test` мы бы использовали `google.protobuf.StringValue test` в нашей .proto-схеме. Обратите внимание, что эти типы являются так называемыми «well-known types» в Protobuf, реализованными в самой библиотеке. [#35149](https://github.com/ClickHouse/ClickHouse/pull/35149) ([Jakub Kuklis](https://github.com/jkuklis)).
* Добавлена поддержка указания `content_type` в конфигурации предопределённых и статических HTTP-обработчиков. [#34916](https://github.com/ClickHouse/ClickHouse/pull/34916) ([Roman Nikonov](https://github.com/nic11)).
* Корректно предупреждать при использовании clickhouse-client с параметром --file без предшествующего --external. Закрывает [#34747](https://github.com/ClickHouse/ClickHouse/issues/34747). [#34765](https://github.com/ClickHouse/ClickHouse/pull/34765) ([李扬](https://github.com/taiyang-li)).
* Улучшен движок базы данных MySQL для обеспечения совместимости с типом данных BINARY(0). [#37232](https://github.com/ClickHouse/ClickHouse/pull/37232) ([zzsmdfj](https://github.com/zzsmdfj)).
* Улучшен JSON-отчет в `clickhouse-benchmark`. [#36473](https://github.com/ClickHouse/ClickHouse/pull/36473) ([Tian Xinhui](https://github.com/xinhuitian)).
* Сервер мог не запускаться, если не удавалось разрешить имя хоста внешнего словаря ClickHouse. Исправлено. Исправляет [#36451](https://github.com/ClickHouse/ClickHouse/issues/36451). [#36463](https://github.com/ClickHouse/ClickHouse/pull/36463) ([tavplubix](https://github.com/tavplubix)).

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-7}

- Теперь `clickhouse-keeper` для архитектуры `x86_64` статически связан с [musl](https://musl.libc.org/) и не зависит от системных библиотек. [#31833](https://github.com/ClickHouse/ClickHouse/pull/31833) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Сборки ClickHouse для архитектуры `PowerPC64LE` теперь доступны в универсальном скрипте установки `curl https://clickhouse.com/ | sh` и по прямой ссылке `https://builds.clickhouse.com/master/powerpc64le/clickhouse`. [#37095](https://github.com/ClickHouse/ClickHouse/pull/37095) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Генерация кода PowerPC ограничена версией Power8 для лучшей совместимости. Это закрывает [#36025](https://github.com/ClickHouse/ClickHouse/issues/36025). [#36529](https://github.com/ClickHouse/ClickHouse/pull/36529) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Упрощён тест производительности. Это даст нам возможность его использовать. [#36769](https://github.com/ClickHouse/ClickHouse/pull/36769) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Сравнение производительности теперь прерывается при ошибках в отчёте. [#34797](https://github.com/ClickHouse/ClickHouse/pull/34797) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Добавлена поддержка ZSTD для Arrow. Это исправляет [#35283](https://github.com/ClickHouse/ClickHouse/issues/35283). [#35486](https://github.com/ClickHouse/ClickHouse/pull/35486) ([Sean Lafferty](https://github.com/seanlaff)).

#### Исправление ошибок {#bug-fix-3}


* Извлекает идентификатор версии (Version ID), если он присутствует, из URI и добавляет параметр запроса к AWS HTTP URI. Закрывает [#31221](https://github.com/ClickHouse/ClickHouse/issues/31221). - [x] Извлечь `Version ID` из URI, если он присутствует, и заново собрать URI без него. - [x] Настроить объект `AWS HTTP URI` с запросом. - [x] Модульные тесты: [`gtest_s3_uri`](https://github.com/ClickHouse/ClickHouse/blob/2340a6c6849ebc05a8efbf97ba8de3ff9dc0eff4/src/IO/tests/gtest_s3_uri.cpp) - [x] Удалить коммит с инструментированием. [#34571](https://github.com/ClickHouse/ClickHouse/pull/34571) ([Saad Ur Rahman](https://github.com/surahman)).
* Исправлен псевдоним attribute.values в system.opentelemetry&#95;span&#95;log: теперь он ссылается на values вместо keys. [#37275](https://github.com/ClickHouse/ClickHouse/pull/37275) ([Aleksandr Razumov](https://github.com/ernado)).
* Исправлено преобразование Nullable(String) в Nullable(Bool/IPv4/IPv6). Закрывает [#37221](https://github.com/ClickHouse/ClickHouse/issues/37221). [#37270](https://github.com/ClickHouse/ClickHouse/pull/37270) ([Kruglov Pavel](https://github.com/Avogar)).
* Экспериментальная возможность: исправлена обработка мутаций в таблицах, содержащих столбцы типа `Object`. Использование подстолбцов типа `Object` в выражении `WHERE` запросов `UPDATE` или `DELETE` пока ещё не поддерживается, равно как и выполнение операций (`DROP`, `MODIFY`) над отдельными подстолбцами. Исправляет [#37205](https://github.com/ClickHouse/ClickHouse/issues/37205). [#37266](https://github.com/ClickHouse/ClickHouse/pull/37266) ([Anton Popov](https://github.com/CurtizJ)).
* Kafka не требует указания `group.id` на стороне продюсера. В консольном логе можно увидеть предупреждение, описывающее эту проблему: `2022.05.15 17:59:13.270227 [ 137 ] {} <Warning> StorageKafka (topic-name): [rdk:CONFWARN] [thrd:app]: Configuration property group.id is a consumer property and will be ignored by this producer instance`. [#37228](https://github.com/ClickHouse/ClickHouse/pull/37228) ([Mark Andreev](https://github.com/mrk-andreev)).
* Экспериментальная возможность (WindowView): обновлять `max_fired_watermark` после фактического срабатывания блоков, на случай удаления данных, которые ещё не были обработаны. [#37225](https://github.com/ClickHouse/ClickHouse/pull/37225) ([vxider](https://github.com/Vxider)).
* Исправлена ошибка «Cannot create column of type Set» для распределённых запросов с LIMIT BY. [#37193](https://github.com/ClickHouse/ClickHouse/pull/37193) ([Azat Khuzhin](https://github.com/azat)).
* Экспериментальная возможность: теперь запрос `WATCH EVENTS` WindowView не будет завершаться из-за непустого Chunk, создаваемого в `WindowViewSource.h:58`. [#37182](https://github.com/ClickHouse/ClickHouse/pull/37182) ([vxider](https://github.com/Vxider)).
* Включена настройка `enable_global_with_statement` для подзапросов, закрыта задача [#37141](https://github.com/ClickHouse/ClickHouse/issues/37141). [#37166](https://github.com/ClickHouse/ClickHouse/pull/37166) ([Vladimir C](https://github.com/vdimir)).
* Исправлено неявное преобразование типов для optimize&#95;skip&#95;unused&#95;shards&#95;rewrite&#95;in. [#37153](https://github.com/ClickHouse/ClickHouse/pull/37153) ([Azat Khuzhin](https://github.com/azat)).
* Функция ILIKE для столбцов типа FixedString могла возвращать некорректные результаты (то есть находить меньше совпадений, чем должна). [#37117](https://github.com/ClickHouse/ClickHouse/pull/37117) ([Robert Schulze](https://github.com/rschu1ze)).
* Исправлена работа `GROUP BY` с `AggregateFunction` (т. е. когда вы выполняете `GROUP BY` по столбцу типа `AggregateFunction`). [#37093](https://github.com/ClickHouse/ClickHouse/pull/37093) ([Azat Khuzhin](https://github.com/azat)).
* Экспериментальная возможность: исправлена `optimize_aggregation_in_order` с префиксным GROUP BY и агрегатными функциями семейства *Array. [#37050](https://github.com/ClickHouse/ClickHouse/pull/37050) ([Azat Khuzhin](https://github.com/azat)).
* Устранена деградация производительности некоторых запросов INSERT SELECT с неявной агрегацией. Исправляет [#36792](https://github.com/ClickHouse/ClickHouse/issues/36792). [#37047](https://github.com/ClickHouse/ClickHouse/pull/37047) ([tavplubix](https://github.com/tavplubix)).
* Экспериментальная возможность: исправлена работа упорядоченного `GROUP BY` (`optimize_aggregation_in_order=1`) при использовании агрегатных функций семейства `*Array` (`groupArrayArray`/...). [#37046](https://github.com/ClickHouse/ClickHouse/pull/37046) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен некорректный результат преобразования LowCardinality-&gt;ArrowDictionary, когда тип индексов отличается от UInt8. Закрывает [#36832](https://github.com/ClickHouse/ClickHouse/issues/36832). [#37043](https://github.com/ClickHouse/ClickHouse/pull/37043) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена проблема со значениями inf в `quantileTDigest`. Исправляет [#32107](https://github.com/ClickHouse/ClickHouse/issues/32107). [#37021](https://github.com/ClickHouse/ClickHouse/pull/37021) ([Vladimir Chebotarev](https://github.com/excitoon)).
* Исправлена отправка данных внешних таблиц в HedgedConnections при значении max&#95;parallel&#95;replicas, отличном от 1. [#36981](https://github.com/ClickHouse/ClickHouse/pull/36981) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена логическая ошибка в запросе `TRUNCATE` в базе данных `Replicated`. Исправление для [#33747](https://github.com/ClickHouse/ClickHouse/issues/33747). [#36976](https://github.com/ClickHouse/ClickHouse/pull/36976) ([tavplubix](https://github.com/tavplubix)).
* Экспериментальная функция: устранено зависание при удалении исходной таблицы в `WindowView`. Закрывает [#35678](https://github.com/ClickHouse/ClickHouse/issues/35678). [#36967](https://github.com/ClickHouse/ClickHouse/pull/36967) ([vxider](https://github.com/Vxider)).
* Экспериментальная возможность (кэш RocksDB): исправлена ошибка: [#36671](https://github.com/ClickHouse/ClickHouse/issues/36671). [#36929](https://github.com/ClickHouse/ClickHouse/pull/36929) ([李扬](https://github.com/taiyang-li)).
* Экспериментальная функция: исправлены ошибки при использовании нескольких столбцов в WindowView путём добавления конвертирующих действий, что позволяет вызывать `writeIntoWindowView` со слегка отличающейся схемой. [#36928](https://github.com/ClickHouse/ClickHouse/pull/36928) ([vxider](https://github.com/Vxider)).
* Исправлена ошибка в clickhouse-keeper, которая могла приводить к повреждению сжатых файлов журнала при низкой нагрузке и перезапусках. [#36910](https://github.com/ClickHouse/ClickHouse/pull/36910) ([alesapin](https://github.com/alesapin)).
* Исправлен некорректный результат запроса при агрегировании констант, что исправляет [#36728](https://github.com/ClickHouse/ClickHouse/issues/36728). [#36888](https://github.com/ClickHouse/ClickHouse/pull/36888) ([Amos Bird](https://github.com/amosbird)).
* Экспериментальная возможность: исправлен подсчёт `current_size` в кэше. [#36887](https://github.com/ClickHouse/ClickHouse/pull/36887) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Экспериментальная возможность: исправлено срабатывание window view при использовании hop window [#34044](https://github.com/ClickHouse/ClickHouse/issues/34044). [#36861](https://github.com/ClickHouse/ClickHouse/pull/36861) ([vxider](https://github.com/Vxider)).
* Экспериментальная возможность: исправлено некорректное приведение типа в кэшированном буфере удалённой файловой системы. [#36809](https://github.com/ClickHouse/ClickHouse/pull/36809) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проблема с созданием таблиц с `flatten_nested = 0`. Ранее неразвёрнутые столбцы типа `Nested` могли быть развёрнуты в плоский вид после перезапуска сервера. [#36803](https://github.com/ClickHouse/ClickHouse/pull/36803) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены некоторые проблемы с асинхронным чтением из удалённой файловой системы, возникавшие при чтении данных типа LowCardinality. [#36763](https://github.com/ClickHouse/ClickHouse/pull/36763) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Экспериментальная возможность: исправлена вставка в столбцы типа `Object` из нескольких файлов, например через табличную функцию `file` с использованием glob-шаблонов. [#36762](https://github.com/ClickHouse/ClickHouse/pull/36762) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлены тайм-ауты в запросах с подстраховкой (hedged requests). Зависание соединения сразу после отправки удалённого запроса могло приводить к бесконечному ожиданию. [#36749](https://github.com/ClickHouse/ClickHouse/pull/36749) ([Kruglov Pavel](https://github.com/Avogar)).
* Экспериментальная возможность: исправлена ошибка в `groupBitmapAndState`/`groupBitmapOrState`/`groupBitmapXorState` для распределённых таблиц. [#36739](https://github.com/ClickHouse/ClickHouse/pull/36739) ([Zhang Yifan](https://github.com/zhangyifan27)).
* Экспериментальная функциональность: Во время [теста](https://s3.amazonaws.com/clickhouse-test-reports/36376/1cb1c7275cb53769ab826772db9b71361bb3e413/stress_test__thread__actions_/clickhouse-server.clean.log) в [PR](https://github.com/ClickHouse/ClickHouse/pull/36376) я обнаружил, что один класс кэша был инициализирован дважды, что приводило к возникновению исключения. Хотя причина этой проблемы пока неясна, в ClickHouse, по-видимому, есть логика, при которой диск загружается повторно, поэтому для этой ситуации нам нужна специальная обработка. [#36737](https://github.com/ClickHouse/ClickHouse/pull/36737) ([Han Shukai](https://github.com/KinderRiven)).
* Исправлены вертикальные слияния в широких частях. Ранее во время слияния мог выбрасываться эксепшн `There is no column`. [#36707](https://github.com/ClickHouse/ClickHouse/pull/36707) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена перезагрузка сервера при изменении порта (теперь не дожидается завершения текущих соединений из контекста запроса). [#36700](https://github.com/ClickHouse/ClickHouse/pull/36700) ([Azat Khuzhin](https://github.com/azat)).
* Экспериментальная возможность: в предыдущем [PR](https://github.com/ClickHouse/ClickHouse/pull/36376) я обнаружил, что тестирование (stateless tests, flaky check (address, actions)) завершается по таймауту. Более того, запуск тестов локально также может приводить к нестабильным взаимным блокировкам системы. Эта проблема по-прежнему воспроизводится при использовании актуального исходного кода ветки master. [#36697](https://github.com/ClickHouse/ClickHouse/pull/36697) ([Han Shukai](https://github.com/KinderRiven)).
* Экспериментальная возможность: устранена проблема перезапуска сервера при изменении конфигурации кэша. [#36685](https://github.com/ClickHouse/ClickHouse/pull/36685) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена потенциальная ошибка heap-use-after-free при определении схемы. Закрывает [#36661](https://github.com/ClickHouse/ClickHouse/issues/36661). [#36679](https://github.com/ClickHouse/ClickHouse/pull/36679) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен разбор настроек в запросе `CREATE`, когда движок не указан. Исправляет [https://github.com/ClickHouse/ClickHouse/pull/34187#issuecomment-1103812419](https://github.com/ClickHouse/ClickHouse/pull/34187#issuecomment-1103812419). [#36642](https://github.com/ClickHouse/ClickHouse/pull/36642) ([tavplubix](https://github.com/tavplubix)).
* Экспериментальная возможность: исправлены слияния широких частей с типом `Object`. [#36637](https://github.com/ClickHouse/ClickHouse/pull/36637) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен сбой форматирования, возникавший, когда за EPHEMERAL следовало выражение по умолчанию, не являющееся литералом. Закрывает [#36618](https://github.com/ClickHouse/ClickHouse/issues/36618). [#36633](https://github.com/ClickHouse/ClickHouse/pull/36633) ([flynn](https://github.com/ucasfl)).
* Исправлено исключение `Missing column`, которое могло возникать при использовании `INTERPOLATE` с таблицей `ENGINE = MergeTree`. [#36549](https://github.com/ClickHouse/ClickHouse/pull/36549) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Исправлена потенциальная ошибка обработки литералов в `WHERE` для запросов с JOIN. Закрывает [#36279](https://github.com/ClickHouse/ClickHouse/issues/36279). [#36542](https://github.com/ClickHouse/ClickHouse/pull/36542) ([Vladimir C](https://github.com/vdimir)).
* Исправлено обновление смещения в ReadBufferFromEncryptedFile, которое могло приводить к неопределённому поведению. [#36493](https://github.com/ClickHouse/ClickHouse/pull/36493) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлены проверки корректности имён хостов в конфигурации кластера Keeper. Добавлена настройка `keeper_server.host_checks_enabled` для включения и отключения этих проверок. [#36492](https://github.com/ClickHouse/ClickHouse/pull/36492) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлено использование исполняемых пользовательских функций в GROUP BY. Ранее исполняемые пользовательские функции нельзя было использовать в качестве выражений в GROUP BY. Закрывает [#36448](https://github.com/ClickHouse/ClickHouse/issues/36448). [#36486](https://github.com/ClickHouse/ClickHouse/pull/36486) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлено возможное исключение в клиенте при получении неизвестного пакета от сервера. [#36481](https://github.com/ClickHouse/ClickHouse/pull/36481) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Экспериментальная возможность (пожалуйста, никогда не используйте таблицу `system.session_log`, она будет удалена): добавлены отсутствующие значения перечисления в таблицу system.session&#95;log. Закрывает [#36474](https://github.com/ClickHouse/ClickHouse/issues/36474). [#36480](https://github.com/ClickHouse/ClickHouse/pull/36480) ([Memo](https://github.com/Joeywzr)).
* Исправлена ошибка в определении схемы для s3Cluster, которая приводила к тому, что при выполнении запроса SELECT к s3Cluster читались не все данные. Ошибка появилась в [https://github.com/ClickHouse/ClickHouse/pull/35544](https://github.com/ClickHouse/ClickHouse/pull/35544). [#36434](https://github.com/ClickHouse/ClickHouse/pull/36434) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено разыменование `nullptr` в обработчике JOIN и COLUMNS. Это исправляет [#36416](https://github.com/ClickHouse/ClickHouse/issues/36416). Изменения относятся к [https://github.com/ClickHouse/ClickHouse/pull/36417](https://github.com/ClickHouse/ClickHouse/pull/36417). [#36430](https://github.com/ClickHouse/ClickHouse/pull/36430) ([Amos Bird](https://github.com/amosbird)).
* Исправлена проблема с повторной загрузкой словаря для `ClickHouseDictionarySource`, если он содержит скалярные подзапросы. [#36390](https://github.com/ClickHouse/ClickHouse/pull/36390) ([lthaooo](https://github.com/lthaooo)).
* Исправлена проверка assert в JOIN, закрыта задача [#36199](https://github.com/ClickHouse/ClickHouse/issues/36199). [#36201](https://github.com/ClickHouse/ClickHouse/pull/36201) ([Vladimir C](https://github.com/vdimir)).
* Запросы с псевдонимами внутри специальных операторов приводили к ошибке при разборе (поведение было нарушено в 22.1). Пример: `SELECT substring('test' AS t, 1, 1)`. [#36167](https://github.com/ClickHouse/ClickHouse/pull/36167) ([Maksim Kita](https://github.com/kitaisreal)).
* Экспериментальная возможность: исправлена вставка сложных JSON-объектов с вложенными массивами в столбцы типа `Object`. [#36077](https://github.com/ClickHouse/ClickHouse/pull/36077) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена работа `ALTER DROP COLUMN` для вложенного столбца с компактными частями (то есть `ALTER TABLE x DROP COLUMN n`, когда существует столбец `n.d`). [#35797](https://github.com/ClickHouse/ClickHouse/pull/35797) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка диапазона аргумента length функции substring, возникавшая, когда `offset` и `length` являются отрицательными константами, а `s` — неконстантным. [#33861](https://github.com/ClickHouse/ClickHouse/pull/33861) ([RogerYK](https://github.com/RogerYK)).

### <a id="224"></a> Релиз ClickHouse 22.4, 2022-04-19 {#a-id224a-clickhouse-release-224-2022-04-19}

#### Обратно несовместимые изменения {#backward-incompatible-change-5}

- Запрещено использование SETTINGS после FORMAT в запросах INSERT (для принятия таких запросов существует настройка совместимости `allow_settings_after_format_in_insert`, но по умолчанию она выключена). [#35883](https://github.com/ClickHouse/ClickHouse/pull/35883) ([Azat Khuzhin](https://github.com/azat)).
- Функция `yandexConsistentHash` (алгоритм консистентного хеширования Константина «kostik» Облакова) переименована в `kostikConsistentHash`. Старое имя оставлено в качестве псевдонима для обеспечения совместимости. Хотя это изменение обратно совместимо, псевдоним может быть удален в последующих релизах, поэтому рекомендуется обновить использование этой функции в ваших приложениях. [#35553](https://github.com/ClickHouse/ClickHouse/pull/35553) ([Alexey Milovidov](https://github.com/alexey-milovidov)).

#### Новая функциональность {#new-feature-8}


* Добавлено расширение INTERPOLATE для ORDER BY ... WITH FILL. Закрывает [#34903](https://github.com/ClickHouse/ClickHouse/issues/34903). [#35349](https://github.com/ClickHouse/ClickHouse/pull/35349) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Профилирование на уровне процессоров (при включённой настройке `log_processors_profiles` ClickHouse будет записывать время, которое процессор провёл на выполнение или ожидание данных, в таблицу `system.processors_profile_log`). [#34355](https://github.com/ClickHouse/ClickHouse/pull/34355) ([Azat Khuzhin](https://github.com/azat)).
* Добавлены функции makeDate(year, month, day), makeDate32(year, month, day). [#35628](https://github.com/ClickHouse/ClickHouse/pull/35628) ([Alexander Gololobov](https://github.com/davenger)). Реализованы функции makeDateTime() и makeDateTIme64(). [#35934](https://github.com/ClickHouse/ClickHouse/pull/35934) ([Alexander Gololobov](https://github.com/davenger)).
* Добавлена поддержка нового типа квоты `WRITTEN BYTES`, ограничивающего объём записанных байт в запросах INSERT. [#35736](https://github.com/ClickHouse/ClickHouse/pull/35736) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена функция `flattenTuple`. Она принимает вложенный именованный `Tuple` в качестве аргумента и возвращает «уплощённый» `Tuple`, элементы которого соответствуют путям в исходном `Tuple`. Например: `Tuple(a Int, Tuple(b Int, c Int)) -> Tuple(a Int, b Int, c Int)`. `flattenTuple` можно использовать для выбора всех путей из типа `Object` в виде отдельных столбцов. [#35690](https://github.com/ClickHouse/ClickHouse/pull/35690) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлены функции `arrayFirstOrNull`, `arrayLastOrNull`. Закрыта задача [#35238](https://github.com/ClickHouse/ClickHouse/issues/35238). [#35414](https://github.com/ClickHouse/ClickHouse/pull/35414) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлены функции `minSampleSizeContinous` и `minSampleSizeConversion`. Автор [achimbab](https://github.com/achimbab). [#35360](https://github.com/ClickHouse/ClickHouse/pull/35360) ([Maksim Kita](https://github.com/kitaisreal)).
* Новые функции minSampleSizeContinous и minSampleSizeConversion. [#34354](https://github.com/ClickHouse/ClickHouse/pull/34354) ([achimbab](https://github.com/achimbab)).
* Добавлен формат `ProtobufList` (все записи как повторяющиеся сообщения в формате Protobuf). Закрывает [#16436](https://github.com/ClickHouse/ClickHouse/issues/16436). [#35152](https://github.com/ClickHouse/ClickHouse/pull/35152) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлены функции `h3PointDistM`, `h3PointDistKm`, `h3PointDistRads`, `h3GetRes0Indexes`, `h3GetPentagonIndexes`. [#34568](https://github.com/ClickHouse/ClickHouse/pull/34568) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлена функция `toLastDayOfMonth`, которая округляет дату или дату со временем до последнего дня месяца. [#33501](https://github.com/ClickHouse/ClickHouse/issues/33501). [#34394](https://github.com/ClickHouse/ClickHouse/pull/34394) ([Habibullah Oladepo](https://github.com/holadepo)).
* Добавлен параметр балансировки нагрузки для клиента [Zoo]Keeper. Закрывает [#29617](https://github.com/ClickHouse/ClickHouse/issues/29617). [#30325](https://github.com/ClickHouse/ClickHouse/pull/30325) ([小路](https://github.com/nicelulu)).
* Добавлен новый тип политик строк `simple`. До этого PR существовало два типа политик строк: `permissive` и `restrictive`. Политика строк типа `simple` добавляет новый фильтр для таблицы без каких-либо побочных эффектов, в отличие от политик `permissive` и `restrictive`. [#35345](https://github.com/ClickHouse/ClickHouse/pull/35345) ([Vitaly Baranov](https://github.com/vitlibar)).
* Добавлена возможность указывать секрет кластера в реплицируемой базе данных. [#35333](https://github.com/ClickHouse/ClickHouse/pull/35333) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлены дополнительные проверки при запуске сервера (объём доступной памяти и дискового пространства, максимальное число потоков и т. д.). [#34566](https://github.com/ClickHouse/ClickHouse/pull/34566) ([Sergei Trifonov](https://github.com/serxa)).
* Улучшен тип INTERVAL — теперь его можно использовать с `[MILLI|MICRO|NANO]SECOND`. Добавлены функции `toStartOf[Milli|Micro|Nano]second()`. Добавлены функции `[add|subtract][Milli|Micro|Nano]seconds()`. [#34353](https://github.com/ClickHouse/ClickHouse/pull/34353) ([Andrey Zvonov](https://github.com/zvonand)).

#### Экспериментальная функциональность {#experimental-feature-7}

- Добавлена поддержка транзакций для простых таблиц `MergeTree`. Эта функциональность является экспериментальной и не рекомендуется для использования в production-окружении. Часть [#22086](https://github.com/ClickHouse/ClickHouse/issues/22086). [#24258](https://github.com/ClickHouse/ClickHouse/pull/24258) ([tavplubix](https://github.com/tavplubix)).
- Поддержка автоматического определения схемы для типа `Object` в формате `JSONEachRow`. Разрешено преобразование столбцов типа `Map` в столбцы типа `Object`. [#35629](https://github.com/ClickHouse/ClickHouse/pull/35629) ([Anton Popov](https://github.com/CurtizJ)).
- Разрешена запись кеша удаленной файловой системы при всех операциях записи. Добавлена таблица `system.remote_filesystem_cache`. Добавлен запрос `drop remote filesystem cache`. Добавлена интроспекция метаданных S3 с помощью таблицы `system.remote_data_paths`. Закрывает [#34021](https://github.com/ClickHouse/ClickHouse/issues/34021). Добавлена опция кеширования для слияний путем добавления режима `read_from_filesystem_cache_if_exists_otherwise_bypass_cache` (включен по умолчанию для слияний и также может быть включен настройкой запроса с тем же именем). Переименованы настройки, связанные с кешем (`remote_fs_enable_cache -> enable_filesystem_cache` и т. д.). [#35475](https://github.com/ClickHouse/ClickHouse/pull/35475) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Опция для хранения метаданных частей в RocksDB. Ускорение процесса загрузки частей MergeTree для ускорения запуска clickhouse-server. С этим улучшением clickhouse-server смог сократить время запуска с 75 минут до 20 секунд при наличии 700 тысяч частей MergeTree. [#32928](https://github.com/ClickHouse/ClickHouse/pull/32928) ([李扬](https://github.com/taiyang-li)).

#### Улучшение производительности {#performance-improvement-8}


- Новая оптимизация плана запроса. Вычисление функций после `ORDER BY`, когда это возможно. Например, для запроса `SELECT sipHash64(number) FROM numbers(1e8) ORDER BY number LIMIT 5` функция `sipHash64` будет вычислена после `ORDER BY` и `LIMIT`, что даёт ускорение примерно в 20 раз. [#35623](https://github.com/ClickHouse/ClickHouse/pull/35623) ([Nikita Taranov](https://github.com/nickitat)).
- Размеры хеш-таблиц, используемых при агрегации, теперь собираются и используются в последующих запросах для предотвращения изменения размера хеш-таблиц. [#33439](https://github.com/ClickHouse/ClickHouse/pull/33439) ([Nikita Taranov](https://github.com/nickitat)).
- Улучшение функции hasAll с использованием инструкций SIMD (SSE и AVX2). [#27653](https://github.com/ClickHouse/ClickHouse/pull/27653) ([youennL-cs](https://github.com/youennL-cs)). [#35723](https://github.com/ClickHouse/ClickHouse/pull/35723) ([Maksim Kita](https://github.com/kitaisreal)).
- Множественные изменения для улучшения производительности ASOF JOIN (в 1,2–1,6 раза быстрее). Также добавлена поддержка больших целых чисел. [#34733](https://github.com/ClickHouse/ClickHouse/pull/34733) ([Raúl Marín](https://github.com/Algunenano)).
- Улучшение производительности ASOF JOIN, если ключ является нативным целым числом. [#35525](https://github.com/ClickHouse/ClickHouse/pull/35525) ([Maksim Kita](https://github.com/kitaisreal)).
- Распараллеливание многочастной загрузки в хранилище S3. [#35343](https://github.com/ClickHouse/ClickHouse/pull/35343) ([Sergei Trifonov](https://github.com/serxa)).
- Движок хранения URL теперь загружает несколько фрагментов параллельно, если конечная точка поддерживает HTTP Range. Добавлены две дополнительные настройки: `max_download_threads` и `max_download_buffer_size`, которые управляют максимальным количеством потоков, которые может использовать один запрос для загрузки файла, и максимальным количеством байтов, которые может обработать каждый поток. [#35150](https://github.com/ClickHouse/ClickHouse/pull/35150) ([Antonio Andelic](https://github.com/antonio2368)).
- Использование нескольких потоков для загрузки объектов из S3. Загрузка управляется с помощью настроек `max_download_threads` и `max_download_buffer_size`. [#35571](https://github.com/ClickHouse/ClickHouse/pull/35571) ([Antonio Andelic](https://github.com/antonio2368)).
- Сужение области действия мьютекса при взаимодействии с HDFS. Связано с [#35292](https://github.com/ClickHouse/ClickHouse/issues/35292). [#35646](https://github.com/ClickHouse/ClickHouse/pull/35646) ([shuchaome](https://github.com/shuchaome)).
- Требование мутаций для TTL отдельных таблиц только при его изменении. [#35953](https://github.com/ClickHouse/ClickHouse/pull/35953) ([Azat Khuzhin](https://github.com/azat)).

#### Улучшения {#improvement-8}


* Многочисленные улучшения механизма вывода схемы. Используются дополнительные приёмы и эвристики для определения чисел, строк, массивов, кортежей и отображений (Map) в форматах данных CSV, TSV и TSVRaw. Добавлена настройка `input_format_csv_use_best_effort_in_schema_inference` для формата CSV, которая включает/выключает использование этих эвристик; если она выключена, все значения рассматриваются как строки. Добавлена аналогичная настройка `input_format_tsv_use_best_effort_in_schema_inference` для форматов TSV/TSVRaw. По умолчанию эти настройки включены. - Добавлена поддержка Map для вывода схемы в формате Values. - Исправлена возможная ошибка сегментации (segfault) при выводе схемы в формате Values. - Разрешено пропускать столбцы с неподдерживаемыми типами в форматах Arrow/ORC/Parquet. Для этого добавлены соответствующие настройки: `input_format_{parquet|orc|arrow}_skip_columns_with_unsupported_types_in_schema_inference`. По умолчанию эти настройки выключены. - Разрешено преобразовывать столбец типа Null в Nullable-столбец со всеми значениями NULL в форматах Arrow/Parquet. - Разрешено указывать имена столбцов при выводе схемы через настройку `column_names_for_schema_inference` для форматов, которые не содержат имена столбцов (таких как CSV, TSV, JSONCompactEachRow и т. д.). - Исправлен вывод схемы в форматах ORC/Arrow/Parquet в части работы с Nullable-столбцами. Ранее все выводимые типы были не Nullable, что блокировало чтение Nullable-столбцов из данных; теперь это исправлено, и все выводимые типы всегда Nullable (так как по схеме мы не можем понять, является столбец Nullable или нет). - Исправлен вывод схемы в формате Template с правилами экранирования CSV. [#35582](https://github.com/ClickHouse/ClickHouse/pull/35582) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлены параллельный парсинг и автоматическое определение схемы для формата `JSONAsObject`. [#35592](https://github.com/ClickHouse/ClickHouse/pull/35592) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена поддержка автоматического определения схемы в табличной функции `s3Cluster`. Сигнатуры `s3 ` и `s3Cluster` синхронизированы. [#35544](https://github.com/ClickHouse/ClickHouse/pull/35544) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлена поддержка автоматического определения схемы для `hdfsCluster`. [#35602](https://github.com/ClickHouse/ClickHouse/pull/35602) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Добавлена новая настройка `input_format_json_read_bools_as_numbers`, которая позволяет распознавать и разбирать булевы значения как числа во входных форматах JSON. По умолчанию она включена. Предложено @alexey-milovidov. [#35735](https://github.com/ClickHouse/ClickHouse/pull/35735) ([Kruglov Pavel](https://github.com/Avogar)).
* Улучшен порядок столбцов при автоматическом определении схемы для форматов TSKV и JSONEachRow, что закрывает [#35640](https://github.com/ClickHouse/ClickHouse/issues/35640). Автоматическое определение схемы больше не прекращается при чтении пустой строки для форматов TSKV и JSONEachRow. [#35724](https://github.com/ClickHouse/ClickHouse/pull/35724) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлены настройки `input_format_orc_case_insensitive_column_matching`, `input_format_arrow_case_insensitive_column_matching` и `input_format_parquet_case_insensitive_column_matching`, которые позволяют ClickHouse использовать регистронезависимое сопоставление столбцов при чтении данных из файлов форматов ORC, Arrow или Parquet. [#35459](https://github.com/ClickHouse/ClickHouse/pull/35459) ([Antonio Andelic](https://github.com/antonio2368)).
* В таблицу `system.query_log` добавлен столбец `is_secure`, который показывает, использует ли клиент защищённое соединение через TCP или HTTP. [#35705](https://github.com/ClickHouse/ClickHouse/pull/35705) ([Antonio Andelic](https://github.com/antonio2368)).
* Теперь `kafka_num_consumers` может быть больше количества физических ядер на малоресурсной машине (с менее чем 16 ядрами). [#35926](https://github.com/ClickHouse/ClickHouse/pull/35926) ([alesapin](https://github.com/alesapin)).
* Добавлены базовые метрики для мониторинга таблиц с движком Kafka (ENGINE=Kafka). [#35916](https://github.com/ClickHouse/ClickHouse/pull/35916) ([filimonov](https://github.com/filimonov)).
* Теперь для движков семейства MergeTree нельзя выполнять `ALTER TABLE ... RESET SETTING` для несуществующих настроек. Исправлена [#35816](https://github.com/ClickHouse/ClickHouse/issues/35816). [#35884](https://github.com/ClickHouse/ClickHouse/pull/35884) ([alesapin](https://github.com/alesapin)).
* Теперь некоторые запросы `ALTER MODIFY COLUMN` для типов `Array` и `Nullable` могут выполняться на уровне метаданных без мутаций. Например, можно изменить `Array(Enum8('Option1'=1))` на `Array(Enum8('Option1'=1, 'Option2'=2))`. [#35882](https://github.com/ClickHouse/ClickHouse/pull/35882) ([alesapin](https://github.com/alesapin)).
* Добавлена анимация значка песочных часов, указывающая пользователю, что запрос выполняется. [#35860](https://github.com/ClickHouse/ClickHouse/pull/35860) ([peledni](https://github.com/peledni)).
* Добавлена поддержка операции ALTER TABLE t DETACH PARTITION (ALL). [#35794](https://github.com/ClickHouse/ClickHouse/pull/35794) ([awakeljw](https://github.com/awakeljw)).
* Улучшен анализ проекций для оптимизации простых запросов, таких как `count()`. [#35788](https://github.com/ClickHouse/ClickHouse/pull/35788) ([Amos Bird](https://github.com/amosbird)).
* Поддержка автоматического определения схемы для `INSERT SELECT` с использованием табличной функции `input`. Получать схему из целевой таблицы вставки вместо вывода её из данных в случае `INSERT SELECT` из табличных функций, поддерживающих автоматическое определение схемы. Закрывает [#35639](https://github.com/ClickHouse/ClickHouse/issues/35639). [#35760](https://github.com/ClickHouse/ClickHouse/pull/35760) ([Kruglov Pavel](https://github.com/Avogar)).
* Учитывать настройку `remote_url_allow_hosts` для таблиц Hive. [#35743](https://github.com/ClickHouse/ClickHouse/pull/35743) ([李扬](https://github.com/taiyang-li)).
* Реализована поддержка `send_logs_level` в clickhouse-local. Закрывает [#35653](https://github.com/ClickHouse/ClickHouse/issues/35653). [#35716](https://github.com/ClickHouse/ClickHouse/pull/35716) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Закрывает [#35641](https://github.com/ClickHouse/ClickHouse/issues/35641); позволяет использовать столбцы `EPHEMERAL` без явного выражения значения по умолчанию. [#35706](https://github.com/ClickHouse/ClickHouse/pull/35706) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Добавлен счетчик профиля `AsyncInsertBytes` для учета размера асинхронных операций INSERT. [#35644](https://github.com/ClickHouse/ClickHouse/pull/35644) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Улучшено описание конвейера обработки JOIN. [#35612](https://github.com/ClickHouse/ClickHouse/pull/35612) ([何李夫](https://github.com/helifu)).
* Определять абсолютный путь к конфигурации HDFS. [#35572](https://github.com/ClickHouse/ClickHouse/pull/35572) ([李扬](https://github.com/taiyang-li)).
* Улучшена производительность вставки из буфера обмена и совместимость clickhouse-client. Это решает проблему [#35501](https://github.com/ClickHouse/ClickHouse/issues/35501). [#35541](https://github.com/ClickHouse/ClickHouse/pull/35541) ([Amos Bird](https://github.com/amosbird)).
* В распределённых запросах могло происходить переполнение стека, если при разборе очень глубоко вложенного типа данных была включена одна из настроек `async_socket_for_remote` или `use_hedged_requests` (по крайней мере в debug-сборке). Закрывает [#35509](https://github.com/ClickHouse/ClickHouse/issues/35509). [#35524](https://github.com/ClickHouse/ClickHouse/pull/35524) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлены размеры подколонок в таблицу `system.parts_columns`. [#35488](https://github.com/ClickHouse/ClickHouse/pull/35488) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена явная информация о таблице в узлы сканирования плана запроса и конвейера. [#35460](https://github.com/ClickHouse/ClickHouse/pull/35460) ([何李夫](https://github.com/helifu)).
* Разрешить серверу привязываться к низкономерным портам (например, 443). Скрипт установки ClickHouse назначит capability `cap_net_bind_service` бинарному файлу. [#35451](https://github.com/ClickHouse/ClickHouse/pull/35451) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Исправлена проблема с INSERT INTO table FROM INFILE: не отображалась полоса прогресса. [#35429](https://github.com/ClickHouse/ClickHouse/pull/35429) ([xiedeyantu](https://github.com/xiedeyantu)).
* Добавлены аргументы `--user`, `--password`, `--host`, `--port` для инструмента `clickhouse-diagnostics`. [#35422](https://github.com/ClickHouse/ClickHouse/pull/35422) ([李扬](https://github.com/taiyang-li)).
* Поддержка UUID для движков Postgres. Закрывает [#35384](https://github.com/ClickHouse/ClickHouse/issues/35384). [#35403](https://github.com/ClickHouse/ClickHouse/pull/35403) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Для табличных функций `s3cluster`, `HDFSCluster` и `hive` не удаётся корректно получить `AccessType` с помощью `StorageFactory::instance().getSourceAccessType(getStorageTypeName())`. В этом PR это исправлено. [#35365](https://github.com/ClickHouse/ClickHouse/pull/35365) ([李扬](https://github.com/taiyang-li)).
* Удалён параметр `--testmode` для clickhouse-client, тестовый режим теперь включён по умолчанию. [#35354](https://github.com/ClickHouse/ClickHouse/pull/35354) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Запрещена операция `wchc` (четырёхбуквенная команда) для clickhouse-keeper. [#35320](https://github.com/ClickHouse/ClickHouse/pull/35320) ([zhangyuli1](https://github.com/zhangyuli1)).
* Добавлена функция `getTypeSerializationStreams`. Для заданного типа (определяемого по столбцу) она возвращает массив со всеми путями подпотоков сериализации. Эта функция в основном полезна для разработчиков. [#35290](https://github.com/ClickHouse/ClickHouse/pull/35290) ([李扬](https://github.com/taiyang-li)).
* Если `port` не указан в конфигурации кластера, будет использован порт сервера по умолчанию. Тем самым закрывается задача [#34769](https://github.com/ClickHouse/ClickHouse/issues/34769). [#34772](https://github.com/ClickHouse/ClickHouse/pull/34772) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Использовать индекс `minmax` для файлов ORC/Parquet в Hive Engine. Связанный PR: [https://github.com/ClickHouse/arrow/pull/10](https://github.com/ClickHouse/arrow/pull/10). [#34631](https://github.com/ClickHouse/ClickHouse/pull/34631) ([李扬](https://github.com/taiyang-li)).
* В таблицах системного лога теперь можно указывать COMMENT в объявлении ENGINE. Закрывает [#33768](https://github.com/ClickHouse/ClickHouse/issues/33768). [#34536](https://github.com/ClickHouse/ClickHouse/pull/34536) ([Maksim Kita](https://github.com/kitaisreal)).
* Корректная обработка настройки `max_rows_to_read` при чтении в порядке ключа сортировки и заданном `LIMIT`. Ранее исключение `Limit for rows or bytes to read exceeded` могло выбрасываться, даже если для выполнения запроса фактически требовалось прочитать меньше строк. [#33230](https://github.com/ClickHouse/ClickHouse/pull/33230) ([Anton Popov](https://github.com/CurtizJ)).
* Учитывать только квоту и период из cgroups, игнорировать shares (которые фактически не ограничивают количество ядер, которые можно использовать). [#35815](https://github.com/ClickHouse/ClickHouse/pull/35815) ([filimonov](https://github.com/filimonov)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-8}

- Добавлена следующая партия настроек рандомизации в функциональных тестах. [#35047](https://github.com/ClickHouse/ClickHouse/pull/35047) ([Kruglov Pavel](https://github.com/Avogar)).
- Добавлена проверка обратной совместимости в стресс-тесте. Закрывает [#25088](https://github.com/ClickHouse/ClickHouse/issues/25088). [#27928](https://github.com/ClickHouse/ClickHouse/pull/27928) ([Kruglov Pavel](https://github.com/Avogar)).
- Миграция сборки пакетов на `nfpm` - Скрипт `release` объявлен устаревшим в пользу `packages/build` - Сборка всех компонентов в образе clickhouse/binary-builder (очистка: clickhouse/deb-builder) - Добавлено удаление символов в cmake (todo: использовать $prefix/lib/$bin_dir/clickhouse/$binary.debug) - Исправлена проблема с символами DWARF - Добавлены пакеты Alpine APK - Переименование `alien` в `additional_pkgs`. [#33664](https://github.com/ClickHouse/ClickHouse/pull/33664) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Добавлено ночное сканирование и загрузка для Coverity. [#34895](https://github.com/ClickHouse/ClickHouse/pull/34895) ([Boris Kuschel](https://github.com/bkuschel)).
- Выделенный компактный пакет для `clickhouse-keeper`. [#35308](https://github.com/ClickHouse/ClickHouse/pull/35308) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Запуск с podman завершался ошибкой: выдавалась жалоба на двойное указание одного и того же тома. [#35978](https://github.com/ClickHouse/ClickHouse/pull/35978) ([Roman Nikonov](https://github.com/nic11)).
- Незначительное улучшение в конфигурации сборки contrib/krb5. [#35832](https://github.com/ClickHouse/ClickHouse/pull/35832) ([Anton Kozlov](https://github.com/tonickkozlov)).
- Добавлена метка для идентификации задачи сборки для каждого образа. [#35583](https://github.com/ClickHouse/ClickHouse/pull/35583) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Применен форматтер `black` к коду Python и добавлена проверка для каждого коммита. [#35466](https://github.com/ClickHouse/ClickHouse/pull/35466) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Переработан образ alpine для использования чистого Dockerfile. Создан скрипт в tests/ci для сборки образов ubuntu и alpine. Добавлен образ clickhouse-keeper (cc @nikitamikhaylov). Добавлена проверка сборки в PullRequestCI. Добавлена задача в ReleaseCI. Добавлена задача в MasterCI для сборки и отправки образов `clickhouse/clickhouse-server:head` и `clickhouse/clickhouse-keeper:head` для каждого объединенного PR. [#35211](https://github.com/ClickHouse/ClickHouse/pull/35211) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Исправлен отчет стресс-теста в CI, теперь журнал выполнения с информацией о запущенных стресс-тестах загружается только один раз. [#35093](https://github.com/ClickHouse/ClickHouse/pull/35093) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Переход на libcxx / libcxxabi из LLVM 14. [#34906](https://github.com/ClickHouse/ClickHouse/pull/34906) ([Raúl Marín](https://github.com/Algunenano)).
- Обновление unixodbc для устранения CVE-2018-7485. Примечание: данная уязвимость CVE не актуальна для ClickHouse, поскольку он реализует собственный уровень изоляции для ODBC. [#35943](https://github.com/ClickHouse/ClickHouse/pull/35943) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).

#### Исправление ошибок {#bug-fix-4}


* Добавлены настройки `input_format_ipv4_default_on_conversion_error`, `input_format_ipv6_default_on_conversion_error`, позволяющие при ошибке преобразования вставлять некорректные значения IP-адресов в таблицы как значения по умолчанию. Закрывает [#35726](https://github.com/ClickHouse/ClickHouse/issues/35726). [#35733](https://github.com/ClickHouse/ClickHouse/pull/35733) ([Maksim Kita](https://github.com/kitaisreal)).
* Не удаляйте столбцы из блока, если их не существует при чтении данных из Hive. [#35393](https://github.com/ClickHouse/ClickHouse/pull/35393) ([lgbo](https://github.com/lgbo-ustc)).
* Добавлена проверка типов при создании материализованного представления. Закрыто: [#23684](https://github.com/ClickHouse/ClickHouse/issues/23684). [#24896](https://github.com/ClickHouse/ClickHouse/pull/24896) ([hexiaoting](https://github.com/hexiaoting)).
* Исправлено форматирование запросов INSERT INFILE (добавлены отсутствовавшие кавычки). [#35886](https://github.com/ClickHouse/ClickHouse/pull/35886) ([Azat Khuzhin](https://github.com/azat)).
* Отключен `session_log` из-за обнаруженной с помощью фаззинга проблемы безопасности при работе с памятью. См. [#35714](https://github.com/ClickHouse/ClickHouse/issues/35714). [#35873](https://github.com/ClickHouse/ClickHouse/pull/35873) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Предотвращена повторная обработка TTL для отдельных столбцов. [#35820](https://github.com/ClickHouse/ClickHouse/pull/35820) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены вставки в столбцы типа `Object` в случае, когда в запросе INSERT содержатся данные, относящиеся к нескольким партициям. [#35806](https://github.com/ClickHouse/ClickHouse/pull/35806) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка в индексах столбцов, отсутствующих в данных, в форматах -WithNames, из‑за которой возникала ошибка `INCORRECT_NUMBER_OF_COLUMNS` при числе столбцов более 256. Закрывает [#35793](https://github.com/ClickHouse/ClickHouse/issues/35793). [#35803](https://github.com/ClickHouse/ClickHouse/pull/35803) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено [#35751](https://github.com/ClickHouse/ClickHouse/issues/35751). [#35799](https://github.com/ClickHouse/ClickHouse/pull/35799) ([Nikolay Degterinsky](https://github.com/evillique)).
* Исправлено чтение из HDFS в формате Snappy. [#35771](https://github.com/ClickHouse/ClickHouse/pull/35771) ([shuchaome](https://github.com/shuchaome)).
* Исправлена ошибка преобразования пользовательских типов в строку, которая могла приводить к ошибке сегментации памяти или неожиданным сообщениям об ошибках. Закрывает [#35752](https://github.com/ClickHouse/ClickHouse/issues/35752). [#35755](https://github.com/ClickHouse/ClickHouse/pull/35755) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена реализация подзапросов с ANY/ALL. Закрывает [#35489](https://github.com/ClickHouse/ClickHouse/issues/35489). [#35727](https://github.com/ClickHouse/ClickHouse/pull/35727) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка удаления непустой базы данных в clickhouse-local. Закрывает [#35692](https://github.com/ClickHouse/ClickHouse/issues/35692). [#35711](https://github.com/ClickHouse/ClickHouse/pull/35711) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка при создании материализованного представления с подзапросом после перезапуска сервера. После перезапуска сервера материализованное представление не обновлялось при вставках в базовую таблицу. Закрывает [#35511](https://github.com/ClickHouse/ClickHouse/issues/35511). [#35691](https://github.com/ClickHouse/ClickHouse/pull/35691) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено возможное исключение `Can't adjust last granule` при чтении подстолбцов экспериментального типа `Object`. [#35687](https://github.com/ClickHouse/ClickHouse/pull/35687) ([Anton Popov](https://github.com/CurtizJ)).
* Включена сборка с JIT-компиляцией по умолчанию. [#35683](https://github.com/ClickHouse/ClickHouse/pull/35683) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена возможная потеря подстолбцов в экспериментальном типе `Object`. [#35682](https://github.com/ClickHouse/ClickHouse/pull/35682) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена проверка допустимости NULL для ключа ASOF JOIN, закрыт [#35565](https://github.com/ClickHouse/ClickHouse/issues/35565). [#35674](https://github.com/ClickHouse/ClickHouse/pull/35674) ([Vladimir C](https://github.com/vdimir)).
* Исправлена логика проверки частей с проекциями. Ошибка возникала, когда проекция и основная часть имели разные типы. Проблема аналогична [https://github.com/ClickHouse/ClickHouse/pull/33774](https://github.com/ClickHouse/ClickHouse/pull/33774). Ошибка устранена @caoyang10. [#35667](https://github.com/ClickHouse/ClickHouse/pull/35667) ([Amos Bird](https://github.com/amosbird)).
* Исправлено падение сервера при передаче большого числа аргументов в функцию `format`. Пожалуйста, обратитесь к тестовому файлу, чтобы увидеть, как воспроизвести это падение. [#35651](https://github.com/ClickHouse/ClickHouse/pull/35651) ([Amos Bird](https://github.com/amosbird)).
* Исправлено использование квот для асинхронных вставок. [#35645](https://github.com/ClickHouse/ClickHouse/pull/35645) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена обработка позиционных аргументов с псевдонимами. Закрывает [#35600](https://github.com/ClickHouse/ClickHouse/issues/35600). [#35620](https://github.com/ClickHouse/ClickHouse/pull/35620) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Проверять `remote_url_allow_hosts` перед определением схемы в движке URL. Закрывает [#35064](https://github.com/ClickHouse/ClickHouse/issues/35064). [#35619](https://github.com/ClickHouse/ClickHouse/pull/35619) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен `HashJoin` при использовании столбцов с типом `LowCardinality`. Это закрывает [#35548](https://github.com/ClickHouse/ClickHouse/issues/35548). [#35616](https://github.com/ClickHouse/ClickHouse/pull/35616) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена возможная ошибка сегментации в MaterializedPostgreSQL, которая возникала, если во время синхронизации данных, собранных в памяти, с базовыми таблицами происходило исключение. Закрывает [#35611](https://github.com/ClickHouse/ClickHouse/issues/35611). [#35614](https://github.com/ClickHouse/ClickHouse/pull/35614) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Параметр `database_atomic_wait_for_drop_and_detach_synchronously` некорректно работал для запроса `ATTACH TABLE`, когда ранее отсоединённая таблица всё ещё использовалась. Это исправлено. [#35594](https://github.com/ClickHouse/ClickHouse/pull/35594) ([tavplubix](https://github.com/tavplubix)).
* Исправлены HTTP-заголовки для именованных коллекций, добавлен параметр `compression_method`. Закрывает [#35273](https://github.com/ClickHouse/ClickHouse/issues/35273). Закрывает [#35269](https://github.com/ClickHouse/ClickHouse/issues/35269). [#35593](https://github.com/ClickHouse/ClickHouse/pull/35593) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено получение виртуальных столбцов в движке S3. Закрывает [#35411](https://github.com/ClickHouse/ClickHouse/issues/35411). [#35586](https://github.com/ClickHouse/ClickHouse/pull/35586) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено выведение возвращаемого типа для `caseWithExpression`. Тип ветки ELSE теперь корректно учитывается. [#35576](https://github.com/ClickHouse/ClickHouse/pull/35576) ([Antonio Andelic](https://github.com/antonio2368)).
* Исправлена обработка IPv6-адресов длиной более 39 символов. Закрывает [#34022](https://github.com/ClickHouse/ClickHouse/issues/34022). [#35539](https://github.com/ClickHouse/ClickHouse/pull/35539) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлено приведение к типам IPv4 и IPv6 в выражении IN. Исправляет ошибку [#35528](https://github.com/ClickHouse/ClickHouse/issues/35528). [#35534](https://github.com/ClickHouse/ClickHouse/pull/35534) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлен сбой при вычислении функции с коротким замыканием, когда один из аргументов является константой Nullable. Закрывает [#35497](https://github.com/ClickHouse/ClickHouse/issues/35497). Закрывает [#35496](https://github.com/ClickHouse/ClickHouse/issues/35496). [#35502](https://github.com/ClickHouse/ClickHouse/pull/35502) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлено падение функции `throwIf` при константных аргументах. [#35500](https://github.com/ClickHouse/ClickHouse/pull/35500) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена ошибка в Keeper, которая могла приводить к нестабильности клиентских подключений. Была внесена в [#35031](https://github.com/ClickHouse/ClickHouse/issues/35031). [#35498](https://github.com/ClickHouse/ClickHouse/pull/35498) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка в функции `if`, при которой тип результирующего столбца отличался от результирующего типа данных, что приводило к логическим ошибкам вида `Logical error: 'Bad cast from type DB::ColumnVector<int> to DB::ColumnVector<long>'.`. Закрывает [#35367](https://github.com/ClickHouse/ClickHouse/issues/35367). [#35476](https://github.com/ClickHouse/ClickHouse/pull/35476) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено избыточное логирование при использовании S3 в качестве бэкенда для MergeTree или как отдельного движка таблицы/функции. Исправлена ошибка [#30559](https://github.com/ClickHouse/ClickHouse/issues/30559). [#35434](https://github.com/ClickHouse/ClickHouse/pull/35434) ([alesapin](https://github.com/alesapin)).
* Теперь слияния, выполняемые с репликацией с нулевым копированием (экспериментальная функция), не будут засорять логи сообщением `Found parts with the same min block and with the same max block as the missing part _ on replica _. Hoping that it will eventually appear as a result of a merge.`. [#35430](https://github.com/ClickHouse/ClickHouse/pull/35430) ([alesapin](https://github.com/alesapin)).
* Пропускать возможное исключение, если в GroupingAggregatedTransform возникают пустые чанки. [#35417](https://github.com/ClickHouse/ClickHouse/pull/35417) ([Nikita Taranov](https://github.com/nickitat)).
* Исправлена обработка столбцов, не используемых в запросе, в форматах Arrow/Parquet/ORC. Это предотвращает возможные ошибки вида `Unsupported <format> type <type> of an input column <column_name>`, когда файл содержит столбец с неподдерживаемым типом, который не используется в запросе. [#35406](https://github.com/ClickHouse/ClickHouse/pull/35406) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена работа локального кэша для удалённой файловой системы (экспериментальная функция) при высокой степени параллелизма в пограничных случаях. [#35381](https://github.com/ClickHouse/ClickHouse/pull/35381) ([Kseniia Sumarokova](https://github.com/kssenii)). Исправлен возможный дедлок в кэше. [#35378](https://github.com/ClickHouse/ClickHouse/pull/35378) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено отсечение партиций при сравнении с константой в `WHERE`. Если столбец и константа имели разные типы, могло происходить переполнение. Запрос мог возвращать некорректный пустой результат. Исправлена проблема [#35304](https://github.com/ClickHouse/ClickHouse/issues/35304). [#35334](https://github.com/ClickHouse/ClickHouse/pull/35334) ([Amos Bird](https://github.com/amosbird)).
* Исправлено определение схемы для формата TSKV при использовании небольшого значения max&#95;read&#95;buffer&#95;size. [#35332](https://github.com/ClickHouse/ClickHouse/pull/35332) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлены мутации в таблицах с включёнными разрежёнными столбцами. [#35284](https://github.com/ClickHouse/ClickHouse/pull/35284) ([Anton Popov](https://github.com/CurtizJ)).
* По умолчанию запись финальной части не откладывается (это устраняет возможную ошибку `Memory limit exceeded` во время `INSERT` путём добавления настройки `max_insert_delayed_streams_for_parallel_write` со значением по умолчанию 1000 для записей в S3 и отключённой, как и раньше, в остальных случаях). [#34780](https://github.com/ClickHouse/ClickHouse/pull/34780) ([Azat Khuzhin](https://github.com/azat)).

### <a id="223"></a> Релиз ClickHouse v22.3-lts, 2022-03-17 {#a-id223a-clickhouse-release-v223-lts-2022-03-17}

#### Обратно несовместимые изменения {#backward-incompatible-change-6}

- Функция `arrayCompact` теперь ведёт себя как другие функции высшего порядка: выполняет сжатие не результатов лямбда-функции, а исходного массива. Если вы используете нетривиальные лямбда-функции в arrayCompact, вы можете восстановить прежнее поведение, обернув аргументы `arrayCompact` в `arrayMap`. Закрывает [#34010](https://github.com/ClickHouse/ClickHouse/issues/34010) [#18535](https://github.com/ClickHouse/ClickHouse/issues/18535) [#14778](https://github.com/ClickHouse/ClickHouse/issues/14778). [#34795](https://github.com/ClickHouse/ClickHouse/pull/34795) ([Alexandre Snarskii](https://github.com/snar)).
- Изменено специфичное для реализации поведение при переполнении функции `toDatetime`. Теперь значение будет ограничиваться ближайшим минимальным/максимальным поддерживаемым моментом времени datetime вместо циклического переноса. Это изменение отмечено как "обратно несовместимое", поскольку кто-то может непреднамеренно полагаться на старое поведение. [#32898](https://github.com/ClickHouse/ClickHouse/pull/32898) ([HaiBo Li](https://github.com/marising)).
- Функции `cast(value, 'IPv4')`, `cast(value, 'IPv6')` теперь ведут себя так же, как функции `toIPv4`, `toIPv6`. Изменено поведение при передаче некорректного IP-адреса в функции `toIPv4`, `toIPv6`: теперь при передаче недопустимого IP-адреса в эти функции будет вызвано исключение, ранее функция возвращала значение по умолчанию. Добавлены функции `IPv4StringToNumOrDefault`, `IPv4StringToNumOrNull`, `IPv6StringToNumOrDefault`, `IPv6StringOrNull`, `toIPv4OrDefault`, `toIPv4OrNull`, `toIPv6OrDefault`, `toIPv6OrNull`. Функции `IPv4StringToNumOrDefault`, `toIPv4OrDefault`, `toIPv6OrDefault` следует использовать, если предыдущая логика полагалась на возврат значения по умолчанию функциями `IPv4StringToNum`, `toIPv4`, `toIPv6` для недопустимого адреса. Добавлена настройка `cast_ipv4_ipv6_default_on_conversion_error`; если эта настройка включена, функции преобразования IP-адресов будут вести себя как раньше. Закрывает [#22825](https://github.com/ClickHouse/ClickHouse/issues/22825). Закрывает [#5799](https://github.com/ClickHouse/ClickHouse/issues/5799). Закрывает [#35156](https://github.com/ClickHouse/ClickHouse/issues/35156). [#35240](https://github.com/ClickHouse/ClickHouse/pull/35240) ([Maksim Kita](https://github.com/kitaisreal)).

#### Новые возможности {#new-feature-9}


- Поддержка локального кэширования данных для удалённых файловых систем. Может быть включена для дисков `s3`. Закрывает [#28961](https://github.com/ClickHouse/ClickHouse/issues/28961). [#33717](https://github.com/ClickHouse/ClickHouse/pull/33717) ([Kseniia Sumarokova](https://github.com/kssenii)). Тем временем мы включили набор тестов для файловой системы s3, и больше не существует известных проблем, поэтому функция готова к использованию в промышленной эксплуатации.
- Добавлена новая табличная функция `hive`. Может использоваться следующим образом: `hive('<hive metastore url>', '<hive database>', '<hive table name>', '<columns definition>', '<partition columns>')`, например `SELECT * FROM hive('thrift://hivetest:9083', 'test', 'demo', 'id Nullable(String), score Nullable(Int32), day Nullable(String)', 'day')`. [#34946](https://github.com/ClickHouse/ClickHouse/pull/34946) ([lgbo](https://github.com/lgbo-ustc)).
- Поддержка аутентификации пользователей, подключённых через SSL, по их сертификату X.509. [#31484](https://github.com/ClickHouse/ClickHouse/pull/31484) ([eungenue](https://github.com/eungenue)).
- Поддержка автоматического определения схемы при вставке в табличные функции `file`/`hdfs`/`s3`/`url`. [#34732](https://github.com/ClickHouse/ClickHouse/pull/34732) ([Kruglov Pavel](https://github.com/Avogar)).
- Теперь можно читать таблицу `system.zookeeper` без ограничений на путь или с использованием выражения `like`. Такие чтения могут создавать значительную нагрузку на zookeeper, поэтому для включения этой возможности необходимо активировать настройку `allow_unrestricted_reads_from_keeper`. [#34609](https://github.com/ClickHouse/ClickHouse/pull/34609) ([Sergei Trifonov](https://github.com/serxa)).
- Отображение метрик CPU и памяти в clickhouse-local. Закрывает [#34545](https://github.com/ClickHouse/ClickHouse/issues/34545). [#34605](https://github.com/ClickHouse/ClickHouse/pull/34605) ([李扬](https://github.com/taiyang-li)).
- Реализованы функции `startsWith` и `endsWith` для массивов, закрывает [#33982](https://github.com/ClickHouse/ClickHouse/issues/33982). [#34368](https://github.com/ClickHouse/ClickHouse/pull/34368) ([usurai](https://github.com/usurai)).
- Добавлены три функции для типа данных Map: 1. `mapReplace(map1, map2)` — заменяет значения ключей в map1 значениями соответствующих ключей в map2; добавляет ключи из map2, которых нет в map1. 2. `mapFilter` 3. `mapMap`. mapFilter и mapMap являются функциями высшего порядка, принимающими два аргумента: первый аргумент — лямбда-функция с парой k, v в качестве аргументов, второй аргумент — столбец типа Map. [#33698](https://github.com/ClickHouse/ClickHouse/pull/33698) ([hexiaoting](https://github.com/hexiaoting)).
- Разрешено получение имени пользователя и пароля по умолчанию для clickhouse-client из переменных окружения `CLICKHOUSE_USER` и `CLICKHOUSE_PASSWORD`. Закрывает [#34538](https://github.com/ClickHouse/ClickHouse/issues/34538). [#34947](https://github.com/ClickHouse/ClickHouse/pull/34947) ([DR](https://github.com/freedomDR)).

#### Экспериментальная функциональность {#experimental-feature-8}

- Новый тип данных `Object(<schema_format>)`, который поддерживает хранение полуструктурированных данных (пока только JSON). Данные записываются в такие типы в виде строки. Затем все пути извлекаются в соответствии с форматом полуструктурированных данных и записываются как отдельные столбцы в наиболее оптимальных типах, которые могут хранить все их значения. Эти столбцы можно запрашивать по именам, соответствующим путям в исходных данных. Например, `data.key1.key2` или с оператором приведения типа `data.key1.key2::Int64`.
- Добавлена настройка `database_replicated_allow_only_replicated_engine`. При включении разрешается создавать только таблицы `Replicated` или таблицы с движками без состояния в базах данных `Replicated`. [#35214](https://github.com/ClickHouse/ClickHouse/pull/35214) ([Nikolai Kochetov](https://github.com/KochetovNicolai)). Обратите внимание, что база данных `Replicated` всё ещё является экспериментальной функцией.

#### Улучшение производительности {#performance-improvement-9}


- Улучшена производительность вставки в таблицы `MergeTree` за счёт оптимизации сортировки. На реалистичных тестах наблюдается ускорение до 2 раз. [#34750](https://github.com/ClickHouse/ClickHouse/pull/34750) ([Maksim Kita](https://github.com/kitaisreal)).
- Отсечение столбцов при чтении файлов Parquet, ORC и Arrow из URL и S3. Закрывает [#34163](https://github.com/ClickHouse/ClickHouse/issues/34163). [#34849](https://github.com/ClickHouse/ClickHouse/pull/34849) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Отсечение столбцов при чтении файлов Parquet, ORC и Arrow из Hive. [#34954](https://github.com/ClickHouse/ClickHouse/pull/34954) ([lgbo](https://github.com/lgbo-ustc)).
- Набор оптимизаций производительности от супергероя производительности. Улучшена производительность обработки запросов с большой секцией `IN`. Улучшена производительность словаря `direct`, если его источником является `ClickHouse`. Улучшена производительность функций `detectCharset`, `detectLanguageUnknown`. [#34888](https://github.com/ClickHouse/ClickHouse/pull/34888) ([Maksim Kita](https://github.com/kitaisreal)).
- Улучшена производительность агрегатной функции `any` за счёт использования большей пакетной обработки. [#34760](https://github.com/ClickHouse/ClickHouse/pull/34760) ([Raúl Marín](https://github.com/Algunenano)).
- Множественные улучшения производительности `clickhouse-keeper`: меньше блокировок [#35010](https://github.com/ClickHouse/ClickHouse/pull/35010) ([zhanglistar](https://github.com/zhanglistar)), снижено потребление памяти за счёт потокового чтения и записи снимков вместо полного копирования [#34584](https://github.com/ClickHouse/ClickHouse/pull/34584) ([zhanglistar](https://github.com/zhanglistar)), оптимизация уплотнения хранилища логов в реализации RAFT [#34534](https://github.com/ClickHouse/ClickHouse/pull/34534) ([zhanglistar](https://github.com/zhanglistar)), версионирование внутренней структуры данных [#34486](https://github.com/ClickHouse/ClickHouse/pull/34486) ([zhanglistar](https://github.com/zhanglistar)).

#### Улучшение {#improvement-9}


* Разрешить асинхронные вставки в табличные функции. Исправлена проблема [#34864](https://github.com/ClickHouse/ClickHouse/issues/34864). [#34866](https://github.com/ClickHouse/ClickHouse/pull/34866) ([Anton Popov](https://github.com/CurtizJ)).
* Неявное приведение типа аргумента ключа в функциях `dictGetHierarchy`, `dictIsIn`, `dictGetChildren`, `dictGetDescendants`. Закрывает [#34970](https://github.com/ClickHouse/ClickHouse/issues/34970). [#35027](https://github.com/ClickHouse/ClickHouse/pull/35027) ([Maksim Kita](https://github.com/kitaisreal)).
* Запрос `EXPLAIN AST` может выводить AST в виде графа в формате Graphviz: `EXPLAIN AST graph = 1 SELECT * FROM system.parts`. [#35173](https://github.com/ClickHouse/ClickHouse/pull/35173) ([李扬](https://github.com/taiyang-li)).
* При записи больших файлов с помощью табличной функции `s3` или табличного движка тип содержимого файлов из-за ошибки в AWS SDK неверно устанавливался как `application/xml`. Это закрывает [#33964](https://github.com/ClickHouse/ClickHouse/issues/33964). [#34433](https://github.com/ClickHouse/ClickHouse/pull/34433) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Немного изменены ограничительные политики строк, чтобы в простых случаях они были более удобной альтернативой разрешительным политикам. Если для конкретной таблицы заданы только ограничительные политики (без разрешительных), пользователи смогут видеть некоторые строки. Также `SHOW CREATE ROW POLICY` всегда будет показывать `AS permissive` или `AS restrictive` в определении политики строк. [#34596](https://github.com/ClickHouse/ClickHouse/pull/34596) ([Vitaly Baranov](https://github.com/vitlibar)).
* Улучшено определение схемы с помощью glob-шаблонов в движках File/S3/HDFS/URL. В случае ошибки определения схемы теперь предпринимается попытка использовать следующий путь. [#34465](https://github.com/ClickHouse/ClickHouse/pull/34465) ([Kruglov Pavel](https://github.com/Avogar)).
* Play UI теперь корректно определяет предпочитаемую светлую или тёмную тему на основе настроек операционной системы. [#35068](https://github.com/ClickHouse/ClickHouse/pull/35068) ([peledni](https://github.com/peledni)).
* Добавлен формат `date_time_input_format = 'best_effort_us'`. Закрывает [#34799](https://github.com/ClickHouse/ClickHouse/issues/34799). [#34982](https://github.com/ClickHouse/ClickHouse/pull/34982) ([WenYao](https://github.com/Cai-Yao)).
* В конфигурацию сервера добавлены новые настройки `allow_plaintext_password` и `allow_no_password`, которые включают или отключают типы аутентификации, потенциально небезопасные в некоторых средах. По умолчанию соответствующие типы аутентификации разрешены. [#34738](https://github.com/ClickHouse/ClickHouse/pull/34738) ([Heena Bansal](https://github.com/HeenaBansal2009)).
* Поддержка типа данных `DateTime64` в формате `Arrow`, что закрывает [#8280](https://github.com/ClickHouse/ClickHouse/issues/8280) и [#28574](https://github.com/ClickHouse/ClickHouse/issues/28574). [#34561](https://github.com/ClickHouse/ClickHouse/pull/34561) ([李扬](https://github.com/taiyang-li)).
* Перезагружать `remote_url_allow_hosts` (фильтрацию исходящих соединений) при обновлении конфигурации. [#35294](https://github.com/ClickHouse/ClickHouse/pull/35294) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлена поддержка параметра `--testmode` для `clickhouse-local`. Этот параметр включает интерпретацию тестовых хинтов, которые мы используем в функциональных тестах. [#35264](https://github.com/ClickHouse/ClickHouse/pull/35264) ([Kseniia Sumarokova](https://github.com/kssenii)).
* В журнал запросов добавлен `distributed_depth`. Это более подробный аналог `is_initial_query` [#35207](https://github.com/ClickHouse/ClickHouse/pull/35207) ([李扬](https://github.com/taiyang-li)).
* Параметр `remote_url_allow_hosts` теперь учитывается для табличных функций `MySQL` и `PostgreSQL`. [#35191](https://github.com/ClickHouse/ClickHouse/pull/35191) ([Heena Bansal](https://github.com/HeenaBansal2009)).
* Добавлено поле `disk_name` в таблицу `system.part_log`. [#35178](https://github.com/ClickHouse/ClickHouse/pull/35178) ([Artyom Yurkov](https://github.com/Varinara)).
* Не выполнять повторных попыток при неповторяемых ошибках при запросах к удалённым URL. Закрывает [#35161](https://github.com/ClickHouse/ClickHouse/issues/35161). [#35172](https://github.com/ClickHouse/ClickHouse/pull/35172) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка распределённых запросов INSERT SELECT (настройка `parallel_distributed_insert_select`) для табличной функции `view()`. [#35132](https://github.com/ClickHouse/ClickHouse/pull/35132) ([Azat Khuzhin](https://github.com/azat)).
* Более точное отслеживание памяти при выполнении `INSERT` в `Buffer` с `AggregateFunction`. [#35072](https://github.com/ClickHouse/ClickHouse/pull/35072) ([Azat Khuzhin](https://github.com/azat)).
* Исключено деление на ноль в Query Profiler при наличии ошибки в ядре Linux. Закрывает [#34787](https://github.com/ClickHouse/ClickHouse/issues/34787). [#35032](https://github.com/ClickHouse/ClickHouse/pull/35032) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Добавлены дополнительные проверки корректности конфигурации keeper: теперь недопустимо смешивать localhost и удалённые серверы, а также добавлены проверки на совпадение значений внутреннего порта Raft и клиентского порта keeper. [#35004](https://github.com/ClickHouse/ClickHouse/pull/35004) ([alesapin](https://github.com/alesapin)).
* В настоящее время если пользователь меняет настройки системных таблиц, генерируется огромное количество логов, а ClickHouse переименовывает таблицы каждую минуту. Это исправляет [#34929](https://github.com/ClickHouse/ClickHouse/issues/34929). [#34949](https://github.com/ClickHouse/ClickHouse/pull/34949) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Использовать пул подключений для клиента Hive Metastore. [#34940](https://github.com/ClickHouse/ClickHouse/pull/34940) ([lgbo](https://github.com/lgbo-ustc)).
* Игнорировать поколоночный `TTL` в `CREATE TABLE AS`, если движок новой таблицы его не поддерживает (то есть если движок не относится к семейству `MergeTree`). [#34938](https://github.com/ClickHouse/ClickHouse/pull/34938) ([Azat Khuzhin](https://github.com/azat)).
* Разрешено использование строк `LowCardinality` для индексов `ngrambf_v1`/`tokenbf_v1`. Закрывает [#21865](https://github.com/ClickHouse/ClickHouse/issues/21865). [#34911](https://github.com/ClickHouse/ClickHouse/pull/34911) ([Lars Hiller Eidnes](https://github.com/larspars)).
* Разрешено открывать пустую базу данных SQLite, если файл отсутствует. Исправлена ошибка [#33367](https://github.com/ClickHouse/ClickHouse/issues/33367). [#34907](https://github.com/ClickHouse/ClickHouse/pull/34907) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Реализована поддержка сбора статистики памяти для FreeBSD — это необходимо для корректной работы `max_server_memory_usage`. [#34902](https://github.com/ClickHouse/ClickHouse/pull/34902) ([Alexandre Snarskii](https://github.com/snar)).
* В предыдущих версиях индикатор прогресса в clickhouse-client мог без видимой причины перескакивать примерно на 50 % вперёд. Это исправляет [#34324](https://github.com/ClickHouse/ClickHouse/issues/34324). [#34801](https://github.com/ClickHouse/ClickHouse/pull/34801) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* Теперь запросы `ALTER TABLE DROP COLUMN columnX` для движков таблиц `MergeTree` будут выполняться мгновенно, если `columnX` является столбцом типа `ALIAS`. Исправляет [#34660](https://github.com/ClickHouse/ClickHouse/issues/34660). [#34786](https://github.com/ClickHouse/ClickHouse/pull/34786) ([alesapin](https://github.com/alesapin)).
* Показывать подсказки, когда пользователь ошибся в имени индекса пропуска данных. Закрывает [#29698](https://github.com/ClickHouse/ClickHouse/issues/29698). [#34764](https://github.com/ClickHouse/ClickHouse/pull/34764) ([flynn](https://github.com/ucasfl)).
* Добавлена поддержка табличных функций `remote()`/`cluster()` для `parallel_distributed_insert_select`. [#34728](https://github.com/ClickHouse/ClickHouse/pull/34728) ([Azat Khuzhin](https://github.com/azat)).
* Не сбрасывать настройки логирования, заданные с помощью опций командной строки `--log-file`/`--errorlog-file`, при пустой конфигурации в конфигурационном файле. [#34718](https://github.com/ClickHouse/ClickHouse/pull/34718) ([Amos Bird](https://github.com/amosbird)).
* Схема теперь извлекается только один раз при создании таблицы; предотвращено чтение из локальных файлов и внешних источников для извлечения схемы при каждом запуске сервера. [#34684](https://github.com/ClickHouse/ClickHouse/pull/34684) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена возможность указывать имена аргументов для исполняемых UDF. Это необходимо для форматов, в которых имя аргумента является частью сериализации, таких как `Native`, `JSONEachRow`. Закрывает [#34604](https://github.com/ClickHouse/ClickHouse/issues/34604). [#34653](https://github.com/ClickHouse/ClickHouse/pull/34653) ([Maksim Kita](https://github.com/kitaisreal)).
* `MaterializedMySQL` (экспериментальная возможность) теперь поддерживает `materialized_mysql_tables_list` (список таблиц базы данных MySQL, разделённых запятыми, который будет реплицироваться движком базы данных MaterializedMySQL. Значение по умолчанию: пустой список — означает, что реплицироваться будут все таблицы), упомянутый в [#32977](https://github.com/ClickHouse/ClickHouse/issues/32977). [#34487](https://github.com/ClickHouse/ClickHouse/pull/34487) ([zzsmdfj](https://github.com/zzsmdfj)).
* Улучшены span-логи OpenTelemetry для операции INSERT в распределённую таблицу. [#34480](https://github.com/ClickHouse/ClickHouse/pull/34480) ([Frank Chen](https://github.com/FrankChen021)).
* Сделаны согласованными значения `ctime` и `mtime` znode между серверами ClickHouse Keeper. [#33441](https://github.com/ClickHouse/ClickHouse/pull/33441) ([小路](https://github.com/nicelulu)).

#### Улучшения сборки/тестирования/пакетирования {#buildtestingpackaging-improvement-9}

- Репозиторий пакетов перенесён на JFrog Artifactory (**Mikhail f. Shiryaev**).
- Рандомизация некоторых настроек в функциональных тестах для тестирования большего количества возможных комбинаций настроек. Это ещё один метод фаззинга для обеспечения лучшего покрытия тестами. Закрывает [#32268](https://github.com/ClickHouse/ClickHouse/issues/32268). [#34092](https://github.com/ClickHouse/ClickHouse/pull/34092) ([Kruglov Pavel](https://github.com/Avogar)).
- Удаление PVS-Studio из CI. [#34680](https://github.com/ClickHouse/ClickHouse/pull/34680) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Добавлена возможность сборки stripped-бинарных файлов с помощью CMake. В предыдущих версиях это выполнялось с помощью dh-tools. [#35196](https://github.com/ClickHouse/ClickHouse/pull/35196) ([alesapin](https://github.com/alesapin)).
- Уменьшенная сборка `clickhouse-keeper` без избыточных компонентов. [#35031](https://github.com/ClickHouse/ClickHouse/pull/35031) ([alesapin](https://github.com/alesapin)).
- Использование @robot-clickhouse в качестве автора и коммитера для PR вида https://github.com/ClickHouse/ClickHouse/pull/34685. [#34793](https://github.com/ClickHouse/ClickHouse/pull/34793) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Ограничение версии DWARF для отладочной информации до версии 4, поскольку внутренний символизатор стека не может обрабатывать DWARF версии 5. Это актуально при компиляции ClickHouse с clang-15. [#34777](https://github.com/ClickHouse/ClickHouse/pull/34777) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Удаление debian-пакета `clickhouse-test` как ненужного усложнения. CI использует тесты из репозитория, автономное тестирование через deb-пакет больше не поддерживается. [#34606](https://github.com/ClickHouse/ClickHouse/pull/34606) ([Ilya Yatsishin](https://github.com/qoega)).

#### Исправление ошибок (видимые пользователю проблемы в официальных стабильных или предварительных релизах) {#bug-fix-user-visible-misbehaviour-in-official-stable-or-prestable-release}


* Исправление интеграции с HDFS: когда размер внутреннего буфера слишком мал, NEED&#95;MORE&#95;INPUT в `HadoopSnappyDecoder` вызывается несколько раз (&gt;=3) для одного сжатого блока. В результате входные данные копируются в неверное место в `HadoopSnappyDecoder::buffer`. [#35116](https://github.com/ClickHouse/ClickHouse/pull/35116) ([lgbo](https://github.com/lgbo-ustc)).
* Игнорировать устаревшие привилегии в запросах ATTACH GRANT. Этот PR исправляет [#34815](https://github.com/ClickHouse/ClickHouse/issues/34815). [#34855](https://github.com/ClickHouse/ClickHouse/pull/34855) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлен сегфолт в базе данных Postgres при получении запроса `CREATE TABLE`, если база данных была создана с использованием именованных коллекций. Закрывает [#35312](https://github.com/ClickHouse/ClickHouse/issues/35312). [#35313](https://github.com/ClickHouse/ClickHouse/pull/35313) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка частичного соединения merge join, приводившая к дублированию строк, закрыт [#31009](https://github.com/ClickHouse/ClickHouse/issues/31009). [#35311](https://github.com/ClickHouse/ClickHouse/pull/35311) ([Vladimir C](https://github.com/vdimir)).
* Исправлена возможная ошибка `Assertion 'position() != working_buffer.end()' failed` при использовании сжатия bzip2 с небольшим значением настройки `max_read_buffer_size`. Ошибка была обнаружена в [https://github.com/ClickHouse/ClickHouse/pull/35047](https://github.com/ClickHouse/ClickHouse/pull/35047). [#35300](https://github.com/ClickHouse/ClickHouse/pull/35300) ([Kruglov Pavel](https://github.com/Avogar)). При использовании сжатия lz4 с небольшим значением настройки `max_read_buffer_size`. [#35296](https://github.com/ClickHouse/ClickHouse/pull/35296) ([Kruglov Pavel](https://github.com/Avogar)). При использовании сжатия lzma с небольшим значением настройки `max_read_buffer_size`. [#35295](https://github.com/ClickHouse/ClickHouse/pull/35295) ([Kruglov Pavel](https://github.com/Avogar)). При использовании сжатия `brotli` с небольшим значением настройки `max_read_buffer_size`. Ошибка была обнаружена в [https://github.com/ClickHouse/ClickHouse/pull/35047](https://github.com/ClickHouse/ClickHouse/pull/35047). [#35281](https://github.com/ClickHouse/ClickHouse/pull/35281) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена возможная ошибка сегментации при определении схемы в `JSONEachRow`. [#35291](https://github.com/ClickHouse/ClickHouse/pull/35291) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен запрос `CHECK TABLE` в случае, когда в таблице включены разреженные столбцы. [#35274](https://github.com/ClickHouse/ClickHouse/pull/35274) ([Anton Popov](https://github.com/CurtizJ)).
* Избежать вызова `std::terminate` при возникновении исключения во время чтения из удалённого VFS. [#35257](https://github.com/ClickHouse/ClickHouse/pull/35257) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено чтение порта из конфигурации; закрыта задача [#34776](https://github.com/ClickHouse/ClickHouse/issues/34776). [#35193](https://github.com/ClickHouse/ClickHouse/pull/35193) ([Vladimir C](https://github.com/vdimir)).
* Исправлена ошибка в запросе с `WITH TOTALS`, возникавшая, когда `HAVING` возвращал пустой результат. Это устраняет [#33711](https://github.com/ClickHouse/ClickHouse/issues/33711). [#35186](https://github.com/ClickHouse/ClickHouse/pull/35186) ([Amos Bird](https://github.com/amosbird)).
* Исправлен краевой случай в `replaceRegexpAll`, закрыт [#35117](https://github.com/ClickHouse/ClickHouse/issues/35117). [#35182](https://github.com/ClickHouse/ClickHouse/pull/35182) ([Vladimir C](https://github.com/vdimir)).
* Определение схемы работало некорректно в случае `INSERT INTO FUNCTION s3(...) FROM ...`: оно пыталось прочитать схему из файла S3 вместо запроса SELECT. [#35176](https://github.com/ClickHouse/ClickHouse/pull/35176) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлены `table overrides` для `partition by` и других параметров в MaterializedPostgreSQL (экспериментальная функция). Закрывает [#35048](https://github.com/ClickHouse/ClickHouse/issues/35048). [#35162](https://github.com/ClickHouse/ClickHouse/pull/35162) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено поведение `MaterializedPostgreSQL` (экспериментальная функциональность) при добавлении новой таблицы в репликацию (`ATTACH TABLE`) после её ручного удаления (`DETACH TABLE`). Закрывает [#33800](https://github.com/ClickHouse/ClickHouse/issues/33800). Закрывает [#34922](https://github.com/ClickHouse/ClickHouse/issues/34922). Закрывает [#34315](https://github.com/ClickHouse/ClickHouse/issues/34315). [#35158](https://github.com/ClickHouse/ClickHouse/pull/35158) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена ошибка отсечения партиций при использовании немонотонной функции с оператором IN. Это устраняет [#35136](https://github.com/ClickHouse/ClickHouse/issues/35136). [#35146](https://github.com/ClickHouse/ClickHouse/pull/35146) ([Amos Bird](https://github.com/amosbird)).
* Исправлены небольшие неточности при преобразовании YAML-конфигураций в XML. [#35135](https://github.com/ClickHouse/ClickHouse/pull/35135) ([Miel Donkers](https://github.com/mdonkers)).
* Исправлена работа `optimize_skip_unused_shards_rewrite_in` для знаковых столбцов и отрицательных значений. [#35134](https://github.com/ClickHouse/ClickHouse/pull/35134) ([Azat Khuzhin](https://github.com/azat)).
* Параметр конфигурации внешнего словаря `update_lag` нельзя было использовать: он приводил к ошибке ``Unexpected key `update_lag` in dictionary source configuration``. [#35089](https://github.com/ClickHouse/ClickHouse/pull/35089) ([Jason Chu](https://github.com/1lann)).
* Предотвращена возможная взаимоблокировка при завершении работы сервера. [#35081](https://github.com/ClickHouse/ClickHouse/pull/35081) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено исчезновение псевдонима после оптимизации функции в подстолбец при включённой настройке `optimize_functions_to_subcolumns`. Закрывает [#33798](https://github.com/ClickHouse/ClickHouse/issues/33798). [#35079](https://github.com/ClickHouse/ClickHouse/pull/35079) ([qieqieplus](https://github.com/qieqieplus)).
* Исправлено чтение из таблицы `system.asynchronous_inserts`, если выполняется асинхронная вставка в табличную функцию. [#35050](https://github.com/ClickHouse/ClickHouse/pull/35050) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено возможное возникновение исключения `Reading for MergeTree family tables must be done with last position boundary` (при операциях с удалённой VFS). Закрывает [#34979](https://github.com/ClickHouse/ClickHouse/issues/34979). [#35001](https://github.com/ClickHouse/ClickHouse/pull/35001) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен неожиданный результат при использовании агрегатной функции типа -State в оконном фрейме. [#34999](https://github.com/ClickHouse/ClickHouse/pull/34999) ([metahys](https://github.com/metahys)).
* Устранён возможный segфault в FileLog (экспериментальная функциональность). Закрыта задача [#30749](https://github.com/ClickHouse/ClickHouse/issues/30749). [#34996](https://github.com/ClickHouse/ClickHouse/pull/34996) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена потенциальная редкая ошибка `Cannot push block to port which already has data`. [#34993](https://github.com/ClickHouse/ClickHouse/pull/34993) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено некорректное определение схемы для дат без кавычек в CSV. Закрывает [#34768](https://github.com/ClickHouse/ClickHouse/issues/34768). [#34961](https://github.com/ClickHouse/ClickHouse/pull/34961) ([Kruglov Pavel](https://github.com/Avogar)).
* Интеграция с Hive: исправлен неожиданный результат при использовании оператора `IN` в условии `WHERE` в запросе Hive. [#34945](https://github.com/ClickHouse/ClickHouse/pull/34945) ([lgbo](https://github.com/lgbo-ustc)).
* Избегайте постоянного опроса в ClickHouse Keeper при поиске файлов журнала изменений для удаления. [#34931](https://github.com/ClickHouse/ClickHouse/pull/34931) ([Azat Khuzhin](https://github.com/azat)).
* Исправлено преобразование DateTime64 из PostgreSQL. Закрывает [#33364](https://github.com/ClickHouse/ClickHouse/issues/33364). [#34910](https://github.com/ClickHouse/ClickHouse/pull/34910) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена возможная ошибка «Part directory doesn&#39;t exist» при выполнении `INSERT` в таблицу MergeTree, использующую VFS поверх S3. [#34876](https://github.com/ClickHouse/ClickHouse/pull/34876) ([Azat Khuzhin](https://github.com/azat)).
* Реализована поддержка выполнения DDL-операторов, таких как CREATE USER, на кросс-реплицированном кластере. [#34860](https://github.com/ClickHouse/ClickHouse/pull/34860) ([Jianmei Zhang](https://github.com/zhangjmruc)).
* Исправлены ошибки при группировке по нескольким столбцам в `WindowView` (экспериментальная возможность). [#34859](https://github.com/ClickHouse/ClickHouse/pull/34859) ([vxider](https://github.com/Vxider)).
* Исправлены возможные сбои в функциях S2 при выполнении запросов с константными столбцами. [#34745](https://github.com/ClickHouse/ClickHouse/pull/34745) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлена ошибка в функциях H3, содержащих константные столбцы, приводившая к сбоям запросов. [#34743](https://github.com/ClickHouse/ClickHouse/pull/34743) ([Bharat Nallan](https://github.com/bharatnc)).
* Исправлена ошибка `No such file or directory` при включённом `fsync_part_directory` и вертикальном слиянии. [#34739](https://github.com/ClickHouse/ClickHouse/pull/34739) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена сериализация/вывод для системных запросов `RELOAD MODEL`, `RELOAD FUNCTION`, `RESTART DISK` при использовании `ON CLUSTER`. Закрывает [#34514](https://github.com/ClickHouse/ClickHouse/issues/34514). [#34696](https://github.com/ClickHouse/ClickHouse/pull/34696) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена настройка `allow_experimental_projection_optimization` при совместном использовании с `enable_global_with_statement` (раньше это могло приводить к ошибке `Stack size too large` при нескольких выражениях в секции `WITH`, а также вызывать повторное выполнение скалярных подзапросов, поэтому теперь выполнение будет более оптимальным). [#34650](https://github.com/ClickHouse/ClickHouse/pull/34650) ([Azat Khuzhin](https://github.com/azat)).
* Прекращён выбор части для `MUTATE`, если другая реплика уже обновила журнал транзакций для движка `ReplatedMergeTree`. [#34633](https://github.com/ClickHouse/ClickHouse/pull/34633) ([Jianmei Zhang](https://github.com/zhangjmruc)).
* Исправлен некорректный результат тривиального запроса `count` при использовании механизма перемещения частей [#34089](https://github.com/ClickHouse/ClickHouse/issues/34089). [#34385](https://github.com/ClickHouse/ClickHouse/pull/34385) ([nvartolomei](https://github.com/nvartolomei)).
* Устранено несоответствие в применении ограничения `max_query_size` в распределённых подзапросах. [#34078](https://github.com/ClickHouse/ClickHouse/pull/34078) ([Chao Ma](https://github.com/godliness)).

### <a id="222"></a> ClickHouse release v22.2, 2022-02-17 {#a-id222a-clickhouse-release-v222-2022-02-17}

#### Примечания по обновлению {#upgrade-notes-3}

- Применение индексов пропуска данных для запросов с FINAL может приводить к некорректным результатам. В этом релизе индексы пропуска данных по умолчанию отключены для запросов с FINAL (добавлена новая настройка `use_skip_indexes_if_final`, которая по умолчанию отключена). [#34243](https://github.com/ClickHouse/ClickHouse/pull/34243) ([Azat Khuzhin](https://github.com/azat)).

#### Новые возможности {#new-feature-10}


* Проекции готовы к промышленной эксплуатации. Параметр `allow_experimental_projection_optimization` теперь установлен по умолчанию, а сам параметр объявлен устаревшим. [#34456](https://github.com/ClickHouse/ClickHouse/pull/34456) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Опция создания новых файлов при вставке для движков `File`/`S3`/`HDFS`. Разрешить перезапись файла в `HDFS`. По умолчанию выбрасывать исключение при попытке перезаписать файл в `S3`. Выбрасывать исключение при попытке дописать данные в файл в форматах, которые имеют суффикс (и, следовательно, не поддерживают дозапись, таких как `Parquet`, `ORC`). Закрывает [#31640](https://github.com/ClickHouse/ClickHouse/issues/31640) Закрывает [#31622](https://github.com/ClickHouse/ClickHouse/issues/31622) Закрывает [#23862](https://github.com/ClickHouse/ClickHouse/issues/23862) Закрывает [#15022](https://github.com/ClickHouse/ClickHouse/issues/15022) Закрывает [#16674](https://github.com/ClickHouse/ClickHouse/issues/16674). [#33302](https://github.com/ClickHouse/ClickHouse/pull/33302) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена настройка, позволяющая пользователю задать собственную семантику дедупликации в `MergeTree`/`ReplicatedMergeTree`. Если она задана, вместо дайджеста данных для генерации ID блока используется её значение. Таким образом, например, указывая уникальное значение для этой настройки в каждом операторе INSERT, пользователь может избежать дедупликации одинаковых вставленных данных. Это закрывает: [#7461](https://github.com/ClickHouse/ClickHouse/issues/7461). [#32304](https://github.com/ClickHouse/ClickHouse/pull/32304) ([Igor Nikonov](https://github.com/devcrafter)).
* Добавлена поддержка ключевого слова `DEFAULT` для запросов INSERT. Закрывает [#6331](https://github.com/ClickHouse/ClickHouse/issues/6331). [#33141](https://github.com/ClickHouse/ClickHouse/pull/33141) ([Andrii Buriachevskyi](https://github.com/1over)).
* К запросу `CREATE TABLE` добавлен спецификатор столбца `EPHEMERAL`. Закрывает [#9436](https://github.com/ClickHouse/ClickHouse/issues/9436). [#34424](https://github.com/ClickHouse/ClickHouse/pull/34424) ([yakov-olkhovskiy](https://github.com/yakov-olkhovskiy)).
* Добавлена поддержка предложения `IF EXISTS` для конструкции `TTL expr TO [DISK|VOLUME] [IF EXISTS] 'xxx'`. Части будут перемещаться на диск или том только если соответствующий диск или том существует на реплике, поэтому правила `MOVE TTL` смогут по-разному работать на репликах в соответствии с действующими политиками хранения. Исправляет [#34455](https://github.com/ClickHouse/ClickHouse/issues/34455). [#34504](https://github.com/ClickHouse/ClickHouse/pull/34504) ([Anton Popov](https://github.com/CurtizJ)).
* Добавлена возможность задавать движок таблицы по умолчанию и создавать таблицы без указания ENGINE. [#34187](https://github.com/ClickHouse/ClickHouse/pull/34187) ([Ilya Yatsishin](https://github.com/qoega)).
* Добавлена табличная функция `format(format_name, data)`. [#34125](https://github.com/ClickHouse/ClickHouse/pull/34125) ([Kruglov Pavel](https://github.com/Avogar)).
* Определять формат в `clickhouse-local` по имени файла, даже если он передаётся через stdin. [#33829](https://github.com/ClickHouse/ClickHouse/pull/33829) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлено определение схемы для табличной функции `values`. Закрывает [#33811](https://github.com/ClickHouse/ClickHouse/issues/33811). [#34017](https://github.com/ClickHouse/ClickHouse/pull/34017) ([Kruglov Pavel](https://github.com/Avogar)).
* Динамическая перезагрузка TLS-сертификатов сервера при перезагрузке конфигурации. Закрывает [#15764](https://github.com/ClickHouse/ClickHouse/issues/15764). [#15765](https://github.com/ClickHouse/ClickHouse/pull/15765) ([johnskopis](https://github.com/johnskopis)). [#31257](https://github.com/ClickHouse/ClickHouse/pull/31257) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* Теперь ReplicatedMergeTree может восстанавливать данные при выходе из строя некоторых своих дисков. [#13544](https://github.com/ClickHouse/ClickHouse/pull/13544) ([Amos Bird](https://github.com/amosbird)).
* Поддержка отказоустойчивых подключений в clickhouse-client: `clickhouse-client ... --host host1 --host host2 --port port2 --host host3 --port port --host host4`. [#34490](https://github.com/ClickHouse/ClickHouse/pull/34490) ([Kruglov Pavel](https://github.com/Avogar)). [#33824](https://github.com/ClickHouse/ClickHouse/pull/33824) ([Filippov Denis](https://github.com/DF5HSE)).
* Добавлены функции `DEGREES` и `RADIANS` для совместимости с MySQL. [#33769](https://github.com/ClickHouse/ClickHouse/pull/33769) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлена функция `h3ToCenterChild`. [#33313](https://github.com/ClickHouse/ClickHouse/pull/33313) ([Bharat Nallan](https://github.com/bharatnc)). Добавлены новые вспомогательные функции h3: `edgeLengthKm`,`exactEdgeLengthKm`,`exactEdgeLengthM`,`exactEdgeLengthRads`,`numHexagons`. [#33621](https://github.com/ClickHouse/ClickHouse/pull/33621) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлена функция `bitSlice` для извлечения битовых подпоследовательностей из типов String и FixedString. [#33360](https://github.com/ClickHouse/ClickHouse/pull/33360) ([RogerYK](https://github.com/RogerYK)).
* Реализована агрегатная функция `meanZTest`. [#33354](https://github.com/ClickHouse/ClickHouse/pull/33354) ([achimbab](https://github.com/achimbab)).
* Добавлены доверительные интервалы для агрегатных функций T-tests. [#33260](https://github.com/ClickHouse/ClickHouse/pull/33260) ([achimbab](https://github.com/achimbab)).
* Добавлена функция `addressToLineWithInlines`. Закрыта задача [#26211](https://github.com/ClickHouse/ClickHouse/issues/26211). [#33467](https://github.com/ClickHouse/ClickHouse/pull/33467) ([SuperDJY](https://github.com/cmsxbc)).
* Добавлены `#!` и `# ` как распознаваемое начало однострочных комментариев. Закрывает [#34138](https://github.com/ClickHouse/ClickHouse/issues/34138). [#34230](https://github.com/ClickHouse/ClickHouse/pull/34230) ([Aaron Katz](https://github.com/aaronstephenkatz)).

#### Экспериментальная функциональность {#experimental-feature-9}

- Функции для классификации текста: определение языка и кодировки. См. [#23271](https://github.com/ClickHouse/ClickHouse/issues/23271). [#33314](https://github.com/ClickHouse/ClickHouse/pull/33314) ([Nikolay Degterinsky](https://github.com/evillique)).
- Добавлен механизм превышения лимита памяти (memory overcommit) в `MemoryTracker`. Добавлены настройки `guaranteed` для лимитов памяти, которые представляют собой мягкие лимиты. При достижении жёсткого лимита памяти `MemoryTracker` пытается отменить запрос с наибольшим превышением лимита. Новая настройка `memory_usage_overcommit_max_wait_microseconds` определяет, как долго запросы могут ожидать остановки другого запроса. Закрывает [#28375](https://github.com/ClickHouse/ClickHouse/issues/28375). [#31182](https://github.com/ClickHouse/ClickHouse/pull/31182) ([Dmitry Novik](https://github.com/novikd)).
- Включена возможность соединения потока с таблицей в WindowView. [#33729](https://github.com/ClickHouse/ClickHouse/pull/33729) ([vxider](https://github.com/Vxider)).
- Поддержка типов данных `SET`, `YEAR`, `TIME` и `GEOMETRY` в `MaterializedMySQL` (экспериментальная функциональность). Исправляет [#18091](https://github.com/ClickHouse/ClickHouse/issues/18091), [#21536](https://github.com/ClickHouse/ClickHouse/issues/21536), [#26361](https://github.com/ClickHouse/ClickHouse/issues/26361). [#33429](https://github.com/ClickHouse/ClickHouse/pull/33429) ([zzsmdfj](https://github.com/zzsmdfj)).
- Исправлены различные проблемы при включении проекций по умолчанию. Каждая проблема описана в отдельном коммите. Относится к [#33678](https://github.com/ClickHouse/ClickHouse/issues/33678). Исправляет [#34273](https://github.com/ClickHouse/ClickHouse/issues/34273). [#34305](https://github.com/ClickHouse/ClickHouse/pull/34305) ([Amos Bird](https://github.com/amosbird)).

#### Улучшение производительности {#performance-improvement-10}


* Поддержка `optimize_read_in_order`, если префикс ключа сортировки уже упорядочен. Например, если в таблице есть ключ сортировки `ORDER BY (a, b)`, а в запросе используются условия `WHERE a = const ORDER BY b`, то теперь будет выполняться чтение в порядке ключа сортировки вместо полной сортировки. [#32748](https://github.com/ClickHouse/ClickHouse/pull/32748) ([Anton Popov](https://github.com/CurtizJ)).
* Повышена производительность операций вставки с разбиением на партиции в табличные функции `URL`, `S3`, `File`, `HDFS`. Закрывает [#34348](https://github.com/ClickHouse/ClickHouse/issues/34348). [#34510](https://github.com/ClickHouse/ClickHouse/pull/34510) ([Maksim Kita](https://github.com/kitaisreal)).
* Несколько улучшений производительности clickhouse-keeper. [#34484](https://github.com/ClickHouse/ClickHouse/pull/34484) [#34587](https://github.com/ClickHouse/ClickHouse/pull/34587) ([zhanglistar](https://github.com/zhanglistar)).
* `FlatDictionary` улучшает производительность загрузки данных словаря. [#33871](https://github.com/ClickHouse/ClickHouse/pull/33871) ([Maksim Kita](https://github.com/kitaisreal)).
* Повышена производительность функции `mapPopulateSeries`. Закрывает [#33944](https://github.com/ClickHouse/ClickHouse/issues/33944). [#34318](https://github.com/ClickHouse/ClickHouse/pull/34318) ([Maksim Kita](https://github.com/kitaisreal)).
* Виртуальные столбцы `_file` и `_path` (в табличных движках, работающих с файлами) переведены на тип `LowCardinality` — это ускорит выполнение запросов к нескольким файлам. Закрывает [#34300](https://github.com/ClickHouse/ClickHouse/issues/34300). [#34317](https://github.com/ClickHouse/ClickHouse/pull/34317) ([flynn](https://github.com/ucasfl)).
* Ускорена загрузка частей данных. Ранее она не выполнялась параллельно: настройка `part_loading_threads` не имела эффекта. См. [#4699](https://github.com/ClickHouse/ClickHouse/issues/4699). [#34310](https://github.com/ClickHouse/ClickHouse/pull/34310) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Повышена производительность формата `LineAsString`. Это закрывает [#34303](https://github.com/ClickHouse/ClickHouse/issues/34303). [#34306](https://github.com/ClickHouse/ClickHouse/pull/34306) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Оптимизированы `quantilesExact{Low,High}` для использования `nth_element` вместо `sort`. [#34287](https://github.com/ClickHouse/ClickHouse/pull/34287) ([Danila Kutenin](https://github.com/danlark1)).
* Незначительно улучшена производительность формата `Regexp`. [#34202](https://github.com/ClickHouse/ClickHouse/pull/34202) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Незначительное улучшение при анализе скалярных подзапросов. [#34128](https://github.com/ClickHouse/ClickHouse/pull/34128) ([Federico Rodriguez](https://github.com/fedrod)).
* Сделать ORDER BY tuple почти таким же быстрым, как ORDER BY по отдельным столбцам. Для ORDER BY по нескольким столбцам у нас есть специальные оптимизации: [https://github.com/ClickHouse/ClickHouse/pull/10831](https://github.com/ClickHouse/ClickHouse/pull/10831). Их целесообразно также применять к столбцам типа tuple. [#34060](https://github.com/ClickHouse/ClickHouse/pull/34060) ([Amos Bird](https://github.com/amosbird)).
* Кэш скалярных подзапросов переработан и снова задействован в механизме выполнения материализованных представлений. [#33958](https://github.com/ClickHouse/ClickHouse/pull/33958) ([Raúl Marín](https://github.com/Algunenano)).
* Незначительно улучшена производительность `ORDER BY` за счёт добавления поддержки x86-64 AVX-512 для функций `memcmpSmall` для ускорения операций сравнения памяти. Работает только если вы компилируете ClickHouse самостоятельно. [#33706](https://github.com/ClickHouse/ClickHouse/pull/33706) ([hanqf-git](https://github.com/hanqf-git)).
* Улучшена производительность словаря `range_hashed` при большом числе интервалов для ключа. Исправляет проблему [#23821](https://github.com/ClickHouse/ClickHouse/issues/23821). [#33516](https://github.com/ClickHouse/ClickHouse/pull/33516) ([Maksim Kita](https://github.com/kitaisreal)).
* При вставках и слияниях в S3 по возможности записывайте файлы параллельно (TODO: проверить, смержен ли PR). [#33291](https://github.com/ClickHouse/ClickHouse/pull/33291) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Улучшена производительность `clickhouse-keeper` и устранено несколько утечек памяти в библиотеке NuRaft. [#33329](https://github.com/ClickHouse/ClickHouse/pull/33329) ([alesapin](https://github.com/alesapin)).

#### Улучшение {#improvement-10}


* Добавлена поддержка асинхронных вставок в `clickhouse-client` для запросов с встроенными данными. [#34267](https://github.com/ClickHouse/ClickHouse/pull/34267) ([Anton Popov](https://github.com/CurtizJ)).
* Функции `dictGet`, `dictHas` неявно приводят аргумент ключа к структуре ключа словаря, если их типы различаются. [#33672](https://github.com/ClickHouse/ClickHouse/pull/33672) ([Maksim Kita](https://github.com/kitaisreal)).
* Улучшения для словарей `range_hashed`. Повышена производительность загрузки при наличии нескольких атрибутов. Теперь можно создавать словарь без атрибутов. Добавлена опция для указания стратегии, когда интервалы `start` и `end` имеют тип `Nullable`; параметр `convert_null_range_bound_to_open` по умолчанию равен `true`. Закрывает [#29791](https://github.com/ClickHouse/ClickHouse/issues/29791). Теперь можно указывать `Float`, `Decimal`, `DateTime64`, `Int128`, `Int256`, `UInt128`, `UInt256` в качестве типов диапазона. В `RangeHashedDictionary` добавлена поддержка значений диапазона, выходящих за пределы типа `Int64`. Закрывает [#28322](https://github.com/ClickHouse/ClickHouse/issues/28322). Добавлена опция `range_lookup_strategy` для указания типа поиска в диапазоне (`min`, `max`), по умолчанию — `min`. Закрывает [#21647](https://github.com/ClickHouse/ClickHouse/issues/21647). Исправлены вычисления объёма выделенной памяти в байтах. Исправлено имя типа в `system.dictionaries` в случае `ComplexKeyHashedDictionary`. [#33927](https://github.com/ClickHouse/ClickHouse/pull/33927) ([Maksim Kita](https://github.com/kitaisreal)).
* Словари `flat`, `hashed`, `hashed_array` теперь поддерживают создание с пустыми атрибутами при сохранении возможности чтения ключей и использования `dictHas`. Исправлена [#33820](https://github.com/ClickHouse/ClickHouse/issues/33820). [#33918](https://github.com/ClickHouse/ClickHouse/pull/33918) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена поддержка типа данных `DateTime64` в словарях. [#33914](https://github.com/ClickHouse/ClickHouse/pull/33914) ([Maksim Kita](https://github.com/kitaisreal)).
* Теперь можно использовать `s3(url, access_key_id, secret_access_key)` (автоопределение формата данных и структуры таблицы при явном указании учётных данных). [#34503](https://github.com/ClickHouse/ClickHouse/pull/34503) ([Kruglov Pavel](https://github.com/Avogar)).
* Добавлена отправка информации о выходном формате обратно клиенту по аналогии с протоколом HTTP, как предложено в [#34362](https://github.com/ClickHouse/ClickHouse/issues/34362). Закрывает [#34362](https://github.com/ClickHouse/ClickHouse/issues/34362). [#34499](https://github.com/ClickHouse/ClickHouse/pull/34499) ([Vitaly Baranov](https://github.com/vitlibar)).
* Отправлять статистику ProfileEvents при выполнении запроса INSERT SELECT (для отображения метрик запроса в `clickhouse-client` для этого типа запросов). [#34498](https://github.com/ClickHouse/ClickHouse/pull/34498) ([Dmitry Novik](https://github.com/novikd)).
* Добавлено распознавание расширения `.jsonl` для формата JSONEachRow. [#34496](https://github.com/ClickHouse/ClickHouse/pull/34496) ([Kruglov Pavel](https://github.com/Avogar)).
* Улучшено определение схемы в clickhouse-local. Теперь можно просто написать `clickhouse-local -q "select * from table" < data.format`. [#34495](https://github.com/ClickHouse/ClickHouse/pull/34495) ([Kruglov Pavel](https://github.com/Avogar)).
* Привилегии CREATE/ALTER/DROP ROW POLICY теперь могут назначаться для отдельной таблицы, для `database.*`, а также глобально — `*.*`. [#34489](https://github.com/ClickHouse/ClickHouse/pull/34489) ([Vitaly Baranov](https://github.com/vitlibar)).
* Позволяет экспортировать файлы произвольного размера в `s3`. Добавлены две новые настройки: `s3_upload_part_size_multiply_factor` и `s3_upload_part_size_multiply_parts_count_threshold`. Теперь каждый раз, когда в рамках одного запроса в S3 загружается количество частей, равное `s3_upload_part_size_multiply_parts_count_threshold`, значение `s3_min_upload_part_size` умножается на `s3_upload_part_size_multiply_factor`. Исправляет [#34244](https://github.com/ClickHouse/ClickHouse/issues/34244). [#34422](https://github.com/ClickHouse/ClickHouse/pull/34422) ([alesapin](https://github.com/alesapin)).
* Добавлена возможность игнорировать не найденные (404) URL-адреса при использовании glob-шаблонов в URL storage / табличной функции. Также закрывает [#34359](https://github.com/ClickHouse/ClickHouse/issues/34359). [#34392](https://github.com/ClickHouse/ClickHouse/pull/34392) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Форматы ввода и вывода по умолчанию для `clickhouse-local`, которые можно переопределить параметрами --input-format и --output-format. Закрыта задача [#30631](https://github.com/ClickHouse/ClickHouse/issues/30631). [#34352](https://github.com/ClickHouse/ClickHouse/pull/34352) ([李扬](https://github.com/taiyang-li)).
* Добавлены параметры для `clickhouse-format`, которые устраняют [#30528](https://github.com/ClickHouse/ClickHouse/issues/30528): `max_query_size`, `max_parser_depth`. [#34349](https://github.com/ClickHouse/ClickHouse/pull/34349) ([李扬](https://github.com/taiyang-li)).
* Улучшена обработка ввода до запуска клиента. Это относится к [#34308](https://github.com/ClickHouse/ClickHouse/issues/34308). [#34336](https://github.com/ClickHouse/ClickHouse/pull/34336) ([Amos Bird](https://github.com/amosbird)).
* Псевдонимы функций `REGEXP_MATCHES` и `REGEXP_REPLACE` для совместимости с PostgreSQL. Закрывает [#30885](https://github.com/ClickHouse/ClickHouse/issues/30885). [#34334](https://github.com/ClickHouse/ClickHouse/pull/34334) ([李扬](https://github.com/taiyang-li)).
* Некоторые серверы ожидают заголовок User-Agent в своих HTTP-запросах. В HTTP-запросы добавлен заголовок `User-Agent` следующего вида: User-Agent: ClickHouse/VERSION&#95;STRING. [#34330](https://github.com/ClickHouse/ClickHouse/pull/34330) ([Saad Ur Rahman](https://github.com/surahman)).
* Отменяет слияния перед получением блокировки таблицы при выполнении запроса `TRUNCATE`, чтобы в ряде случаев избежать ошибки `DEADLOCK_AVOIDED`. Исправляет [#34302](https://github.com/ClickHouse/ClickHouse/issues/34302). [#34304](https://github.com/ClickHouse/ClickHouse/pull/34304) ([tavplubix](https://github.com/tavplubix)).
* Изменён уровень серьёзности сообщения «Cancelled merging parts» в логах, так как оно не является ошибкой. Это закрывает [#34148](https://github.com/ClickHouse/ClickHouse/issues/34148). [#34232](https://github.com/ClickHouse/ClickHouse/pull/34232) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена возможность комбинировать оператор приведения типа в стиле PostgreSQL `::` с выражениями, использующими операторы `[]` и `.` (индексация массивов и кортежей). [#34229](https://github.com/ClickHouse/ClickHouse/pull/34229) ([Nikolay Degterinsky](https://github.com/evillique)).
* Распознавать формат `YYYYMMDD-hhmmss` в функции `parseDateTimeBestEffort`. Это закрывает задачу [#34206](https://github.com/ClickHouse/ClickHouse/issues/34206). [#34208](https://github.com/ClickHouse/ClickHouse/pull/34208) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Разрешён символ возврата каретки в середине строки при разборе формата `Regexp`. Это закрывает [#34200](https://github.com/ClickHouse/ClickHouse/issues/34200). [#34205](https://github.com/ClickHouse/ClickHouse/pull/34205) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка разбора `PRIMARY KEY` словаря в виде `PRIMARY KEY (id, value)`; ранее поддерживался только вариант `PRIMARY KEY id, value`. Закрывает [#34135](https://github.com/ClickHouse/ClickHouse/issues/34135). [#34141](https://github.com/ClickHouse/ClickHouse/pull/34141) ([Maksim Kita](https://github.com/kitaisreal)).
* Необязательный аргумент функции `splitByChar`, ограничивающий количество результирующих элементов. Закрывает [#34081](https://github.com/ClickHouse/ClickHouse/issues/34081). [#34140](https://github.com/ClickHouse/ClickHouse/pull/34140) ([李扬](https://github.com/taiyang-li)).
* Повышение удобства многострочного редактирования в clickhouse-client. Это продолжение [#31123](https://github.com/ClickHouse/ClickHouse/pull/31123). [#34114](https://github.com/ClickHouse/ClickHouse/pull/34114) ([Amos Bird](https://github.com/amosbird)).
* Добавлена поддержка `UUID` в формате ввода/вывода `MsgPack`. [#34065](https://github.com/ClickHouse/ClickHouse/pull/34065) ([Kruglov Pavel](https://github.com/Avogar)).
* Контекст трассировки (для OpenTelemetry) теперь пробрасывается из метаданных gRPC‑клиента (это изменение относится к протоколу клиент‑сервер gRPC). [#34064](https://github.com/ClickHouse/ClickHouse/pull/34064) ([andremarianiello](https://github.com/andremarianiello)).
* Поддерживает все типы запросов `SYSTEM` с оператором `ON CLUSTER`. [#34005](https://github.com/ClickHouse/ClickHouse/pull/34005) ([小路](https://github.com/nicelulu)).
* Улучшен учет памяти для запросов, использующих менее `max_untracker_memory`. [#34001](https://github.com/ClickHouse/ClickHouse/pull/34001) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен поиск строк в UTF-8 без учета регистра в случаях, когда строчные и прописные символы представлены разным количеством байт. Пример — `ẞ` и `ß`. Это закрывает [#7334](https://github.com/ClickHouse/ClickHouse/issues/7334). [#33992](https://github.com/ClickHouse/ClickHouse/pull/33992) ([Harry Lee](https://github.com/HarryLeeIBM)).
* Определение формата и схемы входных данных из stdin в `clickhouse-local`. [#33960](https://github.com/ClickHouse/ClickHouse/pull/33960) ([Kruglov Pavel](https://github.com/Avogar)).
* Корректно обрабатывать случай ошибочной конфигурации, когда несколько дисков используют один и тот же путь файловой системы. [#29072](https://github.com/ClickHouse/ClickHouse/issues/29072). [#33905](https://github.com/ClickHouse/ClickHouse/pull/33905) ([zhongyuankai](https://github.com/zhongyuankai)).
* Перебирать все разрешённые IP-адреса при получении S3-прокси. S3-прокси редко используются, в основном в Yandex Cloud. [#33862](https://github.com/ClickHouse/ClickHouse/pull/33862) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Добавлена поддержка запроса EXPLAIN AST CREATE FUNCTION: запрос `EXPLAIN AST CREATE FUNCTION mycast AS (n) -> cast(n as String)` вернет `EXPLAIN AST CREATE FUNCTION mycast AS n -> CAST(n, 'String')`. [#33819](https://github.com/ClickHouse/ClickHouse/pull/33819) ([李扬](https://github.com/taiyang-li)).
* Добавлена поддержка приведения типов из `Map(Key, Value)` к `Array(Tuple(Key, Value))`. [#33794](https://github.com/ClickHouse/ClickHouse/pull/33794) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлены улучшения и исправления для типа данных `Bool`. Исправлена ошибка [#33244](https://github.com/ClickHouse/ClickHouse/issues/33244). [#33737](https://github.com/ClickHouse/ClickHouse/pull/33737) ([Kruglov Pavel](https://github.com/Avogar)).
* Разбирать и сохранять идентификатор трассировки OpenTelemetry (trace-id) в порядке big-endian. [#33723](https://github.com/ClickHouse/ClickHouse/pull/33723) ([Frank Chen](https://github.com/FrankChen021)).
* Улучшено семейство функций `fromUnixTimestamp64`. Теперь они принимают любое целочисленное значение, которое может быть приведено к типу `Int64`. Это закрывает задачу: [#14648](https://github.com/ClickHouse/ClickHouse/issues/14648). [#33505](https://github.com/ClickHouse/ClickHouse/pull/33505) ([Andrey Zvonov](https://github.com/zvonand)).
* Пере реализовать `_shard_num` из констант (см. [#7624](https://github.com/ClickHouse/ClickHouse/issues/7624)) с помощью функции `shardNum()` (см. [#27020](https://github.com/ClickHouse/ClickHouse/issues/27020)), чтобы избежать возможных проблем (например, таких, как были обнаружены в [#16947](https://github.com/ClickHouse/ClickHouse/issues/16947)). [#33392](https://github.com/ClickHouse/ClickHouse/pull/33392) ([Azat Khuzhin](https://github.com/azat)).
* Включена поддержка бинарных арифметических операций (сложение, вычитание, умножение, деление, least, greatest) между Decimal и Float. [#33355](https://github.com/ClickHouse/ClickHouse/pull/33355) ([flynn](https://github.com/ucasfl)).
* Учитывать ограничения cgroups при автоопределении max&#95;threads. [#33342](https://github.com/ClickHouse/ClickHouse/pull/33342) ([JaySon](https://github.com/JaySon-Huang)).
* Добавлена новая настройка clickhouse-keeper `min_session_timeout_ms`. Теперь clickhouse-keeper будет определять таймаут клиентской сессии в соответствии с настройками `min_session_timeout_ms` и `session_timeout_ms`. [#33288](https://github.com/ClickHouse/ClickHouse/pull/33288) ([JackyWoo](https://github.com/JackyWoo)).
* Добавлена поддержка типа данных `UUID` для функций `hex` и `bin`. [#32170](https://github.com/ClickHouse/ClickHouse/pull/32170) ([Frank Chen](https://github.com/FrankChen021)).
* Исправлено чтение подколонок с точками в их именах. В частности, исправлено чтение колонок типа `Nested`, если имена их элементов содержат точки (например, ``Nested(`keys.name` String, `keys.id` UInt64, values UInt64)``). [#34228](https://github.com/ClickHouse/ClickHouse/pull/34228) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена проблема, из‑за которой `parallel_view_processing = 0` не работал при вставке в таблицу с использованием `VALUES`. — Исправлено некорректное заполнение `view_duration_ms` в `query_views_log` для материализованных представлений. [#34067](https://github.com/ClickHouse/ClickHouse/pull/34067) ([Raúl Marín](https://github.com/Algunenano)).
* Исправлен разбор структуры таблиц из ZooKeeper: теперь метаданные из ZooKeeper сравниваются с локальными метаданными в канонической форме. Это помогает, когда канонические имена функций могут изменяться между версиями ClickHouse. [#33933](https://github.com/ClickHouse/ClickHouse/pull/33933) ([sunny](https://github.com/sunny19930321)).
* Исправлено экранирование некоторых символов при взаимодействии с LDAP. [#33401](https://github.com/ClickHouse/ClickHouse/pull/33401) ([IlyaTsoi](https://github.com/IlyaTsoi)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-10}

- Удалена поддержка сборки без встроенных зависимостей. [#33690](https://github.com/ClickHouse/ClickHouse/pull/33690) ([Azat Khuzhin](https://github.com/azat)).
- Обеспечена независимость тестов от результата нестабильной сортировки равных элементов. Добавлена рандомизация диапазонов равных элементов в режиме отладки после сортировки для предотвращения проблем, возникающих при зависимости от порядка сортировки равных элементов. [#34393](https://github.com/ClickHouse/ClickHouse/pull/34393) ([Maksim Kita](https://github.com/kitaisreal)).
- Добавлен подробный вывод для проверки стиля кода. [#34289](https://github.com/ClickHouse/ClickHouse/pull/34289) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Удален пакет `clickhouse-test` для Debian, так как он устарел. [#33948](https://github.com/ClickHouse/ClickHouse/pull/33948) ([Ilya Yatsishin](https://github.com/qoega)).
- Множественные улучшения системы сборки для устранения возможности случайного использования пакетов из операционной системы и обеспечения герметичных сборок. [#33695](https://github.com/ClickHouse/ClickHouse/pull/33695) ([Amos Bird](https://github.com/amosbird)).

#### Исправление ошибок (видимое пользователю некорректное поведение в официальном стабильном или предварительном релизе) {#bug-fix-user-visible-misbehaviour-in-official-stable-or-prestable-release-1}


* Исправлена ассерция при использовании `allow_experimental_parallel_reading_from_replicas` с `max_parallel_replicas`, равным 1. Это исправляет [#34525](https://github.com/ClickHouse/ClickHouse/issues/34525). [#34613](https://github.com/ClickHouse/ClickHouse/pull/34613) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Исправлена редкая ошибка при чтении пустых массивов, которая могла приводить к ошибке `Data compressed with different methods`. Она могла проявляться, если у вас преимущественно пустые массивы, но не всегда, и чтение выполняется в обратном направлении с ORDER BY ... DESC. Вероятность возникновения этой ошибки чрезвычайно мала. [#34327](https://github.com/ClickHouse/ClickHouse/pull/34327) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен некорректный результат `round`/`roundBankers` при округлении целочисленных значений малых типов. Закрывает [#33267](https://github.com/ClickHouse/ClickHouse/issues/33267). [#34562](https://github.com/ClickHouse/ClickHouse/pull/34562) ([李扬](https://github.com/taiyang-li)).
* Иногда отмена запроса не срабатывала сразу при чтении нескольких файлов из s3 или HDFS. Исправлено: [#34301](https://github.com/ClickHouse/ClickHouse/issues/34301). Связано с [#34397](https://github.com/ClickHouse/ClickHouse/issues/34397). [#34539](https://github.com/ClickHouse/ClickHouse/pull/34539) ([Dmitry Novik](https://github.com/novikd)).
* Исправлено исключение `Chunk should have AggregatedChunkInfo in MergingAggregatedTransform` (в случае `optimize_aggregation_in_order = 1` и `distributed_aggregation_memory_efficient = 0`). Исправляет [#34526](https://github.com/ClickHouse/ClickHouse/issues/34526). [#34532](https://github.com/ClickHouse/ClickHouse/pull/34532) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено сравнение целых чисел и чисел с плавающей запятой при анализе индекса. Ранее это могло приводить к ошибочному пропуску некоторых гранул при чтении. Исправляет [#34493](https://github.com/ClickHouse/ClickHouse/issues/34493). [#34528](https://github.com/ClickHouse/ClickHouse/pull/34528) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена поддержка сжатия в URL-движке. [#34524](https://github.com/ClickHouse/ClickHouse/pull/34524) ([Frank Chen](https://github.com/FrankChen021)).
* Исправлена возможная ошибка &#39;file&#95;size: Operation not supported&#39; при автоматическом определении схемы файлов. [#34479](https://github.com/ClickHouse/ClickHouse/pull/34479) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена возможная гонка при удалении таблицы. [#34416](https://github.com/ClickHouse/ClickHouse/pull/34416) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена возможная ошибка `Cannot convert column Function to mask` при укороченном вычислении функций. Закрывает [#34171](https://github.com/ClickHouse/ClickHouse/issues/34171). [#34415](https://github.com/ClickHouse/ClickHouse/pull/34415) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен потенциальный сбой при выводе схемы из источника URL. Закрывает [#34147](https://github.com/ClickHouse/ClickHouse/issues/34147). [#34405](https://github.com/ClickHouse/ClickHouse/pull/34405) ([Kruglov Pavel](https://github.com/Avogar)).
* Для UDF-функций права доступа проверялись на уровне базы данных вместо глобального уровня, как и должно быть. Закрывает [#34281](https://github.com/ClickHouse/ClickHouse/issues/34281). [#34404](https://github.com/ClickHouse/ClickHouse/pull/34404) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлен некорректный синтаксис движка в результате выполнения запроса `SHOW CREATE DATABASE` для баз данных с движком `Memory`. Закрывает [#34335](https://github.com/ClickHouse/ClickHouse/issues/34335). [#34345](https://github.com/ClickHouse/ClickHouse/pull/34345) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено несколько крайне редких гонок, которые могли приводить к некорректному состоянию очереди репликации и ошибке «Intersecting parts». [#34297](https://github.com/ClickHouse/ClickHouse/pull/34297) ([tavplubix](https://github.com/tavplubix)).
* Исправлена ширина индикатора выполнения. Ранее ширина некорректно округлялась до целого числа символов. [#34275](https://github.com/ClickHouse/ClickHouse/pull/34275) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены поля client information `current_user` и `current_address` для межсерверного взаимодействия (ранее `current_user` и `current_address` сохранялись от предыдущего запроса). [#34263](https://github.com/ClickHouse/ClickHouse/pull/34263) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена утечка памяти в случае возникновения исключения во время обработки запроса при `optimize_aggregation_in_order=1`. [#34234](https://github.com/ClickHouse/ClickHouse/pull/34234) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена метрика `Query`, которая показывает число выполняемых запросов. В нескольких последних релизах она всегда показывала 0. [#34224](https://github.com/ClickHouse/ClickHouse/pull/34224) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлен вывод схемы для табличной функции `s3`. [#34186](https://github.com/ClickHouse/ClickHouse/pull/34186) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено редкое и безопасное состояние гонки в движках хранения `HDFS`, `S3` и `URL`, которое могло приводить к дополнительным подключениям. [#34172](https://github.com/ClickHouse/ClickHouse/pull/34172) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка, которая в редких случаях могла приводить к ошибке &quot;Cannot read all data&quot; при чтении столбцов LowCardinality таблиц семейства движков MergeTree, хранящих данные на удаленной файловой системе, такой как S3 (виртуальная файловая система поверх s3 является экспериментальной возможностью и не готова для использования в продакшене). [#34139](https://github.com/ClickHouse/ClickHouse/pull/34139) ([alesapin](https://github.com/alesapin)).
* Исправлены операции вставки в распределённые таблицы в случае изменения нативного протокола. Последнее изменение было в версии 22.1, поэтому после обновления до этой версии могли возникать ошибки при вставке в распределённые таблицы. [#34132](https://github.com/ClickHouse/ClickHouse/pull/34132) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена возможная гонка данных в движке таблицы `File`, которая появилась в [#33960](https://github.com/ClickHouse/ClickHouse/pull/33960). Закрывает [#34111](https://github.com/ClickHouse/ClickHouse/issues/34111). [#34113](https://github.com/ClickHouse/ClickHouse/pull/34113) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена незначительная гонка состояний, которая в крайне редких случаях после потери соединения с ZooKeeper могла приводить к ошибке &quot;intersecting parts&quot;. [#34096](https://github.com/ClickHouse/ClickHouse/pull/34096) ([tavplubix](https://github.com/tavplubix)).
* Исправлены проблемы с асинхронными вставками в формате `Native`. [#34068](https://github.com/ClickHouse/ClickHouse/pull/34068) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка, из-за которой не удавалось запустить сервер при одновременном использовании replicated access storage и keeper (встроенного в clickhouse-server). Добавлены две настройки тайм-аута сокета keeper вместо использования настроек пользователя по умолчанию: `keeper_server.socket_receive_timeout_sec` и `keeper_server.socket_send_timeout_sec`. Исправлена [#33973](https://github.com/ClickHouse/ClickHouse/issues/33973). [#33988](https://github.com/ClickHouse/ClickHouse/pull/33988) ([alesapin](https://github.com/alesapin)).
* Устранена ошибка сегментации при разборе ORC-файла с повреждённым футером. Закрывает [#33797](https://github.com/ClickHouse/ClickHouse/issues/33797). [#33984](https://github.com/ClickHouse/ClickHouse/pull/33984) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен разбор IPv6 из параметра запроса (подготовленные запросы) и исправлено преобразование IPv6 в строку. Закрывает [#33928](https://github.com/ClickHouse/ClickHouse/issues/33928). [#33971](https://github.com/ClickHouse/ClickHouse/pull/33971) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено падение при чтении вложенных кортежей. Исправляет [#33838](https://github.com/ClickHouse/ClickHouse/issues/33838). [#33956](https://github.com/ClickHouse/ClickHouse/pull/33956) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена работа функций `array` и `tuple` с литеральными аргументами в распределённых запросах. Ранее это могло приводить к исключению `Not found columns`. [#33938](https://github.com/ClickHouse/ClickHouse/pull/33938) ([Anton Popov](https://github.com/CurtizJ)).
* Комбинатор агрегатной функции `-If` некорректно обрабатывал аргумент фильтра с типом `Nullable`. Это закрывает [#27073](https://github.com/ClickHouse/ClickHouse/issues/27073). [#33920](https://github.com/ClickHouse/ClickHouse/pull/33920) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена потенциальная гонка при чтении с удалённого диска (виртуальная файловая система поверх S3 — экспериментальная функция, пока не готовая к использованию в продакшене). [#33912](https://github.com/ClickHouse/ClickHouse/pull/33912) ([Amos Bird](https://github.com/amosbird)).
* Исправлена ошибка, приводившая к сбою при создании SQL UDF с лямбда-выражением, аргументы которого не являются идентификаторами. Закрывает [#33866](https://github.com/ClickHouse/ClickHouse/issues/33866). [#33868](https://github.com/ClickHouse/ClickHouse/pull/33868) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлено поведение при использовании разреженных столбцов (которые могут быть включены экспериментальной настройкой `ratio_of_defaults_for_sparse_serialization`). [#33849](https://github.com/ClickHouse/ClickHouse/pull/33849) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена логическая ошибка `replica is not readonly` в запросе `SYSTEM RESTORE REPLICA`, возникавшая, если реплика фактически находилась в режиме только чтения. Решает проблему [#33806](https://github.com/ClickHouse/ClickHouse/issues/33806). [#33847](https://github.com/ClickHouse/ClickHouse/pull/33847) ([tavplubix](https://github.com/tavplubix)).
* Исправлена утечка памяти в `clickhouse-keeper` при использовании сжатия (по умолчанию). [#33840](https://github.com/ClickHouse/ClickHouse/pull/33840) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена проблема анализа индекса при отсутствии общих типов. [#33833](https://github.com/ClickHouse/ClickHouse/pull/33833) ([Amos Bird](https://github.com/amosbird)).
* Исправлен вывод схемы для `JSONEachRow` и `JSONCompactEachRow`. [#33830](https://github.com/ClickHouse/ClickHouse/pull/33830) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена работа внешних словарей с источником `redis` и большим количеством ключей. [#33804](https://github.com/ClickHouse/ClickHouse/pull/33804) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка в клиенте, которая приводила к &#39;Connection reset by peer&#39; на стороне сервера. Закрывает [#33309](https://github.com/ClickHouse/ClickHouse/issues/33309). [#33790](https://github.com/ClickHouse/ClickHouse/pull/33790) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлен разбор запроса вида INSERT INTO ... VALUES SETTINGS ... (...), ... [#33776](https://github.com/ClickHouse/ClickHouse/pull/33776) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка проверки таблицы при создании части данных в широком формате с проекцией. [#33774](https://github.com/ClickHouse/ClickHouse/pull/33774) ([李扬](https://github.com/taiyang-li)).
* Исправлена небольшая гонка между count() и INSERT/слияниями/... в MergeTree, из‑за которой для SELECT с optimize&#95;trivial&#95;count&#95;query могло возвращаться некорректное количество строк. [#33753](https://github.com/ClickHouse/ClickHouse/pull/33753) ([Azat Khuzhin](https://github.com/azat)).
* Выбрасывать исключение, если запрос на перечисление содержимого каталога в хранилище HDFS завершился с ошибкой. [#33724](https://github.com/ClickHouse/ClickHouse/pull/33724) ([LiuNeng](https://github.com/liuneng1994)).
* Исправлена обработка мутаций для таблиц, содержащих проекции. Это исправляет [#33010](https://github.com/ClickHouse/ClickHouse/issues/33010). Это исправляет [#33275](https://github.com/ClickHouse/ClickHouse/issues/33275). [#33679](https://github.com/ClickHouse/ClickHouse/pull/33679) ([Amos Bird](https://github.com/amosbird)).
* Обеспечивать корректное определение текущей базы данных, если `CREATE TEMPORARY TABLE AS SELECT` выполняется внутри именованной HTTP-сессии. Это крайне редкий сценарий использования. Закрывает [#8340](https://github.com/ClickHouse/ClickHouse/issues/8340). [#33676](https://github.com/ClickHouse/ClickHouse/pull/33676) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Разрешено выполнение некоторых запросов с сортировкой, LIMIT BY, ARRAY JOIN и лямбда-функциями. Это закрывает [#7462](https://github.com/ClickHouse/ClickHouse/issues/7462). [#33675](https://github.com/ClickHouse/ClickHouse/pull/33675) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка в «zero copy replication» (функция находится в разработке и не должна использоваться в продуктивной среде), приводившая к дублированию данных в случае перемещения по TTL. Исправляет [#33643](https://github.com/ClickHouse/ClickHouse/issues/33643). [#33642](https://github.com/ClickHouse/ClickHouse/pull/33642) ([alesapin](https://github.com/alesapin)).
* Исправлена ошибка `Chunk should have AggregatedChunkInfo in GroupingAggregatedTransform` (в случае `optimize_aggregation_in_order = 1`). [#33637](https://github.com/ClickHouse/ClickHouse/pull/33637) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка `Bad cast from type ... to DB::DataTypeArray`, которая могла возникать, когда в таблице имеется столбец типа `Nested` с точками в имени и для него генерируется значение по умолчанию (например, при вставке, когда столбец не указан). Продолжение [#28762](https://github.com/ClickHouse/ClickHouse/issues/28762). [#33588](https://github.com/ClickHouse/ClickHouse/pull/33588) ([Alexey Pavlenko](https://github.com/alexeypavlenko)).
* Исправлен экспорт в файлы `lz4`. Закрывает [#31421](https://github.com/ClickHouse/ClickHouse/issues/31421). [#31862](https://github.com/ClickHouse/ClickHouse/pull/31862) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлено потенциальное аварийное завершение работы, возникавшее, если `group_by_overflow_mode` был установлен в режим `any` (приблизительный GROUP BY) и агрегация выполнялась по одному столбцу типа `LowCardinality`. [#34506](https://github.com/ClickHouse/ClickHouse/pull/34506) ([DR](https://github.com/freedomDR)).
* Исправлена вставка во временные таблицы через клиент-серверный протокол gRPC. Это исправление устраняет [#34347](https://github.com/ClickHouse/ClickHouse/issues/34347), проблему `#2`. [#34364](https://github.com/ClickHouse/ClickHouse/pull/34364) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена ошибка [#19429](https://github.com/ClickHouse/ClickHouse/issues/19429). [#34225](https://github.com/ClickHouse/ClickHouse/pull/34225) ([Vitaly Baranov](https://github.com/vitlibar)).
* Исправлена проблема [#18206](https://github.com/ClickHouse/ClickHouse/issues/18206). [#33977](https://github.com/ClickHouse/ClickHouse/pull/33977) ([Vitaly Baranov](https://github.com/vitlibar)).
* Этот PR позволяет использовать несколько хранилищ LDAP в одном списке пользовательских директорий. Раньше это работало, но затем перестало, поскольку тесты LDAP отключены (они являются частью тестов testflows). [#33574](https://github.com/ClickHouse/ClickHouse/pull/33574) ([Vitaly Baranov](https://github.com/vitlibar)).

### <a id="221"></a> Релиз ClickHouse v22.1, 2022-01-18 {#a-id221a-clickhouse-release-v221-2022-01-18}

#### Примечания к обновлению {#upgrade-notes-4}

- Функции `left` и `right` ранее были реализованы в парсере, а теперь являются полнофункциональными. Распределённые запросы с функциями `left` или `right` без псевдонимов могут вызывать исключение, если кластер содержит разные версии clickhouse-server. Если вы обновляете кластер и столкнулись с этой ошибкой, необходимо завершить обновление кластера, чтобы все узлы имели одинаковую версию. Также можно добавить псевдонимы (`AS something`) к столбцам в запросах, чтобы избежать этой проблемы. [#33407](https://github.com/ClickHouse/ClickHouse/pull/33407) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Начиная с этой версии полностью учитывается использование ресурсов скалярными подзапросами. С этим изменением прочитанные строки в скалярных подзапросах теперь отображаются в query_log. Если скалярный подзапрос кэшируется (повторяется или вызывается для нескольких строк), прочитанные строки учитываются только один раз. Это изменение позволяет прерывать запросы командой KILL и отслеживать прогресс во время выполнения скалярных подзапросов. [#32271](https://github.com/ClickHouse/ClickHouse/pull/32271) ([Raúl Marín](https://github.com/Algunenano)).

#### Новые возможности {#new-feature-11}


* Реализовано автоопределение схемы данных для входных форматов. Разрешено не указывать структуру (или указывать просто `auto`) в табличных функциях `file`, `url`, `s3`, `hdfs` и в параметрах `clickhouse-local`. Разрешено не указывать структуру в запросе CREATE для движков таблиц `File`, `HDFS`, `S3`, `URL`, `Merge`, `Buffer`, `Distributed` и `ReplicatedMergeTree` (если добавляются новые реплики). [#32455](https://github.com/ClickHouse/ClickHouse/pull/32455) ([Kruglov Pavel](https://github.com/Avogar)).
* Определять формат по расширению файла в табличных функциях `file`/`hdfs`/`s3`/`url` и табличных движках `HDFS`/`S3`/`URL`, а также для `SELECT INTO OUTFILE` и `INSERT FROM INFILE` [#33565](https://github.com/ClickHouse/ClickHouse/pull/33565) ([Kruglov Pavel](https://github.com/Avogar)). Закрывает [#30918](https://github.com/ClickHouse/ClickHouse/issues/30918). [#33443](https://github.com/ClickHouse/ClickHouse/pull/33443) ([OnePiece](https://github.com/zhongyuankai)).
* Инструмент для сбора диагностических данных при обращении в службу поддержки. [#33175](https://github.com/ClickHouse/ClickHouse/pull/33175) ([Alexander Burmak](https://github.com/Alex-Burmak)).
* Автоматическое обнаружение кластера с помощью Zoo/Keeper. Это позволяет добавлять реплики в кластер без изменения конфигурации на каждом сервере. [#31442](https://github.com/ClickHouse/ClickHouse/pull/31442) ([vdimir](https://github.com/vdimir)).
* Реализован движок таблиц Hive для доступа к Apache Hive из ClickHouse. Реализация задачи: [#29245](https://github.com/ClickHouse/ClickHouse/issues/29245). [#31104](https://github.com/ClickHouse/ClickHouse/pull/31104) ([taiyang-li](https://github.com/taiyang-li)).
* Добавлены агрегатные функции `cramersV`, `cramersVBiasCorrected`, `theilsU` и `contingency`. Эти функции вычисляют зависимость (меру ассоциации) между категориальными значениями. Все эти функции в реализации используют кросс-таблицу (гистограмму по парам). Это можно представить как коэффициент корреляции, но для любых дискретных значений (не обязательно числовых). [#33366](https://github.com/ClickHouse/ClickHouse/pull/33366) ([alexey-milovidov](https://github.com/alexey-milovidov)). Первоначальная реализация от [Vanyok-All-is-OK](https://github.com/Vanyok-All-is-OK) и [antikvist](https://github.com/antikvist).
* Добавлена табличная функция `hdfsCluster`, которая позволяет параллельно обрабатывать файлы в HDFS со многих узлов заданного кластера, аналогично функции `s3Cluster`. [#32400](https://github.com/ClickHouse/ClickHouse/pull/32400) ([Zhichang Yu](https://github.com/yuzhichang)).
* Добавлена поддержка дисков с использованием Azure Blob Storage, аналогично тому, как она реализована для дисков на AWS S3. [#31505](https://github.com/ClickHouse/ClickHouse/pull/31505) ([Jakub Kuklis](https://github.com/jkuklis)).
* Добавлена поддержка `COMMENT` в `CREATE VIEW` (для всех типов представлений). [#31062](https://github.com/ClickHouse/ClickHouse/pull/31062) ([Vasily Nemkov](https://github.com/Enmk)).
* Динамически переинициализировать прослушиваемые порты и протоколы при изменении конфигурации. [#30549](https://github.com/ClickHouse/ClickHouse/pull/30549) ([Kevin Michel](https://github.com/kmichel-aiven)).
* Добавлены функции `left`, `right`, `leftUTF8`, `rightUTF8`. Исправлена ошибка в реализации функции `substringUTF8` при отрицательном смещении (отсчёт от конца строки). [#33407](https://github.com/ClickHouse/ClickHouse/pull/33407) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлены новые функции для координатной системы `H3`: `h3HexAreaKm2`, `h3CellAreaM2`, `h3CellAreaRads2`. [#33479](https://github.com/ClickHouse/ClickHouse/pull/33479) ([Bharat Nallan](https://github.com/bharatnc)).
* Добавлена функция `MONTHNAME`. [#33436](https://github.com/ClickHouse/ClickHouse/pull/33436) ([usurai](https://github.com/usurai)).
* Добавлена функция `arrayLast`. Закрыта задача [#33390](https://github.com/ClickHouse/ClickHouse/issues/33390). [#33415](https://github.com/ClickHouse/ClickHouse/pull/33415) Добавлена функция `arrayLastIndex`. [#33465](https://github.com/ClickHouse/ClickHouse/pull/33465) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлена функция `decodeURLFormComponent`, немного отличающаяся от `decodeURLComponent`. Закрыт [#10298](https://github.com/ClickHouse/ClickHouse/issues/10298). [#33451](https://github.com/ClickHouse/ClickHouse/pull/33451) ([SuperDJY](https://github.com/cmsxbc)).
* Добавлена возможность разделять правила свёртки `GraphiteMergeTree` для простых и тегированных метрик (необязательное поле rule&#95;type). [#33494](https://github.com/ClickHouse/ClickHouse/pull/33494) ([Michail Safronov](https://github.com/msaf1980)).

#### Улучшение производительности {#performance-improvement-11}

- Поддержка перемещения условий в `PREWHERE` (настройка `optimize_move_to_prewhere`) для таблиц движка `Merge`, если все базовые таблицы поддерживают `PREWHERE`. [#33300](https://github.com/ClickHouse/ClickHouse/pull/33300) ([Anton Popov](https://github.com/CurtizJ)).
- Более эффективная обработка шаблонов для хранилища URL. Теперь можно легко запрашивать миллионы URL параллельно с повторными попытками. Закрывает [#32866](https://github.com/ClickHouse/ClickHouse/issues/32866). [#32907](https://github.com/ClickHouse/ClickHouse/pull/32907) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Устранён экспоненциальный откат в парсере. Закрывает [#20158](https://github.com/ClickHouse/ClickHouse/issues/20158). [#33481](https://github.com/ClickHouse/ClickHouse/pull/33481) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Злоупотребление функцией `untuple` приводило к экспоненциальной сложности анализа запросов (обнаружено фаззером). Закрывает [#33297](https://github.com/ClickHouse/ClickHouse/issues/33297). [#33445](https://github.com/ClickHouse/ClickHouse/pull/33445) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Уменьшено потребление памяти для словарей со строковыми атрибутами. [#33466](https://github.com/ClickHouse/ClickHouse/pull/33466) ([Maksim Kita](https://github.com/kitaisreal)).
- Незначительное улучшение производительности функции `reinterpret`. [#32587](https://github.com/ClickHouse/ClickHouse/pull/32587) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Незначительное изменение. В крайне редких случаях, когда часть данных потеряна на каждой реплике, после слияния некоторых частей данных последующие запросы могут пропускать меньшее количество партиций при отсечении партиций. Это практически ни на что не влияет. [#32220](https://github.com/ClickHouse/ClickHouse/pull/32220) ([Azat Khuzhin](https://github.com/azat)).
- Улучшена производительность записи `clickhouse-keeper` путём оптимизации логики вычисления размера. [#32366](https://github.com/ClickHouse/ClickHouse/pull/32366) ([zhanglistar](https://github.com/zhanglistar)).
- Оптимизирована материализация проекции одной части. Закрывает [#31669](https://github.com/ClickHouse/ClickHouse/issues/31669). [#31885](https://github.com/ClickHouse/ClickHouse/pull/31885) ([Amos Bird](https://github.com/amosbird)).
- Улучшена производительность запросов к системным таблицам. [#33312](https://github.com/ClickHouse/ClickHouse/pull/33312) ([OnePiece](https://github.com/zhongyuankai)).
- Оптимизирован выбор частей MergeTree, которые могут быть перемещены между томами. [#33225](https://github.com/ClickHouse/ClickHouse/pull/33225) ([OnePiece](https://github.com/zhongyuankai)).
- Исправлена производительность словаря `sparse_hashed` с последовательными ключами (неправильная хеш-функция). [#32536](https://github.com/ClickHouse/ClickHouse/pull/32536) ([Azat Khuzhin](https://github.com/azat)).

#### Экспериментальная функциональность {#experimental-feature-10}


- Параллельное чтение из нескольких реплик внутри шарда при выполнении распределённого запроса без использования ключа сэмплирования. Чтобы включить эту функцию, установите `allow_experimental_parallel_reading_from_replicas = 1` и `max_parallel_replicas` в любое число. Это закрывает [#26748](https://github.com/ClickHouse/ClickHouse/issues/26748). [#29279](https://github.com/ClickHouse/ClickHouse/pull/29279) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Реализована разреженная сериализация. Она позволяет уменьшить использование дискового пространства и улучшить производительность некоторых запросов для столбцов, содержащих много значений по умолчанию (нулевых значений). Её можно включить, установив параметр `ratio_for_sparse_serialization`. Разреженная сериализация будет выбрана динамически для столбца, если соотношение количества значений по умолчанию к общему количеству значений превышает указанный порог. Тип сериализации (обычная или разреженная) фиксируется для каждого столбца в куске данных, но может различаться между кусками. [#22535](https://github.com/ClickHouse/ClickHouse/pull/22535) ([Anton Popov](https://github.com/CurtizJ)).
- Добавлена функция TABLE OVERRIDE для настройки схем таблиц MaterializedMySQL. [#32325](https://github.com/ClickHouse/ClickHouse/pull/32325) ([Stig Bakken](https://github.com/stigsb)).
- Добавлен запрос `EXPLAIN TABLE OVERRIDE`. [#32836](https://github.com/ClickHouse/ClickHouse/pull/32836) ([Stig Bakken](https://github.com/stigsb)).
- Добавлена поддержка конструкции TABLE OVERRIDE для MaterializedPostgreSQL. RFC: [#31480](https://github.com/ClickHouse/ClickHouse/issues/31480). [#32749](https://github.com/ClickHouse/ClickHouse/pull/32749) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Изменён путь ZooKeeper для меток нулевого копирования для общих данных. Обратите внимание, что репликация с нулевым копированием является экспериментальной функцией (на ранних стадиях разработки), которую не следует использовать в продакшене. Но если вы её использовали, учтите это изменение. [#32061](https://github.com/ClickHouse/ClickHouse/pull/32061) ([ianton-ru](https://github.com/ianton-ru)).
- Добавлена поддержка конструкции EVENTS для запросов WATCH в WINDOW VIEW. [#32607](https://github.com/ClickHouse/ClickHouse/pull/32607) ([vxider](https://github.com/Vxider)).
- Исправлена работа ACL с явным цифровым хешем в `clickhouse-keeper`: теперь поведение согласовано с ZooKeeper, и сгенерированный дайджест всегда принимается. [#33249](https://github.com/ClickHouse/ClickHouse/pull/33249) ([小路](https://github.com/nicelulu)). [#33246](https://github.com/ClickHouse/ClickHouse/pull/33246).
- Исправлено неожиданное удаление проекций при отсоединении кусков данных. [#32067](https://github.com/ClickHouse/ClickHouse/pull/32067) ([Amos Bird](https://github.com/amosbird)).

#### Улучшения {#improvement-11}


* Теперь функции преобразования даты и времени, которые вычисляют момент времени ранее `1970-01-01 00:00:00`, будут обнулять результат вместо переполнения. [#29953](https://github.com/ClickHouse/ClickHouse/pull/29953) ([Amos Bird](https://github.com/amosbird)). Также исправлена ошибка в анализе индекса, возникавшая, если функция усечения даты возвращала значение, предшествующее эпохе Unix.
* Всегда отображать использование ресурсов (общее использование CPU, общее использование RAM и максимальное использование RAM для каждого хоста) в клиенте. [#33271](https://github.com/ClickHouse/ClickHouse/pull/33271) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Улучшена сериализация и десериализация типа `Bool`, добавлена проверка корректности диапазона значений. [#32984](https://github.com/ClickHouse/ClickHouse/pull/32984) ([Kruglov Pavel](https://github.com/Avogar)).
* Если недопустимая настройка задана с помощью запроса `SET` или с использованием параметров HTTP‑запроса, сообщение об ошибке будет содержать подсказки с вариантами, похожими на строку недопустимой настройки (если такие существуют). [#32946](https://github.com/ClickHouse/ClickHouse/pull/32946) ([Antonio Andelic](https://github.com/antonio2368)).
* Добавлена поддержка подсказок при опечатках в именах настроек для clickhouse-client и clickhouse-local. Закрывает [#32237](https://github.com/ClickHouse/ClickHouse/issues/32237). [#32841](https://github.com/ClickHouse/ClickHouse/pull/32841) ([凌涛](https://github.com/lingtaolf)).
* Разрешить использование виртуальных столбцов в материализованных представлениях. Закрывает [#11210](https://github.com/ClickHouse/ClickHouse/issues/11210). [#33482](https://github.com/ClickHouse/ClickHouse/pull/33482) ([OnePiece](https://github.com/zhongyuankai)).
* Добавлена настройка для отключения IPv6 в clickhouse-keeper при необходимости. Тем самым закрывается [#33381](https://github.com/ClickHouse/ClickHouse/issues/33381). [#33450](https://github.com/ClickHouse/ClickHouse/pull/33450) ([Wu Xueyang](https://github.com/wuxueyang96)).
* Добавлена дополнительная информация в `system.build_options` о текущей ревизии Git. [#33431](https://github.com/ClickHouse/ClickHouse/pull/33431) ([taiyang-li](https://github.com/taiyang-li)).
* `clickhouse-local`: отслеживание использования памяти по параметру `--max_memory_usage_in_client`. [#33341](https://github.com/ClickHouse/ClickHouse/pull/33341) ([Azat Khuzhin](https://github.com/azat)).
* В функции `intervalLengthSum` теперь допускаются отрицательные интервалы. Их длина также будет учитываться. Это закрывает [#33323](https://github.com/ClickHouse/ClickHouse/issues/33323). [#33335](https://github.com/ClickHouse/ClickHouse/pull/33335) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `LineAsString` может использоваться в качестве формата вывода. Это закрывает [#30919](https://github.com/ClickHouse/ClickHouse/issues/30919). [#33331](https://github.com/ClickHouse/ClickHouse/pull/33331) ([Sergei Trifonov](https://github.com/serxa)).
* Поддерживается `<secure/>` в конфигурации кластера как альтернативный вариант `<secure>1</secure>`. Закрывает [#33270](https://github.com/ClickHouse/ClickHouse/issues/33270). [#33330](https://github.com/ClickHouse/ClickHouse/pull/33330) ([SuperDJY](https://github.com/cmsxbc)).
* Двойное нажатие клавиш Ctrl+C немедленно завершит работу `clickhouse-benchmark` без ожидания завершения текущих запросов. Это исправляет проблему [#32586](https://github.com/ClickHouse/ClickHouse/issues/32586). [#33303](https://github.com/ClickHouse/ClickHouse/pull/33303) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Добавлена поддержка Unix-меток времени с точностью до миллисекунд в функции `parseDateTimeBestEffort`. [#33276](https://github.com/ClickHouse/ClickHouse/pull/33276) ([Ben](https://github.com/benbiti)).
* Добавлена возможность отменять запрос при чтении данных из внешней таблицы в форматах `Arrow` / `Parquet` / `ORC` — ранее это не удавалось в случае больших файлов и параметра input&#95;format&#95;allow&#95;seeks = false. Закрывает [#29678](https://github.com/ClickHouse/ClickHouse/issues/29678). [#33238](https://github.com/ClickHouse/ClickHouse/pull/33238) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Если движок таблицы поддерживает предложение `SETTINGS`, можно передавать настройки в виде пар ключ–значение или через конфигурацию. Эта возможность добавлена для MySQL. [#33231](https://github.com/ClickHouse/ClickHouse/pull/33231) ([Kseniia Sumarokova](https://github.com/kssenii)).
* При необходимости корректно запрещать Nullable первичные ключи. Исправление для [#32780](https://github.com/ClickHouse/ClickHouse/issues/32780). [#33218](https://github.com/ClickHouse/ClickHouse/pull/33218) ([Amos Bird](https://github.com/amosbird)).
* Добавлена повторная попытка подключения к `PostgreSQL`, если ещё ничего не было получено. Закрывает [#33199](https://github.com/ClickHouse/ClickHouse/issues/33199). [#33209](https://github.com/ClickHouse/ClickHouse/pull/33209) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Валидация ключей конфигурации внешних словарей. [#33095](https://github.com/ClickHouse/ClickHouse/issues/33095#issuecomment-1000577517). [#33130](https://github.com/ClickHouse/ClickHouse/pull/33130) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отправка информации профиля внутри `clickhouse-local`. Закрывает [#33093](https://github.com/ClickHouse/ClickHouse/issues/33093). [#33097](https://github.com/ClickHouse/ClickHouse/pull/33097) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Укороченное вычисление выражений: поддержка функции `throwIf`. Закрывает [#32969](https://github.com/ClickHouse/ClickHouse/issues/32969). [#32973](https://github.com/ClickHouse/ClickHouse/pull/32973) ([Maksim Kita](https://github.com/kitaisreal)).
* (Это происходит только в неофициальных сборках). Исправлена ошибка, приводившая к сегфолту при вставке данных в сжатые столбцы Decimal, String, FixedString и Array. Закрывает [#32939](https://github.com/ClickHouse/ClickHouse/issues/32939). [#32940](https://github.com/ClickHouse/ClickHouse/pull/32940) ([N. Kolotov](https://github.com/nkolotov)).
* Добавлена поддержка использования подзапроса в качестве определяемой пользователем SQL-функции. Пример: `CREATE FUNCTION test AS () -> (SELECT 1)`. Закрывает [#30755](https://github.com/ClickHouse/ClickHouse/issues/30755). [#32758](https://github.com/ClickHouse/ClickHouse/pull/32758) ([Maksim Kita](https://github.com/kitaisreal)).
* Улучшена поддержка сжатия в gRPC для [#28671](https://github.com/ClickHouse/ClickHouse/issues/28671). [#32747](https://github.com/ClickHouse/ClickHouse/pull/32747) ([Vitaly Baranov](https://github.com/vitlibar)).
* При завершении работы сервера или отсоединении таблицы, когда журнал предзаписи (WAL) отключён, сбрасывать на диск все части данных, находящиеся в памяти. [#32742](https://github.com/ClickHouse/ClickHouse/pull/32742) ([nauta](https://github.com/nautaa)).
* Добавлена возможность управлять таймаутами подключения для MySQL (ранее поддерживалось только для источника словаря). Закрывает [#16669](https://github.com/ClickHouse/ClickHouse/issues/16669). Ранее значение по умолчанию для `connect_timeout` было довольно небольшим, теперь его можно настраивать. [#32734](https://github.com/ClickHouse/ClickHouse/pull/32734) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка параметра `authSource` для хранилища `MongoDB`. Закрывает [#32594](https://github.com/ClickHouse/ClickHouse/issues/32594). [#32702](https://github.com/ClickHouse/ClickHouse/pull/32702) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена поддержка типа `Date32` в табличной функции `genarateRandom`. [#32643](https://github.com/ClickHouse/ClickHouse/pull/32643) ([nauta](https://github.com/nautaa)).
* Добавлены настройки `max_concurrent_select_queries` и `max_concurrent_insert_queries` для управления числом одновременных запросов по типу запроса. Закрыта [#3575](https://github.com/ClickHouse/ClickHouse/issues/3575). [#32609](https://github.com/ClickHouse/ClickHouse/pull/32609) ([SuperDJY](https://github.com/cmsxbc)).
* Улучшена обработка вложенных структур с отсутствующими столбцами при чтении данных в формате `Protobuf`. Продолжение [https://github.com/ClickHouse/ClickHouse/pull/31988](https://github.com/ClickHouse/ClickHouse/pull/31988). [#32531](https://github.com/ClickHouse/ClickHouse/pull/32531) ([Vitaly Baranov](https://github.com/vitlibar)).
* Разрешено использование пустых учетных данных для движка `MongoDB`. Закрывает [#26267](https://github.com/ClickHouse/ClickHouse/issues/26267). [#32460](https://github.com/ClickHouse/ClickHouse/pull/32460) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Отключены некоторые оптимизации оконных функций, которые могли приводить к исключениям. Закрыта задача [#31535](https://github.com/ClickHouse/ClickHouse/issues/31535). Закрыта задача [#31620](https://github.com/ClickHouse/ClickHouse/issues/31620). [#32453](https://github.com/ClickHouse/ClickHouse/pull/32453) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена возможность подключения к MongoDB 5.0. Закрывает задачи [#31483](https://github.com/ClickHouse/ClickHouse/issues/31483), [#32416](https://github.com/ClickHouse/ClickHouse/pull/32416) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Добавлена возможность сравнения между `Decimal` и `Float`. Закрывает [#22626](https://github.com/ClickHouse/ClickHouse/issues/22626). [#31966](https://github.com/ClickHouse/ClickHouse/pull/31966) ([flynn](https://github.com/ucasFL)).
* Добавлены настройки `command_read_timeout`, `command_write_timeout` для `StorageExecutable`, `StorageExecutablePool`, `ExecutableDictionary`, `ExecutablePoolDictionary`, `ExecutableUserDefinedFunctions`. Настройка `command_read_timeout` задает таймаут чтения данных из stdout команды в миллисекундах. Настройка `command_write_timeout` задает таймаут записи данных в stdin команды в миллисекундах. Добавлена настройка `command_termination_timeout` для `ExecutableUserDefinedFunction`, `ExecutableDictionary`, `StorageExecutable`. Добавлена настройка `execute_direct` для `ExecutableUserDefinedFunction`, по умолчанию имеет значение true. Добавлена настройка `execute_direct` для `ExecutableDictionary`, `ExecutablePoolDictionary`, по умолчанию имеет значение false. [#30957](https://github.com/ClickHouse/ClickHouse/pull/30957) ([Maksim Kita](https://github.com/kitaisreal)).
* Функции агрегирования Bitmap теперь возвращают корректный результат для аргументов вне диапазона вместо циклического перехода значения (wraparound). [#33127](https://github.com/ClickHouse/ClickHouse/pull/33127) ([DR](https://github.com/freedomDR)).
* Исправлена ошибка разбора некорректных запросов с оператором `FROM INFILE`. [#33521](https://github.com/ClickHouse/ClickHouse/pull/33521) ([Kruglov Pavel](https://github.com/Avogar)).
* Запрещена запись в `S3`, если путь содержит glob-шаблоны. [#33142](https://github.com/ClickHouse/ClickHouse/pull/33142) ([Kruglov Pavel](https://github.com/Avogar)).
* Опция `--echo` не использовалась клиентом `clickhouse-client` в пакетном режиме при выполнении одного запроса. [#32843](https://github.com/ClickHouse/ClickHouse/pull/32843) ([N. Kolotov](https://github.com/nkolotov)).
* Используйте параметр `--database` в clickhouse-local. [#32797](https://github.com/ClickHouse/ClickHouse/pull/32797) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлен на удивление плохой код в обычной SQL-функции `file`. Теперь она поддерживает символьные ссылки. [#32640](https://github.com/ClickHouse/ClickHouse/pull/32640) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Обновление `modification_time` для части данных в `system.parts` после перемещения части [#32964](https://github.com/ClickHouse/ClickHouse/issues/32964). [#32965](https://github.com/ClickHouse/ClickHouse/pull/32965) ([save-my-heart](https://github.com/save-my-heart)).
* Потенциальная проблема, не приводящая к уязвимости: при изменении размера массива возможно переполнение целого типа. [#33024](https://github.com/ClickHouse/ClickHouse/pull/33024) ([varadarajkumar](https://github.com/varadarajkumar)).

#### Улучшения сборки/тестирования/упаковки {#buildtestingpackaging-improvement-11}

- Добавлены пакеты, функциональные тесты и Docker-сборки для версии ClickHouse под AArch64 (ARM). [#32911](https://github.com/ClickHouse/ClickHouse/pull/32911) ([Mikhail f. Shiryaev](https://github.com/Felixoid)). [#32415](https://github.com/ClickHouse/ClickHouse/pull/32415)
- Подготовлена возможность сборки ClickHouse с musl-libc. По умолчанию не включена. [#33134](https://github.com/ClickHouse/ClickHouse/pull/33134) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Обеспечена работоспособность установочного скрипта на FreeBSD. Закрывает [#33384](https://github.com/ClickHouse/ClickHouse/issues/33384). [#33418](https://github.com/ClickHouse/ClickHouse/pull/33418) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Добавлен `actionlint` для рабочих процессов GitHub Actions и проверка файлов рабочих процессов через `act --list` для контроля корректности синтаксиса. [#33612](https://github.com/ClickHouse/ClickHouse/pull/33612) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- Добавлено больше тестов для функциональности nullable первичных ключей. Добавлены тесты с различными типами и видами merge tree, а также со случайно сгенерированными данными. [#33228](https://github.com/ClickHouse/ClickHouse/pull/33228) ([Amos Bird](https://github.com/amosbird)).
- Добавлен простой инструмент для визуализации нестабильных тестов в веб-браузере. [#33185](https://github.com/ClickHouse/ClickHouse/pull/33185) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- Включена герметичная сборка для shared-сборок. Это в основном для разработчиков. [#32968](https://github.com/ClickHouse/ClickHouse/pull/32968) ([Amos Bird](https://github.com/amosbird)).
- Обновлены `libc++` и `libc++abi` до последних версий. [#32484](https://github.com/ClickHouse/ClickHouse/pull/32484) ([Raúl Marín](https://github.com/Algunenano)).
- Добавлен интеграционный тест для внешнего .NET-клиента ([ClickHouse.Client](https://github.com/DarkWanderer/ClickHouse.Client)). [#23230](https://github.com/ClickHouse/ClickHouse/pull/23230) ([Oleg V. Kozlyuk](https://github.com/DarkWanderer)).
- Внедрена git-информация в бинарный файл clickhouse. Теперь можно легко получить ревизию исходного кода из бинарного файла clickhouse. [#33124](https://github.com/ClickHouse/ClickHouse/pull/33124) ([taiyang-li](https://github.com/taiyang-li)).
- Удален устаревший код из ConfigProcessor. Специфичный для Yandex код больше не используется. Код содержал один незначительный дефект. Этот дефект был обнаружен [Mallik Hassan](https://github.com/SadiHassan) в [#33032](https://github.com/ClickHouse/ClickHouse/issues/33032). Закрывает [#33032](https://github.com/ClickHouse/ClickHouse/issues/33032). [#33026](https://github.com/ClickHouse/ClickHouse/pull/33026) ([alexey-milovidov](https://github.com/alexey-milovidov)).

#### Исправление ошибок (видимые пользователю проблемы в официальных стабильных или предварительных релизах) {#bug-fix-user-visible-misbehavior-in-official-stable-or-prestable-release-4}


* Несколько исправлений разбора форматов. Это актуально, если злоумышленнику предоставлен доступ на запись к `clickhouse-server`. Специально сформированные входные данные для формата `Native` могут приводить к чтению неинициализированной памяти или сбою. Это актуально, если злоумышленнику предоставлен доступ на запись к `clickhouse-server`. [#33050](https://github.com/ClickHouse/ClickHouse/pull/33050) ([Heena Bansal](https://github.com/HeenaBansal2009)). Исправлена проблема выхода за границы индекса Union-типа Apache Avro в двоичном формате Apache Avro. [#33022](https://github.com/ClickHouse/ClickHouse/pull/33022) ([Harry Lee](https://github.com/HarryLeeIBM)). Исправлено разыменование нулевого указателя в данных `LowCardinality` при десериализации данных `LowCardinality` в формате `Native`. [#33021](https://github.com/ClickHouse/ClickHouse/pull/33021) ([Harry Lee](https://github.com/HarryLeeIBM)).
* Обработчик ClickHouse Keeper теперь корректно удаляет операцию после отправки ответа. [#32988](https://github.com/ClickHouse/ClickHouse/pull/32988) ([JackyWoo](https://github.com/JackyWoo)).
* Потенциальная ошибка off-by-one при вычислении квот: лимит квоты формально ещё не был достигнут, но уже считался превышенным. Это исправляет [#31174](https://github.com/ClickHouse/ClickHouse/issues/31174). [#31656](https://github.com/ClickHouse/ClickHouse/pull/31656) ([sunny](https://github.com/sunny19930321)).
* Исправлено преобразование (CAST) из String в IPv4 или IPv6 и обратно. Исправлено сообщение об ошибке в случае неуспешного преобразования. [#29224](https://github.com/ClickHouse/ClickHouse/pull/29224) ([Dmitry Novik](https://github.com/novikd)) [#27914](https://github.com/ClickHouse/ClickHouse/pull/27914) ([Vasily Nemkov](https://github.com/Enmk)).
* Устранено исключение вида `Unknown aggregate function nothing` при выполнении на удалённом сервере. Это исправление закрывает [#16689](https://github.com/ClickHouse/ClickHouse/issues/16689). [#26074](https://github.com/ClickHouse/ClickHouse/pull/26074) ([hexiaoting](https://github.com/hexiaoting)).
* Исправлен выбор неверной базы данных для JOIN без явного указания базы данных в распределённых запросах (исправляет: [#10471](https://github.com/ClickHouse/ClickHouse/issues/10471)). [#33611](https://github.com/ClickHouse/ClickHouse/pull/33611) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена ошибка сегментации (segfault) в формате Apache `Avro`, возникающая после второй вставки в файл. [#33566](https://github.com/ClickHouse/ClickHouse/pull/33566) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка сегментации в формате Apache `Arrow`, возникающая, если схема содержит тип `Dictionary`. Закрывает [#33507](https://github.com/ClickHouse/ClickHouse/issues/33507). [#33529](https://github.com/ClickHouse/ClickHouse/pull/33529) ([Kruglov Pavel](https://github.com/Avogar)).
* Настройки `offset` и `limit`, заданные вне запроса, могут быть некорректно применены к представлениям. Закрыты задачи [#33289](https://github.com/ClickHouse/ClickHouse/issues/33289) и [#33518](https://github.com/ClickHouse/ClickHouse/pull/33518) ([hexiaoting](https://github.com/hexiaoting)).
* Исправлено исключение `Block structure mismatch`, которое могло возникать при вставке в таблицу с вложенным столбцом `LowCardinality` со значением по умолчанию. Исправляет [#33028](https://github.com/ClickHouse/ClickHouse/issues/33028). [#33504](https://github.com/ClickHouse/ClickHouse/pull/33504) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлены выражения словаря для атрибутов минимальной и максимальной границ диапазона (`range min` и `range max`) в словарях типа `range_hashed` при создании через DDL. Закрывает [#30809](https://github.com/ClickHouse/ClickHouse/issues/30809). [#33478](https://github.com/ClickHouse/ClickHouse/pull/33478) ([Maksim Kita](https://github.com/kitaisreal)).
* Исправлена возможная ошибка типа use-after-free при операции INSERT в материализованное представление при одновременном выполнении операции DROP ([Azat Khuzhin](https://github.com/azat)).
* Не пытайтесь читать за пределами EOF (в качестве обходного пути для ошибки в ядре Linux). Эту ошибку можно воспроизвести в ядрах Linux версий 3.14–5.9; для этого требуется `index_granularity_bytes=0` (т. е. отключение адаптивной зернистости индекса). [#33372](https://github.com/ClickHouse/ClickHouse/pull/33372) ([Azat Khuzhin](https://github.com/azat)).
* Для команд `SYSTEM SUSPEND` и `SYSTEM ... THREAD FUZZER` отсутствовал контроль доступа. Проблема исправлена. Автор: Kevin Michel. [#33333](https://github.com/ClickHouse/ClickHouse/pull/33333) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлена ошибка, из-за которой `COMMENT` для словарей не отображался в `system.tables`, `system.dictionaries`. Добавлена возможность изменять комментарий для движка `Dictionary`. Закрывает [#33251](https://github.com/ClickHouse/ClickHouse/issues/33251). [#33261](https://github.com/ClickHouse/ClickHouse/pull/33261) ([Maksim Kita](https://github.com/kitaisreal)).
* Добавлены в журнал запросов асинхронные вставки (при включённой настройке `async_insert`). Ранее такие запросы не попадали в журнал запросов. [#33239](https://github.com/ClickHouse/ClickHouse/pull/33239) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена проблема с отправкой выражений `WHERE 1 = 0` для запросов к внешним базам данных. Закрывает [#33152](https://github.com/ClickHouse/ClickHouse/issues/33152). [#33214](https://github.com/ClickHouse/ClickHouse/pull/33214) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проверка DDL для MaterializedPostgreSQL. Исправлена настройка `materialized_postgresql_allow_automatic_update`. Закрывает [#29535](https://github.com/ClickHouse/ClickHouse/issues/29535). [#33200](https://github.com/ClickHouse/ClickHouse/pull/33200) ([Kseniia Sumarokova](https://github.com/kssenii)). Обеспечено, что неиспользуемые replication slots всегда удаляются. Обнаружено в [#26952](https://github.com/ClickHouse/ClickHouse/issues/26952). [#33187](https://github.com/ClickHouse/ClickHouse/pull/33187) ([Kseniia Sumarokova](https://github.com/kssenii)). Исправлено отсоединение/подключение (удаление/добавление в репликацию) таблиц с нестандартной схемой в MaterializedPostreSQL. Обнаружено в [#29535](https://github.com/ClickHouse/ClickHouse/issues/29535). [#33179](https://github.com/ClickHouse/ClickHouse/pull/33179) ([Kseniia Sumarokova](https://github.com/kssenii)). Исправлена операция `DROP` базы данных MaterializedPostgreSQL. [#33468](https://github.com/ClickHouse/ClickHouse/pull/33468) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Метрика `StorageBufferBytes` иногда рассчитывалась некорректно. [#33159](https://github.com/ClickHouse/ClickHouse/pull/33159) ([xuyatian](https://github.com/xuyatian)).
* Исправлена ошибка `Invalid version for SerializationLowCardinality key column` при чтении из столбца `LowCardinality`, когда включены настройки `local_filesystem_read_prefetch` или `remote_filesystem_read_prefetch`. [#33046](https://github.com/ClickHouse/ClickHouse/pull/33046) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена ошибка функции таблицы `s3` при чтении пустого файла. Закрывает [#33008](https://github.com/ClickHouse/ClickHouse/issues/33008). [#33037](https://github.com/ClickHouse/ClickHouse/pull/33037) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена утечка контекста в случае `cancel_http_readonly_queries_on_client_close` (т. е. утечка внешних таблиц, которые были загружены на сервер, и других ресурсов). [#32982](https://github.com/ClickHouse/ClickHouse/pull/32982) ([Azat Khuzhin](https://github.com/azat)).
* Исправлен некорректный вывод кортежей в формате `CSV` при использовании пользовательского разделителя CSV. [#32981](https://github.com/ClickHouse/ClickHouse/pull/32981) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена проверка URL HDFS, из-за которой нельзя было использовать адрес NameNode в конфигурации HA. Ошибка появилась в [https://github.com/ClickHouse/ClickHouse/pull/31042](https://github.com/ClickHouse/ClickHouse/pull/31042). [#32976](https://github.com/ClickHouse/ClickHouse/pull/32976) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка, при которой для непозиционных аргументов выбрасывалось исключение вида positional argument out of bounds. Закрывает [#31173](https://github.com/ClickHouse/ClickHouse/issues/31173)#event-5789668239. [#32961](https://github.com/ClickHouse/ClickHouse/pull/32961) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлено неопределённое поведение (UB) в случае неожиданного EOF при заполнении множества из HTTP-запроса (если клиент прервал соединение в середине, например при выполнении `timeout 0.15s curl -Ss -F 's=@t.csv;' 'http://127.0.0.1:8123/?s_structure=key+Int&query=SELECT+dummy+IN+s'` и при достаточно большом `t.csv`). [#32955](https://github.com/ClickHouse/ClickHouse/pull/32955) ([Azat Khuzhin](https://github.com/azat)).
* Исправлена регрессия в функции `replaceRegexpAll`. Функция работала некорректно, когда совпавшая подстрока была пустой. Закрывает [#32777](https://github.com/ClickHouse/ClickHouse/issues/32777). Закрывает [#30245](https://github.com/ClickHouse/ClickHouse/issues/30245). [#32945](https://github.com/ClickHouse/ClickHouse/pull/32945) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлено чтение страйпов в формате `ORC`. [#32929](https://github.com/ClickHouse/ClickHouse/pull/32929) ([kreuzerkrieg](https://github.com/kreuzerkrieg)).
* `topKWeightedState` завершался с ошибкой для некоторых типов входных данных. [#32487](https://github.com/ClickHouse/ClickHouse/issues/32487). [#32914](https://github.com/ClickHouse/ClickHouse/pull/32914) ([vdimir](https://github.com/vdimir)).
* Исправлено исключение `Single chunk is expected from view inner query (LOGICAL_ERROR)` в материализованном представлении. Устраняет проблему [#31419](https://github.com/ClickHouse/ClickHouse/issues/31419). [#32862](https://github.com/ClickHouse/ClickHouse/pull/32862) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена оптимизация с отложенным seek для асинхронного чтения из удалённых файловых систем. Закрывает [#32803](https://github.com/ClickHouse/ClickHouse/issues/32803). [#32835](https://github.com/ClickHouse/ClickHouse/pull/32835) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Движок таблиц `MergeTree` мог незаметно пропускать некоторые мутации при слишком большом числе выполняющихся мутаций или при высоком потреблении памяти, ошибка исправлена. Исправляет [#17882](https://github.com/ClickHouse/ClickHouse/issues/17882). [#32814](https://github.com/ClickHouse/ClickHouse/pull/32814) ([tavplubix](https://github.com/tavplubix)).
* Избегайте повторного использования кэша скалярных подзапросов при обработке блоков MV. Это исправляет ошибку, когда скалярный подзапрос обращается к исходной таблице, но приводит к тому, что все скалярные подзапросы в определении MV будут вычисляться для каждого блока. [#32811](https://github.com/ClickHouse/ClickHouse/pull/32811) ([Raúl Marín](https://github.com/Algunenano)).
* Сервер мог не запуститься, если база данных с движком `MySQL` не могла подключиться к серверу MySQL; это исправлено. Исправляет [#14441](https://github.com/ClickHouse/ClickHouse/issues/14441). [#32802](https://github.com/ClickHouse/ClickHouse/pull/32802) ([tavplubix](https://github.com/tavplubix)).
* Исправлен сбой при использовании функции `fuzzBits`, закрыта задача [#32737](https://github.com/ClickHouse/ClickHouse/issues/32737). [#32755](https://github.com/ClickHouse/ClickHouse/pull/32755) ([SuperDJY](https://github.com/cmsxbc)).
* Исправлена ошибка `Column is not under aggregate function` в случае материализованного представления с `GROUP BY (list of columns)` (которое парсится как `GROUP BY tuple(...)`) поверх `Kafka`/`RabbitMQ`. Исправлены [#32668](https://github.com/ClickHouse/ClickHouse/issues/32668) и [#32744](https://github.com/ClickHouse/ClickHouse/issues/32744). [#32751](https://github.com/ClickHouse/ClickHouse/pull/32751) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлена работа запроса `ALTER TABLE ... MATERIALIZE TTL` с режимами `TTL ... DELETE WHERE ...` и `TTL ... GROUP BY ...`. [#32695](https://github.com/ClickHouse/ClickHouse/pull/32695) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена оптимизация `optimize_read_in_order` в случае, когда движок таблицы — `Distributed` или `Merge`, а ее базовые таблицы `MergeTree` имеют монотонную функцию в префиксной части ключа сортировки. [#32670](https://github.com/ClickHouse/ClickHouse/pull/32670) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлено исключение LOGICAL&#95;ERROR, возникавшее, когда целевой таблицей материализованного представления являлась таблица JOIN или SET. [#32669](https://github.com/ClickHouse/ClickHouse/pull/32669) ([Raúl Marín](https://github.com/Algunenano)).
* При вставке в S3 с использованием multipart-загрузки в Google Cloud Storage может происходить отмена загрузки. [#32504](https://github.com/ClickHouse/ClickHouse/issues/32504). [#32649](https://github.com/ClickHouse/ClickHouse/pull/32649) ([vdimir](https://github.com/vdimir)).
* Исправлено возможное исключение при запуске хранилища `RabbitMQ` за счёт отложенного создания канала. [#32584](https://github.com/ClickHouse/ClickHouse/pull/32584) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Исправлена проблема с временем жизни таблицы (т.е. возможное use-after-free) при параллельном выполнении DROP TABLE и INSERT. [#32572](https://github.com/ClickHouse/ClickHouse/pull/32572) ([Azat Khuzhin](https://github.com/azat)).
* Исправлены асинхронные вставки с форматами `CustomSeparated`, `Template`, `Regexp`, `MsgPack` и `JSONAsString`. Ранее асинхронные вставки с этими форматами не считывали данные. [#32530](https://github.com/ClickHouse/ClickHouse/pull/32530) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена функция `groupBitmapAnd` для распределённых таблиц. [#32529](https://github.com/ClickHouse/ClickHouse/pull/32529) ([minhthucdao](https://github.com/dmthuc)).
* Исправлен краш при выполнении JOIN, обнаруженный фаззером; закрыта [#32458](https://github.com/ClickHouse/ClickHouse/issues/32458). [#32508](https://github.com/ClickHouse/ClickHouse/pull/32508) ([vdimir](https://github.com/vdimir)).
* Корректная обработка ситуации с дублированием столбцов формата Apache Arrow. [#32507](https://github.com/ClickHouse/ClickHouse/pull/32507) ([Dmitriy Mokhnatkin](https://github.com/DMokhnatkin)).
* Исправлена проблема с неоднозначным форматированием распределённых запросов, приводившая к ошибкам, когда некоторые столбцы таблицы имели имена `ALL` или `DISTINCT`. Это закрывает [#32391](https://github.com/ClickHouse/ClickHouse/issues/32391). [#32490](https://github.com/ClickHouse/ClickHouse/pull/32490) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Исправлены сбои в запросах при попытке использовать ещё не материализованные skipping-индексы. Устраняет [#32292](https://github.com/ClickHouse/ClickHouse/issues/32292) и [#30343](https://github.com/ClickHouse/ClickHouse/issues/30343). [#32359](https://github.com/ClickHouse/ClickHouse/pull/32359) ([Anton Popov](https://github.com/CurtizJ)).
* Исправлена ошибка в запросах SELECT, проявлявшаяся при наличии более двух политик строкового уровня для одного и того же столбца, начиная со второго запроса в той же сессии. [#31606](https://github.com/ClickHouse/ClickHouse/issues/31606). [#32291](https://github.com/ClickHouse/ClickHouse/pull/32291) ([SuperDJY](https://github.com/cmsxbc)).
* Исправлено преобразование дробного Unix-таймстампа в `DateTime64`: дробная часть инвертировалась для отрицательных Unix-таймстампов (до 1970-01-01). [#32240](https://github.com/ClickHouse/ClickHouse/pull/32240) ([Ben](https://github.com/benbiti)).
* Некоторые записи очереди репликации могли зависать на время, равное `temporary_directories_lifetime` (по умолчанию 1 день), с ошибкой `Directory tmp_merge_<part_name>` или `Part ... (state Deleting) already exists, but it will be deleted soon` или похожим сообщением. Это исправлено. Исправлена проблема [#29616](https://github.com/ClickHouse/ClickHouse/issues/29616). [#32201](https://github.com/ClickHouse/ClickHouse/pull/32201) ([tavplubix](https://github.com/tavplubix)).
* Исправлен парсинг трансформера столбца `APPLY lambda`, который мог приводить к сбою клиента или сервера. [#32138](https://github.com/ClickHouse/ClickHouse/pull/32138) ([Kruglov Pavel](https://github.com/Avogar)).
* Исправлена ошибка, из-за которой функция `base64Encode` добавляла лишние байты к коротким строкам. [#31797](https://github.com/ClickHouse/ClickHouse/pull/31797) ([Kevin Michel](https://github.com/kmichel-aiven)).
* Исправлено возможное падение (или получение некорректного результата) при использовании аргументов типа `LowCardinality` в оконной функции. Исправляет [#31114](https://github.com/ClickHouse/ClickHouse/issues/31114). [#31888](https://github.com/ClickHouse/ClickHouse/pull/31888) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Исправлено зависание при выполнении команды `DROP TABLE system.query_log sync`. [#33293](https://github.com/ClickHouse/ClickHouse/pull/33293) ([zhanghuajie](https://github.com/zhanghuajieHIT)).





## [Журнал изменений за 2021 год](./2021.md) {#changelog-for-2021}
