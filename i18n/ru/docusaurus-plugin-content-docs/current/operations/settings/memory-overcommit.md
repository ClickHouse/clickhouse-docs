---
description: 'Экспериментальный механизм, позволяющий более гибко задавать
  ограничения по памяти для запросов.'
slug: /operations/settings/memory-overcommit
title: 'Оверкоммит памяти'
doc_type: 'reference'
---



# Оверкоммит памяти (memory overcommit)

Оверкоммит памяти — экспериментальная техника, позволяющая более гибко настраивать лимиты памяти для запросов.

Идея этой техники заключается во введении настроек, которые задают гарантированный объем памяти, доступный запросу.
Когда оверкоммит памяти включен и лимит памяти достигнут, ClickHouse выбирает запрос с наибольшим «перерасходом» памяти и пытается освободить память, завершив этот запрос.

Когда лимит памяти достигнут, любой запрос в течение некоторого времени ожидает успешного выделения дополнительной памяти.
Если за время ожидания память освобождается, запрос продолжает выполнение.
В противном случае выбрасывается исключение, и запрос завершается.

Выбор запроса для остановки или завершения выполняется либо глобальным, либо пользовательским трекером оверкоммита, в зависимости от того, какой лимит памяти был достигнут.
Если трекер оверкоммита не может выбрать запрос для остановки, генерируется исключение MEMORY_LIMIT_EXCEEDED.



## Трекер превышения лимитов пользователя {#user-overcommit-tracker}

Трекер превышения лимитов пользователя находит запрос с наибольшим коэффициентом превышения в списке запросов пользователя.
Коэффициент превышения для запроса вычисляется как количество выделенных байтов, делённое на значение настройки `memory_overcommit_ratio_denominator_for_user`.

Если `memory_overcommit_ratio_denominator_for_user` для запроса равен нулю, трекер превышения лимитов не выберет этот запрос.

Тайм-аут ожидания задаётся настройкой `memory_usage_overcommit_max_wait_microseconds`.

**Пример**

```sql
SELECT number FROM numbers(1000) GROUP BY number SETTINGS memory_overcommit_ratio_denominator_for_user=4000, memory_usage_overcommit_max_wait_microseconds=500
```


## Глобальный трекер превышения лимитов {#global-overcommit-tracker}

Глобальный трекер превышения лимитов находит запрос с наибольшим коэффициентом превышения среди всех запросов.
В данном случае коэффициент превышения вычисляется как количество выделенных байтов, делённое на значение настройки `memory_overcommit_ratio_denominator`.

Если `memory_overcommit_ratio_denominator` для запроса равен нулю, трекер превышения лимитов не выберет этот запрос.

Тайм-аут ожидания задаётся параметром `memory_usage_overcommit_max_wait_microseconds` в конфигурационном файле.
