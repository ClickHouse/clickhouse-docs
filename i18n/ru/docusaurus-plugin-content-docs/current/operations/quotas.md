---
description: 'Руководство по настройке и управлению квотами использования ресурсов в ClickHouse'
sidebar_label: 'Квоты'
sidebar_position: 51
slug: /operations/quotas
title: 'Квоты'
doc_type: 'guide'
---

:::note Квоты в ClickHouse Cloud
Квоты поддерживаются в ClickHouse Cloud, но должны создаваться с помощью [DDL-синтаксиса](/sql-reference/statements/create/quota). Подход с XML-конфигурацией, описанный ниже, **не поддерживается**.
:::

Квоты позволяют ограничивать использование ресурсов за определённый период времени или отслеживать их использование.
Квоты настраиваются в конфигурации пользователей, которая обычно называется &#39;users.xml&#39;.

В системе также предусмотрена возможность ограничения сложности отдельного запроса. См. раздел [Ограничения на сложность запроса](../operations/settings/query-complexity.md).

В отличие от ограничений на сложность запросов, квоты:

* Накладывают ограничения на набор запросов, которые могут выполняться за определённый период времени, а не на отдельный запрос.
* Учитывают ресурсы, затраченные на всех удалённых серверах при распределённой обработке запросов.

Рассмотрим фрагмент файла &#39;users.xml&#39;, который определяет квоты.

```xml
<!-- Квоты -->
<quotas>
    <!-- Название квоты. -->
    <default>
        <!-- Ограничения для временного периода. Можно задать несколько интервалов с различными ограничениями. -->
        <interval>
            <!-- Длительность интервала. -->
            <duration>3600</duration>

            <!-- Без ограничений. Только сбор данных за указанный интервал времени. -->
            <queries>0</queries>
            <query_selects>0</query_selects>
            <query_inserts>0</query_inserts>
            <errors>0</errors>
            <result_rows>0</result_rows>
            <read_rows>0</read_rows>
            <execution_time>0</execution_time>
        </interval>
    </default>
```

По умолчанию квота отслеживает почасовое потребление ресурсов, не ограничивая использование.
Потребление ресурсов, рассчитанное для каждого интервала, выводится в журнал сервера после каждого запроса.

```xml
<statbox>
    <!-- Ограничения для временного периода. Можно задать несколько интервалов с различными ограничениями. -->
    <interval>
        <!-- Длительность интервала. -->
        <duration>3600</duration>

        <queries>1000</queries>
        <query_selects>100</query_selects>
        <query_inserts>100</query_inserts>
        <written_bytes>5000000</written_bytes>
        <errors>100</errors>
        <result_rows>1000000000</result_rows>
        <read_rows>100000000000</read_rows>
        <execution_time>900</execution_time>
        <failed_sequential_authentications>5</failed_sequential_authentications>
    </interval>

    <interval>
        <duration>86400</duration>

        <queries>10000</queries>
        <query_selects>10000</query_selects>
        <query_inserts>10000</query_inserts>
        <errors>1000</errors>
        <result_rows>5000000000</result_rows>
        <result_bytes>160000000000</result_bytes>
        <read_rows>500000000000</read_rows>
        <result_bytes>16000000000000</result_bytes>
        <execution_time>7200</execution_time>
    </interval>
</statbox>
```

Для квоты &#39;statbox&#39; ограничения задаются на каждый час и на каждые 24 часа (86 400 секунд). Отсчет временного интервала ведётся, начиная с фиксированного момента времени, определяемого реализацией. Другими словами, 24-часовой интервал не обязательно начинается в полночь.

Когда интервал заканчивается, все накопленные значения сбрасываются. В следующий час вычисление квоты начинается заново.

Ниже перечислены показатели, для которых могут задаваться ограничения:

`queries` – общее количество запросов.

`query_selects` – общее количество запросов типа SELECT.

`query_inserts` – общее количество запросов типа INSERT.

`errors` – количество запросов, завершившихся исключением.

`result_rows` – общее количество строк, возвращённых в результате.

`result_bytes` – общий объём данных, возвращённых в результате.

`read_rows` – общее количество исходных строк, прочитанных из таблиц для выполнения запроса на всех удалённых серверах.

`read_bytes` – общий объём данных, прочитанных из таблиц для выполнения запроса на всех удалённых серверах.

`written_bytes` – общий объём данных, записанных в результате операции записи.

`execution_time` – общее время выполнения запросов в секундах (по часам, wall time).

`failed_sequential_authentications` – общее количество последовательных ошибок аутентификации.


Если лимит превышен хотя бы для одного временного интервала, генерируется исключение, в тексте которого указано, какое ограничение было превышено, для какого интервала и когда начинается новый интервал (когда запросы снова можно отправлять).

Квоты могут использовать функциональность «quota key» для независимого учета использования ресурсов для нескольких ключей. Вот пример:

```xml
<!-- Для глобального конструктора отчётов. -->
<web_global>
    <!-- keyed – Ключ квоты quota_key "key" передаётся в параметре запроса,
            при этом квота отслеживается отдельно для каждого значения ключа.
        Например, можно передать имя пользователя в качестве ключа,
            и тогда квота будет учитываться отдельно для каждого имени пользователя.
        Использование ключей имеет смысл только в том случае, если quota_key передаётся программой, а не пользователем.

        Также можно указать <keyed_by_ip />, в этом случае IP-адрес будет использоваться в качестве ключа квоты.
        (Но учтите, что пользователи могут довольно легко изменить IPv6-адрес.)
    -->
    <keyed />
```

Квота назначается пользователям в разделе &#39;users&#39; конфигурации. См. раздел «Права доступа».

При распределённой обработке запросов накопленные значения хранятся на сервере-инициаторе запроса. Поэтому, если пользователь перейдёт на другой сервер, квота там начнётся &quot;с нуля&quot;.

При перезапуске сервера квоты сбрасываются.


## Связанный контент {#related-content}

- Блог: [Создание одностраничных приложений с ClickHouse](https://clickhouse.com/blog/building-single-page-applications-with-clickhouse-and-http)
