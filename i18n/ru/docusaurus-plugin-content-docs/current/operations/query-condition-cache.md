---
description: 'Руководство по использованию и настройке механизма кэша условий запросов в ClickHouse'
sidebar_label: 'Кэш условий запросов'
sidebar_position: 64
slug: /operations/query-condition-cache
title: 'Кэш условий запросов'
doc_type: 'guide'
---



# Кэш условий запроса

:::note
Кэш условий запроса работает только тогда, когда параметр [enable_analyzer](https://clickhouse.com/docs/operations/settings/settings#enable_analyzer) установлен в значение `true` (это значение по умолчанию).
:::

Во многих реальных сценариях нагрузки выполняются повторяющиеся запросы к одним и тем же или почти одним и тем же данным (например, к уже существующим данным плюс новые данные).
ClickHouse предоставляет различные методы оптимизации для таких шаблонов запросов.
Один из вариантов — настроить физическую организацию данных с использованием индексов (например, индексы по первичному ключу, пропускающие индексы, проекции) или предварительных вычислений (материализованные представления).
Другой вариант — использовать [кэш запросов](query-cache.md) ClickHouse, чтобы избежать повторной обработки одинаковых запросов.
Недостаток первого подхода заключается в том, что он требует ручного вмешательства и мониторинга со стороны администратора базы данных.
Второй подход может возвращать устаревшие результаты (так как кэш запросов транзакционно не согласован), что может быть приемлемо или неприемлемо в зависимости от сценария использования.

Кэш условий запроса предоставляет элегантное решение обеих этих проблем.
Он основан на идее, что вычисление условия фильтрации (например, `WHERE col = 'xyz'`) на одних и тех же данных всегда будет возвращать одни и те же результаты.
Более конкретно, кэш условий запроса запоминает для каждого вычисленного фильтра и каждого гранула (= блок из 8192 строк по умолчанию), содержит ли гранула хотя бы одну строку, удовлетворяющую условию фильтрации.
Информация записывается в виде одного бита: бит 0 означает, что ни одна строка не удовлетворяет фильтру, а бит 1 — что существует хотя бы одна подходящая строка.
В первом случае ClickHouse может пропустить соответствующую гранулу при вычислении фильтра, во втором случае гранула должна быть загружена и обработана.

Кэш условий запроса эффективен, если выполняются три предпосылки:
- Во-первых, рабочая нагрузка должна многократно вычислять одни и те же условия фильтрации. Это естественным образом происходит, если один и тот же запрос повторяется несколько раз, но может происходить и тогда, когда два разных запроса используют одинаковые фильтры, например `SELECT product FROM products WHERE quality > 3` и `SELECT vendor, count() FROM products WHERE quality > 3`.
- Во-вторых, большая часть данных должна быть неизменяемой, то есть не меняться между запросами. Это обычно верно для ClickHouse, так как части данных (parts) неизменяемы и создаются только операциями INSERT.
- В-третьих, фильтры должны быть селективными, то есть только относительно небольшое число строк удовлетворяет условию фильтрации. Чем меньше строк соответствует условию фильтрации, тем больше гранул будет записано с битом 0 (нет подходящих строк) и тем больше данных может быть «отсечено» при последующих вычислениях фильтра.



## Потребление памяти {#memory-consumption}

Поскольку кеш условий запроса хранит только один бит на условие фильтра и гранулу, он потребляет минимальное количество памяти.
Максимальный размер кеша условий запроса можно настроить с помощью серверного параметра [`query_condition_cache_size`](server-configuration-parameters/settings.md#query_condition_cache_size) (по умолчанию: 100 МБ).
Размер кеша в 100 МБ соответствует 100 _ 1024 _ 1024 \* 8 = 838 860 800 записям.
Поскольку каждая запись представляет метку (по умолчанию 8192 строки), кеш может охватывать до 6 871 947 673 600 (6,8 триллиона) строк одного столбца.
На практике фильтры вычисляются для нескольких столбцов, поэтому это число необходимо разделить на количество фильтруемых столбцов.


## Настройки конфигурации и использование {#configuration-settings-and-usage}

Настройка [use_query_condition_cache](settings/settings#use_query_condition_cache) определяет, должен ли конкретный запрос или все запросы текущей сессии использовать кеш условий запроса.

Например, при первом выполнении запроса

```sql
SELECT col1, col2
FROM table
WHERE col1 = 'x'
SETTINGS use_query_condition_cache = true;
```

будут сохранены диапазоны таблицы, которые не удовлетворяют предикату.
При последующих выполнениях того же запроса, также с параметром `use_query_condition_cache = true`, будет использоваться кеш условий запроса для сканирования меньшего объёма данных.


## Администрирование {#administration}

Кэш условий запросов не сохраняется между перезапусками ClickHouse.

Для очистки кэша условий запросов выполните команду [`SYSTEM DROP QUERY CONDITION CACHE`](../sql-reference/statements/system.md#drop-query-condition-cache).

Содержимое кэша отображается в системной таблице [system.query_condition_cache](system-tables/query_condition_cache.md).
Для вычисления текущего размера кэша условий запросов в МБ выполните запрос `SELECT formatReadableSize(sum(entry_size)) FROM system.query_condition_cache`.
Для исследования отдельных условий фильтрации можно проверить поле `condition` в таблице `system.query_condition_cache`.
Обратите внимание, что это поле заполняется только при выполнении запроса с включенной настройкой [query_condition_cache_store_conditions_as_plaintext](settings/settings#query_condition_cache_store_conditions_as_plaintext).

Количество попаданий и промахов кэша условий запросов с момента запуска базы данных отображается в виде событий "QueryConditionCacheHits" и "QueryConditionCacheMisses" в системной таблице [system.events](system-tables/events.md).
Оба счетчика обновляются только для запросов `SELECT`, выполняемых с настройкой `use_query_condition_cache = true`; другие запросы не влияют на "QueryCacheMisses".


## Связанные материалы {#related-content}

- Блог: [Introducing the Query Condition Cache](https://clickhouse.com/blog/introducing-the-clickhouse-query-condition-cache)
- [Predicate Caching: Query-Driven Secondary Indexing for Cloud Data Warehouses (Schmidt et. al., 2024)](https://doi.org/10.1145/3626246.3653395)
