---
description: 'Уже созданные и корректно настроенные пользователи ClickHouse могут проходить аутентификацию по протоколу Kerberos.'
slug: /operations/external-authenticators/kerberos
title: 'Kerberos'
doc_type: 'reference'
---

import SelfManaged from '@site/i18n/ru/docusaurus-plugin-content-docs/current/_snippets/_self_managed_only_no_roadmap.md';

# Kerberos \{#kerberos\}

<SelfManaged />

Существующие и корректно настроенные пользователи ClickHouse могут аутентифицироваться через протокол Kerberos.

В настоящее время Kerberos может использоваться только как внешний механизм аутентификации для существующих пользователей, которые определены в `users.xml` или в локальных путях управления доступом. Эти пользователи могут использовать только HTTP-запросы и должны иметь возможность аутентифицироваться с использованием механизма GSS-SPNEGO.

Для этого подхода Kerberos должен быть настроен в системе и включен в конфигурации ClickHouse.

## Включение Kerberos в ClickHouse \{#enabling-kerberos-in-clickhouse\}

Чтобы включить Kerberos, необходимо добавить секцию `kerberos` в `config.xml`. Эта секция может содержать дополнительные параметры.

#### Параметры \{#parameters\}

* `principal` - каноническое имя сервисного principal, которое будет использоваться при приёме контекстов безопасности.
  * Этот параметр является необязательным, если он опущен, будет использован principal по умолчанию.

* `realm` - realm, который будет использоваться для ограничения аутентификации только запросами, у которых realm инициатора совпадает с ним.
  * Этот параметр является необязательным, если он опущен, дополнительная фильтрация по realm применяться не будет.

* `keytab` - путь к сервисному keytab-файлу.
  * Этот параметр является необязательным, если он опущен, путь к сервисному keytab-файлу должен быть задан в переменной окружения `KRB5_KTNAME`.

Пример (добавляется в `config.xml`):

```xml
<clickhouse>
    <!- ... -->
    <kerberos />
</clickhouse>
```

С указанием субъекта (principal):

```xml
<clickhouse>
    <!- ... -->
    <kerberos>
        <principal>HTTP/clickhouse.example.com@EXAMPLE.COM</principal>
    </kerberos>
</clickhouse>
```

С фильтром по realm:

```xml
<clickhouse>
    <!- ... -->
    <kerberos>
        <realm>EXAMPLE.COM</realm>
    </kerberos>
</clickhouse>
```

:::note
Можно задать только один раздел `kerberos`. Наличие нескольких разделов `kerberos` приведёт к отключению аутентификации Kerberos в ClickHouse.
:::

:::note
Разделы `principal` и `realm` не могут указываться одновременно. Наличие одновременно и `principal`, и `realm` приведёт к отключению аутентификации Kerberos в ClickHouse.
:::

## Kerberos в качестве внешнего аутентификатора для существующих пользователей \{#kerberos-as-an-external-authenticator-for-existing-users\}

Kerberos может использоваться как метод проверки подлинности локально определённых пользователей (пользователей, определённых в `users.xml` или в локальных путях управления доступом). В настоящий момент **только** запросы через HTTP-интерфейс могут проходить аутентификацию по Kerberos (через механизм GSS-SPNEGO).

Формат имени принципала Kerberos обычно имеет следующий вид:

* *primary/instance@REALM*

Часть */instance* может встречаться ноль или более раз. **Ожидается, что *primary*-часть канонического имени принципала инициатора будет совпадать с именем пользователя для Kerberos-аутентификации, чтобы аутентификация прошла успешно**.

### Включение Kerberos в `users.xml` \{#enabling-kerberos-in-users-xml\}

Чтобы включить аутентификацию Kerberos для пользователя, укажите секцию `kerberos` вместо `password` или аналогичных секций в определении пользователя.

Параметры:

* `realm` — область (realm), которая будет использоваться для ограничения аутентификации только запросами, у которых область инициатора совпадает с ней.
  * Этот параметр является необязательным: если он опущен, дополнительная фильтрация по области применяться не будет.

Пример (помещается в `users.xml`):

```xml
<clickhouse>
    <!- ... -->
    <users>
        <!- ... -->
        <my_user>
            <!- ... -->
            <kerberos>
                <realm>EXAMPLE.COM</realm>
            </kerberos>
        </my_user>
    </users>
</clickhouse>
```

:::note
Обратите внимание, что аутентификация Kerberos не может использоваться одновременно с другими механизмами аутентификации. Наличие любых других разделов конфигурации, таких как `password` вместе с `kerberos`, приведёт к принудительному завершению работы ClickHouse.
:::

:::info Reminder
Обратите внимание, что теперь, когда пользователь `my_user` использует `kerberos`, Kerberos должен быть включён в основном файле `config.xml`, как описано ранее.
:::

### Включение Kerberos через SQL \{#enabling-kerberos-using-sql\}

Когда в ClickHouse включена [SQL-управляемая система контроля доступа и управления учётными записями](/operations/access-rights#access-control-usage), пользователей, аутентифицируемых через Kerberos, также можно создавать с помощью SQL-выражений.

```sql
CREATE USER my_user IDENTIFIED WITH kerberos REALM 'EXAMPLE.COM'
```

...или без фильтрации по реалму:

```sql
CREATE USER my_user IDENTIFIED WITH kerberos
```
