---
description: 'Существующие и корректно настроенные пользователи ClickHouse могут проходить аутентификацию посредством протокола Kerberos.'
slug: /operations/external-authenticators/kerberos
title: 'Kerberos'
doc_type: 'reference'
---

import SelfManaged from '@site/docs/_snippets/_self_managed_only_no_roadmap.md';


# Kerberos

<SelfManaged />

Существующие и корректно настроенные пользователи ClickHouse могут проходить аутентификацию с использованием протокола Kerberos.

В настоящий момент Kerberos может использоваться только как внешний механизм аутентификации для существующих пользователей, которые определены в `users.xml` или в локальных путях контроля доступа. Эти пользователи могут использовать только HTTP-запросы и должны иметь возможность аутентифицироваться с помощью механизма GSS-SPNEGO.

В рамках этого подхода Kerberos должен быть настроен в системе и включён в конфигурации ClickHouse.



## Включение Kerberos в ClickHouse {#enabling-kerberos-in-clickhouse}

Для включения Kerberos необходимо добавить секцию `kerberos` в файл `config.xml`. Эта секция может содержать дополнительные параметры.

#### Параметры {#parameters}

- `principal` — каноническое имя сервисного принципала, которое будет получено и использовано при принятии контекстов безопасности.
  - Этот параметр необязателен. Если он не указан, будет использован принципал по умолчанию.

- `realm` — область (realm), которая будет использоваться для ограничения аутентификации только теми запросами, область инициатора которых ей соответствует.
  - Этот параметр необязателен. Если он не указан, дополнительная фильтрация по области применяться не будет.

- `keytab` — путь к файлу keytab сервиса.
  - Этот параметр необязателен. Если он не указан, путь к файлу keytab сервиса должен быть задан в переменной окружения `KRB5_KTNAME`.

Пример (добавляется в `config.xml`):

```xml
<clickhouse>
    <!- ... -->
    <kerberos />
</clickhouse>
```

С указанием принципала:

```xml
<clickhouse>
    <!- ... -->
    <kerberos>
        <principal>HTTP/clickhouse.example.com@EXAMPLE.COM</principal>
    </kerberos>
</clickhouse>
```

С фильтрацией по области:

```xml
<clickhouse>
    <!- ... -->
    <kerberos>
        <realm>EXAMPLE.COM</realm>
    </kerberos>
</clickhouse>
```

:::note
Можно определить только одну секцию `kerberos`. Наличие нескольких секций `kerberos` приведёт к отключению аутентификации Kerberos в ClickHouse.
:::

:::note
Секции `principal` и `realm` не могут быть указаны одновременно. Наличие обеих секций `principal` и `realm` приведёт к отключению аутентификации Kerberos в ClickHouse.
:::


## Kerberos как внешний аутентификатор для существующих пользователей {#kerberos-as-an-external-authenticator-for-existing-users}

Kerberos может использоваться в качестве метода проверки подлинности локально определённых пользователей (пользователей, определённых в `users.xml` или в локальных путях управления доступом). В настоящее время **только** запросы через HTTP-интерфейс могут использовать _kerberized_-аутентификацию (через механизм GSS-SPNEGO).

Формат имени принципала Kerberos обычно соответствует следующему шаблону:

- _primary/instance@REALM_

Часть _/instance_ может встречаться ноль или более раз. **Ожидается, что часть _primary_ канонического имени принципала инициатора совпадает с именем пользователя kerberized для успешной аутентификации**.

### Включение Kerberos в `users.xml` {#enabling-kerberos-in-users-xml}

Чтобы включить аутентификацию Kerberos для пользователя, укажите секцию `kerberos` вместо `password` или аналогичных секций в определении пользователя.

Параметры:

- `realm` — область (realm), которая будет использоваться для ограничения аутентификации только теми запросами, область инициатора которых совпадает с ней.
  - Этот параметр необязателен. Если он опущен, дополнительная фильтрация по области применяться не будет.

Пример (добавляется в `users.xml`):

```xml
<clickhouse>
    <!- ... -->
    <users>
        <!- ... -->
        <my_user>
            <!- ... -->
            <kerberos>
                <realm>EXAMPLE.COM</realm>
            </kerberos>
        </my_user>
    </users>
</clickhouse>
```

:::note
Обратите внимание, что аутентификация Kerberos не может использоваться одновременно с любым другим механизмом аутентификации. Наличие любых других секций, таких как `password`, наряду с `kerberos` приведёт к завершению работы ClickHouse.
:::

:::info Напоминание
Обратите внимание, что теперь, когда пользователь `my_user` использует `kerberos`, Kerberos должен быть включён в основном файле `config.xml`, как описано ранее.
:::

### Включение Kerberos с помощью SQL {#enabling-kerberos-using-sql}

Когда в ClickHouse включено [управление доступом и учётными записями на основе SQL](/operations/access-rights#access-control-usage), пользователи, идентифицируемые через Kerberos, также могут быть созданы с помощью SQL-операторов.

```sql
CREATE USER my_user IDENTIFIED WITH kerberos REALM 'EXAMPLE.COM'
```

...или без фильтрации по области:

```sql
CREATE USER my_user IDENTIFIED WITH kerberos
```
