---
description: 'Руководство по настройке LDAP-аутентификации для ClickHouse'
slug: /operations/external-authenticators/ldap
title: 'LDAP'
doc_type: 'reference'
---

import SelfManaged from '@site/docs/_snippets/_self_managed_only_no_roadmap.md';

<SelfManaged />

Сервер LDAP может использоваться для аутентификации пользователей ClickHouse. Для этого есть два подхода:

* Использовать LDAP как внешний аутентификатор для существующих пользователей, определённых в `users.xml` или в локальных файлах управления доступом.
* Использовать LDAP как внешний каталог пользователей и разрешить аутентификацию локально не определённых пользователей, если они существуют на сервере LDAP.

Для обоих подходов в конфигурации ClickHouse должен быть определён LDAP-сервер с именем, чтобы другие части конфигурации могли на него ссылаться.


## Определение LDAP-сервера {#ldap-server-definition}

Для определения LDAP-сервера необходимо добавить секцию `ldap_servers` в `config.xml`.

**Пример**

```xml
<clickhouse>
    <!- ... -->
    <ldap_servers>
        <!- Типичный LDAP-сервер. -->
        <my_ldap_server>
            <host>localhost</host>
            <port>636</port>
            <bind_dn>uid={user_name},ou=users,dc=example,dc=com</bind_dn>
            <verification_cooldown>300</verification_cooldown>
            <enable_tls>yes</enable_tls>
            <tls_minimum_protocol_version>tls1.2</tls_minimum_protocol_version>
            <tls_require_cert>demand</tls_require_cert>
            <tls_cert_file>/path/to/tls_cert_file</tls_cert_file>
            <tls_key_file>/path/to/tls_key_file</tls_key_file>
            <tls_ca_cert_file>/path/to/tls_ca_cert_file</tls_ca_cert_file>
            <tls_ca_cert_dir>/path/to/tls_ca_cert_dir</tls_ca_cert_dir>
            <tls_cipher_suite>ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:AES256-GCM-SHA384</tls_cipher_suite>
        </my_ldap_server>

        <!- Типичный Active Directory с настроенным обнаружением DN пользователя для последующего сопоставления ролей. -->
        <my_ad_server>
            <host>localhost</host>
            <port>389</port>
            <bind_dn>EXAMPLE\{user_name}</bind_dn>
            <user_dn_detection>
                <base_dn>CN=Users,DC=example,DC=com</base_dn>
                <search_filter>(&amp;(objectClass=user)(sAMAccountName={user_name}))</search_filter>
            </user_dn_detection>
            <enable_tls>no</enable_tls>
        </my_ad_server>
    </ldap_servers>
</clickhouse>
```

Обратите внимание, что в секции `ldap_servers` можно определить несколько LDAP-серверов с различными именами.

**Параметры**


- `host` — имя хоста или IP-адрес LDAP‑сервера, этот параметр является обязательным и не может быть пустым.
- `port` — порт LDAP‑сервера, по умолчанию `636`, если `enable_tls` установлено в `true`, иначе `389`.
- `bind_dn` — шаблон, используемый для построения DN для bind‑операции.
  - Итоговый DN будет сформирован путем замены всех подстрок `{user_name}` в шаблоне фактическим именем пользователя при каждой попытке аутентификации.
- `user_dn_detection` — секция с параметрами LDAP‑поиска для определения фактического пользовательского DN привязанного пользователя.
  - В основном используется в фильтрах поиска для последующего сопоставления ролей, когда сервером является Active Directory. Итоговый пользовательский DN будет использоваться при замене подстрок `{user_dn}` везде, где это допускается. По умолчанию пользовательский DN устанавливается равным bind DN, но после выполнения поиска он будет обновлен до фактического обнаруженного значения пользовательского DN.
    - `base_dn` — шаблон, используемый для построения базового DN для LDAP‑поиска.
      - Итоговый DN будет сформирован путем замены всех подстрок `{user_name}` и `{bind_dn}` в шаблоне фактическим именем пользователя и bind DN во время LDAP‑поиска.
    - `scope` — область действия LDAP‑поиска.
      - Допустимые значения: `base`, `one_level`, `children`, `subtree` (значение по умолчанию).
    - `search_filter` — шаблон, используемый для построения фильтра поиска для LDAP‑поиска.
      - Итоговый фильтр будет сформирован путем замены всех подстрок `{user_name}`, `{bind_dn}` и `{base_dn}` в шаблоне фактическим именем пользователя, bind DN и base DN во время LDAP‑поиска.
      - Обратите внимание, что специальные символы должны быть корректно экранированы в XML.
- `verification_cooldown` — период времени в секундах, после успешной bind‑операции, в течение которого предполагается, что пользователь успешно аутентифицирован для всех последующих запросов без обращения к LDAP‑серверу.
  - Укажите `0` (значение по умолчанию), чтобы отключить кэширование и принудительно обращаться к LDAP‑серверу для каждого запроса аутентификации.
- `enable_tls` — флаг, включающий использование защищенного соединения с LDAP‑сервером.
  - Укажите `no` для незашифрованного протокола `ldap://` (не рекомендуется).
  - Укажите `yes` для протокола LDAP поверх SSL/TLS `ldaps://` (рекомендуется, значение по умолчанию).
  - Укажите `starttls` для устаревшего протокола StartTLS (незашифрованный протокол `ldap://`, переводимый на TLS).
- `tls_minimum_protocol_version` — минимальная версия протокола SSL/TLS.
  - Допустимые значения: `ssl2`, `ssl3`, `tls1.0`, `tls1.1`, `tls1.2` (значение по умолчанию).
- `tls_require_cert` — поведение проверки сертификата удаленного узла SSL/TLS.
  - Допустимые значения: `never`, `allow`, `try`, `demand` (значение по умолчанию).
- `tls_cert_file` — путь к файлу сертификата.
- `tls_key_file` — путь к файлу закрытого ключа сертификата.
- `tls_ca_cert_file` — путь к файлу сертификата центра сертификации (CA).
- `tls_ca_cert_dir` — путь к каталогу, содержащему сертификаты центров сертификации (CA).
- `tls_cipher_suite` — разрешенный набор шифров (в нотации OpenSSL).



## Внешний аутентификатор LDAP {#ldap-external-authenticator}

Удаленный LDAP-сервер может использоваться в качестве метода проверки паролей для локально определенных пользователей (пользователей, определенных в `users.xml` или в локальных путях управления доступом). Для этого укажите имя ранее определенного LDAP-сервера вместо секции `password` или аналогичных секций в определении пользователя.

При каждой попытке входа ClickHouse пытается выполнить «привязку» к указанному DN, определенному параметром `bind_dn` в [определении LDAP-сервера](#ldap-server-definition), используя предоставленные учетные данные, и если операция успешна, пользователь считается аутентифицированным. Этот метод часто называется «простой привязкой».

**Пример**

```xml
<clickhouse>
    <!- ... -->
    <users>
        <!- ... -->
        <my_user>
            <!- ... -->
            <ldap>
                <server>my_ldap_server</server>
            </ldap>
        </my_user>
    </users>
</clickhouse>
```

Обратите внимание, что пользователь `my_user` ссылается на `my_ldap_server`. Этот LDAP-сервер должен быть настроен в основном файле `config.xml`, как описано ранее.

Когда включено [управление доступом и учетными записями](/operations/access-rights#access-control-usage) на основе SQL, пользователи, аутентифицируемые через LDAP-серверы, также могут быть созданы с помощью оператора [CREATE USER](/sql-reference/statements/create/user).

Запрос:

```sql
CREATE USER my_user IDENTIFIED WITH ldap SERVER 'my_ldap_server';
```


## Внешний каталог пользователей LDAP {#ldap-external-user-directory}

Помимо локально определённых пользователей, в качестве источника определений пользователей может использоваться удалённый LDAP-сервер. Для этого укажите имя ранее определённого LDAP-сервера (см. [Определение LDAP-сервера](#ldap-server-definition)) в секции `ldap` внутри секции `users_directories` файла `config.xml`.

При каждой попытке входа ClickHouse пытается найти определение пользователя локально и аутентифицировать его обычным способом. Если пользователь не определён, ClickHouse предполагает, что определение существует во внешнем каталоге LDAP, и попытается выполнить «привязку» к указанному DN на LDAP-сервере, используя предоставленные учётные данные. В случае успеха пользователь будет считаться существующим и аутентифицированным. Пользователю будут назначены роли из списка, указанного в секции `roles`. Дополнительно может быть выполнен LDAP-«поиск», результаты которого могут быть преобразованы и интерпретированы как имена ролей, а затем назначены пользователю, если также настроена секция `role_mapping`. Всё это подразумевает, что включено SQL-управление [доступом и учётными записями](/operations/access-rights#access-control-usage), а роли создаются с помощью оператора [CREATE ROLE](/sql-reference/statements/create/role).

**Пример**

Добавляется в `config.xml`.

```xml
<clickhouse>
    <!- ... -->
    <user_directories>
        <!- Типичный LDAP-сервер. -->
        <ldap>
            <server>my_ldap_server</server>
            <roles>
                <my_local_role1 />
                <my_local_role2 />
            </roles>
            <role_mapping>
                <base_dn>ou=groups,dc=example,dc=com</base_dn>
                <scope>subtree</scope>
                <search_filter>(&amp;(objectClass=groupOfNames)(member={bind_dn}))</search_filter>
                <attribute>cn</attribute>
                <prefix>clickhouse_</prefix>
            </role_mapping>
        </ldap>

        <!- Типичный Active Directory с сопоставлением ролей на основе обнаруженного DN пользователя. -->
        <ldap>
            <server>my_ad_server</server>
            <role_mapping>
                <base_dn>CN=Users,DC=example,DC=com</base_dn>
                <attribute>CN</attribute>
                <scope>subtree</scope>
                <search_filter>(&amp;(objectClass=group)(member={user_dn}))</search_filter>
                <prefix>clickhouse_</prefix>
            </role_mapping>
        </ldap>
    </user_directories>
</clickhouse>
```

Обратите внимание, что `my_ldap_server`, указанный в секции `ldap` внутри секции `user_directories`, должен быть ранее определённым LDAP-сервером, настроенным в `config.xml` (см. [Определение LDAP-сервера](#ldap-server-definition)).

**Параметры**


- `server` — Одно из имён LDAP-серверов, определённых в конфигурационном разделе `ldap_servers` выше. Этот параметр обязателен и не может быть пустым.
- `roles` — Раздел со списком локально определённых ролей, которые будут назначены каждому пользователю, полученному из LDAP-сервера.
  - Если здесь не указаны роли или они не назначены в ходе сопоставления ролей (см. ниже), пользователь не сможет выполнять никакие действия после аутентификации.
- `role_mapping` — Раздел с параметрами поиска в LDAP и правилами сопоставления.
  - Когда пользователь аутентифицируется, пока соединение с LDAP остаётся установленным, выполняется поиск в LDAP с использованием `search_filter` и имени вошедшего пользователя. Для каждой записи, найденной в ходе этого поиска, извлекается значение указанного атрибута. Для каждого значения атрибута, имеющего заданный префикс, префикс удаляется, а оставшаяся часть значения становится именем локальной роли, определённой в ClickHouse, которая должна быть создана заранее с помощью оператора [CREATE ROLE](/sql-reference/statements/create/role).
  - В одном и том же разделе `ldap` может быть определено несколько разделов `role_mapping`. Все они будут применены.
    - `base_dn` — Шаблон, используемый для построения базового DN для поиска в LDAP.
      - Итоговый DN будет сформирован путём замены всех подстрок `{user_name}`, `{bind_dn}` и `{user_dn}` в шаблоне фактическими значениями имени пользователя, bind DN и user DN при каждом поиске в LDAP.
    - `scope` — Область поиска в LDAP.
      - Допустимые значения: `base`, `one_level`, `children`, `subtree` (по умолчанию).
    - `search_filter` — Шаблон, используемый для построения фильтра поиска для поиска в LDAP.
      - Итоговый фильтр будет сформирован путём замены всех подстрок `{user_name}`, `{bind_dn}`, `{user_dn}` и `{base_dn}` в шаблоне фактическими значениями имени пользователя, bind DN, user DN и base DN при каждом поиске в LDAP.
      - Обратите внимание, что специальные символы должны корректно экранироваться в XML.
    - `attribute` — Имя атрибута, значения которого будут возвращены поиском в LDAP. По умолчанию — `cn`.
    - `prefix` — Префикс, который ожидается перед каждой строкой в исходном списке строк, возвращённом поиском в LDAP. Префикс будет удалён из исходных строк, а полученные строки будут интерпретироваться как имена локальных ролей. По умолчанию — пустой.
