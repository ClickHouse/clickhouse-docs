---
description: 'Руководство по самостоятельному обновлению'
sidebar_title: 'Самостоятельное обновление'
slug: /operations/update
title: 'Самостоятельное обновление'
doc_type: 'guide'
---



## Обзор обновления ClickHouse {#clickhouse-upgrade-overview}

Этот документ содержит:

- общие рекомендации
- рекомендуемый план
- особенности обновления бинарных файлов в ваших системах


## Общие рекомендации {#general-guidelines}

Эти замечания помогут вам в планировании и понимании причин рекомендаций, приведённых далее в документе.

### Обновляйте сервер ClickHouse отдельно от ClickHouse Keeper или ZooKeeper {#upgrade-clickhouse-server-separately-from-clickhouse-keeper-or-zookeeper}

Если не требуется исправление уязвимостей безопасности для ClickHouse Keeper или Apache ZooKeeper, обновлять Keeper при обновлении сервера ClickHouse не обязательно. Стабильность Keeper необходима в процессе обновления, поэтому завершите обновление сервера ClickHouse, прежде чем рассматривать обновление Keeper.

### Минорные обновления версий следует применять часто {#minor-version-upgrades-should-be-adopted-often}

Настоятельно рекомендуется всегда обновляться до новейшей минорной версии сразу после её выпуска. Минорные релизы не содержат breaking changes, но включают важные исправления ошибок (и могут содержать исправления уязвимостей безопасности).

### Тестируйте экспериментальные функции на отдельном сервере ClickHouse с целевой версией {#test-experimental-features-on-a-separate-clickhouse-server-running-the-target-version}

Совместимость экспериментальных функций может быть нарушена в любой момент любым способом. Если вы используете экспериментальные функции, проверяйте журналы изменений и рассмотрите возможность настройки отдельного сервера ClickHouse с установленной целевой версией для тестирования использования этих экспериментальных функций.

### Откат версии {#downgrades}

Если вы выполнили обновление и затем обнаружили, что новая версия несовместима с некоторой функцией, от которой вы зависите, вы можете откатиться к недавней версии (выпущенной менее года назад), если ещё не начали использовать новые функции. После начала использования новых функций откат версии не будет работать.

### Несколько версий сервера ClickHouse в кластере {#multiple-clickhouse-server-versions-in-a-cluster}

Мы прилагаем усилия для поддержания окна совместимости в один год (которое включает 2 LTS-версии). Это означает, что любые две версии должны работать вместе в кластере, если разница между ними составляет менее одного года (или если между ними менее двух LTS-версий). Однако рекомендуется обновить все узлы кластера до одной версии как можно быстрее, поскольку возможны некоторые незначительные проблемы (такие как замедление распределённых запросов, повторяемые ошибки в некоторых фоновых операциях в ReplicatedMergeTree и т. д.).

Мы никогда не рекомендуем запускать разные версии в одном кластере, если даты выпуска отличаются более чем на один год. Хотя мы не ожидаем потери данных, кластер может стать неработоспособным. Проблемы, которых следует ожидать при разнице версий более одного года, включают:

- кластер может не работать
- некоторые (или даже все) запросы могут завершаться с произвольными ошибками
- в логах могут появляться произвольные ошибки/предупреждения
- откат версии может быть невозможен

### Поэтапные обновления {#incremental-upgrades}

Если разница между текущей версией и целевой версией составляет более одного года, рекомендуется:

- Выполнить обновление с простоем (остановить все серверы, обновить все серверы, запустить все серверы).
- Или выполнить обновление через промежуточную версию (версию, которая новее текущей менее чем на один год).


## Рекомендуемый план {#recommended-plan}

Ниже приведены рекомендуемые шаги для обновления ClickHouse без простоя:

1. Убедитесь, что ваши изменения конфигурации находятся не в файле по умолчанию `/etc/clickhouse-server/config.xml`, а в каталоге `/etc/clickhouse-server/config.d/`, поскольку файл `/etc/clickhouse-server/config.xml` может быть перезаписан во время обновления.
2. Изучите [журналы изменений](/whats-new/changelog/index.md) на предмет критических изменений (начиная с целевого релиза и заканчивая релизом, который вы используете в настоящее время).
3. Выполните все обновления, выявленные в критических изменениях, которые можно выполнить до обновления, и составьте список изменений, которые потребуется выполнить после обновления.
4. Определите одну или несколько реплик для каждого шарда, которые будут продолжать работу, пока остальные реплики каждого шарда обновляются.
5. На репликах, которые будут обновлены, по одной за раз:

- остановите сервер ClickHouse
- обновите сервер до целевой версии
- запустите сервер ClickHouse
- дождитесь сообщений Keeper, указывающих на стабильность системы
- переходите к следующей реплике

6. Проверьте наличие ошибок в журнале Keeper и журнале ClickHouse
7. Обновите реплики, определенные на шаге 4, до новой версии
8. Обратитесь к списку изменений, составленному на шагах 1–3, и выполните изменения, которые необходимо сделать после обновления.

:::note
Это сообщение об ошибке ожидаемо, когда в реплицируемой среде работают несколько версий ClickHouse. Вы перестанете видеть эти сообщения, когда все реплики будут обновлены до одной версии.

```text
MergeFromLogEntryTask: Code: 40. DB::Exception: Checksums of parts don't match:
hash of uncompressed files doesn't match. (CHECKSUM_DOESNT_MATCH)  Data after merge is not
byte-identical to data on another replicas.
```

:::


## Процесс обновления бинарного файла сервера ClickHouse {#clickhouse-server-binary-upgrade-process}

Если ClickHouse был установлен из пакетов `deb`, выполните на сервере следующие команды:

```bash
$ sudo apt-get update
$ sudo apt-get install clickhouse-client clickhouse-server
$ sudo service clickhouse-server restart
```

Если вы установили ClickHouse другим способом, отличным от рекомендуемых пакетов `deb`, используйте соответствующий метод обновления.

:::note
Вы можете обновлять несколько серверов одновременно, если при этом не возникает ситуации, когда все реплики одного шарда находятся в офлайне.
:::

Обновление более старой версии ClickHouse до конкретной версии:

Пример:

`xx.yy.a.b` — текущая стабильная версия. Последнюю стабильную версию можно найти [здесь](https://github.com/ClickHouse/ClickHouse/releases)

```bash
$ sudo apt-get update
$ sudo apt-get install clickhouse-server=xx.yy.a.b clickhouse-client=xx.yy.a.b clickhouse-common-static=xx.yy.a.b
$ sudo service clickhouse-server restart
```
