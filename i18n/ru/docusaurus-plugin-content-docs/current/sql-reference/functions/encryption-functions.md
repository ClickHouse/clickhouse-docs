---
description: 'Документация по функциям шифрования'
sidebar_label: 'Шифрование'
slug: /sql-reference/functions/encryption-functions
title: 'Функции шифрования'
keywords: ['шифрование', 'обычные функции', 'зашифровать', 'дешифровать']
doc_type: 'reference'
---

# Функции шифрования {#encryption-functions}

Эти функции выполняют шифрование и расшифровку данных с использованием алгоритма AES (Advanced Encryption Standard).

Длина ключа зависит от режима шифрования: `16`, `24` и `32` байта для режимов `-128-`, `-196-` и `-256-` соответственно.

Длина вектора инициализации всегда составляет 16 байт (байты сверх этого значения игнорируются).

{/* 
  Внутреннее содержимое расположенных ниже тегов заменяется на этапе сборки фреймворка документации
  на документацию, сгенерированную из system.functions. Пожалуйста, не изменяйте и не удаляйте эти теги.
  См.: https://github.com/ClickHouse/clickhouse-docs/blob/main/contribute/autogenerated-documentation-from-source.md
  */ }

{/*AUTOGENERATED_START*/ }

## aes&#95;decrypt&#95;mysql {#aes&#95;decrypt&#95;mysql}

Добавлена в версии: v20.12

Расшифровывает данные, зашифрованные функцией MySQL [`AES_ENCRYPT`](https://dev.mysql.com/doc/refman/8.0/en/encryption-functions.html#function_aes-encrypt).

Возвращает тот же открытый текст, что и [`decrypt`](#decrypt) при тех же входных данных.
Когда `key` или `iv` длиннее, чем это обычно требуется, `aes_decrypt_mysql` ведет себя так же, как MySQL `AES_DECRYPT`, то есть «сворачивает» `key` и игнорирует лишние биты `IV`.

Поддерживает следующие режимы расшифрования:

* aes-128-ecb, aes-192-ecb, aes-256-ecb
* aes-128-cbc, aes-192-cbc, aes-256-cbc
* aes-128-cfb128
* aes-128-ofb, aes-192-ofb, aes-256-ofb

**Синтаксис**

```sql
aes_decrypt_mysql(mode, ciphertext, key[, iv])
```

**Аргументы**

* `mode` — режим расшифровки. [`String`](/sql-reference/data-types/string)
* `ciphertext` — зашифрованный текст, который необходимо расшифровать. [`String`](/sql-reference/data-types/string)
* `key` — ключ расшифровки. [`String`](/sql-reference/data-types/string)
* `iv` — необязательный параметр, вектор инициализации. [`String`](/sql-reference/data-types/string)

**Возвращаемое значение**

Возвращает расшифрованную строку. [`String`](/sql-reference/data-types/string)

**Примеры**

**Расшифровка данных из MySQL**

```sql title=Query
-- Расшифруем данные, ранее зашифрованные с помощью MySQL:
mysql> SET  block_encryption_mode='aes-256-ofb';
Query OK, 0 rows affected (0.00 sec)

mysql> SELECT aes_encrypt('Secret', '123456789101213141516171819202122', 'iviviviviviviviv123456') as ciphertext;
+------------------------+
| ciphertext             |
+------------------------+
| 0x24E9E4966469         |
+------------------------+
1 row in set (0.00 sec)

SELECT aes_decrypt_mysql('aes-256-ofb', unhex('24E9E4966469'), '123456789101213141516171819202122', 'iviviviviviviviv123456') AS plaintext
```

```response title=Response
┌─plaintext─┐
│ Секрет    │
└───────────┘
```

## aes&#95;encrypt&#95;mysql {#aes&#95;encrypt&#95;mysql}

Введена в версии v20.12

Шифрует текст тем же способом, что и функция MySQL `AES_ENCRYPT`.
Полученный шифртекст может быть расшифрован с помощью функции MySQL `AES_DECRYPT`.
Для одинаковых входных данных создаёт тот же шифртекст, что и функция `encrypt`.
Когда `key` или `iv` длиннее, чем должны быть, `aes_encrypt_mysql` ведёт себя так же, как MySQL `aes_encrypt`, то есть «сворачивает» `key` и игнорирует лишние биты `iv`.

Поддерживаемые режимы шифрования:

* aes-128-ecb, aes-192-ecb, aes-256-ecb
* aes-128-cbc, aes-192-cbc, aes-256-cbc
* aes-128-ofb, aes-192-ofb, aes-256-ofb

**Синтаксис**

```sql
aes_encrypt_mysql(mode, plaintext, key[, iv])
```

**Аргументы**

* `mode` — режим шифрования. [`String`](/sql-reference/data-types/string)
* `plaintext` — текст, который нужно зашифровать. [`String`](/sql-reference/data-types/string)
* `key` — ключ шифрования. Если ключ длиннее, чем требуется `mode`, выполняется специфичная для MySQL свёртка ключа. [`String`](/sql-reference/data-types/string)
* `iv` — необязательный параметр. Вектор инициализации. Учитываются только первые 16 байт. [`String`](/sql-reference/data-types/string)

**Возвращаемое значение**

Бинарная строка шифртекста. [`String`](/sql-reference/data-types/string)

**Примеры**

**Сравнение одинаковых входных данных**

```sql title=Query
-- При одинаковых входных данных функции encrypt и aes_encrypt_mysql возвращают один и тот же зашифрованный текст:
SELECT encrypt('aes-256-ofb', 'Secret', '12345678910121314151617181920212', 'iviviviviviviviv') = aes_encrypt_mysql('aes-256-ofb', 'Secret', '12345678910121314151617181920212', 'iviviviviviviviv') AS ciphertexts_equal;
```

```response title=Response
┌─ciphertexts_equal─┐
│                 1 │
└───────────────────┘
```

**Ошибка шифрования при длинном ключе**

```sql title=Query
-- Но encrypt завершается с ошибкой, если ключ или iv длиннее ожидаемого:
SELECT encrypt('aes-256-ofb', 'Secret', '123456789101213141516171819202122', 'iviviviviviviviv123');
```

```response title=Response
Получено исключение от сервера (версия 22.6.1):
Код: 36. DB::Exception: получено от localhost:9000. DB::Exception: Недопустимый размер ключа: 33, ожидалось 32: при обработке encrypt('aes-256-ofb', 'Secret', '123456789101213141516171819202122', 'iviviviviviviviv123').
```

**Совместимость с MySQL**

```sql title=Query
-- aes_encrypt_mysql выдаёт результат, совместимый с MySQL:
SELECT hex(aes_encrypt_mysql('aes-256-ofb', 'Secret', '123456789101213141516171819202122', 'iviviviviviviviv123')) AS ciphertext;
```

```response title=Response
┌─ciphertext───┐
│ 24E9E4966469 │
└──────────────┘
```

**Более длинный IV даёт тот же результат**

```sql title=Query
-- Обратите внимание, что использование даже более длинного IV дает тот же результат
SELECT hex(aes_encrypt_mysql('aes-256-ofb', 'Secret', '123456789101213141516171819202122', 'iviviviviviviviv123456')) AS ciphertext
```

```response title=Response
┌─ciphertext───┐
│ 24E9E4966469 │
└──────────────┘
```

## decrypt {#decrypt}

Появилась в версии: v20.12

Эта функция расшифровывает двоичную строку, зашифрованную с помощью AES, в одном из следующих режимов:

* aes-128-ecb, aes-192-ecb, aes-256-ecb
* aes-128-cbc, aes-192-cbc, aes-256-cbc
* aes-128-ofb, aes-192-ofb, aes-256-ofb
* aes-128-gcm, aes-192-gcm, aes-256-gcm
* aes-128-ctr, aes-192-ctr, aes-256-ctr
* aes-128-cfb, aes-128-cfb1, aes-128-cfb8

**Синтаксис**

```sql
decrypt(mode, ciphertext, key[, iv, aad])
```

**Аргументы**

* `mode` — Режим расшифрования. [`String`](/sql-reference/data-types/string)
* `ciphertext` — Зашифрованный текст, который нужно расшифровать. [`String`](/sql-reference/data-types/string)
* `key` — Ключ расшифрования. [`String`](/sql-reference/data-types/string)
* `iv` — Вектор инициализации. Обязателен для режимов `-gcm`, для остальных не является обязательным. [`String`](/sql-reference/data-types/string)
* `aad` — Дополнительные аутентифицированные данные. Расшифрование не будет выполнено, если это значение некорректно. Работает только в режимах `-gcm`, для остальных вызывает исключение. [`String`](/sql-reference/data-types/string)

**Возвращаемое значение**

Возвращает расшифрованный открытый текст. [`String`](/sql-reference/data-types/string)

**Примеры**

**Корректная расшифровка зашифрованных данных**

```sql title=Query
-- Повторное использование таблицы из примера функции encrypt
SELECT comment, hex(secret) FROM encryption_test;
```

```response title=Response
┌─comment──────────────┬─hex(secret)──────────────────────────────────┐
│ aes-256-gcm          │ A8A3CCBC6426CFEEB60E4EAE03D3E94204C1B09E0254 │
│ aes-256-gcm с AAD    │ A8A3CCBC6426D9A1017A0A932322F1852260A4AD6837 │
└──────────────────────┴──────────────────────────────────────────────┘
┌─comment──────────────────────────┬─hex(secret)──────────────────────┐
│ aes-256-ofb без IV               │ B4972BDC4459                     │
│ aes-256-ofb без IV, другой ключ  │ 2FF57C092DC9                     │
│ aes-256-ofb с IV                 │ 5E6CB398F653                     │
│ aes-256-cbc без IV               │ 1BC0629A92450D9E73A00E7D02CF4142 │
└──────────────────────────────────┴──────────────────────────────────┘
```

**Некорректная расшифровка зашифрованных данных**

```sql title=Query
SELECT comment, decrypt('aes-256-cfb128', secret, '12345678910121314151617181920212') AS plaintext FROM encryption_test
```

```response title=Response
-- Обратите внимание, что корректно расшифрована только часть данных, а остальное представляет собой бессмысленный набор символов, так как при шифровании использовались другие значения `mode`, `key` или `iv`.
┌─comment──────────────┬─plaintext──┐
│ aes-256-gcm          │ OQ�E
                             �t�7T�\���\�   │
│ aes-256-gcm with AAD │ OQ�E
                             �\��si����;�o�� │
└──────────────────────┴────────────┘
┌─comment──────────────────────────┬─plaintext─┐
│ aes-256-ofb no IV                │ Secret    │
│ aes-256-ofb no IV, different key │ �4�
                                        �         │
│ aes-256-ofb with IV              │ ���6�~        │
│aes-256-cbc no IV                │ �2*4�h3c�4w��@
└──────────────────────────────────┴───────────┘
```

## encrypt {#encrypt}

Появилась в версии: v20.12

Шифрует открытый текст в шифртекст с использованием AES в одном из следующих режимов:

* aes-128-ecb, aes-192-ecb, aes-256-ecb
* aes-128-cbc, aes-192-cbc, aes-256-cbc
* aes-128-ofb, aes-192-ofb, aes-256-ofb
* aes-128-gcm, aes-192-gcm, aes-256-gcm
* aes-128-ctr, aes-192-ctr, aes-256-ctr
* aes-128-cfb, aes-128-cfb1, aes-128-cfb8

**Синтаксис**

```sql
encrypt(mode, plaintext, key[, iv, aad])
```

**Аргументы**

* `mode` — режим шифрования. [`String`](/sql-reference/data-types/string)
* `plaintext` — текст, который нужно зашифровать. [`String`](/sql-reference/data-types/string)
* `key` — ключ шифрования. [`String`](/sql-reference/data-types/string)
* `iv` — вектор инициализации. Обязателен для режимов `-gcm`, для остальных — необязателен. [`String`](/sql-reference/data-types/string)
* `aad` — дополнительные аутентифицируемые данные. Они не шифруются, но влияют на расшифровку. Работает только в режимах `-gcm`, для остальных генерируется исключение. [`String`](/sql-reference/data-types/string)

**Возвращаемое значение**

Возвращает двоичную строку с зашифрованным текстом (ciphertext). [`String`](/sql-reference/data-types/string)

**Примеры**

**Пример шифрования**

```sql title=Query
CREATE TABLE encryption_test
(
    `comment` String,
    `secret` String
)
ENGINE = MergeTree;

INSERT INTO encryption_test VALUES
('aes-256-ofb без IV', encrypt('aes-256-ofb', 'Secret', '12345678910121314151617181920212')),
('aes-256-ofb без IV, другой ключ', encrypt('aes-256-ofb', 'Secret', 'keykeykeykeykeykeykeykeykeykeyke')),
('aes-256-ofb с IV', encrypt('aes-256-ofb', 'Secret', '12345678910121314151617181920212', 'iviviviviviviviv')),
('aes-256-cbc без IV', encrypt('aes-256-cbc', 'Secret', '12345678910121314151617181920212'));

SELECT comment, hex(secret) FROM encryption_test;
```

```response title=Response
┌─comment──────────────────────────┬─hex(secret)──────────────────────┐
│ aes-256-ofb без вектора инициализации                │ B4972BDC4459                     │
│ aes-256-ofb без вектора инициализации, другой ключ │ 2FF57C092DC9                     │
│ aes-256-ofb с вектором инициализации              │ 5E6CB398F653                     │
│ aes-256-cbc без вектора инициализации                │ 1BC0629A92450D9E73A00E7D02CF4142 │
└──────────────────────────────────┴──────────────────────────────────┘
```

**Пример для режима GCM**

```sql title=Query
INSERT INTO encryption_test VALUES
('aes-256-gcm', encrypt('aes-256-gcm', 'Secret', '12345678910121314151617181920212', 'iviviviviviviviv')),

('aes-256-gcm с AAD', encrypt('aes-256-gcm', 'Secret', '12345678910121314151617181920212', 'iviviviviviviviv', 'aad'));

SELECT comment, hex(secret) FROM encryption_test WHERE comment LIKE '%gcm%';
```

```response title=Response
┌─comment──────────────┬─hex(secret)──────────────────────────────────┐
│ aes-256-gcm          │ A8A3CCBC6426CFEEB60E4EAE03D3E94204C1B09E0254 │
│ aes-256-gcm с AAD    │ A8A3CCBC6426D9A1017A0A932322F1852260A4AD6837 │
└──────────────────────┴──────────────────────────────────────────────┘
```

## tryDecrypt {#tryDecrypt}

Добавлена в: v22.10

Похожа на функцию `decrypt`, но возвращает `NULL`, если расшифрование завершается ошибкой при использовании неверного ключа.

**Синтаксис**

```sql
tryDecrypt(режим, шифротекст, ключ[, iv, aad])
```

**Аргументы**

* `mode` — режим расшифрования. [`String`](/sql-reference/data-types/string)
* `ciphertext` — зашифрованный текст, который нужно расшифровать. [`String`](/sql-reference/data-types/string)
* `key` — ключ расшифрования. [`String`](/sql-reference/data-types/string)
* `iv` — необязательный параметр. Вектор инициализации. Обязателен для режимов `-gcm`, необязателен для других режимов. [`String`](/sql-reference/data-types/string)
* `aad` — необязательный параметр. Дополнительные аутентифицированные данные. Расшифровка не произойдёт, если это значение неверно. Работает только в режимах `-gcm`, для других режимов выбрасывает исключение. [`String`](/sql-reference/data-types/string)

**Возвращаемое значение**

Возвращает расшифрованную строку или `NULL`, если расшифровка не удалась. [`Nullable(String)`](/sql-reference/data-types/nullable)

**Примеры**

**Создание таблицы и вставка данных**

```sql title=Query
-- Создадим таблицу, где user_id — уникальный идентификатор пользователя, encrypted — зашифрованное строковое поле, iv — вектор инициализации для расшифровки/шифрования.
-- Предполагается, что пользователи знают свой идентификатор и ключ для расшифровки зашифрованного поля:
CREATE TABLE decrypt_null
(
    dt DateTime,
    user_id UInt32,
    encrypted String,
    iv String
)
ENGINE = MergeTree;

-- Вставим данные:
INSERT INTO decrypt_null VALUES
('2022-08-02 00:00:00', 1, encrypt('aes-256-gcm', 'value1', 'keykeykeykeykeykeykeykeykeykey01', 'iv1'), 'iv1'),
('2022-09-02 00:00:00', 2, encrypt('aes-256-gcm', 'value2', 'keykeykeykeykeykeykeykeykeykey02', 'iv2'), 'iv2'),
('2022-09-02 00:00:01', 3, encrypt('aes-256-gcm', 'value3', 'keykeykeykeykeykeykeykeykeykey03', 'iv3'), 'iv3');

-- Попробуем расшифровать с помощью одного ключа:
SELECT
    dt,
    user_id,
    tryDecrypt('aes-256-gcm', encrypted, 'keykeykeykeykeykeykeykeykeykey02', iv) AS value
FROM decrypt_null
ORDER BY user_id ASC
```

```response title=Response
┌──────────────────dt─┬─user_id─┬─value──┐
│ 2022-08-02 00:00:00 │       1 │ ᴺᵁᴸᴸ   │
│ 2022-09-02 00:00:00 │       2 │ value2 │
│ 2022-09-02 00:00:01 │       3 │ ᴺᵁᴸᴸ   │
└─────────────────────┴─────────┴────────┘
```

{/*AUTOGENERATED_END*/ }
