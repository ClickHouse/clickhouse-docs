---
description: 'Документация по функциям работы с временными рядами'
sidebar_label: 'Временные ряды'
slug: /sql-reference/functions/time-series-functions
title: 'Функции для работы с временными рядами'
doc_type: 'reference'
---

# Функции для работы с временными рядами \{#time-series-functions\}

Следующие функции предназначены для использования совместно с агрегатными функциями `timeSeries*()`, такими как
[`timeSeriesInstantRateToGrid`](../aggregate-functions/reference/timeSeriesInstantRateToGrid.md),
[`timeSeriesLastToGrid`](../aggregate-functions/reference/timeSeriesResampleToGridWithStaleness.md)
и другими.

{/* 
  При сборке фреймворка документации содержимое приведённых ниже тегов
  заменяется документацией, сгенерированной из system.functions. Пожалуйста, не изменяйте и не удаляйте эти теги.
  См.: https://github.com/ClickHouse/clickhouse-docs/blob/main/contribute/autogenerated-documentation-from-source.md
  */ }

{/*AUTOGENERATED_START*/ }

## seriesDecomposeSTL \{#seriesDecomposeSTL\}

Добавлена в версии: v24.1

Разлагает временной ряд с использованием STL [(Seasonal-Trend Decomposition Procedure Based on Loess)](https://www.wessa.net/download/stl.pdf) на сезонную, трендовую и остаточную составляющие.

**Синтаксис**

```sql
seriesDecomposeSTL(series, period)
```

**Аргументы**

* `series` — массив числовых значений [`Array((U)Int8/16/32/64)`](/sql-reference/data-types/array) или [`Array(Float*)`](/sql-reference/data-types/array)
* `period` — положительное целое число [`UInt8/16/32/64`](/sql-reference/data-types/int-uint)

**Возвращаемое значение**

Возвращает массив из четырёх массивов, где первый массив содержит сезонные компоненты, второй массив — тренд, третий массив — остаточную компоненту, а четвёртый массив — базовую компоненту (seasonal + trend). [`Array(Array(Float32), Array(Float32), Array(Float32), Array(Float32))`](/sql-reference/data-types/array)

**Примеры**

**Разложение данных временного ряда с помощью STL**

```sql title=Query
SELECT seriesDecomposeSTL([10.1, 20.45, 40.34, 10.1, 20.45, 40.34, 10.1, 20.45, 40.34, 10.1, 20.45, 40.34, 10.1, 20.45, 40.34, 10.1, 20.45, 40.34, 10.1, 20.45, 40.34, 10.1, 20.45, 40.34], 3) AS print_0
```

```response title=Response
┌───────────print_0──────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ [[
        -13.529999, -3.1799996, 16.71,      -13.53,     -3.1799996, 16.71,      -13.53,     -3.1799996,
        16.71,      -13.530001, -3.18,      16.710001,  -13.530001, -3.1800003, 16.710001,  -13.530001,
        -3.1800003, 16.710001,  -13.530001, -3.1799994, 16.71,      -13.529999, -3.1799994, 16.709997
    ],
    [
        23.63,     23.63,     23.630003, 23.630001, 23.630001, 23.630001, 23.630001, 23.630001,
        23.630001, 23.630001, 23.630001, 23.63,     23.630001, 23.630001, 23.63,     23.630001,
        23.630001, 23.63,     23.630001, 23.630001, 23.630001, 23.630001, 23.630001, 23.630003
    ],
    [
        0, 0.0000019073486, -0.0000019073486, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -0.0000019073486, 0,
        0
    ],
    [
        10.1, 20.449999, 40.340004, 10.100001, 20.45, 40.34, 10.100001, 20.45, 40.34, 10.1, 20.45, 40.34,
        10.1, 20.45, 40.34, 10.1, 20.45, 40.34, 10.1, 20.45, 40.34, 10.100002, 20.45, 40.34
    ]]                                                                                                                   │
└────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

## seriesOutliersDetectTukey \{#seriesOutliersDetectTukey\}

Введена в версии: v24.2

Обнаруживает выбросы в данных временных рядов с помощью [ограждений Тьюки (Tukey Fences)](https://en.wikipedia.org/wiki/Outlier#Tukey%27s_fences).

**Синтаксис**

```sql
seriesOutliersDetectTukey(series[, min_percentile, max_percentile, K])
```

**Аргументы**

* `series` — массив числовых значений. [`Array((UInt8/16/32/64))`](/sql-reference/data-types/array) или [`Array(Float*)`](/sql-reference/data-types/array)
* `min_percentile` — необязательный параметр. Минимальный процентиль, используемый для вычисления межквартильного размаха [(IQR)](https://en.wikipedia.org/wiki/Interquartile_range). Значение должно быть в диапазоне [0.02, 0.98]. Значение по умолчанию — 0.25. [`Float*`](/sql-reference/data-types/float)
* `max_percentile` — необязательный параметр. Максимальный процентиль, используемый для вычисления межквартильного размаха (IQR). Значение должно быть в диапазоне [0.02, 0.98]. Значение по умолчанию — 0.75. [`Float*`](/sql-reference/data-types/float)
* `K` — необязательный параметр. Неотрицательная константа для обнаружения умеренных или более сильных выбросов. Значение по умолчанию — 1.5. [`Float*`](/sql-reference/data-types/float)

**Возвращаемое значение**

Возвращает массив той же длины, что и входной массив, где каждое значение представляет собой оценку степени возможной аномалии соответствующего элемента в ряду. Ненулевое значение оценки указывает на возможную аномалию. [`Array(Float32)`](/sql-reference/data-types/array)

**Примеры**

**Простое обнаружение выбросов**

```sql title=Query
SELECT seriesOutliersDetectTukey([-3, 2, 15, 3, 5, 6, 4, 5, 12, 45, 12, 3, 3, 4, 5, 6]) AS print_0
```

```response title=Response
┌───────────print_0─────────────────┐
│[0,0,0,0,0,0,0,0,0,27,0,0,0,0,0,0] │
└───────────────────────────────────┘
```

**Выявление выбросов с настраиваемыми параметрами**

```sql title=Query
SELECT seriesOutliersDetectTukey([-3, 2, 15, 3, 5, 6, 4.50, 5, 12, 45, 12, 3.40, 3, 4, 5, 6], 0.2, 0.8, 1.5) AS print_0
```

```response title=Response
┌─print_0──────────────────────────────┐
│ [0,0,0,0,0,0,0,0,0,19.5,0,0,0,0,0,0] │
└──────────────────────────────────────┘
```

## seriesPeriodDetectFFT \{#seriesPeriodDetectFFT\}

Добавлено в: v23.12

Определяет период заданных данных временного ряда с помощью FFT — [быстрого преобразования Фурье](https://en.wikipedia.org/wiki/Fast_Fourier_transform)

**Синтаксис**

```sql
seriesPeriodDetectFFT(series)
```

**Аргументы**

* `series` — массив числовых значений. [`Array((U)Int8/16/32/64)`](/sql-reference/data-types/array) или [`Array(Float*)`](/sql-reference/data-types/array)

**Возвращаемое значение**

Возвращает вещественное значение, равное периоду данных временного ряда. Возвращает NaN, если количество точек данных меньше четырёх. [`Float64`](/sql-reference/data-types/float)

**Примеры**

**Определение периода по простому паттерну**

```sql title=Query
SELECT seriesPeriodDetectFFT([1, 4, 6, 1, 4, 6, 1, 4, 6, 1, 4, 6, 1, 4, 6, 1, 4, 6, 1, 4, 6]) AS print_0
```

```response title=Response
┌───────────print_0──────┐
│                      3 │
└────────────────────────┘
```

**Определение периода по сложному шаблону**

```sql title=Query
SELECT seriesPeriodDetectFFT(arrayMap(x -> abs((x % 6) - 3), range(1000))) AS print_0
```

```response title=Response
┌─print_0─┐
│       6 │
└─────────┘
```

## timeSeriesCopyTag \{#timeSeriesCopyTag\}

Добавлено в версии: v26.1

Копирует указанный тег из одной группы тегов (`src_group`) в другую (`dest_group`).
Функция заменяет любые предыдущие значения копируемого тега в `dest_group`.
Если копируемый тег отсутствует в `src_group`, функция также удалит его из `dest_group`.
Функция следует логике копирования модификаторов Prometheus
[group left/group right](https://prometheus.io/docs/prometheus/latest/querying/operators/#group-modifiers).

**Синтаксис**

```sql
timeSeriesCopyTag(dest_group, src_group, tag_to_copy)
```

**Аргументы**

* `dest_group` — целевая группа тегов. [`UInt64`](/sql-reference/data-types/int-uint)
* `src_group` — исходная группа тегов. [`UInt64`](/sql-reference/data-types/int-uint)
* `tag_to_copy` — имя тега, который нужно скопировать. [`String`](/sql-reference/data-types/string)

**Возвращаемое значение**

Возвращает группу тегов, содержащую теги из `dest_group`, а также скопированные теги из `src_group`. [`UInt64`](/sql-reference/data-types/int-uint)

**Примеры**

**Пример**

```sql title=Query
SELECT timeSeriesTagsToGroup([('region', 'eu'), ('env', 'dev')], '__name__', 'http_requests_count') AS dest_group,
       timeSeriesTagsToGroup([('code', '404'), ('message', 'Page not found')], '__name__', 'http_codes') AS src_group,
       timeSeriesCopyTag(dest_group, src_group, '__name__') AS result_group,
       timeSeriesGroupToTags(result_group)
```

```response title=Response
┌─dest_group─┬─src_group─┬─result_group─┬─timeSeriesGroupToTags(result_group)────────────────────────┐
│          1 │         2 │            3 │ [('__name__','http_codes'),('code','404'),('region','eu')] │
└────────────┴───────────┴──────────────┴────────────────────────────────────────────────────────────┘
```

## timeSeriesCopyTags \{#timeSeriesCopyTags\}

Введена в: v26.1

Копирует указанные теги из одной группы тегов (`src_group`) в другую (`dest_group`).
Функция заменяет все предыдущие значения скопированных тегов в `dest_group`.
Если некоторые из копируемых тегов отсутствуют в `src_group`, функция также удалит их из `dest_group`.
Функция имитирует логику копирования модификаторов Prometheus
[group left/group right](https://prometheus.io/docs/prometheus/latest/querying/operators/#group-modifiers).

**Синтаксис**

```sql
timeSeriesCopyTags(dest_group, src_group, tags_to_copy)
```

**Аргументы**

* `dest_group` — целевая группа тегов. [`UInt64`](/sql-reference/data-types/int-uint)
* `src_group` — исходная группа тегов. [`UInt64`](/sql-reference/data-types/int-uint)
* `tags_to_copy` — имена тегов для копирования. [`Array(String)`](/sql-reference/data-types/array)

**Возвращаемое значение**

Возвращает группу тегов, которая содержит теги из `dest_group` вместе со скопированными тегами из `src_group`. [`UInt64`](/sql-reference/data-types/int-uint)

**Примеры**

**Пример**

```sql title=Query
SELECT timeSeriesTagsToGroup([('region', 'eu'), ('env', 'dev')], '__name__', 'http_requests_count') AS dest_group,
       timeSeriesTagsToGroup([('code', '404'), ('message', 'Page not found')], '__name__', 'http_codes') AS src_group,
       timeSeriesCopyTags(dest_group, src_group, ['__name__', 'code', 'env']) AS result_group,
       timeSeriesGroupToTags(result_group)
```

```response title=Response
┌─dest_group─┬─src_group─┬─result_group─┬─timeSeriesGroupToTags(result_group)────────────────────────┐
│          1 │         2 │            3 │ [('__name__','http_codes'),('code','404'),('region','eu')] │
└────────────┴───────────┴──────────────┴────────────────────────────────────────────────────────────┘
```

## timeSeriesExtractTag \{#timeSeriesExtractTag\}

Добавлена в: v26.1

Извлекает значение указанного тега из группы. Возвращает NULL, если тег не найден.
См. также функцию [timeSeriesGroupToTags()](/sql-reference/functions/time-series-functions#timeSeriesGroupToTags).

**Синтаксис**

```sql
timeSeriesExtractTag(group)
```

**Аргументы**

* `group` — Группа тегов. [`UInt64`](/sql-reference/data-types/int-uint)
* `tag_to_extract` — Имя тега, который нужно извлечь из группы. [`String`](/sql-reference/data-types/string)

**Возвращаемое значение**

Возвращает значение указанного тега. [`Nullable(String)`](/sql-reference/data-types/nullable)

**Примеры**

**Пример**

```sql title=Query
SELECT timeSeriesTagsToGroup([('region', 'eu'), ('env', 'dev')], '__name__', 'http_requests_count') AS group,
       timeSeriesExtractTag(group, '__name__'),
       timeSeriesExtractTag(group, 'env'),
       timeSeriesExtractTag(group, 'instance')
```

```response title=Response
┌─group─┬─timeSeriesExtractTag(group, '__name__')─┬─timeSeriesExtractTag(group, 'env')─┬─timeSeriesExtractTag(group, 'instance')─┐
│     1 │ http_requests_count                     │ dev                                │ ᴺᵁᴸᴸ                                    │
└───────┴─────────────────────────────────────────┴────────────────────────────────────┴─────────────────────────────────────────┘
```

## timeSeriesFromGrid \{#timeSeriesFromGrid\}

Введена в версии: v25.8

Преобразует массив значений `[x1, x2, x3, ...]` в массив кортежей
`[(start_timestamp, x1), (start_timestamp + step, x2), (start_timestamp + 2 * step, x3), ...]`.

Текущая метка времени увеличивается на `step` до тех пор, пока не станет больше `end_timestamp`.
Если количество значений не совпадает с количеством меток времени, функция выбрасывает исключение.

Значения NULL в `[x1, x2, x3, ...]` пропускаются, но при этом текущая метка времени всё равно увеличивается.
Например, для `[value1, NULL, x2]` функция возвращает `[(start_timestamp, x1), (start_timestamp + 2 * step, x2)]`.

**Синтаксис**

```sql
timeSeriesFromGrid(start_timestamp, end_timestamp, step, values)
```

**Аргументы**

* `start_timestamp` — Начало временной сетки. [`DateTime64`](/sql-reference/data-types/datetime64) или [`DateTime`](/sql-reference/data-types/datetime) или [`UInt32`](/sql-reference/data-types/int-uint)
* `end_timestamp` — Конец временной сетки. [`DateTime64`](/sql-reference/data-types/datetime64) или [`DateTime`](/sql-reference/data-types/datetime) или [`UInt32`](/sql-reference/data-types/int-uint)
* `step` — Шаг сетки в секундах, [`Decimal64`](/sql-reference/data-types/decimal) или [`Decimal32`](/sql-reference/data-types/decimal) или [`UInt32/64`](/sql-reference/data-types/int-uint)
* `values` — Массив значений [`Array(Float*)`](/sql-reference/data-types/array) или [`Array(Nullable(Float*))`](/sql-reference/data-types/array)

**Возвращаемое значение**

Возвращает значения из исходного массива, объединённые с метками времени на регулярной временной сетке, задаваемой `start_timestamp` и `step`. [`Array(Tuple(DateTime64, Float64))`](/sql-reference/data-types/array)

**Примеры**

**Пример использования**

```sql title=Query
SELECT timeSeriesFromGrid('2025-06-01 00:00:00'::DateTime64(3), '2025-06-01 00:01:30.000'::DateTime64(3), 30, [10, 20, NULL, 30]) AS result;
```

```response title=Response
┌─────────────────────────────────────────────result─────────────────────────────────────────────┐
│ [('2025-06-01 00:00:00.000',10),('2025-06-01 00:00:30.000',20),('2025-06-01 00:01:30.000',30)] │
└────────────────────────────────────────────────────────────────────────────────────────────────┘
```

## timeSeriesGroupToTags \{#timeSeriesGroupToTags\}

Добавлена в версии: v26.1

Возвращает имена и значения тегов, связанных с указанной группой.
См. также функцию [timeSeriesTagsToGroup()](/sql-reference/functions/time-series-functions#timeSeriesTagsToGroup).

**Синтаксис**

```sql
timeSeriesGroupToTags(group)
```

**Псевдонимы**: `timeSeriesTagsGroupToTags`

**Аргументы**

* `group` — группа тегов типа [`UInt64`](/sql-reference/data-types/int-uint)

**Возвращаемое значение**

Возвращает массив пар `(tag_name, tag_value)`.
Возвращаемый массив всегда отсортирован по `tag_name` и не содержит повторяющихся значений `tag_name`.
[`Array(Tuple(String, String))`](/sql-reference/data-types/array)

**Примеры**

**Пример**

```sql title=Query
SELECT timeSeriesTagsToGroup([('region', 'eu'), ('env', 'dev')], '__name__', 'http_requests_count') AS group,
       timeSeriesGroupToTags(group) AS sorted_tags,
       timeSeriesTagsToGroup(sorted_tags) AS same_group,
       throwIf(same_group != group)
```

```response title=Response
┌─group─┬─sorted_tags────────────────────────────────────────────────────────┬─same_group─┬─throwIf(notE⋯up, group))─┐
│     1 │ [('__name__','http_requests_count'),('env','dev'),('region','eu')] │          1 │                        0 │
└───────┴────────────────────────────────────────────────────────────────────┴────────────┴──────────────────────────┘
```

## timeSeriesIdToGroup \{#timeSeriesIdToGroup\}

Добавлена в версии: v26.1

Возвращает имена и значения тегов, связанных с указанным идентификатором временного ряда.
См. также функцию [timeSeriesStoreTags()](/sql-reference/functions/time-series-functions#timeSeriesStoreTags).

**Синтаксис**

```sql
timeSeriesIdToGroup(id)
```

**Псевдонимы**: `timeSeriesIdToTagsGroup`

**Аргументы**

* `id` — идентификатор временного ряда. [`UInt64`](/sql-reference/data-types/int-uint) или [`UInt128`](/sql-reference/data-types/int-uint) или [`UUID`](/sql-reference/data-types/uuid) или [`FixedString(16)`](/sql-reference/data-types/fixedstring)

**Возвращаемое значение**

Возвращает группу тегов, связанных с идентификатором временного ряда `id`. [`UInt64`](/sql-reference/data-types/int-uint)

**Примеры**

**Пример**

```sql title=Query
SELECT 8374283493092 AS id,
       timeSeriesStoreTags(id, [('region', 'eu'), ('env', 'dev')], '__name__', 'http_requests_count') AS same_id,
       throwIf(same_id != id),
       timeSeriesIdToGroup(same_id) AS group,
       timeSeriesGroupToTags(group)
```

```response title=Response
┌────────────id─┬───────same_id─┬─throwIf(notE⋯me_id, id))─┬─group─┬─timeSeriesGroupToTags(group)───────────────────────────────────────┐
│ 8374283493092 │ 8374283493092 │                        0 │     1 │ [('__name__','http_requests_count'),('env','dev'),('region','eu')] │
└───────────────┴───────────────┴──────────────────────────┴───────┴────────────────────────────────────────────────────────────────────┘
```

## timeSeriesIdToTags \{#timeSeriesIdToTags\}

Появилась в версии: v25.8

Возвращает теги, связанные с указанным идентификатором временного ряда.
См. также функцию [timeSeriesStoreTags()](/sql-reference/functions/time-series-functions#timeSeriesStoreTags).

**Синтаксис**

```sql
timeSeriesIdToTags(id)
```

**Аргументы**

* `id` — идентификатор временного ряда. [`UInt64`](/sql-reference/data-types/int-uint) или [`UInt128`](/sql-reference/data-types/int-uint) или [`UUID`](/sql-reference/data-types/uuid) или [`FixedString(16)`](/sql-reference/data-types/fixedstring)

**Возвращаемое значение**

Возвращает массив пар `(tag_name, tag_value)`.
Возвращаемый массив всегда отсортирован по `tag_name` и не содержит повторяющихся значений `tag_name`.
[`Array(Tuple(String, String))`](/sql-reference/data-types/array)

**Примеры**

**Пример**

```sql title=Query
SELECT 8374283493092 AS id,
       timeSeriesStoreTags(id, [('region', 'eu'), ('env', 'dev')], '__name__', 'http_requests_count') AS same_id,
       throwIf(same_id != id),
       timeSeriesIdToTags(same_id)
```

```response title=Response
┌────────────id─┬───────same_id─┬─throwIf(notE⋯me_id, id))─┬─timeSeriesIdToTags(same_id)────────────────────────────────────────┐
│ 8374283493092 │ 8374283493092 │                        0 │ [('__name__','http_requests_count'),('env','dev'),('region','eu')] │
└───────────────┴───────────────┴──────────────────────────┴────────────────────────────────────────────────────────────────────┘
```

## timeSeriesJoinTags \{#timeSeriesJoinTags\}

Добавлена в: v26.1

Объединяет значения указанных тегов, извлечённых из группы тегов.
Функция вставляет разделитель между объединёнными значениями и возвращает новую группу тегов
с тегом `dest_tag`, установленным в объединённое значение.
Эта функция воспроизводит логику функции Prometheus
[label&#95;join()](https://prometheus.io/docs/prometheus/latest/querying/functions/#label_join).

**Синтаксис**

```sql
timeSeriesJoinTags(group, dest_tag, separator, src_tags)
```

**Аргументы**

* `group` — группа тегов. [`UInt64`](/sql-reference/data-types/int-uint)
* `dest_tag` — имя тега с объединённым результатом, который будет добавлен в `group`. [`String`](/sql-reference/data-types/string)
* `separator` — разделитель, вставляемый между объединяемыми значениями. [`String`](/sql-reference/data-types/string)
* `src_tags` — имена исходных тегов со значениями, которые будут объединены. [`Array(String)`](/sql-reference/data-types/array)

**Возвращаемое значение**

Возвращает новую группу тегов с тегом `dest_tag`, установленным в значение объединённого результата. [`UInt64`](/sql-reference/data-types/int-uint)

**Примеры**

**Пример**

```sql title=Query
SELECT timeSeriesTagsToGroup([('__name__', 'up'), ('job', 'api-server'), ('src1', 'a'), ('src2', 'b'), ('src3', 'c')]) AS group,
       timeSeriesJoinTags(group, 'foo', ',', ['src1', 'src2', 'src3']) AS result_group,
       timeSeriesGroupToTags(result_group)
```

```response title=Response
┌─group─┬─result_group─┬─timeSeriesGroupToTags(result_group)─────────────────────────────────────────────────────────────┐
│     1 │            2 │ [('__name__','up'),('foo','a,b,c'),('job','api-server'),('src1','a'),('src2','b'),('src3','c')] │
└───────┴──────────────┴─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

## timeSeriesRange \{#timeSeriesRange\}

Введена в версии: v25.8

Генерирует диапазон меток времени [start&#95;timestamp, start&#95;timestamp + step, start&#95;timestamp + 2 * step, ..., end&#95;timestamp].

Если `start_timestamp` равен `end_timestamp`, функция возвращает массив из одного элемента, содержащий `[start_timestamp]`.

Функция `timeSeriesRange()` аналогична функции [range](../functions/array-functions.md#range).

**Синтаксис**

```sql
timeSeriesRange(start_timestamp, end_timestamp, step)
```

**Аргументы**

* `start_timestamp` — Начало диапазона. [`DateTime64`](/sql-reference/data-types/datetime64) или [`DateTime`](/sql-reference/data-types/datetime) или [`UInt32`](/sql-reference/data-types/int-uint)
* `end_timestamp` — Конец диапазона. [`DateTime64`](/sql-reference/data-types/datetime64) или [`DateTime`](/sql-reference/data-types/datetime) или [`UInt32`](/sql-reference/data-types/int-uint)
* `step` — Шаг диапазона в секундах. [`UInt32/64`](/sql-reference/data-types/int-uint) или [`Decimal32/64`](/sql-reference/data-types/decimal)

**Возвращаемое значение**

Возвращает диапазон меток времени. [`Array(DateTime64)`](/sql-reference/data-types/array)

**Примеры**

**Пример использования**

```sql title=Query
SELECT timeSeriesRange('2025-06-01 00:00:00'::DateTime64(3), '2025-06-01 00:01:00'::DateTime64(3), 30)
```

```response title=Response
┌────────────────────────────────────result─────────────────────────────────────────┐
│ ['2025-06-01 00:00:00.000', '2025-06-01 00:00:30.000', '2025-06-01 00:01:00.000'] │
└───────────────────────────────────────────────────────────────────────────────────┘
```

## timeSeriesRemoveAllTagsExcept \{#timeSeriesRemoveAllTagsExcept\}

Добавлена в версии v26.1

Удаляет все теги, кроме указанных, из группы тегов.
См. также функции [timeSeriesRemoveTag()](/sql-reference/functions/time-series-functions#timeSeriesRemoveTag),
[timeSeriesRemoveTags()](/sql-reference/functions/time-series-functions#timeSeriesRemoveTags).

**Синтаксис**

```sql
timeSeriesRemoveAllTagsExcept(group, tags_to_keep)
```

**Аргументы**

* `group` — группа тегов. [`UInt64`](/sql-reference/data-types/int-uint)
* `tags_to_keep` — имена тегов, которые нужно оставить в группе. [`Array(String)`](/sql-reference/data-types/array)

**Возвращаемое значение**

Новая группа тегов, в которой сохранены только указанные теги. [`UInt64`](/sql-reference/data-types/int-uint)

**Примеры**

**Пример**

```sql title=Query
SELECT timeSeriesTagsToGroup([('region', 'eu'), ('env', 'dev')], '__name__', 'http_requests_count') AS group,
       timeSeriesRemoveAllTagsExcept(group, ['env']) AS result_group,
       timeSeriesGroupToTags(result_group)
```

```response title=Response
┌─group─┬─result_group─┬─timeSeriesGroupToTags(result_group)─┐
│     1 │            2 │ [('env','dev')]                     │
└───────┴──────────────┴─────────────────────────────────────┘
```

## timeSeriesRemoveTag \{#timeSeriesRemoveTag\}

Введена в версии v26.1

Удаляет указанный тег из группы тегов.
Если в группе нет такого тега, группа возвращается без изменений.
См. также функции [timeSeriesRemoveTags()](/sql-reference/functions/time-series-functions#timeSeriesRemoveTags),
[timeSeriesRemoveAllTagsExcept()](/sql-reference/functions/time-series-functions#timeSeriesRemoveAllTagsExcept).

**Синтаксис**

```sql
timeSeriesRemoveTag(group, tag_to_remove)
```

**Аргументы**

* `group` — группа тегов. [`UInt64`](/sql-reference/data-types/int-uint)
* `tag_to_remove` — имя тега, который нужно удалить из группы. [`String`](/sql-reference/data-types/string)

**Возвращаемое значение**

Новая группа тегов без указанного тега. [`UInt64`](/sql-reference/data-types/int-uint)

**Примеры**

**Пример**

```sql title=Query
SELECT timeSeriesTagsToGroup([('region', 'eu'), ('env', 'dev')], '__name__', 'http_requests_count') AS group_of_3,
       timeSeriesRemoveTag(group_of_3, '__name__') AS group_of_2,
       timeSeriesGroupToTags(group_of_2),
       timeSeriesRemoveTag(group_of_2, 'env') AS group_of_1,
       timeSeriesGroupToTags(group_of_1),
       timeSeriesRemoveTag(group_of_1, 'region') AS empty_group,
       timeSeriesGroupToTags(empty_group)
```

```response title=Response
┌─group_of_3─┬─group_of_2─┬─timeSeriesGroupToTags(group_of_2)─┬─group_of_1─┬─timeSeriesGroupToTags(group_of_1)─┬─empty_group─┬─timeSeriesGroupToTags(empty_group)─┐
│          1 │          2 │ [('env','dev'),('region','eu')]   │          3 │ [('region','eu')]                 │           0 │ []                                 │
└────────────┴────────────┴───────────────────────────────────┴────────────┴───────────────────────────────────┴─────────────┴────────────────────────────────────┘
```

## timeSeriesRemoveTags \{#timeSeriesRemoveTags\}

Впервые появилась в версии v26.1

Удаляет указанные теги из группы тегов.
Если некоторых из указанных тегов нет в группе тегов, функция их игнорирует.
См. также функции [timeSeriesRemoveTag()](/sql-reference/functions/time-series-functions#timeSeriesRemoveTag),
[timeSeriesRemoveAllTagsExcept()](/sql-reference/functions/time-series-functions#timeSeriesRemoveAllTagsExcept).

**Синтаксис**

```sql
timeSeriesRemoveTags(group, tags_to_remove)
```

**Аргументы**

* `group` — Группа тегов. [`UInt64`](/sql-reference/data-types/int-uint)
* `tags_to_remove` — Имена тегов, которые нужно удалить из группы. [`Array(String)`](/sql-reference/data-types/array)

**Возвращаемое значение**

Новая группа тегов без указанных тегов. [`UInt64`](/sql-reference/data-types/int-uint)

**Примеры**

**Пример**

```sql title=Query
SELECT timeSeriesTagsToGroup([('region', 'eu'), ('env', 'dev')], '__name__', 'http_requests_count') AS group_of_3,
       timeSeriesRemoveTags(group_of_3, ['env', 'region']) AS group_of_1,
       timeSeriesGroupToTags(group_of_1),
       timeSeriesRemoveTags(group_of_1, ['__name__', 'nonexistent']) AS empty_group,
       timeSeriesGroupToTags(empty_group)
```

```response title=Response
┌─group_of_3─┬─group_of_1─┬─timeSeriesGroupToTags(group_of_1)────┬─empty_group─┬─timeSeriesGroupToTags(empty_group)─┐
│          1 │          2 │ [('__name__','http_requests_count')] │           0 │ []                                 │
└────────────┴────────────┴──────────────────────────────────────┴─────────────┴────────────────────────────────────┘
```

## timeSeriesReplaceTag \{#timeSeriesReplaceTag\}

Впервые представлено в: v26.1

Сопоставляет регулярное выражение `regex` со значением тега `src_tag`.
Если сопоставление успешно, значение тега `dest_tag` в результирующем наборе будет подстановкой `replacement`,
вместе с исходными тегами во входных данных.
Эта функция имитирует логику функции prometheus
[label&#95;replace()](https://prometheus.io/docs/prometheus/latest/querying/functions/#label_replace).

**Синтаксис**

```sql
timeSeriesReplaceTag(group, dest_tag, replacement, src_tag, regex)
```

**Аргументы**

* `group` — группа тегов. [`UInt64`](/sql-reference/data-types/int-uint)
* `dest_tag` — имя целевого тега, в который записывается результирующая группа. [`String`](/sql-reference/data-types/string)
* `replacement` — шаблон замены, может содержать $1, $2 или $name для обращения к захватывающим группам в регулярном выражении «regex». [`String`](/sql-reference/data-types/string)
* `src_tag` — имя тега, значение которого используется для сопоставления с регулярным выражением «regex». [`String`](/sql-reference/data-types/string)
* `regex` — регулярное выражение. [`String`](/sql-reference/data-types/string)

**Возвращаемое значение**

Новая группа тегов, возможно с добавлением `dest_tag`. [`UInt64`](/sql-reference/data-types/int-uint)

**Примеры**

**Пример**

```sql title=Query
SELECT timeSeriesTagsToGroup([('__name__', 'up'), ('job', 'api-server'), ('service', 'a:c')]) AS group,
       timeSeriesReplaceTag(group, 'foo', '$1', 'service', '(.*):.*') AS result_group,
       timeSeriesGroupToTags(result_group)
```

```response title=Response
┌─group─┬─result_group─┬─timeSeriesGroupToTags(result_group)────────────────────────────────────┐
│     1 │            2 │ [('__name__','up'),('foo','a'),('job','api-server'),('service','a:c')] │
└───────┴──────────────┴────────────────────────────────────────────────────────────────────────┘
```

## timeSeriesStoreTags \{#timeSeriesStoreTags\}

Добавлено в версии: v25.8

Сохраняет в контексте запроса соответствие между указанным идентификатором временного ряда и набором тегов.
Функции [timeSeriesIdToTags()](/sql-reference/functions/time-series-functions#timeSeriesIdToTags)
и [timeSeriesIdToGroup()](/sql-reference/functions/time-series-functions#timeSeriesIdToGroup)
могут использоваться для доступа к этому соответствию позже во время выполнения запроса.

**Синтаксис**

```sql
timeSeriesStoreTags(id, tags_array, separate_tag_name_1, separate_tag_value_1, ...)
```

**Аргументы**

* `id` — Идентификатор временного ряда. [`UInt64`](/sql-reference/data-types/int-uint) или [`UInt128`](/sql-reference/data-types/int-uint) или [`UUID`](/sql-reference/data-types/uuid) или [`FixedString(16)`](/sql-reference/data-types/fixedstring)
* `tags_array` — Массив пар (tag&#95;name, tag&#95;value). [`Array(Tuple(String, String))`](/sql-reference/data-types/array) или [`NULL`](/sql-reference/syntax#null)
* `separate_tag_name_i` — Имя тега. [`String`](/sql-reference/data-types/string) или [`FixedString`](/sql-reference/data-types/fixedstring)
* `separate_tag_value_i` — Значение тега. [`String`](/sql-reference/data-types/string) или [`FixedString`](/sql-reference/data-types/fixedstring) или [`Nullable(String)`](/sql-reference/data-types/nullable)

**Возвращаемое значение**

Возвращает идентификатор временного ряда (т. е. просто первый аргумент).

**Примеры**

**Пример**

```sql title=Query
SELECT 8374283493092 AS id,
       timeSeriesStoreTags(id, [('region', 'eu'), ('env', 'dev')], '__name__', 'http_requests_count') AS same_id,
       throwIf(same_id != id),
       timeSeriesIdToTags(same_id),
       timeSeriesGroupToTags(timeSeriesIdToGroup(same_id))
```

```response title=Response
┌────────────id─┬───────same_id─┬─throwIf(notEquals(same_id, id))─┬─timeSeriesIdToTags(same_id)────────────────────────────────────────┬─timeSeriesGroupToTags(timeSeriesIdToGroup(same_id))────────────────┐
│ 8374283493092 │ 8374283493092 │                               0 │ [('__name__','http_requests_count'),('env','dev'),('region','eu')] │ [('__name__','http_requests_count'),('env','dev'),('region','eu')] │
└───────────────┴───────────────┴─────────────────────────────────┴────────────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────┘
```

## timeSeriesTagsToGroup \{#timeSeriesTagsToGroup\}

Введена в версии v26.1

Возвращает группу тегов, связанную с указанными тегами.
Если одна и та же группа тегов встречается несколько раз при выполнении запроса, функция возвращает одну и ту же группу.
Для пустого набора тегов функция всегда возвращает значение 0.
См. также функцию [timeSeriesGroupToTags()](/sql-reference/functions/time-series-functions#timeSeriesGroupToTags).

**Синтаксис**

```sql
timeSeriesTagsToGroup(tags_array, tag_name_1, tag_value_1, tag_name2, tag_value2, ...)
```

**Аргументы**

* `tags_array` — Массив пар (tag&#95;name, tag&#95;value). [`Array(Tuple(String, String))`](/sql-reference/data-types/array) или [`NULL`](/sql-reference/syntax#null)
* `tag_name_i` — Имя тега. [`String`](/sql-reference/data-types/string) или [`FixedString`](/sql-reference/data-types/fixedstring)
* `tag_value_i` — Значение тега. [`String`](/sql-reference/data-types/string) или [`FixedString`](/sql-reference/data-types/fixedstring) или [`Nullable(String)`](/sql-reference/data-types/nullable)

**Возвращаемое значение**

Возвращает группу тегов, связанную с указанными тегами. [`UInt64`](/sql-reference/data-types/int-uint)

**Примеры**

**Пример**

```sql title=Query
SELECT timeSeriesTagsToGroup([('region', 'eu'), ('env', 'dev')], '__name__', 'http_requests_count') AS group1,
       timeSeriesTagsToGroup([], '__name__', 'http_failures') AS group2,
       timeSeriesTagsToGroup([]) AS empty_group,
       timeSeriesTagsToGroup([], '__name__', 'http_failures') AS same_group2,
       throwIf(same_group2 != group2),
       timeSeriesGroupToTags(group2)
```

```response title=Response
┌─group1─┬─group2─┬─empty_group─┬─same_group2─┬─throwIf(notEquals(same_group2, group2))─┬─timeSeriesGroupToTags(group2)──┐
│      1 │      2 │           0 │           2 │                                       0 │ [('__name__','http_failures')] │
└────────┴────────┴─────────────┴─────────────┴─────────────────────────────────────────┴────────────────────────────────┘
```

{/*AUTOGENERATED_END*/ }
