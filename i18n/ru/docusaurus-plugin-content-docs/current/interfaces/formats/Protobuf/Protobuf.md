---
title: Protobuf
slug: /interfaces/formats/Protobuf
keywords: ['Protobuf']
input_format: true
output_format: true
alias: []
---

import CloudNotSupportedBadge from '@theme/badges/CloudNotSupportedBadge';

<CloudNotSupportedBadge/>

| Вход  | Выход | Псевдоним |
|-------|--------|-----------|
| ✔     | ✔      |           |

## Описание {#description}

Формат `Protobuf` - это формат [Protocol Buffers](https://protobuf.dev/).

Этот формат требует внешнюю схему формата, которая кэшируется между запросами.

ClickHouse поддерживает:
- синтаксисы `proto2` и `proto3`.
- поля `Repeated`/`optional`/`required`.

## Примеры использования {#example-usage}

### Основные примеры {#basic-examples}

Примеры использования:

```sql
SELECT * FROM test.table FORMAT Protobuf SETTINGS format_schema = 'schemafile:MessageType'
```

```bash
cat protobuf_messages.bin | clickhouse-client --query "INSERT INTO test.table SETTINGS format_schema='schemafile:MessageType' FORMAT Protobuf"
```

Где файл `schemafile.proto` выглядит следующим образом:

```capnp
syntax = "proto3";

message MessageType {
  string name = 1;
  string surname = 2;
  uint32 birthDate = 3;
  repeated string phoneNumbers = 4;
};
```

Чтобы найти соответствие между колонками таблицы и полями типа сообщения Protocol Buffers, ClickHouse сравнивает их названия.
Это сравнение нечувствительно к регистру, и символы `_` (подчеркивание) и `.` (точка) считаются равными.
Если типы колонки и поля сообщения Protocol Buffers различаются, применяется необходимое преобразование.

Поддерживаются вложенные сообщения. Например, для поля `z` в следующем типе сообщения:

```capnp
message MessageType {
  message XType {
    message YType {
      int32 z;
    };
    repeated YType y;
  };
  XType x;
};
```

ClickHouse пытается найти колонку с именем `x.y.z` (или `x_y_z` или `X.y_Z` и так далее).

Вложенные сообщения подходят для ввода или вывода [вложенных структур данных](/sql-reference/data-types/nested-data-structures/index.md).

Значения по умолчанию, определенные в схеме protobuf, как в следующем примере, не применяются; вместо этого используются [значения по умолчанию таблицы](/sql-reference/statements/create/table#default_values):

```capnp
syntax = "proto2";

message MessageType {
  optional int32 result_per_page = 3 [default = 10];
}
```

ClickHouse вводит и выводит сообщения protobuf в формате `length-delimited`.
Это означает, что перед каждым сообщением его длина должна быть записана как [целое число переменной длины (varint)](https://developers.google.com/protocol-buffers/docs/encoding#varints).

Смотрите также: [как читать/писать сообщения protobuf с разделителями длины на популярных языках](https://cwiki.apache.org/confluence/display/GEODE/Delimiting+Protobuf+Messages).

### Использование автоматически сгенерированной схемы {#using-autogenerated-protobuf-schema}

Если у вас нет внешней схемы Protobuf для ваших данных, вы все равно можете вводить/выводить данные в формате Protobuf, используя автоматически сгенерированную схему.

Например:

```sql
SELECT * FROM test.hits format Protobuf SETTINGS format_protobuf_use_autogenerated_schema=1
```

В этом случае ClickHouse будет автоматически генерировать схему Protobuf в соответствии с структурой таблицы, используя функцию [`structureToProtobufSchema`](/sql-reference/functions/other-functions.md#structure_to_protobuf_schema).
Затем он будет использовать эту схему для сериализации данных в формате Protobuf.

Вы также можете прочитать файл Protobuf с автоматически сгенерированной схемой. В этом случае необходимо, чтобы файл был создан с использованием той же схемы:

```bash
$ cat hits.bin | clickhouse-client --query "INSERT INTO test.hits SETTINGS format_protobuf_use_autogenerated_schema=1 FORMAT Protobuf"
```

Настройка [`format_protobuf_use_autogenerated_schema`](/operations/settings/settings-formats.md#format_protobuf_use_autogenerated_schema) включена по умолчанию и применяется, если [`format_schema`](/operations/settings/formats#format_schema) не задана.

Вы также можете сохранить автоматически сгенерированную схему в файл во время ввода/вывода, используя настройку [`output_format_schema`](/operations/settings/formats#output_format_schema). Например:

```sql
SELECT * FROM test.hits format Protobuf SETTINGS format_protobuf_use_autogenerated_schema=1, output_format_schema='path/to/schema/schema.proto'
```
В этом случае автоматически сгенерированная схема Protobuf будет сохранена в файл `path/to/schema/schema.capnp`.

### Сброс кэша Protobuf {#drop-protobuf-cache}

Чтобы перезагрузить схему Protobuf, загруженную из [`format_schema_path`](/operations/server-configuration-parameters/settings.md/#format_schema_path), используйте оператор [`SYSTEM DROP ... FORMAT CACHE`](/sql-reference/statements/system.md/#system-drop-schema-format).

```sql
SYSTEM DROP FORMAT SCHEMA CACHE FOR Protobuf
```

## Настройки формата {#format-settings}
