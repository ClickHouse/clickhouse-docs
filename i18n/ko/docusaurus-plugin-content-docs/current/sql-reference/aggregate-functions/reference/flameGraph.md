---
description: '스택트레이스 목록을 사용하여 플레임 그래프(flame graph)를 생성하는 집계 함수(aggregate function)입니다.'
slug: /sql-reference/aggregate-functions/reference/flame_graph
title: 'flameGraph'
doc_type: 'reference'
---

{/*AUTOGENERATED_START*/ }

## flameGraph \{#flameGraph\}

도입 버전: v23.8

스택 트레이스 목록을 사용해 [flamegraph](https://www.brendangregg.com/flamegraphs.html)을(를) 생성합니다.
flamegraph의 SVG를 렌더링하기 위해 [flamegraph.pl](https://github.com/brendangregg/FlameGraph) 유틸리티에서 사용할 수 있는 문자열 배열을 출력합니다.

:::note
`ptr != 0`인 경우, flameGraph는 동일한 size와 ptr을 가진 할당(size &gt; 0)과 해제(size &lt; 0)를 서로 매칭합니다.
해제되지 않은 할당만 표시됩니다.
매핑되지 않은 해제는 무시됩니다.
:::

**구문**

```sql
flameGraph(traces[, size[, ptr]])
```

**인수**

* `traces` — 스택 트레이스입니다. [`Array(UInt64)`](/sql-reference/data-types/array)
* `size` — 선택적 인수입니다. 메모리 프로파일링을 위한 할당 크기입니다(기본값 1). [`UInt64`](/sql-reference/data-types/int-uint)
* `ptr` — 선택적 인수입니다. 할당 주소입니다(기본값 0). [`UInt64`](/sql-reference/data-types/int-uint)

**반환 값**

flamegraph.pl 유틸리티에서 사용할 문자열 배열을 반환합니다. [`Array(String)`](/sql-reference/data-types/array)

**예시**

**CPU 쿼리 프로파일러를 기반으로 flamegraph를 생성하기**

```sql title=Query
SET query_profiler_cpu_time_period_ns=10000000;
SELECT SearchPhrase, COUNT(DISTINCT UserID) AS u FROM hits WHERE SearchPhrase <> '' GROUP BY SearchPhrase ORDER BY u DESC LIMIT 10;
```

```response title=Response
clickhouse client --allow_introspection_functions=1 -q "select arrayJoin(flameGraph(arrayReverse(trace))) from system.trace_log where trace_type = 'CPU' and query_id = 'xxx'" | ~/dev/FlameGraph/flamegraph.pl  > flame_cpu.svg
```

**메모리 쿼리 프로파일러를 기반으로 모든 메모리 할당을 시각화하는 flamegraph 생성**

```sql title=Query
SET memory_profiler_sample_probability=1, max_untracked_memory=1;
SELECT SearchPhrase, COUNT(DISTINCT UserID) AS u FROM hits WHERE SearchPhrase <> '' GROUP BY SearchPhrase ORDER BY u DESC LIMIT 10;
```

```response title=Response
clickhouse client --allow_introspection_functions=1 -q "select arrayJoin(flameGraph(trace, size)) from system.trace_log where trace_type = 'MemorySample' and query_id = 'xxx'" | ~/dev/FlameGraph/flamegraph.pl --countname=bytes --color=mem > flame_mem.svg
```

**메모리 쿼리 프로파일러를 기반으로 해제되지 않은 메모리 할당을 보여주는 flamegraph 생성하기**

```sql title=Query
SET memory_profiler_sample_probability=1, max_untracked_memory=1, use_uncompressed_cache=1, merge_tree_max_rows_to_use_cache=100000000000, merge_tree_max_bytes_to_use_cache=1000000000000;
SELECT SearchPhrase, COUNT(DISTINCT UserID) AS u FROM hits WHERE SearchPhrase <> '' GROUP BY SearchPhrase ORDER BY u DESC LIMIT 10;
```

```response title=Response
clickhouse client --allow_introspection_functions=1 -q "SELECT arrayJoin(flameGraph(trace, size, ptr)) FROM system.trace_log WHERE trace_type = 'MemorySample' AND query_id = 'xxx'" | ~/dev/FlameGraph/flamegraph.pl --countname=bytes --color=mem > flame_mem_untracked.svg
```

**메모리 쿼리 프로파일러를 기반으로, 특정 시점의 활성 메모리 할당을 보여주는 플레임 그래프를 생성합니다**

```sql title=Query
SET memory_profiler_sample_probability=1, max_untracked_memory=1;
SELECT SearchPhrase, COUNT(DISTINCT UserID) AS u FROM hits WHERE SearchPhrase <> '' GROUP BY SearchPhrase ORDER BY u DESC LIMIT 10;

-- 1. Memory usage per second
SELECT event_time, m, formatReadableSize(max(s) AS m) FROM (SELECT event_time, sum(size) OVER (ORDER BY event_time) AS s FROM system.trace_log WHERE query_id = 'xxx' AND trace_type = 'MemorySample') GROUP BY event_time ORDER BY event_time;

-- 2. Find a time point with maximal memory usage
SELECT argMax(event_time, s), max(s) FROM (SELECT event_time, sum(size) OVER (ORDER BY event_time) AS s FROM system.trace_log WHERE query_id = 'xxx' AND trace_type = 'MemorySample');
```

```response title=Response
-- 3. Fix active allocations at fixed point of time
clickhouse client --allow_introspection_functions=1 -q "SELECT arrayJoin(flameGraph(trace, size, ptr)) FROM (SELECT * FROM system.trace_log WHERE trace_type = 'MemorySample' AND query_id = 'xxx' AND event_time <= 'yyy' ORDER BY event_time\)\" | ~/dev/FlameGraph/flamegraph.pl --countname=bytes --color=mem > flame_mem_time_point_pos.svg

-- 4. Find deallocations at fixed point of time
clickhouse client --allow_introspection_functions=1 -q "SELECT arrayJoin(flameGraph(trace, -size, ptr)) FROM (SELECT * FROM system.trace_log WHERE trace_type = 'MemorySample' AND query_id = 'xxx' AND event_time > 'yyy' ORDER BY event_time desc\)\" | ~/dev/FlameGraph/flamegraph.pl --countname=bytes --color=mem > flame_mem_time_point_neg.svg
```

{/*AUTOGENERATED_END*/ }
