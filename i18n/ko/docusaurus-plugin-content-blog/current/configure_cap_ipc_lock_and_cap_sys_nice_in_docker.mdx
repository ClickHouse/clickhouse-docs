---
title: Docker에서 CAP_IPC_LOCK 및 CAP_SYS_NICE Capability 구성하기
description: 컨테이너에서 ClickHouse를 실행할 때 `CAP_IPC_LOCK` 및 `CAP_SYS_NICE`와 관련된 Docker capability 경고를 해결하는 방법을 설명합니다.
date: 2023-06-07
tags: ['오류 및 예외']
keywords: ['Docker', 'CAP_IPC_LOCK', 'CAP_SYS_NICE']
---

{frontMatter.description}

{/* 생략 */}

## Question \{#question\}

Docker에서 ClickHouse를 실행할 때 Docker가 시스템에 `CAP_IPC_LOCK` 및 `CAP_SYS_NICE` capability(권한)이 없다고 보고합니다. 이를 어떻게 해결할 수 있습니까?

`CAP_SYS_NICE` 또는 `CAP_SYS_NICE` capability(권한)이 없을 때 출력되는 로그 메시지는 다음과 같습니다:

```bash
docker run -d --name clickhouse-server \
    --ulimit nofile=262144:262144 \
    --network clickhouse-net \
    -p 8123:8123 -p 9000:9000 -p 9009:9009 -p 9363:9363 \
    clickhouse/clickhouse-server:23.2
```

```response
2023.04.19 08:04:10.022720 [ 1 ] {} <Information> Application: It looks like the process has no CAP_IPC_LOCK capability, binary mlock will be disabled. It could happen due to incorrect ClickHouse package installation. You could resolve the problem manually with 'sudo setcap cap_ipc_lock=+ep /usr/bin/clickhouse'. Note that it will not work on 'nosuid' mounted filesystems.

2023.04.19 08:04:10.065860 [ 1 ] {} <Information> Application: It looks like the process has no CAP_SYS_NICE capability, the setting 'os_thread_priority' will have no effect. It could happen due to incorrect ClickHouse package installation. You could resolve the problem manually with 'sudo setcap cap_sys_nice=+ep /usr/bin/clickhouse'. Note that it will not work on 'nosuid' mounted filesystems.
```

## 답변 \{#answer\}

1. 컨테이너에 `IPC_LOCK` 및 `SYS_NICE` capability를 부여하기 위해 `--cap-add` 인수를 두 개 추가합니다:

```bash
docker run -d --name clickhouse-server \
   --cap-add=SYS_NICE \
   --cap-add=IPC_LOCK \
   --ulimit nofile=262144:262144 \
   --network clickhouse-net \
   -p 8123:8123 -p 9000:9000 -p 9009:9009 -p 9363:9363 \
   clickhouse/clickhouse-server:23.2
```

2. 다음 명령으로 컨테이너에 capabilities가 설정되어 있는지 확인합니다:

```bash
apt-get update > /dev/null && apt-get install -y libcap2-bin > /dev/null && capsh --print
```

응답 내용은 다음과 비슷합니다:

```response
debconf: delaying package configuration, since apt-utils is not installed
WARNING: libcap needs an update (cap=40 should have a name).
Current: = cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_ipc_lock,cap_sys_chroot,cap_sys_nice,cap_mknod,cap_audit_write,cap_setfcap+ep
Bounding set =cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_ipc_lock,cap_sys_chroot,cap_sys_nice,cap_mknod,cap_audit_write,cap_setfcap
Ambient set =
Securebits: 00/0x0/1'b0
 secure-noroot: no (unlocked)
 secure-no-suid-fixup: no (unlocked)
 secure-keep-caps: no (unlocked)
 secure-no-ambient-raise: no (unlocked)
uid=0(root) euid=0(root)
gid=0(root)
groups=0(root)
Guessed mode: UNCERTAIN (0)
```

3. ClickHouse의 두 가지 capability를 모두 직접 설정합니다.

```bash
setcap "cap_ipc_lock=+ep cap_sys_nice=+ep" /usr/bin/clickhouse
```

4. Capabilities가 적용되었는지 확인합니다.

```bash
getcap -v /usr/bin/clickhouse
```

다음이 표시됩니다:

```response
/usr/bin/clickhouse = cap_ipc_lock,cap_sys_nice+ep
```

5. ClickHouse 서버를 재시작한 후에는 해당 로그 메시지가 더 이상 표시되지 않습니다.

<br />

자세한 내용은 이 [Linux capabilities에 관한 문서](https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities)를 참고하십시오.
