---
title: 단일 ClickHouse 서버에서 Let's Encrypt로 SSL을 활성화하는 방법
description: Let's Encrypt를 사용해 단일 ClickHouse 서버에 SSL을 설정하고, 인증서를 발급·구성·검증하는 방법을 설명합니다.
date: 2024-12-11
tags: ['보안 및 인증']
keywords: ['SSL', 'Let/`s Encrypt']
---

import Image from "@theme/IdealImage";
import security_group from "@site/static/images/knowledgebase/lets-encrypt-ssl/port_80_security_group.png";

{frontMatter.description}

{{/* 생략 */}}

## 진행 단계 \{#steps-to-follow\}

다음 단계는 [Let&#39;s Encrypt](https://letsencrypt.org/)를 사용하여 단일 ClickHouse Server에 SSL을 활성화하는 방법입니다. Let&#39;s Encrypt는 누구나 손쉽게 웹사이트를 HTTPS로 보호할 수 있도록 설계된 무료, 자동화된 공개 인증 기관(CA)입니다. 인증서 발급 및 갱신 과정을 자동화함으로써 Let&#39;s Encrypt는 수동 개입 없이도 웹사이트가 안전한 상태를 유지하도록 합니다.

:::note
다음 가이드에서는 ClickHouse가 표준 패키지 위치에 설치되어 있다고 가정합니다. 모든 예제에서 도메인으로 `product-test-server.clickhouse-dev.com`을 사용합니다. 실제 환경에 맞게 이 도메인을 사용 중인 도메인으로 바꾸어 사용하면 됩니다.
:::

1. 서버를 가리키는 DNS `A` 또는 `AAAA` 레코드가 존재하는지 확인합니다. 이는 Linux 도구 `dig.`를 사용하여 확인할 수 있습니다. 예를 들어 Cloudflare DNS 서버 `1.1.1.1`을 사용하는 경우 `product-test-server.clickhouse-dev.com`에 대한 응답은 다음과 같습니다:

<br />

```bash
dig @1.1.1.1 product-test-server.clickhouse-dev.com

; <<>> DiG 9.18.28-0ubuntu0.22.04.1-Ubuntu <<>> @1.1.1.1 product-test-server.clickhouse-dev.com
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 22315
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;product-test-server.clickhouse-dev.com.    IN A

;; ANSWER SECTION:
product-test-server.clickhouse-dev.com. 300 IN A 34.248.59.9

;; Query time: 52 msec
;; SERVER: 1.1.1.1#53(1.1.1.1) (UDP)
;; WHEN: Thu Dec 12 09:37:33 UTC 2024
;; MSG SIZE  rcvd: 83
```

A 레코드 존재 여부를 확인하는 아래 섹션을 확인하십시오.

```bash
;; ANSWER SECTION:
product-test-server.clickhouse-dev.com. 300 IN A 34.248.59.9
```

2. 서버에서 포트 80을 엽니다. 이 포트는 certbot과 함께 ACME 프로토콜을 사용하여 인증서를 자동으로 갱신하는 데 사용됩니다. AWS의 경우 [인스턴스에 연결된 Security Group을 수정](https://repost.aws/knowledge-center/connect-http-https-ec2)하여 설정할 수 있습니다.

<br />

<Image img={security_group} size="md" alt="포트 80이 열린 상태를 보여주는 AWS Security Group 구성" border />

3. 예를 들어 `apt`를 사용하여 [`certbot`](https://certbot.eff.org/instructions)을 설치합니다.

<br />

```bash
sudo apt install certbot
```

4. SSL 인증서 발급받기

<br />

```bash
sudo certbot certonly
Saving debug log to /var/log/letsencrypt/letsencrypt.log

How would you like to authenticate with the ACME CA?
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
1: Spin up a temporary webserver (standalone)
2: Place files in webroot directory (webroot)
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Select the appropriate number [1-2] then [enter] (press 'c' to cancel): 1
Please enter the domain name(s) you would like on your certificate (comma and/or
space separated) (Enter 'c' to cancel): product-test-server.clickhouse-dev.com
Requesting a certificate for product-test-server.clickhouse-dev.com

Successfully received certificate.
Certificate is saved at: /etc/letsencrypt/live/product-test-server.clickhouse-dev.com/fullchain.pem
Key is saved at:         /etc/letsencrypt/live/product-test-server.clickhouse-dev.com/privkey.pem
This certificate expires on 2025-03-12.
These files will be updated when the certificate renews.
Certbot has set up a scheduled task to automatically renew this certificate in the background.

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
If you like Certbot, please consider supporting our work by:
 * Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
 * Donating to EFF:                    https://eff.org/donate-le
```

:::note
서버에서 웹 서버가 실행 중이지 않으므로, Certbot이 임시 독립 실행형 웹 서버를 사용하도록 허용하는 (1)번 옵션을 선택합니다.
:::

요청이 표시되면 서버의 전체 도메인 이름(예: `product-test-server.clickhouse-dev.com`)을 입력합니다.

:::note
Let&#39;s Encrypt는 공용 Cloud 제공자가 생성한 도메인(AWS의 `*.compute.amazonaws.com` 도메인 등)과 같은 특정 유형의 도메인에 대해서는 인증서를 발급하지 않는 정책을 가지고 있습니다. 이러한 도메인은 공유 인프라로 간주되며, 보안 및 오용 방지 이유로 차단됩니다.
:::

5. 인증서를 ClickHouse 디렉터리로 복사합니다.

<br />

```bash
echo '* * * * * root cp -u /etc/letsencrypt/live/product-test-server.clickhouse-dev.com/*.pem /etc/clickhouse-server/ && chown clickhouse:clickhouse /etc/clickhouse-server/*.pem && chmod 400 /etc/clickhouse-server/*.pem' | sudo tee /etc/cron.d/copy-certificates
```

이 명령은 ClickHouse 서버용 Let&#39;s Encrypt SSL 인증서 관리를 자동화하기 위해 cron 작업을 설정합니다. 이 작업은 root 사용자로 매 분 실행되며, Let&#39;s Encrypt 디렉터리에서 ClickHouse 서버의 설정 디렉터리로 .pem 파일을 복사하되, 파일이 업데이트된 경우에만 복사합니다. 복사 후 스크립트는 파일의 소유자를 clickhouse 사용자와 그룹으로 변경하여 서버가 필요한 접근 권한을 가지도록 합니다. 또한 복사된 파일에 대해 엄격한 파일 보안을 유지하기 위해 읽기 전용 권한(`chmod 400`)을 설정합니다. 이를 통해 수동 개입 없이도 ClickHouse 서버가 항상 최신 SSL 인증서에 접근할 수 있도록 하여, 보안을 유지하고 운영상의 부담을 최소화합니다.

6. 이러한 인증서를 clickhouse-server에서 사용하도록 구성합니다.

<br />

```bash
echo "https_port: 8443
tcp_port_secure: 9440
openSSL:
 server:
 certificateFile: '/etc/clickhouse-server/fullchain.pem'
 privateKeyFile: '/etc/clickhouse-server/privkey.pem'
 disableProtocols: 'sslv2,sslv3,tlsv1,tlsv1_1'" | sudo tee /etc/clickhouse-server/config.d/ssl.yaml
```

7. ClickHouse 서버 재시작

<br />

```bash
sudo clickhouse restart
```

8. ClickHouse가 SSL을 통해 통신할 수 있는지 확인합니다.

<br />

```bash
curl https://product-test-server.clickhouse-dev.com:8443/

Ok.
```

마지막 단계가 작동하도록 하려면 포트 8443에 대한 접근이 가능해야 합니다(예: AWS의 Security Group에 해당 포트를 추가). 또는 서버에서만 ClickHouse에 접근하려는 경우에는 hosts 파일을 다음과 같이 수정하십시오.

```bash
echo "127.0.0.1 product-test-server.clickhouse-dev.com" | sudo tee -a /etc/hosts
```

:::warning
와일드카드 주소에서의 연결을 허용하는 경우, 다음 조치 중 적어도 하나 이상을 반드시 적용하십시오:

* 서버는 방화벽으로 보호되며 신뢰할 수 없는 네트워크에서는 접근할 수 없습니다.
* 모든 사용자는 네트워크 주소의 일부 범위로 제한됩니다(`users.xml` 참조).
* 모든 사용자는 강력한 비밀번호를 사용하고, 보안(TLS) 인터페이스만 접근 가능하거나 TLS 인터페이스를 통해서만 연결이 이루어집니다.
* 비밀번호가 없는 사용자는 읽기 전용으로만 접근할 수 있습니다.

참고: https://www.shodan.io/search?query=clickhouse

공용 인스턴스를 보호하는 방법에 대한 참고용으로 다음 블로그 글을 활용할 수 있습니다: [Building single page applications with ClickHouse](https://clickhouse.com/blog/building-single-page-applications-with-clickhouse-and-http)
:::

다음 내용은 ClickHouse가 실행 중인 로컬 머신에서 연결하는 경우에도 동작해야 합니다. `product-test-server.clickhouse-dev.com`으로 연결하려면 다음에서 포트 9440을 개방해야 합니다.

```bash
clickhouse client --secure --user default --password <password>
```
