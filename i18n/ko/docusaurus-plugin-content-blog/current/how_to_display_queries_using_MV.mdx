---
title: ClickHouse에서 materialized view를 사용하는 쿼리를 식별하는 방법
description: 지정된 기간 내에 materialized view가 포함된 모든 쿼리를 식별하기 위해 ClickHouse 로그를 조회하는 방법을 알아봅니다.
date: 2023-03-24
tags: ['시스템 테이블']
keywords: ['materialized view', 'create_table_query']
---

{frontMatter.description}

{/* 이하 생략 */}

***

## 질문 \{#question\}

지난 60분 동안 materialized view가 포함된 모든 쿼리를 어떻게 조회할 수 있습니까?

## Answer \{#answer\}

다음 쿼리는 다음 사항을 고려하여 구체화된 뷰(Materialized View)를 대상으로 하는 모든 쿼리를 표시합니다.

* `system.tables` 테이블의 `create_table_query` 필드를 활용하여 어떤 테이블이 MV의 명시적(`TO`) 대상 테이블인지 식별할 수 있습니다.
* `uuid` 및 `.inner_id.<uuid>`라는 네이밍 규칙을 사용하여 어떤 테이블이 MV의 암시적 대상 테이블인지 역추적할 수 있습니다.

또한 초기 쿼리의 CTE에서 값(기본값은 `60`분)을 변경하여 얼마나 과거까지 조회할지 설정할 수 있습니다.

```sql
WITH(60) -- default 60m
AS timeRange,
(
    --prepare names of possible implicit MV hidden target tables for *any* table with NON NULL uuid
    SELECT groupArray(
            concat('default.`.inner_id.', toString(uuid), '`')
        )
    FROM clusterAllReplicas(default, system.tables)
    WHERE notEmpty(uuid)
) AS MV_implicit_possible_hidden_target_tables_names_array,
(
    --captures MV name and target tables (if TO is specified)
    --TODO it seems that extract will return just the first capturing group :( replace with regexpExtract once available
    SELECT arrayFilter(
            x->x != '',
            --remove empty captures
            groupArray(
                extract(
                    create_table_query,
                    '^CREATE MATERIALIZED VIEW\s(\w+\.\w+)\s(?:TO\s(\S+))?'
                )
            )
        )
    FROM clusterAllReplicas(default, system.tables)
    WHERE engine = 'MaterializedView'
) AS MV_explicit_target_tables_names_array
SELECT event_time,
    query,
    tables as "MVs tables"
FROM clusterAllReplicas(default, system.query_log)
WHERE (
        -- only SELECT within 60m
        event_time > now() - toIntervalMinute(timeRange)
        AND startsWith(query, 'SELECT')
    ) -- check either that query involves implicit MV target table names
    AND (
        hasAny(
            tables,
            MV_implicit_possible_hidden_target_tables_names_array
        )
        OR -- check that query involves explicit MV target table
        hasAny(tables, MV_explicit_target_tables_names_array)
    )
ORDER BY event_time DESC;
```

예상 출력 결과:

```sql
| event_time          | query                                                                                          | MVs tables                                                            |
| ------------------- | ---------------------------------------------------------------------------------------------- | --------------------------------------------------------------------- |
| 2023-02-23 08:14:14 | SELECT     rand(),* FROM     default.sum_of_volumes,     default.big_changes,     system.users | ["default.big_changes_mv","default.sum_of_volumes_mv","system.users"] |
| 2023-02-23 08:04:47 | SELECT     price,* FROM     default.sum_of_volumes,     default.big_changes                    | ["default.big_changes_mv","default.sum_of_volumes_mv"]                |

```

위의 예시 결과에서 `default.big_changes_mv`와 `default.sum_of_volumes_mv`는 모두 materialized view입니다.
