---
title: "쿼리에서 Projection이 사용되었는지 확인하는 방법"
date: 2022-07-10
description: "샘플 데이터를 사용해 ClickHouse 쿼리에서 Projection 사용 여부를 테스트하고, EXPLAIN으로 Projection 사용을 검증하는 방법을 설명합니다."
tags: ['데이터 모델링']
keywords: ['Projection']
---

{frontMatter.description}

{/* 생략 */}

## 질문 \{#question\}

PROJECTION이 사용되고 있는지 어떻게 확인할 수 있습니까?

## 답변 \{#answer\}

1. 샘플 데이터베이스를 생성합니다.

```
CREATE database db1;
```

2. column1을 기본 키로 사용하는 예제 테이블을 생성합니다

```
CREATE table db1.table1_projections
(
 column1 Int32,
 column2 Int32
)
engine = MergeTree()
order by column1;
```

3. column2를 기본 키로 사용하도록 `for_column2` 프로젝션을 추가합니다

```
ALTER table db1.table1_projections add projection for_column2
(
  select * 
  order by column2
);
```

4. 테스트 데이터 삽입

*column1과 column2 컬럼에 무작위 숫자로 구성된 행 100000개를 삽입합니다

```
INSERT INTO db1.table1_projections
select 
 floor(randNormal(50, 5)) as column1,
 floor(randUniform(1, 100)) as column2
from numbers(100000);
```

5. 샘플 데이터 집합을 확인합니다

```
clickhouse-cloud :) SELECT * from db1.table1_projections limit 5;

SELECT *
FROM db1.table1_projections
LIMIT 5

Query id: d6940799-b507-4a5e-9843-df55ebe818ab

┌─column1─┬─column2─┐
│      28 │      41 │
│      29 │      12 │
│      30 │      73 │
│      30 │      75 │
│      30 │      70 │
└─────────┴─────────┘
```

6. `column1`이 있는 원본 테이블을 사용하고 있는지 확인합니다:

```
clickhouse-cloud :) explain indexes = 1 
                    SELECT count() from db1.table1_projections where column1 > 50;

EXPLAIN indexes = 1
SELECT count()
FROM db1.table1_projections
WHERE column1 > 50

Query id: e04d5236-1a05-4f1f-9502-7e41986beb44

┌─explain────────────────────────────────────────────┐
│ Expression ((Projection + Before ORDER BY))        │
│   Aggregating                                      │
│     Expression (Before GROUP BY)                   │
│       Filter (WHERE)                               │
│         ReadFromMergeTree (db1.table1_projections) │
│         Indexes:                                   │
│           PrimaryKey                               │
│             Condition: true                        │
│             Parts: 1/1                             │
│             Granules: 12/12                        │
└────────────────────────────────────────────────────┘
```

*`db1.table1_projections`에서 데이터를 읽고 있다는 점에 유의하십시오

7. WHERE 절에서 column2를 사용하여 해당 프로젝션에서 읽기를 테스트합니다

```
clickhouse-cloud :) explain indexes = 1 
                    SELECT * from db1.table1_projections where column2 > 50;

EXPLAIN indexes = 1
SELECT *
FROM db1.table1_projections
WHERE column2 > 50

Query id: d2b20e01-93bf-4b60-a370-4aac7b454267

┌─explain─────────────────────────────────────┐
│ Expression ((Projection + Before ORDER BY)) │
│   Filter                                    │
│     ReadFromMergeTree (for_column2)         │
│     Indexes:                                │
│       PrimaryKey                            │
│         Keys:                               │
│           column2                           │
│         Condition: (column2 in [51, +Inf))  │
│         Parts: 1/1                          │
│         Granules: 6/12                      │
└─────────────────────────────────────────────┘
```

*이제 `for_column2` 프로젝션이 사용되고 있음을 확인할 수 있습니다.

**자세한 내용**

프로젝션:
https://clickhouse.com/docs/sql-reference/statements/alter/projection

numbers 테이블 함수:
https://clickhouse.com/docs/sql-reference/table-functions/numbers

랜덤 데이터 생성 관련 블로그:
https://clickhouse.com/blog/generating-random-test-distribution-data-for-clickhouse
