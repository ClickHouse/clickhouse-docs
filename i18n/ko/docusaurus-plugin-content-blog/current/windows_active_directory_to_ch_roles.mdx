---
title: Windows Active Directory 보안 그룹을 ClickHouse 역할에 매핑하는 방법
description: "Windows Active Directory 보안 그룹을 ClickHouse 역할에 매핑하는 예제"
date: 2024-05-20
tags: ['도구 및 유틸리티']
keywords: ['Windows']
---

import Image from "@theme/IdealImage";
import ad_env from "@site/static/images/knowledgebase/windows-ad-ch-roles/AD_Env_and_UO_structure.png";
import ad_group from "@site/static/images/knowledgebase/windows-ad-ch-roles/AD_Group_clickhouse_ad_db1_users.png";
import ad_user from "@site/static/images/knowledgebase/windows-ad-ch-roles/AD_user_clickhouse_db1_user.png";
import ad_user_group from "@site/static/images/knowledgebase/windows-ad-ch-roles/AD_user_to_group.png";

{frontMatter.description}

{/* 생략 */}

## 예시 \{#example\}

이 예시는 서로 다른 AD 보안 그룹에 속한 AD 사용자에게 ClickHouse에서 역할 권한을 부여하는 방법을 보여줍니다. 또한 하나의 사용자를 여러 AD 사용자 그룹에 추가하여, 여러 역할이 제공하는 권한을 동시에 갖도록 하는 방법도 보여줍니다.

이 환경은 다음과 같이 구성됩니다.

* Windows Active Directory 도메인: `marsnet2.local`
* ClickHouse 클러스터 `cluster_1S_3R` — 1개 세그먼트와 3개 레플리카로 구성된 클러스터 설정에서 3개의 노드
* 3명의 AD 사용자

| AD User                     | Description                               |
| --------------------------- | ----------------------------------------- |
| clickhouse&#95;ad&#95;admin | ClickHouse 관리자 사용자                        |
| clickhouse&#95;db1&#95;user | db1.table1에 대한 액세스 권한이 있는 사용자             |
| clickhouse&#95;db2&#95;user | db2.table1에 대한 액세스 권한이 있는 사용자             |
| ch&#95;db1&#95;db2&#95;user | db1.table1과 db2.table1 모두에 액세스 권한이 있는 사용자 |

* 3개의 AD 보안 그룹

| AD Group                            | Description                    |
| ----------------------------------- | ------------------------------ |
| clickhouse&#95;ad&#95;admins        | ClickHouse 관리자 그룹              |
| clickhouse&#95;ad&#95;db1&#95;users | db1.table1에 대한 액세스를 매핑하기 위한 그룹 |
| clickhouse&#95;ad&#95;db2&#95;users | db2.table1에 대한 액세스를 매핑하기 위한 그룹 |

* 예시 AD 환경 및 UO 구조:

<Image img={ad_env} size="md" alt="예시 AD 환경 및 UO 구조" />

* 예시 AD 보안 그룹 구성:

<Image img={ad_group} size="md" alt="예시 AD 보안 그룹 구성" />

* 예시 AD 사용자 구성:

<Image img={ad_user} size="md" alt="예시 AD 사용자 구성" />

1. Windows AD Users and Groups에서 각 사용자를 해당 그룹에 추가합니다. 그러면 다음 단계 예시와 같이 이들이 ClickHouse 역할에 매핑됩니다.

| AD Security Group           | ClickHouse Role                                                           |
| --------------------------- | ------------------------------------------------------------------------- |
| clickhouse&#95;ad&#95;admin | clickhouse&#95;ad&#95;admins                                              |
| clickhouse&#95;db1&#95;user | clickhouse&#95;ad&#95;db1&#95;users                                       |
| clickhouse&#95;db2&#95;user | clickhouse&#95;ad&#95;db2&#95;users                                       |
| ch&#95;db1&#95;db2&#95;user | clickhouse&#95;ad&#95;db1&#95;users 및 clickhouse&#95;ad&#95;db2&#95;users |

* 예시 사용자 그룹 멤버십:

<Image img={ad_user_group} size="md" alt="예시 사용자 그룹 멤버십" />

2. 각 ClickHouse 노드의 `config.xml`에 `ldap_servers` 설정을 추가합니다.

```
<ldap_servers>
	<marsnet2_ad>
		<host>marsdc1.marsnet2.local</host>
		<port>389</port>
		<bind_dn>{user_name}@marsnet2.local</bind_dn>
		<user_dn_detection>
			<base_dn>OU=Users,OU=ClickHouse,DC=marsnet2,DC=local</base_dn>
			<search_filter>(&amp;(objectClass=user)(sAMAccountName={user_name}))</search_filter>
		</user_dn_detection>
		<enable_tls>no</enable_tls>
	</marsnet2_ad>
</ldap_servers>
```

| xml tag                   | 설명                                                                       | 예시 값                                                |
| ------------------------- | ------------------------------------------------------------------------ | --------------------------------------------------- |
| ldap&#95;servers          | ClickHouse에서 사용할 LDAP 서버를 정의하는 데 사용되는 태그입니다                              | NA                                                  |
| marsnet&#95;ad            | 이 태그는 임의의 이름이며, `<user_directories>` 섵션에서 서버를 식별하기 위한 레이블로만 사용됩니다        | NA                                                  |
| host                      | Active Directory 서버 또는 도메인의 FQDN 또는 IP 주소입니다                             | marsdc1.marsnet2.local                              |
| port                      | Active Directory 포트로, 일반적으로 비 SSL 연결은 389, SSL 연결은 636을 사용합니다            | 389                                                 |
| bind&#95;dn               | AD에 bind를 생성할 때 사용할 사용자 계정으로, 일반 사용자 계정 사용이 허용되지 않는 경우 전용 계정을 지정할 수 있습니다 | `{user_name}@marsnet2.local`                        |
| user&#95;dn&#95;detection | ClickHouse가 AD 사용자를 찾는 방식을 지정하는 설정입니다                                    | NA                                                  |
| base&#95;dn               | 사용자 검색을 시작할 AD OU 경로입니다                                                  | OU=Users,OU=ClickHouse,DC=marsnet2,DC=local         |
| search&#95;filter         | AD 사용자를 찾기 위한 LDAP 검색 필터입니다                                              | `(&(objectClass=user)(sAMAccountName={user_name}))` |

전체 옵션 목록은 다음 문서를 참고하십시오:
https://clickhouse.com/docs/operations/external-authenticators/ldap#ldap-server-definition

3. ClickHouse `config.xml`에서 각 ClickHouse 노드에 `<ldap>` 엔트리가 포함된 `<user_directories>` 구성을 추가합니다.

```
<user_directories>
	<users_xml>
		<path>users.xml</path>
	</users_xml>
	<local_directory>
		<path>/var/lib/clickhouse/access/</path>
	</local_directory>
	<ldap>
		<server>marsnet2_ad</server>
		<role_mapping>
			<base_dn>OU=Groups,OU=ClickHouse,DC=marsnet2,DC=local</base_dn>
			<search_filter>(&amp;(objectClass=group)(member={user_dn}))</search_filter>
			<attribute>CN</attribute>
			<scope>subtree</scope>
			<prefix>clickhouse_</prefix>
		</role_mapping>
	</ldap>
</user_directories>
```

| xml tag              | Description                                            | Example Value                                |
| -------------------- | ------------------------------------------------------ | -------------------------------------------- |
| user&#95;directories | 사용할 authenticator를 정의합니다                               | NA                                           |
| ldap                 | 이 AD에서 사용할 ldap 서버에 대한 설정을 포함합니다                       | NA                                           |
| server               | `<ldap_servers>` 섹션에서 정의된 태그 이름입니다                     | marsnet2&#95;ad                              |
| role&#95;mapping     | 인증된 사용자를 AD 그룹과 ClickHouse 역할 사이에서 어떻게 매핑할지에 대한 정의입니다  | NA                                           |
| base&#95;dn          | 시스템이 AD 그룹 검색을 시작할 때 사용할 AD 경로입니다                      | OU=Groups,OU=ClickHouse,DC=marsnet2,DC=local |
| search&#95;filter    | AD 그룹을 찾기 위한 ldap 검색 필터입니다                             | `(&(objectClass=group)(member={user_dn}))`   |
| attribute            | 사용자를 식별하기 위해 사용할 AD 속성(attribute) 필드입니다                | CN                                           |
| scope                | 시스템이 그룹을 검색할 때 base DN에서 어느 수준까지 검색할지 정의합니다            | subtree                                      |
| prefix               | AD 그룹 이름에 사용되는 접두사이며, 이 접두사는 ClickHouse 역할을 찾을 때 제거됩니다 | clickhouse&#95;                              |

전체 옵션 목록은 다음 문서를 참조하십시오:
https://clickhouse.com/docs/operations/external-authenticators/ldap#ldap-external-user-directory

**note:::**
예제에서 AD 보안 그룹에 접두사가 붙어 있으므로(예: `clickhouse_ad_db1_users`), 시스템이 이를 가져올 때 접두사가 제거되며, `clickhouse_ad_db1_users`에 매핑할 ClickHouse 역할 `ad_db1_users`를 찾게 됩니다.
**:::**

4. 예제 데이터베이스를 생성합니다.

```
create database db1 on cluster 'cluster_1S_3R';
create database db2 on cluster 'cluster_1S_3R';
```

5. 예제 테이블을 생성하십시오.

```
create table db1.table1 on cluster 'cluster_1S_3R'
(
  id Int32,
  column1 String
)
engine = MergeTree()
order by id;

create table db2.table1 on cluster 'cluster_1S_3R
(
  id Int32,
  column1 String
)
engine = MergeTree()
order by id;
```

6. 샘플 데이터를 입력합니다.

```
insert into db1.table1
values
(1, 'a');

insert into db2.table1
values
(2, 'b');
```

7. ClickHouse 역할을 생성합니다.

```
create role ad_admins on cluster 'cluster_1S_3R';
create role ad_db1_users on cluster 'cluster_1S_3R';
create role ad_db2_users on cluster 'cluster_1S_3R';
```

8. 역할에 권한을 부여합니다.

```
GRANT SHOW, SELECT, INSERT, ALTER, CREATE, DROP, UNDROP TABLE, TRUNCATE, OPTIMIZE, BACKUP, KILL QUERY, KILL TRANSACTION, MOVE PARTITION BETWEEN SHARDS, ACCESS MANAGEMENT, SYSTEM, dictGet, displaySecretsInShowAndSelect, INTROSPECTION, SOURCES, CLUSTER ON *.* on cluster 'cluster_1S_3R' TO ad_admins WITH GRANT OPTION;

GRANT SELECT ON db1.table1 on cluster 'cluster_1S_3R' TO ad_db1_users;

GRANT SELECT ON db2.table1 on cluster 'cluster_1S_3R' TO ad_db2_users;
```

9. 제한된 권한의 db1 사용자 접근을 테스트합니다.
   예를 들어:

```
root@chnode1:/etc/clickhouse-server# clickhouse-client --user clickhouse_db1_user --password MyPassword123  --secure --port 9440 --host chnode1.marsnet.local
ClickHouse client version 24.1.3.31 (official build).
Connecting to chnode1.marsnet.local:9440 as user clickhouse_db1_user.
Connected to ClickHouse server version 24.1.3.


clickhouse :) select * from db1.table1;

SELECT *
FROM db1.table1

Query id: b04b92d6-5b8b-40a2-a92a-f06f15774930

┌─id─┬─column1─┐
│  1 │ a       │
└────┴─────────┘

1 row in set. Elapsed: 0.004 sec.

clickhouse :) select * from db2.table1;

SELECT *
FROM db2.table1

Query id: 7f7eaa44-7b47-4184-807a-6968a56057ad


Elapsed: 0.115 sec.

Received exception from server (version 24.1.3):
Code: 497. DB::Exception: Received from chnode1.marsnet.local:9440. DB::Exception: clickhouse_db1_user: Not enough privileges. To execute this query, it's necessary to have the grant SELECT(id, column1) ON db2.table1. (ACCESS_DENIED)
```

10. db1과 db2 두 데이터베이스 모두에 대한 권한이 있는 사용자로 액세스를 테스트합니다.
    예를 들어:

```
root@chnode1:/etc/clickhouse-server# clickhouse-client --user ch_db1_db2_user --password MyPassword123  --secure --port 9440 --host chnode1.marsnet.local
ClickHouse client version 24.1.3.31 (official build).
Connecting to chnode1.marsnet.local:9440 as user ch_db1_db2_user.
Connected to ClickHouse server version 24.1.3.

clickhouse :) select * from db1.table1;

SELECT *
FROM db1.table1

Query id: 23084744-08c2-48bd-8635-a23438812026

┌─id─┬─column1─┐
│  1 │ a       │
└────┴─────────┘

1 row in set. Elapsed: 0.005 sec.

clickhouse :) select * from db2.table1;

SELECT *
FROM db2.table1

Query id: f9954ec4-d8d9-4b5a-9f68-a7aa79a1bb4a

┌─id─┬─column1─┐
│  2 │ b       │
└────┴─────────┘

1 row in set. Elapsed: 0.004 sec.
```

11. Admin 사용자 액세스를 테스트합니다.
    예를 들어 다음과 같습니다:

```
root@chnode1:/etc/clickhouse-server# clickhouse-client --user clickhouse_ad_admin --password MyPassword123  --secure --port 9440 --host chnode1.marsnet.local
ClickHouse client version 24.1.3.31 (official build).
Connecting to chnode1.marsnet.local:9440 as user clickhouse_ad_admin.
Connected to ClickHouse server version 24.1.3.

clickhouse :) create table db1.table2 on cluster 'cluster_1S_3R'
(
  id Int32,
  column1 String
)
engine = MergeTree()
order by id;

CREATE TABLE db1.table2 ON CLUSTER cluster_1S_3R
(
    `id` Int32,
    `column1` String
)
ENGINE = MergeTree
ORDER BY id

Query id: 6041fd32-4294-44bd-b442-3fdd41333e6f

┌─host──────────────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
│ chnode1.marsnet.local │ 9440 │      0 │       │                   2 │                2 │
└───────────────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘
┌─host──────────────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
│ chnode2.marsnet.local │ 9440 │      0 │       │                   1 │                1 │
└───────────────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘
┌─host──────────────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
│ chnode3.marsnet.local │ 9440 │      0 │       │                   0 │                0 │
└───────────────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘
```
