---
title: Materialized View를 사용하는 랜딩 테이블을 통한 JSON 데이터 추출 간단 예제 흐름
description: "Materialized View를 사용하는 랜딩 테이블을 통한 JSON 데이터 추출 간단 예제 흐름"
date: 2024-05-20
tags: ['데이터 형식']
keywords: ['JSON', '랜딩 테이블', 'Materialized View']
---

{frontMatter.description}

{/* 생략 */}

## Question \{#question\}

source 또는 landing 테이블을 사용하여 materialized view에서 추출할 수 있도록 JSON 메시지를 어떻게 처리합니까?\
experimental JSON Object 없이 JSON을 어떻게 처리합니까?

## Answer \{#answer\}

JSON 데이터를 처리할 때 흔히 사용하는 패턴은 데이터를 랜딩 테이블(landing table)에 먼저 적재한 다음, JSONExtract 함수를 사용하고 구체화된 뷰(Materialized View) 트리거를 통해 이 데이터를 새 테이블로 옮기는 것입니다.
이는 일반적으로 다음과 같은 절차와 패턴으로 진행됩니다.

```
source data --> MergeTree table --> Materialized View (with base table) --> application/client
```

랜딩 테이블에는 원시 JSON을 저장하는 `raw` 문자열 필드가 있어야 합니다. 또한 데이터가 오래됨에 따라 파티션을 구성하고 정리할 수 있도록, 해당 테이블 관리를 위해 사용할 수 있는 다른 필드 1~2개를 두는 것이 좋습니다.

* 일부 통합에서는, 예를 들어 ClickHouse Kafka Connector Sink를 사용하는 경우 원본 데이터에 필드를 추가할 수 있습니다.

단순화된 예시는 아래와 같습니다:

* 예제 데이터베이스를 생성합니다

```
create database db1;
```

* 원시 JSON이 삽입될 랜딩 테이블(landing table)을 생성합니다.

```
create table db1.table2_json_raw
(
    id Int32,
    timestamp DateTime,
    raw String
)
engine = MergeTree()
order by timestamp;
```

* materialized view의 기본 테이블을 생성합니다

```
create table db1.table2_json_mv_base
(
 id Int32,
 timestamp DateTime,
 raw_string String,
 custId Int8,
 custName String
)
engine = MergeTree()
order by timestamp;
```

* 기본 테이블에 materialized view를 생성합니다

```
create materialized view db1.table2_json_mv to db1.table2_json_mv_base
AS SELECT
 id,
 timestamp,
 raw as raw_string,
 simpleJSONExtractRaw(raw, 'customerId') as custId,
 simpleJSONExtractRaw(raw, 'customerName') as custName
 FROM
db1.table2_json_raw;
```

* 샘플 행을 몇 개 삽입합니다

```
 insert into db1.table2_json_raw
 values
 (1, '2024-05-16 00:00:00', '{"customerId":1, "customerName":"ABC"}'),
 (2, '2024-05-16 00:00:01', '{"customerId":2, "customerName":"XYZ"}');
```

* 추출 결과와 쿼리에서 사용될 materialized view의 결과를 조회합니다

```
clickhouse-cloud :) select * from db1.table2_json_mv;

SELECT *
FROM db1.table2_json_mv

Query id: 12655fd3-567a-4dfb-9ef7-abc4b11ad044

┌─id─┬───────────timestamp─┬─raw_string─────────────────────────────┬─custId─┬─custName─┐
│  1 │ 2024-05-16 00:00:00 │ {"customerId":1, "customerName":"ABC"} │ 1      │ "ABC"    │
│  2 │ 2024-05-16 00:00:01 │ {"customerId":2, "customerName":"XYZ"} │ 2      │ "XYZ"    │
└────┴─────────────────────┴────────────────────────────────────────┴────────┴──────────┘
```

추가 참고 링크:
구체화된 뷰(Materialized View): https://clickhouse.com/docs/guides/developer/cascading-materialized-views
JSON 다루기: https://clickhouse.com/docs/integrations/data-formats/json#other-approaches
JSON 함수: https://clickhouse.com/docs/sql-reference/functions/json-functions
