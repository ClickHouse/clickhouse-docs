---
date: 2025-11-19
title: 스토리지 장애 이후 레플리카를 복구하는 방법
tags: ['배포 및 확장']
keywords: ['복구', '레플리카', '스토리지 장애', 'Atomic 데이터베이스']
description: '이 문서는 ClickHouse에서 복제된 테이블을 사용하는 Atomic 데이터베이스 환경에서 레플리카 중 하나의 디스크/스토리지가 손실되거나 손상되었을 때 데이터를 복구하는 방법을 설명합니다.'
---

{frontMatter.description}

{/* 이하 생략 */}

<br />

<br />

:::note
이 가이드는 config.xml 파일에서 `<path>` 매개변수가 다음과 같이 설정되어 있는 것을 전제로 합니다:

```text
<path>/var/lib/clickhouse/</path>
```

데이터 경로를 다르게 설정한 경우, 아래 명령어에 있는 `/var/lib/clickhouse` 를 실제 `<path>` 설정 값으로 모두 바꾸십시오.
:::

<VerticalStepper headerLevel="h2">
  ## 정상 레플리카에서 액세스 설정 복사 \{#copy-access-config\}

  정상 레플리카에서 로컬 사용자가 포함된 `access` 폴더의 내용을 복사하십시오:

  ```text
  /var/lib/clickhouse/access
  ```

  ## 정상 레플리카에서 metadata 폴더 백업 \{#back-up-the-metadata-folder-from-the-healthy-replica\}

  1. ClickHouse 데이터 디렉터리로 이동합니다:

  ```text
  cd /var/lib/clickhouse
  ```

  2. metadata 폴더(심볼릭 링크 포함)의 백업을 생성합니다. metadata 디렉터리에는 데이터베이스와 테이블에 대한 DDL이 들어 있습니다.
     데이터베이스 디렉터리에는 모든 테이블 DDL이 들어 있는 `/var/lib/clickhouse/store/..` 에 대한 심볼릭 링크가 있습니다.

  ```bash
  { find metadata -type f; find metadata -type l; find metadata -type l | xargs readlink -f; } | tar -cPf backup.tar --files-from=-
  ```

  :::note
  이 명령은 **metadata 파일**과 심볼릭 링크 구조가 모두 백업에 보존되도록 합니다.
  :::

  ## 장애 레플리카에서 metadata 복원 \{#restore-the-metadata-on-the-faulty-replica\}

  1. 생성된 `backup.tar` 파일을 장애 레플리카로 복사합니다.
  2. ClickHouse 데이터 디렉터리에 압축을 해제합니다:

  ```text
  cd /var/lib/clickhouse/
  tar -xvPf backup.tar
  ```

  ## 강제 복원 플래그 생성 \{#create-force-restore-flag\}

  다른 레플리카로부터 자동 데이터 동기화를 시작하려면 다음 플래그를 생성하십시오:

  ```text
  sudo -u clickhouse touch /var/lib/clickhouse/flags/force_restore_data
  ```

  ## 장애 레플리카 재시작 \{#restart-faulty-replica\}

  1. 장애 노드에서 ClickHouse 서버를 재시작합니다.
  2. 서버 로그를 확인하면, 정상 레플리카에서 파트가 다운로드되는 것을 확인할 수 있어야 합니다:

  ```bash
  2025.11.02 00:00:04.047097 [ 682 ] {} <Debug> analytics.events_local (...) (Fetcher): Downloading files 23
  2025.11.02 00:00:04.055542 [ 682 ] {} <Debug> analytics.events_local (...) (Fetcher): Download of part 202511_0_0_0 onto disk disk2 finished.
  2025.11.02 00:00:04.101888 [ 687 ] {} <Debug> warehouse.customers_local (...) (Fetcher): Downloading part 2025_0_0_1 onto disk default.
  2025.11.02 00:00:04.102005 [ 687 ] {} <Debug> warehouse.customers_local (...) (Fetcher): Downloading files 11
  2025.11.02 00:00:04.102210 [ 690 ] {} <Debug> warehouse.customers_local (...) (Fetcher): Downloading part 2022_0_0_1 onto disk disk1.
  2025.11.02 00:00:04.102247 [ 688 ] {} <Debug> warehouse.customers_local (...) (Fetcher): Downloading part 2021_0_0_1 onto disk disk2.
  2025.11.02 00:00:04.102331 [ 690 ] {} <Debug> warehouse.customers_local (...) (Fetcher): Downloading files 11
  ```
</VerticalStepper>
