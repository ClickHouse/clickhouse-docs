---
title: 두 쿼리가 동일한 결과 집합을 반환하는지 검증하는 방법
description: 두 개의 ClickHouse 쿼리가 해시 함수와 비교 기법을 사용하여 동일한 결과 집합(result set)을 생성하는지 검증하는 방법을 알아봅니다.
date: 2023-05-04
tags: ['Functions']
keywords: ['검증', '결과 집합', '해시 함수']
---

{frontMatter.description}

{/* 이하 생략 */}

## 질문 \{#question\}

두 쿼리가 동일한 결과 집합을 반환하는지 어떻게 확인할 수 있습니까?

## 답변 \{#answer\}

다음과 같은 방법을 사용할 수 있습니다:

```sql
WITH
    (
        SELECT sum(cityHash64(*))
        FROM
        (
            -- your query 1 here
            -- SELECT ...
        )
    ) AS q1_resultset_hash,
    (
        SELECT sum(cityHash64(*))
        FROM
        (
            -- your query 2 here
            -- SELECT ...
        )
    ) AS q2_resultset_hash
SELECT equals(q1_resultset_hash,q2_resultset_hash) as Q1_equals_Q2
```

이 예제에서는 [CTE](https://clickhouse.com/docs/sql-reference/statements/select/with)를 사용하여 두 쿼리 각각의 각 행에 대한 [cityHash](https://clickhouse.com/docs/sql-reference/functions/hash-functions#cityhash64) 값의 합을 계산하고, 두 결과 집합이 동일할 경우 `1`을 반환합니다.

정수 시퀀스 데이터와 Pretty 포맷을 사용하면 다음과 같습니다:

```sql
WITH
    (
        SELECT sum(cityHash64(*))
        FROM
        (
            SELECT *
            FROM numbers(10)
            ORDER BY number DESC
        )
    ) AS q1_resultset_hash,
    (
        SELECT sum(cityHash64(*))
        FROM
        (
            SELECT *
            FROM numbers(10)
            ORDER BY number ASC
        )
    ) AS q2_resultset_hash
SELECT q1_resultset_hash = q2_resultset_hash AS Q1_equals_Q2
FORMAT Pretty
```

다음이 반환됩니다:

```
┏━━━━━━━━━━━━━━┓
┃ Q1_equals_Q2 ┃
┡━━━━━━━━━━━━━━┩
│            1 │
└──────────────┘
```

이는 여러 상황에서 유용하지만, 모든 타입에 대해 결과 집합의 동등성을 검증하는 만능 해결책으로 볼 수는 없으며, 예를 들어 어떤 행에 `NULL` 값이 하나라도 포함되어 있으면 위의 방법이 실패하는 등 사용할 때 유의해야 할 점들이 있습니다.
