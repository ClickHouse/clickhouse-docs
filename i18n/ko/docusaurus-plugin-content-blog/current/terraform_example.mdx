---
title: Cloud API 사용을 위한 Terraform 예제
description: "이 문서는 Terraform을 사용하여 API로 클러스터를 생성/삭제하는 예제를 다룹니다"
Date: 2023-09-02
tags: ['네이티브 클라이언트 및 인터페이스']
keywords: ['Terraform']
---

{frontMatter.description}

{/* 이하 생략 */}

## 질문 \{#question\}

API로 ClickHouse Cloud 클러스터를 관리하려면 어떻게 해야 합니까?

## 답변 \{#answer\}

Terraform와 [ClickHouse Provider](https://registry.terraform.io/providers/ClickHouse/clickhouse/latest/docs)를 사용하여 인프라를 구성합니다.

단계는 다음과 같습니다.

1). Cloud에서 API Key를 생성합니다.
다음 문서를 참고하십시오 - https://clickhouse.com/docs/cloud/manage/openapi

자격 증명을 로컬에 저장합니다.

2). Terraform을 설치합니다 - https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli

Mac을 사용하는 경우 Homebrew 패키지 관리자를 사용할 수 있습니다.

3). 원하는 위치에 디렉터리를 하나 생성합니다:

```
mkdir test
➜  test pwd
/Users/jaijhala/Desktop/terraform/test
```

4). 두 개의 파일인 `main.tf`와 `secret.tfvars`를 생성합니다.

다음을 복사하십시오:

`main.tf` 파일은 다음과 같습니다:

```
terraform {
 required_providers {
   clickhouse = {
     source = "ClickHouse/clickhouse"
     version = "0.0.2"
   }
 }
}

variable "organization_id" {
  type = string
}

variable "token_key" {
  type = string
}

variable "token_secret" {
  type = string
}

provider clickhouse {
  environment 	= "production"
  organization_id = var.organization_id
  token_key   	= var.token_key
  token_secret	= var.token_secret
}


variable "service_password" {
  type = string
  sensitive   = true
}

resource "clickhouse_service" "service123" {
  name       	= "jai-terraform"
  cloud_provider = "aws"
  region     	= "us-east-2"
  tier       	= "development"
  idle_scaling   = true
  password  = var.service_password
  ip_access = [
	{
    	source  	= "0.0.0.0/0"
    	description = "Anywhere"
	}
  ]
}

output "CLICKHOUSE_HOST" {
  value = clickhouse_service.service123.endpoints.0.host
}
```

위의 resources 섹션에서 service name, region 등의 매개변수를 환경에 맞게 교체하면 됩니다.

`secret.tfvars` 파일에는 앞에서 다운로드한 모든 API Key 관련 정보를 넣습니다. 이 파일의 목적은 모든 비밀 자격 증명 정보를 메인 설정 파일에서 분리하여 숨기는 것입니다.

예시는 다음과 같습니다(이 매개변수들을 실제 값으로 교체하십시오).

```
organization_id = "e957a5f7-4qe3-4b05-ad5a-d02b2dcd0593"
token_key = "QWhhkMeytqQruTeKg"
token_secret = "4b1dNmjWdLUno9lXxmKvSUcPP62jvn7irkuZPbY"
service_password = "password123!"
```

5).  이 디렉터리에서 `terraform init`을 실행합니다.

예상 출력 결과:

```
Initializing the backend...

Initializing provider plugins...
- Finding clickhouse/clickhouse versions matching "0.0.2"...
- Installing clickhouse/clickhouse v0.0.2...
- Installed clickhouse/clickhouse v0.0.2 (self-signed, key ID D7089EE5C6A92ED1)

Partner and community providers are signed by their developers.
If you'd like to know more about provider signing, you can read about it here:
https://www.terraform.io/docs/cli/plugins/signing.html

Terraform has created a lock file .terraform.lock.hcl to record the provider
selections it made above. Include this file in your version control repository
so that Terraform can guarantee to make the same selections by default when
you run "terraform init" in the future.

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running "terraform plan" to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.
```

6). `terraform apply -var-file=secret.tfvars` 명령을 실행합니다.

예를 들면 다음과 같습니다.

```
➜  test terraform apply -var-file=secret.tfvars

Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with
the following symbols:
  + create

Terraform will perform the following actions:

  # clickhouse_service.service123 will be created
  + resource "clickhouse_service" "service123" {
      + cloud_provider = "aws"
      + endpoints      = (known after apply)
      + id             = (known after apply)
      + idle_scaling   = true
      + ip_access      = [
          + {
              + description = "Anywhere"
              + source      = "0.0.0.0/0"
            },
        ]
      + last_updated   = (known after apply)
      + name           = "jai-terraform"
      + password       = (sensitive value)
      + region         = "us-east-2"
      + tier           = "development"
    }

Plan: 1 to add, 0 to change, 0 to destroy.

Changes to Outputs:
  + CLICKHOUSE_HOST = (known after apply)

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: yes
```

`yes`를 입력하고 엔터 키를 누르십시오

참고: 위에 `password       = (sensitive value)`라고 표시된 것을 확인할 수 있습니다.
이는 main.tf 파일에서 password에 `sensitive   = true`를 설정했기 때문입니다.

7). 서비스를 생성하는 데 몇 분 정도 소요되지만, 최종적으로는 다음과 같이 표시됩니다:

```
  Enter a value: yes

clickhouse_service.service123: Creating...
clickhouse_service.service123: Still creating... [10s elapsed]
clickhouse_service.service123: Still creating... [20s elapsed]
clickhouse_service.service123: Still creating... [30s elapsed]
clickhouse_service.service123: Still creating... [40s elapsed]
clickhouse_service.service123: Still creating... [50s elapsed]
clickhouse_service.service123: Still creating... [1m0s elapsed]
clickhouse_service.service123: Still creating... [1m10s elapsed]
clickhouse_service.service123: Still creating... [1m20s elapsed]
clickhouse_service.service123: Still creating... [1m30s elapsed]
clickhouse_service.service123: Still creating... [1m40s elapsed]
clickhouse_service.service123: Creation complete after 1m41s [id=aa8d8d63-1878-4600-8470-630715af38ed]

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.

Outputs:

CLICKHOUSE_HOST = "h3ljlaqez6.us-east-2.aws.clickhouse.cloud"
➜  test
```

8). Cloud Console을 확인합니다. 생성된 서비스를 확인할 수 있습니다.

9). 서비스를 정리하거나 삭제하려면 `terraform destroy -var-file=secret.tfvars` 명령을 실행합니다.

예시는 다음과 같습니다.

```
Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with
the following symbols:
  - destroy

Terraform will perform the following actions:

  # clickhouse_service.service123 will be destroyed
  - resource "clickhouse_service" "service123" {
      - cloud_provider = "aws" -> null
      - ............

Plan: 0 to add, 0 to change, 1 to destroy.

Changes to Outputs:
  - CLICKHOUSE_HOST = "h3ljlaqez6.us-east-2.aws.clickhouse.cloud" -> null

Do you really want to destroy all resources?
  Terraform will destroy all your managed infrastructure, as shown above.
  There is no undo. Only 'yes' will be accepted to confirm.

  Enter a value:
```

yes를 입력한 후 Enter 키를 누르십시오

10).

```
clickhouse_service.service123: Destroying... [id=aa8d8d63-1878-4600-8470-630715af38ed]
clickhouse_service.service123: Still destroying... [id=aa8d8d63-1878-4600-8470-630715af38ed, 10s elapsed]
clickhouse_service.service123: Still destroying... [id=aa8d8d63-1878-4600-8470-630715af38ed, 20s elapsed]
clickhouse_service.service123: Destruction complete after 27s

Destroy complete! Resources: 1 destroyed.
```

이제 Cloud Console에서 해당 항목이 사라져 있어야 합니다.

Cloud API에 대한 자세한 내용은 다음 문서를 참고하십시오: https://clickhouse.com/docs/cloud/manage/api/api-overview
