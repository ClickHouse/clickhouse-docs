---
title: '概要'
description: 'ClickHouse をオブザーバビリティ・ソリューションとして活用する'
slug: /use-cases/observability/introduction
keywords: ['observability', 'logs', 'traces', 'metrics', 'OpenTelemetry', 'Grafana', 'OTel']
show_related_blogs: true
doc_type: 'guide'
---

import observability_1 from '@site/static/images/use-cases/observability/observability-1.png';
import observability_2 from '@site/static/images/use-cases/observability/observability-2.png';
import Image from '@theme/IdealImage';


# オブザーバビリティにおける ClickHouse の利用



## はじめに {#introduction}

本ガイドは、ClickHouseを使用してログとトレースに焦点を当てた独自のSQLベースのオブザーバビリティソリューションを構築したいユーザー向けに設計されています。データ取り込みの考慮事項、アクセスパターンに応じたスキーマの最適化、非構造化ログからの構造抽出など、独自のソリューション構築に関するあらゆる側面を網羅しています。

ClickHouse単体では、オブザーバビリティのためのすぐに使えるソリューションではありません。しかし、オブザーバビリティデータ向けの高効率なストレージエンジンとして使用でき、比類のない圧縮率と極めて高速なクエリ応答時間を実現します。ユーザーがオブザーバビリティソリューション内でClickHouseを使用するには、ユーザーインターフェースとデータ収集フレームワークの両方が必要です。現在、オブザーバビリティシグナルの可視化には**Grafana**を、データ収集には**OpenTelemetry**を使用することを推奨しています(両方とも公式にサポートされている統合です)。

<Image img={observability_1} alt='Simple OTel' size='md' />

<br />

:::note OpenTelemetryだけではありません
データ収集にはOpenTelemetry(OTel)プロジェクトの使用を推奨していますが、VectorやFluentdなどの他のフレームワークやツールを使用して同様のアーキテクチャを構築することも可能です(Fluent Bitを使用した[例](https://clickhouse.com/blog/kubernetes-logs-to-clickhouse-fluent-bit)を参照してください)。SupersetやMetabaseなどの代替可視化ツールも存在します。
:::


## なぜClickHouseを使用するのか？ {#why-use-clickhouse}

集中型オブザーバビリティストアの最も重要な機能は、多様なソースから得られる膨大な量のログデータを迅速に集約、分析、検索できる能力です。この集中化によってトラブルシューティングが効率化され、サービス障害の根本原因を特定しやすくなります。

ユーザーの価格感度が高まり、既製のソリューションがもたらす価値に比べてコストが高額かつ予測不可能であると感じられる中、クエリパフォーマンスが許容範囲内でありながらコスト効率が高く予測可能なログストレージは、これまで以上に価値があります。

そのパフォーマンスとコスト効率により、ClickHouseはオブザーバビリティ製品におけるログおよびトレーシングストレージエンジンの事実上の標準となっています。

より具体的には、以下の理由によりClickHouseはオブザーバビリティデータのストレージに最適です:

- **圧縮** - オブザーバビリティデータには通常、HTTPコードやサービス名など、値が特定のセットから取られるフィールドが含まれます。ClickHouseのカラム指向ストレージでは値がソート済みで保存されるため、このデータは非常に効率的に圧縮されます。特に時系列データ用の特殊なコーデックと組み合わせた場合に顕著です。通常JSON形式の元のデータサイズと同等のストレージを必要とする他のデータストアとは異なり、ClickHouseはログとトレースを平均14倍まで圧縮します。大規模なオブザーバビリティ環境において大幅なストレージ削減を実現するだけでなく、この圧縮によってディスクから読み取る必要があるデータ量が減少し、クエリの高速化にも貢献します。
- **高速な集約** - オブザーバビリティソリューションでは通常、エラー率を示す折れ線グラフやトラフィックソースを示す棒グラフなど、チャートを通じたデータの可視化が重要な役割を果たします。これらのチャートを支える集約、すなわちGROUP BYは基本的な機能であり、問題診断のワークフローでフィルタを適用する際にも高速かつレスポンシブである必要があります。ClickHouseのカラム指向フォーマットとベクトル化されたクエリ実行エンジンの組み合わせは高速な集約に最適であり、スパースインデックスによってユーザーのアクションに応じたデータの迅速なフィルタリングが可能です。
- **高速な線形スキャン** - 代替技術がログの高速クエリのために転置インデックスに依存する一方で、これらは必然的に高いディスクおよびリソース使用率をもたらします。ClickHouseは追加のオプションインデックスタイプとして転置インデックスを提供していますが、線形スキャンは高度に並列化されており、マシン上の利用可能なすべてのコアを使用します(別途設定されていない限り)。これにより、[高度に最適化されたテキストマッチング演算子](/sql-reference/functions/string-search-functions)を使用して、潜在的に数十GB/秒(圧縮済み)のマッチングスキャンが可能になります。
- **SQLの親しみやすさ** - SQLはすべてのエンジニアが精通している普遍的な言語です。50年以上の開発の歴史を持ち、データ分析のための事実上の言語としての地位を確立しており、[3番目に人気のあるプログラミング言語](https://clickhouse.com/blog/the-state-of-sql-based-observability#lingua-franca)であり続けています。オブザーバビリティはSQLが最適なもう一つのデータ課題に過ぎません。
- **分析関数** - ClickHouseはANSI SQLを拡張し、SQLクエリをよりシンプルで書きやすくするための分析関数を提供しています。これらは、データを多角的に分析する必要がある根本原因分析を実行するユーザーにとって不可欠です。
- **セカンダリインデックス** - ClickHouseはブルームフィルタなどのセカンダリインデックスをサポートし、特定のクエリプロファイルを高速化します。これらはカラムレベルでオプションとして有効化でき、ユーザーに細かい制御を提供し、コストパフォーマンスの利点を評価できるようにします。
- **オープンソースとオープンスタンダード** - オープンソースデータベースとして、ClickHouseはOpenTelemetryなどのオープンスタンダードを採用しています。プロジェクトへの貢献と積極的な参加が可能であり、ベンダーロックインの課題を回避できる点が魅力的です。


## オブザーバビリティにClickHouseを使用すべき場合 {#when-should-you-use-clickhouse-for-observability}

オブザーバビリティデータにClickHouseを使用するには、SQLベースのオブザーバビリティを採用する必要があります。SQLベースのオブザーバビリティの歴史については[このブログ記事](https://clickhouse.com/blog/the-state-of-sql-based-observability)をご参照ください。要約すると以下の通りです:

以下に該当する場合、SQLベースのオブザーバビリティが適しています:

- あなたまたはチームがSQLに精通している(または習得を希望している)
- ベンダーロックインを回避し拡張性を実現するため、OpenTelemetryなどのオープン標準への準拠を重視している
- 収集からストレージ、可視化に至るまで、オープンソースのイノベーションによって推進されるエコシステムを運用する意思がある
- 管理するオブザーバビリティデータが中規模から大規模(または非常に大規模)に成長することを想定している
- TCO(総所有コスト)を管理し、オブザーバビリティコストの高騰を回避したい
- コスト管理のためだけにオブザーバビリティデータの保持期間を短縮することを望まない、または許容できない

以下に該当する場合、SQLベースのオブザーバビリティは適していない可能性があります:

- SQLの習得(または生成)があなたまたはチームにとって魅力的でない
- パッケージ化されたエンドツーエンドのオブザーバビリティソリューションを求めている
- オブザーバビリティデータ量が小さすぎて大きな効果が見込めず(例: 150 GiB未満)、かつ成長が予測されない
- ユースケースがメトリクス中心でPromQLが必要である。その場合でも、メトリクスにはPrometheusを使用し、ログとトレーシングにはClickHouseを使用して、Grafanaのプレゼンテーション層で統合することができます
- エコシステムがさらに成熟し、SQLベースのオブザーバビリティがよりターンキーになるまで待つことを好む


## ログとトレース {#logs-and-traces}

オブザーバビリティのユースケースには、ロギング、トレーシング、メトリクスという3つの柱があります。それぞれ異なるデータ型とアクセスパターンを持ちます。

現在、ClickHouseでは2種類のオブザーバビリティデータの保存を推奨しています:

- **ログ** - ログは、システム内で発生するイベントのタイムスタンプ付き記録であり、ソフトウェア運用のさまざまな側面に関する詳細な情報を記録します。ログ内のデータは通常、非構造化または半構造化されており、エラーメッセージ、ユーザーアクティビティログ、システム変更、その他のイベントを含むことができます。ログは、トラブルシューティング、異常検知、およびシステム内の問題に至る特定のイベントを理解するために不可欠です。

```response
54.36.149.41 - - [22/Jan/2019:03:56:14 +0330] "GET
/filter/27|13%20%D9%85%DA%AF%D8%A7%D9%BE%DB%8C%DA%A9%D8%B3%D9%84,27|%DA%A9%D9%85%D8%AA%D8%B1%20%D8%A7%D8%B2%205%20%D9%85%DA%AF%D8%A7%D9%BE%DB%8C%DA%A9%D8%B3%D9%84,p53 HTTP/1.1" 200 30577 "-" "Mozilla/5.0 (compatible; AhrefsBot/6.1; +http://ahrefs.com/robot/)" "-"
```

- **トレース** - トレースは、分散システム内の異なるサービスを通過するリクエストの経路を記録し、これらのリクエストのパスとパフォーマンスを詳細に示します。トレース内のデータは高度に構造化されており、リクエストが辿る各ステップをマッピングするスパンとトレースで構成され、タイミング情報も含まれます。トレースは、システムパフォーマンスに関する貴重な洞察を提供し、ボトルネックやレイテンシの問題を特定し、マイクロサービスの効率を最適化するのに役立ちます。

:::note メトリクス
ClickHouseはメトリクスデータの保存に使用できますが、この領域はClickHouseではまだ成熟しておらず、Prometheusデータ形式やPromQLのサポートなどの機能が今後対応予定です。
:::

### 分散トレーシング {#distributed-tracing}

分散トレーシングは、オブザーバビリティの重要な機能です。分散トレース、単にトレースと呼ばれるものは、システムを通過するリクエストの経路をマッピングします。リクエストはエンドユーザーまたはアプリケーションから発生し、システム全体に伝播し、通常はマイクロサービス間のアクションフローを生成します。このシーケンスを記録し、後続のイベントを関連付けることで、オブザーバビリティユーザーやSREは、アーキテクチャがどれほど複雑であるか、またはサーバーレスであるかに関係なく、アプリケーションフロー内の問題を診断できるようになります。

各トレースは複数のスパンで構成され、リクエストに関連付けられた最初のスパンはルートスパンと呼ばれます。このルートスパンは、リクエスト全体を最初から最後まで記録します。ルートの下にある後続のスパンは、リクエスト中に発生するさまざまなステップや操作に関する詳細な情報を提供します。トレーシングがなければ、分散システムにおけるパフォーマンスの問題を診断することは非常に困難です。トレーシングは、リクエストがシステムを通過する際のイベントのシーケンスを詳細に記録することで、分散システムのデバッグと理解のプロセスを容易にします。

ほとんどのオブザーバビリティベンダーは、この情報をウォーターフォールとして視覚化し、相対的なタイミングを比例サイズの水平バーで表示します。例えば、Grafanaでは:

<Image img={observability_2} alt='Example trace' size='lg' border />

ログとトレースの概念を深く理解する必要があるユーザーには、[OpenTelemetryドキュメント](https://opentelemetry.io/docs/concepts/)を強く推奨します。
