---
sidebar_position: 1
slug: /community-wisdom/cost-optimization
sidebar_label: 'コスト最適化'
doc_type: 'guide'
keywords: [
  'cost optimization',
  'storage costs', 
  'partition management',
  'data retention',
  'storage analysis',
  'database optimization',
  'clickhouse cost reduction',
  'storage hot spots',
  'ttl performance',
  'disk usage',
  'compression strategies',
  'retention analysis'
]
title: 'レッスン - コスト最適化'
description: '実運用の事例と検証済みの手法に基づく、ClickHouse コミュニティミートアップ発のコスト最適化戦略。'
---



# コスト最適化：コミュニティからの戦略 {#cost-optimization}

_本ガイドは、コミュニティミートアップから得られた知見集の一部です。このページでは、ClickHouse利用時のコスト最適化に関するコミュニティの知見を紹介しており、それぞれの環境や経験において効果が実証されたものです。その他の実践的なソリューションや知見については、[課題別に参照](./community-wisdom.md)することができます。_

_[ClickHouse Cloudによる運用コスト管理](/cloud/overview)についてもご確認ください。_


## 圧縮戦略: 本番環境におけるLZ4とZSTD {#compression-strategy}

Microsoft Clarityが数百テラバイトのデータを処理する必要に迫られた際、圧縮方式の選択がコストに劇的な影響を与えることを発見しました。この規模では、ストレージの節約が極めて重要であり、パフォーマンスとストレージコストという古典的なトレードオフに直面しました。Microsoft Clarityは膨大な量のデータを扱っており、全アカウント合わせて月間2ペタバイトの非圧縮データを処理し、8ノードで1時間あたり約60,000件のクエリを処理し、数百万のウェブサイトから数十億のページビューを提供しています。この規模では、圧縮戦略が重要なコスト要因となります。

当初はClickHouseのデフォルトである[LZ4](/sql-reference/statements/create/table#lz4)圧縮を使用していましたが、[ZSTD](/sql-reference/statements/create/table#zstd)を使用することで大幅なコスト削減が可能であることを発見しました。LZ4の方が高速ですが、ZSTDはパフォーマンスがわずかに低下する代わりに、より高い圧縮率を実現します。両方のアプローチをテストした結果、ストレージの節約を優先するという戦略的な決定を下しました。その結果は顕著でした。大規模なテーブルで50%のストレージ削減を実現し、データ取り込みとクエリへのパフォーマンス影響は許容範囲内に収まりました。

**主な成果:**

- ZSTD圧縮により大規模テーブルで50%のストレージ削減を達成
- 月間2ペタバイトのデータ処理能力
- データ取り込みとクエリへのパフォーマンス影響は許容範囲内
- 数百テラバイト規模での大幅なコスト削減


## カラム単位の保持戦略 {#column-retention}

最も効果的なコスト最適化手法の一つは、実際に使用されているカラムを分析することです。Microsoft ClarityはClickHouseの組み込みテレメトリ機能を活用して、高度なカラム単位の保持戦略を実装しています。ClickHouseは、カラムごとのストレージ使用量に関する詳細なメトリクスと、包括的なクエリパターン(アクセスされるカラム、アクセス頻度、クエリ実行時間、全体的な使用統計)を提供します。

このデータドリブンなアプローチにより、保持ポリシーとカラムライフサイクル管理に関する戦略的な意思決定が可能になります。このテレメトリデータを分析することで、Microsoftはストレージのホットスポット、つまり大量のスペースを消費しながらもクエリがほとんど実行されないカラムを特定できます。これらの使用頻度の低いカラムに対しては、積極的な保持ポリシーを実装し、保存期間を30ヶ月から1ヶ月に短縮したり、全くクエリされない場合はカラムを完全に削除したりできます。この選択的な保持戦略により、ユーザーエクスペリエンスに影響を与えることなくストレージコストを削減できます。

**戦略:**

- ClickHouseテレメトリを使用してカラムの使用パターンを分析する
- ストレージ使用量が多くクエリ頻度が低いカラムを特定する
- 選択的な保持ポリシーを実装する
- データドリブンな意思決定のためにクエリパターンを監視する

**関連ドキュメント**

- [データ管理 - カラムレベルTTL](/observability/managing-data)


## パーティションベースのデータ管理 {#partition-management}

Microsoft Clarityは、パーティショニング戦略がパフォーマンスと運用のシンプルさの両方に影響することを発見しました。彼らのアプローチは、日付でパーティション分割し、時間で順序付けするというものです。この戦略は、クリーンアップ効率だけでなく、複数のメリットをもたらします。データクリーンアップの簡素化、顧客向けサービスの課金計算の簡素化、そして行ベースの削除に対するGDPRコンプライアンス要件のサポートを実現します。

**主なメリット:**

- データクリーンアップの簡素化（パーティション削除と行単位削除の比較）
- 課金計算の簡素化
- パーティション除外によるクエリパフォーマンスの向上
- 運用管理の容易化

**関連ドキュメント**

- [データ管理 - パーティション](/observability/managing-data#partitions)


## 文字列から整数への変換戦略 {#string-integer-conversion}

分析プラットフォームでは、数百万行にわたって繰り返し出現するカテゴリカルデータのストレージ課題に直面することがよくあります。Microsoftのエンジニアリングチームは、検索分析データでこの問題に遭遇し、対象データセットで60%のストレージ削減を達成する効果的なソリューションを開発しました。

Microsoftのウェブ分析システムでは、検索結果に応じて天気カード、スポーツ情報、ニュース記事、事実に基づく回答など、さまざまなタイプの回答が表示されます。各クエリ結果には「weather_answer」「sports_answer」「factual_answer」などの説明的な文字列がタグ付けされていました。数十億件の検索クエリが処理される中、これらの文字列値がClickHouseに繰り返し保存され、膨大なストレージ容量を消費し、クエリ実行時に高コストな文字列比較が必要となっていました。

Microsoftは、別のMySQLデータベースを使用して文字列から整数へのマッピングシステムを実装しました。ClickHouseに実際の文字列を保存する代わりに、整数IDのみを保存します。ユーザーがUIを通じてクエリを実行し、`weather_answer`のデータをリクエストすると、クエリオプティマイザはまずMySQLマッピングテーブルを参照して対応する整数IDを取得し、その後クエリをその整数を使用するように変換してからClickHouseに送信します。

このアーキテクチャはユーザーエクスペリエンスを維持します。ユーザーはダッシュボードで`weather_answer`のような意味のあるラベルを引き続き確認できる一方で、バックエンドのストレージとクエリははるかに効率的な整数で動作します。マッピングシステムはすべての変換を透過的に処理するため、ユーザーインターフェースやユーザーワークフローの変更は不要です。

**主な利点:**

- 対象データセットで60%のストレージ削減
- 整数比較によるクエリパフォーマンスの向上
- 結合と集計におけるメモリ使用量の削減
- 大規模な結果セットに対するネットワーク転送コストの削減

:::note
これはMicrosoft Clarityのデータシナリオで特に使用される例です。すべてのデータがClickHouseにある場合、またはClickHouseへのデータ移行に制約がない場合は、代わりに[ディクショナリ](/dictionary)の使用を検討してください。
:::


## 動画リソース {#video-sources}

- **[Microsoft Clarity and ClickHouse](https://www.youtube.com/watch?v=rUVZlquVGw0)** - Microsoft Clarity Team
- **[ClickHouse journey in Contentsquare](https://www.youtube.com/watch?v=zvuCBAl2T0Q)** - Doron Hoffman & Guram Sigua (ContentSquare)

_これらのコミュニティによるコスト最適化の知見は、数百テラバイトからペタバイト規模のデータを処理する企業の戦略を表しており、ClickHouseの運用コストを削減するための実践的なアプローチを示しています。_
