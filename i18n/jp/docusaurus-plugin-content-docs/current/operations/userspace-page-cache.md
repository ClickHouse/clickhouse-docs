---
description: 'OS ページキャッシュに依存せず、
プロセス内メモリ上にデータをキャッシュするためのキャッシュ機構。'
sidebar_label: 'ユーザー空間ページキャッシュ'
sidebar_position: 65
slug: /operations/userspace-page-cache
title: 'ユーザー空間ページキャッシュ'
doc_type: 'reference'
---



# ユーザースペースページキャッシュ



## 概要 {#overview}

> ユーザースペースページキャッシュは、OSページキャッシュに依存せず、プロセス内メモリでデータをキャッシュできる新しいキャッシング機構です。

ClickHouseは、Amazon S3、Google Cloud Storage（GCS）、Azure Blob Storageなどのリモートオブジェクトストレージ上でキャッシングを行う手段として、すでに[ファイルシステムキャッシュ](/docs/operations/storing-data)を提供しています。ユーザースペースページキャッシュは、通常のOSキャッシングでは十分なパフォーマンスが得られない場合に、リモートデータへのアクセスを高速化するように設計されています。

ファイルシステムキャッシュとは以下の点で異なります：

| ファイルシステムキャッシュ                                        | ユーザースペースページキャッシュ                  |
| ------------------------------------------------------- | ------------------------------------- |
| ローカルファイルシステムにデータを書き込む                     | メモリ内にのみ存在                |
| ディスク容量を使用（tmpfs上でも設定可能）        | ファイルシステムに依存しない             |
| サーバー再起動後も保持される                                | サーバー再起動後は保持されない      |
| サーバーのメモリ使用量に表示されない           | サーバーのメモリ使用量に表示される |
| ディスク上とメモリ内（OSページキャッシュ）の両方に適している | **ディスクレスサーバーに最適**        |


## 設定と使用方法 {#configuration-settings-and-usage}

### 使用方法 {#usage}

ユーザースペースページキャッシュを有効にするには、まずサーバー上で設定します：

```bash
cat config.d/page_cache.yaml
page_cache_max_size: 100G
```

:::note
ユーザースペースページキャッシュは指定された量までのメモリを使用しますが、このメモリ量は予約されません。他のサーバーの必要に応じて、メモリは退避されます。
:::

次に、クエリレベルで使用を有効にします：

```sql
SET use_page_cache_for_disks_without_file_cache=1;
```

### 設定 {#settings}

| 設定                                                 | 説明                                                                                                                                                                                                                                                                                                            | デフォルト値     |
| ------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| `use_page_cache_for_disks_without_file_cache`           | ファイルシステムキャッシュが有効になっていないリモートディスクに対してユーザースペースページキャッシュを使用します。                                                                                                                                                                                                                    | `0`         |
| `use_page_cache_with_distributed_cache`                 | 分散キャッシュが使用されている場合にユーザースペースページキャッシュを使用します。                                                                                                                                                                                                                                                               | `0`         |
| `read_from_page_cache_if_exists_otherwise_bypass_cache` | [`read_from_filesystem_cache_if_exists_otherwise_bypass_cache`](/docs/operations/settings/settings#read_from_filesystem_cache_if_exists_otherwise_bypass_cache)と同様に、ユーザースペースページキャッシュをパッシブモードで使用します。                                                                                                  | `0`         |
| `page_cache_inject_eviction`                            | ユーザースペースページキャッシュがランダムに一部のページを無効化することがあります。テスト用途を想定しています。                                                                                                                                                                                                                             | `0`         |
| `page_cache_block_size`                                 | ユーザースペースページキャッシュに格納するファイルチャンクのサイズ（バイト単位）。キャッシュを経由するすべての読み取りは、このサイズの倍数に切り上げられます。                                                                                                                                                                                                                                                                 | `1048576`   |
| `page_cache_history_window_ms`                          | 解放されたメモリがユーザースペースページキャッシュで使用可能になるまでの遅延時間。                                                                                                                                                                                                                                                                         | `1000`      |
| `page_cache_policy`                                     | ユーザースペースページキャッシュのポリシー名。                                                                                                                                                                                                                                                                                      | `SLRU`      |
| `page_cache_size_ratio`                                 | ユーザースペースページキャッシュ内の保護キューのサイズをキャッシュの全体サイズに対する相対値で指定します。                                                                                                                                                                                                                       | `0.5`       |
| `page_cache_min_size`                                   | ユーザースペースページキャッシュの最小サイズ。                                                                                                                                                                                                                                                                                              | `104857600` |
| `page_cache_max_size`                                   | ユーザースペースページキャッシュの最大サイズ。0に設定するとキャッシュが無効になります。page_cache_min_sizeより大きい場合、キャッシュサイズはこの範囲内で継続的に調整され、総メモリ使用量を制限値（`max_server_memory_usage`\[`_to_ram_ratio`\]）以下に保ちながら、利用可能なメモリの大部分を使用します。 | `0`         |
| `page_cache_free_memory_ratio`                          | ユーザースペースページキャッシュから解放しておくメモリ制限の割合。Linuxのmin_free_kbytes設定に類似しています。                                                                                                                                                                                                                   | `0.15`      |
| `page_cache_lookahead_blocks`                           | ユーザースペースページキャッシュミス時に、キャッシュに存在しない場合、基盤となるストレージから一度に読み取る連続ブロックの最大数。各ブロックはpage_cache_block_sizeバイトです。                                                                                                                               | `16`        |
| `page_cache_shards`                                     | ミューテックスの競合を減らすために、ユーザースペースページキャッシュをこの数のシャードに分割します。実験的機能であり、パフォーマンスの向上は期待できません。                                                                                                                                                                                                         | `4`         |


## 関連コンテンツ {#related-content}

- [ファイルシステムキャッシュ](/docs/operations/storing-data)
- [ClickHouse v25.3 リリースウェビナー](https://www.youtube.com/live/iCKEzp0_Z2Q?feature=shared&t=1320)
