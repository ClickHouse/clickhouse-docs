---
slug: /faq/operations/production
title: '本番環境ではどの ClickHouse バージョンを使うべきですか？'
toc_hidden: true
toc_priority: 10
description: 'このページでは、本番環境で使用する ClickHouse バージョンの選び方について案内します'
doc_type: 'guide'
keywords: ['production', 'deployment', 'versions', 'best practices', 'upgrade strategy']
---



# 本番環境で使用するClickHouseのバージョンはどれか？ {#which-clickhouse-version-to-use-in-production}

まず、なぜこの質問がそもそもされるのかについて説明します。主な理由は2つあります：

1.  ClickHouseは非常に高速に開発されており、通常年間10以上の安定版リリースがあります。そのため、選択肢となるリリースの範囲が広く、選択は決して簡単ではありません。
2.  一部のユーザーは、自分のユースケースに最適なバージョンを見極めるために時間を費やすことを避け、他者の助言に従いたいと考えています。

2つ目の理由はより根本的なものであるため、まずそちらから始め、その後さまざまなClickHouseリリースの選び方に戻ります。


## どのClickHouseバージョンを推奨しますか？ {#which-clickhouse-version-do-you-recommend}

コンサルタントを雇ったり、著名な専門家を信頼して本番環境の責任を回避したくなることがあります。誰かが推奨した特定のClickHouseバージョンをインストールし、何か問題が発生しても、それはあなたの責任ではなく他人の責任だと考えるかもしれません。しかし、この考え方は大きな落とし穴です。外部の誰よりも、あなた自身が自社の本番環境で何が起きているかを最もよく理解しているのです。

では、どのClickHouseバージョンにアップグレードすべきかを適切に選択するにはどうすればよいでしょうか？あるいは、最初のClickHouseバージョンをどのように選択すればよいでしょうか？まず第一に、**現実的なプレプロダクション環境**の構築に投資する必要があります。理想的には、完全に同一のシャドウコピーを用意できればよいのですが、通常それは高コストです。

高コストをかけずにプレプロダクション環境で妥当な再現性を得るための重要なポイントは以下の通りです：

- プレプロダクション環境では、本番環境で実行する予定のクエリセットにできるだけ近いものを実行する必要があります：
  - 固定されたデータで読み取り専用にしないでください。
  - 典型的なレポートを作成せずにデータをコピーするだけの書き込み専用にしないでください。
  - スキーママイグレーションを適用する代わりに環境をクリーンに消去しないでください。
- 実際の本番データとクエリのサンプルを使用してください。代表性を保ち、`SELECT`クエリが妥当な結果を返すようなサンプルを選択するよう心がけてください。データが機密性の高いもので、社内ポリシーが本番環境外への持ち出しを許可していない場合は、難読化を使用してください。
- プレプロダクション環境が、本番環境と同様に監視およびアラートソフトウェアでカバーされていることを確認してください。
- 本番環境が複数のデータセンターやリージョンにまたがっている場合は、プレプロダクション環境も同様にしてください。
- 本番環境でレプリケーション、分散テーブル、カスケードマテリアライズドビューなどの複雑な機能を使用している場合は、プレプロダクション環境でも同様に設定されていることを確認してください。
- プレプロダクション環境で、本番環境とほぼ同じ数のサーバーまたはVMを使用するがサイズを小さくするか、同じサイズだが数を大幅に減らすかのトレードオフがあります。前者はネットワーク関連の問題を追加で検出できる可能性がありますが、後者は管理が容易です。

投資すべき第二の領域は**自動テストインフラストラクチャ**です。ある種のクエリが一度正常に実行されたからといって、それが永遠に続くと仮定しないでください。ClickHouseをモック化したユニットテストを持つことは問題ありませんが、実際のClickHouseに対して実行され、すべての重要なユースケースが期待通りに動作していることを確認する、妥当な自動テストセットを製品に用意してください。

さらに一歩進んで、これらの自動テストを[ClickHouseのオープンソーステストインフラストラクチャ](https://github.com/ClickHouse/ClickHouse/tree/master/tests)に貢献することもできます。このインフラストラクチャは日々の開発で継続的に使用されています。[実行方法](../../development/tests.md)を学び、テストをこのフレームワークに適応させるには、確かに追加の時間と労力がかかりますが、ClickHouseリリースが安定版として発表される時点で既にテストされていることを保証できるため、事後に問題を報告し、バグ修正の実装、バックポート、リリースを待つという時間の浪費を繰り返さずに済むという点で報われます。一部の企業では、インフラストラクチャの使用者によるこのようなテスト貢献を社内ポリシーとして定めています（Googleでは[Beyoncéルール](https://www.oreilly.com/library/view/software-engineering-at/9781492082781/ch01.html#policies_that_scale_well)と呼ばれています）。

プレプロダクション環境とテストインフラストラクチャが整えば、最適なバージョンの選択は簡単です：

1.  新しいClickHouseリリースに対して定期的に自動テストを実行してください。`testing`とマークされたClickHouseリリースに対しても実行できますが、それらで次のステップに進むことは推奨されません。
2.  テストに合格したClickHouseリリースをプレプロダクション環境にデプロイし、すべてのプロセスが期待通りに動作していることを確認してください。
3.  発見した問題を[ClickHouse GitHub Issues](https://github.com/ClickHouse/ClickHouse/issues)に報告してください。
4.  重大な問題がなければ、ClickHouseリリースの本番環境へのデプロイを開始しても安全です。[カナリアリリース](https://martinfowler.com/bliki/CanaryRelease.html)や[ブルーグリーンデプロイメント](https://martinfowler.com/bliki/BlueGreenDeployment.html)に類似したアプローチを実装する段階的リリース自動化に投資することで、本番環境での問題のリスクをさらに軽減できる可能性があります。

お気づきかもしれませんが、上記で説明したアプローチにはClickHouse固有のものは何もありません。本番環境を真剣に考えている人々は、依存するあらゆるインフラストラクチャに対してこれを行っています。


## ClickHouseリリースの選択方法 {#how-to-choose-between-clickhouse-releases}

ClickHouseパッケージリポジトリの内容を確認すると、2種類のパッケージがあります:

1.  `stable`
2.  `lts`(長期サポート)

これらの選択に関するガイダンスは以下の通りです:

- `stable`は、デフォルトで推奨するパッケージです。概ね月次でリリースされ(適度な遅延で新機能が提供されます)、最新の3つのstableリリースについて、診断とバグ修正のバックポートがサポートされます。
- `lts`は年に2回リリースされ、初回リリース後1年間サポートされます。以下のような場合には、`stable`よりも`lts`の選択をお勧めします:
  - 頻繁なアップグレードやLTS以外のソフトウェアの使用を許可しない社内ポリシーがある場合。
  - 複雑なClickHouse機能を必要としない、または最新状態を維持するための十分なリソースがない補助的な製品でClickHouseを使用している場合。

当初は`lts`が適切だと考えていた多くのチームが、製品にとって重要な最新機能のために、最終的に`stable`に切り替えることがよくあります。

:::tip  
ClickHouseをアップグレードする際に留意すべきもう1つの点:リリース間の互換性には常に注意を払っていますが、維持することが合理的でない場合もあり、細かい点が変更される可能性があります。そのため、アップグレード前に必ず[変更履歴](/whats-new/changelog/index.md)を確認し、後方互換性のない変更に関する注記がないか確認してください。
:::
