---
slug: /faq/operations/production
title: '本番環境ではどの ClickHouse バージョンを使うべきですか？'
toc_hidden: true
toc_priority: 10
description: 'このページでは、本番環境で利用する ClickHouse バージョンの選択についてガイドします'
doc_type: 'guide'
keywords: ['production', 'deployment', 'versions', 'best practices', 'upgrade strategy']
---



# 本番環境で使用するClickHouseのバージョンはどれか？ {#which-clickhouse-version-to-use-in-production}

まず、なぜこの質問がされるのかについて説明します。主な理由は2つあります：

1.  ClickHouseは非常に速いペースで開発されており、通常年間10以上の安定版がリリースされます。そのため、選択肢となるリリースの範囲が広く、選択は容易ではありません。
2.  一部のユーザーは、自分のユースケースに最適なバージョンを見極めるのに時間をかけることを避け、他者のアドバイスに従いたいと考えています。

2つ目の理由はより本質的なものであるため、まずそちらから始め、その後さまざまなClickHouseリリースの選び方について説明します。


## どのClickHouseバージョンを推奨しますか？ {#which-clickhouse-version-do-you-recommend}

コンサルタントを雇ったり、著名な専門家を信頼して本番環境の責任を回避したくなることがあります。誰かが推奨した特定のClickHouseバージョンをインストールし、問題が発生した場合は自分の責任ではなく他人の責任だと考えます。しかし、この考え方は大きな落とし穴です。外部の人間が、あなた自身よりも自社の本番環境で何が起こっているかをよく理解していることはありません。

では、どのClickHouseバージョンにアップグレードするかを適切に選択するにはどうすればよいでしょうか？または、最初のClickHouseバージョンをどのように選択すればよいでしょうか？まず第一に、**現実的なプリプロダクション環境**の構築に投資する必要があります。理想的には、完全に同一のシャドウコピーを用意できますが、通常はコストがかかります。

高コストをかけずにプリプロダクション環境で妥当な再現性を得るための重要なポイントは次のとおりです：

- プリプロダクション環境では、本番環境で実行する予定のクエリセットにできるだけ近いものを実行する必要があります：
  - 固定されたデータで読み取り専用にしないでください。
  - 典型的なレポートを作成せずにデータをコピーするだけの書き込み専用にしないでください。
  - スキーママイグレーションを適用する代わりに環境をクリーンに消去しないでください。
- 実際の本番データとクエリのサンプルを使用してください。代表性を保ち、`SELECT`クエリが妥当な結果を返すようなサンプルを選択してください。データが機密性の高いもので、社内ポリシーが本番環境外への持ち出しを許可しない場合は、難読化を使用してください。
- プリプロダクション環境が、本番環境と同じように監視およびアラートソフトウェアでカバーされていることを確認してください。
- 本番環境が複数のデータセンターやリージョンにまたがっている場合は、プリプロダクション環境も同様にしてください。
- 本番環境でレプリケーション、分散テーブル、カスケードマテリアライズドビューなどの複雑な機能を使用している場合は、プリプロダクション環境でも同様に設定されていることを確認してください。
- プリプロダクション環境で、本番環境とほぼ同じ数のサーバーまたはVMを使用するがサイズを小さくするか、同じサイズだが数を大幅に減らすかのトレードオフがあります。前者はネットワーク関連の問題を追加で検出できる可能性がありますが、後者は管理が容易です。

投資すべき2つ目の領域は**自動テストインフラストラクチャ**です。ある種のクエリが一度正常に実行されたからといって、永遠にそうであり続けると仮定しないでください。ClickHouseをモック化したユニットテストを用意するのは問題ありませんが、実際のClickHouseに対して実行され、すべての重要なユースケースが期待どおりに機能していることを確認する適切な自動テストセットを製品に用意してください。

さらに一歩進んで、これらの自動テストを日常的な開発で継続的に使用されている[ClickHouseのオープンソーステストインフラストラクチャ](https://github.com/ClickHouse/ClickHouse/tree/master/tests)に貢献することもできます。[実行方法](../../development/tests.md)を学び、テストをこのフレームワークに適応させるには、確かに追加の時間と労力がかかりますが、ClickHouseリリースが安定版として発表される時点で既にテストされていることを保証することで、問題を事後報告し、バグ修正の実装、バックポート、リリースを待つという時間の浪費を繰り返さずに済むため、その価値はあります。一部の企業では、インフラストラクチャの利用者によるこのようなテスト貢献を社内ポリシーとしています（Googleでは[Beyonce's Rule](https://www.oreilly.com/library/view/software-engineering-at/9781492082781/ch01.html#policies_that_scale_well)と呼ばれています）。

プリプロダクション環境とテストインフラストラクチャが整っていれば、最適なバージョンの選択は簡単です：

1.  新しいClickHouseリリースに対して定期的に自動テストを実行してください。`testing`とマークされたClickHouseリリースに対しても実行できますが、それらで次のステップに進むことは推奨されません。
2.  テストに合格したClickHouseリリースをプリプロダクション環境にデプロイし、すべてのプロセスが期待どおりに実行されていることを確認してください。
3.  発見した問題を[ClickHouse GitHub Issues](https://github.com/ClickHouse/ClickHouse/issues)に報告してください。
4.  重大な問題がなければ、ClickHouseリリースの本番環境へのデプロイを開始しても安全です。[カナリアリリース](https://martinfowler.com/bliki/CanaryRelease.html)や[ブルーグリーンデプロイメント](https://martinfowler.com/bliki/BlueGreenDeployment.html)に類似したアプローチを実装する段階的リリース自動化に投資することで、本番環境での問題のリスクをさらに軽減できる可能性があります。

お気づきかもしれませんが、上記で説明したアプローチにはClickHouse固有のものは何もありません。本番環境を真剣に考えている場合、人々は依存するあらゆるインフラストラクチャに対してこれを行っています。


## ClickHouseリリースの選択方法 {#how-to-choose-between-clickhouse-releases}

ClickHouseパッケージリポジトリの内容を確認すると、2種類のパッケージがあります:

1.  `stable`(安定版)
2.  `lts`(長期サポート版)

以下、これらの選択に関するガイダンスです:

- `stable`は、デフォルトで推奨するパッケージです。概ね月次でリリースされ(そのため、新機能が適度な遅延で提供されます)、最新の3つの安定版リリースについて、診断とバグ修正のバックポートがサポートされます。
- `lts`は年に2回リリースされ、初回リリース後1年間サポートされます。以下のような場合には、`stable`よりも`lts`の選択をお勧めします:
  - 頻繁なアップグレードやLTS以外のソフトウェアの使用を許可しない社内ポリシーがある場合。
  - 複雑なClickHouse機能を必要としない、または更新を維持するための十分なリソースがないサブシステムや製品でClickHouseを使用している場合。

当初は`lts`が適切だと考えていた多くのチームが、製品にとって重要な最新機能のために、最終的に`stable`に切り替えることがよくあります。

:::tip  
ClickHouseをアップグレードする際にもう1つ留意すべき点: 私たちは常にリリース間の互換性に注意を払っていますが、維持することが合理的でない場合もあり、一部の細かい点が変更される可能性があります。そのため、アップグレード前に必ず[変更履歴](/whats-new/changelog/index.md)を確認し、後方互換性のない変更に関する注記がないか確認してください。
:::
