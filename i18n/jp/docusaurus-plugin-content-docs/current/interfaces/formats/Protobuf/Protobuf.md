---
title: Protobuf
slug: /interfaces/formats/Protobuf
keywords: [Protobuf]
input_format: true
output_format: true
alias: []
---

import CloudNotSupportedBadge from '@theme/badges/CloudNotSupportedBadge';

<CloudNotSupportedBadge/>

| 入力 | 出力 | 別名 |
|-------|--------|-------|
| ✔     | ✔      |       |

## 説明 {#description}

`Protobuf`形式は、[Protocol Buffers](https://protobuf.dev/)形式です。

この形式は、クエリ間でキャッシュされる外部形式スキーマを必要とします。

ClickHouseは以下をサポートします：
- `proto2`および`proto3`構文。
- `Repeated`/`optional`/`required`フィールド。

## 使用例 {#example-usage}

### 基本的な例 {#basic-examples}

使用例：

```sql
SELECT * FROM test.table FORMAT Protobuf SETTINGS format_schema = 'schemafile:MessageType'
```

```bash
cat protobuf_messages.bin | clickhouse-client --query "INSERT INTO test.table SETTINGS format_schema='schemafile:MessageType' FORMAT Protobuf"
```

ここで、ファイル `schemafile.proto` は次のようになります：

```capnp
syntax = "proto3";

message MessageType {
  string name = 1;
  string surname = 2;
  uint32 birthDate = 3;
  repeated string phoneNumbers = 4;
};
```

ClickHouseは、テーブルのカラムとProtocol Buffersのメッセージタイプのフィールドの対応を見つけるために、それらの名前を比較します。
この比較は大文字小文字を区別せず、`_`（アンダースコア）と `.` （ドット）は等しいと見なされます。
カラムとProtocol Buffersのメッセージのフィールドの型が異なる場合は、必要な変換が適用されます。

ネストされたメッセージもサポートされています。例えば、以下のメッセージタイプのフィールド `z` の場合：

```capnp
message MessageType {
  message XType {
    message YType {
      int32 z;
    };
    repeated YType y;
  };
  XType x;
};
```

ClickHouseは、`x.y.z`（または `x_y_z` や `X.y_Z` など）という名前のカラムを見つけようとします。

ネストされたメッセージは、[ネストデータ構造](/sql-reference/data-types/nested-data-structures/index.md)の入力または出力に適しています。

以下のようなprotobufスキーマで定義されたデフォルト値は適用されず、[テーブルのデフォルト値](/sql-reference/statements/create/table#default_values)が代わりに使用されます：

```capnp
syntax = "proto2";

message MessageType {
  optional int32 result_per_page = 3 [default = 10];
}
```

ClickHouseは `length-delimited` 形式でprotobufメッセージを入力・出力します。
これは、各メッセージの前にその長さを[可変幅整数（varint）](https://developers.google.com/protocol-buffers/docs/encoding#varints)として記述する必要があることを意味します。

参照: [人気のプログラミング言語での長さ区切りprotobufメッセージの読み書き方法](https://cwiki.apache.org/confluence/display/GEODE/Delimiting+Protobuf+Messages)。

### 自動生成スキーマの使用 {#using-autogenerated-protobuf-schema}

データ用の外部Protobufスキーマがない場合でも、自動生成されたスキーマを使用してProtobuf形式でデータを出力・入力できます。

例えば：

```sql
SELECT * FROM test.hits format Protobuf SETTINGS format_protobuf_use_autogenerated_schema=1
```

この場合、ClickHouseはテーブル構造に従ってProtobufスキーマを自動生成し、[`structureToProtobufSchema`](/sql-reference/functions/other-functions.md#structure_to_protobuf_schema)関数を使用します。
その後、このスキーマを使用してProtobuf形式でデータをシリアライズします。

自動生成されたスキーマを使用してProtobufファイルを読み込むこともできます。この場合、ファイルは同じスキーマを使って作成されている必要があります：

```bash
$ cat hits.bin | clickhouse-client --query "INSERT INTO test.hits SETTINGS format_protobuf_use_autogenerated_schema=1 FORMAT Protobuf"
```

設定[`format_protobuf_use_autogenerated_schema`](/operations/settings/settings-formats.md#format_protobuf_use_autogenerated_schema)はデフォルトで有効で、[`format_schema`](/operations/settings/formats#format_schema)が設定されていない場合に適用されます。

入力・出力中に設定[`output_format_schema`](/operations/settings/formats#output_format_schema)を使用して自動生成スキーマをファイルに保存することもできます。例えば：

```sql
SELECT * FROM test.hits format Protobuf SETTINGS format_protobuf_use_autogenerated_schema=1, output_format_schema='path/to/schema/schema.proto'
```

この場合、自動生成されたProtobufスキーマはファイル `path/to/schema/schema.capnp` に保存されます。

### Protobufキャッシュの削除 {#drop-protobuf-cache}

[`format_schema_path`](/operations/server-configuration-parameters/settings.md/#format_schema_path)から読み込まれたProtobufスキーマを再読み込みするには、[`SYSTEM DROP ... FORMAT CACHE`](/sql-reference/statements/system.md/#system-drop-schema-format)ステートメントを使用します。

```sql
SYSTEM DROP FORMAT SCHEMA CACHE FOR Protobuf
```

## フォーマット設定 {#format-settings}
