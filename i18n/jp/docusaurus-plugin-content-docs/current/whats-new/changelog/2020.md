---
slug: /whats-new/changelog/2020
sidebar_position: 7
sidebar_label: "2020"
title: "2020年の変更履歴"
description: "2020年の変更履歴"
doc_type: "changelog"
keywords:
  [
    "ClickHouse 2020",
    "changelog 2020",
    "リリースノート",
    "バージョン履歴",
    "バグ修正"
  ]
---

### ClickHouseリリース 20.12 {#clickhouse-release-2012}

### ClickHouseリリース v20.12.5.14-stable, 2020-12-28 {#clickhouse-release-v2012514-stable-2020-12-28}

#### バグ修正 {#bug-fix}

- マージ中のAIOによる書き込みを無効化しました。マージ時に主キー列で極めて稀にデータ破損が発生する可能性があるためです。[#18481](https://github.com/ClickHouse/ClickHouse/pull/18481) ([alesapin](https://github.com/alesapin))。
- `Nullable(String)`型の引数で`toType(...)`関数（`toDate`、`toUInt32`など）を実行する際の`value is too short`エラーを修正しました。これらの関数は、パースエラー時に例外をスローする代わりに`NULL`を返すようになりました。[#7673](https://github.com/ClickHouse/ClickHouse/issues/7673)を修正します。[#18445](https://github.com/ClickHouse/ClickHouse/pull/18445) ([tavplubix](https://github.com/tavplubix))。
- ワイドパートからコンパクトパートへのマージを制限しました。垂直マージの場合、結果パートが破損する原因となっていました。[#18381](https://github.com/ClickHouse/ClickHouse/pull/18381) ([Anton Popov](https://github.com/CurtizJ))。
- `system.settings_profile_elements`テーブルの入力処理を修正しました。このPRは[#18231](https://github.com/ClickHouse/ClickHouse/issues/18231)を修正します。[#18379](https://github.com/ClickHouse/ClickHouse/pull/18379) ([Vitaly Baranov](https://github.com/vitlibar))。
- 2レベル集約を使用する際の、`Distinct`コンビネータを持つ集約関数における潜在的なクラッシュを修正しました。[#17682](https://github.com/ClickHouse/ClickHouse/issues/17682)を修正します。[#18365](https://github.com/ClickHouse/ClickHouse/pull/18365) ([Anton Popov](https://github.com/CurtizJ))。
- `MODIFY COLUMN ... REMOVE TTL`クエリが実際には列のTTLを削除しないエラーを修正しました。[#18130](https://github.com/ClickHouse/ClickHouse/pull/18130) ([alesapin](https://github.com/alesapin))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement}

- タイムゾーン情報を2020eに更新しました。[#18531](https://github.com/ClickHouse/ClickHouse/pull/18531) ([alesapin](https://github.com/alesapin))。

### ClickHouseリリース v20.12.4.5-stable, 2020-12-24 {#clickhouse-release-v201245-stable-2020-12-24}

#### バグ修正 {#bug-fix-1}


- デュアルIPv4/IPv6スタックを持つマシンにおいて、サーバーが`clickhouse-odbc-bridge`プロセスに到達できない問題を修正しました。- 不正な形式のクエリを使用してODBC辞書の更新が実行される、またはクラッシュを引き起こす問題を修正しました。おそらく次の問題を解決します: [#14489](https://github.com/ClickHouse/ClickHouse/issues/14489)。[#18278](https://github.com/ClickHouse/ClickHouse/pull/18278) ([Denis Glazachev](https://github.com/traceon))。
- Enum型とInt型間のキー比較を修正しました。次の問題を修正します: [#17989](https://github.com/ClickHouse/ClickHouse/issues/17989)。[#18214](https://github.com/ClickHouse/ClickHouse/pull/18214) ([Amos Bird](https://github.com/amosbird))。
- `MaterializeMySQL`データベースエンジンにおけるユニークキー変換時のクラッシュを修正しました。次の問題を修正します: [#18186](https://github.com/ClickHouse/ClickHouse/issues/18186) および [#16372](https://github.com/ClickHouse/ClickHouse/issues/16372) [#18211](https://github.com/ClickHouse/ClickHouse/pull/18211) ([Winter Zhang](https://github.com/zhang2014))。
- S3 URLパース時の`std::out_of_range: basic_string`エラーを修正しました。[#18059](https://github.com/ClickHouse/ClickHouse/pull/18059) ([Vladimir Chebotarev](https://github.com/excitoon))。
- MaterializeMySQLでMySQLプレフィックスインデックスの変換がサポートされていなかったことが原因で、MySQLから一部のテーブルがClickHouseに同期されない問題を修正しました。次の問題を修正します: [#15187](https://github.com/ClickHouse/ClickHouse/issues/15187) および [#17912](https://github.com/ClickHouse/ClickHouse/issues/17912) [#17944](https://github.com/ClickHouse/ClickHouse/pull/17944) ([Winter Zhang](https://github.com/zhang2014))。
- クエリに`ARRAY JOIN`が含まれている場合にクエリ最適化が誤った結果を生成する問題を修正しました。[#17887](https://github.com/ClickHouse/ClickHouse/pull/17887) ([sundyli](https://github.com/sundy-li))。
- `topK`集約関数における潜在的なセグメンテーション違反を修正しました。次の問題を解決します: [#17404](https://github.com/ClickHouse/ClickHouse/issues/17404)。[#17845](https://github.com/ClickHouse/ClickHouse/pull/17845) ([Maksim Kita](https://github.com/kitaisreal))。
- サーバーがデーモンモードで実行されている場合に`system.stack_trace`テーブルが空になる問題を修正しました。[#17630](https://github.com/ClickHouse/ClickHouse/pull/17630) ([Amos Bird](https://github.com/amosbird))。

### ClickHouseリリース v20.12.3.3-stable, 2020-12-13 {#clickhouse-release-v201233-stable-2020-12-13}

#### 後方互換性のない変更 {#backward-incompatible-change}

- `use_compact_format_in_distributed_parts_names`をデフォルトで有効化しました(詳細はドキュメントを参照してください)。[#16728](https://github.com/ClickHouse/ClickHouse/pull/16728) ([Azat Khuzhin](https://github.com/azat))。
- `File`エンジンを使用するテーブルを作成する際に、`SETTINGS`句でファイル形式に関連するユーザー設定(例: `format_csv_delimiter`)を受け入れ、すべての`INSERT`および`SELECT`でこれらの設定を使用するようにしました。現在のユーザーセッションまたはDMLクエリ自体の`SETTINGS`句で変更されたファイル形式設定は、クエリに影響を与えなくなりました。[#16591](https://github.com/ClickHouse/ClickHouse/pull/16591) ([Alexander Kuzmenkov](https://github.com/akuzm))。

#### 新機能 {#new-feature}


- `*.xz`圧縮/解凍のサポートを追加しました。これにより、`file()`関数で`*.xz`を使用できるようになります。これは[#8828](https://github.com/ClickHouse/ClickHouse/issues/8828)を解決します。[#16578](https://github.com/ClickHouse/ClickHouse/pull/16578) ([Abi Palagashvili](https://github.com/fibersel))。
- クエリ`ALTER TABLE ... DROP|DETACH PART 'part_name'`を導入しました。[#15511](https://github.com/ClickHouse/ClickHouse/pull/15511) ([nvartolomei](https://github.com/nvartolomei))。
- 新しいALTER UPDATE/DELETE IN PARTITION構文を追加しました。[#13403](https://github.com/ClickHouse/ClickHouse/pull/13403) ([Vladimir Chebotarev](https://github.com/excitoon))。
- JSON入出力形式を使用する際に、名前付きタプルをJSONオブジェクトとしてフォーマットできるようになりました。これは`output_format_json_named_tuples_as_objects`設定で制御され、デフォルトでは無効になっています。[#17175](https://github.com/ClickHouse/ClickHouse/pull/17175) ([Alexander Kuzmenkov](https://github.com/akuzm))。
- TSVおよびCSV形式で、デフォルトでenum値をそのIDとして入力できる機能を追加しました。[#16834](https://github.com/ClickHouse/ClickHouse/pull/16834) ([Kruglov Pavel](https://github.com/Avogar))。
- ネストされた型がStringである場合の、Nullable、LowCardinality、Array、TupleのCOLLATEサポートを追加しました。また、ColumnString.cppの照合順序に関連するコードをリファクタリングしました。[#16273](https://github.com/ClickHouse/ClickHouse/pull/16273) ([Kruglov Pavel](https://github.com/Avogar))。
- 新しい`tcpPort`関数は、このサーバーがリッスンしているTCPポートを返します。[#17134](https://github.com/ClickHouse/ClickHouse/pull/17134) ([Ivan](https://github.com/abyss7))。
- 新しい数学関数を追加しました:`acosh`、`asinh`、`atan2`、`atanh`、`cosh`、`hypot`、`log1p`、`sinh`。[#16636](https://github.com/ClickHouse/ClickHouse/pull/16636) ([Konstantin Malanchev](https://github.com/hombit))。
- 異なるレプリカ間でマージを分散する機能を追加しました。`execute_merges_on_single_replica_time_threshold` mergetree設定を導入しました。[#16424](https://github.com/ClickHouse/ClickHouse/pull/16424) ([filimonov](https://github.com/filimonov))。
- SQL標準互換性のための設定`aggregate_functions_null_for_empty`を追加しました。このオプションは、クエリ内のすべての集約関数を書き換え、-OrNullサフィックスを追加します。[10273](https://github.com/ClickHouse/ClickHouse/issues/10273)を実装しています。[#16123](https://github.com/ClickHouse/ClickHouse/pull/16123) ([flynn](https://github.com/ucasFL))。
- DateTime、DateTime64のパースを更新し、文字列Date形式を受け入れるようにしました。[#16040](https://github.com/ClickHouse/ClickHouse/pull/16040) ([Maksim Kita](https://github.com/kitaisreal))。
- `clickhouse-client`で`--history_file`パラメータを使用して履歴ファイルのパスを変更できるようにしました。[#15960](https://github.com/ClickHouse/ClickHouse/pull/15960) ([Maksim Kita](https://github.com/kitaisreal))。

#### バグ修正 {#bug-fix-2}


* サーバーが極めてまれな場合に接続の受け付けを停止してしまう問題を修正しました。 [#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) ([Amos Bird](https://github.com/amosbird)).
* Windows Subsystem for Linux 上で ClickHouse を実行している環境において、`Atomic` データベースで `RENAME` クエリを実行した際に発生していた `Function not implemented` エラーを修正しました。[#17661](https://github.com/ClickHouse/ClickHouse/issues/17661) を解決。[#17664](https://github.com/ClickHouse/ClickHouse/pull/17664)（[tavplubix](https://github.com/tavplubix)）。
* `in_memory_parts_enable_wal` が無効になっている場合、WAL からパーツを復元しないようにしました。 [#17802](https://github.com/ClickHouse/ClickHouse/pull/17802) ([detailyang](https://github.com/detailyang)).
* `MergeTreeWriterSettings` の `max_compress_block_size` が誤って `min_compress_block_size` で初期化されていた問題を修正。 [#17833](https://github.com/ClickHouse/ClickHouse/pull/17833) ([flynn](https://github.com/ucasFL)).
* 削除対象とできるテーブルの最大サイズに関する例外メッセージが誤って表示されていました。 [#17764](https://github.com/ClickHouse/ClickHouse/pull/17764) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `Distributed` テーブルへの挿入時に空き領域が不足している場合に発生する可能性があったセグメンテーションフォールトを修正しました。 [#17737](https://github.com/ClickHouse/ClickHouse/pull/17737) ([tavplubix](https://github.com/tavplubix)).
* ClickHouse が MySQL サーバーへの接続を再開できない問題を修正。 [#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz))。
* `pool_size` &gt; 1 の場合のレースコンディションにより、`ON CLUSTER` クエリの実行時にクラスタが循環（クロス）レプリケーションされているかどうかが誤って判定されることがありました。この問題を修正しました。 [#17640](https://github.com/ClickHouse/ClickHouse/pull/17640) ([tavplubix](https://github.com/tavplubix)).
* 例外 `fmt::v7::format_error` が MergeTree テーブルでバックグラウンド処理中にログに記録される場合があります。これにより [#17613](https://github.com/ClickHouse/ClickHouse/issues/17613) が修正されました。[#17615](https://github.com/ClickHouse/ClickHouse/pull/17615) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `clickhouse-client` をインタラクティブモードでマルチラインクエリとともに使用した場合、1 行コメントが誤ってクエリの末尾まで拡張されていました。これにより [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654) が修正されました。 [#17565](https://github.com/ClickHouse/ClickHouse/pull/17565) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 対応するミューテーションが別のレプリカ上で強制終了された場合に `ALTER` クエリがハングする問題を修正。[#16953](https://github.com/ClickHouse/ClickHouse/issues/16953) を修正。[#17499](https://github.com/ClickHouse/ClickHouse/pull/17499)（[alesapin](https://github.com/alesapin)）。
* mark cache のサイズが ClickHouse によって過小評価される問題を修正しました。これは、mark を含むごく小さなファイルが多数存在する場合に発生する可能性がありました。 [#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin))。
* 設定 `optimize_redundant_functions_in_order_by` 有効時の `ORDER BY` を修正。 [#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* 誤った最適化により `DISTINCT` 適用後にも重複が残る可能性があった問題を修正。 [#17294](https://github.com/ClickHouse/ClickHouse/issues/17294) を修正。 [#17296](https://github.com/ClickHouse/ClickHouse/pull/17296)（[li chengxiang](https://github.com/chengxianglibra)）。 [#17439](https://github.com/ClickHouse/ClickHouse/pull/17439)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `LowCardinality` 型を含む `JOIN` テーブルからの読み取り時に発生するクラッシュを修正。これにより [#17228](https://github.com/ClickHouse/ClickHouse/issues/17228) を解決。 [#17397](https://github.com/ClickHouse/ClickHouse/pull/17397)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `toInt256(inf)` によるスタックオーバーフローが発生する問題を修正。Int256 は実験的な機能です。[#17235](https://github.com/ClickHouse/ClickHouse/issues/17235) をクローズ。[#17257](https://github.com/ClickHouse/ClickHouse/pull/17257)（[flynn](https://github.com/ucasFL)）。
* `LIMIT` を伴う Distributed クエリでログに出力される可能性のある `Unexpected packet Data received from client` エラーを修正。 [#17254](https://github.com/ClickHouse/ClickHouse/pull/17254) ([Azat Khuzhin](https://github.com/azat))。
* サブクエリに `const` カラムが含まれている場合に set インデックスが無効化されてしまう問題を修正しました。これにより [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246) が修正されます。[#17249](https://github.com/ClickHouse/ClickHouse/pull/17249)（[Amos Bird](https://github.com/amosbird)）。
* インデックス比較の型が異なる場合に誤ったインデックス解析が行われる可能性があった問題を修正しました。これにより [#17122](https://github.com/ClickHouse/ClickHouse/issues/17122) が修正されました。[#17145](https://github.com/ClickHouse/ClickHouse/pull/17145)（[Amos Bird](https://github.com/amosbird)）。
* クラッシュの原因となっていた ColumnConst の比較を修正しました。これにより [#17088](https://github.com/ClickHouse/ClickHouse/issues/17088) が解決されました。 [#17135](https://github.com/ClickHouse/ClickHouse/pull/17135) ([Amos Bird](https://github.com/amosbird))。
* MaterializeMySQL（実験的機能）に対する複数の修正。[#16923](https://github.com/ClickHouse/ClickHouse/issues/16923) および [#15883](https://github.com/ClickHouse/ClickHouse/issues/15883) を修正。MySQL の `binlog_checksum` を変更した際に発生する MaterializeMySQL の SYNC の失敗を修正。[#17091](https://github.com/ClickHouse/ClickHouse/pull/17091)（[Winter Zhang](https://github.com/zhang2014)）。
* `ON CLUSTER` クエリがリーダーでない ReplicatedMergeTreeTables に対して無期限にハングし続ける可能性がある不具合を修正。 [#17089](https://github.com/ClickHouse/ClickHouse/pull/17089) ([alesapin](https://github.com/alesapin)).
* `some_table` が `AS table_function()` として作成されていた場合に、`CREATE TABLE ... AS some_table` クエリで発生していたクラッシュを修正しました。[#16944](https://github.com/ClickHouse/ClickHouse/issues/16944) を修正。[#17072](https://github.com/ClickHouse/ClickHouse/pull/17072) ([tavplubix](https://github.com/tavplubix))。
* 関数 fuzzBits の未完成の実装に起因するバグ。関連する issue: [#16980](https://github.com/ClickHouse/ClickHouse/issues/16980)。[#17051](https://github.com/ClickHouse/ClickHouse/pull/17051)（[hexiaoting](https://github.com/hexiaoting)）。
* CFA レジスタが RAX の場合に LLVM の libunwind を修正。これは [LLVM の libunwind](https://github.com/llvm/llvm-project/tree/master/libunwind) における [バグ](https://bugs.llvm.org/show_bug.cgi?id=48186) です。すでにこのバグに対するワークアラウンドは導入済みです。[#17046](https://github.com/ClickHouse/ClickHouse/pull/17046)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `LIMIT` を含むクエリのように、実行中にキャンセルされる可能性のあるリモートクエリにおける不要なネットワークエラーの発生を回避します。 [#17006](https://github.com/ClickHouse/ClickHouse/pull/17006) ([Azat Khuzhin](https://github.com/azat)).
* OFFSET 句のみを含むクエリに対して、（デフォルトでは無効の）`optimize_distributed_group_by_sharding_key` 設定を修正。 [#16996](https://github.com/ClickHouse/ClickHouse/pull/16996) ([Azat Khuzhin](https://github.com/azat)).
* JOIN を伴う Distributed テーブル上の Merge テーブル向けの修正。 [#16993](https://github.com/ClickHouse/ClickHouse/pull/16993) ([Azat Khuzhin](https://github.com/azat)).
* double 型からのキャスト時に、128 / 256 ビットの大きな整数型で誤った結果が返される問題を修正しました。大きな整数型のサポートは実験的機能です。 [#16986](https://github.com/ClickHouse/ClickHouse/pull/16986) ([Mike](https://github.com/myrrc))。
* `ALTER TABLE ... MODIFY COLUMN ... NewType` 実行中に、変更対象のカラムに対して `WHERE` 句を含む `SELECT` が実行された場合に発生しうるサーバークラッシュを修正。 [#16968](https://github.com/ClickHouse/ClickHouse/pull/16968) ([Amos Bird](https://github.com/amosbird)).
* `clickhouse-git-import` で blame 情報が正しく計算されていませんでした。 [#16959](https://github.com/ClickHouse/ClickHouse/pull/16959) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 単調関数を利用した ORDER BY の最適化を修正。[#16107](https://github.com/ClickHouse/ClickHouse/issues/16107) を修正。[#16956](https://github.com/ClickHouse/ClickHouse/pull/16956)（[Anton Popov](https://github.com/CurtizJ)）。
* `optimize_aggregators_of_group_by_keys` 設定が有効な状態での `GROUP BY` と `JOIN` の最適化の不具合を修正。 [#12604](https://github.com/ClickHouse/ClickHouse/issues/12604) を修正。 [#16951](https://github.com/ClickHouse/ClickHouse/pull/16951)（[Anton Popov](https://github.com/CurtizJ)）。
* `ORDER BY` を含むクエリで発生する可能性のあった `Illegal type of argument` エラーを修正。[#16580](https://github.com/ClickHouse/ClickHouse/issues/16580) を修正。[#16928](https://github.com/ClickHouse/ClickHouse/pull/16928)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* InterpreterShowAccessQuery 内の不自然なコードを修正。 [#16866](https://github.com/ClickHouse/ClickHouse/pull/16866) ([tavplubix](https://github.com/tavplubix))。
* 関数 `timeSeriesGroupSum` 使用時に ClickHouse サーバーがクラッシュする問題を防止しました。この関数は新しい ClickHouse リリースでは削除されています。 [#16865](https://github.com/ClickHouse/ClickHouse/pull/16865) ([filimonov](https://github.com/filimonov))。
* クエリプロファイラが有効であり、かつ一部の関数で（おそらく）壊れた非同期アンワインドテーブルを持つ glibc バージョンを使用する OS 上に ClickHouse がインストールされている場合に発生する、まれなサイレントクラッシュを修正しました。これにより [#15301](https://github.com/ClickHouse/ClickHouse/issues/15301) が修正されます。また、[#13098](https://github.com/ClickHouse/ClickHouse/issues/13098) も修正されます。 [#16846](https://github.com/ClickHouse/ClickHouse/pull/16846)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 引数なしで `any` を使用した際にクラッシュが発生する問題を修正しました。これは [#16803](https://github.com/ClickHouse/ClickHouse/issues/16803) に対応するものです。cc @azat。 [#16826](https://github.com/ClickHouse/ClickHouse/pull/16826)（[Amos Bird](https://github.com/amosbird)）。
* ディスク上にテーブルメタデータを書き込む際にメモリを確保できない場合、破損したメタデータファイルが書き込まれる可能性があります。 [#16772](https://github.com/ClickHouse/ClickHouse/pull/16772) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* パーティション述語を用いた単純なクエリ最適化を修正。 [#16767](https://github.com/ClickHouse/ClickHouse/pull/16767) ([Azat Khuzhin](https://github.com/azat)).
* `transform_null_in` 設定が有効な場合に、複数カラムおよびタプルに対する `IN` 演算子の動作を修正しました。 [#15310](https://github.com/ClickHouse/ClickHouse/issues/15310) を修正します。 [#16722](https://github.com/ClickHouse/ClickHouse/pull/16722)（[Anton Popov](https://github.com/CurtizJ)）。
* MySQL プロトコル経由の INSERT クエリに対して、影響を受けた行数を返すようになりました。以前は ClickHouse は常に 0 を返していましたが、この問題は修正されています。[#16605](https://github.com/ClickHouse/ClickHouse/issues/16605) を修正。[#16715](https://github.com/ClickHouse/ClickHouse/pull/16715)（[Winter Zhang](https://github.com/zhang2014)）。
* &#39;if&#39; サフィックス付き集約関数の使用時に発生するリモートクエリ失敗の問題を修正。[#16574](https://github.com/ClickHouse/ClickHouse/issues/16574)、[#16231](https://github.com/ClickHouse/ClickHouse/issues/16231)、[#16610](https://github.com/ClickHouse/ClickHouse/pull/16610) を修正（[Winter Zhang](https://github.com/zhang2014)）。
* 最適化された単純な count クエリおよび system.tables に対して、`select_sequential_consistency` によって引き起こされる一貫性のない動作を修正しました。 [#16309](https://github.com/ClickHouse/ClickHouse/pull/16309) ([Hao Chen](https://github.com/haoch))。

#### 改善 {#improvement}


* TTL、ミューテーション、または collapsing マージアルゴリズムによる削除後に残った空のパーツを削除します。 [#16895](https://github.com/ClickHouse/ClickHouse/pull/16895) ([Anton Popov](https://github.com/CurtizJ)).
* Distributed テーブルでの非同期送信時にディレクトリのコンパクトな形式を有効化: `use_compact_format_in_distributed_parts_names` はデフォルトで 1 に設定されています。[#16788](https://github.com/ClickHouse/ClickHouse/pull/16788) ([Azat Khuzhin](https://github.com/azat))。
* S3 にデータが書き込まれなかった場合は、マルチパートアップロードを中止するようにしました。[#16840](https://github.com/ClickHouse/ClickHouse/pull/16840) ([Pavel Kovalenko](https://github.com/Jokser)).
* エラー発生時に `format_avro_schema_registry_url` の IP アドレスを再度解決するようにしました。 [#16985](https://github.com/ClickHouse/ClickHouse/pull/16985) ([filimonov](https://github.com/filimonov)).
* system.distribution&#95;queue 内の data&#95;path に含まれるパスワードをマスクするようにしました。 [#16727](https://github.com/ClickHouse/ClickHouse/pull/16727) ([Azat Khuzhin](https://github.com/azat)).
* 存在しないカラムを `column transformer` で置き換えようとした場合はエラーをスローするようにしました。 [#16183](https://github.com/ClickHouse/ClickHouse/pull/16183) ([hexiaoting](https://github.com/hexiaoting)).
* すべてのスレッドが同時に動作するのに十分なメモリがない場合は、並列パースをオフにします。また、誰かが極端に巨大な行（&gt; min&#95;chunk&#95;bytes&#95;for&#95;parallel&#95;parsing）を挿入しようとした場合、「Memory limit exceeded」のような例外が発生する可能性もあります。これは、パース対象の各チャンクが（1 つ以上の）文字列から成る独立した集合でなければならないためです。 [#16721](https://github.com/ClickHouse/ClickHouse/pull/16721) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* インストールスクリプトは常に config フォルダ内にサブディレクトリを作成するようにしました。これは、カスタム config を用いた Docker ビルドにのみ関係します。 [#16936](https://github.com/ClickHouse/ClickHouse/pull/16936) ([filimonov](https://github.com/filimonov)).
* JSONEachRow、JSONCompactEachRow、および RegexpRow の各入力形式におけるエラーメッセージの文法を修正しました。 [#17205](https://github.com/ClickHouse/ClickHouse/pull/17205) ([nico piderman](https://github.com/sneako))。
* `SOURCE(CLICKHOUSE(...))` のデフォルトの `host` および `port` パラメータを現在のインスタンスに、`user` のデフォルト値を `'default'` に設定しました。 [#16997](https://github.com/ClickHouse/ClickHouse/pull/16997) ([vdimir](https://github.com/vdimir)).
* `ATTACH/DETACH TABLE <DICTIONARY>` を実行した際に、よりわかりやすいエラーメッセージを返すようにしました。この PR 以前は、`detach table <dict>` は実行自体は成功するものの、不正なインメモリメタデータ状態を引き起こしていました。 [#16885](https://github.com/ClickHouse/ClickHouse/pull/16885) ([Amos Bird](https://github.com/amosbird))。
* cutToFirstSignificantSubdomainWithWWW() を追加しました。 [#16845](https://github.com/ClickHouse/ClickHouse/pull/16845) ([Azat Khuzhin](https://github.com/azat)).
* 誤った設定が指定された場合（`metric_log`.`collect_interval_milliseconds` が欠落している）、サーバーは起動を拒否し、例外メッセージを出力するようになりました。 [#16815](https://github.com/ClickHouse/ClickHouse/pull/16815) ([Ivan](https://github.com/abyss7)).
* 分散 DDL の設定が存在しない場合に出力される例外メッセージを改善しました。これにより [#5075](https://github.com/ClickHouse/ClickHouse/issues/5075) が修正されました。 [#16769](https://github.com/ClickHouse/ClickHouse/pull/16769) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* ユーザビリティの改善：`CREATE TABLE` クエリで `CODEC` 式が誤った位置にある場合の構文エラーメッセージにおいて、より適切な候補が提示されるようにしました。これにより [#12493](https://github.com/ClickHouse/ClickHouse/issues/12493) が修正されました。 [#16768](https://github.com/ClickHouse/ClickHouse/pull/16768) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* Distributed エンジンの起動時に、非同期 `INSERT` 用の空ディレクトリを削除するようにしました。 [#16729](https://github.com/ClickHouse/ClickHouse/pull/16729) ([Azat Khuzhin](https://github.com/azat)).
* nginx サーバーをプロキシとして介して S3 を使用するためのワークアラウンド。現在の Nginx は `http://domain.com?delete` のような、パスが空の URL を受け付けないが、標準の aws-sdk-cpp はこの種の URL を生成する。このコミットではパッチ適用済みの aws-sdk-cpp バージョンを使用し、このような場合にパスとして &quot;/&quot; を持つ URL、例えば `http://domain.com/?delete` を生成するようにしている。[#16709](https://github.com/ClickHouse/ClickHouse/pull/16709) ([ianton-ru](https://github.com/ianton-ru))。
* 同じサイズの整数および浮動小数点数に対して `reinterpretAs*` 関数が動作するようにしました。[16640](https://github.com/ClickHouse/ClickHouse/issues/16640) を実装しました。[#16657](https://github.com/ClickHouse/ClickHouse/pull/16657)（[flynn](https://github.com/ucasFL)）。
* これにより、サーバーを再起動することなく `config.xml` の `<auxiliary_zookeepers>` 設定を変更して再読み込みできるようになりました。 [#16627](https://github.com/ClickHouse/ClickHouse/pull/16627) ([Amos Bird](https://github.com/amosbird))。
* リモートリソースへの HTTPS 接続で SNI をサポートしました。これにより、SNI を必須とする Cloudflare サーバーへの接続が可能になります。この変更により [#10055](https://github.com/ClickHouse/ClickHouse/issues/10055) が修正されました。 [#16252](https://github.com/ClickHouse/ClickHouse/pull/16252) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* SNI を要求する `clickhouse-server` のセキュアエンドポイントへ接続できるようにしました。これは、`clickhouse-server` が TLS プロキシの背後でホストされている場合に有効です。 [#16938](https://github.com/ClickHouse/ClickHouse/pull/16938) ([filimonov](https://github.com/filimonov)).
* マテリアライズドビューのループが作成された際に発生し得るスタックオーバーフローを修正しました。これにより [#15732](https://github.com/ClickHouse/ClickHouse/issues/15732) がクローズされました。 [#16048](https://github.com/ClickHouse/ClickHouse/pull/16048) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* MergeTree テーブルエンジンファミリー向けのバックグラウンドタスク処理の実装を簡素化しました。ユーザーから見た挙動に変更はありません。[#15983](https://github.com/ClickHouse/ClickHouse/pull/15983) ([alesapin](https://github.com/alesapin))。
* MaterializeMySQL（実験的機能）の改善。MySQL の同期ユーザーの権限設定が誤っている場合に、正しい同期に必要な権限についての例外をスローするようにしました。 [#15977](https://github.com/ClickHouse/ClickHouse/pull/15977) ([TCeason](https://github.com/TCeason)).
* `indexOf()` で BloomFilter を使用するようにしました。 [#14977](https://github.com/ClickHouse/ClickHouse/pull/14977) ([achimbab](https://github.com/achimbab)).

#### パフォーマンス改善 {#performance-improvement}

- Floyd-Rivestアルゴリズムを使用します。これはClickHouseの部分ソートのユースケースに最適です。ベンチマークは https://github.com/danlark1/miniselect および[こちら](https://drive.google.com/drive/folders/1DHEaeXgZuX6AJ9eByeZ8iQVQv0ueP8XM)にあります。[#16825](https://github.com/ClickHouse/ClickHouse/pull/16825) ([Danila Kutenin](https://github.com/danlark1))。
- `ReplicatedMergeTree`エンジンファミリーは、レプリケーションフェッチ用に独立したスレッドプールを使用するようになりました。プールのサイズは`background_fetches_pool_size`設定によって制限され、サーバーの再起動で調整できます。この設定のデフォルト値は3で、並列フェッチの最大数が3であることを意味します(これにより10Gネットワークを活用できます)。#520を修正しました。[#16390](https://github.com/ClickHouse/ClickHouse/pull/16390) ([alesapin](https://github.com/alesapin))。
- `quantileTDigest`の状態の制御されない増大を修正しました。[#16680](https://github.com/ClickHouse/ClickHouse/pull/16680) ([hrissan](https://github.com/hrissan))。
- `EXPLAIN`に`VIEW`サブクエリの説明を追加しました。`VIEW`の述語プッシュダウン最適化を制限しました。クエリプランに`Distributed`のローカルレプリカを追加しました。[#14936](https://github.com/ClickHouse/ClickHouse/pull/14936) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- max_threads > 0およびORDER BY内の式を使用した場合のoptimize_read_in_order/optimize_aggregation_in_orderを修正しました。[#16637](https://github.com/ClickHouse/ClickHouse/pull/16637) ([Azat Khuzhin](https://github.com/azat))。
- 大量の`MergeTree`テーブルに対する`Merge`テーブルからの読み取りパフォーマンスを修正しました。[#7748](https://github.com/ClickHouse/ClickHouse/issues/7748)を修正しました。[#16988](https://github.com/ClickHouse/ClickHouse/pull/16988) ([Anton Popov](https://github.com/CurtizJ))。
- 完全一致でパーティションを安全に削除できるようになりました。有用なケース: テーブルが`intHash64(x) % 100`でパーティション化されており、クエリがxではなく`intHash64(x) % 100`そのものに対する条件を持つ場合を想定します。[#16253](https://github.com/ClickHouse/ClickHouse/pull/16253) ([Amos Bird](https://github.com/amosbird))。

#### 実験的機能 {#experimental-feature}

- `EmbeddedRocksDB`テーブルエンジンを追加しました(ディクショナリに使用できます)。[#15073](https://github.com/ClickHouse/ClickHouse/pull/15073) ([sundyli](https://github.com/sundy-li))。

#### ビルド/テスト/パッケージング改善 {#buildtestingpackaging-improvement-1}


* イメージビルドに関するテストカバレッジを改善。 [#17233](https://github.com/ClickHouse/ClickHouse/pull/17233) ([alesapin](https://github.com/alesapin)).
* 埋め込みタイムゾーンデータをバージョン 2020d に更新（cctz も最新の master に更新）。 [#17204](https://github.com/ClickHouse/ClickHouse/pull/17204) ([filimonov](https://github.com/filimonov)).
* Poco における UBSan レポートを修正。これにより [#12719](https://github.com/ClickHouse/ClickHouse/issues/12719) がクローズされます。 [#16765](https://github.com/ClickHouse/ClickHouse/pull/16765) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* サードパーティライブラリに対して UBSan のインストルメンテーションを行わないように変更。 [#16764](https://github.com/ClickHouse/ClickHouse/pull/16764) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* キャッシュディクショナリにおける UBSan レポートを修正。これにより [#12641](https://github.com/ClickHouse/ClickHouse/issues/12641) がクローズされます。 [#16763](https://github.com/ClickHouse/ClickHouse/pull/16763) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 無限大の浮動小数点数を整数へ変換しようとした際の UBSan レポートを修正。これにより [#14190](https://github.com/ClickHouse/ClickHouse/issues/14190) がクローズされます。 [#16677](https://github.com/ClickHouse/ClickHouse/pull/16677) ([alexey-milovidov](https://github.com/alexey-milovidov)).



## ClickHouse リリース 20.11 {#clickhouse-release-2011}

### ClickHouse リリース v20.11.7.16-stable, 2021-03-02 {#clickhouse-release-v2011716-stable-2021-03-02}

#### 改善 {#improvement-1}

- clickhouse-server イメージにおいて、clickhouse ユーザーおよびグループの uid / gid を固定値 (101) に明示的に設定しました。[#19096](https://github.com/ClickHouse/ClickHouse/pull/19096) ([filimonov](https://github.com/filimonov))。

#### バグ修正 {#bug-fix-3}


* BloomFilter インデックスのクラッシュを修正。[#19757](https://github.com/ClickHouse/ClickHouse/issues/19757) を解決。 [#19884](https://github.com/ClickHouse/ClickHouse/pull/19884)（[Maksim Kita](https://github.com/kitaisreal)）。
* system.text&#95;log が有効な場合にデッドロックが発生する可能性のある問題がありました。これは [#19874](https://github.com/ClickHouse/ClickHouse/issues/19874) を修正しました。 [#19875](https://github.com/ClickHouse/ClickHouse/pull/19875) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 以前のバージョンでは、関数 arrayEnumerateUniq に対する異常な引数がクラッシュや無限ループを引き起こす可能性がありました。これにより [#19787](https://github.com/ClickHouse/ClickHouse/issues/19787) がクローズされました。 [#19788](https://github.com/ClickHouse/ClickHouse/pull/19788) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 算術型と文字列型の厳密比較を行った際に発生していたスタックオーバーフローを修正しました。 [#19773](https://github.com/ClickHouse/ClickHouse/pull/19773) ([tavplubix](https://github.com/tavplubix)).
* `bitmapAndnot` 関数で発生していたセグメンテーションフォールトを修正し、[#19668](https://github.com/ClickHouse/ClickHouse/issues/19668) を解決。[#19713](https://github.com/ClickHouse/ClickHouse/pull/19713)（[Maksim Kita](https://github.com/kitaisreal)）。
* 大きな整数を扱う一部の関数がセグメンテーションフォルトを引き起こす可能性があります。Big integers は実験的な機能です。これにより [#19667](https://github.com/ClickHouse/ClickHouse/issues/19667) がクローズされます。[#19672](https://github.com/ClickHouse/ClickHouse/pull/19672)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `LowCardinality` 引数を取る `neighbor` 関数で誤った結果が返される問題を修正。 [#10333](https://github.com/ClickHouse/ClickHouse/issues/10333) を修正。 [#19617](https://github.com/ClickHouse/ClickHouse/pull/19617)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 切断後の Connection における CompressedWriteBuffer の use-after-free バグを修正しました。 [#19599](https://github.com/ClickHouse/ClickHouse/pull/19599) ([Azat Khuzhin](https://github.com/azat)).
* `DROP/DETACH TABLE table ON CLUSTER cluster SYNC` クエリがハングしてしまうことがある不具合を修正しました。 [#19568](https://github.com/ClickHouse/ClickHouse/issues/19568) を解決。 [#19572](https://github.com/ClickHouse/ClickHouse/pull/19572) ([tavplubix](https://github.com/tavplubix)).
* CREATE DICTIONARY クエリの id 式を修正。 [#19571](https://github.com/ClickHouse/ClickHouse/pull/19571) ([Maksim Kita](https://github.com/kitaisreal)).
* merge&#95;tree&#95;min&#95;rows&#95;for&#95;concurrent&#95;read/merge&#95;tree&#95;min&#95;bytes&#95;for&#95;concurrent&#95;read が 0/UINT64&#95;MAX に設定されている場合に発生する SIGSEGV を修正。 [#19528](https://github.com/ClickHouse/ClickHouse/pull/19528) ([Azat Khuzhin](https://github.com/azat)).
* 特定の細工された引数で `addMonth` 関数が呼び出された場合に、（メモリ読み取り時の）バッファオーバーフローが発生する可能性がありました。これにより [#19441](https://github.com/ClickHouse/ClickHouse/issues/19441) が修正されました。これにより [#19413](https://github.com/ClickHouse/ClickHouse/issues/19413) が修正されました。[#19472](https://github.com/ClickHouse/ClickHouse/pull/19472)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* いずれかのファイルに空のデータブロックが含まれている場合、その分散バッチを破損としてマークするようにしました。 [#19449](https://github.com/ClickHouse/ClickHouse/pull/19449) ([Azat Khuzhin](https://github.com/azat)).
* Uber H3 ライブラリにおけるバッファオーバーフローが発生する可能性のある不具合を修正しました。詳細は [https://github.com/uber/h3/issues/392](https://github.com/uber/h3/issues/392) を参照してください。これにより [#19219](https://github.com/ClickHouse/ClickHouse/issues/19219) が解決しました。 [#19383](https://github.com/ClickHouse/ClickHouse/pull/19383) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* system.parts の &#95;state カラムの問題を修正（並び順の誤りにより、このカラムを参照するクエリで LOGICAL&#95;ERROR が発生していた）。[#19346](https://github.com/ClickHouse/ClickHouse/pull/19346)（[Azat Khuzhin](https://github.com/azat)）。
* エラー `Cannot convert column now64() because it is constant but values of constants are different in source and result` を修正しました。[#7156](https://github.com/ClickHouse/ClickHouse/issues/7156) の継続にあたる変更です。[#19316](https://github.com/ClickHouse/ClickHouse/pull/19316)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `ALTER` クエリと `DROP` クエリが ReplicatedMergeTree テーブルを処理している際に同時に実行されるとハングすることがある不具合を修正。[#19237](https://github.com/ClickHouse/ClickHouse/pull/19237) ([alesapin](https://github.com/alesapin)).
* `ORC` 形式のファイルからの無限ループ読み込みが発生する問題を修正（[#10580](https://github.com/ClickHouse/ClickHouse/issues/10580) で導入されたもの）。[#19095](https://github.com/ClickHouse/ClickHouse/issues/19095) を修正。[#19134](https://github.com/ClickHouse/ClickHouse/pull/19134)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* ClickHouse が `LowCardinality(Nullable(...))` から圧縮コーデックを読み取れず、`Attempt to read after EOF` という例外をスローしていた起動時のバグを修正。[#18340](https://github.com/ClickHouse/ClickHouse/issues/18340) を解決。[#19101](https://github.com/ClickHouse/ClickHouse/pull/19101)（[alesapin](https://github.com/alesapin)）。
* `Template` または `CustomSeparated` フォーマットを使用して HTTP インターフェイス経由でデータを挿入する際に発生していた `There is no checkpoint` エラーを修正しました。[#19021](https://github.com/ClickHouse/ClickHouse/issues/19021) を解決。[#19072](https://github.com/ClickHouse/ClickHouse/pull/19072)（[tavplubix](https://github.com/tavplubix)）。
* 旧構文で作成された `MergeTree` テーブルに対する `MODIFY TTL` クエリを禁止しました。以前はクエリは成功していましたが、実際には何の効果もありませんでした。 [#19064](https://github.com/ClickHouse/ClickHouse/pull/19064) ([Anton Popov](https://github.com/CurtizJ)).
* Enum 型の引数に対して `groupUniqArray` が正しい型を返すよう修正しました。これにより [#17875](https://github.com/ClickHouse/ClickHouse/issues/17875) が解決されました。[#19019](https://github.com/ClickHouse/ClickHouse/pull/19019)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 関数 `ignore` を `LowCardinality` 型の引数とともに使用した際に発生しうる `Expected single dictionary argument for function` エラーを修正しました。 [#14275](https://github.com/ClickHouse/ClickHouse/issues/14275) を解決。 [#19016](https://github.com/ClickHouse/ClickHouse/pull/19016)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `TinyLog` エンジンのテーブルへの `LowCardinality` 列の挿入処理を修正しました。[#18629](https://github.com/ClickHouse/ClickHouse/issues/18629) を修正。[#19010](https://github.com/ClickHouse/ClickHouse/pull/19010)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `optimize_move_functions_out_of_any` を、この最適化が常に正しく動作するとは限らないため無効化しました。これにより [#18051](https://github.com/ClickHouse/ClickHouse/issues/18051) がクローズされました。また、[#18973](https://github.com/ClickHouse/ClickHouse/issues/18973) もクローズされました。[#18981](https://github.com/ClickHouse/ClickHouse/pull/18981)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* シャットダウン時にごくまれに発生するデッドロックを修正しました。 [#18977](https://github.com/ClickHouse/ClickHouse/pull/18977) ([tavplubix](https://github.com/tavplubix))。
* エスケープされたテキスト（`ALTER ... UPDATE e = CAST('foo', 'Enum8(\'foo\' = 1')` のような）を含む mutation が誤ってシリアライズされるバグを修正。[#18878](https://github.com/ClickHouse/ClickHouse/issues/18878) を修正。[#18944](https://github.com/ClickHouse/ClickHouse/pull/18944)（[alesapin](https://github.com/alesapin)）。
* ATTACH PARTITION 操作で mutation がリセットされるようになりました。 [#18804](https://github.com/ClickHouse/ClickHouse/issues/18804). [#18935](https://github.com/ClickHouse/ClickHouse/pull/18935) ([fastio](https://github.com/fastio)).
* clickhouse-local のシャットダウン時にハングする可能性がある問題を修正。これにより [#18891](https://github.com/ClickHouse/ClickHouse/issues/18891) が修正されます。 [#18893](https://github.com/ClickHouse/ClickHouse/pull/18893) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 単項関数および `Nullable` 型での *If コンビネータ* を修正。 [#18806](https://github.com/ClickHouse/ClickHouse/pull/18806) ([Azat Khuzhin](https://github.com/azat))。
* 非同期の分散 `INSERT` は、設定 `network_compression_method` がグローバルにデフォルト以外の値に設定されている場合、サーバーによって拒否されることがあります。これにより [#18741](https://github.com/ClickHouse/ClickHouse/issues/18741) が修正されています。 [#18776](https://github.com/ClickHouse/ClickHouse/pull/18776) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `Nullable(String)` から `Nullable(Decimal(P, S))` への `CAST` を試みた際に発生していた `Attempt to read after eof` エラーを修正しました。これにより、NULL 許容の文字列から Decimal を変換できない場合、`CAST` 関数は `NULL` を返すようになりました。[#7690](https://github.com/ClickHouse/ClickHouse/issues/7690) を修正。[#18718](https://github.com/ClickHouse/ClickHouse/pull/18718)（[Winter Zhang](https://github.com/zhang2014)）。
* 引数サイズが一致しない Logger を修正。 [#18717](https://github.com/ClickHouse/ClickHouse/pull/18717) ([sundyli](https://github.com/sundy-li)).
* FixedString データ型のサポートを追加。MySQL から ClickHouse へデータをレプリケートする際に、例外「Code: 50, e.displayText() = DB::Exception: Unsupported type FixedString(1)」が発生します。このパッチでバグ [#18450](https://github.com/ClickHouse/ClickHouse/issues/18450) を修正し、[#6556](https://github.com/ClickHouse/ClickHouse/issues/6556) も併せて修正します。[#18553](https://github.com/ClickHouse/ClickHouse/pull/18553)（[awesomeleo](https://github.com/awesomeleo)）。
* `RIGHT` または `FULL` 結合を含むサブクエリの後に `ORDER BY` を使用した際に発生する可能性のある `Pipeline stuck` エラーを修正しました。[#18550](https://github.com/ClickHouse/ClickHouse/pull/18550) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 対応する mutation を kill した後に `ALTER` クエリがハングする可能性があるバグを修正。thread fuzzer によって検出。[#18518](https://github.com/ClickHouse/ClickHouse/pull/18518) ([alesapin](https://github.com/alesapin)).
* マージ時の AIO による書き込みを無効化しました。これは、マージ中にプライマリキー列の極めて稀なデータ破損を引き起こす可能性があるためです。 [#18481](https://github.com/ClickHouse/ClickHouse/pull/18481) ([alesapin](https://github.com/alesapin))。
* 結果を計算できない場合には、解析段階におけるサブクエリの定数畳み込みを行わないようにしました。 [#18446](https://github.com/ClickHouse/ClickHouse/pull/18446) ([Azat Khuzhin](https://github.com/azat)).
* `Nullable(String)` 型の引数に対して `toType(...)` 関数（`toDate`、`toUInt32` など）を実行した際に発生していた `value is too short` エラーを修正しました。これらの関数は、パースエラーが発生した場合に例外をスローする代わりに `NULL` を返すようになりました。[#7673](https://github.com/ClickHouse/ClickHouse/issues/7673) を修正。[#18445](https://github.com/ClickHouse/ClickHouse/pull/18445)（[tavplubix](https://github.com/tavplubix)）。
* ワイドパーツからコンパクトパーツへのマージを制限しました。垂直マージの場合に不正な結果パーツが生成されていました。 [#18381](https://github.com/ClickHouse/ClickHouse/pull/18381) ([Anton Popov](https://github.com/CurtizJ)).
* テーブル `system.settings_profile_elements` へのデータ投入処理を修正しました。この PR は [#18231](https://github.com/ClickHouse/ClickHouse/issues/18231) を修正します。 [#18379](https://github.com/ClickHouse/ClickHouse/pull/18379)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 定数引数を取る二項関数のインデックス解析に起因して誤ったクエリ結果が返される問題を修正しました。これにより [#18364](https://github.com/ClickHouse/ClickHouse/issues/18364) が解決されました。[#18373](https://github.com/ClickHouse/ClickHouse/pull/18373)（[Amos Bird](https://github.com/amosbird)）。
* 二段階集約を使用している場合に、`Distinct` コンビネータ付きの集約関数で起こり得るクラッシュを修正しました。[#17682](https://github.com/ClickHouse/ClickHouse/issues/17682) を修正。[#18365](https://github.com/ClickHouse/ClickHouse/pull/18365)（[Anton Popov](https://github.com/CurtizJ)）。
* `table` のカラムのうち少なくとも 1 つを選択できる場合には、`SELECT count() FROM table` を実行できるようになりました。この PR は [#10639](https://github.com/ClickHouse/ClickHouse/issues/10639) を修正します。[#18233](https://github.com/ClickHouse/ClickHouse/pull/18233)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `SELECT JOIN` では、結合される各テーブルに対して `SELECT` 権限が必要になりました。この PR により [#17654](https://github.com/ClickHouse/ClickHouse/issues/17654) が修正されました。[#18232](https://github.com/ClickHouse/ClickHouse/pull/18232)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `MergeTree*` からの読み取り中に read backoff が発生した場合（ログ内のメッセージ `<Debug> MergeTreeReadPool: Will lower number of threads`）に、不完全なクエリ結果が返される可能性がある問題を修正。これは [#16423](https://github.com/ClickHouse/ClickHouse/issues/16423) で導入されたもの。[#18137](https://github.com/ClickHouse/ClickHouse/issues/18137) を修正。[#18216](https://github.com/ClickHouse/ClickHouse/pull/18216)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* クエリ `MODIFY COLUMN ... REMOVE TTL` が実際にはカラム TTL を削除していなかった不具合を修正。 [#18130](https://github.com/ClickHouse/ClickHouse/pull/18130) ([alesapin](https://github.com/alesapin)).
* 述語オプティマイザーにおける非決定的関数の扱いを修正。これにより [#17244](https://github.com/ClickHouse/ClickHouse/issues/17244) が修正されます。 [#17273](https://github.com/ClickHouse/ClickHouse/pull/17273) ([Winter Zhang](https://github.com/zhang2014)).
* `MOVE` や `REPLACE PARTITION` の後、またはまれなケースでは `DETACH` や `DROP PARTITION` の後に、存在しないパーツを待ってミューテーションがハングすることがある問題を修正しました。 [#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-2}

- タイムゾーン情報を2020eに更新。[#18531](https://github.com/ClickHouse/ClickHouse/pull/18531) ([alesapin](https://github.com/alesapin))。

### ClickHouse リリース v20.11.6.6-stable, 2020-12-24 {#clickhouse-release-v201166-stable-2020-12-24}

#### バグ修正 {#bug-fix-4}


* デュアルスタックの `IPv4/IPv6` を持つマシンにおいて、サーバーから `clickhouse-odbc-bridge` プロセスに到達できない問題を修正し、さらに、不正なクエリを使用して ODBC 辞書の更新が行われる場合やクラッシュを引き起こす場合の問題を修正しました。これにより、[#14489](https://github.com/ClickHouse/ClickHouse/issues/14489) が解決されている可能性があります。 [#18278](https://github.com/ClickHouse/ClickHouse/pull/18278) ([Denis Glazachev](https://github.com/traceon))。
* Enum 型と Int 型のキー比較を修正しました。これにより [#17989](https://github.com/ClickHouse/ClickHouse/issues/17989) が解決されます。[#18214](https://github.com/ClickHouse/ClickHouse/pull/18214)（[Amos Bird](https://github.com/amosbird)）。
* `MaterializeMySQL` データベースエンジンにおけるユニークキー変換時のクラッシュを修正しました。これにより [#18186](https://github.com/ClickHouse/ClickHouse/issues/18186) と [#16372](https://github.com/ClickHouse/ClickHouse/issues/16372) が解決されました。[#18211](https://github.com/ClickHouse/ClickHouse/pull/18211)（[Winter Zhang](https://github.com/zhang2014)）。
* S3 URL のパース時に発生していた `std::out_of_range: basic_string` を修正しました。 [#18059](https://github.com/ClickHouse/ClickHouse/pull/18059) ([Vladimir Chebotarev](https://github.com/excitoon)).
* MaterializeMySQL が MySQL のプレフィックスインデックスの変換をサポートしていなかったことが原因で、一部のテーブルが MySQL から ClickHouse へ同期されない問題を修正しました。これにより [#15187](https://github.com/ClickHouse/ClickHouse/issues/15187)、[#17912](https://github.com/ClickHouse/ClickHouse/issues/17912)、[#17944](https://github.com/ClickHouse/ClickHouse/pull/17944) が修正されます（[Winter Zhang](https://github.com/zhang2014)）。
* クエリに `ARRAY JOIN` が含まれている場合に、クエリ最適化によって誤った結果が返される問題を修正しました。[#17887](https://github.com/ClickHouse/ClickHouse/pull/17887) ([sundyli](https://github.com/sundy-li)).
* `topK` 集約関数でセグメンテーションフォルトが発生する可能性のあった問題を修正しました。これにより [#17404](https://github.com/ClickHouse/ClickHouse/issues/17404) がクローズされました。 [#17845](https://github.com/ClickHouse/ClickHouse/pull/17845) ([Maksim Kita](https://github.com/kitaisreal))。
* `in_memory_parts_enable_wal` が無効な場合、WAL からパーツを復元しないようにしました。 [#17802](https://github.com/ClickHouse/ClickHouse/pull/17802) ([detailyang](https://github.com/detailyang)).
* ClickHouse が MySQL サーバーへ再接続できなくなる問題を修正しました。[#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz)).
* パーティション述語を含むクエリに対する `optimize_trivial_count_query` の動作の不整合を修正しました。 [#17644](https://github.com/ClickHouse/ClickHouse/pull/17644) ([Azat Khuzhin](https://github.com/azat)).
* サーバーがデーモンモードで動作している際に `system.stack_trace` テーブルが空になる問題を修正しました。 [#17630](https://github.com/ClickHouse/ClickHouse/pull/17630) ([Amos Bird](https://github.com/amosbird)).
* MergeTree テーブルで、バックグラウンド処理中に `fmt::v7::format_error` 例外がログ出力される可能性があった挙動を修正しました。これにより [#17613](https://github.com/ClickHouse/ClickHouse/issues/17613) が修正されました。 [#17615](https://github.com/ClickHouse/ClickHouse/pull/17615) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `clickhouse-client` を対話モードで複数行クエリとともに使用した際に、1 行コメントが誤ってクエリの末尾まで延長されてしまう挙動を修正しました。これにより [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654) の問題が修正されました。 [#17565](https://github.com/ClickHouse/ClickHouse/pull/17565) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* ごくまれなケースにおいてサーバーが接続の受け付けを停止してしまう問題を修正しました。 [#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 別のレプリカ上で対応するミューテーションが強制終了された際に `ALTER` クエリがハングする問題を修正しました。これにより [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953) が修正されました。 [#17499](https://github.com/ClickHouse/ClickHouse/pull/17499)（[alesapin](https://github.com/alesapin)）。
* ClickHouse でマークキャッシュサイズが過小に見積もられていたバグを修正しました。これは、マークを含む非常に小さなファイルが多数存在する場合に発生する可能性がありました。 [#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin)).
* `optimize_redundant_functions_in_order_by` 設定を有効にした状態での `ORDER BY` の挙動を修正しました。 [#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* `DISTINCT` で誤った最適化により発生する可能性があった重複を修正しました。これにより [#17294](https://github.com/ClickHouse/ClickHouse/issues/17294) が修正されました。この修正は [#17296](https://github.com/ClickHouse/ClickHouse/pull/17296)（[li chengxiang](https://github.com/chengxianglibra)）および [#17439](https://github.com/ClickHouse/ClickHouse/pull/17439)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）で行われました。
* `LowCardinality` 型を含む `JOIN` テーブルからの読み取り時にクラッシュが発生する問題を修正しました。これにより [#17228](https://github.com/ClickHouse/ClickHouse/issues/17228) が修正されました。 [#17397](https://github.com/ClickHouse/ClickHouse/pull/17397) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* サブクエリ内に `const` 列が含まれる場合の set インデックスの無効化処理を修正しました。これにより [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246) が修正されました。[#17249](https://github.com/ClickHouse/ClickHouse/pull/17249)（[Amos Bird](https://github.com/amosbird)）。
* インデックス比較における型が異なる場合に、誤ったインデックス解析が行われる可能性のあった問題を修正しました。これにより [#17122](https://github.com/ClickHouse/ClickHouse/issues/17122) が修正されました。[#17145](https://github.com/ClickHouse/ClickHouse/pull/17145)（[Amos Bird](https://github.com/amosbird)）。
* クラッシュの原因となっていた `ColumnConst` の比較を修正しました。これにより [#17088](https://github.com/ClickHouse/ClickHouse/issues/17088) が解決されます。 [#17135](https://github.com/ClickHouse/ClickHouse/pull/17135) ([Amos Bird](https://github.com/amosbird)).
* リーダーではない `ReplicatedMergeTreeTables` に対する `ON CLUSTER` クエリが無期限にハングしたままになる可能性があったバグを修正しました。 [#17089](https://github.com/ClickHouse/ClickHouse/pull/17089) ([alesapin](https://github.com/alesapin)).
* `fuzzBits` 関数で fuzzer によって検出されたバグを修正しました。これにより [#16980](https://github.com/ClickHouse/ClickHouse/issues/16980) が解決されます。 [#17051](https://github.com/ClickHouse/ClickHouse/pull/17051) ([hexiaoting](https://github.com/hexiaoting))。
* `LIMIT` を含むクエリなど、実行中にキャンセルされる可能性のあるリモートクエリに対して、不要なネットワークエラーを回避します。 [#17006](https://github.com/ClickHouse/ClickHouse/pull/17006) ([Azat Khuzhin](https://github.com/azat)).
* double 型からのキャスト時に 128 ビットおよび 256 ビット整数で誤った結果が返される問題を修正しました。 [#16986](https://github.com/ClickHouse/ClickHouse/pull/16986) ([Mike](https://github.com/myrrc)).
* エラー時に `format_avro_schema_registry_url` の IP アドレスを再解決するようになりました。 [#16985](https://github.com/ClickHouse/ClickHouse/pull/16985) ([filimonov](https://github.com/filimonov)).
* `SELECT` が変更中のカラムに対する `WHERE` 句を含み、`ALTER` 文がまだ完了していない状態で `ALTER TABLE ... MODIFY COLUMN ... NewType` を実行した場合にサーバーがクラッシュする可能性があった問題を修正しました。 [#16968](https://github.com/ClickHouse/ClickHouse/pull/16968) ([Amos Bird](https://github.com/amosbird)).
* `clickhouse-git-import` において blame 情報が正しく算出されていませんでした。[#16959](https://github.com/ClickHouse/ClickHouse/pull/16959) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 単調関数を用いた `ORDER BY` の最適化を修正。[#16107](https://github.com/ClickHouse/ClickHouse/issues/16107) を修正。[#16956](https://github.com/ClickHouse/ClickHouse/pull/16956)（[Anton Popov](https://github.com/CurtizJ)）。
* `optimize_aggregators_of_group_by_keys` 設定が有効な場合の GROUP BY と JOIN の最適化を修正しました。これにより、[#12604](https://github.com/ClickHouse/ClickHouse/issues/12604) が解消されました。 [#16951](https://github.com/ClickHouse/ClickHouse/pull/16951) ([Anton Popov](https://github.com/CurtizJ))。
* インストールスクリプトは、常に設定フォルダー内にサブディレクトリを作成するようになりました。これはカスタム設定を使用した Docker ビルドの場合にのみ関連します。 [#16936](https://github.com/ClickHouse/ClickHouse/pull/16936) ([filimonov](https://github.com/filimonov))。
* `ORDER BY` を含むクエリで起こり得る `Illegal type of argument` エラーを修正しました。これにより [#16580](https://github.com/ClickHouse/ClickHouse/issues/16580) の問題が解決されました。 [#16928](https://github.com/ClickHouse/ClickHouse/pull/16928) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* WriteBufferFromS3 にデータが一切書き込まれなかった場合、マルチパートアップロードを中止するようにしました。 [#16840](https://github.com/ClickHouse/ClickHouse/pull/16840) ([Pavel Kovalenko](https://github.com/Jokser)).
* 引数なしで `any` を使用した際にクラッシュする問題を修正しました。これにより [#16803](https://github.com/ClickHouse/ClickHouse/issues/16803) が解決されました。[#16826](https://github.com/ClickHouse/ClickHouse/pull/16826)（[Amos Bird](https://github.com/amosbird)）。
* MySQL プロトコル経由の `INSERT` クエリに対して、影響を受けた行数ではなく常に 0 を返していた ClickHouse の動作を修正しました。これにより [#16605](https://github.com/ClickHouse/ClickHouse/issues/16605) が解決されます。 [#16715](https://github.com/ClickHouse/ClickHouse/pull/16715) ([Winter Zhang](https://github.com/zhang2014)).
* TDigest が制御不能に増大する問題を修正しました。 [#16680](https://github.com/ClickHouse/ClickHouse/pull/16680) ([hrissan](https://github.com/hrissan)).
* 集約関数でサフィックス `if` を使用した際に発生するリモートクエリの失敗を修正しました。これにより、[#16574](https://github.com/ClickHouse/ClickHouse/issues/16574)、[#16231](https://github.com/ClickHouse/ClickHouse/issues/16231)、[#16610](https://github.com/ClickHouse/ClickHouse/pull/16610) が解決されました（[Winter Zhang](https://github.com/zhang2014)）。
* `select_sequential_consistency` によって最適化された単純な COUNT クエリと system.tables において発生していた一貫性のない動作を修正しました。 [#16309](https://github.com/ClickHouse/ClickHouse/pull/16309) ([Hao Chen](https://github.com/haoch))。
* 存在しないカラムを `ColumnTransformer` で置換しようとした場合にエラーをスローするようにしました。 [#16183](https://github.com/ClickHouse/ClickHouse/pull/16183) ([hexiaoting](https://github.com/hexiaoting)).

### ClickHouseリリース v20.11.3.3-stable, 2020-11-13 {#clickhouse-release-v201133-stable-2020-11-13}

#### バグ修正 {#bug-fix-5}

- クエリプロファイラが有効で、一部の関数に対して非同期アンワインドテーブルが破損している(と思われる)glibcバージョンを持つOSにClickHouseがインストールされている場合に発生する稀なサイレントクラッシュを修正しました。これにより[#15301](https://github.com/ClickHouse/ClickHouse/issues/15301)が修正されます。これにより[#13098](https://github.com/ClickHouse/ClickHouse/issues/13098)が修正されます。[#16846](https://github.com/ClickHouse/ClickHouse/pull/16846) ([alexey-milovidov](https://github.com/alexey-milovidov))。

### ClickHouseリリース v20.11.2.1, 2020-11-11 {#clickhouse-release-v201121-2020-11-11}

#### 後方互換性のない変更 {#backward-incompatible-change-1}

- `distributed_ddl`設定セクションで`profile`が指定されている場合、このプロファイルがサーバー起動時に`default`プロファイルの設定を上書きする可能性がありました。これは修正され、分散DDLクエリの設定がグローバルサーバー設定に影響を与えないようになりました。[#16635](https://github.com/ClickHouse/ClickHouse/pull/16635) ([tavplubix](https://github.com/tavplubix))。
- キー(ソートキー、プライマリキー、パーティションキーなど)での比較不可能なデータ型(`AggregateFunction`など)の使用を制限しました。[#16601](https://github.com/ClickHouse/ClickHouse/pull/16601) ([alesapin](https://github.com/alesapin))。
- `ANALYZE`および`AST`クエリを削除し、`enable_debug_queries`設定を廃止しました。これらは現在、フル機能の`EXPLAIN`クエリの一部となっています。[#16536](https://github.com/ClickHouse/ClickHouse/pull/16536) ([Ivan](https://github.com/abyss7))。
- 集約関数`boundingRatio`、`rankCorr`、`retention`、`timeSeriesGroupSum`、`timeSeriesGroupRateSum`、`windowFunnel`が誤って大文字小文字を区別しないようになっていました。現在、これらの名前は設計通り大文字小文字を区別するようになりました。SQL標準で指定されている関数、他のDBMSとの互換性のために作成された関数、またはそれらに類似する関数のみが大文字小文字を区別しないようにすべきです。[#16407](https://github.com/ClickHouse/ClickHouse/pull/16407) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `rankCorr`関数がデータ不足時にnanを返すようにしました[#16124](https://github.com/ClickHouse/ClickHouse/issues/16124)。[#16135](https://github.com/ClickHouse/ClickHouse/pull/16135) ([hexiaoting](https://github.com/hexiaoting))。
- 20.5より古いバージョンからアップグレードする際、ローリングアップデートを実行し、クラスタに20.5以上のバージョンと20.5未満のバージョンの両方が含まれている場合、古いバージョンのClickHouseノードが再起動され、新しいバージョンの存在下で古いバージョンが起動すると、`Part ... intersects previous part`エラーが発生する可能性があります。このエラーを防ぐには、まずすべてのクラスタノードに新しいclickhouse-serverパッケージをインストールしてから再起動を実行してください(これにより、clickhouse-serverが再起動されると新しいバージョンで起動します)。

#### 新機能 {#new-feature-1}


* ローカルに存在しないユーザー向けのユーザーディレクトリとして LDAP をサポートしました。 [#12736](https://github.com/ClickHouse/ClickHouse/pull/12736) ([Denis Glazachev](https://github.com/traceon)).
* 現在実行中のバックグラウンドのフェッチ処理を表示する `system.replicated_fetches` テーブルを追加。 [#16428](https://github.com/ClickHouse/ClickHouse/pull/16428) ([alesapin](https://github.com/alesapin)).
* 設定 `date_time_output_format` を追加しました。[#15845](https://github.com/ClickHouse/ClickHouse/pull/15845) ([Maksim Kita](https://github.com/kitaisreal))。
* ClickHouse に簡易的な Web UI を追加しました。 [#16158](https://github.com/ClickHouse/ClickHouse/pull/16158) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 長さ区切りなしで単一の Protobuf メッセージを一度に読み書きできるようにしました。 [#15199](https://github.com/ClickHouse/ClickHouse/pull/15199) ([filimonov](https://github.com/filimonov)).
* 初期の OpenTelemetry サポートを追加しました。ClickHouse は現在、Native および HTTP プロトコル経由で送信される OpenTelemetry の traceparent ヘッダーを受け付け、一部のケースでそれらを下流に渡します。実行されたクエリのトレーススパンは `system.opentelemetry_span_log` テーブルに保存されます。[#14195](https://github.com/ClickHouse/ClickHouse/pull/14195)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* `CREATE TABLE` クエリのカラムリスト内で PRIMARY KEY を指定できるようにしました。これは他の SQL 方言との互換性のために必要です。 [#15823](https://github.com/ClickHouse/ClickHouse/pull/15823) ([Maksim Kita](https://github.com/kitaisreal))。
* `ORDER BY` を含む `SELECT` クエリで `OFFSET offset_row_count {ROW | ROWS} FETCH {FIRST | NEXT} fetch_row_count {ROW | ROWS} {ONLY | WITH TIES}` を実装。これは `LIMIT` を指定するための SQL 標準の構文です。 [#15855](https://github.com/ClickHouse/ClickHouse/pull/15855) ([hexiaoting](https://github.com/hexiaoting))。
* `errorCodeToName` 関数 - エラーの名前（シンボリック名）を返します（`query_log` などの解析に役立ちます）。`system.errors` テーブル - エラーが何回発生したかを表示します（`system_events_show_zero_values` の設定に従います）。 [#16438](https://github.com/ClickHouse/ClickHouse/pull/16438) ([Azat Khuzhin](https://github.com/azat)).
* 名前付きタプルを展開して SELECT 句に新しいカラムを導入できる特殊な関数 `untuple` を追加しました。 [#16242](https://github.com/ClickHouse/ClickHouse/pull/16242) ([Nikolai Kochetov](https://github.com/KochetovNicolai), [Amos Bird](https://github.com/amosbird)).
* クエリパラメータとして識別子を指定できるようになりました。また、これらのパラメータをテーブルオブジェクトやカラムとして使用できます。 [#16594](https://github.com/ClickHouse/ClickHouse/pull/16594) ([Amos Bird](https://github.com/amosbird))。
* MergeTree BloomFilter インデックスに、big integer（UInt256、Int128、Int256）および UUID データ型のサポートを追加しました。big integer は実験的機能です。 [#16642](https://github.com/ClickHouse/ClickHouse/pull/16642) ([Maksim Kita](https://github.com/kitaisreal)).
* `farmFingerprint64` 関数（暗号学的ではない文字列ハッシュ）を追加。 [#16570](https://github.com/ClickHouse/ClickHouse/pull/16570) ([Jacob Hayes](https://github.com/JacobHayes))。
* `log_queries_min_query_duration_ms` を追加しました。この設定値よりも実行時間が長いクエリのみが `query_log` / `query_thread_log` に出力されます（MySQL の `slow_query_log` のようなもの）。 [#16529](https://github.com/ClickHouse/ClickHouse/pull/16529) ([Azat Khuzhin](https://github.com/azat)).
* `Alpine` ベースの Docker イメージを作成できるようになりました。事前コンパイル済みバイナリと Ubuntu 20.04 由来の glibc コンポーネントを使用します。 [#16479](https://github.com/ClickHouse/ClickHouse/pull/16479) ([filimonov](https://github.com/filimonov)).
* キャスト関数 `toUUIDOrNull` と `toUUIDOrZero` を追加。[#16337](https://github.com/ClickHouse/ClickHouse/pull/16337)（[Maksim Kita](https://github.com/kitaisreal)）。
* `max_concurrent_queries_for_all_users` 設定を追加しました。利用例については [#6636](https://github.com/ClickHouse/ClickHouse/issues/6636) を参照してください。 [#16154](https://github.com/ClickHouse/ClickHouse/pull/16154) ([nvartolomei](https://github.com/nvartolomei))。
* clickhouse-client に新しいオプション `print_query_id` を追加しました。これにより、クライアントが生成した現在のクエリ ID を使用して任意の文字列を生成できます。また、デフォルトで clickhouse-client がクエリ ID を出力するようにしました。 [#15809](https://github.com/ClickHouse/ClickHouse/pull/15809) ([Amos Bird](https://github.com/amosbird)).
* `tid` 関数と `logTrace` 関数を追加しました。これにより、[#9434](https://github.com/ClickHouse/ClickHouse/issues/9434) がクローズされました。 [#15803](https://github.com/ClickHouse/ClickHouse/pull/15803) ([flynn](https://github.com/ucasFL)).
* 時間差を人が読みやすい形式の文字列に整形する関数 `formatReadableTimeDelta` を追加 ... [#15497](https://github.com/ClickHouse/ClickHouse/pull/15497) ([Filipe Caixeta](https://github.com/filipecaixeta)).
* マルチディスク構成におけるボリューム用に `disable_merges` オプションを追加しました。 [#13956](https://github.com/ClickHouse/ClickHouse/pull/13956) ([Vladimir Chebotarev](https://github.com/excitoon)).

#### 実験的機能 {#experimental-feature-1}

- 新しい関数 `encrypt`、`aes_encrypt_mysql`、`decrypt`、`aes_decrypt_mysql`。これらの関数は動作が遅いため、実験的機能と位置付けています。[#11844](https://github.com/ClickHouse/ClickHouse/pull/11844) ([Vasily Nemkov](https://github.com/Enmk))。

#### バグ修正 {#bug-fix-6}


* `system.distribution_queue` の data&#95;path 内のパスワードをマスクするようにしました。 [#16727](https://github.com/ClickHouse/ClickHouse/pull/16727) ([Azat Khuzhin](https://github.com/azat)).
* `transform_null_in` 設定を有効にしている場合の、複数列およびタプルに対する `IN` 演算子の動作を修正。 [#15310](https://github.com/ClickHouse/ClickHouse/issues/15310) を修正。 [#16722](https://github.com/ClickHouse/ClickHouse/pull/16722)（[Anton Popov](https://github.com/CurtizJ)）。
* クエリ対象のテーブルにサンプリングがない場合、設定 `max_parallel_replicas` が正しく動作していませんでした。これにより [#5733](https://github.com/ClickHouse/ClickHouse/issues/5733) が修正されます。 [#16675](https://github.com/ClickHouse/ClickHouse/pull/16675) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `max_threads &gt; 0` で、かつ `ORDER BY` 句に式が含まれている場合の `optimize_read_in_order` / `optimize_aggregation_in_order` を修正しました。 [#16637](https://github.com/ClickHouse/ClickHouse/pull/16637) ([Azat Khuzhin](https://github.com/azat)).
* `DEFAULT` 式の計算において、（実際に発生する可能性は極めて低いものの）名前の衝突が起こりうる問題がありました。これにより [#9359](https://github.com/ClickHouse/ClickHouse/issues/9359) が修正されました。 [#16612](https://github.com/ClickHouse/ClickHouse/pull/16612) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `query_thread_log.query_duration_ms` の単位を修正しました。 [#16563](https://github.com/ClickHouse/ClickHouse/pull/16563) ([Azat Khuzhin](https://github.com/azat)).
* MySQL Master -&gt; MySQL Slave -&gt; ClickHouse の MaterializeMySQL エンジンを使用する際に発生するバグを修正しました。`MaterializeMySQL` は実験的な機能です。[#16504](https://github.com/ClickHouse/ClickHouse/pull/16504) ([TCeason](https://github.com/TCeason))。
* `Decimal` 型に対する `round` 関数の特定の引数指定により、整数除算でゼロ除算が発生していました。この問題を修正します。[#13338](https://github.com/ClickHouse/ClickHouse/issues/13338)。[#16451](https://github.com/ClickHouse/ClickHouse/pull/16451)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* Distributed テーブルに対する DROP TABLE の動作を修正（INSERT との競合状態を解消）。[#16409](https://github.com/ClickHouse/ClickHouse/pull/16409)（[Azat Khuzhin](https://github.com/azat)）。
* レプリケーションキュー内の非常に大きなエントリの処理を修正しました。非常に大きなエントリは、テーブル構造が極めて大きい場合（1 MB 近い場合）に `ALTER` クエリで発生することがあります。これにより [#16307](https://github.com/ClickHouse/ClickHouse/issues/16307) が修正されます。[#16332](https://github.com/ClickHouse/ClickHouse/pull/16332)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* フィルタリング用の `set` が作成されなかったために、返されるデータの一部が削除されてしまう可能性があった一貫性のない挙動を修正しました。 [#16308](https://github.com/ClickHouse/ClickHouse/pull/16308) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* sharding&#95;key 内の dictGet の問題を修正（および関数コンテキストが永続的に保存される同様の箇所も修正）。 [#16205](https://github.com/ClickHouse/ClickHouse/pull/16205) ([Azat Khuzhin](https://github.com/azat)).
* `clickhouse-local` で `OPTIMIZE` コマンドを実行しようとした際にスローされる例外を修正。[#16076](https://github.com/ClickHouse/ClickHouse/issues/16076) の問題を修正。[#16192](https://github.com/ClickHouse/ClickHouse/pull/16192)（[filimonov](https://github.com/filimonov)）。
* [#15780](https://github.com/ClickHouse/ClickHouse/issues/15780) のリグレッションを修正。例えば `indexOf([1, 2, 3], toLowCardinality(1))` は現在は禁止されていますが、本来は許可されるべきです。[#16038](https://github.com/ClickHouse/ClickHouse/pull/16038)（[Mike](https://github.com/myrrc)）。
* MySQL データベースに関するバグを修正。データベースエンジンとして使用されている MySQL サーバーがダウンしている場合、一部のクエリは本来不要であるにもかかわらず、停止しているサーバーからテーブルを取得しようとして例外をスローしていました。例えば、クエリ `SELECT ... FROM system.parts` は MergeTree テーブルのみに対して動作すべきであり、MySQL データベースには一切アクセスすべきではありません。 [#16032](https://github.com/ClickHouse/ClickHouse/pull/16032) ([Kruglov Pavel](https://github.com/Avogar)).
* `ALTER MODIFY COLUMN ... DEFAULT ...` で指定されたデフォルト値が列の型と互換性がない場合に、例外がスローされるようになりました。[#15854](https://github.com/ClickHouse/ClickHouse/issues/15854) を修正。[#15858](https://github.com/ClickHouse/ClickHouse/pull/15858)（[alesapin](https://github.com/alesapin)）。
* IPv4CIDRToRange/IPv6CIDRToRange 関数が const IP 列の値を受け付けるように修正しました。 [#15856](https://github.com/ClickHouse/ClickHouse/pull/15856) ([vladimir-golovchenko](https://github.com/vladimir-golovchenko))。

#### 改善 {#improvement-2}


* `INTERVAL '1 hour'` を `INTERVAL 1 HOUR` と同等に扱うようにし、Postgres などとの互換性を確保しました。これにより [#15637](https://github.com/ClickHouse/ClickHouse/issues/15637) が修正されました。 [#15978](https://github.com/ClickHouse/ClickHouse/pull/15978) ([flynn](https://github.com/ucasFL))。
* CSV、TSV、JSON の入力フォーマットで、数値 ID による enum 値のパースを有効化しました。 [#15685](https://github.com/ClickHouse/ClickHouse/pull/15685) ([vivarum](https://github.com/vivarum))。
* JBOD アーキテクチャおよび `MergeTree` ストレージ向けの読み取りタスクのスケジューリングを改善。新しい設定項目 `read_backoff_min_concurrency` は、読み取りスレッド数の下限として機能します。[#16423](https://github.com/ClickHouse/ClickHouse/pull/16423) ([Amos Bird](https://github.com/amosbird)).
* `Avro` フォーマットにおける `LowCardinality` の不足していたサポートを追加。 [#16521](https://github.com/ClickHouse/ClickHouse/pull/16521) ([Mike](https://github.com/myrrc)).
* `S3` を nginx サーバーをプロキシとして利用する際のワークアラウンド。現在の nginx は `http://domain.com?delete` のようなパスが空の URL を受け付けないが、素の aws-sdk-cpp はこの種の URL を生成する。このコミットではパッチ適用済みの aws-sdk-cpp バージョンを使用し、このような場合にパスとして「/」を含む URL（`http://domain.com/?delete` のようなもの）を生成するようにしている。 [#16814](https://github.com/ClickHouse/ClickHouse/pull/16814) ([ianton-ru](https://github.com/ianton-ru)).
* 入力データのパースエラーに対する診断情報を改善しました。`Cannot read all data` エラーで行番号を表示するようにしました。[#16644](https://github.com/ClickHouse/ClickHouse/pull/16644) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `minMap` と `maxMap` の動作をより望ましいものにしました。結果からゼロ値をスキップしないようにしました。[#16087](https://github.com/ClickHouse/ClickHouse/issues/16087) を修正しました。[#16631](https://github.com/ClickHouse/ClickHouse/pull/16631)（[Ildus Kurbangaliev](https://github.com/ildus)）。
* ZooKeeper 設定のランタイム更新を改善しました。 [#16630](https://github.com/ClickHouse/ClickHouse/pull/16630) ([sundyli](https://github.com/sundy-li)).
* `SETTINGS` 句はできるだけ早い段階で適用するようにしました。これにより、クエリ内でより多くの設定を変更できるようになりました。この変更により [#3178](https://github.com/ClickHouse/ClickHouse/issues/3178) がクローズされました。[#16619](https://github.com/ClickHouse/ClickHouse/pull/16619)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `event_time_microseconds` フィールドは、UInt64 ではなく Decimal64 に保存されるようになりました。 [#16617](https://github.com/ClickHouse/ClickHouse/pull/16617) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* `APPLY` カラムトランスフォーマーでパラメータ化された関数を使用できるようになりました。 [#16589](https://github.com/ClickHouse/ClickHouse/pull/16589) ([Amos Bird](https://github.com/amosbird))。
* `Atomic` データベースにおいて、削除済みテーブルのデータをクリーンアップするバックグラウンドタスクのスケジューリングを改善しました。テーブルに実際にはデータディレクトリが存在しない場合、`Atomic` データベースはテーブルのデータディレクトリへの壊れたシンボリックリンクを作成しなくなりました。 [#16584](https://github.com/ClickHouse/ClickHouse/pull/16584) ([tavplubix](https://github.com/tavplubix)).
* `WITH` 句（CTE）内のサブクエリは、その名前を使って同じ `WITH` 句内の前のサブクエリを参照できるようになりました。 [#16575](https://github.com/ClickHouse/ClickHouse/pull/16575) ([Amos Bird](https://github.com/amosbird)).
* `system.query_thread_log` に current&#95;database を追加しました。 [#16558](https://github.com/ClickHouse/ClickHouse/pull/16558) ([Azat Khuzhin](https://github.com/azat)).
* すでにコミット済み、または現在のインスタンスでは古くなっているパーツを `detached` ディレクトリに取得できるようにします。これは、別のクラスターからテーブルを移行し、N 対 1 のシャードマッピングを行う場合に有用です。また、現在の `fetchPartition` 実装との一貫性も保たれます。 [#16538](https://github.com/ClickHouse/ClickHouse/pull/16538) ([Amos Bird](https://github.com/amosbird))。
* `RabbitMQ` 向けに複数の改善を行いました。[#16263](https://github.com/ClickHouse/ClickHouse/issues/16263) に関するバグを修正し、イベントループの存続期間を最小化しました。さらに、より効率的なキュー設定を追加しました。[#16426](https://github.com/ClickHouse/ClickHouse/pull/16426)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `quantileDeterministic` 関数のデバッグ用アサーションを修正しました。以前のバージョンでは、ネットワーク経由で転送されるデータ量が最大で 2 倍になる可能性がありましたが、不具合自体は存在しませんでした。この修正は [#15683](https://github.com/ClickHouse/ClickHouse/issues/15683) を解決します。 [#16410](https://github.com/ClickHouse/ClickHouse/pull/16410)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `TablesToDropQueueSize` メトリクスを追加しました。これは、バックグラウンドでデータ削除が行われるのを待っている削除済みテーブルの数に等しい値です。 [#16364](https://github.com/ClickHouse/ClickHouse/pull/16364) ([tavplubix](https://github.com/tavplubix))。
* クライアントが接続を切断した場合の診断が改善されました。以前のバージョンでは、`Attempt to read after EOF` および `Broken pipe` という例外がサーバー側でログに記録されていました。新しいバージョンでは、情報メッセージ `Client has dropped the connection, cancel the query.` が出力されます。 [#16329](https://github.com/ClickHouse/ClickHouse/pull/16329) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Set/Join テーブルエンジンに `system.tables` の total&#95;rows/total&#95;bytes のサポートを追加。 [#16306](https://github.com/ClickHouse/ClickHouse/pull/16306) ([Azat Khuzhin](https://github.com/azat)).
* MergeTree テーブルエンジンファミリーのテーブルに対して、`ORDER BY` なしで `PRIMARY KEY` を指定できるようになりました。 [#15591](https://github.com/ClickHouse/ClickHouse/issues/15591) をクローズしました。 [#16284](https://github.com/ClickHouse/ClickHouse/pull/16284) ([alesapin](https://github.com/alesapin))。
* システムに `tmp` フォルダが存在しない場合（`chroot` 環境や設定ミスなど）、`clickhouse-local` はカレントディレクトリ内に一時的なサブフォルダを作成します。 [#16280](https://github.com/ClickHouse/ClickHouse/pull/16280) ([filimonov](https://github.com/filimonov))。
* ネストされたデータ型（named tuple など）をサブタイプとして扱えるよう対応を追加。[#15587](https://github.com/ClickHouse/ClickHouse/issues/15587) を修正。[#16262](https://github.com/ClickHouse/ClickHouse/pull/16262)（[Ivan](https://github.com/abyss7)）。
* `DROP DATABASE` に対する `database_atomic_wait_for_drop_and_detach_synchronously` / `NO DELAY` / `SYNC` のサポート。 [#16127](https://github.com/ClickHouse/ClickHouse/pull/16127) ([Azat Khuzhin](https://github.com/azat))。
* `allow_nondeterministic_optimize_skip_unused_shards` を追加（シャーディングキーで `rand()` や `dictGet()` といった非決定的関数を許可するため）。[#16105](https://github.com/ClickHouse/ClickHouse/pull/16105)（[Azat Khuzhin](https://github.com/azat)）。
* HTTP 経由のクエリに対する `memory_profiler_step` / `max_untracked_memory` を修正（テストを含む）。XML 設定ファイルでこの値をグローバルに調整しても効果がない問題を修正。これらの設定はそもそも適用されず、デフォルト値（4MB）のみが[使用されていた](https://github.com/ClickHouse/ClickHouse/blob/17731245336d8c84f75e4c0894c5797ed7732190/src/Common/ThreadStatus.h#L104)ため。HTTP クエリの最上位の ThreadStatus に対する `query_id` を修正（`query_id` の読み取り後に QueryScope を初期化することで実現）。[#16101](https://github.com/ClickHouse/ClickHouse/pull/16101)（[Azat Khuzhin](https://github.com/azat)）。
* クラスタ設定における `<internal_replication>` の設定値に関係なく、`ALTER ... ON CLUSTER` クエリを実行できるようになりました。[#16075](https://github.com/ClickHouse/ClickHouse/pull/16075) ([alesapin](https://github.com/alesapin))。
* `clickhouse-client` がサジェストを読み込む際に、終了時にまれに異常終了する問題を修正しました。これにより [#16035](https://github.com/ClickHouse/ClickHouse/issues/16035) が修正されました。 [#16047](https://github.com/ClickHouse/ClickHouse/pull/16047) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 複合キーを使用する `Redis` 辞書に `cache` レイアウトのサポートを追加。 [#15985](https://github.com/ClickHouse/ClickHouse/pull/15985) ([Anton Popov](https://github.com/CurtizJ)).
* 誤った設定（`connections_with_failover_max_tries` が 0 に設定されている場合）の際に、クエリがハング（無限ループ）する問題を修正しました。 [#15876](https://github.com/ClickHouse/ClickHouse/pull/15876) ([Azat Khuzhin](https://github.com/azat)).
* 一部のログメッセージのレベルを information から debug に変更し、クエリごとに information メッセージが出力されないようにしました。これにより [#5293](https://github.com/ClickHouse/ClickHouse/issues/5293) がクローズされます。 [#15816](https://github.com/ClickHouse/ClickHouse/pull/15816)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 潜在的に誤解を招く結果を避けるために、`MemoryTrackingInBackground*` メトリクスを削除します。これにより [#15684](https://github.com/ClickHouse/ClickHouse/issues/15684) が修正されます。[#15813](https://github.com/ClickHouse/ClickHouse/pull/15813)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `zookeeper-dump-tree` ツールに再接続処理を追加。 [#15711](https://github.com/ClickHouse/ClickHouse/pull/15711) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `CREATE TABLE table AS table_function(...)` クエリで列リストを明示的に指定できるようにしました。これにより、[#9249](https://github.com/ClickHouse/ClickHouse/issues/9249) および [#14214](https://github.com/ClickHouse/ClickHouse/issues/14214) の問題が修正されました。 [#14295](https://github.com/ClickHouse/ClickHouse/pull/14295) ([tavplubix](https://github.com/tavplubix)).

#### パフォーマンス改善 {#performance-improvement-1}

- SELECT FINALでパーティション間のパーツをマージしないようにしました。[#15938](https://github.com/ClickHouse/ClickHouse/pull/15938) ([Kruglov Pavel](https://github.com/Avogar)).
- `-OrNull`および`-OrDefault`集約関数のパフォーマンスを改善しました。[#16661](https://github.com/ClickHouse/ClickHouse/pull/16661) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- `quantileMerge`のパフォーマンスを改善しました。以前のバージョンでは非常に低速でした。これにより[#1463](https://github.com/ClickHouse/ClickHouse/issues/1463)が解決されます。[#16643](https://github.com/ClickHouse/ClickHouse/pull/16643) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- 論理関数のパフォーマンスをわずかに改善しました。[#16347](https://github.com/ClickHouse/ClickHouse/pull/16347) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- MergeTreeテーブルエンジンにおけるマージ割り当てのパフォーマンスを改善しました。ユーザーには影響ありません。[#16191](https://github.com/ClickHouse/ClickHouse/pull/16191) ([alesapin](https://github.com/alesapin)).
- ハッシュテーブルを事前割り当てすることで、hashed/sparse_hashed辞書の読み込みを高速化しました。[#15454](https://github.com/ClickHouse/ClickHouse/pull/15454) ([Azat Khuzhin](https://github.com/azat)).
- 単純なカウント最適化がやや高度になりました。正確なパーティション式を含む述語も最適化できるようになりました。これにより[#11092](https://github.com/ClickHouse/ClickHouse/issues/11092)も修正されました。この問題は`max_parallel_replicas > 1`の場合に誤ったカウントを返すものでした。[#15074](https://github.com/ClickHouse/ClickHouse/pull/15074) ([Amos Bird](https://github.com/amosbird)).

#### ビルド/テスト/パッケージング改善 {#buildtestingpackaging-improvement-3}


* ステートレステスト向けのフレーク（不安定テスト）チェックを追加。マージされる前に、潜在的に不安定な機能テストを事前に検出します。 [#16238](https://github.com/ClickHouse/ClickHouse/pull/16238) ([alesapin](https://github.com/alesapin)).
* アマルガメーションではなく、`croaring` に対して適切なバージョンを使用するように変更。 [#16285](https://github.com/ClickHouse/ClickHouse/pull/16285) ([sundyli](https://github.com/sundy-li)).
* `ya.make` ビルドシステム（Arcadia）向けのビルドファイル生成を改善。 [#16700](https://github.com/ClickHouse/ClickHouse/pull/16700) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `MaterializeMySQL` データベースエンジン向けの MySQL BinLog ファイルチェックツールを追加。`MaterializeMySQL` は実験的機能です。 [#16223](https://github.com/ClickHouse/ClickHouse/pull/16223) ([Winter Zhang](https://github.com/zhang2014)).
* 実行すべきでないファイルに実行ビットが立っていないかをチェックするように変更。Windows から誤って実行可能ファイルとしてコミットしてしまうことがよくあります。 [#15843](https://github.com/ClickHouse/ClickHouse/pull/15843) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* ヘッダー内の `#pragma once` をチェック。 [#15818](https://github.com/ClickHouse/ClickHouse/pull/15818) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* libhdfs3 における不正なコードスタイル `&vector[idx]` を修正。これにより libcxx のデバッグビルドが修正されます。あわせて https://github.com/ClickHouse-Extras/libhdfs3/pull/8 も参照してください。 [#15815](https://github.com/ClickHouse/ClickHouse/pull/15815) ([Amos Bird](https://github.com/amosbird)).
* Mac OS 上のある補助的なサンプルツールのビルドを修正。なお、CI では Mac OS 上でサンプルはビルドしておらず（ClickHouse バイナリのみビルド）、そのため今後再び壊れないという保証はまったくありません。これにより [#15804](https://github.com/ClickHouse/ClickHouse/issues/15804) が修正されます。 [#15808](https://github.com/ClickHouse/ClickHouse/pull/15808) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Sys/V init スクリプトを簡素化。 [#14135](https://github.com/ClickHouse/ClickHouse/pull/14135) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 使い勝手を高めるために、`db_generator` に `boost::program_options` を追加。これにより [#15940](https://github.com/ClickHouse/ClickHouse/issues/15940) がクローズされます。 [#15973](https://github.com/ClickHouse/ClickHouse/pull/15973) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).



## ClickHouse リリース 20.10 {#clickhouse-release-2010}

### ClickHouse リリース v20.10.7.4-stable, 2020-12-24 {#clickhouse-release-v201074-stable-2020-12-24}

#### バグ修正 {#bug-fix-7}


* デュアルスタックの `IPv4/IPv6` を持つマシンにおいて、サーバーから `clickhouse-odbc-bridge` プロセスに到達できない問題を修正し、さらに、ODBC 辞書の更新が不正なクエリで実行される場合やクラッシュを引き起こす場合の問題を修正しました。これにより、おそらく [#14489](https://github.com/ClickHouse/ClickHouse/issues/14489) がクローズされます。 [#18278](https://github.com/ClickHouse/ClickHouse/pull/18278) ([Denis Glazachev](https://github.com/traceon)).
* Enum 型と Int 型のキー比較を修正。これにより [#17989](https://github.com/ClickHouse/ClickHouse/issues/17989) が解決しました。[#18214](https://github.com/ClickHouse/ClickHouse/pull/18214)（[Amos Bird](https://github.com/amosbird)）。
* `MaterializeMySQL` データベースエンジンにおけるユニークキー変換時のクラッシュを修正しました。これにより [#18186](https://github.com/ClickHouse/ClickHouse/issues/18186) および [#16372](https://github.com/ClickHouse/ClickHouse/issues/16372) が修正されました（[#18211](https://github.com/ClickHouse/ClickHouse/pull/18211)、[Winter Zhang](https://github.com/zhang2014)）。
* S3 URL の解析時に発生する `std::out_of_range: basic_string` を修正しました。 [#18059](https://github.com/ClickHouse/ClickHouse/pull/18059) ([Vladimir Chebotarev](https://github.com/excitoon)).
* MaterializeMySQL が MySQL のプレフィックスインデックスの変換をサポートしていなかったために、一部のテーブルが MySQL から ClickHouse へ同期されない問題を修正しました。これにより、[#15187](https://github.com/ClickHouse/ClickHouse/issues/15187)、[#17912](https://github.com/ClickHouse/ClickHouse/issues/17912)、[#17944](https://github.com/ClickHouse/ClickHouse/pull/17944) の問題が修正されます（[Winter Zhang](https://github.com/zhang2014)）。
* `topK` 集約関数で発生する可能性のあるセグメンテーションフォールトを修正しました。これにより [#17404](https://github.com/ClickHouse/ClickHouse/issues/17404) が解決しました。 [#17845](https://github.com/ClickHouse/ClickHouse/pull/17845) ([Maksim Kita](https://github.com/kitaisreal)).
* `in_memory_parts_enable_wal` が無効になっている場合、`WAL` からパーツを復元しないようにしました。 [#17802](https://github.com/ClickHouse/ClickHouse/pull/17802) ([detailyang](https://github.com/detailyang)).
* ClickHouse が MySQL サーバーへの再接続に失敗する問題を修正しました。 [#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz)).
* サーバーがデーモンモードで実行されている場合に `system.stack_trace` テーブルが空になる問題を修正しました。[#17630](https://github.com/ClickHouse/ClickHouse/pull/17630) ([Amos Bird](https://github.com/amosbird)).
* `clickhouse-client` を対話モードで複数行クエリとともに使用した際、1 行コメントが誤ってクエリの末尾まで適用されてしまう問題を修正しました。これにより [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654) が修正されました。 [#17565](https://github.com/ClickHouse/ClickHouse/pull/17565) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* ごくまれにサーバーが接続の受け付けを停止することがある問題を修正しました。 [#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 別のレプリカ上で対応する mutation が kill された場合に `ALTER` クエリがハングしてしまう問題を修正しました。これにより [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953) が修正されました。 [#17499](https://github.com/ClickHouse/ClickHouse/pull/17499) ([alesapin](https://github.com/alesapin))。
* ClickHouse によって mark cache のサイズが過小に見積もられていたバグを修正しました。多数の小さなファイルに marks が含まれている場合に発生する可能性があります。 [#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin))。
* `optimize_redundant_functions_in_order_by` 設定が有効な場合の `ORDER BY` の動作を修正しました。 [#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* 誤った最適化により `DISTINCT` の後に発生する可能性があった重複を修正しました。[#17294](https://github.com/ClickHouse/ClickHouse/issues/17294) を解決しました。[#17296](https://github.com/ClickHouse/ClickHouse/pull/17296)（[li chengxiang](https://github.com/chengxianglibra)）。[#17439](https://github.com/ClickHouse/ClickHouse/pull/17439)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `LowCardinality` 型を含む `JOIN` テーブルからの読み取り時に発生していたクラッシュを修正しました。これにより [#17228](https://github.com/ClickHouse/ClickHouse/issues/17228) が解決されました。[#17397](https://github.com/ClickHouse/ClickHouse/pull/17397)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* サブクエリ内に `const` カラムが存在する場合の set インデックスの無効化処理を修正しました。これにより [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246) が修正されました。[#17249](https://github.com/ClickHouse/ClickHouse/pull/17249) ([Amos Bird](https://github.com/amosbird)).
* `ColumnConst` の比較によってクラッシュが発生していた問題を修正しました。この修正により [#17088](https://github.com/ClickHouse/ClickHouse/issues/17088) が解決されました。 [#17135](https://github.com/ClickHouse/ClickHouse/pull/17135) ([Amos Bird](https://github.com/amosbird))。
* 非リーダーの `ReplicatedMergeTreeTables` において `ON CLUSTER` クエリが無期限にハングする可能性があったバグを修正しました。[#17089](https://github.com/ClickHouse/ClickHouse/pull/17089) ([alesapin](https://github.com/alesapin)).
* 関数 `fuzzBits` で fuzzer により発見されたバグを修正しました。これにより [#16980](https://github.com/ClickHouse/ClickHouse/issues/16980) が修正されました。[#17051](https://github.com/ClickHouse/ClickHouse/pull/17051)（[hexiaoting](https://github.com/hexiaoting)）。
* `LIMIT` を含むクエリなど、実行中にキャンセルされる可能性があるリモートクエリで発生する不要なネットワークエラーを回避します。 [#17006](https://github.com/ClickHouse/ClickHouse/pull/17006) ([Azat Khuzhin](https://github.com/azat)).
* double 型からのキャスト時に、128ビットおよび256ビット整数型で誤った結果が返される問題を修正しました。 [#16986](https://github.com/ClickHouse/ClickHouse/pull/16986) ([Mike](https://github.com/myrrc)).
* エラー発生時に `format_avro_schema_registry_url` の IP アドレスを再解決するようにしました。 [#16985](https://github.com/ClickHouse/ClickHouse/pull/16985) ([filimonov](https://github.com/filimonov)).
* `ALTER TABLE ... MODIFY COLUMN ... NewType` 実行中に、変更中のカラムを参照する `WHERE` 句を含む `SELECT` があり、かつ `ALTER` 処理がまだ完了していない場合に発生しうるサーバークラッシュを修正しました。 [#16968](https://github.com/ClickHouse/ClickHouse/pull/16968) ([Amos Bird](https://github.com/amosbird)).
* `clickhouse-git-import` で blame 情報が正しく算出されていませんでした。 [#16959](https://github.com/ClickHouse/ClickHouse/pull/16959) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 単調関数を用いた `ORDER BY` の最適化を修正しました。これにより [#16107](https://github.com/ClickHouse/ClickHouse/issues/16107) を修正しました。[#16956](https://github.com/ClickHouse/ClickHouse/pull/16956)（[Anton Popov](https://github.com/CurtizJ)）。
* `optimize_aggregators_of_group_by_keys` 設定を有効にした状態での GROUP BY と JOIN の最適化を修正。これにより [#12604](https://github.com/ClickHouse/ClickHouse/issues/12604) が解決されました。 [#16951](https://github.com/ClickHouse/ClickHouse/pull/16951) ([Anton Popov](https://github.com/CurtizJ)).
* インストールスクリプトは常に設定フォルダー内にサブディレクトリを作成する必要があります。これはカスタム設定を使用した Docker ビルドの場合にのみ該当します。 [#16936](https://github.com/ClickHouse/ClickHouse/pull/16936) ([filimonov](https://github.com/filimonov)).
* `ORDER BY` を含むクエリで発生する可能性のある `Illegal type of argument` エラーを修正しました。これにより [#16580](https://github.com/ClickHouse/ClickHouse/issues/16580) が解決されています。[#16928](https://github.com/ClickHouse/ClickHouse/pull/16928)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `WriteBufferFromS3` に一切データが書き込まれなかった場合は、マルチパートアップロードを中止するようにしました。 [#16840](https://github.com/ClickHouse/ClickHouse/pull/16840) ([Pavel Kovalenko](https://github.com/Jokser)).
* 引数なしで `any` を使用した際にクラッシュする問題を修正しました。この修正により [#16803](https://github.com/ClickHouse/ClickHouse/issues/16803) が解決されました。 [#16826](https://github.com/ClickHouse/ClickHouse/pull/16826) ([Amos Bird](https://github.com/amosbird))。
* MySQL プロトコル経由の `INSERT` クエリに対して、ClickHouse が実際の影響行数ではなく常に 0 を返していた挙動を修正しました。これにより [#16605](https://github.com/ClickHouse/ClickHouse/issues/16605) が解決されます。[#16715](https://github.com/ClickHouse/ClickHouse/pull/16715)（[Winter Zhang](https://github.com/zhang2014)）。
* `TDigest` の無制御なサイズ増大を修正しました。 [#16680](https://github.com/ClickHouse/ClickHouse/pull/16680) ([hrissan](https://github.com/hrissan)).
* Aggregate 関数でサフィックス `if` を使用した場合にリモートクエリが失敗する問題を修正しました。これにより [#16574](https://github.com/ClickHouse/ClickHouse/issues/16574)、[#16231](https://github.com/ClickHouse/ClickHouse/issues/16231)、[#16610](https://github.com/ClickHouse/ClickHouse/pull/16610) が修正されました（[Winter Zhang](https://github.com/zhang2014)）。

### ClickHouse release v20.10.4.1-stable, 2020-11-13 {#clickhouse-release-v201041-stable-2020-11-13}

#### バグ修正 {#bug-fix-8}

- クエリプロファイラが有効で、一部の関数に対して非同期アンワインドテーブルが破損している(と思われる)glibcバージョンを持つOSにClickHouseがインストールされている場合に発生する稀なサイレントクラッシュを修正しました。これにより[#15301](https://github.com/ClickHouse/ClickHouse/issues/15301)が修正されます。これにより[#13098](https://github.com/ClickHouse/ClickHouse/issues/13098)が修正されます。[#16846](https://github.com/ClickHouse/ClickHouse/pull/16846) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `transform_null_in`設定が有効な場合の複数カラムとタプルに対する`IN`演算子を修正しました。[#15310](https://github.com/ClickHouse/ClickHouse/issues/15310)を修正します。[#16722](https://github.com/ClickHouse/ClickHouse/pull/16722) ([Anton Popov](https://github.com/CurtizJ))。
- max_threads>0およびORDER BY内の式を使用した場合のoptimize_read_in_order/optimize_aggregation_in_orderを修正しました。[#16637](https://github.com/ClickHouse/ClickHouse/pull/16637) ([Azat Khuzhin](https://github.com/azat))。
- 入力からAVROを解析する際に、型からLowCardinalityが削除されるようになりました。[#16188](https://github.com/ClickHouse/ClickHouse/issues/16188)を修正します。[#16521](https://github.com/ClickHouse/ClickHouse/pull/16521) ([Mike](https://github.com/myrrc))。
- MySQL Master -> MySQL Slave -> ClickHouse MaterializeMySQL Engineを使用し、MySQL Slaveで`slave_parallel_worker`が有効な場合のメタデータの急速な増加を、GTIDセットを適切に縮小することで修正しました。これにより[#15951](https://github.com/ClickHouse/ClickHouse/issues/15951)が修正されます。[#16504](https://github.com/ClickHouse/ClickHouse/pull/16504) ([TCeason](https://github.com/TCeason))。
- Distributedテーブルに対するDROP TABLE(INSERTとの競合)を修正しました。[#16409](https://github.com/ClickHouse/ClickHouse/pull/16409) ([Azat Khuzhin](https://github.com/azat))。
- レプリケーションキュー内の非常に大きなエントリの処理を修正しました。テーブル構造が極端に大きい場合(1MB近く)、ALTERクエリで非常に大きなエントリが発生する可能性があります。これにより[#16307](https://github.com/ClickHouse/ClickHouse/issues/16307)が修正されます。[#16332](https://github.com/ClickHouse/ClickHouse/pull/16332) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- MySQLデータベースのバグを修正しました。データベースエンジンとして使用されているMySQLサーバーがダウンしている場合、一部のクエリが不要にもかかわらず無効なサーバーからテーブルを取得しようとするため、例外が発生していました。例えば、`SELECT ... FROM system.parts`クエリはMergeTreeテーブルのみで動作し、MySQLデータベースには一切アクセスすべきではありません。[#16032](https://github.com/ClickHouse/ClickHouse/pull/16032) ([Kruglov Pavel](https://github.com/Avogar))。

#### 改善 {#improvement-3}

- nginxサーバーをプロキシとして使用する場合のS3の回避策。現在、nginxはhttp://domain.com?deleteのような空のパスを持つURLを受け付けませんが、標準のaws-sdk-cppはこの種のURLを生成します。このコミットでは、パッチを適用したaws-sdk-cppバージョンを使用し、このような場合にhttp://domain.com/?deleteのように"/"をパスとして含むURLを生成します。[#16813](https://github.com/ClickHouse/ClickHouse/pull/16813) ([ianton-ru](https://github.com/ianton-ru))。

### ClickHouse release v20.10.3.30, 2020-10-28 {#clickhouse-release-v2010330-2020-10-28}

#### 後方互換性のない変更 {#backward-incompatible-change-2}


- `multiple_joins_rewriter_version`を廃止。結合リライタの最初のバージョンを削除しました。[#15472](https://github.com/ClickHouse/ClickHouse/pull/15472) ([Artem Zuikov](https://github.com/4ertus2))。
- `format_regexp_escaping_rule`設定(`Regexp`フォーマットに関連)のデフォルト値を`Raw`(サブパターン全体を値として読み取ることを意味します)に変更し、ユーザーが期待する動作により近づけました。[#15426](https://github.com/ClickHouse/ClickHouse/pull/15426) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- SQLでネストされた複数行コメント`/* comment /* comment */ */`のサポートを追加しました。これはSQL標準に準拠しています。[#14655](https://github.com/ClickHouse/ClickHouse/pull/14655) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- バックグラウンドプールおよびレプリケーションキュー内のTTLを伴うマージの数を制御するためのMergeTree設定(`max_replicated_merges_with_ttl_in_queue`および`max_number_of_merges_with_ttl_in_pool`)を追加しました。この変更は、削除TTLを使用している場合にのみ古いバージョンとの互換性を破壊します。それ以外の場合、レプリケーションは互換性を維持します。すべてのシャードレプリカを一度に更新するか、すべてのレプリカの更新が完了するまで`SYSTEM STOP TTL MERGES`を実行することで、非互換性の問題を回避できます。レプリケーションキューに非互換エントリが発生した場合は、まず`SYSTEM STOP TTL MERGES`を実行し、その後、非互換TTLマージが割り当てられたパーティションに対して`ALTER TABLE ... DETACH PARTITION ...`を実行してください。単一のレプリカで再アタッチしてください。[#14490](https://github.com/ClickHouse/ClickHouse/pull/14490) ([alesapin](https://github.com/alesapin))。
- 20.5より古いバージョンからアップグレードする際、ローリングアップデートを実行し、クラスタに20.5以上のバージョンと20.5未満のバージョンの両方が含まれている場合、古いバージョンのClickHouseノードが再起動され、新しいバージョンの存在下で古いバージョンが起動すると、`Part ... intersects previous part`エラーが発生する可能性があります。このエラーを防ぐには、まずすべてのクラスタノードに新しいclickhouse-serverパッケージをインストールしてから再起動を実行してください(これにより、clickhouse-serverが再起動されると新しいバージョンで起動します)。

#### 新機能 {#new-feature-2}


* バックグラウンドでのデータ再圧縮。MergeTree テーブルエンジンファミリー向けに `TTL ... RECOMPRESS codec_name` を指定できる機能を追加。[#14494](https://github.com/ClickHouse/ClickHouse/pull/14494) ([alesapin](https://github.com/alesapin)).
* 並列クォーラム挿入機能を追加しました。これにより [#15601](https://github.com/ClickHouse/ClickHouse/issues/15601) が解決しました。 [#15601](https://github.com/ClickHouse/ClickHouse/pull/15601)（[Latysheva Alexandra](https://github.com/alexelex)）。
* データ永続性をさらに強化するための設定。レプリケーションを行わない構成で有用。[#11948](https://github.com/ClickHouse/ClickHouse/pull/11948)（[Anton Popov](https://github.com/CurtizJ)）。
* 重複したブロックが、まだローカルに存在しないレプリカ（他のレプリカからまだ取得されていないレプリカ）に書き込まれた場合でも、それを無視せずローカルにも書き込むことで、正常にレプリケーションされた場合と同じ効果が得られるようにしました。 [#11684](https://github.com/ClickHouse/ClickHouse/pull/11684) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* クエリコンテキストで名前付きサブクエリを導入するための `WITH &lt;identifier&gt; AS (subquery) ...` 構文をサポートしました。これにより [#2416](https://github.com/ClickHouse/ClickHouse/issues/2416) がクローズされ、[#4967](https://github.com/ClickHouse/ClickHouse/issues/4967) もクローズされます。[#14771](https://github.com/ClickHouse/ClickHouse/pull/14771)（[Amos Bird](https://github.com/amosbird)）。
* `enable_global_with_statement` 設定を導入しました。この設定は、同じレベルにある他の `SELECT` クエリへ最初の `SELECT` の `WITH` 句を伝播し、さらに `WITH` 句内のエイリアスをサブクエリからも参照可能にします。 [#15451](https://github.com/ClickHouse/ClickHouse/pull/15451) ([Amos Bird](https://github.com/amosbird))。
* セキュアなクラスタ間クエリ実行（`initial_user` を現在のクエリユーザーとして扱う）。 [#13156](https://github.com/ClickHouse/ClickHouse/pull/13156) ([Azat Khuzhin](https://github.com/azat)). [#15551](https://github.com/ClickHouse/ClickHouse/pull/15551) ([Azat Khuzhin](https://github.com/azat)).
* カラムプロパティおよびテーブル TTL を削除する機能を追加しました。`ALTER TABLE MODIFY COLUMN col_name REMOVE what_to_remove` と `ALTER TABLE REMOVE TTL` のクエリが導入されました。どちらの操作も軽量で、メタデータレベルで実行されます。[#14742](https://github.com/ClickHouse/ClickHouse/pull/14742)（[alesapin](https://github.com/alesapin)）。
* フォーマット `RawBLOB` を追加しました。これは、エスケープや区切り文字を一切行わずに単一の値を入出力するためのものです。これにより [#15349](https://github.com/ClickHouse/ClickHouse/issues/15349) がクローズされました。 [#15364](https://github.com/ClickHouse/ClickHouse/pull/15364) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* ビッグエンディアン形式のバイト列を UUID に変換する `reinterpretAsUUID` 関数を追加。[#15480](https://github.com/ClickHouse/ClickHouse/pull/15480)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* `force_data_skipping_indices` 設定を実装しました。 [#15642](https://github.com/ClickHouse/ClickHouse/pull/15642) ([Azat Khuzhin](https://github.com/azat))。
* Pretty 形式で結果に行番号を付与するための設定 `output_format_pretty_row_numbers` を追加しました。これにより [#15350](https://github.com/ClickHouse/ClickHouse/issues/15350) が解決されました。 [#15443](https://github.com/ClickHouse/ClickHouse/pull/15443) ([flynn](https://github.com/ucasFL))。
* クエリ難読化ツールを追加しました。これにより、より多くのクエリを共有し、テストの質を高めることができます。この変更により [#15268](https://github.com/ClickHouse/ClickHouse/issues/15268) がクローズされました。 [#15321](https://github.com/ClickHouse/ClickHouse/pull/15321) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* テーブル関数 `null('structure')` を追加。 [#14797](https://github.com/ClickHouse/ClickHouse/pull/14797) ([vxider](https://github.com/Vxider))。
* `formatReadableQuantity` 関数を追加しました。人間が大きな数値を読みやすくするのに役立ちます。 [#14725](https://github.com/ClickHouse/ClickHouse/pull/14725) ([Artem Hnilov](https://github.com/BooBSD))。
* 改行で区切られた行のシーケンスを受け取り、各行を 1 つの String フィールドとしてそのままパースするフォーマット `LineAsString` を追加。 [#14703](https://github.com/ClickHouse/ClickHouse/pull/14703) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)), [#13846](https://github.com/ClickHouse/ClickHouse/pull/13846) ([hexiaoting](https://github.com/hexiaoting)).
* 文字列の配列としてデータを出力する `JSONStrings` フォーマットを追加しました。 [#14333](https://github.com/ClickHouse/ClickHouse/pull/14333) ([hcz](https://github.com/hczhcz)).
* `Regexp` フォーマットに「Raw」カラムフォーマットのサポートを追加しました。これにより、エスケープ規則を適用することなく、サブパターン全体をそのまま抽出できるようになりました。 [#15363](https://github.com/ClickHouse/ClickHouse/pull/15363) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `TSV` 出力フォーマットにおける `NULL` の表現方法を設定可能にしました。これは設定 `output_format_tsv_null_representation` によって制御され、デフォルト値は `\N` です。これにより [#9375](https://github.com/ClickHouse/ClickHouse/issues/9375) が解決されました。なお、この設定は出力フォーマットにのみ影響し、`TSV` 入力フォーマットでサポートされる `NULL` の表現は `\N` のみです。[#14586](https://github.com/ClickHouse/ClickHouse/pull/14586) ([Kruglov Pavel](https://github.com/Avogar))。
* `MaterializeMySQL` で Decimal データ型をサポートしました。`MaterializeMySQL` は実験的機能です。[#14535](https://github.com/ClickHouse/ClickHouse/pull/14535)（[Winter Zhang](https://github.com/zhang2014)）。
* 新機能を追加：`SHOW DATABASES LIKE 'xxx'`。 [#14521](https://github.com/ClickHouse/ClickHouse/pull/14521) ([hexiaoting](https://github.com/hexiaoting))。
* 任意の Git リポジトリをサンプルデータセットとして ClickHouse にインポートするスクリプトを追加しました。[#14471](https://github.com/ClickHouse/ClickHouse/pull/14471) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `INSERT` ステートメントのカラムリストで、カラムトランスフォーマーと組み合わせてアスタリスク（およびそのバリエーション）を使用できるようになりました。 [#14453](https://github.com/ClickHouse/ClickHouse/pull/14453) ([Amos Bird](https://github.com/amosbird)).
* 分散クエリ向けに、新しいクエリ複雑度制限設定 `max_rows_to_read_leaf` と `max_bytes_to_read_leaf` が追加され、リーフノードで読み取る行数／バイト数の上限を設定できるようになりました。制限はローカルでの読み取りに対してのみ適用され、ルートノードでの最終マージ段階は *対象外* です。 [#14221](https://github.com/ClickHouse/ClickHouse/pull/14221) ([Roman Khavronenko](https://github.com/hagen1778))。
* 設定ファイルの `<replicated_merge_tree>` セクションで、ユーザーが `ReplicatedMergeTree*` ストレージ用の設定を指定できるようにしました。これは `<merge_tree>` セクションと同様に動作します。`ReplicatedMergeTree*` ストレージでは、`<merge_tree>` と `<replicated_merge_tree>` の両方の設定が適用されますが、`<replicated_merge_tree>` の設定の方がより高い優先度を持ちます。`system.replicated_merge_tree_settings` テーブルを追加しました。 [#13573](https://github.com/ClickHouse/ClickHouse/pull/13573) ([Amos Bird](https://github.com/amosbird))。
* `mapPopulateSeries` 関数を追加しました。 [#13166](https://github.com/ClickHouse/ClickHouse/pull/13166) ([Ildus Kurbangaliev](https://github.com/ildus))。
* MySQL の `decimal` 型（ClickHouse の `Decimal` として）およびサブ秒精度を持つ `datetime` 型（`DateTime64` として）をサポート。 [#11512](https://github.com/ClickHouse/ClickHouse/pull/11512) ([Vasily Nemkov](https://github.com/Enmk))。
* `event_time_microseconds` フィールドを `system.text_log`、`system.trace_log`、`system.query_log`、`system.query_thread_log` テーブルに追加。[#14760](https://github.com/ClickHouse/ClickHouse/pull/14760)（[Bharat Nallan](https://github.com/bharatnc)）。
* `event_time_microseconds` を `system.asynchronous_metric_log` および `system.metric_log` テーブルに追加しました。[#14514](https://github.com/ClickHouse/ClickHouse/pull/14514) ([Bharat Nallan](https://github.com/bharatnc))。
* `query_start_time_microseconds` フィールドを `system.query_log` および `system.query_thread_log` テーブルに追加。[#14252](https://github.com/ClickHouse/ClickHouse/pull/14252) ([Bharat Nallan](https://github.com/bharatnc))。

#### バグ修正 {#bug-fix-9}


* メモリが上限を超えて割り当てられてしまうケースを修正しました。これにより [#14560](https://github.com/ClickHouse/ClickHouse/issues/14560) が解決されました。[#16206](https://github.com/ClickHouse/ClickHouse/pull/16206)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `executable` 辞書ソースがハングする問題を修正しました。以前のバージョンでは、一部のフォーマット（例: `JSONEachRow`）を使用する場合、子プロセスが少なくとも何らかの出力を行うまでは、データが子プロセスにフィードされませんでした。この変更により [#1697](https://github.com/ClickHouse/ClickHouse/issues/1697) および [#2455](https://github.com/ClickHouse/ClickHouse/issues/2455) が解決されます。 [#14525](https://github.com/ClickHouse/ClickHouse/pull/14525)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 関数 `dictGet` 内で、例外発生時に二重解放が起きる問題を修正しました。これは、辞書がエラーを伴ってロードされた場合に発生する可能性がありました。 [#16429](https://github.com/ClickHouse/ClickHouse/pull/16429) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `GROUP BY` で `TOTALS` / `ROLLUP` / `CUBE` 修飾子およびグループ化キーに対する `min` / `max` 関数を併用した場合の不具合を修正しました。[#16393](https://github.com/ClickHouse/ClickHouse/issues/16393) を修正します。[#16397](https://github.com/ClickHouse/ClickHouse/pull/16397)（[Anton Popov](https://github.com/CurtizJ)）。
* `prefer_localhost_replica=0` および `internal_replication` を用いた非同期の Distributed への `INSERT` を修正。 [#16358](https://github.com/ClickHouse/ClickHouse/pull/16358) ([Azat Khuzhin](https://github.com/azat)).
* メモリリークを引き起こす可能性のあった TwoLevelStringHashTable 実装内の重大な不具合を修正。[#16264](https://github.com/ClickHouse/ClickHouse/pull/16264)（[Amos Bird](https://github.com/amosbird)）。
* ラムダ式における誤った集約の一部のケースで発生するセグメンテーションフォルトを修正。 [#16082](https://github.com/ClickHouse/ClickHouse/pull/16082) ([Anton Popov](https://github.com/CurtizJ)).
* `ReplicatedVersionedCollapsingMergeTree` に対する `ALTER MODIFY ... ORDER BY` クエリがハングする問題を修正しました。この変更により [#15980](https://github.com/ClickHouse/ClickHouse/issues/15980) が解決されます。[#16011](https://github.com/ClickHouse/ClickHouse/pull/16011)（[alesapin](https://github.com/alesapin)）。
* `MaterializeMySQL`（実験的機能）：照合順序名と文字セット名のパーサーを修正し、文字列型で `length = 0` をサポート。[#16008](https://github.com/ClickHouse/ClickHouse/pull/16008)（[Winter Zhang](https://github.com/zhang2014)）。
* 複合キーを持つ辞書で `direct` レイアウトを使用できるようにしました。 [#16007](https://github.com/ClickHouse/ClickHouse/pull/16007) ([Anton Popov](https://github.com/CurtizJ)).
* 非アクティブな期間の後にレプリケーションエラーが発生した場合にレプリカが 5〜10 分間ハングしてしまう問題を防止。[#15987](https://github.com/ClickHouse/ClickHouse/pull/15987) ([filimonov](https://github.com/filimonov))。
* Atomic データベースエンジンにおいて、対象テーブルを同時に `DROP` しながら `MaterializedView` への挿入または `MaterializedView` からの SELECT を行うと、まれに発生していたセグメンテーションフォルトを修正しました。 [#15984](https://github.com/ClickHouse/ClickHouse/pull/15984) ([tavplubix](https://github.com/tavplubix))。
* 設定プロファイルのパースにおけるあいまいさを解消しました。`CREATE USER ... SETTINGS profile readonly` は、読み取り専用制約付きの `profile` という設定ではなく、`readonly` という名前のプロファイルを使用しているものとして解釈されるようになりました。これにより [#15628](https://github.com/ClickHouse/ClickHouse/issues/15628) が修正されました。[#15982](https://github.com/ClickHouse/ClickHouse/pull/15982)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `MaterializeMySQL`（実験的な機能）：データベースの作成に失敗した際に発生するクラッシュを修正。 [#15954](https://github.com/ClickHouse/ClickHouse/pull/15954) ([Winter Zhang](https://github.com/zhang2014)).
* Atomic データベースエンジンにおいて、テーブルが同時にリネームされている場合に `DROP TABLE IF EXISTS` が `Table ... does not exist` エラーで失敗する問題を修正しました。複数テーブルに対して一部の DDL クエリ（`DROP DATABASE` や `RENAME TABLE` など）を同時に実行した場合にまれに発生するデッドロックを修正しました。`DROP/DETACH TABLE` を同時に実行した際に、`DROP/DETACH DATABASE` が `Table ... does not exist` で失敗する問題を修正しました。[#15934](https://github.com/ClickHouse/ClickHouse/pull/15934) ([tavplubix](https://github.com/tavplubix)).
* `WHERE`、`PREWHERE` および `GLOBAL IN` を含むクエリで、`Distributed` テーブルから誤って空の結果が返される問題を修正しました。 [#15792](https://github.com/ClickHouse/ClickHouse/issues/15792) を修正。 [#15933](https://github.com/ClickHouse/ClickHouse/pull/15933)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* [#12513](https://github.com/ClickHouse/ClickHouse/issues/12513) を修正: クエリの再解析時に同じエイリアスを持つ差分式が存在する問題。[#15886](https://github.com/ClickHouse/ClickHouse/pull/15886)（[Winter Zhang](https://github.com/zhang2014)）。
* RBAC 実装で非常にまれに発生する可能性のあるデッドロックを修正。 [#15875](https://github.com/ClickHouse/ClickHouse/pull/15875) ([Vitaly Baranov](https://github.com/vitlibar)).
* `ALTER MODIFY COLUMN` クエリの実行後に実行された `SELECT ... ORDER BY DESC` クエリで発生していた例外 `Block structure mismatch` を修正。 [#15800](https://github.com/ClickHouse/ClickHouse/issues/15800) を修正。 [#15852](https://github.com/ClickHouse/ClickHouse/pull/15852) ([alesapin](https://github.com/alesapin))。
* `MaterializeMySQL`（実験的機能）：`select count()` の不正確さを修正。[#15767](https://github.com/ClickHouse/ClickHouse/pull/15767) ([tavplubix](https://github.com/tavplubix))。
* 仮想カラムのみを選択する一部のクエリの処理を修正しました。以前は `Not found column _nothing in block` という例外がスローされることがありました。 [#12298](https://github.com/ClickHouse/ClickHouse/issues/12298) を修正。 [#15756](https://github.com/ClickHouse/ClickHouse/pull/15756)（[Anton Popov](https://github.com/CurtizJ)）。
* Atomic データベースにおいて、内部テーブルを持つマテリアライズドビューに対する DROP の処理を修正しました（MV の内部テーブルに対する再帰的な DROP TABLE によりワーカースレッドがハングし、その結果、後続のすべての DROP TABLE がハングしてしまう問題）。 [#15743](https://github.com/ClickHouse/ClickHouse/pull/15743) ([Azat Khuzhin](https://github.com/azat))。
* 最初の試行が失敗した場合でも、パーツを別のディスク/ボリュームに移動できるようにしました。 [#15723](https://github.com/ClickHouse/ClickHouse/pull/15723) ([Pavel Kovalenko](https://github.com/Jokser)).
* `ARRAY JOIN` を含む `MV` 用のクエリの場合に、`MATERIALIZED VIEW` への挿入時に発生することがある `Cannot find column` エラーを修正。 [#15717](https://github.com/ClickHouse/ClickHouse/pull/15717) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `max_replicated_logs_to_keep` 設定のデフォルト値が低すぎる問題を修正しました。この問題により、レプリカが頻繁に lost 状態になる可能性がありました。lost したレプリカの復旧プロセスを改善し、クローン元として最も新しいレプリカを選択するようにしました。また、lost したレプリカから古いパーツを削除せず、代わりにデタッチするようにしました。 [#15701](https://github.com/ClickHouse/ClickHouse/pull/15701) ([tavplubix](https://github.com/tavplubix)).
* MySQL をソースとする辞書およびテーブルにおけるまれなレースコンディションを修正しました。 [#15686](https://github.com/ClickHouse/ClickHouse/pull/15686) ([alesapin](https://github.com/alesapin)).
* AMQP-CPP の実害のないレースコンディションを修正。 [#15667](https://github.com/ClickHouse/ClickHouse/pull/15667) ([alesapin](https://github.com/alesapin))。
* 送信先テーブルと異なる構造を持つ `Buffer` テーブルからの読み取り時に発生していた `Cannot add simple transform to empty Pipe` エラーを修正しました。これは、送信先テーブルがクエリに対して空の結果を返した場合に発生する可能性がありました。[#15529](https://github.com/ClickHouse/ClickHouse/issues/15529) を修正しました。[#15662](https://github.com/ClickHouse/ClickHouse/pull/15662)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* S3 を使用した MergeTree への挿入時の適切なエラー処理。S3 上の MergeTree は実験的な機能です。[#15657](https://github.com/ClickHouse/ClickHouse/pull/15657)（[Pavel Kovalenko](https://github.com/Jokser)）。
* S3 テーブル関数のバグを修正: URL から取得した `region` が S3 クライアントの設定に反映されていませんでした。 [#15646](https://github.com/ClickHouse/ClickHouse/pull/15646) ([Vladimir Chebotarev](https://github.com/excitoon))。
* クエリプランの `ReadFromStorage` ステップでのリソースの破棄順序を修正しました。まれなケースでクラッシュを引き起こす可能性がありました。[#15610](https://github.com/ClickHouse/ClickHouse/issues/15610) に関連している可能性があります。[#15645](https://github.com/ClickHouse/ClickHouse/pull/15645)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 読み取り専用テーブルをデタッチしたときに `ReadonlyReplica` メトリクスを減算するようにしました。 [#15592](https://github.com/ClickHouse/ClickHouse/pull/15592) ([sundyli](https://github.com/sundy-li)).
* `VALUES`、`LIMIT`、または `IN` 演算子の右辺で `JSON*` 関数の結果を使用した際に発生していた `Element ... is not a constant expression` エラーを修正しました。 [#15589](https://github.com/ClickHouse/ClickHouse/pull/15589) ([tavplubix](https://github.com/tavplubix)).
* 例外発生時にはクエリがより早く終了するようになりました。例外が発生した場合は、リモートレプリカでの実行をキャンセルします。 [#15578](https://github.com/ClickHouse/ClickHouse/pull/15578) ([Azat Khuzhin](https://github.com/azat)).
* エラーメッセージ `Could not calculate available disk space (statvfs), errno: 4, strerror: Interrupted system call` が発生しないようにしました。これにより [#15541](https://github.com/ClickHouse/ClickHouse/issues/15541) が修正されました。 [#15557](https://github.com/ClickHouse/ClickHouse/pull/15557) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* イニシエーター側にデータベースが存在しない場合に、IN 句および Distributed テーブルを含むクエリで発生する `Database &lt;db&gt; does not exist.` エラーを修正しました。 [#15538](https://github.com/ClickHouse/ClickHouse/pull/15538) ([Artem Zuikov](https://github.com/4ertus2)).
* `MOVE` や `REPLACE PARTITION` の実行後に存在しないパーツを待ち続けてミューテーションがハングしてしまうことがあり、まれに `DETACH` や `DROP PARTITION` の後にも発生する場合がありました。これは修正されました。 [#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix))。
* 同じパターンで `LIKE` 演算子を実行した後に、`ILIKE` 演算子が大文字小文字を区別しない動作をしなくなるバグを修正しました。 [#15536](https://github.com/ClickHouse/ClickHouse/pull/15536) ([alesapin](https://github.com/alesapin)).
* データに存在しない列で、同じくデータに存在しない他の列に依存しているものを選択した際に発生する `Missing columns` エラーを修正。 [#15530](https://github.com/ClickHouse/ClickHouse/issues/15530) を修正。 [#15532](https://github.com/ClickHouse/ClickHouse/pull/15532)（[alesapin](https://github.com/alesapin)）。
* `ReplicatedMergeTree` に単一のパラメータが渡された場合、無視せずにエラーをスローするよう変更しました。 [#15516](https://github.com/ClickHouse/ClickHouse/pull/15516) ([nvartolomei](https://github.com/nvartolomei)).
* DDLWorker におけるイベントサブスクリプションのバグを修正しました。このバグにより、まれに `ON CLUSTER` でクエリがハングすることがありました。[#13450](https://github.com/ClickHouse/ClickHouse/issues/13450) で導入された問題です。[#15477](https://github.com/ClickHouse/ClickHouse/pull/15477)（[alesapin](https://github.com/alesapin)）。
* `boundingRatio` 集約関数の第 2 引数の型が誤っている場合に、適切なエラーを報告するようになりました。 [#15407](https://github.com/ClickHouse/ClickHouse/pull/15407) ([detailyang](https://github.com/detailyang)).
* [#15365](https://github.com/ClickHouse/ClickHouse/issues/15365) の修正: MySQL エンジンのデータベースを `ATTACH` する際に、クエリコンテキストがない場合に例外がスローされる問題を修正。[#15384](https://github.com/ClickHouse/ClickHouse/pull/15384)（[Winter Zhang](https://github.com/zhang2014)）。
* `SELECT` クエリ内で列トランスフォーマが複数回使用される場合の処理を修正。 [#15378](https://github.com/ClickHouse/ClickHouse/pull/15378) ([Amos Bird](https://github.com/amosbird)).
* `S3` ストレージでの圧縮を修正しました。 [#15376](https://github.com/ClickHouse/ClickHouse/pull/15376) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `SELECT toStartOfDay(today())` のようなクエリが、time&#95;zone 引数が空であるとしてエラーになり失敗するバグを修正。 [#15319](https://github.com/ClickHouse/ClickHouse/pull/15319) ([Bharat Nallan](https://github.com/bharatnc)).
* MergeTree テーブルのリネームおよびバックグラウンド クリーンアップ中に発生するレースコンディションを修正。 [#15304](https://github.com/ClickHouse/ClickHouse/pull/15304) ([alesapin](https://github.com/alesapin)).
* システムログが有効な場合のサーバー起動時に発生する、まれなレースコンディションを修正しました。 [#15300](https://github.com/ClickHouse/ClickHouse/pull/15300) ([alesapin](https://github.com/alesapin)).
* `MySQL` エンジンの同一テーブルに対して多数のサブクエリを含むクエリがハングする問題を修正しました。以前は、クエリ内で同じ `MySQL` テーブルへのサブクエリが 16 個を超えると、ハングしたまま解除されませんでした。 [#15299](https://github.com/ClickHouse/ClickHouse/pull/15299) ([Anton Popov](https://github.com/CurtizJ))。
* QueryLog における MSan のレポートを修正しました。未初期化メモリがフィールド `memory_usage` に使用されていた可能性がありました。 [#15258](https://github.com/ClickHouse/ClickHouse/pull/15258) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Merge テーブルに対する JOIN を含むクエリで、GROUP BY で発生する &#39;Unknown identifier&#39; エラーを修正。 [#15242](https://github.com/ClickHouse/ClickHouse/pull/15242) ([Artem Zuikov](https://github.com/4ertus2)).
* `LowCardinality` 型とともに `joinGet` を使用したときにインスタンスがクラッシュする不具合を修正しました。これにより、[#15214](https://github.com/ClickHouse/ClickHouse/issues/15214) が修正されます。[#15220](https://github.com/ClickHouse/ClickHouse/pull/15220)（[Amos Bird](https://github.com/amosbird)）。
* テーブルエンジン `Buffer` において、`ALTER` クエリ実行後に新しい構造のデータを `Buffer` に挿入できなくなっていた不具合を修正しました。 [#15117](https://github.com/ClickHouse/ClickHouse/issues/15117) を修正。 [#15192](https://github.com/ClickHouse/ClickHouse/pull/15192)（[alesapin](https://github.com/alesapin)）。
* MySQL のカラム定義パケット内の Decimal フィールドサイズを調整しました。 [#15152](https://github.com/ClickHouse/ClickHouse/pull/15152) ([maqroll](https://github.com/maqroll)).
* `join_algorithm='auto'` において発生する `Data compressed with different methods` を修正。`join_algorithm='partial_merge'` では、左テーブルの結合キーの型として LowCardinality を保持するように変更。[#15088](https://github.com/ClickHouse/ClickHouse/pull/15088)（[Artem Zuikov](https://github.com/4ertus2)）。
* `jemalloc` を更新し、アフィニティマスク対応の `percpu_arena` の問題を修正しました。 [#15035](https://github.com/ClickHouse/ClickHouse/pull/15035) ([Azat Khuzhin](https://github.com/azat)). [#14957](https://github.com/ClickHouse/ClickHouse/pull/14957) ([Azat Khuzhin](https://github.com/azat)).
* すでに String と FixedString 間のパディング付き比較を使用しています（[https://github.com/ClickHouse/ClickHouse/blob/master/src/Functions/FunctionsComparison.h#L333](https://github.com/ClickHouse/ClickHouse/blob/master/src/Functions/FunctionsComparison.h#L333)）。この PR は同じロジックをフィールド比較にも適用し、FixedString をプライマリキーとして使用する場合の扱いを正しくします。これにより [#14908](https://github.com/ClickHouse/ClickHouse/issues/14908) が修正されます。[#15033](https://github.com/ClickHouse/ClickHouse/pull/15033)（[Amos Bird](https://github.com/amosbird)）。
* 関数 `bar` が細工された特定の引数で呼び出された場合、バッファオーバーフローが発生する可能性がありました。これにより [#13926](https://github.com/ClickHouse/ClickHouse/issues/13926) がクローズされました。 [#15028](https://github.com/ClickHouse/ClickHouse/pull/15028) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* macOS 上の Docker で clickhouse-server を実行している場合に、Atomic データベースでの DDL クエリ実行時に発生していた `Cannot rename ... errno: 22, strerror: Invalid argument` エラーを修正しました。 [#15024](https://github.com/ClickHouse/ClickHouse/pull/15024) ([tavplubix](https://github.com/tavplubix))。
* メモリ制限を超え、HashJoin から MergeJoin へ切り替える必要がある場合に、`join&#95;algorith=&#39;auto&#39;` を使用している RIGHT JOIN または FULL JOIN で発生していたクラッシュを修正。 [#15002](https://github.com/ClickHouse/ClickHouse/pull/15002) ([Artem Zuikov](https://github.com/4ertus2))。
* `number_of_free_entries_in_pool_to_execute_mutation` および `number_of_free_entries_in_pool_to_lower_max_size_of_merge` の設定値は、`background_pool_size` と同じ値に設定できるようになりました。 [#14975](https://github.com/ClickHouse/ClickHouse/pull/14975) ([alesapin](https://github.com/alesapin))。
* サブクエリに `finalizeAggregation` 関数が含まれている場合に述語プッシュダウンが機能するように修正。[#14847](https://github.com/ClickHouse/ClickHouse/issues/14847) を解決。[#14937](https://github.com/ClickHouse/ClickHouse/pull/14937)（[filimonov](https://github.com/filimonov)）。
* `system.asynchronous_metrics` に論理コアごとの CPU 周波数を公開するようにしました。これにより [#14923](https://github.com/ClickHouse/ClickHouse/issues/14923) が修正されます。[#14924](https://github.com/ClickHouse/ClickHouse/pull/14924)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* `MaterializeMySQL`（実験的な機能）：`.metadata.tmp File exists` エラーを修正しました。 [#14898](https://github.com/ClickHouse/ClickHouse/pull/14898) ([Winter Zhang](https://github.com/zhang2014)).
* `extractAllGroups` 関数の一部の呼び出しで「Memory limit exceeded」エラーが発生する可能性がある問題を修正しました。これにより [#13383](https://github.com/ClickHouse/ClickHouse/issues/13383) が修正されます。[#14889](https://github.com/ClickHouse/ClickHouse/pull/14889)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* ファイルディスクリプタを用いた StorageFile への INSERT の試行時に発生する SIGSEGV を修正。 [#14887](https://github.com/ClickHouse/ClickHouse/pull/14887) ([Azat Khuzhin](https://github.com/azat))。
* `cache` 辞書で発生していたセグメンテーションフォルトを修正しました [#14837](https://github.com/ClickHouse/ClickHouse/issues/14837)。[#14879](https://github.com/ClickHouse/ClickHouse/pull/14879)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* `MaterializeMySQL`（実験的機能）：MySQL の binlog イベントのパースにおけるバグを修正しました。このバグにより、`MaterializeMySQL` データベースエンジンで `Attempt to read after EOF` および `Packet payload is not fully read` エラーが発生していました。[#14852](https://github.com/ClickHouse/ClickHouse/pull/14852) ([Winter Zhang](https://github.com/zhang2014)).
* 問い合わせ対象のカラムが `DEFAULT` 式を持ち、その `DEFAULT` 式が、やはり `DEFAULT` を持ちつつ `SELECT` クエリに含まれずディスク上にも存在しない別のカラムに依存している場合に、`SELECT` クエリでまれに発生するエラーを修正しました。 [#14531](https://github.com/ClickHouse/ClickHouse/issues/14531) を部分的に修正します。 [#14845](https://github.com/ClickHouse/ClickHouse/pull/14845)（[alesapin](https://github.com/alesapin)）。
* `from_zk` インクルードオプションを使用して構成ファイルを ZK から取得する必要がある場合に、起動時に ZooKeeper との通信中にサーバーがハングする可能性がある問題を修正しました。これにより [#14814](https://github.com/ClickHouse/ClickHouse/issues/14814) が修正されます。 [#14843](https://github.com/ClickHouse/ClickHouse/pull/14843) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* 符号付き型におけるビット幅を縮小する `Int -> Int` キャストでの誤った単調性検出を修正しました。これにより、誤ったクエリ結果が返される可能性がありました。このバグは [#14513](https://github.com/ClickHouse/ClickHouse/issues/14513) で露見しました。[#14783](https://github.com/ClickHouse/ClickHouse/pull/14783)（[Amos Bird](https://github.com/amosbird)）。
* `Replace` カラムトランスフォーマーは、識別子をクローンした AST で置き換える必要があります。これにより、[#14695](https://github.com/ClickHouse/ClickHouse/issues/14695) が修正されます。[#14734](https://github.com/ClickHouse/ClickHouse/pull/14734)（[Amos Bird](https://github.com/amosbird)）。
* `ALTER ... MODIFY QUERY` を実行した際に、マテリアライズドビューのメタデータからデフォルトデータベース名が欠落していた問題を修正しました。 [#14664](https://github.com/ClickHouse/ClickHouse/pull/14664) ([tavplubix](https://github.com/tavplubix)).
* 代入式で `Nullable` 列に定数値（`UPDATE x = 42` のような）を設定する `ALTER UPDATE` ミューテーションにより、列の値が不正になる、またはセグメンテーションフォルトが発生するバグを修正しました。[#13634](https://github.com/ClickHouse/ClickHouse/issues/13634)、[#14045](https://github.com/ClickHouse/ClickHouse/issues/14045) を修正。[#14646](https://github.com/ClickHouse/ClickHouse/pull/14646)（[alesapin](https://github.com/alesapin)）。
* 誤った Decimal 乗算結果を引き起こしていた結果列の不正な Decimal スケールを修正しました。 [#14603](https://github.com/ClickHouse/ClickHouse/pull/14603) ([Artem Zuikov](https://github.com/4ertus2))。
* `Nullable` 型の `LowCardinality` に対する関数 `has` を修正。 [#14591](https://github.com/ClickHouse/ClickHouse/pull/14591) ([Mike](https://github.com/myrrc)).
* StorageReplicatedMergeTree エンジンの CreateQuery 実行中に ZooKeeper 例外が発生した場合に、データディレクトリをクリーンアップするようにしました。 [#14563](https://github.com/ClickHouse/ClickHouse/pull/14563) ([Bharat Nallan](https://github.com/bharatnc))。
* 非常に大きなパラメータによるオーバーフローが原因で発生する可能性があった、`-Resample` コンビネータ付き関数でのまれなセグメンテーションフォールトを修正しました。 [#14562](https://github.com/ClickHouse/ClickHouse/pull/14562) ([Anton Popov](https://github.com/CurtizJ)).
* `Nullable(String)` を Enum 型に変換する際のバグを修正しました。[#12745](https://github.com/ClickHouse/ClickHouse/pull/12745) によって導入されたバグです。これにより [#14435](https://github.com/ClickHouse/ClickHouse/issues/14435) が解決されます。[#14530](https://github.com/ClickHouse/ClickHouse/pull/14530)（[Amos Bird](https://github.com/amosbird)）。
* `Nullable` 列のソート順の誤りを修正しました。これにより [#14344](https://github.com/ClickHouse/ClickHouse/issues/14344) が解決されます。[#14495](https://github.com/ClickHouse/ClickHouse/pull/14495)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* `currentDatabase()` 関数を `ON CLUSTER` DDL クエリ内で使用できなかった問題を修正。 [#14211](https://github.com/ClickHouse/ClickHouse/pull/14211) ([Winter Zhang](https://github.com/zhang2014)).
* `MaterializeMySQL`（実験的な機能）：`MaterializeMySQL` データベースエンジンで発生していた `Packet payload is not fully read` エラーを修正しました。[#14696](https://github.com/ClickHouse/ClickHouse/pull/14696) ([BohuTANG](https://github.com/BohuTANG))。

#### 改善 {#improvement-4}


* 新しく作成されるデータベースでは、`Atomic` データベースエンジンがデフォルトで有効になります。 [#15003](https://github.com/ClickHouse/ClickHouse/pull/15003) ([tavplubix](https://github.com/tavplubix)).
* サブタイプを持つカラムに対して `Delta`、`T64` などの専用コーデックを指定できるようにする機能を追加。[#12551](https://github.com/ClickHouse/ClickHouse/issues/12551) を実装し、[#11397](https://github.com/ClickHouse/ClickHouse/issues/11397) および [#4609](https://github.com/ClickHouse/ClickHouse/issues/4609) を修正。[#15089](https://github.com/ClickHouse/ClickHouse/pull/15089)（[alesapin](https://github.com/alesapin)）。
* ZooKeeper 設定の動的リロード。 [#14678](https://github.com/ClickHouse/ClickHouse/pull/14678) ([sundyli](https://github.com/sundy-li)).
* クラスタ設定の `<internal_replication>` の値に関係なく、`ALTER ... ON CLUSTER` クエリを実行できるようになりました。 [#16075](https://github.com/ClickHouse/ClickHouse/pull/16075) ([alesapin](https://github.com/alesapin)).
* `joinGet` がマルチキー検索をサポートするようになりました。[#12418](https://github.com/ClickHouse/ClickHouse/issues/12418) の継続対応です。[#13015](https://github.com/ClickHouse/ClickHouse/pull/13015)（[Amos Bird](https://github.com/amosbird)）。
* `Atomic` データベースに対して `NO DELAY` または `SYNC` が指定されている場合、`DROP/DETACH TABLE` が実際に完了するまで待つようになりました。 [#15448](https://github.com/ClickHouse/ClickHouse/pull/15448) ([tavplubix](https://github.com/tavplubix)).
* `VersionedCollapsingMergeTree` のバージョン列の型を `ALTER` クエリで変更できるようになりました。 [#15442](https://github.com/ClickHouse/ClickHouse/pull/15442) ([alesapin](https://github.com/alesapin))。
* レプリケーテッドテーブル作成時に、`zookeeper_path` 内の `{database}`、`{table}`、`{uuid}` マクロを展開する。サーバー再起動後に `zookeeper_path` を不整合な状態にする可能性がある場合は、`RENAME TABLE` を許可しないようにする。[#6917](https://github.com/ClickHouse/ClickHouse/issues/6917) を修正。[#15348](https://github.com/ClickHouse/ClickHouse/pull/15348)（[tavplubix](https://github.com/tavplubix)）。
* 関数 `now` はタイムゾーンを指定した引数を受け取れるようになりました。これにより [15264](https://github.com/ClickHouse/ClickHouse/issues/15264) が解決されました。[#15285](https://github.com/ClickHouse/ClickHouse/pull/15285) ([flynn](https://github.com/ucasFL))。
* `/docker-entrypoint-initdb.d/` 内のすべてのスクリプトが実行されるまで ClickHouse サーバーへの接続を許可しないようにしました。 [#15244](https://github.com/ClickHouse/ClickHouse/pull/15244) ([Aleksei Kozharin](https://github.com/alekseik1)).
* `EXPLAIN PLAN` クエリに `optimize` 設定を追加しました。有効な場合、クエリプランレベルの最適化が適用されます。デフォルトで有効になっています。 [#15201](https://github.com/ClickHouse/ClickHouse/pull/15201) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* CAST の引数の数が不正な場合の例外メッセージを適切なものに修正しました。これにより issue [#13992](https://github.com/ClickHouse/ClickHouse/issues/13992) がクローズされました。[#15029](https://github.com/ClickHouse/ClickHouse/pull/15029)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* データパーツ挿入時の TTL 移動を無効化するオプションを追加。 [#15000](https://github.com/ClickHouse/ClickHouse/pull/15000) ([Pavel Kovalenko](https://github.com/Jokser)).
* ミューテーション実行時にキー制約を無視する。このプルリクエストがない場合、`force_index_by_date = 1` または `force_primary_key = 1` に設定されているときはミューテーションを実行できない。 [#14973](https://github.com/ClickHouse/ClickHouse/pull/14973) ([Amos Bird](https://github.com/amosbird))。
* ZooKeeper セッションの期限切れにより前回の DROP 試行が失敗していても、Replicated テーブルを DROP できるようにしました。これにより [#11891](https://github.com/ClickHouse/ClickHouse/issues/11891) が修正されました。 [#14926](https://github.com/ClickHouse/ClickHouse/pull/14926) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 分散テーブル上で `SETTINGS` 付きの `SELECT` を実行した際に発生していた、不要な設定制約違反の問題を修正しました。 [#14876](https://github.com/ClickHouse/ClickHouse/pull/14876) ([Amos Bird](https://github.com/amosbird)).
* `load_balancing_first_offset` クエリ設定を追加し、最初のレプリカを明示的に指定できるようにしました。これは、レプリカ間のワークロードを制御可能にする `FIRST_OR_RANDOM` ロードバランシング戦略と併せて使用されます。 [#14867](https://github.com/ClickHouse/ClickHouse/pull/14867) ([Amos Bird](https://github.com/amosbird)).
* `EXPLAIN` の結果に `SET` および `JOIN` のサブクエリを表示するようにしました。 [#14856](https://github.com/ClickHouse/ClickHouse/pull/14856) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* ストレージ `Distributed` でマルチボリュームのストレージ構成を使用できるようにしました。 [#14839](https://github.com/ClickHouse/ClickHouse/pull/14839) ([Pavel Kovalenko](https://github.com/Jokser)).
* 同じ timespec から `query_start_time` と `query_start_time_microseconds` を構築するようにした。 [#14831](https://github.com/ClickHouse/ClickHouse/pull/14831) ([Bharat Nallan](https://github.com/bharatnc)).
* `StorageJoin` と `StorageSet` の永続化を無効化できるようになりました。この機能は `disable_set_and_join_persistency` を設定することで制御できます。この PR により Issue [#6318](https://github.com/ClickHouse/ClickHouse/issues/6318) が解決されました。 [#14776](https://github.com/ClickHouse/ClickHouse/pull/14776) ([vxider](https://github.com/Vxider))。
* これで `COLUMNS` を使用して列のリストをまとめ、その後に列トランスフォーマーを適用できるようになりました。 [#14775](https://github.com/ClickHouse/ClickHouse/pull/14775) ([Amos Bird](https://github.com/amosbird))
* `system.merges` テーブルに `merge_algorithm` を追加し、マージ処理の把握を容易にしました。 [#14705](https://github.com/ClickHouse/ClickHouse/pull/14705) ([Amos Bird](https://github.com/amosbird)).
* ZooKeeper の exists watch が原因となる可能性のあるメモリリークを修正しました。 [#14693](https://github.com/ClickHouse/ClickHouse/pull/14693) ([hustnn](https://github.com/hustnn)).
* 分散DDLの並列実行を可能に。 [#14684](https://github.com/ClickHouse/ClickHouse/pull/14684) ([Azat Khuzhin](https://github.com/azat)).
* `QueryMemoryLimitExceeded` イベントカウンタを追加。これにより [#14589](https://github.com/ClickHouse/ClickHouse/issues/14589) がクローズされます。[#14647](https://github.com/ClickHouse/ClickHouse/pull/14647)（[fastio](https://github.com/fastio)）。
* クエリのフォーマットで末尾の空白をいくつか修正。 [#14595](https://github.com/ClickHouse/ClickHouse/pull/14595) ([Azat Khuzhin](https://github.com/azat)).
* ClickHouse は `partition expr` と `key expr` を異なるものとして扱います。`partition expr` は関連するカラムを含む minmax インデックスを構築するために使用され、一方で primary key の `expr` は式として保存されます。ユーザーが `partition by i / 1000` のように、より粗い粒度でテーブルをパーティション分割することもあります。しかし、二項演算子は単調ではなく、この PR はその問題の修正を試みるものです。これは他のユースケースにも有用かもしれません。 [#14513](https://github.com/ClickHouse/ClickHouse/pull/14513) ([Amos Bird](https://github.com/amosbird))。
* `DiskS3` のアクセスチェックをスキップできるオプションを追加しました。`s3` ディスクは実験的な機能です。 [#14497](https://github.com/ClickHouse/ClickHouse/pull/14497) ([Pavel Kovalenko](https://github.com/Jokser))。
* 進行中の S3 リクエストがある場合のサーバーのシャットダウン処理を高速化しました。 [#14496](https://github.com/ClickHouse/ClickHouse/pull/14496) ([Pavel Kovalenko](https://github.com/Jokser)).
* `SYSTEM RELOAD CONFIG` は、再読み込みに失敗した場合に例外をスローし、以前の users.xml を引き続き使用するようになりました。バックグラウンドでの定期的な再読み込み処理も、再読み込みに失敗した場合は以前の users.xml を引き続き使用します。 [#14492](https://github.com/ClickHouse/ClickHouse/pull/14492) ([Vitaly Baranov](https://github.com/vitlibar)).
* `clickhouse-client` のスクリプトモードにおいて、VALUES 形式でインラインデータを指定する INSERT 文で、改行に加えてセミコロンもデータ終端記号としてサポートするようにしました。[#12288](https://github.com/ClickHouse/ClickHouse/issues/12288) をクローズ。[#13192](https://github.com/ClickHouse/ClickHouse/pull/13192)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* コンパクトパーツでカスタムコーデックが利用可能になりました。 [#12183](https://github.com/ClickHouse/ClickHouse/pull/12183) ([Anton Popov](https://github.com/CurtizJ)).

#### パフォーマンス改善 {#performance-improvement-2}

- 小さなパーツに対してデフォルトでコンパクトパーツを有効化しました。これにより、頻繁な挿入処理が若干効率化されます（4〜100倍）。[#11913](https://github.com/ClickHouse/ClickHouse/pull/11913) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `quantileTDigest`のパフォーマンスを改善しました。これにより [#2668](https://github.com/ClickHouse/ClickHouse/issues/2668) が修正されます。[#15542](https://github.com/ClickHouse/ClickHouse/pull/15542) ([Kruglov Pavel](https://github.com/Avogar))。
- AggregatingInOrderTransform/optimize_aggregation_in_orderにおけるメモリ使用量を大幅に削減しました。[#15543](https://github.com/ClickHouse/ClickHouse/pull/15543) ([Azat Khuzhin](https://github.com/azat))。
- 256ビット乗算を高速化しました。[#15418](https://github.com/ClickHouse/ClickHouse/pull/15418) ([Artem Zuikov](https://github.com/4ertus2))。
- ワイド整数の基本型として(u)int64_tを使用することで、256ビット型のパフォーマンスを改善しました。従来のワイド整数は8ビット型を基本として使用していました。[#14859](https://github.com/ClickHouse/ClickHouse/pull/14859) ([Artem Zuikov](https://github.com/4ertus2))。
- 垂直マージの一時データを保存するために、明示的に一時ディスクを使用するようにしました。[#15639](https://github.com/ClickHouse/ClickHouse/pull/15639) ([Grigory Pervakov](https://github.com/GrigoryPervakov))。
- ループ内の複数のDeleteObjectの代わりに、1つのS3 DeleteObjectsリクエストを使用するようにしました。機能的な変更はないため、integration/test_log_family_s3などの既存のテストでカバーされています。[#15238](https://github.com/ClickHouse/ClickHouse/pull/15238) ([ianton-ru](https://github.com/ianton-ru))。
- `DateTime <op> DateTime`が誤って低速な汎用実装を選択していた問題を修正しました。これにより [#15153](https://github.com/ClickHouse/ClickHouse/issues/15153) が修正されます。[#15178](https://github.com/ClickHouse/ClickHouse/pull/15178) ([Amos Bird](https://github.com/amosbird))。
- `FixedString`型のGROUP BYキーのパフォーマンスを改善しました。[#15034](https://github.com/ClickHouse/ClickHouse/pull/15034) ([Amos Bird](https://github.com/amosbird))。
- clickhouse-serverの起動時にコードセグメントのみを`mlock`するようにしました。以前のバージョンでは、デバッグ情報を含むすべてのマップされた領域がメモリにロックされていました。デバッグ情報は通常別ファイルに分割されますが、そうでない場合は+2〜3 GiBのメモリ使用量増加につながっていました。[#14929](https://github.com/ClickHouse/ClickHouse/pull/14929) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- リンク時最適化により、ClickHouseバイナリのサイズが小さくなりました。

#### ビルド/テスト/パッケージング改善 {#buildtestingpackaging-improvement-4}


* 現在、ClickHouse の本番ビルドには clang-11 を使用しています。 [#15239](https://github.com/ClickHouse/ClickHouse/pull/15239) ([alesapin](https://github.com/alesapin))
* 現在、CI では ClickHouse のビルドに clang-11 を使用しています。[#14846](https://github.com/ClickHouse/ClickHouse/pull/14846) ([alesapin](https://github.com/alesapin))。
* バイナリビルド（Linux、Darwin、AArch64、FreeBSD）を clang-11 に切り替えました。 [#15622](https://github.com/ClickHouse/ClickHouse/pull/15622) ([Ilya Yatsishin](https://github.com/qoega)).
* すべてのテストイメージで `llvm-symbolizer-11` を使用するようになりました。 [#15069](https://github.com/ClickHouse/ClickHouse/pull/15069) ([alesapin](https://github.com/alesapin)).
* llvm-11 でのビルドを可能にしました。 [#15366](https://github.com/ClickHouse/ClickHouse/pull/15366) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `clang-tidy-10` から `clang-tidy-11` に切り替えました。 [#14922](https://github.com/ClickHouse/ClickHouse/pull/14922) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* LLVM の実験的なパスマネージャーをデフォルトで使用します。 [#15608](https://github.com/ClickHouse/ClickHouse/pull/15608) ([Danila Kutenin](https://github.com/danlark1))。
* いずれの C++ 翻訳単位もビルドに 10 分以上かかったり、10 GB を超えるメモリを使用したりしないように制限しました。これにより [#14925](https://github.com/ClickHouse/ClickHouse/issues/14925) が修正されました。 [#15060](https://github.com/ClickHouse/ClickHouse/pull/15060) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* テスト実行とプロファイル実行を分離することで、パフォーマンステストの安定性と代表性を高めました。 [#15027](https://github.com/ClickHouse/ClickHouse/pull/15027) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* パフォーマンス テストの信頼性を高める試み。プロセスの実行可能メモリを `madvise` を用いて動的に再マッピングし、Transparent Huge Pages を使用するようにすることで実現している。これにより、パフォーマンス テストにおける不安定性の主な要因である iTLB ミスの回数を減らせる可能性がある。 [#14685](https://github.com/ClickHouse/ClickHouse/pull/14685) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* Python 3 へ移行。これにより [#14886](https://github.com/ClickHouse/ClickHouse/issues/14886) をクローズします。 [#15007](https://github.com/ClickHouse/ClickHouse/pull/15007) ([Azat Khuzhin](https://github.com/azat)).
* サーバーが応答しなかった場合には、機能テストが早期に失敗するようにしました。これにより [#15262](https://github.com/ClickHouse/ClickHouse/issues/15262) がクローズされました。 [#15267](https://github.com/ClickHouse/ClickHouse/pull/15267) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 設定ファイルなしで AArch64 版の clickhouse-server を実行できるようにしました。これにより [#15174](https://github.com/ClickHouse/ClickHouse/issues/15174) の解決が容易になります。 [#15266](https://github.com/ClickHouse/ClickHouse/pull/15266) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* CI 用 Docker イメージを改善: ZooKeeper を排除し、テスト設定インストール用の単一スクリプトを導入。 [#15215](https://github.com/ClickHouse/ClickHouse/pull/15215) ([alesapin](https://github.com/alesapin)).
* fast test スクリプトでの CMake オプションのフォワーディングを修正。[#14711](https://github.com/ClickHouse/ClickHouse/issues/14711) のエラーを解消。[#15155](https://github.com/ClickHouse/ClickHouse/pull/15155)（[alesapin](https://github.com/alesapin)）。
* 1つのコマンドでハードウェアベンチマークを実行するスクリプトを追加しました。 [#15115](https://github.com/ClickHouse/ClickHouse/pull/15115) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 大規模なテスト `test_dictionaries_all_layouts_and_sources` を、より小さなテストに分割しました。 [#15110](https://github.com/ClickHouse/ClickHouse/pull/15110) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
* AVX-512 搭載サーバー上で base64 によって発生していた MSan レポートをおそらく修正しました。これにより [#14006](https://github.com/ClickHouse/ClickHouse/issues/14006) が修正されます。 [#15030](https://github.com/ClickHouse/ClickHouse/pull/15030) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* すべての統合テスト用 *.py ファイルのコードを再フォーマットし、クリーンアップ。 [#14864](https://github.com/ClickHouse/ClickHouse/pull/14864) ([Bharat Nallan](https://github.com/bharatnc)).
* CI で検出された MaterializeMySQL の空トランザクションに関する不安定なテストケースを修正しました。 [#14854](https://github.com/ClickHouse/ClickHouse/pull/14854) ([Winter Zhang](https://github.com/zhang2014)).
* ビルドを少し高速化するための試み。 [#14808](https://github.com/ClickHouse/ClickHouse/pull/14808) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 未使用のヘッダーを削除してビルド時間をわずかに短縮。 [#14714](https://github.com/ClickHouse/ClickHouse/pull/14714) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* OSX でのビルド失敗を修正。 [#14761](https://github.com/ClickHouse/ClickHouse/pull/14761) ([Winter Zhang](https://github.com/zhang2014)).
* OS 上で `ccache` が検出された場合、`cmake` でデフォルトで `ccache` を有効化するようにしました。 [#14575](https://github.com/ClickHouse/ClickHouse/pull/14575) ([alesapin](https://github.com/alesapin)).
* ClickHouse リポジトリ側で CI ビルドの設定を管理できるようにしました。 [#14547](https://github.com/ClickHouse/ClickHouse/pull/14547) ([alesapin](https://github.com/alesapin)).
* CMake ファイルにおいては次の変更を行いました: - 一部のオプションについて、説明の一部を直前のコメントに移動しました。 - `option` のデフォルト値で 0 を `OFF` に、1 を `ON` に置き換えました。 - いくつかのオプションに説明とドキュメントへのリンクを追加しました。 - `FUZZER` オプションを置き換えました（同じ機能を有効にする別のオプション `ENABLE_FUZZING` が存在します）。 - `ENABLE_TESTS` があるため、`ENABLE_GTEST_LIBRARY` オプションを削除しました。 詳細な説明は PR を参照してください: [#14711](https://github.com/ClickHouse/ClickHouse/pull/14711) ([Mike](https://github.com/myrrc))。
* バイナリサイズを少し小さくし、デバッグ版で約 50 MB 削減。 [#14555](https://github.com/ClickHouse/ClickHouse/pull/14555) ([Artem Zuikov](https://github.com/4ertus2)).
* ConfigProcessor でファイルパスを連結する際に std::filesystem::path を使用するようにしました。 [#14558](https://github.com/ClickHouse/ClickHouse/pull/14558) ([Bharat Nallan](https://github.com/bharatnc))。
* 負の多倍長整数を指定して `bitShiftLeft()` を呼び出した際に発生するデバッグアサーションを修正。[#14697](https://github.com/ClickHouse/ClickHouse/pull/14697)（[Artem Zuikov](https://github.com/4ertus2)）。





## ClickHouse リリース 20.9 {#clickhouse-release-209}

### ClickHouse リリース v20.9.7.11-stable, 2020-12-07 {#clickhouse-release-v209711-stable-2020-12-07}

#### パフォーマンス改善 {#performance-improvement-3}

- 大量の`MergeTree`テーブルに対する`Merge`テーブルからの読み取りパフォーマンスを改善しました。[#7748](https://github.com/ClickHouse/ClickHouse/issues/7748)を修正。[#16988](https://github.com/ClickHouse/ClickHouse/pull/16988) ([Anton Popov](https://github.com/CurtizJ))。

#### バグ修正 {#bug-fix-10}


* `in_memory_parts_enable_wal` が無効な場合は、WAL からパーツを復元しないようにしました。 [#17802](https://github.com/ClickHouse/ClickHouse/pull/17802) ([detailyang](https://github.com/detailyang))。
* `Distributed` テーブルへの挿入時に空き領域が不足している場合に発生していたセグメンテーションフォルトを修正。[#17737](https://github.com/ClickHouse/ClickHouse/pull/17737) ([tavplubix](https://github.com/tavplubix)).
* ClickHouse が MySQL サーバーへの接続を再開できない問題を修正。 [#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz)).
* ClickHouse が Windows Subsystem for Linux 上で動作している環境で、`Atomic` データベースに対して `RENAME` クエリを実行する際に発生していた `Function not implemented` エラーを修正しました。[#17661](https://github.com/ClickHouse/ClickHouse/issues/17661) を修正。 [#17664](https://github.com/ClickHouse/ClickHouse/pull/17664) ([tavplubix](https://github.com/tavplubix))。
* clickhouse-client をインタラクティブモードで複数行クエリと共に使用した場合、1行コメントが誤ってクエリの末尾まで適用されていました。この問題を修正します [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654)。 [#17565](https://github.com/ClickHouse/ClickHouse/pull/17565)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 非常にまれなケースでサーバーが接続を受け付けなくなる不具合を修正。 [#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 対応する mutation が別のレプリカ上で kill された場合に `ALTER` クエリがハングする問題を修正（[#16953](https://github.com/ClickHouse/ClickHouse/issues/16953)）。 [#17499](https://github.com/ClickHouse/ClickHouse/pull/17499)（[alesapin](https://github.com/alesapin)）。
* `mark cache` のサイズを ClickHouse が過小に見積もっていたバグを修正しました。これは、多数の `marks` を含む小さなファイルが大量に存在する場合に発生する可能性がありました。 [#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin))。
* 設定 `optimize_redundant_functions_in_order_by` が有効な場合の `ORDER BY` の挙動を修正しました。 [#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* 誤った最適化により `DISTINCT` の後に発生し得た重複行を修正。 [#17294](https://github.com/ClickHouse/ClickHouse/issues/17294) を解決。 [#17296](https://github.com/ClickHouse/ClickHouse/pull/17296)（[li chengxiang](https://github.com/chengxianglibra)）。 [#17439](https://github.com/ClickHouse/ClickHouse/pull/17439)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `LowCardinality` 型を含む `JOIN` テーブルからの読み取り時に発生していたクラッシュを修正しました。 [#17228](https://github.com/ClickHouse/ClickHouse/issues/17228) を修正。 [#17397](https://github.com/ClickHouse/ClickHouse/pull/17397)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* サブクエリに const カラムが存在する場合に set インデックスが不正に無効化される問題を修正しました。これにより [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246) が解決されました。[#17249](https://github.com/ClickHouse/ClickHouse/pull/17249)（[Amos Bird](https://github.com/amosbird)）。
* クラッシュの原因となっていた ColumnConst の比較処理を修正しました。これにより [#17088](https://github.com/ClickHouse/ClickHouse/issues/17088) が解決されました。 [#17135](https://github.com/ClickHouse/ClickHouse/pull/17135) ([Amos Bird](https://github.com/amosbird))。
* `some_table` が `AS table_function()` として作成されている場合に `CREATE TABLE ... AS some_table` クエリがクラッシュする問題を修正。 [#16944](https://github.com/ClickHouse/ClickHouse/issues/16944) を修正。 [#17072](https://github.com/ClickHouse/ClickHouse/pull/17072) ([tavplubix](https://github.com/tavplubix)).
* fuzzBits 関数のバグ修正。関連する Issue: [#16980](https://github.com/ClickHouse/ClickHouse/issues/16980)。[#17051](https://github.com/ClickHouse/ClickHouse/pull/17051)（[hexiaoting](https://github.com/hexiaoting)）。
* `LIMIT` を含むクエリなど、実行中にキャンセルされる可能性があるリモートクエリに対して、不要なネットワークエラーが発生しないようにしました。 [#17006](https://github.com/ClickHouse/ClickHouse/pull/17006) ([Azat Khuzhin](https://github.com/azat)).
* TODO。 [#16866](https://github.com/ClickHouse/ClickHouse/pull/16866) ([tavplubix](https://github.com/tavplubix)).
* MySQL プロトコル経由の INSERT クエリに対して、影響を受けた行数を返すようにしました。以前の ClickHouse は常に 0 を返していましたが、これは修正されました。[#16605](https://github.com/ClickHouse/ClickHouse/issues/16605) を修正しました。[#16715](https://github.com/ClickHouse/ClickHouse/pull/16715)（[Winter Zhang](https://github.com/zhang2014)）。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-5}

- 埋め込みタイムゾーンデータをバージョン2020dに更新（cctzも最新のmasterに更新）。[#17204](https://github.com/ClickHouse/ClickHouse/pull/17204) ([filimonov](https://github.com/filimonov))。

### ClickHouse リリース v20.9.6.14-stable, 2020-11-20 {#clickhouse-release-v209614-stable-2020-11-20}

#### 改善 {#improvement-5}

- SNIを必要とする`clickhouse-server`のセキュアエンドポイントへの接続を可能にしました。これは`clickhouse-server`がTLSプロキシの背後でホストされている場合に利用できます。[#16938](https://github.com/ClickHouse/ClickHouse/pull/16938) ([filimonov](https://github.com/filimonov))。
- 条件付き集約関数（例：`avgIf`、`sumIf`、`maxIf`）は、行が存在せずnullable引数を使用する場合に`NULL`を返すようになりました。[#13964](https://github.com/ClickHouse/ClickHouse/pull/13964) ([Winter Zhang](https://github.com/zhang2014))。

#### バグ修正 {#bug-fix-11}

- 非リーダーのReplicatedMergeTreeTablesに対して`ON CLUSTER`クエリが永久にハングする可能性があるバグを修正しました。[#17089](https://github.com/ClickHouse/ClickHouse/pull/17089) ([alesapin](https://github.com/alesapin))。
- エラーが発生した場合に`format_avro_schema_registry_url`のIPを再解決するようにしました。[#16985](https://github.com/ClickHouse/ClickHouse/pull/16985) ([filimonov](https://github.com/filimonov))。
- `ALTER TABLE ... MODIFY COLUMN ... NewType`の後、`SELECT`が変更中のカラムに対する`WHERE`式を持ち、かつ変更がまだ完了していない場合に発生する可能性のあるサーバークラッシュを修正しました。[#16968](https://github.com/ClickHouse/ClickHouse/pull/16968) ([Amos Bird](https://github.com/amosbird))。
- インストールスクリプトは常に設定フォルダ内にサブディレクトリを作成するようになりました。これはカスタム設定を使用したDockerビルドにのみ関連します。[#16936](https://github.com/ClickHouse/ClickHouse/pull/16936) ([filimonov](https://github.com/filimonov))。
- `ORDER BY`を含むクエリで発生する可能性のある`Illegal type of argument`エラーを修正しました。[#16580](https://github.com/ClickHouse/ClickHouse/issues/16580)を修正。[#16928](https://github.com/ClickHouse/ClickHouse/pull/16928) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- WriteBufferFromS3にデータが書き込まれなかった場合、マルチパートアップロードを中止するようにしました。[#16840](https://github.com/ClickHouse/ClickHouse/pull/16840) ([Pavel Kovalenko](https://github.com/Jokser))。
- 引数なしで`any`を使用した場合のクラッシュを修正しました。これは[#16803](https://github.com/ClickHouse/ClickHouse/issues/16803)に対するものです。cc @azat。[#16826](https://github.com/ClickHouse/ClickHouse/pull/16826) ([Amos Bird](https://github.com/amosbird))。
- `transform_null_in`設定が有効な場合の複数カラムとタプルに対する`IN`演算子を修正しました。[#15310](https://github.com/ClickHouse/ClickHouse/issues/15310)を修正。[#16722](https://github.com/ClickHouse/ClickHouse/pull/16722) ([Anton Popov](https://github.com/CurtizJ))。
- max_threads>0およびORDER BY内の式を使用した場合のoptimize_read_in_order/optimize_aggregation_in_orderを修正しました。[#16637](https://github.com/ClickHouse/ClickHouse/pull/16637) ([Azat Khuzhin](https://github.com/azat))。
- [#16574](https://github.com/ClickHouse/ClickHouse/issues/16574)を修正、[#16231](https://github.com/ClickHouse/ClickHouse/issues/16231)を修正、'if'サフィックス集約関数を使用した場合のリモートクエリの失敗を修正しました。[#16610](https://github.com/ClickHouse/ClickHouse/pull/16610) ([Winter Zhang](https://github.com/zhang2014))。
- 例外が発生した場合にクエリがより速く終了するようになりました。例外が発生した場合、リモートレプリカでの実行をキャンセルします。[#15578](https://github.com/ClickHouse/ClickHouse/pull/15578) ([Azat Khuzhin](https://github.com/azat))。


### ClickHouse release v20.9.5.5-stable, 2020-11-13 {#clickhouse-release-v20955-stable-2020-11-13}

#### バグ修正 {#bug-fix-12}

- クエリプロファイラが有効で、一部の関数に対して非同期アンワインドテーブルが破損している(と推定される)glibcバージョンを持つOSにClickHouseがインストールされている場合に発生する稀なサイレントクラッシュを修正しました。これにより[#15301](https://github.com/ClickHouse/ClickHouse/issues/15301)が修正されます。これにより[#13098](https://github.com/ClickHouse/ClickHouse/issues/13098)が修正されます。[#16846](https://github.com/ClickHouse/ClickHouse/pull/16846) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 入力からAVROを解析する際に、型からLowCardinalityが削除されるようになりました。[#16188](https://github.com/ClickHouse/ClickHouse/issues/16188)を修正します。[#16521](https://github.com/ClickHouse/ClickHouse/pull/16521) ([Mike](https://github.com/myrrc))。
- MySQL Master -> MySQL Slave -> ClickHouse MaterializeMySQL Engineを使用し、MySQL Slaveで`slave_parallel_worker`が有効になっている場合のメタデータの急速な増加を、GTIDセットを適切に縮小することで修正しました。これにより[#15951](https://github.com/ClickHouse/ClickHouse/issues/15951)が修正されます。[#16504](https://github.com/ClickHouse/ClickHouse/pull/16504) ([TCeason](https://github.com/TCeason))。
- Distributedテーブルに対するDROP TABLE(INSERTとの競合状態)を修正しました。[#16409](https://github.com/ClickHouse/ClickHouse/pull/16409) ([Azat Khuzhin](https://github.com/azat))。
- レプリケーションキュー内の非常に大きなエントリの処理を修正しました。テーブル構造が極端に大きい場合(1MB近く)、ALTERクエリで非常に大きなエントリが出現する可能性があります。これにより[#16307](https://github.com/ClickHouse/ClickHouse/issues/16307)が修正されます。[#16332](https://github.com/ClickHouse/ClickHouse/pull/16332) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- フィルタリング用のセットが作成されていないために返却データの一部がドロップされる可能性がある不整合な動作を修正しました。[#16308](https://github.com/ClickHouse/ClickHouse/pull/16308) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- MySQLデータベースに関するバグを修正しました。データベースエンジンとして使用されているMySQLサーバーがダウンしている場合、一部のクエリが例外を発生させていました。これは、不要であるにもかかわらず無効化されたサーバーからテーブルを取得しようとするためです。例えば、`SELECT ... FROM system.parts`クエリはMergeTreeテーブルのみで動作すべきであり、MySQLデータベースには一切アクセスすべきではありません。[#16032](https://github.com/ClickHouse/ClickHouse/pull/16032) ([Kruglov Pavel](https://github.com/Avogar))。

### ClickHouse release v20.9.4.76-stable (2020-10-29) {#clickhouse-release-v209476-stable-2020-10-29}

#### バグ修正 {#bug-fix-13}


* `dictGet` 関数での例外発生時に二重解放が発生する不具合を修正しました。これは、辞書の読み込み時にエラーが発生した場合に起こり得ました。[#16429](https://github.com/ClickHouse/ClickHouse/pull/16429) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* totals/rollup/cube 修飾子付き GROUP BY と、GROUP BY キーに対する min/max 関数の組み合わせを修正。[#16393](https://github.com/ClickHouse/ClickHouse/issues/16393) を修正。[#16397](https://github.com/ClickHouse/ClickHouse/pull/16397)（[Anton Popov](https://github.com/CurtizJ)）。
* `prefer_localhost_replica=0` および `internal_replication` を使用した非同期 Distributed INSERT を修正しました。 [#16358](https://github.com/ClickHouse/ClickHouse/pull/16358) ([Azat Khuzhin](https://github.com/azat)).
* TwoLevelStringHashTable 実装内の重大な誤りのあるコードを修正しました。これによりメモリリークが発生する可能性がありました。このバグがこれほど長い間紛れ込んでいたことに驚いています…… [#16264](https://github.com/ClickHouse/ClickHouse/pull/16264) ([Amos Bird](https://github.com/amosbird))。
* メモリ制限に関係なくメモリが過剰に割り当てられる場合がある問題を修正しました。これにより [#14560](https://github.com/ClickHouse/ClickHouse/issues/14560) が解決されます。[#16206](https://github.com/ClickHouse/ClickHouse/pull/16206)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `ReplicatedVersionedCollapsingMergeTree` に対する `ALTER MODIFY ... ORDER BY` クエリがハングする問題を修正しました。この修正により [#15980](https://github.com/ClickHouse/ClickHouse/issues/15980) が解決されています。 [#16011](https://github.com/ClickHouse/ClickHouse/pull/16011) ([alesapin](https://github.com/alesapin)).
* 照合順序名および文字セット名のパーサを修正し、文字列型において `length = 0` をサポートするようにしました。 [#16008](https://github.com/ClickHouse/ClickHouse/pull/16008) ([Winter Zhang](https://github.com/zhang2014)).
* 複雑なキーを持つ辞書で direct レイアウトを使用できるようにしました。 [#16007](https://github.com/ClickHouse/ClickHouse/pull/16007) ([Anton Popov](https://github.com/CurtizJ)).
* 一定期間のアイドル状態の後にレプリケーションエラーが発生した場合に、レプリカが 5〜10 分間ハングする問題を防止。 [#15987](https://github.com/ClickHouse/ClickHouse/pull/15987) ([filimonov](https://github.com/filimonov))
* Atomic データベースエンジンにおいて、MaterializedView への挿入または MaterializedView からの読み取りと対象テーブルの `DROP` を同時に実行した場合に、まれに発生するセグメンテーションフォルトを修正しました。 [#15984](https://github.com/ClickHouse/ClickHouse/pull/15984) ([tavplubix](https://github.com/tavplubix)).
* 設定プロファイルの構文解釈における曖昧さを修正しました。`CREATE USER ... SETTINGS profile readonly` は、`readonly` 制約を持つ設定 `profile` を使用しているのではなく、`readonly` という名前のプロファイルを使用していると解釈されるようになりました。これにより [#15628](https://github.com/ClickHouse/ClickHouse/issues/15628) が修正されました。[#15982](https://github.com/ClickHouse/ClickHouse/pull/15982)（[Vitaly Baranov](https://github.com/vitlibar)）。
* データベース作成に失敗した際に発生するクラッシュを修正。 [#15954](https://github.com/ClickHouse/ClickHouse/pull/15954) ([Winter Zhang](https://github.com/zhang2014))。
* Atomic データベースエンジン使用時に、テーブルが並行してリネームされている場合に `Table ... does not exist` エラーが発生し、`DROP TABLE IF EXISTS` が失敗していた問題を修正しました。複数テーブルに対して `DROP DATABASE` や `RENAME TABLE` などの DDL クエリを並行して実行した際に、まれに発生していたデッドロックを修正しました。`DROP/DETACH TABLE` を並行して実行している場合に `Table ... does not exist` により `DROP/DETACH DATABASE` が失敗していた問題を修正しました。[#15934](https://github.com/ClickHouse/ClickHouse/pull/15934) ([tavplubix](https://github.com/tavplubix))。
* クエリに `WHERE`、`PREWHERE`、`GLOBAL IN` が含まれている場合に、`Distributed` テーブルに対するクエリで誤って空の結果が返される問題を修正しました。[#15792](https://github.com/ClickHouse/ClickHouse/issues/15792) の修正。[#15933](https://github.com/ClickHouse/ClickHouse/pull/15933)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* RBAC における起こり得るデッドロックを修正しました。 [#15875](https://github.com/ClickHouse/ClickHouse/pull/15875) ([Vitaly Baranov](https://github.com/vitlibar)).
* `ALTER MODIFY COLUMN` クエリの後に実行される `SELECT ... ORDER BY DESC` クエリで `Block structure mismatch` 例外が発生する問題を修正しました。[#15800](https://github.com/ClickHouse/ClickHouse/issues/15800) を修正。[#15852](https://github.com/ClickHouse/ClickHouse/pull/15852)（[alesapin](https://github.com/alesapin)）。
* MaterializeMySQL における `select count()` の不正確な動作を修正。 [#15767](https://github.com/ClickHouse/ClickHouse/pull/15767) ([tavplubix](https://github.com/tavplubix))。
* 仮想カラムのみが選択されるクエリの一部のケースを修正。以前は `Not found column _nothing in block` という例外が発生することがありました。[#12298](https://github.com/ClickHouse/ClickHouse/issues/12298) を修正。[#15756](https://github.com/ClickHouse/ClickHouse/pull/15756)（[Anton Popov](https://github.com/CurtizJ)）。
* `max_replicated_logs_to_keep` 設定のデフォルト値が低すぎた問題を修正しました。これにより、レプリカが頻繁にロストする可能性がありました。クローン元として最も最新のレプリカを選択することで、ロストしたレプリカの復旧プロセスを改善しました。また、ロストしたレプリカから古いパーツを削除せず、代わりに detach するようにしました。 [#15701](https://github.com/ClickHouse/ClickHouse/pull/15701) ([tavplubix](https://github.com/tavplubix)).
* `Buffer` テーブルからの読み取り時に、宛先テーブルと構造が異なる場合に発生していた `Cannot add simple transform to empty Pipe` エラーを修正しました。これは、宛先テーブルに対するクエリが空の結果セットを返した場合に発生する可能性がありました。[#15529](https://github.com/ClickHouse/ClickHouse/issues/15529) を修正しました。 [#15662](https://github.com/ClickHouse/ClickHouse/pull/15662)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* S3 テーブル関数における glob パターンのバグを修正しました。URL から取得したリージョンが S3 クライアント設定に適用されていませんでした。 [#15646](https://github.com/ClickHouse/ClickHouse/pull/15646) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 読み取り専用テーブルをデタッチする際に `ReadonlyReplica` メトリクスをデクリメントします。これにより [#15598](https://github.com/ClickHouse/ClickHouse/issues/15598) が解決します。[#15592](https://github.com/ClickHouse/ClickHouse/pull/15592)（[sundyli](https://github.com/sundy-li)）。
* ReplicatedMergeTree に単一のパラメータが渡された場合、それを無視するのではなくエラーを発生させるようにしました。 [#15516](https://github.com/ClickHouse/ClickHouse/pull/15516) ([nvartolomei](https://github.com/nvartolomei)).

#### 改善 {#improvement-6}

- クラスタ設定の`<internal_replication>`設定に関わらず、`ALTER ... ON CLUSTER`クエリを実行できるようになりました。[#16075](https://github.com/ClickHouse/ClickHouse/pull/16075) ([alesapin](https://github.com/alesapin))。
- テーブル作成時に`ReplicatedMergeTree`の引数内で`{database}`、`{table}`、`{uuid}`マクロを展開するようになりました。[#16160](https://github.com/ClickHouse/ClickHouse/pull/16160) ([tavplubix](https://github.com/tavplubix))。

### ClickHouse リリース v20.9.3.45-stable (2020-10-09) {#clickhouse-release-v209345-stable-2020-10-09}

#### バグ修正 {#bug-fix-14}


* クエリに `ARRAY JOIN` を含む `MATERIALIZED VIEW` への挿入時に発生する可能性があった `Cannot find column` エラーを修正。 [#15717](https://github.com/ClickHouse/ClickHouse/pull/15717) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* AMQP-CPP における競合状態を修正。[#15667](https://github.com/ClickHouse/ClickHouse/pull/15667) ([alesapin](https://github.com/alesapin))。
* クエリプランの `ReadFromStorage` ステップにおけるリソースの解放順序を修正しました。まれな場合にクラッシュを引き起こす可能性がありました。[#15610](https://github.com/ClickHouse/ClickHouse/issues/15610) に関連している可能性があります。[#15645](https://github.com/ClickHouse/ClickHouse/pull/15645)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `JSON*` 関数の結果を `VALUES`、`LIMIT`、または `IN` 演算子の右側で使用した際に発生していた `Element ... is not a constant expression` エラーを修正しました。 [#15589](https://github.com/ClickHouse/ClickHouse/pull/15589) ([tavplubix](https://github.com/tavplubix))。
* エラーメッセージ `Could not calculate available disk space (statvfs), errno: 4, strerror: Interrupted system call` が発生しないようにしました。これにより [#15541](https://github.com/ClickHouse/ClickHouse/issues/15541) が修正されます。[#15557](https://github.com/ClickHouse/ClickHouse/pull/15557)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* AggregatingInOrderTransform/optimize&#95;aggregation&#95;in&#95;order でのメモリ使用量を大幅に削減しました。 [#15543](https://github.com/ClickHouse/ClickHouse/pull/15543) ([Azat Khuzhin](https://github.com/azat)).
* `MOVE` や `REPLACE PARTITION` の後、存在しないパーツを待ち続けてミューテーションがハングしてしまうことがあり、まれに `DETACH` や `DROP PARTITION` の後にも発生する可能性がありました。この問題は修正されました。 [#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix)).
* `LIKE` 演算子で同じパターンを実行した後に、`ILIKE` 演算子が大文字小文字を区別するようになってしまうバグを修正。 [#15536](https://github.com/ClickHouse/ClickHouse/pull/15536) ([alesapin](https://github.com/alesapin))。
* データ内に存在しない列であり、かつ同じくデータ内に存在しない他の列に依存している列を SELECT した際に発生する `Missing columns` エラーを修正しました。 [#15530](https://github.com/ClickHouse/ClickHouse/issues/15530) を解決。 [#15532](https://github.com/ClickHouse/ClickHouse/pull/15532) ([alesapin](https://github.com/alesapin)).
* DDLWorker におけるイベントサブスクリプションのバグを修正しました。このバグは、まれに `ON CLUSTER` でクエリがハングする原因となることがありました。[#13450](https://github.com/ClickHouse/ClickHouse/issues/13450) で導入された問題です。[#15477](https://github.com/ClickHouse/ClickHouse/pull/15477)（[alesapin](https://github.com/alesapin)）。
* `boundingRatio` 集約関数の第 2 引数の型が誤っている場合に、適切なエラーを報告するようにしました。 [#15407](https://github.com/ClickHouse/ClickHouse/pull/15407) ([detailyang](https://github.com/detailyang)).
* `SELECT toStartOfDay(today())` のようなクエリが、time&#95;zone 引数が空だとしてエラーになり失敗するバグを修正。 [#15319](https://github.com/ClickHouse/ClickHouse/pull/15319) ([Bharat Nallan](https://github.com/bharatnc))。
* MergeTree テーブルのリネーム処理とバックグラウンドクリーンアップ処理の間に発生するレースコンディションを修正。 [#15304](https://github.com/ClickHouse/ClickHouse/pull/15304) ([alesapin](https://github.com/alesapin)).
* `system.logs` が有効な場合にサーバー起動時にまれに発生するレースコンディションを修正。 [#15300](https://github.com/ClickHouse/ClickHouse/pull/15300) ([alesapin](https://github.com/alesapin))。
* QueryLog における MSan レポートを修正。初期化されていないメモリがフィールド `memory_usage` に使用される可能性がありました。 [#15258](https://github.com/ClickHouse/ClickHouse/pull/15258) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* LowCardinality 型で joinGet を使用した際に発生するインスタンスのクラッシュを修正しました。これにより [#15214](https://github.com/ClickHouse/ClickHouse/issues/15214) が修正されます。 [#15220](https://github.com/ClickHouse/ClickHouse/pull/15220) ([Amos Bird](https://github.com/amosbird))。
* テーブルエンジン `Buffer` において、`ALTER` クエリの後に新しい構造のデータを `Buffer` に挿入できなくなっていた不具合を修正しました。[#15117](https://github.com/ClickHouse/ClickHouse/issues/15117) を修正します。[#15192](https://github.com/ClickHouse/ClickHouse/pull/15192)（[alesapin](https://github.com/alesapin)）。
* MySQL カラム定義パケット内の decimals フィールドのサイズを調整。 [#15152](https://github.com/ClickHouse/ClickHouse/pull/15152) ([maqroll](https://github.com/maqroll))。
* macOS 上で Docker コンテナとして clickhouse-server を実行している場合に、Atomic データベースで DDL クエリの実行時に発生していた `Cannot rename ... errno: 22, strerror: Invalid argument` エラーを修正しました。 [#15024](https://github.com/ClickHouse/ClickHouse/pull/15024) ([tavplubix](https://github.com/tavplubix)).
* サブクエリに `finalizeAggregation` 関数が含まれている場合でも述語プッシュダウンが機能するように修正しました。 [#14847](https://github.com/ClickHouse/ClickHouse/issues/14847) を修正。 [#14937](https://github.com/ClickHouse/ClickHouse/pull/14937)（[filimonov](https://github.com/filimonov)）。
* 設定ファイルを `from_zk` インクルードオプションで ZK から取得する必要がある場合に、起動時に ZooKeeper と通信している間サーバーがハングする可能性がある問題を修正しました。これにより [#14814](https://github.com/ClickHouse/ClickHouse/issues/14814) が修正されます。[#14843](https://github.com/ClickHouse/ClickHouse/pull/14843)（[Alexander Kuzmenkov](https://github.com/akuzm)）。

#### 改善 {#improvement-7}

- `ALTER`クエリで`VersionedCollapsingMergeTree`のバージョンカラムの型を変更できるようになりました。[#15442](https://github.com/ClickHouse/ClickHouse/pull/15442) ([alesapin](https://github.com/alesapin))。

### ClickHouseリリース v20.9.2.20, 2020-09-22 {#clickhouse-release-v209220-2020-09-22}

#### 後方互換性のない変更 {#backward-incompatible-change-3}

- 20.5より古いバージョンからアップグレードする際、ローリングアップデートを実行し、クラスタに20.5以上と20.5未満のバージョンが混在している場合、古いバージョンのClickHouseノードを再起動すると、新しいバージョンが存在する状態で古いバージョンが起動し、`Part ... intersects previous part`エラーが発生する可能性があります。このエラーを防ぐには、まずすべてのクラスタノードに新しいclickhouse-serverパッケージをインストールしてから再起動を実行してください(これにより、clickhouse-serverの再起動時に新しいバージョンで起動します)。

#### 新機能 {#new-feature-3}

- カラム変換子`EXCEPT`、`REPLACE`、`APPLY`を追加しました。これらは選択されたカラムのリスト(`*`または`COLUMNS(...)`の後)に適用できます。例えば、`SELECT * EXCEPT(URL) REPLACE(number + 1 AS number)`と記述できます。別の例として、すべての文字列カラムの最大長を調べるために`select * apply(length) apply(max) from wide_string_table`を使用できます。[#14233](https://github.com/ClickHouse/ClickHouse/pull/14233) ([Amos Bird](https://github.com/amosbird))。
- 順位相関係数を計算する集約関数`rankCorr`を追加しました。[#11769](https://github.com/ClickHouse/ClickHouse/pull/11769) ([antikvist](https://github.com/antikvist)) [#14411](https://github.com/ClickHouse/ClickHouse/pull/14411) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- サブクエリをテーブルオブジェクトに変換するテーブル関数`view`を追加しました。これによりクエリの受け渡しが容易になります。例えば、remote/clusterテーブル関数で使用できます。[#12567](https://github.com/ClickHouse/ClickHouse/pull/12567) ([Amos Bird](https://github.com/amosbird))。

#### バグ修正 {#bug-fix-15}


* `ALTER UPDATE` のミューテーションで、代入式に Nullable 列と定数値（`UPDATE x = 42` のような）が含まれる場合に、列に誤った値が入ったりセグメンテーションフォルトが発生したりするバグを修正しました。[#13634](https://github.com/ClickHouse/ClickHouse/issues/13634)、[#14045](https://github.com/ClickHouse/ClickHouse/issues/14045) を解決します。[#14646](https://github.com/ClickHouse/ClickHouse/pull/14646)（[alesapin](https://github.com/alesapin)）。
* 結果列の小数スケールが誤っていたために `Decimal` の乗算結果が不正になる問題を修正しました。 [#14603](https://github.com/ClickHouse/ClickHouse/pull/14603) ([Artem Zuikov](https://github.com/4ertus2))。
* `Nullable` 列の誤ったソート順を修正しました。これにより [#14344](https://github.com/ClickHouse/ClickHouse/issues/14344) が解決されました。[#14495](https://github.com/ClickHouse/ClickHouse/pull/14495)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* `FixedString` 型の主キーを、より短い長さの文字列と比較した場合に、インデックス解析時の比較が一貫しない問題を修正しました。これにより [#14908](https://github.com/ClickHouse/ClickHouse/issues/14908) が修正されました。 [#15033](https://github.com/ClickHouse/ClickHouse/pull/15033) ([Amos Bird](https://github.com/amosbird))。
* テーブルに単一のパーツのみを含むパーティションが存在する場合に、誤ったマージの割り当てが行われる不具合を修正しました。 [#14444](https://github.com/ClickHouse/ClickHouse/pull/14444) ([alesapin](https://github.com/alesapin)).
* 関数 `bar` が特定の細工された引数で呼び出された場合に、バッファオーバーフローが発生する可能性がありました。これにより [#13926](https://github.com/ClickHouse/ClickHouse/issues/13926) がクローズされました。 [#15028](https://github.com/ClickHouse/ClickHouse/pull/15028) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 論理コアごとの CPU 周波数を `system.asynchronous_metrics` で公開するようにしました。これにより [#14923](https://github.com/ClickHouse/ClickHouse/issues/14923) が修正されました。 [#14924](https://github.com/ClickHouse/ClickHouse/pull/14924) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* `MaterializeMySQL` データベースエンジン使用時に発生する `.metadata.tmp File exists` エラーを修正しました。 [#14898](https://github.com/ClickHouse/ClickHouse/pull/14898) ([Winter Zhang](https://github.com/zhang2014)).
* `extractAllGroups` 関数の一部の呼び出しで「Memory limit exceeded」エラーが発生する可能性がある問題を修正しました。これにより [#13383](https://github.com/ClickHouse/ClickHouse/issues/13383) が解決されます。[#14889](https://github.com/ClickHouse/ClickHouse/pull/14889)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* StorageFile(fd) への INSERT を試行した際に発生する SIGSEGV を修正。 [#14887](https://github.com/ClickHouse/ClickHouse/pull/14887) ([Azat Khuzhin](https://github.com/azat)).
* `DEFAULT` 式を持つカラムが照会対象となっており、その `DEFAULT` が、同じく `DEFAULT` を持ちながら `SELECT` クエリに含まれず、ディスク上にも存在しない別のカラムに依存している場合にまれに発生する `SELECT` クエリのエラーを修正しました。[#14531](https://github.com/ClickHouse/ClickHouse/issues/14531) の一部を修正します。 [#14845](https://github.com/ClickHouse/ClickHouse/pull/14845) ([alesapin](https://github.com/alesapin))。
* 符号付き型に対する縮小 `Int -> Int` キャストでの単調性検出の誤りを修正しました。これにより、クエリ結果が誤ったものになる可能性がありました。このバグは [#14513](https://github.com/ClickHouse/ClickHouse/issues/14513) で明らかになりました。[#14783](https://github.com/ClickHouse/ClickHouse/pull/14783)（[Amos Bird](https://github.com/amosbird)）。
* `ALTER ... MODIFY QUERY` を実行した際に、マテリアライズドビューのメタデータで見落とされていたデフォルトデータベース名を修正しました。 [#14664](https://github.com/ClickHouse/ClickHouse/pull/14664) ([tavplubix](https://github.com/tavplubix)).
* LowCardinality 型および Nullable 型が関与する場合に、関数 `has` が誤った結果を返す可能性がある問題を修正しました。 [#14591](https://github.com/ClickHouse/ClickHouse/pull/14591) ([Mike](https://github.com/myrrc)).
* ReplicatedMergeTree エンジンのテーブルに対する CREATE クエリ実行中に ZooKeeper で例外が発生した場合に、データディレクトリをクリーンアップするようにしました。 [#14563](https://github.com/ClickHouse/ClickHouse/pull/14563) ([Bharat Nallan](https://github.com/bharatnc))。
* きわめて大きなパラメータによりオーバーフローが発生した場合に起こりうる、`-Resample` コンビネータ付き関数でのまれなセグメンテーションフォルトを修正しました。 [#14562](https://github.com/ClickHouse/ClickHouse/pull/14562) ([Anton Popov](https://github.com/CurtizJ)).
* `topK` 集約関数における配列サイズのオーバーフローをチェックするようにしました。\
  このチェックがない場合、ユーザーが巧妙に細工したパラメータでクエリを送信し、サーバークラッシュを引き起こす可能性があります。\
  これにより [#14452](https://github.com/ClickHouse/ClickHouse/issues/14452) が解決されました。 [#14467](https://github.com/ClickHouse/ClickHouse/pull/14467) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* SysVinit による restart/start/stop/reload を、（systemd が使用されている場合は）systemd に委譲するようにしました。 [#14460](https://github.com/ClickHouse/ClickHouse/pull/14460) ([Azat Khuzhin](https://github.com/azat)).
* `PipelineExecutor` 自体で例外が発生した場合にクエリ実行を停止するようにしました。これにより、まれに発生しうるクエリのハングを防止できます。 [#14334](https://github.com/ClickHouse/ClickHouse/pull/14334) [#14402](https://github.com/ClickHouse/ClickHouse/pull/14402) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `AS table_function` で作成されたテーブルに対する `ALTER` クエリの実行時に発生するクラッシュの問題を修正。[#14212](https://github.com/ClickHouse/ClickHouse/issues/14212) を修正。[#14326](https://github.com/ClickHouse/ClickHouse/pull/14326)（[alesapin](https://github.com/alesapin)）。
* REFRESH コマンドを使用した ALTER LIVE VIEW クエリの実行時に発生していた例外を修正しました。LIVE VIEW は実験的な機能です。 [#14320](https://github.com/ClickHouse/ClickHouse/pull/14320) ([Bharat Nallan](https://github.com/bharatnc))。
* ネストされたインタープリタを使用するクエリに対して、`EXPLAIN PIPELINE graph=1` 用の `QueryPlan` のライフタイムを修正しました。 [#14315](https://github.com/ClickHouse/ClickHouse/pull/14315) ([Azat Khuzhin](https://github.com/azat)).
* SSD キャッシュを利用する複合キー外部辞書において、タプルサイズのチェックを強化しました。これにより [#13981](https://github.com/ClickHouse/ClickHouse/issues/13981) が修正されました。 [#14313](https://github.com/ClickHouse/ClickHouse/pull/14313)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `ALIAS` カラム型での `CODEC` の使用を禁止。 [#13911](https://github.com/ClickHouse/ClickHouse/issues/13911) を修正。 [#14263](https://github.com/ClickHouse/ClickHouse/pull/14263)（[Bharat Nallan](https://github.com/bharatnc)）。
* グローバルレベル以外で実行された場合の `GRANT ALL` ステートメントの動作を修正しました。 [#13987](https://github.com/ClickHouse/ClickHouse/pull/13987) ([Vitaly Baranov](https://github.com/vitlibar)).
* lambda 内での arrayJoin() のキャプチャ処理を修正（論理エラーを示すメッセージ付きの例外がスローされていた）。 [#13792](https://github.com/ClickHouse/ClickHouse/pull/13792) ([Azat Khuzhin](https://github.com/azat)).

#### 実験的機能 {#experimental-feature-2}

- 指定されたSELECTクエリによるランダムなデータベース生成のための`db-generator`ツールを追加しました。ユーザーからの不完全なバグレポートしかない場合に、問題の再現を容易にします。[#14442](https://github.com/ClickHouse/ClickHouse/pull/14442) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)) [#10973](https://github.com/ClickHouse/ClickHouse/issues/10973) ([ZeDRoman](https://github.com/ZeDRoman))。

#### 改善 {#improvement-8}

- Distributedストレージでマルチボリュームストレージ構成の使用を許可しました。[#14839](https://github.com/ClickHouse/ClickHouse/pull/14839) ([Pavel Kovalenko](https://github.com/Jokser))。
- `toStartOf*`タイプの関数で空のtime_zone引数を禁止しました。[#14509](https://github.com/ClickHouse/ClickHouse/pull/14509) ([Bharat Nallan](https://github.com/bharatnc))。
- MySQLハンドラは`SET @@var = value`のようなクエリに対して`OK`を返すようになりました。このようなステートメントは無視されます。これは、一部のMySQLドライバがハンドシェイク後のセットアップのために`SET @@`クエリを送信するために必要です https://github.com/ClickHouse/ClickHouse/issues/9336#issuecomment-686222422 。[#14469](https://github.com/ClickHouse/ClickHouse/pull/14469) ([BohuTANG](https://github.com/BohuTANG))。
- 以前にマテリアライズされていなかった場合、マージ中にTTLが適用されるようになりました。[#14438](https://github.com/ClickHouse/ClickHouse/pull/14438) ([alesapin](https://github.com/alesapin))。
- [#13163](https://github.com/ClickHouse/ClickHouse/issues/13163)で提案されたように、`clickhouse-obfuscator`がUUID型をサポートするようになりました。[#14409](https://github.com/ClickHouse/ClickHouse/pull/14409) ([dimarub2000](https://github.com/dimarub2000))。
- [#11384](https://github.com/ClickHouse/ClickHouse/issues/11384)で提案されたように、新しい設定`system_events_show_zero_values`を追加しました。[#14404](https://github.com/ClickHouse/ClickHouse/pull/14404) ([dimarub2000](https://github.com/dimarub2000))。
- `MaterializeMySQL`でプライマリキーを暗黙的にnot nullに変換するようにしました(`MySQL`と同様)。[#14114](https://github.com/ClickHouse/ClickHouse/issues/14114)を修正しました。[#14397](https://github.com/ClickHouse/ClickHouse/pull/14397) ([Winter Zhang](https://github.com/zhang2014))。
- boost multiprecisionの広整数(256ビット)をhttps://github.com/cerevra/intの実装に置き換えました。256ビット整数は実験的機能です。[#14229](https://github.com/ClickHouse/ClickHouse/pull/14229) ([Artem Zuikov](https://github.com/4ertus2))。
- `system.part_log`のパーツに対して`default_compression_codec`という名前のデフォルト圧縮コーデックを追加しました。[#14116](https://github.com/ClickHouse/ClickHouse/pull/14116) ([alesapin](https://github.com/alesapin))。
- `DateTime`型に精度引数を追加しました。これにより、`DateTime64`の代わりに`DateTime`という名前を使用できるようになります。[#13761](https://github.com/ClickHouse/ClickHouse/pull/13761) ([Winter Zhang](https://github.com/zhang2014))。
- `Redis`外部ディクショナリにrequirepass認証を追加しました。[#13688](https://github.com/ClickHouse/ClickHouse/pull/13688) ([Ivan Torgashov](https://github.com/it1804))。
- `RabbitMQ`エンジンの改善:接続とチャネルの障害処理、適切なコミット、挿入失敗の処理、改善されたエクスチェンジ、キューの永続性とキュー再開機能、新しいキュー設定を追加しました。テストを修正しました。[#12761](https://github.com/ClickHouse/ClickHouse/pull/12761) ([Kseniia Sumarokova](https://github.com/kssenii))。
- コンパクトパーツでカスタムコーデックをサポートしました。[#12183](https://github.com/ClickHouse/ClickHouse/pull/12183) ([Anton Popov](https://github.com/CurtizJ))。

#### パフォーマンス改善 {#performance-improvement-4}


- `optimize_skip_unused_shards`および`optimize_distributed_group_by_sharding_key`の設定下で、GROUP BY sharding_keyを使用した分散クエリにおけるLIMIT/LIMIT BY/ORDER BYを最適化。[#10373](https://github.com/ClickHouse/ClickHouse/pull/10373) ([Azat Khuzhin](https://github.com/azat))。
- 複数の`JOIN`および`IN`に対するセットを並列作成。複数の異なる`IN subquery`式を含むクエリのパフォーマンスがわずかに向上する可能性があります。[#14412](https://github.com/ClickHouse/ClickHouse/pull/14412) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 各コンシューマーに独立したスレッドを提供することでKafkaエンジンのパフォーマンスを向上。ストリーミングエンジン(Kafkaなど)用の独立したスレッドプール。[#13939](https://github.com/ClickHouse/ClickHouse/pull/13939) ([fastio](https://github.com/fastio))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-6}

- `Functions`からデバッグ情報を削除することでデバッグビルドのバイナリサイズを削減。これは非常に古いリンカーを使用しているYandexの1つの内部プロジェクトにのみ必要です。[#14549](https://github.com/ClickHouse/ClickHouse/pull/14549) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- clang 11でのビルドに向けた準備。[#14455](https://github.com/ClickHouse/ClickHouse/pull/14455) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- バックポートスクリプトのロジックを修正。以前のバージョンでは、100%赤色のラベルに対してトリガーされていました。これは奇妙な動作でした。[#14433](https://github.com/ClickHouse/ClickHouse/pull/14433) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 統合テストはデフォルトのベース設定を使用。すべての設定変更は、インスタンスのmain_configs、user_configs、dictionariesパラメータで明示的に指定されます。[#13647](https://github.com/ClickHouse/ClickHouse/pull/13647) ([Ilya Yatsishin](https://github.com/qoega))。


## ClickHouseリリース 20.8 {#clickhouse-release-208}

### ClickHouseリリース v20.8.12.2-lts, 2021-01-16 {#clickhouse-release-v208122-lts-2021-01-16}

#### バグ修正 {#bug-fix-16}

- 単項関数とNullable型を使用した\*Ifコンビネータを修正。[#18806](https://github.com/ClickHouse/ClickHouse/pull/18806) ([Azat Khuzhin](https://github.com/azat))。
- ワイドパートからコンパクトパートへのマージを制限。垂直マージの場合、結果パートが破損する原因となっていました。[#18381](https://github.com/ClickHouse/ClickHouse/pull/18381) ([Anton Popov](https://github.com/CurtizJ))。

### ClickHouseリリース v20.8.11.17-lts, 2020-12-25 {#clickhouse-release-v2081117-lts-2020-12-25}

#### バグ修正 {#bug-fix-17}

- マージ中のAIOによる書き込みを無効化。マージ時にプライマリキー列の極めて稀なデータ破損を引き起こす可能性があるためです。[#18481](https://github.com/ClickHouse/ClickHouse/pull/18481) ([alesapin](https://github.com/alesapin))。
- `Nullable(String)`型の引数を使用して`toType(...)`関数（`toDate`、`toUInt32`など）を実行する際の`value is too short`エラーを修正。これらの関数は、解析エラー時に例外をスローする代わりに`NULL`を返すようになりました。[#7673](https://github.com/ClickHouse/ClickHouse/issues/7673)を修正。[#18445](https://github.com/ClickHouse/ClickHouse/pull/18445) ([tavplubix](https://github.com/tavplubix))。
- 2レベル集約を使用する際の`Distinct`コンビネータを持つ集約関数における潜在的なクラッシュを修正。[#17682](https://github.com/ClickHouse/ClickHouse/issues/17682)を修正。[#18365](https://github.com/ClickHouse/ClickHouse/pull/18365) ([Anton Popov](https://github.com/CurtizJ))。

### ClickHouseリリース v20.8.10.13-lts, 2020-12-24 {#clickhouse-release-v2081013-lts-2020-12-24}

#### バグ修正 {#bug-fix-18}


* `logger.size` パラメータに 2^32 より大きい数値を設定してサーバーログのローテーションを構成した場合、ログのローテーションが正しく行われませんでした。 [#17905](https://github.com/ClickHouse/ClickHouse/pull/17905) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* MergeTreeWriterSettings において、`max_compress_block_size` を `min_compress_block_size` で誤って初期化していた問題を修正しました。 [#17833](https://github.com/ClickHouse/ClickHouse/pull/17833) ([flynn](https://github.com/ucasFL))。
* ClickHouse が MySQL サーバーへの接続再開に失敗する問題を修正しました。 [#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz)).
* 対応するミューテーションが別のレプリカ上で kill された場合に `ALTER` クエリがハングする問題を修正しました。これにより [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953) が解決されています。 [#17499](https://github.com/ClickHouse/ClickHouse/pull/17499) ([alesapin](https://github.com/alesapin))。
* マークを含む小さなファイルが多数存在する場合に、ClickHouse がマークキャッシュのサイズを過小に見積もってしまう不具合を修正しました。 [#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin))。
* `optimize_redundant_functions_in_order_by` 設定を有効にした際の `ORDER BY` 句の動作を修正しました。 [#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* クラッシュを引き起こしていた `ColumnConst` の比較処理を修正しました。これにより [#17088](https://github.com/ClickHouse/ClickHouse/issues/17088) が解決されました。[#17135](https://github.com/ClickHouse/ClickHouse/pull/17135)（[Amos Bird](https://github.com/amosbird)）。
* `ON CLUSTER` クエリが、リーダーでない ReplicatedMergeTree テーブルに対して無期限に待ち状態のままになる可能性があったバグを修正しました。 [#17089](https://github.com/ClickHouse/ClickHouse/pull/17089) ([alesapin](https://github.com/alesapin)).
* `LIMIT` を含むクエリのように、実行中にキャンセルされる可能性があるリモートクエリに対して、不要なネットワークエラーの発生を回避します。 [#17006](https://github.com/ClickHouse/ClickHouse/pull/17006) ([Azat Khuzhin](https://github.com/azat)).
* エラー発生時に `format_avro_schema_registry_url` の IP アドレスを再解決するようにしました。 [#16985](https://github.com/ClickHouse/ClickHouse/pull/16985) ([filimonov](https://github.com/filimonov)).
* `ALTER TABLE ... MODIFY COLUMN ... NewType` の後、`SELECT` が変更対象のカラムに対する `WHERE` 句を含み、`ALTER` がまだ完了していない場合に発生する可能性があったサーバークラッシュを修正しました。 [#16968](https://github.com/ClickHouse/ClickHouse/pull/16968) ([Amos Bird](https://github.com/amosbird)).
* インストールスクリプトは、常に設定ディレクトリ内にサブディレクトリを作成する必要があります。これはカスタム設定を用いた Docker ビルドにのみ関連します。 [#16936](https://github.com/ClickHouse/ClickHouse/pull/16936) ([filimonov](https://github.com/filimonov)).
* `ORDER BY` を含むクエリで発生する可能性のあった `Illegal type of argument` エラーを修正しました。 [#16580](https://github.com/ClickHouse/ClickHouse/issues/16580)。 [#16928](https://github.com/ClickHouse/ClickHouse/pull/16928)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* WriteBufferFromS3 にデータが書き込まれなかった場合、マルチパートアップロードを中止するようにしました。 [#16840](https://github.com/ClickHouse/ClickHouse/pull/16840) ([Pavel Kovalenko](https://github.com/Jokser)).
* 引数を指定せずに `any` を使用した際にクラッシュする不具合を修正しました。これにより [#16803](https://github.com/ClickHouse/ClickHouse/issues/16803) が解決されています。[#16826](https://github.com/ClickHouse/ClickHouse/pull/16826)（[Amos Bird](https://github.com/amosbird)）。
* `transform_null_in` 設定有効時における、複数の列およびタプルに対する `IN` 演算子の動作を修正しました。 [#15310](https://github.com/ClickHouse/ClickHouse/issues/15310) を修正。 [#16722](https://github.com/ClickHouse/ClickHouse/pull/16722)（[Anton Popov](https://github.com/CurtizJ)）。
* `max_threads` &gt; 0 かつ ORDER BY 句に式が含まれる場合における `optimize_read_in_order/optimize_aggregation_in_order` の不整合な動作を修正しました。 [#16637](https://github.com/ClickHouse/ClickHouse/pull/16637) ([Azat Khuzhin](https://github.com/azat)).
* クエリに `ARRAY JOIN` が含まれている場合に、クエリ最適化によって誤った結果が生成される不具合を修正しました。 [#17887](https://github.com/ClickHouse/ClickHouse/pull/17887) ([sundyli](https://github.com/sundy-li)).
* 例外が発生した場合、クエリをより早く終了します。例外発生時にはリモートレプリカでの実行をキャンセルします。 [#15578](https://github.com/ClickHouse/ClickHouse/pull/15578) ([Azat Khuzhin](https://github.com/azat)).

### ClickHouse release v20.8.6.6-lts, 2020-11-13 {#clickhouse-release-v20866-lts-2020-11-13}

#### バグ修正 {#bug-fix-19}

- クエリプロファイラが有効で、一部の関数に対して非同期アンワインドテーブルが破損している(と推定される)glibcバージョンを持つOSにClickHouseがインストールされている場合に発生する稀なサイレントクラッシュを修正しました。これにより[#15301](https://github.com/ClickHouse/ClickHouse/issues/15301)が修正されます。これにより[#13098](https://github.com/ClickHouse/ClickHouse/issues/13098)が修正されます。[#16846](https://github.com/ClickHouse/ClickHouse/pull/16846) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 入力からAVROを解析する際に、型からLowCardinalityが削除されるようになりました。[#16188](https://github.com/ClickHouse/ClickHouse/issues/16188)を修正します。[#16521](https://github.com/ClickHouse/ClickHouse/pull/16521) ([Mike](https://github.com/myrrc))。
- MySQL Master -> MySQL Slave -> ClickHouse MaterializeMySQL Engineを使用し、MySQL Slaveで`slave_parallel_worker`が有効になっている場合のメタデータの急速な増加を、GTIDセットを適切に縮小することで修正しました。これにより[#15951](https://github.com/ClickHouse/ClickHouse/issues/15951)が修正されます。[#16504](https://github.com/ClickHouse/ClickHouse/pull/16504) ([TCeason](https://github.com/TCeason))。
- Distributedテーブルに対するDROP TABLE(INSERTとの競合状態)を修正しました。[#16409](https://github.com/ClickHouse/ClickHouse/pull/16409) ([Azat Khuzhin](https://github.com/azat))。
- レプリケーションキュー内の非常に大きなエントリの処理を修正しました。テーブル構造が極端に大きい場合(1MB近く)、ALTERクエリで非常に大きなエントリが出現する可能性があります。これにより[#16307](https://github.com/ClickHouse/ClickHouse/issues/16307)が修正されます。[#16332](https://github.com/ClickHouse/ClickHouse/pull/16332) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- フィルタリング用のセットが作成されていないために返却データの一部がドロップされる可能性がある不整合な動作を修正しました。[#16308](https://github.com/ClickHouse/ClickHouse/pull/16308) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- MySQLデータベースに関するバグを修正しました。データベースエンジンとして使用されているMySQLサーバーがダウンしている場合、一部のクエリが例外を発生させていました。これは、不要であるにもかかわらず無効化されたサーバーからテーブルを取得しようとするためです。例えば、`SELECT ... FROM system.parts`クエリはMergeTreeテーブルのみで動作すべきであり、MySQLデータベースには一切アクセスすべきではありません。[#16032](https://github.com/ClickHouse/ClickHouse/pull/16032) ([Kruglov Pavel](https://github.com/Avogar))。

### ClickHouse release v20.8.5.45-lts, 2020-10-29 {#clickhouse-release-v208545-lts-2020-10-29}

#### バグ修正 {#bug-fix-20}


* 関数 `dictGet` で例外が発生した場合の二重解放を修正しました。これは、辞書の読み込み時にエラーが発生していた場合に起こり得ました。 [#16429](https://github.com/ClickHouse/ClickHouse/pull/16429) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `GROUP BY` 句で `TOTALS` / `ROLLUP` / `CUBE` 修飾子と、グループキーを対象とする `min` / `max` 関数を併用した場合に発生する問題を修正しました。 [#16393](https://github.com/ClickHouse/ClickHouse/issues/16393) を解決。 [#16397](https://github.com/ClickHouse/ClickHouse/pull/16397)（[Anton Popov](https://github.com/CurtizJ)）。
* prefer&#95;localhost&#95;replica=0 および internal&#95;replication 使用時の非同期 Distributed INSERT を修正。 [#16358](https://github.com/ClickHouse/ClickHouse/pull/16358) ([Azat Khuzhin](https://github.com/azat)).
* `TwoLevelStringHashTable` の実装における不具合が原因で、文字列キーを伴う `GROUP BY` 実行時に発生する可能性のあるメモリリークを修正しました。 [#16264](https://github.com/ClickHouse/ClickHouse/pull/16264) ([Amos Bird](https://github.com/amosbird))。
* メモリが上限を無視して過剰に割り当てられてしまうケースを修正しました。これにより [#14560](https://github.com/ClickHouse/ClickHouse/issues/14560) が解決されます。[#16206](https://github.com/ClickHouse/ClickHouse/pull/16206)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `ReplicatedVersionedCollapsingMergeTree` に対する `ALTER MODIFY ... ORDER BY` クエリがハングする問題を修正しました。これにより [#15980](https://github.com/ClickHouse/ClickHouse/issues/15980) が解決されました。 [#16011](https://github.com/ClickHouse/ClickHouse/pull/16011) ([alesapin](https://github.com/alesapin))。
* `collate` 名および `charset` 名のパーサーを修正し、文字列型における `length = 0` をサポート。 [#16008](https://github.com/ClickHouse/ClickHouse/pull/16008) ([Winter Zhang](https://github.com/zhang2014)).
* 複合キーを持つディクショナリで direct レイアウトを使用できるようにしました。 [#16007](https://github.com/ClickHouse/ClickHouse/pull/16007) ([Anton Popov](https://github.com/CurtizJ)).
* 一定期間のアイドル状態の後にレプリケーションエラーが発生した場合、レプリカが 5～10 分間ハングすることを防止しました。 [#15987](https://github.com/ClickHouse/ClickHouse/pull/15987) ([filimonov](https://github.com/filimonov)).
* Atomic データベースエンジンにおいて、MaterializedView への INSERT または MaterializedView からの SELECT と対象テーブルの DROP が同時に行われた場合にまれに発生するセグメンテーションフォルトを修正。 [#15984](https://github.com/ClickHouse/ClickHouse/pull/15984) ([tavplubix](https://github.com/tavplubix)).
* 設定プロファイルの解析における曖昧さを修正しました。`CREATE USER ... SETTINGS profile readonly` は、readonly 制約付きの設定 `profile` を使用しているのではなく、`readonly` という名前のプロファイルを使用していると解釈されるようになりました。これにより、[#15628](https://github.com/ClickHouse/ClickHouse/issues/15628) が修正されました。[#15982](https://github.com/ClickHouse/ClickHouse/pull/15982)（[Vitaly Baranov](https://github.com/vitlibar)）。
* データベース作成に失敗した際に発生するクラッシュを修正。 [#15954](https://github.com/ClickHouse/ClickHouse/pull/15954) ([Winter Zhang](https://github.com/zhang2014)).
* Atomic データベースエンジンにおいて、テーブルが同時にリネームされている場合に `DROP TABLE IF EXISTS` が `Table ... does not exist` エラーで失敗する問題を修正しました。複数テーブルに対して `DROP DATABASE` や `RENAME TABLE` などの DDL クエリを同時に実行した際に、まれに発生するデッドロックを修正しました。同時に `DROP/DETACH TABLE` を実行しているときに、`DROP/DETACH DATABASE` が `Table ... does not exist` エラーで失敗する問題を修正しました。[#15934](https://github.com/ClickHouse/ClickHouse/pull/15934) ([tavplubix](https://github.com/tavplubix))。
* `WHERE`、`PREWHERE`、`GLOBAL IN` を含むクエリで `Distributed` テーブルを参照した際に、誤って空の結果が返されてしまう問題を修正しました。 [#15792](https://github.com/ClickHouse/ClickHouse/issues/15792) を修正。 [#15933](https://github.com/ClickHouse/ClickHouse/pull/15933) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* RBAC においてデッドロックが発生し得る問題を修正しました。 [#15875](https://github.com/ClickHouse/ClickHouse/pull/15875) ([Vitaly Baranov](https://github.com/vitlibar))。
* `ALTER MODIFY COLUMN` クエリの後に実行された `SELECT ... ORDER BY DESC` クエリで発生していた `Block structure mismatch` という例外を修正しました。 [#15800](https://github.com/ClickHouse/ClickHouse/issues/15800) を修正。 [#15852](https://github.com/ClickHouse/ClickHouse/pull/15852)（[alesapin](https://github.com/alesapin)）。
* 仮想カラムのみが選択されているクエリのいくつかのケースを修正しました。以前は `Not found column _nothing in block` という例外がスローされることがありました。[#12298](https://github.com/ClickHouse/ClickHouse/issues/12298) を修正。 [#15756](https://github.com/ClickHouse/ClickHouse/pull/15756)（[Anton Popov](https://github.com/CurtizJ)）。
* `ARRAY JOIN` を含む `MV` のクエリにより、`MATERIALIZED VIEW` への挿入時に発生する可能性がある `Cannot find column` エラーを修正しました。 [#15717](https://github.com/ClickHouse/ClickHouse/pull/15717) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `max_replicated_logs_to_keep` 設定のデフォルト値が低すぎる問題を修正しました。これにより、レプリカが頻繁に失われる原因となっていました。最も新しいレプリカをクローン元として選択することで、失われたレプリカの復旧プロセスを改善しました。また、失われたレプリカから古いパートを削除せず、代わりに detach するようにしました。 [#15701](https://github.com/ClickHouse/ClickHouse/pull/15701) ([tavplubix](https://github.com/tavplubix)).
* 宛先テーブルとは異なる構造を持つ `Buffer` テーブルからの読み取り中に発生していたエラー `Cannot add simple transform to empty Pipe` を修正しました。このエラーは、クエリに対して宛先テーブルが空の結果を返した場合に発生する可能性がありました。 [#15529](https://github.com/ClickHouse/ClickHouse/issues/15529) を修正しました。 [#15662](https://github.com/ClickHouse/ClickHouse/pull/15662)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* S3テーブル関数におけるグロブのバグを修正しました。URL から取得したリージョンが S3 クライアントの設定に反映されていませんでした。 [#15646](https://github.com/ClickHouse/ClickHouse/pull/15646) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 読み取り専用テーブルをデタッチする際に `ReadonlyReplica` メトリクスを減少させます。これにより [#15598](https://github.com/ClickHouse/ClickHouse/issues/15598) が修正されました。[#15592](https://github.com/ClickHouse/ClickHouse/pull/15592)（[sundyli](https://github.com/sundy-li)）。
* ReplicatedMergeTree に単一のパラメータが渡された場合、それを無視するのではなくエラーをスローするようにしました。 [#15516](https://github.com/ClickHouse/ClickHouse/pull/15516) ([nvartolomei](https://github.com/nvartolomei)).

#### 改善 {#improvement-9}

- クラスタ設定の`<internal_replication>`設定に関わらず、`ALTER ... ON CLUSTER`クエリを実行できるようになりました。[#16075](https://github.com/ClickHouse/ClickHouse/pull/16075) ([alesapin](https://github.com/alesapin))。
- テーブル作成時に`ReplicatedMergeTree`の引数内の`{database}`、`{table}`、`{uuid}`マクロを展開するようになりました。[#16159](https://github.com/ClickHouse/ClickHouse/pull/16159) ([tavplubix](https://github.com/tavplubix))。

### ClickHouseリリース v20.8.4.11-lts, 2020-10-09 {#clickhouse-release-v208411-lts-2020-10-09}

#### バグ修正 {#bug-fix-21}


* クエリプランの `ReadFromStorage` ステップにおけるリソースの破棄順序を修正しました。まれなケースでクラッシュを引き起こす原因となっていました。[#15610](https://github.com/ClickHouse/ClickHouse/issues/15610) と関連している可能性があります。[#15645](https://github.com/ClickHouse/ClickHouse/pull/15645)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `VALUES`、`LIMIT`、または `IN` 演算子の右辺で `JSON*` 関数の結果を使用した際に発生していた `Element ... is not a constant expression` エラーを修正しました。 [#15589](https://github.com/ClickHouse/ClickHouse/pull/15589) ([tavplubix](https://github.com/tavplubix)).
* エラーメッセージ `Could not calculate available disk space (statvfs), errno: 4, strerror: Interrupted system call` が発生しないようにしました。これにより [#15541](https://github.com/ClickHouse/ClickHouse/issues/15541) が修正されます。[#15557](https://github.com/ClickHouse/ClickHouse/pull/15557)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* AggregatingInOrderTransform/optimize&#95;aggregation&#95;in&#95;order におけるメモリ使用量を大幅に削減しました。 [#15543](https://github.com/ClickHouse/ClickHouse/pull/15543) ([Azat Khuzhin](https://github.com/azat)).
* `MOVE` または `REPLACE PARTITION` の後、あるいはまれなケースとして `DETACH` または `DROP PARTITION` の後に、存在しないパーツを待ち続けることでミューテーションがハングする可能性がありました。この問題を修正しました。 [#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix))。
* 同じパターンで `LIKE` を実行した後に、`ILIKE` 演算子が大文字小文字を区別するようになってしまうバグを修正。 [#15536](https://github.com/ClickHouse/ClickHouse/pull/15536) ([alesapin](https://github.com/alesapin)).
* データに存在しない列で、同じくデータに存在しない別の列に依存している列を選択した際に発生する `Missing columns` エラーを修正。 [#15530](https://github.com/ClickHouse/ClickHouse/issues/15530) を修正。 [#15532](https://github.com/ClickHouse/ClickHouse/pull/15532) ([alesapin](https://github.com/alesapin))。
* DDLWorker におけるイベントサブスクリプションのバグを修正しました。これにより、まれに `ON CLUSTER` でクエリがハングする可能性がありました。このバグは [#13450](https://github.com/ClickHouse/ClickHouse/issues/13450) で導入されました。[#15477](https://github.com/ClickHouse/ClickHouse/pull/15477)（[alesapin](https://github.com/alesapin)）。
* `boundingRatio` 集約関数の第 2 引数の型が誤っている場合に、適切なエラーを返すようにしました。 [#15407](https://github.com/ClickHouse/ClickHouse/pull/15407) ([detailyang](https://github.com/detailyang)).
* MergeTree テーブルのリネームとバックグラウンドクリーンアップの間に発生するレースコンディションを修正。 [#15304](https://github.com/ClickHouse/ClickHouse/pull/15304) ([alesapin](https://github.com/alesapin)).
* `system.logs` が有効な場合に、サーバー起動時にまれに発生していたレースコンディションを修正。 [#15300](https://github.com/ClickHouse/ClickHouse/pull/15300) ([alesapin](https://github.com/alesapin)).
* QueryLog に関する MSan の指摘を修正。フィールド `memory_usage` で未初期化メモリが使用されてしまう可能性がありました。[#15258](https://github.com/ClickHouse/ClickHouse/pull/15258) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* LowCardinality 型で joinGet を使用した際にインスタンスがクラッシュする問題を修正。これにより [#15214](https://github.com/ClickHouse/ClickHouse/issues/15214) が修正されます。[#15220](https://github.com/ClickHouse/ClickHouse/pull/15220)（[Amos Bird](https://github.com/amosbird)）。
* テーブルエンジン `Buffer` において、`ALTER` クエリ実行後に新しい構造のデータを `Buffer` に挿入できなくなっていたバグを修正しました。[#15117](https://github.com/ClickHouse/ClickHouse/issues/15117) を修正。[#15192](https://github.com/ClickHouse/ClickHouse/pull/15192)（[alesapin](https://github.com/alesapin)）。
* MySQL のカラム定義パケット内における decimals フィールドのサイズを調整。 [#15152](https://github.com/ClickHouse/ClickHouse/pull/15152) ([maqroll](https://github.com/maqroll)).
* 既に String と FixedString 間のパディング付き比較（[https://github.com/ClickHouse/ClickHouse/blob/master/src/Functions/FunctionsComparison.h#L333](https://github.com/ClickHouse/ClickHouse/blob/master/src/Functions/FunctionsComparison.h#L333)）を使用しています。この PR は同じロジックをフィールド比較にも適用し、FixedString をプライマリキーとして使用する場合の挙動を修正します。これにより [#14908](https://github.com/ClickHouse/ClickHouse/issues/14908) が解決されます。[#15033](https://github.com/ClickHouse/ClickHouse/pull/15033)（[Amos Bird](https://github.com/amosbird)）。
* 関数 `bar` が特別に細工された引数で呼び出された場合、バッファオーバーフローが発生する可能性がありました。これにより [#13926](https://github.com/ClickHouse/ClickHouse/issues/13926) が解決されました。 [#15028](https://github.com/ClickHouse/ClickHouse/pull/15028)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* Mac OS 上の docker で clickhouse-server を実行している場合に、Atomic データベースでの DDL クエリ実行時に発生していた `Cannot rename ... errno: 22, strerror: Invalid argument` エラーを修正しました。 [#15024](https://github.com/ClickHouse/ClickHouse/pull/15024) ([tavplubix](https://github.com/tavplubix)).
* `number_of_free_entries_in_pool_to_execute_mutation` および `number_of_free_entries_in_pool_to_lower_max_size_of_merge` の設定は、`background_pool_size` と同じ値にできるようになりました。 [#14975](https://github.com/ClickHouse/ClickHouse/pull/14975) ([alesapin](https://github.com/alesapin)).
* `finalizeAggregation` 関数を含む `subquery` で `predicate push down`（述語プッシュダウン）が機能するように修正しました。 [#14847](https://github.com/ClickHouse/ClickHouse/issues/14847) を修正。 [#14937](https://github.com/ClickHouse/ClickHouse/pull/14937)（[filimonov](https://github.com/filimonov)）。
* `system.asynchronous_metrics` 内で論理 CPU コアごとの CPU 周波数を公開します。これにより [#14923](https://github.com/ClickHouse/ClickHouse/issues/14923) が修正されました。 [#14924](https://github.com/ClickHouse/ClickHouse/pull/14924) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* `MaterializeMySQL` データベースエンジン使用時に `.metadata.tmp File exists` エラーが発生する問題を修正しました。 [#14898](https://github.com/ClickHouse/ClickHouse/pull/14898) ([Winter Zhang](https://github.com/zhang2014)).
* `from_zk` include オプションを使用して設定ファイルを ZK から取得する必要がある場合に、サーバーが ZooKeeper との通信中に起動時にハングする可能性がある問題を修正しました。これにより [#14814](https://github.com/ClickHouse/ClickHouse/issues/14814) の問題が修正されました。 [#14843](https://github.com/ClickHouse/ClickHouse/pull/14843) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* 符号付き型に対する縮小方向の `Int -> Int` キャストにおける誤った単調性検出を修正しました。これにより、クエリ結果が不正確になる可能性がありました。このバグは [#14513](https://github.com/ClickHouse/ClickHouse/issues/14513) で発見されました。[#14783](https://github.com/ClickHouse/ClickHouse/pull/14783)（[Amos Bird](https://github.com/amosbird)）。
* `Nullable` 列の誤ったソート順を修正しました。これにより [#14344](https://github.com/ClickHouse/ClickHouse/issues/14344) が解決されました。[#14495](https://github.com/ClickHouse/ClickHouse/pull/14495)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。

#### 改善 {#improvement-10}

- `ALTER`クエリを使用して`VersionedCollapsingMergeTree`のバージョン列の型を変更できるようになりました。[#15442](https://github.com/ClickHouse/ClickHouse/pull/15442) ([alesapin](https://github.com/alesapin))。

### ClickHouseリリース v20.8.3.18-stable、2020-09-18 {#clickhouse-release-v208318-stable-2020-09-18}

#### バグ修正 {#bug-fix-22}

- `extractAllGroups`関数の一部の呼び出しで「メモリ制限超過」エラーが発生する問題を修正しました。これにより[#13383](https://github.com/ClickHouse/ClickHouse/issues/13383)が修正されます。[#14889](https://github.com/ClickHouse/ClickHouse/pull/14889) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- StorageFile(fd)へのINSERT試行時のSIGSEGVを修正しました。[#14887](https://github.com/ClickHouse/ClickHouse/pull/14887) ([Azat Khuzhin](https://github.com/azat))。
- クエリ対象の列が`DEFAULT`式を持ち、その式が別の`DEFAULT`を持つ列に依存しており、そのカラムがselectクエリに存在せず、ディスク上にも存在しない場合に発生する`SELECT`クエリの稀なエラーを修正しました。[#14531](https://github.com/ClickHouse/ClickHouse/issues/14531)を部分的に修正します。[#14845](https://github.com/ClickHouse/ClickHouse/pull/14845) ([alesapin](https://github.com/alesapin))。
- `ALTER ... MODIFY QUERY`実行時にマテリアライズドビューのメタデータでデフォルトデータベース名が欠落する問題を修正しました。[#14664](https://github.com/ClickHouse/ClickHouse/pull/14664) ([tavplubix](https://github.com/tavplubix))。
- 代入式にNullable列と定数値(例:`UPDATE x = 42`)を使用した`ALTER UPDATE`ミューテーションが列の不正な値やセグメンテーション違反を引き起こすバグを修正しました。[#13634](https://github.com/ClickHouse/ClickHouse/issues/13634)、[#14045](https://github.com/ClickHouse/ClickHouse/issues/14045)を修正します。[#14646](https://github.com/ClickHouse/ClickHouse/pull/14646) ([alesapin](https://github.com/alesapin))。
- 結果列の誤った小数点以下桁数によって引き起こされる誤ったDecimal乗算結果を修正しました。[#14603](https://github.com/ClickHouse/ClickHouse/pull/14603) ([Artem Zuikov](https://github.com/4ertus2))。
- `lc->isNullable()`の呼び出しも`ls->getDictionaryPtr()->isNullable()`の呼び出しも正しい結果を返さないため、チェッカーを追加しました。[#14591](https://github.com/ClickHouse/ClickHouse/pull/14591) ([myrrc](https://github.com/myrrc))。
- StorageReplicatedMergeTreeエンジンのCreateQuery中にZookeeper例外が発生した後、データディレクトリをクリーンアップするようにしました。[#14563](https://github.com/ClickHouse/ClickHouse/pull/14563) ([Bharat Nallan](https://github.com/bharatnc))。
- 非常に大きなパラメータによるオーバーフローの結果として発生する可能性がある、-Resampleコンビネータを持つ関数での稀なセグメンテーション違反を修正しました。[#14562](https://github.com/ClickHouse/ClickHouse/pull/14562) ([Anton Popov](https://github.com/CurtizJ))。

#### 改善 {#improvement-11}

- 進行中のS3リクエストがある場合のサーバーシャットダウンプロセスを高速化しました。[#14858](https://github.com/ClickHouse/ClickHouse/pull/14858) ([Pavel Kovalenko](https://github.com/Jokser))。
- Distributedストレージでマルチボリュームストレージ構成の使用を許可しました。[#14839](https://github.com/ClickHouse/ClickHouse/pull/14839) ([Pavel Kovalenko](https://github.com/Jokser))。
- 進行中のS3リクエストがある場合のサーバーシャットダウンプロセスを高速化しました。[#14496](https://github.com/ClickHouse/ClickHouse/pull/14496) ([Pavel Kovalenko](https://github.com/Jokser))。
- コンパクトパートでカスタムコーデックをサポートしました。[#12183](https://github.com/ClickHouse/ClickHouse/pull/12183) ([Anton Popov](https://github.com/CurtizJ))。

### ClickHouseリリース v20.8.2.3-stable、2020-09-08 {#clickhouse-release-v20823-stable-2020-09-08}

#### 後方互換性のない変更 {#backward-incompatible-change-4}


- `OPTIMIZE FINAL`クエリは、TTL作成前に追加されたパーツに対してTTLを再計算しなくなりました。一度`ALTER TABLE ... MATERIALIZE TTL`を使用してそれらを計算した後、`OPTIMIZE FINAL`はTTLを適切に評価します。この動作はレプリケートされたテーブルでは機能しませんでした。[#14220](https://github.com/ClickHouse/ClickHouse/pull/14220) ([alesapin](https://github.com/alesapin))。
- `parallel_distributed_insert_select`設定を拡張し、ローカルテーブルへの`INSERT`を実行するオプションを追加しました。この設定の型が`Bool`から`UInt64`に変更されたため、`false`と`true`の値はサポートされなくなりました。サーバー設定にこれらの値がある場合、サーバーは起動しません。それぞれ`0`と`1`に置き換えてください。[#14060](https://github.com/ClickHouse/ClickHouse/pull/14060) ([Azat Khuzhin](https://github.com/azat))。
- `ODBCDriver`入出力フォーマットのサポートを削除しました。これはClickHouse ODBCドライバーとの通信に使用されていた非推奨のフォーマットで、現在は`ODBCDriver2`フォーマットに完全に置き換えられています。[#13629](https://github.com/ClickHouse/ClickHouse/issues/13629)を解決します。[#13847](https://github.com/ClickHouse/ClickHouse/pull/13847) ([hexiaoting](https://github.com/hexiaoting))。
- 20.5より古いバージョンからアップグレードする際、ローリングアップデートを実行し、クラスターに20.5以上のバージョンと20.5未満のバージョンの両方が含まれている場合、古いバージョンのClickHouseノードが再起動され、新しいバージョンが存在する状態で古いバージョンが起動すると、`Part ... intersects previous part`エラーが発生する可能性があります。このエラーを防ぐには、まずすべてのクラスターノードに新しいclickhouse-serverパッケージをインストールしてから再起動を実行してください(これにより、clickhouse-serverの再起動時に新しいバージョンで起動します)。

#### 新機能 {#new-feature-4}


- `config.xml`で指定された設定に対応するカラムに`Default`圧縮コーデックを指定する機能を追加しました。実装: [#9074](https://github.com/ClickHouse/ClickHouse/issues/9074). [#14049](https://github.com/ClickHouse/ClickHouse/pull/14049) ([alesapin](https://github.com/alesapin)).
- `krb5`および`cyrus-sasl`ライブラリを使用したKafkaでのKerberos認証をサポートしました。[#12771](https://github.com/ClickHouse/ClickHouse/pull/12771) ([Ilya Golshtein](https://github.com/ilejn)).
- リテラル、リテラルのシーケンス、複雑なエイリアスをプレースホルダーに置き換える`normalizeQuery`関数を追加しました。類似したクエリに対して同一の64ビットハッシュ値を返す`normalizedQueryHash`関数を追加しました。これによりクエリログの分析が容易になります。これにより[#11271](https://github.com/ClickHouse/ClickHouse/issues/11271)が解決されました。[#13816](https://github.com/ClickHouse/ClickHouse/pull/13816) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- `time_zones`テーブルを追加しました。[#13880](https://github.com/ClickHouse/ClickHouse/pull/13880) ([Bharat Nallan](https://github.com/bharatnc)).
- 指定された型のデフォルト値を返す`defaultValueOfTypeName`関数を追加しました。[#13877](https://github.com/ClickHouse/ClickHouse/pull/13877) ([hcz](https://github.com/hczhcz)).
- 整数またはDecimalカラムの10進数桁数をカウントする`countDigits(x)`関数を追加しました。Decimalカラムの値がその精度(または指定された精度)を超えているかどうかをチェックする`isDecimalOverflow(d, [p])`関数を追加しました。[#14151](https://github.com/ClickHouse/ClickHouse/pull/14151) ([Artem Zuikov](https://github.com/4ertus2)).
- `medianExactLow`および`medianExactHigh`のそれぞれのエイリアスとともに、`quantileExactLow`および`quantileExactHigh`の実装を追加しました。[#13818](https://github.com/ClickHouse/ClickHouse/pull/13818) ([Bharat Nallan](https://github.com/bharatnc)).
- 日付/時刻値を指定された日付/時刻部分に切り捨てる`date_trunc`関数を追加しました。[#13888](https://github.com/ClickHouse/ClickHouse/pull/13888) ([Vladimir Golovchenko](https://github.com/vladimir-golovchenko)).
- メイン設定ファイルに新しいオプションセクション`<user_directories>`を追加しました。[#13425](https://github.com/ClickHouse/ClickHouse/pull/13425) ([Vitaly Baranov](https://github.com/vitlibar)).
- テーブルのサンプル句を変更できる`ALTER SAMPLE BY`ステートメントを追加しました。[#13280](https://github.com/ClickHouse/ClickHouse/pull/13280) ([Amos Bird](https://github.com/amosbird)).
- `position`関数がオプションの`start_pos`引数をサポートするようになりました。[#13237](https://github.com/ClickHouse/ClickHouse/pull/13237) ([vdimir](https://github.com/vdimir)).

#### バグ修正 {#bug-fix-23}


* インタラクティブモードのクライアントにおいて、プログレスバーによって表示中のデータが潰れてしまう問題を修正しました。これにより、[#12562](https://github.com/ClickHouse/ClickHouse/issues/12562)、[#13369](https://github.com/ClickHouse/ClickHouse/issues/13369)、[#13584](https://github.com/ClickHouse/ClickHouse/issues/13584) および [#12964](https://github.com/ClickHouse/ClickHouse/issues/12964) が修正されました。 [#13691](https://github.com/ClickHouse/ClickHouse/pull/13691) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 複数列でのソート時に `LowCardinality` 列で発生していた誤った並び順を修正しました。これにより [#13958](https://github.com/ClickHouse/ClickHouse/issues/13958) が解決されました。[#14223](https://github.com/ClickHouse/ClickHouse/pull/14223)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* `topK` 集約関数で配列サイズのオーバーフローを検出するチェックを追加しました。このチェックがない場合、ユーザーが細工したパラメータを指定したクエリを送信することで、サーバーをクラッシュさせる可能性があります。これにより [#14452](https://github.com/ClickHouse/ClickHouse/issues/14452) が解決されました。[#14467](https://github.com/ClickHouse/ClickHouse/pull/14467)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* テーブルに 1 つのパートのみを含むパーティションがある場合に、誤ったマージ割り当てが行われる可能性がある不具合を修正。 [#14444](https://github.com/ClickHouse/ClickHouse/pull/14444) ([alesapin](https://github.com/alesapin)).
* `PipelineExecutor` 自体で例外が発生した場合にクエリ実行を停止します。これにより、まれに発生しうるクエリハングを防止できます。[#14334](https://github.com/ClickHouse/ClickHouse/issues/14334) の継続です。 [#14402](https://github.com/ClickHouse/ClickHouse/pull/14402) [#14334](https://github.com/ClickHouse/ClickHouse/pull/14334) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `AS table_function` で作成されたテーブルに対する `ALTER` クエリの実行時に発生していたクラッシュを修正。 [#14212](https://github.com/ClickHouse/ClickHouse/issues/14212) を解決。 [#14326](https://github.com/ClickHouse/ClickHouse/pull/14326) ([alesapin](https://github.com/alesapin)).
* REFRESH コマンドを伴う ALTER LIVE VIEW クエリで発生していた例外を修正しました。Live View は実験的な機能です。 [#14320](https://github.com/ClickHouse/ClickHouse/pull/14320) ([Bharat Nallan](https://github.com/bharatnc)).
* ネストされたインタプリタを使用するクエリに対して、EXPLAIN PIPELINE graph=1 における QueryPlan のライフタイムを修正。 [#14315](https://github.com/ClickHouse/ClickHouse/pull/14315) ([Azat Khuzhin](https://github.com/azat)).
* 一部の外部ソースからスキーマを取得する際に発生する `clickhouse-odbc-bridge` のセグメンテーションフォールトを修正しました。この PR で [#13861](https://github.com/ClickHouse/ClickHouse/issues/13861) を解決しました。[#14267](https://github.com/ClickHouse/ClickHouse/pull/14267)（[Vitaly Baranov](https://github.com/vitlibar)）。
* [#12277](https://github.com/ClickHouse/ClickHouse/pull/12277) で導入されたマーク包含検索処理におけるクラッシュを修正。[#14225](https://github.com/ClickHouse/ClickHouse/pull/14225)（[Amos Bird](https://github.com/amosbird)）。
* 名前付きタプルを使用するテーブルの作成処理を修正しました。これにより [#13027](https://github.com/ClickHouse/ClickHouse/issues/13027) が解消されます。[#14143](https://github.com/ClickHouse/ClickHouse/pull/14143)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 最小負の小数値の書式を修正しました。この変更により [#14111](https://github.com/ClickHouse/ClickHouse/issues/14111) が修正されます。 [#14119](https://github.com/ClickHouse/ClickHouse/pull/14119) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* `DistributedFilesToInsert` メトリクスを修正（本来はゼロになるべきでない場面でゼロになっていた問題を修正）。 [#14095](https://github.com/ClickHouse/ClickHouse/pull/14095) ([Azat Khuzhin](https://github.com/azat)).
* 多角形を表す const 2 次元配列を使用する場合の `pointInPolygon` を修正。 [#14079](https://github.com/ClickHouse/ClickHouse/pull/14079) ([Alexey Ilyukhov](https://github.com/livace)).
* `Poco::Exception: no space left on device` の追加情報で報告されていた誤ったマウントポイントを修正しました。[#14050](https://github.com/ClickHouse/ClickHouse/pull/14050) ([tavplubix](https://github.com/tavplubix))。
* グローバルレベル以外で実行された場合の `GRANT ALL` 文の挙動を修正。 [#13987](https://github.com/ClickHouse/ClickHouse/pull/13987) ([Vitaly Baranov](https://github.com/vitlibar)).
* ENGINE を指定した `CREATE TABLE AS` テーブル関数を拒否するようにパーサーを修正。 [#13940](https://github.com/ClickHouse/ClickHouse/pull/13940) ([hcz](https://github.com/hczhcz))。
* `optimize_duplicate_order_by_and_distinct` 設定が有効な場合に、`DISTINCT` キーワードを使用する SELECT クエリおよび UNION ALL を含むサブクエリで誤った結果が返される不具合を修正。 [#13925](https://github.com/ClickHouse/ClickHouse/pull/13925) ([Artem Zuikov](https://github.com/4ertus2)).
* `Distributed` テーブルの名前変更時に発生する可能性があったデッドロックを解消しました。 [#13922](https://github.com/ClickHouse/ClickHouse/pull/13922) ([tavplubix](https://github.com/tavplubix)).
* 複数列でソートする際の `FixedString` 列の誤った並び順を修正しました。[#13182](https://github.com/ClickHouse/ClickHouse/issues/13182) を修正。[#13887](https://github.com/ClickHouse/ClickHouse/pull/13887)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `topK`/`topKWeighted` のマージ結果が（非デフォルトパラメータ使用時に）不正確になる可能性がある問題を修正しました。 [#13817](https://github.com/ClickHouse/ClickHouse/pull/13817) ([Azat Khuzhin](https://github.com/azat)).
* NULL との比較時に、SET 型の INDEX を持つ MergeTree テーブルからの読み取りが失敗する問題を修正しました。これにより [#13686](https://github.com/ClickHouse/ClickHouse/issues/13686) が修正されます。 [#13793](https://github.com/ClickHouse/ClickHouse/pull/13793) ([Amos Bird](https://github.com/amosbird))。
* lambda 内での `arrayJoin` のキャプチャ処理を修正 (LOGICAL&#95;ERROR)。 [#13792](https://github.com/ClickHouse/ClickHouse/pull/13792) ([Azat Khuzhin](https://github.com/azat)).
* 関数 `range` にステップ値のオーバーフロー検査を追加。 [#13790](https://github.com/ClickHouse/ClickHouse/pull/13790) ([Azat Khuzhin](https://github.com/azat))。
* `DROP DATABASE` と `CREATE TABLE` を並行して実行した際に発生する `Directory not empty` エラーを修正しました。 [#13756](https://github.com/ClickHouse/ClickHouse/pull/13756) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `h3KRing` 関数に対して範囲チェックを追加しました。これにより [#13633](https://github.com/ClickHouse/ClickHouse/issues/13633) が修正されました。[#13752](https://github.com/ClickHouse/ClickHouse/pull/13752) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* DETACH とバックグラウンドマージ間のレースコンディションを修正しました。DETACH 後にパーツが復活してしまう可能性がありました。これは、問題自体は修正できなかったものの、その問題を示す、非常にまれなケースでのみ失敗するテストを導入した [#8602](https://github.com/ClickHouse/ClickHouse/issues/8602) に対する継続対応です。 [#13746](https://github.com/ClickHouse/ClickHouse/pull/13746) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `log_queries_min_type` が `QUERY_START` より大きい場合の `Settings.Names` / `Settings.Values` のログ記録を修正。 [#13737](https://github.com/ClickHouse/ClickHouse/pull/13737) ([Azat Khuzhin](https://github.com/azat)).
* verbose=1 のときの `/replicas_status` エンドポイントのレスポンスのステータスコードを修正しました。 [#13722](https://github.com/ClickHouse/ClickHouse/pull/13722) ([javi santana](https://github.com/javisantana)).
* ユーザーとグループのチェック時に表示される `clickhouse-server.init` 内の誤ったメッセージを修正。 [#13711](https://github.com/ClickHouse/ClickHouse/pull/13711) ([ylchou](https://github.com/ylchou)).
* `optimize_move_functions_out_of_any` 設定有効時には any(arrayJoin()) -&gt; arrayJoin() への最適化を行わないようにしました。 [#13681](https://github.com/ClickHouse/ClickHouse/pull/13681) ([Azat Khuzhin](https://github.com/azat)).
* StorageMerge を使用した JOIN で、設定 `enable_optimize_predicate_expression` が 1 の場合に発生するクラッシュを修正。 [#13679](https://github.com/ClickHouse/ClickHouse/pull/13679) ([Artem Zuikov](https://github.com/4ertus2)).
* `The value of 'number_of_free_entries_in_pool_to_lower_max_size_of_merge' setting` 設定の値に関するエラーメッセージのタイポを修正。 [#13678](https://github.com/ClickHouse/ClickHouse/pull/13678) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 同時に実行される `ALTER ... REPLACE/MOVE PARTITION ...` クエリがデッドロックを引き起こす可能性がある問題を修正しました。 [#13626](https://github.com/ClickHouse/ClickHouse/pull/13626) ([tavplubix](https://github.com/tavplubix)).
* 一部のケースで cache-dictionary がソースに存在する値ではなくデフォルト値を返してしまう問題を修正しました。[#13624](https://github.com/ClickHouse/ClickHouse/pull/13624) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* コンパクトパーツにおけるセカンダリインデックスの破損を修正。コンパクトパーツは実験的な機能です。 [#13538](https://github.com/ClickHouse/ClickHouse/pull/13538) ([Anton Popov](https://github.com/CurtizJ)).
* 単一レプリカ上でのみ実行する必要があるクエリに対して発生していた、`ON CLUSTER` の過度に早いタイムアウトを修正しました。[#6704](https://github.com/ClickHouse/ClickHouse/issues/6704)、[#7228](https://github.com/ClickHouse/ClickHouse/issues/7228)、[#13361](https://github.com/ClickHouse/ClickHouse/issues/13361)、[#11884](https://github.com/ClickHouse/ClickHouse/issues/11884) を解決しました。[#13450](https://github.com/ClickHouse/ClickHouse/pull/13450)（[alesapin](https://github.com/alesapin)）。
* 関数 `netloc` 内の誤ったコードを修正し、[#13335](https://github.com/ClickHouse/ClickHouse/issues/13335) を解決。 [#13446](https://github.com/ClickHouse/ClickHouse/pull/13446)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `StorageMemory` における起こり得るレースコンディションを修正。 [#13416](https://github.com/ClickHouse/ClickHouse/pull/13416) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* HTTP プロトコルにおける `TSV/CSVWithNames` 形式でのヘッダーの欠落および過剰なヘッダー出力を修正。これにより [#12504](https://github.com/ClickHouse/ClickHouse/issues/12504) を解決。[#13343](https://github.com/ClickHouse/ClickHouse/pull/13343)（[Azat Khuzhin](https://github.com/azat)）。
* `users.xml` から行ポリシーを解析する際、データベース名やテーブル名にドットが含まれている場合の不具合を修正しました。これにより [#5779](https://github.com/ClickHouse/ClickHouse/issues/5779)、[#12527](https://github.com/ClickHouse/ClickHouse/issues/12527) が修正されました。[#13199](https://github.com/ClickHouse/ClickHouse/pull/13199)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 一度接続が切れた後に `redis` 辞書に再度アクセスできなくなる問題を修正しました。これは `cache` および `direct` 辞書レイアウトで発生する可能性があります。 [#13082](https://github.com/ClickHouse/ClickHouse/pull/13082) ([Anton Popov](https://github.com/CurtizJ)).
* ClickHouseDictionarySource を使用してリモートテーブルをクエリする際に行われていた誤った認可チェックを削除しました。 [#12756](https://github.com/ClickHouse/ClickHouse/pull/12756) ([sundyli](https://github.com/sundy-li))。
* 共通部分式除去のため、一部のケースで副問い合わせを適切に区別できるようにしました。 [#8333](https://github.com/ClickHouse/ClickHouse/issues/8333)。 [#8367](https://github.com/ClickHouse/ClickHouse/pull/8367) ([Amos Bird](https://github.com/amosbird))。

#### 改善 {#improvement-12}


* `ALIAS` 型の列で `CODEC` の使用を禁止しました。 [#13911](https://github.com/ClickHouse/ClickHouse/issues/13911) を修正。 [#14263](https://github.com/ClickHouse/ClickHouse/pull/14263)（[Bharat Nallan](https://github.com/bharatnc)）。
* 辞書の更新が完了するのを待機する際は、ハードコードされた値ではなく、`query_wait_timeout_milliseconds` 設定で指定されたタイムアウトを使用します。 [#14105](https://github.com/ClickHouse/ClickHouse/pull/14105) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* `index_granularity_bytes` 設定値が非常に小さいテーブルを誤って作成してしまうことを防ぐための設定項目 `min_index_granularity_bytes` を追加。 [#14139](https://github.com/ClickHouse/ClickHouse/pull/14139) ([Bharat Nallan](https://github.com/bharatnc))。
* 異なる ZooKeeper を利用しているクラスタからパーティションを取得できるようになりました: `ALTER TABLE table_name FETCH PARTITION partition_expr FROM 'zk-name:/path-in-zookeeper'`。これは新しいクラスタへデータを移行する際に有用です。 [#14155](https://github.com/ClickHouse/ClickHouse/pull/14155) ([Amos Bird](https://github.com/amosbird))。
* 大量の非常に小さなブロックから構成されている場合（そのようなケースは稀ですが）、Memory テーブルのパフォーマンスがわずかに向上します。アイデアの提案者: [Mark Papadakis](https://github.com/markpapadakis)。[#14043](https://github.com/ClickHouse/ClickHouse/issues/14043) をクローズ。[#14056](https://github.com/ClickHouse/ClickHouse/pull/14056)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 条件付き集約関数（`avgIf`、`sumIf`、`maxIf` など）は、条件に一致する行がない場合に `NULL` を返し、Nullable な引数を使用するようになりました。 [#13964](https://github.com/ClickHouse/ClickHouse/pull/13964) ([Winter Zhang](https://github.com/zhang2014))。
* -Resample combinator の上限を 1M に引き上げ。 [#13947](https://github.com/ClickHouse/ClickHouse/pull/13947) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* 異常に小さい不正な形式のメッセージを受信した際に Kafka テーブルエンジンがメッセージの処理を停止してしまう原因となっていた AvroConfluent フォーマットのエラーを修正しました。 [#13941](https://github.com/ClickHouse/ClickHouse/pull/13941) ([Gervasio Varela](https://github.com/gervarela)).
* 長いクエリに対する誤ったエラーを修正しました。本来は `Max query size exceeded` になるべき正しいクエリに対して、別の構文エラーが発生してしまう可能性がありました。 [#13928](https://github.com/ClickHouse/ClickHouse/pull/13928) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `TabSeparated` フォーマットにおける NULL 値に対するエラーメッセージを改善しました。 [#13906](https://github.com/ClickHouse/ClickHouse/pull/13906) ([jiang tao](https://github.com/tomjiang1987)).
* 配列要素の型が Float32/Float64 の場合、関数 `arrayCompact` は NaN をビット単位で比較します。以前のバージョンでは、配列要素の型が Float32/Float64 の場合は NaN 同士は常に等しくないと判定され、Nullable(Float64) のような、より複雑な型の場合は常に等しいと判定されていました。これにより [#13857](https://github.com/ClickHouse/ClickHouse/issues/13857) が解決されました。 [#13868](https://github.com/ClickHouse/ClickHouse/pull/13868)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `lgamma` 関数のデータ競合を修正しました。この競合は `tsan` でのみ検出され、実際には副作用は発生していませんでした。 [#13842](https://github.com/ClickHouse/ClickHouse/pull/13842) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 配列をフィールドとして操作する際にクエリが過度に遅くならないようにし、代わりに例外をスローするようにしました。 [#13753](https://github.com/ClickHouse/ClickHouse/pull/13753) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Redis の `requirepass` 認証（Redis 辞書ソース用）への対応を追加しました。 [#13688](https://github.com/ClickHouse/ClickHouse/pull/13688) ([Ivan Torgashov](https://github.com/it1804)).
* MergeTree の Write-Ahead-Log (WAL) ダンプツールを追加しました。WAL は実験的な機能です。 [#13640](https://github.com/ClickHouse/ClickHouse/pull/13640) ([BohuTANG](https://github.com/BohuTANG))。
* 以前のバージョンでは、特別に細工された引数で呼び出された場合に、`lcm` 関数がデバッグビルドでアサーション失敗を起こす可能性がありました。これにより [#13368](https://github.com/ClickHouse/ClickHouse/issues/13368) が修正されました。[#13510](https://github.com/ClickHouse/ClickHouse/pull/13510)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* より多くのケースで `toDate/toDateTime` 関数に単調性情報を提供します。単調性に関する情報はインデックス解析に利用され（より複雑なクエリでもインデックスを利用できるようになります）、今回、入力引数の飽和処理がより自然になったことで、単調性がさらに向上しました。 [#13497](https://github.com/ClickHouse/ClickHouse/pull/13497) ([Amos Bird](https://github.com/amosbird))。
* カスタム設定に対して複合識別子をサポートしました。カスタム設定は、ClickHouse のコードベースと他のコードベースを連携させるためのポイントであり（ClickHouse 自体には特に利点はありません）、[#13496](https://github.com/ClickHouse/ClickHouse/pull/13496)（[Vitaly Baranov](https://github.com/vitlibar)）で導入されました。
* DiskLocal から DiskS3 へパーツを並列に移動します。`DiskS3` は実験的な機能です。 [#13459](https://github.com/ClickHouse/ClickHouse/pull/13459) ([Pavel Kovalenko](https://github.com/Jokser))。
* デフォルトで混合粒度パーツを有効にしました。 [#13449](https://github.com/ClickHouse/ClickHouse/pull/13449) ([alesapin](https://github.com/alesapin)).
* S3 リダイレクトにおけるリモートホストの適切な検証（セキュリティ関連）。 [#13404](https://github.com/ClickHouse/ClickHouse/pull/13404) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `QueryTimeMicroseconds`、`SelectQueryTimeMicroseconds` および `InsertQueryTimeMicroseconds` を system.events に追加しました。 [#13336](https://github.com/ClickHouse/ClickHouse/pull/13336) ([ianton-ru](https://github.com/ianton-ru)).
* Decimal の負の指数が大きすぎる場合に発生するデバッグアサーションを修正。[#13188](https://github.com/ClickHouse/ClickHouse/issues/13188) を解決。[#13228](https://github.com/ClickHouse/ClickHouse/pull/13228)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* DiskS3 にキャッシュ層を追加しました（ローカルディスク上の mark ファイルおよび index ファイル用のキャッシュ）。`DiskS3` は実験的機能です。 [#13076](https://github.com/ClickHouse/ClickHouse/pull/13076) ([Pavel Kovalenko](https://github.com/Jokser)).
* readline を修正し、履歴を直ちにファイルへ書き出すようにした。 [#13600](https://github.com/ClickHouse/ClickHouse/pull/13600) ([Amos Bird](https://github.com/amosbird)).
* デフォルトで `Atomic` エンジンを使用する `system` データベースを作成しました（全体で `Atomic` データベースエンジンをデフォルトにするための準備）。 [#13680](https://github.com/ClickHouse/ClickHouse/pull/13680) ([tavplubix](https://github.com/tavplubix))。

#### パフォーマンス改善 {#performance-improvement-5}

- `LowCardinality`を使用した非常に短いクエリを若干最適化しました。[#14129](https://github.com/ClickHouse/ClickHouse/pull/14129) ([Anton Popov](https://github.com/CurtizJ))。
- `max_insert_threads`設定が指定されている場合、テーブルエンジン`Null`、`Memory`、`Distributed`、`Buffer`に対して並列INSERTを有効化しました。[#14120](https://github.com/ClickHouse/ClickHouse/pull/14120) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- パーツスキャン時に`max_rows_to_read`制限を超えた場合、即座に失敗するようにしました。この変更の目的は、`max_rows_to_read`が既に超過していることが明らかな場合、選択されたすべてのパーツに対する範囲スキャンをスキップすることです。この変更は、多数のパーツに対するクエリで顕著な効果があります。[#13677](https://github.com/ClickHouse/ClickHouse/pull/13677) ([Roman Khavronenko](https://github.com/hagen1778))。
- UInt8/UInt16キーによる集計のパフォーマンスを若干改善しました。[#13099](https://github.com/ClickHouse/ClickHouse/pull/13099) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `Array(LowCardinality(T))`と定数の右引数に対する`has()`、`indexOf()`、`countEqual()`関数を最適化しました。[#12550](https://github.com/ClickHouse/ClickHouse/pull/12550) ([myrrc](https://github.com/myrrc))。
- 単純な`INSERT SELECT`クエリを実行する際、`max_threads`を1または`max_insert_threads`に自動的に設定し、`max_block_size`を`min_insert_block_size_rows`に設定するようにしました。[#5907](https://github.com/ClickHouse/ClickHouse/issues/5907)に関連します。[#12195](https://github.com/ClickHouse/ClickHouse/pull/12195) ([flynn](https://github.com/ucasFL))。

#### 実験的機能 {#experimental-feature-3}

- ClickHouseがMySQLレプリカとして動作できるようになりました - これは`MaterializeMySQL`データベースエンジンによって実装されています。[#4006](https://github.com/ClickHouse/ClickHouse/issues/4006)を実装しました。[#10851](https://github.com/ClickHouse/ClickHouse/pull/10851) ([Winter Zhang](https://github.com/zhang2014))。
- `Int128`、`Int256`、`UInt256`型とそれらに関連する関数を追加しました。Decimal256(最大76桁の精度)でDecimalsを拡張しました。新しい型は`allow_experimental_bigint_types`設定の下にあります。これは極めて遅く、動作も良くありません。実装は不完全です。この機能は使用しないでください。[#13097](https://github.com/ClickHouse/ClickHouse/pull/13097) ([Artem Zuikov](https://github.com/4ertus2))。

#### ビルド/テスト/パッケージング改善 {#buildtestingpackaging-improvement-7}


* 単一のバイナリしかない環境で便利な `clickhouse install` スクリプトを追加しました。 [#13528](https://github.com/ClickHouse/ClickHouse/pull/13528) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 設定ファイルなしで `clickhouse` バイナリを実行できるようにしました。 [#13515](https://github.com/ClickHouse/ClickHouse/pull/13515) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* コード内のタイポを検出するための `codespell` チェックを有効化しました。 [#13513](https://github.com/ClickHouse/ClickHouse/pull/13513) [#13511](https://github.com/ClickHouse/ClickHouse/pull/13511) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* ShellCheck を CI で .sh テスト用のリンターとして有効化しました。これにより [#13168](https://github.com/ClickHouse/ClickHouse/issues/13168) がクローズされます。 [#13530](https://github.com/ClickHouse/ClickHouse/pull/13530) [#13529](https://github.com/ClickHouse/ClickHouse/pull/13529) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 自動再構成の代わりに構成処理を失敗させるための CMake オプションを追加し、デフォルトで有効化しました。 [#13687](https://github.com/ClickHouse/ClickHouse/pull/13687) ([Konstantin](https://github.com/podshumok)).
* `system.build_options` の `TZDATA_VERSION` 経由で、組み込み `tzdata` のバージョンを参照可能にした。 [#13648](https://github.com/ClickHouse/ClickHouse/pull/13648) ([filimonov](https://github.com/filimonov)).
* ビルド時における `system.time_zones` テーブルの生成処理を改善。 [#14209](https://github.com/ClickHouse/ClickHouse/issues/14209) をクローズ。 [#14215](https://github.com/ClickHouse/ClickHouse/pull/14215)（[filimonov](https://github.com/filimonov)）。
* パッケージリポジトリから取得可能な最新の tzdata を使用して ClickHouse をビルドするようにしました。 [#13623](https://github.com/ClickHouse/ClickHouse/pull/13623) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* skip&#95;list.json で JS スタイルのコメントを記述できる機能を追加。 [#14159](https://github.com/ClickHouse/ClickHouse/pull/14159) ([alesapin](https://github.com/alesapin)).
* GPL コードのコピーペーストがないことを確認。 [#13514](https://github.com/ClickHouse/ClickHouse/pull/13514) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* テスト用 Docker イメージが親イメージとして `test-base` を使用するように変更。[#14167](https://github.com/ClickHouse/ClickHouse/pull/14167)（[Ilya Yatsishin](https://github.com/qoega)）。
* docker-compose クラスターの立ち上げ時にリトライ処理を追加; COMPOSE&#95;HTTP&#95;TIMEOUT を延長。[#14112](https://github.com/ClickHouse/ClickHouse/pull/14112) ([vzakaznikov](https://github.com/vzakaznikov)).
* ストレステストで `system.text_log` を有効化し、より多くのバグを検出できるようにしました。 [#13855](https://github.com/ClickHouse/ClickHouse/pull/13855) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Testflows の LDAP モジュール: openldap4 用に不足していた証明書と dhparam.pem を追加。 [#13780](https://github.com/ClickHouse/ClickHouse/pull/13780) ([vzakaznikov](https://github.com/vzakaznikov)).
* ZooKeeper は CI インフラストラクチャ上のユニットテストでは安定して動作しません。実際の ZooKeeper を用いて ZooKeeper との連携をユニットテストで検証しようとするのは、そもそも得策ではありません（ユニットテストは複雑な分散システムを検証することを想定していません）。この目的にはすでにインテグレーションテストを使用しており、その方が適しています。 [#13745](https://github.com/ClickHouse/ClickHouse/pull/13745) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* スタイルチェック用の Docker イメージを追加しました。すべての Docker および Docker Compose ファイルが docker ディレクトリ内に配置されていることを確認するスタイルチェックを追加しました。 [#13724](https://github.com/ClickHouse/ClickHouse/pull/13724) ([Ilya Yatsishin](https://github.com/qoega)).
* Mac OS 上での Cassandra ビルドを修正。 [#13708](https://github.com/ClickHouse/ClickHouse/pull/13708) ([Ilya Yatsishin](https://github.com/qoega)).
* 共有ビルド時のリンクエラーを修正。 [#13700](https://github.com/ClickHouse/ClickHouse/pull/13700) ([Amos Bird](https://github.com/amosbird))。
* LDAP ユーザー認証スイートを更新し、RBAC と連携して動作することを確認するようにした。 [#13656](https://github.com/ClickHouse/ClickHouse/pull/13656) ([vzakaznikov](https://github.com/vzakaznikov))。
* `contrib/aws` に対する `-DENABLE_CURL_CLIENT` を削除しました。 [#13628](https://github.com/ClickHouse/ClickHouse/pull/13628) ([Vladimir Chebotarev](https://github.com/excitoon)).
* ClickHouse ノードのヘルスチェックタイムアウトを延長し、コンテナが正常でない場合に `docker-compose` のログをダンプできるようにしました。 [#13612](https://github.com/ClickHouse/ClickHouse/pull/13612) ([vzakaznikov](https://github.com/vzakaznikov)).
* [#10977](https://github.com/ClickHouse/ClickHouse/issues/10977) が無効であることを確認しました。 [#13539](https://github.com/ClickHouse/ClickHouse/pull/13539) ([Amos Bird](https://github.com/amosbird))。
* robot-clickhouse からの PR をスキップするようにしました。 [#13489](https://github.com/ClickHouse/ClickHouse/pull/13489) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Dockerfile をインテグレーションテストから `docker/test` ディレクトリに移動。docker&#95;compose ファイルは `runner` Docker コンテナ内で利用できます。Docker イメージはインテグレーションテスト内ではなく、CI でビルドされます。[#13448](https://github.com/ClickHouse/ClickHouse/pull/13448) ([Ilya Yatsishin](https://github.com/qoega)).





## ClickHouseリリース20.7 {#clickhouse-release-207}

### ClickHouseリリースv20.7.2.30-stable、2020-08-31 {#clickhouse-release-v207230-stable-2020-08-31}

#### 後方互換性のない変更 {#backward-incompatible-change-5}

- 関数`modulo`(演算子`%`)は、引数として少なくとも1つの浮動小数点数がある場合、両方の引数を整数に変換せずに浮動小数点数で直接除算の余りを計算します。これにより、ほとんどのDBMSと互換性のある動作になります。これはDateおよびDateTimeデータ型にも適用されます。エイリアス`mod`を追加しました。これにより[#7323](https://github.com/ClickHouse/ClickHouse/issues/7323)が解決されます。[#12585](https://github.com/ClickHouse/ClickHouse/pull/12585) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ゼロのDate/DateTime値を`0000-00-00`および`0000-00-00 00:00:00`として特別に表示する機能を非推奨にしました。[#12442](https://github.com/ClickHouse/ClickHouse/pull/12442) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 関数`groupArrayMoving*`が分散クエリで動作していませんでした。その結果は誤ったデータ型(最大の型への昇格なし)で計算されていました。関数`groupArrayMovingAvg`は`avg`関数と一致しない整数を返していました。これにより[#12568](https://github.com/ClickHouse/ClickHouse/issues/12568)が修正されます。[#12622](https://github.com/ClickHouse/ClickHouse/pull/12622) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- MergeTree設定の健全性チェックを追加しました。設定が正しくない場合、サーバーは起動またはテーブルの作成を拒否し、詳細な説明をユーザーに出力します。[#13153](https://github.com/ClickHouse/ClickHouse/pull/13153) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ユーザーが`background_pool_size`を`number_of_free_entries_in_pool_to_execute_mutation`または`number_of_free_entries_in_pool_to_lower_max_size_of_merge`より低い値に設定する場合から保護します。これらの場合、ALTERが動作しないか、マージの最大サイズが過度に制限されます。対処方法を説明する例外がスローされます。これにより[#10897](https://github.com/ClickHouse/ClickHouse/issues/10897)が解決されます。[#12728](https://github.com/ClickHouse/ClickHouse/pull/12728) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 20.5より古いバージョンからアップグレードする際、ローリングアップデートが実行され、クラスターに20.5以上のバージョンと20.5未満のバージョンの両方が含まれている場合、古いバージョンのClickHouseノードが再起動され、新しいバージョンの存在下で古いバージョンが起動されると、`Part ... intersects previous part`エラーが発生する可能性があります。このエラーを防ぐには、まずすべてのクラスターノードに新しいclickhouse-serverパッケージをインストールしてから再起動を実行してください(これにより、clickhouse-serverが再起動されると新しいバージョンで起動します)。

#### 新機能 {#new-feature-5}


- 効率的な「逆ジオコーディング」検索を提供するPolygon辞書タイプ - 多数のポリゴン(世界地図)の辞書内で座標から地域を検索します。再帰的グリッドを使用した最適化されたアルゴリズムにより、CPUとメモリ使用量を低く抑えます。[#9278](https://github.com/ClickHouse/ClickHouse/pull/9278) ([achulkov2](https://github.com/achulkov2))。
- 事前設定されたユーザーに対するLDAP認証のサポートを追加しました(「Simple Bind」方式)。[#11234](https://github.com/ClickHouse/ClickHouse/pull/11234) ([Denis Glazachev](https://github.com/traceon))。
- 一部の`ALTER TABLE ... PARTITION ...`クエリ(現在は`ATTACH`と`FREEZE`)で影響を受けたパーツに関する情報を出力する設定`alter_partition_verbose_result`を導入しました。[#8076](https://github.com/ClickHouse/ClickHouse/issues/8076)を解決。[#13017](https://github.com/ClickHouse/ClickHouse/pull/13017) ([alesapin](https://github.com/alesapin))。
- ベイジアンABテスト用の`bayesAB`関数を追加しました。[#12327](https://github.com/ClickHouse/ClickHouse/pull/12327) ([achimbab](https://github.com/achimbab))。
- 致命的エラーのスタックトレースが収集される`system.crash_log`テーブルを追加しました。このテーブルは空である必要があります。[#12316](https://github.com/ClickHouse/ClickHouse/pull/12316) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- デフォルトデータベースと出力フォーマットを設定するために使用できるHTTPヘッダー`X-ClickHouse-Database`と`X-ClickHouse-Format`を追加しました。[#12981](https://github.com/ClickHouse/ClickHouse/pull/12981) ([hcz](https://github.com/hczhcz))。
- `SimpleAggregateFunction`に`minMap`と`maxMap`関数のサポートを追加しました。[#12662](https://github.com/ClickHouse/ClickHouse/pull/12662) ([Ildus Kurbangaliev](https://github.com/ildus))。
- ディスク上のデータを変更する`ALTER`クエリの実行を制限する設定`allow_non_metadata_alters`を追加しました。デフォルトでは無効です。[#11547](https://github.com/ClickHouse/ClickHouse/issues/11547)を解決。[#12635](https://github.com/ClickHouse/ClickHouse/pull/12635) ([alesapin](https://github.com/alesapin))。
- 任意の式を指定されたフォーマットで文字列に変換する関数`formatRow`を追加しました。SQL出力の操作に便利で、`columns`関数と組み合わせると非常に汎用性が高くなります。[#12574](https://github.com/ClickHouse/ClickHouse/pull/12574) ([Amos Bird](https://github.com/amosbird))。
- MySQLとの互換性のために`FROM_UNIXTIME`関数を追加しました。[12149](https://github.com/ClickHouse/ClickHouse/issues/12149)に関連。[#12484](https://github.com/ClickHouse/ClickHouse/pull/12484) ([flynn](https://github.com/ucasFL))。
- `allow_nullable_key`テーブル設定が有効な場合、MergeTreeテーブルのキーとしてNullable型を許可します。[#5319](https://github.com/ClickHouse/ClickHouse/issues/5319)を解決。[#12433](https://github.com/ClickHouse/ClickHouse/pull/12433) ([Amos Bird](https://github.com/amosbird))。
- [COS](https://intl.cloud.tencent.com/product/cos)との統合。[#12386](https://github.com/ClickHouse/ClickHouse/pull/12386) ([fastio](https://github.com/fastio))。
- キーマップされた値の加算/減算のための`mapAdd`と`mapSubtract`関数を追加しました。[#11735](https://github.com/ClickHouse/ClickHouse/pull/11735) ([Ildus Kurbangaliev](https://github.com/ildus))。

#### バグ修正 {#bug-fix-24}


* 単一レプリカ上で実行する必要があるクエリに対する `ON CLUSTER` の過度に早いタイムアウトを修正しました。[#6704](https://github.com/ClickHouse/ClickHouse/issues/6704)、[#7228](https://github.com/ClickHouse/ClickHouse/issues/7228)、[#13361](https://github.com/ClickHouse/ClickHouse/issues/13361)、[#11884](https://github.com/ClickHouse/ClickHouse/issues/11884) の問題を修正。[#13450](https://github.com/ClickHouse/ClickHouse/pull/13450)（[alesapin](https://github.com/alesapin)）。
* [#12277](https://github.com/ClickHouse/ClickHouse/pull/12277) で導入されたマーク包含検索処理で発生するクラッシュを修正。[#14225](https://github.com/ClickHouse/ClickHouse/pull/14225) ([Amos Bird](https://github.com/amosbird))。
* キャッシュレイアウトを使用する外部ディクショナリにおけるレースコンディションを修正しました。これが原因でサーバーがクラッシュする可能性がありました。 [#12566](https://github.com/ClickHouse/ClickHouse/pull/12566) ([alesapin](https://github.com/alesapin)).
* インタラクティブモードのクライアントにおいて、プログレスバーによって表示データが上書きされてしまう問題を修正しました。これにより [#12562](https://github.com/ClickHouse/ClickHouse/issues/12562)、[#13369](https://github.com/ClickHouse/ClickHouse/issues/13369)、[#13584](https://github.com/ClickHouse/ClickHouse/issues/13584) が修正され、[#12964](https://github.com/ClickHouse/ClickHouse/issues/12964) も解決されます。[#13691](https://github.com/ClickHouse/ClickHouse/pull/13691)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `ORDER BY` で複数のカラムを指定した場合に発生していた `LowCardinality` カラムの誤ったソート順を修正しました。これにより [#13958](https://github.com/ClickHouse/ClickHouse/issues/13958) が解決されました。[#14223](https://github.com/ClickHouse/ClickHouse/pull/14223)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* キャッシュ辞書に対する `query_wait_timeout_milliseconds` 設定を誤って上書きしていたハードコードされたタイムアウト値を削除しました。 [#14105](https://github.com/ClickHouse/ClickHouse/pull/14105) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* `Poco::Exception: no space left on device` の追加情報内の誤ったマウントポイントを修正しました。 [#14050](https://github.com/ClickHouse/ClickHouse/pull/14050) ([tavplubix](https://github.com/tavplubix)).
* `optimize_duplicate_order_by_and_distinct` 設定が有効な場合に、サブクエリにも `DISTINCT` が指定されている `DISTINCT` 付きの SELECT クエリに対して誤ったクエリ最適化が行われる問題を修正。 [#13925](https://github.com/ClickHouse/ClickHouse/pull/13925) ([Artem Zuikov](https://github.com/4ertus2)).
* `Distributed` テーブルの名前変更時に発生する可能性のあったデッドロックを修正しました。 [#13922](https://github.com/ClickHouse/ClickHouse/pull/13922) ([tavplubix](https://github.com/tavplubix)).
* 複数カラムを指定した ORDER BY で `FixedString` 列に対して誤ったソートが行われる問題を修正しました。 [#13182](https://github.com/ClickHouse/ClickHouse/issues/13182) を修正。 [#13887](https://github.com/ClickHouse/ClickHouse/pull/13887)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `topK`/`topKWeighted` 集約（デフォルト以外のパラメータを使用する場合）における精度低下の可能性を修正。 [#13817](https://github.com/ClickHouse/ClickHouse/pull/13817) ([Azat Khuzhin](https://github.com/azat)).
* `INDEX` の型が `SET` の MergeTree テーブルから読み取る際に、`NULL` との比較で失敗する問題を修正しました。この修正により [#13686](https://github.com/ClickHouse/ClickHouse/issues/13686) の問題が解決されました。 [#13793](https://github.com/ClickHouse/ClickHouse/pull/13793) ([Amos Bird](https://github.com/amosbird))。
* 関数 `range()` におけるステップのオーバーフローを修正。[#13790](https://github.com/ClickHouse/ClickHouse/pull/13790) ([Azat Khuzhin](https://github.com/azat))。
* `DROP DATABASE` と `CREATE TABLE` を並行して実行した際に発生する `Directory not empty` エラーを修正しました。 [#13756](https://github.com/ClickHouse/ClickHouse/pull/13756) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `h3KRing` 関数に範囲チェックを追加しました。これにより [#13633](https://github.com/ClickHouse/ClickHouse/issues/13633) が修正されました。 [#13752](https://github.com/ClickHouse/ClickHouse/pull/13752) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* DETACH とバックグラウンドマージとの間のレースコンディションを修正。パーツが DETACH 後に復活してしまうことがありました。これは、問題自体は修正できなかったものの、その問題を示す極めてまれに失敗するテストを導入した [#8602](https://github.com/ClickHouse/ClickHouse/issues/8602) の継続対応です。 [#13746](https://github.com/ClickHouse/ClickHouse/pull/13746) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `log_queries_min_type` が `QUERY_START` より大きい場合の Settings.Names/Values のログ出力を修正しました。 [#13737](https://github.com/ClickHouse/ClickHouse/pull/13737) ([Azat Khuzhin](https://github.com/azat)).
* ユーザーおよびグループのチェック時に `clickhouse-server.init` によって出力される誤ったメッセージを修正。[#13711](https://github.com/ClickHouse/ClickHouse/pull/13711)（[ylchou](https://github.com/ylchou)）。
* `optimize_move_functions_out_of_any` が有効な場合でも、`any(arrayJoin())` を `arrayJoin()` に最適化しないようにしました。 [#13681](https://github.com/ClickHouse/ClickHouse/pull/13681) ([Azat Khuzhin](https://github.com/azat)).
* 同時実行される `ALTER ... REPLACE/MOVE PARTITION ...` クエリで発生する可能性があったデッドロックを修正しました。 [#13626](https://github.com/ClickHouse/ClickHouse/pull/13626) ([tavplubix](https://github.com/tavplubix)).
* キャッシュ辞書が、ソースに存在する値ではなくデフォルト値を返してしまうことがある動作を修正しました。 [#13624](https://github.com/ClickHouse/ClickHouse/pull/13624) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* コンパクトパーツにおけるセカンダリインデックスの破損を修正（コンパクトパーツは実験的な機能です）。 [#13538](https://github.com/ClickHouse/ClickHouse/pull/13538) ([Anton Popov](https://github.com/CurtizJ)).
* 関数 `netloc` 内の誤ったコードを修正しました。これにより [#13335](https://github.com/ClickHouse/ClickHouse/issues/13335) が解決されます。[#13446](https://github.com/ClickHouse/ClickHouse/pull/13446)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `parseDateTimeBestEffort` 関数に Unix タイムスタンプが引数として渡された場合に発生するエラーを修正しました。これにより [#13362](https://github.com/ClickHouse/ClickHouse/issues/13362) が解決されました。 [#13441](https://github.com/ClickHouse/ClickHouse/pull/13441) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `NULL` 要素を含むタプルの比較における不正な戻り値型を修正。 [#12461](https://github.com/ClickHouse/ClickHouse/issues/12461) を修正。 [#13420](https://github.com/ClickHouse/ClickHouse/pull/13420)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `SET optimize_move_functions_out_of_any = 1` および `any()` 内のエイリアスがある場合に `aggregate function any(x) is found inside another aggregate function in query` エラーを引き起こしていた誤った最適化を修正しました。 [#13419](https://github.com/ClickHouse/ClickHouse/pull/13419) ([Artem Zuikov](https://github.com/4ertus2)).
* `StorageMemory` におけるレースコンディションが発生しうる問題を修正。 [#13416](https://github.com/ClickHouse/ClickHouse/pull/13416) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* クエリがゼロ行を返した場合に、`Arrow` および `Parquet` フォーマットで出力が空になってしまう問題を修正しました。これらのフォーマットでは空の出力は不正な形式となるため、この変更を行いました。 [#13399](https://github.com/ClickHouse/ClickHouse/pull/13399) ([hcz](https://github.com/hczhcz)).
* `ORDER BY` 句に定数カラムと主キーのプレフィックスを含む `SELECT` クエリを修正。[#13396](https://github.com/ClickHouse/ClickHouse/pull/13396)（[Anton Popov](https://github.com/CurtizJ)）。
* clickhouse-local 向けの `PrettyCompactMonoBlock` を修正。`PrettyCompactMonoBlock` における `extremes` / `totals` を修正。[#7746](https://github.com/ClickHouse/ClickHouse/issues/7746) を修正。[#13394](https://github.com/ClickHouse/ClickHouse/pull/13394)（[Azat Khuzhin](https://github.com/azat)）。
* system.text&#95;log でのデッドロック問題を修正しました。[#12452](https://github.com/ClickHouse/ClickHouse/pull/12452)（[alexey-milovidov](https://github.com/alexey-milovidov)）。これは [#12339](https://github.com/ClickHouse/ClickHouse/issues/12339) の一部です。この修正により [#12325](https://github.com/ClickHouse/ClickHouse/issues/12325) が解決されます。[#13386](https://github.com/ClickHouse/ClickHouse/pull/13386)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* `File(TSVWithNames*)`（ヘッダーが複数回書き込まれていた）を修正し、`clickhouse-local --format CSVWithNames*`（ヘッダーがなく、[#12197](https://github.com/ClickHouse/ClickHouse/issues/12197) 以降動作しなくなっていた）を修正し、行数ゼロの場合の `clickhouse-local --format CSVWithNames*`（ヘッダーがない）を修正しました。 [#13343](https://github.com/ClickHouse/ClickHouse/pull/13343)（[Azat Khuzhin](https://github.com/azat)）。
* 関数 `groupArrayMovingSum` が空のステートをデシリアライズする際に発生するセグメンテーションフォールトを修正。[#13339](https://github.com/ClickHouse/ClickHouse/issues/13339) を修正。[#13341](https://github.com/ClickHouse/ClickHouse/pull/13341)（[alesapin](https://github.com/alesapin)）。
* `JOIN ON` 節内での `arrayJoin()` 関数に対してエラーを発生させるようにしました。 [#13330](https://github.com/ClickHouse/ClickHouse/pull/13330) ([Artem Zuikov](https://github.com/4ertus2)).
* `join_use_nulls=1` 使用時の `LEFT ASOF JOIN` におけるクラッシュを修正。 [#13291](https://github.com/ClickHouse/ClickHouse/pull/13291) ([Artem Zuikov](https://github.com/4ertus2)).
* 遅延レプリカからのクエリを実行した場合に発生する可能性のある `Totals having transform was already added to pipeline` エラーを修正。[#13290](https://github.com/ClickHouse/ClickHouse/pull/13290)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* ユーザーが関数 `h3ToChildren` に特定の細工を施した引数を渡した場合に、サーバーがクラッシュする可能性がありました。この問題を [#13275](https://github.com/ClickHouse/ClickHouse/issues/13275) で追跡し、[#13277](https://github.com/ClickHouse/ClickHouse/pull/13277)（[alexey-milovidov](https://github.com/alexey-milovidov)）で修正しました。
* `NaN` 値を含む Float 型に対して呼び出された `uniqExact`、`topK`、`sumDistinct` などの集約関数で発生していた、潜在的な低パフォーマンスとわずかに不正確な結果を修正しました。デバッグビルドでは `assert` が発火する原因にもなっていました。この修正により [#12491](https://github.com/ClickHouse/ClickHouse/issues/12491) が解決されました。[#13254](https://github.com/ClickHouse/ClickHouse/pull/13254)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 主キーに単調関数を含む式があり、かつクエリに型の異なる定数との比較条件が含まれている場合の `KeyCondition` におけるアサーションを修正しました。これにより [#12465](https://github.com/ClickHouse/ClickHouse/issues/12465) が修正されます。 [#13251](https://github.com/ClickHouse/ClickHouse/pull/13251) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 関数 `roundUpToPowerOfTwoOrZero()` において、最上位ビットがセットされている数値に対しては渡された数値をそのまま返すようにしました。これにより、配列サイズのオーバーフローに起因する潜在的なエラーを防ぎます。 [#13234](https://github.com/ClickHouse/ClickHouse/pull/13234) ([Azat Khuzhin](https://github.com/azat)).
* リテラル NULL ではない nullable な `constexpr` を条件として使用した場合の `if` 関数の不具合を修正しました。[#12463](https://github.com/ClickHouse/ClickHouse/issues/12463) を修正。[#13226](https://github.com/ClickHouse/ClickHouse/pull/13226)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 配列要素が `Nullable` で、配列の添字も `Nullable` の場合における `arrayElement` 関数のアサーションを修正しました。これにより [#12172](https://github.com/ClickHouse/ClickHouse/issues/12172) が解決されます。 [#13224](https://github.com/ClickHouse/ClickHouse/pull/13224) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 引数が定数である場合の DateTime64 変換関数を修正。 [#13205](https://github.com/ClickHouse/ClickHouse/pull/13205) ([Azat Khuzhin](https://github.com/azat)).
* `users.xml` から行ポリシーを解析する処理を修正し、データベース名やテーブル名にドットが含まれている場合でも正しく処理できるようにしました。これにより [#5779](https://github.com/ClickHouse/ClickHouse/issues/5779)、[#12527](https://github.com/ClickHouse/ClickHouse/issues/12527) が修正されました。[#13199](https://github.com/ClickHouse/ClickHouse/pull/13199)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 一度接続が切断された後に `redis` ディクショナリへアクセスできなくなる問題を修正しました。これは `cache` および `direct` ディクショナリレイアウトで発生する可能性があります。 [#13082](https://github.com/ClickHouse/ClickHouse/pull/13082) ([Anton Popov](https://github.com/CurtizJ))。
* 関数を含むインデックス解析の誤りを修正しました。この問題により、`MergeTree` テーブルからの読み取り時に一部のデータパーツがスキップされてしまう可能性がありました。 [#13060](https://github.com/ClickHouse/ClickHouse/issues/13060) を修正しました。 [#12406](https://github.com/ClickHouse/ClickHouse/issues/12406) を修正しました。 [#13081](https://github.com/ClickHouse/ClickHouse/pull/13081)（[Anton Popov](https://github.com/CurtizJ)）。
* `now()`, `now64()`, `randConstant()` など、クエリのスコープ内では決定的だがクエリ間では非決定的な関数を使用するリモートクエリで発生していた `Cannot convert column because it is constant but values of constants are different in source and result` エラーを修正しました。[#11327](https://github.com/ClickHouse/ClickHouse/issues/11327) を修正します。[#13075](https://github.com/ClickHouse/ClickHouse/pull/13075)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `ORDER BY` 句でタプルを使用し、かつ小さい `LIMIT` を指定したクエリで発生する可能性があったクラッシュを修正しました。[#12623](https://github.com/ClickHouse/ClickHouse/issues/12623) を解決。[#13009](https://github.com/ClickHouse/ClickHouse/pull/13009)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `UNION` と `JOIN` を含むクエリで発生していた `Block structure mismatch` エラーを修正しました。[#12602](https://github.com/ClickHouse/ClickHouse/issues/12602) を解決。[#12989](https://github.com/ClickHouse/ClickHouse/pull/12989)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `merge_with_ttl_timeout` のロジックを修正しました。有効期限の影響が、ある1つの時間間隔内で複数のパーティションに及ぶ場合に正しく動作していませんでした。（作成者: @excitoon）。[#12982](https://github.com/ClickHouse/ClickHouse/pull/12982)（[Alexander Kazakov](https://github.com/Akazz)）。
* DDLクエリから作成された範囲ハッシュ辞書で発生していたカラムの重複問題を修正しました。これにより [#10605](https://github.com/ClickHouse/ClickHouse/issues/10605) が解決されます。 [#12857](https://github.com/ClickHouse/ClickHouse/pull/12857) ([alesapin](https://github.com/alesapin))。
* ローカルレプリカからの `SELECT` クエリに対するスレッド数の不要な制限を修正。 [#12840](https://github.com/ClickHouse/ClickHouse/pull/12840) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `ALTER DELETE` と `ALTER MODIFY COLUMN` クエリが単一のミューテーションとして同時に実行されたときに発生する、まれなバグを修正しました。このバグにより `count.txt` 内の行数が誤り、その結果としてパーツ内のデータも誤った状態になる可能性がありました。また、`ALTER RENAME COLUMN` と `ALTER ADD COLUMN` を同時に実行した場合に発生する小さなバグも修正しました。 [#12760](https://github.com/ClickHouse/ClickHouse/pull/12760) ([alesapin](https://github.com/alesapin))。
* `clickhouse` ディクショナリーソースを使用してリモートテーブルをクエリする際に、誤った認証情報が使用される問題を修正。 [#12756](https://github.com/ClickHouse/ClickHouse/pull/12756) ([sundyli](https://github.com/sundy-li)).
* `CAST(Nullable(String), Enum())` を修正。 [#12745](https://github.com/ClickHouse/ClickHouse/pull/12745) ([Azat Khuzhin](https://github.com/azat)).
* `IN` 句で大きなタプルが関数として解釈される場合のパフォーマンスを改善しました。ユーザーが何らかのよくわからない理由で `WHERE x IN (1, 2, ...)` ではなく `WHERE x IN tuple(1, 2, ...)` と記述するケースに対応します。[#12700](https://github.com/ClickHouse/ClickHouse/pull/12700)（[Anton Popov](https://github.com/CurtizJ)）。
* input&#95;format&#95;parallel&#95;parsing のメモリトラッキングを修正（スレッドをグループに関連付け）。[#12672](https://github.com/ClickHouse/ClickHouse/pull/12672)（[Azat Khuzhin](https://github.com/azat)）。
* `any(func(<lambda>))` の場合に誤って行われていた最適化 `optimize_move_functions_out_of_any=1` を修正。 [#12664](https://github.com/ClickHouse/ClickHouse/pull/12664) ([Artem Zuikov](https://github.com/4ertus2)).
* 定数式を使用する Bloom filter インデックスの問題を修正しました [#10572](https://github.com/ClickHouse/ClickHouse/issues/10572)。 [#12659](https://github.com/ClickHouse/ClickHouse/pull/12659)（[Winter Zhang](https://github.com/zhang2014)）。
* ブローカーが利用できない場合などに StorageKafka で発生する SIGSEGV を修正しました。[#12658](https://github.com/ClickHouse/ClickHouse/pull/12658) ([Azat Khuzhin](https://github.com/azat)).
* 関数 `if` が `Array(UUID)` 引数を受け付けるようになりました。これにより [#11066](https://github.com/ClickHouse/ClickHouse/issues/11066) が修正されました。 [#12648](https://github.com/ClickHouse/ClickHouse/pull/12648) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `CREATE USER IF NOT EXISTS` は、ユーザーが既に存在する場合に例外をスローしなくなりました。これにより [#12507](https://github.com/ClickHouse/ClickHouse/issues/12507) が解決されました。 [#12646](https://github.com/ClickHouse/ClickHouse/pull/12646)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 例外 `There is no supertype...` が、`ALTER ... UPDATE` の実行中に（例えば UInt64 カラムからの減算時など）予期しないケースでスローされることがあります。これにより [#7306](https://github.com/ClickHouse/ClickHouse/issues/7306) が修正されます。また [#4165](https://github.com/ClickHouse/ClickHouse/issues/4165) も修正されます。 [#12633](https://github.com/ClickHouse/ClickHouse/pull/12633)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 外部ソートを行うクエリで発生する可能性のある `Pipeline stuck` エラーを修正。[#12617](https://github.com/ClickHouse/ClickHouse/issues/12617) に対応。[#12618](https://github.com/ClickHouse/ClickHouse/pull/12618)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `OPTIMIZE DEDUPLICATE` で発生していたエラー `Output of TreeExecutor is not sorted` を修正しました。[#11572](https://github.com/ClickHouse/ClickHouse/issues/11572) を解決。[#12613](https://github.com/ClickHouse/ClickHouse/pull/12613) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* クエリ最適化中に関数 `any` の結果に付けたエイリアスが失われてしまう可能性がある問題を修正しました。 [#12593](https://github.com/ClickHouse/ClickHouse/pull/12593) ([Anton Popov](https://github.com/CurtizJ)).
* `DROP TABLE` の実行時に Distributed テーブルのデータ（非同期 `INSERT` によるブロック）を削除する。 [#12556](https://github.com/ClickHouse/ClickHouse/pull/12556) ([Azat Khuzhin](https://github.com/azat))。
* `checksums.txt` ファイルが存在しない場合、ClickHouse はパーツのチェックサムを再計算するようになりました。[#9827](https://github.com/ClickHouse/ClickHouse/issues/9827) 以降、この動作は壊れていました。[#12545](https://github.com/ClickHouse/ClickHouse/pull/12545) ([alesapin](https://github.com/alesapin))。
* `enable_mixed_granularity_parts=1` のときに `ALTER DELETE` クエリによって古いパーツが破損してしまう原因となっていたバグを修正しました。 [#12536](https://github.com/ClickHouse/ClickHouse/issues/12536) を修正。 [#12543](https://github.com/ClickHouse/ClickHouse/pull/12543) ([alesapin](https://github.com/alesapin))。
* データ重複を引き起こす可能性があったライブビュー・テーブルのレースコンディションを修正しました。LIVE VIEW は実験的機能です。 [#12519](https://github.com/ClickHouse/ClickHouse/pull/12519) ([vzakaznikov](https://github.com/vzakaznikov)).
* `AggregateFunction(avg, ...)` の値のバイナリフォーマットの後方互換性を修正しました。これにより [#12342](https://github.com/ClickHouse/ClickHouse/issues/12342) が解決されます。 [#12486](https://github.com/ClickHouse/ClickHouse/pull/12486) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 辞書キーの式で結合を行う場合（`t JOIN dict ON expr(dict.id) = t.id`）に、辞書を用いた `JOIN` でクラッシュする問題を修正。 このケースでは辞書 `JOIN` に対する最適化を無効化。 [#12458](https://github.com/ClickHouse/ClickHouse/pull/12458) ([Artem Zuikov](https://github.com/4ertus2)).
* 非常に大きな LIMIT または OFFSET が指定された場合に発生するオーバーフローを修正します。これにより [#10470](https://github.com/ClickHouse/ClickHouse/issues/10470) および [#11372](https://github.com/ClickHouse/ClickHouse/issues/11372) の問題が解決されます。[#12427](https://github.com/ClickHouse/ClickHouse/pull/12427)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* kafka: バッチ内にエラーを含むメッセージがある場合に SIGSEGV が発生する問題を修正。 [#12302](https://github.com/ClickHouse/ClickHouse/pull/12302) ([Azat Khuzhin](https://github.com/azat)).

#### 改善 {#improvement-13}


* ZooKeeper 内に保持するログ量を少なく抑えます。多数のサーバーやテーブル、挿入処理が存在する場合でも、オフラインレプリカによって ZooKeeper ノードが過度に増加するのを回避します。 [#13100](https://github.com/ClickHouse/ClickHouse/pull/13100) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `ALTER` またはミューテーションの実行中にエラーが発生した場合、その例外がクライアントに転送されるようになりました。[#11329](https://github.com/ClickHouse/ClickHouse/issues/11329) をクローズしました。 [#12666](https://github.com/ClickHouse/ClickHouse/pull/12666) ([alesapin](https://github.com/alesapin)).
* `QueryTimeMicroseconds`、`SelectQueryTimeMicroseconds`、`InsertQueryTimeMicroseconds` を `system.events` に追加し、同様に `system.metrics`、`processes`、`query_log` などにも追加しました。[#13028](https://github.com/ClickHouse/ClickHouse/pull/13028)（[ianton-ru](https://github.com/ianton-ru)）。
* `system.events` に `SelectedRows` と `SelectedBytes` を追加し、あわせて `system.metrics`、`processes`、`query_log` などにも追加しました。 [#12638](https://github.com/ClickHouse/ClickHouse/pull/12638) ([ianton-ru](https://github.com/ianton-ru))。
* `system.query_log` に `current_database` 情報を追加しました。 [#12652](https://github.com/ClickHouse/ClickHouse/pull/12652) ([Amos Bird](https://github.com/amosbird))。
* `TabSeparatedRaw` を入力フォーマットとして使用可能にしました。 [#12009](https://github.com/ClickHouse/ClickHouse/pull/12009) ([hcz](https://github.com/hczhcz)).
* `joinGet` で複数キー検索がサポートされるようになりました。 [#12418](https://github.com/ClickHouse/ClickHouse/pull/12418) ([Amos Bird](https://github.com/amosbird))。
* NULL を含む Array 上でも `*Map` 集約関数が動作するようにしました。 [#13157](https://github.com/ClickHouse/ClickHouse/issues/13157) を修正。 [#13225](https://github.com/ClickHouse/ClickHouse/pull/13225)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* タイムゾーンにおいて負の Unix タイムスタンプになってしまう `DateTime` 値のパース時に発生するオーバーフローを回避します（例: モスクワ時間の `1970-01-01 00:00:00`）。代わりに 0 にサチュレートします。これにより [#3470](https://github.com/ClickHouse/ClickHouse/issues/3470) が修正されます。これにより [#4172](https://github.com/ClickHouse/ClickHouse/issues/4172) が修正されます。[#12443](https://github.com/ClickHouse/ClickHouse/pull/12443)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* AvroConfluent: Kafka のトゥームストーンレコードをスキップ - 破損したレコードのスキップをサポート [#13203](https://github.com/ClickHouse/ClickHouse/pull/13203) ([Andrew Onyshchuk](https://github.com/oandrew)).
* 長いクエリに対して不適切なエラーが発生する問題を修正。正しいクエリに対しても、`Max query size exceeded` とは異なる構文エラーが返される可能性がありました。[#13928](https://github.com/ClickHouse/ClickHouse/pull/13928)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `lgamma` 関数におけるデータレースを修正しました。このデータレースは `tsan` でのみ検出され、実際には副作用は発生していませんでした。[#13842](https://github.com/ClickHouse/ClickHouse/pull/13842)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* ATTACH/ALTER/CREATE QUOTA ステートメントにおける「Week」間隔のフォーマットを修正。 [#13417](https://github.com/ClickHouse/ClickHouse/pull/13417) ([vladimir-golovchenko](https://github.com/vladimir-golovchenko)).
* コンパクトパーツの処理中に遭遇した破損パーツも、現在は報告されるようになりました。コンパクトパーツは実験的な機能です。 [#13282](https://github.com/ClickHouse/ClickHouse/pull/13282) ([Amos Bird](https://github.com/amosbird))。
* `geohashesInBox` のアサーションを修正。これにより [#12554](https://github.com/ClickHouse/ClickHouse/issues/12554) が解決されます。[#13229](https://github.com/ClickHouse/ClickHouse/pull/13229)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `parseDateTimeBestEffort` 内のアサーションを修正。これにより [#12649](https://github.com/ClickHouse/ClickHouse/issues/12649) が解決されます。 [#13227](https://github.com/ClickHouse/ClickHouse/pull/13227) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* Processors/PipelineExecutor に軽微な最適化を実施: ループを適切なタイミングで抜けるようにした。 [#13058](https://github.com/ClickHouse/ClickHouse/pull/13058) ([Mark Papadakis](https://github.com/markpapadakis)).
* TABLE キーワードなしの TRUNCATE TABLE をサポート。 [#12653](https://github.com/ClickHouse/ClickHouse/pull/12653) ([Winter Zhang](https://github.com/zhang2014)).
* `EXPLAIN` クエリのフォーマットがデフォルトで上書きされていた問題を修正しました。これにより [#12541](https://github.com/ClickHouse/ClickHouse/issues/12432) が解決されました。[#12541](https://github.com/ClickHouse/ClickHouse/pull/12541)（[BohuTANG](https://github.com/BohuTANG)）。
* JOIN の種類とタイプを、より標準的な方法で指定できるようにしました。`SEMI LEFT JOIN` の代わりに `LEFT SEMI JOIN` を使用できます。現時点ではどちらも使用可能です。[#12520](https://github.com/ClickHouse/ClickHouse/pull/12520) ([Artem Zuikov](https://github.com/4ertus2)).
* `multiple_joins_rewriter_version` のデフォルト値を 2 に変更しました。これにより、列名を認識できる新しい multiple joins rewriter が有効になります。 [#12469](https://github.com/ClickHouse/ClickHouse/pull/12469) ([Artem Zuikov](https://github.com/4ertus2))。
* S3 ストレージへのリクエストに関する複数のメトリクスを追加しました。 [#12464](https://github.com/ClickHouse/ClickHouse/pull/12464) ([ianton-ru](https://github.com/ianton-ru)).
* `--secure` 引数を指定した場合に、`clickhouse-benchmark` が正しいデフォルトのセキュアポートを使用するようにしました。これにより [#11044](https://github.com/ClickHouse/ClickHouse/issues/11044) が修正されました。 [#12440](https://github.com/ClickHouse/ClickHouse/pull/12440) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `Log`、`TinyLog`、`StripeLog` エンジンで挿入エラーが発生した場合にロールバックするようにしました。以前のバージョンでは、挿入エラーによってテーブル状態の不整合を招くことがありました（これはドキュメントで説明されているとおりの動作であり、これらのテーブルエンジンでは想定された挙動です）。この変更により [#12402](https://github.com/ClickHouse/ClickHouse/issues/12402) が解決されました。 [#12426](https://github.com/ClickHouse/ClickHouse/pull/12426)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `Atomic` データベースエンジン向けに `RENAME DATABASE` および `RENAME DICTIONARY` を実装。- 暗黙の `{uuid}` マクロを追加。これは `ReplicatedMergeTree` の ZooKeeper パスで使用でき、`CREATE ... ON CLUSTER ...` クエリで動作します。これを使用するには、`show_table_uuid_in_table_create_query_if_not_nil` を `true` に設定してください。- `ReplicatedMergeTree` エンジンの引数を省略可能にし、デフォルトで `/clickhouse/tables/{uuid}/{shard}/` および `{replica}` が使用されます。[#12135](https://github.com/ClickHouse/ClickHouse/issues/12135) をクローズ。- 軽微な修正。- これらの変更により、`Atomic` データベースエンジンとの後方互換性は失われます。以前に作成された `Atomic` データベースは、新しい形式へ手動で変換する必要があります。`Atomic` データベースは実験的機能です。[#12343](https://github.com/ClickHouse/ClickHouse/pull/12343)（[tavplubix](https://github.com/tavplubix)）。
* `AWSAuthV4Signer` を別のロガーに切り出し、ログメッセージから過剰な `AWSClient: AWSClient` を削除しました。 [#12320](https://github.com/ClickHouse/ClickHouse/pull/12320) ([Vladimir Chebotarev](https://github.com/excitoon)).
* ディスクアクセスストレージの例外メッセージを改善。 [#12625](https://github.com/ClickHouse/ClickHouse/pull/12625) ([alesapin](https://github.com/alesapin)).
* 無効な引数の個数が指定された場合に、関数 `in` がスローする例外を改善しました。 [#12529](https://github.com/ClickHouse/ClickHouse/pull/12529) ([Anton Popov](https://github.com/CurtizJ)).
* アダプティブグラニュラリティに関するエラーメッセージを修正。 [#12624](https://github.com/ClickHouse/ClickHouse/pull/12624) ([alesapin](https://github.com/alesapin))。
* FORMAT の後の SETTINGS のパースを修正。 [#12480](https://github.com/ClickHouse/ClickHouse/pull/12480) ([Azat Khuzhin](https://github.com/azat))。
* MergeTree テーブルに `ORDER BY` または `PARTITION BY` が含まれていない場合、すべてのカラムを `CLEAR` する `ALTER` を要求できてしまい、その `ALTER` がハングしてしまう可能性がありました。この問題を修正しました。[#7941](https://github.com/ClickHouse/ClickHouse/issues/7941)。[#12382](https://github.com/ClickHouse/ClickHouse/pull/12382)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 各クエリ実行後に履歴ファイルから補完情報を再読み込みしないようにしました（他のクライアントセッションとの履歴の重複を避けるため）。 [#13086](https://github.com/ClickHouse/ClickHouse/pull/13086) ([Azat Khuzhin](https://github.com/azat)).

#### パフォーマンス改善 {#performance-improvement-6}

- 一部の操作におけるメモリ使用量を最大2倍削減しました。[#12424](https://github.com/ClickHouse/ClickHouse/pull/12424) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 正確なプライマリキー範囲に一致するクエリのプライマリキー検索を最適化しました。[#12277](https://github.com/ClickHouse/ClickHouse/pull/12277) ([Ivan Babrou](https://github.com/bobrik))。
- `LowCardinality`を使用する非常に短いクエリをわずかに最適化しました。[#14129](https://github.com/ClickHouse/ClickHouse/pull/14129) ([Anton Popov](https://github.com/CurtizJ))。
- UInt8/UInt16キーによる集計のパフォーマンスをわずかに改善しました。[#13091](https://github.com/ClickHouse/ClickHouse/pull/13091) および [#13055](https://github.com/ClickHouse/ClickHouse/pull/13055) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- クエリプランの`LIMIT`ステップをプッシュダウンしました(サブクエリ内)。[#13016](https://github.com/ClickHouse/ClickHouse/pull/13016) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- [#11564](https://github.com/ClickHouse/ClickHouse/issues/11564)で説明されているように、パート上でのプライマリキー検索とスキップインデックスステージの並列化を実装しました。[#12589](https://github.com/ClickHouse/ClickHouse/pull/12589) ([Ivan Babrou](https://github.com/bobrik))。
- `set optimize_if_transform_strings_to_enum = 1`の場合、関数「if」および「transform」の文字列型引数を列挙型に変換します。[#12515](https://github.com/ClickHouse/ClickHouse/pull/12515) ([Artem Zuikov](https://github.com/4ertus2))。
- `set optimize_monotonous_functions_in_order_by=1`の場合、`ORDER BY`内の単調関数をその引数で置き換えます。[#12467](https://github.com/ClickHouse/ClickHouse/pull/12467) ([Artem Zuikov](https://github.com/4ertus2))。
- `set optimize_redundant_functions_in_order_by = 1`の場合、`ORDER BY x, f(x)`を`ORDER BY x`に書き換える最適化を追加しました。[#12404](https://github.com/ClickHouse/ClickHouse/pull/12404) ([Artem Zuikov](https://github.com/4ertus2))。
- サブクエリに`WITH`句が含まれる場合に述語のプッシュダウンを許可しました。これにより[#12293](https://github.com/ClickHouse/ClickHouse/issues/12293)が修正されました。[#12663](https://github.com/ClickHouse/ClickHouse/pull/12663) ([Winter Zhang](https://github.com/zhang2014))。
- コンパクトパートからの読み取りパフォーマンスを改善しました。コンパクトパートは実験的機能です。[#12492](https://github.com/ClickHouse/ClickHouse/pull/12492) ([Anton Popov](https://github.com/CurtizJ))。
- `DiskS3`にストリーミング最適化の実装を試みました。DiskS3は実験的機能です。[#12434](https://github.com/ClickHouse/ClickHouse/pull/12434) ([Vladimir Chebotarev](https://github.com/excitoon))。

#### ビルド/テスト/パッケージング改善 {#buildtestingpackaging-improvement-8}


* `sh` テストのリントに `shellcheck` を使用します。 [#13200](https://github.com/ClickHouse/ClickHouse/pull/13200) [#13207](https://github.com/ClickHouse/ClickHouse/pull/13207) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* GitHub フックでプルリクエストにラベルを設定するスクリプトを追加しました。 [#13183](https://github.com/ClickHouse/ClickHouse/pull/13183) ([alesapin](https://github.com/alesapin)).
* 一部の再帰サブモジュールを削除しました。詳細は [#13378](https://github.com/ClickHouse/ClickHouse/issues/13378) を参照してください。[#13379](https://github.com/ClickHouse/ClickHouse/pull/13379)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* すべてのサブモジュールが適切な URL を参照していることを確認します。[#13379](https://github.com/ClickHouse/ClickHouse/issues/13379) の続きです。これにより [#13378](https://github.com/ClickHouse/ClickHouse/issues/13378) が修正されます。[#13397](https://github.com/ClickHouse/ClickHouse/pull/13397)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* クエリ内からアクセス可能なユーザー定義設定のサポートを追加しました。これは、ClickHouse エンジンが他のシステムのコンポーネントとして利用される場合に必要となります。 [#13013](https://github.com/ClickHouse/ClickHouse/pull/13013) ([Vitaly Baranov](https://github.com/vitlibar))。
* TestFlows において、RBAC における INSERT 権限の動作を検証するテストを追加しました。SELECT のテスト対象となるテーブルを拡充しました。新しいテーブルエンジンのテストに対応する Requirements を追加しました。 [#13340](https://github.com/ClickHouse/ClickHouse/pull/13340) ([MyroTk](https://github.com/MyroTk)).
* ストレステスト時のサーバー再起動で発生するタイムアウトエラーを修正。 [#13321](https://github.com/ClickHouse/ClickHouse/pull/13321) ([alesapin](https://github.com/alesapin)).
* fast test は、サーバー待機時にリトライを行うようになりました。 [#13284](https://github.com/ClickHouse/ClickHouse/pull/13284) ([alesapin](https://github.com/alesapin))。
* Function `materialize()`（ClickHouse のテスト用関数）は、NULL に対しても期待どおりに動作し、NULL を非定数カラムに変換します。 [#13212](https://github.com/ClickHouse/ClickHouse/pull/13212) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* AArch64 における libunwind のビルドを修正。これにより [#13204](https://github.com/ClickHouse/ClickHouse/issues/13204) が解決されます。[#13208](https://github.com/ClickHouse/ClickHouse/pull/13208)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* テストの不安定さを防ぐために、`zkutil gtest` におけるリトライ回数をさらに増やしました。 [#13165](https://github.com/ClickHouse/ClickHouse/pull/13165) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* RBAC TestFlows に対する細かな修正。 [#13152](https://github.com/ClickHouse/ClickHouse/pull/13152) ([vzakaznikov](https://github.com/vzakaznikov)).
* `00960_live_view_watch_events_live.py` テストを修正。 [#13108](https://github.com/ClickHouse/ClickHouse/pull/13108) ([vzakaznikov](https://github.com/vzakaznikov)).
* ドキュメントのデプロイスクリプトにおけるキャッシュパージ処理を改善。 [#13107](https://github.com/ClickHouse/ClickHouse/pull/13107) ([alesapin](https://github.com/alesapin)).
* いくつかの孤立したテストを gtest に移行し、テストから不要なインクルードを削除しました。 [#13073](https://github.com/ClickHouse/ClickHouse/pull/13073) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* TestFlows において、`SELECT` 権限の RBAC 機能に関するテストを追加しました。 [#13061](https://github.com/ClickHouse/ClickHouse/pull/13061) ([Ritaank Tiwari](https://github.com/ritaank)).
* fast test check でいくつかのテストを再実行しました。 [#12992](https://github.com/ClickHouse/ClickHouse/pull/12992) ([alesapin](https://github.com/alesapin))。
* 「rdkafka」ライブラリにおける MSan エラーを修正しました。これにより [#12990](https://github.com/ClickHouse/ClickHouse/issues/12990) が解決されます。`rdkafka` をバージョン 1.5（master）に更新しました。[#12991](https://github.com/ClickHouse/ClickHouse/pull/12991) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* テストが AVX-512 対応サーバー上で実行された場合に base64 で発生する UBSan レポートを修正しました。これにより [#12318](https://github.com/ClickHouse/ClickHouse/issues/12318) が解決されました。著者: @qoega。 [#12441](https://github.com/ClickHouse/ClickHouse/pull/12441)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* HDFS ライブラリにおける UBSan レポート上の問題を修正。これにより [#12330](https://github.com/ClickHouse/ClickHouse/issues/12330) をクローズします。[#12453](https://github.com/ClickHouse/ClickHouse/pull/12453)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 古いバージョンのバックアップを新しいバージョンで復元できることを確認しました。これにより [#8979](https://github.com/ClickHouse/ClickHouse/issues/8979) が解決されました。[#12959](https://github.com/ClickHouse/ClickHouse/pull/12959) ([alesapin](https://github.com/alesapin))。
* 統合テスト内で helper&#95;container イメージをビルドしないでください。CI で Docker コンテナをビルドし、統合テストでは事前ビルド済みの helper&#95;container を使用してください。 [#12953](https://github.com/ClickHouse/ClickHouse/pull/12953) ([Ilya Yatsishin](https://github.com/qoega))。
* プライマリキー列に対する `ALTER TABLE CLEAR COLUMN` クエリのテストを追加。 [#12951](https://github.com/ClickHouse/ClickHouse/pull/12951) ([alesapin](https://github.com/alesapin)).
* testflows テストのタイムアウト値を増やしました。[#12949](https://github.com/ClickHouse/ClickHouse/pull/12949) ([vzakaznikov](https://github.com/vzakaznikov)).
* Mac OS X 上でのテストのビルドを修正しました。これにより [#12767](https://github.com/ClickHouse/ClickHouse/issues/12767) がクローズされます。 [#12772](https://github.com/ClickHouse/ClickHouse/pull/12772)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* Connector-ODBC を mysql-connector-odbc-8.0.21 に更新しました。 [#12739](https://github.com/ClickHouse/ClickHouse/pull/12739) ([Ilya Yatsishin](https://github.com/qoega)).
* TestFlows に RBAC 構文テストを追加。 [#12642](https://github.com/ClickHouse/ClickHouse/pull/12642) ([vzakaznikov](https://github.com/vzakaznikov))。
* TestKeeper のパフォーマンスを改善しました。これにより、Replicated テーブルを集中的に利用するテストが高速化されます。 [#12505](https://github.com/ClickHouse/ClickHouse/pull/12505) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* ストレステストの実行後にサーバーが起動できることを確認するようにしました。これにより [#12473](https://github.com/ClickHouse/ClickHouse/issues/12473) が修正されます。[#12496](https://github.com/ClickHouse/ClickHouse/pull/12496)（[alesapin](https://github.com/alesapin)）。
* fmtlib を master ブランチ（7.0.1）に更新。 [#12446](https://github.com/ClickHouse/ClickHouse/pull/12446) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 高速テスト用の Docker イメージを追加。[#12294](https://github.com/ClickHouse/ClickHouse/pull/12294) ([alesapin](https://github.com/alesapin))。
* 統合テスト向けの設定パスを再構成。 [#12285](https://github.com/ClickHouse/ClickHouse/pull/12285) ([Ilya Yatsishin](https://github.com/qoega)).
* スタックフレームが大きくなりすぎないよう制御するコンパイラオプションを追加しました。これにより、スタックサイズが小さいファイバー内でもコードを実行できるようになります。 [#11524](https://github.com/ClickHouse/ClickHouse/pull/11524) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* gitignore ファイルを更新しました。 [#13447](https://github.com/ClickHouse/ClickHouse/pull/13447) ([vladimir-golovchenko](https://github.com/vladimir-golovchenko)).





## ClickHouse リリース 20.6 {#clickhouse-release-206}

### ClickHouse リリース v20.6.3.28-stable {#clickhouse-release-v206328-stable}

#### 後方互換性のない変更 {#backward-incompatible-change-6}

- 20.5より古いバージョンからアップグレードする際、ローリングアップデートを実行し、クラスタに20.5以上のバージョンと20.5未満のバージョンが混在している場合、古いバージョンのClickHouseノードを再起動すると、新しいバージョンが存在する状態で古いバージョンが起動し、`Part ... intersects previous part`エラーが発生する可能性があります。このエラーを防ぐには、まずすべてのクラスタノードに新しいclickhouse-serverパッケージをインストールしてから再起動を行ってください(これにより、clickhouse-serverの再起動時に新しいバージョンで起動します)。

#### 新機能 {#new-feature-6}

- `EXPLAIN`クエリの初期実装を追加しました。構文: `EXPLAIN SELECT ...`。これにより[#1118](https://github.com/ClickHouse/ClickHouse/issues/1118)が修正されます。[#11873](https://github.com/ClickHouse/ClickHouse/pull/11873) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- `RabbitMQ`ストレージを追加しました。[#11069](https://github.com/ClickHouse/ClickHouse/pull/11069) ([Kseniia Sumarokova](https://github.com/kssenii))。
- PostgreSQL風の`ILIKE`演算子を実装しました([#11710](https://github.com/ClickHouse/ClickHouse/issues/11710))。[#12125](https://github.com/ClickHouse/ClickHouse/pull/12125) ([Mike](https://github.com/myrrc))。
- `SET join_algorithm = 'partial_merge'`でのRIGHTおよびFULL JOINをサポートしました。ALL厳密性のみが許可されます(ANY、SEMI、ANTI、ASOFは許可されません)。[#12118](https://github.com/ClickHouse/ClickHouse/pull/12118) ([Artem Zuikov](https://github.com/4ertus2))。
- 単一の値に基づいて集計を初期化する`initializeAggregation`関数を追加しました。[#12109](https://github.com/ClickHouse/ClickHouse/pull/12109) ([Guillaume Tassery](https://github.com/YiuRULE))。
- `ALTER TABLE ... [ADD|MODIFY] COLUMN ... FIRST`をサポートしました([#4006](https://github.com/ClickHouse/ClickHouse/issues/4006))。[#12073](https://github.com/ClickHouse/ClickHouse/pull/12073) ([Winter Zhang](https://github.com/zhang2014))。
- `parseDateTimeBestEffortUS`関数を追加しました。[#12028](https://github.com/ClickHouse/ClickHouse/pull/12028) ([flynn](https://github.com/ucasFL))。
- 出力用の`ORC`フォーマットをサポートしました(以前は入力のみサポート)。[#11662](https://github.com/ClickHouse/ClickHouse/pull/11662) ([Kruglov Pavel](https://github.com/Avogar))。

#### バグ修正 {#bug-fix-25}


* クエリ内で発生する `aggregate function any(x) is found inside another aggregate function in query` エラーを、`SET optimize_move_functions_out_of_any = 1` と `any()` 内のエイリアスの使用により解消しました。 [#13419](https://github.com/ClickHouse/ClickHouse/pull/13419) ([Artem Zuikov](https://github.com/4ertus2)).
* clickhouse-local 向けの `PrettyCompactMonoBlock` を修正しました。`PrettyCompactMonoBlock` 使用時の extremes/totals の動作を修正しました。これにより [#7746](https://github.com/ClickHouse/ClickHouse/issues/7746) が解決されました。 [#13394](https://github.com/ClickHouse/ClickHouse/pull/13394) ([Azat Khuzhin](https://github.com/azat)).
* 遅延レプリカからのクエリで発生する可能性があった `Totals having transform was already added to pipeline` エラーを修正しました。 [#13290](https://github.com/ClickHouse/ClickHouse/pull/13290) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* ユーザーが関数 `h3ToChildren` に特別に細工された引数を渡した場合、サーバーがクラッシュするおそれがありました。これにより [#13275](https://github.com/ClickHouse/ClickHouse/issues/13275) が修正されました。 [#13277](https://github.com/ClickHouse/ClickHouse/pull/13277)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* NaN 値を含む Float 型のデータに対して実行された `uniqExact`、`topK`、`sumDistinct` などの集約関数における、潜在的なパフォーマンス低下およびわずかに不正確な結果を修正しました。また、デバッグビルドで `assert` が発生する問題も引き起こしていました。この変更により [#12491](https://github.com/ClickHouse/ClickHouse/issues/12491) が修正されました。 [#13254](https://github.com/ClickHouse/ClickHouse/pull/13254) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* リテラルの `NULL` ではない nullable な `constexpr` を条件に取る `if` 関数の不具合を修正しました。[#12463](https://github.com/ClickHouse/ClickHouse/issues/12463) を解決します。[#13226](https://github.com/ClickHouse/ClickHouse/pull/13226)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 配列要素と配列添字がともに Nullable である場合の `arrayElement` 関数における `assert` を修正しました。これにより [#12172](https://github.com/ClickHouse/ClickHouse/issues/12172) の問題が解決されました。 [#13224](https://github.com/ClickHouse/ClickHouse/pull/13224)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 定数引数を取る `DateTime64` 変換関数を修正しました。 [#13205](https://github.com/ClickHouse/ClickHouse/pull/13205) ([Azat Khuzhin](https://github.com/azat)).
* 関数を使用した場合の誤ったインデックス解析を修正しました。この問題により、`MergeTree` テーブルから読み取る際に誤ったパーツがプルーニングされる可能性がありました。[#13060](https://github.com/ClickHouse/ClickHouse/issues/13060) を修正しました。[#12406](https://github.com/ClickHouse/ClickHouse/issues/12406) を修正しました。[#13081](https://github.com/ClickHouse/ClickHouse/pull/13081)（[Anton Popov](https://github.com/CurtizJ)）。
* `now()`, `now64()`, `randConstant()` のように、クエリのスコープ内では決定論的だがクエリ間では決定論的ではない関数を使用するリモートクエリで発生していた `Cannot convert column because it is constant but values of constants are different in source and result` というエラーを修正しました。 [#11327](https://github.com/ClickHouse/ClickHouse/issues/11327) を修正。 [#13075](https://github.com/ClickHouse/ClickHouse/pull/13075)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* ローカルレプリカからの SELECT に対するスレッド数の不要な制限を解消しました。 [#12840](https://github.com/ClickHouse/ClickHouse/pull/12840) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `ALTER DELETE` と `ALTER MODIFY COLUMN` クエリが 1 つのミューテーションとして同時に実行された場合に発生するまれなバグを修正しました。このバグにより、`count.txt` 内の行数が不正となり、その結果パート内のデータも不正になる問題がありました。また、`ALTER RENAME COLUMN` と `ALTER ADD COLUMN` を同時に実行した場合に発生する小さなバグも修正しました。 [#12760](https://github.com/ClickHouse/ClickHouse/pull/12760) ([alesapin](https://github.com/alesapin)).
* `CAST(Nullable(String), Enum())` の不具合を修正しました。 [#12745](https://github.com/ClickHouse/ClickHouse/pull/12745) ([Azat Khuzhin](https://github.com/azat)).
* `IN` 句において、大きなタプルが関数として解釈される場合のパフォーマンス問題を修正しました。ユーザーが、何らかのよくわからない理由で `WHERE x IN (1, 2, ...)` ではなく `WHERE x IN tuple(1, 2, ...)` と記述するケースです。 [#12700](https://github.com/ClickHouse/ClickHouse/pull/12700) ([Anton Popov](https://github.com/CurtizJ))。
* `input_format_parallel_parsing` のメモリ追跡を修正（スレッドをグループにアタッチすることで実現）。 [#12672](https://github.com/ClickHouse/ClickHouse/pull/12672) ([Azat Khuzhin](https://github.com/azat)).
* const 式を使用する固定 Bloom フィルタインデックスを修正しました。これにより [#10572](https://github.com/ClickHouse/ClickHouse/issues/10572) が解決されました。[#12659](https://github.com/ClickHouse/ClickHouse/pull/12659)（[Winter Zhang](https://github.com/zhang2014)）。
* ブローカーが利用できない場合などに `StorageKafka` で発生していた `SIGSEGV` を修正しました。 [#12658](https://github.com/ClickHouse/ClickHouse/pull/12658) ([Azat Khuzhin](https://github.com/azat)).
* `Array(UUID)` 型の引数を取る関数 `if` のサポートを追加しました。これにより [#11066](https://github.com/ClickHouse/ClickHouse/issues/11066) が修正されました。[#12648](https://github.com/ClickHouse/ClickHouse/pull/12648)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `CREATE USER IF NOT EXISTS` は、ユーザーが存在する場合に例外をスローしなくなりました。これにより [#12507](https://github.com/ClickHouse/ClickHouse/issues/12507) が修正されました。 [#12646](https://github.com/ClickHouse/ClickHouse/pull/12646) ([Vitaly Baranov](https://github.com/vitlibar))。
* ディスクアクセスストレージでの例外メッセージを改善。 [#12625](https://github.com/ClickHouse/ClickHouse/pull/12625) ([alesapin](https://github.com/alesapin))。
* 関数 `groupArrayMoving*` は分散クエリに対して正しく動作していませんでした。結果は不適切なデータ型（最大の型への型昇格なし）で計算されていました。関数 `groupArrayMovingAvg` は `avg` 関数と一貫性のない整数値を返していました。これにより [#12568](https://github.com/ClickHouse/ClickHouse/issues/12568) が修正されました。 [#12622](https://github.com/ClickHouse/ClickHouse/pull/12622)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 関数 `any` でエイリアスが使用できなかった問題を修正。[#12593](https://github.com/ClickHouse/ClickHouse/pull/12593) ([Anton Popov](https://github.com/CurtizJ))。
* キャッシュレイアウトを使用する外部ディクショナリにおいて、サーバーのクラッシュを引き起こす可能性のあったレースコンディションを修正しました。 [#12566](https://github.com/ClickHouse/ClickHouse/pull/12566) ([alesapin](https://github.com/alesapin)).
* DROP TABLE 時に Distributed テーブルのデータ（非同期 INSERT によるブロック）を削除するようになりました。 [#12556](https://github.com/ClickHouse/ClickHouse/pull/12556) ([Azat Khuzhin](https://github.com/azat)).
* `enable_mixed_granularity_parts=1` のときに `ALTER DELETE` クエリを実行すると古いパーツが破損してしまうバグを修正しました。これは [#12536](https://github.com/ClickHouse/ClickHouse/issues/12536) の修正です。 [#12543](https://github.com/ClickHouse/ClickHouse/pull/12543) ([alesapin](https://github.com/alesapin))。
* 引数の数が不正な場合の関数 `in` の例外メッセージを改善。 [#12529](https://github.com/ClickHouse/ClickHouse/pull/12529) ([Anton Popov](https://github.com/CurtizJ))。
* Live View テーブルにおけるデータ重複を引き起こす可能性のあるレースコンディションを修正。 [#12519](https://github.com/ClickHouse/ClickHouse/pull/12519) ([vzakaznikov](https://github.com/vzakaznikov)).
* コンパクトパーツからの読み取りにおけるパフォーマンス問題を修正。 [#12492](https://github.com/ClickHouse/ClickHouse/pull/12492) ([Anton Popov](https://github.com/CurtizJ)).
* `AggregateFunction(avg, ...)` の値のバイナリ形式に関する後方互換性の問題を修正しました。これにより [#12342](https://github.com/ClickHouse/ClickHouse/issues/12342) が解決されました。 [#12486](https://github.com/ClickHouse/ClickHouse/pull/12486) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* FORMAT 以降の SETTINGS のパースを修正しました。 [#12480](https://github.com/ClickHouse/ClickHouse/pull/12480) ([Azat Khuzhin](https://github.com/azat))。
* `text_log` が有効になっている場合に発生していたデッドロックを修正しました。 [#12452](https://github.com/ClickHouse/ClickHouse/pull/12452) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 非常に大きな `LIMIT` または `OFFSET` が指定された場合に発生していたオーバーフローの問題を修正しました。これにより [#10470](https://github.com/ClickHouse/ClickHouse/issues/10470) および [#11372](https://github.com/ClickHouse/ClickHouse/issues/11372) が修正されました。 [#12427](https://github.com/ClickHouse/ClickHouse/pull/12427) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `StorageMerge` でセグメンテーションフォルトが発生する可能性があった問題を修正しました。これにより [#12054](https://github.com/ClickHouse/ClickHouse/issues/12054) が修正されます。[#12401](https://github.com/ClickHouse/ClickHouse/pull/12401)（[tavplubix](https://github.com/tavplubix)）。
* [#12098](https://github.com/ClickHouse/ClickHouse/issues/12098) を解決するため、[#11079](https://github.com/ClickHouse/ClickHouse/issues/11079) で導入された変更を元に戻しました。 [#12397](https://github.com/ClickHouse/ClickHouse/pull/12397) ([Mike](https://github.com/myrrc))。
* ブルームフィルターインデックスの引数に対する追加チェックを行いました。これにより [#11408](https://github.com/ClickHouse/ClickHouse/issues/11408) の問題が修正されました。[#12388](https://github.com/ClickHouse/ClickHouse/pull/12388)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* インデックス付きテーブルの WHERE 条件で負の定数または浮動小数点定数が使用された場合に例外が発生しないようにしました。これにより [#11905](https://github.com/ClickHouse/ClickHouse/issues/11905) を修正しました。[#12384](https://github.com/ClickHouse/ClickHouse/pull/12384)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 依存している `DEFAULT` 式が存在する場合でも、カラムを `CLEAR` できるようにしました。これにより [#12333](https://github.com/ClickHouse/ClickHouse/issues/12333) が修正されました。 [#12378](https://github.com/ClickHouse/ClickHouse/pull/12378) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `-State` と `Nullable` 引数を持つ集約関数での `TOTALS/ROLLUP/CUBE` の挙動を修正しました。これにより [#12163](https://github.com/ClickHouse/ClickHouse/issues/12163) を解決しました。[#12376](https://github.com/ClickHouse/ClickHouse/pull/12376)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `RENAME` が許可されていない場合の `ALTER RENAME COLUMN` クエリに対するエラーメッセージおよび終了コードを修正しました。[#12301](https://github.com/ClickHouse/ClickHouse/issues/12301) および [#12303](https://github.com/ClickHouse/ClickHouse/issues/12303) の問題を解決しました。[#12335](https://github.com/ClickHouse/ClickHouse/pull/12335) ([alesapin](https://github.com/alesapin))。
* `ReplicatedMergeTreeQueue` において、極めてまれに発生し得るレースコンディションを修正しました。 [#12315](https://github.com/ClickHouse/ClickHouse/pull/12315) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 固定長型ではない型でコーデック `Delta` または `DoubleDelta` を使用した場合、本来はコード `BAD_ARGUMENTS` の例外が返されるべきところで、コード `LOGICAL_ERROR` の例外が返されていました（コード `LOGICAL_ERROR` の例外は決して発生しないことを保証しています）。この修正により [#12110](https://github.com/ClickHouse/ClickHouse/issues/12110) が解決されました。 [#12308](https://github.com/ClickHouse/ClickHouse/pull/12308)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `WITH FILL` 修飾子での列の順序を修正しました。以前は `ORDER BY` 句で指定した列の順序が反映されていませんでした。 [#12306](https://github.com/ClickHouse/ClickHouse/pull/12306) ([Anton Popov](https://github.com/CurtizJ))。
* 仮想カラム（`Merge` テーブルの `_table` など）やシステムテーブルの「index」カラム（`system.tables` をクエリする際にデータベース名でフィルタリングする場合など）によってデータをフィルタする式があり、その式が `Nullable` 型を返す場合に発生する「bad cast」例外を回避します。これにより [#12166](https://github.com/ClickHouse/ClickHouse/issues/12166) が修正されました。 [#12305](https://github.com/ClickHouse/ClickHouse/pull/12305)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* TTL 式が依存している列の名前変更後における `TTL` の挙動を修正。 [#12304](https://github.com/ClickHouse/ClickHouse/pull/12304) ([Anton Popov](https://github.com/CurtizJ)).
* `Kafka` エンジンにおいて、バッチの途中にエラーを含むメッセージがある場合に発生していた SIGSEGV を修正しました。 [#12302](https://github.com/ClickHouse/ClickHouse/pull/12302) ([Azat Khuzhin](https://github.com/azat)).
* `DNS` キャッシュを更新する際に、一部のスレッドがランダムに数秒間ハングする可能性があった問題を修正しました。 [#12296](https://github.com/ClickHouse/ClickHouse/pull/12296) ([tavplubix](https://github.com/tavplubix)).
* 設定名の誤記を修正しました。 [#12292](https://github.com/ClickHouse/ClickHouse/pull/12292) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `TrieDictionary` の読み込みに失敗した場合にエラーを表示するようにしました。 [#12290](https://github.com/ClickHouse/ClickHouse/pull/12290) ([Vitaly Baranov](https://github.com/vitlibar))。
* `arrayFill` 関数は空配列に対して誤った動作をしており、クラッシュの原因となる可能性がありました。この修正により [#12263](https://github.com/ClickHouse/ClickHouse/issues/12263) が解決されています。[#12279](https://github.com/ClickHouse/ClickHouse/pull/12279)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `LowCardinality` 型に対する共通型への変換を実装しました。これにより、LowCardinality 型の列とその他の列を持つテーブルに対して UNION ALL を実行できるようになります。これにより [#8212](https://github.com/ClickHouse/ClickHouse/issues/8212) が修正されます。また、[#4342](https://github.com/ClickHouse/ClickHouse/issues/4342) も修正されます。[#12275](https://github.com/ClickHouse/ClickHouse/pull/12275)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `S3` ストレージへのリクエストでリダイレクト上限に達した際の挙動を修正しました。 [#12256](https://github.com/ClickHouse/ClickHouse/pull/12256) ([ianton-ru](https://github.com/ianton-ru)).
* `StorageFile` への複数の挿入を連続して行った際に、一部の特殊な型に対してヘッダーが複数回書き込まれてしまう挙動を修正しました。これにより [#6155](https://github.com/ClickHouse/ClickHouse/issues/6155) が修正されました。 [#12197](https://github.com/ClickHouse/ClickHouse/pull/12197) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* UInt8 の値が 0 または 1 でない場合の論理関数の動作を修正しました。 [#12196](https://github.com/ClickHouse/ClickHouse/pull/12196) ([Alexander Kazakov](https://github.com/Akazz))。
* max&#95;memory&#95;usage* の上限値をプロセスの常駐メモリ使用量に制限しました。 [#12182](https://github.com/ClickHouse/ClickHouse/pull/12182) ([Azat Khuzhin](https://github.com/azat)).
* `GROUP BY` における単射関数削除時の `dictGet` の引数チェックを修正。 [#12179](https://github.com/ClickHouse/ClickHouse/pull/12179) ([Azat Khuzhin](https://github.com/azat)).
* `SummingMergeTree` エンジンがパーティションキーのカラムを合計する際の動作を修正しました。パーティションキーのカラムと重複する合計対象カラムを明示的に指定した場合に、例外をスローするようにしました。これにより [#7867](https://github.com/ClickHouse/ClickHouse/issues/7867) が修正されました。[#12173](https://github.com/ClickHouse/ClickHouse/pull/12173)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* ODBC 接続がスキーマをサポートしていない場合は、辞書のソースとなるテーブル名をスキーマ名とテーブル名に分割しないようにしました。 [#12165](https://github.com/ClickHouse/ClickHouse/pull/12165) ([Vitaly Baranov](https://github.com/vitlibar))。
* `ALTER DELETE` において、条件が NULL と評価された場合にレコードが削除されてしまう誤ったロジックを修正しました。これにより [#9088](https://github.com/ClickHouse/ClickHouse/issues/9088) が修正され、[#12106](https://github.com/ClickHouse/ClickHouse/issues/12106) がクローズされます。 [#12153](https://github.com/ClickHouse/ClickHouse/pull/12153) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* エイリアスが含まれる場合に外部 DBMS（例: MySQL、ODBC）へ送信するクエリの変換を修正しました。これにより [#12032](https://github.com/ClickHouse/ClickHouse/issues/12032) が修正されました。[#12151](https://github.com/ClickHouse/ClickHouse/pull/12151)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 冗長な ORDER BY の最適化処理における不正なコードを修正しました。このバグは [#10067](https://github.com/ClickHouse/ClickHouse/issues/10067) によって導入されました。[#12148](https://github.com/ClickHouse/ClickHouse/pull/12148)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 整数除算時に発生する可能性のあったオーバーフローを修正しました。これにより [#12119](https://github.com/ClickHouse/ClickHouse/issues/12119) が解決されます。[#12140](https://github.com/ClickHouse/ClickHouse/pull/12140)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `greatCircleDistance`、`geoDistance` における潜在的な無限ループの問題を修正しました。これにより [#12117](https://github.com/ClickHouse/ClickHouse/issues/12117) が解決されています。[#12137](https://github.com/ClickHouse/ClickHouse/pull/12137)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 「pid」ファイルの扱いを正規化しました。以前のバージョンでは、サーバーが適切にシャットダウンされずに強制終了され、その後に以前動作していたサーバーと同じ pid を持つ別のプロセスが存在する場合、サーバーが起動を拒否することがありました。また、ほかのサーバーが動作している場合でも、サーバーの起動に失敗すると pid ファイルが削除されてしまうことがありました。この変更で [#3501](https://github.com/ClickHouse/ClickHouse/issues/3501) が修正されました。 [#12133](https://github.com/ClickHouse/ClickHouse/pull/12133) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* ReplicatedVersionedCollapsingMergeTree テーブルに対して ZooKeeper 内のテーブルメタデータが不正になる原因となっていた不具合を修正しました。 [#12093](https://github.com/ClickHouse/ClickHouse/issues/12093) を修正しています。 [#12121](https://github.com/ClickHouse/ClickHouse/pull/12121)（[alesapin](https://github.com/alesapin)）。
* `system.query_log`、`metric_log` などのシステムログ、または `engine=Buffer` の基礎テーブルに紐づく JOIN やサブクエリを含むマテリアライズドビューで発生していた「There is no query」例外を回避するようにしました。 [#12120](https://github.com/ClickHouse/ClickHouse/pull/12120) ([filimonov](https://github.com/filimonov)).
* ENGINE=Dictionary を使用するテーブルにおけるディクショナリへの依存関係の処理を修正しました。これにより [#10994](https://github.com/ClickHouse/ClickHouse/issues/10994) および [#10397](https://github.com/ClickHouse/ClickHouse/issues/10397) が修正されました。[#12116](https://github.com/ClickHouse/ClickHouse/pull/12116)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `Parquet` フォーマットが `LowCardinality` 型および `LowCardinality(Nullable)` 型で正しく動作するようになりました。 [#12086](https://github.com/ClickHouse/ClickHouse/issues/12086)、[#8406](https://github.com/ClickHouse/ClickHouse/issues/8406) が修正されました。 [#12108](https://github.com/ClickHouse/ClickHouse/pull/12108)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `UNION` を含む SELECT クエリにおいて、スレッド総数の上限値が誤っていたことに起因するパフォーマンス問題を修正しました。 [#12030](https://github.com/ClickHouse/ClickHouse/issues/12030) を修正します。 [#12103](https://github.com/ClickHouse/ClickHouse/pull/12103)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `-StateResample` コンビネーターにおいて発生していたセグメンテーションフォールトを修正しました。 [#12092](https://github.com/ClickHouse/ClickHouse/pull/12092) ([Anton Popov](https://github.com/CurtizJ)).
* `SELECT` クエリに対して `system.quey_log` 内の `result_rows` および `result_bytes` メトリクスが空になる問題を修正しました。 [#11595](https://github.com/ClickHouse/ClickHouse/issues/11595) を修正。 [#12089](https://github.com/ClickHouse/ClickHouse/pull/12089)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `VIEW` からの SELECT に対してスレッド数を不必要に制限していた問題を修正しました。 [#11937](https://github.com/ClickHouse/ClickHouse/issues/11937) を修正。 [#12085](https://github.com/ClickHouse/ClickHouse/pull/12085) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* DROP TABLE 実行時に StorageKafka で発生する SIGSEGV を修正しました。 [#12075](https://github.com/ClickHouse/ClickHouse/pull/12075) ([Azat Khuzhin](https://github.com/azat)).
* `PREWHERE` に誤った型を使用した場合に発生し得るクラッシュを修正しました。これにより [#12053](https://github.com/ClickHouse/ClickHouse/issues/12053)、[#12060](https://github.com/ClickHouse/ClickHouse/issues/12060) が解決されました。 [#12060](https://github.com/ClickHouse/ClickHouse/pull/12060)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `Tuple(LowCardinality)` 引数を持つ高階関数で発生していた `Cannot capture column` エラーを修正しました。[#9766](https://github.com/ClickHouse/ClickHouse/issues/9766) および [#12055](https://github.com/ClickHouse/ClickHouse/pull/12055)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）に対応しています。
* 制約のチェック処理を修正し、制約が定数式かどうかを検証するようにしました。これにより [#11360](https://github.com/ClickHouse/ClickHouse/issues/11360) が修正されました。[#12042](https://github.com/ClickHouse/ClickHouse/pull/12042)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `FixedString` 型でサイズが異なる引数を使用して関数 `if` を呼び出した際に、誤った結果が返されたりクラッシュが発生する可能性のあった不具合を修正しました。これにより [#11362](https://github.com/ClickHouse/ClickHouse/issues/11362) が修正されました。 [#12021](https://github.com/ClickHouse/ClickHouse/pull/12021) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### 改善 {#improvement-14}

- `JOIN`の種類と型をより標準的な方法で設定できるようになりました：`SEMI LEFT JOIN`の代わりに`LEFT SEMI JOIN`を使用できます。現時点では両方とも正しい記法です。[#12520](https://github.com/ClickHouse/ClickHouse/pull/12520) ([Artem Zuikov](https://github.com/4ertus2))。
- Bufferエンジンにlifetime_rows/lifetime_bytesを追加しました。[#12421](https://github.com/ClickHouse/ClickHouse/pull/12421) ([Azat Khuzhin](https://github.com/azat))。
- 'MySQL server has gone away'の代わりに、詳細な例外メッセージをクライアントに書き込むようにしました。[#12383](https://github.com/ClickHouse/ClickHouse/pull/12383) ([BohuTANG](https://github.com/BohuTANG))。
- グリッド境界線の印刷に使用される文字セットを変更できるようになりました。利用可能な文字セットは次のとおりです：UTF-8、ASCII。設定`output_format_pretty_grid_charset`でこの機能を有効にします。[#12372](https://github.com/ClickHouse/ClickHouse/pull/12372) ([Sabyanin Maxim](https://github.com/s-mx))。
- MySQLの'SELECT DATABASE()'をサポートしました [#9336](https://github.com/ClickHouse/ClickHouse/issues/9336) 2. MySQL置換クエリの統合テストを追加しました。[#12314](https://github.com/ClickHouse/ClickHouse/pull/12314) ([BohuTANG](https://github.com/BohuTANG))。
- MySQLクライアント/ドライバーが長時間実行されるクエリをキャンセルするための`KILL QUERY [connection_id]`を追加しました、issue [#12038](https://github.com/ClickHouse/ClickHouse/issues/12038)。[#12152](https://github.com/ClickHouse/ClickHouse/pull/12152) ([BohuTANG](https://github.com/BohuTANG))。
- `formatDateTime`関数に`%g`（2桁のISO年）と`%G`（4桁のISO年）の置換サポートを追加しました。[#12136](https://github.com/ClickHouse/ClickHouse/pull/12136) ([vivarum](https://github.com/vivarum))。
- system.disksに'type'カラムを追加しました。[#12115](https://github.com/ClickHouse/ClickHouse/pull/12115) ([ianton-ru](https://github.com/ianton-ru))。
- `REVOKE`コマンドを改善しました：取り消されるアクセス権に対してのみgrant/adminオプションが必要になりました。例えば、`REVOKE ALL ON *.* FROM user1`を実行する際に、grantオプション付きの完全なアクセス権を持つ必要がなくなりました。コマンド`REVOKE ALL FROM user1`を追加しました - これは`user1`から付与されたすべてのロールを取り消します。[#12083](https://github.com/ClickHouse/ClickHouse/pull/12083) ([Vitaly Baranov](https://github.com/vitlibar))。
- load_balancingにレプリカ優先度を追加しました（負荷分散の手動優先順位付けのため）。[#11995](https://github.com/ClickHouse/ClickHouse/pull/11995) ([Azat Khuzhin](https://github.com/azat))。
- S3メタデータ内のパスを相対パスに切り替え、S3 blobをより簡単に処理できるようにしました。[#11892](https://github.com/ClickHouse/ClickHouse/pull/11892) ([Vladimir Chebotarev](https://github.com/excitoon))。

#### パフォーマンス改善 {#performance-improvement-7}


- ソートキーのプレフィックスによる`ORDER BY`および`GROUP BY`のパフォーマンスを改善しました（`optimize_aggregation_in_order`設定で有効化、デフォルトでは無効）。[#11696](https://github.com/ClickHouse/ClickHouse/pull/11696) ([Anton Popov](https://github.com/CurtizJ))。
- `set optimize_injective_functions_inside_uniq=1`の場合、`uniq*()`内の単射関数を削除しました。[#12337](https://github.com/ClickHouse/ClickHouse/pull/12337) ([Ruslan Kamalov](https://github.com/kamalov-ruslan))。
- リテラルを含むIN演算子でインデックスが使用されない問題を修正しました。これはv19.3頃に導入されたパフォーマンス低下です。この修正は[#10574](https://github.com/ClickHouse/ClickHouse/issues/10574)に対応しています。[#12062](https://github.com/ClickHouse/ClickHouse/pull/12062) ([nvartolomei](https://github.com/nvartolomei))。
- DiskS3のシングルパートアップロードを実装しました（実験的機能）。[#12026](https://github.com/ClickHouse/ClickHouse/pull/12026) ([Vladimir Chebotarev](https://github.com/excitoon))。

#### 実験的機能 {#experimental-feature-4}

- `MergeTree`ファミリーテーブルに、データをメモリに格納する新しいインメモリ形式のパートを追加しました。パートは最初のマージ時にディスクに書き込まれます。パートのサイズが行数またはバイト数で`min_rows_for_compact_part`および`min_bytes_for_compact_part`の閾値を下回る場合、インメモリ形式で作成されます。また、Write-Ahead-Logのオプションサポートも利用可能で、デフォルトで有効化されており、`in_memory_parts_enable_wal`設定で制御されます。[#10697](https://github.com/ClickHouse/ClickHouse/pull/10697) ([Anton Popov](https://github.com/CurtizJ))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-9}


* clickhouse-client 向けに AST ベースのクエリファジングモードを実装しました。ファジングによって最近発見された issue の一覧は[このラベル](https://github.com/ClickHouse/ClickHouse/issues?q=label%3Afuzz+is%3Aissue)を参照してください。そのほとんどはこのツールで発見され、いくつかは SQLancer と `00746_sql_fuzzy.pl` によって発見されました。[#12111](https://github.com/ClickHouse/ClickHouse/pull/12111)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* Testflows フレームワークに基づく新しい種類のテストを追加しました。[#12090](https://github.com/ClickHouse/ClickHouse/pull/12090)（[vzakaznikov](https://github.com/vzakaznikov)）。
* S3 HTTPS 統合テストを追加しました。[#12412](https://github.com/ClickHouse/ClickHouse/pull/12412)（[Pavel Kovalenko](https://github.com/Jokser)）。
* サニタイザのトラップメッセージを別スレッドからログ出力するようにしました。これにより ThreadSanitizer 利用時のデッドロックの可能性を防ぎます。[#12313](https://github.com/ClickHouse/ClickHouse/pull/12313)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 機能テストおよびストレステストを、古いバージョンの `clickhouse-test` スクリプトでも実行できるようにしました。[#12287](https://github.com/ClickHouse/ClickHouse/pull/12287)（[alesapin](https://github.com/alesapin)）。
* ビルド中に `orc` で発生していた不自然なファイル作成を削除しました。[#12258](https://github.com/ClickHouse/ClickHouse/pull/12258)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 共通の Docker Compose ファイルを統合テスト用 Docker コンテナに含めました。[#12168](https://github.com/ClickHouse/ClickHouse/pull/12168)（[Ilya Yatsishin](https://github.com/qoega)）。
* CodeQL からの警告を修正しました。`CodeQL` は、既に使用している `clang-tidy` や `PVS-Studio` と並行して利用する別の静的解析ツールです。[#12138](https://github.com/ClickHouse/ClickHouse/pull/12138)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* UNBUNDLED ビルド向けの小さな CMake 修正を行いました。[#12131](https://github.com/ClickHouse/ClickHouse/pull/12131)（[Matwey V. Kornilov](https://github.com/matwey)）。
* いずれの Linux ディストリビューションにも依存しない最小限の Docker イメージのショーケースを追加しました。[#12126](https://github.com/ClickHouse/ClickHouse/pull/12126)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `clickhouse-server` Docker イメージ内でシステムパッケージをアップグレードするようにしました。[#12124](https://github.com/ClickHouse/ClickHouse/pull/12124)（[Ivan Blinkov](https://github.com/blinkov)）。
* `system.build_options` テーブルに `UNBUNDLED` フラグを追加しました。`clickhouse-test` 用のスキップリストを clickhouse リポジトリに移動しました。[#12107](https://github.com/ClickHouse/ClickHouse/pull/12107)（[alesapin](https://github.com/alesapin)）。
* [Anchore Container Analysis](https://docs.anchore.com) セキュリティ解析ツールによる、`clickhouse-server` Docker イメージ内の [CVE](https://cve.mitre.org/) を検査する定期的なチェックを追加しました。また、`Dockerfile` がビルド可能であることも確認します。`master` と `Dockerfile` へのプルリクエストに対して、毎日実行されます。[#12102](https://github.com/ClickHouse/ClickHouse/pull/12102)（[Ivan Blinkov](https://github.com/blinkov)）。
* [GitHub CodeQL](https://securitylab.github.com/tools/codeql) セキュリティ解析ツールによる、[CWE](https://cwe.mitre.org/) を検査する日次チェックを追加しました。[#12101](https://github.com/ClickHouse/ClickHouse/pull/12101)（[Ivan Blinkov](https://github.com/blinkov)）。
* Dockerfile 内で最初の `apt-get update` の前に `ca-certificates` をインストールするように変更しました。[#12095](https://github.com/ClickHouse/ClickHouse/pull/12095)（[Ivan Blinkov](https://github.com/blinkov)）。



## ClickHouse リリース 20.5 {#clickhouse-release-205}

### ClickHouse リリース v20.5.4.40-stable 2020-08-10 {#clickhouse-release-v205440-stable-2020-08-10}

#### バグ修正 {#bug-fix-26}


* 関数使用時の誤ったインデックス解析を修正しました。これにより、`MergeTree` テーブルからの読み取り時に誤った部分がプルーニングされてしまう可能性がありました。[#13060](https://github.com/ClickHouse/ClickHouse/issues/13060) を修正。[#12406](https://github.com/ClickHouse/ClickHouse/issues/12406) を修正。[#13081](https://github.com/ClickHouse/ClickHouse/pull/13081)（[Anton Popov](https://github.com/CurtizJ)）。
* ローカルレプリカからの `SELECT` に対する不要なスレッド数制限を解消しました。 [#12840](https://github.com/ClickHouse/ClickHouse/pull/12840) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `IN` 節で関数として解釈される大きなタプルを使用した場合のパフォーマンスを改善しました。ユーザーが何らかの（よく分からない）理由で `WHERE x IN (1, 2, ...)` ではなく `WHERE x IN tuple(1, 2, ...)` と記述したケースに対応しています。 [#12700](https://github.com/ClickHouse/ClickHouse/pull/12700) ([Anton Popov](https://github.com/CurtizJ)).
* input&#95;format&#95;parallel&#95;parsing のメモリトラッキングを修正（スレッドをグループにアタッチすることで対応）。[#12672](https://github.com/ClickHouse/ClickHouse/pull/12672) ([Azat Khuzhin](https://github.com/azat))。
* 定数式を使用する固定 Bloom フィルターインデックスを修正しました。これにより [#10572](https://github.com/ClickHouse/ClickHouse/issues/10572) が修正されました。[#12659](https://github.com/ClickHouse/ClickHouse/pull/12659)（[Winter Zhang](https://github.com/zhang2014)）。
* ブローカーが利用不能な場合などに `StorageKafka` で発生していた `SIGSEGV` を修正しました。 [#12658](https://github.com/ClickHouse/ClickHouse/pull/12658) ([Azat Khuzhin](https://github.com/azat)).
* 関数 `if` が `Array(UUID)` 型の引数を受け取れるようサポートを追加しました。これにより、[#11066](https://github.com/ClickHouse/ClickHouse/issues/11066) が解決されました。[#12648](https://github.com/ClickHouse/ClickHouse/pull/12648)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 関数 `any` でエイリアスが使用できなかった問題を修正しました。 [#12593](https://github.com/ClickHouse/ClickHouse/pull/12593) ([Anton Popov](https://github.com/CurtizJ)).
* キャッシュレイアウトを使用する外部ディクショナリで、サーバークラッシュを引き起こす可能性のあったレースコンディションを修正しました。 [#12566](https://github.com/ClickHouse/ClickHouse/pull/12566) ([alesapin](https://github.com/alesapin)).
* `DROP TABLE` 実行時に Distributed テーブルのデータ（非同期 `INSERT` によるブロック）を削除するようにしました。 [#12556](https://github.com/ClickHouse/ClickHouse/pull/12556) ([Azat Khuzhin](https://github.com/azat)).
* `enable_mixed_granularity_parts=1` のときに `ALTER DELETE` クエリ実行後、古いパーツが破損する原因となっていたバグを修正しました。[#12536](https://github.com/ClickHouse/ClickHouse/issues/12536) を修正。[#12543](https://github.com/ClickHouse/ClickHouse/pull/12543) ([alesapin](https://github.com/alesapin))。
* 無効な数の引数を持つ `in` 関数に対して、より適切な例外をスローするようにしました。 [#12529](https://github.com/ClickHouse/ClickHouse/pull/12529) ([Anton Popov](https://github.com/CurtizJ))。
* Live View テーブルにおいてデータ重複を引き起こす可能性があったレースコンディションを修正しました。 [#12519](https://github.com/ClickHouse/ClickHouse/pull/12519) ([vzakaznikov](https://github.com/vzakaznikov)).
* コンパクトパーツからの読み込み時のパフォーマンス問題を修正しました。 [#12492](https://github.com/ClickHouse/ClickHouse/pull/12492) ([Anton Popov](https://github.com/CurtizJ)).
* `AggregateFunction(avg, …)` の値におけるバイナリ形式の後方互換性を修正しました。これにより [#12342](https://github.com/ClickHouse/ClickHouse/issues/12342) が解決されました。 [#12486](https://github.com/ClickHouse/ClickHouse/pull/12486) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `text_log` が有効な場合に発生していたデッドロックを修正しました。[#12452](https://github.com/ClickHouse/ClickHouse/pull/12452) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 非常に大きな LIMIT または OFFSET が指定された場合に発生していたオーバーフローを修正しました。これにより [#10470](https://github.com/ClickHouse/ClickHouse/issues/10470) および [#11372](https://github.com/ClickHouse/ClickHouse/issues/11372) が修正されました。 [#12427](https://github.com/ClickHouse/ClickHouse/pull/12427)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* StorageMerge 使用時に発生する可能性のあったセグメンテーションフォルトを修正しました。 [#12054](https://github.com/ClickHouse/ClickHouse/issues/12054) をクローズしました。 [#12401](https://github.com/ClickHouse/ClickHouse/pull/12401) ([tavplubix](https://github.com/tavplubix))。
* [#12098](https://github.com/ClickHouse/ClickHouse/issues/12098) を解決するために [#11079](https://github.com/ClickHouse/ClickHouse/issues/11079) で導入された変更を元に戻します。[#12397](https://github.com/ClickHouse/ClickHouse/pull/12397) ([Mike](https://github.com/myrrc))。
* インデックス付きテーブルの WHERE 句で負の定数または浮動小数点定数が使用された場合に例外が発生しないようにしました。これにより [#11905](https://github.com/ClickHouse/ClickHouse/issues/11905) が修正されました。[#12384](https://github.com/ClickHouse/ClickHouse/pull/12384)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 依存している `DEFAULT` 式が存在する場合でも `CLEAR` でカラムをクリアできるようにしました。これにより [#12333](https://github.com/ClickHouse/ClickHouse/issues/12333) が修正されました。 [#12378](https://github.com/ClickHouse/ClickHouse/pull/12378) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `-State` および `Nullable` 型の引数を取る集約関数に対する TOTALS/ROLLUP/CUBE の動作を修正しました。これにより [#12163](https://github.com/ClickHouse/ClickHouse/issues/12163) が修正されました。 [#12376](https://github.com/ClickHouse/ClickHouse/pull/12376) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `Kafka` エンジンで、バッチの途中にエラーを含むメッセージがある場合に発生していた SIGSEGV を修正しました。 [#12302](https://github.com/ClickHouse/ClickHouse/pull/12302) ([Azat Khuzhin](https://github.com/azat)).
* `SummingMergeTree` エンジンがパーティションキーの列を合計するときの動作を修正しました。合計する列を明示的に指定した結果、それがパーティションキーの列と重複する場合には例外をスローするようにしました。これにより [#7867](https://github.com/ClickHouse/ClickHouse/issues/7867) が修正されました。[#12173](https://github.com/ClickHouse/ClickHouse/pull/12173) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 別名が存在する場合に、外部 DBMS（例：MySQL、ODBC）へ送信するクエリの変換処理を修正しました。これにより [#12032](https://github.com/ClickHouse/ClickHouse/issues/12032) が解決されました。 [#12151](https://github.com/ClickHouse/ClickHouse/pull/12151)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* ReplicatedVersionedCollapsingMergeTree テーブルで ZooKeepeer 上のテーブルメタデータが不正になるバグを修正しました。[#12093](https://github.com/ClickHouse/ClickHouse/issues/12093) を修正します。[#12121](https://github.com/ClickHouse/ClickHouse/pull/12121)（[alesapin](https://github.com/alesapin)）。
* `VIEW` からの `SELECT` に対して、スレッド数を不必要に制限していた問題を修正しました。 [#11937](https://github.com/ClickHouse/ClickHouse/issues/11937) を修正。 [#12085](https://github.com/ClickHouse/ClickHouse/pull/12085) （[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `join_algorithm=partial_merge` 設定時に、LowCardinality 型を含む JOIN で発生していたクラッシュを修正しました。 [#12035](https://github.com/ClickHouse/ClickHouse/pull/12035) ([Artem Zuikov](https://github.com/4ertus2)).
* 条件式に NULL が含まれる場合の `if()` の誤った結果を修正。 [#11807](https://github.com/ClickHouse/ClickHouse/pull/11807) ([Artem Zuikov](https://github.com/4ertus2)).

#### パフォーマンス改善 {#performance-improvement-8}

- リテラルを使用したIN演算子でインデックスが使用されない問題を修正しました。この問題はv19.3頃に導入されたパフォーマンス低下です。[#10574](https://github.com/ClickHouse/ClickHouse/issues/10574)を修正します。[#12062](https://github.com/ClickHouse/ClickHouse/pull/12062) ([nvartolomei](https://github.com/nvartolomei))。

#### ビルド/テスト/パッケージング改善 {#buildtestingpackaging-improvement-10}

- Dockerfileで最初の`apt-get update`の前に`ca-certificates`をインストールするようにしました。[#12095](https://github.com/ClickHouse/ClickHouse/pull/12095) ([Ivan Blinkov](https://github.com/blinkov))。

### ClickHouse リリース v20.5.2.7-stable 2020-07-02 {#clickhouse-release-v20527-stable-2020-07-02}

#### 後方互換性のない変更 {#backward-incompatible-change-7}

- COUNT(DISTINCT)および`uniq`集約関数ファミリーから非Nullable結果を返すようにしました。渡された値がすべてNULLの場合は、代わりにゼロを返します。これによりSQL互換性が向上します。[#11661](https://github.com/ClickHouse/ClickHouse/pull/11661) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ユーザーレベル設定が誤った場所に指定されている場合のチェックを追加しました。ユーザーレベル設定は、特定のユーザープロファイルの`users.xml`内の`<profile>`セクション(またはデフォルト設定の場合は`<default>`)に指定する必要があります。サーバーはログに例外メッセージを出力して起動しません。これは[#9051](https://github.com/ClickHouse/ClickHouse/issues/9051)を修正します。チェックをスキップする場合は、設定を適切な場所に移動するか、config.xmlに`<skip_check_for_incorrect_settings>1</skip_check_for_incorrect_settings>`を追加してください。[#11449](https://github.com/ClickHouse/ClickHouse/pull/11449) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 設定`input_format_with_names_use_header`がデフォルトで有効になりました。これは入力フォーマット`-WithNames`および`-WithNamesAndTypes`の解析に影響します。[#10937](https://github.com/ClickHouse/ClickHouse/pull/10937) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `experimental_use_processors`設定を削除しました。デフォルトで有効になっています。[#10924](https://github.com/ClickHouse/ClickHouse/pull/10924) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- `zstd`を1.4.4に更新しました。パフォーマンスと圧縮率にわずかな改善があります。異なるバージョンのClickHouseでレプリカを実行している場合、説明付きで`Data after merge is not byte-identical to data on another replicas.`という妥当なエラーメッセージが表示されることがあります。これらのメッセージは問題なく、心配する必要はありません。この変更は後方互換性がありますが、これらのメッセージについて疑問に思う場合に備えて、ここの変更履歴に記載しています。[#10663](https://github.com/ClickHouse/ClickHouse/pull/10663) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 意味のないコーデックのチェックと、このチェックを制御する設定`allow_suspicious_codecs`を追加しました。これは[#4966](https://github.com/ClickHouse/ClickHouse/issues/4966)を解決します。[#10645](https://github.com/ClickHouse/ClickHouse/pull/10645) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 複数のKafka設定のデフォルト値が変更されました。[#11388](https://github.com/ClickHouse/ClickHouse/pull/11388)を参照してください。
- 20.5より古いバージョンからアップグレードする場合、ローリングアップデートを実行し、クラスタに20.5以上のバージョンと20.5未満のバージョンの両方が含まれている場合、古いバージョンのClickHouseノードが再起動され、新しいバージョンが存在する状態で古いバージョンが起動されると、`Part ... intersects previous part`エラーが発生する可能性があります。このエラーを防ぐには、まずすべてのクラスタノードに新しいclickhouse-serverパッケージをインストールしてから再起動を実行してください(これにより、clickhouse-serverが再起動されると新しいバージョンで起動します)。

#### 新機能 {#new-feature-7}


* テーブル内データの自動粗粒化およびロールアップを行う `TTL DELETE WHERE` と `TTL GROUP BY`。 [#10537](https://github.com/ClickHouse/ClickHouse/pull/10537) ([expl0si0nn](https://github.com/expl0si0nn)).
* PostgreSQL ワイヤプロトコルの実装。 [#10242](https://github.com/ClickHouse/ClickHouse/pull/10242) ([Movses](https://github.com/MovElb)).
* ユーザー、ロール、権限、設定プロファイル、クォータ、行ポリシー用のsystemテーブルを追加し、SHOW USER、SHOW [CURRENT|ENABLED] ROLES、SHOW SETTINGS PROFILES コマンドを追加しました。 [#10387](https://github.com/ClickHouse/ClickHouse/pull/10387) ([Vitaly Baranov](https://github.com/vitlibar))。
* ODBC テーブル関数での書き込みをサポート [#10554](https://github.com/ClickHouse/ClickHouse/pull/10554) ([ageraab](https://github.com/ageraab)). [#10901](https://github.com/ClickHouse/ClickHouse/pull/10901) ([tavplubix](https://github.com/tavplubix)).
* Linux の `perf_events` に基づくクエリパフォーマンスメトリクスを追加しました（これらのメトリクスはハードウェア CPU カウンタおよび OS カウンタを用いて算出されます）。これはオプション機能であり、clickhouse バイナリに `CAP_SYS_ADMIN` ケーパビリティを設定する必要があります。 [#9545](https://github.com/ClickHouse/ClickHouse/pull/9545) [Andrey Skobtsov](https://github.com/And42)。 [#11226](https://github.com/ClickHouse/ClickHouse/pull/11226) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* `CREATE` 文において、データ型に対する `NULL` および `NOT NULL` 修飾子がサポートされるようになりました。 [#11057](https://github.com/ClickHouse/ClickHouse/pull/11057) ([Павел Потемкин](https://github.com/Potya)).
* `ArrowStream` 入力および出力フォーマットを追加しました。 [#11088](https://github.com/ClickHouse/ClickHouse/pull/11088) ([hcz](https://github.com/hczhcz)).
* Cassandra を外部ディクショナリのデータソースとしてサポート。 [#4978](https://github.com/ClickHouse/ClickHouse/pull/4978) ([favstovol](https://github.com/favstovol)).
* 新しい `direct` レイアウトを追加しました。これは、各クエリごとにソースからすべてのデータを直接読み込み、データの保存やキャッシュは行いません。 [#10622](https://github.com/ClickHouse/ClickHouse/pull/10622) ([Artem Streltsov](https://github.com/kekekekule)).
* クエリ実行中にローカルへ一切データを保存しない、新しい `complex_key_direct` レイアウトを辞書に追加しました。 [#10850](https://github.com/ClickHouse/ClickHouse/pull/10850) ([Artem Streltsov](https://github.com/kekekekule)).
* MySQL スタイルのグローバル変数構文（スタブ）のサポートを追加しました。これは MySQL プロトコルとの互換性のために必要です。 [#11832](https://github.com/ClickHouse/ClickHouse/pull/11832) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `replxx` を使用して `clickhouse-client` に構文ハイライト機能を追加しました。[#11422](https://github.com/ClickHouse/ClickHouse/pull/11422)（[Tagir Kuskarov](https://github.com/kuskarov)）。
* `minMap` および `maxMap` 関数が追加されました。 [#11603](https://github.com/ClickHouse/ClickHouse/pull/11603) ([Ildus Kurbangaliev](https://github.com/ildus))。
* `system.asynchronous_metrics` の履歴メトリクスを記録する `system.asynchronous_metric_log` テーブルを追加。 [#11588](https://github.com/ClickHouse/ClickHouse/pull/11588) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* 関数 `extractAllGroupsHorizontal(haystack, re)` と `extractAllGroupsVertical(haystack, re)` を追加しました。 [#11554](https://github.com/ClickHouse/ClickHouse/pull/11554) ([Vasily Nemkov](https://github.com/Enmk)).
* SHOW CLUSTER(S) クエリを追加しました。 [#11467](https://github.com/ClickHouse/ClickHouse/pull/11467) ([hexiaoting](https://github.com/hexiaoting)).
* Python の `urlparse(url)` の `netloc` と同様に、URL からネットワークロケーションを抽出するための `netloc` 関数を追加。 [#11356](https://github.com/ClickHouse/ClickHouse/pull/11356) ([Guillaume Tassery](https://github.com/YiuRULE)).
* `engine=Kafka` 用にメッセージヘッダーにアクセスするための仮想カラムを 2 つ追加。 [#11283](https://github.com/ClickHouse/ClickHouse/pull/11283) ([filimonov](https://github.com/filimonov))。
* Kafka エンジンに `_timestamp_ms` 仮想カラムを追加（型は `Nullable(DateTime64(3))`）。[#11260](https://github.com/ClickHouse/ClickHouse/pull/11260)（[filimonov](https://github.com/filimonov)）。
* 関数 `randomFixedString` を追加。[#10866](https://github.com/ClickHouse/ClickHouse/pull/10866)（[Andrei Nekrashevich](https://github.com/xolm)）。
* 文字列中のビットを指定された確率でランダムに反転させる関数 `fuzzBits` を追加。 [#11237](https://github.com/ClickHouse/ClickHouse/pull/11237) ([Andrei Nekrashevich](https://github.com/xolm))。
* 比較演算子および IN 句と VALUES 句で、数値を定数文字列と比較できるようにしました。 [#11647](https://github.com/ClickHouse/ClickHouse/pull/11647) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `round_robin` load&#95;balancing モードを追加しました。 [#11645](https://github.com/ClickHouse/ClickHouse/pull/11645) ([Azat Khuzhin](https://github.com/azat)).
* `cast_keep_nullable` 設定を追加しました。設定すると、`CAST(something_nullable AS Type)` は `Nullable(Type)` を返します。 [#11733](https://github.com/ClickHouse/ClickHouse/pull/11733) ([Artem Zuikov](https://github.com/4ertus2)).
* `system.columns` テーブルに列 `position` を、`system.parts_columns` テーブルに列 `column_position` を追加しました。これらの列には、テーブル内の列の序数位置（1 始まり）が格納されます。これにより [#7744](https://github.com/ClickHouse/ClickHouse/issues/7744) がクローズされました。 [#11655](https://github.com/ClickHouse/ClickHouse/pull/11655) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* ON CLUSTER での SYSTEM `{FLUSH DISTRIBUTED,STOP/START DISTRIBUTED SEND}` のサポート。 [#11415](https://github.com/ClickHouse/ClickHouse/pull/11415) ([Azat Khuzhin](https://github.com/azat)).
* system.distribution&#95;queue テーブルを追加。 [#11394](https://github.com/ClickHouse/ClickHouse/pull/11394) ([Azat Khuzhin](https://github.com/azat)).
* Kafka で利用可能なすべてのフォーマット設定をサポートし、一部の設定をテーブルレベルでも指定できるようにし、パフォーマンス向上のためにデフォルト値を調整しました。 [#11388](https://github.com/ClickHouse/ClickHouse/pull/11388) ([filimonov](https://github.com/filimonov)).
* `port` 関数（URL からポート番号を抽出する）を追加しました。[#11120](https://github.com/ClickHouse/ClickHouse/pull/11120) ([Azat Khuzhin](https://github.com/azat))
* `dictGet*` 関数でテーブル名を指定できるようになりました。 [#11050](https://github.com/ClickHouse/ClickHouse/pull/11050) ([Vitaly Baranov](https://github.com/vitlibar))。
* `clickhouse-format` ツールは、`-n` 引数を使用すると複数のクエリを整形できるようになりました。 [#10852](https://github.com/ClickHouse/ClickHouse/pull/10852) ([Darío](https://github.com/dgrr))。
* DiskS3 用の proxy-resolver を設定できるようになりました。 [#10744](https://github.com/ClickHouse/ClickHouse/pull/10744) ([Pavel Kovalenko](https://github.com/Jokser)).
* `pointInPolygon` が非定数のポリゴンでも動作するようになりました。`pointInPolygon` は第 2 引数として Array(Array(Tuple(..., ...))) を受け取れるようになり、ポリゴンおよびホールの配列を指定できます。 [#10623](https://github.com/ClickHouse/ClickHouse/pull/10623) ([Alexey Ilyukhov](https://github.com/livace)) [#11421](https://github.com/ClickHouse/ClickHouse/pull/11421) ([Alexey Ilyukhov](https://github.com/livace)).
* `move_ttl_info` を `system.parts` に追加し、move TTL 機能の動作を確認できるようにしました。 [#10591](https://github.com/ClickHouse/ClickHouse/pull/10591) ([Vladimir Chebotarev](https://github.com/excitoon))。
* プロキシ経由で S3 を利用可能に。 [#10576](https://github.com/ClickHouse/ClickHouse/pull/10576) ([Pavel Kovalenko](https://github.com/Jokser)).
* データ型のシノニムとして `NCHAR` および `NVARCHAR` を追加。[#11025](https://github.com/ClickHouse/ClickHouse/pull/11025)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* [#7224](https://github.com/ClickHouse/ClickHouse/issues/7224) を解決し、`FailedQuery`、`FailedSelectQuery`、`FailedInsertQuery` メトリクスを `system.events` テーブルに追加しました。 [#11151](https://github.com/ClickHouse/ClickHouse/pull/11151) （[Nikita Orlov](https://github.com/naorlov)）。
* `system.asynchronous_metrics` に `jemalloc` の統計情報をさらに追加し、それらの値が常に最新の状態で確認できるようにしました。 [#11748](https://github.com/ClickHouse/ClickHouse/pull/11748) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* S3 のデフォルト認証情報およびカスタム認証ヘッダーを指定できるようにしました。 [#11134](https://github.com/ClickHouse/ClickHouse/pull/11134) ([Grigory Pervakov](https://github.com/GrigoryPervakov)).
* さまざまな精度の DateTime64 を Int64 型としてインポート／エクスポートするための新しい関数 `to-/fromUnixTimestamp64Milli/-Micro/-Nano` を追加しました。 [#10923](https://github.com/ClickHouse/ClickHouse/pull/10923) ([Vasily Nemkov](https://github.com/Enmk))。
* MongoDB ディクショナリに対して `mongodb://` URI を指定できるようにしました。 [#10915](https://github.com/ClickHouse/ClickHouse/pull/10915) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* `OFFSET` キーワードは、対応する `LIMIT` 句がなくても使用できるようになりました。 [#10802](https://github.com/ClickHouse/ClickHouse/pull/10802) ([Guillaume Tassery](https://github.com/YiuRULE))。
* `system.licenses` テーブルを追加しました。このテーブルには、`contrib` ディレクトリに含まれるサードパーティライブラリのライセンスが含まれます。これにより[#2890](https://github.com/ClickHouse/ClickHouse/issues/2890)が解決されました。[#10795](https://github.com/ClickHouse/ClickHouse/pull/10795) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 新しい関数 `toStartOfSecond(DateTime64) -&gt; DateTime64` を追加。`DateTime64` の値から小数秒部分を切り捨てます。 [#10722](https://github.com/ClickHouse/ClickHouse/pull/10722) ([Vasily Nemkov](https://github.com/Enmk))。
* 新しい入力フォーマット `JSONAsString` を追加しました。このフォーマットは、改行、空白、カンマで区切られた一連の JSON オブジェクトを受け付けます。 [#10607](https://github.com/ClickHouse/ClickHouse/pull/10607) ([Kruglov Pavel](https://github.com/Avogar)).
* 4 MiB よりも細かい粒度でメモリをプロファイルできるようになりました。ランダムな割り当て／解放を記録するサンプリングメモリプロファイラを追加しました。 [#10598](https://github.com/ClickHouse/ClickHouse/pull/10598) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `SimpleAggregateFunction` は `sumMap` もサポートするようになりました。 [#10000](https://github.com/ClickHouse/ClickHouse/pull/10000) ([Ildus Kurbangaliev](https://github.com/ildus)).
* 分散テーブルエンジンで `ALTER RENAME COLUMN` をサポートしました。[#10727](https://github.com/ClickHouse/ClickHouse/issues/10727) の続きです。[#10747](https://github.com/ClickHouse/ClickHouse/issues/10747) を修正しました。[#10887](https://github.com/ClickHouse/ClickHouse/pull/10887)（[alesapin](https://github.com/alesapin)）。

#### バグ修正 {#bug-fix-27}


* Decimal のパースにおける UBSan レポートへの対応。これにより [#7540](https://github.com/ClickHouse/ClickHouse/issues/7540) が修正されました。 [#10512](https://github.com/ClickHouse/ClickHouse/pull/10512)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* DateTime64 をパースする際に発生しうる浮動小数点例外を修正しました。これにより [#11374](https://github.com/ClickHouse/ClickHouse/issues/11374) が修正されました。 [#11875](https://github.com/ClickHouse/ClickHouse/pull/11875) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `prewhere` 条件で `Nullable` 列を使用した場合にまれに発生するクラッシュを修正。 [#11895](https://github.com/ClickHouse/ClickHouse/pull/11895) [#11608](https://github.com/ClickHouse/ClickHouse/issues/11608) [#11869](https://github.com/ClickHouse/ClickHouse/pull/11869) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 高階関数内での arrayJoin の使用を禁止しました。これが原因でプロトコル同期が破綻していました。この変更により [#3933](https://github.com/ClickHouse/ClickHouse/issues/3933) が解決されます。[#11846](https://github.com/ClickHouse/ClickHouse/pull/11846)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* FixedString と定数 String の比較で誤った結果が返される問題を修正しました。これにより [#11393](https://github.com/ClickHouse/ClickHouse/issues/11393) が解決されています。このバグはバージョン 20.4 で発生しました。 [#11828](https://github.com/ClickHouse/ClickHouse/pull/11828)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 条件に NULL を含む `if` 関数で誤った結果が返される問題を修正。 [#11807](https://github.com/ClickHouse/ClickHouse/pull/11807) ([Artem Zuikov](https://github.com/4ertus2)).
* クエリでスレッドを過剰に使用する不具合を修正。 [#11788](https://github.com/ClickHouse/ClickHouse/pull/11788) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `SELECT ... FROM merge_tree_table ...` で `WITH &lt;scalar subquery&gt; ...` を使用した際に発生していた `Scalar does not exist` 例外を修正しました。 [#11621](https://github.com/ClickHouse/ClickHouse/issues/11621)。 [#11767](https://github.com/ClickHouse/ClickHouse/pull/11767) ([Amos Bird](https://github.com/amosbird))。
* `SELECT *, xyz.*` のようなクエリが、本来はエラーになるべきところで成功してしまっていた予期しない動作を修正しました。 [#11753](https://github.com/ClickHouse/ClickHouse/pull/11753) ([hexiaoting](https://github.com/hexiaoting)).
* メタデータの ALTER 中は、レプリケートテーブルでのフェッチ処理がキャンセルされるようになりました。 [#11744](https://github.com/ClickHouse/ClickHouse/pull/11744) ([alesapin](https://github.com/alesapin)).
* 同値性を確認する前に、ZooKeeper に保存されているメタデータをパースするように変更。 [#11739](https://github.com/ClickHouse/ClickHouse/pull/11739) ([Azat Khuzhin](https://github.com/azat)).
* Values 入力フォーマットにおける複雑なリテラルの誤った型推論によって発生していた LOGICAL&#95;ERROR を修正しました。 [#11732](https://github.com/ClickHouse/ClickHouse/pull/11732) ([tavplubix](https://github.com/tavplubix)).
* 定数列に対する `ORDER BY ... WITH FILL` を修正。 [#11697](https://github.com/ClickHouse/ClickHouse/pull/11697) ([Anton Popov](https://github.com/CurtizJ))。
* SYSTEM SYNC REPLICA における極めてまれなレースコンディションを修正しました。replicated テーブルが作成されている最中に、別の接続から別のクライアントが同じテーブルに対して `SYSTEM SYNC REPLICA` コマンドを発行した場合（このクライアントはテーブルが作成中であることを認識しているはずなので、発生する可能性は低い）、nullptr のデリファレンスが発生する可能性がありました。 [#11691](https://github.com/ClickHouse/ClickHouse/pull/11691) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* XDBC bridge と通信する際に適切なタイムアウト値を指定するようにしました。最近、bridge の生存確認およびメタ情報の受信時にタイムアウトが考慮されていませんでした。 [#11690](https://github.com/ClickHouse/ClickHouse/pull/11690) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* エイリアスを含む `ORDER BY` 句と併用した場合の `LIMIT n WITH TIES` の挙動を修正。 [#11689](https://github.com/ClickHouse/ClickHouse/pull/11689) ([Anton Popov](https://github.com/CurtizJ)).
* 並列な `FINAL` を伴う SELECT で発生し得る `Pipeline stuck` 問題を修正しました。 [#11636](https://github.com/ClickHouse/ClickHouse/issues/11636) を修正。 [#11682](https://github.com/ClickHouse/ClickHouse/pull/11682)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `system.mutations` が不正な状態になる原因となるエラーを修正しました。サーバーがレプリケーションキューに `MUTATE_PART` タスクを残したまま実行しようとしているにもかかわらず、ミューテーション全体がすでに完了していると表示されてしまう場合がありました。これにより [#11611](https://github.com/ClickHouse/ClickHouse/issues/11611) が修正されました。 [#11681](https://github.com/ClickHouse/ClickHouse/pull/11681) ([alesapin](https://github.com/alesapin))。
* CREATE USER クエリの構文ハイライトを修正。 [#11664](https://github.com/ClickHouse/ClickHouse/pull/11664) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 大文字小文字を区別しないフラグ付き正規表現のサポートを追加しました。これにより [#11101](https://github.com/ClickHouse/ClickHouse/issues/11101) および [#11506](https://github.com/ClickHouse/ClickHouse/issues/11506) が修正されました。[#11649](https://github.com/ClickHouse/ClickHouse/pull/11649)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 行レベルセキュリティが設定されている場合、単純な COUNT クエリの最適化を削除します。以前のバージョンでは、ユーザーはフィルタ後の件数ではなく、テーブル内の全レコード件数を取得していました。これにより [#11352](https://github.com/ClickHouse/ClickHouse/issues/11352) が修正されます。 [#11644](https://github.com/ClickHouse/ClickHouse/pull/11644) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* String 型用ブルームフィルタ（data skipping indices）を修正。 [#11638](https://github.com/ClickHouse/ClickHouse/pull/11638) ([Azat Khuzhin](https://github.com/azat))。
* `-q` オプションを指定しない場合、起動時にデータベースは作成されません。 [#11604](https://github.com/ClickHouse/ClickHouse/pull/11604) ([giordyb](https://github.com/giordyb))。
* `Buffer` テーブルからのサンプリング読み取りを行うクエリで発生する `Block structure mismatch` エラーを修正しました。 [#11602](https://github.com/ClickHouse/ClickHouse/pull/11602) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* clickhouse-client の終了コードが `exception.code() % 256 == 0` の場合に誤っていた問題を修正。 [#11601](https://github.com/ClickHouse/ClickHouse/pull/11601) ([filimonov](https://github.com/filimonov))。
* ReplicatedMergeTree の異なるレプリカの CREATE/DROP に発生するレースコンディションを修正しました。テーブルが ZooKeeper から完全に削除されていない場合や、正常に作成されなかった場合でも処理を継続できるようにしました。これにより [#11432](https://github.com/ClickHouse/ClickHouse/issues/11432) が修正されます。 [#11592](https://github.com/ClickHouse/ClickHouse/pull/11592) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* サーバー起動時に出力される「Mark cache size was lowered」というログメッセージの些細な誤りを修正しました。これにより [#11399](https://github.com/ClickHouse/ClickHouse/issues/11399) がクローズされました。 [#11589](https://github.com/ClickHouse/ClickHouse/pull/11589) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `PREWHERE column in (subquery)` と `ARRAY JOIN` を含むクエリで発生していたエラー `Size of offsets does not match size of column` を修正しました。 [#11580](https://github.com/ClickHouse/ClickHouse/pull/11580) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `SHOW CREATE TABLE` でまれに発生していたセグメンテーションフォールトを修正しました。[#11490](https://github.com/ClickHouse/ClickHouse/issues/11490) を解決。[#11579](https://github.com/ClickHouse/ClickHouse/pull/11579)（[tavplubix](https://github.com/tavplubix)）。
* HTTP セッション内のすべてのクエリで同じ `query_id` が使用されていました。修正済みです。 [#11578](https://github.com/ClickHouse/ClickHouse/pull/11578) ([tavplubix](https://github.com/tavplubix)).
* これにより、clickhouse-server の Docker コンテナはサーバーの生存確認を行う際に IPv6 を優先的に利用するようになります。 [#11550](https://github.com/ClickHouse/ClickHouse/pull/11550) ([Ivan Starkov](https://github.com/istarkov))。
* `min_bytes_to_use_direct_io` が有効で、かつ PREWHERE が有効な状態で SAMPLE を使用している場合や、スレッド数が多い場合に発生しうる `Data compressed with different methods` エラーを修正しました。これにより [#11539](https://github.com/ClickHouse/ClickHouse/issues/11539) が解決されました。 [#11540](https://github.com/ClickHouse/ClickHouse/pull/11540) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `<node>` 向けの shard&#95;num/replica&#95;num を修正（use&#95;compact&#95;format&#95;in&#95;distributed&#95;parts&#95;names が機能しなくなっていた不具合）。 [#11528](https://github.com/ClickHouse/ClickHouse/pull/11528) ([Azat Khuzhin](https://github.com/azat)).
* prefer&#95;localhost&#95;replica=0 かつ internal&#95;replication を使用しない構成での Distributed テーブルへの非同期 `INSERT` を修正。 [#11527](https://github.com/ClickHouse/ClickHouse/pull/11527) ([Azat Khuzhin](https://github.com/azat)).
* `-State` 関数を用いた集約の途中で例外がスローされた場合に発生するメモリリークを修正しました。これにより [#8995](https://github.com/ClickHouse/ClickHouse/issues/8995) が解決されました。 [#11496](https://github.com/ClickHouse/ClickHouse/pull/11496) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `SELECT`（`max_threads`&gt;1）が複数のストリームを持ち、`INSERT` が1つのストリーム（`max_insert_threads`==0）のみを持つ場合に `INSERT SELECT FINAL` で発生していた `Pipeline stuck` 例外を修正しました。 [#11455](https://github.com/ClickHouse/ClickHouse/pull/11455) ([Azat Khuzhin](https://github.com/azat)).
* `select count() from t, u` のようなクエリで誤った結果が返される問題を修正。 [#11454](https://github.com/ClickHouse/ClickHouse/pull/11454) ([Artem Zuikov](https://github.com/4ertus2)).
* コーデックの返す圧縮サイズを修正しました。 [#11448](https://github.com/ClickHouse/ClickHouse/pull/11448) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 列がリテラル以外の引数を持つ圧縮コーデックを使用している場合に発生するサーバークラッシュを修正しました。[#11365](https://github.com/ClickHouse/ClickHouse/issues/11365) を修正します。 [#11431](https://github.com/ClickHouse/ClickHouse/pull/11431)（[alesapin](https://github.com/alesapin)）。
* テーブルが正常に作成されなかった場合の MergeTree のシャットダウン時に発生し得る、未初期化メモリの読み取りを修正しました。 [#11420](https://github.com/ClickHouse/ClickHouse/pull/11420) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `LowCarinality(T)` および `Nullable(T)` に対する JOIN 実行時のクラッシュを修正。[#11380](https://github.com/ClickHouse/ClickHouse/issues/11380)。[#11414](https://github.com/ClickHouse/ClickHouse/pull/11414)（[Artem Zuikov](https://github.com/4ertus2)）。
* 不正な `USING` キー指定に対するエラーコードを修正。 [#11373](https://github.com/ClickHouse/ClickHouse/issues/11373)。 [#11404](https://github.com/ClickHouse/ClickHouse/pull/11404) ([Artem Zuikov](https://github.com/4ertus2))。
* 緯度・経度の範囲外の引数が指定された場合の `geohashesInBox` の動作を修正しました。 [#11403](https://github.com/ClickHouse/ClickHouse/pull/11403) ([Vasily Nemkov](https://github.com/Enmk)).
* `joinGet()` 関数のエラーメッセージを改善。 [#11389](https://github.com/ClickHouse/ClickHouse/pull/11389) ([Artem Zuikov](https://github.com/4ertus2)).
* 外部ソートと `LIMIT` を含むクエリで発生する可能性のあった `Pipeline stuck` エラーを修正しました。 [#11359](https://github.com/ClickHouse/ClickHouse/issues/11359) を修正。 [#11366](https://github.com/ClickHouse/ClickHouse/pull/11366)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* ReplicatedMergeTree におけるパーツ送信時の冗長なロックを削除。 [#11354](https://github.com/ClickHouse/ClickHouse/pull/11354) ([alesapin](https://github.com/alesapin)).
* マルチラインモードにおける clickhouse-client の `\G`（縦方向出力）サポートを修正しました。これにより [#9933](https://github.com/ClickHouse/ClickHouse/issues/9933) が解決されます。[#11350](https://github.com/ClickHouse/ClickHouse/pull/11350)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `Lazy` データベースを使用する際に起こりうるセグメンテーションフォルトを修正。 [#11348](https://github.com/ClickHouse/ClickHouse/pull/11348) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `Join` テーブルエンジンからの（`JOIN` を伴わない）直接 `SELECT` におけるクラッシュと誤った NULL 許容性を修正。 [#11340](https://github.com/ClickHouse/ClickHouse/pull/11340) ([Artem Zuikov](https://github.com/4ertus2)).
* `quantilesExactWeightedArray` でクラッシュする問題を修正。 [#11337](https://github.com/ClickHouse/ClickHouse/pull/11337) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `ALTER` クエリでメタデータを変更する前にマージが停止するようになりました。 [#11335](https://github.com/ClickHouse/ClickHouse/pull/11335) ([alesapin](https://github.com/alesapin)).
* `parallel_view_processing = 1` 設定時の `MATERIALIZED VIEW` への書き込みを再び並列実行できるようにしました。[#10241](https://github.com/ClickHouse/ClickHouse/issues/10241) を修正。[#11330](https://github.com/ClickHouse/ClickHouse/pull/11330) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 抽出された JSON に、対応する閉じ括弧のない &#123; または [ を含む文字列がある場合の `visitParamExtractRaw` の動作を修正。 [#11318](https://github.com/ClickHouse/ClickHouse/pull/11318) ([Ewout](https://github.com/devwout)).
* `ThreadPool` における極めて稀に発生するレースコンディションを修正。 [#11314](https://github.com/ClickHouse/ClickHouse/pull/11314) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `clickhouse-copier` における軽微なデータレースを修正しました。統合テストで検出されました。 [#11313](https://github.com/ClickHouse/ClickHouse/pull/11313) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 変換処理において未初期化メモリが使用される可能性のある問題を修正しました。例: `SELECT toIntervalSecond(now64())`。[#11311](https://github.com/ClickHouse/ClickHouse/pull/11311) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* プライマリキーに Array 型カラムを持つテーブルで、そのカラムに対して `empty` または `notEmpty` 関数を用いてフィルタリングするクエリの場合に、インデックス解析が機能しない問題を修正しました。これにより [#11286](https://github.com/ClickHouse/ClickHouse/issues/11286) が解決されました。 [#11303](https://github.com/ClickHouse/ClickHouse/pull/11303)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* クエリが `max_network_bandwidth`、`max_execution_speed` または `priority` 設定によってスロットルされている場合に、クエリ速度の推定が誤ることがあり、その結果 `min_execution_speed` の制限が動作しない、もしくは誤って動作するバグを修正しました。`timeout_before_checking_execution_speed` のデフォルト値を非ゼロに変更しました。そうでない場合、`min_execution_speed` および `max_execution_speed` の設定が効果を持たないためです。これにより [#11297](https://github.com/ClickHouse/ClickHouse/issues/11297) が修正されます。また [#5732](https://github.com/ClickHouse/ClickHouse/issues/5732) も修正されます。さらに [#6228](https://github.com/ClickHouse/ClickHouse/issues/6228) も修正されます。ユーザビリティの改善として、`clickhouse-client` において例外メッセージとプログレスバーが連結されて表示されることを回避しました。[#11296](https://github.com/ClickHouse/ClickHouse/pull/11296) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `SET DEFAULT ROLE` が誤った引数で呼び出された場合にクラッシュする問題を修正し、[#10586](https://github.com/ClickHouse/ClickHouse/issues/10586) を解決しました。 [#11278](https://github.com/ClickHouse/ClickHouse/pull/11278) ([Vitaly Baranov](https://github.com/vitlibar))。
* `Protobuf` フォーマットで破損したデータを読み込む際に発生するクラッシュを修正しました。これにより、[#5957](https://github.com/ClickHouse/ClickHouse/issues/5957) および [#11203](https://github.com/ClickHouse/ClickHouse/issues/11203) の問題が修正されました。[#11258](https://github.com/ClickHouse/ClickHouse/pull/11258)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `cache` 辞書で、有効期限切れのキーしか存在しない場合に、本来の値ではなくデフォルト値を返してしまうバグを修正しました。これは文字列フィールドにのみ影響します。 [#11233](https://github.com/ClickHouse/ClickHouse/pull/11233) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 内部クエリに定数を含む `VIEW` から読み取る際に発生する `Block structure mismatch in QueryPipeline` エラーを修正。 [#11181](https://github.com/ClickHouse/ClickHouse/issues/11181) を解決。 [#11205](https://github.com/ClickHouse/ClickHouse/pull/11205)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `Invalid status for associated output` という例外が発生しうる不具合を修正。 [#11200](https://github.com/ClickHouse/ClickHouse/pull/11200) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `CREATE` クエリで `primary.idx` が定義されている場合、それがチェックされるようになりました。 [#11199](https://github.com/ClickHouse/ClickHouse/pull/11199) ([alesapin](https://github.com/alesapin)).
* `Array(Array(LowCardinality))` がキャプチャ引数として指定された高階関数で発生する可能性のある `Cannot capture column` エラーを修正しました。 [#11185](https://github.com/ClickHouse/ClickHouse/pull/11185) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 一部のバックエンドを使用していて、キー数が 1000 を超える場合に失敗する可能性があった `S3` のグロブ処理を修正しました。 [#11179](https://github.com/ClickHouse/ClickHouse/pull/11179) ([Vladimir Chebotarev](https://github.com/excitoon)).
* バックグラウンドでのマージ処理中に変更される列（`SummingMergeTree`、`AggregatingMergeTree` および TTL `GROUP BY` の場合）にデータスキップインデックスが依存している場合、インデックスが正しく計算できていませんでした。この問題は、マージ後にインデックスを計算するように変更し、マージ後のデータに対してインデックスが計算されるようにすることで修正されました。[#11162](https://github.com/ClickHouse/ClickHouse/pull/11162)（[Azat Khuzhin](https://github.com/azat)）。
* エンジンが Kafka のテーブルを DROP する際（またはサーバー再起動時）に時々発生していたハングの問題を修正。 [#11145](https://github.com/ClickHouse/ClickHouse/pull/11145) ([filimonov](https://github.com/filimonov)).
* 単純なクエリに対してスレッドを過剰に予約してしまう問題を修正（パイプラインの変更後に一部壊れていた、スレッド数削減のための最適化）。 [#11114](https://github.com/ClickHouse/ClickHouse/pull/11114) ([Azat Khuzhin](https://github.com/azat)).
* 何も確定されなかった場合は、mutation の finalization タスクからのログ出力を削除しました。 [#11109](https://github.com/ClickHouse/ClickHouse/pull/11109) ([alesapin](https://github.com/alesapin)).
* システムログテーブルの構造変更を伴う更新後に、サーバーの起動時に発生していたデッドロックを修正しました。 [#11106](https://github.com/ClickHouse/ClickHouse/pull/11106) ([alesapin](https://github.com/alesapin)).
* registerDiskS3で発生していたメモリリークを修正しました。 [#11074](https://github.com/ClickHouse/ClickHouse/pull/11074) ([Pavel Kovalenko](https://github.com/Jokser)).
* JOIN が PREWHERE 句と共に使用されている場合、または `optimize_move_to_prewhere` によって WHERE 句が PREWHERE 句に変換される場合に発生する `No such name in Block::erase()` というエラーを修正。 [#11051](https://github.com/ClickHouse/ClickHouse/pull/11051) ([Artem Zuikov](https://github.com/4ertus2)).
* Kafka エンジンテーブルの終了時に発生し得るデータの取りこぼしを修正しました。 [#11048](https://github.com/ClickHouse/ClickHouse/pull/11048) ([filimonov](https://github.com/filimonov)).
* parseDateTime64BestEffort の引数の解決に関する不具合を修正しました。 [#10925](https://github.com/ClickHouse/ClickHouse/issues/10925) [#11038](https://github.com/ClickHouse/ClickHouse/pull/11038) ([Vasily Nemkov](https://github.com/Enmk))。
* 1つの `ALTER` クエリ内で、同じカラムに対して `ADD/DROP` と `RENAME` を同時に実行できるようになりました。同時に指定した `MODIFY` と `RENAME` に対する例外メッセージが、よりわかりやすくなりました。[#10669](https://github.com/ClickHouse/ClickHouse/issues/10669) を部分的に修正しました。 [#11037](https://github.com/ClickHouse/ClickHouse/pull/11037) ([alesapin](https://github.com/alesapin))。
* S3 URL の解析処理を修正しました。 [#11036](https://github.com/ClickHouse/ClickHouse/pull/11036) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `LIMIT` 使用時の二段階 `GROUP BY` におけるメモリトラッキングを修正しました。 [#11022](https://github.com/ClickHouse/ClickHouse/pull/11022) ([Azat Khuzhin](https://github.com/azat)).
* テーブルが正常に作成されなかった場合に MergeTree でごくまれに発生しうる use-after-free エラーを修正しました。 [#10986](https://github.com/ClickHouse/ClickHouse/pull/10986) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* Atomicデータベースにおけるメタデータ（rename 向けの相対パス）およびデータ（symlink 向けの相対パス）の処理を修正しました。 [#10980](https://github.com/ClickHouse/ClickHouse/pull/10980) ([Azat Khuzhin](https://github.com/azat)).
* `Atomic` データベースエンジンで `ALTER` および `DROP DATABASE` クエリを同時に実行した際にサーバーがクラッシュする問題を修正。 [#10968](https://github.com/ClickHouse/ClickHouse/pull/10968) ([tavplubix](https://github.com/tavplubix)).
* メソッド `getRawData()` における誤った生データサイズを修正しました。 [#10964](https://github.com/ClickHouse/ClickHouse/pull/10964) ([Igr](https://github.com/ObjatieGroba)).
* バージョン 20.1 以前との間で発生していた二段階集約の互換性問題を修正しました。この問題は、イニシエーターノードとリモートノードで異なるバージョンの ClickHouse が使用されており、`GROUP BY` の結果が大きく、単一の `String` フィールドで集約が行われる場合に発生します。その結果、単一のキーに対してマージされていない複数の行が結果に含まれることがありました。 [#10952](https://github.com/ClickHouse/ClickHouse/pull/10952) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* DistributedBlockOutputStream によって部分的にしか書き込まれていないファイルが送信されないようにしました。 [#10940](https://github.com/ClickHouse/ClickHouse/pull/10940) ([Azat Khuzhin](https://github.com/azat)).
* `SELECT count(notNullIn(NULL, []))` におけるクラッシュの不具合を修正。 [#10920](https://github.com/ClickHouse/ClickHouse/pull/10920)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* エンジンが `Kafka` のテーブルを DROP する際（またはサーバー再起動中）に時々発生していたハングする問題を修正しました。 [#10910](https://github.com/ClickHouse/ClickHouse/pull/10910) ([filimonov](https://github.com/filimonov)).
* 現在、`a TO b, c TO a` のように、複数の `ALTER RENAME` 文をまとめて実行できるようになりました。 [#10895](https://github.com/ClickHouse/ClickHouse/pull/10895) ([alesapin](https://github.com/alesapin))。
* 同じカラムに対して複数スレッドから集約関数 state の結果を取得する際に発生しうるレースコンディションを修正しました。私が確認した限り、これが発生しうるのは、`quanite*` 関数用の `AggregateFunction` state を保持している `Memory` エンジンのテーブルを読み込む際に、`finalizeAggregation` 関数を使用している場合のみです。 [#10890](https://github.com/ClickHouse/ClickHouse/pull/10890) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Distributed テーブルでのタプルの後方互換性を修正しました。 [#10889](https://github.com/ClickHouse/ClickHouse/pull/10889) ([Anton Popov](https://github.com/CurtizJ)).
* StringHashTable で、存在しないキーを扱う際に発生する SIGSEGV を修正。 [#10870](https://github.com/ClickHouse/ClickHouse/pull/10870) ([Azat Khuzhin](https://github.com/azat)).
* `Atomic` エンジンを使用するデータベースから `LiveView` テーブルが削除された後に `WATCH` がハングする問題を修正しました。 [#10859](https://github.com/ClickHouse/ClickHouse/pull/10859) ([tavplubix](https://github.com/tavplubix)).
* `ReplicatedMergeTree` において、レプリカが非アクティブになった後もそのレプリカを待ち続けてしまい、一部の `OPTIMIZE` クエリに対する `ALTER` がハングする可能性があったバグを修正しました。 [#10849](https://github.com/ClickHouse/ClickHouse/pull/10849) ([tavplubix](https://github.com/tavplubix)).
* `CONSTRAINT` 式に含まれるカラムがリネームされた場合に、制約が更新されるようになりました。 [#10844](https://github.com/ClickHouse/ClickHouse/issues/10844) を修正。 [#10847](https://github.com/ClickHouse/ClickHouse/pull/10847) ([alesapin](https://github.com/alesapin))。
* キャッシュ辞書で未初期化メモリが読み取られる可能性のある問題を修正。 [#10834](https://github.com/ClickHouse/ClickHouse/pull/10834) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Block::sortColumns() の後にカラム順を修正し（あわせて、実際のユースケースである Buffer エンジンに影響することを示すテストも追加）、[#10826](https://github.com/ClickHouse/ClickHouse/pull/10826)（[Azat Khuzhin](https://github.com/azat)）。
* 識別子をクオートしないよう指定されている場合の ODBC ブリッジの問題を修正しました。この修正により [#7984](https://github.com/ClickHouse/ClickHouse/issues/7984) が解決されます。 [#10821](https://github.com/ClickHouse/ClickHouse/pull/10821) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* DateLUT における UBSan および MSan のレポートを修正。 [#10798](https://github.com/ClickHouse/ClickHouse/pull/10798) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* キー条件での型変換を正しく行うために `src_type` を利用。 [#6287](https://github.com/ClickHouse/ClickHouse/issues/6287) を修正。 [#10791](https://github.com/ClickHouse/ClickHouse/pull/10791) ([Andrew Onyshchuk](https://github.com/oandrew))。
* 古い libunwind のパッチを削除しました。 [https://github.com/ClickHouse-Extras/libunwind/commit/500aa227911bd185a94bfc071d68f4d3b03cb3b1#r39048012](https://github.com/ClickHouse-Extras/libunwind/commit/500aa227911bd185a94bfc071d68f4d3b03cb3b1#r39048012) これにより、`clang` ビルドで `-fno-omit-frame-pointer` を無効にできるようになり、平均で少なくとも 1% の性能向上が得られます。 [#10761](https://github.com/ClickHouse/ClickHouse/pull/10761) ([Amos Bird](https://github.com/amosbird))。
* 複数シャードにまたがって浮動小数点の重みを使用する場合の avgWeighted を修正しました。 [#10758](https://github.com/ClickHouse/ClickHouse/pull/10758) ([Baudouin Giard](https://github.com/bgiard))
* `parallel_view_processing` の動作を修正しました。これにより、例外が発生した場合でも、すべての `MATERIALIZED VIEW` への挿入処理が漏れなく完了するようになりました。 [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241) を修正。 [#10757](https://github.com/ClickHouse/ClickHouse/pull/10757) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* -State コンビネータと組み合わせた場合の -OrNull および -OrDefault コンビネータを修正。 [#10741](https://github.com/ClickHouse/ClickHouse/pull/10741) ([hcz](https://github.com/hczhcz))。
* ネストされた型で `generateRandom` がクラッシュする問題を修正。[#10583](https://github.com/ClickHouse/ClickHouse/issues/10583) を解決。[#10734](https://github.com/ClickHouse/ClickHouse/pull/10734)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* マージ後に発生した可能性のある、`SummingMergeTree` における `LowCardinality(FixedString)` キーカラムのデータ破損を修正します。 [#10489](https://github.com/ClickHouse/ClickHouse/issues/10489) を修正。 [#10721](https://github.com/ClickHouse/ClickHouse/pull/10721)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 関数でラップされた主キーを&#39;FINAL&#39;修飾子および&#39;ORDER BY&#39;最適化と併用した際の不具合を修正。[#10715](https://github.com/ClickHouse/ClickHouse/pull/10715) ([Anton Popov](https://github.com/CurtizJ)).
* 関数 `h3EdgeAngle` で発生しうるバッファオーバーフローを修正しました。 [#10711](https://github.com/ClickHouse/ClickHouse/pull/10711) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 消えてしまう合計値の問題を修正。クエリに `JOIN` や、外側に `WHERE` 条件を持つサブクエリが含まれている場合に、合計値がフィルタリングされてしまうことがありました。 [#10674](https://github.com/ClickHouse/ClickHouse/issues/10674) を修正。 [#10698](https://github.com/ClickHouse/ClickHouse/pull/10698)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* HTTP insert のアトミック性を修正しました。これにより [#9666](https://github.com/ClickHouse/ClickHouse/issues/9666) が解決されました。 [#10687](https://github.com/ClickHouse/ClickHouse/pull/10687) ([Andrew Onyshchuk](https://github.com/oandrew))。
* 1 つのクエリ内で同一の集合に対して複数回使用されていた `IN` 演算子を修正。 [#10686](https://github.com/ClickHouse/ClickHouse/pull/10686) ([Anton Popov](https://github.com/CurtizJ)).
* `readonly=2` かつ `cancel_http_readonly_queries_on_client_close=1` の場合に、クライアントが接続を閉じた際に HTTP リクエストがハングしてしまう不具合を修正しました。 [#7939](https://github.com/ClickHouse/ClickHouse/issues/7939)、[#7019](https://github.com/ClickHouse/ClickHouse/issues/7019)、[#7736](https://github.com/ClickHouse/ClickHouse/issues/7736)、[#7091](https://github.com/ClickHouse/ClickHouse/issues/7091) を解決します。 [#10684](https://github.com/ClickHouse/ClickHouse/pull/10684) ([tavplubix](https://github.com/tavplubix))。
* AggregateTransform コンストラクタのパラメータ順を修正。 [#10667](https://github.com/ClickHouse/ClickHouse/pull/10667) ([palasonic1](https://github.com/palasonic1)).
* `distributed_aggregation_memory_efficient` が有効な場合にリモートクエリが並列実行されない問題を修正しました。 [#10655](https://github.com/ClickHouse/ClickHouse/issues/10655) を修正。 [#10664](https://github.com/ClickHouse/ClickHouse/pull/10664)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `LIMIT` を含むクエリで返される行数が誤っている可能性がある問題を修正。[#10566](https://github.com/ClickHouse/ClickHouse/issues/10566)、[#10709](https://github.com/ClickHouse/ClickHouse/issues/10709) を解決。[#10660](https://github.com/ClickHouse/ClickHouse/pull/10660)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 多数のパーツを持つテーブルで同時実行される `ALTER` 操作がロックされてしまう不具合を修正。 [#10659](https://github.com/ClickHouse/ClickHouse/pull/10659) ([alesapin](https://github.com/alesapin)).
* サーバーがテーブルの起動前にシャットダウンされていた場合の StorageBuffer における `nullptr` デリファレンスを修正。 [#10641](https://github.com/ClickHouse/ClickHouse/pull/10641) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `HAVING` 句を含むクエリ（つまりクエリのイニシエータとなるサーバー側でのフィルタリングが必要なクエリ）に対して、分散クエリ用の述語最適化（`enable_optimize_predicate_expression=1`）を、式の順序を保持することで（これだけで修正としては十分）行い、さらにアグリゲータがインデックスではなくカラム名を使用するように強制しました。修正: [#10613](https://github.com/ClickHouse/ClickHouse/issues/10613), [#11413](https://github.com/ClickHouse/ClickHouse/issues/11413)。[#10621](https://github.com/ClickHouse/ClickHouse/pull/10621)（[Azat Khuzhin](https://github.com/azat)）。
* LowCardinality 使用時の `optimize_skip_unused_shards` の不具合を修正。 [#10611](https://github.com/ClickHouse/ClickHouse/pull/10611) ([Azat Khuzhin](https://github.com/azat)).
* サーバー起動時に例外が発生した際に `StorageBuffer` でセグメンテーションフォルトが発生する問題を修正しました。 [#10550](https://github.com/ClickHouse/ClickHouse/issues/10550) を修正。 [#10609](https://github.com/ClickHouse/ClickHouse/pull/10609)（[tavplubix](https://github.com/tavplubix)）。
* `SYSTEM DROP DNS CACHE` クエリの実行時に、特定の IP アドレスからの接続が許可されているかを確認するために使用されるキャッシュも削除されるようにしました。 [#10608](https://github.com/ClickHouse/ClickHouse/pull/10608) ([tavplubix](https://github.com/tavplubix)).
* 依存テーブルを含むクエリの場合に、`MATERIALIZED VIEW` の内部クエリで誤ったスカラー値が返される問題を修正しました。 [#10603](https://github.com/ClickHouse/ClickHouse/pull/10603) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 同期ミューテーション用の条件変数の扱いを修正しました。場合によっては、その条件変数へのシグナルが失われる可能性がありました。 [#10588](https://github.com/ClickHouse/ClickHouse/pull/10588) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `loadStoredObject()` が完了する前に `createDictionary()` が呼び出された場合に発生する可能性のあるクラッシュを修正します。 [#10587](https://github.com/ClickHouse/ClickHouse/pull/10587) ([Vitaly Baranov](https://github.com/vitlibar)).
* エラー `the BloomFilter false positive must be a double number between 0 and 1` を修正。 [#10551](https://github.com/ClickHouse/ClickHouse/issues/10551)、[#10569](https://github.com/ClickHouse/ClickHouse/pull/10569)（[Winter Zhang](https://github.com/zhang2014)）。
* 列の `ALIAS` でデフォルト式の型が列の型と異なる場合の `SELECT` を修正。 [#10563](https://github.com/ClickHouse/ClickHouse/pull/10563) ([Azat Khuzhin](https://github.com/azat)).
* DateTime と同様に、DateTime64 と String の値の比較を実装しました。 [#10560](https://github.com/ClickHouse/ClickHouse/pull/10560) ([Vasily Nemkov](https://github.com/Enmk))。
* コンパクトパーツを別のコンパクトパーツにマージした後、一部のケースで発生する可能性があるインデックスの破損を修正します。 [#10531](https://github.com/ClickHouse/ClickHouse/pull/10531) ([Anton Popov](https://github.com/CurtizJ)).
* GROUP BY における sharding&#95;key の最適化をデフォルトで無効化（`optimize_distributed_group_by_sharding_key` は導入時から、sharding&#95;key の解析の複雑さ ― 単純な例として sharding key 内の `if` ― によりデフォルト無効とされていた）し、WITH ROLLUP/CUBE/TOTALS で正しく動作するよう修正しました。 [#10516](https://github.com/ClickHouse/ClickHouse/pull/10516) ([Azat Khuzhin](https://github.com/azat)).
* 修正: [#10263](https://github.com/ClickHouse/ClickHouse/issues/10263)（この PR の後、INSERT 経由の dist send が各 INSERT ごとに遅延するようになっていた問題を修正） 修正: [#8756](https://github.com/ClickHouse/ClickHouse/issues/8756)（この PR により、次のすべての条件を満たす場合に distributed send が動作しなくなっていた問題を修正（現時点ではまず想定しにくい構成）：`internal_replication == false`、複数のローカルシャード（ハードリンク用コードを有効化）、および `distributed_storage_policy`（`EXDEV` により `link(2)` が失敗する原因））。 [#10486](https://github.com/ClickHouse/ClickHouse/pull/10486)（[Azat Khuzhin](https://github.com/azat)）。
* &quot;max&#95;rows&#95;to&#95;sort&quot; 制限に関する不具合を修正しました。 [#10268](https://github.com/ClickHouse/ClickHouse/pull/10268) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 外部ディクショナリを読み取る関数の各呼び出しにおいて、ディクショナリの取得とアクセス権の確認を一度だけ行うようにしました。 [#10928](https://github.com/ClickHouse/ClickHouse/pull/10928) ([Vitaly Baranov](https://github.com/vitlibar)).

#### 改善 {#improvement-15}


* `ALTER MODIFY TTL` クエリの後に古いデータに対して `TTL` を適用します。この動作は設定 `materialize_ttl_after_modify` によって制御され、デフォルトで有効になっています。 [#11042](https://github.com/ClickHouse/ClickHouse/pull/11042) ([Anton Popov](https://github.com/CurtizJ)).
* C 形式のバックスラッシュエスケープを含む文字列リテラル、`VALUES`、および各種テキストフォーマットをパースする際に（これは ClickHouse と MySQL に特有の SQL 標準への拡張です）、未知のエスケープシーケンス（例: `\%` や `\w`）が見つかった場合にはバックスラッシュを保持するようにしました。これにより、`LIKE` および `match` 正規表現の利用がより便利になり（`name LIKE 'used\\_cars'` の代わりに `name LIKE 'used\_cars'` と書くだけでよい）、同時に他の実装との互換性も向上します。この変更により [#10922](https://github.com/ClickHouse/ClickHouse/issues/10922) が修正されました。 [#11208](https://github.com/ClickHouse/ClickHouse/pull/11208)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* Decimal 型の値を読み込む際、小数点以下の余分な桁を切り捨てるようにしました。この挙動の方が MySQL および PostgreSQL との互換性が高くなります。この変更により [#10202](https://github.com/ClickHouse/ClickHouse/issues/10202) が修正されました。[#11831](https://github.com/ClickHouse/ClickHouse/pull/11831) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* ZooKeeper 内のメタデータがすでに削除され存在しない場合（テスト用に TestKeeper を使用していてサーバーが再起動された場合も同様）、レプリケーテッドテーブルを DROP できるようにしました。ZooKeeper との通信でエラーが発生していても、レプリケーテッドテーブルを RENAME できるようにしました。これにより [#10720](https://github.com/ClickHouse/ClickHouse/issues/10720) が修正されました。[#11652](https://github.com/ClickHouse/ClickHouse/pull/11652)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 文字列から Decimal 型を読み取る際の診断メッセージをわずかに改善しました。これにより [#10202](https://github.com/ClickHouse/ClickHouse/issues/10202) がクローズされました。 [#11829](https://github.com/ClickHouse/ClickHouse/pull/11829) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* シグナルハンドラー内での `sleep` 呼び出しを修正しました。想定より短い時間しかスリープしていませんでした。[#11825](https://github.com/ClickHouse/ClickHouse/pull/11825) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* （Linux のみ）OS 関連のパフォーマンスメトリクス（CPU および I/O 向け）は、`CAP_NET_ADMIN` ケーパビリティがなくても取得できます。[#10544](https://github.com/ClickHouse/ClickHouse/pull/10544) ([Alexander Kazakov](https://github.com/Akazz)).
* `hostName` 関数のエイリアスとして `hostname` を追加しました。この機能は Yandex.Metrica の Victor Tarnavskiy 氏の提案によるものです。 [#11821](https://github.com/ClickHouse/ClickHouse/pull/11821) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* クロスレプリケーションクラスターに対する分散 `DDL`（update/delete/drop partition）のサポートを追加しました。 [#11703](https://github.com/ClickHouse/ClickHouse/pull/11703) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 起動時に、いずれかの listen アドレスで待ち受けできない場合（例: Docker 内で IPv6 が利用できない場合）、サーバーログにはエラーではなく警告を出力するようにしました。なお、列挙されたすべてのアドレスで待ち受けに失敗した場合には、従来どおり起動を拒否します。これにより [#4406](https://github.com/ClickHouse/ClickHouse/issues/4406) が修正されました。 [#11687](https://github.com/ClickHouse/ClickHouse/pull/11687) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* Docker イメージ起動時にデフォルトのユーザーとデータベースを作成。 [#10637](https://github.com/ClickHouse/ClickHouse/pull/10637) ([Paramtamtam](https://github.com/tarampampam)).
* 複数行クエリがサーバーログに出力される際、行が1行に結合されます。複数行の文字列リテラル、識別子、および単一行コメントが含まれる場合でも正しく処理されるように修正しました。これにより [#3853](https://github.com/ClickHouse/ClickHouse/issues/3853) が解決されました。[#11686](https://github.com/ClickHouse/ClickHouse/pull/11686)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `CREATE USER`、`CREATE ROLE`、`ALTER USER`、`SHOW CREATE USER`、`SHOW GRANTS` などのコマンドで複数の名前を指定できるようになりました。 [#11670](https://github.com/ClickHouse/ClickHouse/pull/11670) ([Vitaly Baranov](https://github.com/vitlibar)).
* クロスレプリケーションクラスタにおける分散DDL（`UPDATE/DELETE/DROP PARTITION`）のサポートを追加。 [#11508](https://github.com/ClickHouse/ClickHouse/pull/11508)（[frank lee](https://github.com/etah000)）。
* ユーザーが明示的な値として指定した場合、`clickhouse-client` および `clickhouse-benchmark` のコマンドライン引数からパスワードをクリアします。これにより、`ps` などのツールによるパスワードの漏えいを防ぎます。 [#11665](https://github.com/ClickHouse/ClickHouse/pull/11665) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 実行中のバイナリと対応していない場合は、ELF ファイルのデバッグ情報を使用しないようにしました。これは、スタックトレース内で誤った関数名やソースコード上の位置が出力されることを防ぐために必要です。この変更により [#7514](https://github.com/ClickHouse/ClickHouse/issues/7514) が修正されました。[#11657](https://github.com/ClickHouse/ClickHouse/pull/11657)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* parseDateTimeBestEffortOrNull/Zero 関数で値を完全にパースできない場合に NULL/0 を返すようにしました。これにより [#7876](https://github.com/ClickHouse/ClickHouse/issues/7876) が修正されました。[#11653](https://github.com/ClickHouse/ClickHouse/pull/11653)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* リクエスト URL 内の空のパラメータをスキップするようにしました。これは `http://localhost:8123/?&a=b` や `http://localhost:8123/?a=b&&c=d` のように記述した場合に発生することがあります。これにより [#10749](https://github.com/ClickHouse/ClickHouse/issues/10749) がクローズされました。 [#11651](https://github.com/ClickHouse/ClickHouse/pull/11651)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `groupArrayArray` と `groupUniqArrayArray` を `SimpleAggregateFunction` として使用できるようにしました。 [#11650](https://github.com/ClickHouse/ClickHouse/pull/11650) ([Volodymyr Kuznetsov](https://github.com/ksvladimir)).
* 他の型に対するインデックス条件を解析する際に、暗黙的な型変換を行うことで定数文字列との比較を許可します。これにより [#11630](https://github.com/ClickHouse/ClickHouse/issues/11630) が解決される可能性があります。[#11648](https://github.com/ClickHouse/ClickHouse/pull/11648)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* [https://github.com/ClickHouse/ClickHouse/pull/7572#issuecomment-642815377](https://github.com/ClickHouse/ClickHouse/pull/7572#issuecomment-642815377) 設定ファイルでデフォルトの HTTPHandlers をサポート。[#11628](https://github.com/ClickHouse/ClickHouse/pull/11628) ([Winter Zhang](https://github.com/zhang2014)).
* Kafka エンジンで使用可能な入力フォーマットをさらに追加しました。早期にフラッシュされてしまう問題を修正しました。`kafka_num_consumers` がトピック内のパーティション数より大きい場合のパフォーマンス問題を修正しました。 [#11599](https://github.com/ClickHouse/ClickHouse/pull/11599) ([filimonov](https://github.com/filimonov)).
* `multiple_joins_rewriter_version=2` のロジックを改善し、lambda エイリアスに対する unknown column エラーを修正。[#11587](https://github.com/ClickHouse/ClickHouse/pull/11587) ([Artem Zuikov](https://github.com/4ertus2)).
* カラム定義リストを解析できない場合の例外メッセージを改善しました。これにより [#10403](https://github.com/ClickHouse/ClickHouse/issues/10403) がクローズされました。[#11537](https://github.com/ClickHouse/ClickHouse/pull/11537)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* VIEW 向けの `enable_optimize_predicate_expression=1` のロジックを改善しました。 [#11513](https://github.com/ClickHouse/ClickHouse/pull/11513) ([Artem Zuikov](https://github.com/4ertus2)).
* ライブビュー テーブルでの PREWHERE サポートを追加。 [#11495](https://github.com/ClickHouse/ClickHouse/pull/11495) ([vzakaznikov](https://github.com/vzakaznikov)).
* ユーザーがアドレスから接続することが許可されているかを確認するために使用される DNS キャッシュを自動更新するようになりました。 [#11487](https://github.com/ClickHouse/ClickHouse/pull/11487) ([tavplubix](https://github.com/tavplubix)).
* `OPTIMIZE FINAL` は、同時にマージが実行されている場合でも強制的にマージを行います。これにより [#11309](https://github.com/ClickHouse/ClickHouse/issues/11309) と [#11322](https://github.com/ClickHouse/ClickHouse/issues/11322) がクローズされます。 [#11346](https://github.com/ClickHouse/ClickHouse/pull/11346) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* clickhouse-client において、キャンセルされたクエリの出力を抑制しました。以前のバージョンでは、Ctrl+C を押してクエリをキャンセルした後でも、結果がターミナルに出力され続けることがありました。これにより [#9473](https://github.com/ClickHouse/ClickHouse/issues/9473) が解決しました。[#11342](https://github.com/ClickHouse/ClickHouse/pull/11342)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 現在、履歴ファイルはクエリごとに更新され、複数のクライアントが同じ履歴ファイルを使用してもレースコンディションは発生しません。これにより [#9897](https://github.com/ClickHouse/ClickHouse/issues/9897) が修正されました。 [#11453](https://github.com/ClickHouse/ClickHouse/pull/11453) ([Tagir Kuskarov](https://github.com/kuskarov))。
* 設定の再読み込み中のログメッセージを改善。 [#11341](https://github.com/ClickHouse/ClickHouse/pull/11341) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 一部のケースで、`clickhouse-client` または `clickhouse-format` で整形されたクエリから末尾の空白文字を削除するようにしました。 [#11325](https://github.com/ClickHouse/ClickHouse/pull/11325) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 設定 &quot;output&#95;format&#95;pretty&#95;max&#95;value&#95;width&quot; を追加しました。値がこの長さを超える場合は、ターミナルに過度に大きな値が出力されるのを避けるために切り詰められます。これにより [#11140](https://github.com/ClickHouse/ClickHouse/issues/11140) が解決されました。 [#11324](https://github.com/ClickHouse/ClickHouse/pull/11324) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* メモリマッピングが不足している場合の例外メッセージを改善しました。これにより [#11027](https://github.com/ClickHouse/ClickHouse/issues/11027) が解決しました。 [#11316](https://github.com/ClickHouse/ClickHouse/pull/11316) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* ASOF JOIN において (U)Int8、(U)Int16、Date をサポートしました。 [#11301](https://github.com/ClickHouse/ClickHouse/pull/11301) ([Artem Zuikov](https://github.com/4ertus2))。
* Kafka テーブルで kafka&#95;client&#95;id パラメータをサポートしました。また、ClickHouse が Kafka と通信する際に使用するデフォルトの `client.id` を、より情報量が多く実用的なものに変更しました。 [#11252](https://github.com/ClickHouse/ClickHouse/pull/11252) ([filimonov](https://github.com/filimonov)).
* 例外発生時にも `DistributedFilesToInsert` メトリクスの値を保持するようにしました。以前のバージョンでは、ファイルを送信しようとするタイミングで値が設定されていましたが、例外が発生すると、一部のファイルがまだ保留中であっても値は 0 になっていました。現在では、ファイルシステム上で保留中のファイル数を表すようになりました。 [#11220](https://github.com/ClickHouse/ClickHouse/pull/11220) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* SQL との互換性を高めるため、`DOUBLE PRECISION` や `CHAR VARYING` のような複数語で構成されるデータ型名のサポートを追加しました。 [#11214](https://github.com/ClickHouse/ClickHouse/pull/11214) ([Павел Потемкин](https://github.com/Potya)).
* 一部のデータ型にシノニムを追加しました。 [#10856](https://github.com/ClickHouse/ClickHouse/pull/10856) ([Павел Потемкин](https://github.com/Potya)).
* クエリログはデフォルトで有効になりました。 [#11184](https://github.com/ClickHouse/ClickHouse/pull/11184) ([Ivan Blinkov](https://github.com/blinkov)).
* `system.users` テーブルおよび `SHOW CREATE USER` クエリで認証方式を表示するようにしました。 [#11080](https://github.com/ClickHouse/ClickHouse/pull/11080) ([Vitaly Baranov](https://github.com/vitlibar)).
* `Memory` データベースエンジンで明示的に `DROP DATABASE` が実行された場合にデータを削除するように変更。[#10557](https://github.com/ClickHouse/ClickHouse/issues/10557) を修正。[#11021](https://github.com/ClickHouse/ClickHouse/pull/11021)（[tavplubix](https://github.com/tavplubix)）。
* `rdkafka` ライブラリの内部スレッドにスレッド名を設定し、`rdkafka` からのログをサーバーログからも確認できるようにした。[#10983](https://github.com/ClickHouse/ClickHouse/pull/10983) ([Azat Khuzhin](https://github.com/azat))。
* クエリ内での Unicode 空白文字をサポートしました。これにより、Word や Web ページからクエリをコピー＆ペーストしても正しく処理されます。この変更により [#10896](https://github.com/ClickHouse/ClickHouse/issues/10896) が修正されました。 [#10903](https://github.com/ClickHouse/ClickHouse/pull/10903) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 関数 `tupleElement` でインデックスとして大きな UInt 型を使用できるようにしました。[#10874](https://github.com/ClickHouse/ClickHouse/pull/10874) ([hcz](https://github.com/hczhcz))。
* Distributed への INSERT 時に prefer&#95;localhost&#95;replica/load&#95;balancing の設定を考慮するようにしました。 [#10867](https://github.com/ClickHouse/ClickHouse/pull/10867) ([Azat Khuzhin](https://github.com/azat)).
* `min_insert_block_size_rows_for_materialized_views`、`min_insert_block_size_bytes_for_materialized_views` 設定を導入しました。これらの設定は `min_insert_block_size_rows` および `min_insert_block_size_bytes` と似ていますが、`MATERIALIZED VIEW` に挿入されるブロックに対してのみ適用されます。これにより、マテリアライズドビュー (MV) への書き込み時のブロックの統合を制御し、過剰なメモリ使用を回避するのに役立ちます。 [#10858](https://github.com/ClickHouse/ClickHouse/pull/10858) ([Azat Khuzhin](https://github.com/azat)).
* サーバーシャットダウン中にレプリケーションキューから例外が発生しないようにしました。 [#10819](https://github.com/ClickHouse/ClickHouse/issues/10819) を修正しました。 [#10841](https://github.com/ClickHouse/ClickHouse/pull/10841)（[alesapin](https://github.com/alesapin)）。
* 数値誤差によって `varSamp` および `varPop` が負の値を返すことがないようにし、`stddevSamp` および `stddevPop` が負の分散から計算されないようにしました。これにより [#10532](https://github.com/ClickHouse/ClickHouse/issues/10532) が修正されました。 [#10829](https://github.com/ClickHouse/ClickHouse/pull/10829) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* DNS 例外メッセージを改善。これにより [#10813](https://github.com/ClickHouse/ClickHouse/issues/10813) を修正。[#10828](https://github.com/ClickHouse/ClickHouse/pull/10828)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 一部のパースエラーが発生した際の HTTP レスポンスコードを 400 Bad Request に変更しました。この修正により [#10636](https://github.com/ClickHouse/ClickHouse/issues/10636) が解決されました。 [#10640](https://github.com/ClickHouse/ClickHouse/pull/10640) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* clickhouse-client が clickhouse-server より新しいバージョンの場合にメッセージを出力するようにしました。 [#10627](https://github.com/ClickHouse/ClickHouse/pull/10627) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `INSERT INTO [db.]table WATCH` クエリのサポートを追加しました。 [#10498](https://github.com/ClickHouse/ClickHouse/pull/10498) ([vzakaznikov](https://github.com/vzakaznikov)).
* clickhouse-client で quota&#95;key を指定できるようにしました。これにより [#10227](https://github.com/ClickHouse/ClickHouse/issues/10227) がクローズされました。 [#10270](https://github.com/ClickHouse/ClickHouse/pull/10270)（[alexey-milovidov](https://github.com/alexey-milovidov)）。

#### パフォーマンスの改善 {#performance-improvement-9}


* 複数のレプリカがマージ、ミューテーション、パーティションの削除・移動・置換を同時に割り当てられるようにしました。これにより [#10367](https://github.com/ClickHouse/ClickHouse/issues/10367) がクローズされました。 [#11639](https://github.com/ClickHouse/ClickHouse/pull/11639) ([alexey-milovidov](https://github.com/alexey-milovidov)) [#11795](https://github.com/ClickHouse/ClickHouse/pull/11795) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* テーブルのソートキーを考慮した `GROUP BY` の最適化機能を `optimize_aggregation_in_order` 設定で有効化。[#9113](https://github.com/ClickHouse/ClickHouse/pull/9113)（[dimarub2000](https://github.com/dimarub2000)）。
* `FINAL` を伴う `SELECT` クエリは並列実行されます。使用するスレッド数を制限するための設定 `max_final_threads` が追加されました。 [#10463](https://github.com/ClickHouse/ClickHouse/pull/10463) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `INSERT SELECT` や、`clickhouse-client` を用いた INSERT において、小さなブロックが生成される場合（並列パースで典型的に発生）に INSERT クエリのパフォーマンスを改善しました。これにより [#11275](https://github.com/ClickHouse/ClickHouse/issues/11275) が修正されました。DEFAULT フィールドに対して CONSTRAINT が機能していなかった問題を修正しました。これにより [#11273](https://github.com/ClickHouse/ClickHouse/issues/11273) が修正されました。TEMPORARY テーブルで CONSTRAINTS が無視されていた問題を修正しました。これにより [#11274](https://github.com/ClickHouse/ClickHouse/issues/11274) が修正されました。[#11276](https://github.com/ClickHouse/ClickHouse/pull/11276)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `optimize_aggregators_of_group_by_keys` 設定によって有効化される、SELECT 句における GROUP BY 句のキーに対する min/max/any 集約関数を削除する最適化。[#11667](https://github.com/ClickHouse/ClickHouse/pull/11667) ([xPoSx](https://github.com/xPoSx)). [#11806](https://github.com/ClickHouse/ClickHouse/pull/11806) ([Azat Khuzhin](https://github.com/azat)).
* `any` 関数の外にすべての処理を移動する新しい最適化を追加し、`optimize_move_functions_out_of_any` で有効化 [#11529](https://github.com/ClickHouse/ClickHouse/pull/11529) （[Ruslan](https://github.com/kamalov-ruslan)）。
* Pretty 形式が使用されている対話モード時の `clickhouse-client` のパフォーマンスを改善しました。以前のバージョンでは、UTF-8 文字列の表示幅の計算に多くの時間がかかる場合がありました。この変更により [#11323](https://github.com/ClickHouse/ClickHouse/issues/11323) がクローズされました。[#11323](https://github.com/ClickHouse/ClickHouse/pull/11323)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `ORDER BY` と小さい `LIMIT`（`max_block_size` 未満）を含むクエリのパフォーマンスを改善。 [#11171](https://github.com/ClickHouse/ClickHouse/pull/11171) ([Albert Kidrachev](https://github.com/Provet)).
* 実行時の CPU 検出機能を追加し、最適な関数実装を選択して利用できるようにしました。複数ターゲット向けのコード生成をサポートしました。これにより [#1017](https://github.com/ClickHouse/ClickHouse/issues/1017) が解決されました。 [#10058](https://github.com/ClickHouse/ClickHouse/pull/10058) ([DimasKovas](https://github.com/DimasKovas))。
* ClickHouse バイナリの `mlock` をデフォルトで有効化しました。これにより、高い I/O 負荷下でも ClickHouse 実行ファイルがページアウトされるのを防ぎます。 [#11139](https://github.com/ClickHouse/ClickHouse/pull/11139) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* GROUP BY キーを指定せずに `sum` 集約関数を用いたクエリは、数倍高速に実行されます。 [#10992](https://github.com/ClickHouse/ClickHouse/pull/10992) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 単純キーを対象とする `ORDER BY` で使用される基数ソートについて、一部の冗長なデータ移動を削減して改善。 [#10981](https://github.com/ClickHouse/ClickHouse/pull/10981) ([Arslan Gumerov](https://github.com/g-arslan)).
* MergeJoin において左テーブルのより大きな部分をソートします。左ブロックをメモリにバッファします。左ブロックのバッファサイズを管理するための設定 `partial_merge_join_left_table_buffer_bytes` を追加しました。 [#10601](https://github.com/ClickHouse/ClickHouse/pull/10601) ([Artem Zuikov](https://github.com/4ertus2)).
* サブクエリ内の重複した ORDER BY と DISTINCT を削除します。この最適化は `optimize_duplicate_order_by_and_distinct` 設定で有効になります [#10067](https://github.com/ClickHouse/ClickHouse/pull/10067) ([Mikhail Malafeev](https://github.com/demo-99))。
* この機能は GROUP BY 句における他のキーに対する関数の使用を排除するもので、`optimize_group_by_function_keys` によって有効になります [#10051](https://github.com/ClickHouse/ClickHouse/pull/10051) ([xPoSx](https://github.com/xPoSx))。
* 集約関数から算術演算を外に出す新しい最適化を導入しました。この最適化は `optimize_arithmetic_operations_in_aggregate_functions` で有効化されます。[#10047](https://github.com/ClickHouse/ClickHouse/pull/10047)（[Ruslan](https://github.com/kamalov-ruslan)）。
* curl の代わりに Poco ベースの S3 向け HTTP クライアントを使用するようにしました。これにより、S3 ストレージおよびテーブル関数のパフォーマンスが向上し、メモリ使用量が削減されます。 [#11230](https://github.com/ClickHouse/ClickHouse/pull/11230) ([Pavel Kovalenko](https://github.com/Jokser)).
* 常に適用されていた制限に基づく再スケジュールに起因する Kafka のパフォーマンス問題を修正。 [#11149](https://github.com/ClickHouse/ClickHouse/pull/11149) ([filimonov](https://github.com/filimonov))。
* jemalloc で percpu&#95;arena:percpu を有効化（スレッドプールによるメモリ断片化を抑制します）。 [#11084](https://github.com/ClickHouse/ClickHouse/pull/11084) ([Azat Khuzhin](https://github.com/azat)).
* S3 HTTP クライアントからのレスポンス読み取り時のメモリ使用量を最適化。 [#11561](https://github.com/ClickHouse/ClickHouse/pull/11561) ([Pavel Kovalenko](https://github.com/Jokser)).
* パフォーマンス向上のために Kafka のデフォルト設定を調整。 [#11388](https://github.com/ClickHouse/ClickHouse/pull/11388) ([filimonov](https://github.com/filimonov))。

#### 実験的機能 {#experimental-feature-5}

- データ型`Point`(Tuple(Float64, Float64))および`Polygon`(Array(Array(Tuple(Float64, Float64)))を追加しました。[#10678](https://github.com/ClickHouse/ClickHouse/pull/10678) ([Alexey Ilyukhov](https://github.com/livace))。
- 配列内の部分列を検索するための`hasSubstr`関数を追加しました。注意: この関数は予告なく名前が変更される可能性があります。[#11071](https://github.com/ClickHouse/ClickHouse/pull/11071) ([Ryad Zenine](https://github.com/r-zenine))。
- OpenCLサポートとバイトニックソートアルゴリズムを追加しました。単一カラム内の整数型データのソートに使用できます。`-DENABLE_OPENCL=1`フラグを指定してビルドする必要があります。他のアルゴリズムの代わりにバイトニックソートアルゴリズムを使用するには、設定オプション`special_sort`に`bitonic_sort`を設定し、OpenCLが利用可能であることを確認してください。この機能はパフォーマンスの向上などを目的としたものではなく、例示およびデモンストレーション目的でのみ提供されています。この方向での更なる開発が行われない場合、近い将来削除される可能性があります。[#10232](https://github.com/ClickHouse/ClickHouse/pull/10232) ([Ri](https://github.com/margaritiko))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-11}


* programs および utils で clang-tidy を有効化。 [#10991](https://github.com/ClickHouse/ClickHouse/pull/10991) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `tzdata` への依存関係を削除しました。`/usr/share/zoneinfo` ディレクトリが存在しない場合でも異常終了しないようにしました。システムに `tzdata` がインストールされていない場合でも、ClickHouse ではすべてのタイムゾーンが利用可能であることに注意してください。 [#11827](https://github.com/ClickHouse/ClickHouse/pull/11827) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* MSan と UBSan のストレステストを追加しました。すでに機能テスト用の MSan、UBSan はありますが、「ストレス」テストは別種のテストである点に注意してください。 [#10871](https://github.com/ClickHouse/ClickHouse/pull/10871) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* クラッシュメッセージにコンパイラのビルド ID を出力するようにしました。これにより、どのバイナリがクラッシュしたかを以前よりも確実に特定できるようになります。新しい関数 `buildId` を追加しました。 [#11824](https://github.com/ClickHouse/ClickHouse/pull/11824) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* FREEZE クエリ実行後も mutation が動作し続けることを確認するテストを追加しました。 [#11820](https://github.com/ClickHouse/ClickHouse/pull/11820) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* テスト名に「fail」という文字列を含めないようにしました。ブラウザでテスト結果を表示した際に、Ctrl+F で「fail」を検索しづらくなるためです。 [#11817](https://github.com/ClickHouse/ClickHouse/pull/11817) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* HTTPHandlerFactory から未使用のインポートを削除します。 [#11660](https://github.com/ClickHouse/ClickHouse/pull/11660) ([Bharat Nallan](https://github.com/bharatnc)).
* copier が実行されるインスタンスの一部をランダムにサンプリングする処理を追加しました。これは `Too many simultaneous queries` エラーを回避するために必要です。また、タイムアウト値を延長し、障害発生の確率を下げました。 [#11573](https://github.com/ClickHouse/ClickHouse/pull/11573) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 抜けていた include を修正。 [#11525](https://github.com/ClickHouse/ClickHouse/pull/11525) ([Matwey V. Kornilov](https://github.com/matwey)).
* 古いサンプルプログラムを削除してビルド時間を短縮しました。また、孤立していた機能テストもいくつか見つかりました。 [#11486](https://github.com/ClickHouse/ClickHouse/pull/11486) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* CI ビルドで使用する ccache のサイズを増やしました。 [#11450](https://github.com/ClickHouse/ClickHouse/pull/11450) ([alesapin](https://github.com/alesapin)).
* deb ビルドには unit&#95;tests&#95;dbms のみを含める。 [#11429](https://github.com/ClickHouse/ClickHouse/pull/11429) ([Ilya Yatsishin](https://github.com/qoega)).
* librdkafka をバージョン [1.4.2](https://github.com/edenhill/librdkafka/releases/tag/v1.4.2) に更新。[#11256](https://github.com/ClickHouse/ClickHouse/pull/11256)（[filimonov](https://github.com/filimonov)）。
* CMake ビルドファイルをリファクタリングしました。 [#11390](https://github.com/ClickHouse/ClickHouse/pull/11390) ([Ivan](https://github.com/abyss7))。
* いくつかの不安定な統合テストを修正。 [#11355](https://github.com/ClickHouse/ClickHouse/pull/11355) ([alesapin](https://github.com/alesapin)).
* UBSan を用いて実行するユニットテストのサポートを追加しました。[#11345](https://github.com/ClickHouse/ClickHouse/pull/11345) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* インテグレーションテスト `test_insertion_sync_fails_with_timeout` から冗長なタイムアウトを削除しました。 [#11343](https://github.com/ClickHouse/ClickHouse/pull/11343) ([alesapin](https://github.com/alesapin))。
* clickhouse-test におけるハングしたクエリの検出を改善しました。 [#11321](https://github.com/ClickHouse/ClickHouse/pull/11321) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* サーバーがデバッグビルドまたはサニタイザー有効でビルドされている場合に警告を出すようにしました。 [#11304](https://github.com/ClickHouse/ClickHouse/pull/11304) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `clickhouse-test` は、テストを実行する前にサーバーが稼働しているかを確認するようになりました。 [#11285](https://github.com/ClickHouse/ClickHouse/pull/11285) ([alesapin](https://github.com/alesapin)).
* 潜在的に不安定なテスト `00731_long_merge_tree_select_opened_files.sh` を修正しました。このテストは頻繁には失敗しませんが、ThreadFuzzer を用いた実験中に潜在的なレースコンディションがあることが分かりました（[#9814](https://github.com/ClickHouse/ClickHouse/issues/9814)）。例については [link](https://clickhouse-test-reports.s3.yandex.net/9814/40e3023e215df22985d275bf85f4d2290897b76b/functional_stateless_tests_\(unbundled\).html#fail1) を参照してください。 [#11270](https://github.com/ClickHouse/ClickHouse/pull/11270) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* CI で `curl` 呼び出しがタイムアウトした場合はテストを再実行します。これは、当社の CI インフラストラクチャでよく発生する、10 秒以上に及ぶシステムハングアップが原因で起こり得ます。これにより [#11267](https://github.com/ClickHouse/ClickHouse/issues/11267) が修正されました。[#11268](https://github.com/ClickHouse/ClickHouse/pull/11268)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* @donmikel による Join テーブルエンジン向けのテストを追加。これにより [#9158](https://github.com/ClickHouse/ClickHouse/issues/9158) がクローズされます。 [#11265](https://github.com/ClickHouse/ClickHouse/pull/11265)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* ユニットテスト内のいくつかの軽微なエラーを修正しました。 [#11262](https://github.com/ClickHouse/ClickHouse/pull/11262) ([alesapin](https://github.com/alesapin)).
* これにより、`cctz` ライブラリ向けリンカーコマンドの一部が他のライブラリと混在して順序が入れ替わることはなくなりました。 [#11213](https://github.com/ClickHouse/ClickHouse/pull/11213) ([alesapin](https://github.com/alesapin)).
* /programs/server を実際のプログラム本体とライブラリに分割しました。 [#11186](https://github.com/ClickHouse/ClickHouse/pull/11186) ([Ivan](https://github.com/abyss7)).
* protobuf と gRPC 用のビルドスクリプトを改善しました。 [#11172](https://github.com/ClickHouse/ClickHouse/pull/11172)（[Vitaly Baranov](https://github.com/vitlibar)）
* 動作していなかったパフォーマンステストを有効にしました。 [#11158](https://github.com/ClickHouse/ClickHouse/pull/11158) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* いずれの ClickHouse インスタンスも起動する前に、テスト用のルート S3 バケットを作成するようにしました。 [#11142](https://github.com/ClickHouse/ClickHouse/pull/11142) ([Pavel Kovalenko](https://github.com/Jokser))。
* 非定数ポリゴン向けのパフォーマンステストを追加。 [#11141](https://github.com/ClickHouse/ClickHouse/pull/11141) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `00979_live_view_watch_continuous_aggregates` テストの修正。 [#11024](https://github.com/ClickHouse/ClickHouse/pull/11024) ([vzakaznikov](https://github.com/vzakaznikov)).
* 統合テストで `tmpfs` 上で ZooKeeper を実行できるようにする機能を追加。 [#11002](https://github.com/ClickHouse/ClickHouse/pull/11002) ([alesapin](https://github.com/alesapin))。
* 指数バックオフ方式で odbc-bridge を待機するようにしました。CI 環境では以前の待機時間 200 ms では不十分でした。[#10990](https://github.com/ClickHouse/ClickHouse/pull/10990) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 非決定的なテストを修正しました。 [#10989](https://github.com/ClickHouse/ClickHouse/pull/10989) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 空の外部データ用のテストを追加しました。 [#10926](https://github.com/ClickHouse/ClickHouse/pull/10926) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* データベースは各テストのたびに再作成されます。これによりテスト間の独立性が高まります。 [#10902](https://github.com/ClickHouse/ClickHouse/pull/10902) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* カラム関連のコードにアサーションをさらに追加しました。 [#10833](https://github.com/ClickHouse/ClickHouse/pull/10833) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* サニタイザとの連携を改善しました。サニタイザの失敗メッセージに `query_id` の情報を出力するようにしました。 [#10832](https://github.com/ClickHouse/ClickHouse/pull/10832) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* &quot;Split build smoke test&quot; チェックにおける明らかなレースコンディションを修正。 [#10820](https://github.com/ClickHouse/ClickHouse/pull/10820) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* MergeTreeIndexFullText における MSan による誤検出レポートを修正。最初に報告されたのは [#9968](https://github.com/ClickHouse/ClickHouse/issues/9968)。[#10801](https://github.com/ClickHouse/ClickHouse/pull/10801)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* MariaDB Client ライブラリ用に MSan 抑制を追加。[#10800](https://github.com/ClickHouse/ClickHouse/pull/10800)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* GRPC の make で protobuf ファイルが見つからなかったため、適切なリンクを追加して Makefile を修正しました。 [#10794](https://github.com/ClickHouse/ClickHouse/pull/10794) ([mnkonkova](https://github.com/mnkonkova)).
* base、utils、programs に対して追加の警告（`-Weverything`）を有効にしました。なお、コードの大部分ではすでに有効になっています。 [#10779](https://github.com/ClickHouse/ClickHouse/pull/10779) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* ライブラリからの警告抑制が、[#10396](https://github.com/ClickHouse/ClickHouse/issues/10396) で誤って public として宣言されていました。[#10776](https://github.com/ClickHouse/ClickHouse/pull/10776)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* [#10396](https://github.com/ClickHouse/ClickHouse/issues/10396) で誤って削除されたパッチを復元しました。 [#10774](https://github.com/ClickHouse/ClickHouse/pull/10774) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* パフォーマンステストでのエラーを修正（その2）。 [#10773](https://github.com/ClickHouse/ClickHouse/pull/10773) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* パフォーマンステストにおけるエラーを修正。[#10766](https://github.com/ClickHouse/ClickHouse/pull/10766) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* クロスビルドを更新し、clang-10 コンパイラを使用するようにしました。 [#10724](https://github.com/ClickHouse/ClickHouse/pull/10724) ([Ivan](https://github.com/abyss7)).
* RPM パッケージのインストール手順を更新しました。これは Denis（TG ログイン名 @ldviolet）の提案に基づき、Arkady Shejn によって実装されました。 [#10707](https://github.com/ClickHouse/ClickHouse/pull/10707) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `tests/queries/0_stateless/01246_insert_into_watch_live_view.py` テストの修正を試みる。 [#10670](https://github.com/ClickHouse/ClickHouse/pull/10670)（[vzakaznikov](https://github.com/vzakaznikov)）。
* 00979&#95;live&#95;view&#95;watch&#95;continuous&#95;aggregates.py テストを修正し、再度有効化しました。 [#10658](https://github.com/ClickHouse/ClickHouse/pull/10658) ([vzakaznikov](https://github.com/vzakaznikov)).
* ASan ストレステストで発生する OOM を修正。 [#10646](https://github.com/ClickHouse/ClickHouse/pull/10646) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* clang-10 への移行後に HashTable で発生した UBSan のレポート（nullptr に 0 を加算する問題）を修正しました。[#10638](https://github.com/ClickHouse/ClickHouse/pull/10638) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* コンパイル時の tzdata 処理中に行われていた外部 `ld` (bfd) リンカーの呼び出しを削除しました。 [#10634](https://github.com/ClickHouse/ClickHouse/pull/10634) ([alesapin](https://github.com/alesapin))。
* `lld` を使用して blob（リソース）をリンクできるようにしました。 [#10632](https://github.com/ClickHouse/ClickHouse/pull/10632) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `LZ4` ライブラリでの UBSan レポートに関する問題を修正。 [#10631](https://github.com/ClickHouse/ClickHouse/pull/10631) ([alexey-milovidov](https://github.com/alexey-milovidov))。あわせてこちらも参照: [https://github.com/lz4/lz4/issues/857](https://github.com/lz4/lz4/issues/857)
* LZ4 を最新の開発ブランチに更新。 [#10630](https://github.com/ClickHouse/ClickHouse/pull/10630) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 安定版バージョンの一覧を含む機械可読な自動生成ファイルを追加しました。 [#10628](https://github.com/ClickHouse/ClickHouse/pull/10628) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `capnp::UnalignedFlatArrayMessageReader` 用の `capnproto` バージョンチェックを修正しました。 [#10618](https://github.com/ClickHouse/ClickHouse/pull/10618) ([Matwey V. Kornilov](https://github.com/matwey)).
* テスト時のメモリ使用量を削減。 [#10617](https://github.com/ClickHouse/ClickHouse/pull/10617) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 新しい Live View テストにおけるハードコードされたタイムアウトの修正。 [#10604](https://github.com/ClickHouse/ClickHouse/pull/10604) ([vzakaznikov](https://github.com/vzakaznikov))。
* tests/queries/0&#95;stateless/helpers/client.py でクライアントを開く際のタイムアウトを延長。 [#10599](https://github.com/ClickHouse/ClickHouse/pull/10599) ([vzakaznikov](https://github.com/vzakaznikov))。
* clang によるビルドで ThinLTO を有効化しました。[#10435](https://github.com/ClickHouse/ClickHouse/pull/10435) の継続対応です。[#10585](https://github.com/ClickHouse/ClickHouse/pull/10585)（[Amos Bird](https://github.com/amosbird)）。
* fuzzer の追加と oss-fuzz との統合に向けた準備。 [#10546](https://github.com/ClickHouse/ClickHouse/pull/10546) ([kyprizel](https://github.com/kyprizel)).
* FreeBSD 向けビルドを修正。 [#10150](https://github.com/ClickHouse/ClickHouse/pull/10150) ([Ivan](https://github.com/abyss7)).
* pytest フレームワークを使用するクエリテスト用の新しいビルドを追加。 [#10039](https://github.com/ClickHouse/ClickHouse/pull/10039) ([Ivan](https://github.com/abyss7)).





## ClickHouse リリース v20.4 {#clickhouse-release-v204}

### ClickHouse リリース v20.4.8.99-stable 2020-08-10 {#clickhouse-release-v204899-stable-2020-08-10}

#### バグ修正 {#bug-fix-28}


* `parseDateTimeBestEffort` 関数に Unix タイムスタンプが引数として渡された場合に発生していたエラーを修正しました。これにより [#13362](https://github.com/ClickHouse/ClickHouse/issues/13362) が解決されます。 [#13441](https://github.com/ClickHouse/ClickHouse/pull/13441) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* NaN を含む Float 型に対して呼び出された `uniqExact`、`topK`、`sumDistinct` などの集約関数における、潜在的なパフォーマンス低下およびわずかに不正確な結果を修正しました。これはデバッグビルドでのアサートも引き起こしていました。この修正は [#12491](https://github.com/ClickHouse/ClickHouse/issues/12491) を解決します。[#13254](https://github.com/ClickHouse/ClickHouse/pull/13254)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* リテラル NULL ではない null 許容 constexpr を条件として受け取る if 関数を修正しました。[#12463](https://github.com/ClickHouse/ClickHouse/issues/12463) を修正します。[#13226](https://github.com/ClickHouse/ClickHouse/pull/13226)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 配列要素が Nullable であり、配列添字も Nullable の場合における `arrayElement` 関数内のアサートを修正しました。これにより [#12172](https://github.com/ClickHouse/ClickHouse/issues/12172) が修正されました。[#13224](https://github.com/ClickHouse/ClickHouse/pull/13224)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 関数を使用したインデックス解析の誤りを修正しました。これにより、`MergeTree` テーブルから読み込む際に誤ったパーツがプルーニング（除外）されてしまう可能性がありました。[#13060](https://github.com/ClickHouse/ClickHouse/issues/13060) を修正。[#12406](https://github.com/ClickHouse/ClickHouse/issues/12406) を修正。[#13081](https://github.com/ClickHouse/ClickHouse/pull/13081)（[Anton Popov](https://github.com/CurtizJ)）。
* ローカルレプリカからの SELECT 時にスレッド数が不必要に制限されていた問題を修正しました。 [#12840](https://github.com/ClickHouse/ClickHouse/pull/12840) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `WITH TOTALS` を含むクエリで発生する可能性があったデータ中の余分なオーバーフロー行を修正しました。 [#12747](https://github.com/ClickHouse/ClickHouse/pull/12747) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `IN` 節で関数として解釈される大きなタプルを含む場合の性能を修正しました。ユーザーが、何らかのよく分からない理由で `WHERE x IN (1, 2, ...)` ではなく `WHERE x IN tuple(1, 2, ...)` と記述するケースです。 [#12700](https://github.com/ClickHouse/ClickHouse/pull/12700) ([Anton Popov](https://github.com/CurtizJ)).
* `input_format_parallel_parsing` のメモリトラッキングを修正しました（スレッドをグループにアタッチすることで対応）。[#12672](https://github.com/ClickHouse/ClickHouse/pull/12672) ([Azat Khuzhin](https://github.com/azat)).
* [#12293](https://github.com/ClickHouse/ClickHouse/issues/12293) を修正し、サブクエリが WITH 句を含む場合でも述語プッシュダウンを許可しました。[#12663](https://github.com/ClickHouse/ClickHouse/pull/12663) ([Winter Zhang](https://github.com/zhang2014))。
* 定数式を用いた Bloom フィルタインデックスの不具合を修正しました。 [#10572](https://github.com/ClickHouse/ClickHouse/issues/10572) [#12659](https://github.com/ClickHouse/ClickHouse/pull/12659) ([Winter Zhang](https://github.com/zhang2014)).
* ブローカーが利用不能な場合（およびその他のケースでも）に `StorageKafka` で発生していた `SIGSEGV` を修正しました。 [#12658](https://github.com/ClickHouse/ClickHouse/pull/12658) ([Azat Khuzhin](https://github.com/azat)).
* `Array(UUID)` 引数を持つ `if` 関数のサポートを追加しました。これにより [#11066](https://github.com/ClickHouse/ClickHouse/issues/11066) が修正されます。[#12648](https://github.com/ClickHouse/ClickHouse/pull/12648)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* キャッシュレイアウトを用いる外部ディクショナリにおけるレースコンディションを修正しました。サーバーがクラッシュする可能性がありました。 [#12566](https://github.com/ClickHouse/ClickHouse/pull/12566) ([alesapin](https://github.com/alesapin)).
* `DROP TABLE` 時に Distributed テーブルのデータ（非同期 `INSERT` によるブロック）を削除するようにしました。 [#12556](https://github.com/ClickHouse/ClickHouse/pull/12556) ([Azat Khuzhin](https://github.com/azat)).
* `enable_mixed_granularity_parts=1` のときに `ALTER DELETE` クエリの後で古いパーツが破損してしまう不具合を修正しました。[#12536](https://github.com/ClickHouse/ClickHouse/issues/12536) を修正。[#12543](https://github.com/ClickHouse/ClickHouse/pull/12543) ([alesapin](https://github.com/alesapin))。
* `in` 関数で引数の数が不正な場合の例外を改善。 [#12529](https://github.com/ClickHouse/ClickHouse/pull/12529) ([Anton Popov](https://github.com/CurtizJ)).
* コンパクトパーツから読み取る際のパフォーマンス問題を修正しました。 [#12492](https://github.com/ClickHouse/ClickHouse/pull/12492) ([Anton Popov](https://github.com/CurtizJ)).
* 辞書のキーの式を使って JOIN している場合（`t JOIN dict ON expr(dict.id) = t.id`）に発生していた、辞書を使った JOIN のクラッシュを修正しました。このケースでは辞書 JOIN の最適化を無効化しました。[#12458](https://github.com/ClickHouse/ClickHouse/pull/12458)（[Artem Zuikov](https://github.com/4ertus2)）。
* StorageMerge で発生する可能性のあったセグメンテーションフォルトを修正。 [#12054](https://github.com/ClickHouse/ClickHouse/issues/12054) をクローズ。 [#12401](https://github.com/ClickHouse/ClickHouse/pull/12401) ([tavplubix](https://github.com/tavplubix)).
* `WITH FILL` 修飾子における列の順序を修正しました。以前は、`ORDER BY` 句で指定した列の順序が反映されていませんでした。 [#12306](https://github.com/ClickHouse/ClickHouse/pull/12306) ([Anton Popov](https://github.com/CurtizJ)).
* 仮想カラム（`Merge` テーブルにおける `_table` など）や、`system.tables` からクエリする際のデータベース名によるフィルタリングのような、システムテーブルのインデックスカラムでデータをフィルタする式が `Nullable` 型を返す場合に、&quot;bad cast&quot; 例外が発生しないようにしました。これにより [#12166](https://github.com/ClickHouse/ClickHouse/issues/12166) が修正されます。 [#12305](https://github.com/ClickHouse/ClickHouse/pull/12305) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* TrieDictionary の読み込みに失敗した場合にエラーを表示するようにしました。 [#12290](https://github.com/ClickHouse/ClickHouse/pull/12290) ([Vitaly Baranov](https://github.com/vitlibar)).
* 関数 `arrayFill` が空配列を処理する際に正しく動作せず、クラッシュを引き起こす可能性がありました。この変更により [#12263](https://github.com/ClickHouse/ClickHouse/issues/12263) が修正されました。 [#12279](https://github.com/ClickHouse/ClickHouse/pull/12279)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `LowCardinality` 型に対する共通型への変換を実装しました。これにより、LowCardinality 型の列とその他の列を含むテーブル間で UNION ALL を実行できるようになりました。この変更により [#8212](https://github.com/ClickHouse/ClickHouse/issues/8212) および [#4342](https://github.com/ClickHouse/ClickHouse/issues/4342) が修正されます。 [#12275](https://github.com/ClickHouse/ClickHouse/pull/12275)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `StorageFile` への連続した複数回の挿入時に、一部の特殊な型でヘッダーが複数回書き込まれてしまう問題を修正しました。これにより [#6155](https://github.com/ClickHouse/ClickHouse/issues/6155) が解決されました。[#12197](https://github.com/ClickHouse/ClickHouse/pull/12197)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* UInt8 値が 0 または 1 でない場合の論理関数の動作を修正しました。 [#12196](https://github.com/ClickHouse/ClickHouse/pull/12196) ([Alexander Kazakov](https://github.com/Akazz))。
* max&#95;memory&#95;usage* の上限をプロセスの常駐メモリ量までに制限。 [#12182](https://github.com/ClickHouse/ClickHouse/pull/12182) ([Azat Khuzhin](https://github.com/azat)).
* GROUP BY で単射関数を削除する際の `dictGet` の引数チェックを修正しました。 [#12179](https://github.com/ClickHouse/ClickHouse/pull/12179) ([Azat Khuzhin](https://github.com/azat)).
* ODBC 接続がスキーマをサポートしていない場合、辞書ソースのテーブル名をスキーマとテーブル名に分割しないようにしました。 [#12165](https://github.com/ClickHouse/ClickHouse/pull/12165) ([Vitaly Baranov](https://github.com/vitlibar)).
* `ALTER DELETE` において、条件が NULL と評価される場合にレコードが削除されてしまう不正なロジックを修正しました。これにより [#9088](https://github.com/ClickHouse/ClickHouse/issues/9088) が解決されます。この変更は [#12106](https://github.com/ClickHouse/ClickHouse/issues/12106) をクローズします。[#12153](https://github.com/ClickHouse/ClickHouse/pull/12153)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* エイリアスが存在する場合に、外部 DBMS（例: MySQL、ODBC）へ送信するクエリの変換処理を修正しました。これにより [#12032](https://github.com/ClickHouse/ClickHouse/issues/12032) が解決されています。[#12151](https://github.com/ClickHouse/ClickHouse/pull/12151)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 整数除算で発生し得るオーバーフローを修正しました。これにより [#12119](https://github.com/ClickHouse/ClickHouse/issues/12119) が解決されています。[#12140](https://github.com/ClickHouse/ClickHouse/pull/12140) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `greatCircleDistance` と `geoDistance` において無限ループが発生する可能性のあった問題を修正しました。これにより [#12117](https://github.com/ClickHouse/ClickHouse/issues/12117) が解決されました。 [#12137](https://github.com/ClickHouse/ClickHouse/pull/12137)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 「pid」ファイルの扱いを正規化しました。以前のバージョンでは、サーバーが正しくシャットダウンされずに強制終了され、その後、以前のサーバーと同じ pid を持つ別のプロセスが存在する場合、サーバーの起動が拒否されることがありました。また、別のサーバーが稼働中であっても、サーバーの起動に失敗した際に pid ファイルが削除されてしまうことがありました。これにより [#3501](https://github.com/ClickHouse/ClickHouse/issues/3501) が修正されました。 [#12133](https://github.com/ClickHouse/ClickHouse/pull/12133) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* ENGINE=Dictionary を使用するテーブルの、ディクショナリに対する依存関係の扱いを修正しました。これにより [#10994](https://github.com/ClickHouse/ClickHouse/issues/10994) および [#10397](https://github.com/ClickHouse/ClickHouse/issues/10397) の問題が修正されています。[#12116](https://github.com/ClickHouse/ClickHouse/pull/12116)（[Vitaly Baranov](https://github.com/vitlibar)）。
* スレッド総数に対する誤った上限設定が原因で発生していた、`UNION` を含む SELECT クエリのパフォーマンス低下を修正しました。 [#12030](https://github.com/ClickHouse/ClickHouse/issues/12030) を解決。 [#12103](https://github.com/ClickHouse/ClickHouse/pull/12103)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `-StateResample` コンビネータで発生していたセグメンテーションフォルトを修正しました。 [#12092](https://github.com/ClickHouse/ClickHouse/pull/12092) ([Anton Popov](https://github.com/CurtizJ)).
* `SELECT` クエリに対する `system.query_log` 内の空の `result_rows` および `result_bytes` メトリクスを修正しました。 [#11595](https://github.com/ClickHouse/ClickHouse/issues/11595) を解決。 [#12089](https://github.com/ClickHouse/ClickHouse/pull/12089)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `VIEW` からの select に対してスレッド数を不必要に制限していた問題を修正しました。 [#11937](https://github.com/ClickHouse/ClickHouse/issues/11937) を修正。 [#12085](https://github.com/ClickHouse/ClickHouse/pull/12085) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `PREWHERE` に誤った型を使用した場合にクラッシュする可能性があった問題を修正しました。[#12053](https://github.com/ClickHouse/ClickHouse/issues/12053)、[#12060](https://github.com/ClickHouse/ClickHouse/issues/12060) を修正。[#12060](https://github.com/ClickHouse/ClickHouse/pull/12060)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `LowCardinality` 型を使用した関数 `defaultValueOfArgumentType` で発生していたエラー `Expected single dictionary argument for function` を修正しました。[#11808](https://github.com/ClickHouse/ClickHouse/issues/11808) を解決。[#12056](https://github.com/ClickHouse/ClickHouse/pull/12056)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `Tuple(LowCardinality)` 引数を持つ高階関数で発生していた `Cannot capture column` エラーを修正しました。これは [#9766](https://github.com/ClickHouse/ClickHouse/issues/9766) を解決するものです。 [#12055](https://github.com/ClickHouse/ClickHouse/pull/12055)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* データベースの読み込み時にテーブルのメタデータを並列で解析するようにしました。これにより、多数のテーブルが存在する場合のサーバーの起動が遅くなる問題を解消します。 [#12045](https://github.com/ClickHouse/ClickHouse/pull/12045) ([tavplubix](https://github.com/tavplubix)).
* Enum 型に対して `topK` 集約関数が Enum 型を返すようにしました。これにより [#3740](https://github.com/ClickHouse/ClickHouse/issues/3740) を修正しました。[#12043](https://github.com/ClickHouse/ClickHouse/pull/12043)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 制約チェックが、制約が定数式であるかどうかを確認するように修正されました。これにより [#11360](https://github.com/ClickHouse/ClickHouse/issues/11360) が解決されています。[#12042](https://github.com/ClickHouse/ClickHouse/pull/12042)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `Nullable` カラムを含むタプルの誤った比較処理を修正しました。 [#11985](https://github.com/ClickHouse/ClickHouse/issues/11985) を解決。 [#12039](https://github.com/ClickHouse/ClickHouse/pull/12039)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* allow&#95;introspection&#95;functions=0 の場合のアクセス権限の計算方法を修正しました。 [#12031](https://github.com/ClickHouse/ClickHouse/pull/12031) ([Vitaly Baranov](https://github.com/vitlibar))
* サイズが異なる `FixedString` 型の引数で関数 `if` を呼び出した際に、誤った結果が返されたりクラッシュする可能性があった不具合を修正しました。これにより [#11362](https://github.com/ClickHouse/ClickHouse/issues/11362) が修正されました。 [#12021](https://github.com/ClickHouse/ClickHouse/pull/12021)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 返される式が `neighbor` 関数だけであるクエリは、オフセット `-9223372036854775808` で関数が呼び出された場合、空の結果を返すことがありました。これは [#11367](https://github.com/ClickHouse/ClickHouse/issues/11367) を修正します。[#12019](https://github.com/ClickHouse/ClickHouse/pull/12019)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* allow&#95;ddl=0 の場合のアクセス権限の計算を修正。 [#12015](https://github.com/ClickHouse/ClickHouse/pull/12015) ([Vitaly Baranov](https://github.com/vitlibar))。
* `generateRandom` において配列サイズがオーバーフローし、クラッシュにつながる可能性のあった問題を修正しました。これにより [#11371](https://github.com/ClickHouse/ClickHouse/issues/11371) が解決されます。[#12013](https://github.com/ClickHouse/ClickHouse/pull/12013)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 浮動小数点例外が発生しうる不具合を修正しました。これにより [#11378](https://github.com/ClickHouse/ClickHouse/issues/11378) が解決されます。[#12005](https://github.com/ClickHouse/ClickHouse/pull/12005)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* サーバー起動時のログメッセージ中の誤った設定名を修正しました。 [#11997](https://github.com/ClickHouse/ClickHouse/pull/11997) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `Values` フォーマットにおける `Query parameter was not set` の問題を修正。 [#11918](https://github.com/ClickHouse/ClickHouse/issues/11918) を解決。 [#11936](https://github.com/ClickHouse/ClickHouse/pull/11936)（[tavplubix](https://github.com/tavplubix)）。
* クエリ内の置換（パラメータ化クエリ）に対するエイリアスを保持するようにしました。これにより [#11914](https://github.com/ClickHouse/ClickHouse/issues/11914) が修正されました。 [#11916](https://github.com/ClickHouse/ClickHouse/pull/11916) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* デフォルトのストレージポリシーから別のポリシーへ変更する際に移動が行われないバグを修正しました。 [#11893](https://github.com/ClickHouse/ClickHouse/pull/11893) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `DateTime64` のパース時に発生する可能性があった浮動小数点例外を修正しました。これにより [#11374](https://github.com/ClickHouse/ClickHouse/issues/11374) が解決しました。[#11875](https://github.com/ClickHouse/ClickHouse/pull/11875)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* HTTP インターフェイス経由のメモリ使用量の計測を修正しました（`wait_end_of_query=1` の場合に顕著になる可能性があります）。[#11840](https://github.com/ClickHouse/ClickHouse/pull/11840)（[Azat Khuzhin](https://github.com/azat)）。
* 等価性を確認する前に、ZooKeeper に保存されているメタデータをパースする。 [#11739](https://github.com/ClickHouse/ClickHouse/pull/11739) ([Azat Khuzhin](https://github.com/azat)).

#### パフォーマンス改善 {#performance-improvement-10}

- リテラルを含むIN演算子でインデックスが使用されず、v19.3頃に導入されたパフォーマンス低下を修正。[#10574](https://github.com/ClickHouse/ClickHouse/issues/10574) を修正。[#12062](https://github.com/ClickHouse/ClickHouse/pull/12062) ([nvartolomei](https://github.com/nvartolomei))。

#### ビルド/テスト/パッケージング改善 {#buildtestingpackaging-improvement-12}

- Dockerfileで最初の`apt-get update`の前に`ca-certificates`をインストール。[#12095](https://github.com/ClickHouse/ClickHouse/pull/12095) ([Ivan Blinkov](https://github.com/blinkov))。

### ClickHouse リリース v20.4.6.53-stable 2020-06-25 {#clickhouse-release-v204653-stable-2020-06-25}

#### バグ修正 {#bug-fix-29}


* `prewhere` 条件で `Nullable` 列を使用した際にまれに発生するクラッシュを修正。[#11608](https://github.com/ClickHouse/ClickHouse/issues/11608) の継続対応。[#11869](https://github.com/ClickHouse/ClickHouse/pull/11869)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 高階関数内で arrayJoin を許可しないようにしました。これはプロトコル同期の破綻を引き起こしていたためです。この変更により [#3933](https://github.com/ClickHouse/ClickHouse/issues/3933) がクローズされました。[#11846](https://github.com/ClickHouse/ClickHouse/pull/11846)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* FixedString と定数 String の比較で誤った結果が返される不具合を修正しました。これにより [#11393](https://github.com/ClickHouse/ClickHouse/issues/11393) が解消されます。この不具合はバージョン 20.4 で導入されました。[#11828](https://github.com/ClickHouse/ClickHouse/pull/11828)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 条件に NULL が含まれる場合の `if()` の誤った結果を修正。 [#11807](https://github.com/ClickHouse/ClickHouse/pull/11807) ([Artem Zuikov](https://github.com/4ertus2))。
* クエリで過剰な数のスレッドを使用していた問題を修正しました。 [#11788](https://github.com/ClickHouse/ClickHouse/pull/11788) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `SELECT *, xyz.*` のようなクエリで、本来はエラーとなるべきところが成功してしまう予期しない動作を修正しました。 [#11753](https://github.com/ClickHouse/ClickHouse/pull/11753) ([hexiaoting](https://github.com/hexiaoting)).
* メタデータの ALTER 実行中は、レプリケートフェッチがキャンセルされるようになりました。 [#11744](https://github.com/ClickHouse/ClickHouse/pull/11744) ([alesapin](https://github.com/alesapin)).
* Values 入力形式で複合リテラルの型推論が誤っていたことに起因する LOGICAL&#95;ERROR を修正しました。 [#11732](https://github.com/ClickHouse/ClickHouse/pull/11732) ([tavplubix](https://github.com/tavplubix)).
* 定数列に対する `ORDER BY ... WITH FILL` を修正。 [#11697](https://github.com/ClickHouse/ClickHouse/pull/11697) ([Anton Popov](https://github.com/CurtizJ)).
* XDBC ブリッジと通信する際に適切なタイムアウトを渡すように修正しました。最近まで、ブリッジの稼働状態の確認およびメタ情報の受信時にタイムアウトが正しく適用されていませんでした。 [#11690](https://github.com/ClickHouse/ClickHouse/pull/11690) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* エイリアスを使用した `ORDER BY` 句と併用した場合の `LIMIT n WITH TIES` の挙動を修正しました。 [#11689](https://github.com/ClickHouse/ClickHouse/pull/11689) ([Anton Popov](https://github.com/CurtizJ)).
* `system.mutations` の状態が不正になる不具合を修正しました。この不具合により、サーバーのレプリケーションキューには依然として `MUTATE_PART` タスクが残っていて実行を試みているにもかかわらず、ミューテーション全体がすでに完了しているように表示されることがありました。この修正は [#11611](https://github.com/ClickHouse/ClickHouse/issues/11611) を解消します。 [#11681](https://github.com/ClickHouse/ClickHouse/pull/11681) ([alesapin](https://github.com/alesapin))。
* 大文字・小文字を区別しないフラグ付き正規表現のサポートを追加しました。これにより [#11101](https://github.com/ClickHouse/ClickHouse/issues/11101) と [#11506](https://github.com/ClickHouse/ClickHouse/issues/11506) が修正されました。[#11649](https://github.com/ClickHouse/ClickHouse/pull/11649)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 行レベルセキュリティが設定されている場合には、単純な COUNT クエリに対する最適化を削除しました。以前のバージョンでは、フィルタされた結果ではなく、テーブル内のレコードの総数をユーザーが取得できてしまっていました。これにより [#11352](https://github.com/ClickHouse/ClickHouse/issues/11352) が修正されます。 [#11644](https://github.com/ClickHouse/ClickHouse/pull/11644) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* String 型用ブルームフィルタ（データスキップインデックス）を修正。 [#11638](https://github.com/ClickHouse/ClickHouse/pull/11638) ([Azat Khuzhin](https://github.com/azat)).
* `prewhere` 条件で `Nullable` カラムを使用した場合にまれに発生するクラッシュを修正（おそらく [#11572](https://github.com/ClickHouse/ClickHouse/issues/11572) と何らかの関連があります）。[#11608](https://github.com/ClickHouse/ClickHouse/pull/11608)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `Buffer` テーブルからのサンプリング読み出しを行うクエリで発生していた `Block structure mismatch` エラーを修正。[#11602](https://github.com/ClickHouse/ClickHouse/pull/11602)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* exception.code() % 256 = 0 の場合に clickhouse-client が不正な終了コードを返す問題を修正しました。 [#11601](https://github.com/ClickHouse/ClickHouse/pull/11601) ([filimonov](https://github.com/filimonov))。
* サーバー起動時の「Mark cache size was lowered」というログメッセージ内の些細な誤りを修正しました。これにより [#11399](https://github.com/ClickHouse/ClickHouse/issues/11399) がクローズされました。 [#11589](https://github.com/ClickHouse/ClickHouse/pull/11589) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `PREWHERE column in (subquery)` および `ARRAY JOIN` を含むクエリで発生していたエラー `Size of offsets does not match size of column` を修正。 [#11580](https://github.com/ClickHouse/ClickHouse/pull/11580) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `SHOW CREATE TABLE` でまれに発生していたセグメンテーションフォルトを修正。 [#11490](https://github.com/ClickHouse/ClickHouse/issues/11490) を解決。 [#11579](https://github.com/ClickHouse/ClickHouse/pull/11579) ([tavplubix](https://github.com/tavplubix))。
* HTTP セッション内のすべてのクエリで同じ query&#95;id が使用されていました。これを修正しました。 [#11578](https://github.com/ClickHouse/ClickHouse/pull/11578) ([tavplubix](https://github.com/tavplubix)).
* これにより、clickhouse-server の Docker コンテナはサーバーの生存確認時に IPv6 を優先的に使用するようになります。[#11550](https://github.com/ClickHouse/ClickHouse/pull/11550) ([Ivan Starkov](https://github.com/istarkov)).
* `<node>` 向けの shard&#95;num/replica&#95;num を修正（use&#95;compact&#95;format&#95;in&#95;distributed&#95;parts&#95;names が機能しない問題）。 [#11528](https://github.com/ClickHouse/ClickHouse/pull/11528) ([Azat Khuzhin](https://github.com/azat)).
* テーブルの削除中に例外が発生するおそれのあるレースコンディションを修正しました。少々トリッキーですが、まったく危険ではありません。説明が必要であれば、Telegram で声をかけてください。 [#11523](https://github.com/ClickHouse/ClickHouse/pull/11523) ([alesapin](https://github.com/alesapin)).
* -State 関数を使った集約処理の途中で例外がスローされた場合に発生していたメモリリークを修正しました。これにより [#8995](https://github.com/ClickHouse/ClickHouse/issues/8995) が解決されました。[#11496](https://github.com/ClickHouse/ClickHouse/pull/11496)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* データスキップインデックスが、バックグラウンドマージ中に変更される列（SummingMergeTree、AggregatingMergeTree、および TTL GROUP BY の場合）に依存している場合、インデックスが正しく計算されていませんでした。この問題は、マージ後にインデックスを計算するよう処理の順序を変更し、マージ後のデータに対してインデックスが計算されるようにすることで修正されました。 [#11162](https://github.com/ClickHouse/ClickHouse/pull/11162) ([Azat Khuzhin](https://github.com/azat))。
* 古い libunwind パッチを削除しました。 [https://github.com/ClickHouse-Extras/libunwind/commit/500aa227911bd185a94bfc071d68f4d3b03cb3b1#r39048012](https://github.com/ClickHouse-Extras/libunwind/commit/500aa227911bd185a94bfc071d68f4d3b03cb3b1#r39048012) これにより、`clang` ビルドで `-fno-omit-frame-pointer` を無効にできるようになり、平均して少なくとも 1% のパフォーマンス向上が得られます。 [#10761](https://github.com/ClickHouse/ClickHouse/pull/10761) ([Amos Bird](https://github.com/amosbird))。
* 関数でラップされた主キーを使用した場合の &#39;FINAL&#39; 修飾子および &#39;ORDER BY&#39; 最適化の動作を修正しました。 [#10715](https://github.com/ClickHouse/ClickHouse/pull/10715) ([Anton Popov](https://github.com/CurtizJ)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-13}

- ユニットテストにおける重要度の低いエラーを複数修正しました。[#11262](https://github.com/ClickHouse/ClickHouse/pull/11262) ([alesapin](https://github.com/alesapin))。
- MergeTreeIndexFullTextにおける誤検知のMSanレポートを修正しました。この問題は[#9968](https://github.com/ClickHouse/ClickHouse/issues/9968)で最初に発生しました。[#10801](https://github.com/ClickHouse/ClickHouse/pull/10801) ([alexey-milovidov](https://github.com/alexey-milovidov))。

### ClickHouseリリース v20.4.5.36-stable 2020-06-10 {#clickhouse-release-v204536-stable-2020-06-10}

#### バグ修正 {#bug-fix-30}


* `min_bytes_to_use_direct_io` が有効で、PREWHERE が有効かつ SAMPLE を使用している場合、またはスレッド数が多い場合に発生する可能性のあるエラー `Data compressed with different methods` を修正しました。これにより [#11539](https://github.com/ClickHouse/ClickHouse/issues/11539) が解決されます。[#11540](https://github.com/ClickHouse/ClickHouse/pull/11540)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* コーデックの返す圧縮サイズを修正。 [#11448](https://github.com/ClickHouse/ClickHouse/pull/11448) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* リテラルではない引数を持つ圧縮コーデックを列が使用している場合に発生するサーバークラッシュを修正しました。[#11365](https://github.com/ClickHouse/ClickHouse/issues/11365) を修正します。[#11431](https://github.com/ClickHouse/ClickHouse/pull/11431)（[alesapin](https://github.com/alesapin)）。
* `nan` を点として扱う場合の `pointInPolygon` の不具合を修正。[#11375](https://github.com/ClickHouse/ClickHouse/issues/11375) に対応。[#11421](https://github.com/ClickHouse/ClickHouse/pull/11421)（[Alexey Ilyukhov](https://github.com/livace)）。
* テーブルが正常に作成されなかった場合の、MergeTree のシャットダウン時に発生し得る未初期化メモリの読み取りを修正。 [#11420](https://github.com/ClickHouse/ClickHouse/pull/11420) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 緯度・経度の範囲外の引数が指定された場合の geohashesInBox の動作を修正しました。 [#11403](https://github.com/ClickHouse/ClickHouse/pull/11403) ([Vasily Nemkov](https://github.com/Enmk)).
* 外部ソートと `LIMIT` を使用するクエリで発生する可能性のある `Pipeline stuck` エラーを修正しました。 [#11359](https://github.com/ClickHouse/ClickHouse/issues/11359) を解決。 [#11366](https://github.com/ClickHouse/ClickHouse/pull/11366)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* ReplicatedMergeTree におけるパーツ送信時の冗長なロックを削除しました。 [#11354](https://github.com/ClickHouse/ClickHouse/pull/11354) ([alesapin](https://github.com/alesapin)).
* 複数行モードでの clickhouse-client における `\G`（縦方向出力）のサポートを修正しました。この修正により [#9933](https://github.com/ClickHouse/ClickHouse/issues/9933) がクローズされます。 [#11350](https://github.com/ClickHouse/ClickHouse/pull/11350) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `Lazy` データベース使用時に発生する可能性のあったセグメンテーションフォルトを修正。 [#11348](https://github.com/ClickHouse/ClickHouse/pull/11348) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `quantilesExactWeightedArray` で発生していたクラッシュを修正。[#11337](https://github.com/ClickHouse/ClickHouse/pull/11337)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `ALTER` クエリでメタデータを変更する前に、マージ処理が停止するようになりました。 [#11335](https://github.com/ClickHouse/ClickHouse/pull/11335) ([alesapin](https://github.com/alesapin)).
* `parallel_view_processing = 1` が設定されている場合の `MATERIALIZED VIEW` への書き込みを再び並列実行できるようにしました。 [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241) を修正。 [#11330](https://github.com/ClickHouse/ClickHouse/pull/11330)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 抽出された JSON 内の文字列に対応の取れていない &#123; または [ が含まれている場合の `visitParamExtractRaw` の動作を修正しました。 [#11318](https://github.com/ClickHouse/ClickHouse/pull/11318) ([Ewout](https://github.com/devwout)).
* ThreadPool における極めてまれなレースコンディションを修正。 [#11314](https://github.com/ClickHouse/ClickHouse/pull/11314) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* clickhouse-copier における軽微なデータ競合を修正しました。統合テストで発見されました。[#11313](https://github.com/ClickHouse/ClickHouse/pull/11313) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 変換処理時の未初期化メモリ使用の可能性を修正しました。例: `SELECT toIntervalSecond(now64())`。 [#11311](https://github.com/ClickHouse/ClickHouse/pull/11311) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* テーブルのプライマリキーに Array 型カラムが含まれており、クエリがこのカラムを `empty` または `notEmpty` 関数でフィルタリングしている場合に、インデックス解析が機能しない問題を修正しました。これにより [#11286](https://github.com/ClickHouse/ClickHouse/issues/11286) が修正されました。[#11303](https://github.com/ClickHouse/ClickHouse/pull/11303)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* クエリが `max_network_bandwidth`、`max_execution_speed`、または `priority` 設定によってスロットルされている場合に、クエリ速度の推定が正しく行われず、その結果 `min_execution_speed` の制限が動作しない、もしくは誤って動作する不具合を修正しました。`timeout_before_checking_execution_speed` のデフォルト値を非ゼロに変更しました。そうしないと、`min_execution_speed` および `max_execution_speed` 設定が効果を持たないためです。これにより [#11297](https://github.com/ClickHouse/ClickHouse/issues/11297) が修正されます。これにより [#5732](https://github.com/ClickHouse/ClickHouse/issues/5732) が修正されます。これにより [#6228](https://github.com/ClickHouse/ClickHouse/issues/6228) が修正されます。ユーザビリティの改善: `clickhouse-client` において、例外メッセージとプログレスバーが連結されてしまうことを回避しました。 [#11296](https://github.com/ClickHouse/ClickHouse/pull/11296) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `SET DEFAULT ROLE` が誤った引数で呼び出された場合にクラッシュする問題を修正しました。これにより [#10586](https://github.com/ClickHouse/ClickHouse/issues/10586) が解決しました。 [#11278](https://github.com/ClickHouse/ClickHouse/pull/11278) ([Vitaly Baranov](https://github.com/vitlibar))。
* Protobuf 形式の不正なデータを読み込む際に発生するクラッシュを修正しました。これにより [#5957](https://github.com/ClickHouse/ClickHouse/issues/5957) および [#11203](https://github.com/ClickHouse/ClickHouse/issues/11203) が修正されました。[#11258](https://github.com/ClickHouse/ClickHouse/pull/11258)（[Vitaly Baranov](https://github.com/vitlibar)）。
* cache-dictionary が本来の値ではなくデフォルト値を返してしまうバグ（有効期限切れのキーのみが存在する場合）が修正されました。これは文字列型のフィールドのみに影響します。 [#11233](https://github.com/ClickHouse/ClickHouse/pull/11233) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 内部クエリに定数を含む `VIEW` から読み取る際に発生する `Block structure mismatch in QueryPipeline` エラーを修正しました。 [#11181](https://github.com/ClickHouse/ClickHouse/issues/11181) の修正。 [#11205](https://github.com/ClickHouse/ClickHouse/pull/11205)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `Invalid status for associated output` という例外が発生する可能性がある問題を修正。 [#11200](https://github.com/ClickHouse/ClickHouse/pull/11200) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `Array(Array(LowCardinality))` 型の引数をキャプチャする高階関数で発生する可能性のある `Cannot capture column` エラーを修正。 [#11185](https://github.com/ClickHouse/ClickHouse/pull/11185) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 一部のバックエンドにおいて、キー数が 1000 を超える場合に失敗する可能性があった S3 のグロブ処理を修正しました。 [#11179](https://github.com/ClickHouse/ClickHouse/pull/11179) ([Vladimir Chebotarev](https://github.com/excitoon)).
* データスキッピングインデックスが、バックグラウンドマージ中に変更される列（`SummingMergeTree` や `AggregatingMergeTree`、および `TTL GROUP BY` の場合）に依存している場合、インデックスが正しく計算されていませんでした。この問題は、インデックスの計算をマージ後に行い、マージ済みデータに対してインデックスを計算するように変更することで修正されました。[#11162](https://github.com/ClickHouse/ClickHouse/pull/11162)（[Azat Khuzhin](https://github.com/azat)）。
* 制限値に基づく再スケジュールが常に適用されていたことに起因する Kafka のパフォーマンス問題を修正しました。 [#11149](https://github.com/ClickHouse/ClickHouse/pull/11149) ([filimonov](https://github.com/filimonov))。
* `engine=Kafka` のテーブルに対する `DROP` 文の実行中（またはサーバー再起動時）に時々発生していたハングを修正しました。 [#11145](https://github.com/ClickHouse/ClickHouse/pull/11145) ([filimonov](https://github.com/filimonov)).
* 単純なクエリに対してスレッドを過剰に予約してしまう問題を修正しました（パイプラインの変更後に一部壊れていた、スレッド数削減のための最適化）。 [#11114](https://github.com/ClickHouse/ClickHouse/pull/11114) ([Azat Khuzhin](https://github.com/azat))。
* `HAVING` 句を含むクエリ（つまりイニシエータサーバー側でのフィルタリングが必要なクエリ）に対する分散クエリの述語最適化（`enable_optimize_predicate_expression=1`）の不具合を、式の順序を保持するようにし（これだけで問題は解消されます）、さらにアグリゲータがインデックスではなくカラム名を使用するように強制することで修正。修正対象: [#10613](https://github.com/ClickHouse/ClickHouse/issues/10613), [#11413](https://github.com/ClickHouse/ClickHouse/issues/11413)。[#10621](https://github.com/ClickHouse/ClickHouse/pull/10621)（[Azat Khuzhin](https://github.com/azat)）。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-14}

- 複数の不安定な統合テストを修正。[#11355](https://github.com/ClickHouse/ClickHouse/pull/11355) ([alesapin](https://github.com/alesapin))。

### ClickHouse リリース v20.4.4.18-stable 2020-05-26 {#clickhouse-release-v204418-stable-2020-05-26}

v20.4.3.16-stable と比較して変更なし。

### ClickHouse リリース v20.4.3.16-stable 2020-05-23 {#clickhouse-release-v204316-stable-2020-05-23}

#### バグ修正 {#bug-fix-31}


* 何もファイナライズされなかった場合には、ミューテーションのファイナライズタスクからのログ出力を削除しました。 [#11109](https://github.com/ClickHouse/ClickHouse/pull/11109) ([alesapin](https://github.com/alesapin)).
* registerDiskS3 のメモリリークを修正しました。 [#11074](https://github.com/ClickHouse/ClickHouse/pull/11074) ([Pavel Kovalenko](https://github.com/Jokser)).
* Kafka エンジンテーブルの終了時に発生する可能性のあったデータ取りこぼしの問題を修正しました。 [#11048](https://github.com/ClickHouse/ClickHouse/pull/11048) ([filimonov](https://github.com/filimonov)).
* `parseDateTime64BestEffort` の引数解決に関するバグを修正。[#11038](https://github.com/ClickHouse/ClickHouse/pull/11038) ([Vasily Nemkov](https://github.com/Enmk))。
* テーブルの作成に失敗した場合に `MergeTree` で発生し得る、極めてまれな use-after-free の潜在的エラーを修正しました。 [#10986](https://github.com/ClickHouse/ClickHouse/pull/10986), [#10970](https://github.com/ClickHouse/ClickHouse/pull/10970) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Atomic データベースにおけるメタデータ（rename 用の相対パス）およびデータ（symlink 用の相対パス）の扱いを修正しました。 [#10980](https://github.com/ClickHouse/ClickHouse/pull/10980) ([Azat Khuzhin](https://github.com/azat)).
* `Atomic` データベースエンジンで、`ALTER` クエリと `DROP DATABASE` クエリを同時に実行した場合にサーバーがクラッシュする問題を修正しました。 [#10968](https://github.com/ClickHouse/ClickHouse/pull/10968) ([tavplubix](https://github.com/tavplubix)).
* `getRawData()` メソッドで誤っていた生データのサイズを修正しました。 [#10964](https://github.com/ClickHouse/ClickHouse/pull/10964) ([Igr](https://github.com/ObjatieGroba))。
* バージョン 20.1 以前との間に存在した二段階集約の非互換性を修正しました。この非互換性は、イニシエーターノードとリモートノードで異なるバージョンの ClickHouse を使用しており、`GROUP BY` の結果セットが大きく、かつ単一の `String` フィールドで集約が行われる場合に発生します。その結果、1つのキーに対してマージされていない複数の行が結果として返されることがありました。 [#10952](https://github.com/ClickHouse/ClickHouse/pull/10952) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `DistributedBlockOutputStream` によって部分的にしか書き込まれていないファイルが送信されてしまう問題を修正しました。 [#10940](https://github.com/ClickHouse/ClickHouse/pull/10940) ([Azat Khuzhin](https://github.com/azat)).
* `SELECT count(notNullIn(NULL, []))` がクラッシュする問題を修正しました。 [#10920](https://github.com/ClickHouse/ClickHouse/pull/10920) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `Kafka` テーブルエンジンの `DROP` 実行中（またはサーバー再起動中）に時折発生していたハングアップを修正しました。[#10910](https://github.com/ClickHouse/ClickHouse/pull/10910) ([filimonov](https://github.com/filimonov))
* `a TO b, c TO a` のような複数の `ALTER RENAME` 文を実行できなかった問題を修正しました。 [#10895](https://github.com/ClickHouse/ClickHouse/pull/10895) ([alesapin](https://github.com/alesapin)).
* 同一カラムに対して複数スレッドから集約関数の状態の結果を取得する際に発生する可能性があったレースコンディションを修正しました。これは、`quantile*` 関数用の `AggregateFunction` の状態を保持する `Memory` エンジンのテーブルを読み出す際に `finalizeAggregation` 関数を使用した場合にのみ発生し得ます。 [#10890](https://github.com/ClickHouse/ClickHouse/pull/10890) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* Distributed テーブルでのタプル使用時の後方互換性を修正しました。 [#10889](https://github.com/ClickHouse/ClickHouse/pull/10889) ([Anton Popov](https://github.com/CurtizJ)).
* 存在しないキーに対して `StringHashTable` で発生していた `SIGSEGV` を修正しました。 [#10870](https://github.com/ClickHouse/ClickHouse/pull/10870) ([Azat Khuzhin](https://github.com/azat)).
* `Atomic` エンジンを使用するデータベースから `LiveView` テーブルが削除された後に発生していた `WATCH` がハングする問題を修正しました。 [#10859](https://github.com/ClickHouse/ClickHouse/pull/10859) ([tavplubix](https://github.com/tavplubix)).
* `ReplicatedMergeTree` におけるバグを修正しました。このバグにより、あるレプリカが非アクティブになった後もそのレプリカを待ち続けることで、`OPTIMIZE` クエリ内の一部の `ALTER` がハングする可能性がありました。 [#10849](https://github.com/ClickHouse/ClickHouse/pull/10849) ([tavplubix](https://github.com/tavplubix)).
* `CONSTRAINT` 式に含まれるカラムの名前を変更した場合に、その制約も更新されるようになりました。 [#10844](https://github.com/ClickHouse/ClickHouse/issues/10844) を修正しました。 [#10847](https://github.com/ClickHouse/ClickHouse/pull/10847)（[alesapin](https://github.com/alesapin)）。
* cache-dictionary において未初期化メモリの読み取りが発生する可能性のあった問題を修正しました。 [#10834](https://github.com/ClickHouse/ClickHouse/pull/10834) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `Block::sortColumns()` 呼び出し後の列順を修正しました。 [#10826](https://github.com/ClickHouse/ClickHouse/pull/10826) ([Azat Khuzhin](https://github.com/azat)).
* 識別子の引用符付けが不要と指定されている場合の `ODBC` ブリッジの不具合を修正しました。 [#7984](https://github.com/ClickHouse/ClickHouse/issues/7984) を修正。 [#10821](https://github.com/ClickHouse/ClickHouse/pull/10821)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `DateLUT` での `UBSan` および `MSan` のレポートを修正しました。 [#10798](https://github.com/ClickHouse/ClickHouse/pull/10798) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* キー条件における誤った型変換を修正しました。 [#6287](https://github.com/ClickHouse/ClickHouse/issues/6287) を解決。 [#10791](https://github.com/ClickHouse/ClickHouse/pull/10791)（[Andrew Onyshchuk](https://github.com/oandrew)）。
* `parallel_view_processing` の動作を修正しました。これにより、例外が発生した場合でも、`MATERIALIZED VIEW` へのすべての挿入が完了するようになりました。[#10241](https://github.com/ClickHouse/ClickHouse/issues/10241) を修正しました。[#10757](https://github.com/ClickHouse/ClickHouse/pull/10757)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `-State` と組み合わせた場合の `-OrNull` および `-OrDefault` コンビネータの不具合を修正しました。 [#10741](https://github.com/ClickHouse/ClickHouse/pull/10741) ([hcz](https://github.com/hczhcz)).
* 関数 `h3EdgeAngle` で発生する可能性のあったバッファオーバーフローを修正しました。 [#10711](https://github.com/ClickHouse/ClickHouse/pull/10711) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* テーブルに多数のパーツがある場合に、同時に実行される `ALTER` がロックされてしまう不具合を修正しました。 [#10659](https://github.com/ClickHouse/ClickHouse/pull/10659) ([alesapin](https://github.com/alesapin)).
* テーブルが起動する前にサーバーがシャットダウンされた場合に `StorageBuffer` で発生する `nullptr` のデリファレンスを修正しました。 [#10641](https://github.com/ClickHouse/ClickHouse/pull/10641) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `LowCardinality` 使用時の `optimize_skip_unused_shards` を修正しました。 [#10611](https://github.com/ClickHouse/ClickHouse/pull/10611) ([Azat Khuzhin](https://github.com/azat)).
* 同期ミューテーションのための条件変数の扱いを修正しました。状況によっては、その条件変数へのシグナルが失われてしまうことがありました。 [#10588](https://github.com/ClickHouse/ClickHouse/pull/10588) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `loadStoredObject()` が完了する前に `createDictionary()` が呼び出された場合に発生し得るクラッシュを修正しました。 [#10587](https://github.com/ClickHouse/ClickHouse/pull/10587) ([Vitaly Baranov](https://github.com/vitlibar))。
* デフォルト式の型が列の型と異なっていた列 `ALIAS` に対する `SELECT` を修正しました。 [#10563](https://github.com/ClickHouse/ClickHouse/pull/10563) ([Azat Khuzhin](https://github.com/azat))。
* DateTime64 と String の値同士の比較を実装しました。 [#10560](https://github.com/ClickHouse/ClickHouse/pull/10560) ([Vasily Nemkov](https://github.com/Enmk)).
* デフォルトで `GROUP BY` sharding&#95;key の最適化を無効化し（`optimize_distributed_group_by_sharding_key` は導入されたものの、sharding&#95;key の解析がトリッキーであるため（単純な例としては sharding key 内の `if` など）、デフォルトではオフになっています）、さらに `WITH ROLLUP/CUBE/TOTALS` に対する動作を修正しました。 [#10516](https://github.com/ClickHouse/ClickHouse/pull/10516) ([Azat Khuzhin](https://github.com/azat)).
* [#10263](https://github.com/ClickHouse/ClickHouse/issues/10263) を修正。[#10486](https://github.com/ClickHouse/ClickHouse/pull/10486)（[Azat Khuzhin](https://github.com/azat)）。
* `max_rows_to_sort` 設定に関するテストを追加しました。 [#10268](https://github.com/ClickHouse/ClickHouse/pull/10268) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Bloom フィルターインデックス作成に関する後方互換性を追加しました。 [#10551](https://github.com/ClickHouse/ClickHouse/issues/10551). [#10569](https://github.com/ClickHouse/ClickHouse/pull/10569) ([Winter Zhang](https://github.com/zhang2014)).

### ClickHouseリリース v20.4.2.9, 2020-05-12 {#clickhouse-release-v20429-2020-05-12}

#### 後方互換性のない変更 {#backward-incompatible-change-8}

- システムテーブル(例: system.query_log、system.trace_log、system.metric_log)は、10 MiB未満のパートに対してコンパクトデータパート形式を使用します。コンパクトデータパート形式はバージョン20.3以降でサポートされています。バージョン20.3未満にダウングレードする場合は、`/var/lib/clickhouse/data/system/`内のシステムログのテーブルデータを手動で削除する必要があります。
- 文字列比較でFixedStringが使用され、比較される引数のサイズが異なる場合、小さい文字列が大きい文字列の長さまでパディングされているものとして比較を行います。これは、FixedStringデータ型がSQL CHARに対応すると想定した場合のSQL互換性を目的としています。これにより[#9272](https://github.com/ClickHouse/ClickHouse/issues/9272)が解決されます。[#10363](https://github.com/ClickHouse/ClickHouse/pull/10363) ([alexey-milovidov](https://github.com/alexey-milovidov))
- SHOW CREATE TABLEを複数行形式にしました。これにより可読性が向上し、MySQLに近い形式になりました。[#10049](https://github.com/ClickHouse/ClickHouse/pull/10049) ([Azat Khuzhin](https://github.com/azat))
- `pointInPolygon`関数で使用される設定`validate_polygons`を追加し、デフォルトで有効にしました。[#9857](https://github.com/ClickHouse/ClickHouse/pull/9857) ([alexey-milovidov](https://github.com/alexey-milovidov))


#### 新機能 {#new-feature-8}

- ClickHouseからZookeeperへのセキュア接続のサポートを追加 [#10184](https://github.com/ClickHouse/ClickHouse/pull/10184) ([Konstantin Lebedev](https://github.com/xzkostyan))
- カスタムHTTPハンドラーをサポート。詳細は[#5436](https://github.com/ClickHouse/ClickHouse/issues/5436)を参照してください。[#7572](https://github.com/ClickHouse/ClickHouse/pull/7572) ([Winter Zhang](https://github.com/zhang2014))
- MessagePack入出力フォーマットを追加。[#9889](https://github.com/ClickHouse/ClickHouse/pull/9889) ([Kruglov Pavel](https://github.com/Avogar))
- Regexp入力フォーマットを追加。[#9196](https://github.com/ClickHouse/ClickHouse/pull/9196) ([Kruglov Pavel](https://github.com/Avogar))
- Markdownドキュメントにテーブルを埋め込むための出力フォーマット`Markdown`を追加。[#10317](https://github.com/ClickHouse/ClickHouse/pull/10317) ([Kruglov Pavel](https://github.com/Avogar))
- ディクショナリにカスタム設定セクションのサポートを追加。また、issue [#2829](https://github.com/ClickHouse/ClickHouse/issues/2829)を修正。[#10137](https://github.com/ClickHouse/ClickHouse/pull/10137) ([Artem Streltsov](https://github.com/kekekekule))
- `CREATE DICTIONARY`のDDLクエリにカスタム設定のサポートを追加 [#10465](https://github.com/ClickHouse/ClickHouse/pull/10465) ([Artem Streltsov](https://github.com/kekekekule))
- サーバーのメモリ使用量が次の割り当てしきい値を超えた際に割り当てコンテキストを収集する、シンプルなサーバー全体のメモリプロファイラーを追加。[#10444](https://github.com/ClickHouse/ClickHouse/pull/10444) ([alexey-milovidov](https://github.com/alexey-milovidov))
- レプリカが自身でパートをマージすることを制限し、常に他のレプリカからのダウンロードを優先する設定`always_fetch_merged_part`を追加。[#10379](https://github.com/ClickHouse/ClickHouse/pull/10379) ([alesapin](https://github.com/alesapin))
- JSONオブジェクトから生データを抽出する関数`JSONExtractKeysAndValuesRaw`を追加 [#10378](https://github.com/ClickHouse/ClickHouse/pull/10378) ([hcz](https://github.com/hczhcz))
- OSからのメモリ使用量を`system.asynchronous_metrics`に追加。[#10361](https://github.com/ClickHouse/ClickHouse/pull/10361) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 関数`least`と`greatest`の汎用バリアントを追加。任意の型の任意の数の引数で動作するようになりました。これにより[#4767](https://github.com/ClickHouse/ClickHouse/issues/4767)が修正されます [#10318](https://github.com/ClickHouse/ClickHouse/pull/10318) ([alexey-milovidov](https://github.com/alexey-milovidov))
- ClickHouseはディクショナリソースのタイムアウトを自身で制御するようになりました。キャッシュディクショナリ設定に2つの新しい設定が追加されました：デフォルトで`max_lifetime`である`strict_max_lifetime_seconds`と、デフォルトで1分である`query_wait_timeout_milliseconds`です。最初の設定は`allow_read_expired_keys`設定と併用すると便利です(非常に期限切れのキーの読み取りを禁止するため)。[#10337](https://github.com/ClickHouse/ClickHouse/pull/10337) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- query_logに書き込まれるエントリをフィルタリングするためのlog_queries_min_typeを追加 [#10053](https://github.com/ClickHouse/ClickHouse/pull/10053) ([Azat Khuzhin](https://github.com/azat))
- 関数`isConstant`を追加。この関数は引数が定数式であるかどうかをチェックし、1または0を返します。開発、デバッグ、デモンストレーション目的で使用されます。[#10198](https://github.com/ClickHouse/ClickHouse/pull/10198) ([alexey-milovidov](https://github.com/alexey-milovidov))
- キーが存在しない場合にデフォルト値を返す代わりにNULLを返すjoinGetOrNullを追加。[#10094](https://github.com/ClickHouse/ClickHouse/pull/10094) ([Amos Bird](https://github.com/amosbird))
- オプション`transform_null_in`が設定されている場合、`IN`演算子で`NULL`を`NULL`と等しいとみなします。[#10085](https://github.com/ClickHouse/ClickHouse/pull/10085) ([achimbab](https://github.com/achimbab))
- MergeTreeテーブルエンジンファミリーに`ALTER TABLE ... RENAME COLUMN`を追加。[#9948](https://github.com/ClickHouse/ClickHouse/pull/9948) ([alesapin](https://github.com/alesapin))
- 並列分散INSERT SELECTをサポート。[#9759](https://github.com/ClickHouse/ClickHouse/pull/9759) ([vxider](https://github.com/Vxider))
- Distributed over Distributedのクエリ機能を追加(`distributed_group_by_no_merge`なし)... [#9923](https://github.com/ClickHouse/ClickHouse/pull/9923) ([Azat Khuzhin](https://github.com/azat))
- 指定された範囲内の配列要素を集約する関数`arrayReduceInRanges`を追加。[#9598](https://github.com/ClickHouse/ClickHouse/pull/9598) ([hcz](https://github.com/hczhcz))
- Prometheusエクスポーターにディクショナリステータスを追加。[#9622](https://github.com/ClickHouse/ClickHouse/pull/9622) ([Guillaume Tassery](https://github.com/YiuRULE))
- 関数`arrayAUC`を追加 [#8698](https://github.com/ClickHouse/ClickHouse/pull/8698) ([taiyang-li](https://github.com/taiyang-li))
- TPC-H互換性向上のため`DROP VIEW`ステートメントをサポート。[#9831](https://github.com/ClickHouse/ClickHouse/pull/9831) ([Amos Bird](https://github.com/amosbird))
- windowFunnel()に'strict_order'オプションを追加 [#9773](https://github.com/ClickHouse/ClickHouse/pull/9773) ([achimbab](https://github.com/achimbab))
- `DATE`および`TIMESTAMP` SQL演算子をサポート、例：`SELECT date '2001-01-01'` [#9691](https://github.com/ClickHouse/ClickHouse/pull/9691) ([Artem Zuikov](https://github.com/4ertus2))

#### 実験的機能 {#experimental-feature-6}

- 実験的なデータベースエンジンAtomicを追加しました。ノンブロッキングの`DROP`および`RENAME TABLE`クエリと、アトミックな`EXCHANGE TABLES t1 AND t2`クエリをサポートします [#7512](https://github.com/ClickHouse/ClickHouse/pull/7512) ([tavplubix](https://github.com/tavplubix))
- S3上のReplicatedMergeTreeの初期サポートを追加しました(最適ではない方法で動作します) [#10126](https://github.com/ClickHouse/ClickHouse/pull/10126) ([Pavel Kovalenko](https://github.com/Jokser))


#### バグ修正 {#bug-fix-32}

- Fixed incorrect scalar results inside inner query of `MATERIALIZED VIEW` in case if this query contained dependent table [#10603](https://github.com/ClickHouse/ClickHouse/pull/10603) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed bug, which caused HTTP requests to get stuck on client closing connection when `readonly=2` and `cancel_http_readonly_queries_on_client_close=1`. [#10684](https://github.com/ClickHouse/ClickHouse/pull/10684) ([tavplubix](https://github.com/tavplubix))
- Fix segfault in StorageBuffer when exception is thrown on server startup. Fixes [#10550](https://github.com/ClickHouse/ClickHouse/issues/10550) [#10609](https://github.com/ClickHouse/ClickHouse/pull/10609) ([tavplubix](https://github.com/tavplubix))
- The query`SYSTEM DROP DNS CACHE` now also drops caches used to check if user is allowed to connect from some IP addresses [#10608](https://github.com/ClickHouse/ClickHouse/pull/10608) ([tavplubix](https://github.com/tavplubix))
- Fix usage of multiple `IN` operators with an identical set in one query. Fixes [#10539](https://github.com/ClickHouse/ClickHouse/issues/10539) [#10686](https://github.com/ClickHouse/ClickHouse/pull/10686) ([Anton Popov](https://github.com/CurtizJ))
- Fix crash in `generateRandom` with nested types. Fixes [#10583](https://github.com/ClickHouse/ClickHouse/issues/10583). [#10734](https://github.com/ClickHouse/ClickHouse/pull/10734) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix data corruption for `LowCardinality(FixedString)` key column in `SummingMergeTree` which could have happened after merge. Fixes [#10489](https://github.com/ClickHouse/ClickHouse/issues/10489). [#10721](https://github.com/ClickHouse/ClickHouse/pull/10721) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix logic for aggregation_memory_efficient_merge_threads setting. [#10667](https://github.com/ClickHouse/ClickHouse/pull/10667) ([palasonic1](https://github.com/palasonic1))
- Fix disappearing totals. Totals could have being filtered if query had `JOIN` or subquery with external `WHERE` condition. Fixes [#10674](https://github.com/ClickHouse/ClickHouse/issues/10674) [#10698](https://github.com/ClickHouse/ClickHouse/pull/10698) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix the lack of parallel execution of remote queries with `distributed_aggregation_memory_efficient` enabled. Fixes [#10655](https://github.com/ClickHouse/ClickHouse/issues/10655) [#10664](https://github.com/ClickHouse/ClickHouse/pull/10664) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix possible incorrect number of rows for queries with `LIMIT`. Fixes [#10566](https://github.com/ClickHouse/ClickHouse/issues/10566), [#10709](https://github.com/ClickHouse/ClickHouse/issues/10709) [#10660](https://github.com/ClickHouse/ClickHouse/pull/10660) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix index corruption, which may occur in some cases after merging compact parts into another compact part. [#10531](https://github.com/ClickHouse/ClickHouse/pull/10531) ([Anton Popov](https://github.com/CurtizJ))
- Fix the situation, when mutation finished all parts, but hung up in `is_done=0`. [#10526](https://github.com/ClickHouse/ClickHouse/pull/10526) ([alesapin](https://github.com/alesapin))
- Fix overflow at beginning of unix epoch for timezones with fractional offset from UTC. Fixes [#9335](https://github.com/ClickHouse/ClickHouse/issues/9335). [#10513](https://github.com/ClickHouse/ClickHouse/pull/10513) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Better diagnostics for input formats. Fixes [#10204](https://github.com/ClickHouse/ClickHouse/issues/10204) [#10418](https://github.com/ClickHouse/ClickHouse/pull/10418) ([tavplubix](https://github.com/tavplubix))
- Fix numeric overflow in `simpleLinearRegression()` over large integers [#10474](https://github.com/ClickHouse/ClickHouse/pull/10474) ([hcz](https://github.com/hczhcz))
- Fix use-after-free in Distributed shutdown, avoid waiting for sending all batches [#10491](https://github.com/ClickHouse/ClickHouse/pull/10491) ([Azat Khuzhin](https://github.com/azat))
- Add CA certificates to clickhouse-server docker image [#10476](https://github.com/ClickHouse/ClickHouse/pull/10476) ([filimonov](https://github.com/filimonov))
- Fix a rare endless loop that might have occurred when using the `addressToLine` function or AggregateFunctionState columns. [#10466](https://github.com/ClickHouse/ClickHouse/pull/10466) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Handle zookeeper "no node error" during distributed query [#10050](https://github.com/ClickHouse/ClickHouse/pull/10050) ([Daniel Chen](https://github.com/Phantomape))
- Fix bug when server cannot attach table after column's default was altered. [#10441](https://github.com/ClickHouse/ClickHouse/pull/10441) ([alesapin](https://github.com/alesapin))
- Implicitly cast the default expression type to the column type for the ALIAS columns [#10563](https://github.com/ClickHouse/ClickHouse/pull/10563) ([Azat Khuzhin](https://github.com/azat))
- Don't remove metadata directory if `ATTACH DATABASE` fails [#10442](https://github.com/ClickHouse/ClickHouse/pull/10442) ([Winter Zhang](https://github.com/zhang2014))
- Avoid dependency on system tzdata. Fixes loading of `Africa/Casablanca` timezone on CentOS 8. Fixes [#10211](https://github.com/ClickHouse/ClickHouse/issues/10211) [#10425](https://github.com/ClickHouse/ClickHouse/pull/10425) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix some issues if data is inserted with quorum and then gets deleted (DROP PARTITION, TTL, etc.). It led to stuck of INSERTs or false-positive exceptions in SELECTs. Fixes [#9946](https://github.com/ClickHouse/ClickHouse/issues/9946) [#10188](https://github.com/ClickHouse/ClickHouse/pull/10188) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Check the number and type of arguments when creating BloomFilter index [#9623](https://github.com/ClickHouse/ClickHouse/issues/9623) [#10431](https://github.com/ClickHouse/ClickHouse/pull/10431) ([Winter Zhang](https://github.com/zhang2014))
- Prefer `fallback_to_stale_replicas` over `skip_unavailable_shards`, otherwise when both settings specified and there are no up-to-date replicas the query will fail (patch from @alex-zaitsev ) [#10422](https://github.com/ClickHouse/ClickHouse/pull/10422) ([Azat Khuzhin](https://github.com/azat))
- Fix the issue when a query with ARRAY JOIN, ORDER BY and LIMIT may return incomplete result. Fixes [#10226](https://github.com/ClickHouse/ClickHouse/issues/10226). [#10427](https://github.com/ClickHouse/ClickHouse/pull/10427) ([Vadim Plakhtinskiy](https://github.com/VadimPlh))
- Add database name to dictionary name after DETACH/ATTACH. Fixes system.dictionaries table and `SYSTEM RELOAD` query [#10415](https://github.com/ClickHouse/ClickHouse/pull/10415) ([Azat Khuzhin](https://github.com/azat))
- Fix possible incorrect result for extremes in processors pipeline. [#10131](https://github.com/ClickHouse/ClickHouse/pull/10131) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix possible segfault when the setting `distributed_group_by_no_merge` is enabled (introduced in 20.3.7.46 by [#10131](https://github.com/ClickHouse/ClickHouse/issues/10131)). [#10399](https://github.com/ClickHouse/ClickHouse/pull/10399) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix wrong flattening of `Array(Tuple(...))` data types. Fixes [#10259](https://github.com/ClickHouse/ClickHouse/issues/10259) [#10390](https://github.com/ClickHouse/ClickHouse/pull/10390) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix column names of constants inside JOIN that may clash with names of constants outside of JOIN [#9950](https://github.com/ClickHouse/ClickHouse/pull/9950) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Fix order of columns after Block::sortColumns() [#10826](https://github.com/ClickHouse/ClickHouse/pull/10826) ([Azat Khuzhin](https://github.com/azat))
- Fix possible `Pipeline stuck` error in `ConcatProcessor` which may happen in remote query. [#10381](https://github.com/ClickHouse/ClickHouse/pull/10381) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Don't make disk reservations for aggregations. Fixes [#9241](https://github.com/ClickHouse/ClickHouse/issues/9241) [#10375](https://github.com/ClickHouse/ClickHouse/pull/10375) ([Azat Khuzhin](https://github.com/azat))
- Fix wrong behaviour of datetime functions for timezones that has altered between positive and negative offsets from UTC (e.g. Pacific/Kiritimati). Fixes [#7202](https://github.com/ClickHouse/ClickHouse/issues/7202) [#10369](https://github.com/ClickHouse/ClickHouse/pull/10369) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Avoid infinite loop in `dictIsIn` function. Fixes #515 [#10365](https://github.com/ClickHouse/ClickHouse/pull/10365) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Disable GROUP BY sharding_key optimization by default and fix it for WITH ROLLUP/CUBE/TOTALS [#10516](https://github.com/ClickHouse/ClickHouse/pull/10516) ([Azat Khuzhin](https://github.com/azat))
- Check for error code when checking parts and don't mark part as broken if the error is like "not enough memory". Fixes [#6269](https://github.com/ClickHouse/ClickHouse/issues/6269) [#10364](https://github.com/ClickHouse/ClickHouse/pull/10364) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Show information about not loaded dictionaries in system tables. [#10234](https://github.com/ClickHouse/ClickHouse/pull/10234) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix nullptr dereference in StorageBuffer if server was shutdown before table startup. [#10641](https://github.com/ClickHouse/ClickHouse/pull/10641) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed `DROP` vs `OPTIMIZE` race in `ReplicatedMergeTree`. `DROP` could left some garbage in replica path in ZooKeeper if there was concurrent `OPTIMIZE` query. [#10312](https://github.com/ClickHouse/ClickHouse/pull/10312) ([tavplubix](https://github.com/tavplubix))
- Fix 'Logical error: CROSS JOIN has expressions' error for queries with comma and names joins mix. Fixes [#9910](https://github.com/ClickHouse/ClickHouse/issues/9910) [#10311](https://github.com/ClickHouse/ClickHouse/pull/10311) ([Artem Zuikov](https://github.com/4ertus2))
- Fix queries with `max_bytes_before_external_group_by`. [#10302](https://github.com/ClickHouse/ClickHouse/pull/10302) ([Artem Zuikov](https://github.com/4ertus2))
- Fix the issue with limiting maximum recursion depth in parser in certain cases. This fixes [#10283](https://github.com/ClickHouse/ClickHouse/issues/10283) This fix may introduce minor incompatibility: long and deep queries via clickhouse-client may refuse to work, and you should adjust settings `max_query_size` and `max_parser_depth` accordingly. [#10295](https://github.com/ClickHouse/ClickHouse/pull/10295) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Allow to use `count(*)` with multiple JOINs. Fixes [#9853](https://github.com/ClickHouse/ClickHouse/issues/9853) [#10291](https://github.com/ClickHouse/ClickHouse/pull/10291) ([Artem Zuikov](https://github.com/4ertus2))
- Fix error `Pipeline stuck` with `max_rows_to_group_by` and `group_by_overflow_mode = 'break'`. [#10279](https://github.com/ClickHouse/ClickHouse/pull/10279) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix 'Cannot add column' error while creating `range_hashed` dictionary using DDL query. Fixes [#10093](https://github.com/ClickHouse/ClickHouse/issues/10093). [#10235](https://github.com/ClickHouse/ClickHouse/pull/10235) ([alesapin](https://github.com/alesapin))
- Fix rare possible exception `Cannot drain connections: cancel first`. [#10239](https://github.com/ClickHouse/ClickHouse/pull/10239) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed bug where ClickHouse would throw "Unknown function lambda." error message when user tries to run ALTER UPDATE/DELETE on tables with ENGINE = Replicated\*. Check for nondeterministic functions now handles lambda expressions correctly. [#10237](https://github.com/ClickHouse/ClickHouse/pull/10237) ([Alexander Kazakov](https://github.com/Akazz))
- Fixed reasonably rare segfault in StorageSystemTables that happens when SELECT ... FROM system.tables is run on a database with Lazy engine. [#10209](https://github.com/ClickHouse/ClickHouse/pull/10209) ([Alexander Kazakov](https://github.com/Akazz))
- Fix possible infinite query execution when the query actually should stop on LIMIT, while reading from infinite source like `system.numbers` or `system.zeros`. [#10206](https://github.com/ClickHouse/ClickHouse/pull/10206) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed "generateRandom" function for Date type. This fixes [#9973](https://github.com/ClickHouse/ClickHouse/issues/9973). Fix an edge case when dates with year 2106 are inserted to MergeTree tables with old-style partitioning but partitions are named with year 1970. [#10218](https://github.com/ClickHouse/ClickHouse/pull/10218) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Convert types if the table definition of a View does not correspond to the SELECT query. This fixes [#10180](https://github.com/ClickHouse/ClickHouse/issues/10180) and [#10022](https://github.com/ClickHouse/ClickHouse/issues/10022) [#10217](https://github.com/ClickHouse/ClickHouse/pull/10217) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix `parseDateTimeBestEffort` for strings in RFC-2822 when day of week is Tuesday or Thursday. This fixes [#10082](https://github.com/ClickHouse/ClickHouse/issues/10082) [#10214](https://github.com/ClickHouse/ClickHouse/pull/10214) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix column names of constants inside JOIN that may clash with names of constants outside of JOIN. [#10207](https://github.com/ClickHouse/ClickHouse/pull/10207) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix move-to-prewhere optimization in presense of arrayJoin functions (in certain cases). This fixes [#10092](https://github.com/ClickHouse/ClickHouse/issues/10092) [#10195](https://github.com/ClickHouse/ClickHouse/pull/10195) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix issue with separator appearing in SCRAMBLE for native mysql-connector-java (JDBC) [#10140](https://github.com/ClickHouse/ClickHouse/pull/10140) ([BohuTANG](https://github.com/BohuTANG))
- Fix using the current database for an access checking when the database isn't specified. [#10192](https://github.com/ClickHouse/ClickHouse/pull/10192) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix ALTER of tables with compact parts. [#10130](https://github.com/ClickHouse/ClickHouse/pull/10130) ([Anton Popov](https://github.com/CurtizJ))
- Add the ability to relax the restriction on non-deterministic functions usage in mutations with `allow_nondeterministic_mutations` setting. [#10186](https://github.com/ClickHouse/ClickHouse/pull/10186) ([filimonov](https://github.com/filimonov))
- Fix `DROP TABLE` invoked for dictionary [#10165](https://github.com/ClickHouse/ClickHouse/pull/10165) ([Azat Khuzhin](https://github.com/azat))
- Convert blocks if structure does not match when doing `INSERT` into Distributed table [#10135](https://github.com/ClickHouse/ClickHouse/pull/10135) ([Azat Khuzhin](https://github.com/azat))
- The number of rows was logged incorrectly (as sum across all parts) when inserted block is split by parts with partition key. [#10138](https://github.com/ClickHouse/ClickHouse/pull/10138) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add some arguments check and support identifier arguments for MySQL Database Engine [#10077](https://github.com/ClickHouse/ClickHouse/pull/10077) ([Winter Zhang](https://github.com/zhang2014))
- Fix incorrect `index_granularity_bytes` check while creating new replica. Fixes [#10098](https://github.com/ClickHouse/ClickHouse/issues/10098). [#10121](https://github.com/ClickHouse/ClickHouse/pull/10121) ([alesapin](https://github.com/alesapin))
- Fix bug in `CHECK TABLE` query when table contain skip indices. [#10068](https://github.com/ClickHouse/ClickHouse/pull/10068) ([alesapin](https://github.com/alesapin))
- Fix Distributed-over-Distributed with the only one shard in a nested table [#9997](https://github.com/ClickHouse/ClickHouse/pull/9997) ([Azat Khuzhin](https://github.com/azat))
- Fix possible rows loss for queries with `JOIN` and `UNION ALL`. Fixes [#9826](https://github.com/ClickHouse/ClickHouse/issues/9826), [#10113](https://github.com/ClickHouse/ClickHouse/issues/10113). ... [#10099](https://github.com/ClickHouse/ClickHouse/pull/10099) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix bug in dictionary when local clickhouse server is used as source. It may caused memory corruption if types in dictionary and source are not compatible. [#10071](https://github.com/ClickHouse/ClickHouse/pull/10071) ([alesapin](https://github.com/alesapin))
- Fixed replicated tables startup when updating from an old ClickHouse version where `/table/replicas/replica_name/metadata` node does not exist. Fixes [#10037](https://github.com/ClickHouse/ClickHouse/issues/10037). [#10095](https://github.com/ClickHouse/ClickHouse/pull/10095) ([alesapin](https://github.com/alesapin))
- Fix error `Cannot clone block with columns because block has 0 columns ... While executing GroupingAggregatedTransform`. It happened when setting `distributed_aggregation_memory_efficient` was enabled, and distributed query read aggregating data with mixed single and two-level aggregation from different shards. [#10063](https://github.com/ClickHouse/ClickHouse/pull/10063) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix deadlock when database with materialized view failed attach at start [#10054](https://github.com/ClickHouse/ClickHouse/pull/10054) ([Azat Khuzhin](https://github.com/azat))
- Fix a segmentation fault that could occur in GROUP BY over string keys containing trailing zero bytes ([#8636](https://github.com/ClickHouse/ClickHouse/issues/8636), [#8925](https://github.com/ClickHouse/ClickHouse/issues/8925)). ... [#10025](https://github.com/ClickHouse/ClickHouse/pull/10025) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Fix wrong results of distributed queries when alias could override qualified column name. Fixes [#9672](https://github.com/ClickHouse/ClickHouse/issues/9672) [#9714](https://github.com/ClickHouse/ClickHouse/issues/9714) [#9972](https://github.com/ClickHouse/ClickHouse/pull/9972) ([Artem Zuikov](https://github.com/4ertus2))
- Fix possible deadlock in `SYSTEM RESTART REPLICAS` [#9955](https://github.com/ClickHouse/ClickHouse/pull/9955) ([tavplubix](https://github.com/tavplubix))
- Fix the number of threads used for remote query execution (performance regression, since 20.3). This happened when query from `Distributed` table was executed simultaneously on local and remote shards. Fixes [#9965](https://github.com/ClickHouse/ClickHouse/issues/9965) [#9971](https://github.com/ClickHouse/ClickHouse/pull/9971) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed `DeleteOnDestroy` logic in `ATTACH PART` which could lead to automatic removal of attached part and added few tests [#9410](https://github.com/ClickHouse/ClickHouse/pull/9410) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix a bug with `ON CLUSTER` DDL queries freezing on server startup. [#9927](https://github.com/ClickHouse/ClickHouse/pull/9927) ([Gagan Arneja](https://github.com/garneja))
- Fix bug in which the necessary tables weren't retrieved at one of the processing stages of queries to some databases. Fixes [#9699](https://github.com/ClickHouse/ClickHouse/issues/9699). [#9949](https://github.com/ClickHouse/ClickHouse/pull/9949) ([achulkov2](https://github.com/achulkov2))
- Fix 'Not found column in block' error when `JOIN` appears with `TOTALS`. Fixes [#9839](https://github.com/ClickHouse/ClickHouse/issues/9839) [#9939](https://github.com/ClickHouse/ClickHouse/pull/9939) ([Artem Zuikov](https://github.com/4ertus2))
- Fix parsing multiple hosts set in the CREATE USER command [#9924](https://github.com/ClickHouse/ClickHouse/pull/9924) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix `TRUNCATE` for Join table engine ([#9917](https://github.com/ClickHouse/ClickHouse/issues/9917)). [#9920](https://github.com/ClickHouse/ClickHouse/pull/9920) ([Amos Bird](https://github.com/amosbird))
- Fix race condition between drop and optimize in `ReplicatedMergeTree`. [#9901](https://github.com/ClickHouse/ClickHouse/pull/9901) ([alesapin](https://github.com/alesapin))
- Fix `DISTINCT` for Distributed when `optimize_skip_unused_shards` is set. [#9808](https://github.com/ClickHouse/ClickHouse/pull/9808) ([Azat Khuzhin](https://github.com/azat))
- Fix "scalar does not exist" error in ALTERs ([#9878](https://github.com/ClickHouse/ClickHouse/issues/9878)). ... [#9904](https://github.com/ClickHouse/ClickHouse/pull/9904) ([Amos Bird](https://github.com/amosbird))
- Fix error with qualified names in `distributed_product_mode=\'local\'`. Fixes [#4756](https://github.com/ClickHouse/ClickHouse/issues/4756) [#9891](https://github.com/ClickHouse/ClickHouse/pull/9891) ([Artem Zuikov](https://github.com/4ertus2))
- For INSERT queries shards now do clamp the settings from the initiator to their constraints instead of throwing an exception. This fix allows to send INSERT queries to a shard with another constraints. This change improves fix [#9447](https://github.com/ClickHouse/ClickHouse/issues/9447). [#9852](https://github.com/ClickHouse/ClickHouse/pull/9852) ([Vitaly Baranov](https://github.com/vitlibar))
- Add some retries when commiting offsets to Kafka broker, since it can reject commit if during `offsets.commit.timeout.ms` there were no enough replicas available for the `__consumer_offsets` topic [#9884](https://github.com/ClickHouse/ClickHouse/pull/9884) ([filimonov](https://github.com/filimonov))
- Fix Distributed engine behavior when virtual columns of the underlying table used in `WHERE` [#9847](https://github.com/ClickHouse/ClickHouse/pull/9847) ([Azat Khuzhin](https://github.com/azat))
- Fixed some cases when timezone of the function argument wasn't used properly. [#9574](https://github.com/ClickHouse/ClickHouse/pull/9574) ([Vasily Nemkov](https://github.com/Enmk))
- Fix 'Different expressions with the same alias' error when query has PREWHERE and WHERE on distributed table and `SET distributed_product_mode = 'local'`. [#9871](https://github.com/ClickHouse/ClickHouse/pull/9871) ([Artem Zuikov](https://github.com/4ertus2))
- Fix mutations excessive memory consumption for tables with a composite primary key. This fixes [#9850](https://github.com/ClickHouse/ClickHouse/issues/9850). [#9860](https://github.com/ClickHouse/ClickHouse/pull/9860) ([alesapin](https://github.com/alesapin))
- Fix calculating grants for introspection functions from the setting `allow_introspection_functions`. [#9840](https://github.com/ClickHouse/ClickHouse/pull/9840) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix max_distributed_connections (w/ and w/o Processors) [#9673](https://github.com/ClickHouse/ClickHouse/pull/9673) ([Azat Khuzhin](https://github.com/azat))
- Fix possible exception `Got 0 in totals chunk, expected 1` on client. It happened for queries with `JOIN` in case if right joined table had zero rows. Example: `select * from system.one t1 join system.one t2 on t1.dummy = t2.dummy limit 0 FORMAT TabSeparated;`. Fixes [#9777](https://github.com/ClickHouse/ClickHouse/issues/9777). ... [#9823](https://github.com/ClickHouse/ClickHouse/pull/9823) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix 'COMMA to CROSS JOIN rewriter is not enabled or cannot rewrite query' error in case of subqueries with COMMA JOIN out of tables lists (i.e. in WHERE). Fixes [#9782](https://github.com/ClickHouse/ClickHouse/issues/9782) [#9830](https://github.com/ClickHouse/ClickHouse/pull/9830) ([Artem Zuikov](https://github.com/4ertus2))
- Fix server crashing when `optimize_skip_unused_shards` is set and expression for key can't be converted to its field type [#9804](https://github.com/ClickHouse/ClickHouse/pull/9804) ([Azat Khuzhin](https://github.com/azat))
- Fix empty string handling in `splitByString`. [#9767](https://github.com/ClickHouse/ClickHouse/pull/9767) ([hcz](https://github.com/hczhcz))
- Fix broken `ALTER TABLE DELETE COLUMN` query for compact parts. [#9779](https://github.com/ClickHouse/ClickHouse/pull/9779) ([alesapin](https://github.com/alesapin))
- Fixed missing `rows_before_limit_at_least` for queries over http (with processors pipeline). Fixes [#9730](https://github.com/ClickHouse/ClickHouse/issues/9730) [#9757](https://github.com/ClickHouse/ClickHouse/pull/9757) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix excessive memory consumption in `ALTER` queries (mutations). This fixes [#9533](https://github.com/ClickHouse/ClickHouse/issues/9533) and [#9670](https://github.com/ClickHouse/ClickHouse/issues/9670). [#9754](https://github.com/ClickHouse/ClickHouse/pull/9754) ([alesapin](https://github.com/alesapin))
- Fix possible permanent "Cannot schedule a task" error. [#9154](https://github.com/ClickHouse/ClickHouse/pull/9154) ([Azat Khuzhin](https://github.com/azat))
- Fix bug in backquoting in external dictionaries DDL. Fixes [#9619](https://github.com/ClickHouse/ClickHouse/issues/9619). [#9734](https://github.com/ClickHouse/ClickHouse/pull/9734) ([alesapin](https://github.com/alesapin))
- Fixed data race in `text_log`. It does not correspond to any real bug. [#9726](https://github.com/ClickHouse/ClickHouse/pull/9726) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix bug in a replication that does not allow replication to work if the user has executed mutations on the previous version. This fixes [#9645](https://github.com/ClickHouse/ClickHouse/issues/9645). [#9652](https://github.com/ClickHouse/ClickHouse/pull/9652) ([alesapin](https://github.com/alesapin))
- Fixed incorrect internal function names for `sumKahan` and `sumWithOverflow`. It led to exception while using this functions in remote queries. [#9636](https://github.com/ClickHouse/ClickHouse/pull/9636) ([Azat Khuzhin](https://github.com/azat))
- Add setting `use_compact_format_in_distributed_parts_names` which allows to write files for `INSERT` queries into `Distributed` table with more compact format. This fixes [#9647](https://github.com/ClickHouse/ClickHouse/issues/9647). [#9653](https://github.com/ClickHouse/ClickHouse/pull/9653) ([alesapin](https://github.com/alesapin))
- Fix RIGHT and FULL JOIN with LowCardinality in JOIN keys. [#9610](https://github.com/ClickHouse/ClickHouse/pull/9610) ([Artem Zuikov](https://github.com/4ertus2))
- Fix possible exceptions `Size of filter does not match size of column` and `Invalid number of rows in Chunk` in `MergeTreeRangeReader`. They could appear while executing `PREWHERE` in some cases. [#9612](https://github.com/ClickHouse/ClickHouse/pull/9612) ([Anton Popov](https://github.com/CurtizJ))
- Allow `ALTER ON CLUSTER` of Distributed tables with internal replication. This fixes [#3268](https://github.com/ClickHouse/ClickHouse/issues/3268) [#9617](https://github.com/ClickHouse/ClickHouse/pull/9617) ([shinoi2](https://github.com/shinoi2))
- Fix issue when timezone was not preserved if you write a simple arithmetic expression like `time + 1` (in contrast to an expression like `time + INTERVAL 1 SECOND`). This fixes [#5743](https://github.com/ClickHouse/ClickHouse/issues/5743) [#9323](https://github.com/ClickHouse/ClickHouse/pull/9323) ([alexey-milovidov](https://github.com/alexey-milovidov))





#### 改善 {#improvement-16}

- Use time zone when comparing DateTime with string literal. This fixes [#5206](https://github.com/ClickHouse/ClickHouse/issues/5206). [#10515](https://github.com/ClickHouse/ClickHouse/pull/10515) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Print verbose diagnostic info if Decimal value cannot be parsed from text input format. [#10205](https://github.com/ClickHouse/ClickHouse/pull/10205) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add tasks/memory metrics for distributed/buffer schedule pools [#10449](https://github.com/ClickHouse/ClickHouse/pull/10449) ([Azat Khuzhin](https://github.com/azat))
- Display result as soon as it's ready for SELECT DISTINCT queries in clickhouse-local and HTTP interface. This fixes [#8951](https://github.com/ClickHouse/ClickHouse/issues/8951) [#9559](https://github.com/ClickHouse/ClickHouse/pull/9559) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Allow to use `SAMPLE OFFSET` query instead of `cityHash64(PRIMARY KEY) % N == n` for splitting in `clickhouse-copier`. To use this feature, pass `--experimental-use-sample-offset 1` as a command line argument. [#10414](https://github.com/ClickHouse/ClickHouse/pull/10414) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Allow to parse BOM in TSV if the first column cannot contain BOM in its value. This fixes [#10301](https://github.com/ClickHouse/ClickHouse/issues/10301) [#10424](https://github.com/ClickHouse/ClickHouse/pull/10424) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add Avro nested fields insert support [#10354](https://github.com/ClickHouse/ClickHouse/pull/10354) ([Andrew Onyshchuk](https://github.com/oandrew))
- Allowed to alter column in non-modifying data mode when the same type is specified. [#10382](https://github.com/ClickHouse/ClickHouse/pull/10382) ([Vladimir Chebotarev](https://github.com/excitoon))
- Auto `distributed_group_by_no_merge` on GROUP BY sharding key (if `optimize_skip_unused_shards` is set) [#10341](https://github.com/ClickHouse/ClickHouse/pull/10341) ([Azat Khuzhin](https://github.com/azat))
- Optimize queries with LIMIT/LIMIT BY/ORDER BY for distributed with GROUP BY sharding_key [#10373](https://github.com/ClickHouse/ClickHouse/pull/10373) ([Azat Khuzhin](https://github.com/azat))
- Added a setting `max_server_memory_usage` to limit total memory usage of the server. The metric `MemoryTracking` is now calculated without a drift. The setting `max_memory_usage_for_all_queries` is now obsolete and does nothing. This closes [#10293](https://github.com/ClickHouse/ClickHouse/issues/10293). [#10362](https://github.com/ClickHouse/ClickHouse/pull/10362) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add config option `system_tables_lazy_load`. If it's set to false, then system tables with logs are loaded at the server startup. [Alexander Burmak](https://github.com/Alex-Burmak), [Svyatoslav Tkhon Il Pak](https://github.com/DeifyTheGod), [#9642](https://github.com/ClickHouse/ClickHouse/pull/9642) [#10359](https://github.com/ClickHouse/ClickHouse/pull/10359) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Use background thread pool (background_schedule_pool_size) for distributed sends [#10263](https://github.com/ClickHouse/ClickHouse/pull/10263) ([Azat Khuzhin](https://github.com/azat))
- Use background thread pool for background buffer flushes. [#10315](https://github.com/ClickHouse/ClickHouse/pull/10315) ([Azat Khuzhin](https://github.com/azat))
- Support for one special case of removing incompletely written parts. This fixes [#9940](https://github.com/ClickHouse/ClickHouse/issues/9940). [#10221](https://github.com/ClickHouse/ClickHouse/pull/10221) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Use isInjective() over manual list of such functions for GROUP BY optimization. [#10342](https://github.com/ClickHouse/ClickHouse/pull/10342) ([Azat Khuzhin](https://github.com/azat))
- Avoid printing error message in log if client sends RST packet immediately on connect. It is typical behaviour of IPVS balancer with keepalived and VRRP. This fixes [#1851](https://github.com/ClickHouse/ClickHouse/issues/1851) [#10274](https://github.com/ClickHouse/ClickHouse/pull/10274) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Allow to parse `+inf` for floating point types. This closes [#1839](https://github.com/ClickHouse/ClickHouse/issues/1839) [#10272](https://github.com/ClickHouse/ClickHouse/pull/10272) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Implemented `generateRandom` table function for Nested types. This closes [#9903](https://github.com/ClickHouse/ClickHouse/issues/9903) [#10219](https://github.com/ClickHouse/ClickHouse/pull/10219) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Provide `max_allowed_packed` in MySQL compatibility interface that will help some clients to communicate with ClickHouse via MySQL protocol. [#10199](https://github.com/ClickHouse/ClickHouse/pull/10199) ([BohuTANG](https://github.com/BohuTANG))
- Allow literals for GLOBAL IN (i.e. `SELECT * FROM remote('localhost', system.one) WHERE dummy global in (0)`) [#10196](https://github.com/ClickHouse/ClickHouse/pull/10196) ([Azat Khuzhin](https://github.com/azat))
- Fix various small issues in interactive mode of clickhouse-client [#10194](https://github.com/ClickHouse/ClickHouse/pull/10194) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Avoid superfluous dictionaries load (system.tables, DROP/SHOW CREATE TABLE) [#10164](https://github.com/ClickHouse/ClickHouse/pull/10164) ([Azat Khuzhin](https://github.com/azat))
- Update to RWLock: timeout parameter for getLock() + implementation reworked to be phase fair [#10073](https://github.com/ClickHouse/ClickHouse/pull/10073) ([Alexander Kazakov](https://github.com/Akazz))
- Enhanced compatibility with native mysql-connector-java(JDBC) [#10021](https://github.com/ClickHouse/ClickHouse/pull/10021) ([BohuTANG](https://github.com/BohuTANG))
- The function `toString` is considered monotonic and can be used for index analysis even when applied in tautological cases with String or LowCardinality(String) argument. [#10110](https://github.com/ClickHouse/ClickHouse/pull/10110) ([Amos Bird](https://github.com/amosbird))
- Add `ON CLUSTER` clause support to commands `{CREATE|DROP} USER/ROLE/ROW POLICY/SETTINGS PROFILE/QUOTA`, `GRANT`. [#9811](https://github.com/ClickHouse/ClickHouse/pull/9811) ([Vitaly Baranov](https://github.com/vitlibar))
- Virtual hosted-style support for S3 URI [#9998](https://github.com/ClickHouse/ClickHouse/pull/9998) ([Pavel Kovalenko](https://github.com/Jokser))
- Now layout type for dictionaries with no arguments can be specified without round brackets in dictionaries DDL-queries. Fixes [#10057](https://github.com/ClickHouse/ClickHouse/issues/10057). [#10064](https://github.com/ClickHouse/ClickHouse/pull/10064) ([alesapin](https://github.com/alesapin))
- Add ability to use number ranges with leading zeros in filepath [#9989](https://github.com/ClickHouse/ClickHouse/pull/9989) ([Olga Khvostikova](https://github.com/stavrolia))
- Better memory usage in CROSS JOIN. [#10029](https://github.com/ClickHouse/ClickHouse/pull/10029) ([Artem Zuikov](https://github.com/4ertus2))
- Try to connect to all shards in cluster when getting structure of remote table and skip_unavailable_shards is set. [#7278](https://github.com/ClickHouse/ClickHouse/pull/7278) ([nvartolomei](https://github.com/nvartolomei))
- Add `total_rows`/`total_bytes` into the `system.tables` table. [#9919](https://github.com/ClickHouse/ClickHouse/pull/9919) ([Azat Khuzhin](https://github.com/azat))
- System log tables now use polymorpic parts by default. [#9905](https://github.com/ClickHouse/ClickHouse/pull/9905) ([Anton Popov](https://github.com/CurtizJ))
- Add type column into system.settings/merge_tree_settings [#9909](https://github.com/ClickHouse/ClickHouse/pull/9909) ([Azat Khuzhin](https://github.com/azat))
- Check for available CPU instructions at server startup as early as possible. [#9888](https://github.com/ClickHouse/ClickHouse/pull/9888) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Remove `ORDER BY` stage from mutations because we read from a single ordered part in a single thread. Also add check that the rows in mutation are ordered by sorting key and this order is not violated. [#9886](https://github.com/ClickHouse/ClickHouse/pull/9886) ([alesapin](https://github.com/alesapin))
- Implement operator LIKE for FixedString at left hand side. This is needed to better support TPC-DS queries. [#9890](https://github.com/ClickHouse/ClickHouse/pull/9890) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add `force_optimize_skip_unused_shards_no_nested` that will disable `force_optimize_skip_unused_shards` for nested Distributed table [#9812](https://github.com/ClickHouse/ClickHouse/pull/9812) ([Azat Khuzhin](https://github.com/azat))
- Now columns size is calculated only once for MergeTree data parts. [#9827](https://github.com/ClickHouse/ClickHouse/pull/9827) ([alesapin](https://github.com/alesapin))
- Evaluate constant expressions for `optimize_skip_unused_shards` (i.e. `SELECT * FROM foo_dist WHERE key=xxHash32(0)`) [#8846](https://github.com/ClickHouse/ClickHouse/pull/8846) ([Azat Khuzhin](https://github.com/azat))
- Check for using `Date` or `DateTime` column from TTL expressions was removed. [#9967](https://github.com/ClickHouse/ClickHouse/pull/9967) ([Vladimir Chebotarev](https://github.com/excitoon))
- DiskS3 hard links optimal implementation. [#9760](https://github.com/ClickHouse/ClickHouse/pull/9760) ([Pavel Kovalenko](https://github.com/Jokser))
- If `set multiple_joins_rewriter_version = 2` enables second version of multiple JOIN rewrites that keeps not clashed column names as is. It supports multiple JOINs with `USING` and allow `select *` for JOINs with subqueries. [#9739](https://github.com/ClickHouse/ClickHouse/pull/9739) ([Artem Zuikov](https://github.com/4ertus2))
- Implementation of "non-blocking" alter for StorageMergeTree [#9606](https://github.com/ClickHouse/ClickHouse/pull/9606) ([alesapin](https://github.com/alesapin))
- Add MergeTree full support for DiskS3 [#9646](https://github.com/ClickHouse/ClickHouse/pull/9646) ([Pavel Kovalenko](https://github.com/Jokser))
- Extend `splitByString` to support empty strings as separators. [#9742](https://github.com/ClickHouse/ClickHouse/pull/9742) ([hcz](https://github.com/hczhcz))
- Add a `timestamp_ns` column to `system.trace_log`. It contains a high-definition timestamp of the trace event, and allows to build timelines of thread profiles ("flame charts"). [#9696](https://github.com/ClickHouse/ClickHouse/pull/9696) ([Alexander Kuzmenkov](https://github.com/akuzm))
- When the setting `send_logs_level` is enabled, avoid intermixing of log messages and query progress. [#9634](https://github.com/ClickHouse/ClickHouse/pull/9634) ([Azat Khuzhin](https://github.com/azat))
- Added support of `MATERIALIZE TTL IN PARTITION`. [#9581](https://github.com/ClickHouse/ClickHouse/pull/9581) ([Vladimir Chebotarev](https://github.com/excitoon))
- Support complex types inside Avro nested fields [#10502](https://github.com/ClickHouse/ClickHouse/pull/10502) ([Andrew Onyshchuk](https://github.com/oandrew))

#### パフォーマンス改善 {#performance-improvement-11}

- Partial MergeJoinの右テーブルに対する挿入ロジックを改善しました。[#10467](https://github.com/ClickHouse/ClickHouse/pull/10467) ([Artem Zuikov](https://github.com/4ertus2))
- 行指向フォーマットのパフォーマンスを改善しました(狭いテーブルの場合、CSVで10%以上、Avroで35%以上の向上)。[#10503](https://github.com/ClickHouse/ClickHouse/pull/10503) ([Andrew Onyshchuk](https://github.com/oandrew))
- IN演算子の右側に明示的に定義された集合があり、左側にタプルがあるクエリのパフォーマンスを改善しました。[#10385](https://github.com/ClickHouse/ClickHouse/pull/10385) ([Anton Popov](https://github.com/CurtizJ))
- HashJoinのハッシュテーブルで使用するメモリを削減しました。[#10416](https://github.com/ClickHouse/ClickHouse/pull/10416) ([Artem Zuikov](https://github.com/4ertus2))
- StorageDictionary上での特殊なHashJoinを実装しました。`dictGet()`関数をJOINで書き換えることができます。これ自体は後方互換性がありますが、一部のインストール環境では[#8400](https://github.com/ClickHouse/ClickHouse/issues/8400)が顕在化する可能性があります。[#10133](https://github.com/ClickHouse/ClickHouse/pull/10133) ([Artem Zuikov](https://github.com/4ertus2))
- ターゲットテーブルがサポートしている場合、マテリアライズドビューの並列挿入を有効にしました。[#10052](https://github.com/ClickHouse/ClickHouse/pull/10052) ([vxider](https://github.com/Vxider))
- 単調関数を使用したインデックス解析のパフォーマンスを改善しました。[#9607](https://github.com/ClickHouse/ClickHouse/pull/9607)[#10026](https://github.com/ClickHouse/ClickHouse/pull/10026) ([Anton Popov](https://github.com/CurtizJ))
- SSE2またはSSE4.2 SIMD命令を使用して、ブルームフィルタのトークン化を高速化しました。[#9968](https://github.com/ClickHouse/ClickHouse/pull/9968) ([Vasily Nemkov](https://github.com/Enmk))
- `IN`演算子の右側に明示的に定義された集合があるクエリのパフォーマンスを改善しました。これによりバージョン20.3でのパフォーマンス低下が修正されます。[#9740](https://github.com/ClickHouse/ClickHouse/pull/9740) ([Anton Popov](https://github.com/CurtizJ))
- clickhouse-copierが各パーティションを複数の部分に分割し、それらを独立してコピーするようになりました。[#9075](https://github.com/ClickHouse/ClickHouse/pull/9075) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- より多くの集約メソッドを追加しました。例えば、TPC-Hクエリ1は`FixedHashMap<UInt16, AggregateDataPtr>`を選択し、25%のパフォーマンス向上を実現します。[#9829](https://github.com/ClickHouse/ClickHouse/pull/9829) ([Amos Bird](https://github.com/amosbird))
- pre-limit変換で複数のストリームに対して単一の行カウンタを使用します。これにより、`limit`はあるが`order by`がないクエリ(`select f(x) from (select x from t limit 1000000000)`など)でパイプラインストリームを統合することを回避し、後続の処理で複数のスレッドを使用できるようになります。[#9602](https://github.com/ClickHouse/ClickHouse/pull/9602) ([Nikolai Kochetov](https://github.com/KochetovNicolai))


#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-15}

- Use a fork of AWS SDK libraries from ClickHouse-Extras [#10527](https://github.com/ClickHouse/ClickHouse/pull/10527) ([Pavel Kovalenko](https://github.com/Jokser))
- Add integration tests for new ALTER RENAME COLUMN query. [#10654](https://github.com/ClickHouse/ClickHouse/pull/10654) ([vzakaznikov](https://github.com/vzakaznikov))
- Fix possible signed integer overflow in invocation of function `now64` with wrong arguments. This fixes [#8973](https://github.com/ClickHouse/ClickHouse/issues/8973) [#10511](https://github.com/ClickHouse/ClickHouse/pull/10511) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Split fuzzer and sanitizer configurations to make build config compatible with Oss-fuzz. [#10494](https://github.com/ClickHouse/ClickHouse/pull/10494) ([kyprizel](https://github.com/kyprizel))
- Fixes for clang-tidy on clang-10. [#10420](https://github.com/ClickHouse/ClickHouse/pull/10420) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Display absolute paths in error messages. Otherwise KDevelop fails to navigate to correct file and opens a new file instead. [#10434](https://github.com/ClickHouse/ClickHouse/pull/10434) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added `ASAN_OPTIONS` environment variable to investigate errors in CI stress tests with Address sanitizer. [#10440](https://github.com/ClickHouse/ClickHouse/pull/10440) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Enable ThinLTO for clang builds (experimental). [#10435](https://github.com/ClickHouse/ClickHouse/pull/10435) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Remove accidential dependency on Z3 that may be introduced if the system has Z3 solver installed. [#10426](https://github.com/ClickHouse/ClickHouse/pull/10426) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Move integration tests docker files to docker/ directory. [#10335](https://github.com/ClickHouse/ClickHouse/pull/10335) ([Ilya Yatsishin](https://github.com/qoega))
- Allow to use `clang-10` in CI. It ensures that [#10238](https://github.com/ClickHouse/ClickHouse/issues/10238) is fixed. [#10384](https://github.com/ClickHouse/ClickHouse/pull/10384) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update OpenSSL to upstream master. Fixed the issue when TLS connections may fail with the message `OpenSSL SSL_read: error:14094438:SSL routines:ssl3_read_bytes:tlsv1 alert internal error` and `SSL Exception: error:2400006E:random number generator::error retrieving entropy`. The issue was present in version 20.1. [#8956](https://github.com/ClickHouse/ClickHouse/pull/8956) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix clang-10 build. [#10238](https://github.com/ClickHouse/ClickHouse/issues/10238) [#10370](https://github.com/ClickHouse/ClickHouse/pull/10370) ([Amos Bird](https://github.com/amosbird))
- Add performance test for [Parallel INSERT for materialized view](https://github.com/ClickHouse/ClickHouse/pull/10052). [#10345](https://github.com/ClickHouse/ClickHouse/pull/10345) ([vxider](https://github.com/Vxider))
- Fix flaky test `test_settings_constraints_distributed.test_insert_clamps_settings`. [#10346](https://github.com/ClickHouse/ClickHouse/pull/10346) ([Vitaly Baranov](https://github.com/vitlibar))
- Add util to test results upload in CI ClickHouse [#10330](https://github.com/ClickHouse/ClickHouse/pull/10330) ([Ilya Yatsishin](https://github.com/qoega))
- Convert test results to JSONEachRow format in junit_to_html tool [#10323](https://github.com/ClickHouse/ClickHouse/pull/10323) ([Ilya Yatsishin](https://github.com/qoega))
- Update cctz. [#10215](https://github.com/ClickHouse/ClickHouse/pull/10215) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Allow to create HTML report from the purest JUnit XML report. [#10247](https://github.com/ClickHouse/ClickHouse/pull/10247) ([Ilya Yatsishin](https://github.com/qoega))
- Update the check for minimal compiler version. Fix the root cause of the issue [#10250](https://github.com/ClickHouse/ClickHouse/issues/10250) [#10256](https://github.com/ClickHouse/ClickHouse/pull/10256) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Initial support for live view tables over distributed [#10179](https://github.com/ClickHouse/ClickHouse/pull/10179) ([vzakaznikov](https://github.com/vzakaznikov))
- Fix (false) MSan report in MergeTreeIndexFullText. The issue first appeared in [#9968](https://github.com/ClickHouse/ClickHouse/issues/9968). [#10801](https://github.com/ClickHouse/ClickHouse/pull/10801) ([alexey-milovidov](https://github.com/alexey-milovidov))
- clickhouse-docker-util [#10151](https://github.com/ClickHouse/ClickHouse/pull/10151) ([filimonov](https://github.com/filimonov))
- Update pdqsort to recent version [#10171](https://github.com/ClickHouse/ClickHouse/pull/10171) ([Ivan](https://github.com/abyss7))
- Update libdivide to v3.0 [#10169](https://github.com/ClickHouse/ClickHouse/pull/10169) ([Ivan](https://github.com/abyss7))
- Add check with enabled polymorphic parts. [#10086](https://github.com/ClickHouse/ClickHouse/pull/10086) ([Anton Popov](https://github.com/CurtizJ))
- Add cross-compile build for FreeBSD. This fixes [#9465](https://github.com/ClickHouse/ClickHouse/issues/9465) [#9643](https://github.com/ClickHouse/ClickHouse/pull/9643) ([Ivan](https://github.com/abyss7))
- Add performance test for [#6924](https://github.com/ClickHouse/ClickHouse/issues/6924) [#6980](https://github.com/ClickHouse/ClickHouse/pull/6980) ([filimonov](https://github.com/filimonov))
- Add support of `/dev/null` in the `File` engine for better performance testing [#8455](https://github.com/ClickHouse/ClickHouse/pull/8455) ([Amos Bird](https://github.com/amosbird))
- Move all folders inside /dbms one level up [#9974](https://github.com/ClickHouse/ClickHouse/pull/9974) ([Ivan](https://github.com/abyss7))
- Add a test that checks that read from MergeTree with single thread is performed in order. Addition to [#9670](https://github.com/ClickHouse/ClickHouse/issues/9670) [#9762](https://github.com/ClickHouse/ClickHouse/pull/9762) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix the `00964_live_view_watch_events_heartbeat.py` test to avoid race condition. [#9944](https://github.com/ClickHouse/ClickHouse/pull/9944) ([vzakaznikov](https://github.com/vzakaznikov))
- Fix integration test `test_settings_constraints` [#9962](https://github.com/ClickHouse/ClickHouse/pull/9962) ([Vitaly Baranov](https://github.com/vitlibar))
- Every function in its own file, part 12. [#9922](https://github.com/ClickHouse/ClickHouse/pull/9922) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added performance test for the case of extremely slow analysis of array of tuples. [#9872](https://github.com/ClickHouse/ClickHouse/pull/9872) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update zstd to 1.4.4. It has some minor improvements in performance and compression ratio. If you run replicas with different versions of ClickHouse you may see reasonable error messages `Data after merge is not byte-identical to data on another replicas.` with explanation. These messages are Ok and you should not worry. [#10663](https://github.com/ClickHouse/ClickHouse/pull/10663) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix TSan report in `system.stack_trace`. [#9832](https://github.com/ClickHouse/ClickHouse/pull/9832) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Removed dependency on `clock_getres`. [#9833](https://github.com/ClickHouse/ClickHouse/pull/9833) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added identifier names check with clang-tidy. [#9799](https://github.com/ClickHouse/ClickHouse/pull/9799) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update "builder" docker image. This image is not used in CI but is useful for developers. [#9809](https://github.com/ClickHouse/ClickHouse/pull/9809) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Remove old `performance-test` tool that is no longer used in CI. `clickhouse-performance-test` is great but now we are using way superior tool that is doing comparison testing with sophisticated statistical formulas to achieve confident results regardless to various changes in environment. [#9796](https://github.com/ClickHouse/ClickHouse/pull/9796) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added most of clang-static-analyzer checks. [#9765](https://github.com/ClickHouse/ClickHouse/pull/9765) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update Poco to 1.9.3 in preparation for MongoDB URI support. [#6892](https://github.com/ClickHouse/ClickHouse/pull/6892) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Fix build with `-DUSE_STATIC_LIBRARIES=0 -DENABLE_JEMALLOC=0` [#9651](https://github.com/ClickHouse/ClickHouse/pull/9651) ([Artem Zuikov](https://github.com/4ertus2))
- For change log script, if merge commit was cherry-picked to release branch, take PR name from commit description. [#9708](https://github.com/ClickHouse/ClickHouse/pull/9708) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Support `vX.X-conflicts` tag in backport script. [#9705](https://github.com/ClickHouse/ClickHouse/pull/9705) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix `auto-label` for backporting script. [#9685](https://github.com/ClickHouse/ClickHouse/pull/9685) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Use libc++ in Darwin cross-build to make it consistent with native build. [#9665](https://github.com/ClickHouse/ClickHouse/pull/9665) ([Hui Wang](https://github.com/huiwang))
- Fix flacky test `01017_uniqCombined_memory_usage`. Continuation of [#7236](https://github.com/ClickHouse/ClickHouse/issues/7236). [#9667](https://github.com/ClickHouse/ClickHouse/pull/9667) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix build for native macOS Clang compiler [#9649](https://github.com/ClickHouse/ClickHouse/pull/9649) ([Ivan](https://github.com/abyss7))
- Allow to add various glitches around `pthread_mutex_lock`, `pthread_mutex_unlock` functions. [#9635](https://github.com/ClickHouse/ClickHouse/pull/9635) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add support for `clang-tidy` in `packager` script. [#9625](https://github.com/ClickHouse/ClickHouse/pull/9625) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add ability to use unbundled msgpack. [#10168](https://github.com/ClickHouse/ClickHouse/pull/10168) ([Azat Khuzhin](https://github.com/azat))





## ClickHouseリリース v20.3 {#clickhouse-release-v203}

### ClickHouseリリース v20.3.21.2-lts, 2020-11-02 {#clickhouse-release-v203212-lts-2020-11-02}

#### バグ修正 {#bug-fix-33}

- sharding_key内のdictGetを修正(および類似の箇所、すなわち関数コンテキストが永続的に保存される場合)。[#16205](https://github.com/ClickHouse/ClickHouse/pull/16205) ([Azat Khuzhin](https://github.com/azat))。
- クエリに`WHERE`、`PREWHERE`、`GLOBAL IN`が含まれる場合の`Distributed`テーブルからのクエリで誤った空の結果が返される問題を修正。[#15792](https://github.com/ClickHouse/ClickHouse/issues/15792)を修正。[#15933](https://github.com/ClickHouse/ClickHouse/pull/15933) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- `TSV/CSVWithNames`形式におけるヘッダーの欠落または過剰な出力を修正。[#12504](https://github.com/ClickHouse/ClickHouse/issues/12504)を修正。[#13343](https://github.com/ClickHouse/ClickHouse/pull/13343) ([Azat Khuzhin](https://github.com/azat))。

### ClickHouseリリース v20.3.20.6-lts, 2020-10-09 {#clickhouse-release-v203206-lts-2020-10-09}

#### バグ修正 {#bug-fix-34}

- `MOVE`または`REPLACE PARTITION`の後、まれに`DETACH`または`DROP PARTITION`の後に、存在しないパートを待機してミューテーションがハングする可能性がありました。修正されました。[#15724](https://github.com/ClickHouse/ClickHouse/pull/15724)、[#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix))。
- `MySQL`エンジンの同じテーブルに対する多数のサブクエリを含むクエリのハングを修正。以前は、クエリ内に同じ`MySQL`テーブルへのサブクエリが16個を超える場合、永久にハングしていました。[#15299](https://github.com/ClickHouse/ClickHouse/pull/15299) ([Anton Popov](https://github.com/CurtizJ))。
- Mergeテーブルに対するJOINを含むクエリでのGROUP BY内の'Unknown identifier'エラーを修正。[#15242](https://github.com/ClickHouse/ClickHouse/pull/15242) ([Artem Zuikov](https://github.com/4ertus2))。
- サブクエリにfinalizeAggregation関数が含まれる場合に述語プッシュダウンが機能するように修正。[#14847](https://github.com/ClickHouse/ClickHouse/issues/14847)を修正。[#14937](https://github.com/ClickHouse/ClickHouse/pull/14937) ([filimonov](https://github.com/filimonov))。
- 同時実行される`ALTER ... REPLACE/MOVE PARTITION ...`クエリがデッドロックを引き起こす可能性がありました。修正されました。[#13626](https://github.com/ClickHouse/ClickHouse/pull/13626) ([tavplubix](https://github.com/tavplubix))。

### ClickHouseリリース v20.3.19.4-lts, 2020-09-18 {#clickhouse-release-v203194-lts-2020-09-18}

#### バグ修正 {#bug-fix-35}


- クエリ対象のカラムが`DEFAULT`式を持ち、その式が別の`DEFAULT`を持つカラムに依存しており、そのカラムがSELECTクエリに含まれず、ディスク上にも存在しない場合に発生する`SELECT`クエリの稀なエラーを修正しました。[#14531](https://github.com/ClickHouse/ClickHouse/issues/14531)を部分的に修正します。[#14845](https://github.com/ClickHouse/ClickHouse/pull/14845) ([alesapin](https://github.com/alesapin))。
- 代入式にNullableカラムと定数値(例:`UPDATE x = 42`)を使用した`ALTER UPDATE`ミューテーションが、カラムの不正な値やセグメンテーション違反を引き起こすバグを修正しました。[#13634](https://github.com/ClickHouse/ClickHouse/issues/13634)、[#14045](https://github.com/ClickHouse/ClickHouse/issues/14045)を修正します。[#14646](https://github.com/ClickHouse/ClickHouse/pull/14646) ([alesapin](https://github.com/alesapin))。
- 結果カラムの誤った小数点スケールによって引き起こされるDecimal型の乗算結果の誤りを修正しました。[#14603](https://github.com/ClickHouse/ClickHouse/pull/14603) ([Artem Zuikov](https://github.com/4ertus2))。

#### 改善 {#improvement-17}

- コンパクトパートでカスタムコーデックをサポートしました。[#12183](https://github.com/ClickHouse/ClickHouse/pull/12183) ([Anton Popov](https://github.com/CurtizJ))。

### ClickHouseリリース v20.3.18.10-lts、2020-09-08 {#clickhouse-release-v2031810-lts-2020-09-08}

#### バグ修正 {#bug-fix-36}

- `PipelineExecutor`自体で例外が発生した場合にクエリの実行を停止するようにしました。これにより、稀に発生する可能性のあるクエリのハングを防ぐことができます。[#14334](https://github.com/ClickHouse/ClickHouse/issues/14334)の続きです。[#14402](https://github.com/ClickHouse/ClickHouse/pull/14402) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- キャッシュディクショナリがソースから存在する値ではなくデフォルト値を返すことがある動作を修正しました。[#13624](https://github.com/ClickHouse/ClickHouse/pull/13624) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- データベース名またはテーブル名にドットが含まれている場合のusers.xmlからの行ポリシーの解析を修正しました。[#5779](https://github.com/ClickHouse/ClickHouse/issues/5779)、[#12527](https://github.com/ClickHouse/ClickHouse/issues/12527)を修正します。[#13199](https://github.com/ClickHouse/ClickHouse/pull/13199) ([Vitaly Baranov](https://github.com/vitlibar))。
- CAST(Nullable(String), Enum())を修正しました。[#12745](https://github.com/ClickHouse/ClickHouse/pull/12745) ([Azat Khuzhin](https://github.com/azat))。
- `text_log`のデータ競合を修正しました。これは実際のバグには対応していません。[#9726](https://github.com/ClickHouse/ClickHouse/pull/9726) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### 改善 {#improvement-18}

- 長いクエリに対する誤ったエラーを修正しました。正しいクエリに対して`Max query size exceeded`以外の構文エラーが発生する可能性がありました。[#13928](https://github.com/ClickHouse/ClickHouse/pull/13928) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- parseDateTimeBestEffortOrNull/Zero関数で値が完全に解析されない場合にNULL/ゼロを返すようにしました。[#7876](https://github.com/ClickHouse/ClickHouse/issues/7876)を修正します。[#11653](https://github.com/ClickHouse/ClickHouse/pull/11653) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### パフォーマンス改善 {#performance-improvement-12}

- LowCardinalityを使用した非常に短いクエリをわずかに最適化しました。[#14129](https://github.com/ClickHouse/ClickHouse/pull/14129) ([Anton Popov](https://github.com/CurtizJ))。

#### ビルド/テスト/パッケージング改善 {#buildtestingpackaging-improvement-16}


- clang-10への移行後にHashTableで発生したUBSanレポート（nullptrへのゼロ加算）を修正。[#10638](https://github.com/ClickHouse/ClickHouse/pull/10638) ([alexey-milovidov](https://github.com/alexey-milovidov))。

### ClickHouseリリース v20.3.17.173-lts, 2020-08-15 {#clickhouse-release-v20317173-lts-2020-08-15}

#### バグ修正 {#bug-fix-37}

- StorageMergeと`set enable_optimize_predicate_expression=1`を使用したJOINでのクラッシュを修正。[#13679](https://github.com/ClickHouse/ClickHouse/pull/13679) ([Artem Zuikov](https://github.com/4ertus2))。
- `NULL`要素を含むタプルの比較における無効な戻り値の型を修正。修正内容: [#12461](https://github.com/ClickHouse/ClickHouse/issues/12461)。[#13420](https://github.com/ClickHouse/ClickHouse/pull/13420) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 定数カラムとプライマリキーの`ORDER BY`プレフィックスを使用したクエリを修正。[#13396](https://github.com/ClickHouse/ClickHouse/pull/13396) ([Anton Popov](https://github.com/CurtizJ))。
- roundUpToPowerOfTwoOrZero()において、MSBが設定された数値に対して渡された数値を返すように修正。[#13234](https://github.com/ClickHouse/ClickHouse/pull/13234) ([Azat Khuzhin](https://github.com/azat))。

### ClickHouseリリース v20.3.16.165-lts 2020-08-10 {#clickhouse-release-v20316165-lts-2020-08-10}

#### バグ修正 {#bug-fix-38}


* `parseDateTimeBestEffort` 関数に Unix タイムスタンプを引数として渡した場合に発生していたエラーを修正しました。これにより [#13362](https://github.com/ClickHouse/ClickHouse/issues/13362) が解消されました。 [#13441](https://github.com/ClickHouse/ClickHouse/pull/13441) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `NaN` 値を含む Float 型に対して呼び出された `uniqExact`、`topK`、`sumDistinct` などの集約関数における、潜在的なパフォーマンス低下およびわずかに不正確な結果を修正しました。また、デバッグビルドで `assert` が発生する問題の原因にもなっていました。これにより [#12491](https://github.com/ClickHouse/ClickHouse/issues/12491) が修正されました。[#13254](https://github.com/ClickHouse/ClickHouse/pull/13254)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* リテラルの NULL ではない nullable な constexpr を条件に取る `if` 関数を修正しました。[#12463](https://github.com/ClickHouse/ClickHouse/issues/12463) を解決します。 [#13226](https://github.com/ClickHouse/ClickHouse/pull/13226)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 配列要素が Nullable であり、配列添字も Nullable である場合の `arrayElement` 関数におけるアサートを修正しました。これにより [#12172](https://github.com/ClickHouse/ClickHouse/issues/12172) が解決されます。 [#13224](https://github.com/ClickHouse/ClickHouse/pull/13224) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* ローカルレプリカからの `SELECT` に対するスレッド数の不要な制限を修正しました。 [#12840](https://github.com/ClickHouse/ClickHouse/pull/12840) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `WITH TOTALS` を含むクエリで出現する可能性のあった、データ中の余分なオーバーフロー行を修正しました。 [#12747](https://github.com/ClickHouse/ClickHouse/pull/12747) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `IN` 句で関数として解釈される大きなタプルに関するパフォーマンスを修正しました。ユーザーが何らかのよく分からない理由で `WHERE x IN (1, 2, ...)` ではなく `WHERE x IN tuple(1, 2, ...)` と記述するケースです。 [#12700](https://github.com/ClickHouse/ClickHouse/pull/12700) ([Anton Popov](https://github.com/CurtizJ)).
* input&#95;format&#95;parallel&#95;parsing のメモリトラッキングを修正（スレッドをグループにアタッチすることで対応）。[#12672](https://github.com/ClickHouse/ClickHouse/pull/12672) ([Azat Khuzhin](https://github.com/azat))。
* [#12293](https://github.com/ClickHouse/ClickHouse/issues/12293) の修正により、サブクエリに WITH 句が含まれている場合でも述語をプッシュダウンできるようになりました。[#12663](https://github.com/ClickHouse/ClickHouse/pull/12663)（[Winter Zhang](https://github.com/zhang2014)）。
* [#10572](https://github.com/ClickHouse/ClickHouse/issues/10572) の修正: 定数式を含む Bloom フィルターインデックスを修正しました。[#12659](https://github.com/ClickHouse/ClickHouse/pull/12659)（[Winter Zhang](https://github.com/zhang2014)）。
* ブローカーが利用不能な場合などに StorageKafka で発生する SIGSEGV を修正しました。 [#12658](https://github.com/ClickHouse/ClickHouse/pull/12658) ([Azat Khuzhin](https://github.com/azat)).
* キャッシュレイアウトを使用する外部辞書で、サーバーのクラッシュを引き起こす可能性のあったレースコンディションを修正しました。 [#12566](https://github.com/ClickHouse/ClickHouse/pull/12566) ([alesapin](https://github.com/alesapin)).
* `enable_mixed_granularity_parts=1` のときに `ALTER DELETE` クエリを実行すると既存のパーツが破損してしまうバグを修正しました。 [#12536](https://github.com/ClickHouse/ClickHouse/issues/12536) を解決します。 [#12543](https://github.com/ClickHouse/ClickHouse/pull/12543) ([alesapin](https://github.com/alesapin))。
* 無効な数の引数が指定された場合の `in` 関数の例外メッセージを改善しました。 [#12529](https://github.com/ClickHouse/ClickHouse/pull/12529) ([Anton Popov](https://github.com/CurtizJ)).
* コンパクトパーツからの読み取り時のパフォーマンス問題を修正しました。 [#12492](https://github.com/ClickHouse/ClickHouse/pull/12492) ([Anton Popov](https://github.com/CurtizJ)).
* `text_log` が有効な場合に発生するデッドロックを修正しました。[#12452](https://github.com/ClickHouse/ClickHouse/pull/12452) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* StorageMerge で発生する可能性のあったセグメンテーションフォルトを修正しました。[#12054](https://github.com/ClickHouse/ClickHouse/issues/12054) をクローズしました。 [#12401](https://github.com/ClickHouse/ClickHouse/pull/12401)（[tavplubix](https://github.com/tavplubix)）。
* `-State` と `Nullable` 引数を持つ集約関数に対する `TOTALS/ROLLUP/CUBE` を修正しました。これにより [#12163](https://github.com/ClickHouse/ClickHouse/issues/12163) が解決されました。 [#12376](https://github.com/ClickHouse/ClickHouse/pull/12376) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `WITH FILL` 修飾子における列の順序処理を修正しました。以前は、`ORDER BY` ステートメントで指定した列の順序が反映されていませんでした。 [#12306](https://github.com/ClickHouse/ClickHouse/pull/12306) ([Anton Popov](https://github.com/CurtizJ)).
* 仮想カラム（`Merge` テーブルの `_table` など）やシステムテーブルの「index」カラム（`system.tables` からクエリする際にデータベース名でフィルタする場合など）でデータをフィルタする式があり、その式が `Nullable` 型を返す場合に「bad cast」例外が発生しないようにしました。これにより [#12166](https://github.com/ClickHouse/ClickHouse/issues/12166) が修正されました。 [#12305](https://github.com/ClickHouse/ClickHouse/pull/12305)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `TrieDictionary` のロードに失敗した場合にエラーを表示するようにしました。 [#12290](https://github.com/ClickHouse/ClickHouse/pull/12290) ([Vitaly Baranov](https://github.com/vitlibar)).
* 関数 `arrayFill` が空配列に対して誤って動作し、クラッシュにつながる可能性がありました。これにより [#12263](https://github.com/ClickHouse/ClickHouse/issues/12263) が修正されました。 [#12279](https://github.com/ClickHouse/ClickHouse/pull/12279)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `LowCardinality` 型に対する共通型への変換を実装しました。これにより、`LowCardinality` 型の列とそれ以外の列を持つテーブル同士で UNION ALL を実行できるようになります。これにより [#8212](https://github.com/ClickHouse/ClickHouse/issues/8212) および [#4342](https://github.com/ClickHouse/ClickHouse/issues/4342) が修正されます。[#12275](https://github.com/ClickHouse/ClickHouse/pull/12275)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `StorageFile` への複数の連続した挿入時に、特定の型に対してヘッダーが複数回書き込まれてしまう不具合を修正しました。これにより [#6155](https://github.com/ClickHouse/ClickHouse/issues/6155) が修正されました。[#12197](https://github.com/ClickHouse/ClickHouse/pull/12197)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* UInt8 値が 0 または 1 以外の場合の論理関数の動作を修正しました。 [#12196](https://github.com/ClickHouse/ClickHouse/pull/12196) ([Alexander Kazakov](https://github.com/Akazz)).
* GROUP BY における単射関数の削除時に実行される `dictGet` 引数チェックを修正。 [#12179](https://github.com/ClickHouse/ClickHouse/pull/12179) ([Azat Khuzhin](https://github.com/azat)).
* `ALTER DELETE` において、条件が NULL と評価されるとレコードが削除されてしまう誤ったロジックを修正しました。これにより [#9088](https://github.com/ClickHouse/ClickHouse/issues/9088) が解決されます。この変更は [#12106](https://github.com/ClickHouse/ClickHouse/issues/12106) をクローズします。[#12153](https://github.com/ClickHouse/ClickHouse/pull/12153)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* エイリアスが存在する場合に、外部 DBMS（例: MySQL、ODBC）へ送信するクエリの変換処理が正しく行われるよう修正しました。これにより [#12032](https://github.com/ClickHouse/ClickHouse/issues/12032) が解決されました。[#12151](https://github.com/ClickHouse/ClickHouse/pull/12151)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 整数除算で発生する可能性のあったオーバーフローを修正しました。これにより [#12119](https://github.com/ClickHouse/ClickHouse/issues/12119) が解決されます。[#12140](https://github.com/ClickHouse/ClickHouse/pull/12140)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `greatCircleDistance` と `geoDistance` における無限ループが発生する可能性のある問題を修正しました。これにより [#12117](https://github.com/ClickHouse/ClickHouse/issues/12117) が修正されました。 [#12137](https://github.com/ClickHouse/ClickHouse/pull/12137)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `system.query_log`、`metric_log` などのシステムログ、または `engine=Buffer` の基になるテーブルに対して結合やサブクエリを使用するマテリアライズドビューで発生する `There is no query` 例外を回避しました。 [#12120](https://github.com/ClickHouse/ClickHouse/pull/12120) ([filimonov](https://github.com/filimonov)).
* スレッド総数に対する誤った制限により `UNION` を含む SELECT クエリのパフォーマンスが低下していた問題を修正しました。[#12030](https://github.com/ClickHouse/ClickHouse/issues/12030) を修正。[#12103](https://github.com/ClickHouse/ClickHouse/pull/12103)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `-StateResample` コンビネータで発生していたセグメンテーションフォールトを修正しました。 [#12092](https://github.com/ClickHouse/ClickHouse/pull/12092) ([Anton Popov](https://github.com/CurtizJ)).
* `VIEW` からの `SELECT` に対してスレッド数を不必要に制限していた問題を修正。 [#11937](https://github.com/ClickHouse/ClickHouse/issues/11937) を修正。 [#12085](https://github.com/ClickHouse/ClickHouse/pull/12085)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `PREWHERE` に誤った型を使用した場合に発生し得るクラッシュを修正しました。 [#12053](https://github.com/ClickHouse/ClickHouse/issues/12053)、[#12060](https://github.com/ClickHouse/ClickHouse/issues/12060) を解決しました。 [#12060](https://github.com/ClickHouse/ClickHouse/pull/12060)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `LowCardinality` 型に対する関数 `defaultValueOfArgumentType` で発生していた `Expected single dictionary argument for function` エラーを修正しました。[#11808](https://github.com/ClickHouse/ClickHouse/issues/11808) を解決。[#12056](https://github.com/ClickHouse/ClickHouse/pull/12056) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `Tuple(LowCardinality)` 引数を持つ高階関数で発生していた `Cannot capture column` エラーを修正しました。 [#9766](https://github.com/ClickHouse/ClickHouse/issues/9766) の修正。 [#12055](https://github.com/ClickHouse/ClickHouse/pull/12055) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* データベースを読み込む際に、テーブルのメタデータを並列に解析するようにしました。これにより、多数のテーブルが存在する場合のサーバー起動時の遅延が解消されます。 [#12045](https://github.com/ClickHouse/ClickHouse/pull/12045) ([tavplubix](https://github.com/tavplubix)).
* Enum 型に対して `topK` 集約関数が Enum 型を返すようにしました。これにより、[#3740](https://github.com/ClickHouse/ClickHouse/issues/3740) を修正しました。[#12043](https://github.com/ClickHouse/ClickHouse/pull/12043)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 制約が定数式かどうかを検証するように制約チェックを修正しました。これにより [#11360](https://github.com/ClickHouse/ClickHouse/issues/11360) が解決されました。 [#12042](https://github.com/ClickHouse/ClickHouse/pull/12042) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `Nullable` 列を含むタプルの誤った比較を修正しました。 [#11985](https://github.com/ClickHouse/ClickHouse/issues/11985) を解決。 [#12039](https://github.com/ClickHouse/ClickHouse/pull/12039)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `FixedString` 型でサイズが異なる引数を指定して関数 `if` を呼び出した場合に、誤った結果が返されたりクラッシュする可能性があった問題を修正しました。これにより [#11362](https://github.com/ClickHouse/ClickHouse/issues/11362) が解決されました。 [#12021](https://github.com/ClickHouse/ClickHouse/pull/12021) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 返り値の式として `neighbor` 関数だけを含むクエリで、オフセットに `-9223372036854775808` を指定してこの関数を呼び出すと、結果が空になることがありました。この問題を修正しました [#11367](https://github.com/ClickHouse/ClickHouse/issues/11367)。 [#12019](https://github.com/ClickHouse/ClickHouse/pull/12019)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* クラッシュを引き起こす可能性のあった `generateRandom` における配列サイズオーバーフローの不具合を修正しました。これにより [#11371](https://github.com/ClickHouse/ClickHouse/issues/11371) が解決されます。[#12013](https://github.com/ClickHouse/ClickHouse/pull/12013)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 浮動小数点例外が発生し得る不具合を修正しました。これにより [#11378](https://github.com/ClickHouse/ClickHouse/issues/11378) がクローズされました。[#12005](https://github.com/ClickHouse/ClickHouse/pull/12005)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* サーバー起動時のログメッセージにおける誤った設定名を修正しました。 [#11997](https://github.com/ClickHouse/ClickHouse/pull/11997) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `Values` フォーマットで発生していた `Query parameter was not set` エラーを修正しました。[#11918](https://github.com/ClickHouse/ClickHouse/issues/11918) を解決します。 [#11936](https://github.com/ClickHouse/ClickHouse/pull/11936) ([tavplubix](https://github.com/tavplubix))。
* クエリ内での置換に使用するエイリアス（パラメータ化クエリ）を保持するようにしました。これにより [#11914](https://github.com/ClickHouse/ClickHouse/issues/11914) が修正されました。 [#11916](https://github.com/ClickHouse/ClickHouse/pull/11916) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* DateTime64 のパース時に発生し得た浮動小数点例外を修正しました。これにより [#11374](https://github.com/ClickHouse/ClickHouse/issues/11374) が解決されました。 [#11875](https://github.com/ClickHouse/ClickHouse/pull/11875) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `HTTP` インターフェイス経由のメモリ計上の不具合を修正（`wait_end_of_query=1` の場合に影響が大きくなる可能性があります）。 [#11840](https://github.com/ClickHouse/ClickHouse/pull/11840) ([Azat Khuzhin](https://github.com/azat)).
* 条件に NULL が含まれる場合に `if()` が誤った結果を返す問題を修正。 [#11807](https://github.com/ClickHouse/ClickHouse/pull/11807) ([Artem Zuikov](https://github.com/4ertus2)).
* 等価かどうかをチェックする前に、ZooKeeper に保存されているメタデータをパースするようにしました。 [#11739](https://github.com/ClickHouse/ClickHouse/pull/11739) ([Azat Khuzhin](https://github.com/azat)).
* エイリアスを含む `ORDER BY` 句と組み合わせて使用した場合の `LIMIT n WITH TIES` の挙動を修正しました。 [#11689](https://github.com/ClickHouse/ClickHouse/pull/11689) ([Anton Popov](https://github.com/CurtizJ)).
* cache dictionary における未初期化メモリの読み取りが発生する可能性のある問題を修正。 [#10834](https://github.com/ClickHouse/ClickHouse/pull/10834) ([alexey-milovidov](https://github.com/alexey-milovidov)).

#### パフォーマンス改善 {#performance-improvement-13}

- リテラルを含むIN演算子でインデックスが使用されず、v19.3頃に導入されたパフォーマンス低下を修正しました。[#10574](https://github.com/ClickHouse/ClickHouse/issues/10574)を修正します。[#12062](https://github.com/ClickHouse/ClickHouse/pull/12062) ([nvartolomei](https://github.com/nvartolomei))。

### ClickHouse リリース v20.3.12.112-lts 2020-06-25 {#clickhouse-release-v20312112-lts-2020-06-25}

#### バグ修正 {#bug-fix-39}


* `prewhere` 条件で `Nullable` カラムを使用した際に発生する、まれなクラッシュを修正しました。[#11608](https://github.com/ClickHouse/ClickHouse/issues/11608) に続く修正です。[#11869](https://github.com/ClickHouse/ClickHouse/pull/11869) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 高階関数内での arrayJoin の使用を許可しないようにしました。これが原因でプロトコル同期が破綻する問題が発生していました。この変更により [#3933](https://github.com/ClickHouse/ClickHouse/issues/3933) がクローズされます。[#11846](https://github.com/ClickHouse/ClickHouse/pull/11846)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* クエリで過剰な数のスレッドを使用していた問題を修正。 [#11788](https://github.com/ClickHouse/ClickHouse/pull/11788) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `SELECT *, xyz.*` のようなクエリで、本来はエラーになるべきところが成功してしまう予期しない挙動を修正。 [#11753](https://github.com/ClickHouse/ClickHouse/pull/11753) ([hexiaoting](https://github.com/hexiaoting)).
* メタデータの ALTER 実行中は、レプリケーションのフェッチ処理がキャンセルされるようになりました。 [#11744](https://github.com/ClickHouse/ClickHouse/pull/11744) ([alesapin](https://github.com/alesapin)).
* Values 入力フォーマットでの複合リテラルの誤った型推論により発生していた LOGICAL&#95;ERROR を修正しました。 [#11732](https://github.com/ClickHouse/ClickHouse/pull/11732) ([tavplubix](https://github.com/tavplubix)).
* 定数列に対する `ORDER BY ... WITH FILL` を修正。 [#11697](https://github.com/ClickHouse/ClickHouse/pull/11697) ([Anton Popov](https://github.com/CurtizJ)).
* XDBC bridge と通信する際に適切なタイムアウトを渡すようにしました。最近、bridge の生存確認およびメタ情報の受信時にタイムアウトが考慮されていませんでした。 [#11690](https://github.com/ClickHouse/ClickHouse/pull/11690) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `system.mutations` が不正な状態になる不具合を修正しました。サーバーのレプリケーションキューには依然として `MUTATE_PART` タスクが存在し、それらを実行しようとしているにもかかわらず、ミューテーション全体がすでに完了しているように表示される場合がありました。この修正は [#11611](https://github.com/ClickHouse/ClickHouse/issues/11611) を解決します。 [#11681](https://github.com/ClickHouse/ClickHouse/pull/11681)（[alesapin](https://github.com/alesapin)）。
* 大文字小文字を区別しないフラグ付き正規表現のサポートを追加しました。これにより、[#11101](https://github.com/ClickHouse/ClickHouse/issues/11101) と [#11506](https://github.com/ClickHouse/ClickHouse/issues/11506) の問題が修正されました。[#11649](https://github.com/ClickHouse/ClickHouse/pull/11649)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 行レベルセキュリティが設定されている場合、trivial count クエリの最適化を無効化しました。以前のバージョンでは、ユーザーはフィルタリング後の件数ではなく、テーブル内の全レコード数を取得できていました。これにより [#11352](https://github.com/ClickHouse/ClickHouse/issues/11352) を修正しました。[#11644](https://github.com/ClickHouse/ClickHouse/pull/11644)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* String 型用ブルームフィルタ（データスキッピングインデックス）の不具合を修正。 [#11638](https://github.com/ClickHouse/ClickHouse/pull/11638) ([Azat Khuzhin](https://github.com/azat)).
* `Nullable` カラムを `PREWHERE` 句で使用した場合に発生するまれなクラッシュを修正（おそらく [#11572](https://github.com/ClickHouse/ClickHouse/issues/11572) と関連しています）。[#11608](https://github.com/ClickHouse/ClickHouse/pull/11608)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `Buffer` テーブルからのサンプリング読み取りを行うクエリで発生する `Block structure mismatch` エラーを修正しました。 [#11602](https://github.com/ClickHouse/ClickHouse/pull/11602) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* exception.code() % 256 = 0 の場合に clickhouse-client が誤った終了コードを返す問題を修正しました。 [#11601](https://github.com/ClickHouse/ClickHouse/pull/11601) ([filimonov](https://github.com/filimonov)).
* サーバー起動時に出力される「Mark cache size was lowered」というログメッセージの軽微な誤りを修正しました。これにより [#11399](https://github.com/ClickHouse/ClickHouse/issues/11399) がクローズされました。 [#11589](https://github.com/ClickHouse/ClickHouse/pull/11589) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `PREWHERE column in (subquery)` と `ARRAY JOIN` を含むクエリで発生する `Size of offsets does not match size of column` エラーを修正しました。 [#11580](https://github.com/ClickHouse/ClickHouse/pull/11580) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* HTTP セッション内のすべてのクエリで同じ `query_id` が使用されていました。この問題を修正しました。 [#11578](https://github.com/ClickHouse/ClickHouse/pull/11578) ([tavplubix](https://github.com/tavplubix)).
* これにより、clickhouse-server の Docker コンテナはサーバーの生存確認時に IPv6 を優先して使用するようになります。 [#11550](https://github.com/ClickHouse/ClickHouse/pull/11550) ([Ivan Starkov](https://github.com/istarkov)).
* `<node>` の shard&#95;num/replica&#95;num を修正（use&#95;compact&#95;format&#95;in&#95;distributed&#95;parts&#95;names が動作しなくなっていた問題を修正）。 [#11528](https://github.com/ClickHouse/ClickHouse/pull/11528) ([Azat Khuzhin](https://github.com/azat)).
* -State 関数を用いた集約の実行中に例外がスローされた場合に発生するメモリリークを修正しました。これにより [#8995](https://github.com/ClickHouse/ClickHouse/issues/8995) が解決されます。[#11496](https://github.com/ClickHouse/ClickHouse/pull/11496)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 別名が修飾列名を上書きしてしまうことで、分散クエリで誤った結果が返される問題を修正しました。 [#9672](https://github.com/ClickHouse/ClickHouse/issues/9672) [#9714](https://github.com/ClickHouse/ClickHouse/issues/9714) を修正。 [#9972](https://github.com/ClickHouse/ClickHouse/pull/9972)（[Artem Zuikov](https://github.com/4ertus2)）。

### ClickHouse release v20.3.11.97-lts 2020-06-10 {#clickhouse-release-v2031197-lts-2020-06-10}

#### 新機能 {#new-feature-9}

- ClickHouseは辞書ソースのタイムアウトを自身で制御するようになりました。キャッシュ辞書の設定に2つの新しい設定が追加されました：`strict_max_lifetime_seconds`（デフォルトは`max_lifetime`）と`query_wait_timeout_milliseconds`（デフォルトは1分）です。最初の設定は`allow_read_expired_keys`設定と併用すると有用です（有効期限が大幅に切れたキーの読み取りを禁止するため）。[#10337](https://github.com/ClickHouse/ClickHouse/pull/10337) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。

#### バグ修正 {#bug-fix-40}


* `min_bytes_to_use_direct_io` が有効で、かつ PREWHERE が有効で SAMPLE を使用している場合、またはスレッド数が多い場合に発生する可能性のあるエラー `Data compressed with different methods` を修正。これにより [#11539](https://github.com/ClickHouse/ClickHouse/issues/11539) が修正されました。 [#11540](https://github.com/ClickHouse/ClickHouse/pull/11540)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* コーデックが返す圧縮サイズを修正。 [#11448](https://github.com/ClickHouse/ClickHouse/pull/11448) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 非リテラル引数を持つ圧縮コーデックをカラムに設定した場合にサーバーがクラッシュする問題を修正。 [#11365](https://github.com/ClickHouse/ClickHouse/issues/11365) を修正。 [#11431](https://github.com/ClickHouse/ClickHouse/pull/11431) ([alesapin](https://github.com/alesapin))。
* pointInPolygon が点として NaN を扱う場合の動作を修正。[#11375](https://github.com/ClickHouse/ClickHouse/issues/11375) を修正。[#11421](https://github.com/ClickHouse/ClickHouse/pull/11421)（[Alexey Ilyukhov](https://github.com/livace)）。
* LowCardinality(T) および Nullable(T) を含む JOIN で発生するクラッシュを修正。 [#11380](https://github.com/ClickHouse/ClickHouse/issues/11380). [#11414](https://github.com/ClickHouse/ClickHouse/pull/11414) ([Artem Zuikov](https://github.com/4ertus2)).
* 誤った `USING` キーに対して返されるエラーコードを修正。 [#11373](https://github.com/ClickHouse/ClickHouse/issues/11373)。 [#11404](https://github.com/ClickHouse/ClickHouse/pull/11404) ([Artem Zuikov](https://github.com/4ertus2))。
* 緯度・経度の範囲外の引数に対する `geohashesInBox` の処理を修正しました。 [#11403](https://github.com/ClickHouse/ClickHouse/pull/11403) ([Vasily Nemkov](https://github.com/Enmk)).
* `joinGet()` 関数のエラーメッセージを改善。 [#11389](https://github.com/ClickHouse/ClickHouse/pull/11389) ([Artem Zuikov](https://github.com/4ertus2)).
* 外部ソートと `LIMIT` を含むクエリで発生する可能性のあった `Pipeline stuck` エラーを修正しました。[#11359](https://github.com/ClickHouse/ClickHouse/issues/11359) を修正。[#11366](https://github.com/ClickHouse/ClickHouse/pull/11366)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* ReplicatedMergeTree でのパーツ送信時に取得していた冗長なロックを削除。 [#11354](https://github.com/ClickHouse/ClickHouse/pull/11354) ([alesapin](https://github.com/alesapin)).
* マルチラインモードにおける clickhouse-client の `\G`（縦方向出力）サポートを修正しました。これにより [#9933](https://github.com/ClickHouse/ClickHouse/issues/9933) が解決されました。 [#11350](https://github.com/ClickHouse/ClickHouse/pull/11350)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* StorageJoin からの（JOIN を使用しない）直接 SELECT 時に発生するクラッシュと、NULL 可能性の誤判定を修正。 [#11340](https://github.com/ClickHouse/ClickHouse/pull/11340) ([Artem Zuikov](https://github.com/4ertus2)).
* `quantilesExactWeightedArray` のクラッシュを修正。 [#11337](https://github.com/ClickHouse/ClickHouse/pull/11337) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `ALTER` クエリでメタデータを変更する前にマージが停止するようになりました。 [#11335](https://github.com/ClickHouse/ClickHouse/pull/11335) ([alesapin](https://github.com/alesapin)).
* `parallel_view_processing = 1` に設定した場合の `MATERIALIZED VIEW` への書き込みを再び並列で実行できるようにしました。 [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241) を修正。 [#11330](https://github.com/ClickHouse/ClickHouse/pull/11330) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 抽出された JSON 内の文字列に、対応する `}` や `]` がない `{` または `[` が含まれている場合の `visitParamExtractRaw` の動作を修正。 [#11318](https://github.com/ClickHouse/ClickHouse/pull/11318) ([Ewout](https://github.com/devwout))。
* ThreadPool における非常にまれな競合状態（レースコンディション）を修正しました。 [#11314](https://github.com/ClickHouse/ClickHouse/pull/11314) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 変換処理で未初期化メモリが使用される可能性のある問題を修正しました。例: `SELECT toIntervalSecond(now64())`。 [#11311](https://github.com/ClickHouse/ClickHouse/pull/11311) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* プライマリキーに `Array` 型の列が含まれており、クエリがこの列に対して `empty` または `notEmpty` 関数でフィルタしている場合にインデックス解析が機能しない問題を修正しました。この修正により [#11286](https://github.com/ClickHouse/ClickHouse/issues/11286) が解決されます。[#11303](https://github.com/ClickHouse/ClickHouse/pull/11303)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `max_network_bandwidth`、`max_execution_speed`、または `priority` 設定によってクエリがスロットルされている場合に、クエリ速度の推定が不正確になり、`min_execution_speed` の制限が機能しない、あるいは誤って機能してしまう不具合を修正しました。`timeout_before_checking_execution_speed` のデフォルト値を非ゼロに変更しました。ゼロのままだと、`min_execution_speed` および `max_execution_speed` の設定が効果を持たないためです。これにより、[#11297](https://github.com/ClickHouse/ClickHouse/issues/11297) が修正されます。これにより、[#5732](https://github.com/ClickHouse/ClickHouse/issues/5732) が修正されます。これにより、[#6228](https://github.com/ClickHouse/ClickHouse/issues/6228) が修正されます。操作性の改善: `clickhouse-client` において、例外メッセージがプログレスバーと連結されて表示されてしまうことを回避しました。 [#11296](https://github.com/ClickHouse/ClickHouse/pull/11296) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* Protobuf フォーマットで不正なデータを読み込んだ際にクラッシュする問題を修正します。これにより [#5957](https://github.com/ClickHouse/ClickHouse/issues/5957) および [#11203](https://github.com/ClickHouse/ClickHouse/issues/11203) の問題が解決されます。[#11258](https://github.com/ClickHouse/ClickHouse/pull/11258)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `cache-dictionary` が（期限切れキーしか存在しない場合に）正しい値ではなくデフォルト値を返してしまうバグを修正しました。これは文字列型フィールドのみに影響します。 [#11233](https://github.com/ClickHouse/ClickHouse/pull/11233) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 内部クエリで定数を使用している `VIEW` から読み取る際に発生する `Block structure mismatch in QueryPipeline` エラーを修正しました。[#11181](https://github.com/ClickHouse/ClickHouse/issues/11181) を解決。 [#11205](https://github.com/ClickHouse/ClickHouse/pull/11205)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 発生し得る例外 `Invalid status for associated output` を修正。 [#11200](https://github.com/ClickHouse/ClickHouse/pull/11200) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `Array(Array(LowCardinality))` 型のキャプチャされた引数を取る高階関数で発生する可能性がある `Cannot capture column` エラーを修正。 [#11185](https://github.com/ClickHouse/ClickHouse/pull/11185) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 一部のバックエンドにおいてキーが 1000 個を超える場合に失敗する可能性があった S3 のグロブ処理を修正しました。 [#11179](https://github.com/ClickHouse/ClickHouse/pull/11179) ([Vladimir Chebotarev](https://github.com/excitoon)).
* バックグラウンドでのマージ処理中に変更される列（`SummingMergeTree`、`AggregatingMergeTree`、および `TTL GROUP BY` の場合）に依存するデータスキッピングインデックスは、正しく計算されていませんでした。この問題は、インデックスの計算をマージ完了後に行うように変更し、マージ後のデータに対してインデックスを計算することで修正されました。 [#11162](https://github.com/ClickHouse/ClickHouse/pull/11162) ([Azat Khuzhin](https://github.com/azat))。
* 単純なクエリ向けの過剰なスレッド予約を修正しました（パイプラインの変更により一部で動作しなくなっていた、スレッド数削減のための最適化）。[#11114](https://github.com/ClickHouse/ClickHouse/pull/11114) ([Azat Khuzhin](https://github.com/azat))
* 分散クエリに対する述語最適化機能（`enable_optimize_predicate_expression=1`）で、`HAVING` 句を含むクエリ（つまり、イニシエータサーバー側でのフィルタリングが必要な場合）において、式の順序を保持するようにして修正し（これだけで問題は解消され）、さらにアグリゲータがインデックスではなくカラム名を使用するように強制しました。修正対象: [#10613](https://github.com/ClickHouse/ClickHouse/issues/10613), [#11413](https://github.com/ClickHouse/ClickHouse/issues/11413)。[#10621](https://github.com/ClickHouse/ClickHouse/pull/10621)（[Azat Khuzhin](https://github.com/azat)）。
* コミット再試行ロジックを導入し、まれに発生するオフセットコミットの失敗時に Kafka から重複データを受け取る可能性を低減しました。 [#9884](https://github.com/ClickHouse/ClickHouse/pull/9884) ([filimonov](https://github.com/filimonov)).

#### パフォーマンス改善 {#performance-improvement-14}

- 外部ディクショナリを読み取る関数の各呼び出しごとに、ディクショナリの取得とアクセス権の確認を一度だけ実行するように変更。[#10928](https://github.com/ClickHouse/ClickHouse/pull/10928) ([Vitaly Baranov](https://github.com/vitlibar))。

#### ビルド/テスト/パッケージング改善 {#buildtestingpackaging-improvement-17}

- 不安定な統合テストを複数修正。[#11355](https://github.com/ClickHouse/ClickHouse/pull/11355) ([alesapin](https://github.com/alesapin))。

### ClickHouse リリース v20.3.10.75-lts 2020-05-23 {#clickhouse-release-v2031075-lts-2020-05-23}

#### バグ修正 {#bug-fix-41}


* 何もファイナライズされない場合、ミューテーションのファイナライズ処理タスクでのログ出力を行わないようにしました。 [#11109](https://github.com/ClickHouse/ClickHouse/pull/11109) ([alesapin](https://github.com/alesapin)).
* `parseDateTime64BestEffort` の引数の解決に関する不具合を修正しました。 [#11038](https://github.com/ClickHouse/ClickHouse/pull/11038) ([Vasily Nemkov](https://github.com/Enmk)).
* メソッド `getRawData()` において誤っていた生データサイズを修正しました。 [#10964](https://github.com/ClickHouse/ClickHouse/pull/10964) ([Igr](https://github.com/ObjatieGroba)).
* 二段階集約処理における、バージョン 20.1 とそれ以前のバージョンとの非互換性を修正しました。この非互換性は、イニシエータノードとリモートノードで異なるバージョンの ClickHouse が使用されており、`GROUP BY` の結果セットのサイズが大きく、単一の `String` 型フィールドのみで集約が行われる場合に発生します。その結果、1 つのキーに対してマージされていない複数の行が結果セットに含まれる可能性がありました。[#10952](https://github.com/ClickHouse/ClickHouse/pull/10952) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `Distributed` テーブルにおけるタプルの後方互換性を修正しました。 [#10889](https://github.com/ClickHouse/ClickHouse/pull/10889) ([Anton Popov](https://github.com/CurtizJ)).
* `StringHashTable` において、存在しないキーにアクセスした際に発生していた `SIGSEGV` を修正しました。 [#10870](https://github.com/ClickHouse/ClickHouse/pull/10870) ([Azat Khuzhin](https://github.com/azat)).
* `ReplicatedMergeTree` において、あるレプリカが非アクティブになった後もそのレプリカを待ち続けてしまい、`OPTIMIZE` クエリ中の一部の `ALTER` がハングする可能性があったバグを修正しました。 [#10849](https://github.com/ClickHouse/ClickHouse/pull/10849) ([tavplubix](https://github.com/tavplubix)).
* `Block::sortColumns()` 実行後のカラム順が正しくなるよう修正しました。 [#10826](https://github.com/ClickHouse/ClickHouse/pull/10826) ([Azat Khuzhin](https://github.com/azat)).
* 識別子のクォートを行わない設定時に発生していた `ODBC` ブリッジの問題を修正しました。[#7984](https://github.com/ClickHouse/ClickHouse/issues/7984) を解消します。[#10821](https://github.com/ClickHouse/ClickHouse/pull/10821)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `DateLUT` で `UBSan` および `MSan` により検出された問題を修正しました。 [#10798](https://github.com/ClickHouse/ClickHouse/pull/10798) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* キー条件における誤った型変換を修正しました。 [#6287](https://github.com/ClickHouse/ClickHouse/issues/6287) の修正。 [#10791](https://github.com/ClickHouse/ClickHouse/pull/10791) ([Andrew Onyshchuk](https://github.com/oandrew))
* `parallel_view_processing` の動作を修正しました。これにより、例外が発生した場合でも、すべての `MATERIALIZED VIEW` への挿入処理が例外なく完了するようになりました。 [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241) を修正しました。 [#10757](https://github.com/ClickHouse/ClickHouse/pull/10757)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `-State` と組み合わせた場合の `-OrNull` および `-OrDefault` コンビネータの動作を修正しました。 [#10741](https://github.com/ClickHouse/ClickHouse/pull/10741) ([hcz](https://github.com/hczhcz)).
* ネストされた型を扱う `generateRandom` で発生していたクラッシュを修正しました。[#10583](https://github.com/ClickHouse/ClickHouse/issues/10583) を解決。[#10734](https://github.com/ClickHouse/ClickHouse/pull/10734)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* マージ後に発生する可能性があった、`SummingMergeTree` における `LowCardinality(FixedString)` キー列のデータ破損を修正しました。 [#10489](https://github.com/ClickHouse/ClickHouse/issues/10489) を解決。 [#10721](https://github.com/ClickHouse/ClickHouse/pull/10721)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 関数 `h3EdgeAngle` でバッファオーバーフローが発生する可能性のあった問題を修正しました。 [#10711](https://github.com/ClickHouse/ClickHouse/pull/10711) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 消えてしまう `totals` の問題を修正しました。クエリに `JOIN` またはサブクエリがあり、その外側に `WHERE` 条件がある場合、`totals` がフィルタリングされてしまうことがありました。 [#10674](https://github.com/ClickHouse/ClickHouse/issues/10674) を修正します。 [#10698](https://github.com/ClickHouse/ClickHouse/pull/10698)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 1つのクエリ内で同一の集合を使用する `IN` 演算子を複数回使用していた問題を修正しました。 [#10686](https://github.com/ClickHouse/ClickHouse/pull/10686) ([Anton Popov](https://github.com/CurtizJ)).
* `readonly=2` かつ `cancel_http_readonly_queries_on_client_close=1` の場合に、クライアントが接続を閉じた際に HTTP リクエストがハングしてしまう不具合を修正しました。あわせて [#7939](https://github.com/ClickHouse/ClickHouse/issues/7939)、[#7019](https://github.com/ClickHouse/ClickHouse/issues/7019)、[#7736](https://github.com/ClickHouse/ClickHouse/issues/7736)、[#7091](https://github.com/ClickHouse/ClickHouse/issues/7091) を修正しました。 [#10684](https://github.com/ClickHouse/ClickHouse/pull/10684)（[tavplubix](https://github.com/tavplubix)）。
* `AggregateTransform` コンストラクタのパラメータ順序を修正しました。 [#10667](https://github.com/ClickHouse/ClickHouse/pull/10667) ([palasonic1](https://github.com/palasonic1)).
* `distributed_aggregation_memory_efficient` が有効な場合にリモートクエリが並列実行されない問題を修正しました。 [#10655](https://github.com/ClickHouse/ClickHouse/issues/10655) を修正。 [#10664](https://github.com/ClickHouse/ClickHouse/pull/10664)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `LIMIT` を含むクエリで誤った行数が返される可能性のあった問題を修正しました。[#10566](https://github.com/ClickHouse/ClickHouse/issues/10566)、[#10709](https://github.com/ClickHouse/ClickHouse/issues/10709) を修正。[#10660](https://github.com/ClickHouse/ClickHouse/pull/10660) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* パーツ数が多いテーブルで同時に実行される `ALTER` がロックされてしまう不具合を修正しました。 [#10659](https://github.com/ClickHouse/ClickHouse/pull/10659) ([alesapin](https://github.com/alesapin)).
* `SYSTEM DROP DNS CACHE` クエリによって、特定の IP アドレスからの接続がユーザーに許可されているかを確認するために使用されるキャッシュも誤って削除されてしまう不具合を修正しました。 [#10608](https://github.com/ClickHouse/ClickHouse/pull/10608) ([tavplubix](https://github.com/tavplubix)).
* 依存するテーブルを含むクエリの場合に、`MATERIALIZED VIEW` の内部クエリ内で誤ったスカラー結果が返される問題を修正しました。 [#10603](https://github.com/ClickHouse/ClickHouse/pull/10603) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* デフォルト式の型がカラム型と異なる `ALIAS` カラムに対する `SELECT` を修正しました。 [#10563](https://github.com/ClickHouse/ClickHouse/pull/10563) ([Azat Khuzhin](https://github.com/azat)).
* DateTime64 型と String 型の値の比較を実装しました。 [#10560](https://github.com/ClickHouse/ClickHouse/pull/10560) ([Vasily Nemkov](https://github.com/Enmk))。
* マージでコンパクトパーツを別のコンパクトパーツに統合した後に、一部の場合で発生する可能性があったインデックス破損を修正しました。 [#10531](https://github.com/ClickHouse/ClickHouse/pull/10531) ([Anton Popov](https://github.com/CurtizJ)).
* すべてのパーツに対する mutation が完了しているにもかかわらず、`is_done=0` の状態でハングしてしまう問題を修正しました。 [#10526](https://github.com/ClickHouse/ClickHouse/pull/10526) ([alesapin](https://github.com/alesapin)).
* `UTC` からのオフセットに小数を含むタイムゾーンにおいて、Unix エポック開始時点でオーバーフローが発生していた問題を修正しました。この修正は [#9335](https://github.com/ClickHouse/ClickHouse/issues/9335) を解決します。[#10513](https://github.com/ClickHouse/ClickHouse/pull/10513)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `Distributed` ストレージの不適切なシャットダウンの問題を修正しました。 [#10491](https://github.com/ClickHouse/ClickHouse/pull/10491) ([Azat Khuzhin](https://github.com/azat)).
* `simpleLinearRegression` において、大きな整数に対する数値オーバーフローを修正しました。 [#10474](https://github.com/ClickHouse/ClickHouse/pull/10474) ([hcz](https://github.com/hczhcz)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-18}

- LZ4ライブラリのUBSanレポートを修正しました。[#10631](https://github.com/ClickHouse/ClickHouse/pull/10631) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- clang-10ビルドを修正しました。[#10238](https://github.com/ClickHouse/ClickHouse/issues/10238)。[#10370](https://github.com/ClickHouse/ClickHouse/pull/10370) ([Amos Bird](https://github.com/amosbird))。
- `max_rows_to_sort`設定に関する失敗テストを追加しました。[#10268](https://github.com/ClickHouse/ClickHouse/pull/10268) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 入力フォーマットにおける診断情報の出力に関する改善を追加しました。修正 [#10204](https://github.com/ClickHouse/ClickHouse/issues/10204)。[#10418](https://github.com/ClickHouse/ClickHouse/pull/10418) ([tavplubix](https://github.com/tavplubix))。
- clickhouse-server DockerイメージにCA証明書を追加しました。[#10476](https://github.com/ClickHouse/ClickHouse/pull/10476) ([filimonov](https://github.com/filimonov))。

#### バグ修正 {#bug-fix-42}

- エラー`the BloomFilter false positive must be a double number between 0 and 1`を修正しました [#10551](https://github.com/ClickHouse/ClickHouse/issues/10551)。[#10569](https://github.com/ClickHouse/ClickHouse/pull/10569) ([Winter Zhang](https://github.com/zhang2014))。

### ClickHouseリリース v20.3.8.53, 2020-04-23 {#clickhouse-release-v203853-2020-04-23}


#### バグ修正 {#bug-fix-43}

- UTCからの正負のオフセット間で変更されたタイムゾーン(例: Pacific/Kiritimati)に対するdatetime関数の誤った動作を修正しました。これにより [#7202](https://github.com/ClickHouse/ClickHouse/issues/7202) が修正されます [#10369](https://github.com/ClickHouse/ClickHouse/pull/10369) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `distributed_group_by_no_merge`が有効な場合に発生する可能性のあるセグメンテーション違反を修正しました(20.3.7.46で [#10131](https://github.com/ClickHouse/ClickHouse/issues/10131) により導入)。[#10399](https://github.com/ClickHouse/ClickHouse/pull/10399) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- `Array(Tuple(...))`データ型の誤ったフラット化を修正しました。これにより [#10259](https://github.com/ClickHouse/ClickHouse/issues/10259) が修正されます [#10390](https://github.com/ClickHouse/ClickHouse/pull/10390) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Aggregatorにおけるディスク予約を削除しました。これにより、正常に完了できる場合でも大規模な外部集約が失敗する可能性があるディスク領域予約のバグが修正されます [#10375](https://github.com/ClickHouse/ClickHouse/pull/10375) ([Azat Khuzhin](https://github.com/azat))
- `ReplicatedMergeTree`における`DROP`と`OPTIMIZE`の競合状態を修正しました。同時に`OPTIMIZE`クエリが実行されている場合、`DROP`がZooKeeperのレプリカパスにゴミを残す可能性がありました。[#10312](https://github.com/ClickHouse/ClickHouse/pull/10312) ([tavplubix](https://github.com/tavplubix))
- カラムのデフォルト値が変更された後にサーバーがテーブルをアタッチできないバグを修正しました。[#10441](https://github.com/ClickHouse/ClickHouse/pull/10441) ([alesapin](https://github.com/alesapin))
- テーブルの読み込み前にデータベースのアタッチが失敗した場合、メタデータディレクトリを削除しないようにしました。[#10442](https://github.com/ClickHouse/ClickHouse/pull/10442) ([Winter Zhang](https://github.com/zhang2014))
- クォーラムでデータが挿入された後、何らかの方法(DROP PARTITION、TTL)で削除され、INSERTがスタックするかSELECTで誤検知の例外が発生する複数のバグを修正しました。これにより [#9946](https://github.com/ClickHouse/ClickHouse/issues/9946) が修正されます [#10188](https://github.com/ClickHouse/ClickHouse/pull/10188) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- リモートクエリで発生する可能性があった`ConcatProcessor`における`Pipeline stuck`エラーを修正しました。[#10381](https://github.com/ClickHouse/ClickHouse/pull/10381) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- バッファからHashMapを読み取ろうとした際にコンパイルエラーを引き起こすHashTableの誤った動作を修正しました。[#10386](https://github.com/ClickHouse/ClickHouse/pull/10386) ([palasonic1](https://github.com/palasonic1))
- 複数のJOINで`count(*)`を使用できるようにしました。[#9853](https://github.com/ClickHouse/ClickHouse/issues/9853) を修正します [#10291](https://github.com/ClickHouse/ClickHouse/pull/10291) ([Artem Zuikov](https://github.com/4ertus2))
- `skip_unavailable_shards`よりも`fallback_to_stale_replicas`を優先するようにしました。そうしないと、両方の設定が指定され、最新のレプリカが存在しない場合にクエリが失敗します(@alex-zaitsevによるパッチ)。修正: [#2564](https://github.com/ClickHouse/ClickHouse/issues/2564)。[#10422](https://github.com/ClickHouse/ClickHouse/pull/10422) ([Azat Khuzhin](https://github.com/azat))
- ARRAY JOIN、ORDER BY、LIMITを含むクエリが不完全な結果を返す可能性がある問題を修正しました。これにより [#10226](https://github.com/ClickHouse/ClickHouse/issues/10226) が修正されます。作成者: [Vadim Plakhtinskiy](https://github.com/VadimPlh)。[#10427](https://github.com/ClickHouse/ClickHouse/pull/10427) ([alexey-milovidov](https://github.com/alexey-milovidov))
- BloomFilterインデックスを作成する際に引数の数と型をチェックするようにしました [#9623](https://github.com/ClickHouse/ClickHouse/issues/9623) [#10431](https://github.com/ClickHouse/ClickHouse/pull/10431) ([Winter Zhang](https://github.com/zhang2014))

#### パフォーマンス改善 {#performance-improvement-15}

- `IN`演算子の右側に明示的に定義された集合と左側にタプルを持つクエリのパフォーマンスを改善しました。これによりバージョン20.3でのパフォーマンス低下が修正されます。[#9740](https://github.com/ClickHouse/ClickHouse/pull/9740), [#10385](https://github.com/ClickHouse/ClickHouse/pull/10385) ([Anton Popov](https://github.com/CurtizJ))

### ClickHouseリリース v20.3.7.46, 2020-04-17 {#clickhouse-release-v203746-2020-04-17}

#### バグ修正 {#bug-fix-44}

- カンマ結合と名前付き結合が混在するクエリで発生する`Logical error: CROSS JOIN has expressions`エラーを修正しました。[#10311](https://github.com/ClickHouse/ClickHouse/pull/10311) ([Artem Zuikov](https://github.com/4ertus2))
- `max_bytes_before_external_group_by`を使用したクエリを修正しました。[#10302](https://github.com/ClickHouse/ClickHouse/pull/10302) ([Artem Zuikov](https://github.com/4ertus2))
- arrayJoin関数が存在する場合(特定のケース)のmove-to-prewhere最適化を修正しました。これにより[#10092](https://github.com/ClickHouse/ClickHouse/issues/10092)が修正されます。[#10195](https://github.com/ClickHouse/ClickHouse/pull/10195) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `allow_nondeterministic_mutations`設定により、ミューテーションにおける非決定的関数の使用制限を緩和する機能を追加しました。[#10186](https://github.com/ClickHouse/ClickHouse/pull/10186) ([filimonov](https://github.com/filimonov))

### ClickHouseリリース v20.3.6.40, 2020-04-16 {#clickhouse-release-v203640-2020-04-16}

#### 新機能 {#new-feature-10}

- `isConstant`関数を追加しました。この関数は引数が定数式であるかどうかを確認し、1または0を返します。開発、デバッグ、デモンストレーション目的での使用を想定しています。[#10198](https://github.com/ClickHouse/ClickHouse/pull/10198) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### バグ修正 {#bug-fix-45}


* `max_rows_to_group_by` と `group_by_overflow_mode = 'break'` 使用時に発生する `Pipeline stuck` エラーを修正。 [#10279](https://github.com/ClickHouse/ClickHouse/pull/10279) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* まれに発生しうる例外 `Cannot drain connections: cancel first` を修正。 [#10239](https://github.com/ClickHouse/ClickHouse/pull/10239) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* ClickHouse が ENGINE = Replicated* のテーブルに対してユーザーが ALTER UPDATE/DELETE を実行しようとした際に、「Unknown function lambda.」というエラーを返していた不具合を修正しました。非決定的関数のチェック処理が lambda 式を正しく扱うようになりました。 [#10237](https://github.com/ClickHouse/ClickHouse/pull/10237) ([Alexander Kazakov](https://github.com/Akazz))。
* Date 型に対する `generateRandom` 関数を修正しました。これにより [#9973](https://github.com/ClickHouse/ClickHouse/issues/9973) が解決されます。2106 年の日付が、旧スタイルのパーティション方式を用いる MergeTree テーブルに挿入されているにもかかわらず、パーティション名には 1970 年が使われている場合のエッジケースを修正しました。[#10218](https://github.com/ClickHouse/ClickHouse/pull/10218)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* View のテーブル定義と SELECT クエリが対応していない場合に、型変換を行うようにしました。これにより [#10180](https://github.com/ClickHouse/ClickHouse/issues/10180) および [#10022](https://github.com/ClickHouse/ClickHouse/issues/10022) が修正されました。 [#10217](https://github.com/ClickHouse/ClickHouse/pull/10217) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 曜日が火曜日または木曜日の場合の RFC-2822 形式の文字列に対して `parseDateTimeBestEffort` を修正しました。これにより [#10082](https://github.com/ClickHouse/ClickHouse/issues/10082) が解決されます。[#10214](https://github.com/ClickHouse/ClickHouse/pull/10214)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* JOIN 内の定数の列名が JOIN 外の定数の列名と衝突する可能性がある問題を修正。 [#10207](https://github.com/ClickHouse/ClickHouse/pull/10207) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `system.numbers` や `system.zeros` のような無限ソースから読み取る際、本来は LIMIT でクエリ実行が停止すべきにもかかわらず、無限に実行されてしまう可能性がある問題を修正。 [#10206](https://github.com/ClickHouse/ClickHouse/pull/10206) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* データベースが指定されていない場合に、アクセスチェック時には現在のデータベースを使用するよう修正。 [#10192](https://github.com/ClickHouse/ClickHouse/pull/10192) ([Vitaly Baranov](https://github.com/vitlibar))。
* INSERT into Distributed() 時に構造が一致しない場合、ブロックを変換するようにしました。 [#10135](https://github.com/ClickHouse/ClickHouse/pull/10135) ([Azat Khuzhin](https://github.com/azat)).
* プロセッサーパイプラインにおいて `extremes` が誤った結果となる可能性のある問題を修正。 [#10131](https://github.com/ClickHouse/ClickHouse/pull/10131) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* コンパクトパーツに対する特定の種類の `ALTER` を修正。[#10130](https://github.com/ClickHouse/ClickHouse/pull/10130)（[Anton Popov](https://github.com/CurtizJ)）。
* 新しいレプリカ作成時の誤った `index_granularity_bytes` チェックを修正。[#10098](https://github.com/ClickHouse/ClickHouse/issues/10098) を解決。[#10121](https://github.com/ClickHouse/ClickHouse/pull/10121)（[alesapin](https://github.com/alesapin)）。
* 下位テーブルと構造が異なる Distributed テーブルへの INSERT 時に発生していた SIGSEGV を修正。[#10105](https://github.com/ClickHouse/ClickHouse/pull/10105)（[Azat Khuzhin](https://github.com/azat)）。
* `JOIN` および `UNION ALL` を含むクエリで行が欠落する可能性のあった問題を修正しました。 [#9826](https://github.com/ClickHouse/ClickHouse/issues/9826)、[#10113](https://github.com/ClickHouse/ClickHouse/issues/10113) を修正。 [#10099](https://github.com/ClickHouse/ClickHouse/pull/10099)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 古い ClickHouse バージョンからアップデートした際に `/table/replicas/replica_name/metadata` ノードが存在しない場合に、レプリケートテーブルが正しく起動しない問題を修正しました。 [#10037](https://github.com/ClickHouse/ClickHouse/issues/10037) を修正。 [#10095](https://github.com/ClickHouse/ClickHouse/pull/10095)（[alesapin](https://github.com/alesapin)）。
* MySQL データベースエンジン向けに引数チェックを追加し、識別子引数をサポートしました。 [#10077](https://github.com/ClickHouse/ClickHouse/pull/10077) ([Winter Zhang](https://github.com/zhang2014))。
* localhost 上の ClickHouse サーバーをソースとする ClickHouse 辞書で発生するバグを修正しました。辞書とソースの型に互換性がない場合、このバグによってメモリ破損が発生する可能性があります。 [#10071](https://github.com/ClickHouse/ClickHouse/pull/10071) ([alesapin](https://github.com/alesapin)).
* スキップインデックスを含むテーブルに対する `CHECK TABLE` クエリのバグを修正。 [#10068](https://github.com/ClickHouse/ClickHouse/pull/10068) ([alesapin](https://github.com/alesapin)).
* エラー `Cannot clone block with columns because block has 0 columns ... While executing GroupingAggregatedTransform` を修正しました。これは、`distributed_aggregation_memory_efficient` の設定が有効な状態で、分散クエリが異なるシャードから異なるレベルの集計データ（単一レベル集計と 2 レベル集計が混在）を読み取る際に発生していました。 [#10063](https://github.com/ClickHouse/ClickHouse/pull/10063) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 末尾にゼロバイトを含む文字列キーに対する GROUP BY 実行時に発生し得たセグメンテーションフォルトを修正しました（[#8636](https://github.com/ClickHouse/ClickHouse/issues/8636), [#8925](https://github.com/ClickHouse/ClickHouse/issues/8925)）。 [#10025](https://github.com/ClickHouse/ClickHouse/pull/10025) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* リモートクエリ実行に使用されるスレッド数を修正しました（20.3 以降で発生していたパフォーマンス劣化）。これは、`Distributed` テーブルからのクエリがローカルシャードおよびリモートシャードで同時に実行された場合に発生していました。[#9965](https://github.com/ClickHouse/ClickHouse/issues/9965) を修正。[#9971](https://github.com/ClickHouse/ClickHouse/pull/9971)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 一部のデータベースに対するクエリ処理のある段階で、必要なテーブルが取得されない不具合を修正しました。 [#9699](https://github.com/ClickHouse/ClickHouse/issues/9699) を修正。 [#9949](https://github.com/ClickHouse/ClickHouse/pull/9949) ([achulkov2](https://github.com/achulkov2))。
* `JOIN` が `TOTALS` と共に使用された場合に発生する「Not found column in block」エラーを修正しました。[#9839](https://github.com/ClickHouse/ClickHouse/issues/9839) の修正。[#9939](https://github.com/ClickHouse/ClickHouse/pull/9939)（[Artem Zuikov](https://github.com/4ertus2)）。
* サーバーの起動時に `ON CLUSTER` DDL クエリがフリーズするバグを修正。[#9927](https://github.com/ClickHouse/ClickHouse/pull/9927)（[Gagan Arneja](https://github.com/garneja)）。
* `CREATE USER` コマンドで複数のホストを指定した際の解析処理を修正しました。例えば `CREATE USER user6 HOST NAME REGEXP 'lo.?*host', NAME REGEXP 'lo*host'` のようなケースです。 [#9924](https://github.com/ClickHouse/ClickHouse/pull/9924) ([Vitaly Baranov](https://github.com/vitlibar)).
* Join テーブルエンジンに対する `TRUNCATE` を修正（[#9917](https://github.com/ClickHouse/ClickHouse/issues/9917)）。 [#9920](https://github.com/ClickHouse/ClickHouse/pull/9920) ([Amos Bird](https://github.com/amosbird))。
* ALTER ステートメントで発生する &quot;scalar does not exist&quot; エラーを修正（[#9878](https://github.com/ClickHouse/ClickHouse/issues/9878)）。[#9904](https://github.com/ClickHouse/ClickHouse/pull/9904)（[Amos Bird](https://github.com/amosbird)）。
* `ReplicatedMergeTree` における DROP と OPTIMIZE 間のレースコンディションを修正。 [#9901](https://github.com/ClickHouse/ClickHouse/pull/9901) ([alesapin](https://github.com/alesapin))。
* `distributed_product_mode='local'` における修飾名の不具合を修正。 [#4756](https://github.com/ClickHouse/ClickHouse/issues/4756) を修正。 [#9891](https://github.com/ClickHouse/ClickHouse/pull/9891)（[Artem Zuikov](https://github.com/4ertus2)）。
* 設定 &#39;allow&#95;introspection&#95;functions&#39; に基づくイントロスペクション関数への権限付与の計算を修正。[#9840](https://github.com/ClickHouse/ClickHouse/pull/9840) ([Vitaly Baranov](https://github.com/vitlibar))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-19}

- 統合テスト`test_settings_constraints`を修正。[#9962](https://github.com/ClickHouse/ClickHouse/pull/9962) ([Vitaly Baranov](https://github.com/vitlibar))。
- `clock_getres`への依存関係を削除。[#9833](https://github.com/ClickHouse/ClickHouse/pull/9833) ([alexey-milovidov](https://github.com/alexey-milovidov))。

### ClickHouseリリース v20.3.5.21, 2020-03-27 {#clickhouse-release-v203521-2020-03-27}

#### バグ修正 {#bug-fix-46}

- 分散テーブルに対してPREWHEREとWHEREを含むクエリで`SET distributed_product_mode = 'local'`が設定されている場合の「同じエイリアスを持つ異なる式」エラーを修正。[#9871](https://github.com/ClickHouse/ClickHouse/pull/9871) ([Artem Zuikov](https://github.com/4ertus2))。
- 複合主キーを持つテーブルに対するミューテーションの過剰なメモリ消費を修正。これは[#9850](https://github.com/ClickHouse/ClickHouse/issues/9850)を修正。[#9860](https://github.com/ClickHouse/ClickHouse/pull/9860) ([alesapin](https://github.com/alesapin))。
- INSERTクエリにおいて、シャードは例外をスローする代わりに、イニシエーターから取得した設定をシャードの制約に合わせて調整するようになりました。この修正により、異なる制約を持つシャードにINSERTクエリを送信できるようになります。この変更は[#9447](https://github.com/ClickHouse/ClickHouse/issues/9447)の修正を改善。[#9852](https://github.com/ClickHouse/ClickHouse/pull/9852) ([Vitaly Baranov](https://github.com/vitlibar))。
- テーブルリストの外側(WHERE句内など)でCOMMA JOINを使用するサブクエリの場合の「COMMA to CROSS JOIN rewriterが有効でないか、クエリを書き換えられません」エラーを修正。[#9782](https://github.com/ClickHouse/ClickHouse/issues/9782)を修正。[#9830](https://github.com/ClickHouse/ClickHouse/pull/9830) ([Artem Zuikov](https://github.com/4ertus2))。
- クライアントで発生する可能性のある例外`Got 0 in totals chunk, expected 1`を修正。これは、右結合テーブルが0行の場合に`JOIN`を含むクエリで発生していました。例: `select * from system.one t1 join system.one t2 on t1.dummy = t2.dummy limit 0 FORMAT TabSeparated;`。[#9777](https://github.com/ClickHouse/ClickHouse/issues/9777)を修正。[#9823](https://github.com/ClickHouse/ClickHouse/pull/9823) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 型を変換できない場合のoptimize_skip_unused_shardsによるSIGSEGVを修正。[#9804](https://github.com/ClickHouse/ClickHouse/pull/9804) ([Azat Khuzhin](https://github.com/azat))。
- コンパクトパーツに対する`ALTER TABLE DELETE COLUMN`クエリの不具合を修正。[#9779](https://github.com/ClickHouse/ClickHouse/pull/9779) ([alesapin](https://github.com/alesapin))。
- max_distributed_connections(Processorsありおよびなし)を修正。[#9673](https://github.com/ClickHouse/ClickHouse/pull/9673) ([Azat Khuzhin](https://github.com/azat))。
- 関数引数のタイムゾーンが適切に使用されていなかったいくつかのケースを修正。[#9574](https://github.com/ClickHouse/ClickHouse/pull/9574) ([Vasily Nemkov](https://github.com/Enmk))。

#### 改善 {#improvement-19}

- 単一のスレッドで単一の順序付けられたパーツから読み取るため、ミューテーションからorder byステージを削除。また、ミューテーション内の行の順序がソートキーの順序で並んでおり、この順序が違反されていないことを確認するチェックを追加。[#9886](https://github.com/ClickHouse/ClickHouse/pull/9886) ([alesapin](https://github.com/alesapin))。

### ClickHouseリリース v20.3.4.10, 2020-03-20 {#clickhouse-release-v203410-2020-03-20}


#### バグ修正 {#bug-fix-47}

- このリリースには20.1.8.41のすべてのバグ修正も含まれています
- HTTP経由のクエリ(プロセッサパイプライン使用時)で`rows_before_limit_at_least`が欠落していた問題を修正しました。これにより[#9730](https://github.com/ClickHouse/ClickHouse/issues/9730)が修正されます。[#9757](https://github.com/ClickHouse/ClickHouse/pull/9757) ([Nikolai Kochetov](https://github.com/KochetovNicolai))

### ClickHouseリリース v20.3.3.6, 2020-03-17 {#clickhouse-release-v20336-2020-03-17}

#### バグ修正 {#bug-fix-48}

- このリリースには20.1.7.38のすべてのバグ修正も含まれています
- ユーザーが以前のバージョンでミューテーションを実行した場合にレプリケーションが機能しなくなるバグを修正しました。これにより[#9645](https://github.com/ClickHouse/ClickHouse/issues/9645)が修正されます。[#9652](https://github.com/ClickHouse/ClickHouse/pull/9652) ([alesapin](https://github.com/alesapin))。これによりバージョン20.3が再び後方互換性を持つようになります。
- `Distributed`テーブルへの`INSERT`クエリのファイルをよりコンパクトな形式で書き込むことを可能にする設定`use_compact_format_in_distributed_parts_names`を追加しました。これにより[#9647](https://github.com/ClickHouse/ClickHouse/issues/9647)が修正されます。[#9653](https://github.com/ClickHouse/ClickHouse/pull/9653) ([alesapin](https://github.com/alesapin))。これによりバージョン20.3が再び後方互換性を持つようになります。

### ClickHouseリリース v20.3.2.1, 2020-03-12 {#clickhouse-release-v20321-2020-03-12}

#### 後方互換性のない変更 {#backward-incompatible-change-9}


* 多数のレプリカを持つ `Distributed` テーブルにデータを送信する際に発生していた `file name too long` の問題を修正しました。サーバーログ内にレプリカの認証情報が表示されてしまっていた問題を修正しました。ディスク上のディレクトリ名の形式を `[shard{shard_index}[_replica{replica_index}]]` に変更しました。 [#8911](https://github.com/ClickHouse/ClickHouse/pull/8911) ([Mikhail Korotov](https://github.com/millb)) 新バージョンにアップグレードした後は、手作業による対応なしにダウングレードすることはできません。これは、古いサーバーバージョンが新しいディレクトリ形式を認識できないためです。ダウングレードしたい場合は、該当するディレクトリ名を手動で古い形式に変更する必要があります。この変更は、非同期の `INSERT` を `Distributed` テーブルに対して使用していた場合にのみ影響します。バージョン 20.3.3 では、新しい形式を段階的に有効化できる設定を導入する予定です。
* ミューテーションコマンドに対するレプリケーションログエントリの形式が変更されました。新しいバージョンをインストールする前に、既存のミューテーションの処理が完了するまで待つ必要があります。
* ソフトなメモリ割り当て上限を超えるたびに、N バイトごとにスタックトレースを `system.trace_log` にダンプするシンプルなメモリプロファイラを実装しました [#8765](https://github.com/ClickHouse/ClickHouse/pull/8765)（[Ivan](https://github.com/abyss7)） [#9472](https://github.com/ClickHouse/ClickHouse/pull/9472)（[alexey-milovidov](https://github.com/alexey-milovidov)）。`system.trace_log` のカラム名を `timer_type` から `trace_type` に変更しました。これにより、サードパーティのパフォーマンス解析およびフレームグラフ処理ツールの変更が必要になります。
* 内部スレッド番号の代わりに、すべての箇所で OS スレッド ID を使用するようにしました。これにより [#7477](https://github.com/ClickHouse/ClickHouse/issues/7477) が解決します。古い `clickhouse-client` は、設定 `send_logs_level` が有効なときにサーバーから送信されるログを受信できません。これは、構造化ログメッセージの名前と型が変更されたためです。一方で、異なるサーバーバージョン同士が、互いに異なる型のログを送信する可能性があります。`send_logs_level` 設定を使用しない場合は、気にする必要はありません。[#8954](https://github.com/ClickHouse/ClickHouse/pull/8954) ([alexey-milovidov](https://github.com/alexey-milovidov))
* `indexHint` 関数を削除 [#9542](https://github.com/ClickHouse/ClickHouse/pull/9542) ([alexey-milovidov](https://github.com/alexey-milovidov))
* `findClusterIndex`、`findClusterValue` 関数を削除しました。これにより [#8641](https://github.com/ClickHouse/ClickHouse/issues/8641) が修正されます。これらの関数を使用していた場合は、`clickhouse-feedback@yandex-team.com` までメールでご連絡ください [#9543](https://github.com/ClickHouse/ClickHouse/pull/9543)（[alexey-milovidov](https://github.com/alexey-milovidov)）
* `SELECT` サブクエリをデフォルト式として使用してカラムを作成したり追加したりすることは、現在では許可されていません。 [#9481](https://github.com/ClickHouse/ClickHouse/pull/9481) ([alesapin](https://github.com/alesapin))
* `JOIN` におけるサブクエリにエイリアス指定を必須化。 [#9274](https://github.com/ClickHouse/ClickHouse/pull/9274) ([Artem Zuikov](https://github.com/4ertus2))
* `ALTER MODIFY/ADD` クエリのロジックを改善しました。これにより、型を指定せずにカラムを `ADD` できなくなり、`MODIFY` でデフォルト式を変更してもカラムの型は変わらず、`MODIFY` で型を変更してもデフォルト式の値は失われなくなりました。[#8669](https://github.com/ClickHouse/ClickHouse/issues/8669) を修正。[#9227](https://github.com/ClickHouse/ClickHouse/pull/9227)（[alesapin](https://github.com/alesapin)）
* ログ設定の変更を反映するには、サーバーを再起動する必要があります。これは、サーバーが削除済みのログファイルにログを書き出し続けてしまうバグを回避するための一時的なワークアラウンドです（[#8696](https://github.com/ClickHouse/ClickHouse/issues/8696) を参照）。[#8707](https://github.com/ClickHouse/ClickHouse/pull/8707)（[Alexander Kuzmenkov](https://github.com/akuzm)）
* `experimental_use_processors` 設定はデフォルトで有効になっています。この設定により、新しいクエリパイプラインが使用されます。これは内部的なリファクタリングであり、外から見える挙動の変更はない想定です。もし何らかの問題が発生した場合は、値を 0 に戻してください。 [#8768](https://github.com/ClickHouse/ClickHouse/pull/8768) ([alexey-milovidov](https://github.com/alexey-milovidov))





#### 新機能 {#new-feature-11}

- `Avro`および`AvroConfluent`入出力フォーマットを追加 [#8571](https://github.com/ClickHouse/ClickHouse/pull/8571) ([Andrew Onyshchuk](https://github.com/oandrew)) [#8957](https://github.com/ClickHouse/ClickHouse/pull/8957) ([Andrew Onyshchuk](https://github.com/oandrew)) [#8717](https://github.com/ClickHouse/ClickHouse/pull/8717) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `cache`ディクショナリにおける期限切れキーのマルチスレッドおよび非ブロッキング更新(古いキーの読み取り許可をオプションで設定可能)。[#8303](https://github.com/ClickHouse/ClickHouse/pull/8303) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- クエリ`ALTER ... MATERIALIZE TTL`を追加。TTLによって期限切れデータを強制的に削除し、すべてのパートでTTLに関するメタ情報を再計算するミューテーションを実行します。[#8775](https://github.com/ClickHouse/ClickHouse/pull/8775) ([Anton Popov](https://github.com/CurtizJ))
- 必要に応じてHashJoinからMergeJoin(ディスク上)への切り替えを実装 [#9082](https://github.com/ClickHouse/ClickHouse/pull/9082) ([Artem Zuikov](https://github.com/4ertus2))
- `ALTER TABLE`に`MOVE PARTITION`コマンドを追加 [#4729](https://github.com/ClickHouse/ClickHouse/issues/4729) [#6168](https://github.com/ClickHouse/ClickHouse/pull/6168) ([Guillaume Tassery](https://github.com/YiuRULE))
- 設定ファイルからストレージ設定を動的に再読み込み可能に。[#8594](https://github.com/ClickHouse/ClickHouse/pull/8594) ([Vladimir Chebotarev](https://github.com/excitoon))
- `storage_policy`をより機能が豊富なものへ変更可能に。[#8107](https://github.com/ClickHouse/ClickHouse/pull/8107) ([Vladimir Chebotarev](https://github.com/excitoon))
- S3ストレージおよびテーブル関数でグロブ/ワイルドカードのサポートを追加。[#8851](https://github.com/ClickHouse/ClickHouse/pull/8851) ([Vladimir Chebotarev](https://github.com/excitoon))
- `FixedString(N)`データ型に対して`bitAnd`、`bitOr`、`bitXor`、`bitNot`を実装。[#9091](https://github.com/ClickHouse/ClickHouse/pull/9091) ([Guillaume Tassery](https://github.com/YiuRULE))
- 関数`bitCount`を追加。これにより[#8702](https://github.com/ClickHouse/ClickHouse/issues/8702)を修正。[#8708](https://github.com/ClickHouse/ClickHouse/pull/8708) ([alexey-milovidov](https://github.com/alexey-milovidov)) [#8749](https://github.com/ClickHouse/ClickHouse/pull/8749) ([ikopylov](https://github.com/ikopylov))
- 指定されたスキーマでランダムな行を生成する`generateRandom`テーブル関数を追加。任意のテストテーブルにデータを投入可能に。[#8994](https://github.com/ClickHouse/ClickHouse/pull/8994) ([Ilya Yatsishin](https://github.com/qoega))
- `JSONEachRowFormat`: オブジェクトがトップレベル配列で囲まれている特殊なケースをサポート。[#8860](https://github.com/ClickHouse/ClickHouse/pull/8860) ([Kruglov Pavel](https://github.com/Avogar))
- デフォルトで`ALIAS`式を持つカラムに依存する`DEFAULT`式を持つカラムの作成が可能に。[#9489](https://github.com/ClickHouse/ClickHouse/pull/9489) ([alesapin](https://github.com/alesapin))
- `clickhouse-obfuscator`でソースデータサイズを超える`--limit`の指定が可能に。データは異なるランダムシードで繰り返されます。[#9155](https://github.com/ClickHouse/ClickHouse/pull/9155) ([alexey-milovidov](https://github.com/alexey-milovidov))
- リザーバーサンプリングアルゴリズムを使用した`groupArraySample`関数(`groupArray`に類似)を追加。[#8286](https://github.com/ClickHouse/ClickHouse/pull/8286) ([Amos Bird](https://github.com/amosbird))
- システムメトリクスを通じて`cache`/`complex_key_cache`ディクショナリの更新キューサイズを監視可能に。[#9413](https://github.com/ClickHouse/ClickHouse/pull/9413) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- 設定`output_format_csv_crlf_end_of_line`を1に設定することで、CSV出力フォーマットで行区切り文字としてCRLFを使用可能に [#8934](https://github.com/ClickHouse/ClickHouse/pull/8934) [#8935](https://github.com/ClickHouse/ClickHouse/pull/8935) [#8963](https://github.com/ClickHouse/ClickHouse/pull/8963) ([Mikhail Korotov](https://github.com/millb))
- [H3](https://github.com/uber/h3) APIのより多くの関数を実装: `h3GetBaseCell`、`h3HexAreaM2`、`h3IndexesAreNeighbors`、`h3ToChildren`、`h3ToString`、`stringToH3` [#8938](https://github.com/ClickHouse/ClickHouse/pull/8938) ([Nico Mandery](https://github.com/nmandery))
- 新しい設定を導入: 最大スタックサイズを制御し、大規模で複雑なクエリを可能にする`max_parser_depth`。これにより[#6681](https://github.com/ClickHouse/ClickHouse/issues/6681)および[#7668](https://github.com/ClickHouse/ClickHouse/issues/7668)を修正。[#8647](https://github.com/ClickHouse/ClickHouse/pull/8647) ([Maxim Smirnov](https://github.com/qMBQx8GH))
- 未使用シャードのスキップが不可能な場合に例外をスローする設定`force_optimize_skip_unused_shards`を追加 [#8805](https://github.com/ClickHouse/ClickHouse/pull/8805) ([Azat Khuzhin](https://github.com/azat))
- `Distributed`エンジンで送信用データを保存するための複数のディスク/ボリュームの設定が可能に [#8756](https://github.com/ClickHouse/ClickHouse/pull/8756) ([Azat Khuzhin](https://github.com/azat))
- 一時データを保存するためのストレージポリシー(`<tmp_policy>`)をサポート。[#8750](https://github.com/ClickHouse/ClickHouse/pull/8750) ([Azat Khuzhin](https://github.com/azat))
- データ送信前に例外がスローされた場合に設定される`X-ClickHouse-Exception-Code` HTTPヘッダーを追加。これにより[#4971](https://github.com/ClickHouse/ClickHouse/issues/4971)を実装。[#8786](https://github.com/ClickHouse/ClickHouse/pull/8786) ([Mikhail Korotov](https://github.com/millb))
- 関数`ifNotFinite`を追加。これは単なる構文糖衣です: `ifNotFinite(x, y) = isFinite(x) ? x : y`。[#8710](https://github.com/ClickHouse/ClickHouse/pull/8710) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `system.dictionaries`テーブルに`last_successful_update_time`カラムを追加 [#9394](https://github.com/ClickHouse/ClickHouse/pull/9394) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- `blockSerializedSize`関数(圧縮なしのディスク上のサイズ)を追加 [#8952](https://github.com/ClickHouse/ClickHouse/pull/8952) ([Azat Khuzhin](https://github.com/azat))
- 関数`moduloOrZero`を追加 [#9358](https://github.com/ClickHouse/ClickHouse/pull/9358) ([hcz](https://github.com/hczhcz))
- システムテーブル`system.zeros`および`system.zeros_mt`、ならびにテーブル関数`zeros()`および`zeros_mt()`を追加。テーブル(およびテーブル関数)には、名前が`zero`で型が`UInt8`の単一カラムが含まれます。このカラムにはゼロが格納されます。多数の行を生成する最速の方法として、テスト目的で必要とされます。これにより[#6604](https://github.com/ClickHouse/ClickHouse/issues/6604)を修正 [#9593](https://github.com/ClickHouse/ClickHouse/pull/9593) ([Nikolai Kochetov](https://github.com/KochetovNicolai))

#### 実験的機能 {#experimental-feature-7}

- `MergeTree`ファミリーテーブルにおいて、すべてのカラムを1つのファイルに格納する新しいコンパクト形式のパートを追加しました。これにより、小規模で頻繁な挿入のパフォーマンスが向上します。従来の形式(カラムごとに1ファイル)は現在ワイド形式と呼ばれています。データ格納形式は設定`min_bytes_for_wide_part`および`min_rows_for_wide_part`によって制御されます。[#8290](https://github.com/ClickHouse/ClickHouse/pull/8290) ([Anton Popov](https://github.com/CurtizJ))
- `Log`、`TinyLog`、`StripeLog`テーブルに対するS3ストレージのサポートを追加しました。[#8862](https://github.com/ClickHouse/ClickHouse/pull/8862) ([Pavel Kovalenko](https://github.com/Jokser))


#### バグ修正 {#bug-fix-49}

- Fixed inconsistent whitespaces in log messages. [#9322](https://github.com/ClickHouse/ClickHouse/pull/9322) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix bug in which arrays of unnamed tuples were flattened as Nested structures on table creation. [#8866](https://github.com/ClickHouse/ClickHouse/pull/8866) ([achulkov2](https://github.com/achulkov2))
- Fixed the issue when "Too many open files" error may happen if there are too many files matching glob pattern in `File` table or `file` table function. Now files are opened lazily. This fixes [#8857](https://github.com/ClickHouse/ClickHouse/issues/8857) [#8861](https://github.com/ClickHouse/ClickHouse/pull/8861) ([alexey-milovidov](https://github.com/alexey-milovidov))
- DROP TEMPORARY TABLE now drops only temporary table. [#8907](https://github.com/ClickHouse/ClickHouse/pull/8907) ([Vitaly Baranov](https://github.com/vitlibar))
- Remove outdated partition when we shutdown the server or DETACH/ATTACH a table. [#8602](https://github.com/ClickHouse/ClickHouse/pull/8602) ([Guillaume Tassery](https://github.com/YiuRULE))
- For how the default disk calculates the free space from `data` subdirectory. Fixed the issue when the amount of free space is not calculated correctly if the `data` directory is mounted to a separate device (rare case). This fixes [#7441](https://github.com/ClickHouse/ClickHouse/issues/7441) [#9257](https://github.com/ClickHouse/ClickHouse/pull/9257) ([Mikhail Korotov](https://github.com/millb))
- Allow comma (cross) join with IN () inside. [#9251](https://github.com/ClickHouse/ClickHouse/pull/9251) ([Artem Zuikov](https://github.com/4ertus2))
- Allow to rewrite CROSS to INNER JOIN if there's [NOT] LIKE operator in WHERE section. [#9229](https://github.com/ClickHouse/ClickHouse/pull/9229) ([Artem Zuikov](https://github.com/4ertus2))
- Fix possible incorrect result after `GROUP BY` with enabled setting `distributed_aggregation_memory_efficient`. Fixes [#9134](https://github.com/ClickHouse/ClickHouse/issues/9134). [#9289](https://github.com/ClickHouse/ClickHouse/pull/9289) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Found keys were counted as missed in metrics of cache dictionaries. [#9411](https://github.com/ClickHouse/ClickHouse/pull/9411) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Fix replication protocol incompatibility introduced in [#8598](https://github.com/ClickHouse/ClickHouse/issues/8598). [#9412](https://github.com/ClickHouse/ClickHouse/pull/9412) ([alesapin](https://github.com/alesapin))
- Fixed race condition on `queue_task_handle` at the startup of `ReplicatedMergeTree` tables. [#9552](https://github.com/ClickHouse/ClickHouse/pull/9552) ([alexey-milovidov](https://github.com/alexey-milovidov))
- The token `NOT` did not work in `SHOW TABLES NOT LIKE` query [#8727](https://github.com/ClickHouse/ClickHouse/issues/8727) [#8940](https://github.com/ClickHouse/ClickHouse/pull/8940) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added range check to function `h3EdgeLengthM`. Without this check, buffer overflow is possible. [#8945](https://github.com/ClickHouse/ClickHouse/pull/8945) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed up a bug in batched calculations of ternary logical OPs on multiple arguments (more than 10). [#8718](https://github.com/ClickHouse/ClickHouse/pull/8718) ([Alexander Kazakov](https://github.com/Akazz))
- Fix error of PREWHERE optimization, which could lead to segfaults or `Inconsistent number of columns got from MergeTreeRangeReader` exception. [#9024](https://github.com/ClickHouse/ClickHouse/pull/9024) ([Anton Popov](https://github.com/CurtizJ))
- Fix unexpected `Timeout exceeded while reading from socket` exception, which randomly happens on secure connection before timeout actually exceeded and when query profiler is enabled. Also add `connect_timeout_with_failover_secure_ms` settings (default 100ms), which is similar to `connect_timeout_with_failover_ms`, but is used for secure connections (because SSL handshake is slower, than ordinary TCP connection) [#9026](https://github.com/ClickHouse/ClickHouse/pull/9026) ([tavplubix](https://github.com/tavplubix))
- Fix bug with mutations finalization, when mutation may hang in state with `parts_to_do=0` and `is_done=0`. [#9022](https://github.com/ClickHouse/ClickHouse/pull/9022) ([alesapin](https://github.com/alesapin))
- Use new ANY JOIN logic with `partial_merge_join` setting. It's possible to make `ANY|ALL|SEMI LEFT` and `ALL INNER` joins with `partial_merge_join=1` now. [#8932](https://github.com/ClickHouse/ClickHouse/pull/8932) ([Artem Zuikov](https://github.com/4ertus2))
- Shard now clamps the settings got from the initiator to the shard's constaints instead of throwing an exception. This fix allows to send queries to a shard with another constraints. [#9447](https://github.com/ClickHouse/ClickHouse/pull/9447) ([Vitaly Baranov](https://github.com/vitlibar))
- Fixed memory management problem in `MergeTreeReadPool`. [#8791](https://github.com/ClickHouse/ClickHouse/pull/8791) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix `toDecimal*OrNull()` functions family when called with string `e`. Fixes [#8312](https://github.com/ClickHouse/ClickHouse/issues/8312) [#8764](https://github.com/ClickHouse/ClickHouse/pull/8764) ([Artem Zuikov](https://github.com/4ertus2))
- Make sure that `FORMAT Null` sends no data to the client. [#8767](https://github.com/ClickHouse/ClickHouse/pull/8767) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Fix bug that timestamp in `LiveViewBlockInputStream` will not updated. `LIVE VIEW` is an experimental feature. [#8644](https://github.com/ClickHouse/ClickHouse/pull/8644) ([vxider](https://github.com/Vxider)) [#8625](https://github.com/ClickHouse/ClickHouse/pull/8625) ([vxider](https://github.com/Vxider))
- Fixed `ALTER MODIFY TTL` wrong behavior which did not allow to delete old TTL expressions. [#8422](https://github.com/ClickHouse/ClickHouse/pull/8422) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fixed UBSan report in MergeTreeIndexSet. This fixes [#9250](https://github.com/ClickHouse/ClickHouse/issues/9250) [#9365](https://github.com/ClickHouse/ClickHouse/pull/9365) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed the behaviour of `match` and `extract` functions when haystack has zero bytes. The behaviour was wrong when haystack was constant. This fixes [#9160](https://github.com/ClickHouse/ClickHouse/issues/9160) [#9163](https://github.com/ClickHouse/ClickHouse/pull/9163) ([alexey-milovidov](https://github.com/alexey-milovidov)) [#9345](https://github.com/ClickHouse/ClickHouse/pull/9345) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Avoid throwing from destructor in Apache Avro 3rd-party library. [#9066](https://github.com/ClickHouse/ClickHouse/pull/9066) ([Andrew Onyshchuk](https://github.com/oandrew))
- Don't commit a batch polled from `Kafka` partially as it can lead to holes in data. [#8876](https://github.com/ClickHouse/ClickHouse/pull/8876) ([filimonov](https://github.com/filimonov))
- Fix `joinGet` with nullable return types. [#8919](https://github.com/ClickHouse/ClickHouse/issues/8919) [#9014](https://github.com/ClickHouse/ClickHouse/pull/9014) ([Amos Bird](https://github.com/amosbird))
- Fix data incompatibility when compressed with `T64` codec. [#9016](https://github.com/ClickHouse/ClickHouse/pull/9016) ([Artem Zuikov](https://github.com/4ertus2)) Fix data type ids in `T64` compression codec that leads to wrong (de)compression in affected versions. [#9033](https://github.com/ClickHouse/ClickHouse/pull/9033) ([Artem Zuikov](https://github.com/4ertus2))
- Add setting `enable_early_constant_folding` and disable it in some cases that leads to errors. [#9010](https://github.com/ClickHouse/ClickHouse/pull/9010) ([Artem Zuikov](https://github.com/4ertus2))
- Fix pushdown predicate optimizer with VIEW and enable the test [#9011](https://github.com/ClickHouse/ClickHouse/pull/9011) ([Winter Zhang](https://github.com/zhang2014))
- Fix segfault in `Merge` tables, that can happen when reading from `File` storages [#9387](https://github.com/ClickHouse/ClickHouse/pull/9387) ([tavplubix](https://github.com/tavplubix))
- Added a check for storage policy in `ATTACH PARTITION FROM`, `REPLACE PARTITION`, `MOVE TO TABLE`. Otherwise it could make data of part inaccessible after restart and prevent ClickHouse to start. [#9383](https://github.com/ClickHouse/ClickHouse/pull/9383) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix alters if there is TTL set for table. [#8800](https://github.com/ClickHouse/ClickHouse/pull/8800) ([Anton Popov](https://github.com/CurtizJ))
- Fix race condition that can happen when `SYSTEM RELOAD ALL DICTIONARIES` is executed while some dictionary is being modified/added/removed. [#8801](https://github.com/ClickHouse/ClickHouse/pull/8801) ([Vitaly Baranov](https://github.com/vitlibar))
- In previous versions `Memory` database engine use empty data path, so tables are created in `path` directory (e.g. `/var/lib/clickhouse/`), not in data directory of database (e.g. `/var/lib/clickhouse/db_name`). [#8753](https://github.com/ClickHouse/ClickHouse/pull/8753) ([tavplubix](https://github.com/tavplubix))
- Fixed wrong log messages about missing default disk or policy. [#9530](https://github.com/ClickHouse/ClickHouse/pull/9530) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix not(has()) for the bloom_filter index of array types. [#9407](https://github.com/ClickHouse/ClickHouse/pull/9407) ([achimbab](https://github.com/achimbab))
- Allow first column(s) in a table with `Log` engine be an alias [#9231](https://github.com/ClickHouse/ClickHouse/pull/9231) ([Ivan](https://github.com/abyss7))
- Fix order of ranges while reading from `MergeTree` table in one thread. It could lead to exceptions from `MergeTreeRangeReader` or wrong query results. [#9050](https://github.com/ClickHouse/ClickHouse/pull/9050) ([Anton Popov](https://github.com/CurtizJ))
- Make `reinterpretAsFixedString` to return `FixedString` instead of `String`. [#9052](https://github.com/ClickHouse/ClickHouse/pull/9052) ([Andrew Onyshchuk](https://github.com/oandrew))
- Avoid extremely rare cases when the user can get wrong error message (`Success` instead of detailed error description). [#9457](https://github.com/ClickHouse/ClickHouse/pull/9457) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Do not crash when using `Template` format with empty row template. [#8785](https://github.com/ClickHouse/ClickHouse/pull/8785) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Metadata files for system tables could be created in wrong place [#8653](https://github.com/ClickHouse/ClickHouse/pull/8653) ([tavplubix](https://github.com/tavplubix)) Fixes [#8581](https://github.com/ClickHouse/ClickHouse/issues/8581).
- Fix data race on exception_ptr in cache dictionary [#8303](https://github.com/ClickHouse/ClickHouse/issues/8303). [#9379](https://github.com/ClickHouse/ClickHouse/pull/9379) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Do not throw an exception for query `ATTACH TABLE IF NOT EXISTS`. Previously it was thrown if table already exists, despite the `IF NOT EXISTS` clause. [#8967](https://github.com/ClickHouse/ClickHouse/pull/8967) ([Anton Popov](https://github.com/CurtizJ))
- Fixed missing closing paren in exception message. [#8811](https://github.com/ClickHouse/ClickHouse/pull/8811) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Avoid message `Possible deadlock avoided` at the startup of clickhouse-client in interactive mode. [#9455](https://github.com/ClickHouse/ClickHouse/pull/9455) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed the issue when padding at the end of base64 encoded value can be malformed. Update base64 library. This fixes [#9491](https://github.com/ClickHouse/ClickHouse/issues/9491), closes [#9492](https://github.com/ClickHouse/ClickHouse/issues/9492) [#9500](https://github.com/ClickHouse/ClickHouse/pull/9500) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Prevent losing data in `Kafka` in rare cases when exception happens after reading suffix but before commit. Fixes [#9378](https://github.com/ClickHouse/ClickHouse/issues/9378) [#9507](https://github.com/ClickHouse/ClickHouse/pull/9507) ([filimonov](https://github.com/filimonov))
- Fixed exception in `DROP TABLE IF EXISTS` [#8663](https://github.com/ClickHouse/ClickHouse/pull/8663) ([Nikita Vasilev](https://github.com/nikvas0))
- Fix crash when a user tries to `ALTER MODIFY SETTING` for old-formated `MergeTree` table engines family. [#9435](https://github.com/ClickHouse/ClickHouse/pull/9435) ([alesapin](https://github.com/alesapin))
- Support for UInt64 numbers that don't fit in Int64 in JSON-related functions. Update SIMDJSON to master. This fixes [#9209](https://github.com/ClickHouse/ClickHouse/issues/9209) [#9344](https://github.com/ClickHouse/ClickHouse/pull/9344) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed execution of inversed predicates when non-strictly monotinic functional index is used. [#9223](https://github.com/ClickHouse/ClickHouse/pull/9223) ([Alexander Kazakov](https://github.com/Akazz))
- Don't try to fold `IN` constant in `GROUP BY` [#8868](https://github.com/ClickHouse/ClickHouse/pull/8868) ([Amos Bird](https://github.com/amosbird))
- Fix bug in `ALTER DELETE` mutations which leads to index corruption. This fixes [#9019](https://github.com/ClickHouse/ClickHouse/issues/9019) and [#8982](https://github.com/ClickHouse/ClickHouse/issues/8982). Additionally fix extremely rare race conditions in `ReplicatedMergeTree` `ALTER` queries. [#9048](https://github.com/ClickHouse/ClickHouse/pull/9048) ([alesapin](https://github.com/alesapin))
- When the setting `compile_expressions` is enabled, you can get `unexpected column` in `LLVMExecutableFunction` when we use `Nullable` type [#8910](https://github.com/ClickHouse/ClickHouse/pull/8910) ([Guillaume Tassery](https://github.com/YiuRULE))
- Multiple fixes for `Kafka` engine: 1) fix duplicates that were appearing during consumer group rebalance. 2) Fix rare 'holes' appeared when data were polled from several partitions with one poll and committed partially (now we always process / commit the whole polled block of messages). 3) Fix flushes by block size (before that only flushing by timeout was working properly). 4) better subscription procedure (with assignment feedback). 5) Make tests work faster (with default intervals and timeouts). Due to the fact that data was not flushed by block size before (as it should according to documentation), that PR may lead to some performance degradation with default settings (due to more often & tinier flushes which are less optimal). If you encounter the performance issue after that change - please increase `kafka_max_block_size` in the table to the bigger value ( for example `CREATE TABLE ...Engine=Kafka ... SETTINGS ... kafka_max_block_size=524288`). Fixes [#7259](https://github.com/ClickHouse/ClickHouse/issues/7259) [#8917](https://github.com/ClickHouse/ClickHouse/pull/8917) ([filimonov](https://github.com/filimonov))
- Fix `Parameter out of bound` exception in some queries after PREWHERE optimizations. [#8914](https://github.com/ClickHouse/ClickHouse/pull/8914) ([Baudouin Giard](https://github.com/bgiard))
- Fixed the case of mixed-constness of arguments of function `arrayZip`. [#8705](https://github.com/ClickHouse/ClickHouse/pull/8705) ([alexey-milovidov](https://github.com/alexey-milovidov))
- When executing `CREATE` query, fold constant expressions in storage engine arguments. Replace empty database name with current database. Fixes [#6508](https://github.com/ClickHouse/ClickHouse/issues/6508), [#3492](https://github.com/ClickHouse/ClickHouse/issues/3492) [#9262](https://github.com/ClickHouse/ClickHouse/pull/9262) ([tavplubix](https://github.com/tavplubix))
- Now it's not possible to create or add columns with simple cyclic aliases like `a DEFAULT b, b DEFAULT a`. [#9603](https://github.com/ClickHouse/ClickHouse/pull/9603) ([alesapin](https://github.com/alesapin))
- Fixed a bug with double move which may corrupt original part. This is relevant if you use `ALTER TABLE MOVE` [#8680](https://github.com/ClickHouse/ClickHouse/pull/8680) ([Vladimir Chebotarev](https://github.com/excitoon))
- Allow `interval` identifier to correctly parse without backticks. Fixed issue when a query cannot be executed even if the `interval` identifier is enclosed in backticks or double quotes. This fixes [#9124](https://github.com/ClickHouse/ClickHouse/issues/9124). [#9142](https://github.com/ClickHouse/ClickHouse/pull/9142) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed fuzz test and incorrect behaviour of `bitTestAll`/`bitTestAny` functions. [#9143](https://github.com/ClickHouse/ClickHouse/pull/9143) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix possible crash/wrong number of rows in `LIMIT n WITH TIES` when there are a lot of rows equal to n'th row. [#9464](https://github.com/ClickHouse/ClickHouse/pull/9464) ([tavplubix](https://github.com/tavplubix))
- Fix mutations with parts written with enabled `insert_quorum`. [#9463](https://github.com/ClickHouse/ClickHouse/pull/9463) ([alesapin](https://github.com/alesapin))
- Fix data race at destruction of `Poco::HTTPServer`. It could happen when server is started and immediately shut down. [#9468](https://github.com/ClickHouse/ClickHouse/pull/9468) ([Anton Popov](https://github.com/CurtizJ))
- Fix bug in which a misleading error message was shown when running `SHOW CREATE TABLE a_table_that_does_not_exist`. [#8899](https://github.com/ClickHouse/ClickHouse/pull/8899) ([achulkov2](https://github.com/achulkov2))
- Fixed `Parameters are out of bound` exception in some rare cases when we have a constant in the `SELECT` clause when we have an `ORDER BY` and a `LIMIT` clause. [#8892](https://github.com/ClickHouse/ClickHouse/pull/8892) ([Guillaume Tassery](https://github.com/YiuRULE))
- Fix mutations finalization, when already done mutation can have status `is_done=0`. [#9217](https://github.com/ClickHouse/ClickHouse/pull/9217) ([alesapin](https://github.com/alesapin))
- Prevent from executing `ALTER ADD INDEX` for MergeTree tables with old syntax, because it does not work. [#8822](https://github.com/ClickHouse/ClickHouse/pull/8822) ([Mikhail Korotov](https://github.com/millb))
- During server startup do not access table, which `LIVE VIEW` depends on, so server will be able to start. Also remove `LIVE VIEW` dependencies when detaching `LIVE VIEW`. `LIVE VIEW` is an experimental feature. [#8824](https://github.com/ClickHouse/ClickHouse/pull/8824) ([tavplubix](https://github.com/tavplubix))
- Fix possible segfault in `MergeTreeRangeReader`, while executing `PREWHERE`. [#9106](https://github.com/ClickHouse/ClickHouse/pull/9106) ([Anton Popov](https://github.com/CurtizJ))
- Fix possible mismatched checksums with column TTLs. [#9451](https://github.com/ClickHouse/ClickHouse/pull/9451) ([Anton Popov](https://github.com/CurtizJ))
- Fixed a bug when parts were not being moved in background by TTL rules in case when there is only one volume. [#8672](https://github.com/ClickHouse/ClickHouse/pull/8672) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fixed the issue `Method createColumn() is not implemented for data type Set`. This fixes [#7799](https://github.com/ClickHouse/ClickHouse/issues/7799). [#8674](https://github.com/ClickHouse/ClickHouse/pull/8674) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Now we will try finalize mutations more frequently. [#9427](https://github.com/ClickHouse/ClickHouse/pull/9427) ([alesapin](https://github.com/alesapin))
- Fix `intDiv` by minus one constant [#9351](https://github.com/ClickHouse/ClickHouse/pull/9351) ([hcz](https://github.com/hczhcz))
- Fix possible race condition in `BlockIO`. [#9356](https://github.com/ClickHouse/ClickHouse/pull/9356) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix bug leading to server termination when trying to use / drop `Kafka` table created with wrong parameters. [#9513](https://github.com/ClickHouse/ClickHouse/pull/9513) ([filimonov](https://github.com/filimonov))
- Added workaround if OS returns wrong result for `timer_create` function. [#8837](https://github.com/ClickHouse/ClickHouse/pull/8837) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed error in usage of `min_marks_for_seek` parameter. Fixed the error message when there is no sharding key in Distributed table and we try to skip unused shards. [#8908](https://github.com/ClickHouse/ClickHouse/pull/8908) ([Azat Khuzhin](https://github.com/azat))





#### 改善 {#improvement-20}

- `ReplicatedMergeTree*`エンジンファミリーに対して、ミューテーション上で`ALTER MODIFY/DROP`クエリを実装しました。現在、`ALTERS`はメタデータ更新段階でのみブロックし、その後はブロックしません。[#8701](https://github.com/ClickHouse/ClickHouse/pull/8701) ([alesapin](https://github.com/alesapin))
- 非修飾名を含む`WHERE`セクションを持つCROSSをINNER JOINに書き換える機能を追加しました。[#9512](https://github.com/ClickHouse/ClickHouse/pull/9512) ([Artem Zuikov](https://github.com/4ertus2))
- `SHOW TABLES`および`SHOW DATABASES`クエリが`WHERE`式と`FROM`/`IN`をサポートするようにしました。[#9076](https://github.com/ClickHouse/ClickHouse/pull/9076) ([sundyli](https://github.com/sundy-li))
- `deduplicate_blocks_in_dependent_materialized_views`設定を追加しました。[#9070](https://github.com/ClickHouse/ClickHouse/pull/9070) ([urykhy](https://github.com/urykhy))
- 最近の変更後、MySQLクライアントがバイナリ文字列を16進数で出力するようになり、読み取れなくなりました([#9032](https://github.com/ClickHouse/ClickHouse/issues/9032))。ClickHouseでの回避策は、文字列カラムをUTF-8としてマークすることです。これは常にではありませんが、通常はそうです。[#9079](https://github.com/ClickHouse/ClickHouse/pull/9079) ([Yuriy Baranov](https://github.com/yurriy))
- `sumMap`に対してStringおよびFixedStringキーのサポートを追加しました。[#8903](https://github.com/ClickHouse/ClickHouse/pull/8903) ([Baudouin Giard](https://github.com/bgiard))
- SummingMergeTreeマップで文字列キーをサポートしました。[#8933](https://github.com/ClickHouse/ClickHouse/pull/8933) ([Baudouin Giard](https://github.com/bgiard))
- スレッドが例外をスローした場合でも、スレッドプールにスレッドの終了を通知するようにしました。[#8736](https://github.com/ClickHouse/ClickHouse/pull/8736) ([Ding Xiang Fei](https://github.com/dingxiangfei2009))
- `clickhouse-benchmark`で`query_id`を設定できるようにしました。[#9416](https://github.com/ClickHouse/ClickHouse/pull/9416) ([Anton Popov](https://github.com/CurtizJ))
- `ALTER TABLE ... PARTITION partition`クエリで不正な式を許可しないようにしました。これは[#7192](https://github.com/ClickHouse/ClickHouse/issues/7192)に対処します。[#8835](https://github.com/ClickHouse/ClickHouse/pull/8835) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `system.table_engines`テーブルが機能サポートに関する情報(`supports_ttl`や`supports_sort_order`など)を提供するようになりました。[#8830](https://github.com/ClickHouse/ClickHouse/pull/8830) ([Max Akhmedov](https://github.com/zlobober))
- `system.metric_log`をデフォルトで有効にしました。これには、"collect_interval_milliseconds"間隔(デフォルトでは1秒)で収集されたProfileEvents、CurrentMetricsの値を持つ行が含まれます。このテーブルは非常に小さく(通常はメガバイト単位)、デフォルトでこのデータを収集することは妥当です。[#9225](https://github.com/ClickHouse/ClickHouse/pull/9225) ([alexey-milovidov](https://github.com/alexey-milovidov))
- グループ内のすべてのスレッドに対してクエリプロファイラを初期化するようにしました。例えば、これによりinsertクエリを完全にプロファイルできます。[#6964](https://github.com/ClickHouse/ClickHouse/issues/6964)を修正しました。[#8874](https://github.com/ClickHouse/ClickHouse/pull/8874) ([Ivan](https://github.com/abyss7))
- 一時的な`LIVE VIEW`は、`CREATE TEMPORARY LIVE VIEW ...`の代わりに`CREATE LIVE VIEW name WITH TIMEOUT [42] ...`で作成されるようになりました。以前の構文は`CREATE TEMPORARY TABLE ...`と一貫性がなかったためです。[#9131](https://github.com/ClickHouse/ClickHouse/pull/9131) ([tavplubix](https://github.com/tavplubix))
- `system.text_log`テーブルに送られるエントリを制限するためのtext_log.level設定パラメータを追加しました。[#8809](https://github.com/ClickHouse/ClickHouse/pull/8809) ([Azat Khuzhin](https://github.com/azat))
- TTLルールに従って、ダウンロードされたパートをディスク/ボリュームに配置できるようにしました。[#8598](https://github.com/ClickHouse/ClickHouse/pull/8598) ([Vladimir Chebotarev](https://github.com/excitoon))
- 外部MySQL辞書に対して、MySQL接続プールを共有して辞書間で利用できるようにしました。このオプションにより、MySQLサーバーへの接続数が大幅に削減されます。[#9409](https://github.com/ClickHouse/ClickHouse/pull/9409) ([Clément Rodriguez](https://github.com/clemrodriguez))
- `clickhouse-benchmark`出力で、補間値の代わりに分位数の最も近いクエリ実行時間を表示するようにしました。一部のクエリの実行時間に対応する値を表示する方が良いです。[#8712](https://github.com/ClickHouse/ClickHouse/pull/8712) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Kafkaにデータを挿入する際に、メッセージにキーとタイムスタンプを追加できるようにしました。[#7198](https://github.com/ClickHouse/ClickHouse/issues/7198)を修正しました。[#8969](https://github.com/ClickHouse/ClickHouse/pull/8969) ([filimonov](https://github.com/filimonov))
- サーバーがターミナルから実行される場合、スレッド番号、クエリID、ログ優先度を色で強調表示するようにしました。これは、開発者向けに関連するログメッセージの可読性を向上させるためです。[#8961](https://github.com/ClickHouse/ClickHouse/pull/8961) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `Ordinary`データベースのテーブル読み込み時の例外メッセージを改善しました。[#9527](https://github.com/ClickHouse/ClickHouse/pull/9527) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 集約関数状態を持つ配列に対して`arraySlice`を実装しました。これは[#9388](https://github.com/ClickHouse/ClickHouse/issues/9388)を修正します。[#9391](https://github.com/ClickHouse/ClickHouse/pull/9391) ([alexey-milovidov](https://github.com/alexey-milovidov))
- IN演算子の右側で定数関数と定数配列を使用できるようにしました。[#8813](https://github.com/ClickHouse/ClickHouse/pull/8813) ([Anton Popov](https://github.com/CurtizJ))
- system.replicasのデータ取得中にzookeeper例外が発生した場合、それを別のカラムに表示するようにしました。これは[#9137](https://github.com/ClickHouse/ClickHouse/issues/9137)を実装します。[#9138](https://github.com/ClickHouse/ClickHouse/pull/9138) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 破棄時にMergeTreeデータパートをアトミックに削除するようにしました。[#8402](https://github.com/ClickHouse/ClickHouse/pull/8402) ([Vladimir Chebotarev](https://github.com/excitoon))
- Distributedテーブルに対して行レベルセキュリティをサポートしました。[#8926](https://github.com/ClickHouse/ClickHouse/pull/8926) ([Ivan](https://github.com/abyss7))
- 設定値で接尾辞(KB、KiBなど)を認識するようになりました。[#8072](https://github.com/ClickHouse/ClickHouse/pull/8072) ([Mikhail Korotov](https://github.com/millb))
- 大規模なJOINの結果を構築する際のメモリ不足を防止しました。[#8637](https://github.com/ClickHouse/ClickHouse/pull/8637) ([Artem Zuikov](https://github.com/4ertus2))
- `clickhouse-client`のインタラクティブモードで、クラスター名を候補に追加しました。[#8709](https://github.com/ClickHouse/ClickHouse/pull/8709) ([alexey-milovidov](https://github.com/alexey-milovidov))
- グループ内のすべてのスレッドに対してクエリプロファイラを初期化するようにしました。例えば、これによりinsertクエリを完全にプロファイルできます。[#8820](https://github.com/ClickHouse/ClickHouse/pull/8820) ([Ivan](https://github.com/abyss7))
- `system.query_log`テーブルに`exception_code`カラムを追加しました。[#8770](https://github.com/ClickHouse/ClickHouse/pull/8770) ([Mikhail Korotov](https://github.com/millb))
- デフォルトのサーバー設定ファイルでポート`9004`のMySQL互換サーバーを有効にしました。設定例のパスワード生成コマンドを修正しました。[#8771](https://github.com/ClickHouse/ClickHouse/pull/8771) ([Yuriy Baranov](https://github.com/yurriy))
- ファイルシステムが読み取り専用の場合、シャットダウン時の中断を防止しました。これは[#9094](https://github.com/ClickHouse/ClickHouse/issues/9094)を修正します。[#9100](https://github.com/ClickHouse/ClickHouse/pull/9100) ([alexey-milovidov](https://github.com/alexey-milovidov))
- HTTP POSTクエリで長さが必要な場合の例外メッセージを改善しました。[#9453](https://github.com/ClickHouse/ClickHouse/pull/9453) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `HDFS`および`File`エンジン、ならびに`hdfs`および`file`テーブル関数に`_path`および`_file`仮想カラムを追加しました。[#8489](https://github.com/ClickHouse/ClickHouse/pull/8489) ([Olga Khvostikova](https://github.com/stavrolia))
- ビューの内部テーブルに新しいカラムが追加された場合に、`MATERIALIZED VIEW`への挿入時に発生する`Cannot find column`エラーを修正しました。[#8766](https://github.com/ClickHouse/ClickHouse/pull/8766) [#8788](https://github.com/ClickHouse/ClickHouse/pull/8788) ([vzakaznikov](https://github.com/vzakaznikov)) [#8788](https://github.com/ClickHouse/ClickHouse/issues/8788) [#8806](https://github.com/ClickHouse/ClickHouse/pull/8806) ([Nikolai Kochetov](https://github.com/KochetovNicolai)) [#8803](https://github.com/ClickHouse/ClickHouse/pull/8803) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- ネイティブクライアント・サーバープロトコル上の進行状況を修正し、最終更新後(ログのように)に進行状況を送信するようにしました。これは、ネイティブプロトコルを使用している一部のサードパーティツールにのみ関連する可能性があります。[#9495](https://github.com/ClickHouse/ClickHouse/pull/9495) ([Azat Khuzhin](https://github.com/azat))
- MySQLプロトコルを使用しているクライアント接続数を追跡するシステムメトリックを追加しました([#9013](https://github.com/ClickHouse/ClickHouse/issues/9013))。[#9015](https://github.com/ClickHouse/ClickHouse/pull/9015) ([Eugene Klimov](https://github.com/Slach))
- 今後、HTTPレスポンスには`SELECT timezone()`が報告するのと同じタイムゾーン値に設定された`X-ClickHouse-Timezone`ヘッダーが含まれます。[#9493](https://github.com/ClickHouse/ClickHouse/pull/9493) ([Denis Glazachev](https://github.com/traceon))

#### パフォーマンス改善 {#performance-improvement-16}

- INを使用したインデックス解析のパフォーマンスを改善 [#9261](https://github.com/ClickHouse/ClickHouse/pull/9261) ([Anton Popov](https://github.com/CurtizJ))
- 論理関数のコードをより簡潔かつ効率的に改善し、コードのクリーンアップを実施。[#8718](https://github.com/ClickHouse/ClickHouse/issues/8718)のフォローアップ [#8728](https://github.com/ClickHouse/ClickHouse/pull/8728) ([Alexander Kazakov](https://github.com/Akazz))
- C++20の機能を使用してより厳密なエイリアシングを確保することにより、全体的なパフォーマンスを改善(影響を受けるクエリで5%から200%の範囲)。[#9304](https://github.com/ClickHouse/ClickHouse/pull/9304) ([Amos Bird](https://github.com/amosbird))
- 比較関数の内部ループに対してより厳密なエイリアシングを適用。[#9327](https://github.com/ClickHouse/ClickHouse/pull/9327) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 算術関数の内部ループに対してより厳密なエイリアシングを適用。[#9325](https://github.com/ClickHouse/ClickHouse/pull/9325) ([alexey-milovidov](https://github.com/alexey-milovidov))
- ColumnVector::replicate()の実装を約3倍高速化。これによりColumnConst::convertToFullColumn()が実装されています。定数を具体化する際のテストでも有用です。[#9293](https://github.com/ClickHouse/ClickHouse/pull/9293) ([Alexander Kazakov](https://github.com/Akazz))
- `ColumnVector::replicate()`に対するさらなる軽微なパフォーマンス改善(`materialize`関数と高階関数を高速化)。[#9293](https://github.com/ClickHouse/ClickHouse/issues/9293)のさらなる改善 [#9442](https://github.com/ClickHouse/ClickHouse/pull/9442) ([Alexander Kazakov](https://github.com/Akazz))
- `stochasticLinearRegression`集約関数のパフォーマンスを改善。このパッチはIntelによって提供されました。[#8652](https://github.com/ClickHouse/ClickHouse/pull/8652) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `reinterpretAsFixedString`関数のパフォーマンスを改善。[#9342](https://github.com/ClickHouse/ClickHouse/pull/9342) ([alexey-milovidov](https://github.com/alexey-milovidov))
- プロセッサパイプラインにおいて`Null`フォーマットの場合、クライアントにブロックを送信しないように変更。[#8797](https://github.com/ClickHouse/ClickHouse/pull/8797) ([Nikolai Kochetov](https://github.com/KochetovNicolai)) [#8767](https://github.com/ClickHouse/ClickHouse/pull/8767) ([Alexander Kuzmenkov](https://github.com/akuzm))


#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-20}

- Exception handling now works correctly on Windows Subsystem for Linux. See https://github.com/ClickHouse-Extras/libunwind/pull/3 This fixes [#6480](https://github.com/ClickHouse/ClickHouse/issues/6480) [#9564](https://github.com/ClickHouse/ClickHouse/pull/9564) ([sobolevsv](https://github.com/sobolevsv))
- Replace `readline` with `replxx` for interactive line editing in `clickhouse-client` [#8416](https://github.com/ClickHouse/ClickHouse/pull/8416) ([Ivan](https://github.com/abyss7))
- Better build time and less template instantiations in FunctionsComparison. [#9324](https://github.com/ClickHouse/ClickHouse/pull/9324) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added integration with `clang-tidy` in CI. See also [#6044](https://github.com/ClickHouse/ClickHouse/issues/6044) [#9566](https://github.com/ClickHouse/ClickHouse/pull/9566) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Now we link ClickHouse in CI using `lld` even for `gcc`. [#9049](https://github.com/ClickHouse/ClickHouse/pull/9049) ([alesapin](https://github.com/alesapin))
- Allow to randomize thread scheduling and insert glitches when `THREAD_FUZZER_*` environment variables are set. This helps testing. [#9459](https://github.com/ClickHouse/ClickHouse/pull/9459) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Enable secure sockets in stateless tests [#9288](https://github.com/ClickHouse/ClickHouse/pull/9288) ([tavplubix](https://github.com/tavplubix))
- Make SPLIT_SHARED_LIBRARIES=OFF more robust [#9156](https://github.com/ClickHouse/ClickHouse/pull/9156) ([Azat Khuzhin](https://github.com/azat))
- Make "performance_introspection_and_logging" test reliable to random server stuck. This may happen in CI environment. See also [#9515](https://github.com/ClickHouse/ClickHouse/issues/9515) [#9528](https://github.com/ClickHouse/ClickHouse/pull/9528) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Validate XML in style check. [#9550](https://github.com/ClickHouse/ClickHouse/pull/9550) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed race condition in test `00738_lock_for_inner_table`. This test relied on sleep. [#9555](https://github.com/ClickHouse/ClickHouse/pull/9555) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Remove performance tests of type `once`. This is needed to run all performance tests in statistical comparison mode (more reliable). [#9557](https://github.com/ClickHouse/ClickHouse/pull/9557) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added performance test for arithmetic functions. [#9326](https://github.com/ClickHouse/ClickHouse/pull/9326) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added performance test for `sumMap` and `sumMapWithOverflow` aggregate functions. Follow-up for [#8933](https://github.com/ClickHouse/ClickHouse/issues/8933) [#8947](https://github.com/ClickHouse/ClickHouse/pull/8947) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Ensure style of ErrorCodes by style check. [#9370](https://github.com/ClickHouse/ClickHouse/pull/9370) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add script for tests history. [#8796](https://github.com/ClickHouse/ClickHouse/pull/8796) ([alesapin](https://github.com/alesapin))
- Add GCC warning `-Wsuggest-override` to locate and fix all places where `override` keyword must be used. [#8760](https://github.com/ClickHouse/ClickHouse/pull/8760) ([kreuzerkrieg](https://github.com/kreuzerkrieg))
- Ignore weak symbol under Mac OS X because it must be defined [#9538](https://github.com/ClickHouse/ClickHouse/pull/9538) ([Deleted user](https://github.com/ghost))
- Normalize running time of some queries in performance tests. This is done in preparation to run all the performance tests in comparison mode. [#9565](https://github.com/ClickHouse/ClickHouse/pull/9565) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix some tests to support pytest with query tests [#9062](https://github.com/ClickHouse/ClickHouse/pull/9062) ([Ivan](https://github.com/abyss7))
- Enable SSL in build with MSan, so server will not fail at startup when running stateless tests [#9531](https://github.com/ClickHouse/ClickHouse/pull/9531) ([tavplubix](https://github.com/tavplubix))
- Fix database substitution in test results [#9384](https://github.com/ClickHouse/ClickHouse/pull/9384) ([Ilya Yatsishin](https://github.com/qoega))
- Build fixes for miscellaneous platforms [#9381](https://github.com/ClickHouse/ClickHouse/pull/9381) ([proller](https://github.com/proller)) [#8755](https://github.com/ClickHouse/ClickHouse/pull/8755) ([proller](https://github.com/proller)) [#8631](https://github.com/ClickHouse/ClickHouse/pull/8631) ([proller](https://github.com/proller))
- Added disks section to stateless-with-coverage test docker image [#9213](https://github.com/ClickHouse/ClickHouse/pull/9213) ([Pavel Kovalenko](https://github.com/Jokser))
- Get rid of in-source-tree files when building with GRPC [#9588](https://github.com/ClickHouse/ClickHouse/pull/9588) ([Amos Bird](https://github.com/amosbird))
- Slightly faster build time by removing SessionCleaner from Context. Make the code of SessionCleaner more simple. [#9232](https://github.com/ClickHouse/ClickHouse/pull/9232) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Updated checking for hung queries in clickhouse-test script [#8858](https://github.com/ClickHouse/ClickHouse/pull/8858) ([Alexander Kazakov](https://github.com/Akazz))
- Removed some useless files from repository. [#8843](https://github.com/ClickHouse/ClickHouse/pull/8843) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Changed type of math perftests from `once` to `loop`. [#8783](https://github.com/ClickHouse/ClickHouse/pull/8783) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Add docker image which allows to build interactive code browser HTML report for our codebase. [#8781](https://github.com/ClickHouse/ClickHouse/pull/8781) ([alesapin](https://github.com/alesapin)) See [Woboq Code Browser](https://clickhouse-test-reports.s3.yandex.net/codebrowser/ClickHouse/dbms/index.html)
- Suppress some test failures under MSan. [#8780](https://github.com/ClickHouse/ClickHouse/pull/8780) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Speedup "exception while insert" test. This test often time out in debug-with-coverage build. [#8711](https://github.com/ClickHouse/ClickHouse/pull/8711) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Updated `libcxx` and `libcxxabi` to master. In preparation to [#9304](https://github.com/ClickHouse/ClickHouse/issues/9304) [#9308](https://github.com/ClickHouse/ClickHouse/pull/9308) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix flacky test `00910_zookeeper_test_alter_compression_codecs`. [#9525](https://github.com/ClickHouse/ClickHouse/pull/9525) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Clean up duplicated linker flags. Make sure the linker won't look up an unexpected symbol. [#9433](https://github.com/ClickHouse/ClickHouse/pull/9433) ([Amos Bird](https://github.com/amosbird))
- Add `clickhouse-odbc` driver into test images. This allows to test interaction of ClickHouse with ClickHouse via its own ODBC driver. [#9348](https://github.com/ClickHouse/ClickHouse/pull/9348) ([filimonov](https://github.com/filimonov))
- Fix several bugs in unit tests. [#9047](https://github.com/ClickHouse/ClickHouse/pull/9047) ([alesapin](https://github.com/alesapin))
- Enable `-Wmissing-include-dirs` GCC warning to eliminate all non-existing includes - mostly as a result of CMake scripting errors [#8704](https://github.com/ClickHouse/ClickHouse/pull/8704) ([kreuzerkrieg](https://github.com/kreuzerkrieg))
- Describe reasons if query profiler cannot work. This is intended for [#9049](https://github.com/ClickHouse/ClickHouse/issues/9049) [#9144](https://github.com/ClickHouse/ClickHouse/pull/9144) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update OpenSSL to upstream master. Fixed the issue when TLS connections may fail with the message `OpenSSL SSL_read: error:14094438:SSL routines:ssl3_read_bytes:tlsv1 alert internal error` and `SSL Exception: error:2400006E:random number generator::error retrieving entropy`. The issue was present in version 20.1. [#8956](https://github.com/ClickHouse/ClickHouse/pull/8956) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update Dockerfile for server [#8893](https://github.com/ClickHouse/ClickHouse/pull/8893) ([Ilya Mazaev](https://github.com/ne-ray))
- Minor fixes in build-gcc-from-sources script [#8774](https://github.com/ClickHouse/ClickHouse/pull/8774) ([Michael Nacharov](https://github.com/mnach))
- Replace `numbers` to `zeros` in perftests where `number` column is not used. This will lead to more clean test results. [#9600](https://github.com/ClickHouse/ClickHouse/pull/9600) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix stack overflow issue when using initializer_list in Column constructors. [#9367](https://github.com/ClickHouse/ClickHouse/pull/9367) ([Deleted user](https://github.com/ghost))
- Upgrade librdkafka to v1.3.0. Enable bundled `rdkafka` and `gsasl` libraries on Mac OS X. [#9000](https://github.com/ClickHouse/ClickHouse/pull/9000) ([Andrew Onyshchuk](https://github.com/oandrew))
- build fix on GCC 9.2.0 [#9306](https://github.com/ClickHouse/ClickHouse/pull/9306) ([vxider](https://github.com/Vxider))





## ClickHouse リリース v20.1 {#clickhouse-release-v201}

### ClickHouse リリース v20.1.16.120-stable 2020-60-26 {#clickhouse-release-v20116120-stable-2020-60-26}

#### バグ修正 {#bug-fix-50}

- prewhere条件で`Nullable`カラムを使用した際に発生する稀なクラッシュを修正しました。[#11608](https://github.com/ClickHouse/ClickHouse/issues/11608)の続きです。[#11869](https://github.com/ClickHouse/ClickHouse/pull/11869) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 高階関数内でarrayJoinを使用できないようにしました。これはプロトコル同期の破損を引き起こしていました。これにより[#3933](https://github.com/ClickHouse/ClickHouse/issues/3933)が解決されます。[#11846](https://github.com/ClickHouse/ClickHouse/pull/11846) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- エラーが予期されるにもかかわらず成功していた`SELECT *, xyz.*`のようなクエリの予期しない動作を修正しました。[#11753](https://github.com/ClickHouse/ClickHouse/pull/11753) ([hexiaoting](https://github.com/hexiaoting))。
- Values入力フォーマットにおける複雑なリテラルの誤った型推論によって引き起こされるLOGICAL_ERRORを修正しました。[#11732](https://github.com/ClickHouse/ClickHouse/pull/11732) ([tavplubix](https://github.com/tavplubix))。
- 定数カラムに対する`ORDER BY ... WITH FILL`を修正しました。[#11697](https://github.com/ClickHouse/ClickHouse/pull/11697) ([Anton Popov](https://github.com/CurtizJ))。
- XDBCブリッジとの通信時に適切なタイムアウトを渡すようにしました。最近、ブリッジの生存確認とメタ情報の受信時にタイムアウトが尊重されていませんでした。[#11690](https://github.com/ClickHouse/ClickHouse/pull/11690) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 大文字小文字を区別しないフラグを持つ正規表現のサポートを追加しました。これにより[#11101](https://github.com/ClickHouse/ClickHouse/issues/11101)と[#11506](https://github.com/ClickHouse/ClickHouse/issues/11506)が修正されます。[#11649](https://github.com/ClickHouse/ClickHouse/pull/11649) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- String型のブルームフィルタ(データスキップインデックス)を修正しました。[#11638](https://github.com/ClickHouse/ClickHouse/pull/11638) ([Azat Khuzhin](https://github.com/azat))。
- prewhere条件で`Nullable`カラムを使用した際に発生する稀なクラッシュを修正しました。(おそらく[#11572](https://github.com/ClickHouse/ClickHouse/issues/11572)と何らかの関連があります)。[#11608](https://github.com/ClickHouse/ClickHouse/pull/11608) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- exception.code() % 256 = 0の場合のclickhouse-clientの誤った終了コードを修正しました。[#11601](https://github.com/ClickHouse/ClickHouse/pull/11601) ([filimonov](https://github.com/filimonov))。
- サーバー起動時の「Mark cache size was lowered」に関するログメッセージの些細なエラーを修正しました。これにより[#11399](https://github.com/ClickHouse/ClickHouse/issues/11399)が解決されます。[#11589](https://github.com/ClickHouse/ClickHouse/pull/11589) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- clickhouse-server dockerコンテナは、サーバーの生存確認にIPv6を優先するようになりました。[#11550](https://github.com/ClickHouse/ClickHouse/pull/11550) ([Ivan Starkov](https://github.com/istarkov))。
- -State関数を使用した集約の途中で例外がスローされた場合のメモリリークを修正しました。これにより[#8995](https://github.com/ClickHouse/ClickHouse/issues/8995)が修正されます。[#11496](https://github.com/ClickHouse/ClickHouse/pull/11496) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 'FINAL'修飾子と'ORDER BY'最適化を伴う関数でラップされた主キーの使用を修正しました。[#10715](https://github.com/ClickHouse/ClickHouse/pull/10715) ([Anton Popov](https://github.com/CurtizJ))。


### ClickHouse release v20.1.15.109-stable 2020-06-19 {#clickhouse-release-v20115109-stable-2020-06-19}

#### バグ修正 {#bug-fix-51}

- ALTER実行時の構造に対する過剰なロックを修正。[#11790](https://github.com/ClickHouse/ClickHouse/pull/11790) ([alesapin](https://github.com/alesapin))。

### ClickHouse release v20.1.14.107-stable 2020-06-11 {#clickhouse-release-v20114107-stable-2020-06-11}

#### バグ修正 {#bug-fix-52}

- `PREWHERE column in (subquery)`と`ARRAY JOIN`を含むクエリで発生する`Size of offsets does not match size of column`エラーを修正。[#11580](https://github.com/ClickHouse/ClickHouse/pull/11580) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。

### ClickHouse release v20.1.13.105-stable 2020-06-10 {#clickhouse-release-v20113105-stable-2020-06-10}

#### バグ修正 {#bug-fix-53}


* `min_bytes_to_use_direct_io` が有効で、PREWHERE が有効かつ SAMPLE を使用している場合、またはスレッド数が多い場合に発生し得る `Data compressed with different methods` エラーを修正しました。これにより [#11539](https://github.com/ClickHouse/ClickHouse/issues/11539) が解決されました。 [#11540](https://github.com/ClickHouse/ClickHouse/pull/11540) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* コーデックの圧縮サイズの返り値を修正。 [#11448](https://github.com/ClickHouse/ClickHouse/pull/11448) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 列がリテラル以外の引数を持つ圧縮コーデックを使用している場合に発生するサーバークラッシュを修正しました。 [#11365](https://github.com/ClickHouse/ClickHouse/issues/11365) を修正。 [#11431](https://github.com/ClickHouse/ClickHouse/pull/11431)（[alesapin](https://github.com/alesapin)）。
* point に NaN が指定された場合の pointInPolygon を修正。[#11375](https://github.com/ClickHouse/ClickHouse/issues/11375) を解決。[#11421](https://github.com/ClickHouse/ClickHouse/pull/11421)（[Alexey Ilyukhov](https://github.com/livace)）。
* 緯度・経度の範囲外の引数が指定された場合の geohashesInBox の挙動を修正しました。 [#11403](https://github.com/ClickHouse/ClickHouse/pull/11403) ([Vasily Nemkov](https://github.com/Enmk)).
* 外部ソートと `LIMIT` を含むクエリで発生しうる `Pipeline stuck` エラーを修正しました。 [#11359](https://github.com/ClickHouse/ClickHouse/issues/11359) を解決しました。 [#11366](https://github.com/ClickHouse/ClickHouse/pull/11366) （[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `quantilesExactWeightedArray` で発生していたクラッシュを修正。 [#11337](https://github.com/ClickHouse/ClickHouse/pull/11337) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `parallel_view_processing = 1` 設定時の `MATERIALIZED VIEW` への書き込みを、再度並列実行できるようにしました。[#10241](https://github.com/ClickHouse/ClickHouse/issues/10241) を修正。[#11330](https://github.com/ClickHouse/ClickHouse/pull/11330)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 抽出された JSON に、対応の取れていない &#123; または [ を含む文字列がある場合の `visitParamExtractRaw` の動作を修正。[#11318](https://github.com/ClickHouse/ClickHouse/pull/11318) ([Ewout](https://github.com/devwout))。
* ThreadPool における非常にまれなレースコンディションを修正しました。 [#11314](https://github.com/ClickHouse/ClickHouse/pull/11314) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 変換処理時の未初期化メモリ使用の可能性を修正。例: `SELECT toIntervalSecond(now64())`。 [#11311](https://github.com/ClickHouse/ClickHouse/pull/11311) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* プライマリキーに Array 型のカラムを持つテーブルで、そのカラムに対して `empty` または `notEmpty` 関数を用いてフィルタリングを行うクエリの場合に、インデックス解析が機能しない問題を修正しました。これにより [#11286](https://github.com/ClickHouse/ClickHouse/issues/11286) の問題が解決されました。 [#11303](https://github.com/ClickHouse/ClickHouse/pull/11303) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* バグ修正: クエリが `max_network_bandwidth`、`max_execution_speed` または `priority` 設定によってスロットルされている場合に、クエリ速度の推定が誤ってしまい、`min_execution_speed` の制限がまったく効かなかったり、正しく動作しない可能性がある問題を修正しました。`timeout_before_checking_execution_speed` のデフォルト値をゼロ以外に変更しました。そうしないと、`min_execution_speed` および `max_execution_speed` の設定がまったく効果を持たないためです。これにより [#11297](https://github.com/ClickHouse/ClickHouse/issues/11297) が修正されます。これにより [#5732](https://github.com/ClickHouse/ClickHouse/issues/5732) が修正されます。これにより [#6228](https://github.com/ClickHouse/ClickHouse/issues/6228) が修正されます。ユーザビリティの改善: `clickhouse-client` において、例外メッセージとプログレスバーが連結されてしまうことを回避しました。 [#11296](https://github.com/ClickHouse/ClickHouse/pull/11296) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* Protobuf 形式の不正なデータの読み込み時に発生するクラッシュを修正しました。これにより [#5957](https://github.com/ClickHouse/ClickHouse/issues/5957) および [#11203](https://github.com/ClickHouse/ClickHouse/issues/11203) の問題が解決されました。[#11258](https://github.com/ClickHouse/ClickHouse/pull/11258)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `Array(Array(LowCardinality))` をキャプチャ引数として持つ高階関数で発生する可能性のある `Cannot capture column` エラーを修正しました。 [#11185](https://github.com/ClickHouse/ClickHouse/pull/11185) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* データスキッピングインデックスが、バックグラウンドマージ中に変更される列（SummingMergeTree、AggregatingMergeTree、TTL GROUP BY など）に依存している場合、インデックスが正しく計算されていませんでした。この問題は、マージ後にインデックスを計算するよう処理の順序を変更し、インデックスがマージ済みデータに対して計算されるようにすることで修正されました。 [#11162](https://github.com/ClickHouse/ClickHouse/pull/11162) ([Azat Khuzhin](https://github.com/azat)).
* 何も確定されなかった場合は、mutation の最終処理タスクでのロギングを削除しました。 [#11109](https://github.com/ClickHouse/ClickHouse/pull/11109) ([alesapin](https://github.com/alesapin)).
* parseDateTime64BestEffort の引数の解決処理に関する不具合を修正しました。[#10925](https://github.com/ClickHouse/ClickHouse/issues/10925)。[#11038](https://github.com/ClickHouse/ClickHouse/pull/11038) ([Vasily Nemkov](https://github.com/Enmk))。
* メソッド `getRawData()` の生データサイズの誤りを修正。[#10964](https://github.com/ClickHouse/ClickHouse/pull/10964)（[Igr](https://github.com/ObjatieGroba)）。
* Distributedテーブルにおけるタプルの後方互換性の問題を修正しました。 [#10889](https://github.com/ClickHouse/ClickHouse/pull/10889) ([Anton Popov](https://github.com/CurtizJ))。
* StringHashTable で、存在しないキーに対して SIGSEGV が発生する問題を修正。 [#10870](https://github.com/ClickHouse/ClickHouse/pull/10870) ([Azat Khuzhin](https://github.com/azat)).
* `ReplicatedMergeTree` において、レプリカが非アクティブになった後も一部の `ALTER` または `OPTIMIZE` クエリがそのレプリカを待ち続けてハングしてしまう可能性があった問題を修正しました。[#10849](https://github.com/ClickHouse/ClickHouse/pull/10849) ([tavplubix](https://github.com/tavplubix)).
* Block::sortColumns() の後にカラム順を修正（実際のユースケース（Buffer エンジン）に影響することを示すテストも追加）。 [#10826](https://github.com/ClickHouse/ClickHouse/pull/10826) ([Azat Khuzhin](https://github.com/azat))。
* 識別子をクオートしないよう指定された場合に発生する ODBC bridge の問題を修正しました。これにより [#7984](https://github.com/ClickHouse/ClickHouse/issues/7984) が解決されました。[#10821](https://github.com/ClickHouse/ClickHouse/pull/10821)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* DateLUT における UBSan および MSan で報告された問題を修正。 [#10798](https://github.com/ClickHouse/ClickHouse/pull/10798) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* * キー条件における正しい型変換のために `src_type` を使用するようにしました。 [#6287](https://github.com/ClickHouse/ClickHouse/issues/6287) を修正。 [#10791](https://github.com/ClickHouse/ClickHouse/pull/10791)（[Andrew Onyshchuk](https://github.com/oandrew)）。
* `parallel_view_processing` の動作を修正しました。これにより、例外が発生した場合でも、すべての `MATERIALIZED VIEW` への挿入が必ず完了するようになりました。[#10241](https://github.com/ClickHouse/ClickHouse/issues/10241) を修正します。 [#10757](https://github.com/ClickHouse/ClickHouse/pull/10757) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* -State と組み合わせて使用された場合の -OrNull および -OrDefault コンビネータを修正しました。 [#10741](https://github.com/ClickHouse/ClickHouse/pull/10741) ([hcz](https://github.com/hczhcz)).
* 消えてしまう `totals` の問題を修正しました。クエリに `JOIN` やサブクエリがあり、外側に `WHERE` 句がある場合に、`totals` がフィルタリングされてしまう可能性があった問題を修正しました。 [#10674](https://github.com/ClickHouse/ClickHouse/issues/10674) を修正。 [#10698](https://github.com/ClickHouse/ClickHouse/pull/10698)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 1つのクエリ内で同一の集合に対して `IN` 演算子が複数回使用されている場合の問題を修正しました。 [#10686](https://github.com/ClickHouse/ClickHouse/pull/10686) ([Anton Popov](https://github.com/CurtizJ)).
* AggregateTransform コンストラクターのパラメーター順を修正しました。 [#10667](https://github.com/ClickHouse/ClickHouse/pull/10667) ([palasonic1](https://github.com/palasonic1)).
* `distributed_aggregation_memory_efficient` を有効にした場合に、リモートクエリが並列実行されない問題を修正しました。[#10655](https://github.com/ClickHouse/ClickHouse/issues/10655) を修正します。[#10664](https://github.com/ClickHouse/ClickHouse/pull/10664)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `HAVING` セクションを含むクエリ（すなわち、イニシエーターサーバー側でのフィルタリングが必要な場合）に対する分散クエリの述語最適化（`enable_optimize_predicate_expression=1`）を、式の順序を保持することで修正（これだけで十分）し、さらにアグリゲーターがインデックスではなくカラム名を使用するように強制しました。修正対象: [#10613](https://github.com/ClickHouse/ClickHouse/issues/10613)、[#11413](https://github.com/ClickHouse/ClickHouse/issues/11413)。[#10621](https://github.com/ClickHouse/ClickHouse/pull/10621)（[Azat Khuzhin](https://github.com/azat)）。
* `the BloomFilter false positive must be a double number between 0 and 1` というエラーを修正しました [#10551](https://github.com/ClickHouse/ClickHouse/issues/10551)。 [#10569](https://github.com/ClickHouse/ClickHouse/pull/10569)（[Winter Zhang](https://github.com/zhang2014)）。
* 列エイリアスでデフォルト式の型が列の型と異なる場合の `SELECT` を修正。 [#10563](https://github.com/ClickHouse/ClickHouse/pull/10563) ([Azat Khuzhin](https://github.com/azat)).
* * DateTime と同様に、DateTime64 型と String 型の値の比較を実装しました。 [#10560](https://github.com/ClickHouse/ClickHouse/pull/10560) ([Vasily Nemkov](https://github.com/Enmk)).

### ClickHouse release v20.1.12.86, 2020-05-26 {#clickhouse-release-v2011286-2020-05-26}

#### バグ修正 {#bug-fix-54}


* バージョン 20.1 より前のバージョンとの間に存在した二段階集約処理の非互換性を修正しました。この非互換性は、イニシエーターノードとリモートノードで異なるバージョンの ClickHouse が使用されており、`GROUP BY` の結果セットのサイズが大きく、単一の `String` フィールドで集約が行われる場合に発生します。その結果、1 つのキーに対してマージされていない複数行が結果に含まれる可能性がありました。[#10952](https://github.com/ClickHouse/ClickHouse/pull/10952) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* マージ後に発生する可能性があった、`SummingMergeTree` における `LowCardinality(FixedString)` キーカラムのデータ破損を修正しました。[#10489](https://github.com/ClickHouse/ClickHouse/issues/10489) を修正します。 [#10721](https://github.com/ClickHouse/ClickHouse/pull/10721)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `readonly=2` かつ `cancel_http_readonly_queries_on_client_close=1` の場合に、クライアントが接続を閉じた際に HTTP リクエストが完了せずハングするバグを修正しました。[#7939](https://github.com/ClickHouse/ClickHouse/issues/7939)、[#7019](https://github.com/ClickHouse/ClickHouse/issues/7019)、[#7736](https://github.com/ClickHouse/ClickHouse/issues/7736)、[#7091](https://github.com/ClickHouse/ClickHouse/issues/7091) を修正。[#10684](https://github.com/ClickHouse/ClickHouse/pull/10684)（[tavplubix](https://github.com/tavplubix)）。
* `SYSTEM DROP DNS CACHE` クエリの実行時に、特定の IP アドレスからの接続が許可されているかどうかを確認するために使用されるキャッシュも同時に削除されてしまう不具合を修正しました。 [#10608](https://github.com/ClickHouse/ClickHouse/pull/10608) ([tavplubix](https://github.com/tavplubix))。
* 依存テーブルを含む場合に、`MATERIALIZED VIEW` の内部クエリ内で誤ったスカラー値が返される問題を修正しました。 [#10603](https://github.com/ClickHouse/ClickHouse/pull/10603) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* すべてのパーツのmutationが完了しているにもかかわらず、`is_done=0` の状態でハングしてしまう問題を修正しました。 [#10526](https://github.com/ClickHouse/ClickHouse/pull/10526) ([alesapin](https://github.com/alesapin)).
* UTC からのオフセットに小数部（分単位など）を持つタイムゾーンにおいて、Unix エポックの開始時点で発生していたオーバーフローを修正しました。これにより [#9335](https://github.com/ClickHouse/ClickHouse/issues/9335) が解決されます。[#10513](https://github.com/ClickHouse/ClickHouse/pull/10513)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* Distributed ストレージの不適切なシャットダウン処理を修正しました。 [#10491](https://github.com/ClickHouse/ClickHouse/pull/10491) ([Azat Khuzhin](https://github.com/azat)).
* 大きな整数を扱う `simpleLinearRegression` で発生していた数値オーバーフローを修正しました。 [#10474](https://github.com/ClickHouse/ClickHouse/pull/10474) ([hcz](https://github.com/hczhcz)).
* `ATTACH DATABASE` が失敗した際に、メタデータディレクトリが誤って削除される問題を修正しました。 [#10442](https://github.com/ClickHouse/ClickHouse/pull/10442) ([Winter Zhang](https://github.com/zhang2014)).
* `BloomFilter` インデックスを作成する際に、引数の数と型をチェックするようにしました [#9623](https://github.com/ClickHouse/ClickHouse/issues/9623)。[#10431](https://github.com/ClickHouse/ClickHouse/pull/10431)（[Winter Zhang](https://github.com/zhang2014)）。
* `ARRAY JOIN`、`ORDER BY`、`LIMIT` を含むクエリが不完全な結果を返す可能性のあった問題を修正しました。これにより [#10226](https://github.com/ClickHouse/ClickHouse/issues/10226) が修正されました。 [#10427](https://github.com/ClickHouse/ClickHouse/pull/10427) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `skip_unavailable_shards` よりも `fallback_to_stale_replicas` の使用を推奨します。 [#10422](https://github.com/ClickHouse/ClickHouse/pull/10422) ([Azat Khuzhin](https://github.com/azat)).
* `Array(Tuple(...))` データ型の誤ったフラット化処理を修正しました。これにより [#10259](https://github.com/ClickHouse/ClickHouse/issues/10259) が解決されました。 [#10390](https://github.com/ClickHouse/ClickHouse/pull/10390) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* バッファから `HashMap` を読み込もうとした際に発生していたコンパイルエラーの原因となっていた `HashTable` の誤った動作を修正しました。 [#10386](https://github.com/ClickHouse/ClickHouse/pull/10386) ([palasonic1](https://github.com/palasonic1)).
* リモートクエリの実行中に発生する可能性のあった `ConcatProcessor` の `Pipeline stuck` エラーを修正しました。 [#10381](https://github.com/ClickHouse/ClickHouse/pull/10381) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `max_rows_to_group_by` と `group_by_overflow_mode = 'break'` を使用している場合に発生する `Pipeline stuck` エラーを修正しました。 [#10279](https://github.com/ClickHouse/ClickHouse/pull/10279) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 一部のデータが `quorum` 付きで挿入された後に、`DROP PARTITION` や `TTL` などにより削除された場合に、`INSERT` が停止したり、`SELECT` で誤った例外が発生したりする不具合を複数修正しました。これにより [#9946](https://github.com/ClickHouse/ClickHouse/issues/9946) が解決されました。[#10188](https://github.com/ClickHouse/ClickHouse/pull/10188)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* リモートサーバーで 18.12.17 より前のバージョンを、発行側サーバーでそれ以降の新しいバージョンを使用している場合に、`GROUP BY` に固定キーと非固定キーの両方が含まれ、かつ二段階 `GROUP BY` メソッドが有効化されていると発生していた互換性の問題を修正しました。 [#3254](https://github.com/ClickHouse/ClickHouse/pull/3254) ([alexey-milovidov](https://github.com/alexey-milovidov)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-21}

- clickhouse-server Dockerイメージに CA 証明書を追加しました。[#10476](https://github.com/ClickHouse/ClickHouse/pull/10476) ([filimonov](https://github.com/filimonov))。

### ClickHouse リリース v20.1.10.70, 2020-04-17 {#clickhouse-release-v2011070-2020-04-17}

#### バグ修正 {#bug-fix-55}


* まれに発生する可能性のある例外 `Cannot drain connections: cancel first` を修正しました。 [#10239](https://github.com/ClickHouse/ClickHouse/pull/10239) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `ENGINE = Replicated*` を使用したテーブルに対してユーザーが `ALTER UPDATE/DELETE` を実行しようとした際に、ClickHouse が `'Unknown function lambda.'` というエラーメッセージを返してしまう不具合を修正しました。非決定的関数のチェックで、ラムダ式も正しく扱えるようになりました。[#10237](https://github.com/ClickHouse/ClickHouse/pull/10237) ([Alexander Kazakov](https://github.com/Akazz)).
* RFC-2822 形式の文字列のうち、曜日が火曜日または木曜日である場合の `parseDateTimeBestEffort` の動作を修正しました。これにより [#10082](https://github.com/ClickHouse/ClickHouse/issues/10082) が解決されます。 [#10214](https://github.com/ClickHouse/ClickHouse/pull/10214) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `JOIN` の外側にある定数と名前が衝突する可能性のあった、`JOIN` 内部の定数の列名を修正しました。 [#10207](https://github.com/ClickHouse/ClickHouse/pull/10207) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `system.numbers` や `system.zeros` のような無限に続くソースから読み込む際、本来は `LIMIT` で停止すべきクエリが無限に実行され続けてしまう可能性がある問題を修正。 [#10206](https://github.com/ClickHouse/ClickHouse/pull/10206) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 特定のケースにおいて `arrayJoin` 関数を含む場合の move-to-prewhere 最適化を修正しました。これにより [#10092](https://github.com/ClickHouse/ClickHouse/issues/10092) が修正されました。 [#10195](https://github.com/ClickHouse/ClickHouse/pull/10195) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `allow_nondeterministic_mutations` 設定によって、ミューテーション内での非決定的関数の使用制限を緩和できるようにしました。 [#10186](https://github.com/ClickHouse/ClickHouse/pull/10186) ([filimonov](https://github.com/filimonov)).
* `Distributed` エンジンを持つテーブルへの `INSERT` 時に構造が一致しないブロックを変換するようにしました。 [#10135](https://github.com/ClickHouse/ClickHouse/pull/10135) ([Azat Khuzhin](https://github.com/azat)).
* 基盤となるテーブルと構造が異なる `Distributed` テーブルへの `INSERT` 時に `SIGSEGV` が発生する問題を修正。[#10105](https://github.com/ClickHouse/ClickHouse/pull/10105) ([Azat Khuzhin](https://github.com/azat)).
* `JOIN` および `UNION ALL` を含むクエリで行が失われる可能性のある問題を修正。[#9826](https://github.com/ClickHouse/ClickHouse/issues/9826)、[#10113](https://github.com/ClickHouse/ClickHouse/issues/10113) を修正。[#10099](https://github.com/ClickHouse/ClickHouse/pull/10099)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* MySQL Database Engine に引数チェックを追加し、識別子引数をサポートしました。 [#10077](https://github.com/ClickHouse/ClickHouse/pull/10077) ([Winter Zhang](https://github.com/zhang2014)).
* localhost 上の ClickHouse サーバーをソースとする ClickHouse Dictionary のバグを修正しました。このバグにより、Dictionary とソースの型が互換ではない場合にメモリ破損が発生する可能性がありました。 [#10071](https://github.com/ClickHouse/ClickHouse/pull/10071) ([alesapin](https://github.com/alesapin)).
* エラー `Cannot clone block with columns because block has 0 columns ... While executing GroupingAggregatedTransform` を修正しました。`distributed_aggregation_memory_efficient` 設定が有効化されている状態で、分散クエリが異なるシャードから集約レベルの異なるデータ（単一レベルと二段階レベルの集約が混在）を読み取る場合に発生していました。 [#10063](https://github.com/ClickHouse/ClickHouse/pull/10063) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 末尾にヌルバイトを含む文字列キーに対する `GROUP BY` で発生する可能性があったセグメンテーションフォールトを修正しました（[#8636](https://github.com/ClickHouse/ClickHouse/issues/8636)、[#8925](https://github.com/ClickHouse/ClickHouse/issues/8925)）。[#10025](https://github.com/ClickHouse/ClickHouse/pull/10025)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 一部のデータベースへのクエリ処理のある段階で、必要なテーブルが取得されていなかったバグを修正。[#9699](https://github.com/ClickHouse/ClickHouse/issues/9699) を解決。[#9949](https://github.com/ClickHouse/ClickHouse/pull/9949)（[achulkov2](https://github.com/achulkov2)）。
* `JOIN` と `TOTALS` を併用した際に発生する `'Not found column in block'` エラーを修正。 [#9839](https://github.com/ClickHouse/ClickHouse/issues/9839) を修正。 [#9939](https://github.com/ClickHouse/ClickHouse/pull/9939)（[Artem Zuikov](https://github.com/4ertus2)）。
* サーバー起動時に `ON CLUSTER` DDL クエリがフリーズするバグを修正しました。 [#9927](https://github.com/ClickHouse/ClickHouse/pull/9927) ([Gagan Arneja](https://github.com/garneja))。
* Join テーブルエンジン向けの `TRUNCATE` を修正しました（[#9917](https://github.com/ClickHouse/ClickHouse/issues/9917)）。[#9920](https://github.com/ClickHouse/ClickHouse/pull/9920)（[Amos Bird](https://github.com/amosbird)）。
* ALTER クエリで発生する `'scalar does not exist'` エラーを修正しました（[#9878](https://github.com/ClickHouse/ClickHouse/issues/9878)）。[#9904](https://github.com/ClickHouse/ClickHouse/pull/9904)（[Amos Bird](https://github.com/amosbird)）。
* `ReplicatedMergeTree` における drop と optimize 間で発生するレースコンディションを修正。 [#9901](https://github.com/ClickHouse/ClickHouse/pull/9901) ([alesapin](https://github.com/alesapin)).
* `ATTACH PART` における `DeleteOnDestroy` ロジックを修正し、アタッチされたパーツが自動的に削除されてしまう不具合を解消するとともに、いくつかのテストを追加しました。 [#9410](https://github.com/ClickHouse/ClickHouse/pull/9410) ([Vladimir Chebotarev](https://github.com/excitoon)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-22}

- 単体テスト `collapsing_sorted_stream` を修正しました。[#9367](https://github.com/ClickHouse/ClickHouse/pull/9367) ([Deleted user](https://github.com/ghost))。

### ClickHouse リリース v20.1.9.54, 2020-03-28 {#clickhouse-release-v201954-2020-03-28}

#### バグ修正 {#bug-fix-56}

- 分散テーブルに対して `PREWHERE` と `WHERE` を含むクエリで `SET distributed_product_mode = 'local'` が設定されている場合に発生する `'Different expressions with the same alias'` エラーを修正しました。[#9871](https://github.com/ClickHouse/ClickHouse/pull/9871) ([Artem Zuikov](https://github.com/4ertus2))。
- 複合主キーを持つテーブルに対するミューテーションの過剰なメモリ消費を修正しました。これにより [#9850](https://github.com/ClickHouse/ClickHouse/issues/9850) が修正されます。[#9860](https://github.com/ClickHouse/ClickHouse/pull/9860) ([alesapin](https://github.com/alesapin))。
- INSERT クエリにおいて、シャードは例外をスローする代わりに、イニシエーターから取得した設定をシャードの制約に合わせて調整するようになりました。この修正により、異なる制約を持つシャードに `INSERT` クエリを送信できるようになります。この変更は [#9447](https://github.com/ClickHouse/ClickHouse/issues/9447) の修正を改善します。[#9852](https://github.com/ClickHouse/ClickHouse/pull/9852) ([Vitaly Baranov](https://github.com/vitlibar))。
- クライアントで発生する可能性のある `Got 0 in totals chunk, expected 1` 例外を修正しました。これは、右結合テーブルが0行の場合に `JOIN` を含むクエリで発生していました。例: `select * from system.one t1 join system.one t2 on t1.dummy = t2.dummy limit 0 FORMAT TabSeparated;`。[#9777](https://github.com/ClickHouse/ClickHouse/issues/9777) を修正します。[#9823](https://github.com/ClickHouse/ClickHouse/pull/9823) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 型を変換できない場合に `optimize_skip_unused_shards` で発生する `SIGSEGV` を修正しました。[#9804](https://github.com/ClickHouse/ClickHouse/pull/9804) ([Azat Khuzhin](https://github.com/azat))。
- 関数引数のタイムゾーンが適切に使用されていなかったいくつかのケースを修正しました。[#9574](https://github.com/ClickHouse/ClickHouse/pull/9574) ([Vasily Nemkov](https://github.com/Enmk))。

#### 改善 {#improvement-21}

- 単一のスレッドで単一の順序付けられたパートから読み取るため、ミューテーションから `ORDER BY` ステージを削除しました。また、ミューテーション内の行の順序がソートキーの順序で並んでおり、この順序が違反されていないことを確認するチェックを追加しました。[#9886](https://github.com/ClickHouse/ClickHouse/pull/9886) ([alesapin](https://github.com/alesapin))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-23}

- 重複したリンカーフラグをクリーンアップしました。リンカーが予期しないシンボルを検索しないようにします。[#9433](https://github.com/ClickHouse/ClickHouse/pull/9433) ([Amos Bird](https://github.com/amosbird))。

### ClickHouse リリース v20.1.8.41, 2020-03-20 {#clickhouse-release-v201841-2020-03-20}


#### バグ修正 {#bug-fix-57}

- `ParallelAggregatingBlockInputStream::Handler::onFinish/onFinishThread`での未処理の例外により発生する可能性のある恒久的な`Cannot schedule a task`エラーを修正しました。この修正は[#6833](https://github.com/ClickHouse/ClickHouse/issues/6833)に対応しています。[#9154](https://github.com/ClickHouse/ClickHouse/pull/9154) ([Azat Khuzhin](https://github.com/azat))
- `ALTER`クエリ(ミューテーション)における過剰なメモリ消費を修正しました。この修正は[#9533](https://github.com/ClickHouse/ClickHouse/issues/9533)および[#9670](https://github.com/ClickHouse/ClickHouse/issues/9670)に対応しています。[#9754](https://github.com/ClickHouse/ClickHouse/pull/9754) ([alesapin](https://github.com/alesapin))
- 外部ディクショナリのDDLにおけるバッククォートのバグを修正しました。この修正は[#9619](https://github.com/ClickHouse/ClickHouse/issues/9619)に対応しています。[#9734](https://github.com/ClickHouse/ClickHouse/pull/9734) ([alesapin](https://github.com/alesapin))

### ClickHouse リリース v20.1.7.38, 2020-03-18 {#clickhouse-release-v201738-2020-03-18}


#### バグ修正 {#bug-fix-58}

- `sumKahan`と`sumWithOverflow`の内部関数名の誤りを修正しました。リモートクエリでこれらの関数を使用する際に例外が発生していました。[#9636](https://github.com/ClickHouse/ClickHouse/pull/9636) ([Azat Khuzhin](https://github.com/azat))。この問題はすべてのClickHouseリリースに存在していました。
- 内部レプリケーションを持つ`Distributed`テーブルに対する`ALTER ON CLUSTER`を許可しました。これにより[#3268](https://github.com/ClickHouse/ClickHouse/issues/3268)が修正されます。[#9617](https://github.com/ClickHouse/ClickHouse/pull/9617) ([shinoi2](https://github.com/shinoi2))。この問題はすべてのClickHouseリリースに存在していました。
- `MergeTreeRangeReader`における`Size of filter does not match size of column`および`Invalid number of rows in Chunk`の例外の可能性を修正しました。これらは一部のケースで`PREWHERE`の実行中に発生する可能性がありました。修正:[#9132](https://github.com/ClickHouse/ClickHouse/issues/9132)。[#9612](https://github.com/ClickHouse/ClickHouse/pull/9612) ([Anton Popov](https://github.com/CurtizJ))
- 問題を修正しました:`time + 1`のような単純な算術式を記述した場合にタイムゾーンが保持されませんでした(`time + INTERVAL 1 SECOND`のような式とは対照的に)。これにより[#5743](https://github.com/ClickHouse/ClickHouse/issues/5743)が修正されます。[#9323](https://github.com/ClickHouse/ClickHouse/pull/9323) ([alexey-milovidov](https://github.com/alexey-milovidov))。この問題はすべてのClickHouseリリースに存在していました。
- `a DEFAULT b, b DEFAULT a`のような単純な循環エイリアスを持つカラムの作成または追加ができなくなりました。[#9603](https://github.com/ClickHouse/ClickHouse/pull/9603) ([alesapin](https://github.com/alesapin))
- base64エンコード値の末尾のパディングが不正になる可能性がある問題を修正しました。base64ライブラリを更新しました。これにより[#9491](https://github.com/ClickHouse/ClickHouse/issues/9491)が修正され、[#9492](https://github.com/ClickHouse/ClickHouse/issues/9492)がクローズされます。[#9500](https://github.com/ClickHouse/ClickHouse/pull/9500) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `Poco::HTTPServer`の破棄時のデータ競合を修正しました。これはサーバーが起動後すぐにシャットダウンされた場合に発生する可能性がありました。[#9468](https://github.com/ClickHouse/ClickHouse/pull/9468) ([Anton Popov](https://github.com/CurtizJ))
- n番目の行と等しい行が多数存在する場合の`LIMIT n WITH TIES`における可能性のあるクラッシュ/誤った行数を修正しました。[#9464](https://github.com/ClickHouse/ClickHouse/pull/9464) ([tavplubix](https://github.com/tavplubix))
- カラムTTLにおけるチェックサムの不一致の可能性を修正しました。[#9451](https://github.com/ClickHouse/ClickHouse/pull/9451) ([Anton Popov](https://github.com/CurtizJ))
- ユーザーが旧形式の`MergeTree`テーブルエンジンファミリーに対して`ALTER MODIFY SETTING`を試行した際のクラッシュを修正しました。[#9435](https://github.com/ClickHouse/ClickHouse/pull/9435) ([alesapin](https://github.com/alesapin))
- ミューテーションの完了をより頻繁に試行するようになりました。[#9427](https://github.com/ClickHouse/ClickHouse/pull/9427) ([alesapin](https://github.com/alesapin))
- [#8598](https://github.com/ClickHouse/ClickHouse/issues/8598)で導入されたレプリケーションプロトコルの非互換性を修正しました。[#9412](https://github.com/ClickHouse/ClickHouse/pull/9412) ([alesapin](https://github.com/alesapin))
- 配列型のbloom_filterインデックスに対するnot(has())を修正しました。[#9407](https://github.com/ClickHouse/ClickHouse/pull/9407) ([achimbab](https://github.com/achimbab))
- haystackにゼロバイトが含まれる場合の`match`および`extract`関数の動作を修正しました。haystackが定数の場合に動作が誤っていました。これにより[#9160](https://github.com/ClickHouse/ClickHouse/issues/9160)が修正されます。[#9163](https://github.com/ClickHouse/ClickHouse/pull/9163) ([alexey-milovidov](https://github.com/alexey-milovidov)) [#9345](https://github.com/ClickHouse/ClickHouse/pull/9345) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-24}

- Windows Subsystem for Linux上で例外処理が正しく動作するようになりました。https://github.com/ClickHouse-Extras/libunwind/pull/3 を参照してください。これにより [#6480](https://github.com/ClickHouse/ClickHouse/issues/6480) [#9564](https://github.com/ClickHouse/ClickHouse/pull/9564) が修正されました ([sobolevsv](https://github.com/sobolevsv))

### ClickHouseリリース v20.1.6.30, 2020-03-05 {#clickhouse-release-v201630-2020-03-05}

#### バグ修正 {#bug-fix-59}


* `T64` コーデックで圧縮された場合のデータの非互換性を修正。
  [#9039](https://github.com/ClickHouse/ClickHouse/pull/9039) [(abyss7)](https://github.com/abyss7)
* 1 つのスレッドで MergeTree テーブルから読み込む際の範囲の順序を修正しました。[#8964](https://github.com/ClickHouse/ClickHouse/issues/8964) の問題に対応。
  [#9050](https://github.com/ClickHouse/ClickHouse/pull/9050) [(CurtizJ)](https://github.com/CurtizJ)
* `PREWHERE` 実行中に発生する可能性があった `MergeTreeRangeReader` のセグメンテーションフォルトを修正。 [#9064](https://github.com/ClickHouse/ClickHouse/issues/9064) を解決。
  [#9106](https://github.com/ClickHouse/ClickHouse/pull/9106) [(CurtizJ)](https://github.com/CurtizJ)
* `reinterpretAsFixedString` が `String` ではなく `FixedString` を返すように修正。
* NULL を許容する戻り値型を持つ `joinGet` を修正。 [#8919](https://github.com/ClickHouse/ClickHouse/issues/8919) を解決。
  [#9014](https://github.com/ClickHouse/ClickHouse/pull/9014) [(amosbird)](https://github.com/amosbird)
* fuzz テストおよび bitTestAll/bitTestAny 関数の誤動作を修正。
  [#9143](https://github.com/ClickHouse/ClickHouse/pull/9143) [(alexey-milovidov)](https://github.com/alexey-milovidov)
* `haystack` がゼロバイトの場合の `match` 関数および `extract` 関数の動作を修正しました。`haystack` が定数の場合に誤った動作をしていました。[#9160](https://github.com/ClickHouse/ClickHouse/issues/9160) を修正しました。
  [#9163](https://github.com/ClickHouse/ClickHouse/pull/9163) [(alexey-milovidov)](https://github.com/alexey-milovidov)
* 非厳密単調な関数インデックス使用時の反転述語の実行を修正。[#9034](https://github.com/ClickHouse/ClickHouse/issues/9034) を解決。
  [#9223](https://github.com/ClickHouse/ClickHouse/pull/9223) [(Akazz)](https://github.com/Akazz)
* `WHERE` 句に `[NOT] LIKE` 演算子がある場合に、`CROSS` を `INNER JOIN` に書き換えられるようにしました。 [#9191](https://github.com/ClickHouse/ClickHouse/issues/9191) を修正しました。
  [#9229](https://github.com/ClickHouse/ClickHouse/pull/9229) [(4ertus2)](https://github.com/4ertus2)
* Log エンジンを使用するテーブルで、先頭の列（複数可）をエイリアス列として許可。
* `IN()` 内でのカンマ区切りによる結合を許可。 [#7314](https://github.com/ClickHouse/ClickHouse/issues/7314) を修正。
  [#9251](https://github.com/ClickHouse/ClickHouse/pull/9251) [(4ertus2)](https://github.com/4ertus2)
* `ALTER MODIFY/ADD` クエリのロジックを改善しました。これにより、型を指定せずにカラムを `ADD` することはできなくなり、`MODIFY` でデフォルト式を変更してもカラムの型は変更されず、`MODIFY` で型を変更してもデフォルト式の値は失われません。[#8669](https://github.com/ClickHouse/ClickHouse/issues/8669) を修正。
  [#9227](https://github.com/ClickHouse/ClickHouse/pull/9227)  [(alesapin)](https://github.com/alesapin)
* 既に完了している mutation のステータスが is&#95;done=0 になってしまう場合がある問題を修正。
  [#9217](https://github.com/ClickHouse/ClickHouse/pull/9217) [(alesapin)](https://github.com/alesapin)
* system.numbers および system.numbers&#95;mt 向けに「Processors」パイプラインをサポートしました。これにより、`max_execution_time` が適用されない不具合も修正されます。
  [#7796](https://github.com/ClickHouse/ClickHouse/pull/7796)  [(KochetovNicolai)](https://github.com/KochetovNicolai)
* `DictCacheKeysRequestedFound` メトリクスの誤ったカウント処理を修正。
  [#9411](https://github.com/ClickHouse/ClickHouse/pull/9411) [(nikitamikhaylov)](https://github.com/nikitamikhaylov)
* `ATTACH PARTITION FROM`、`REPLACE PARTITION`、`MOVE TO TABLE` にストレージポリシーのチェックを追加しました。これがない場合、再起動後にパーツのデータへアクセスできなくなり、ClickHouse が起動できなくなる問題が発生する可能性がありました。
  [#9383](https://github.com/ClickHouse/ClickHouse/pull/9383) [(excitoon)](https://github.com/excitoon)
* `MergeTreeIndexSet` における UBSan レポートを修正しました。これにより [#9250](https://github.com/ClickHouse/ClickHouse/issues/9250) が解決されます。
  [#9365](https://github.com/ClickHouse/ClickHouse/pull/9365) [(alexey-milovidov)](https://github.com/alexey-milovidov)
* BlockIO 内で発生し得るデータレースを修正。
  [#9356](https://github.com/ClickHouse/ClickHouse/pull/9356) [(KochetovNicolai)](https://github.com/KochetovNicolai)
* `Int64` に収まらない `UInt64` 型の数値に対する JSON 関連関数でのサポート。`SIMDJSON` を master ブランチに更新。これにより [#9209](https://github.com/ClickHouse/ClickHouse/issues/9209) が修正されます。
  [#9344](https://github.com/ClickHouse/ClickHouse/pull/9344) [(alexey-milovidov)](https://github.com/alexey-milovidov)
* データディレクトリが別デバイスにマウントされている場合に、空きディスク容量が正しく計算されない問題を修正しました。デフォルトディスクでは、`data` サブディレクトリを基準に空き容量を計算するようにしました。これにより [#7441](https://github.com/ClickHouse/ClickHouse/issues/7441) が修正されます。
  [#9257](https://github.com/ClickHouse/ClickHouse/pull/9257) [(millb)](https://github.com/millb)
* `OpenSSL SSL_read: error:14094438:SSL routines:ssl3_read_bytes:tlsv1 alert internal error and SSL Exception: error:2400006E:random number generator::error retrieving entropy.` というメッセージとともに TLS 接続が失敗することがある問題を修正しました。OpenSSL を upstream の master ブランチに更新しました。
  [#8956](https://github.com/ClickHouse/ClickHouse/pull/8956) [(alexey-milovidov)](https://github.com/alexey-milovidov)
* `CREATE` クエリを実行する際、ストレージエンジンの引数に含まれる定数式を畳み込みます。空のデータベース名は現在のデータベース名に置き換えます。[#6508](https://github.com/ClickHouse/ClickHouse/issues/6508)、[#3492](https://github.com/ClickHouse/ClickHouse/issues/3492) を修正します。さらに、ClickHouseDictionarySource におけるローカルアドレスのチェックも修正しました。
  [#9262](https://github.com/ClickHouse/ClickHouse/pull/9262) [(tabplubix)](https://github.com/tavplubix)
* StorageFile からの読み取り時に発生する可能性がある `StorageMerge` のセグメンテーションフォールトを修正。
  [#9387](https://github.com/ClickHouse/ClickHouse/pull/9387) [(tabplubix)](https://github.com/tavplubix)
* 例外がサフィックス読み取り後からコミット前の間に発生するというまれなケースにおいて、`Kafka` のデータが失われないようにする。[#9378](https://github.com/ClickHouse/ClickHouse/issues/9378) を修正。関連: [#7175](https://github.com/ClickHouse/ClickHouse/issues/7175)
  [#9507](https://github.com/ClickHouse/ClickHouse/pull/9507) [(filimonov)](https://github.com/filimonov)
* 誤ったパラメータで作成された `Kafka` テーブルを使用／削除しようとした際にサーバーが終了してしまう不具合を修正。[#9494](https://github.com/ClickHouse/ClickHouse/issues/9494) を修正し、[#9507](https://github.com/ClickHouse/ClickHouse/issues/9507) を取り込み。
  [#9513](https://github.com/ClickHouse/ClickHouse/pull/9513) [(filimonov)](https://github.com/filimonov)

#### 新機能 {#new-feature-12}

- マテリアライズドビューを持つテーブルへの冪等な挿入の動作を制御する `deduplicate_blocks_in_dependent_materialized_views` オプションを追加しました。この新機能は、Altinity からの特別な要望によりバグ修正リリースに追加されました。
  [#9070](https://github.com/ClickHouse/ClickHouse/pull/9070) [(urykhy)](https://github.com/urykhy)

### ClickHouse リリース v20.1.2.4, 2020-01-22 {#clickhouse-release-v20124-2020-01-22}

#### 後方互換性のない変更 {#backward-incompatible-change-10}

- 設定 `merge_tree_uniform_read_distribution` を廃止しました。サーバーは依然としてこの設定を認識しますが、効果はありません。[#8308](https://github.com/ClickHouse/ClickHouse/pull/8308) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 関数 `greatCircleDistance` の戻り値の型を `Float32` に変更しました。計算結果が `Float32` になったためです。[#7993](https://github.com/ClickHouse/ClickHouse/pull/7993) ([alexey-milovidov](https://github.com/alexey-milovidov))
- クエリパラメータは「エスケープ」形式で表現されることが期待されるようになりました。例えば、文字列 `a<tab>b` を渡すには `a\tb` または `a\<tab>b` と記述する必要があり、URL では `a%5Ctb` または `a%5C%09b` と記述します。これは NULL を `\N` として渡す機能を追加するために必要です。この変更により [#7488](https://github.com/ClickHouse/ClickHouse/issues/7488) が修正されます。[#8517](https://github.com/ClickHouse/ClickHouse/pull/8517) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `ReplicatedMergeTree` の `use_minimalistic_part_header_in_zookeeper` 設定をデフォルトで有効にしました。これにより、ZooKeeper に保存されるデータ量が大幅に削減されます。この設定はバージョン 19.1 以降でサポートされており、半年以上にわたって複数のサービスの本番環境で問題なく使用しています。バージョン 19.1 より古いバージョンにダウングレードする可能性がある場合は、この設定を無効にしてください。[#6850](https://github.com/ClickHouse/ClickHouse/pull/6850) ([alexey-milovidov](https://github.com/alexey-milovidov))
- データスキッピングインデックスは本番環境で使用可能となり、デフォルトで有効になりました。設定 `allow_experimental_data_skipping_indices`、`allow_experimental_cross_to_join_conversion`、`allow_experimental_multiple_joins_emulation` は廃止され、効果はありません。[#7974](https://github.com/ClickHouse/ClickHouse/pull/7974) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `JOIN` 操作と一貫性のある新しい `ANY JOIN` ロジックを `StorageJoin` に追加しました。動作を変更せずにアップグレードするには、Engine Join テーブルのメタデータに `SETTINGS any_join_distinct_right_table_keys = 1` を追加するか、アップグレード後にこれらのテーブルを再作成する必要があります。[#8400](https://github.com/ClickHouse/ClickHouse/pull/8400) ([Artem Zuikov](https://github.com/4ertus2))
- ログ設定の変更を適用するには、サーバーの再起動が必要です。これは、削除されたログファイルにサーバーがログを記録するバグを回避するための一時的な対処法です（[#8696](https://github.com/ClickHouse/ClickHouse/issues/8696) を参照）。[#8707](https://github.com/ClickHouse/ClickHouse/pull/8707) ([Alexander Kuzmenkov](https://github.com/akuzm))


#### 新機能 {#new-feature-13}

- `system.merges`にパートパスに関する情報を追加しました。[#8043](https://github.com/ClickHouse/ClickHouse/pull/8043) ([Vladimir Chebotarev](https://github.com/excitoon))
- `ON CLUSTER`モードで`SYSTEM RELOAD DICTIONARY`クエリを実行する機能を追加しました。[#8288](https://github.com/ClickHouse/ClickHouse/pull/8288) ([Guillaume Tassery](https://github.com/YiuRULE))
- `ON CLUSTER`モードで`CREATE DICTIONARY`クエリを実行する機能を追加しました。[#8163](https://github.com/ClickHouse/ClickHouse/pull/8163) ([alesapin](https://github.com/alesapin))
- `users.xml`内のユーザープロファイルが複数のプロファイルを継承できるようになりました。[#8343](https://github.com/ClickHouse/ClickHouse/pull/8343) ([Mikhail f. Shiryaev](https://github.com/Felixoid))
- すべてのサーバースレッドのスタックトレースを確認できる`system.stack_trace`テーブルを追加しました。これは開発者がサーバーの状態を調査するのに役立ちます。これにより[#7576](https://github.com/ClickHouse/ClickHouse/issues/7576)が修正されました。[#8344](https://github.com/ClickHouse/ClickHouse/pull/8344) ([alexey-milovidov](https://github.com/alexey-milovidov))
- サブ秒精度を設定可能な`DateTime64`データ型を追加しました。[#7170](https://github.com/ClickHouse/ClickHouse/pull/7170) ([Vasily Nemkov](https://github.com/Enmk))
- クラスタ内のすべてのノードにクエリを実行できるテーブル関数`clusterAllReplicas`を追加しました。[#8493](https://github.com/ClickHouse/ClickHouse/pull/8493) ([kiran sunkari](https://github.com/kiransunkari))
- 離散特徴の情報価値を計算する集約関数`categoricalInformationValue`を追加しました。[#8117](https://github.com/ClickHouse/ClickHouse/pull/8117) ([hcz](https://github.com/hczhcz))
- `CSV`、`TSV`、`JSONEachRow`形式のデータファイルの解析を並列処理することで高速化しました。[#7780](https://github.com/ClickHouse/ClickHouse/pull/7780) ([Alexander Kuzmenkov](https://github.com/akuzm))
- 銀行家の丸めを実行する関数`bankerRound`を追加しました。[#8112](https://github.com/ClickHouse/ClickHouse/pull/8112) ([hcz](https://github.com/hczhcz))
- 地域名の組み込み辞書でより多くの言語をサポートしました:'ru'、'en'、'ua'、'uk'、'by'、'kz'、'tr'、'de'、'uz'、'lv'、'lt'、'et'、'pt'、'he'、'vi'。[#8189](https://github.com/ClickHouse/ClickHouse/pull/8189) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `ANY JOIN`ロジックの一貫性を改善しました。現在、`t1 ANY LEFT JOIN t2`は`t2 ANY RIGHT JOIN t1`と等価です。[#7665](https://github.com/ClickHouse/ClickHouse/pull/7665) ([Artem Zuikov](https://github.com/4ertus2))
- `ANY INNER JOIN`の旧動作を有効にする設定`any_join_distinct_right_table_keys`を追加しました。[#7665](https://github.com/ClickHouse/ClickHouse/pull/7665) ([Artem Zuikov](https://github.com/4ertus2))
- 新しい`SEMI`および`ANTI JOIN`を追加しました。旧`ANY INNER JOIN`の動作は現在`SEMI LEFT JOIN`として利用可能です。[#7665](https://github.com/ClickHouse/ClickHouse/pull/7665) ([Artem Zuikov](https://github.com/4ertus2))
- `File`エンジンと`file`テーブル関数に`Distributed`形式を追加しました。これにより、`Distributed`テーブルへの非同期挿入によって生成された`.bin`ファイルから読み取ることができます。[#8535](https://github.com/ClickHouse/ClickHouse/pull/8535) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- `runningAccumulate`にオプションのリセット列引数を追加しました。これにより、新しいキー値ごとに集約結果をリセットできます。[#8326](https://github.com/ClickHouse/ClickHouse/pull/8326) ([Sergey Kononenko](https://github.com/kononencheg))
- ClickHouseをPrometheusエンドポイントとして使用する機能を追加しました。[#7900](https://github.com/ClickHouse/ClickHouse/pull/7900) ([vdimir](https://github.com/Vdimir))
- `config.xml`にセクション`<remote_url_allow_hosts>`を追加しました。これにより、リモートテーブルエンジンおよびテーブル関数`URL`、`S3`、`HDFS`の許可されたホストを制限できます。[#7154](https://github.com/ClickHouse/ClickHouse/pull/7154) ([Mikhail Korotov](https://github.com/millb))
- 球面上の距離を度数で計算する関数`greatCircleAngle`を追加しました。[#8105](https://github.com/ClickHouse/ClickHouse/pull/8105) ([alexey-milovidov](https://github.com/alexey-milovidov))
- H3ライブラリと一致するように地球の半径を変更しました。[#8105](https://github.com/ClickHouse/ClickHouse/pull/8105) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 入力と出力用に`JSONCompactEachRow`および`JSONCompactEachRowWithNamesAndTypes`形式を追加しました。[#7841](https://github.com/ClickHouse/ClickHouse/pull/7841) ([Mikhail Korotov](https://github.com/millb))
- ファイル関連のテーブルエンジンおよびテーブル関数(`File`、`S3`、`URL`、`HDFS`)に、追加のエンジンパラメータまたはファイル拡張子に基づいて`gzip`ファイルを読み書きできる機能を追加しました。[#7840](https://github.com/ClickHouse/ClickHouse/pull/7840) ([Andrey Bodrov](https://github.com/apbodrov))
- [ASCII](https://en.wikipedia.org/wiki/ASCII#Printable_characters)印字可能文字のランダムなセットで文字列を生成する`randomASCII(length)`関数を追加しました。[#8401](https://github.com/ClickHouse/ClickHouse/pull/8401) ([BayoNet](https://github.com/BayoNet))
- `JSON`文字列から未解析のJSON配列要素の配列を返す関数`JSONExtractArrayRaw`を追加しました。[#8081](https://github.com/ClickHouse/ClickHouse/pull/8081) ([Oleg Matrokhin](https://github.com/errx))
- 同じ長さの複数の配列を1つのタプル配列に結合できる関数`arrayZip`を追加しました。[#8149](https://github.com/ClickHouse/ClickHouse/pull/8149) ([Winter Zhang](https://github.com/zhang2014))
- `*MergeTree`テーブルエンジンファミリーに対して、設定された`TTL`式に従ってディスク間でデータを移動する機能を追加しました。[#8140](https://github.com/ClickHouse/ClickHouse/pull/8140) ([Vladimir Chebotarev](https://github.com/excitoon))
- 加重平均を計算できる新しい集約関数`avgWeighted`を追加しました。[#7898](https://github.com/ClickHouse/ClickHouse/pull/7898) ([Andrey Bodrov](https://github.com/apbodrov))
- `TSV`、`TSKV`、`CSV`、`JSONEachRow`形式でデフォルトで並列解析が有効になりました。[#7894](https://github.com/ClickHouse/ClickHouse/pull/7894) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- `H3`ライブラリからいくつかの地理関数を追加しました:`h3GetResolution`、`h3EdgeAngle`、`h3EdgeLength`、`h3IsValid`、`h3kRing`。[#8034](https://github.com/ClickHouse/ClickHouse/pull/8034) ([Konstantin Malanchev](https://github.com/hombit))
- ファイル関連のストレージおよびテーブル関数でbrotli(`br`)圧縮のサポートを追加しました。これにより[#8156](https://github.com/ClickHouse/ClickHouse/issues/8156)が修正されました。[#8526](https://github.com/ClickHouse/ClickHouse/pull/8526) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `SimpleAggregationFunction`型用の`groupBit*`関数を追加しました。[#8485](https://github.com/ClickHouse/ClickHouse/pull/8485) ([Guillaume Tassery](https://github.com/YiuRULE))





#### バグ修正 {#bug-fix-60}

- Fix rename of tables with `Distributed` engine. Fixes issue [#7868](https://github.com/ClickHouse/ClickHouse/issues/7868). [#8306](https://github.com/ClickHouse/ClickHouse/pull/8306) ([tavplubix](https://github.com/tavplubix))
- Now dictionaries support `EXPRESSION` for attributes in arbitrary string in non-ClickHouse SQL dialect. [#8098](https://github.com/ClickHouse/ClickHouse/pull/8098) ([alesapin](https://github.com/alesapin))
- Fix broken `INSERT SELECT FROM mysql(...)` query. This fixes [#8070](https://github.com/ClickHouse/ClickHouse/issues/8070) and [#7960](https://github.com/ClickHouse/ClickHouse/issues/7960). [#8234](https://github.com/ClickHouse/ClickHouse/pull/8234) ([tavplubix](https://github.com/tavplubix))
- Fix error "Mismatch column sizes" when inserting default `Tuple` from `JSONEachRow`. This fixes [#5653](https://github.com/ClickHouse/ClickHouse/issues/5653). [#8606](https://github.com/ClickHouse/ClickHouse/pull/8606) ([tavplubix](https://github.com/tavplubix))
- Now an exception will be thrown in case of using `WITH TIES` alongside `LIMIT BY`. Also add ability to use `TOP` with `LIMIT BY`. This fixes [#7472](https://github.com/ClickHouse/ClickHouse/issues/7472). [#7637](https://github.com/ClickHouse/ClickHouse/pull/7637) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Fix unintendent dependency from fresh glibc version in `clickhouse-odbc-bridge` binary. [#8046](https://github.com/ClickHouse/ClickHouse/pull/8046) ([Amos Bird](https://github.com/amosbird))
- Fix bug in check function of `*MergeTree` engines family. Now it does not fail in case when we have equal amount of rows in last granule and last mark (non-final). [#8047](https://github.com/ClickHouse/ClickHouse/pull/8047) ([alesapin](https://github.com/alesapin))
- Fix insert into `Enum*` columns after `ALTER` query, when underlying numeric type is equal to table specified type. This fixes [#7836](https://github.com/ClickHouse/ClickHouse/issues/7836). [#7908](https://github.com/ClickHouse/ClickHouse/pull/7908) ([Anton Popov](https://github.com/CurtizJ))
- Allowed non-constant negative "size" argument for function `substring`. It was not allowed by mistake. This fixes [#4832](https://github.com/ClickHouse/ClickHouse/issues/4832). [#7703](https://github.com/ClickHouse/ClickHouse/pull/7703) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix parsing bug when wrong number of arguments passed to `(O|J)DBC` table engine. [#7709](https://github.com/ClickHouse/ClickHouse/pull/7709) ([alesapin](https://github.com/alesapin))
- Using command name of the running clickhouse process when sending logs to syslog. In previous versions, empty string was used instead of command name. [#8460](https://github.com/ClickHouse/ClickHouse/pull/8460) ([Michael Nacharov](https://github.com/mnach))
- Fix check of allowed hosts for `localhost`. This PR fixes the solution provided in [#8241](https://github.com/ClickHouse/ClickHouse/pull/8241). [#8342](https://github.com/ClickHouse/ClickHouse/pull/8342) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix rare crash in `argMin` and `argMax` functions for long string arguments, when result is used in `runningAccumulate` function. This fixes [#8325](https://github.com/ClickHouse/ClickHouse/issues/8325) [#8341](https://github.com/ClickHouse/ClickHouse/pull/8341) ([dinosaur](https://github.com/769344359))
- Fix memory overcommit for tables with `Buffer` engine. [#8345](https://github.com/ClickHouse/ClickHouse/pull/8345) ([Azat Khuzhin](https://github.com/azat))
- Fixed potential bug in functions that can take `NULL` as one of the arguments and return non-NULL. [#8196](https://github.com/ClickHouse/ClickHouse/pull/8196) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Better metrics calculations in thread pool for background processes for `MergeTree` table engines. [#8194](https://github.com/ClickHouse/ClickHouse/pull/8194) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix function `IN` inside `WHERE` statement when row-level table filter is present. Fixes [#6687](https://github.com/ClickHouse/ClickHouse/issues/6687) [#8357](https://github.com/ClickHouse/ClickHouse/pull/8357) ([Ivan](https://github.com/abyss7))
- Now an exception is thrown if the integral value is not parsed completely for settings values. [#7678](https://github.com/ClickHouse/ClickHouse/pull/7678) ([Mikhail Korotov](https://github.com/millb))
- Fix exception when aggregate function is used in query to distributed table with more than two local shards. [#8164](https://github.com/ClickHouse/ClickHouse/pull/8164) ([小路](https://github.com/nicelulu))
- Now bloom filter can handle zero length arrays and does not perform redundant calculations. [#8242](https://github.com/ClickHouse/ClickHouse/pull/8242) ([achimbab](https://github.com/achimbab))
- Fixed checking if a client host is allowed by matching the client host to `host_regexp` specified in `users.xml`. [#8241](https://github.com/ClickHouse/ClickHouse/pull/8241) ([Vitaly Baranov](https://github.com/vitlibar))
- Relax ambiguous column check that leads to false positives in multiple `JOIN ON` section. [#8385](https://github.com/ClickHouse/ClickHouse/pull/8385) ([Artem Zuikov](https://github.com/4ertus2))
- Fixed possible server crash (`std::terminate`) when the server cannot send or write data in `JSON` or `XML` format with values of `String` data type (that require `UTF-8` validation) or when compressing result data with Brotli algorithm or in some other rare cases. This fixes [#7603](https://github.com/ClickHouse/ClickHouse/issues/7603) [#8384](https://github.com/ClickHouse/ClickHouse/pull/8384) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix race condition in `StorageDistributedDirectoryMonitor` found by CI. This fixes [#8364](https://github.com/ClickHouse/ClickHouse/issues/8364). [#8383](https://github.com/ClickHouse/ClickHouse/pull/8383) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Now background merges in `*MergeTree` table engines family preserve storage policy volume order more accurately. [#8549](https://github.com/ClickHouse/ClickHouse/pull/8549) ([Vladimir Chebotarev](https://github.com/excitoon))
- Now table engine `Kafka` works properly with `Native` format. This fixes [#6731](https://github.com/ClickHouse/ClickHouse/issues/6731) [#7337](https://github.com/ClickHouse/ClickHouse/issues/7337) [#8003](https://github.com/ClickHouse/ClickHouse/issues/8003). [#8016](https://github.com/ClickHouse/ClickHouse/pull/8016) ([filimonov](https://github.com/filimonov))
- Fixed formats with headers (like `CSVWithNames`) which were throwing exception about EOF for table engine `Kafka`. [#8016](https://github.com/ClickHouse/ClickHouse/pull/8016) ([filimonov](https://github.com/filimonov))
- Fixed a bug with making set from subquery in right part of `IN` section. This fixes [#5767](https://github.com/ClickHouse/ClickHouse/issues/5767) and [#2542](https://github.com/ClickHouse/ClickHouse/issues/2542). [#7755](https://github.com/ClickHouse/ClickHouse/pull/7755) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Fix possible crash while reading from storage `File`. [#7756](https://github.com/ClickHouse/ClickHouse/pull/7756) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed reading of the files in `Parquet` format containing columns of type `list`. [#8334](https://github.com/ClickHouse/ClickHouse/pull/8334) ([maxulan](https://github.com/maxulan))
- Fix error `Not found column` for distributed queries with `PREWHERE` condition dependent on sampling key if `max_parallel_replicas > 1`. [#7913](https://github.com/ClickHouse/ClickHouse/pull/7913) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix error `Not found column` if query used `PREWHERE` dependent on table's alias and the result set was empty because of primary key condition. [#7911](https://github.com/ClickHouse/ClickHouse/pull/7911) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed return type for functions `rand` and `randConstant` in case of `Nullable` argument. Now functions always return `UInt32` and never `Nullable(UInt32)`. [#8204](https://github.com/ClickHouse/ClickHouse/pull/8204) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Disabled predicate push-down for `WITH FILL` expression. This fixes [#7784](https://github.com/ClickHouse/ClickHouse/issues/7784). [#7789](https://github.com/ClickHouse/ClickHouse/pull/7789) ([Winter Zhang](https://github.com/zhang2014))
- Fixed incorrect `count()` result for `SummingMergeTree` when `FINAL` section is used. [#3280](https://github.com/ClickHouse/ClickHouse/issues/3280) [#7786](https://github.com/ClickHouse/ClickHouse/pull/7786) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Fix possible incorrect result for constant functions from remote servers. It happened for queries with functions like `version()`, `uptime()`, etc. which returns different constant values for different servers. This fixes [#7666](https://github.com/ClickHouse/ClickHouse/issues/7666). [#7689](https://github.com/ClickHouse/ClickHouse/pull/7689) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix complicated bug in push-down predicate optimization which leads to wrong results. This fixes a lot of issues on push-down predicate optimization. [#8503](https://github.com/ClickHouse/ClickHouse/pull/8503) ([Winter Zhang](https://github.com/zhang2014))
- Fix crash in `CREATE TABLE .. AS dictionary` query. [#8508](https://github.com/ClickHouse/ClickHouse/pull/8508) ([Azat Khuzhin](https://github.com/azat))
- Several improvements ClickHouse grammar in `.g4` file. [#8294](https://github.com/ClickHouse/ClickHouse/pull/8294) ([taiyang-li](https://github.com/taiyang-li))
- Fix bug that leads to crashes in `JOIN`s with tables with engine `Join`. This fixes [#7556](https://github.com/ClickHouse/ClickHouse/issues/7556) [#8254](https://github.com/ClickHouse/ClickHouse/issues/8254) [#7915](https://github.com/ClickHouse/ClickHouse/issues/7915) [#8100](https://github.com/ClickHouse/ClickHouse/issues/8100). [#8298](https://github.com/ClickHouse/ClickHouse/pull/8298) ([Artem Zuikov](https://github.com/4ertus2))
- Fix redundant dictionaries reload on `CREATE DATABASE`. [#7916](https://github.com/ClickHouse/ClickHouse/pull/7916) ([Azat Khuzhin](https://github.com/azat))
- Limit maximum number of streams for read from `StorageFile` and `StorageHDFS`. Fixes [#7650](https://github.com/ClickHouse/ClickHouse/issues/7650). [#7981](https://github.com/ClickHouse/ClickHouse/pull/7981) ([alesapin](https://github.com/alesapin))
- Fix bug in `ALTER ... MODIFY ... CODEC` query, when user specify both default expression and codec. Fixes [8593](https://github.com/ClickHouse/ClickHouse/issues/8593). [#8614](https://github.com/ClickHouse/ClickHouse/pull/8614) ([alesapin](https://github.com/alesapin))
- Fix error in background merge of columns with `SimpleAggregateFunction(LowCardinality)` type. [#8613](https://github.com/ClickHouse/ClickHouse/pull/8613) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed type check in function `toDateTime64`. [#8375](https://github.com/ClickHouse/ClickHouse/pull/8375) ([Vasily Nemkov](https://github.com/Enmk))
- Now server do not crash on `LEFT` or `FULL JOIN` with and Join engine and unsupported `join_use_nulls` settings. [#8479](https://github.com/ClickHouse/ClickHouse/pull/8479) ([Artem Zuikov](https://github.com/4ertus2))
- Now `DROP DICTIONARY IF EXISTS db.dict` query does not throw exception if `db` does not exist. [#8185](https://github.com/ClickHouse/ClickHouse/pull/8185) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix possible crashes in table functions (`file`, `mysql`, `remote`) caused by usage of reference to removed `IStorage` object. Fix incorrect parsing of columns specified at insertion into table function. [#7762](https://github.com/ClickHouse/ClickHouse/pull/7762) ([tavplubix](https://github.com/tavplubix))
- Ensure network be up before starting `clickhouse-server`. This fixes [#7507](https://github.com/ClickHouse/ClickHouse/issues/7507). [#8570](https://github.com/ClickHouse/ClickHouse/pull/8570) ([Zhichang Yu](https://github.com/yuzhichang))
- Fix timeouts handling for secure connections, so queries does not hang indefenitely. This fixes [#8126](https://github.com/ClickHouse/ClickHouse/issues/8126). [#8128](https://github.com/ClickHouse/ClickHouse/pull/8128) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix `clickhouse-copier`'s redundant contention between concurrent workers. [#7816](https://github.com/ClickHouse/ClickHouse/pull/7816) ([Ding Xiang Fei](https://github.com/dingxiangfei2009))
- Now mutations does not skip attached parts, even if their mutation version were larger than current mutation version. [#7812](https://github.com/ClickHouse/ClickHouse/pull/7812) ([Zhichang Yu](https://github.com/yuzhichang)) [#8250](https://github.com/ClickHouse/ClickHouse/pull/8250) ([alesapin](https://github.com/alesapin))
- Ignore redundant copies of `*MergeTree` data parts after move to another disk and server restart. [#7810](https://github.com/ClickHouse/ClickHouse/pull/7810) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix crash in `FULL JOIN` with `LowCardinality` in `JOIN` key. [#8252](https://github.com/ClickHouse/ClickHouse/pull/8252) ([Artem Zuikov](https://github.com/4ertus2))
- Forbidden to use column name more than once in insert query like `INSERT INTO tbl (x, y, x)`. This fixes [#5465](https://github.com/ClickHouse/ClickHouse/issues/5465), [#7681](https://github.com/ClickHouse/ClickHouse/issues/7681). [#7685](https://github.com/ClickHouse/ClickHouse/pull/7685) ([alesapin](https://github.com/alesapin))
- Added fallback for detection the number of physical CPU cores for unknown CPUs (using the number of logical CPU cores). This fixes [#5239](https://github.com/ClickHouse/ClickHouse/issues/5239). [#7726](https://github.com/ClickHouse/ClickHouse/pull/7726) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix `There's no column` error for materialized and alias columns. [#8210](https://github.com/ClickHouse/ClickHouse/pull/8210) ([Artem Zuikov](https://github.com/4ertus2))
- Fixed sever crash when `EXISTS` query was used without `TABLE` or `DICTIONARY` qualifier. Just like `EXISTS t`. This fixes [#8172](https://github.com/ClickHouse/ClickHouse/issues/8172). This bug was introduced in version 19.17. [#8213](https://github.com/ClickHouse/ClickHouse/pull/8213) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix rare bug with error `"Sizes of columns does not match"` that might appear when using `SimpleAggregateFunction` column. [#7790](https://github.com/ClickHouse/ClickHouse/pull/7790) ([Boris Granveaud](https://github.com/bgranvea))
- Fix bug where user with empty `allow_databases` got access to all databases (and same for `allow_dictionaries`). [#7793](https://github.com/ClickHouse/ClickHouse/pull/7793) ([DeifyTheGod](https://github.com/DeifyTheGod))
- Fix client crash when server already disconnected from client. [#8071](https://github.com/ClickHouse/ClickHouse/pull/8071) ([Azat Khuzhin](https://github.com/azat))
- Fix `ORDER BY` behaviour in case of sorting by primary key prefix and non primary key suffix. [#7759](https://github.com/ClickHouse/ClickHouse/pull/7759) ([Anton Popov](https://github.com/CurtizJ))
- Check if qualified column present in the table. This fixes [#6836](https://github.com/ClickHouse/ClickHouse/issues/6836). [#7758](https://github.com/ClickHouse/ClickHouse/pull/7758) ([Artem Zuikov](https://github.com/4ertus2))
- Fixed behavior with `ALTER MOVE` ran immediately after merge finish moves superpart of specified. Fixes [#8103](https://github.com/ClickHouse/ClickHouse/issues/8103). [#8104](https://github.com/ClickHouse/ClickHouse/pull/8104) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix possible server crash while using `UNION` with different number of columns. Fixes [#7279](https://github.com/ClickHouse/ClickHouse/issues/7279). [#7929](https://github.com/ClickHouse/ClickHouse/pull/7929) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix size of result substring for function `substr` with negative size. [#8589](https://github.com/ClickHouse/ClickHouse/pull/8589) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Now server does not execute part mutation in `MergeTree` if there are not enough free threads in background pool. [#8588](https://github.com/ClickHouse/ClickHouse/pull/8588) ([tavplubix](https://github.com/tavplubix))
- Fix a minor typo on formatting `UNION ALL` AST. [#7999](https://github.com/ClickHouse/ClickHouse/pull/7999) ([litao91](https://github.com/litao91))
- Fixed incorrect bloom filter results for negative numbers. This fixes [#8317](https://github.com/ClickHouse/ClickHouse/issues/8317). [#8566](https://github.com/ClickHouse/ClickHouse/pull/8566) ([Winter Zhang](https://github.com/zhang2014))
- Fixed potential buffer overflow in decompress. Malicious user can pass fabricated compressed data that will cause read after buffer. This issue was found by Eldar Zaitov from Yandex information security team. [#8404](https://github.com/ClickHouse/ClickHouse/pull/8404) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix incorrect result because of integers overflow in `arrayIntersect`. [#7777](https://github.com/ClickHouse/ClickHouse/pull/7777) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Now `OPTIMIZE TABLE` query will not wait for offline replicas to perform the operation. [#8314](https://github.com/ClickHouse/ClickHouse/pull/8314) ([javi santana](https://github.com/javisantana))
- Fixed `ALTER TTL` parser for `Replicated*MergeTree` tables. [#8318](https://github.com/ClickHouse/ClickHouse/pull/8318) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix communication between server and client, so server read temporary tables info after query failure. [#8084](https://github.com/ClickHouse/ClickHouse/pull/8084) ([Azat Khuzhin](https://github.com/azat))
- Fix `bitmapAnd` function error when intersecting an aggregated bitmap and a scalar bitmap. [#8082](https://github.com/ClickHouse/ClickHouse/pull/8082) ([Yue Huang](https://github.com/moon03432))
- Refine the definition of `ZXid` according to the ZooKeeper Programmer's Guide which fixes bug in `clickhouse-cluster-copier`. [#8088](https://github.com/ClickHouse/ClickHouse/pull/8088) ([Ding Xiang Fei](https://github.com/dingxiangfei2009))
- `odbc` table function now respects `external_table_functions_use_nulls` setting. [#7506](https://github.com/ClickHouse/ClickHouse/pull/7506) ([Vasily Nemkov](https://github.com/Enmk))
- Fixed bug that lead to a rare data race. [#8143](https://github.com/ClickHouse/ClickHouse/pull/8143) ([Alexander Kazakov](https://github.com/Akazz))
- Now `SYSTEM RELOAD DICTIONARY` reloads a dictionary completely, ignoring `update_field`. This fixes [#7440](https://github.com/ClickHouse/ClickHouse/issues/7440). [#8037](https://github.com/ClickHouse/ClickHouse/pull/8037) ([Vitaly Baranov](https://github.com/vitlibar))
- Add ability to check if dictionary exists in create query. [#8032](https://github.com/ClickHouse/ClickHouse/pull/8032) ([alesapin](https://github.com/alesapin))
- Fix `Float*` parsing in `Values` format. This fixes [#7817](https://github.com/ClickHouse/ClickHouse/issues/7817). [#7870](https://github.com/ClickHouse/ClickHouse/pull/7870) ([tavplubix](https://github.com/tavplubix))
- Fix crash when we cannot reserve space in some background operations of `*MergeTree` table engines family. [#7873](https://github.com/ClickHouse/ClickHouse/pull/7873) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix crash of merge operation when table contains `SimpleAggregateFunction(LowCardinality)` column. This fixes [#8515](https://github.com/ClickHouse/ClickHouse/issues/8515). [#8522](https://github.com/ClickHouse/ClickHouse/pull/8522) ([Azat Khuzhin](https://github.com/azat))
- Restore support of all ICU locales and add the ability to apply collations for constant expressions. Also add language name to `system.collations` table. [#8051](https://github.com/ClickHouse/ClickHouse/pull/8051) ([alesapin](https://github.com/alesapin))
- Fix bug when external dictionaries with zero minimal lifetime (`LIFETIME(MIN 0 MAX N)`, `LIFETIME(N)`) don't update in background. [#7983](https://github.com/ClickHouse/ClickHouse/pull/7983) ([alesapin](https://github.com/alesapin))
- Fix crash when external dictionary with ClickHouse source has subquery in query. [#8351](https://github.com/ClickHouse/ClickHouse/pull/8351) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix incorrect parsing of file extension in table with engine `URL`. This fixes [#8157](https://github.com/ClickHouse/ClickHouse/issues/8157). [#8419](https://github.com/ClickHouse/ClickHouse/pull/8419) ([Andrey Bodrov](https://github.com/apbodrov))
- Fix `CHECK TABLE` query for `*MergeTree` tables without key. Fixes [#7543](https://github.com/ClickHouse/ClickHouse/issues/7543). [#7979](https://github.com/ClickHouse/ClickHouse/pull/7979) ([alesapin](https://github.com/alesapin))
- Fixed conversion of `Float64` to MySQL type. [#8079](https://github.com/ClickHouse/ClickHouse/pull/8079) ([Yuriy Baranov](https://github.com/yurriy))
- Now if table was not completely dropped because of server crash, server will try to restore and load it. [#8176](https://github.com/ClickHouse/ClickHouse/pull/8176) ([tavplubix](https://github.com/tavplubix))
- Fixed crash in table function `file` while inserting into file that does not exist. Now in this case file would be created and then insert would be processed. [#8177](https://github.com/ClickHouse/ClickHouse/pull/8177) ([Olga Khvostikova](https://github.com/stavrolia))
- Fix rare deadlock which can happen when `trace_log` is in enabled. [#7838](https://github.com/ClickHouse/ClickHouse/pull/7838) ([filimonov](https://github.com/filimonov))
- Add ability to work with different types besides `Date` in `RangeHashed` external dictionary created from DDL query. Fixes [7899](https://github.com/ClickHouse/ClickHouse/issues/7899). [#8275](https://github.com/ClickHouse/ClickHouse/pull/8275) ([alesapin](https://github.com/alesapin))
- Fixes crash when `now64()` is called with result of another function. [#8270](https://github.com/ClickHouse/ClickHouse/pull/8270) ([Vasily Nemkov](https://github.com/Enmk))
- Fixed bug with detecting client IP for connections through mysql wire protocol. [#7743](https://github.com/ClickHouse/ClickHouse/pull/7743) ([Dmitry Muzyka](https://github.com/dmitriy-myz))
- Fix empty array handling in `arraySplit` function. This fixes [#7708](https://github.com/ClickHouse/ClickHouse/issues/7708). [#7747](https://github.com/ClickHouse/ClickHouse/pull/7747) ([hcz](https://github.com/hczhcz))
- Fixed the issue when `pid-file` of another running `clickhouse-server` may be deleted. [#8487](https://github.com/ClickHouse/ClickHouse/pull/8487) ([Weiqing Xu](https://github.com/weiqxu))
- Fix dictionary reload if it has `invalidate_query`, which stopped updates and some exception on previous update tries. [#8029](https://github.com/ClickHouse/ClickHouse/pull/8029) ([alesapin](https://github.com/alesapin))
- Fixed error in function `arrayReduce` that may lead to "double free" and error in aggregate function combinator `Resample` that may lead to memory leak. Added aggregate function `aggThrow`. This function can be used for testing purposes. [#8446](https://github.com/ClickHouse/ClickHouse/pull/8446) ([alexey-milovidov](https://github.com/alexey-milovidov))





#### 改善 {#improvement-22}

- Improved logging when working with `S3` table engine. [#8251](https://github.com/ClickHouse/ClickHouse/pull/8251) ([Grigory Pervakov](https://github.com/GrigoryPervakov))
- Printed help message when no arguments are passed when calling `clickhouse-local`. This fixes [#5335](https://github.com/ClickHouse/ClickHouse/issues/5335). [#8230](https://github.com/ClickHouse/ClickHouse/pull/8230) ([Andrey Nagorny](https://github.com/Melancholic))
- Add setting `mutations_sync` which allows to wait `ALTER UPDATE/DELETE` queries synchronously. [#8237](https://github.com/ClickHouse/ClickHouse/pull/8237) ([alesapin](https://github.com/alesapin))
- Allow to set up relative `user_files_path` in `config.xml` (in the way similar to `format_schema_path`). [#7632](https://github.com/ClickHouse/ClickHouse/pull/7632) ([hcz](https://github.com/hczhcz))
- Add exception for illegal types for conversion functions with `-OrZero` postfix. [#7880](https://github.com/ClickHouse/ClickHouse/pull/7880) ([Andrey Konyaev](https://github.com/akonyaev90))
- Simplify format of the header of data sending to a shard in a distributed query. [#8044](https://github.com/ClickHouse/ClickHouse/pull/8044) ([Vitaly Baranov](https://github.com/vitlibar))
- `Live View` table engine refactoring. [#8519](https://github.com/ClickHouse/ClickHouse/pull/8519) ([vzakaznikov](https://github.com/vzakaznikov))
- Add additional checks for external dictionaries created from DDL-queries. [#8127](https://github.com/ClickHouse/ClickHouse/pull/8127) ([alesapin](https://github.com/alesapin))
- Fix error `Column ... already exists` while using `FINAL` and `SAMPLE` together, e.g. `select count() from table final sample 1/2`. Fixes [#5186](https://github.com/ClickHouse/ClickHouse/issues/5186). [#7907](https://github.com/ClickHouse/ClickHouse/pull/7907) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Now table the first argument of `joinGet` function can be table identifier. [#7707](https://github.com/ClickHouse/ClickHouse/pull/7707) ([Amos Bird](https://github.com/amosbird))
- Allow using `MaterializedView` with subqueries above `Kafka` tables. [#8197](https://github.com/ClickHouse/ClickHouse/pull/8197) ([filimonov](https://github.com/filimonov))
- Now background moves between disks run it the seprate thread pool. [#7670](https://github.com/ClickHouse/ClickHouse/pull/7670) ([Vladimir Chebotarev](https://github.com/excitoon))
- `SYSTEM RELOAD DICTIONARY` now executes synchronously. [#8240](https://github.com/ClickHouse/ClickHouse/pull/8240) ([Vitaly Baranov](https://github.com/vitlibar))
- Stack traces now display physical addresses (offsets in object file) instead of virtual memory addresses (where the object file was loaded). That allows the use of `addr2line` when binary is position independent and ASLR is active. This fixes [#8360](https://github.com/ClickHouse/ClickHouse/issues/8360). [#8387](https://github.com/ClickHouse/ClickHouse/pull/8387) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Support new syntax for row-level security filters: `<table name='table_name'>...</table>`. Fixes [#5779](https://github.com/ClickHouse/ClickHouse/issues/5779). [#8381](https://github.com/ClickHouse/ClickHouse/pull/8381) ([Ivan](https://github.com/abyss7))
- Now `cityHash` function can work with `Decimal` and `UUID` types. Fixes [#5184](https://github.com/ClickHouse/ClickHouse/issues/5184). [#7693](https://github.com/ClickHouse/ClickHouse/pull/7693) ([Mikhail Korotov](https://github.com/millb))
- Removed fixed index granularity (it was 1024) from system logs because it's obsolete after implementation of adaptive granularity. [#7698](https://github.com/ClickHouse/ClickHouse/pull/7698) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Enabled MySQL compatibility server when ClickHouse is compiled without SSL. [#7852](https://github.com/ClickHouse/ClickHouse/pull/7852) ([Yuriy Baranov](https://github.com/yurriy))
- Now server checksums distributed batches, which gives more verbose errors in case of corrupted data in batch. [#7914](https://github.com/ClickHouse/ClickHouse/pull/7914) ([Azat Khuzhin](https://github.com/azat))
- Support `DROP DATABASE`, `DETACH TABLE`, `DROP TABLE` and `ATTACH TABLE` for `MySQL` database engine. [#8202](https://github.com/ClickHouse/ClickHouse/pull/8202) ([Winter Zhang](https://github.com/zhang2014))
- Add authentication in S3 table function and table engine. [#7623](https://github.com/ClickHouse/ClickHouse/pull/7623) ([Vladimir Chebotarev](https://github.com/excitoon))
- Added check for extra parts of `MergeTree` at different disks, in order to not allow to miss data parts at undefined disks. [#8118](https://github.com/ClickHouse/ClickHouse/pull/8118) ([Vladimir Chebotarev](https://github.com/excitoon))
- Enable SSL support for Mac client and server. [#8297](https://github.com/ClickHouse/ClickHouse/pull/8297) ([Ivan](https://github.com/abyss7))
- Now ClickHouse can work as MySQL federated server (see https://dev.mysql.com/doc/refman/5.7/en/federated-create-server.html). [#7717](https://github.com/ClickHouse/ClickHouse/pull/7717) ([Maxim Fedotov](https://github.com/MaxFedotov))
- `clickhouse-client` now only enable `bracketed-paste` when multiquery is on and multiline is off. This fixes [#7757](https://github.com/ClickHouse/ClickHouse/issues/7757). [#7761](https://github.com/ClickHouse/ClickHouse/pull/7761) ([Amos Bird](https://github.com/amosbird))
- Support `Array(Decimal)` in `if` function. [#7721](https://github.com/ClickHouse/ClickHouse/pull/7721) ([Artem Zuikov](https://github.com/4ertus2))
- Support Decimals in `arrayDifference`, `arrayCumSum` and `arrayCumSumNegative` functions. [#7724](https://github.com/ClickHouse/ClickHouse/pull/7724) ([Artem Zuikov](https://github.com/4ertus2))
- Added `lifetime` column to `system.dictionaries` table. [#6820](https://github.com/ClickHouse/ClickHouse/issues/6820) [#7727](https://github.com/ClickHouse/ClickHouse/pull/7727) ([kekekekule](https://github.com/kekekekule))
- Improved check for existing parts on different disks for `*MergeTree` table engines. Addresses [#7660](https://github.com/ClickHouse/ClickHouse/issues/7660). [#8440](https://github.com/ClickHouse/ClickHouse/pull/8440) ([Vladimir Chebotarev](https://github.com/excitoon))
- Integration with `AWS SDK` for `S3` interactions which allows to use all S3 features out of the box. [#8011](https://github.com/ClickHouse/ClickHouse/pull/8011) ([Pavel Kovalenko](https://github.com/Jokser))
- Added support for subqueries in `Live View` tables. [#7792](https://github.com/ClickHouse/ClickHouse/pull/7792) ([vzakaznikov](https://github.com/vzakaznikov))
- Check for using `Date` or `DateTime` column from `TTL` expressions was removed. [#7920](https://github.com/ClickHouse/ClickHouse/pull/7920) ([Vladimir Chebotarev](https://github.com/excitoon))
- Information about disk was added to `system.detached_parts` table. [#7833](https://github.com/ClickHouse/ClickHouse/pull/7833) ([Vladimir Chebotarev](https://github.com/excitoon))
- Now settings `max_(table|partition)_size_to_drop` can be changed without a restart. [#7779](https://github.com/ClickHouse/ClickHouse/pull/7779) ([Grigory Pervakov](https://github.com/GrigoryPervakov))
- Slightly better usability of error messages. Ask user not to remove the lines below `Stack trace:`. [#7897](https://github.com/ClickHouse/ClickHouse/pull/7897) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Better reading messages from `Kafka` engine in various formats after [#7935](https://github.com/ClickHouse/ClickHouse/issues/7935). [#8035](https://github.com/ClickHouse/ClickHouse/pull/8035) ([Ivan](https://github.com/abyss7))
- Better compatibility with MySQL clients which don't support `sha2_password` auth plugin. [#8036](https://github.com/ClickHouse/ClickHouse/pull/8036) ([Yuriy Baranov](https://github.com/yurriy))
- Support more column types in MySQL compatibility server. [#7975](https://github.com/ClickHouse/ClickHouse/pull/7975) ([Yuriy Baranov](https://github.com/yurriy))
- Implement `ORDER BY` optimization for `Merge`, `Buffer` and `Materilized View` storages with underlying `MergeTree` tables. [#8130](https://github.com/ClickHouse/ClickHouse/pull/8130) ([Anton Popov](https://github.com/CurtizJ))
- Now we always use POSIX implementation of `getrandom` to have better compatibility with old kernels (< 3.17). [#7940](https://github.com/ClickHouse/ClickHouse/pull/7940) ([Amos Bird](https://github.com/amosbird))
- Better check for valid destination in a move TTL rule. [#8410](https://github.com/ClickHouse/ClickHouse/pull/8410) ([Vladimir Chebotarev](https://github.com/excitoon))
- Better checks for broken insert batches for `Distributed` table engine. [#7933](https://github.com/ClickHouse/ClickHouse/pull/7933) ([Azat Khuzhin](https://github.com/azat))
- Add column with array of parts name which mutations must process in future to `system.mutations` table. [#8179](https://github.com/ClickHouse/ClickHouse/pull/8179) ([alesapin](https://github.com/alesapin))
- Parallel merge sort optimization for processors. [#8552](https://github.com/ClickHouse/ClickHouse/pull/8552) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- The settings `mark_cache_min_lifetime` is now obsolete and does nothing. In previous versions, mark cache can grow in memory larger than `mark_cache_size` to accomodate data within `mark_cache_min_lifetime` seconds. That was leading to confusion and higher memory usage than expected, that is especially bad on memory constrained systems. If you will see performance degradation after installing this release, you should increase the `mark_cache_size`. [#8484](https://github.com/ClickHouse/ClickHouse/pull/8484) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Preparation to use `tid` everywhere. This is needed for [#7477](https://github.com/ClickHouse/ClickHouse/issues/7477). [#8276](https://github.com/ClickHouse/ClickHouse/pull/8276) ([alexey-milovidov](https://github.com/alexey-milovidov))





#### パフォーマンス改善 {#performance-improvement-17}

- プロセッサパイプラインのパフォーマンス最適化。[#7988](https://github.com/ClickHouse/ClickHouse/pull/7988) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- キャッシュディクショナリにおける期限切れキーの非ブロッキング更新(古いキーの読み取りを許可)。[#8303](https://github.com/ClickHouse/ClickHouse/pull/8303) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- レジスタを1つ追加で確保するため、グローバルに`-fno-omit-frame-pointer`なしでClickHouseをコンパイル。[#8097](https://github.com/ClickHouse/ClickHouse/pull/8097) ([Amos Bird](https://github.com/amosbird))
- `greatCircleDistance`関数の高速化とパフォーマンステストの追加。[#7307](https://github.com/ClickHouse/ClickHouse/pull/7307) ([Olga Khvostikova](https://github.com/stavrolia))
- `roundDown`関数のパフォーマンス改善。[#8465](https://github.com/ClickHouse/ClickHouse/pull/8465) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `DateTime64`データ型における`max`、`min`、`argMin`、`argMax`のパフォーマンス改善。[#8199](https://github.com/ClickHouse/ClickHouse/pull/8199) ([Vasily Nemkov](https://github.com/Enmk))
- 制限なし、または大きな制限値と外部ソートを使用した場合のソートパフォーマンスの改善。[#8545](https://github.com/ClickHouse/ClickHouse/pull/8545) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 浮動小数点数のフォーマット処理のパフォーマンスを最大6倍改善。[#8542](https://github.com/ClickHouse/ClickHouse/pull/8542) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `modulo`関数のパフォーマンス改善。[#7750](https://github.com/ClickHouse/ClickHouse/pull/7750) ([Amos Bird](https://github.com/amosbird))
- 単一カラムキーによる`ORDER BY`とマージの最適化。[#8335](https://github.com/ClickHouse/ClickHouse/pull/8335) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `arrayReduce`、`-Array`、`-State`コンビネータの実装改善。[#7710](https://github.com/ClickHouse/ClickHouse/pull/7710) ([Amos Bird](https://github.com/amosbird))
- `PREWHERE`が少なくとも`WHERE`と同等の効率になるよう最適化。[#7769](https://github.com/ClickHouse/ClickHouse/pull/7769) ([Amos Bird](https://github.com/amosbird))
- `round`と`roundBankers`における負の数の処理方法を改善。[#8229](https://github.com/ClickHouse/ClickHouse/pull/8229) ([hcz](https://github.com/hczhcz))
- `DoubleDelta`と`Gorilla`コーデックのデコードパフォーマンスを約30-40%改善。これにより[#7082](https://github.com/ClickHouse/ClickHouse/issues/7082)を修正。[#8019](https://github.com/ClickHouse/ClickHouse/pull/8019) ([Vasily Nemkov](https://github.com/Enmk))
- `base64`関連関数のパフォーマンス改善。[#8444](https://github.com/ClickHouse/ClickHouse/pull/8444) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `geoDistance`関数を追加。`greatCircleDistance`と類似していますが、WGS-84楕円体モデルの近似を使用します。両関数のパフォーマンスはほぼ同等です。[#8086](https://github.com/ClickHouse/ClickHouse/pull/8086) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `Decimal`データ型における`min`と`max`集約関数の高速化。[#8144](https://github.com/ClickHouse/ClickHouse/pull/8144) ([Artem Zuikov](https://github.com/4ertus2))
- `arrayReduce`の処理をベクトル化。[#7608](https://github.com/ClickHouse/ClickHouse/pull/7608) ([Amos Bird](https://github.com/amosbird))
- `if`チェーンが`multiIf`として最適化されるようになりました。[#8355](https://github.com/ClickHouse/ClickHouse/pull/8355) ([kamalov-ruslan](https://github.com/kamalov-ruslan))
- 19.15で導入された`Kafka`テーブルエンジンのパフォーマンス低下を修正。これにより[#7261](https://github.com/ClickHouse/ClickHouse/issues/7261)を修正。[#7935](https://github.com/ClickHouse/ClickHouse/pull/7935) ([filimonov](https://github.com/filimonov))
- Debianパッケージの`gcc`がデフォルトで時折含める"pie"コード生成を削除。[#8483](https://github.com/ClickHouse/ClickHouse/pull/8483) ([alexey-milovidov](https://github.com/alexey-milovidov))
- データフォーマットの並列パース処理[#6553](https://github.com/ClickHouse/ClickHouse/pull/6553) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- 式を含む`Values`の最適化されたパーサーをデフォルトで有効化(`input_format_values_deduce_templates_of_expressions=1`)。[#8231](https://github.com/ClickHouse/ClickHouse/pull/8231) ([tavplubix](https://github.com/tavplubix))





#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-25}

- Build fixes for `ARM` and in minimal mode. [#8304](https://github.com/ClickHouse/ClickHouse/pull/8304) ([proller](https://github.com/proller))
- Add coverage file flush for `clickhouse-server` when std::atexit is not called. Also slightly improved logging in stateless tests with coverage. [#8267](https://github.com/ClickHouse/ClickHouse/pull/8267) ([alesapin](https://github.com/alesapin))
- Update LLVM library in contrib. Avoid using LLVM from OS packages. [#8258](https://github.com/ClickHouse/ClickHouse/pull/8258) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Make bundled `curl` build fully quiet. [#8232](https://github.com/ClickHouse/ClickHouse/pull/8232) [#8203](https://github.com/ClickHouse/ClickHouse/pull/8203) ([Pavel Kovalenko](https://github.com/Jokser))
- Fix some `MemorySanitizer` warnings. [#8235](https://github.com/ClickHouse/ClickHouse/pull/8235) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Use `add_warning` and `no_warning` macros in `CMakeLists.txt`. [#8604](https://github.com/ClickHouse/ClickHouse/pull/8604) ([Ivan](https://github.com/abyss7))
- Add support of Minio S3 Compatible object (https://min.io/) for better integration tests. [#7863](https://github.com/ClickHouse/ClickHouse/pull/7863) [#7875](https://github.com/ClickHouse/ClickHouse/pull/7875) ([Pavel Kovalenko](https://github.com/Jokser))
- Imported `libc` headers to contrib. It allows to make builds more consistent across various systems (only for `x86_64-linux-gnu`). [#5773](https://github.com/ClickHouse/ClickHouse/pull/5773) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Remove `-fPIC` from some libraries. [#8464](https://github.com/ClickHouse/ClickHouse/pull/8464) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Clean `CMakeLists.txt` for curl. See https://github.com/ClickHouse/ClickHouse/pull/8011#issuecomment-569478910 [#8459](https://github.com/ClickHouse/ClickHouse/pull/8459) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Silent warnings in `CapNProto` library. [#8220](https://github.com/ClickHouse/ClickHouse/pull/8220) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add performance tests for short string optimized hash tables. [#7679](https://github.com/ClickHouse/ClickHouse/pull/7679) ([Amos Bird](https://github.com/amosbird))
- Now ClickHouse will build on `AArch64` even if `MADV_FREE` is not available. This fixes [#8027](https://github.com/ClickHouse/ClickHouse/issues/8027). [#8243](https://github.com/ClickHouse/ClickHouse/pull/8243) ([Amos Bird](https://github.com/amosbird))
- Update `zlib-ng` to fix memory sanitizer problems. [#7182](https://github.com/ClickHouse/ClickHouse/pull/7182) [#8206](https://github.com/ClickHouse/ClickHouse/pull/8206) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Enable internal MySQL library on non-Linux system, because usage of OS packages is very fragile and usually does not work at all. This fixes [#5765](https://github.com/ClickHouse/ClickHouse/issues/5765). [#8426](https://github.com/ClickHouse/ClickHouse/pull/8426) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed build on some systems after enabling `libc++`. This supersedes [#8374](https://github.com/ClickHouse/ClickHouse/issues/8374). [#8380](https://github.com/ClickHouse/ClickHouse/pull/8380) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Make `Field` methods more type-safe to find more errors. [#7386](https://github.com/ClickHouse/ClickHouse/pull/7386) [#8209](https://github.com/ClickHouse/ClickHouse/pull/8209) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Added missing files to the `libc-headers` submodule. [#8507](https://github.com/ClickHouse/ClickHouse/pull/8507) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix wrong `JSON` quoting in performance test output. [#8497](https://github.com/ClickHouse/ClickHouse/pull/8497) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Now stack trace is displayed for `std::exception` and `Poco::Exception`. In previous versions it was available only for `DB::Exception`. This improves diagnostics. [#8501](https://github.com/ClickHouse/ClickHouse/pull/8501) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Porting `clock_gettime` and `clock_nanosleep` for fresh glibc versions. [#8054](https://github.com/ClickHouse/ClickHouse/pull/8054) ([Amos Bird](https://github.com/amosbird))
- Enable `part_log` in example config for developers. [#8609](https://github.com/ClickHouse/ClickHouse/pull/8609) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix async nature of reload in `01036_no_superfluous_dict_reload_on_create_database*`. [#8111](https://github.com/ClickHouse/ClickHouse/pull/8111) ([Azat Khuzhin](https://github.com/azat))
- Fixed codec performance tests. [#8615](https://github.com/ClickHouse/ClickHouse/pull/8615) ([Vasily Nemkov](https://github.com/Enmk))
- Add install scripts for `.tgz` build and documentation for them. [#8612](https://github.com/ClickHouse/ClickHouse/pull/8612) [#8591](https://github.com/ClickHouse/ClickHouse/pull/8591) ([alesapin](https://github.com/alesapin))
- Removed old `ZSTD` test (it was created in year 2016 to reproduce the bug that pre 1.0 version of ZSTD has had). This fixes [#8618](https://github.com/ClickHouse/ClickHouse/issues/8618). [#8619](https://github.com/ClickHouse/ClickHouse/pull/8619) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed build on Mac OS Catalina. [#8600](https://github.com/ClickHouse/ClickHouse/pull/8600) ([meo](https://github.com/meob))
- Increased number of rows in codec performance tests to make results noticeable. [#8574](https://github.com/ClickHouse/ClickHouse/pull/8574) ([Vasily Nemkov](https://github.com/Enmk))
- In debug builds, treat `LOGICAL_ERROR` exceptions as assertion failures, so that they are easier to notice. [#8475](https://github.com/ClickHouse/ClickHouse/pull/8475) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Make formats-related performance test more deterministic. [#8477](https://github.com/ClickHouse/ClickHouse/pull/8477) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update `lz4` to fix a MemorySanitizer failure. [#8181](https://github.com/ClickHouse/ClickHouse/pull/8181) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Suppress a known MemorySanitizer false positive in exception handling. [#8182](https://github.com/ClickHouse/ClickHouse/pull/8182) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Update `gcc` and `g++` to version 9 in `build/docker/build.sh` [#7766](https://github.com/ClickHouse/ClickHouse/pull/7766) ([TLightSky](https://github.com/tlightsky))
- Add performance test case to test that `PREWHERE` is worse than `WHERE`. [#7768](https://github.com/ClickHouse/ClickHouse/pull/7768) ([Amos Bird](https://github.com/amosbird))
- Progress towards fixing one flacky test. [#8621](https://github.com/ClickHouse/ClickHouse/pull/8621) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Avoid MemorySanitizer report for data from `libunwind`. [#8539](https://github.com/ClickHouse/ClickHouse/pull/8539) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Updated `libc++` to the latest version. [#8324](https://github.com/ClickHouse/ClickHouse/pull/8324) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Build ICU library from sources. This fixes [#6460](https://github.com/ClickHouse/ClickHouse/issues/6460). [#8219](https://github.com/ClickHouse/ClickHouse/pull/8219) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Switched from `libressl` to `openssl`. ClickHouse should support TLS 1.3 and SNI after this change. This fixes [#8171](https://github.com/ClickHouse/ClickHouse/issues/8171). [#8218](https://github.com/ClickHouse/ClickHouse/pull/8218) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed UBSan report when using `chacha20_poly1305` from SSL (happens on connect to https://yandex.ru/). [#8214](https://github.com/ClickHouse/ClickHouse/pull/8214) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix mode of default password file for `.deb` linux distros. [#8075](https://github.com/ClickHouse/ClickHouse/pull/8075) ([proller](https://github.com/proller))
- Improved expression for getting `clickhouse-server` PID in `clickhouse-test`. [#8063](https://github.com/ClickHouse/ClickHouse/pull/8063) ([Alexander Kazakov](https://github.com/Akazz))
- Updated contrib/googletest to v1.10.0. [#8587](https://github.com/ClickHouse/ClickHouse/pull/8587) ([Alexander Burmak](https://github.com/Alex-Burmak))
- Fixed ThreadSaninitizer report in `base64` library. Also updated this library to the latest version, but it does not matter. This fixes [#8397](https://github.com/ClickHouse/ClickHouse/issues/8397). [#8403](https://github.com/ClickHouse/ClickHouse/pull/8403) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix `00600_replace_running_query` for processors. [#8272](https://github.com/ClickHouse/ClickHouse/pull/8272) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Remove support for `tcmalloc` to make `CMakeLists.txt` simpler. [#8310](https://github.com/ClickHouse/ClickHouse/pull/8310) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Release gcc builds now use `libc++` instead of `libstdc++`. Recently `libc++` was used only with clang. This will improve consistency of build configurations and portability. [#8311](https://github.com/ClickHouse/ClickHouse/pull/8311) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Enable ICU library for build with MemorySanitizer. [#8222](https://github.com/ClickHouse/ClickHouse/pull/8222) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Suppress warnings from `CapNProto` library. [#8224](https://github.com/ClickHouse/ClickHouse/pull/8224) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Removed special cases of code for `tcmalloc`, because it's no longer supported. [#8225](https://github.com/ClickHouse/ClickHouse/pull/8225) ([alexey-milovidov](https://github.com/alexey-milovidov))
- In CI coverage task, kill the server gracefully to allow it to save the coverage report. This fixes incomplete coverage reports we've been seeing lately. [#8142](https://github.com/ClickHouse/ClickHouse/pull/8142) ([alesapin](https://github.com/alesapin))
- Performance tests for all codecs against `Float64` and `UInt64` values. [#8349](https://github.com/ClickHouse/ClickHouse/pull/8349) ([Vasily Nemkov](https://github.com/Enmk))
- `termcap` is very much deprecated and lead to various problems (f.g. missing "up" cap and echoing `^J` instead of multi line) . Favor `terminfo` or bundled `ncurses`. [#7737](https://github.com/ClickHouse/ClickHouse/pull/7737) ([Amos Bird](https://github.com/amosbird))
- Fix `test_storage_s3` integration test. [#7734](https://github.com/ClickHouse/ClickHouse/pull/7734) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Support `StorageFile(<format>, null) ` to insert block into given format file without actually write to disk. This is required for performance tests. [#8455](https://github.com/ClickHouse/ClickHouse/pull/8455) ([Amos Bird](https://github.com/amosbird))
- Added argument `--print-time` to functional tests which prints execution time per test. [#8001](https://github.com/ClickHouse/ClickHouse/pull/8001) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Added asserts to `KeyCondition` while evaluating RPN. This will fix warning from gcc-9. [#8279](https://github.com/ClickHouse/ClickHouse/pull/8279) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Dump cmake options in CI builds. [#8273](https://github.com/ClickHouse/ClickHouse/pull/8273) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Don't generate debug info for some fat libraries. [#8271](https://github.com/ClickHouse/ClickHouse/pull/8271) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Make `log_to_console.xml` always log to stderr, regardless of is it interactive or not. [#8395](https://github.com/ClickHouse/ClickHouse/pull/8395) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Removed some unused features from `clickhouse-performance-test` tool. [#8555](https://github.com/ClickHouse/ClickHouse/pull/8555) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Now we will also search for `lld-X` with corresponding `clang-X` version. [#8092](https://github.com/ClickHouse/ClickHouse/pull/8092) ([alesapin](https://github.com/alesapin))
- Parquet build improvement. [#8421](https://github.com/ClickHouse/ClickHouse/pull/8421) ([maxulan](https://github.com/maxulan))
- More GCC warnings [#8221](https://github.com/ClickHouse/ClickHouse/pull/8221) ([kreuzerkrieg](https://github.com/kreuzerkrieg))
- Package for Arch Linux now allows to run ClickHouse server, and not only client. [#8534](https://github.com/ClickHouse/ClickHouse/pull/8534) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix test with processors. Tiny performance fixes. [#7672](https://github.com/ClickHouse/ClickHouse/pull/7672) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Update contrib/protobuf. [#8256](https://github.com/ClickHouse/ClickHouse/pull/8256) ([Matwey V. Kornilov](https://github.com/matwey))
- In preparation of switching to c++20 as a new year celebration. "May the C++ force be with ClickHouse." [#8447](https://github.com/ClickHouse/ClickHouse/pull/8447) ([Amos Bird](https://github.com/amosbird))

#### 実験的機能 {#experimental-feature-8}

- 実験的設定 `min_bytes_to_use_mmap_io` を追加しました。カーネルからユーザー空間へのデータコピーなしで大きなファイルを読み取ることができます。この設定はデフォルトで無効になっています。mmap/munmapが低速であるため、推奨される閾値は約64MBです。[#8520](https://github.com/ClickHouse/ClickHouse/pull/8520) ([alexey-milovidov](https://github.com/alexey-milovidov))
- アクセス制御システムの一部としてクォータを再設計しました。新しいテーブル `system.quotas`、新しい関数 `currentQuota`、`currentQuotaKey`、新しいSQL構文 `CREATE QUOTA`、`ALTER QUOTA`、`DROP QUOTA`、`SHOW QUOTA` を追加しました。[#7257](https://github.com/ClickHouse/ClickHouse/pull/7257) ([Vitaly Baranov](https://github.com/vitlibar))
- 例外をスローする代わりに、警告を表示して未知の設定をスキップできるようにしました。[#7653](https://github.com/ClickHouse/ClickHouse/pull/7653) ([Vitaly Baranov](https://github.com/vitlibar))
- アクセス制御システムの一部として行ポリシーを再設計しました。新しいテーブル `system.row_policies`、新しい関数 `currentRowPolicies()`、新しいSQL構文 `CREATE POLICY`、`ALTER POLICY`、`DROP POLICY`、`SHOW CREATE POLICY`、`SHOW POLICIES` を追加しました。[#7808](https://github.com/ClickHouse/ClickHouse/pull/7808) ([Vitaly Baranov](https://github.com/vitlibar))

#### セキュリティ修正 {#security-fix}

- `File` テーブルエンジンを使用したテーブルでディレクトリ構造を読み取れる可能性を修正しました。これにより [#8536](https://github.com/ClickHouse/ClickHouse/issues/8536) が修正されます。[#8537](https://github.com/ClickHouse/ClickHouse/pull/8537) ([alexey-milovidov](https://github.com/alexey-milovidov))


## [2019年の変更履歴](./2019.md) {#changelog-for-2019}
