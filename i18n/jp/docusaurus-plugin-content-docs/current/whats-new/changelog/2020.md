---
slug: /whats-new/changelog/2020
sidebar_position: 7
sidebar_label: "2020"
title: "2020年の変更履歴"
description: "2020年の変更履歴"
doc_type: "changelog"
keywords:
  [
    "ClickHouse 2020",
    "changelog 2020",
    "リリースノート",
    "バージョン履歴",
    "バグ修正"
  ]
---

### ClickHouseリリース 20.12 {#clickhouse-release-2012}

### ClickHouseリリース v20.12.5.14-stable, 2020-12-28 {#clickhouse-release-v2012514-stable-2020-12-28}

#### バグ修正 {#bug-fix}

- マージ中のAIOによる書き込みを無効化しました。マージ時にプライマリキー列で極めて稀にデータ破損が発生する可能性があるためです。[#18481](https://github.com/ClickHouse/ClickHouse/pull/18481) ([alesapin](https://github.com/alesapin))。
- `Nullable(String)`型の引数を持つ`toType(...)`関数（`toDate`、`toUInt32`など）を実行する際の`value is too short`エラーを修正しました。これらの関数は、パースエラー時に例外をスローする代わりに`NULL`を返すようになりました。[#7673](https://github.com/ClickHouse/ClickHouse/issues/7673)を修正。[#18445](https://github.com/ClickHouse/ClickHouse/pull/18445) ([tavplubix](https://github.com/tavplubix))。
- wideパートからcompactパートへのマージを制限しました。垂直マージの場合、結果パートが破損する原因となっていました。[#18381](https://github.com/ClickHouse/ClickHouse/pull/18381) ([Anton Popov](https://github.com/CurtizJ))。
- `system.settings_profile_elements`テーブルへのデータ入力を修正しました。このPRは[#18231](https://github.com/ClickHouse/ClickHouse/issues/18231)を修正します。[#18379](https://github.com/ClickHouse/ClickHouse/pull/18379) ([Vitaly Baranov](https://github.com/vitlibar))。
- 2レベル集約を使用する際の`Distinct`コンビネータを持つ集約関数で発生する可能性のあるクラッシュを修正しました。[#17682](https://github.com/ClickHouse/ClickHouse/issues/17682)を修正。[#18365](https://github.com/ClickHouse/ClickHouse/pull/18365) ([Anton Popov](https://github.com/CurtizJ))。
- `MODIFY COLUMN ... REMOVE TTL`クエリが実際には列のTTLを削除しないエラーを修正しました。[#18130](https://github.com/ClickHouse/ClickHouse/pull/18130) ([alesapin](https://github.com/alesapin))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement}

- タイムゾーン情報を2020eに更新しました。[#18531](https://github.com/ClickHouse/ClickHouse/pull/18531) ([alesapin](https://github.com/alesapin))。

### ClickHouseリリース v20.12.4.5-stable, 2020-12-24 {#clickhouse-release-v201245-stable-2020-12-24}

#### バグ修正 {#bug-fix-1}


- デュアルIPv4/IPv6スタックを持つマシンでサーバーから`clickhouse-odbc-bridge`プロセスに到達できない問題を修正; - 不正な形式のクエリを使用してODBC辞書の更新が実行される、またはクラッシュを引き起こす問題を修正; おそらく次の問題を解決: [#14489](https://github.com/ClickHouse/ClickHouse/issues/14489). [#18278](https://github.com/ClickHouse/ClickHouse/pull/18278) ([Denis Glazachev](https://github.com/traceon)).
- Enum型とInt型間のキー比較を修正。次の問題を解決: [#17989](https://github.com/ClickHouse/ClickHouse/issues/17989). [#18214](https://github.com/ClickHouse/ClickHouse/pull/18214) ([Amos Bird](https://github.com/amosbird)).
- `MaterializeMySQL`データベースエンジンにおけるユニークキー変換時のクラッシュを修正。次の問題を解決: [#18186](https://github.com/ClickHouse/ClickHouse/issues/18186) および [#16372](https://github.com/ClickHouse/ClickHouse/issues/16372) [#18211](https://github.com/ClickHouse/ClickHouse/pull/18211) ([Winter Zhang](https://github.com/zhang2014)).
- S3 URL解析における`std::out_of_range: basic_string`エラーを修正。[#18059](https://github.com/ClickHouse/ClickHouse/pull/18059) ([Vladimir Chebotarev](https://github.com/excitoon)).
- MaterializeMySQLでMySQLプレフィックスインデックスの変換がサポートされていなかったことが原因で、MySQLからClickHouseに一部のテーブルが同期されない問題を修正。次の問題を解決: [#15187](https://github.com/ClickHouse/ClickHouse/issues/15187) および [#17912](https://github.com/ClickHouse/ClickHouse/issues/17912) [#17944](https://github.com/ClickHouse/ClickHouse/pull/17944) ([Winter Zhang](https://github.com/zhang2014)).
- クエリに`ARRAY JOIN`が含まれている場合にクエリ最適化が誤った結果を生成する問題を修正。[#17887](https://github.com/ClickHouse/ClickHouse/pull/17887) ([sundyli](https://github.com/sundy-li)).
- `topK`集約関数で発生する可能性のあるセグメンテーション違反を修正。次の問題を解決: [#17404](https://github.com/ClickHouse/ClickHouse/issues/17404). [#17845](https://github.com/ClickHouse/ClickHouse/pull/17845) ([Maksim Kita](https://github.com/kitaisreal)).
- サーバーがデーモンモードで実行されている場合に`system.stack_trace`テーブルが空になる問題を修正。[#17630](https://github.com/ClickHouse/ClickHouse/pull/17630) ([Amos Bird](https://github.com/amosbird)).

### ClickHouseリリース v20.12.3.3-stable, 2020-12-13 {#clickhouse-release-v201233-stable-2020-12-13}

#### 後方互換性のない変更 {#backward-incompatible-change}

- `use_compact_format_in_distributed_parts_names`をデフォルトで有効化(詳細はドキュメントを参照)。[#16728](https://github.com/ClickHouse/ClickHouse/pull/16728) ([Azat Khuzhin](https://github.com/azat)).
- `File`エンジンを使用するテーブルを作成する際に、`SETTINGS`句でファイル形式に関連するユーザー設定(例: `format_csv_delimiter`)を受け入れ、すべての`INSERT`および`SELECT`でこれらの設定を使用。現在のユーザーセッションまたはDMLクエリ自体の`SETTINGS`句で変更されたファイル形式設定は、クエリに影響しなくなりました。[#16591](https://github.com/ClickHouse/ClickHouse/pull/16591) ([Alexander Kuzmenkov](https://github.com/akuzm)).

#### 新機能 {#new-feature}


- `*.xz` 圧縮/解凍のサポートを追加。`file()` 関数で `*.xz` を使用できるようになります。これにより [#8828](https://github.com/ClickHouse/ClickHouse/issues/8828) がクローズされます。[#16578](https://github.com/ClickHouse/ClickHouse/pull/16578) ([Abi Palagashvili](https://github.com/fibersel))。
- クエリ `ALTER TABLE ... DROP|DETACH PART 'part_name'` を導入。[#15511](https://github.com/ClickHouse/ClickHouse/pull/15511) ([nvartolomei](https://github.com/nvartolomei))。
- 新しい ALTER UPDATE/DELETE IN PARTITION 構文を追加。[#13403](https://github.com/ClickHouse/ClickHouse/pull/13403) ([Vladimir Chebotarev](https://github.com/excitoon))。
- JSON 入出力形式を使用する際に、名前付きタプルを JSON オブジェクトとしてフォーマットできるようになりました。`output_format_json_named_tuples_as_objects` 設定で制御され、デフォルトでは無効です。[#17175](https://github.com/ClickHouse/ClickHouse/pull/17175) ([Alexander Kuzmenkov](https://github.com/akuzm))。
- TSV および CSV 形式で、デフォルトで列挙型の値をその ID として入力できる機能を追加。[#16834](https://github.com/ClickHouse/ClickHouse/pull/16834) ([Kruglov Pavel](https://github.com/Avogar))。
- ネストされた型が String である Nullable、LowCardinality、Array、Tuple に対する COLLATE サポートを追加。また、ColumnString.cpp の照合順序に関連するコードをリファクタリング。[#16273](https://github.com/ClickHouse/ClickHouse/pull/16273) ([Kruglov Pavel](https://github.com/Avogar))。
- 新しい `tcpPort` 関数は、このサーバーがリッスンしている TCP ポートを返します。[#17134](https://github.com/ClickHouse/ClickHouse/pull/17134) ([Ivan](https://github.com/abyss7))。
- 新しい数学関数を追加: `acosh`、`asinh`、`atan2`、`atanh`、`cosh`、`hypot`、`log1p`、`sinh`。[#16636](https://github.com/ClickHouse/ClickHouse/pull/16636) ([Konstantin Malanchev](https://github.com/hombit))。
- 異なるレプリカ間でマージを分散する機能。`execute_merges_on_single_replica_time_threshold` mergetree 設定を導入。[#16424](https://github.com/ClickHouse/ClickHouse/pull/16424) ([filimonov](https://github.com/filimonov))。
- SQL 標準互換性のための設定 `aggregate_functions_null_for_empty` を追加。このオプションは、クエリ内のすべての集約関数を書き換え、-OrNull サフィックスを追加します。[10273](https://github.com/ClickHouse/ClickHouse/issues/10273) を実装。[#16123](https://github.com/ClickHouse/ClickHouse/pull/16123) ([flynn](https://github.com/ucasFL))。
- DateTime、DateTime64 のパースを更新し、文字列 Date リテラル形式を受け入れるようになりました。[#16040](https://github.com/ClickHouse/ClickHouse/pull/16040) ([Maksim Kita](https://github.com/kitaisreal))。
- `clickhouse-client` で `--history_file` パラメータを使用して履歴ファイルのパスを変更できるようになりました。[#15960](https://github.com/ClickHouse/ClickHouse/pull/15960) ([Maksim Kita](https://github.com/kitaisreal))。

#### バグ修正 {#bug-fix-2}


* ごくまれなケースでサーバーが接続を受け付けなくなる問題を修正しました。 [#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) ([Amos Bird](https://github.com/amosbird)).
* Windows Subsystem for Linux 上で ClickHouse を実行している環境において、`Atomic` データベースで `RENAME` クエリを実行した際に発生していた `Function not implemented` エラーを修正しました。 [#17661](https://github.com/ClickHouse/ClickHouse/issues/17661) を解決します。 [#17664](https://github.com/ClickHouse/ClickHouse/pull/17664) ([tavplubix](https://github.com/tavplubix))。
* `in_memory_parts_enable_wal` が無効な場合は、WAL からパーツを復元しないようにしました。 [#17802](https://github.com/ClickHouse/ClickHouse/pull/17802) ([detailyang](https://github.com/detailyang)).
* MergeTreeWriterSettings の `max_compress_block_size` が `min_compress_block_size` で誤って初期化されていた問題を修正しました。 [#17833](https://github.com/ClickHouse/ClickHouse/pull/17833) ([flynn](https://github.com/ucasFL)).
* 削除対象となるテーブルの最大サイズに関する例外メッセージが正しく表示されていませんでした。 [#17764](https://github.com/ClickHouse/ClickHouse/pull/17764) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `Distributed` テーブルへの挿入時に、空き領域が不足している場合に発生する可能性のあったセグメンテーションフォルトを修正しました。 [#17737](https://github.com/ClickHouse/ClickHouse/pull/17737) ([tavplubix](https://github.com/tavplubix)).
* ClickHouse が MySQL サーバーへの接続を再開できない問題を修正しました。 [#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz)).
* `pool_size` &gt; 1 の場合のレースコンディションにより、`ON CLUSTER` クエリを実行する際に、クラスタが循環（クロス）レプリケーションされているかどうかが誤って判定されることがありました。修正済みです。 [#17640](https://github.com/ClickHouse/ClickHouse/pull/17640) ([tavplubix](https://github.com/tavplubix)).
* `MergeTree` テーブルに対して、バックグラウンドで発生した例外 `fmt::v7::format_error` をログに記録できるようになりました。これにより [#17613](https://github.com/ClickHouse/ClickHouse/issues/17613) が修正されます。 [#17615](https://github.com/ClickHouse/ClickHouse/pull/17615) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `clickhouse-client` を対話モードで複数行クエリとともに使用した場合、1 行コメントが誤ってクエリの終端まで延長されていました。この修正により [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654) が解決されています。[#17565](https://github.com/ClickHouse/ClickHouse/pull/17565)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 対応する mutation が別のレプリカ上で kill された場合に `ALTER` クエリがハングする問題を修正しました。[#16953](https://github.com/ClickHouse/ClickHouse/issues/16953) を解決します。 [#17499](https://github.com/ClickHouse/ClickHouse/pull/17499)（[alesapin](https://github.com/alesapin)）。
* `mark cache` サイズが ClickHouse によって過小に見積もられていた問題を修正しました。これは、`marks` を含むごく小さいファイルが多数存在する場合に発生する可能性があります。 [#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin)).
* 設定 `optimize_redundant_functions_in_order_by` 有効時の `ORDER BY` の動作を修正。 [#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* 誤った最適化により `DISTINCT` 適用後に発生する可能性があった重複を修正。[#17294](https://github.com/ClickHouse/ClickHouse/issues/17294) を修正。[#17296](https://github.com/ClickHouse/ClickHouse/pull/17296)（[li chengxiang](https://github.com/chengxianglibra)）。[#17439](https://github.com/ClickHouse/ClickHouse/pull/17439)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `LowCardinality` 型を含む `JOIN` テーブルからの読み取り時に発生するクラッシュを修正。[#17228](https://github.com/ClickHouse/ClickHouse/issues/17228) を解決。[#17397](https://github.com/ClickHouse/ClickHouse/pull/17397)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `toInt256(inf)` によるスタックオーバーフローを修正。Int256 は実験的な機能です。[#17235](https://github.com/ClickHouse/ClickHouse/issues/17235) をクローズ。[#17257](https://github.com/ClickHouse/ClickHouse/pull/17257)（[flynn](https://github.com/ucasFL)）。
* `LIMIT` を含む Distributed クエリで `Unexpected packet Data received from client` エラーが記録される可能性のある問題を修正。 [#17254](https://github.com/ClickHouse/ClickHouse/pull/17254) ([Azat Khuzhin](https://github.com/azat)).
* サブクエリ内に const カラムがある場合の set インデックスの無効化処理を修正しました。これにより [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246) が修正されます。[#17249](https://github.com/ClickHouse/ClickHouse/pull/17249)（[Amos Bird](https://github.com/amosbird)）。
* インデックス比較の型が異なる場合に誤ったインデックス解析が行われる可能性がある問題を修正しました。これにより [#17122](https://github.com/ClickHouse/ClickHouse/issues/17122) が解決されます。[#17145](https://github.com/ClickHouse/ClickHouse/pull/17145)（[Amos Bird](https://github.com/amosbird)）。
* クラッシュを引き起こしていた `ColumnConst` の比較処理を修正しました。これにより [#17088](https://github.com/ClickHouse/ClickHouse/issues/17088) が解決されました。 [#17135](https://github.com/ClickHouse/ClickHouse/pull/17135) ([Amos Bird](https://github.com/amosbird))。
* MaterializeMySQL（実験的機能）に対する複数の修正。[#16923](https://github.com/ClickHouse/ClickHouse/issues/16923) を修正。[#15883](https://github.com/ClickHouse/ClickHouse/issues/15883) を修正。MySQL の `binlog_checksum` を変更した際に発生する MaterializeMySQL の SYNC 失敗を修正。[#17091](https://github.com/ClickHouse/ClickHouse/pull/17091)（[Winter Zhang](https://github.com/zhang2014)）。
* リーダーではない ReplicatedMergeTree テーブルに対する `ON CLUSTER` クエリが無期限にハングする可能性があるバグを修正。 [#17089](https://github.com/ClickHouse/ClickHouse/pull/17089) ([alesapin](https://github.com/alesapin)).
* `some_table` が `AS table_function()` を使って作成されていた場合に、`CREATE TABLE ... AS some_table` クエリで発生していたクラッシュを修正しました。 [#16944](https://github.com/ClickHouse/ClickHouse/issues/16944) を修正。 [#17072](https://github.com/ClickHouse/ClickHouse/pull/17072)（[tavplubix](https://github.com/tavplubix)）。
* 関数 fuzzBits の未完成の実装に起因するバグ。関連 issue: [#16980](https://github.com/ClickHouse/ClickHouse/issues/16980)。[#17051](https://github.com/ClickHouse/ClickHouse/pull/17051)（[hexiaoting](https://github.com/hexiaoting)）。
* CFA レジスタが RAX の場合の LLVM の libunwind を修正します。これは [LLVM の libunwind](https://github.com/llvm/llvm-project/tree/master/libunwind) における[バグ](https://bugs.llvm.org/show_bug.cgi?id=48186)です。このバグに対する回避策はすでに用意されています。[#17046](https://github.com/ClickHouse/ClickHouse/pull/17046)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `LIMIT` を含むクエリなど、実行中にキャンセルされる可能性のあるリモートクエリで、不要なネットワークエラーが発生しないようにしました。 [#17006](https://github.com/ClickHouse/ClickHouse/pull/17006) ([Azat Khuzhin](https://github.com/azat)).
* OFFSET のみを含むクエリに対し、デフォルトでは無効になっている `optimize_distributed_group_by_sharding_key` 設定の挙動を修正しました。 [#16996](https://github.com/ClickHouse/ClickHouse/pull/16996) ([Azat Khuzhin](https://github.com/azat)).
* `JOIN` を伴う `Distributed` テーブル上の `Merge` テーブルに関する修正。 [#16993](https://github.com/ClickHouse/ClickHouse/pull/16993) ([Azat Khuzhin](https://github.com/azat)).
* double からのキャスト時に、大きな整数 (128, 256 ビット) で誤った結果が返される問題を修正しました。大きな整数のサポートは実験的機能です。 [#16986](https://github.com/ClickHouse/ClickHouse/pull/16986) ([Mike](https://github.com/myrrc)).
* `ALTER TABLE ... MODIFY COLUMN ... NewType` の実行中に、変更中のカラムを対象とした `WHERE` 句を含む `SELECT` が行われた場合に発生し得るサーバークラッシュを修正しました。 [#16968](https://github.com/ClickHouse/ClickHouse/pull/16968) ([Amos Bird](https://github.com/amosbird)).
* `clickhouse-git-import` において blame 情報が正しく算出されていませんでした。 [#16959](https://github.com/ClickHouse/ClickHouse/pull/16959) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 単調関数を用いた `ORDER BY` の最適化を修正。 [#16107](https://github.com/ClickHouse/ClickHouse/issues/16107) を修正。 [#16956](https://github.com/ClickHouse/ClickHouse/pull/16956)（[Anton Popov](https://github.com/CurtizJ)）。
* `optimize_aggregators_of_group_by_keys` 設定が有効な場合の `GROUP BY` と `JOIN` の最適化を修正。[#12604](https://github.com/ClickHouse/ClickHouse/issues/12604) を修正。 [#16951](https://github.com/ClickHouse/ClickHouse/pull/16951) ([Anton Popov](https://github.com/CurtizJ)).
* `ORDER BY` を含むクエリで発生しうる `Illegal type of argument` エラーを修正。 [#16580](https://github.com/ClickHouse/ClickHouse/issues/16580) を解決。 [#16928](https://github.com/ClickHouse/ClickHouse/pull/16928) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* InterpreterShowAccessQuery の不自然なコードを修正。 [#16866](https://github.com/ClickHouse/ClickHouse/pull/16866) ([tavplubix](https://github.com/tavplubix)).
* 関数 `timeSeriesGroupSum` 使用時に clickhouse server がクラッシュしないようにしました。この関数は新しい ClickHouse リリースでは削除されています。 [#16865](https://github.com/ClickHouse/ClickHouse/pull/16865) ([filimonov](https://github.com/filimonov))。
* `query profiler` が有効で、かつ一部の関数について（おそらく）不正な非同期アンワインドテーブルを含むバージョンの `glibc` を使用する OS 上に ClickHouse がインストールされている場合に発生する、まれなサイレントクラッシュを修正します。これにより [#15301](https://github.com/ClickHouse/ClickHouse/issues/15301) が修正されます。これにより [#13098](https://github.com/ClickHouse/ClickHouse/issues/13098) が修正されます。[#16846](https://github.com/ClickHouse/ClickHouse/pull/16846)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 引数なしで `any` を使用した際にクラッシュする問題を修正しました。これは [#16803](https://github.com/ClickHouse/ClickHouse/issues/16803) に対応するものです。cc @azat。 [#16826](https://github.com/ClickHouse/ClickHouse/pull/16826)（[Amos Bird](https://github.com/amosbird)）。
* ディスク上にテーブルメタデータを書き込む際にメモリを確保できない場合、破損したメタデータファイルが書き込まれてしまうことがあります。 [#16772](https://github.com/ClickHouse/ClickHouse/pull/16772) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* パーティション述語を使用する簡単なクエリ最適化を修正。 [#16767](https://github.com/ClickHouse/ClickHouse/pull/16767)（[Azat Khuzhin](https://github.com/azat)）。
* `transform_null_in` 設定が有効な場合に、複数カラムおよびタプルに対する `IN` 演算子の動作を修正します。[#15310](https://github.com/ClickHouse/ClickHouse/issues/15310) を修正。[#16722](https://github.com/ClickHouse/ClickHouse/pull/16722)（[Anton Popov](https://github.com/CurtizJ)）。
* MySQL プロトコル経由の `INSERT` クエリで、影響を受けた行数を返すようにしました。以前の ClickHouse は常に 0 を返していましたが、これを修正しました。[#16605](https://github.com/ClickHouse/ClickHouse/issues/16605) を修正します。[#16715](https://github.com/ClickHouse/ClickHouse/pull/16715)（[Winter Zhang](https://github.com/zhang2014)）。
* &#39;if&#39; サフィックス付き集約関数を使用した際に発生するリモートクエリの失敗を修正。 [#16574](https://github.com/ClickHouse/ClickHouse/issues/16574) と [#16231](https://github.com/ClickHouse/ClickHouse/issues/16231) を修正。 [#16610](https://github.com/ClickHouse/ClickHouse/pull/16610)（[Winter Zhang](https://github.com/zhang2014)）。
* `select_sequential_consistency` により最適化された trivial count クエリおよび system.tables で発生していた一貫性のない動作を修正しました。 [#16309](https://github.com/ClickHouse/ClickHouse/pull/16309) ([Hao Chen](https://github.com/haoch))。

#### 改善 {#improvement}


* TTL、mutation、または collapsing merge アルゴリズムによって間引かれた後に残った空のパーツを削除しました。 [#16895](https://github.com/ClickHouse/ClickHouse/pull/16895) ([Anton Popov](https://github.com/CurtizJ)).
* Distributed テーブルにおける非同期送信で、ディレクトリ名のコンパクト形式を有効化しました：`use_compact_format_in_distributed_parts_names` はデフォルトで 1 に設定されています。 [#16788](https://github.com/ClickHouse/ClickHouse/pull/16788) ([Azat Khuzhin](https://github.com/azat)).
* S3 にデータが書き込まれなかった場合は、マルチパートアップロードを中止する。 [#16840](https://github.com/ClickHouse/ClickHouse/pull/16840) ([Pavel Kovalenko](https://github.com/Jokser)).
* エラー発生時に `format_avro_schema_registry_url` の IP を再解決するようにしました。 [#16985](https://github.com/ClickHouse/ClickHouse/pull/16985) ([filimonov](https://github.com/filimonov)).
* system.distribution&#95;queue の data&#95;path 内のパスワードをマスクします。 [#16727](https://github.com/ClickHouse/ClickHouse/pull/16727) ([Azat Khuzhin](https://github.com/azat)).
* 存在しないカラムを置き換えようとする `column transformer` を使用した場合にエラーをスローするようにしました。 [#16183](https://github.com/ClickHouse/ClickHouse/pull/16183) ([hexiaoting](https://github.com/hexiaoting)).
* すべてのスレッドが同時に動作するのに十分なメモリがない場合は、parallel parsing をオフにします。また、誰かが極端に巨大な行（&gt; min&#95;chunk&#95;bytes&#95;for&#95;parallel&#95;parsing）を挿入しようとした場合、&quot;Memory limit exceeded&quot; のような例外が発生する可能性もあります。これは、解析する各チャンクが、互いに独立した文字列（1 行以上）の集合でなければならないためです。 [#16721](https://github.com/ClickHouse/ClickHouse/pull/16721) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* インストールスクリプトは、常に設定フォルダ内にサブディレクトリを作成する必要があります。これはカスタム設定を用いた Docker ビルドにのみ関係します。 [#16936](https://github.com/ClickHouse/ClickHouse/pull/16936) ([filimonov](https://github.com/filimonov))。
* JSONEachRow、JSONCompactEachRow、RegexpRow の各入力フォーマットにおけるエラーメッセージの文法を修正。 [#17205](https://github.com/ClickHouse/ClickHouse/pull/17205) ([nico piderman](https://github.com/sneako)).
* `SOURCE(CLICKHOUSE(...))` のデフォルトの `host` および `port` パラメータを現在のインスタンスに設定し、デフォルトの `user` の値を `'default'` に設定しました。 [#16997](https://github.com/ClickHouse/ClickHouse/pull/16997) ([vdimir](https://github.com/vdimir))。
* `ATTACH/DETACH TABLE <DICTIONARY>` を実行した際に、より情報量の多いエラーメッセージをスローするようにしました。この PR 以前は、`detach table <dict>` は実行自体は成功するものの、メモリ内メタデータが不正な状態になっていました。 [#16885](https://github.com/ClickHouse/ClickHouse/pull/16885) ([Amos Bird](https://github.com/amosbird))。
* cutToFirstSignificantSubdomainWithWWW() を追加しました。 [#16845](https://github.com/ClickHouse/ClickHouse/pull/16845) ([Azat Khuzhin](https://github.com/azat)).
* 誤った設定が指定された場合（`metric_log`.`collect_interval_milliseconds` が欠落している場合）、例外メッセージを出してサーバーが起動しないようになりました。 [#16815](https://github.com/ClickHouse/ClickHouse/pull/16815) ([Ivan](https://github.com/abyss7)).
* 分散 DDL の設定が存在しない場合の例外メッセージを改善しました。これにより [#5075](https://github.com/ClickHouse/ClickHouse/issues/5075) が修正されました。 [#16769](https://github.com/ClickHouse/ClickHouse/pull/16769) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* ユーザビリティの改善：`CREATE TABLE` クエリ内で `CODEC` 式が誤った位置にある場合の構文エラーメッセージで、より適切な候補を提示するようにしました。これにより [#12493](https://github.com/ClickHouse/ClickHouse/issues/12493) が修正されました。 [#16768](https://github.com/ClickHouse/ClickHouse/pull/16768) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* Distributed エンジンの起動時に、非同期 `INSERT` 用の空ディレクトリを削除するようにした。 [#16729](https://github.com/ClickHouse/ClickHouse/pull/16729) ([Azat Khuzhin](https://github.com/azat)).
* nginx サーバーをプロキシとして利用して S3 を使う際のワークアラウンド。現在の Nginx は `http://domain.com?delete` のようなパスが空の URL を受け付けませんが、標準の aws-sdk-cpp はこの種の URL を生成します。このコミットではパッチ適用済みの aws-sdk-cpp バージョンを使用し、このような場合に `http://domain.com/?delete` のようにパスとして &quot;/&quot; を持つ URL を生成するようにしています。[#16709](https://github.com/ClickHouse/ClickHouse/pull/16709)（[ianton-ru](https://github.com/ianton-ru)）。
* 同じサイズの整数および浮動小数点数に対しても `reinterpretAs*` 関数が動作するようにしました。[16640](https://github.com/ClickHouse/ClickHouse/issues/16640) を実装。[#16657](https://github.com/ClickHouse/ClickHouse/pull/16657)（[flynn](https://github.com/ucasFL)）。
* `config.xml` 内の `<auxiliary_zookeepers>` 設定を、サーバーを起動し直すことなく変更してリロードできるようになりました。 [#16627](https://github.com/ClickHouse/ClickHouse/pull/16627) ([Amos Bird](https://github.com/amosbird)).
* リモートリソースへの HTTPS 接続で SNI をサポートしました。これにより、SNI を必須とする Cloudflare サーバーへの接続が可能になります。これにより [#10055](https://github.com/ClickHouse/ClickHouse/issues/10055) が修正されました。[#16252](https://github.com/ClickHouse/ClickHouse/pull/16252)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* SNI を必要とする `clickhouse-server` のセキュアエンドポイントへの接続が可能になりました。これは、`clickhouse-server` が TLS プロキシの背後でホストされている場合に利用できます。 [#16938](https://github.com/ClickHouse/ClickHouse/pull/16938) ([filimonov](https://github.com/filimonov)).
* マテリアライズドビューのループが作成された場合に発生しうるスタックオーバーフローを修正しました。これにより [#15732](https://github.com/ClickHouse/ClickHouse/issues/15732) がクローズされます。 [#16048](https://github.com/ClickHouse/ClickHouse/pull/16048) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* MergeTree テーブルエンジンファミリー向けのバックグラウンドタスク処理の実装を簡略化しました。ユーザーからは目に見える変更はないはずです。 [#15983](https://github.com/ClickHouse/ClickHouse/pull/15983) ([alesapin](https://github.com/alesapin)).
* MaterializeMySQL（実験的機能）の改良。MySQL の同期ユーザーに誤った権限が設定されている場合に、正しい同期権限について例外をスローするように変更。 [#15977](https://github.com/ClickHouse/ClickHouse/pull/15977) ([TCeason](https://github.com/TCeason)).
* `indexOf()` が BloomFilter を使用するようになりました。 [#14977](https://github.com/ClickHouse/ClickHouse/pull/14977) ([achimbab](https://github.com/achimbab)).

#### パフォーマンス改善 {#performance-improvement}

- Floyd-Rivestアルゴリズムを使用します。これはClickHouseの部分ソートのユースケースに最適です。ベンチマークは https://github.com/danlark1/miniselect および[こちら](https://drive.google.com/drive/folders/1DHEaeXgZuX6AJ9eByeZ8iQVQv0ueP8XM)にあります。[#16825](https://github.com/ClickHouse/ClickHouse/pull/16825) ([Danila Kutenin](https://github.com/danlark1))。
- `ReplicatedMergeTree`エンジンファミリーは、レプリケーションフェッチ用に専用のスレッドプールを使用するようになりました。プールのサイズは`background_fetches_pool_size`設定で制限され、サーバー再起動時に調整できます。この設定のデフォルト値は3で、並列フェッチの最大数が3であることを意味します(これにより10Gネットワークを活用できます)。#520を修正。[#16390](https://github.com/ClickHouse/ClickHouse/pull/16390) ([alesapin](https://github.com/alesapin))。
- `quantileTDigest`の状態の制御不能な増大を修正しました。[#16680](https://github.com/ClickHouse/ClickHouse/pull/16680) ([hrissan](https://github.com/hrissan))。
- `EXPLAIN`に`VIEW`サブクエリの説明を追加しました。`VIEW`の述語プッシュダウン最適化を制限しました。クエリプランに`Distributed`のローカルレプリカを追加しました。[#14936](https://github.com/ClickHouse/ClickHouse/pull/14936) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- max_threads > 0およびORDER BY内の式を使用した場合のoptimize_read_in_order/optimize_aggregation_in_orderを修正しました。[#16637](https://github.com/ClickHouse/ClickHouse/pull/16637) ([Azat Khuzhin](https://github.com/azat))。
- 大量の`MergeTree`テーブルに対する`Merge`テーブルからの読み取りパフォーマンスを修正しました。[#7748](https://github.com/ClickHouse/ClickHouse/issues/7748)を修正。[#16988](https://github.com/ClickHouse/ClickHouse/pull/16988) ([Anton Popov](https://github.com/CurtizJ))。
- 完全一致でパーティションを安全に削除できるようになりました。有用なケース: テーブルが`intHash64(x) % 100`でパーティション化されており、クエリがxではなく`intHash64(x) % 100`そのものに対する条件を持つ場合を想定します。[#16253](https://github.com/ClickHouse/ClickHouse/pull/16253) ([Amos Bird](https://github.com/amosbird))。

#### 実験的機能 {#experimental-feature}

- `EmbeddedRocksDB`テーブルエンジンを追加しました(ディクショナリに使用できます)。[#15073](https://github.com/ClickHouse/ClickHouse/pull/15073) ([sundyli](https://github.com/sundy-li))。

#### ビルド/テスト/パッケージング改善 {#buildtestingpackaging-improvement-1}


* イメージビルドに関するテストカバレッジを改善。 [#17233](https://github.com/ClickHouse/ClickHouse/pull/17233) ([alesapin](https://github.com/alesapin)).
* 組み込みタイムゾーンデータをバージョン 2020d に更新（`cctz` も最新の master に更新）。 [#17204](https://github.com/ClickHouse/ClickHouse/pull/17204) ([filimonov](https://github.com/filimonov)).
* Poco における UBSan レポートを修正。これにより [#12719](https://github.com/ClickHouse/ClickHouse/issues/12719) がクローズされます。 [#16765](https://github.com/ClickHouse/ClickHouse/pull/16765) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* サードパーティライブラリを UBSan でインストゥルメントしないように変更。 [#16764](https://github.com/ClickHouse/ClickHouse/pull/16764) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* cache dictionaries における UBSan レポートを修正。これにより [#12641](https://github.com/ClickHouse/ClickHouse/issues/12641) がクローズされます。 [#16763](https://github.com/ClickHouse/ClickHouse/pull/16763) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 無限大の浮動小数点数を整数に変換しようとした際の UBSan レポートを修正。これにより [#14190](https://github.com/ClickHouse/ClickHouse/issues/14190) がクローズされます。 [#16677](https://github.com/ClickHouse/ClickHouse/pull/16677) ([alexey-milovidov](https://github.com/alexey-milovidov)).



## ClickHouse リリース 20.11 {#clickhouse-release-2011}

### ClickHouse リリース v20.11.7.16-stable, 2021-03-02 {#clickhouse-release-v2011716-stable-2021-03-02}

#### 改善 {#improvement-1}

- clickhouse-server イメージにおいて、clickhouse ユーザーおよびグループの uid / gid を固定値（101）に明示的に設定しました。[#19096](https://github.com/ClickHouse/ClickHouse/pull/19096) ([filimonov](https://github.com/filimonov))。

#### バグ修正 {#bug-fix-3}


* BloomFilter インデックスのクラッシュを修正。[#19757](https://github.com/ClickHouse/ClickHouse/issues/19757) の修正。[#19884](https://github.com/ClickHouse/ClickHouse/pull/19884)（[Maksim Kita](https://github.com/kitaisreal)）。
* system.text&#95;log が有効になっている場合にデッドロックが発生する可能性がありました。これにより [#19874](https://github.com/ClickHouse/ClickHouse/issues/19874) が修正されます。 [#19875](https://github.com/ClickHouse/ClickHouse/pull/19875) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 以前のバージョンでは、関数 arrayEnumerateUniq に対する異常な引数が、クラッシュや無限ループを引き起こす可能性がありました。これにより [#19787](https://github.com/ClickHouse/ClickHouse/issues/19787) が解決されました。[#19788](https://github.com/ClickHouse/ClickHouse/pull/19788)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 算術型と文字列型の精密な比較を行った際に発生していたスタックオーバーフローを修正しました。 [#19773](https://github.com/ClickHouse/ClickHouse/pull/19773) ([tavplubix](https://github.com/tavplubix)).
* `bitmapAndnot` 関数で発生するセグメンテーションフォルトを修正。[#19668](https://github.com/ClickHouse/ClickHouse/issues/19668) を解決。[#19713](https://github.com/ClickHouse/ClickHouse/pull/19713)（[Maksim Kita](https://github.com/kitaisreal)）。
* 一部の `big integers` を使用する関数が segfault を引き起こす可能性があります。`big integers` は実験的な機能です。これにより [#19667](https://github.com/ClickHouse/ClickHouse/issues/19667) がクローズされました。 [#19672](https://github.com/ClickHouse/ClickHouse/pull/19672) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `LowCardinality` 引数に対する `neighbor` 関数の誤った結果を修正。 [#10333](https://github.com/ClickHouse/ClickHouse/issues/10333) に対応。 [#19617](https://github.com/ClickHouse/ClickHouse/pull/19617)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* disconnect 後の Connection で発生する CompressedWriteBuffer の use-after-free 問題を修正。 [#19599](https://github.com/ClickHouse/ClickHouse/pull/19599) ([Azat Khuzhin](https://github.com/azat)).
* `DROP/DETACH TABLE table ON CLUSTER cluster SYNC` クエリがハングする可能性がある問題を修正しました。[#19568](https://github.com/ClickHouse/ClickHouse/issues/19568) を解決します。[#19572](https://github.com/ClickHouse/ClickHouse/pull/19572)（[tavplubix](https://github.com/tavplubix)）。
* `CREATE DICTIONARY` クエリの `id` 式を修正しました。 [#19571](https://github.com/ClickHouse/ClickHouse/pull/19571) ([Maksim Kita](https://github.com/kitaisreal)).
* merge&#95;tree&#95;min&#95;rows&#95;for&#95;concurrent&#95;read/merge&#95;tree&#95;min&#95;bytes&#95;for&#95;concurrent&#95;read=0/UINT64&#95;MAX の場合に発生する SIGSEGV を修正。 [#19528](https://github.com/ClickHouse/ClickHouse/pull/19528) ([Azat Khuzhin](https://github.com/azat)).
* 特定の引数を指定して `addMonth` 関数を呼び出した場合に、メモリ読み取り時のバッファオーバーフローが発生する可能性がありました。これにより [#19441](https://github.com/ClickHouse/ClickHouse/issues/19441) が修正されました。また、[#19413](https://github.com/ClickHouse/ClickHouse/issues/19413) も修正されました。[#19472](https://github.com/ClickHouse/ClickHouse/pull/19472)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* いずれかのファイルでデータブロックが空の場合、その分散バッチを破損としてマークするようにしました。 [#19449](https://github.com/ClickHouse/ClickHouse/pull/19449) ([Azat Khuzhin](https://github.com/azat)).
* Uber H3 ライブラリにおけるバッファオーバーフローが起こり得る不具合を修正しました。詳細は [https://github.com/uber/h3/issues/392](https://github.com/uber/h3/issues/392) を参照してください。これは [#19219](https://github.com/ClickHouse/ClickHouse/issues/19219) をクローズします。 [#19383](https://github.com/ClickHouse/ClickHouse/pull/19383) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* system.parts の &#95;state カラムを修正（このカラムをクエリすると、順序が正しくないため LOGICAL&#95;ERROR が発生していた）。 [#19346](https://github.com/ClickHouse/ClickHouse/pull/19346) ([Azat Khuzhin](https://github.com/azat)).
* エラー `Cannot convert column now64() because it is constant but values of constants are different in source and result` を修正しました。[#7156](https://github.com/ClickHouse/ClickHouse/issues/7156) の対応の続きです。[#19316](https://github.com/ClickHouse/ClickHouse/pull/19316)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `ReplicatedMergeTree` テーブルの処理中に、同時に実行された `ALTER` および `DROP` クエリがハングする可能性があるバグを修正。 [#19237](https://github.com/ClickHouse/ClickHouse/pull/19237) ([alesapin](https://github.com/alesapin)).
* `ORC` フォーマットのファイルからの無限読み取りを修正（[#10580](https://github.com/ClickHouse/ClickHouse/issues/10580) で導入された問題）。[#19095](https://github.com/ClickHouse/ClickHouse/issues/19095) を解決。[#19134](https://github.com/ClickHouse/ClickHouse/pull/19134)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 起動時に `LowCardinality(Nullable(...))` から圧縮コーデックを読み取れず、例外 `Attempt to read after EOF` をスローしていたバグを修正しました。 [#18340](https://github.com/ClickHouse/ClickHouse/issues/18340) の修正です。 [#19101](https://github.com/ClickHouse/ClickHouse/pull/19101)（[alesapin](https://github.com/alesapin)）。
* `Template` または `CustomSeparated` フォーマットを使用して http インターフェイス経由でデータを挿入する際に発生していた `There is no checkpoint` エラーを修正しました。[#19021](https://github.com/ClickHouse/ClickHouse/issues/19021) に対応。[#19072](https://github.com/ClickHouse/ClickHouse/pull/19072) ([tavplubix](https://github.com/tavplubix))。
* 古い構文で作成された `MergeTree` テーブルに対しては、`MODIFY TTL` クエリを禁止するようにしました。以前はクエリ自体は成功していましたが、実際には何の効果もありませんでした。 [#19064](https://github.com/ClickHouse/ClickHouse/pull/19064) ([Anton Popov](https://github.com/CurtizJ)).
* `Enum` 型の引数に対して `groupUniqArray` が正しい型を返すようにしました。これにより [#17875](https://github.com/ClickHouse/ClickHouse/issues/17875) がクローズされました。 [#19019](https://github.com/ClickHouse/ClickHouse/pull/19019) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 関数 `ignore` を `LowCardinality` 引数とともに使用した場合に発生する可能性のある `Expected single dictionary argument for function` エラーを修正しました。[#14275](https://github.com/ClickHouse/ClickHouse/issues/14275) を修正。[#19016](https://github.com/ClickHouse/ClickHouse/pull/19016)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `TinyLog` エンジンのテーブルへの `LowCardinality` 列の挿入処理を修正。[#18629](https://github.com/ClickHouse/ClickHouse/issues/18629) を修正。[#19010](https://github.com/ClickHouse/ClickHouse/pull/19010)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `optimize_move_functions_out_of_any` を無効化しました。この最適化は常に正しいとは限らないためです。これにより [#18051](https://github.com/ClickHouse/ClickHouse/issues/18051) がクローズされます。また [#18973](https://github.com/ClickHouse/ClickHouse/issues/18973) もクローズされます。 [#18981](https://github.com/ClickHouse/ClickHouse/pull/18981)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* シャットダウン時にごくまれに発生するデッドロックを修正。 [#18977](https://github.com/ClickHouse/ClickHouse/pull/18977) ([tavplubix](https://github.com/tavplubix)).
* 一部のエスケープされたテキストを含むミューテーション（`ALTER ... UPDATE e = CAST('foo', 'Enum8(\'foo\' = 1')` のようなもの）が誤ってシリアライズされるバグを修正しました。[#18878](https://github.com/ClickHouse/ClickHouse/issues/18878) を修正。[#18944](https://github.com/ClickHouse/ClickHouse/pull/18944)（[alesapin](https://github.com/alesapin)）。
* `ATTACH PARTITION` は mutation をリセットする必要があります。 [#18804](https://github.com/ClickHouse/ClickHouse/issues/18804)。 [#18935](https://github.com/ClickHouse/ClickHouse/pull/18935) ([fastio](https://github.com/fastio))。
* clickhouse-local のシャットダウン時にハングする可能性のある問題を修正しました。これにより [#18891](https://github.com/ClickHouse/ClickHouse/issues/18891) が解決されます。 [#18893](https://github.com/ClickHouse/ClickHouse/pull/18893) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 単項関数と `Nullable` 型を組み合わせた `If` コンビネータの問題を修正。 [#18806](https://github.com/ClickHouse/ClickHouse/pull/18806) ([Azat Khuzhin](https://github.com/azat)).
* `network_compression_method` 設定がグローバルにデフォルト以外の値に設定されている場合、非同期分散 `INSERT` がサーバーによって拒否されることがあります。これにより [#18741](https://github.com/ClickHouse/ClickHouse/issues/18741) が修正されました。 [#18776](https://github.com/ClickHouse/ClickHouse/pull/18776)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `Nullable(String)` から `Nullable(Decimal(P, S))` へ `CAST` しようとした際に発生していた `Attempt to read after eof` エラーを修正しました。これにより、nullable な文字列から decimal をパースできない場合、関数 `CAST` は `NULL` を返すようになりました。[#7690](https://github.com/ClickHouse/ClickHouse/issues/7690) を修正します。 [#18718](https://github.com/ClickHouse/ClickHouse/pull/18718)（[Winter Zhang](https://github.com/zhang2014)）。
* 引数サイズの不一致が原因の `Logger` の問題を修正。 [#18717](https://github.com/ClickHouse/ClickHouse/pull/18717) ([sundyli](https://github.com/sundy-li)).
* FixedString データ型のサポートを追加。MySQL から ClickHouse へデータをレプリケートする際に、「Code: 50, e.displayText() = DB::Exception: Unsupported type FixedString(1)」という例外が発生していました。このパッチはバグ [#18450](https://github.com/ClickHouse/ClickHouse/issues/18450) を修正し、あわせて [#6556](https://github.com/ClickHouse/ClickHouse/issues/6556) も修正します。[#18553](https://github.com/ClickHouse/ClickHouse/pull/18553)（[awesomeleo](https://github.com/awesomeleo)）。
* `RIGHT` または `FULL` join を含むサブクエリの後に `ORDER BY` を使用した場合に発生する可能性がある `Pipeline stuck` エラーを修正しました。 [#18550](https://github.com/ClickHouse/ClickHouse/pull/18550) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 対応する mutation の kill の後に `ALTER` クエリがハングする可能性があるバグを修正。thread fuzzer によって検出。 [#18518](https://github.com/ClickHouse/ClickHouse/pull/18518) ([alesapin](https://github.com/alesapin))。
* マージ時の書き込みでの AIO を無効化しました。これは、マージ中にプライマリキー列の極めてまれなデータ破損を引き起こす可能性があるためです。 [#18481](https://github.com/ClickHouse/ClickHouse/pull/18481) ([alesapin](https://github.com/alesapin)).
* 結果を計算できない場合、解析ステージでサブクエリの定数畳み込みを無効化しました。 [#18446](https://github.com/ClickHouse/ClickHouse/pull/18446) ([Azat Khuzhin](https://github.com/azat)).
* `Nullable(String)` 型の引数に対して `toType(...)` 系の関数（`toDate`、`toUInt32` など）を実行した際に発生していた `value is too short` エラーを修正しました。これらの関数は、パースエラー時に例外をスローするのではなく `NULL` を返すようになりました。[#7673](https://github.com/ClickHouse/ClickHouse/issues/7673) を修正。[#18445](https://github.com/ClickHouse/ClickHouse/pull/18445)（[tavplubix](https://github.com/tavplubix)）。
* ワイドパーツからコンパクトパーツへのマージを制限しました。`vertical merge` の場合、結果のパーツが壊れる原因となっていました。 [#18381](https://github.com/ClickHouse/ClickHouse/pull/18381) ([Anton Popov](https://github.com/CurtizJ)).
* テーブル `system.settings_profile_elements` のデータ投入処理を修正。この PR は [#18231](https://github.com/ClickHouse/ClickHouse/issues/18231) を修正します。[#18379](https://github.com/ClickHouse/ClickHouse/pull/18379)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 定数引数を持つ二項関数のインデックス解析を修正し、誤ったクエリ結果が返される問題を解消しました。これにより [#18364](https://github.com/ClickHouse/ClickHouse/issues/18364) が修正されました。[#18373](https://github.com/ClickHouse/ClickHouse/pull/18373)（[Amos Bird](https://github.com/amosbird)）。
* 2 段階集約で `Distinct` コンビネータを使用した際に、集約関数で発生する可能性があったクラッシュを修正しました。[#17682](https://github.com/ClickHouse/ClickHouse/issues/17682) を修正。[#18365](https://github.com/ClickHouse/ClickHouse/pull/18365)（[Anton Popov](https://github.com/CurtizJ)）。
* `table` から任意のカラムを 1 つだけ選択できる場合、`SELECT count() FROM table` を実行できるようになりました。この PR は [#10639](https://github.com/ClickHouse/ClickHouse/issues/10639) を修正します。 [#18233](https://github.com/ClickHouse/ClickHouse/pull/18233) ([Vitaly Baranov](https://github.com/vitlibar))。
* `SELECT JOIN` では、結合対象の各テーブルに対して `SELECT` 権限が必要になりました。この PR は [#17654](https://github.com/ClickHouse/ClickHouse/issues/17654) を修正します。 [#18232](https://github.com/ClickHouse/ClickHouse/pull/18232)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `MergeTree*` からの読み取り時に read backoff（ログメッセージ `<Debug> MergeTreeReadPool: Will lower number of threads`）が発生した場合に、クエリ結果が不完全になる可能性のある問題を修正。[#16423](https://github.com/ClickHouse/ClickHouse/issues/16423) で導入された問題であり、[#18137](https://github.com/ClickHouse/ClickHouse/issues/18137) を修正。[#18216](https://github.com/ClickHouse/ClickHouse/pull/18216)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* クエリ `MODIFY COLUMN ... REMOVE TTL` が実際にはカラム TTL を削除しない不具合を修正。[#18130](https://github.com/ClickHouse/ClickHouse/pull/18130)（[alesapin](https://github.com/alesapin)）。
* 述語オプティマイザにおける非決定的関数の扱いを修正。これにより [#17244](https://github.com/ClickHouse/ClickHouse/issues/17244) が解決されます。[#17273](https://github.com/ClickHouse/ClickHouse/pull/17273)（[Winter Zhang](https://github.com/zhang2014)）。
* `MOVE` や `REPLACE PARTITION` の後、存在しないパーツを待ち続けて Mutation がハングすることがあり、まれに `DETACH` や `DROP PARTITION` の後にも発生することがありました。この問題を修正しました。 [#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-2}

- タイムゾーン情報を2020eに更新。[#18531](https://github.com/ClickHouse/ClickHouse/pull/18531) ([alesapin](https://github.com/alesapin))。

### ClickHouseリリース v20.11.6.6-stable, 2020-12-24 {#clickhouse-release-v201166-stable-2020-12-24}

#### バグ修正 {#bug-fix-4}


* デュアルな `IPv4/IPv6 stack` を持つマシンで、サーバーから `clickhouse-odbc-bridge` プロセスに到達できない問題を修正し、また、ODBC 辞書の更新が不正なクエリで実行される場合やクラッシュを引き起こす場合がある問題も修正しました。これにより、おそらく [#14489](https://github.com/ClickHouse/ClickHouse/issues/14489) が解決されています。 [#18278](https://github.com/ClickHouse/ClickHouse/pull/18278)（[Denis Glazachev](https://github.com/traceon)）。
* Enum 型と Int 型の間の固定キー比較を修正しました。これにより [#17989](https://github.com/ClickHouse/ClickHouse/issues/17989) が解決されました。[#18214](https://github.com/ClickHouse/ClickHouse/pull/18214)（[Amos Bird](https://github.com/amosbird)）。
* `MaterializeMySQL` データベースエンジンにおけるユニークキー変換時のクラッシュを修正しました。これにより、[#18186](https://github.com/ClickHouse/ClickHouse/issues/18186) および [#16372](https://github.com/ClickHouse/ClickHouse/issues/16372) が修正されました。[#18211](https://github.com/ClickHouse/ClickHouse/pull/18211)（[Winter Zhang](https://github.com/zhang2014)）。
* S3 URL の解析時に発生する `std::out_of_range: basic_string` を修正しました。 [#18059](https://github.com/ClickHouse/ClickHouse/pull/18059) ([Vladimir Chebotarev](https://github.com/excitoon))。
* MaterializeMySQL が MySQL プレフィックスインデックスの変換をサポートしていなかったことが原因で、一部のテーブルが MySQL から ClickHouse に同期されない問題を修正しました。これにより [#15187](https://github.com/ClickHouse/ClickHouse/issues/15187) および [#17912](https://github.com/ClickHouse/ClickHouse/issues/17912) [#17944](https://github.com/ClickHouse/ClickHouse/pull/17944) が解決されました（[Winter Zhang](https://github.com/zhang2014)）。
* クエリに `ARRAY JOIN` が含まれている場合に、クエリ最適化によって誤った結果が返される問題を修正しました。 [#17887](https://github.com/ClickHouse/ClickHouse/pull/17887) ([sundyli](https://github.com/sundy-li))。
* `topK` 集約関数で発生する可能性のあったセグメンテーションフォールトを修正しました。これにより [#17404](https://github.com/ClickHouse/ClickHouse/issues/17404) がクローズされます。 [#17845](https://github.com/ClickHouse/ClickHouse/pull/17845) ([Maksim Kita](https://github.com/kitaisreal))。
* `in_memory_parts_enable_wal` が無効化されている場合は、WAL からパーツを復元しないようにしました。 [#17802](https://github.com/ClickHouse/ClickHouse/pull/17802) ([detailyang](https://github.com/detailyang)).
* ClickHouse が MySQL サーバーへの接続再開に失敗する不具合を修正しました。 [#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz)).
* パーティション述語を伴う `optimize_trivial_count_query` の不整合な動作を修正しました。 [#17644](https://github.com/ClickHouse/ClickHouse/pull/17644) ([Azat Khuzhin](https://github.com/azat)).
* サーバーがデーモンモードで動作しているときに `system.stack_trace` テーブルが空になってしまう問題を修正しました。 [#17630](https://github.com/ClickHouse/ClickHouse/pull/17630) ([Amos Bird](https://github.com/amosbird)).
* MergeTree テーブルでバックグラウンド処理中に `fmt::v7::format_error` 例外がログに記録される可能性があった動作を修正しました。これにより [#17613](https://github.com/ClickHouse/ClickHouse/issues/17613) が修正されます。 [#17615](https://github.com/ClickHouse/ClickHouse/pull/17615) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `clickhouse-client` を対話モードで複数行クエリとともに使用した際、単一行コメントが誤ってクエリの末尾まで拡張されてしまう問題を修正しました。これにより [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654) が解決されます。 [#17565](https://github.com/ClickHouse/ClickHouse/pull/17565) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 非常にまれなケースでサーバーが接続の受け付けを停止してしまう問題を修正しました。 [#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 対応する mutation が別のレプリカ上で kill された場合に `ALTER` クエリがハングする問題を修正しました。これにより [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953) が解決されました。 [#17499](https://github.com/ClickHouse/ClickHouse/pull/17499) ([alesapin](https://github.com/alesapin))。
* `mark cache` のサイズが ClickHouse によって過小に見積もられてしまうバグを修正しました。これは、多数の小さな `mark` を含むファイルが存在する場合に発生することがあります。 [#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin)).
* 設定 `optimize_redundant_functions_in_order_by` が有効な場合の `ORDER BY` の動作を修正。 [#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* 誤った最適化により `DISTINCT` の後に発生する可能性があった重複を修正しました。これにより [#17294](https://github.com/ClickHouse/ClickHouse/issues/17294) が修正されます。[#17296](https://github.com/ClickHouse/ClickHouse/pull/17296)（[li chengxiang](https://github.com/chengxianglibra)）。[#17439](https://github.com/ClickHouse/ClickHouse/pull/17439)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `LowCardinality` 型を含む `JOIN` テーブルからの読み取り時に発生していたクラッシュを修正しました。これにより [#17228](https://github.com/ClickHouse/ClickHouse/issues/17228) が解決されました。[#17397](https://github.com/ClickHouse/ClickHouse/pull/17397)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* サブクエリ内に `const` カラムが存在する場合の fixed set インデックスの失効処理を修正しました。これにより [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246) が解決されました。 [#17249](https://github.com/ClickHouse/ClickHouse/pull/17249) ([Amos Bird](https://github.com/amosbird))。
* インデックス比較の型が異なる場合に誤ったインデックス解析が行われる可能性があった問題を修正しました。これにより [#17122](https://github.com/ClickHouse/ClickHouse/issues/17122) が解決されました。[#17145](https://github.com/ClickHouse/ClickHouse/pull/17145)（[Amos Bird](https://github.com/amosbird)）。
* クラッシュを引き起こしていた `ColumnConst` の比較処理を修正しました。これにより [#17088](https://github.com/ClickHouse/ClickHouse/issues/17088) が解決されます。[#17135](https://github.com/ClickHouse/ClickHouse/pull/17135)（[Amos Bird](https://github.com/amosbird)）。
* リーダーではない `ReplicatedMergeTreeTables` に対する `ON CLUSTER` クエリが無期限にハングする可能性があったバグを修正しました。 [#17089](https://github.com/ClickHouse/ClickHouse/pull/17089) ([alesapin](https://github.com/alesapin)).
* `fuzzBits` 関数で fuzzer によって発見されたバグを修正しました。これにより [#16980](https://github.com/ClickHouse/ClickHouse/issues/16980) が解決されます。[#17051](https://github.com/ClickHouse/ClickHouse/pull/17051)（[hexiaoting](https://github.com/hexiaoting)）。
* `LIMIT` を含むクエリのように、実行中にキャンセルされる可能性があるリモートクエリで発生する不要なネットワークエラーを回避します。 [#17006](https://github.com/ClickHouse/ClickHouse/pull/17006) ([Azat Khuzhin](https://github.com/azat)).
* `double` からキャストする際に、大きな整数（128 ビット、256 ビット）で誤った結果が返される問題を修正しました。 [#16986](https://github.com/ClickHouse/ClickHouse/pull/16986) ([Mike](https://github.com/myrrc)).
* エラー発生時に `format_avro_schema_registry_url` の IP を再度解決するようにしました。[#16985](https://github.com/ClickHouse/ClickHouse/pull/16985) ([filimonov](https://github.com/filimonov)).
* `ALTER TABLE ... MODIFY COLUMN ... NewType` の実行後、変更中のカラムに対して `WHERE` 句付きの `SELECT` が実行され、`ALTER` がまだ完了していない場合にサーバーがクラッシュする可能性があった問題を修正しました。 [#16968](https://github.com/ClickHouse/ClickHouse/pull/16968) ([Amos Bird](https://github.com/amosbird))。
* `clickhouse-git-import` において blame 情報が正しく算出されていませんでした。 [#16959](https://github.com/ClickHouse/ClickHouse/pull/16959) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 単調関数を用いた `ORDER BY` の最適化を修正。[#16107](https://github.com/ClickHouse/ClickHouse/issues/16107) を修正。[#16956](https://github.com/ClickHouse/ClickHouse/pull/16956)（[Anton Popov](https://github.com/CurtizJ)）。
* `optimize_aggregators_of_group_by_keys` 設定が有効な場合の `GROUP BY` と `JOIN` の最適化を修正しました。これにより [#12604](https://github.com/ClickHouse/ClickHouse/issues/12604) が解決されます。 [#16951](https://github.com/ClickHouse/ClickHouse/pull/16951) ([Anton Popov](https://github.com/CurtizJ))。
* インストールスクリプトは常に設定フォルダ内にサブディレクトリを作成するようにしました。これはカスタム設定を用いた Docker ビルドにのみ関係します。 [#16936](https://github.com/ClickHouse/ClickHouse/pull/16936) ([filimonov](https://github.com/filimonov)).
* `ORDER BY` を含むクエリで発生しうる `Illegal type of argument` エラーを修正しました。これにより [#16580](https://github.com/ClickHouse/ClickHouse/issues/16580) が解決されました。[#16928](https://github.com/ClickHouse/ClickHouse/pull/16928)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* WriteBufferFromS3 にデータが書き込まれなかった場合、マルチパートアップロードを中止するようにしました。 [#16840](https://github.com/ClickHouse/ClickHouse/pull/16840) ([Pavel Kovalenko](https://github.com/Jokser)).
* 引数なしで `any` を使用した場合にクラッシュする問題を修正しました。これにより [#16803](https://github.com/ClickHouse/ClickHouse/issues/16803) が解決されます。 [#16826](https://github.com/ClickHouse/ClickHouse/pull/16826)（[Amos Bird](https://github.com/amosbird)）。
* MySQL プロトコル経由の `INSERT` クエリに対して、影響を受けた行数ではなく常に 0 を返していた ClickHouse の動作を修正しました。これにより [#16605](https://github.com/ClickHouse/ClickHouse/issues/16605) が解決されます。 [#16715](https://github.com/ClickHouse/ClickHouse/pull/16715) ([Winter Zhang](https://github.com/zhang2014)).
* TDigest の制御不能な肥大化を修正しました。 [#16680](https://github.com/ClickHouse/ClickHouse/pull/16680) ([hrissan](https://github.com/hrissan)).
* Aggregate 関数でサフィックス `if` を使用した際に発生していたリモートクエリの失敗を修正しました。これにより [#16574](https://github.com/ClickHouse/ClickHouse/issues/16574)、[#16231](https://github.com/ClickHouse/ClickHouse/issues/16231)、[#16610](https://github.com/ClickHouse/ClickHouse/pull/16610) が修正されました（[Winter Zhang](https://github.com/zhang2014)）。
* `select_sequential_consistency` により、最適化された単純な count クエリおよび system.tables で発生していた不整合な動作を修正しました。 [#16309](https://github.com/ClickHouse/ClickHouse/pull/16309) ([Hao Chen](https://github.com/haoch)).
* 存在しないカラムを `ColumnTransformer` で置き換えようとした場合にエラーをスローするようにしました。 [#16183](https://github.com/ClickHouse/ClickHouse/pull/16183) ([hexiaoting](https://github.com/hexiaoting)).

### ClickHouseリリース v20.11.3.3-stable, 2020-11-13 {#clickhouse-release-v201133-stable-2020-11-13}

#### バグ修正 {#bug-fix-5}

- クエリプロファイラが有効で、一部の関数に対して非同期アンワインドテーブルが破損している(と思われる)glibcバージョンを持つOSにClickHouseがインストールされている場合に発生する稀なサイレントクラッシュを修正しました。これにより[#15301](https://github.com/ClickHouse/ClickHouse/issues/15301)が修正されます。これにより[#13098](https://github.com/ClickHouse/ClickHouse/issues/13098)が修正されます。[#16846](https://github.com/ClickHouse/ClickHouse/pull/16846) ([alexey-milovidov](https://github.com/alexey-milovidov))。

### ClickHouseリリース v20.11.2.1, 2020-11-11 {#clickhouse-release-v201121-2020-11-11}

#### 後方互換性のない変更 {#backward-incompatible-change-1}

- `distributed_ddl`設定セクションで`profile`が指定されている場合、このプロファイルがサーバー起動時に`default`プロファイルの設定を上書きする可能性がありました。これが修正され、分散DDLクエリの設定がグローバルサーバー設定に影響を与えないようになりました。[#16635](https://github.com/ClickHouse/ClickHouse/pull/16635) ([tavplubix](https://github.com/tavplubix))。
- キー(ソートキー、プライマリキー、パーティションキーなど)での比較不可能なデータ型(`AggregateFunction`など)の使用を制限しました。[#16601](https://github.com/ClickHouse/ClickHouse/pull/16601) ([alesapin](https://github.com/alesapin))。
- `ANALYZE`および`AST`クエリを削除し、`enable_debug_queries`設定を廃止しました。これらは現在、フル機能の`EXPLAIN`クエリの一部となっています。[#16536](https://github.com/ClickHouse/ClickHouse/pull/16536) ([Ivan](https://github.com/abyss7))。
- 集約関数`boundingRatio`、`rankCorr`、`retention`、`timeSeriesGroupSum`、`timeSeriesGroupRateSum`、`windowFunnel`が誤って大文字小文字を区別しないようになっていました。現在、これらの名前は設計通り大文字小文字を区別するようになりました。SQL標準で指定されている関数、他のDBMSとの互換性のために作成された関数、またはそれらに類似する関数のみが大文字小文字を区別しないようにすべきです。[#16407](https://github.com/ClickHouse/ClickHouse/pull/16407) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `rankCorr`関数がデータ不足時にnanを返すようにしました[#16124](https://github.com/ClickHouse/ClickHouse/issues/16124)。[#16135](https://github.com/ClickHouse/ClickHouse/pull/16135) ([hexiaoting](https://github.com/hexiaoting))。
- 20.5より古いバージョンからアップグレードする際、ローリングアップデートを実行し、クラスタに20.5以上のバージョンと20.5未満のバージョンの両方が含まれている場合、古いバージョンのClickHouseノードが再起動され、新しいバージョンの存在下で古いバージョンが起動すると、`Part ... intersects previous part`エラーが発生する可能性があります。このエラーを防ぐには、まずすべてのクラスタノードに新しいclickhouse-serverパッケージをインストールしてから再起動を実行してください(これにより、clickhouse-serverが再起動されると新しいバージョンで起動します)。

#### 新機能 {#new-feature-1}


* ローカルに存在しないユーザー向けのユーザーディレクトリとして LDAP をサポートしました。 [#12736](https://github.com/ClickHouse/ClickHouse/pull/12736) ([Denis Glazachev](https://github.com/traceon)).
* 現在実行中のバックグラウンドフェッチを表示する `system.replicated_fetches` テーブルを追加しました。 [#16428](https://github.com/ClickHouse/ClickHouse/pull/16428) ([alesapin](https://github.com/alesapin))。
* 設定 `date_time_output_format` を追加。 [#15845](https://github.com/ClickHouse/ClickHouse/pull/15845) ([Maksim Kita](https://github.com/kitaisreal)).
* ClickHouse に簡易的な Web UI を追加しました。 [#16158](https://github.com/ClickHouse/ClickHouse/pull/16158) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 長さ区切りなしで、単一の protobuf メッセージを一度に読み書きできるようになりました。 [#15199](https://github.com/ClickHouse/ClickHouse/pull/15199) ([filimonov](https://github.com/filimonov)).
* OpenTelemetry の初期サポートを追加しました。ClickHouse は現在、Native および HTTP プロトコル経由で OpenTelemetry の `traceparent` ヘッダーを受け付け、場合によってはそれらを下流に伝播します。実行されたクエリのトレース span は `system.opentelemetry_span_log` テーブルに保存されます。 [#14195](https://github.com/ClickHouse/ClickHouse/pull/14195) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* `CREATE TABLE` クエリのカラムリスト内で主キー（`PRIMARY KEY`）を指定できるようにしました。これは他の SQL 方言との互換性のために必要です。 [#15823](https://github.com/ClickHouse/ClickHouse/pull/15823) ([Maksim Kita](https://github.com/kitaisreal)).
* `ORDER BY` を伴う `SELECT` クエリで `OFFSET offset_row_count {ROW | ROWS} FETCH {FIRST | NEXT} fetch_row_count {ROW | ROWS} {ONLY | WITH TIES}` を実装しました。これは `LIMIT` を指定するための SQL 標準の方法です。[#15855](https://github.com/ClickHouse/ClickHouse/pull/15855) ([hexiaoting](https://github.com/hexiaoting)).
* `errorCodeToName` 関数 - エラーの変数名を返します（`query_log` などを分析する際に有用です）。`system.errors` テーブル - エラーが何回発生したかを表示します（`system_events_show_zero_values` を考慮します）。[#16438](https://github.com/ClickHouse/ClickHouse/pull/16438)（[Azat Khuzhin](https://github.com/azat)）。
* 名前付きタプルを展開することで SELECT リストに新しいカラムを導入できる特別な関数 `untuple` を追加。 [#16242](https://github.com/ClickHouse/ClickHouse/pull/16242) ([Nikolai Kochetov](https://github.com/KochetovNicolai), [Amos Bird](https://github.com/amosbird)).
* これで、クエリパラメータを介して識別子を指定できるようになりました。また、これらのパラメータをテーブルオブジェクトやカラムとして使用できます。 [#16594](https://github.com/ClickHouse/ClickHouse/pull/16594) ([Amos Bird](https://github.com/amosbird)).
* MergeTree BloomFilter インデックスに、ビッグ整数（`UInt256`、`Int128`、`Int256`）および `UUID` データ型のサポートを追加しました。ビッグ整数は実験的機能です。 [#16642](https://github.com/ClickHouse/ClickHouse/pull/16642) ([Maksim Kita](https://github.com/kitaisreal)).
* `farmFingerprint64` 関数（非暗号学的な文字列ハッシュ）を追加。 [#16570](https://github.com/ClickHouse/ClickHouse/pull/16570) ([Jacob Hayes](https://github.com/JacobHayes)).
* `log_queries_min_query_duration_ms` を追加。この設定値より実行時間が長いクエリのみが `query_log` / `query_thread_log` に記録される（つまり、mysql の `slow_query_log` のようなもの）。[#16529](https://github.com/ClickHouse/ClickHouse/pull/16529)（[Azat Khuzhin](https://github.com/azat)）。
* `Alpine` ベースの Docker イメージを作成できる機能。事前にコンパイルされたバイナリと、Ubuntu 20.04 の glibc コンポーネントを使用します。 [#16479](https://github.com/ClickHouse/ClickHouse/pull/16479) ([filimonov](https://github.com/filimonov))。
* `toUUIDOrNull`、`toUUIDOrZero` キャスト関数を追加しました。 [#16337](https://github.com/ClickHouse/ClickHouse/pull/16337) ([Maksim Kita](https://github.com/kitaisreal)).
* `max_concurrent_queries_for_all_users` 設定を追加しました。利用例については [#6636](https://github.com/ClickHouse/ClickHouse/issues/6636) を参照してください。 [#16154](https://github.com/ClickHouse/ClickHouse/pull/16154) ([nvartolomei](https://github.com/nvartolomei))。
* clickhouse-client に新しいオプション `print_query_id` を追加しました。これにより、クライアントが生成した現在のクエリ ID を埋め込んだ任意の文字列を生成できるようになります。また、デフォルトで clickhouse-client がクエリ ID を出力するようにしました。 [#15809](https://github.com/ClickHouse/ClickHouse/pull/15809) ([Amos Bird](https://github.com/amosbird))。
* `tid` 関数と `logTrace` 関数を追加しました。これにより [#9434](https://github.com/ClickHouse/ClickHouse/issues/9434) がクローズされました。[#15803](https://github.com/ClickHouse/ClickHouse/pull/15803)（[flynn](https://github.com/ucasFL)）より。
* 時間差を人間が読みやすい文字列に整形する関数 `formatReadableTimeDelta` を追加 ... [#15497](https://github.com/ClickHouse/ClickHouse/pull/15497) ([Filipe Caixeta](https://github.com/filipecaixeta)).
* マルチディスク構成のボリュームに対して `disable_merges` オプションを追加しました。 [#13956](https://github.com/ClickHouse/ClickHouse/pull/13956) ([Vladimir Chebotarev](https://github.com/excitoon))。

#### 実験的機能 {#experimental-feature-1}

- 新しい関数 `encrypt`、`aes_encrypt_mysql`、`decrypt`、`aes_decrypt_mysql`。これらの関数は動作が遅いため、実験的機能として扱っています。[#11844](https://github.com/ClickHouse/ClickHouse/pull/11844) ([Vasily Nemkov](https://github.com/Enmk))。

#### バグ修正 {#bug-fix-6}


* `system.distribution_queue` 内の data&#95;path に含まれるパスワードをマスクするようにしました。 [#16727](https://github.com/ClickHouse/ClickHouse/pull/16727) ([Azat Khuzhin](https://github.com/azat)).
* `transform_null_in` 設定が有効な場合に、複数カラムおよびタプルに対する `IN` 演算子の動作を修正。[#15310](https://github.com/ClickHouse/ClickHouse/issues/15310) を修正。[#16722](https://github.com/ClickHouse/ClickHouse/pull/16722)（[Anton Popov](https://github.com/CurtizJ)）。
* クエリ対象のテーブルにサンプリングがない場合、設定 `max_parallel_replicas` が正しく動作していませんでした。これにより [#5733](https://github.com/ClickHouse/ClickHouse/issues/5733) が修正されました。[#16675](https://github.com/ClickHouse/ClickHouse/pull/16675)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `max_threads` &gt; 0 で、ORDER BY に式が含まれている場合の `optimize_read_in_order` / `optimize_aggregation_in_order` を修正。 [#16637](https://github.com/ClickHouse/ClickHouse/pull/16637) ([Azat Khuzhin](https://github.com/azat)).
* `DEFAULT` 式の計算において、（発生する可能性は極めて低いものの）名前の衝突が起こりうる問題がありました。これにより [#9359](https://github.com/ClickHouse/ClickHouse/issues/9359) が修正されました。[#16612](https://github.com/ClickHouse/ClickHouse/pull/16612)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `query_thread_log.query_duration_ms` の単位を修正しました。 [#16563](https://github.com/ClickHouse/ClickHouse/pull/16563) ([Azat Khuzhin](https://github.com/azat)).
* MySQL Master -&gt; MySQL Slave -&gt; ClickHouse MaterializeMySQL Engine を使用する構成で発生していたバグを修正しました。`MaterializeMySQL` は実験的機能です。 [#16504](https://github.com/ClickHouse/ClickHouse/pull/16504) ([TCeason](https://github.com/TCeason)).
* `Decimal` 型に対する `round` 関数の特定の引数により、整数のゼロ除算が発生していました。これにより [#13338](https://github.com/ClickHouse/ClickHouse/issues/13338) が修正されています。 [#16451](https://github.com/ClickHouse/ClickHouse/pull/16451) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* Distributed テーブルに対する `DROP TABLE` を修正（`INSERT` とのレースコンディションを解消）。 [#16409](https://github.com/ClickHouse/ClickHouse/pull/16409) ([Azat Khuzhin](https://github.com/azat)).
* レプリケーションキュー内の非常に大きなエントリの処理を修正しました。非常に大きなエントリは、テーブル構造が極端に大きい場合（1 MB 近く）に `ALTER` クエリで発生することがあります。この修正により [#16307](https://github.com/ClickHouse/ClickHouse/issues/16307) が解決されます。 [#16332](https://github.com/ClickHouse/ClickHouse/pull/16332) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* フィルタリング用の `set` が作成されないことで返却データの一部がドロップされてしまう不整合な動作を修正しました。 [#16308](https://github.com/ClickHouse/ClickHouse/pull/16308) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* sharding&#95;key 内の `dictGet` を修正（および、関数コンテキストが永続的に保存される同様の箇所も修正）。 [#16205](https://github.com/ClickHouse/ClickHouse/pull/16205) ([Azat Khuzhin](https://github.com/azat))。
* `clickhouse-local` で `OPTIMIZE` コマンドを実行しようとした際にスローされる例外を修正しました。 [#16076](https://github.com/ClickHouse/ClickHouse/issues/16076) を修正。 [#16192](https://github.com/ClickHouse/ClickHouse/pull/16192)（[filimonov](https://github.com/filimonov)）。
* [#15780](https://github.com/ClickHouse/ClickHouse/issues/15780) のリグレッションを修正します。例えば `indexOf([1, 2, 3], toLowCardinality(1))` は現在は禁止されていますが、本来は禁止されるべきではありません。[#16038](https://github.com/ClickHouse/ClickHouse/pull/16038) ([Mike](https://github.com/myrrc))。
* MySQL データベースに関するバグを修正。データベースエンジンとして使用されている MySQL サーバーがダウンしている場合、本来不要であるにもかかわらず、一部のクエリが無効化されたサーバーからテーブルを取得しようとして Exception をスローしていました。例えば、`SELECT ... FROM system.parts` クエリは MergeTree テーブルのみを対象に動作すべきであり、MySQL データベースには一切アクセスすべきではありません。 [#16032](https://github.com/ClickHouse/ClickHouse/pull/16032) ([Kruglov Pavel](https://github.com/Avogar)).
* `ALTER MODIFY COLUMN ... DEFAULT ...` でカラム型と互換性のないデフォルト値が指定された場合に、例外がスローされるようになりました。[#15854](https://github.com/ClickHouse/ClickHouse/issues/15854) を修正。[#15858](https://github.com/ClickHouse/ClickHouse/pull/15858)（[alesapin](https://github.com/alesapin)）。
* IPv4CIDRToRange/IPv6CIDRToRange 関数が const IP 列の値を受け取れるように修正しました。 [#15856](https://github.com/ClickHouse/ClickHouse/pull/15856) ([vladimir-golovchenko](https://github.com/vladimir-golovchenko)).

#### 改善 {#improvement-2}


* Postgres などとの互換性のために、`INTERVAL '1 hour'` を `INTERVAL 1 HOUR` と同等に扱うようにしました。これにより [#15637](https://github.com/ClickHouse/ClickHouse/issues/15637) が修正されました。 [#15978](https://github.com/ClickHouse/ClickHouse/pull/15978)（[flynn](https://github.com/ucasFL)）。
* CSV、TSV、JSON の各入力フォーマットで、enum の値を数値 ID でパースできるようにしました。 [#15685](https://github.com/ClickHouse/ClickHouse/pull/15685) ([vivarum](https://github.com/vivarum)).
* JBOD アーキテクチャおよび `MergeTree` ストレージ向けの読み取りタスクのスケジューリングを改善。新しい設定 `read_backoff_min_concurrency` は、読み取りスレッド数の下限として機能します。 [#16423](https://github.com/ClickHouse/ClickHouse/pull/16423) ([Amos Bird](https://github.com/amosbird)).
* `Avro` フォーマットで不足していた `LowCardinality` のサポートを追加しました。 [#16521](https://github.com/ClickHouse/ClickHouse/pull/16521) ([Mike](https://github.com/myrrc)).
* nginx サーバーをプロキシとして使用する際の `S3` 向けワークアラウンド。現在の nginx は `http://domain.com?delete` のような、パスが空の URL を受け付けないが、素の aws-sdk-cpp はこの種の URL を生成する。このコミットではパッチ適用済みの aws-sdk-cpp を使用し、このような場合にパスとして「/」を含む URL（`http://domain.com/?delete` のようなもの）を生成するようにしている。 [#16814](https://github.com/ClickHouse/ClickHouse/pull/16814) ([ianton-ru](https://github.com/ianton-ru))。
* 入力データのパースエラーに対する診断を改善しました。`Cannot read all data` エラーで行番号を表示するようにしました。[#16644](https://github.com/ClickHouse/ClickHouse/pull/16644) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `minMap` と `maxMap` の動作をより望ましいものにしました。結果で 0 の値がスキップされなくなります。 [#16087](https://github.com/ClickHouse/ClickHouse/issues/16087) を修正。 [#16631](https://github.com/ClickHouse/ClickHouse/pull/16631)（[Ildus Kurbangaliev](https://github.com/ildus)）。
* 実行時における ZooKeeper 設定の更新方法を改善。[#16630](https://github.com/ClickHouse/ClickHouse/pull/16630)（[sundyli](https://github.com/sundy-li)）。
* `SETTINGS` 句を可能な限り早い段階で適用します。これにより、クエリ内でより多くの設定を変更できるようになります。これによって [#3178](https://github.com/ClickHouse/ClickHouse/issues/3178) がクローズされました。[#16619](https://github.com/ClickHouse/ClickHouse/pull/16619)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `event_time_microseconds` フィールドは、UInt64 ではなく Decimal64 で保存されるようになりました。 [#16617](https://github.com/ClickHouse/ClickHouse/pull/16617) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* `APPLY` カラムトランスフォーマーでパラメーター付き関数を使用できるようになりました。 [#16589](https://github.com/ClickHouse/ClickHouse/pull/16589) ([Amos Bird](https://github.com/amosbird)).
* `Atomic` データベースにおいて、削除済みテーブルのデータを削除するバックグラウンドタスクのスケジューリングを改善しました。テーブルに実際にはデータディレクトリが存在しない場合、`Atomic` データベースはテーブルのデータディレクトリへの壊れたシンボリックリンクを作成しなくなりました。[#16584](https://github.com/ClickHouse/ClickHouse/pull/16584) ([tavplubix](https://github.com/tavplubix))。
* `WITH` セクション (CTE) 内のサブクエリは、その名前を使って同じ `WITH` セクション内の前のサブクエリを参照できるようになりました。 [#16575](https://github.com/ClickHouse/ClickHouse/pull/16575) ([Amos Bird](https://github.com/amosbird)).
* `system.query_thread_log` に current&#95;database を追加しました。[#16558](https://github.com/ClickHouse/ClickHouse/pull/16558)（[Azat Khuzhin](https://github.com/azat)）。
* 現在のインスタンスではすでにコミット済み、または古くなっているパーツを、`detached` ディレクトリにフェッチできるようにしました。これは、別のクラスタからテーブルを移行し、N 対 1 のシャードマッピングを行う場合に便利です。また、既存の `fetchPartition` 実装との整合性も保たれています。 [#16538](https://github.com/ClickHouse/ClickHouse/pull/16538) ([Amos Bird](https://github.com/amosbird))。
* `RabbitMQ` に対して複数の改善を行いました。[#16263](https://github.com/ClickHouse/ClickHouse/issues/16263) のバグを修正し、イベントループのライフタイムを短縮しました。さらに、より効率的なキューのセットアップを追加しました。[#16426](https://github.com/ClickHouse/ClickHouse/pull/16426)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `quantileDeterministic` 関数のデバッグアサーションを修正しました。以前のバージョンでは、バグ自体は存在しなかったものの、ネットワーク経由で最大 2 倍のデータを転送してしまう可能性がありました。この変更は [#15683](https://github.com/ClickHouse/ClickHouse/issues/15683) を修正します。 [#16410](https://github.com/ClickHouse/ClickHouse/pull/16410) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `TablesToDropQueueSize` メトリクスを追加しました。これは、バックグラウンドでのデータ削除を待機している削除済みテーブル数を表します。 [#16364](https://github.com/ClickHouse/ClickHouse/pull/16364) ([tavplubix](https://github.com/tavplubix))。
* クライアント側で接続が切断された場合の診断情報が向上しました。以前のバージョンでは、サーバーに `Attempt to read after EOF` や `Broken pipe` といった例外が記録されていました。新しいバージョンでは、`Client has dropped the connection, cancel the query.` という情報メッセージが記録されます。[#16329](https://github.com/ClickHouse/ClickHouse/pull/16329) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* Set/Join テーブルエンジンに `system.tables` の total&#95;rows/total&#95;bytes のサポートを追加。 [#16306](https://github.com/ClickHouse/ClickHouse/pull/16306) ([Azat Khuzhin](https://github.com/azat)).
* MergeTree テーブルエンジンファミリーに対して、`ORDER BY` なしで `PRIMARY KEY` を指定できるようになりました。[#15591](https://github.com/ClickHouse/ClickHouse/issues/15591) をクローズ。[#16284](https://github.com/ClickHouse/ClickHouse/pull/16284)（[alesapin](https://github.com/alesapin)）。
* システム内に `tmp` フォルダが存在しない場合（chroot 環境、設定ミスなど）、`clickhouse-local` はカレントディレクトリ内に一時的なサブフォルダを作成します。 [#16280](https://github.com/ClickHouse/ClickHouse/pull/16280) ([filimonov](https://github.com/filimonov)).
* 入れ子のデータ型（named tuple など）をサブタイプとしてサポートする機能を追加。 [#15587](https://github.com/ClickHouse/ClickHouse/issues/15587) を修正。 [#16262](https://github.com/ClickHouse/ClickHouse/pull/16262)（[Ivan](https://github.com/abyss7)）。
* `DROP DATABASE` に対する `database_atomic_wait_for_drop_and_detach_synchronously` / `NO DELAY` / `SYNC` のサポートを追加。 [#16127](https://github.com/ClickHouse/ClickHouse/pull/16127) ([Azat Khuzhin](https://github.com/azat))。
* `rand()` や `dictGet()` のような非決定的な関数をシャーディングキーで使用できるようにする設定 `allow_nondeterministic_optimize_skip_unused_shards` を追加しました。 [#16105](https://github.com/ClickHouse/ClickHouse/pull/16105) ([Azat Khuzhin](https://github.com/azat)).
* HTTP 経由のクエリに対する `memory_profiler_step` / `max_untracked_memory` を修正（テストを含む）。この値を XML 設定でグローバルに調整しても効果がない問題を修正しました。というのも、これらの設定は適用されず、デフォルト値 (4MB) のみが[使用されていた](https://github.com/ClickHouse/ClickHouse/blob/17731245336d8c84f75e4c0894c5797ed7732190/src/Common/ThreadStatus.h#L104)ためです。HTTP クエリの最上位の ThreadStatus における `query_id` を修正（`query_id` の読み取り後に QueryScope を初期化することで実現）。[#16101](https://github.com/ClickHouse/ClickHouse/pull/16101)（[Azat Khuzhin](https://github.com/azat)）。
* クラスタ設定の `<internal_replication>` に関係なく、`ALTER ... ON CLUSTER` クエリを実行できるようになりました。 [#16075](https://github.com/ClickHouse/ClickHouse/pull/16075) ([alesapin](https://github.com/alesapin)).
* `clickhouse-client` がサジェスト読み込みの影響で終了時に異常終了する可能性がある、まれな問題を修正しました。これにより [#16035](https://github.com/ClickHouse/ClickHouse/issues/16035) が修正されました。 [#16047](https://github.com/ClickHouse/ClickHouse/pull/16047) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 複合キーを持つ `Redis` ディクショナリで `cache` レイアウトをサポートしました。 [#15985](https://github.com/ClickHouse/ClickHouse/pull/15985) ([Anton Popov](https://github.com/CurtizJ)).
* 誤った設定（`connections_with_failover_max_tries` を 0 に設定した場合）により発生するクエリのハング（無限ループ）を修正しました。 [#15876](https://github.com/ClickHouse/ClickHouse/pull/15876) ([Azat Khuzhin](https://github.com/azat))。
* 一部のログメッセージのレベルを information から debug に変更し、すべてのクエリで information メッセージが出力されないようにしました。これにより [#5293](https://github.com/ClickHouse/ClickHouse/issues/5293) がクローズされます。 [#15816](https://github.com/ClickHouse/ClickHouse/pull/15816) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 誤解を招く可能性のある結果を避けるため、`MemoryTrackingInBackground*` メトリクスを削除します。これにより [#15684](https://github.com/ClickHouse/ClickHouse/issues/15684) が修正されます。[#15813](https://github.com/ClickHouse/ClickHouse/pull/15813)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `zookeeper-dump-tree` ツールに再接続機能を追加しました。 [#15711](https://github.com/ClickHouse/ClickHouse/pull/15711) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `CREATE TABLE table AS table_function(...)` クエリで列リストを明示的に指定できるようにしました。 [#9249](https://github.com/ClickHouse/ClickHouse/issues/9249) を修正。 [#14214](https://github.com/ClickHouse/ClickHouse/issues/14214) を修正。 [#14295](https://github.com/ClickHouse/ClickHouse/pull/14295)（[tavplubix](https://github.com/tavplubix)）。

#### パフォーマンス改善 {#performance-improvement-1}

- SELECT FINALでパーティション間のパーツマージを行わないように変更。[#15938](https://github.com/ClickHouse/ClickHouse/pull/15938) ([Kruglov Pavel](https://github.com/Avogar)).
- `-OrNull`および`-OrDefault`集約関数のパフォーマンスを改善。[#16661](https://github.com/ClickHouse/ClickHouse/pull/16661) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- `quantileMerge`のパフォーマンスを改善。以前のバージョンでは非常に低速でした。これにより[#1463](https://github.com/ClickHouse/ClickHouse/issues/1463)が解決されます。[#16643](https://github.com/ClickHouse/ClickHouse/pull/16643) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- 論理関数のパフォーマンスを若干改善。[#16347](https://github.com/ClickHouse/ClickHouse/pull/16347) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- MergeTreeテーブルエンジンにおけるマージ割り当てのパフォーマンスを改善。ユーザーへの影響はありません。[#16191](https://github.com/ClickHouse/ClickHouse/pull/16191) ([alesapin](https://github.com/alesapin)).
- ハッシュテーブルの事前割り当てにより、hashed/sparse_hashedディクショナリの読み込みを高速化。[#15454](https://github.com/ClickHouse/ClickHouse/pull/15454) ([Azat Khuzhin](https://github.com/azat)).
- 単純なカウント最適化がやや高度になりました。正確なパーティション式を含む述語も最適化できるようになりました。これにより[#11092](https://github.com/ClickHouse/ClickHouse/issues/11092)も修正され、`max_parallel_replicas > 1`の場合に誤ったカウントが返される問題が解決されました。[#15074](https://github.com/ClickHouse/ClickHouse/pull/15074) ([Amos Bird](https://github.com/amosbird)).

#### ビルド/テスト/パッケージング改善 {#buildtestingpackaging-improvement-3}


* ステートレステスト用のフレーク検査を追加しました。これにより、マージ前の段階で潜在的に不安定な機能テストを事前に検出できます。 [#16238](https://github.com/ClickHouse/ClickHouse/pull/16238) ([alesapin](https://github.com/alesapin)).
* `croaring` について、アマルガメーションではなく正規のバージョンを使用するようにしました。 [#16285](https://github.com/ClickHouse/ClickHouse/pull/16285) ([sundyli](https://github.com/sundy-li)).
* `ya.make` ビルドシステム（Arcadia）向けのビルドファイル生成を改善しました。 [#16700](https://github.com/ClickHouse/ClickHouse/pull/16700) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `MaterializeMySQL` データベースエンジン向けの MySQL BinLog ファイル検査ツールを追加しました。`MaterializeMySQL` は実験的な機能です。 [#16223](https://github.com/ClickHouse/ClickHouse/pull/16223) ([Winter Zhang](https://github.com/zhang2014)).
* 非実行ファイルに対して実行ビットをチェックするようにしました。Windows から誤って実行属性付きでコミットしてしまうケースがよくあります。 [#15843](https://github.com/ClickHouse/ClickHouse/pull/15843) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* ヘッダ内の `#pragma once` の有無をチェックするようにしました。 [#15818](https://github.com/ClickHouse/ClickHouse/pull/15818) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* libhdfs3 内の不正なコードスタイル `&vector[idx]` を修正しました。これにより libcxx のデバッグビルドが修正されます。あわせて https://github.com/ClickHouse-Extras/libhdfs3/pull/8 も参照してください。 [#15815](https://github.com/ClickHouse/ClickHouse/pull/15815) ([Amos Bird](https://github.com/amosbird)).
* Mac OS 上での、あるサンプルツールのビルドを修正しました。なお、CI では Mac OS 上でサンプルはビルドしておらず（ClickHouse バイナリのみをビルドしているため）、今後再び壊れない保証はありません。この修正は [#15804](https://github.com/ClickHouse/ClickHouse/issues/15804) を解決します。 [#15808](https://github.com/ClickHouse/ClickHouse/pull/15808) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Sys/V init スクリプトを簡素化しました。 [#14135](https://github.com/ClickHouse/ClickHouse/pull/14135) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `db_generator` に `boost::program_options` を追加し、使い勝手を向上させました。これにより [#15940](https://github.com/ClickHouse/ClickHouse/issues/15940) がクローズされます。 [#15973](https://github.com/ClickHouse/ClickHouse/pull/15973) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).



## ClickHouse リリース 20.10 {#clickhouse-release-2010}

### ClickHouse リリース v20.10.7.4-stable, 2020-12-24 {#clickhouse-release-v201074-stable-2020-12-24}

#### バグ修正 {#bug-fix-7}


* デュアルスタック構成の `IPv4/IPv6` を持つマシン上で、サーバーから `clickhouse-odbc-bridge` プロセスにアクセスできない問題を修正し、また不正なクエリによって ODBC 辞書の更新が行われたりクラッシュを引き起こしたりする問題を修正しました。これにより、おそらく [#14489](https://github.com/ClickHouse/ClickHouse/issues/14489) が解決されています。 [#18278](https://github.com/ClickHouse/ClickHouse/pull/18278) ([Denis Glazachev](https://github.com/traceon))。
* Enum 型と Int 型のキー比較を修正。これにより [#17989](https://github.com/ClickHouse/ClickHouse/issues/17989) が解決されます。 [#18214](https://github.com/ClickHouse/ClickHouse/pull/18214)（[Amos Bird](https://github.com/amosbird)）。
* `MaterializeMySQL` データベースエンジンにおける一意キー変換時のクラッシュを修正しました。この修正により [#18186](https://github.com/ClickHouse/ClickHouse/issues/18186) が解消され、[#16372](https://github.com/ClickHouse/ClickHouse/issues/16372) および [#18211](https://github.com/ClickHouse/ClickHouse/pull/18211) も修正されました（[Winter Zhang](https://github.com/zhang2014)）。
* S3 URL パース時に発生する `std::out_of_range: basic_string` を修正しました。 [#18059](https://github.com/ClickHouse/ClickHouse/pull/18059) ([Vladimir Chebotarev](https://github.com/excitoon)).
* MaterializeMySQL が MySQL のプレフィックスインデックスの変換をサポートしていなかったことが原因で、一部のテーブルが MySQL から ClickHouse へ同期されない問題を修正しました。これにより [#15187](https://github.com/ClickHouse/ClickHouse/issues/15187)、[#17912](https://github.com/ClickHouse/ClickHouse/issues/17912)、[#17944](https://github.com/ClickHouse/ClickHouse/pull/17944) が修正されました（[Winter Zhang](https://github.com/zhang2014)）。
* `topK` 集約関数で発生する可能性のあるセグメンテーションフォルトを修正しました。これにより [#17404](https://github.com/ClickHouse/ClickHouse/issues/17404) がクローズされました。 [#17845](https://github.com/ClickHouse/ClickHouse/pull/17845) ([Maksim Kita](https://github.com/kitaisreal))。
* `in_memory_parts_enable_wal` が無効になっている場合は、`WAL` からパーツを復元しないようにしました。 [#17802](https://github.com/ClickHouse/ClickHouse/pull/17802) ([detailyang](https://github.com/detailyang)).
* ClickHouse が MySQL サーバーへの接続を再確立できない問題を修正しました。 [#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz)).
* サーバーがデーモンモードで動作しているときに `system.stack_trace` テーブルが空になっていた問題を修正しました。 [#17630](https://github.com/ClickHouse/ClickHouse/pull/17630) ([Amos Bird](https://github.com/amosbird)).
* インタラクティブモードで複数行クエリを使用した場合に、単一行コメントが誤ってクエリの末尾まで拡張されてしまう `clickhouse-client` の挙動を修正しました。この修正により [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654) が解決されます。 [#17565](https://github.com/ClickHouse/ClickHouse/pull/17565) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* ごくまれなケースでサーバーが接続を受け付けなくなる問題を修正しました。 [#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 対応する mutation が別のレプリカ上で kill された場合に `ALTER` クエリがハングする問題を修正しました。これにより [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953) が解決しました。 [#17499](https://github.com/ClickHouse/ClickHouse/pull/17499) ([alesapin](https://github.com/alesapin))。
* ClickHouse による mark キャッシュサイズの過小見積もりが発生するバグを修正しました。これは、多数の小さな mark を含むファイルが存在する場合に発生する可能性がありました。 [#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin))。
* 設定 `optimize_redundant_functions_in_order_by` が有効な場合の `ORDER BY` の動作を修正しました。 [#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* 誤った最適化が原因で `DISTINCT` の後に発生する可能性があった重複行を修正しました。[#17294](https://github.com/ClickHouse/ClickHouse/issues/17294) を解決。[#17296](https://github.com/ClickHouse/ClickHouse/pull/17296)（[li chengxiang](https://github.com/chengxianglibra)）。[#17439](https://github.com/ClickHouse/ClickHouse/pull/17439)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `LowCardinality` 型を持つ `JOIN` テーブルからの読み取り時にクラッシュする不具合を修正しました。これにより [#17228](https://github.com/ClickHouse/ClickHouse/issues/17228) が修正されました。[#17397](https://github.com/ClickHouse/ClickHouse/pull/17397) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* サブクエリ内に `const` カラムが存在する場合の fixed set インデックスの無効化処理を修正しました。これにより [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246) が解決されています。[#17249](https://github.com/ClickHouse/ClickHouse/pull/17249)（[Amos Bird](https://github.com/amosbird)）。
* `ColumnConst` の比較によってクラッシュが発生する問題を修正しました。これにより [#17088](https://github.com/ClickHouse/ClickHouse/issues/17088) が解決されました。 [#17135](https://github.com/ClickHouse/ClickHouse/pull/17135) ([Amos Bird](https://github.com/amosbird)).
* 非リーダーの `ReplicatedMergeTree` テーブルに対する `ON CLUSTER` クエリが永遠にハングする可能性があったバグを修正しました。 [#17089](https://github.com/ClickHouse/ClickHouse/pull/17089) ([alesapin](https://github.com/alesapin)).
* 関数 `fuzzBits` に対して fuzzer によって発見されたバグを修正しました。これにより [#16980](https://github.com/ClickHouse/ClickHouse/issues/16980) が解決されます。[#17051](https://github.com/ClickHouse/ClickHouse/pull/17051)（[hexiaoting](https://github.com/hexiaoting)）。
* `LIMIT` を含むクエリのように、実行中にキャンセルされる可能性のあるリモートクエリで発生する不要なネットワークエラーを回避します。 [#17006](https://github.com/ClickHouse/ClickHouse/pull/17006) ([Azat Khuzhin](https://github.com/azat)).
* `double` からのキャスト時に、大きな整数（128 ビット、256 ビット）で誤った結果になる問題を修正しました。 [#16986](https://github.com/ClickHouse/ClickHouse/pull/16986) ([Mike](https://github.com/myrrc)).
* エラー発生時に `format_avro_schema_registry_url` の IP を再解決するようにしました。 [#16985](https://github.com/ClickHouse/ClickHouse/pull/16985) ([filimonov](https://github.com/filimonov))。
* `SELECT` が変更中のカラムに対して `WHERE` 句を持ち、`ALTER` がまだ完了していない状態で `ALTER TABLE ... MODIFY COLUMN ... NewType` を実行した場合に発生する可能性があったサーバークラッシュを修正しました。 [#16968](https://github.com/ClickHouse/ClickHouse/pull/16968) ([Amos Bird](https://github.com/amosbird)).
* `clickhouse-git-import` において blame 情報が正しく算出されていませんでした。 [#16959](https://github.com/ClickHouse/ClickHouse/pull/16959) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 単調関数を用いた `ORDER BY` の最適化を修正しました。これにより [#16107](https://github.com/ClickHouse/ClickHouse/issues/16107) が解決されました。 [#16956](https://github.com/ClickHouse/ClickHouse/pull/16956)（[Anton Popov](https://github.com/CurtizJ)）。
* `optimize_aggregators_of_group_by_keys` 設定が有効な状態での `group by` と `join` に関する最適化を修正しました。これにより [#12604](https://github.com/ClickHouse/ClickHouse/issues/12604) が修正されました。 [#16951](https://github.com/ClickHouse/ClickHouse/pull/16951) ([Anton Popov](https://github.com/CurtizJ))。
* インストールスクリプトは、設定フォルダ内にサブディレクトリを必ず作成するようにしました。これはカスタム設定を使用した Docker ビルドにのみ該当します。 [#16936](https://github.com/ClickHouse/ClickHouse/pull/16936) ([filimonov](https://github.com/filimonov)).
* `ORDER BY` を含むクエリで発生する可能性のあった `Illegal type of argument` エラーを修正しました。これにより [#16580](https://github.com/ClickHouse/ClickHouse/issues/16580) が解決されます。 [#16928](https://github.com/ClickHouse/ClickHouse/pull/16928)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `WriteBufferFromS3` にデータが書き込まれていない場合は、マルチパートアップロードを中止する。[#16840](https://github.com/ClickHouse/ClickHouse/pull/16840) ([Pavel Kovalenko](https://github.com/Jokser)).
* 引数を一切指定せずに `any` を使用した場合にクラッシュする問題を修正しました。これにより [#16803](https://github.com/ClickHouse/ClickHouse/issues/16803) が解決されました。 [#16826](https://github.com/ClickHouse/ClickHouse/pull/16826)（[Amos Bird](https://github.com/amosbird)）。
* MySQL プロトコル経由の `INSERT` クエリで、影響を受けた行数ではなく常に 0 を返してしまっていた ClickHouse の動作を修正しました。これにより [#16605](https://github.com/ClickHouse/ClickHouse/issues/16605) が解決されます。 [#16715](https://github.com/ClickHouse/ClickHouse/pull/16715) ([Winter Zhang](https://github.com/zhang2014)).
* `TDigest` の制御不能な増加を修正しました。 [#16680](https://github.com/ClickHouse/ClickHouse/pull/16680) ([hrissan](https://github.com/hrissan)).
* Aggregate 関数で接尾辞 `if` を使用した際に発生していたリモートクエリの失敗を修正しました。これにより [#16574](https://github.com/ClickHouse/ClickHouse/issues/16574) [#16231](https://github.com/ClickHouse/ClickHouse/issues/16231) [#16610](https://github.com/ClickHouse/ClickHouse/pull/16610) が修正されました ([Winter Zhang](https://github.com/zhang2014))。

### ClickHouse release v20.10.4.1-stable, 2020-11-13 {#clickhouse-release-v201041-stable-2020-11-13}

#### バグ修正 {#bug-fix-8}

- クエリプロファイラが有効で、一部の関数の非同期アンワインドテーブルが破損している(と思われる)glibcバージョンを持つOSにClickHouseがインストールされている場合に発生する稀なサイレントクラッシュを修正しました。これにより [#15301](https://github.com/ClickHouse/ClickHouse/issues/15301) を修正。これにより [#13098](https://github.com/ClickHouse/ClickHouse/issues/13098) を修正。[#16846](https://github.com/ClickHouse/ClickHouse/pull/16846) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `transform_null_in`設定が有効な場合の複数カラムとタプルに対する`IN`演算子を修正しました。[#15310](https://github.com/ClickHouse/ClickHouse/issues/15310) を修正。[#16722](https://github.com/ClickHouse/ClickHouse/pull/16722) ([Anton Popov](https://github.com/CurtizJ))。
- max_threads>0およびORDER BY内の式を使用したoptimize_read_in_order/optimize_aggregation_in_orderを修正しました。[#16637](https://github.com/ClickHouse/ClickHouse/pull/16637) ([Azat Khuzhin](https://github.com/azat))。
- 入力からAVROを解析する際に、型からLowCardinalityが削除されるようになりました。[#16188](https://github.com/ClickHouse/ClickHouse/issues/16188) を修正。[#16521](https://github.com/ClickHouse/ClickHouse/pull/16521) ([Mike](https://github.com/myrrc))。
- MySQL Master -> MySQL Slave -> ClickHouse MaterializeMySQL Engineを使用し、MySQL Slaveで`slave_parallel_worker`が有効な場合のメタデータの急速な増加を、GTIDセットを適切に縮小することで修正しました。これにより [#15951](https://github.com/ClickHouse/ClickHouse/issues/15951) を修正。[#16504](https://github.com/ClickHouse/ClickHouse/pull/16504) ([TCeason](https://github.com/TCeason))。
- Distributedテーブルに対するDROP TABLE(INSERTとの競合)を修正しました。[#16409](https://github.com/ClickHouse/ClickHouse/pull/16409) ([Azat Khuzhin](https://github.com/azat))。
- レプリケーションキュー内の非常に大きなエントリの処理を修正しました。テーブル構造が極端に大きい場合(1MB近く)、ALTERクエリで非常に大きなエントリが発生する可能性があります。これにより [#16307](https://github.com/ClickHouse/ClickHouse/issues/16307) を修正。[#16332](https://github.com/ClickHouse/ClickHouse/pull/16332) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- MySQLデータベースのバグを修正しました。データベースエンジンとして使用されているMySQLサーバーがダウンしている場合、一部のクエリが不要にもかかわらず無効なサーバーからテーブルを取得しようとするため、例外が発生していました。例えば、`SELECT ... FROM system.parts`クエリはMergeTreeテーブルのみで動作し、MySQLデータベースには一切アクセスすべきではありません。[#16032](https://github.com/ClickHouse/ClickHouse/pull/16032) ([Kruglov Pavel](https://github.com/Avogar))。

#### 改善 {#improvement-3}

- nginxサーバーをプロキシとして使用する場合のS3の回避策。現在、nginxはhttp://domain.com?deleteのような空のパスを持つURLを受け付けませんが、標準のaws-sdk-cppはこの種のURLを生成します。このコミットでは、パッチを適用したaws-sdk-cppバージョンを使用し、このような場合にhttp://domain.com/?deleteのように"/"をパスとして含むURLを生成します。[#16813](https://github.com/ClickHouse/ClickHouse/pull/16813) ([ianton-ru](https://github.com/ianton-ru))。

### ClickHouse release v20.10.3.30, 2020-10-28 {#clickhouse-release-v2010330-2020-10-28}

#### 後方互換性のない変更 {#backward-incompatible-change-2}


- `multiple_joins_rewriter_version`を廃止。結合リライタの初期バージョンを削除しました。[#15472](https://github.com/ClickHouse/ClickHouse/pull/15472) ([Artem Zuikov](https://github.com/4ertus2))。
- `format_regexp_escaping_rule`設定(`Regexp`フォーマットに関連)のデフォルト値を`Raw`(サブパターン全体を値として読み取ることを意味する)に変更し、ユーザーの期待により近い動作にしました。[#15426](https://github.com/ClickHouse/ClickHouse/pull/15426) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- SQLでネストされた複数行コメント`/* comment /* comment */ */`のサポートを追加しました。これはSQL標準に準拠しています。[#14655](https://github.com/ClickHouse/ClickHouse/pull/14655) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- バックグラウンドプールおよびレプリケーションキュー内のTTLを伴うマージ数を制御するためのMergeTree設定(`max_replicated_merges_with_ttl_in_queue`および`max_number_of_merges_with_ttl_in_pool`)を追加しました。この変更は、削除TTLを使用している場合のみ旧バージョンとの互換性を破壊します。それ以外の場合、レプリケーションは互換性を維持します。すべてのシャードレプリカを一度に更新するか、すべてのレプリカの更新が完了するまで`SYSTEM STOP TTL MERGES`を実行することで、非互換性の問題を回避できます。レプリケーションキューに非互換エントリが発生した場合は、まず`SYSTEM STOP TTL MERGES`を実行し、その後、非互換TTLマージが割り当てられたパーティションに対して`ALTER TABLE ... DETACH PARTITION ...`を実行してください。単一のレプリカで再アタッチしてください。[#14490](https://github.com/ClickHouse/ClickHouse/pull/14490) ([alesapin](https://github.com/alesapin))。
- 20.5より古いバージョンからアップグレードする際、ローリングアップデートを実行し、クラスタに20.5以上と20.5未満の両方のバージョンが含まれている場合、旧バージョンのClickHouseノードが再起動され、新しいバージョンの存在下で旧バージョンが起動すると、`Part ... intersects previous part`エラーが発生する可能性があります。このエラーを防ぐには、まずすべてのクラスタノードに新しいclickhouse-serverパッケージをインストールしてから再起動を実行してください(これにより、clickhouse-serverが再起動されると新しいバージョンで起動します)。

#### 新機能 {#new-feature-2}


* バックグラウンドでのデータ再圧縮。MergeTree テーブルエンジンファミリーに対して `TTL ... RECOMPRESS codec_name` を指定できる機能を追加。[#14494](https://github.com/ClickHouse/ClickHouse/pull/14494)（[alesapin](https://github.com/alesapin)）。
* 並列クォーラム挿入を追加。これにより [#15601](https://github.com/ClickHouse/ClickHouse/issues/15601) がクローズされます。 [#15601](https://github.com/ClickHouse/ClickHouse/pull/15601)（[Latysheva Alexandra](https://github.com/alexelex)）。
* データ永続性を追加的に強制するための設定。レプリケーションなしの構成で有用。 [#11948](https://github.com/ClickHouse/ClickHouse/pull/11948) ([Anton Popov](https://github.com/CurtizJ)).
* 重複したブロックが、ローカルには存在しない（他のレプリカからまだ取得されていない）レプリカに書き込まれた場合でも、それを無視せずにローカルへも書き込み、正常にレプリケーションされた場合と同じ効果を得られるようにしました。 [#11684](https://github.com/ClickHouse/ClickHouse/pull/11684) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* クエリコンテキスト内で名前付きサブクエリを導入するための `WITH <identifier> AS (subquery) ... ` をサポートしました。これにより [#2416](https://github.com/ClickHouse/ClickHouse/issues/2416) がクローズされました。また、[#4967](https://github.com/ClickHouse/ClickHouse/issues/4967) もクローズされました。[#14771](https://github.com/ClickHouse/ClickHouse/pull/14771)（[Amos Bird](https://github.com/amosbird)）。
* `enable_global_with_statement` 設定を導入しました。これは、同じレベルにある他の `SELECT` クエリへ最初の `SELECT` の `WITH` 句を伝播させ、さらに `WITH` 句内のエイリアスをサブクエリから参照可能にします。 [#15451](https://github.com/ClickHouse/ClickHouse/pull/15451) ([Amos Bird](https://github.com/amosbird))。
* `initial_user` を現在のクエリユーザーとして使用して、クラスタ間のクエリ実行を安全にしました。 [#13156](https://github.com/ClickHouse/ClickHouse/pull/13156) ([Azat Khuzhin](https://github.com/azat)). [#15551](https://github.com/ClickHouse/ClickHouse/pull/15551) ([Azat Khuzhin](https://github.com/azat)).
* カラムプロパティおよびテーブル TTL を削除できる機能を追加しました。`ALTER TABLE MODIFY COLUMN col_name REMOVE what_to_remove` と `ALTER TABLE REMOVE TTL` の 2 つのクエリを導入しました。いずれの操作も軽量で、メタデータ レベルで実行されます。[#14742](https://github.com/ClickHouse/ClickHouse/pull/14742) ([alesapin](https://github.com/alesapin))。
* フォーマット `RawBLOB` を追加しました。エスケープや区切り文字を一切行わずに、単一の値を入出力するためのフォーマットです。これにより [#15349](https://github.com/ClickHouse/ClickHouse/issues/15349) が解決されました。 [#15364](https://github.com/ClickHouse/ClickHouse/pull/15364) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* ビッグエンディアンのバイト文字列を UUID に変換できる `reinterpretAsUUID` 関数を追加。 [#15480](https://github.com/ClickHouse/ClickHouse/pull/15480) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* `force_data_skipping_indices` 設定を実装しました。[#15642](https://github.com/ClickHouse/ClickHouse/pull/15642)（[Azat Khuzhin](https://github.com/azat)）。
* Pretty フォーマットで結果に行番号を付与するための設定 `output_format_pretty_row_numbers` を追加。これにより [#15350](https://github.com/ClickHouse/ClickHouse/issues/15350) がクローズされた。 [#15443](https://github.com/ClickHouse/ClickHouse/pull/15443) ([flynn](https://github.com/ucasFL))。
* クエリ難読化ツールを追加しました。これにより、より多くのクエリを共有して、テストをより良く行えるようになります。これにて [#15268](https://github.com/ClickHouse/ClickHouse/issues/15268) はクローズされます。 [#15321](https://github.com/ClickHouse/ClickHouse/pull/15321) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* テーブル関数 `null('structure')` を追加しました。 [#14797](https://github.com/ClickHouse/ClickHouse/pull/14797) ([vxider](https://github.com/Vxider)).
* `formatReadableQuantity` 関数を追加しました。人間が大きな数値を読みやすくするのに役立ちます。 [#14725](https://github.com/ClickHouse/ClickHouse/pull/14725) ([Artem Hnilov](https://github.com/BooBSD))。
* 改行で区切られた複数行を受け取り、各行全体を 1 つの String フィールドとしてパースするフォーマット `LineAsString` を追加しました。 [#14703](https://github.com/ClickHouse/ClickHouse/pull/14703) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)), [#13846](https://github.com/ClickHouse/ClickHouse/pull/13846) ([hexiaoting](https://github.com/hexiaoting)).
* データを文字列の配列として出力する `JSONStrings` フォーマットを追加。 [#14333](https://github.com/ClickHouse/ClickHouse/pull/14333) ([hcz](https://github.com/hczhcz)).
* `Regexp` フォーマットに「Raw」列フォーマットのサポートを追加しました。これにより、エスケープ規則を一切適用せずにサブパターン全体をそのまま抽出できるようになります。 [#15363](https://github.com/ClickHouse/ClickHouse/pull/15363) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `TSV` 出力フォーマットにおける `NULL` の表現を設定可能にしました。これは設定 `output_format_tsv_null_representation` によって制御され、デフォルトは `\N` です。これにより [#9375](https://github.com/ClickHouse/ClickHouse/issues/9375) がクローズされました。なお、この設定は出力フォーマットにのみ影響し、`TSV` 入力フォーマットでサポートされる `NULL` の表現は `\N` のみです。[#14586](https://github.com/ClickHouse/ClickHouse/pull/14586)（[Kruglov Pavel](https://github.com/Avogar)）。
* `MaterializeMySQL` で Decimal データ型をサポートしました。`MaterializeMySQL` は実験的機能です。 [#14535](https://github.com/ClickHouse/ClickHouse/pull/14535) ([Winter Zhang](https://github.com/zhang2014)).
* 新機能を追加: `SHOW DATABASES LIKE 'xxx'`。 [#14521](https://github.com/ClickHouse/ClickHouse/pull/14521) ([hexiaoting](https://github.com/hexiaoting))。
* 任意の git リポジトリをサンプルデータセットとして ClickHouse にインポートするためのスクリプトを追加。 [#14471](https://github.com/ClickHouse/ClickHouse/pull/14471) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `INSERT` ステートメントのカラムリストで、アスタリスク（およびそのバリエーション）をカラムトランスフォーマーと組み合わせて使用できるようになりました。 [#14453](https://github.com/ClickHouse/ClickHouse/pull/14453) ([Amos Bird](https://github.com/amosbird)).
* 分散クエリ向けに、新しいクエリ複雑度制限設定 `max_rows_to_read_leaf` および `max_bytes_to_read_leaf` が追加され、リーフノードで読み取る行数／バイト数の上限を制限できるようになりました。この制限はローカルリードに対してのみ適用され、ルートノードでの最終マージ段階は*対象外*です。 [#14221](https://github.com/ClickHouse/ClickHouse/pull/14221) ([Roman Khavronenko](https://github.com/hagen1778)).
* 設定ファイルの `<replicated_merge_tree>` セクションで、ユーザーが `ReplicatedMergeTree*` ストレージ用の設定を指定できるようになりました。これは `<merge_tree>` セクションと同様に動作します。`ReplicatedMergeTree*` ストレージに対しては、`<merge_tree>` と `<replicated_merge_tree>` の両方の設定が同時に適用されますが、`<replicated_merge_tree>` の設定の方が優先されます。`system.replicated_merge_tree_settings` テーブルを追加しました。 [#13573](https://github.com/ClickHouse/ClickHouse/pull/13573) ([Amos Bird](https://github.com/amosbird)).
* `mapPopulateSeries` 関数を追加しました。 [#13166](https://github.com/ClickHouse/ClickHouse/pull/13166) ([Ildus Kurbangaliev](https://github.com/ildus))。
* MySQL の型 `decimal`（ClickHouse の `Decimal` として）およびサブ秒精度を持つ `datetime`（`DateTime64` として）をサポート。 [#11512](https://github.com/ClickHouse/ClickHouse/pull/11512)（[Vasily Nemkov](https://github.com/Enmk)）。
* `system.text_log`、`system.trace_log`、`system.query_log` および `system.query_thread_log` テーブルに `event_time_microseconds` フィールドを追加しました。 [#14760](https://github.com/ClickHouse/ClickHouse/pull/14760) ([Bharat Nallan](https://github.com/bharatnc)).
* `event_time_microseconds` を `system.asynchronous_metric_log` および `system.metric_log` テーブルに追加しました。[#14514](https://github.com/ClickHouse/ClickHouse/pull/14514)（[Bharat Nallan](https://github.com/bharatnc)）。
* `query_start_time_microseconds` フィールドを `system.query_log` および `system.query_thread_log` テーブルに追加しました。 [#14252](https://github.com/ClickHouse/ClickHouse/pull/14252) ([Bharat Nallan](https://github.com/bharatnc))。

#### バグ修正 {#bug-fix-9}


* 制限に関係なくメモリが過剰に割り当てられてしまうケースを修正しました。これにより [#14560](https://github.com/ClickHouse/ClickHouse/issues/14560) がクローズされます。[#16206](https://github.com/ClickHouse/ClickHouse/pull/16206)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `executable` 辞書ソースがハングする問題を修正しました。以前のバージョンでは、いくつかのフォーマット（例: `JSONEachRow`）を使用している場合、子プロセスが何かしら出力を行うまで、その子プロセスにデータが渡されませんでした。この修正により [#1697](https://github.com/ClickHouse/ClickHouse/issues/1697) がクローズされます。また、[#2455](https://github.com/ClickHouse/ClickHouse/issues/2455) もクローズされます。 [#14525](https://github.com/ClickHouse/ClickHouse/pull/14525)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 関数 `dictGet` 内で例外が発生した場合の二重解放を修正しました。これは、ディクショナリをエラー付きでロードした場合に発生する可能性がありました。 [#16429](https://github.com/ClickHouse/ClickHouse/pull/16429) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `GROUP BY` で `WITH TOTALS` / `ROLLUP` / `CUBE` 修飾子を使用し、グループ化キーに対して `min` / `max` 関数を適用した場合の挙動を修正しました。 [#16393](https://github.com/ClickHouse/ClickHouse/issues/16393) を修正。 [#16397](https://github.com/ClickHouse/ClickHouse/pull/16397) ([Anton Popov](https://github.com/CurtizJ)).
* `prefer&#95;localhost&#95;replica=0` と `internal&#95;replication` 使用時の非同期 Distributed への `INSERT` を修正。[#16358](https://github.com/ClickHouse/ClickHouse/pull/16358)（[Azat Khuzhin](https://github.com/azat)）。
* TwoLevelStringHashTable の実装において、メモリリークを引き起こす可能性のある重大なコードの誤りを修正。 [#16264](https://github.com/ClickHouse/ClickHouse/pull/16264) ([Amos Bird](https://github.com/amosbird))。
* ラムダでの誤った集約により一部のケースで発生していたセグメンテーションフォルトを修正しました。 [#16082](https://github.com/ClickHouse/ClickHouse/pull/16082) ([Anton Popov](https://github.com/CurtizJ)).
* `ReplicatedVersionedCollapsingMergeTree` に対する `ALTER MODIFY ... ORDER BY` クエリがハングする問題を修正しました。これにより [#15980](https://github.com/ClickHouse/ClickHouse/issues/15980) が解決されます。[#16011](https://github.com/ClickHouse/ClickHouse/pull/16011)（[alesapin](https://github.com/alesapin)）。
* `MaterializeMySQL`（実験的機能）：照合名および文字セット名のパーサーを修正し、文字列型での `length = 0` をサポートしました。 [#16008](https://github.com/ClickHouse/ClickHouse/pull/16008) ([Winter Zhang](https://github.com/zhang2014)).
* 複合キーを持つディクショナリで `direct` レイアウトを使用できるようになりました。 [#16007](https://github.com/ClickHouse/ClickHouse/pull/16007) ([Anton Popov](https://github.com/CurtizJ)).
* 一定期間の非活動後にレプリケーションエラーが発生した場合に、レプリカが 5〜10 分間ハングしないように防止。 [#15987](https://github.com/ClickHouse/ClickHouse/pull/15987) ([filimonov](https://github.com/filimonov)).
* Atomic データベースエンジンで、`MaterializedView` への挿入または `MaterializedView` からの選択と、対象テーブルの削除が同時に行われた場合にまれに発生するセグメンテーションフォルトを修正しました。 [#15984](https://github.com/ClickHouse/ClickHouse/pull/15984) ([tavplubix](https://github.com/tavplubix)).
* 設定プロファイルのパースにおけるあいまいさを修正しました。`CREATE USER ... SETTINGS profile readonly` は、readonly 制約を持つ設定 `profile` を使用しているのではなく、`readonly` という名前のプロファイルを使用していると解釈されるようになりました。この変更により [#15628](https://github.com/ClickHouse/ClickHouse/issues/15628) が修正されました。 [#15982](https://github.com/ClickHouse/ClickHouse/pull/15982) ([Vitaly Baranov](https://github.com/vitlibar))。
* `MaterializeMySQL`（実験的機能）：データベース作成に失敗した際にクラッシュする問題を修正。 [#15954](https://github.com/ClickHouse/ClickHouse/pull/15954) ([Winter Zhang](https://github.com/zhang2014)).
* `Atomic` データベースエンジンにおいて、テーブルが同時にリネームされている場合に `Table ... does not exist` エラーで失敗する `DROP TABLE IF EXISTS` の問題を修正しました。複数テーブルに対して `DROP DATABASE` や `RENAME TABLE` などの DDL クエリを同時実行した際に、まれに発生するデッドロックを修正しました。`DROP/DETACH TABLE` を同時実行した際に `Table ... does not exist` エラーで失敗する `DROP/DETACH DATABASE` の問題を修正しました。 [#15934](https://github.com/ClickHouse/ClickHouse/pull/15934) ([tavplubix](https://github.com/tavplubix)).
* `WHERE`、`PREWHERE`、`GLOBAL IN` を含むクエリを `Distributed` テーブルに対して実行したときに、結果が誤って空になってしまう問題を修正。 [#15792](https://github.com/ClickHouse/ClickHouse/issues/15792) を修正。 [#15933](https://github.com/ClickHouse/ClickHouse/pull/15933)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* [#12513](https://github.com/ClickHouse/ClickHouse/issues/12513) を修正: クエリが再解析された際に、同じエイリアスを持つ差分表現が存在する問題を修正。 [#15886](https://github.com/ClickHouse/ClickHouse/pull/15886) ([Winter Zhang](https://github.com/zhang2014)).
* RBAC 実装で、ごくまれに発生しうるデッドロックを修正しました。 [#15875](https://github.com/ClickHouse/ClickHouse/pull/15875) ([Vitaly Baranov](https://github.com/vitlibar)).
* `ALTER MODIFY COLUMN` クエリの後に実行された `SELECT ... ORDER BY DESC` クエリで発生していた `Block structure mismatch` 例外を修正しました。[#15800](https://github.com/ClickHouse/ClickHouse/issues/15800) を修正。 [#15852](https://github.com/ClickHouse/ClickHouse/pull/15852)（[alesapin](https://github.com/alesapin)）。
* `MaterializeMySQL`（実験的機能）：`select count()` の不正確な結果を修正。[#15767](https://github.com/ClickHouse/ClickHouse/pull/15767)（[tavplubix](https://github.com/tavplubix)）。
* 仮想カラムのみを選択しているクエリのいくつかのケースを修正しました。以前は `Not found column _nothing in block` という例外が投げられることがありました。[#12298](https://github.com/ClickHouse/ClickHouse/issues/12298) を修正します。[#15756](https://github.com/ClickHouse/ClickHouse/pull/15756)（[Anton Popov](https://github.com/CurtizJ)）。
* Atomic データベースで内部テーブルを持つマテリアライズドビューを DROP するとハングしてしまう問題を修正（MV の内部テーブルに対する再帰的な `DROP TABLE` によりワーカースレッドがハングし、その結果、後続のすべての `DROP TABLE` がハングしてしまう問題）。 [#15743](https://github.com/ClickHouse/ClickHouse/pull/15743) ([Azat Khuzhin](https://github.com/azat)).
* 最初の試行が失敗した場合に、パーツを別のディスク／ボリュームへ移動できるようにしました。 [#15723](https://github.com/ClickHouse/ClickHouse/pull/15723) ([Pavel Kovalenko](https://github.com/Jokser)).
* `ARRAY JOIN` を含む `MV` 用のクエリに対して、`MATERIALIZED VIEW` への挿入時に発生する可能性がある `Cannot find column` エラーを修正。[#15717](https://github.com/ClickHouse/ClickHouse/pull/15717) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `max_replicated_logs_to_keep` 設定のデフォルト値が低すぎた問題を修正しました。この問題により、レプリカが頻繁にロストする可能性がありました。最も最新のレプリカをクローン元として選択することで、ロストしたレプリカの復旧プロセスを改善しました。また、ロストしたレプリカから古いパーツを削除せず、代わりにデタッチするようにしました。 [#15701](https://github.com/ClickHouse/ClickHouse/pull/15701) ([tavplubix](https://github.com/tavplubix)).
* MySQL 由来の辞書およびテーブルでまれに発生するレースコンディションを修正。 [#15686](https://github.com/ClickHouse/ClickHouse/pull/15686) ([alesapin](https://github.com/alesapin)).
* AMQP-CPP の（無害な）競合状態を修正。 [#15667](https://github.com/ClickHouse/ClickHouse/pull/15667) ([alesapin](https://github.com/alesapin)).
* `Buffer` テーブルから、宛先テーブルとは異なる構造を持つデータを読み込む際に発生していたエラー `Cannot add simple transform to empty Pipe` を修正しました。これは、クエリに対して宛先テーブルが空の結果を返した場合に発生する可能性がありました。[#15529](https://github.com/ClickHouse/ClickHouse/issues/15529) を修正。[#15662](https://github.com/ClickHouse/ClickHouse/pull/15662)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* S3 を使用した MergeTree への挿入時のエラー処理を適切に改善。S3 上の MergeTree は実験的機能です。 [#15657](https://github.com/ClickHouse/ClickHouse/pull/15657) ([Pavel Kovalenko](https://github.com/Jokser))。
* S3 テーブル関数のバグを修正: URL から取得した `region` が S3 クライアント設定に適用されていませんでした。 [#15646](https://github.com/ClickHouse/ClickHouse/pull/15646) ([Vladimir Chebotarev](https://github.com/excitoon)).
* クエリプランの `ReadFromStorage` ステップにおけるリソースの破棄順序を修正しました。まれなケースでクラッシュを引き起こす可能性がありました。[#15610](https://github.com/ClickHouse/ClickHouse/issues/15610) と関連している可能性があります。[#15645](https://github.com/ClickHouse/ClickHouse/pull/15645)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 読み取り専用テーブルをデタッチした際に `ReadonlyReplica` メトリクスを減算するようにしました。 [#15592](https://github.com/ClickHouse/ClickHouse/pull/15592) ([sundyli](https://github.com/sundy-li)).
* `VALUES`、`LIMIT`、または `IN` 演算子の右辺で `JSON*` 関数の結果を使用した際に発生していた `Element ... is not a constant expression` エラーを修正しました。 [#15589](https://github.com/ClickHouse/ClickHouse/pull/15589) ([tavplubix](https://github.com/tavplubix)).
* 例外が発生した場合、クエリはより早く終了します。例外発生時にはリモートレプリカでの実行をキャンセルします。 [#15578](https://github.com/ClickHouse/ClickHouse/pull/15578) ([Azat Khuzhin](https://github.com/azat)).
* エラーメッセージ `Could not calculate available disk space (statvfs), errno: 4, strerror: Interrupted system call` が発生しないようにしました。これにより [#15541](https://github.com/ClickHouse/ClickHouse/issues/15541) が修正されます。 [#15557](https://github.com/ClickHouse/ClickHouse/pull/15557)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* IN 句と Distributed テーブルを含むクエリで、イニシエータ側にデータベースが存在しない場合に発生する `Database <db> does not exist.` エラーを修正しました。 [#15538](https://github.com/ClickHouse/ClickHouse/pull/15538) ([Artem Zuikov](https://github.com/4ertus2)).
* `MOVE` や `REPLACE PARTITION` の後、またはまれに `DETACH` や `DROP PARTITION` の後に、存在しないパーツを待ち続けて Mutation がハングすることがありました。修正済みです。 [#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix))。
* 同じパターンでの `LIKE` の実行後に、`ILIKE` 演算子が大文字小文字を区別しない動作をしなくなってしまうバグを修正。 [#15536](https://github.com/ClickHouse/ClickHouse/pull/15536) ([alesapin](https://github.com/alesapin))。
* データに存在しない列を選択した際に、同じくデータに存在しない他の列に依存している場合に発生する `Missing columns` エラーを修正しました。[#15530](https://github.com/ClickHouse/ClickHouse/issues/15530) を修正。[#15532](https://github.com/ClickHouse/ClickHouse/pull/15532)（[alesapin](https://github.com/alesapin)）。
* ReplicatedMergeTree に単一のパラメータが渡された場合、これを無視するのではなくエラーをスローするようにしました。 [#15516](https://github.com/ClickHouse/ClickHouse/pull/15516) ([nvartolomei](https://github.com/nvartolomei)).
* DDLWorker におけるイベント購読のバグを修正しました。このバグにより、まれに `ON CLUSTER` でクエリがハングすることがありました。この問題は [#13450](https://github.com/ClickHouse/ClickHouse/issues/13450) で導入されたものです。[#15477](https://github.com/ClickHouse/ClickHouse/pull/15477)（[alesapin](https://github.com/alesapin)）。
* `boundingRatio` 集約関数の第 2 引数の型が誤っている場合に、適切なエラーを報告するようにしました。 [#15407](https://github.com/ClickHouse/ClickHouse/pull/15407) ([detailyang](https://github.com/detailyang)).
* [#15365](https://github.com/ClickHouse/ClickHouse/issues/15365) を修正: MySQL エンジンを使用するデータベースを `ATTACH` すると例外がスローされる（クエリコンテキストが存在しない）。[#15384](https://github.com/ClickHouse/ClickHouse/pull/15384)（[Winter Zhang](https://github.com/zhang2014)）。
* `select` クエリ内でカラムトランスフォーマーが複数回出現する場合の処理を修正しました。 [#15378](https://github.com/ClickHouse/ClickHouse/pull/15378) ([Amos Bird](https://github.com/amosbird)).
* `S3` ストレージでの圧縮を修正しました。 [#15376](https://github.com/ClickHouse/ClickHouse/pull/15376) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `SELECT toStartOfDay(today())` のようなクエリが、`time_zone` 引数が空であるというエラーで失敗する不具合を修正。 [#15319](https://github.com/ClickHouse/ClickHouse/pull/15319) ([Bharat Nallan](https://github.com/bharatnc))。
* MergeTree テーブルのリネーム処理とバックグラウンドクリーンアップ処理の間で発生するレースコンディションを修正しました。 [#15304](https://github.com/ClickHouse/ClickHouse/pull/15304) ([alesapin](https://github.com/alesapin)).
* システムログが有効な場合のサーバー起動時に発生するまれなレースコンディションを修正。 [#15300](https://github.com/ClickHouse/ClickHouse/pull/15300) ([alesapin](https://github.com/alesapin)).
* `MySQL` エンジンの同一テーブルに対して多数のサブクエリを含むクエリがハングする問題を修正しました。以前は、クエリ内で同じ `MySQL` テーブルへのサブクエリが 16 個を超えると、クエリが永久にハングしていました。 [#15299](https://github.com/ClickHouse/ClickHouse/pull/15299) ([Anton Popov](https://github.com/CurtizJ)).
* QueryLog における MSan レポートを修正。フィールド `memory_usage` に未初期化メモリが使用されていた可能性がありました。[#15258](https://github.com/ClickHouse/ClickHouse/pull/15258) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Merge テーブルへの JOIN を含むクエリで、GROUP BY 句において発生する「Unknown identifier」エラーを修正。 [#15242](https://github.com/ClickHouse/ClickHouse/pull/15242) ([Artem Zuikov](https://github.com/4ertus2)).
* `LowCardinality` 型と共に `joinGet` を使用した際にインスタンスがクラッシュする問題を修正。これにより [#15214](https://github.com/ClickHouse/ClickHouse/issues/15214) が解決されます。 [#15220](https://github.com/ClickHouse/ClickHouse/pull/15220) ([Amos Bird](https://github.com/amosbird)).
* テーブルエンジン `Buffer` で、`ALTER` クエリ実行後に新しい構造のデータを `Buffer` に挿入できなくなっていたバグを修正しました。 [#15117](https://github.com/ClickHouse/ClickHouse/issues/15117) を修正。 [#15192](https://github.com/ClickHouse/ClickHouse/pull/15192)（[alesapin](https://github.com/alesapin)）。
* MySQL のカラム定義パケット内の Decimal フィールドサイズを調整します。 [#15152](https://github.com/ClickHouse/ClickHouse/pull/15152) ([maqroll](https://github.com/maqroll)).
* `join_algorithm='auto'` の場合に発生する `Data compressed with different methods` を修正。`join_algorithm='partial_merge'` では左テーブルの結合キーの型として LowCardinality を維持。[#15088](https://github.com/ClickHouse/ClickHouse/pull/15088)（[Artem Zuikov](https://github.com/4ertus2)）。
* `jemalloc` を更新し、アフィニティマスク対応の `percpu_arena` を修正しました。 [#15035](https://github.com/ClickHouse/ClickHouse/pull/15035) ([Azat Khuzhin](https://github.com/azat))。 [#14957](https://github.com/ClickHouse/ClickHouse/pull/14957) ([Azat Khuzhin](https://github.com/azat))。
* すでに String と FixedString 間の比較では、パディング付きの比較を使用しています（[https://github.com/ClickHouse/ClickHouse/blob/master/src/Functions/FunctionsComparison.h#L333](https://github.com/ClickHouse/ClickHouse/blob/master/src/Functions/FunctionsComparison.h#L333)）。この PR は同じロジックをフィールド比較にも適用し、FixedString を主キーとして使用する際の動作を正しくします。これにより [#14908](https://github.com/ClickHouse/ClickHouse/issues/14908) が修正されます。[#15033](https://github.com/ClickHouse/ClickHouse/pull/15033)（[Amos Bird](https://github.com/amosbird)）。
* 関数 `bar` が細工された特定の引数で呼び出された場合、バッファオーバーフローが発生する可能性がありました。これにより [#13926](https://github.com/ClickHouse/ClickHouse/issues/13926) がクローズされました。[#15028](https://github.com/ClickHouse/ClickHouse/pull/15028)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* Mac OS 上の Docker で clickhouse-server を実行している際に、Atomic データベースで DDL クエリを実行すると発生していた `Cannot rename ... errno: 22, strerror: Invalid argument` エラーを修正しました。 [#15024](https://github.com/ClickHouse/ClickHouse/pull/15024) ([tavplubix](https://github.com/tavplubix)).
* メモリ制限を超過し、`HashJoin` から `MergeJoin` へ切り替える必要がある場合に、`join_algorithm='auto'` を使用した `RIGHT` または `FULL JOIN` で発生していたクラッシュを修正。 [#15002](https://github.com/ClickHouse/ClickHouse/pull/15002) ([Artem Zuikov](https://github.com/4ertus2)).
* `number_of_free_entries_in_pool_to_execute_mutation` 設定と `number_of_free_entries_in_pool_to_lower_max_size_of_merge` 設定を、`background_pool_size` と同じ値に設定できるようになりました。 [#14975](https://github.com/ClickHouse/ClickHouse/pull/14975) ([alesapin](https://github.com/alesapin)).
* サブクエリに `finalizeAggregation` 関数が含まれている場合でも述語プッシュダウンが機能するように修正しました。[#14847](https://github.com/ClickHouse/ClickHouse/issues/14847) を修正。[#14937](https://github.com/ClickHouse/ClickHouse/pull/14937)（[filimonov](https://github.com/filimonov)）。
* `system.asynchronous_metrics` 内で論理コアごとの CPU 周波数を公開するようにしました。これにより [#14923](https://github.com/ClickHouse/ClickHouse/issues/14923) が修正されます。 [#14924](https://github.com/ClickHouse/ClickHouse/pull/14924)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* `MaterializeMySQL`（試験的機能）：`.metadata.tmp File exists` エラーを修正しました。 [#14898](https://github.com/ClickHouse/ClickHouse/pull/14898)（[Winter Zhang](https://github.com/zhang2014)）。
* `extractAllGroups` 関数の一部の呼び出しで &quot;Memory limit exceeded&quot; エラーが発生する可能性がある問題を修正しました。これにより [#13383](https://github.com/ClickHouse/ClickHouse/issues/13383) が解決されました。[#14889](https://github.com/ClickHouse/ClickHouse/pull/14889)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* ファイルディスクリプタを使用した StorageFile への INSERT 試行時に発生する SIGSEGV を修正。 [#14887](https://github.com/ClickHouse/ClickHouse/pull/14887) ([Azat Khuzhin](https://github.com/azat)).
* `cache` 辞書で発生していたセグメンテーションフォールトを修正しました [#14837](https://github.com/ClickHouse/ClickHouse/issues/14837)。 [#14879](https://github.com/ClickHouse/ClickHouse/pull/14879) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* `MaterializeMySQL`（実験的機能）：MySQL の binlog イベントのパースにおけるバグを修正しました。このバグにより、`MaterializeMySQL` データベースエンジンで `Attempt to read after eof` および `Packet payload is not fully read` エラーが発生していました。 [#14852](https://github.com/ClickHouse/ClickHouse/pull/14852) ([Winter Zhang](https://github.com/zhang2014))。
* `SELECT` クエリで、問い合わせ対象のカラムが他のカラムに依存する `DEFAULT` 式を持ち、その依存先のカラムも `DEFAULT` を持つものの `SELECT` 句に含まれておらず、かつディスク上にも存在しない場合に、まれに発生するエラーを修正しました。[#14531](https://github.com/ClickHouse/ClickHouse/issues/14531) の一部を修正します。[#14845](https://github.com/ClickHouse/ClickHouse/pull/14845)（[alesapin](https://github.com/alesapin)）。
* 構成ファイルを `from_zk` include オプションを使って ZK から取得する必要がある場合に、サーバーが ZooKeeper との通信中に起動時にハングする可能性がある問題を修正しました。これにより [#14814](https://github.com/ClickHouse/ClickHouse/issues/14814) が修正されます。 [#14843](https://github.com/ClickHouse/ClickHouse/pull/14843) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* 符号付き型に対する縮小 `Int -> Int` キャストにおける単調性検出の誤りを修正しました。これにより、クエリ結果が不正になる可能性がありました。このバグは [#14513](https://github.com/ClickHouse/ClickHouse/issues/14513) で明らかになりました。[#14783](https://github.com/ClickHouse/ClickHouse/pull/14783)（[Amos Bird](https://github.com/amosbird)）。
* `Replace` 列トランスフォーマは、識別子をクローンされた AST で置き換える必要があります。これにより [#14695](https://github.com/ClickHouse/ClickHouse/issues/14695) が修正されます。 [#14734](https://github.com/ClickHouse/ClickHouse/pull/14734) ([Amos Bird](https://github.com/amosbird))。
* `ALTER ... MODIFY QUERY` を実行した際に、マテリアライズドビューのメタデータからデフォルトデータベース名が抜け落ちていた問題を修正しました。 [#14664](https://github.com/ClickHouse/ClickHouse/pull/14664) ([tavplubix](https://github.com/tavplubix)).
* `Nullable` 列を含む代入式と、`UPDATE x = 42` のような定数値を伴う `ALTER UPDATE` ミューテーションで、列に誤った値が入ったりセグメンテーションフォルトが発生したりする不具合を修正しました。[#13634](https://github.com/ClickHouse/ClickHouse/issues/13634)、[#14045](https://github.com/ClickHouse/ClickHouse/issues/14045) を修正。[#14646](https://github.com/ClickHouse/ClickHouse/pull/14646)（[alesapin](https://github.com/alesapin)）。
* 結果列のスケールが誤っていたために生じていた `Decimal` 型の乗算結果の不具合を修正。 [#14603](https://github.com/ClickHouse/ClickHouse/pull/14603) ([Artem Zuikov](https://github.com/4ertus2)).
* `Nullable` 型の `LowCardinality` に対する `has` 関数の不具合を修正しました。 [#14591](https://github.com/ClickHouse/ClickHouse/pull/14591) ([Mike](https://github.com/myrrc)).
* StorageReplicatedMergeTree エンジンの CreateQuery 実行中に発生した Zookeeper 例外後に、データディレクトリをクリーンアップするようにしました。 [#14563](https://github.com/ClickHouse/ClickHouse/pull/14563) ([Bharat Nallan](https://github.com/bharatnc)).
* 非常に大きなパラメータによるオーバーフローが原因で発生する可能性があった、`-Resample` コンビネータを持つ関数におけるまれなセグメンテーションフォルトを修正しました。 [#14562](https://github.com/ClickHouse/ClickHouse/pull/14562) ([Anton Popov](https://github.com/CurtizJ)).
* `Nullable(String)` を Enum に変換する際のバグを修正しました。[#12745](https://github.com/ClickHouse/ClickHouse/pull/12745) によって導入されたもので、この修正により [#14435](https://github.com/ClickHouse/ClickHouse/issues/14435) が解決されました。[#14530](https://github.com/ClickHouse/ClickHouse/pull/14530)（[Amos Bird](https://github.com/amosbird)）。
* `Nullable` カラムの誤ったソート順を修正しました。これにより [#14344](https://github.com/ClickHouse/ClickHouse/issues/14344) が解消されます。 [#14495](https://github.com/ClickHouse/ClickHouse/pull/14495) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* `ON CLUSTER` DDL クエリで `currentDatabase()` 関数が使用できない問題を修正。 [#14211](https://github.com/ClickHouse/ClickHouse/pull/14211) ([Winter Zhang](https://github.com/zhang2014)).
* `MaterializeMySQL`（実験的機能）：`MaterializeMySQL` データベースエンジンで発生していた `Packet payload is not fully read` エラーを修正しました。 [#14696](https://github.com/ClickHouse/ClickHouse/pull/14696) ([BohuTANG](https://github.com/BohuTANG))。

#### 改善 {#improvement-4}


* 新しく作成されるデータベースでは、デフォルトで `Atomic` データベースエンジンを有効にします。 [#15003](https://github.com/ClickHouse/ClickHouse/pull/15003) ([tavplubix](https://github.com/tavplubix)).
* `Delta`、`T64` などの特殊な codec を、サブタイプを持つカラムにも指定できるようにしました。[#12551](https://github.com/ClickHouse/ClickHouse/issues/12551) を実装し、[#11397](https://github.com/ClickHouse/ClickHouse/issues/11397) と [#4609](https://github.com/ClickHouse/ClickHouse/issues/4609) を修正しました。 [#15089](https://github.com/ClickHouse/ClickHouse/pull/15089) ([alesapin](https://github.com/alesapin))。
* ZooKeeper 設定の動的リロード。 [#14678](https://github.com/ClickHouse/ClickHouse/pull/14678) ([sundyli](https://github.com/sundy-li)).
* クラスタ設定の `<internal_replication>` に関係なく、`ALTER ... ON CLUSTER` クエリを実行できるようになりました。[#16075](https://github.com/ClickHouse/ClickHouse/pull/16075) ([alesapin](https://github.com/alesapin))。
* `joinGet` はマルチキーでのルックアップをサポートするようになりました。[#12418](https://github.com/ClickHouse/ClickHouse/issues/12418) の続きです。[#13015](https://github.com/ClickHouse/ClickHouse/pull/13015)（[Amos Bird](https://github.com/amosbird)）。
* `Atomic` データベースに対して `NO DELAY` または `SYNC` が指定されている場合、`DROP/DETACH TABLE` が実際に完了するまで待機するようになりました。 [#15448](https://github.com/ClickHouse/ClickHouse/pull/15448) ([tavplubix](https://github.com/tavplubix)).
* `ALTER` クエリを使用して、`VersionedCollapsingMergeTree` のバージョン列の型を変更できるようになりました。 [#15442](https://github.com/ClickHouse/ClickHouse/pull/15442) ([alesapin](https://github.com/alesapin))。
* レプリケートテーブル作成時に、`zookeeper_path` 内の `{database}`、`{table}`、`{uuid}` マクロを展開する。サーバー再起動後に `zookeeper_path` が壊れる可能性がある場合は `RENAME TABLE` を許可しない。[#6917](https://github.com/ClickHouse/ClickHouse/issues/6917) を修正。[#15348](https://github.com/ClickHouse/ClickHouse/pull/15348)（[tavplubix](https://github.com/tavplubix)）。
* 関数 `now` でタイムゾーンを指定する引数が利用できるようになりました。これにより [15264](https://github.com/ClickHouse/ClickHouse/issues/15264) が解決されました。 [#15285](https://github.com/ClickHouse/ClickHouse/pull/15285) ([flynn](https://github.com/ucasFL))。
* `/docker-entrypoint-initdb.d/` 内のすべてのスクリプトが実行されるまで、ClickHouse サーバーへの接続を許可しないようにしました。 [#15244](https://github.com/ClickHouse/ClickHouse/pull/15244) ([Aleksei Kozharin](https://github.com/alekseik1)).
* `EXPLAIN PLAN` クエリに `optimize` 設定を追加しました。有効化すると、クエリプランレベルの最適化が適用されます。デフォルトで有効です。 [#15201](https://github.com/ClickHouse/ClickHouse/pull/15201) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `CAST` の引数の数が誤っている場合に出力される例外メッセージを適切なものにしました。これにより [#13992](https://github.com/ClickHouse/ClickHouse/issues/13992) がクローズされました。[#15029](https://github.com/ClickHouse/ClickHouse/pull/15029)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* データパーツ挿入時の TTL 移動を無効にするオプションを追加。 [#15000](https://github.com/ClickHouse/ClickHouse/pull/15000) ([Pavel Kovalenko](https://github.com/Jokser)).
* ミューテーションを実行する際にキー制約を無視します。このプルリクエストがない場合、`force_index_by_date = 1` または `force_primary_key = 1` のときにミューテーションを実行することはできません。[#14973](https://github.com/ClickHouse/ClickHouse/pull/14973)（[Amos Bird](https://github.com/amosbird)）。
* ZooKeeper セッションの有効期限切れが原因で直前の drop 試行が失敗していた場合でも、Replicated テーブルを drop できるようにしました。これにより [#11891](https://github.com/ClickHouse/ClickHouse/issues/11891) が修正されます。 [#14926](https://github.com/ClickHouse/ClickHouse/pull/14926) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 分散テーブルに対して `SETTINGS` 付きで `SELECT` を実行した際に発生していた、不要に厳しい設定制約違反を修正しました。 [#14876](https://github.com/ClickHouse/ClickHouse/pull/14876) ([Amos Bird](https://github.com/amosbird)).
* 最初のレプリカを明示的に指定するためのクエリ設定 `load_balancing_first_offset` を追加しました。これはレプリカ間の負荷を制御できる `FIRST_OR_RANDOM` ロードバランシング戦略と併用されます。[#14867](https://github.com/ClickHouse/ClickHouse/pull/14867)（[Amos Bird](https://github.com/amosbird)）。
* `EXPLAIN` の結果に `SET` および `JOIN` のサブクエリを表示するようにしました。 [#14856](https://github.com/ClickHouse/ClickHouse/pull/14856) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* ストレージ `Distributed` でマルチボリュームストレージ構成を利用できるようにしました。 [#14839](https://github.com/ClickHouse/ClickHouse/pull/14839) ([Pavel Kovalenko](https://github.com/Jokser)).
* 同じ timespec から `query_start_time` と `query_start_time_microseconds` を生成するようにしました。 [#14831](https://github.com/ClickHouse/ClickHouse/pull/14831) ([Bharat Nallan](https://github.com/bharatnc))。
* `StorageJoin` と `StorageSet` の永続化を無効化する機能をサポート。この機能は `disable_set_and_join_persistency` の設定で制御されます。また、この PR によって issue [#6318](https://github.com/ClickHouse/ClickHouse/issues/6318) が解決されました。 [#14776](https://github.com/ClickHouse/ClickHouse/pull/14776) ([vxider](https://github.com/Vxider))。
* `COLUMNS` を使用してカラムのリストをまとめ、その後にカラム変換を適用できるようになりました。 [#14775](https://github.com/ClickHouse/ClickHouse/pull/14775) ([Amos Bird](https://github.com/amosbird)).
* `system.merges` テーブルに `merge_algorithm` を追加し、マージ処理の確認をしやすくしました。 [#14705](https://github.com/ClickHouse/ClickHouse/pull/14705) ([Amos Bird](https://github.com/amosbird)).
* `zookeeper exists watch` によって発生する可能性のあるメモリリークを修正。 [#14693](https://github.com/ClickHouse/ClickHouse/pull/14693) ([hustnn](https://github.com/hustnn)).
* 分散DDLの並列実行を可能にしました。 [#14684](https://github.com/ClickHouse/ClickHouse/pull/14684) ([Azat Khuzhin](https://github.com/azat)).
* `QueryMemoryLimitExceeded` イベントカウンタを追加。これにより [#14589](https://github.com/ClickHouse/ClickHouse/issues/14589) がクローズされます。 [#14647](https://github.com/ClickHouse/ClickHouse/pull/14647) ([fastio](https://github.com/fastio))。
* クエリフォーマットにおける末尾の空白をいくつか修正しました。 [#14595](https://github.com/ClickHouse/ClickHouse/pull/14595) ([Azat Khuzhin](https://github.com/azat)).
* ClickHouse は `partition expr` と `key expr` を別のものとして扱います。`partition expr` は関連するカラムを含む `minmax index` を構築するために使用される一方、`primary key expr` は式そのものとして保存されます。ユーザーが `partition by i / 1000` のように、より粗い粒度でテーブルをパーティション分割することもあります。しかし、二項演算子は単調とは限らず、この PR はその問題を修正しようとするものです。これは他のユースケースにも役立つ可能性があります。[#14513](https://github.com/ClickHouse/ClickHouse/pull/14513)（[Amos Bird](https://github.com/amosbird)）。
* `DiskS3` のアクセスチェックをスキップできるオプションを追加。`s3` ディスクは実験的な機能です。[#14497](https://github.com/ClickHouse/ClickHouse/pull/14497) ([Pavel Kovalenko](https://github.com/Jokser))。
* 進行中の S3 リクエストがある場合のサーバーのシャットダウン処理を高速化しました。 [#14496](https://github.com/ClickHouse/ClickHouse/pull/14496) ([Pavel Kovalenko](https://github.com/Jokser)).
* `SYSTEM RELOAD CONFIG` は再読み込みに失敗した場合、例外をスローし、従来の users.xml を引き続き使用するようになりました。バックグラウンドでの定期的な再読み込みも、再読み込みに失敗した場合は従来の users.xml を引き続き使用します。 [#14492](https://github.com/ClickHouse/ClickHouse/pull/14492) ([Vitaly Baranov](https://github.com/vitlibar)).
* `clickhouse-client` のスクリプトモードにおいて、VALUES 形式でインラインデータを指定する INSERT で、改行に加えてセミコロンもデータ終端文字としてサポートするようになりました。[#12288](https://github.com/ClickHouse/ClickHouse/issues/12288) をクローズ。 [#13192](https://github.com/ClickHouse/ClickHouse/pull/13192) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* コンパクトなパーツでカスタムコーデックをサポート。 [#12183](https://github.com/ClickHouse/ClickHouse/pull/12183) ([Anton Popov](https://github.com/CurtizJ)).

#### パフォーマンス改善 {#performance-improvement-2}

- 小さなパートに対してデフォルトでコンパクトパートを有効化。これにより頻繁なインサートの処理効率がわずかに向上します（4〜100倍）。[#11913](https://github.com/ClickHouse/ClickHouse/pull/11913) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `quantileTDigest`のパフォーマンスを改善。これにより[#2668](https://github.com/ClickHouse/ClickHouse/issues/2668)が修正されます。[#15542](https://github.com/ClickHouse/ClickHouse/pull/15542) ([Kruglov Pavel](https://github.com/Avogar))。
- AggregatingInOrderTransform/optimize_aggregation_in_orderにおけるメモリ使用量を大幅に削減。[#15543](https://github.com/ClickHouse/ClickHouse/pull/15543) ([Azat Khuzhin](https://github.com/azat))。
- 256ビット乗算を高速化。[#15418](https://github.com/ClickHouse/ClickHouse/pull/15418) ([Artem Zuikov](https://github.com/4ertus2))。
- ワイド整数の基本型として(u)int64_tを使用することで256ビット型のパフォーマンスを改善。従来のワイド整数は8ビット型を基本として使用していました。[#14859](https://github.com/ClickHouse/ClickHouse/pull/14859) ([Artem Zuikov](https://github.com/4ertus2))。
- 垂直マージの一時データを保存するために一時ディスクを明示的に使用。[#15639](https://github.com/ClickHouse/ClickHouse/pull/15639) ([Grigory Pervakov](https://github.com/GrigoryPervakov))。
- ループ内の複数のDeleteObjectの代わりに1つのS3 DeleteObjectsリクエストを使用。機能の変更はないため、integration/test_log_family_s3などの既存のテストでカバーされています。[#15238](https://github.com/ClickHouse/ClickHouse/pull/15238) ([ianton-ru](https://github.com/ianton-ru))。
- `DateTime <op> DateTime`が誤って低速な汎用実装を選択していた問題を修正。これにより[#15153](https://github.com/ClickHouse/ClickHouse/issues/15153)が修正されます。[#15178](https://github.com/ClickHouse/ClickHouse/pull/15178) ([Amos Bird](https://github.com/amosbird))。
- `FixedString`型のGROUP BYキーのパフォーマンスを改善。[#15034](https://github.com/ClickHouse/ClickHouse/pull/15034) ([Amos Bird](https://github.com/amosbird))。
- clickhouse-server起動時にコードセグメントのみを`mlock`。以前のバージョンでは、デバッグ情報を含むすべてのマップされた領域がメモリにロックされていました。デバッグ情報は通常別ファイルに分割されますが、そうでない場合は+2〜3 GiBのメモリ使用量増加につながっていました。[#14929](https://github.com/ClickHouse/ClickHouse/pull/14929) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- リンク時最適化によりClickHouseバイナリが小さくなりました。

#### ビルド/テスト/パッケージング改善 {#buildtestingpackaging-improvement-4}


* 現在、本番環境向けの ClickHouse ビルドには `clang-11` を使用しています。 [#15239](https://github.com/ClickHouse/ClickHouse/pull/15239) ([alesapin](https://github.com/alesapin))。
* 現在は CI で ClickHouse をビルドする際に clang-11 を使用しています。 [#14846](https://github.com/ClickHouse/ClickHouse/pull/14846) ([alesapin](https://github.com/alesapin))。
* バイナリビルド（Linux、Darwin、AArch64、FreeDSD）のコンパイラを `clang-11` に切り替え。 [#15622](https://github.com/ClickHouse/ClickHouse/pull/15622) ([Ilya Yatsishin](https://github.com/qoega)).
* これで、すべてのテストイメージが `llvm-symbolizer-11` を使用するようになりました。 [#15069](https://github.com/ClickHouse/ClickHouse/pull/15069) ([alesapin](https://github.com/alesapin))。
* llvm-11 でのビルドに対応。 [#15366](https://github.com/ClickHouse/ClickHouse/pull/15366) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `clang-tidy-10` から `clang-tidy-11` へ切り替えました。 [#14922](https://github.com/ClickHouse/ClickHouse/pull/14922) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* LLVM の experimental pass manager を標準で使用するようにしました。 [#15608](https://github.com/ClickHouse/ClickHouse/pull/15608) ([Danila Kutenin](https://github.com/danlark1)).
* どの C++ 翻訳単位も、ビルドに 10 分以上かかったり、10 GB を超えるメモリを使用したりしないようにしました。これにより [#14925](https://github.com/ClickHouse/ClickHouse/issues/14925) が修正されました。 [#15060](https://github.com/ClickHouse/ClickHouse/pull/15060) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* テスト実行とプロファイル実行を分離することで、パフォーマンステストをより安定かつ代表性の高いものにします。 [#15027](https://github.com/ClickHouse/ClickHouse/pull/15027) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* パフォーマンステストの信頼性を高めました。これは、`madvise` を使ってプロセスの実行可能メモリをオンザフライで再マッピングし、Transparent Huge Pages を利用することで実現しています。これにより、パフォーマンステストの不安定性の主な原因である iTLB ミスの発生回数を減らすことができます。 [#14685](https://github.com/ClickHouse/ClickHouse/pull/14685) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* python3 へ移行しました。これにより [#14886](https://github.com/ClickHouse/ClickHouse/issues/14886) がクローズされます。[#15007](https://github.com/ClickHouse/ClickHouse/pull/15007)（[Azat Khuzhin](https://github.com/azat)）。
* サーバーが応答しなかった場合、機能テストを早期に失敗させるようにしました。これにより [#15262](https://github.com/ClickHouse/ClickHouse/issues/15262) がクローズされました。 [#15267](https://github.com/ClickHouse/ClickHouse/pull/15267) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 設定ファイルなしで AArch64 版の clickhouse-server を実行できるようにしました。これにより [#15174](https://github.com/ClickHouse/ClickHouse/issues/15174) の対応が容易になります。[#15266](https://github.com/ClickHouse/ClickHouse/pull/15266)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* CI の docker イメージを改善: ZooKeeper を排除し、テスト用設定のインストールを単一のスクリプトに統合。 [#15215](https://github.com/ClickHouse/ClickHouse/pull/15215) ([alesapin](https://github.com/alesapin)).
* fast test スクリプトでの CMake オプションの転送を修正。[#14711](https://github.com/ClickHouse/ClickHouse/issues/14711) のエラーを修正。[#15155](https://github.com/ClickHouse/ClickHouse/pull/15155)（[alesapin](https://github.com/alesapin)）。
* 単一のコマンドでハードウェアベンチマークを実行できるスクリプトを追加しました。 [#15115](https://github.com/ClickHouse/ClickHouse/pull/15115) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 巨大なテスト `test_dictionaries_all_layouts_and_sources` を、より小さなテストに分割しました。 [#15110](https://github.com/ClickHouse/ClickHouse/pull/15110) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* AVX-512 を備えたサーバー上での base64 における MSan レポートを修正した可能性があります。これにより [#14006](https://github.com/ClickHouse/ClickHouse/issues/14006) が修正されます。 [#15030](https://github.com/ClickHouse/ClickHouse/pull/15030) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* すべての integration test 用 *.py ファイルのコードを再フォーマットして整理しました。 [#14864](https://github.com/ClickHouse/ClickHouse/pull/14864) ([Bharat Nallan](https://github.com/bharatnc)).
* CI で見つかった MaterializeMySQL の空トランザクションに起因する不安定なテストケースを修正。 [#14854](https://github.com/ClickHouse/ClickHouse/pull/14854) ([Winter Zhang](https://github.com/zhang2014)).
* ビルドを少し高速化しました。 [#14808](https://github.com/ClickHouse/ClickHouse/pull/14808) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 未使用のヘッダーを削除してビルドを少し高速化しました。[#14714](https://github.com/ClickHouse/ClickHouse/pull/14714) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* OSX におけるビルドエラーを修正。 [#14761](https://github.com/ClickHouse/ClickHouse/pull/14761) ([Winter Zhang](https://github.com/zhang2014)).
* OS で `ccache` が見つかった場合、`cmake` でデフォルトで有効化されるようにしました。 [#14575](https://github.com/ClickHouse/ClickHouse/pull/14575) ([alesapin](https://github.com/alesapin)).
* ClickHouse リポジトリから CI ビルドの構成を制御できるようにしました。 [#14547](https://github.com/ClickHouse/ClickHouse/pull/14547) ([alesapin](https://github.com/alesapin)).
* CMake ファイルにおいて: - 一部のオプションの説明の一部を上部のコメントへ移動。 - `option` のデフォルト値の 0 を `OFF`、1 を `ON` に置き換え。 - オプションにいくつかの説明およびドキュメントへのリンクを追加。 - `FUZZER` オプションを置き換え（同じ機能を有効にする `ENABLE_FUZZING` オプションが別に存在するため）。 - `ENABLE_TESTS` があるため、`ENABLE_GTEST_LIBRARY` オプションを削除。PR での詳細な説明はこちら: [#14711](https://github.com/ClickHouse/ClickHouse/pull/14711) ([Mike](https://github.com/myrrc))。
* バイナリを少し小さくしました（デバッグ版で約 50 MB）。[#14555](https://github.com/ClickHouse/ClickHouse/pull/14555)（[Artem Zuikov](https://github.com/4ertus2)）。
* `ConfigProcessor` でファイルパスを連結する際に `std::filesystem::path` を使用するよう変更しました。 [#14558](https://github.com/ClickHouse/ClickHouse/pull/14558) ([Bharat Nallan](https://github.com/bharatnc)).
* 負のビッグインテジャーで呼び出されたときの `bitShiftLeft()` におけるデバッグアサーションを修正しました。 [#14697](https://github.com/ClickHouse/ClickHouse/pull/14697) ([Artem Zuikov](https://github.com/4ertus2))。





## ClickHouse リリース 20.9 {#clickhouse-release-209}

### ClickHouse リリース v20.9.7.11-stable, 2020-12-07 {#clickhouse-release-v209711-stable-2020-12-07}

#### パフォーマンス改善 {#performance-improvement-3}

- 大量の `MergeTree` テーブルに対する `Merge` テーブルからの読み取りパフォーマンスを修正しました。[#7748](https://github.com/ClickHouse/ClickHouse/issues/7748) を修正。[#16988](https://github.com/ClickHouse/ClickHouse/pull/16988) ([Anton Popov](https://github.com/CurtizJ))。

#### バグ修正 {#bug-fix-10}


* `in_memory_parts_enable_wal` が無効な場合、WAL からパーツを復元しないようにしました。 [#17802](https://github.com/ClickHouse/ClickHouse/pull/17802) ([detailyang](https://github.com/detailyang)).
* `Distributed` テーブルへの挿入時に空き領域が不足している場合に発生していたセグメンテーションフォルトを修正しました。 [#17737](https://github.com/ClickHouse/ClickHouse/pull/17737) ([tavplubix](https://github.com/tavplubix)).
* ClickHouse が MySQL サーバーへの接続を再開できない問題を修正しました。 [#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz)).
* Windows Subsystem for Linux 上で ClickHouse を実行している場合に、`Atomic` データベースで `RENAME` クエリを実行すると発生していた `Function not implemented` エラーを修正しました。 [#17661](https://github.com/ClickHouse/ClickHouse/issues/17661) に対応。 [#17664](https://github.com/ClickHouse/ClickHouse/pull/17664)（[tavplubix](https://github.com/tavplubix)）。
* `clickhouse-client` を対話モードで複数行クエリとともに使用した場合、1 行コメントが誤ってクエリの終わりまで適用されていました。これは [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654) を修正するものです。[#17565](https://github.com/ClickHouse/ClickHouse/pull/17565)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 非常にまれなケースでサーバーが接続の受付を停止してしまう問題を修正しました。 [#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 対応する `mutation` が別のレプリカ上で `KILL` された場合に `ALTER` クエリがハングする問題を修正しました。[#16953](https://github.com/ClickHouse/ClickHouse/issues/16953) を修正。[#17499](https://github.com/ClickHouse/ClickHouse/pull/17499)（[alesapin](https://github.com/alesapin)）。
* `mark cache` のサイズを ClickHouse が過小に見積もってしまうバグを修正しました。これは、多数の小さなファイルに `mark` が含まれている場合に発生する可能性があります。 [#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin))。
* `optimize_redundant_functions_in_order_by` 設定が有効な場合の `ORDER BY` の動作を修正。 [#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* 誤った最適化により `DISTINCT` の後に発生し得た重複を修正しました。[#17294](https://github.com/ClickHouse/ClickHouse/issues/17294) を修正。 [#17296](https://github.com/ClickHouse/ClickHouse/pull/17296)（[li chengxiang](https://github.com/chengxianglibra)）。 [#17439](https://github.com/ClickHouse/ClickHouse/pull/17439)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `LowCardinality` 型を含む `JOIN` テーブルからの読み取り時にクラッシュする問題を修正。[#17228](https://github.com/ClickHouse/ClickHouse/issues/17228) を修正。[#17397](https://github.com/ClickHouse/ClickHouse/pull/17397)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* サブクエリ内に const カラムがある場合の set インデックスの失効処理を修正。これにより [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246) が解決される。[#17249](https://github.com/ClickHouse/ClickHouse/pull/17249)（[Amos Bird](https://github.com/amosbird)）。
* クラッシュを引き起こしていた `ColumnConst` の比較処理を修正しました。これにより [#17088](https://github.com/ClickHouse/ClickHouse/issues/17088) が解決されました。 [#17135](https://github.com/ClickHouse/ClickHouse/pull/17135) ([Amos Bird](https://github.com/amosbird))。
* `some_table` が `AS table_function()` として作成されていた場合に、`CREATE TABLE ... AS some_table` クエリで発生していたクラッシュを修正しました。 [#16944](https://github.com/ClickHouse/ClickHouse/issues/16944) を修正。 [#17072](https://github.com/ClickHouse/ClickHouse/pull/17072) ([tavplubix](https://github.com/tavplubix))。
* 関数 fuzzBits のバグ修正。関連 issue: [#16980](https://github.com/ClickHouse/ClickHouse/issues/16980)。[#17051](https://github.com/ClickHouse/ClickHouse/pull/17051)（[hexiaoting](https://github.com/hexiaoting)）。
* `LIMIT` を含むクエリのように、実行中にキャンセルされる可能性があるリモートクエリで、不要なネットワークエラーが発生しないようにしました。 [#17006](https://github.com/ClickHouse/ClickHouse/pull/17006) ([Azat Khuzhin](https://github.com/azat)).
* TODO。 [#16866](https://github.com/ClickHouse/ClickHouse/pull/16866)（[tavplubix](https://github.com/tavplubix)）。
* MySQL プロトコル経由の `INSERT` クエリに対して、影響を受けた行数を返すようにしました。以前の ClickHouse は常に 0 を返していましたが、これを修正しました。[#16605](https://github.com/ClickHouse/ClickHouse/issues/16605) を解決。[#16715](https://github.com/ClickHouse/ClickHouse/pull/16715)（[Winter Zhang](https://github.com/zhang2014)）。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-5}

- 組み込みタイムゾーンデータをバージョン2020dに更新(cctzも最新のmasterに更新)。[#17204](https://github.com/ClickHouse/ClickHouse/pull/17204) ([filimonov](https://github.com/filimonov))。

### ClickHouse リリース v20.9.6.14-stable, 2020-11-20 {#clickhouse-release-v209614-stable-2020-11-20}

#### 改善 {#improvement-5}

- SNIを必要とする`clickhouse-server`のセキュアエンドポイントへの接続を可能にしました。これは`clickhouse-server`がTLSプロキシの背後でホストされている場合に利用できます。[#16938](https://github.com/ClickHouse/ClickHouse/pull/16938) ([filimonov](https://github.com/filimonov))。
- 条件付き集約関数(例: `avgIf`、`sumIf`、`maxIf`)は、該当する行が存在せずnullable引数を使用する場合に`NULL`を返すようになりました。[#13964](https://github.com/ClickHouse/ClickHouse/pull/13964) ([Winter Zhang](https://github.com/zhang2014))。

#### バグ修正 {#bug-fix-11}

- 非リーダーのReplicatedMergeTreeTableに対して`ON CLUSTER`クエリが永久にハングする可能性があるバグを修正しました。[#17089](https://github.com/ClickHouse/ClickHouse/pull/17089) ([alesapin](https://github.com/alesapin))。
- エラーが発生した場合に`format_avro_schema_registry_url`のIPを再解決するようにしました。[#16985](https://github.com/ClickHouse/ClickHouse/pull/16985) ([filimonov](https://github.com/filimonov))。
- `ALTER TABLE ... MODIFY COLUMN ... NewType`の後、`SELECT`が変更中のカラムに対する`WHERE`式を持ち、かつ変更がまだ完了していない場合に発生する可能性のあるサーバークラッシュを修正しました。[#16968](https://github.com/ClickHouse/ClickHouse/pull/16968) ([Amos Bird](https://github.com/amosbird))。
- インストールスクリプトは常に設定フォルダ内にサブディレクトリを作成するようにしました。これはカスタム設定を使用したDockerビルドにのみ関連します。[#16936](https://github.com/ClickHouse/ClickHouse/pull/16936) ([filimonov](https://github.com/filimonov))。
- `ORDER BY`を含むクエリで発生する可能性のある`Illegal type of argument`エラーを修正しました。修正内容 [#16580](https://github.com/ClickHouse/ClickHouse/issues/16580)。[#16928](https://github.com/ClickHouse/ClickHouse/pull/16928) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- WriteBufferFromS3にデータが書き込まれなかった場合、マルチパートアップロードを中止するようにしました。[#16840](https://github.com/ClickHouse/ClickHouse/pull/16840) ([Pavel Kovalenko](https://github.com/Jokser))。
- 引数なしで`any`を使用した場合のクラッシュを修正しました。これは [#16803](https://github.com/ClickHouse/ClickHouse/issues/16803) に対する修正です。cc @azat。[#16826](https://github.com/ClickHouse/ClickHouse/pull/16826) ([Amos Bird](https://github.com/amosbird))。
- `transform_null_in`設定が有効な場合の複数カラムとタプルに対する`IN`演算子を修正しました。修正内容 [#15310](https://github.com/ClickHouse/ClickHouse/issues/15310)。[#16722](https://github.com/ClickHouse/ClickHouse/pull/16722) ([Anton Popov](https://github.com/CurtizJ))。
- max_threads>0およびORDER BY内の式を使用した場合のoptimize_read_in_order/optimize_aggregation_in_orderを修正しました。[#16637](https://github.com/ClickHouse/ClickHouse/pull/16637) ([Azat Khuzhin](https://github.com/azat))。
- 修正内容 [#16574](https://github.com/ClickHouse/ClickHouse/issues/16574) 修正内容 [#16231](https://github.com/ClickHouse/ClickHouse/issues/16231) 'if'サフィックス集約関数を使用した場合のリモートクエリの失敗を修正しました。[#16610](https://github.com/ClickHouse/ClickHouse/pull/16610) ([Winter Zhang](https://github.com/zhang2014))。
- 例外が発生した場合にクエリがより速く終了するようにしました。例外が発生した場合、リモートレプリカでの実行をキャンセルします。[#15578](https://github.com/ClickHouse/ClickHouse/pull/15578) ([Azat Khuzhin](https://github.com/azat))。


### ClickHouse release v20.9.5.5-stable, 2020-11-13 {#clickhouse-release-v20955-stable-2020-11-13}

#### バグ修正 {#bug-fix-12}

- クエリプロファイラが有効で、一部の関数の非同期アンワインドテーブルが破損している（と推定される）glibcバージョンを持つOSにClickHouseがインストールされている場合に発生する稀なサイレントクラッシュを修正しました。この修正は [#15301](https://github.com/ClickHouse/ClickHouse/issues/15301) に対応しています。また [#13098](https://github.com/ClickHouse/ClickHouse/issues/13098) も修正されます。[#16846](https://github.com/ClickHouse/ClickHouse/pull/16846) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 入力からAVROを解析する際に、型からLowCardinalityが削除されるようになりました。[#16188](https://github.com/ClickHouse/ClickHouse/issues/16188) を修正します。[#16521](https://github.com/ClickHouse/ClickHouse/pull/16521) ([Mike](https://github.com/myrrc))。
- MySQL Master -> MySQL Slave -> ClickHouse MaterializeMySQL Engineを使用し、MySQL Slaveで`slave_parallel_worker`が有効になっている場合のメタデータの急速な増加を、GTIDセットを適切に縮小することで修正しました。この修正は [#15951](https://github.com/ClickHouse/ClickHouse/issues/15951) に対応しています。[#16504](https://github.com/ClickHouse/ClickHouse/pull/16504) ([TCeason](https://github.com/TCeason))。
- Distributedテーブルに対するDROP TABLE（INSERTとの競合状態）を修正しました。[#16409](https://github.com/ClickHouse/ClickHouse/pull/16409) ([Azat Khuzhin](https://github.com/azat))。
- レプリケーションキュー内の非常に大きなエントリの処理を修正しました。テーブル構造が極端に大きい場合（1MB近く）、ALTERクエリで非常に大きなエントリが出現する可能性があります。この修正は [#16307](https://github.com/ClickHouse/ClickHouse/issues/16307) に対応しています。[#16332](https://github.com/ClickHouse/ClickHouse/pull/16332) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- フィルタリング用のセットが作成されていないために返却データの一部がドロップされる可能性がある不整合な動作を修正しました。[#16308](https://github.com/ClickHouse/ClickHouse/pull/16308) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- MySQLデータベースに関するバグを修正しました。データベースエンジンとして使用されているMySQLサーバーがダウンしている場合、一部のクエリが不要にもかかわらず無効なサーバーからテーブルを取得しようとするため、例外が発生していました。例えば、`SELECT ... FROM system.parts`クエリはMergeTreeテーブルのみで動作すべきであり、MySQLデータベースには一切アクセスすべきではありません。[#16032](https://github.com/ClickHouse/ClickHouse/pull/16032) ([Kruglov Pavel](https://github.com/Avogar))。

### ClickHouse release v20.9.4.76-stable (2020-10-29) {#clickhouse-release-v209476-stable-2020-10-29}

#### バグ修正 {#bug-fix-13}


* 関数 `dictGet` 内で例外が発生した場合に起きる二重解放の問題を修正しました。これは、辞書の読み込み時にエラーが発生していた場合に起こり得ました。 [#16429](https://github.com/ClickHouse/ClickHouse/pull/16429) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `GROUP BY` で `TOTALS` / `ROLLUP` / `CUBE` 修飾子と、`GROUP BY` キーに対する `min` / `max` 関数を併用した場合の動作を修正。[#16393](https://github.com/ClickHouse/ClickHouse/issues/16393) を修正。 [#16397](https://github.com/ClickHouse/ClickHouse/pull/16397)（[Anton Popov](https://github.com/CurtizJ)）。
* 非同期 Distributed INSERT と `prefer_localhost_replica=0` および internal&#95;replication 使用時の不具合を修正。 [#16358](https://github.com/ClickHouse/ClickHouse/pull/16358) ([Azat Khuzhin](https://github.com/azat)).
* TwoLevelStringHashTable 実装内の重大な誤りを修正しました。これはメモリリークを引き起こす可能性がありました。このバグがこれほど長い間潜んでいたことに驚いています…。[#16264](https://github.com/ClickHouse/ClickHouse/pull/16264) ([Amos Bird](https://github.com/amosbird)).
* メモリが制限に関係なく過剰に割り当てられてしまう問題を修正しました。これにより [#14560](https://github.com/ClickHouse/ClickHouse/issues/14560) がクローズされます。[#16206](https://github.com/ClickHouse/ClickHouse/pull/16206)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `ReplicatedVersionedCollapsingMergeTree` に対する `ALTER MODIFY ... ORDER BY` クエリがハングする問題を修正。[#15980](https://github.com/ClickHouse/ClickHouse/issues/15980) を解決。[#16011](https://github.com/ClickHouse/ClickHouse/pull/16011)（[alesapin](https://github.com/alesapin)）。
* collate 名と charset 名のパーサーを修正し、文字列型での `length = 0` をサポートしました。 [#16008](https://github.com/ClickHouse/ClickHouse/pull/16008) ([Winter Zhang](https://github.com/zhang2014)).
* 複雑なキーを持つ辞書で `direct` レイアウトを使用できるようにしました。 [#16007](https://github.com/ClickHouse/ClickHouse/pull/16007) ([Anton Popov](https://github.com/CurtizJ)).
* 非アクティブな期間の後にレプリケーションエラーが発生した場合に、レプリカが 5～10 分間ハングし続けるのを防止しました。 [#15987](https://github.com/ClickHouse/ClickHouse/pull/15987) ([filimonov](https://github.com/filimonov)).
* `MaterializedView` への `INSERT` または `SELECT` を実行している最中に、同時に対象テーブルを `DROP` すると、まれに発生するセグメンテーションフォルトを修正しました（`Atomic` データベースエンジン向け）。 [#15984](https://github.com/ClickHouse/ClickHouse/pull/15984) ([tavplubix](https://github.com/tavplubix)).
* 設定プロファイルのパースにおける曖昧さを解消しました。`CREATE USER ... SETTINGS profile readonly` は、`readonly` という名前のプロファイルを使用していると解釈されるようになり、`profile` という名前の設定に `readonly` 制約を付与したものとは解釈されなくなりました。これにより [#15628](https://github.com/ClickHouse/ClickHouse/issues/15628) が修正されました。[#15982](https://github.com/ClickHouse/ClickHouse/pull/15982)（[Vitaly Baranov](https://github.com/vitlibar)）。
* データベースの作成に失敗した際にクラッシュする問題を修正。 [#15954](https://github.com/ClickHouse/ClickHouse/pull/15954) ([Winter Zhang](https://github.com/zhang2014)).
* `DROP TABLE IF EXISTS` 実行時に、テーブルが同時にリネームされた場合に `Table ... does not exist` エラーで失敗する問題を修正しました（Atomic データベースエンジン）。複数テーブルに対して一部の DDL クエリ（`DROP DATABASE` や `RENAME TABLE` など）を同時実行した際に、まれに発生するデッドロックを修正しました。`DROP/DETACH TABLE` を同時実行している場合に、`DROP/DETACH DATABASE` が `Table ... does not exist` エラーで失敗する問題を修正しました。 [#15934](https://github.com/ClickHouse/ClickHouse/pull/15934) ([tavplubix](https://github.com/tavplubix)).
* `WHERE`、`PREWHERE`、`GLOBAL IN` を含むクエリを `Distributed` テーブルに対して実行した際に、誤って空の結果が返される問題を修正しました。[#15792](https://github.com/ClickHouse/ClickHouse/issues/15792) を修正。[#15933](https://github.com/ClickHouse/ClickHouse/pull/15933)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* RBAC におけるデッドロックが発生しうる問題を修正。[#15875](https://github.com/ClickHouse/ClickHouse/pull/15875) ([Vitaly Baranov](https://github.com/vitlibar))。
* `ALTER MODIFY COLUMN` クエリの後に実行された `SELECT ... ORDER BY DESC` クエリで発生する例外 `Block structure mismatch` を修正しました。[#15800](https://github.com/ClickHouse/ClickHouse/issues/15800) を解決。[#15852](https://github.com/ClickHouse/ClickHouse/pull/15852)（[alesapin](https://github.com/alesapin)）。
* MaterializeMySQL における `select count()` の不正確な動作を修正。 [#15767](https://github.com/ClickHouse/ClickHouse/pull/15767) ([tavplubix](https://github.com/tavplubix)).
* 仮想カラムのみを選択する一部のクエリの処理を修正しました。以前は `Not found column _nothing in block` という例外がスローされる場合がありました。[#12298](https://github.com/ClickHouse/ClickHouse/issues/12298) を修正します。[#15756](https://github.com/ClickHouse/ClickHouse/pull/15756)（[Anton Popov](https://github.com/CurtizJ)）。
* `max_replicated_logs_to_keep` 設定のデフォルト値が低すぎる問題を修正しました。これによりレプリカが頻繁に lost 状態になる可能性がありました。lost レプリカの復旧プロセスについては、最も最新のレプリカをクローン元として選択するように改善しました。また、lost レプリカから古いパーツを削除せず、代わりに detach するようにしました。 [#15701](https://github.com/ClickHouse/ClickHouse/pull/15701) ([tavplubix](https://github.com/tavplubix)).
* 宛先テーブルとは異なる構造を持つ `Buffer` テーブルから読み込む際に発生していた `Cannot add simple transform to empty Pipe` エラーを修正しました。この問題は、クエリに対して宛先テーブルが空の結果を返す場合に発生する可能性がありました。[#15529](https://github.com/ClickHouse/ClickHouse/issues/15529) を修正。[#15662](https://github.com/ClickHouse/ClickHouse/pull/15662)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* S3 テーブル関数における glob のバグを修正しました。URL から取得した region が S3 クライアントの設定に反映されていませんでした。 [#15646](https://github.com/ClickHouse/ClickHouse/pull/15646) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 読み取り専用テーブルをデタッチする際に `ReadonlyReplica` メトリクスをデクリメントするようにしました。これにより [#15598](https://github.com/ClickHouse/ClickHouse/issues/15598) が修正されました。[#15592](https://github.com/ClickHouse/ClickHouse/pull/15592)（[sundyli](https://github.com/sundy-li)）。
* `ReplicatedMergeTree` に単一のパラメータだけが渡された場合、それを無視するのではなくエラーをスローするようにしました。 [#15516](https://github.com/ClickHouse/ClickHouse/pull/15516) ([nvartolomei](https://github.com/nvartolomei)).

#### 改善 {#improvement-6}

- クラスタ設定の `<internal_replication>` 設定に関わらず、`ALTER ... ON CLUSTER` クエリを実行できるようになりました。[#16075](https://github.com/ClickHouse/ClickHouse/pull/16075) ([alesapin](https://github.com/alesapin))。
- テーブル作成時に `ReplicatedMergeTree` 引数内の `{database}`、`{table}`、`{uuid}` マクロを展開するようになりました。[#16160](https://github.com/ClickHouse/ClickHouse/pull/16160) ([tavplubix](https://github.com/tavplubix))。

### ClickHouse リリース v20.9.3.45-stable (2020-10-09) {#clickhouse-release-v209345-stable-2020-10-09}

#### バグ修正 {#bug-fix-14}


* `ARRAY JOIN` を含む `MV` 用クエリにおいて、`MATERIALIZED VIEW` への挿入時に発生することがある `Cannot find column` エラーを修正。 [#15717](https://github.com/ClickHouse/ClickHouse/pull/15717) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* AMQP-CPP のレースコンディションを修正。 [#15667](https://github.com/ClickHouse/ClickHouse/pull/15667) ([alesapin](https://github.com/alesapin)).
* クエリプランの `ReadFromStorage` ステップにおけるリソースの破棄順序を修正しました。まれなケースでクラッシュを引き起こす可能性がありました。[#15610](https://github.com/ClickHouse/ClickHouse/issues/15610) に関連している可能性があります。[#15645](https://github.com/ClickHouse/ClickHouse/pull/15645)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `VALUES`、`LIMIT`、または `IN` 演算子の右辺で `JSON*` 関数の結果を使用した際に発生していた `Element ... is not a constant expression` エラーを修正しました。 [#15589](https://github.com/ClickHouse/ClickHouse/pull/15589) ([tavplubix](https://github.com/tavplubix))。
* エラーメッセージ `Could not calculate available disk space (statvfs), errno: 4, strerror: Interrupted system call` が発生する可能性をなくしました。これにより [#15541](https://github.com/ClickHouse/ClickHouse/issues/15541) が修正されました。 [#15557](https://github.com/ClickHouse/ClickHouse/pull/15557) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* AggregatingInOrderTransform/optimize&#95;aggregation&#95;in&#95;order におけるメモリ使用量を大幅に削減しました。 [#15543](https://github.com/ClickHouse/ClickHouse/pull/15543) ([Azat Khuzhin](https://github.com/azat)).
* `MOVE` や `REPLACE PARTITION` の後、存在しないパーツを待ち続けてミューテーションがハングすることがあり、まれに `DETACH` や `DROP PARTITION` の後にも発生することがありました。修正済みです。 [#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix)).
* 同じパターンの `LIKE` を実行した後に、`ILIKE` 演算子が大文字小文字を区別しない動作をしなくなってしまうバグを修正。 [#15536](https://github.com/ClickHouse/ClickHouse/pull/15536) ([alesapin](https://github.com/alesapin)).
* データに存在しない列で、かつ同様にデータに存在しない他の列に依存している列を `SELECT` した際に発生する `Missing columns` エラーを修正しました。 [#15530](https://github.com/ClickHouse/ClickHouse/issues/15530) を修正。 [#15532](https://github.com/ClickHouse/ClickHouse/pull/15532) ([alesapin](https://github.com/alesapin))。
* DDLWorker におけるイベント購読のバグを修正しました。これは、まれに `ON CLUSTER` でクエリがハングする原因となる可能性がありました。[#13450](https://github.com/ClickHouse/ClickHouse/issues/13450) で導入された問題です。[#15477](https://github.com/ClickHouse/ClickHouse/pull/15477)（[alesapin](https://github.com/alesapin)）。
* `boundingRatio` 集約関数の第 2 引数の型が誤っている場合に、適切なエラーを報告するようになりました。 [#15407](https://github.com/ClickHouse/ClickHouse/pull/15407) ([detailyang](https://github.com/detailyang)).
* `SELECT toStartOfDay(today())` のようなクエリが、time&#95;zone 引数が空であることを理由に失敗してしまうバグを修正しました。 [#15319](https://github.com/ClickHouse/ClickHouse/pull/15319) ([Bharat Nallan](https://github.com/bharatnc))。
* MergeTree テーブルのリネームとバックグラウンドクリーンアップ時に発生するレースコンディションを修正。 [#15304](https://github.com/ClickHouse/ClickHouse/pull/15304) ([alesapin](https://github.com/alesapin)).
* `system.logs` が有効な場合にサーバー起動時にまれに発生するレースコンディションを修正。 [#15300](https://github.com/ClickHouse/ClickHouse/pull/15300) ([alesapin](https://github.com/alesapin))。
* QueryLog における MSan レポートを修正。フィールド `memory_usage` で未初期化メモリが使用される可能性がありました。 [#15258](https://github.com/ClickHouse/ClickHouse/pull/15258) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* LowCardinality 型で joinGet を使用した際にインスタンスがクラッシュする問題を修正しました。これにより [#15214](https://github.com/ClickHouse/ClickHouse/issues/15214) が解決されます。[#15220](https://github.com/ClickHouse/ClickHouse/pull/15220)（[Amos Bird](https://github.com/amosbird)）。
* テーブルエンジン `Buffer` において、`ALTER` クエリの後に新しい構造のデータを `Buffer` に挿入できなくなっていたバグを修正しました。 [#15117](https://github.com/ClickHouse/ClickHouse/issues/15117) の修正。 [#15192](https://github.com/ClickHouse/ClickHouse/pull/15192)（[alesapin](https://github.com/alesapin)）。
* MySQL のカラム定義パケット内の小数フィールドサイズを調整。 [#15152](https://github.com/ClickHouse/ClickHouse/pull/15152) ([maqroll](https://github.com/maqroll)).
* Mac OS 上の Docker で `clickhouse-server` を実行している場合に、Atomic データベースでの DDL クエリ実行時に発生していた `Cannot rename ... errno: 22, strerror: Invalid argument` エラーを修正しました。 [#15024](https://github.com/ClickHouse/ClickHouse/pull/15024) ([tavplubix](https://github.com/tavplubix)).
* `finalizeAggregation` 関数を含むサブクエリがある場合に、述語プッシュダウンが機能するように修正しました。[#14847](https://github.com/ClickHouse/ClickHouse/issues/14847) を修正。[#14937](https://github.com/ClickHouse/ClickHouse/pull/14937)（[filimonov](https://github.com/filimonov)）。
* 構成ファイルを `from_zk` インクルードオプションで ZK から取得する必要がある場合に、サーバーが起動時に ZooKeeper との通信中にスタックしてしまう可能性がある問題を修正しました。これにより [#14814](https://github.com/ClickHouse/ClickHouse/issues/14814) が修正されました。 [#14843](https://github.com/ClickHouse/ClickHouse/pull/14843) ([Alexander Kuzmenkov](https://github.com/akuzm))。

#### 改善 {#improvement-7}

- `ALTER`クエリで`VersionedCollapsingMergeTree`のバージョンカラムの型を変更できるようになりました。[#15442](https://github.com/ClickHouse/ClickHouse/pull/15442) ([alesapin](https://github.com/alesapin))。

### ClickHouseリリース v20.9.2.20, 2020-09-22 {#clickhouse-release-v209220-2020-09-22}

#### 後方互換性のない変更 {#backward-incompatible-change-3}

- 20.5より古いバージョンからアップグレードする際、ローリングアップデートを実行し、クラスタに20.5以上と20.5未満のバージョンが混在している場合、古いバージョンのClickHouseノードを再起動すると、新しいバージョンが存在する状態で古いバージョンが起動し、`Part ... intersects previous part`エラーが発生する可能性があります。このエラーを防ぐには、まずすべてのクラスタノードに新しいclickhouse-serverパッケージをインストールしてから再起動してください(これにより、clickhouse-serverの再起動時に新しいバージョンで起動します)。

#### 新機能 {#new-feature-3}

- カラム変換子`EXCEPT`、`REPLACE`、`APPLY`を追加しました。これらは選択されたカラムのリスト(`*`または`COLUMNS(...)`の後)に適用できます。例えば、`SELECT * EXCEPT(URL) REPLACE(number + 1 AS number)`のように記述できます。別の例として、`select * apply(length) apply(max) from wide_string_table`ですべての文字列カラムの最大長を調べることができます。[#14233](https://github.com/ClickHouse/ClickHouse/pull/14233) ([Amos Bird](https://github.com/amosbird))。
- 順位相関係数を計算する集約関数`rankCorr`を追加しました。[#11769](https://github.com/ClickHouse/ClickHouse/pull/11769) ([antikvist](https://github.com/antikvist)) [#14411](https://github.com/ClickHouse/ClickHouse/pull/14411) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- サブクエリをテーブルオブジェクトに変換するテーブル関数`view`を追加しました。これによりクエリの受け渡しが容易になります。例えば、remote/clusterテーブル関数で使用できます。[#12567](https://github.com/ClickHouse/ClickHouse/pull/12567) ([Amos Bird](https://github.com/amosbird))。

#### バグ修正 {#bug-fix-15}


* `ALTER UPDATE` のミューテーションで、代入式に Nullable カラムと定数値（`UPDATE x = 42` のようなもの）が含まれている場合に、カラム内の値が不正になる、またはセグメンテーションフォルトが発生するバグを修正。[#13634](https://github.com/ClickHouse/ClickHouse/issues/13634)、[#14045](https://github.com/ClickHouse/ClickHouse/issues/14045) を修正。[#14646](https://github.com/ClickHouse/ClickHouse/pull/14646)（[alesapin](https://github.com/alesapin)）。
* 結果列の小数スケールが誤っていたために不正確になっていた `Decimal` の乗算結果を修正。 [#14603](https://github.com/ClickHouse/ClickHouse/pull/14603) ([Artem Zuikov](https://github.com/4ertus2)).
* `Nullable` 列のソート順が誤っていた問題を修正しました。これにより [#14344](https://github.com/ClickHouse/ClickHouse/issues/14344) が解決されます。 [#14495](https://github.com/ClickHouse/ClickHouse/pull/14495) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* インデックス解析時に、より短い長さの文字列と比較した場合に発生していた、`FixedString` 型の主キーとの不整合な比較を修正しました。これにより [#14908](https://github.com/ClickHouse/ClickHouse/issues/14908) が解決されています。 [#15033](https://github.com/ClickHouse/ClickHouse/pull/15033) ([Amos Bird](https://github.com/amosbird))。
* テーブルに単一のパーツしか持たないパーティションが存在する場合に、誤ったマージの割り当てが行われてしまうバグを修正。 [#14444](https://github.com/ClickHouse/ClickHouse/pull/14444) ([alesapin](https://github.com/alesapin)).
* 関数 `bar` が特別に細工された引数で呼び出された場合に、バッファオーバーフローが発生する可能性がありました。これにより [#13926](https://github.com/ClickHouse/ClickHouse/issues/13926) が解決されました。 [#15028](https://github.com/ClickHouse/ClickHouse/pull/15028) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `system.asynchronous_metrics` 内に論理コアごとの CPU 周波数を公開します。これにより [#14923](https://github.com/ClickHouse/ClickHouse/issues/14923) が修正されます。[#14924](https://github.com/ClickHouse/ClickHouse/pull/14924)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* `MaterializeMySQL` データベースエンジン使用時に発生していた `.metadata.tmp File exists` エラーを修正。 [#14898](https://github.com/ClickHouse/ClickHouse/pull/14898) ([Winter Zhang](https://github.com/zhang2014)).
* `extractAllGroups` 関数の一部の呼び出しで「Memory limit exceeded」エラーが発生する問題を修正しました。これにより [#13383](https://github.com/ClickHouse/ClickHouse/issues/13383) が解決されます。 [#14889](https://github.com/ClickHouse/ClickHouse/pull/14889)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* StorageFile(fd) への INSERT 試行時に発生する SIGSEGV を修正。 [#14887](https://github.com/ClickHouse/ClickHouse/pull/14887) ([Azat Khuzhin](https://github.com/azat)).
* クエリ対象のカラムが、`DEFAULT` を持つ別のカラムに依存する `DEFAULT` 式を持ち、かつその別カラムが `SELECT` クエリ内に含まれずディスク上にも存在しない場合に、まれに発生していた `SELECT` クエリのエラーを修正しました。[#14531](https://github.com/ClickHouse/ClickHouse/issues/14531) の一部を修正します。[#14845](https://github.com/ClickHouse/ClickHouse/pull/14845)（[alesapin](https://github.com/alesapin)）。
* 符号付き型の縮小された `Int -> Int` キャストに対する単調性検出の誤りを修正しました。これにより、クエリ結果が不正になる可能性がありました。このバグは [#14513](https://github.com/ClickHouse/ClickHouse/issues/14513) で明らかになりました。[#14783](https://github.com/ClickHouse/ClickHouse/pull/14783)（[Amos Bird](https://github.com/amosbird)）。
* `ALTER ... MODIFY QUERY` を実行した際に、マテリアライズドビューのメタデータ内でデフォルトのデータベース名が欠落していた問題を修正しました。 [#14664](https://github.com/ClickHouse/ClickHouse/pull/14664) ([tavplubix](https://github.com/tavplubix)).
* LowCardinality 型および Nullable 型が関与している場合に、`has` 関数が誤った結果を返す可能性がある問題を修正。 [#14591](https://github.com/ClickHouse/ClickHouse/pull/14591) ([Mike](https://github.com/myrrc)).
* ReplicatedMergeTree エンジンのテーブルに対する `CREATE` クエリの実行中に Zookeeper 例外が発生した場合に、データディレクトリをクリーンアップするようにしました。 [#14563](https://github.com/ClickHouse/ClickHouse/pull/14563) ([Bharat Nallan](https://github.com/bharatnc))。
* 非常に大きなパラメータによるオーバーフローが原因で発生する可能性があった、`-Resample` コンビネータを持つ関数でのまれなセグメンテーションフォルトを修正しました。 [#14562](https://github.com/ClickHouse/ClickHouse/pull/14562) ([Anton Popov](https://github.com/CurtizJ))。
* `topK` 集約関数で配列サイズのオーバーフローをチェックするようにしました。このチェックがない場合、ユーザーが細工したパラメータを持つクエリを送信することでサーバーをクラッシュさせる可能性があります。これにより [#14452](https://github.com/ClickHouse/ClickHouse/issues/14452) がクローズされました。 [#14467](https://github.com/ClickHouse/ClickHouse/pull/14467) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* SysVinit の再起動/起動/停止/リロードを、systemd 使用時には systemd にプロキシするようにしました。 [#14460](https://github.com/ClickHouse/ClickHouse/pull/14460) ([Azat Khuzhin](https://github.com/azat)).
* `PipelineExecutor` 自体で例外が発生した場合にクエリ実行を停止するようにしました。これにより、まれに発生しうるクエリのハングを防止できます。 [#14334](https://github.com/ClickHouse/ClickHouse/pull/14334) [#14402](https://github.com/ClickHouse/ClickHouse/pull/14402) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `AS table_function` として作成されたテーブルに対する `ALTER` クエリの実行時に発生していたクラッシュを修正。 [#14212](https://github.com/ClickHouse/ClickHouse/issues/14212) を修正。 [#14326](https://github.com/ClickHouse/ClickHouse/pull/14326)（[alesapin](https://github.com/alesapin)）。
* `REFRESH` コマンドを伴う `ALTER LIVE VIEW` クエリ実行時に発生する例外を修正しました。`LIVE VIEW` は実験的な機能です。 [#14320](https://github.com/ClickHouse/ClickHouse/pull/14320) ([Bharat Nallan](https://github.com/bharatnc)).
* ネストされたインタプリタを含むクエリに対して、`EXPLAIN PIPELINE graph=1` のための `QueryPlan` のライフタイムを修正。 [#14315](https://github.com/ClickHouse/ClickHouse/pull/14315) ([Azat Khuzhin](https://github.com/azat)).
* SSD キャッシュを用いる複合キー外部ディクショナリでタプルサイズをより適切にチェックするようにしました。これにより [#13981](https://github.com/ClickHouse/ClickHouse/issues/13981) が修正されます。 [#14313](https://github.com/ClickHouse/ClickHouse/pull/14313)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `ALIAS` カラム型での `CODEC` の使用を禁止します。[#13911](https://github.com/ClickHouse/ClickHouse/issues/13911) を修正。[#14263](https://github.com/ClickHouse/ClickHouse/pull/14263)（[Bharat Nallan](https://github.com/bharatnc)）。
* グローバルレベル以外で実行された場合の `GRANT ALL` ステートメントの動作を修正しました。 [#13987](https://github.com/ClickHouse/ClickHouse/pull/13987) ([Vitaly Baranov](https://github.com/vitlibar)).
* lambda 内での arrayJoin() のキャプチャを修正（論理エラーのメッセージを伴う例外がスローされていた問題を修正）。 [#13792](https://github.com/ClickHouse/ClickHouse/pull/13792) ([Azat Khuzhin](https://github.com/azat)).

#### 実験的機能 {#experimental-feature-2}

- 指定されたSELECTクエリからランダムなデータベースを生成する`db-generator`ツールを追加しました。ユーザーから不完全なバグレポートしか得られない場合に、問題の再現を容易にします。[#14442](https://github.com/ClickHouse/ClickHouse/pull/14442) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)) [#10973](https://github.com/ClickHouse/ClickHouse/issues/10973) ([ZeDRoman](https://github.com/ZeDRoman))。

#### 改善 {#improvement-8}

- Distributedストレージでマルチボリュームストレージ設定の使用を許可しました。[#14839](https://github.com/ClickHouse/ClickHouse/pull/14839) ([Pavel Kovalenko](https://github.com/Jokser))。
- `toStartOf*`系の関数で空のtime_zone引数を禁止しました。[#14509](https://github.com/ClickHouse/ClickHouse/pull/14509) ([Bharat Nallan](https://github.com/bharatnc))。
- MySQLハンドラが`SET @@var = value`のようなクエリに対して`OK`を返すようになりました。このようなステートメントは無視されます。これは、一部のMySQLドライバがハンドシェイク後のセットアップのために`SET @@`クエリを送信するために必要です https://github.com/ClickHouse/ClickHouse/issues/9336#issuecomment-686222422 。[#14469](https://github.com/ClickHouse/ClickHouse/pull/14469) ([BohuTANG](https://github.com/BohuTANG))。
- 以前にマテリアライズされていなかった場合、マージ中にTTLが適用されるようになりました。[#14438](https://github.com/ClickHouse/ClickHouse/pull/14438) ([alesapin](https://github.com/alesapin))。
- `clickhouse-obfuscator`が[#13163](https://github.com/ClickHouse/ClickHouse/issues/13163)で提案されたUUID型をサポートするようになりました。[#14409](https://github.com/ClickHouse/ClickHouse/pull/14409) ([dimarub2000](https://github.com/dimarub2000))。
- [#11384](https://github.com/ClickHouse/ClickHouse/issues/11384)で提案された新しい設定`system_events_show_zero_values`を追加しました。[#14404](https://github.com/ClickHouse/ClickHouse/pull/14404) ([dimarub2000](https://github.com/dimarub2000))。
- `MaterializeMySQL`でプライマリキーを暗黙的にnot nullに変換するようにしました(`MySQL`と同様)。[#14114](https://github.com/ClickHouse/ClickHouse/issues/14114)を修正しました。[#14397](https://github.com/ClickHouse/ClickHouse/pull/14397) ([Winter Zhang](https://github.com/zhang2014))。
- boost multiprecisionの広整数(256ビット)をhttps://github.com/cerevra/intの実装に置き換えました。256ビット整数は実験的機能です。[#14229](https://github.com/ClickHouse/ClickHouse/pull/14229) ([Artem Zuikov](https://github.com/4ertus2))。
- `system.part_log`のパーツに対して`default_compression_codec`という名前のデフォルト圧縮コーデックを追加しました。[#14116](https://github.com/ClickHouse/ClickHouse/pull/14116) ([alesapin](https://github.com/alesapin))。
- `DateTime`型に精度引数を追加しました。これにより、`DateTime64`の代わりに`DateTime`という名前を使用できるようになります。[#13761](https://github.com/ClickHouse/ClickHouse/pull/13761) ([Winter Zhang](https://github.com/zhang2014))。
- `Redis`外部ディクショナリにrequirepass認証を追加しました。[#13688](https://github.com/ClickHouse/ClickHouse/pull/13688) ([Ivan Torgashov](https://github.com/it1804))。
- `RabbitMQ`エンジンの改善:接続とチャネルの障害処理、適切なコミット、挿入失敗の処理、改善されたエクスチェンジ、キューの永続性とキュー再開機能、新しいキュー設定を追加しました。テストを修正しました。[#12761](https://github.com/ClickHouse/ClickHouse/pull/12761) ([Kseniia Sumarokova](https://github.com/kssenii))。
- コンパクトパーツでカスタムコーデックをサポートしました。[#12183](https://github.com/ClickHouse/ClickHouse/pull/12183) ([Anton Popov](https://github.com/CurtizJ))。

#### パフォーマンス改善 {#performance-improvement-4}


- `optimize_skip_unused_shards`および`optimize_distributed_group_by_sharding_key`設定下で、GROUP BY sharding_keyを使用した分散クエリにおけるLIMIT/LIMIT BY/ORDER BYを最適化。[#10373](https://github.com/ClickHouse/ClickHouse/pull/10373) ([Azat Khuzhin](https://github.com/azat))。
- 複数の`JOIN`および`IN`に対するセットを並列作成。複数の異なる`IN subquery`式を含むクエリのパフォーマンスがわずかに向上する可能性があります。[#14412](https://github.com/ClickHouse/ClickHouse/pull/14412) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 各コンシューマーに独立したスレッドを提供することでKafkaエンジンのパフォーマンスを向上。ストリーミングエンジン(Kafkaなど)用の独立したスレッドプール。[#13939](https://github.com/ClickHouse/ClickHouse/pull/13939) ([fastio](https://github.com/fastio))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-6}

- `Functions`からデバッグ情報を削除することでデバッグビルドのバイナリサイズを削減。これは非常に古いリンカーを使用しているYandexの1つの内部プロジェクトにのみ必要です。[#14549](https://github.com/ClickHouse/ClickHouse/pull/14549) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- clang 11でのビルドに向けた準備。[#14455](https://github.com/ClickHouse/ClickHouse/pull/14455) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- バックポートスクリプトのロジックを修正。以前のバージョンでは100%赤色のラベルに対してトリガーされていました。これは奇妙な動作でした。[#14433](https://github.com/ClickHouse/ClickHouse/pull/14433) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 統合テストではデフォルトのベース設定を使用。すべての設定変更は、インスタンスのmain_configs、user_configs、dictionariesパラメータで明示的に指定されます。[#13647](https://github.com/ClickHouse/ClickHouse/pull/13647) ([Ilya Yatsishin](https://github.com/qoega))。


## ClickHouse リリース 20.8 {#clickhouse-release-208}

### ClickHouse リリース v20.8.12.2-lts, 2021-01-16 {#clickhouse-release-v208122-lts-2021-01-16}

#### バグ修正 {#bug-fix-16}

- 単項関数とNullable型を使用した\*Ifコンビネータの問題を修正しました。[#18806](https://github.com/ClickHouse/ClickHouse/pull/18806) ([Azat Khuzhin](https://github.com/azat))。
- wideパートからcompactパートへのマージを制限しました。垂直マージの場合、結果パートが破損していました。[#18381](https://github.com/ClickHouse/ClickHouse/pull/18381) ([Anton Popov](https://github.com/CurtizJ))。

### ClickHouse リリース v20.8.11.17-lts, 2020-12-25 {#clickhouse-release-v2081117-lts-2020-12-25}

#### バグ修正 {#bug-fix-17}

- マージ中のAIOによる書き込みを無効化しました。マージ時に主キー列の極めて稀なデータ破損を引き起こす可能性があるためです。[#18481](https://github.com/ClickHouse/ClickHouse/pull/18481) ([alesapin](https://github.com/alesapin))。
- `Nullable(String)`型の引数で`toType(...)`関数(`toDate`、`toUInt32`など)を実行する際の`value is too short`エラーを修正しました。これらの関数は、パースエラー時に例外をスローする代わりに`NULL`を返すようになりました。[#7673](https://github.com/ClickHouse/ClickHouse/issues/7673)を修正。[#18445](https://github.com/ClickHouse/ClickHouse/pull/18445) ([tavplubix](https://github.com/tavplubix))。
- 2レベル集約を使用する際の`Distinct`コンビネータを持つ集約関数で発生する可能性のあるクラッシュを修正しました。[#17682](https://github.com/ClickHouse/ClickHouse/issues/17682)を修正。[#18365](https://github.com/ClickHouse/ClickHouse/pull/18365) ([Anton Popov](https://github.com/CurtizJ))。

### ClickHouse リリース v20.8.10.13-lts, 2020-12-24 {#clickhouse-release-v2081013-lts-2020-12-24}

#### バグ修正 {#bug-fix-18}


* `logger.size` パラメータに 2^32 より大きい数値を設定してサーバーログのローテーションを構成した場合、ログが正しくローテーションされませんでした。 [#17905](https://github.com/ClickHouse/ClickHouse/pull/17905) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* `MergeTreeWriterSettings` において、`max_compress_block_size` が誤って `min_compress_block_size` で初期化されていた問題を修正しました。 [#17833](https://github.com/ClickHouse/ClickHouse/pull/17833) ([flynn](https://github.com/ucasFL)).
* ClickHouse が MySQL サーバーへの接続を再開できない問題を修正しました。 [#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz))。
* 対応する mutation が別のレプリカ上で kill された場合に `ALTER` クエリがハングする問題を修正しました。これにより [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953) が解決されます。 [#17499](https://github.com/ClickHouse/ClickHouse/pull/17499) ([alesapin](https://github.com/alesapin))。
* 多数の小さなファイルに `marks` が存在する場合に、ClickHouse が `mark cache` のサイズを過小評価してしまう不具合を修正しました。 [#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin)).
* 設定 `optimize_redundant_functions_in_order_by` 有効時の `ORDER BY` の動作を修正。 [#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* `ColumnConst` の比較が原因でクラッシュが発生する問題を修正しました。これにより [#17088](https://github.com/ClickHouse/ClickHouse/issues/17088) が解決されました。 [#17135](https://github.com/ClickHouse/ClickHouse/pull/17135) ([Amos Bird](https://github.com/amosbird))。
* 非リーダーの ReplicatedMergeTree テーブルに対する `ON CLUSTER` クエリが無限にハングする可能性があったバグを修正。 [#17089](https://github.com/ClickHouse/ClickHouse/pull/17089) ([alesapin](https://github.com/alesapin)).
* `LIMIT` を含むクエリなど、実行中にキャンセルされる可能性のあるリモートクエリで発生しうる不要なネットワークエラーを回避します。 [#17006](https://github.com/ClickHouse/ClickHouse/pull/17006) ([Azat Khuzhin](https://github.com/azat)).
* エラー発生時に `format_avro_schema_registry_url` の IP を再解決するように変更。 [#16985](https://github.com/ClickHouse/ClickHouse/pull/16985) ([filimonov](https://github.com/filimonov)).
* `ALTER` がまだ完了していない状態で、変更中のカラムに対して `WHERE` 句を含む `SELECT` が実行されているときに、`ALTER TABLE ... MODIFY COLUMN ... NewType` 実行後にサーバーがクラッシュする可能性があった問題を修正しました。 [#16968](https://github.com/ClickHouse/ClickHouse/pull/16968) ([Amos Bird](https://github.com/amosbird))。
* インストールスクリプトは、設定フォルダ内にサブディレクトリを常に作成する必要があります。これはカスタム設定を使用する Docker ビルドにのみ該当します。 [#16936](https://github.com/ClickHouse/ClickHouse/pull/16936) ([filimonov](https://github.com/filimonov)).
* `ORDER BY` を含むクエリで発生しうる `Illegal type of argument` エラーを修正しました。 [#16580](https://github.com/ClickHouse/ClickHouse/issues/16580) の修正。 [#16928](https://github.com/ClickHouse/ClickHouse/pull/16928) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* WriteBufferFromS3 にデータが書き込まれなかった場合は、マルチパートアップロードを中止するようにしました。 [#16840](https://github.com/ClickHouse/ClickHouse/pull/16840) ([Pavel Kovalenko](https://github.com/Jokser)).
* 引数なしで `any` を使用した場合にクラッシュする問題を修正しました。これにより [#16803](https://github.com/ClickHouse/ClickHouse/issues/16803) が解決されます。 [#16826](https://github.com/ClickHouse/ClickHouse/pull/16826)（[Amos Bird](https://github.com/amosbird)）。
* `transform_null_in` 設定有効時に、複数列およびタプルに対する `IN` 演算子が正しく動作しない問題を修正しました。 [#15310](https://github.com/ClickHouse/ClickHouse/issues/15310) を修正。 [#16722](https://github.com/ClickHouse/ClickHouse/pull/16722)（[Anton Popov](https://github.com/CurtizJ)）。
* `max_threads` &gt; 0 で、かつ ORDER BY 句に式を含む場合における `optimize_read_in_order/optimize_aggregation_in_order` の一貫性のない動作を修正。[#16637](https://github.com/ClickHouse/ClickHouse/pull/16637) ([Azat Khuzhin](https://github.com/azat)).
* クエリに `ARRAY JOIN` が含まれている場合に、クエリ最適化により誤った結果が生成される問題を修正しました。 [#17887](https://github.com/ClickHouse/ClickHouse/pull/17887) ([sundyli](https://github.com/sundy-li))。
* 例外が発生した場合にクエリをより早く終了できるようにしました。例外発生時にはリモートレプリカでの実行をキャンセルします。 [#15578](https://github.com/ClickHouse/ClickHouse/pull/15578) ([Azat Khuzhin](https://github.com/azat)).

### ClickHouse release v20.8.6.6-lts, 2020-11-13 {#clickhouse-release-v20866-lts-2020-11-13}

#### バグ修正 {#bug-fix-19}

- クエリプロファイラが有効で、一部の関数に対して非同期アンワインドテーブルが破損している（と推定される）glibcバージョンを持つOSにClickHouseがインストールされている場合に発生する稀なサイレントクラッシュを修正しました。これにより[#15301](https://github.com/ClickHouse/ClickHouse/issues/15301)が修正されます。これにより[#13098](https://github.com/ClickHouse/ClickHouse/issues/13098)が修正されます。[#16846](https://github.com/ClickHouse/ClickHouse/pull/16846) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 入力からAVROを解析する際に、型からLowCardinalityが削除されるようになりました。[#16188](https://github.com/ClickHouse/ClickHouse/issues/16188)を修正します。[#16521](https://github.com/ClickHouse/ClickHouse/pull/16521) ([Mike](https://github.com/myrrc))。
- MySQL Master -> MySQL Slave -> ClickHouse MaterializeMySQL Engineを使用し、MySQL Slaveで`slave_parallel_worker`が有効になっている場合のメタデータの急速な増加を、GTIDセットを適切に縮小することで修正しました。これにより[#15951](https://github.com/ClickHouse/ClickHouse/issues/15951)が修正されます。[#16504](https://github.com/ClickHouse/ClickHouse/pull/16504) ([TCeason](https://github.com/TCeason))。
- Distributedテーブルに対するDROP TABLE（INSERTとの競合状態）を修正しました。[#16409](https://github.com/ClickHouse/ClickHouse/pull/16409) ([Azat Khuzhin](https://github.com/azat))。
- レプリケーションキュー内の非常に大きなエントリの処理を修正しました。テーブル構造が極端に大きい場合（1MB近く）、ALTERクエリで非常に大きなエントリが出現する可能性があります。これにより[#16307](https://github.com/ClickHouse/ClickHouse/issues/16307)が修正されます。[#16332](https://github.com/ClickHouse/ClickHouse/pull/16332) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- フィルタリング用のセットが作成されていないために返却データの一部がドロップされる可能性がある不整合な動作を修正しました。[#16308](https://github.com/ClickHouse/ClickHouse/pull/16308) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- MySQLデータベースに関するバグを修正しました。データベースエンジンとして使用されているMySQLサーバーがダウンしている場合、一部のクエリが不要にもかかわらず無効なサーバーからテーブルを取得しようとするため、例外が発生していました。例えば、`SELECT ... FROM system.parts`クエリはMergeTreeテーブルのみで動作すべきであり、MySQLデータベースには一切アクセスすべきではありません。[#16032](https://github.com/ClickHouse/ClickHouse/pull/16032) ([Kruglov Pavel](https://github.com/Avogar))。

### ClickHouse release v20.8.5.45-lts, 2020-10-29 {#clickhouse-release-v208545-lts-2020-10-29}

#### バグ修正 {#bug-fix-20}


* `dictGet` 関数で、例外発生時に二重解放が起きる不具合を修正しました。これは、辞書の読み込み時にエラーが発生した場合に起こり得ました。 [#16429](https://github.com/ClickHouse/ClickHouse/pull/16429) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `GROUP BY` に対する `WITH TOTALS` / `ROLLUP` / `CUBE` 修飾子と、グループキー上の `min` / `max` 関数の動作を修正。[#16393](https://github.com/ClickHouse/ClickHouse/issues/16393) を修正。 [#16397](https://github.com/ClickHouse/ClickHouse/pull/16397) ([Anton Popov](https://github.com/CurtizJ)).
* `prefer_localhost_replica=0` かつ内部レプリケーション使用時の非同期 Distributed `INSERT` の問題を修正。 [#16358](https://github.com/ClickHouse/ClickHouse/pull/16358) ([Azat Khuzhin](https://github.com/azat))。
* `TwoLevelStringHashTable` の実装上の不具合が原因で、文字列キーを用いた `GROUP BY` 実行時に発生する可能性があったメモリリークを修正しました。 [#16264](https://github.com/ClickHouse/ClickHouse/pull/16264) ([Amos Bird](https://github.com/amosbird))。
* メモリが制限に関係なく過剰に割り当てられてしまうケースを修正しました。これにより [#14560](https://github.com/ClickHouse/ClickHouse/issues/14560) がクローズされました。 [#16206](https://github.com/ClickHouse/ClickHouse/pull/16206) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `ReplicatedVersionedCollapsingMergeTree` に対する `ALTER MODIFY ... ORDER BY` クエリがハングする問題を修正。これにより [#15980](https://github.com/ClickHouse/ClickHouse/issues/15980) が解決されます。 [#16011](https://github.com/ClickHouse/ClickHouse/pull/16011)（[alesapin](https://github.com/alesapin)）。
* `collate name` と `charset name` のパーサーを修正し、文字列型での `length = 0` をサポートしました。 [#16008](https://github.com/ClickHouse/ClickHouse/pull/16008) ([Winter Zhang](https://github.com/zhang2014))。
* 複雑なキーを持つ辞書でダイレクトレイアウトを使用できるようにしました。 [#16007](https://github.com/ClickHouse/ClickHouse/pull/16007) ([Anton Popov](https://github.com/CurtizJ)).
* 非アクティブな期間の後にレプリケーションエラーが発生した場合に、レプリカが5～10分間ハングするのを防ぎます。 [#15987](https://github.com/ClickHouse/ClickHouse/pull/15987) ([filimonov](https://github.com/filimonov)).
* MaterializedView への挿入または MaterializedView からの選択中に、同時に対象テーブルが削除されるとまれに発生するセグメンテーションフォールトを修正しました（`Atomic` データベースエンジンの場合）。 [#15984](https://github.com/ClickHouse/ClickHouse/pull/15984) ([tavplubix](https://github.com/tavplubix)).
* 設定プロファイルのパース時の曖昧さを修正しました。`CREATE USER ... SETTINGS profile readonly` は、`readonly` という名前のプロファイルを使用していると解釈されるようになり、`readonly` 制約付きの `profile` という名前の設定を使用しているとは解釈されなくなりました。これにより、[#15628](https://github.com/ClickHouse/ClickHouse/issues/15628) が修正されました。[#15982](https://github.com/ClickHouse/ClickHouse/pull/15982)（[Vitaly Baranov](https://github.com/vitlibar)）。
* データベース作成に失敗した場合にクラッシュが発生する問題を修正。 [#15954](https://github.com/ClickHouse/ClickHouse/pull/15954) ([Winter Zhang](https://github.com/zhang2014)).
* `Atomic` データベースエンジンにおいて、テーブルが同時にリネームされた場合に `DROP TABLE IF EXISTS` が `Table ... does not exist` エラーで失敗する問題を修正しました。複数テーブルに対する一部の DDL クエリ（`DROP DATABASE` や `RENAME TABLE` など）を同時に実行した際に発生する、まれなデッドロックを修正しました。`DROP/DETACH TABLE` を同時に実行しているときに、`DROP/DETACH DATABASE` が `Table ... does not exist` エラーで失敗する問題を修正しました。 [#15934](https://github.com/ClickHouse/ClickHouse/pull/15934) ([tavplubix](https://github.com/tavplubix)).
* `WHERE`、`PREWHERE`、`GLOBAL IN` を含むクエリを `Distributed` テーブルに対して実行した際に、結果が誤って空になってしまう問題を修正しました。 [#15792](https://github.com/ClickHouse/ClickHouse/issues/15792) を修正。 [#15933](https://github.com/ClickHouse/ClickHouse/pull/15933)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* RBAC におけるデッドロックが発生する可能性を修正。 [#15875](https://github.com/ClickHouse/ClickHouse/pull/15875) ([Vitaly Baranov](https://github.com/vitlibar)).
* `ALTER MODIFY COLUMN` クエリの実行後に実行された `SELECT ... ORDER BY DESC` クエリで発生していた `Block structure mismatch` 例外を修正しました。これは [#15800](https://github.com/ClickHouse/ClickHouse/issues/15800) を修正するものです。[#15852](https://github.com/ClickHouse/ClickHouse/pull/15852)（[alesapin](https://github.com/alesapin)）。
* 仮想カラムのみが選択されている一部のクエリを修正しました。以前は `Not found column _nothing in block` という例外がスローされる可能性がありました。[#12298](https://github.com/ClickHouse/ClickHouse/issues/12298) を修正。[#15756](https://github.com/ClickHouse/ClickHouse/pull/15756)（[Anton Popov](https://github.com/CurtizJ)）。
* `ARRAY JOIN` を含む `MV` 用のクエリにおいて、`MATERIALIZED VIEW` への挿入時に発生する可能性がある `Cannot find column` エラーを修正しました。 [#15717](https://github.com/ClickHouse/ClickHouse/pull/15717) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `max_replicated_logs_to_keep` 設定のデフォルト値が低すぎた問題を修正しました。この問題により、レプリカが頻繁に lost 状態になる可能性がありました。最も新しいレプリカをクローン元として選択することで、lost レプリカのリカバリ処理を改善しました。また、lost レプリカから古いパーツを削除せず、代わりに detach するようにしました。 [#15701](https://github.com/ClickHouse/ClickHouse/pull/15701) ([tavplubix](https://github.com/tavplubix)).
* 宛先テーブルとは異なる構造を持つ `Buffer` テーブルから読み込む際、クエリに対して宛先テーブルが空の結果を返す場合に発生し得たエラー `Cannot add simple transform to empty Pipe` を修正しました。 [#15529](https://github.com/ClickHouse/ClickHouse/issues/15529) を修正。 [#15662](https://github.com/ClickHouse/ClickHouse/pull/15662)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* S3 テーブル関数におけるグロブのバグを修正しました。URL のリージョンが S3 クライアント設定に適用されていませんでした。 [#15646](https://github.com/ClickHouse/ClickHouse/pull/15646) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 読み取り専用テーブルをデタッチする際に `ReadonlyReplica` メトリクスをデクリメントします。これにより [#15598](https://github.com/ClickHouse/ClickHouse/issues/15598) が修正されます。[#15592](https://github.com/ClickHouse/ClickHouse/pull/15592)（[sundyli](https://github.com/sundy-li)）。
* 単一のパラメータが `ReplicatedMergeTree` に渡された場合、これまで無視していた動作をやめてエラーをスローするようにしました。 [#15516](https://github.com/ClickHouse/ClickHouse/pull/15516) ([nvartolomei](https://github.com/nvartolomei)).

#### 改善 {#improvement-9}

- クラスタ設定の `<internal_replication>` 設定に関わらず、`ALTER ... ON CLUSTER` クエリを実行できるようになりました。[#16075](https://github.com/ClickHouse/ClickHouse/pull/16075) ([alesapin](https://github.com/alesapin))。
- テーブル作成時に `ReplicatedMergeTree` 引数内の `{database}`、`{table}`、`{uuid}` マクロを展開するようになりました。[#16159](https://github.com/ClickHouse/ClickHouse/pull/16159) ([tavplubix](https://github.com/tavplubix))。

### ClickHouse リリース v20.8.4.11-lts, 2020-10-09 {#clickhouse-release-v208411-lts-2020-10-09}

#### バグ修正 {#bug-fix-21}


* クエリプランの `ReadFromStorage` ステップにおけるリソースの破棄順序を修正しました。まれなケースでクラッシュを引き起こす可能性がありました。[#15610](https://github.com/ClickHouse/ClickHouse/issues/15610) に関連している可能性があります。[#15645](https://github.com/ClickHouse/ClickHouse/pull/15645)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `VALUES`、`LIMIT`、または `IN` 演算子の右辺で `JSON*` 関数の結果を使用した際に発生していた `Element ... is not a constant expression` エラーを修正しました。 [#15589](https://github.com/ClickHouse/ClickHouse/pull/15589) ([tavplubix](https://github.com/tavplubix)).
* エラーメッセージ `Could not calculate available disk space (statvfs), errno: 4, strerror: Interrupted system call` が発生しないようにしました。これにより [#15541](https://github.com/ClickHouse/ClickHouse/issues/15541) が修正されました。 [#15557](https://github.com/ClickHouse/ClickHouse/pull/15557) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* AggregatingInOrderTransform/optimize&#95;aggregation&#95;in&#95;order におけるメモリ使用量を大幅に削減しました。 [#15543](https://github.com/ClickHouse/ClickHouse/pull/15543) ([Azat Khuzhin](https://github.com/azat)).
* `MOVE` や `REPLACE PARTITION` の後、存在しないパーツを待ち続けてミューテーションがハングすることがあり、まれに `DETACH` や `DROP PARTITION` の後に発生する場合もありました。この問題を修正しました。 [#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix)).
* 同じパターンで `LIKE` を実行した後に、`ILIKE` 演算子が大文字小文字を区別しない動作をしなくなるバグを修正しました。 [#15536](https://github.com/ClickHouse/ClickHouse/pull/15536) ([alesapin](https://github.com/alesapin)).
* データ内に存在しない列で、さらに同じくデータ内に存在しない他の列に依存している列を `SELECT` した際に発生する `Missing columns` エラーを修正しました。 [#15530](https://github.com/ClickHouse/ClickHouse/issues/15530) を修正。 [#15532](https://github.com/ClickHouse/ClickHouse/pull/15532)（[alesapin](https://github.com/alesapin)）。
* DDLWorker におけるイベント購読のバグを修正しました。まれに `ON CLUSTER` でクエリがハングする原因となる可能性がありました。[#13450](https://github.com/ClickHouse/ClickHouse/issues/13450) で導入された不具合です。[#15477](https://github.com/ClickHouse/ClickHouse/pull/15477)（[alesapin](https://github.com/alesapin)）。
* `boundingRatio` 集約関数の 2 番目の引数の型が不正な場合に、適切なエラーを報告するようにしました。 [#15407](https://github.com/ClickHouse/ClickHouse/pull/15407) ([detailyang](https://github.com/detailyang)).
* MergeTree テーブルの名前変更とバックグラウンドでのクリーンアップ時に発生するレースコンディションを修正。 [#15304](https://github.com/ClickHouse/ClickHouse/pull/15304) ([alesapin](https://github.com/alesapin)).
* `system.logs` が有効な場合のサーバー起動時に発生し得るまれなレースコンディションを修正。 [#15300](https://github.com/ClickHouse/ClickHouse/pull/15300) ([alesapin](https://github.com/alesapin)).
* QueryLog における MSan レポートを修正。初期化されていないメモリがフィールド `memory_usage` に使用されていた可能性があります。 [#15258](https://github.com/ClickHouse/ClickHouse/pull/15258) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* LowCardinality 型と共に joinGet を使用した際に発生するインスタンスのクラッシュを修正します。これにより [#15214](https://github.com/ClickHouse/ClickHouse/issues/15214) が解決されます。 [#15220](https://github.com/ClickHouse/ClickHouse/pull/15220) ([Amos Bird](https://github.com/amosbird)).
* テーブルエンジン `Buffer` において、`ALTER` クエリの後に新しい構造のデータを `Buffer` に挿入できなくなっていたバグを修正しました。[#15117](https://github.com/ClickHouse/ClickHouse/issues/15117) を修正。[#15192](https://github.com/ClickHouse/ClickHouse/pull/15192)（[alesapin](https://github.com/alesapin)）。
* MySQL のカラム定義パケット内の小数フィールドサイズを調整しました。 [#15152](https://github.com/ClickHouse/ClickHouse/pull/15152) ([maqroll](https://github.com/maqroll)).
* `String` と `FixedString` 間の比較では、すでにパディング付き比較を使用しています（[https://github.com/ClickHouse/ClickHouse/blob/master/src/Functions/FunctionsComparison.h#L333](https://github.com/ClickHouse/ClickHouse/blob/master/src/Functions/FunctionsComparison.h#L333)）。この PR は同じロジックをフィールド比較にも適用し、`FixedString` を主キーとして使用する際の挙動を正しくします。これにより [#14908](https://github.com/ClickHouse/ClickHouse/issues/14908) が修正されます。[#15033](https://github.com/ClickHouse/ClickHouse/pull/15033)（[Amos Bird](https://github.com/amosbird)）。
* 関数 `bar` が細工された特定の引数で呼び出された場合、バッファオーバーフローが発生する可能性がありました。これにより [#13926](https://github.com/ClickHouse/ClickHouse/issues/13926) が解決されました。[#15028](https://github.com/ClickHouse/ClickHouse/pull/15028)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* Mac OS 上の docker で clickhouse-server を実行しているときに、Atomic データベースでの DDL クエリ実行時に発生していた `Cannot rename ... errno: 22, strerror: Invalid argument` エラーを修正しました。[#15024](https://github.com/ClickHouse/ClickHouse/pull/15024) ([tavplubix](https://github.com/tavplubix))。
* `number_of_free_entries_in_pool_to_execute_mutation` と `number_of_free_entries_in_pool_to_lower_max_size_of_merge` の設定は、`background_pool_size` と同じ値に設定できるようになりました。 [#14975](https://github.com/ClickHouse/ClickHouse/pull/14975) ([alesapin](https://github.com/alesapin))。
* `subquery` が `finalizeAggregation` 関数を含む場合にも `predicate push down` が機能するように修正。[#14847](https://github.com/ClickHouse/ClickHouse/issues/14847) を解決。[#14937](https://github.com/ClickHouse/ClickHouse/pull/14937)（[filimonov](https://github.com/filimonov)）。
* `system.asynchronous_metrics` で論理コアごとの CPU 周波数を公開するようにしました。これにより [#14923](https://github.com/ClickHouse/ClickHouse/issues/14923) が修正されます。 [#14924](https://github.com/ClickHouse/ClickHouse/pull/14924) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* `MaterializeMySQL` データベースエンジン使用時に発生していた `.metadata.tmp File exists` エラーを修正しました。 [#14898](https://github.com/ClickHouse/ClickHouse/pull/14898) ([Winter Zhang](https://github.com/zhang2014)).
* `from_zk` インクルードオプションを使用して ZK から設定ファイルを取得する必要がある場合に、ZooKeeper との通信中にサーバーが起動時にハングする可能性がある問題を修正しました。これにより [#14814](https://github.com/ClickHouse/ClickHouse/issues/14814) が修正されました。[#14843](https://github.com/ClickHouse/ClickHouse/pull/14843)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 符号付き型に対する縮小された `Int -> Int` キャストの誤った単調性判定を修正しました。これにより、クエリ結果が不正になる可能性がありました。このバグは [#14513](https://github.com/ClickHouse/ClickHouse/issues/14513) で明らかになりました。[#14783](https://github.com/ClickHouse/ClickHouse/pull/14783)（[Amos Bird](https://github.com/amosbird)）。
* `Nullable` カラムの誤ったソート順を修正しました。これにより [#14344](https://github.com/ClickHouse/ClickHouse/issues/14344) が解決されました。[#14495](https://github.com/ClickHouse/ClickHouse/pull/14495)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。

#### 改善 {#improvement-10}

- `ALTER`クエリで`VersionedCollapsingMergeTree`のバージョンカラムの型を変更できるようになりました。[#15442](https://github.com/ClickHouse/ClickHouse/pull/15442) ([alesapin](https://github.com/alesapin))。

### ClickHouseリリース v20.8.3.18-stable、2020-09-18 {#clickhouse-release-v208318-stable-2020-09-18}

#### バグ修正 {#bug-fix-22}

- `extractAllGroups`関数の一部の呼び出しで「メモリ制限超過」エラーが発生する問題を修正しました。これにより[#13383](https://github.com/ClickHouse/ClickHouse/issues/13383)が修正されます。[#14889](https://github.com/ClickHouse/ClickHouse/pull/14889) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- StorageFile(fd)へのINSERT試行時のSIGSEGVを修正しました。[#14887](https://github.com/ClickHouse/ClickHouse/pull/14887) ([Azat Khuzhin](https://github.com/azat))。
- クエリ対象のカラムが`DEFAULT`式を持ち、その式が別の`DEFAULT`を持つカラムに依存しており、そのカラムがselectクエリに存在せず、ディスク上にも存在しない場合に発生する`SELECT`クエリの稀なエラーを修正しました。[#14531](https://github.com/ClickHouse/ClickHouse/issues/14531)を部分的に修正します。[#14845](https://github.com/ClickHouse/ClickHouse/pull/14845) ([alesapin](https://github.com/alesapin))。
- `ALTER ... MODIFY QUERY`実行時にマテリアライズドビューのメタデータでデフォルトデータベース名が欠落する問題を修正しました。[#14664](https://github.com/ClickHouse/ClickHouse/pull/14664) ([tavplubix](https://github.com/tavplubix))。
- 代入式にNullableカラムと定数値を含む`ALTER UPDATE`ミューテーション（`UPDATE x = 42`など）がカラムの不正な値やセグメンテーション違反を引き起こすバグを修正しました。[#13634](https://github.com/ClickHouse/ClickHouse/issues/13634)、[#14045](https://github.com/ClickHouse/ClickHouse/issues/14045)を修正します。[#14646](https://github.com/ClickHouse/ClickHouse/pull/14646) ([alesapin](https://github.com/alesapin))。
- 結果カラムの誤った小数スケールによって引き起こされる誤ったDecimal乗算結果を修正しました。[#14603](https://github.com/ClickHouse/ClickHouse/pull/14603) ([Artem Zuikov](https://github.com/4ertus2))。
- `lc->isNullable()`の呼び出しも`ls->getDictionaryPtr()->isNullable()`の呼び出しも正しい結果を返さないため、チェッカーを追加しました。[#14591](https://github.com/ClickHouse/ClickHouse/pull/14591) ([myrrc](https://github.com/myrrc))。
- StorageReplicatedMergeTreeエンジンのCreateQuery中にZookeeper例外が発生した後、データディレクトリをクリーンアップするようにしました。[#14563](https://github.com/ClickHouse/ClickHouse/pull/14563) ([Bharat Nallan](https://github.com/bharatnc))。
- 非常に大きなパラメータによるオーバーフローの結果として発生する可能性がある、-Resampleコンビネータを持つ関数での稀なセグメンテーション違反を修正しました。[#14562](https://github.com/ClickHouse/ClickHouse/pull/14562) ([Anton Popov](https://github.com/CurtizJ))。

#### 改善 {#improvement-11}

- 進行中のS3リクエストがある場合のサーバーシャットダウンプロセスを高速化しました。[#14858](https://github.com/ClickHouse/ClickHouse/pull/14858) ([Pavel Kovalenko](https://github.com/Jokser))。
- Distributedストレージでマルチボリュームストレージ構成を使用できるようにしました。[#14839](https://github.com/ClickHouse/ClickHouse/pull/14839) ([Pavel Kovalenko](https://github.com/Jokser))。
- 進行中のS3リクエストがある場合のサーバーシャットダウンプロセスを高速化しました。[#14496](https://github.com/ClickHouse/ClickHouse/pull/14496) ([Pavel Kovalenko](https://github.com/Jokser))。
- コンパクトパートでカスタムコーデックをサポートしました。[#12183](https://github.com/ClickHouse/ClickHouse/pull/12183) ([Anton Popov](https://github.com/CurtizJ))。

### ClickHouseリリース v20.8.2.3-stable、2020-09-08 {#clickhouse-release-v20823-stable-2020-09-08}

#### 後方互換性のない変更 {#backward-incompatible-change-4}


- `OPTIMIZE FINAL`クエリは、TTL作成前に追加されたパートに対してTTLを再計算しなくなりました。`ALTER TABLE ... MATERIALIZE TTL`を一度実行してTTLを計算した後、`OPTIMIZE FINAL`はTTLを適切に評価します。この動作はレプリケートテーブルでは従来機能していませんでした。[#14220](https://github.com/ClickHouse/ClickHouse/pull/14220) ([alesapin](https://github.com/alesapin))。
- `parallel_distributed_insert_select`設定を拡張し、ローカルテーブルへの`INSERT`を実行するオプションを追加しました。この設定の型が`Bool`から`UInt64`に変更されたため、`false`と`true`の値はサポートされなくなりました。サーバー設定にこれらの値がある場合、サーバーは起動しません。それぞれ`0`と`1`に置き換えてください。[#14060](https://github.com/ClickHouse/ClickHouse/pull/14060) ([Azat Khuzhin](https://github.com/azat))。
- `ODBCDriver`入出力フォーマットのサポートを削除しました。これはClickHouse ODBCドライバーとの通信に使用されていた非推奨のフォーマットで、現在は`ODBCDriver2`フォーマットに完全に置き換えられています。[#13629](https://github.com/ClickHouse/ClickHouse/issues/13629)を解決します。[#13847](https://github.com/ClickHouse/ClickHouse/pull/13847) ([hexiaoting](https://github.com/hexiaoting))。
- 20.5より古いバージョンからアップグレードする際、ローリングアップデートを実行し、クラスターに20.5以上のバージョンと20.5未満のバージョンが混在している場合、古いバージョンのClickHouseノードを再起動すると、新しいバージョンが存在する状態で古いバージョンが起動し、`Part ... intersects previous part`エラーが発生する可能性があります。このエラーを防ぐには、まずすべてのクラスターノードに新しいclickhouse-serverパッケージをインストールしてから再起動を実行してください(これにより、clickhouse-serverの再起動時に新しいバージョンで起動します)。

#### 新機能 {#new-feature-4}


- `config.xml`で指定された設定に対応するカラムに対して`Default`圧縮コーデックを指定できる機能を追加しました。実装: [#9074](https://github.com/ClickHouse/ClickHouse/issues/9074). [#14049](https://github.com/ClickHouse/ClickHouse/pull/14049) ([alesapin](https://github.com/alesapin)).
- `krb5`および`cyrus-sasl`ライブラリを使用したKafkaでのKerberos認証をサポートしました。[#12771](https://github.com/ClickHouse/ClickHouse/pull/12771) ([Ilya Golshtein](https://github.com/ilejn)).
- リテラル、リテラルのシーケンス、複雑なエイリアスをプレースホルダーに置き換える`normalizeQuery`関数を追加しました。類似したクエリに対して同一の64ビットハッシュ値を返す`normalizedQueryHash`関数を追加しました。これによりクエリログの分析が容易になります。[#11271](https://github.com/ClickHouse/ClickHouse/issues/11271)を解決しました。[#13816](https://github.com/ClickHouse/ClickHouse/pull/13816) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- `time_zones`テーブルを追加しました。[#13880](https://github.com/ClickHouse/ClickHouse/pull/13880) ([Bharat Nallan](https://github.com/bharatnc)).
- 指定された型のデフォルト値を返す`defaultValueOfTypeName`関数を追加しました。[#13877](https://github.com/ClickHouse/ClickHouse/pull/13877) ([hcz](https://github.com/hczhcz)).
- 整数またはDecimalカラムの10進数桁数をカウントする`countDigits(x)`関数を追加しました。Decimalカラムの値がその精度(または指定された精度)を超えているかどうかをチェックする`isDecimalOverflow(d, [p])`関数を追加しました。[#14151](https://github.com/ClickHouse/ClickHouse/pull/14151) ([Artem Zuikov](https://github.com/4ertus2)).
- `quantileExactLow`および`quantileExactHigh`の実装を追加し、それぞれ`medianExactLow`および`medianExactHigh`のエイリアスを提供しました。[#13818](https://github.com/ClickHouse/ClickHouse/pull/13818) ([Bharat Nallan](https://github.com/bharatnc)).
- 日付/時刻値を指定された日付/時刻部分に切り捨てる`date_trunc`関数を追加しました。[#13888](https://github.com/ClickHouse/ClickHouse/pull/13888) ([Vladimir Golovchenko](https://github.com/vladimir-golovchenko)).
- メイン設定ファイルに新しいオプションセクション`<user_directories>`を追加しました。[#13425](https://github.com/ClickHouse/ClickHouse/pull/13425) ([Vitaly Baranov](https://github.com/vitlibar)).
- テーブルのサンプル句を変更できる`ALTER SAMPLE BY`ステートメントを追加しました。[#13280](https://github.com/ClickHouse/ClickHouse/pull/13280) ([Amos Bird](https://github.com/amosbird)).
- `position`関数がオプションの`start_pos`引数をサポートするようになりました。[#13237](https://github.com/ClickHouse/ClickHouse/pull/13237) ([vdimir](https://github.com/vdimir)).

#### バグ修正 {#bug-fix-23}


* インタラクティブモードのクライアントにおいて、プログレスバーが表示中のデータを上書きしてしまう問題を修正しました。これにより、[#12562](https://github.com/ClickHouse/ClickHouse/issues/12562)、[#13369](https://github.com/ClickHouse/ClickHouse/issues/13369)、[#13584](https://github.com/ClickHouse/ClickHouse/issues/13584)、および [#12964](https://github.com/ClickHouse/ClickHouse/issues/12964) が修正されました。[#13691](https://github.com/ClickHouse/ClickHouse/pull/13691)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 複数のカラムでソートした際の `LowCardinality` カラムの誤ったソート順を修正しました。これにより [#13958](https://github.com/ClickHouse/ClickHouse/issues/13958) が解決されました。 [#14223](https://github.com/ClickHouse/ClickHouse/pull/14223) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* `topK` 集約関数で配列サイズのオーバーフローをチェックするようにしました。このチェックがない場合、ユーザーが細工したパラメータを含むクエリを送信することでサーバーをクラッシュさせる可能性があります。これにより [#14452](https://github.com/ClickHouse/ClickHouse/issues/14452) がクローズされました。 [#14467](https://github.com/ClickHouse/ClickHouse/pull/14467)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* テーブルに単一のパーツしか持たないパーティションがある場合に、マージの割り当てが誤って行われる不具合を修正しました。 [#14444](https://github.com/ClickHouse/ClickHouse/pull/14444) ([alesapin](https://github.com/alesapin)).
* `PipelineExecutor` 自体で例外が発生した場合はクエリの実行を停止します。これにより、まれに発生しうるクエリのハングを防ぐことができます。[#14334](https://github.com/ClickHouse/ClickHouse/issues/14334) のフォローアップです。[#14402](https://github.com/ClickHouse/ClickHouse/pull/14402) [#14334](https://github.com/ClickHouse/ClickHouse/pull/14334) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `AS table_function` で作成されたテーブルに対する `ALTER` クエリ実行時に発生していたクラッシュを修正。Issue [#14212](https://github.com/ClickHouse/ClickHouse/issues/14212) を修正。[#14326](https://github.com/ClickHouse/ClickHouse/pull/14326)（[alesapin](https://github.com/alesapin)）。
* `REFRESH` コマンドを伴う `ALTER LIVE VIEW` クエリの実行時に発生する例外を修正しました。`LIVE VIEW` は実験的な機能です。 [#14320](https://github.com/ClickHouse/ClickHouse/pull/14320) ([Bharat Nallan](https://github.com/bharatnc)).
* ネストされた interpreter を持つクエリに対して、EXPLAIN PIPELINE graph=1 における QueryPlan のライフタイムを修正しました。 [#14315](https://github.com/ClickHouse/ClickHouse/pull/14315) ([Azat Khuzhin](https://github.com/azat)).
* 一部の外部ソースからスキーマを取得する際に `clickhouse-odbc-bridge` で発生していたセグメンテーションフォルトを修正しました。このPRは [#13861](https://github.com/ClickHouse/ClickHouse/issues/13861) を解決します。 [#14267](https://github.com/ClickHouse/ClickHouse/pull/14267)（[Vitaly Baranov](https://github.com/vitlibar)）。
* [#12277](https://github.com/ClickHouse/ClickHouse/pull/12277) で導入されたマーク包含検索におけるクラッシュを修正。 [#14225](https://github.com/ClickHouse/ClickHouse/pull/14225) ([Amos Bird](https://github.com/amosbird))。
* 名前付きタプルを使用したテーブル作成の問題を修正しました。これにより [#13027](https://github.com/ClickHouse/ClickHouse/issues/13027) が解決されます。 [#14143](https://github.com/ClickHouse/ClickHouse/pull/14143) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 最小の負の小数の書式を修正しました。これにより [#14111](https://github.com/ClickHouse/ClickHouse/issues/14111) が修正されます。[#14119](https://github.com/ClickHouse/ClickHouse/pull/14119)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* `DistributedFilesToInsert` メトリクスの不具合を修正（本来ゼロになってはいけない場面でゼロになっていた問題）。 [#14095](https://github.com/ClickHouse/ClickHouse/pull/14095) ([Azat Khuzhin](https://github.com/azat)).
* `pointInPolygon` をポリゴンとして const 2 次元配列を使用した場合の動作を修正。 [#14079](https://github.com/ClickHouse/ClickHouse/pull/14079) ([Alexey Ilyukhov](https://github.com/livace)).
* `Poco::Exception: no space left on device` の追加情報に含まれていた誤ったマウントポイントを修正しました。 [#14050](https://github.com/ClickHouse/ClickHouse/pull/14050) ([tavplubix](https://github.com/tavplubix)).
* グローバルレベル以外で実行された場合の `GRANT ALL` ステートメントの動作を修正しました。 [#13987](https://github.com/ClickHouse/ClickHouse/pull/13987) ([Vitaly Baranov](https://github.com/vitlibar)).
* `create table as table function` と `engine` を同時に指定した文を拒否するようにパーサーを修正。 [#13940](https://github.com/ClickHouse/ClickHouse/pull/13940) ([hcz](https://github.com/hczhcz)).
* `optimize_duplicate_order_by_and_distinct` 設定が有効な場合に、`DISTINCT` キーワードと UNION ALL を含むサブクエリを用いた SELECT クエリで誤った結果が返される問題を修正。 [#13925](https://github.com/ClickHouse/ClickHouse/pull/13925) ([Artem Zuikov](https://github.com/4ertus2)).
* `Distributed` テーブルのリネーム時に発生する可能性があったデッドロックを修正しました。 [#13922](https://github.com/ClickHouse/ClickHouse/pull/13922) ([tavplubix](https://github.com/tavplubix)).
* 複数列でのソート時に `FixedString` 列で誤った並び替えが行われる問題を修正。 [#13182](https://github.com/ClickHouse/ClickHouse/issues/13182) を修正。 [#13887](https://github.com/ClickHouse/ClickHouse/pull/13887)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `topK`/`topKWeighted` のマージ時（非デフォルトパラメータ使用時）に結果が不正確になる可能性がある問題を修正しました。 [#13817](https://github.com/ClickHouse/ClickHouse/pull/13817) ([Azat Khuzhin](https://github.com/azat)).
* `INDEX` の型が `SET` の MergeTree テーブルから読み取る際に、`NULL` との比較で失敗する問題を修正しました。これにより [#13686](https://github.com/ClickHouse/ClickHouse/issues/13686) が修正されます。 [#13793](https://github.com/ClickHouse/ClickHouse/pull/13793) ([Amos Bird](https://github.com/amosbird)).
* lambda 内での `arrayJoin` のキャプチャ処理を修正（LOGICAL&#95;ERROR）。 [#13792](https://github.com/ClickHouse/ClickHouse/pull/13792) ([Azat Khuzhin](https://github.com/azat)).
* 関数 `range` にステップのオーバーフロー検査を追加しました。 [#13790](https://github.com/ClickHouse/ClickHouse/pull/13790) ([Azat Khuzhin](https://github.com/azat))。
* `DROP DATABASE` と `CREATE TABLE` を並行して実行した際に発生していた `Directory not empty` エラーを修正しました。 [#13756](https://github.com/ClickHouse/ClickHouse/pull/13756) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `h3KRing` 関数に範囲チェックを追加しました。これにより [#13633](https://github.com/ClickHouse/ClickHouse/issues/13633) が修正されます。[#13752](https://github.com/ClickHouse/ClickHouse/pull/13752)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* DETACH とバックグラウンドマージ間のレースコンディションを修正。`DETACH` 後にパーツが復活してしまう可能性がありました。これは [#8602](https://github.com/ClickHouse/ClickHouse/issues/8602) の対応の継続であり、同イシューでは問題自体は解決されず、代わりにこの問題を示す、ごくまれなケースで失敗し始めるテストが導入されていました。[#13746](https://github.com/ClickHouse/ClickHouse/pull/13746)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `log_queries_min_type` が `QUERY_START` より大きい場合におけるログの `Settings.Names/Values` を修正。 [#13737](https://github.com/ClickHouse/ClickHouse/pull/13737) ([Azat Khuzhin](https://github.com/azat)).
* verbose=1 のときの `/replicas_status` エンドポイントのレスポンスステータスコードを修正します。 [#13722](https://github.com/ClickHouse/ClickHouse/pull/13722) ([javi santana](https://github.com/javisantana)).
* ユーザーとグループの確認時に `clickhouse-server.init` が出力する誤ったメッセージを修正。 [#13711](https://github.com/ClickHouse/ClickHouse/pull/13711) ([ylchou](https://github.com/ylchou)).
* `optimize_move_functions_out_of_any` 設定が有効な場合に any(arrayJoin()) -&gt; arrayJoin() という最適化を行わないようにしました。 [#13681](https://github.com/ClickHouse/ClickHouse/pull/13681) ([Azat Khuzhin](https://github.com/azat)).
* StorageMerge を使用した JOIN で、`set enable_optimize_predicate_expression=1` 設定時に発生するクラッシュを修正しました。 [#13679](https://github.com/ClickHouse/ClickHouse/pull/13679) ([Artem Zuikov](https://github.com/4ertus2)).
* `number_of_free_entries_in_pool_to_lower_max_size_of_merge` 設定の値に関するエラーメッセージのタイポを修正。 [#13678](https://github.com/ClickHouse/ClickHouse/pull/13678) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `ALTER ... REPLACE/MOVE PARTITION ...` クエリを同時に実行するとデッドロックが発生する可能性がありましたが、修正されました。 [#13626](https://github.com/ClickHouse/ClickHouse/pull/13626) ([tavplubix](https://github.com/tavplubix)).
* キャッシュ辞書が、ソースに存在する値ではなく既定値を返してしまうことがある問題を修正しました。 [#13624](https://github.com/ClickHouse/ClickHouse/pull/13624) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* コンパクトパーツにおけるセカンダリインデックスの破損を修正。コンパクトパーツは実験的な機能です。 [#13538](https://github.com/ClickHouse/ClickHouse/pull/13538) ([Anton Popov](https://github.com/CurtizJ)).
* 単一レプリカ上で実行する必要があるクエリに対して発生していた `ON CLUSTER` の過剰に早いタイムアウトを修正しました。[#6704](https://github.com/ClickHouse/ClickHouse/issues/6704)、[#7228](https://github.com/ClickHouse/ClickHouse/issues/7228)、[#13361](https://github.com/ClickHouse/ClickHouse/issues/13361)、[#11884](https://github.com/ClickHouse/ClickHouse/issues/11884) を解決します。[#13450](https://github.com/ClickHouse/ClickHouse/pull/13450)（[alesapin](https://github.com/alesapin)）。
* 関数 `netloc` の誤ったコードを修正。これにより [#13335](https://github.com/ClickHouse/ClickHouse/issues/13335) が解決される。 [#13446](https://github.com/ClickHouse/ClickHouse/pull/13446)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `StorageMemory` の潜在的なレースコンディションを修正しました。 [#13416](https://github.com/ClickHouse/ClickHouse/pull/13416) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* HTTP プロトコルでの `TSV/CSVWithNames` フォーマットにおけるヘッダーの欠落や過剰なヘッダーを修正。これにより [#12504](https://github.com/ClickHouse/ClickHouse/issues/12504) が解決されました。 [#13343](https://github.com/ClickHouse/ClickHouse/pull/13343)（[Azat Khuzhin](https://github.com/azat)）。
* `users.xml` からの行ポリシーのパースを修正し、データベース名やテーブル名にドットが含まれていても正しく処理できるようにしました。これにより [#5779](https://github.com/ClickHouse/ClickHouse/issues/5779)、[#12527](https://github.com/ClickHouse/ClickHouse/issues/12527) が修正されました。[#13199](https://github.com/ClickHouse/ClickHouse/pull/13199)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 一度切断された後に `redis` 辞書へアクセスできなくなる問題を修正しました。これは `cache` および `direct` 辞書レイアウトで発生する可能性があります。 [#13082](https://github.com/ClickHouse/ClickHouse/pull/13082) ([Anton Popov](https://github.com/CurtizJ)).
* ClickHouseDictionarySource を使用してリモートテーブルをクエリする際の誤った認可チェックを削除しました。 [#12756](https://github.com/ClickHouse/ClickHouse/pull/12756) ([sundyli](https://github.com/sundy-li)).
* 共通部分式除去のために、一部のケースで副問い合わせを正しく区別できるようにしました。 [#8333](https://github.com/ClickHouse/ClickHouse/issues/8333). [#8367](https://github.com/ClickHouse/ClickHouse/pull/8367) ([Amos Bird](https://github.com/amosbird)).

#### 改善 {#improvement-12}


* `ALIAS` カラム型での `CODEC` の使用を禁止しました。 [#13911](https://github.com/ClickHouse/ClickHouse/issues/13911) を修正。 [#14263](https://github.com/ClickHouse/ClickHouse/pull/14263)（[Bharat Nallan](https://github.com/bharatnc)）。
* 辞書の更新完了を待機する際には、ハードコードされた値ではなく、`query_wait_timeout_milliseconds` 設定で指定されたタイムアウトを使用します。 [#14105](https://github.com/ClickHouse/ClickHouse/pull/14105) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* `index_granularity_bytes` の設定値が極端に小さいテーブルを誤って作成してしまうことを防ぐため、設定項目 `min_index_granularity_bytes` を追加。 [#14139](https://github.com/ClickHouse/ClickHouse/pull/14139) ([Bharat Nallan](https://github.com/bharatnc))。
* 異なる ZooKeeper を使用するクラスターからパーティションを取得できるようになりました: `ALTER TABLE table_name FETCH PARTITION partition_expr FROM 'zk-name:/path-in-zookeeper'`。これは新しいクラスターへデータを移行する際に役立ちます。 [#14155](https://github.com/ClickHouse/ClickHouse/pull/14155) ([Amos Bird](https://github.com/amosbird))。
* 非常に多くの極めて小さなブロックから構成された場合（そのような状況は起こりにくいですが）、Memory テーブルのパフォーマンスがわずかに向上しました。アイデアの提案者: [Mark Papadakis](https://github.com/markpapadakis)。[#14043](https://github.com/ClickHouse/ClickHouse/issues/14043) をクローズ。[#14056](https://github.com/ClickHouse/ClickHouse/pull/14056)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 条件付き集約関数（例: `avgIf`、`sumIf`、`maxIf`）は、該当する行がない場合には `NULL` を返し、nullable な引数を使用するようになりました。 [#13964](https://github.com/ClickHouse/ClickHouse/pull/13964) ([Winter Zhang](https://github.com/zhang2014))。
* -Resample コンビネータの limit を 1M に引き上げ。 [#13947](https://github.com/ClickHouse/ClickHouse/pull/13947) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* 異常に小さく不正なメッセージを受信した際に、`AvroConfluent` フォーマットでのエラーが原因で `Kafka` テーブルエンジンがメッセージの処理を停止してしまう問題を修正しました。 [#13941](https://github.com/ClickHouse/ClickHouse/pull/13941) ([Gervasio Varela](https://github.com/gervarela))。
* 長いクエリに対して誤ったエラーが返される問題を修正しました。正しいクエリであっても、本来表示されるべき `Max query size exceeded` ではなく、別の構文エラーが発生する可能性がありました。 [#13928](https://github.com/ClickHouse/ClickHouse/pull/13928) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `TabSeparated` フォーマットにおける `null` 値用のエラーメッセージを改善。 [#13906](https://github.com/ClickHouse/ClickHouse/pull/13906) ([jiang tao](https://github.com/tomjiang1987)).
* 配列要素の型が Float32/Float64 の場合、関数 `arrayCompact` は NaN をビット単位で比較します。以前のバージョンでは、配列要素の型が Float32/Float64 の場合は NaN は常に等しくないと判定され、Nullable(Float64) のような、より複雑な型の場合は常に等しいと判定されていました。これにより [#13857](https://github.com/ClickHouse/ClickHouse/issues/13857) が解決されました。 [#13868](https://github.com/ClickHouse/ClickHouse/pull/13868) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `lgamma` 関数におけるデータレースを修正しました。このレースは `tsan` でのみ検出され、実際には副作用は発生していませんでした。 [#13842](https://github.com/ClickHouse/ClickHouse/pull/13842) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 配列をフィールドとして操作する際にクエリが過度に遅くならないようにし、その代わりに例外をスローするようにしました。 [#13753](https://github.com/ClickHouse/ClickHouse/pull/13753) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Redis の `requirepass` 認証（Redis 辞書ソース用）を追加しました。 [#13688](https://github.com/ClickHouse/ClickHouse/pull/13688) ([Ivan Torgashov](https://github.com/it1804)).
* MergeTree Write-Ahead-Log (WAL) のダンプツールを追加。WAL は実験的な機能です。 [#13640](https://github.com/ClickHouse/ClickHouse/pull/13640) ([BohuTANG](https://github.com/BohuTANG)).
* 以前のバージョンでは、`lcm` 関数が特定の細工された引数で呼び出された場合、デバッグビルドでアサーション違反を起こすことがありました。これにより [#13368](https://github.com/ClickHouse/ClickHouse/issues/13368) が修正されました。[#13510](https://github.com/ClickHouse/ClickHouse/pull/13510)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `toDate/toDateTime` 関数に対して、より多くのケースで単調性を提供するようにしました。単調性情報はインデックス解析に使用されます（より複雑なクエリでもインデックスを利用できるようになります）。これにより、入力引数がより自然な形で飽和処理され、単調性がさらに向上します。 [#13497](https://github.com/ClickHouse/ClickHouse/pull/13497) ([Amos Bird](https://github.com/amosbird))。
* カスタム設定で複合識別子をサポート。カスタム設定は ClickHouse のコードベースと他のコードベースとの統合ポイントであり（ClickHouse 自体には特に利点はない）、[#13496](https://github.com/ClickHouse/ClickHouse/pull/13496)（[Vitaly Baranov](https://github.com/vitlibar)）で導入。
* DiskLocal から DiskS3 へパーツを並列して移動できるようにしました。`DiskS3` は実験的な機能です。[#13459](https://github.com/ClickHouse/ClickHouse/pull/13459)（[Pavel Kovalenko](https://github.com/Jokser)）。
* ミックス粒度のパーツをデフォルトで有効化。 [#13449](https://github.com/ClickHouse/ClickHouse/pull/13449) ([alesapin](https://github.com/alesapin)).
* S3 リダイレクトにおけるリモートホストの適切な検証（セキュリティ関連の変更）。 [#13404](https://github.com/ClickHouse/ClickHouse/pull/13404) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `QueryTimeMicroseconds`、`SelectQueryTimeMicroseconds` および `InsertQueryTimeMicroseconds` を system.events に追加しました。 [#13336](https://github.com/ClickHouse/ClickHouse/pull/13336) ([ianton-ru](https://github.com/ianton-ru)).
* Decimal の負の指数が大きすぎる場合に発生するデバッグアサーションを修正。[#13188](https://github.com/ClickHouse/ClickHouse/issues/13188) を解決。[#13228](https://github.com/ClickHouse/ClickHouse/pull/13228)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* DiskS3 向けにキャッシュレイヤーを追加しました（mark ファイルおよび index ファイルをローカルディスクにキャッシュ）。`DiskS3` は実験的機能です。 [#13076](https://github.com/ClickHouse/ClickHouse/pull/13076) ([Pavel Kovalenko](https://github.com/Jokser)).
* `readline` が履歴をすぐにファイルへ書き出すように修正しました。 [#13600](https://github.com/ClickHouse/ClickHouse/pull/13600) ([Amos Bird](https://github.com/amosbird)).
* `system` データベースを、デフォルトで `Atomic` エンジンを用いて作成する（今後、すべての場所で `Atomic` データベースエンジンをデフォルトにするための準備）。 [#13680](https://github.com/ClickHouse/ClickHouse/pull/13680) ([tavplubix](https://github.com/tavplubix)).

#### パフォーマンス改善 {#performance-improvement-5}

- `LowCardinality`を使用した非常に短いクエリを若干最適化しました。[#14129](https://github.com/ClickHouse/ClickHouse/pull/14129) ([Anton Popov](https://github.com/CurtizJ))。
- `max_insert_threads`設定が指定されている場合、テーブルエンジン`Null`、`Memory`、`Distributed`、`Buffer`に対して並列INSERTを有効化しました。[#14120](https://github.com/ClickHouse/ClickHouse/pull/14120) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- パーツスキャン時に`max_rows_to_read`制限を超えた場合、即座に失敗するようにしました。この変更の目的は、`max_rows_to_read`が既に超過していることが明らかな場合、選択されたすべてのパーツに対する範囲スキャンをスキップすることです。この変更は、多数のパーツに対するクエリで顕著な効果があります。[#13677](https://github.com/ClickHouse/ClickHouse/pull/13677) ([Roman Khavronenko](https://github.com/hagen1778))。
- UInt8/UInt16キーによる集約のパフォーマンスを若干改善しました。[#13099](https://github.com/ClickHouse/ClickHouse/pull/13099) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `Array(LowCardinality(T))`と定数の右引数に対する`has()`、`indexOf()`、`countEqual()`関数を最適化しました。[#12550](https://github.com/ClickHouse/ClickHouse/pull/12550) ([myrrc](https://github.com/myrrc))。
- 単純な`INSERT SELECT`クエリを実行する際、`max_threads`を1または`max_insert_threads`に自動設定し、`max_block_size`を`min_insert_block_size_rows`に設定するようにしました。[#5907](https://github.com/ClickHouse/ClickHouse/issues/5907)に関連します。[#12195](https://github.com/ClickHouse/ClickHouse/pull/12195) ([flynn](https://github.com/ucasFL))。

#### 実験的機能 {#experimental-feature-3}

- ClickHouseがMySQLレプリカとして動作できるようになりました。これは`MaterializeMySQL`データベースエンジンによって実装されています。[#4006](https://github.com/ClickHouse/ClickHouse/issues/4006)を実装しました。[#10851](https://github.com/ClickHouse/ClickHouse/pull/10851) ([Winter Zhang](https://github.com/zhang2014))。
- `Int128`、`Int256`、`UInt256`型とそれらに関連する関数を追加しました。Decimal256(最大76桁の精度)でDecimal型を拡張しました。新しい型は`allow_experimental_bigint_types`設定の下で利用できます。動作は極めて遅く、品質も低いです。実装は不完全です。この機能は使用しないでください。[#13097](https://github.com/ClickHouse/ClickHouse/pull/13097) ([Artem Zuikov](https://github.com/4ertus2))。

#### ビルド/テスト/パッケージング改善 {#buildtestingpackaging-improvement-7}


* 単一のバイナリしかない場合に便利な `clickhouse install` スクリプトを追加しました。 [#13528](https://github.com/ClickHouse/ClickHouse/pull/13528) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 設定なしで `clickhouse` バイナリを実行できるようにしました。 [#13515](https://github.com/ClickHouse/ClickHouse/pull/13515) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `codespell` を使用してコード内の誤字チェックを有効にしました。 [#13513](https://github.com/ClickHouse/ClickHouse/pull/13513) [#13511](https://github.com/ClickHouse/ClickHouse/pull/13511) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `.sh` テスト用のリンターとして、CI で Shellcheck を有効化。これにより [#13168](https://github.com/ClickHouse/ClickHouse/issues/13168) がクローズされます。 [#13530](https://github.com/ClickHouse/ClickHouse/pull/13530) [#13529](https://github.com/ClickHouse/ClickHouse/pull/13529) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 自動再構成を行うのではなく設定処理を失敗させるための CMake オプションを追加し、デフォルトで有効にしました。 [#13687](https://github.com/ClickHouse/ClickHouse/pull/13687) ([Konstantin](https://github.com/podshumok))。
* 組み込み `tzdata` のバージョンを、`system.build_options` の `TZDATA_VERSION` を通じて公開。 [#13648](https://github.com/ClickHouse/ClickHouse/pull/13648) ([filimonov](https://github.com/filimonov)).
* ビルド時の `system.time_zones` テーブル生成を改善。 [#14209](https://github.com/ClickHouse/ClickHouse/issues/14209) をクローズ。 [#14215](https://github.com/ClickHouse/ClickHouse/pull/14215)（[filimonov](https://github.com/filimonov)）。
* パッケージリポジトリから取得した最新の `tzdata` を使って ClickHouse をビルドするように変更。 [#13623](https://github.com/ClickHouse/ClickHouse/pull/13623) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* skip&#95;list.json で JS スタイルのコメントを書けるようにしました。 [#14159](https://github.com/ClickHouse/ClickHouse/pull/14159) ([alesapin](https://github.com/alesapin)).
* GPL コードがコピー＆ペーストされていないことを確認します。 [#13514](https://github.com/ClickHouse/ClickHouse/pull/13514) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* テスト用 Docker イメージを、`test-base` を親イメージとして使用するように変更。 [#14167](https://github.com/ClickHouse/ClickHouse/pull/14167) ([Ilya Yatsishin](https://github.com/qoega))。
* docker-compose クラスターの起動時にリトライロジックを追加し、COMPOSE&#95;HTTP&#95;TIMEOUT を増加。 [#14112](https://github.com/ClickHouse/ClickHouse/pull/14112) ([vzakaznikov](https://github.com/vzakaznikov)).
* ストレステストで `system.text_log` を有効にし、より多くのバグを発見できるようにしました。 [#13855](https://github.com/ClickHouse/ClickHouse/pull/13855) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Testflows の LDAP モジュール: openldap4 向けに不足していた証明書と dhparam.pem を追加。 [#13780](https://github.com/ClickHouse/ClickHouse/pull/13780) ([vzakaznikov](https://github.com/vzakaznikov)).
* ZooKeeper は CI インフラストラクチャ内のユニットテスト環境では安定して動作しません。実際の ZooKeeper と対話するためにユニットテストを用いるのは、そもそも良くない考えです（ユニットテストは複雑な分散システムを検証するためのものではありません）。この目的にはすでに integration test を使用しており、そちらの方がより適しています。 [#13745](https://github.com/ClickHouse/ClickHouse/pull/13745) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* スタイルチェック用の Docker イメージを追加しました。すべての Docker および Docker Compose ファイルが docker ディレクトリ内に配置されていることを確認するスタイルチェックを追加しました。 [#13724](https://github.com/ClickHouse/ClickHouse/pull/13724) ([Ilya Yatsishin](https://github.com/qoega)).
* Mac OS における cassandra のビルドを修正。 [#13708](https://github.com/ClickHouse/ClickHouse/pull/13708) ([Ilya Yatsishin](https://github.com/qoega)).
* 共有ビルドのリンクエラーを修正。 [#13700](https://github.com/ClickHouse/ClickHouse/pull/13700) ([Amos Bird](https://github.com/amosbird)).
* RBAC と連携して動作することを確認するために、LDAP ユーザー認証スイートを更新。 [#13656](https://github.com/ClickHouse/ClickHouse/pull/13656) ([vzakaznikov](https://github.com/vzakaznikov))。
* `contrib/aws` から `-DENABLE_CURL_CLIENT` を削除。 [#13628](https://github.com/ClickHouse/ClickHouse/pull/13628) ([Vladimir Chebotarev](https://github.com/excitoon)).
* ClickHouse ノードのヘルスチェックのタイムアウトを延長し、異常なコンテナが見つかった場合に `docker-compose` のログをダンプできるようにしました。 [#13612](https://github.com/ClickHouse/ClickHouse/pull/13612) ([vzakaznikov](https://github.com/vzakaznikov)).
* [#10977](https://github.com/ClickHouse/ClickHouse/issues/10977) が無効であることを確認する。 [#13539](https://github.com/ClickHouse/ClickHouse/pull/13539) ([Amos Bird](https://github.com/amosbird))。
* robot-clickhouse からの PR をスキップする。 [#13489](https://github.com/ClickHouse/ClickHouse/pull/13489) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* Dockerfile を integration tests から `docker/test` ディレクトリに移動しました。docker&#95;compose ファイルは `runner` Docker コンテナ内で利用可能です。Docker イメージは integration tests ではなく CI でビルドされます。[#13448](https://github.com/ClickHouse/ClickHouse/pull/13448)（[Ilya Yatsishin](https://github.com/qoega)）。





## ClickHouseリリース20.7 {#clickhouse-release-207}

### ClickHouseリリースv20.7.2.30-stable、2020-08-31 {#clickhouse-release-v207230-stable-2020-08-31}

#### 後方互換性のない変更 {#backward-incompatible-change-5}

- 関数`modulo`(演算子`%`)は、引数として少なくとも1つの浮動小数点数がある場合、両方の引数を整数に変換せずに浮動小数点数で直接除算の剰余を計算します。これにより、ほとんどのDBMSと互換性のある動作になります。これはDateおよびDateTimeデータ型にも適用されます。エイリアス`mod`を追加しました。これにより[#7323](https://github.com/ClickHouse/ClickHouse/issues/7323)が解決されます。[#12585](https://github.com/ClickHouse/ClickHouse/pull/12585) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ゼロのDate/DateTime値を`0000-00-00`および`0000-00-00 00:00:00`として特別に表示する機能を非推奨にしました。[#12442](https://github.com/ClickHouse/ClickHouse/pull/12442) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 関数`groupArrayMoving*`が分散クエリで動作していませんでした。その結果は誤ったデータ型(最大の型への昇格なし)で計算されていました。関数`groupArrayMovingAvg`は`avg`関数と一致しない整数を返していました。これにより[#12568](https://github.com/ClickHouse/ClickHouse/issues/12568)が修正されます。[#12622](https://github.com/ClickHouse/ClickHouse/pull/12622) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- MergeTree設定の健全性チェックを追加しました。設定が正しくない場合、サーバーは起動またはテーブルの作成を拒否し、詳細な説明をユーザーに出力します。[#13153](https://github.com/ClickHouse/ClickHouse/pull/13153) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ユーザーが`background_pool_size`を`number_of_free_entries_in_pool_to_execute_mutation`または`number_of_free_entries_in_pool_to_lower_max_size_of_merge`より小さい値に設定する場合から保護します。これらの場合、ALTERが動作しないか、マージの最大サイズが過度に制限されます。何をすべきかを説明する例外がスローされます。これにより[#10897](https://github.com/ClickHouse/ClickHouse/issues/10897)が解決されます。[#12728](https://github.com/ClickHouse/ClickHouse/pull/12728) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 20.5より古いバージョンからアップグレードする際、ローリングアップデートが実行され、クラスターに20.5以上のバージョンと20.5未満のバージョンの両方が含まれている場合、古いバージョンのClickHouseノードが再起動され、新しいバージョンの存在下で古いバージョンが起動されると、`Part ... intersects previous part`エラーが発生する可能性があります。このエラーを防ぐには、まずすべてのクラスターノードに新しいclickhouse-serverパッケージをインストールしてから再起動を実行してください(これにより、clickhouse-serverが再起動されると新しいバージョンで起動します)。

#### 新機能 {#new-feature-5}


- 効率的な「逆ジオコーディング」検索を提供するPolygon辞書タイプ - 多数のポリゴン(世界地図)の辞書内で座標から地域を検索します。再帰的グリッドを使用した慎重に最適化されたアルゴリズムにより、CPUとメモリ使用量を低く抑えます。[#9278](https://github.com/ClickHouse/ClickHouse/pull/9278) ([achulkov2](https://github.com/achulkov2))。
- 事前設定されたユーザー向けのLDAP認証のサポートを追加しました(「Simple Bind」方式)。[#11234](https://github.com/ClickHouse/ClickHouse/pull/11234) ([Denis Glazachev](https://github.com/traceon))。
- 一部の`ALTER TABLE ... PARTITION ...`クエリ(現在は`ATTACH`と`FREEZE`)で影響を受けたパートに関する情報を出力する設定`alter_partition_verbose_result`を導入しました。[#8076](https://github.com/ClickHouse/ClickHouse/issues/8076)を解決。[#13017](https://github.com/ClickHouse/ClickHouse/pull/13017) ([alesapin](https://github.com/alesapin))。
- ベイジアンABテスト用の`bayesAB`関数を追加しました。[#12327](https://github.com/ClickHouse/ClickHouse/pull/12327) ([achimbab](https://github.com/achimbab))。
- 致命的エラーのスタックトレースを収集する`system.crash_log`テーブルを追加しました。このテーブルは空であるべきです。[#12316](https://github.com/ClickHouse/ClickHouse/pull/12316) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- デフォルトデータベースと出力フォーマットを設定するために使用できるHTTPヘッダー`X-ClickHouse-Database`と`X-ClickHouse-Format`を追加しました。[#12981](https://github.com/ClickHouse/ClickHouse/pull/12981) ([hcz](https://github.com/hczhcz))。
- `SimpleAggregateFunction`に`minMap`と`maxMap`関数のサポートを追加しました。[#12662](https://github.com/ClickHouse/ClickHouse/pull/12662) ([Ildus Kurbangaliev](https://github.com/ildus))。
- ディスク上のデータを変更する`ALTER`クエリの実行を制限する設定`allow_non_metadata_alters`を追加しました。デフォルトでは無効です。[#11547](https://github.com/ClickHouse/ClickHouse/issues/11547)を解決。[#12635](https://github.com/ClickHouse/ClickHouse/pull/12635) ([alesapin](https://github.com/alesapin))。
- 任意の式を指定されたフォーマットで文字列に変換する関数`formatRow`を追加しました。SQL出力の操作に便利で、`columns`関数と組み合わせると非常に汎用性が高くなります。[#12574](https://github.com/ClickHouse/ClickHouse/pull/12574) ([Amos Bird](https://github.com/amosbird))。
- MySQLとの互換性のために`FROM_UNIXTIME`関数を追加しました。[12149](https://github.com/ClickHouse/ClickHouse/issues/12149)に関連。[#12484](https://github.com/ClickHouse/ClickHouse/pull/12484) ([flynn](https://github.com/ucasFL))。
- `allow_nullable_key`テーブル設定が有効な場合、MergeTreeテーブルのキーとしてNullable型を許可します。[#5319](https://github.com/ClickHouse/ClickHouse/issues/5319)を解決。[#12433](https://github.com/ClickHouse/ClickHouse/pull/12433) ([Amos Bird](https://github.com/amosbird))。
- [COS](https://intl.cloud.tencent.com/product/cos)との統合。[#12386](https://github.com/ClickHouse/ClickHouse/pull/12386) ([fastio](https://github.com/fastio))。
- キーマップされた値の加算/減算のための`mapAdd`と`mapSubtract`関数を追加しました。[#11735](https://github.com/ClickHouse/ClickHouse/pull/11735) ([Ildus Kurbangaliev](https://github.com/ildus))。

#### バグ修正 {#bug-fix-24}


* 単一レプリカ上で実行する必要があるクエリに対する `ON CLUSTER` の早期タイムアウトを修正。 [#6704](https://github.com/ClickHouse/ClickHouse/issues/6704)、 [#7228](https://github.com/ClickHouse/ClickHouse/issues/7228)、 [#13361](https://github.com/ClickHouse/ClickHouse/issues/13361)、 [#11884](https://github.com/ClickHouse/ClickHouse/issues/11884) を修正。 [#13450](https://github.com/ClickHouse/ClickHouse/pull/13450)（[alesapin](https://github.com/alesapin)）。
* [#12277](https://github.com/ClickHouse/ClickHouse/pull/12277) で発生したマーク包含検索におけるクラッシュを修正。[#14225](https://github.com/ClickHouse/ClickHouse/pull/14225)（[Amos Bird](https://github.com/amosbird)）。
* キャッシュレイアウトを持つ外部ディクショナリにおけるレースコンディションを修正しました。これによりサーバーがクラッシュする可能性がありました。 [#12566](https://github.com/ClickHouse/ClickHouse/pull/12566) ([alesapin](https://github.com/alesapin))。
* インタラクティブモードのクライアントで、プログレスバーによって表示中のデータが上書きされてしまう問題を修正しました。これにより [#12562](https://github.com/ClickHouse/ClickHouse/issues/12562)、[#13369](https://github.com/ClickHouse/ClickHouse/issues/13369)、[#13584](https://github.com/ClickHouse/ClickHouse/issues/13584) および [#12964](https://github.com/ClickHouse/ClickHouse/issues/12964) が修正されます。 [#13691](https://github.com/ClickHouse/ClickHouse/pull/13691) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 複数カラムで `ORDER BY` を使用した場合に、`LowCardinality` カラムのソート順が誤っていた問題を修正しました。これにより [#13958](https://github.com/ClickHouse/ClickHouse/issues/13958) が解決されます。 [#14223](https://github.com/ClickHouse/ClickHouse/pull/14223)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* cache-dictionary に対する `query_wait_timeout_milliseconds` 設定を誤って上書きしていたハードコードされたタイムアウトを削除しました。 [#14105](https://github.com/ClickHouse/ClickHouse/pull/14105) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* `Poco::Exception: no space left on device` の追加情報に含まれていた誤ったマウントポイントを修正しました。 [#14050](https://github.com/ClickHouse/ClickHouse/pull/14050) ([tavplubix](https://github.com/tavplubix)).
* `optimize_duplicate_order_by_and_distinct` 設定が有効な場合に、サブクエリにも `DISTINCT` が含まれている `DISTINCT` キーワード付きの `SELECT` クエリで誤ったクエリ最適化が行われる問題を修正します。 [#13925](https://github.com/ClickHouse/ClickHouse/pull/13925) ([Artem Zuikov](https://github.com/4ertus2)).
* `Distributed` テーブルのリネーム時に発生する可能性のあったデッドロックを修正しました。 [#13922](https://github.com/ClickHouse/ClickHouse/pull/13922) ([tavplubix](https://github.com/tavplubix)).
* 複数カラムで `ORDER BY` を使用した際に `FixedString` カラムのソート順が誤っていた問題を修正しました。 [#13182](https://github.com/ClickHouse/ClickHouse/issues/13182) を修正。 [#13887](https://github.com/ClickHouse/ClickHouse/pull/13887)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `topK`/`topKWeighted` 集約（非デフォルトのパラメータ使用時）の精度が低くなる可能性があった問題を修正しました。 [#13817](https://github.com/ClickHouse/ClickHouse/pull/13817) ([Azat Khuzhin](https://github.com/azat)).
* NULL と比較されたときに、型が SET の INDEX を持つ MergeTree テーブルからの読み取りが失敗する問題を修正しました。これにより [#13686](https://github.com/ClickHouse/ClickHouse/issues/13686) が解決されます。 [#13793](https://github.com/ClickHouse/ClickHouse/pull/13793) ([Amos Bird](https://github.com/amosbird))。
* 関数 `range()` のステップ値のオーバーフローを修正しました。 [#13790](https://github.com/ClickHouse/ClickHouse/pull/13790) ([Azat Khuzhin](https://github.com/azat)).
* `DROP DATABASE` と `CREATE TABLE` を同時に実行した際に発生していた `Directory not empty` エラーを修正しました。 [#13756](https://github.com/ClickHouse/ClickHouse/pull/13756) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `h3KRing` 関数に範囲チェックを追加しました。これにより [#13633](https://github.com/ClickHouse/ClickHouse/issues/13633) が修正されます。[#13752](https://github.com/ClickHouse/ClickHouse/pull/13752)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* DETACH とバックグラウンドマージの間のレースコンディションを修正しました。DETACH 後にパーツが復活する可能性がありました。これは、その問題自体は修正できなかったものの、その問題を示す、非常にまれなケースで失敗し始めたテストを導入した [#8602](https://github.com/ClickHouse/ClickHouse/issues/8602) の継続対応です。 [#13746](https://github.com/ClickHouse/ClickHouse/pull/13746) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `log_queries_min_type` が `QUERY_START` より大きい場合の Settings.Names/Values のログ出力を修正。 [#13737](https://github.com/ClickHouse/ClickHouse/pull/13737) ([Azat Khuzhin](https://github.com/azat)).
* ユーザーとグループのチェック時に `clickhouse-server.init` が表示する誤ったメッセージを修正。[#13711](https://github.com/ClickHouse/ClickHouse/pull/13711)（[ylchou](https://github.com/ylchou)）。
* `optimize_move_functions_out_of_any` が有効な場合でも、`any(arrayJoin())` を `arrayJoin()` に最適化しないようにしました。 [#13681](https://github.com/ClickHouse/ClickHouse/pull/13681) ([Azat Khuzhin](https://github.com/azat)).
* 同時実行される `ALTER ... REPLACE/MOVE PARTITION ...` クエリで発生する可能性のあったデッドロックを修正。 [#13626](https://github.com/ClickHouse/ClickHouse/pull/13626) ([tavplubix](https://github.com/tavplubix)).
* キャッシュ辞書が、ソースに存在する値ではなくデフォルト値を返してしまうことがある問題を修正しました。 [#13624](https://github.com/ClickHouse/ClickHouse/pull/13624) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* コンパクトパーツにおけるセカンダリインデックスの破損を修正（コンパクトパーツは実験的機能）。 [#13538](https://github.com/ClickHouse/ClickHouse/pull/13538) ([Anton Popov](https://github.com/CurtizJ)).
* 関数 `netloc` 内の誤ったコードを修正しました。これにより [#13335](https://github.com/ClickHouse/ClickHouse/issues/13335) が解決されます。 [#13446](https://github.com/ClickHouse/ClickHouse/pull/13446)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `parseDateTimeBestEffort` 関数に unix タイムスタンプが引数として渡された場合に発生していたエラーを修正しました。これにより [#13362](https://github.com/ClickHouse/ClickHouse/issues/13362) が解決されます。[#13441](https://github.com/ClickHouse/ClickHouse/pull/13441)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `NULL` 要素を含むタプルの比較における不正な戻り値型を修正しました。[#12461](https://github.com/ClickHouse/ClickHouse/issues/12461) を修正。[#13420](https://github.com/ClickHouse/ClickHouse/pull/13420)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `SET optimize_move_functions_out_of_any = 1` と `any()` 内のエイリアスが原因で発生していた、`aggregate function any(x) is found inside another aggregate function in query` エラーを引き起こす誤った最適化を修正しました。 [#13419](https://github.com/ClickHouse/ClickHouse/pull/13419) ([Artem Zuikov](https://github.com/4ertus2)).
* `StorageMemory` におけるレースコンディションの可能性を修正します。 [#13416](https://github.com/ClickHouse/ClickHouse/pull/13416) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* クエリがゼロ行を返す場合に、`Arrow` および `Parquet` フォーマットで出力が空になってしまう問題を修正しました。これらのフォーマットでは空の出力は無効であるため、この修正を行いました。 [#13399](https://github.com/ClickHouse/ClickHouse/pull/13399) ([hcz](https://github.com/hczhcz)).
* `ORDER BY` 句に定数カラムと主キーのプレフィックスを含む `SELECT` クエリを修正しました。 [#13396](https://github.com/ClickHouse/ClickHouse/pull/13396) ([Anton Popov](https://github.com/CurtizJ)).
* `clickhouse-local` 向けの `PrettyCompactMonoBlock` を修正。`PrettyCompactMonoBlock` 使用時の extremes/totals を修正。[#7746](https://github.com/ClickHouse/ClickHouse/issues/7746) を解決。[#13394](https://github.com/ClickHouse/ClickHouse/pull/13394)（[Azat Khuzhin](https://github.com/azat)）。
* system.text&#95;log のデッドロックを修正しました。 [#12452](https://github.com/ClickHouse/ClickHouse/pull/12452) ([alexey-milovidov](https://github.com/alexey-milovidov))。これは [#12339](https://github.com/ClickHouse/ClickHouse/issues/12339) の一部です。この修正により [#12325](https://github.com/ClickHouse/ClickHouse/issues/12325) が解決されます。 [#13386](https://github.com/ClickHouse/ClickHouse/pull/13386) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* `File(TSVWithNames*)` の不具合を修正（ヘッダーが複数回書き込まれていた）、`clickhouse-local --format CSVWithNames*` の不具合を修正（[#12197](https://github.com/ClickHouse/ClickHouse/issues/12197) 以降、ヘッダーが出力されず壊れていた）、行数がゼロの場合の `clickhouse-local --format CSVWithNames*` の不具合を修正（ヘッダーが欠落していた）。[#13343](https://github.com/ClickHouse/ClickHouse/pull/13343)（[Azat Khuzhin](https://github.com/azat)）。
* 関数 `groupArrayMovingSum` が空の状態をデシリアライズする際に発生するセグメンテーションフォルトを修正。 [#13339](https://github.com/ClickHouse/ClickHouse/issues/13339) を修正。 [#13341](https://github.com/ClickHouse/ClickHouse/pull/13341) ([alesapin](https://github.com/alesapin))。
* `JOIN ON` 節での `arrayJoin()` 関数の使用時にエラーをスローするように変更。 [#13330](https://github.com/ClickHouse/ClickHouse/pull/13330) ([Artem Zuikov](https://github.com/4ertus2)).
* `join_use_nulls=1` 設定時に `LEFT ASOF JOIN` で発生するクラッシュを修正。 [#13291](https://github.com/ClickHouse/ClickHouse/pull/13291) ([Artem Zuikov](https://github.com/4ertus2)).
* 遅延レプリカからのクエリで発生する可能性がある `Totals having transform was already added to pipeline` エラーを修正。 [#13290](https://github.com/ClickHouse/ClickHouse/pull/13290) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* ユーザーが関数 `h3ToChildren` に細工された特定の引数を渡した場合、サーバーがクラッシュする可能性がありました。これにより [#13275](https://github.com/ClickHouse/ClickHouse/issues/13275) が修正されました。[#13277](https://github.com/ClickHouse/ClickHouse/pull/13277)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* Float 型の `NaN` 値を含む `uniqExact`、`topK`、`sumDistinct` などの集約関数で発生していた、潜在的な低パフォーマンスとわずかに不正確な結果を修正しました。この問題は debug ビルドで assert が発生する原因にもなっていました。これにより [#12491](https://github.com/ClickHouse/ClickHouse/issues/12491) が修正されました。 [#13254](https://github.com/ClickHouse/ClickHouse/pull/13254)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 主キーに単調関数を含む式があり、かつクエリに異なる型の定数との比較が含まれている場合の `KeyCondition` のアサーションを修正しました。これにより [#12465](https://github.com/ClickHouse/ClickHouse/issues/12465) が修正されます。 [#13251](https://github.com/ClickHouse/ClickHouse/pull/13251) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 関数 `roundUpToPowerOfTwoOrZero()` において、MSB がセットされている数値に対しては、渡された数値をそのまま返すようにしました。これにより、配列サイズがオーバーフローした場合に発生しうるエラーを防ぎます。 [#13234](https://github.com/ClickHouse/ClickHouse/pull/13234) ([Azat Khuzhin](https://github.com/azat)).
* `cond` にリテラル `NULL` ではない nullable な `constexpr` を指定した場合の `if` 関数の動作を修正。[#12463](https://github.com/ClickHouse/ClickHouse/issues/12463) を修正。[#13226](https://github.com/ClickHouse/ClickHouse/pull/13226)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 配列要素が `Nullable` で、配列の添字も `Nullable` の場合の `arrayElement` 関数内の `assert` を修正しました。これにより [#12172](https://github.com/ClickHouse/ClickHouse/issues/12172) が解決されます。 [#13224](https://github.com/ClickHouse/ClickHouse/pull/13224) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 定数引数を取る `DateTime64` 変換関数を修正。 [#13205](https://github.com/ClickHouse/ClickHouse/pull/13205) ([Azat Khuzhin](https://github.com/azat))。
* `users.xml` から行ポリシーをパースする際に、データベース名やテーブル名にドットが含まれている場合の不具合を修正。これにより [#5779](https://github.com/ClickHouse/ClickHouse/issues/5779)、[#12527](https://github.com/ClickHouse/ClickHouse/issues/12527) が修正されました。[#13199](https://github.com/ClickHouse/ClickHouse/pull/13199)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 一度接続が切断された後に `redis` 辞書へアクセスできなくなる問題を修正しました。これは `cache` および `direct` 辞書レイアウトで発生する可能性があります。 [#13082](https://github.com/ClickHouse/ClickHouse/pull/13082) ([Anton Popov](https://github.com/CurtizJ)).
* 関数を含むインデックス解析の不具合を修正しました。これにより、`MergeTree` テーブルからの読み取り時に一部のデータパーツがスキップされてしまう可能性がありました。[#13060](https://github.com/ClickHouse/ClickHouse/issues/13060) を修正します。[#12406](https://github.com/ClickHouse/ClickHouse/issues/12406) を修正します。[#13081](https://github.com/ClickHouse/ClickHouse/pull/13081)（[Anton Popov](https://github.com/CurtizJ)）による修正です。
* `now()`, `now64()`, `randConstant()` のように、クエリのスコープ内では決定論的だがクエリ間では決定論的でない関数を使用するリモートクエリで発生する `Cannot convert column because it is constant but values of constants are different in source and result` エラーを修正しました。[#11327](https://github.com/ClickHouse/ClickHouse/issues/11327) を修正。[#13075](https://github.com/ClickHouse/ClickHouse/pull/13075)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `ORDER BY` でタプルを使用し、かつ小さい `LIMIT` を指定したクエリで発生する可能性があったクラッシュを修正。 [#12623](https://github.com/ClickHouse/ClickHouse/issues/12623) を修正。 [#13009](https://github.com/ClickHouse/ClickHouse/pull/13009)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `UNION` と `JOIN` を含むクエリで発生する `Block structure mismatch` エラーを修正。[#12602](https://github.com/ClickHouse/ClickHouse/issues/12602) を解決。[#12989](https://github.com/ClickHouse/ClickHouse/pull/12989)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `merge_with_ttl_timeout` のロジックを修正しました。これは、有効期限の影響が1つの時間間隔内で複数のパーティションに及ぶ場合に正しく動作していませんでした。（@excitoon による変更）。[#12982](https://github.com/ClickHouse/ClickHouse/pull/12982)（[Alexander Kazakov](https://github.com/Akazz)）。
* DDL クエリから作成された range hashed dictionary における列の重複を修正しました。これにより [#10605](https://github.com/ClickHouse/ClickHouse/issues/10605) が解決されます。[#12857](https://github.com/ClickHouse/ClickHouse/pull/12857) ([alesapin](https://github.com/alesapin))。
* ローカルレプリカからの SELECT に対するスレッド数の不要な制限を修正。 [#12840](https://github.com/ClickHouse/ClickHouse/pull/12840) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `ALTER DELETE` と `ALTER MODIFY COLUMN` クエリが 1 つの mutation として同時に実行された際に発生する、まれなバグを修正しました。このバグにより `count.txt` に記録される行数が不正になり、その結果としてパーツ内のデータも不正になることがありました。また、`ALTER RENAME COLUMN` と `ALTER ADD COLUMN` を同時に実行した場合に発生する小さなバグも修正しました。 [#12760](https://github.com/ClickHouse/ClickHouse/pull/12760) ([alesapin](https://github.com/alesapin)).
* リモートテーブルをクエリする際に `clickhouse` 辞書ソースを使用すると、誤った認証情報が使用される問題を修正。 [#12756](https://github.com/ClickHouse/ClickHouse/pull/12756) ([sundyli](https://github.com/sundy-li)).
* `CAST(Nullable(String), Enum())` の問題を修正しました。 [#12745](https://github.com/ClickHouse/ClickHouse/pull/12745) ([Azat Khuzhin](https://github.com/azat)).
* `IN` 節で大きなタプルが関数として解釈される場合のパフォーマンスを修正しました。ユーザーが何らかの理由で `WHERE x IN (1, 2, ...)` ではなく `WHERE x IN tuple(1, 2, ...)` と書いてしまうケースです。 [#12700](https://github.com/ClickHouse/ClickHouse/pull/12700) ([Anton Popov](https://github.com/CurtizJ)).
* input&#95;format&#95;parallel&#95;parsing のメモリトラッキングを修正（スレッドをグループに関連付けることで実現）。[#12672](https://github.com/ClickHouse/ClickHouse/pull/12672) ([Azat Khuzhin](https://github.com/azat)).
* `any(func(&lt;lambda&gt;))` の場合における誤った最適化 `optimize_move_functions_out_of_any=1` を修正。 [#12664](https://github.com/ClickHouse/ClickHouse/pull/12664) ([Artem Zuikov](https://github.com/4ertus2)).
* [#10572](https://github.com/ClickHouse/ClickHouse/issues/10572) の修正: 定数式を使用する Bloom filter インデックスの不具合を修正しました。[#12659](https://github.com/ClickHouse/ClickHouse/pull/12659)（[Winter Zhang](https://github.com/zhang2014)）。
* ブローカーが利用できない場合（など）に `StorageKafka` で発生する `SIGSEGV` を修正。 [#12658](https://github.com/ClickHouse/ClickHouse/pull/12658) ([Azat Khuzhin](https://github.com/azat)).
* `Array(UUID)` 引数を取る関数 `if` のサポートを追加しました。これにより [#11066](https://github.com/ClickHouse/ClickHouse/issues/11066) が修正されました。 [#12648](https://github.com/ClickHouse/ClickHouse/pull/12648) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `CREATE USER IF NOT EXISTS` は、ユーザーが既に存在する場合に例外をスローしなくなりました。これにより [#12507](https://github.com/ClickHouse/ClickHouse/issues/12507) が修正されました。 [#12646](https://github.com/ClickHouse/ClickHouse/pull/12646) ([Vitaly Baranov](https://github.com/vitlibar))。
* `ALTER ... UPDATE` の実行中に、予期しないケース（例: UInt64 カラムからの減算）で `There is no supertype...` という例外がスローされることがあります。これにより [#7306](https://github.com/ClickHouse/ClickHouse/issues/7306) が修正されます。これにより [#4165](https://github.com/ClickHouse/ClickHouse/issues/4165) も修正されます。 [#12633](https://github.com/ClickHouse/ClickHouse/pull/12633) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 外部ソートを伴うクエリで発生しうる `Pipeline stuck` エラーを修正。 [#12617](https://github.com/ClickHouse/ClickHouse/issues/12617) を解消。 [#12618](https://github.com/ClickHouse/ClickHouse/pull/12618)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `OPTIMIZE DEDUPLICATE` で発生する `Output of TreeExecutor is not sorted` エラーを修正。[#11572](https://github.com/ClickHouse/ClickHouse/issues/11572) を解決。 [#12613](https://github.com/ClickHouse/ClickHouse/pull/12613)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* クエリ最適化の過程で、関数 `any` の結果に付けたエイリアスが失われる可能性がある問題を修正しました。 [#12593](https://github.com/ClickHouse/ClickHouse/pull/12593) ([Anton Popov](https://github.com/CurtizJ)).
* `DROP TABLE` 時に Distributed テーブルのデータ（非同期 `INSERT` によるブロック）を削除。 [#12556](https://github.com/ClickHouse/ClickHouse/pull/12556) ([Azat Khuzhin](https://github.com/azat))。
* `checksums.txt` ファイルが存在しない場合、ClickHouse はパーツのチェックサムを再計算するようになりました。[#9827](https://github.com/ClickHouse/ClickHouse/issues/9827) 以降、この動作は壊れていました。[#12545](https://github.com/ClickHouse/ClickHouse/pull/12545)（[alesapin](https://github.com/alesapin)）。
* `enable_mixed_granularity_parts=1` のときに `ALTER DELETE` クエリの実行後、古いパーツが壊れた状態になるバグを修正。[#12536](https://github.com/ClickHouse/ClickHouse/issues/12536) を修正。[#12543](https://github.com/ClickHouse/ClickHouse/pull/12543)（[alesapin](https://github.com/alesapin)）。
* データの重複を引き起こす可能性があった LIVE VIEW テーブルのレースコンディションを修正しました。LIVE VIEW は実験的な機能です。 [#12519](https://github.com/ClickHouse/ClickHouse/pull/12519) ([vzakaznikov](https://github.com/vzakaznikov)).
* `AggregateFunction(avg, ...)` の値のバイナリ形式における後方互換性の問題を修正しました。これにより [#12342](https://github.com/ClickHouse/ClickHouse/issues/12342) が解決されます。 [#12486](https://github.com/ClickHouse/ClickHouse/pull/12486) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 辞書キーの式で結合している場合（`t JOIN dict ON expr(dict.id) = t.id`）に発生していた、辞書を用いた `JOIN` のクラッシュを修正しました。このケースでは辞書結合の最適化を無効化しました。 [#12458](https://github.com/ClickHouse/ClickHouse/pull/12458) ([Artem Zuikov](https://github.com/4ertus2)).
* 非常に大きな `LIMIT` または `OFFSET` が指定された場合のオーバーフローを修正。これにより [#10470](https://github.com/ClickHouse/ClickHouse/issues/10470) を修正。[#11372](https://github.com/ClickHouse/ClickHouse/issues/11372) も修正。 [#12427](https://github.com/ClickHouse/ClickHouse/pull/12427) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* kafka: バッチの途中にエラーのあるメッセージが含まれている場合に発生する SIGSEGV を修正。 [#12302](https://github.com/ClickHouse/ClickHouse/pull/12302) ([Azat Khuzhin](https://github.com/azat)).

#### 改善 {#improvement-13}


* ZooKeeper 内のログ量を少なく保ちます。多くのサーバー/テーブル/挿入があり、オフラインレプリカが存在する場合でも、ZooKeeper ノードが過剰に増加するのを防ぎます。 [#13100](https://github.com/ClickHouse/ClickHouse/pull/13100) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `ALTER` またはミューテーションの実行中にエラーが発生した場合、その例外がクライアントに転送されるようになりました。 [#11329](https://github.com/ClickHouse/ClickHouse/issues/11329) をクローズします。 [#12666](https://github.com/ClickHouse/ClickHouse/pull/12666) ([alesapin](https://github.com/alesapin))。
* `system.metrics`、`processes`、`query_log` などとあわせて、`system.events` に `QueryTimeMicroseconds`、`SelectQueryTimeMicroseconds`、`InsertQueryTimeMicroseconds` を追加。 [#13028](https://github.com/ClickHouse/ClickHouse/pull/13028) ([ianton-ru](https://github.com/ianton-ru)).
* `system.events` に `SelectedRows` と `SelectedBytes` を追加し、あわせて system.metrics、processes、query&#95;log などにも追加しました。 [#12638](https://github.com/ClickHouse/ClickHouse/pull/12638) ([ianton-ru](https://github.com/ianton-ru)).
* `current_database` の情報を `system.query_log` に追加しました。 [#12652](https://github.com/ClickHouse/ClickHouse/pull/12652) ([Amos Bird](https://github.com/amosbird)).
* `TabSeparatedRaw` を入力フォーマットとして使用可能にしました。 [#12009](https://github.com/ClickHouse/ClickHouse/pull/12009) ([hcz](https://github.com/hczhcz)).
* `joinGet` はマルチキーでのルックアップをサポートするようになりました。 [#12418](https://github.com/ClickHouse/ClickHouse/pull/12418) ([Amos Bird](https://github.com/amosbird)).
* `*Map` 集約関数が NULL を含む配列でも動作するようにしました。 [#13157](https://github.com/ClickHouse/ClickHouse/issues/13157) を修正。 [#13225](https://github.com/ClickHouse/ClickHouse/pull/13225)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* タイムゾーンによっては負の Unix タイムスタンプとなってしまうような DateTime 値のパース時に発生するオーバーフロー（例: モスクワにおける `1970-01-01 00:00:00`）を回避しました。代わりに 0 に飽和させます。これにより [#3470](https://github.com/ClickHouse/ClickHouse/issues/3470) が修正されます。これにより [#4172](https://github.com/ClickHouse/ClickHouse/issues/4172) が修正されます。 [#12443](https://github.com/ClickHouse/ClickHouse/pull/12443)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* AvroConfluent: Kafka の tombstone レコードをスキップ — 破損したレコードをスキップする機能をサポート [#13203](https://github.com/ClickHouse/ClickHouse/pull/13203) ([Andrew Onyshchuk](https://github.com/oandrew)).
* 長いクエリに対して誤ったエラーが出力される問題を修正しました。正しいクエリに対しても、`Max query size exceeded` ではない構文エラーが返される可能性がありました。 [#13928](https://github.com/ClickHouse/ClickHouse/pull/13928) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `lgamma` 関数のデータ競合を修正しました。この競合は `tsan` でのみ検出されており、実際に副作用が発生することはありませんでした。 [#13842](https://github.com/ClickHouse/ClickHouse/pull/13842) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* ATTACH/ALTER/CREATE QUOTA ステートメントにおける &#39;Week&#39; 間隔のフォーマットを修正。 [#13417](https://github.com/ClickHouse/ClickHouse/pull/13417) ([vladimir-golovchenko](https://github.com/vladimir-golovchenko)).
* コンパクトパーツの処理中に破損したパーツに遭遇した場合も、報告されるようになりました。コンパクトパーツは実験的な機能です。 [#13282](https://github.com/ClickHouse/ClickHouse/pull/13282) ([Amos Bird](https://github.com/amosbird))。
* `geohashesInBox` 内の `assert` を修正。これにより [#12554](https://github.com/ClickHouse/ClickHouse/issues/12554) が解決される。 [#13229](https://github.com/ClickHouse/ClickHouse/pull/13229)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `parseDateTimeBestEffort` の `assert` を修正。これにより [#12649](https://github.com/ClickHouse/ClickHouse/issues/12649) が解決されます。 [#13227](https://github.com/ClickHouse/ClickHouse/pull/13227)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* Processors/PipelineExecutor における軽微な最適化: 妥当なタイミングでループを `break` して抜けるようにしました。 [#13058](https://github.com/ClickHouse/ClickHouse/pull/13058) ([Mark Papadakis](https://github.com/markpapadakis)).
* TABLE キーワードなしでの TRUNCATE TABLE をサポートしました。 [#12653](https://github.com/ClickHouse/ClickHouse/pull/12653) ([Winter Zhang](https://github.com/zhang2014)).
* `EXPLAIN` クエリのフォーマットがデフォルトに上書きされてしまう問題を修正。これにより [#12541](https://github.com/ClickHouse/ClickHouse/issues/12432) が修正される。 [#12541](https://github.com/ClickHouse/ClickHouse/pull/12541) ([BohuTANG](https://github.com/BohuTANG)).
* JOIN の種別とタイプを、`SEMI LEFT JOIN` ではなく `LEFT SEMI JOIN` を使う、より標準的な方法で指定できるようにしました。現時点ではどちらの書き方も有効です。 [#12520](https://github.com/ClickHouse/ClickHouse/pull/12520) ([Artem Zuikov](https://github.com/4ertus2)).
* `multiple_joins_rewriter_version` のデフォルト値を 2 に変更しました。これにより、列名を認識できる新しい multiple joins rewriter が有効になります。 [#12469](https://github.com/ClickHouse/ClickHouse/pull/12469) ([Artem Zuikov](https://github.com/4ertus2))。
* S3 ストレージへのリクエストに関するメトリクスを複数追加しました。 [#12464](https://github.com/ClickHouse/ClickHouse/pull/12464) ([ianton-ru](https://github.com/ianton-ru)).
* `--secure` 引数を指定した `clickhouse-benchmark` が、正しいデフォルトのセキュアポートを使用するようにしました。これにより [#11044](https://github.com/ClickHouse/ClickHouse/issues/11044) が修正されます。 [#12440](https://github.com/ClickHouse/ClickHouse/pull/12440) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `Log`、`TinyLog`、`StripeLog` エンジンで挿入エラーをロールバックするようにしました。以前のバージョンでは、挿入エラーが発生するとテーブル状態が不整合になることがありました（これはドキュメントどおりの動作であり、これらのテーブルエンジンでは正常とされていました）。この変更により [#12402](https://github.com/ClickHouse/ClickHouse/issues/12402) が修正されました。[#12426](https://github.com/ClickHouse/ClickHouse/pull/12426)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `Atomic` データベースエンジン向けに `RENAME DATABASE` および `RENAME DICTIONARY` を実装しました。- ZooKeeper パスで `ReplicatedMergeTree` 用に使用できる暗黙の `{uuid}` マクロを追加しました。これは `CREATE ... ON CLUSTER ...` クエリで機能します。これを使用するには、`show_table_uuid_in_table_create_query_if_not_nil` を `true` に設定します。- `ReplicatedMergeTree` エンジンの引数を省略可能にしました。デフォルトで `/clickhouse/tables/{uuid}/{shard}/` および `{replica}` が使用されます。 [#12135](https://github.com/ClickHouse/ClickHouse/issues/12135) をクローズしました。- 細かな修正を行いました。- これらの変更は `Atomic` データベースエンジンとの後方互換性を損ないます。既に作成済みの `Atomic` データベースは、新しいフォーマットに手動で変換する必要があります。Atomic データベースは実験的な機能です。 [#12343](https://github.com/ClickHouse/ClickHouse/pull/12343)（[tavplubix](https://github.com/tavplubix)）。
* `AWSAuthV4Signer` を別のロガーに切り出し、ログメッセージから過剰な `AWSClient: AWSClient` を削除しました。 [#12320](https://github.com/ClickHouse/ClickHouse/pull/12320) ([Vladimir Chebotarev](https://github.com/excitoon)).
* ディスクアクセスストレージにおける例外メッセージを改善しました。 [#12625](https://github.com/ClickHouse/ClickHouse/pull/12625) ([alesapin](https://github.com/alesapin)).
* 引数の数が不正な場合の関数 `in` の例外を改善。 [#12529](https://github.com/ClickHouse/ClickHouse/pull/12529) ([Anton Popov](https://github.com/CurtizJ)).
* アダプティブグラニュラリティに関するエラーメッセージを修正。 [#12624](https://github.com/ClickHouse/ClickHouse/pull/12624) ([alesapin](https://github.com/alesapin)).
* FORMAT の後にある SETTINGS のパースを修正。 [#12480](https://github.com/ClickHouse/ClickHouse/pull/12480) ([Azat Khuzhin](https://github.com/azat)).
* MergeTree テーブルに `ORDER BY` や `PARTITION BY` が含まれていない場合、すべてのカラムを `CLEAR` する `ALTER` を実行すると、`ALTER` がハングしてしまうことがありました。修正 [#7941](https://github.com/ClickHouse/ClickHouse/issues/7941)。[#12382](https://github.com/ClickHouse/ClickHouse/pull/12382)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 他のクライアントセッションとの履歴の競合を避けるため、各クエリ後に履歴ファイルから補完を再読み込みしないようにしました。 [#13086](https://github.com/ClickHouse/ClickHouse/pull/13086) ([Azat Khuzhin](https://github.com/azat)).

#### パフォーマンス改善 {#performance-improvement-6}

- 一部の操作でメモリ使用量を最大2倍削減しました。[#12424](https://github.com/ClickHouse/ClickHouse/pull/12424) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 正確なプライマリキー範囲に一致するクエリのプライマリキー検索を最適化しました。[#12277](https://github.com/ClickHouse/ClickHouse/pull/12277) ([Ivan Babrou](https://github.com/bobrik))。
- `LowCardinality`を使用する非常に短いクエリをわずかに最適化しました。[#14129](https://github.com/ClickHouse/ClickHouse/pull/14129) ([Anton Popov](https://github.com/CurtizJ))。
- UInt8/UInt16キーによる集約のパフォーマンスをわずかに改善しました。[#13091](https://github.com/ClickHouse/ClickHouse/pull/13091) および [#13055](https://github.com/ClickHouse/ClickHouse/pull/13055) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- クエリプラン(サブクエリ内)の`LIMIT`ステップをプッシュダウンしました。[#13016](https://github.com/ClickHouse/ClickHouse/pull/13016) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- [#11564](https://github.com/ClickHouse/ClickHouse/issues/11564)で説明されているように、パート上でのプライマリキー検索とスキップインデックスステージの並列化を実装しました。[#12589](https://github.com/ClickHouse/ClickHouse/pull/12589) ([Ivan Babrou](https://github.com/bobrik))。
- `set optimize_if_transform_strings_to_enum = 1`の場合、関数「if」および「transform」のString型引数をenumに変換します。[#12515](https://github.com/ClickHouse/ClickHouse/pull/12515) ([Artem Zuikov](https://github.com/4ertus2))。
- `set optimize_monotonous_functions_in_order_by=1`の場合、`ORDER BY`内の単調関数をその引数で置き換えます。[#12467](https://github.com/ClickHouse/ClickHouse/pull/12467) ([Artem Zuikov](https://github.com/4ertus2))。
- `set optimize_redundant_functions_in_order_by = 1`の場合、`ORDER BY x, f(x)`を`ORDER BY x`に書き換えるorder by最適化を追加しました。[#12404](https://github.com/ClickHouse/ClickHouse/pull/12404) ([Artem Zuikov](https://github.com/4ertus2))。
- サブクエリに`WITH`句が含まれる場合に述語のプッシュダウンを許可しました。これにより[#12293](https://github.com/ClickHouse/ClickHouse/issues/12293)が修正されます。[#12663](https://github.com/ClickHouse/ClickHouse/pull/12663) ([Winter Zhang](https://github.com/zhang2014))。
- コンパクトパートからの読み取りパフォーマンスを改善しました。コンパクトパートは実験的機能です。[#12492](https://github.com/ClickHouse/ClickHouse/pull/12492) ([Anton Popov](https://github.com/CurtizJ))。
- `DiskS3`でストリーミング最適化の実装を試みました。DiskS3は実験的機能です。[#12434](https://github.com/ClickHouse/ClickHouse/pull/12434) ([Vladimir Chebotarev](https://github.com/excitoon))。

#### ビルド/テスト/パッケージング改善 {#buildtestingpackaging-improvement-8}


* sh テストのリントには `shellcheck` を使用します。 [#13200](https://github.com/ClickHouse/ClickHouse/pull/13200) [#13207](https://github.com/ClickHouse/ClickHouse/pull/13207) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* GitHub フックでプルリクエストにラベルを設定するスクリプトを追加しました。 [#13183](https://github.com/ClickHouse/ClickHouse/pull/13183) ([alesapin](https://github.com/alesapin)).
* 一部の再帰的なサブモジュールを削除しました。 [#13378](https://github.com/ClickHouse/ClickHouse/issues/13378) を参照。 [#13379](https://github.com/ClickHouse/ClickHouse/pull/13379) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* すべてのサブモジュールが正しい URL を参照していることを確認します。[#13379](https://github.com/ClickHouse/ClickHouse/issues/13379) の続きです。これは [#13378](https://github.com/ClickHouse/ClickHouse/issues/13378) を修正します。[#13397](https://github.com/ClickHouse/ClickHouse/pull/13397)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* クエリ内から参照できるユーザー定義設定のサポートを追加しました。これは、ClickHouse エンジンが他のシステムのコンポーネントとして使用される場合に必要となります。 [#13013](https://github.com/ClickHouse/ClickHouse/pull/13013) ([Vitaly Baranov](https://github.com/vitlibar)).
* `INSERT` 権限の RBAC 機能に対するテストを TestFlows に追加しました。`SELECT` をテストする対象テーブルを拡張しました。新しいテーブルエンジンのテストに対応するために Requirements を追加しました。 [#13340](https://github.com/ClickHouse/ClickHouse/pull/13340) ([MyroTk](https://github.com/MyroTk)).
* ストレステスト中のサーバー再起動時に発生するタイムアウトエラーを修正。 [#13321](https://github.com/ClickHouse/ClickHouse/pull/13321) ([alesapin](https://github.com/alesapin)).
* 高速テストは、サーバーに対してリトライしながら待機するようになりました。 [#13284](https://github.com/ClickHouse/ClickHouse/pull/13284) ([alesapin](https://github.com/alesapin)).
* 関数 `materialize()`（ClickHouse のテスト用関数）は、NULL を期待どおりに処理し、NULL を非定数カラムに変換します。 [#13212](https://github.com/ClickHouse/ClickHouse/pull/13212) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* AArch64 における libunwind のビルドを修正。これにより [#13204](https://github.com/ClickHouse/ClickHouse/issues/13204) が解決されました。[#13208](https://github.com/ClickHouse/ClickHouse/pull/13208)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* テストの不安定さを防ぐために、`zkutil gtest` でのリトライ回数をさらに増やしました。 [#13165](https://github.com/ClickHouse/ClickHouse/pull/13165) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* RBAC TestFlows の細かな修正。 [#13152](https://github.com/ClickHouse/ClickHouse/pull/13152) ([vzakaznikov](https://github.com/vzakaznikov))。
* `00960_live_view_watch_events_live.py` テストを修正。[#13108](https://github.com/ClickHouse/ClickHouse/pull/13108)（[vzakaznikov](https://github.com/vzakaznikov)）。
* ドキュメント用デプロイスクリプトのキャッシュ削除処理を改善。 [#13107](https://github.com/ClickHouse/ClickHouse/pull/13107) ([alesapin](https://github.com/alesapin)).
* いくつかの孤立したテストを `gtest` に書き換えました。テストから不要な `include` を削除しました。 [#13073](https://github.com/ClickHouse/ClickHouse/pull/13073) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* TestFlows における `SELECT` 権限の RBAC 機能向けのテストを追加しました。 [#13061](https://github.com/ClickHouse/ClickHouse/pull/13061) ([Ritaank Tiwari](https://github.com/ritaank)).
* 一部のテストを fast test check で再実行。 [#12992](https://github.com/ClickHouse/ClickHouse/pull/12992) ([alesapin](https://github.com/alesapin)).
* 「rdkafka」ライブラリの MSan エラーを修正しました。これにより [#12990](https://github.com/ClickHouse/ClickHouse/issues/12990) がクローズされます。`rdkafka` をバージョン 1.5（master）に更新しました。[#12991](https://github.com/ClickHouse/ClickHouse/pull/12991)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* AVX-512 を備えたサーバー上でテストが実行された場合に `base64` で発生する UBSan レポートを修正。これにより [#12318](https://github.com/ClickHouse/ClickHouse/issues/12318) が解決されます。Author: @qoega. [#12441](https://github.com/ClickHouse/ClickHouse/pull/12441) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* HDFS ライブラリでの UBSan レポートを修正しました。これにより [#12330](https://github.com/ClickHouse/ClickHouse/issues/12330) がクローズされます。[#12453](https://github.com/ClickHouse/ClickHouse/pull/12453)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 古いバージョンで作成したバックアップを新しいバージョンで復元できることを確認しました。これにより [#8979](https://github.com/ClickHouse/ClickHouse/issues/8979) がクローズされました。 [#12959](https://github.com/ClickHouse/ClickHouse/pull/12959) ([alesapin](https://github.com/alesapin))。
* 統合テスト内で helper&#95;container イメージをビルドしないでください。CI で Docker コンテナをビルドし、統合テストでは事前にビルドされた helper&#95;container を使用してください。 [#12953](https://github.com/ClickHouse/ClickHouse/pull/12953) ([Ilya Yatsishin](https://github.com/qoega)).
* プライマリキー列に対する `ALTER TABLE CLEAR COLUMN` クエリのテストを追加。 [#12951](https://github.com/ClickHouse/ClickHouse/pull/12951) ([alesapin](https://github.com/alesapin))。
* testflows テストのタイムアウト時間を延長しました。 [#12949](https://github.com/ClickHouse/ClickHouse/pull/12949) ([vzakaznikov](https://github.com/vzakaznikov)).
* Mac OS X 上でのテストのビルドを修正しました。これにより [#12767](https://github.com/ClickHouse/ClickHouse/issues/12767) がクローズされます。[#12772](https://github.com/ClickHouse/ClickHouse/pull/12772)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* Connector-ODBC を mysql-connector-odbc-8.0.21 に更新。 [#12739](https://github.com/ClickHouse/ClickHouse/pull/12739) ([Ilya Yatsishin](https://github.com/qoega)).
* TestFlows に RBAC 構文テストを追加。 [#12642](https://github.com/ClickHouse/ClickHouse/pull/12642) ([vzakaznikov](https://github.com/vzakaznikov))。
* TestKeeper のパフォーマンスを改善しました。これにより、Replicated テーブルを集中的に利用するテストが高速化されます。 [#12505](https://github.com/ClickHouse/ClickHouse/pull/12505) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* ストレステスト実行後にサーバーが起動できることを確認するようにしました。これにより [#12473](https://github.com/ClickHouse/ClickHouse/issues/12473) が修正されます。 [#12496](https://github.com/ClickHouse/ClickHouse/pull/12496) ([alesapin](https://github.com/alesapin))。
* fmtlib を master（7.0.1）に更新しました。 [#12446](https://github.com/ClickHouse/ClickHouse/pull/12446) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 高速テスト用の Docker イメージを追加。 [#12294](https://github.com/ClickHouse/ClickHouse/pull/12294) ([alesapin](https://github.com/alesapin)).
* 統合テスト用の設定パスを再設計。 [#12285](https://github.com/ClickHouse/ClickHouse/pull/12285) ([Ilya Yatsishin](https://github.com/qoega)).
* スタックフレームが大きくなりすぎないよう制御するコンパイラオプションを追加しました。これにより、小さなスタックサイズのファイバー上でもコードを実行しやすくなります。 [#11524](https://github.com/ClickHouse/ClickHouse/pull/11524) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* gitignore ファイルを更新。 [#13447](https://github.com/ClickHouse/ClickHouse/pull/13447) ([vladimir-golovchenko](https://github.com/vladimir-golovchenko)).





## ClickHouse リリース 20.6 {#clickhouse-release-206}

### ClickHouse リリース v20.6.3.28-stable {#clickhouse-release-v206328-stable}

#### 後方互換性のない変更 {#backward-incompatible-change-6}

- 20.5より古いバージョンからアップグレードする際、ローリングアップデートを実行し、クラスタに20.5以上のバージョンと20.5未満のバージョンが混在している場合、古いバージョンのClickHouseノードを再起動すると、新しいバージョンが存在する状態で古いバージョンが起動し、`Part ... intersects previous part`エラーが発生する可能性があります。このエラーを防ぐには、まずすべてのクラスタノードに新しいclickhouse-serverパッケージをインストールしてから再起動を行ってください(これにより、clickhouse-serverの再起動時に新しいバージョンで起動します)。

#### 新機能 {#new-feature-6}

- `EXPLAIN`クエリの初期実装を追加しました。構文: `EXPLAIN SELECT ...`。これにより[#1118](https://github.com/ClickHouse/ClickHouse/issues/1118)が修正されます。[#11873](https://github.com/ClickHouse/ClickHouse/pull/11873) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- `RabbitMQ`ストレージを追加しました。[#11069](https://github.com/ClickHouse/ClickHouse/pull/11069) ([Kseniia Sumarokova](https://github.com/kssenii))。
- PostgreSQL風の`ILIKE`演算子を実装しました([#11710](https://github.com/ClickHouse/ClickHouse/issues/11710))。[#12125](https://github.com/ClickHouse/ClickHouse/pull/12125) ([Mike](https://github.com/myrrc))。
- `SET join_algorithm = 'partial_merge'`でのRIGHTおよびFULL JOINをサポートしました。ALL厳密性のみが許可されます(ANY、SEMI、ANTI、ASOFは不可)。[#12118](https://github.com/ClickHouse/ClickHouse/pull/12118) ([Artem Zuikov](https://github.com/4ertus2))。
- 単一の値に基づいて集計を初期化する`initializeAggregation`関数を追加しました。[#12109](https://github.com/ClickHouse/ClickHouse/pull/12109) ([Guillaume Tassery](https://github.com/YiuRULE))。
- `ALTER TABLE ... [ADD|MODIFY] COLUMN ... FIRST`をサポートしました([#4006](https://github.com/ClickHouse/ClickHouse/issues/4006))。[#12073](https://github.com/ClickHouse/ClickHouse/pull/12073) ([Winter Zhang](https://github.com/zhang2014))。
- `parseDateTimeBestEffortUS`関数を追加しました。[#12028](https://github.com/ClickHouse/ClickHouse/pull/12028) ([flynn](https://github.com/ucasFL))。
- 出力用の`ORC`フォーマットをサポートしました(以前は入力のみサポート)。[#11662](https://github.com/ClickHouse/ClickHouse/pull/11662) ([Kruglov Pavel](https://github.com/Avogar))。

#### バグ修正 {#bug-fix-25}


* `SET optimize_move_functions_out_of_any = 1` と `any()` 内のエイリアスにより、`aggregate function any(x) is found inside another aggregate function in query` エラーを修正しました。 [#13419](https://github.com/ClickHouse/ClickHouse/pull/13419) ([Artem Zuikov](https://github.com/4ertus2)).
* clickhouse-local 用の `PrettyCompactMonoBlock` を修正。`PrettyCompactMonoBlock` 使用時の extremes/totals を修正。[#7746](https://github.com/ClickHouse/ClickHouse/issues/7746) を修正。[#13394](https://github.com/ClickHouse/ClickHouse/pull/13394)（[Azat Khuzhin](https://github.com/azat)）。
* 遅延レプリカからのクエリで発生する可能性があった `Totals having transform was already added to pipeline` エラーを修正しました。 [#13290](https://github.com/ClickHouse/ClickHouse/pull/13290) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* ユーザーが関数 `h3ToChildren` に細工された引数を渡した場合、サーバーがクラッシュする可能性がありました。これにより [#13275](https://github.com/ClickHouse/ClickHouse/issues/13275) が修正されました。 [#13277](https://github.com/ClickHouse/ClickHouse/pull/13277)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* NaN 値を含む Float 型に対して呼び出された `uniqExact`、`topK`、`sumDistinct` などの集計関数における、潜在的な低パフォーマンスとわずかに不正確な結果を修正しました。これにより debug ビルドで assert が発生していた問題も解消されました。この変更により [#12491](https://github.com/ClickHouse/ClickHouse/issues/12491) が修正されました。[#13254](https://github.com/ClickHouse/ClickHouse/pull/13254)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* リテラル `NULL` ではない nullable な `constexpr` を条件 `cond` に取る `if` 関数の不具合を修正しました。[#12463](https://github.com/ClickHouse/ClickHouse/issues/12463) を修正します。 [#13226](https://github.com/ClickHouse/ClickHouse/pull/13226)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 配列要素が `Nullable` であり、かつ配列添字も `Nullable` の場合における `arrayElement` 関数内のアサートを修正しました。これにより [#12172](https://github.com/ClickHouse/ClickHouse/issues/12172) が修正されました。[#13224](https://github.com/ClickHouse/ClickHouse/pull/13224)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 定数引数を取る `DateTime64` 変換関数を修正しました。 [#13205](https://github.com/ClickHouse/ClickHouse/pull/13205) ([Azat Khuzhin](https://github.com/azat)).
* 関数に対するインデックス解析の誤りを修正しました。これにより、`MergeTree` テーブルからの読み取り時に誤ったパーツがプルーニングされてしまう可能性がありました。[#13060](https://github.com/ClickHouse/ClickHouse/issues/13060) を修正。[#12406](https://github.com/ClickHouse/ClickHouse/issues/12406) を修正。[#13081](https://github.com/ClickHouse/ClickHouse/pull/13081)（[Anton Popov](https://github.com/CurtizJ)）。
* `now()`, `now64()`, `randConstant()` のように、クエリのスコープ内では決定的だがクエリ間では決定的でない関数を使用するリモートクエリで発生していた `Cannot convert column because it is constant but values of constants are different in source and result` エラーを修正しました。[#11327](https://github.com/ClickHouse/ClickHouse/issues/11327) を修正。[#13075](https://github.com/ClickHouse/ClickHouse/pull/13075) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* ローカルレプリカからの `SELECT` に対するスレッド数の不要な制限を修正しました。 [#12840](https://github.com/ClickHouse/ClickHouse/pull/12840) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `ALTER DELETE` と `ALTER MODIFY COLUMN` クエリが 1 つのミューテーションとして同時に実行された場合にのみ発生する、まれなバグを修正しました。このバグにより `count.txt` 内の行数が不正になり、その結果としてパーツ内のデータも不正になる問題がありました。また、`ALTER RENAME COLUMN` と `ALTER ADD COLUMN` を同時に実行した場合に発生する小さなバグも修正しました。 [#12760](https://github.com/ClickHouse/ClickHouse/pull/12760) ([alesapin](https://github.com/alesapin))。
* `CAST(Nullable(String), Enum())` の問題を修正しました。 [#12745](https://github.com/ClickHouse/ClickHouse/pull/12745) ([Azat Khuzhin](https://github.com/azat)).
* `IN` 節で関数として解釈される大きなタプルに関するパフォーマンス問題を修正しました。ユーザーが何らかの理由で `WHERE x IN (1, 2, ...)` ではなく `WHERE x IN tuple(1, 2, ...)` と記述している場合のケースです。 [#12700](https://github.com/ClickHouse/ClickHouse/pull/12700) ([Anton Popov](https://github.com/CurtizJ)).
* スレッドをグループにアタッチすることで、`input_format_parallel_parsing` のメモリトラッキングを修正しました。 [#12672](https://github.com/ClickHouse/ClickHouse/pull/12672) ([Azat Khuzhin](https://github.com/azat)).
* 定数式を使用する固定 Bloom フィルタインデックスを修正しました。これにより [#10572](https://github.com/ClickHouse/ClickHouse/issues/10572) が解決されました。[#12659](https://github.com/ClickHouse/ClickHouse/pull/12659)（[Winter Zhang](https://github.com/zhang2014)）。
* ブローカーが利用不能な場合（など）に `StorageKafka` で発生していた `SIGSEGV` を修正。 [#12658](https://github.com/ClickHouse/ClickHouse/pull/12658) ([Azat Khuzhin](https://github.com/azat)).
* `Array(UUID)` 引数を取る関数 `if` のサポートを追加しました。これにより [#11066](https://github.com/ClickHouse/ClickHouse/issues/11066) が修正されました。 [#12648](https://github.com/ClickHouse/ClickHouse/pull/12648) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `CREATE USER IF NOT EXISTS` は、ユーザーが既に存在する場合に例外をスローしなくなりました。これにより [#12507](https://github.com/ClickHouse/ClickHouse/issues/12507) が修正されました。 [#12646](https://github.com/ClickHouse/ClickHouse/pull/12646) ([Vitaly Baranov](https://github.com/vitlibar)).
* ディスクアクセスストレージにおける例外メッセージを改善。 [#12625](https://github.com/ClickHouse/ClickHouse/pull/12625) ([alesapin](https://github.com/alesapin)).
* 関数 `groupArrayMoving*` が分散クエリで正しく動作していませんでした。その結果は、（最大の型への昇格を行わずに）誤ったデータ型で計算されていました。関数 `groupArrayMovingAvg` は、`avg` 関数と一貫性のない整数値を返していました。これにより [#12568](https://github.com/ClickHouse/ClickHouse/issues/12568) が修正されます。 [#12622](https://github.com/ClickHouse/ClickHouse/pull/12622)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `any` 関数でエイリアスを使用できなかった問題を修正しました。 [#12593](https://github.com/ClickHouse/ClickHouse/pull/12593) ([Anton Popov](https://github.com/CurtizJ)).
* キャッシュレイアウトを使用する外部ディクショナリにおけるレースコンディションを修正しました。これはサーバーのクラッシュを引き起こす可能性がありました。 [#12566](https://github.com/ClickHouse/ClickHouse/pull/12566) ([alesapin](https://github.com/alesapin)).
* `DROP TABLE` 時に Distributed テーブルのデータ（非同期 `INSERT` のブロック）も削除するようにしました。 [#12556](https://github.com/ClickHouse/ClickHouse/pull/12556) ([Azat Khuzhin](https://github.com/azat)).
* `enable_mixed_granularity_parts=1` のときに `ALTER DELETE` クエリを実行すると古いパーツが壊れてしまうバグを修正しました。 [#12536](https://github.com/ClickHouse/ClickHouse/issues/12536) を修正。 [#12543](https://github.com/ClickHouse/ClickHouse/pull/12543) ([alesapin](https://github.com/alesapin))。
* 引数の数が不正な場合の関数 `in` に対する例外メッセージを改善しました。 [#12529](https://github.com/ClickHouse/ClickHouse/pull/12529) ([Anton Popov](https://github.com/CurtizJ)).
* データの重複を引き起こす可能性があった Live View テーブルのレースコンディションを修正。 [#12519](https://github.com/ClickHouse/ClickHouse/pull/12519) ([vzakaznikov](https://github.com/vzakaznikov)).
* コンパクトパーツからの読み取り時に発生していたパフォーマンス問題を修正しました。 [#12492](https://github.com/ClickHouse/ClickHouse/pull/12492) ([Anton Popov](https://github.com/CurtizJ)).
* `AggregateFunction(avg, ...)` の値のバイナリ形式における後方互換性の問題を修正しました。これにより [#12342](https://github.com/ClickHouse/ClickHouse/issues/12342) が解決されています。 [#12486](https://github.com/ClickHouse/ClickHouse/pull/12486)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* FORMAT 以降の SETTINGS の構文解析を修正しました。 [#12480](https://github.com/ClickHouse/ClickHouse/pull/12480) ([Azat Khuzhin](https://github.com/azat)).
* `text_log` が有効な場合に発生していたデッドロックを修正しました。 [#12452](https://github.com/ClickHouse/ClickHouse/pull/12452) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 非常に大きな `LIMIT` または `OFFSET` が指定された場合に発生していたオーバーフローを修正しました。これにより [#10470](https://github.com/ClickHouse/ClickHouse/issues/10470) が修正されます。また [#11372](https://github.com/ClickHouse/ClickHouse/issues/11372) も修正されます。[#12427](https://github.com/ClickHouse/ClickHouse/pull/12427)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `StorageMerge` で発生する可能性のあったセグメンテーションフォルトを修正しました。これにより [#12054](https://github.com/ClickHouse/ClickHouse/issues/12054) が解決されました。 [#12401](https://github.com/ClickHouse/ClickHouse/pull/12401) ([tavplubix](https://github.com/tavplubix))。
* [#12098](https://github.com/ClickHouse/ClickHouse/issues/12098) を解決するために、[#11079](https://github.com/ClickHouse/ClickHouse/issues/11079) で導入された変更を元に戻しました。 [#12397](https://github.com/ClickHouse/ClickHouse/pull/12397) ([Mike](https://github.com/myrrc))。
* ブルームフィルターインデックスの引数に対する追加チェックを行いました。これにより [#11408](https://github.com/ClickHouse/ClickHouse/issues/11408) が修正されました。[#12388](https://github.com/ClickHouse/ClickHouse/pull/12388)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* インデックス付きテーブルの `WHERE` 条件で負の定数または浮動小数点定数が使用されたときに、例外が発生しないようにしました。これにより [#11905](https://github.com/ClickHouse/ClickHouse/issues/11905) が修正されました。 [#12384](https://github.com/ClickHouse/ClickHouse/pull/12384) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 依存する `DEFAULT` 式が存在する場合でも、カラムを `CLEAR` できるようにしました。これにより [#12333](https://github.com/ClickHouse/ClickHouse/issues/12333) が修正されました。 [#12378](https://github.com/ClickHouse/ClickHouse/pull/12378) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `-State` と `Nullable` 引数を持つ集約関数に対する `TOTALS/ROLLUP/CUBE` の動作を修正しました。これにより [#12163](https://github.com/ClickHouse/ClickHouse/issues/12163) が解決されます。 [#12376](https://github.com/ClickHouse/ClickHouse/pull/12376) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `RENAME` が許可されていない場合の `ALTER RENAME COLUMN` クエリに対するエラーメッセージと終了コードを修正しました。[#12301](https://github.com/ClickHouse/ClickHouse/issues/12301) および [#12303](https://github.com/ClickHouse/ClickHouse/issues/12303) を修正します。[#12335](https://github.com/ClickHouse/ClickHouse/pull/12335)（[alesapin](https://github.com/alesapin)）。
* `ReplicatedMergeTreeQueue` でごくまれに発生するレースコンディションを修正しました。 [#12315](https://github.com/ClickHouse/ClickHouse/pull/12315) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 固定長型以外の型でコーデック `Delta` または `DoubleDelta` を使用した場合に、本来であればコード `BAD_ARGUMENTS` の例外が返されるべきところで、コード `LOGICAL_ERROR` の例外が返されていました（コード `LOGICAL_ERROR` の例外は決して発生しないように保証しています）。この修正により [#12110](https://github.com/ClickHouse/ClickHouse/issues/12110) が解決されました。 [#12308](https://github.com/ClickHouse/ClickHouse/pull/12308)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `WITH FILL` 修飾子における列の順序を修正しました。以前は `ORDER BY` 句で指定した列の順序が反映されていませんでした。 [#12306](https://github.com/ClickHouse/ClickHouse/pull/12306) ([Anton Popov](https://github.com/CurtizJ)).
* 仮想カラム（`Merge` テーブルの `_table` など）によるフィルタリングや、`system.tables` をクエリするときにデータベース名でフィルタリングする場合など、システムテーブルの「index」カラムでデータを絞り込む式があり、その式が `Nullable` 型を返す場合に発生する「bad cast」例外を回避します。これにより [#12166](https://github.com/ClickHouse/ClickHouse/issues/12166) が修正されました。 [#12305](https://github.com/ClickHouse/ClickHouse/pull/12305)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `TTL` 式が依存しているカラムの名前を変更した後の `TTL` の動作を修正しました。 [#12304](https://github.com/ClickHouse/ClickHouse/pull/12304) ([Anton Popov](https://github.com/CurtizJ)).
* `Kafka` エンジンで、バッチの途中にエラーを含むメッセージがある場合に発生していた SIGSEGV を修正しました。 [#12302](https://github.com/ClickHouse/ClickHouse/pull/12302) ([Azat Khuzhin](https://github.com/azat)).
* `DNS` キャッシュの更新中に、一部のスレッドが数秒間ランダムにハングする可能性があった問題を修正しました。 [#12296](https://github.com/ClickHouse/ClickHouse/pull/12296) ([tavplubix](https://github.com/tavplubix)).
* 設定名の誤字を修正しました。 [#12292](https://github.com/ClickHouse/ClickHouse/pull/12292) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `TrieDictionary` の読み込みに失敗した際にエラーを表示するようにしました。 [#12290](https://github.com/ClickHouse/ClickHouse/pull/12290) ([Vitaly Baranov](https://github.com/vitlibar)).
* 空配列に対して `arrayFill` 関数が正しく動作せず、クラッシュを引き起こす可能性がありました。これにより [#12263](https://github.com/ClickHouse/ClickHouse/issues/12263) が修正されました。[#12279](https://github.com/ClickHouse/ClickHouse/pull/12279)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `LowCardinality` 型に対する共通型への変換を実装しました。これにより、LowCardinality 型のカラムとその他のカラムを持つテーブル間で `UNION ALL` を実行できるようになります。これにより [#8212](https://github.com/ClickHouse/ClickHouse/issues/8212) が修正されます。また、[#4342](https://github.com/ClickHouse/ClickHouse/issues/4342) も修正されます。[#12275](https://github.com/ClickHouse/ClickHouse/pull/12275)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `S3` ストレージへのリクエストでリダイレクト上限に達した場合の動作を修正しました。 [#12256](https://github.com/ClickHouse/ClickHouse/pull/12256) ([ianton-ru](https://github.com/ianton-ru)).
* `StorageFile` に対して複数回連続して挿入を行った際に、一部の特殊な型でヘッダーが複数回書き込まれてしまう問題を修正しました。これにより [#6155](https://github.com/ClickHouse/ClickHouse/issues/6155) が解決されました。 [#12197](https://github.com/ClickHouse/ClickHouse/pull/12197) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* UInt8 値が 0 または 1 以外の場合における論理関数の動作を修正しました。 [#12196](https://github.com/ClickHouse/ClickHouse/pull/12196) ([Alexander Kazakov](https://github.com/Akazz)).
* max&#95;memory&#95;usage* の上限をプロセスの常駐メモリ量に抑えるようにしました。 [#12182](https://github.com/ClickHouse/ClickHouse/pull/12182) ([Azat Khuzhin](https://github.com/azat)).
* `GROUP BY` の単射関数削除時における `dictGet` の引数チェックを修正。 [#12179](https://github.com/ClickHouse/ClickHouse/pull/12179) ([Azat Khuzhin](https://github.com/azat)).
* `SummingMergeTree` エンジンがパーティションキーの列を集計する際の動作を修正しました。集計対象の列を明示的に指定した場合に、それがパーティションキーの列と重複しているときは例外をスローするようにしました。これにより [#7867](https://github.com/ClickHouse/ClickHouse/issues/7867) が修正されました。[#12173](https://github.com/ClickHouse/ClickHouse/pull/12173)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* ODBC 接続がスキーマをサポートしていない場合は、辞書ソースのテーブル名をスキーマ名とテーブル名に分割しないようにしました。 [#12165](https://github.com/ClickHouse/ClickHouse/pull/12165) ([Vitaly Baranov](https://github.com/vitlibar)).
* `ALTER DELETE` において、条件式の評価結果が NULL の場合にレコードが削除されてしまう誤ったロジックを修正しました。これにより [#9088](https://github.com/ClickHouse/ClickHouse/issues/9088) が修正され、[#12106](https://github.com/ClickHouse/ClickHouse/issues/12106) がクローズされます。[#12153](https://github.com/ClickHouse/ClickHouse/pull/12153)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* エイリアスが存在する場合に、外部 DBMS（例: MySQL、ODBC）に送信するクエリの変換処理を修正しました。これにより [#12032](https://github.com/ClickHouse/ClickHouse/issues/12032) が解決されました。[#12151](https://github.com/ClickHouse/ClickHouse/pull/12151)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 冗長な ORDER BY の最適化における不適切なコードを修正しました。このバグは [#10067](https://github.com/ClickHouse/ClickHouse/issues/10067) で導入されました。[#12148](https://github.com/ClickHouse/ClickHouse/pull/12148)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 整数除算で発生し得るオーバーフローを修正しました。これにより [#12119](https://github.com/ClickHouse/ClickHouse/issues/12119) が解決されます。[#12140](https://github.com/ClickHouse/ClickHouse/pull/12140)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `greatCircleDistance`、`geoDistance` における無限ループが発生する可能性のある問題を修正しました。これにより [#12117](https://github.com/ClickHouse/ClickHouse/issues/12117) が解決されます。 [#12137](https://github.com/ClickHouse/ClickHouse/pull/12137) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 「pid」ファイルの扱いを整理しました。以前のバージョンでは、サーバーが適切にシャットダウンされずに kill された場合、その後に別のプロセスが以前動作していたサーバーと同じ pid を使用していると、サーバーの起動が拒否されることがありました。また、別のサーバーが稼働している場合でも、サーバーの起動に失敗すると pid ファイルが削除されてしまうことがありました。これにより [#3501](https://github.com/ClickHouse/ClickHouse/issues/3501) が修正されました。 [#12133](https://github.com/ClickHouse/ClickHouse/pull/12133) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* ReplicatedVersionedCollapsingMergeTree テーブルに対して ZooKeeper 内のテーブルメタデータが不正になる不具合を修正しました。 [#12093](https://github.com/ClickHouse/ClickHouse/issues/12093) を修正します。 [#12121](https://github.com/ClickHouse/ClickHouse/pull/12121) ([alesapin](https://github.com/alesapin))。
* `system` ログ（`system.query_log` や `metric_log` など）や、`engine=Buffer` の基盤テーブルに対して紐付けられた `JOIN` またはサブクエリを含む `Materialized View` で発生する &quot;There is no query&quot; 例外を回避しました。 [#12120](https://github.com/ClickHouse/ClickHouse/pull/12120) ([filimonov](https://github.com/filimonov)).
* ENGINE=Dictionary のテーブルにおけるディクショナリへの依存関係の扱いを修正しました。これにより [#10994](https://github.com/ClickHouse/ClickHouse/issues/10994) および [#10397](https://github.com/ClickHouse/ClickHouse/issues/10397) が修正されます。 [#12116](https://github.com/ClickHouse/ClickHouse/pull/12116) ([Vitaly Baranov](https://github.com/vitlibar)).
* `Parquet` フォーマットが `LowCardinality` および `LowCardinality(Nullable)` 型で正しく動作するようになりました。 [#12086](https://github.com/ClickHouse/ClickHouse/issues/12086)、[#8406](https://github.com/ClickHouse/ClickHouse/issues/8406) を修正。 [#12108](https://github.com/ClickHouse/ClickHouse/pull/12108)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `UNION` を含む `SELECT` において、スレッド総数に対する誤った上限設定が原因で発生していたパフォーマンス問題を修正しました。 [#12030](https://github.com/ClickHouse/ClickHouse/issues/12030) を修正。 [#12103](https://github.com/ClickHouse/ClickHouse/pull/12103)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `-StateResample` コンビネータで発生していたセグメンテーションフォールトを修正しました。 [#12092](https://github.com/ClickHouse/ClickHouse/pull/12092) ([Anton Popov](https://github.com/CurtizJ)).
* `SELECT` において `system.quey_log` の `result_rows` および `result_bytes` メトリクスが空になる問題を修正しました。 [#11595](https://github.com/ClickHouse/ClickHouse/issues/11595) を修正。 [#12089](https://github.com/ClickHouse/ClickHouse/pull/12089)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `VIEW` からの SELECT に対してスレッド数を不必要に制限していた問題を修正しました。[#11937](https://github.com/ClickHouse/ClickHouse/issues/11937) を修正。[#12085](https://github.com/ClickHouse/ClickHouse/pull/12085)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `DROP TABLE` 時の `StorageKafka` で発生する SIGSEGV を修正。 [#12075](https://github.com/ClickHouse/ClickHouse/pull/12075) ([Azat Khuzhin](https://github.com/azat))。
* `PREWHERE` に誤った型を使用した際に発生する可能性のあったクラッシュを修正しました。[#12053](https://github.com/ClickHouse/ClickHouse/issues/12053)、[#12060](https://github.com/ClickHouse/ClickHouse/issues/12060) を修正。[#12060](https://github.com/ClickHouse/ClickHouse/pull/12060)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `Tuple(LowCardinality)` 引数を持つ高階関数で発生していた `Cannot capture column` エラーを修正しました。[#9766](https://github.com/ClickHouse/ClickHouse/issues/9766) を解決。 [#12055](https://github.com/ClickHouse/ClickHouse/pull/12055)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 固定制約が、その制約が定数式であるかどうかをチェックするようにしました。これにより [#11360](https://github.com/ClickHouse/ClickHouse/issues/11360) が修正されました。[#12042](https://github.com/ClickHouse/ClickHouse/pull/12042)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* サイズが異なる `FixedString` 型の引数で関数 `if` を呼び出した際に、誤った結果やクラッシュが発生する可能性があった問題を修正しました。これにより [#11362](https://github.com/ClickHouse/ClickHouse/issues/11362) が解決されました。 [#12021](https://github.com/ClickHouse/ClickHouse/pull/12021)（[alexey-milovidov](https://github.com/alexey-milovidov)）。

#### 改善 {#improvement-14}

- `JOIN`の種類と型をより標準的な方法で設定できるようになりました：`SEMI LEFT JOIN`の代わりに`LEFT SEMI JOIN`を使用できます。現時点では両方とも正しい記法です。[#12520](https://github.com/ClickHouse/ClickHouse/pull/12520) ([Artem Zuikov](https://github.com/4ertus2))。
- Bufferエンジンにlifetime_rows/lifetime_bytesを追加しました。[#12421](https://github.com/ClickHouse/ClickHouse/pull/12421) ([Azat Khuzhin](https://github.com/azat))。
- 'MySQL server has gone away'の代わりに、詳細な例外メッセージをクライアントに書き込むようにしました。[#12383](https://github.com/ClickHouse/ClickHouse/pull/12383) ([BohuTANG](https://github.com/BohuTANG))。
- グリッド境界線の印刷に使用される文字セットを変更できるようになりました。利用可能な文字セットは次のとおりです：UTF-8、ASCII。設定`output_format_pretty_grid_charset`でこの機能を有効にします。[#12372](https://github.com/ClickHouse/ClickHouse/pull/12372) ([Sabyanin Maxim](https://github.com/s-mx))。
- MySQLの'SELECT DATABASE()'をサポートしました [#9336](https://github.com/ClickHouse/ClickHouse/issues/9336) 2. MySQL置換クエリの統合テストを追加しました。[#12314](https://github.com/ClickHouse/ClickHouse/pull/12314) ([BohuTANG](https://github.com/BohuTANG))。
- MySQLクライアント/ドライバーで長時間実行されるクエリをキャンセルするための`KILL QUERY [connection_id]`を追加しました。issue [#12038](https://github.com/ClickHouse/ClickHouse/issues/12038)。[#12152](https://github.com/ClickHouse/ClickHouse/pull/12152) ([BohuTANG](https://github.com/BohuTANG))。
- `formatDateTime`関数に`%g`（2桁のISO年）と`%G`（4桁のISO年）の置換サポートを追加しました。[#12136](https://github.com/ClickHouse/ClickHouse/pull/12136) ([vivarum](https://github.com/vivarum))。
- system.disksに'type'カラムを追加しました。[#12115](https://github.com/ClickHouse/ClickHouse/pull/12115) ([ianton-ru](https://github.com/ianton-ru))。
- `REVOKE`コマンドを改善しました：取り消されるアクセス権に対してのみgrant/adminオプションが必要になりました。例えば、`REVOKE ALL ON *.* FROM user1`を実行する際に、grantオプション付きの完全なアクセス権を持つ必要がなくなりました。`REVOKE ALL FROM user1`コマンドを追加しました - これは`user1`から付与されたすべてのロールを取り消します。[#12083](https://github.com/ClickHouse/ClickHouse/pull/12083) ([Vitaly Baranov](https://github.com/vitlibar))。
- load_balancingにレプリカ優先度を追加しました（負荷分散の手動優先順位付けのため）。[#11995](https://github.com/ClickHouse/ClickHouse/pull/11995) ([Azat Khuzhin](https://github.com/azat))。
- S3メタデータ内のパスを相対パスに切り替え、S3 blobをより簡単に処理できるようにしました。[#11892](https://github.com/ClickHouse/ClickHouse/pull/11892) ([Vladimir Chebotarev](https://github.com/excitoon))。

#### パフォーマンス改善 {#performance-improvement-7}


- ソートキーのプレフィックスによる`ORDER BY`および`GROUP BY`のパフォーマンスを改善（`optimize_aggregation_in_order`設定で有効化、デフォルトでは無効）。[#11696](https://github.com/ClickHouse/ClickHouse/pull/11696) ([Anton Popov](https://github.com/CurtizJ))。
- `optimize_injective_functions_inside_uniq=1`に設定した場合、`uniq*()`内の単射関数を削除。[#12337](https://github.com/ClickHouse/ClickHouse/pull/12337) ([Ruslan Kamalov](https://github.com/kamalov-ruslan))。
- リテラルを含むIN演算子でインデックスが使用されない問題を修正。v19.3頃に導入されたパフォーマンス低下に対処。これにより[#10574](https://github.com/ClickHouse/ClickHouse/issues/10574)が修正されます。[#12062](https://github.com/ClickHouse/ClickHouse/pull/12062) ([nvartolomei](https://github.com/nvartolomei))。
- DiskS3のシングルパートアップロードを実装（実験的機能）。[#12026](https://github.com/ClickHouse/ClickHouse/pull/12026) ([Vladimir Chebotarev](https://github.com/excitoon))。

#### 実験的機能 {#experimental-feature-4}

- `MergeTree`ファミリーテーブルに、データをメモリに格納する新しいインメモリ形式のパートを追加。パートは最初のマージ時にディスクに書き込まれます。パートのサイズが行数またはバイト数で`min_rows_for_compact_part`および`min_bytes_for_compact_part`の閾値を下回る場合、インメモリ形式で作成されます。また、Write-Ahead-Logのオプションサポートが利用可能で、デフォルトで有効化されており、`in_memory_parts_enable_wal`設定で制御されます。[#10697](https://github.com/ClickHouse/ClickHouse/pull/10697) ([Anton Popov](https://github.com/CurtizJ))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-9}


* clickhouse-client 向けに AST ベースのクエリファジングモードを実装しました。ファジングによって最近発見された issue の一覧については [このラベル](https://github.com/ClickHouse/ClickHouse/issues?q=label%3Afuzz+is%3Aissue) を参照してください。そのほとんどはこのツールで発見されたもので、いくつかは SQLancer と `00746_sql_fuzzy.pl` によるものです。[#12111](https://github.com/ClickHouse/ClickHouse/pull/12111) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Testflows フレームワークに基づく新しい種類のテストを追加しました。[#12090](https://github.com/ClickHouse/ClickHouse/pull/12090) ([vzakaznikov](https://github.com/vzakaznikov)).
* S3 HTTPS 統合テストを追加しました。[#12412](https://github.com/ClickHouse/ClickHouse/pull/12412) ([Pavel Kovalenko](https://github.com/Jokser)).
* サニタイザートラップメッセージを別スレッドからログに記録するようにしました。これにより thread sanitizer 実行時に発生しうるデッドロックを防止します。[#12313](https://github.com/ClickHouse/ClickHouse/pull/12313) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 機能テストおよびストレステストを、古いバージョンの `clickhouse-test` スクリプトでも実行できるようにしました。[#12287](https://github.com/ClickHouse/ClickHouse/pull/12287) ([alesapin](https://github.com/alesapin)).
* `orc` のビルド中に行われていた不自然なファイル作成処理を削除しました。[#12258](https://github.com/ClickHouse/ClickHouse/pull/12258) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 共通の docker compose ファイルを統合テスト用 Docker コンテナに配置しました。[#12168](https://github.com/ClickHouse/ClickHouse/pull/12168) ([Ilya Yatsishin](https://github.com/qoega)).
* CodeQL による警告を修正しました。`CodeQL` は、既に使用している `clang-tidy` および `PVS-Studio` と併用する、別の静的解析ツールです。[#12138](https://github.com/ClickHouse/ClickHouse/pull/12138) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* UNBUNDLED ビルド向けの軽微な CMake 修正を行いました。[#12131](https://github.com/ClickHouse/ClickHouse/pull/12131) ([Matwey V. Kornilov](https://github.com/matwey)).
* いかなる Linux ディストリビューションも使用しない、最小構成の Docker イメージのショーケースを追加しました。[#12126](https://github.com/ClickHouse/ClickHouse/pull/12126) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `clickhouse-server` Docker イメージ内のシステムパッケージをアップグレードしました。[#12124](https://github.com/ClickHouse/ClickHouse/pull/12124) ([Ivan Blinkov](https://github.com/blinkov)).
* `system.build_options` テーブルに `UNBUNDLED` フラグを追加しました。`clickhouse-test` 用のスキップリストを clickhouse リポジトリに移動しました。[#12107](https://github.com/ClickHouse/ClickHouse/pull/12107) ([alesapin](https://github.com/alesapin)).
* [Anchore Container Analysis](https://docs.anchore.com) セキュリティ解析ツールによる定期チェックを追加しました。このツールは `clickhouse-server` Docker イメージ内の [CVE](https://cve.mitre.org/) を検出し、`Dockerfile` がビルド可能であることも確認します。`master` および `Dockerfile` への pull request に対して、毎日実行されます。[#12102](https://github.com/ClickHouse/ClickHouse/pull/12102) ([Ivan Blinkov](https://github.com/blinkov)).
* [GitHub CodeQL](https://securitylab.github.com/tools/codeql) セキュリティ解析ツールによる、[CWE](https://cwe.mitre.org/) を対象としたデイリーチェックを追加しました。[#12101](https://github.com/ClickHouse/ClickHouse/pull/12101) ([Ivan Blinkov](https://github.com/blinkov)).
* Dockerfile 内で、最初の `apt-get update` の前に `ca-certificates` をインストールするようにしました。[#12095](https://github.com/ClickHouse/ClickHouse/pull/12095) ([Ivan Blinkov](https://github.com/blinkov)).



## ClickHouseリリース 20.5 {#clickhouse-release-205}

### ClickHouseリリース v20.5.4.40-stable 2020-08-10 {#clickhouse-release-v205440-stable-2020-08-10}

#### バグ修正 {#bug-fix-26}


* 関数を使用した際の誤ったインデックス解析を修正しました。これにより、`MergeTree` テーブルから読み取る際に誤った部分がプルーニングされてしまう可能性がありました。この変更により [#13060](https://github.com/ClickHouse/ClickHouse/issues/13060) および [#12406](https://github.com/ClickHouse/ClickHouse/issues/12406) が修正されました。 [#13081](https://github.com/ClickHouse/ClickHouse/pull/13081)（[Anton Popov](https://github.com/CurtizJ)）。
* ローカルレプリカからの `SELECT` におけるスレッド数の不要な制限を修正しました。 [#12840](https://github.com/ClickHouse/ClickHouse/pull/12840) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `IN` 節で関数として解釈される大きな `tuple` を使用した場合のパフォーマンスを修正しました。ユーザーが何らかのよくわからない理由で `WHERE x IN (1, 2, ...)` ではなく `WHERE x IN tuple(1, 2, ...)` と記述するケースです。 [#12700](https://github.com/ClickHouse/ClickHouse/pull/12700) ([Anton Popov](https://github.com/CurtizJ))。
* input&#95;format&#95;parallel&#95;parsing のメモリトラッキングを修正（スレッドをグループにアタッチすることで対応）。 [#12672](https://github.com/ClickHouse/ClickHouse/pull/12672) ([Azat Khuzhin](https://github.com/azat)).
* 定数式を用いた固定 Bloom フィルターインデックスを修正しました。これにより [#10572](https://github.com/ClickHouse/ClickHouse/issues/10572) が解決されました。 [#12659](https://github.com/ClickHouse/ClickHouse/pull/12659)（[Winter Zhang](https://github.com/zhang2014)）。
* ブローカーが利用不能な場合（など）に `StorageKafka` で発生していた `SIGSEGV` を修正しました。 [#12658](https://github.com/ClickHouse/ClickHouse/pull/12658) ([Azat Khuzhin](https://github.com/azat)).
* `Array(UUID)` 引数を取る `if` 関数のサポートを追加しました。これにより [#11066](https://github.com/ClickHouse/ClickHouse/issues/11066) が修正されました。 [#12648](https://github.com/ClickHouse/ClickHouse/pull/12648) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 関数 `any` でエイリアスが不足していた問題を修正しました。 [#12593](https://github.com/ClickHouse/ClickHouse/pull/12593) ([Anton Popov](https://github.com/CurtizJ)).
* キャッシュレイアウトを使用する外部ディクショナリで、サーバークラッシュを引き起こす可能性のあったレースコンディションを修正しました。 [#12566](https://github.com/ClickHouse/ClickHouse/pull/12566) ([alesapin](https://github.com/alesapin)).
* `DROP TABLE` 時に Distributed テーブルのデータ（非同期 `INSERT` によるブロック）も削除するようにしました。 [#12556](https://github.com/ClickHouse/ClickHouse/pull/12556) ([Azat Khuzhin](https://github.com/azat)).
* `enable_mixed_granularity_parts=1` のときに `ALTER DELETE` クエリによって古いパーツが壊れてしまう不具合を修正しました。[#12536](https://github.com/ClickHouse/ClickHouse/issues/12536) を修正。[#12543](https://github.com/ClickHouse/ClickHouse/pull/12543) ([alesapin](https://github.com/alesapin))。
* 無効な引数数が指定された場合の関数 `in` の例外メッセージを改善。 [#12529](https://github.com/ClickHouse/ClickHouse/pull/12529) ([Anton Popov](https://github.com/CurtizJ)).
* データの重複を引き起こす可能性があった Live View テーブルのレースコンディションを修正しました。 [#12519](https://github.com/ClickHouse/ClickHouse/pull/12519) ([vzakaznikov](https://github.com/vzakaznikov)).
* コンパクトパーツからの読み込み時に発生していたパフォーマンス問題を修正しました。 [#12492](https://github.com/ClickHouse/ClickHouse/pull/12492) ([Anton Popov](https://github.com/CurtizJ)).
* `AggregateFunction(avg, ...)` の値のバイナリ形式における後方互換性を修正しました。これにより [#12342](https://github.com/ClickHouse/ClickHouse/issues/12342) が解決されました。 [#12486](https://github.com/ClickHouse/ClickHouse/pull/12486) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `text_log` が有効な場合に発生していたデッドロックを修正しました。 [#12452](https://github.com/ClickHouse/ClickHouse/pull/12452) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 非常に大きな LIMIT または OFFSET が指定された場合に発生するオーバーフローを修正しました。これにより [#10470](https://github.com/ClickHouse/ClickHouse/issues/10470) が解決されます。また、[#11372](https://github.com/ClickHouse/ClickHouse/issues/11372) も解決されます。 [#12427](https://github.com/ClickHouse/ClickHouse/pull/12427)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* StorageMerge 使用時に発生する可能性のあったセグメンテーションフォルトを修正。[#12054](https://github.com/ClickHouse/ClickHouse/issues/12054) をクローズ。[#12401](https://github.com/ClickHouse/ClickHouse/pull/12401) ([tavplubix](https://github.com/tavplubix))。
* [#12098](https://github.com/ClickHouse/ClickHouse/issues/12098) を解決するために、[#11079](https://github.com/ClickHouse/ClickHouse/issues/11079) で導入された変更をリバートしました。[#12397](https://github.com/ClickHouse/ClickHouse/pull/12397)（[Mike](https://github.com/myrrc)）。
* インデックス付きテーブルの `WHERE` 条件で負の定数または浮動小数点定数が使用された場合に、例外が発生しないようにしました。これにより [#11905](https://github.com/ClickHouse/ClickHouse/issues/11905) が修正されました。 [#12384](https://github.com/ClickHouse/ClickHouse/pull/12384) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 依存する `DEFAULT` 式が存在する場合でもカラムを `CLEAR` できるようにしました。これにより [#12333](https://github.com/ClickHouse/ClickHouse/issues/12333) が修正されました。[#12378](https://github.com/ClickHouse/ClickHouse/pull/12378)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `-State` と `Nullable` 引数を持つ集約関数に対する TOTALS/ROLLUP/CUBE の動作を修正しました。これにより [#12163](https://github.com/ClickHouse/ClickHouse/issues/12163) が解決されました。[#12376](https://github.com/ClickHouse/ClickHouse/pull/12376)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `Kafka` エンジンで、バッチの途中にエラーを含むメッセージがある場合に発生していた SIGSEGV を修正。 [#12302](https://github.com/ClickHouse/ClickHouse/pull/12302) ([Azat Khuzhin](https://github.com/azat)).
* `SummingMergeTree` エンジンがパーティションキー列を集計する際の動作を修正しました。合計対象の列を明示的に指定した場合に、それがパーティションキーの列と重複していると例外をスローするようにしました。これにより [#7867](https://github.com/ClickHouse/ClickHouse/issues/7867) が修正されました。 [#12173](https://github.com/ClickHouse/ClickHouse/pull/12173) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* エイリアスが存在する場合に、外部 DBMS（例: MySQL、ODBC）に送信されるクエリの変換処理を修正しました。これにより [#12032](https://github.com/ClickHouse/ClickHouse/issues/12032) が解決されました。 [#12151](https://github.com/ClickHouse/ClickHouse/pull/12151)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* ReplicatedVersionedCollapsingMergeTree テーブルに対して ZooKeepeer 内のテーブルメタデータが不正になる不具合を修正。 [#12093](https://github.com/ClickHouse/ClickHouse/issues/12093) を修正。 [#12121](https://github.com/ClickHouse/ClickHouse/pull/12121) ([alesapin](https://github.com/alesapin))。
* `VIEW` からの select に対してスレッド数が不要に制限されていた問題を修正しました。 [#11937](https://github.com/ClickHouse/ClickHouse/issues/11937) を修正。 [#12085](https://github.com/ClickHouse/ClickHouse/pull/12085)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `join_algorithm=partial_merge` を使用した LowCardinality 型との JOIN で発生していたクラッシュを修正しました。 [#12035](https://github.com/ClickHouse/ClickHouse/pull/12035) ([Artem Zuikov](https://github.com/4ertus2)).
* 条件に NULL を含む `if()` が誤った結果を返す問題を修正しました。 [#11807](https://github.com/ClickHouse/ClickHouse/pull/11807) ([Artem Zuikov](https://github.com/4ertus2)).

#### パフォーマンス改善 {#performance-improvement-8}

- リテラルを使用したIN演算子でインデックスが使用されない問題を修正。v19.3頃に導入されたパフォーマンス低下に対応。[#10574](https://github.com/ClickHouse/ClickHouse/issues/10574)を修正。[#12062](https://github.com/ClickHouse/ClickHouse/pull/12062) ([nvartolomei](https://github.com/nvartolomei))。

#### ビルド/テスト/パッケージング改善 {#buildtestingpackaging-improvement-10}

- Dockerfileで最初の`apt-get update`の前に`ca-certificates`をインストール。[#12095](https://github.com/ClickHouse/ClickHouse/pull/12095) ([Ivan Blinkov](https://github.com/blinkov))。

### ClickHouse release v20.5.2.7-stable 2020-07-02 {#clickhouse-release-v20527-stable-2020-07-02}

#### 後方互換性のない変更 {#backward-incompatible-change-7}

- COUNT(DISTINCT)および`uniq`集約関数ファミリーから非Nullable結果を返すように変更。すべての渡された値がNULLの場合、代わりにゼロを返す。これによりSQL互換性が向上。[#11661](https://github.com/ClickHouse/ClickHouse/pull/11661) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ユーザーレベル設定が誤った場所に指定されている場合のチェックを追加。ユーザーレベル設定は、特定のユーザープロファイルの`users.xml`内の`<profile>`セクション(またはデフォルト設定の場合は`<default>`)に指定する必要がある。サーバーはログに例外メッセージを出力して起動しない。[#9051](https://github.com/ClickHouse/ClickHouse/issues/9051)を修正。チェックをスキップする場合は、設定を適切な場所に移動するか、config.xmlに`<skip_check_for_incorrect_settings>1</skip_check_for_incorrect_settings>`を追加する。[#11449](https://github.com/ClickHouse/ClickHouse/pull/11449) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 設定`input_format_with_names_use_header`がデフォルトで有効化。入力フォーマット`-WithNames`および`-WithNamesAndTypes`の解析に影響する。[#10937](https://github.com/ClickHouse/ClickHouse/pull/10937) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `experimental_use_processors`設定を削除。デフォルトで有効化されている。[#10924](https://github.com/ClickHouse/ClickHouse/pull/10924) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- `zstd`を1.4.4に更新。パフォーマンスと圧縮率にわずかな改善がある。異なるバージョンのClickHouseでレプリカを実行している場合、説明付きで`Data after merge is not byte-identical to data on another replicas.`という妥当なエラーメッセージが表示される可能性がある。これらのメッセージは問題なく、心配する必要はない。この変更は後方互換性があるが、これらのメッセージについて疑問に思う場合に備えて、ここで変更履歴に記載している。[#10663](https://github.com/ClickHouse/ClickHouse/pull/10663) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 無意味なコーデックのチェックと、このチェックを制御する設定`allow_suspicious_codecs`を追加。[#4966](https://github.com/ClickHouse/ClickHouse/issues/4966)をクローズ。[#10645](https://github.com/ClickHouse/ClickHouse/pull/10645) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 複数のKafka設定のデフォルト値が変更。[#11388](https://github.com/ClickHouse/ClickHouse/pull/11388)を参照。
- 20.5より古いバージョンからアップグレードする際、ローリングアップデートを実行し、クラスターに20.5以上と20.5未満の両方のバージョンが含まれている場合、古いバージョンのClickHouseノードが再起動され、新しいバージョンの存在下で古いバージョンが起動すると、`Part ... intersects previous part`エラーが発生する可能性がある。このエラーを防ぐには、まずすべてのクラスターノードに新しいclickhouse-serverパッケージをインストールしてから再起動を実行する(これにより、clickhouse-serverが再起動されると新しいバージョンで起動する)。

#### 新機能 {#new-feature-7}


* `TTL DELETE WHERE` と `TTL GROUP BY` によるテーブル内データの自動的な粗粒化とロールアップ。 [#10537](https://github.com/ClickHouse/ClickHouse/pull/10537) ([expl0si0nn](https://github.com/expl0si0nn)).
* PostgreSQL ワイヤプロトコルを実装。 [#10242](https://github.com/ClickHouse/ClickHouse/pull/10242) ([Movses](https://github.com/MovElb)).
* ユーザー、ロール、権限、設定プロファイル、クォータ、行ポリシー用の system テーブルを追加し、`SHOW USER`、`SHOW [CURRENT|ENABLED] ROLES`、`SHOW SETTINGS PROFILES` コマンドを追加しました。 [#10387](https://github.com/ClickHouse/ClickHouse/pull/10387)（[Vitaly Baranov](https://github.com/vitlibar)）。
* ODBC テーブル関数への書き込みをサポート [#10554](https://github.com/ClickHouse/ClickHouse/pull/10554) ([ageraab](https://github.com/ageraab))。 [#10901](https://github.com/ClickHouse/ClickHouse/pull/10901) ([tavplubix](https://github.com/tavplubix))。
* Linux の `perf_events` に基づくクエリパフォーマンスメトリクスを追加しました（これらのメトリクスはハードウェア CPU カウンタと OS カウンタを用いて算出されます）。これは任意機能であり、clickhouse バイナリに `CAP_SYS_ADMIN` を設定する必要があります。 [#9545](https://github.com/ClickHouse/ClickHouse/pull/9545) [Andrey Skobtsov](https://github.com/And42). [#11226](https://github.com/ClickHouse/ClickHouse/pull/11226) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* `CREATE` クエリでデータ型に対する `NULL` および `NOT NULL` 修飾子がサポートされるようになりました。 [#11057](https://github.com/ClickHouse/ClickHouse/pull/11057) ([Павел Потемкин](https://github.com/Potya)).
* `ArrowStream` 入力および出力フォーマットを追加しました。 [#11088](https://github.com/ClickHouse/ClickHouse/pull/11088) ([hcz](https://github.com/hczhcz)).
* Cassandra を外部辞書ソースとしてサポートしました。 [#4978](https://github.com/ClickHouse/ClickHouse/pull/4978) ([favstovol](https://github.com/favstovol))。
* 新しいレイアウト `direct` を追加しました。これは各クエリごとにソースからすべてのデータを直接読み込み、データの保存やキャッシュを一切行いません。 [#10622](https://github.com/ClickHouse/ClickHouse/pull/10622) ([Artem Streltsov](https://github.com/kekekekule)).
* クエリ実行時にローカルへは何も保存しない、新しい `complex_key_direct` レイアウトを辞書に追加しました。 [#10850](https://github.com/ClickHouse/ClickHouse/pull/10850) ([Artem Streltsov](https://github.com/kekekekule)).
* MySQL 形式のグローバル変数構文（スタブ）をサポートしました。これは MySQL プロトコルとの互換性のために必要です。 [#11832](https://github.com/ClickHouse/ClickHouse/pull/11832) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `replxx` を使用して `clickhouse-client` に構文ハイライト機能を追加しました。[#11422](https://github.com/ClickHouse/ClickHouse/pull/11422) ([Tagir Kuskarov](https://github.com/kuskarov))。
* `minMap` および `maxMap` 関数が追加されました。 [#11603](https://github.com/ClickHouse/ClickHouse/pull/11603) ([Ildus Kurbangaliev](https://github.com/ildus)).
* `system.asynchronous_metrics` の履歴メトリクスを記録する `system.asynchronous_metric_log` テーブルを追加しました。 [#11588](https://github.com/ClickHouse/ClickHouse/pull/11588) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* 関数 `extractAllGroupsHorizontal(haystack, re)` と `extractAllGroupsVertical(haystack, re)` を追加しました。 [#11554](https://github.com/ClickHouse/ClickHouse/pull/11554) ([Vasily Nemkov](https://github.com/Enmk)).
* SHOW CLUSTER(S) クエリを追加しました。 [#11467](https://github.com/ClickHouse/ClickHouse/pull/11467) ([hexiaoting](https://github.com/hexiaoting)).
* Python の `urlparse(url)` における `netloc` と同様に、ネットワークロケーションを抽出するための `netloc` 関数を追加。 [#11356](https://github.com/ClickHouse/ClickHouse/pull/11356) ([Guillaume Tassery](https://github.com/YiuRULE)).
* `engine=Kafka` でメッセージヘッダーにアクセスできるように、仮想カラムを 2 つ追加。 [#11283](https://github.com/ClickHouse/ClickHouse/pull/11283) ([filimonov](https://github.com/filimonov)).
* Kafka エンジンに `_timestamp_ms` 仮想カラムを追加（型は `Nullable(DateTime64(3))`）。 [#11260](https://github.com/ClickHouse/ClickHouse/pull/11260) ([filimonov](https://github.com/filimonov))。
* 関数 `randomFixedString` を追加しました。 [#10866](https://github.com/ClickHouse/ClickHouse/pull/10866) ([Andrei Nekrashevich](https://github.com/xolm)).
* 文字列中のビットを指定した確率でランダムに反転させる関数 `fuzzBits` を追加。 [#11237](https://github.com/ClickHouse/ClickHouse/pull/11237) ([Andrei Nekrashevich](https://github.com/xolm)).
* 比較演算子、`IN` 句および `VALUES` 句で、数値を定数文字列と比較できるようにしました。 [#11647](https://github.com/ClickHouse/ClickHouse/pull/11647) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `round_robin` の `load_balancing` モードを追加しました。[#11645](https://github.com/ClickHouse/ClickHouse/pull/11645) ([Azat Khuzhin](https://github.com/azat)).
* `cast_keep_nullable` 設定を追加しました。この設定を有効にすると、`CAST(something_nullable AS Type)` は `Nullable(Type)` を返します。 [#11733](https://github.com/ClickHouse/ClickHouse/pull/11733) ([Artem Zuikov](https://github.com/4ertus2)).
* `system.columns` テーブルに `position` 列を、`system.parts_columns` テーブルに `column_position` 列を追加しました。これらには、テーブル内の列の 1 から始まる序数位置が格納されます。これにより [#7744](https://github.com/ClickHouse/ClickHouse/issues/7744) が解決されました。 [#11655](https://github.com/ClickHouse/ClickHouse/pull/11655) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* SYSTEM `{FLUSH DISTRIBUTED,STOP/START DISTRIBUTED SEND}` に対する ON CLUSTER のサポート。 [#11415](https://github.com/ClickHouse/ClickHouse/pull/11415) ([Azat Khuzhin](https://github.com/azat)).
* system.distribution&#95;queue テーブルを追加。 [#11394](https://github.com/ClickHouse/ClickHouse/pull/11394) ([Azat Khuzhin](https://github.com/azat)).
* Kafka でのすべてのフォーマット設定をサポートし、一部の設定をテーブルレベルで指定可能にし、パフォーマンス向上のためにデフォルト値を調整。 [#11388](https://github.com/ClickHouse/ClickHouse/pull/11388) ([filimonov](https://github.com/filimonov)).
* `port` 関数（URL からポートを抽出するため）を追加しました。[#11120](https://github.com/ClickHouse/ClickHouse/pull/11120)（[Azat Khuzhin](https://github.com/azat)）。
* `dictGet*` 関数でテーブル名を指定できるようになりました。 [#11050](https://github.com/ClickHouse/ClickHouse/pull/11050) ([Vitaly Baranov](https://github.com/vitlibar))。
* `clickhouse-format` ツールは、`-n` 引数を使用することで複数のクエリをフォーマットできるようになりました。 [#10852](https://github.com/ClickHouse/ClickHouse/pull/10852) ([Darío](https://github.com/dgrr))。
* DiskS3 向けに proxy resolver を設定できるようになりました。 [#10744](https://github.com/ClickHouse/ClickHouse/pull/10744) ([Pavel Kovalenko](https://github.com/Jokser)).
* `pointInPolygon` が定数ではないポリゴンにも対応するようになりました。`pointInPolygon` は、2 番目の引数として多角形および穴の配列である Array(Array(Tuple(..., ...))) を受け取れるようになりました。 [#10623](https://github.com/ClickHouse/ClickHouse/pull/10623) ([Alexey Ilyukhov](https://github.com/livace)) [#11421](https://github.com/ClickHouse/ClickHouse/pull/11421) ([Alexey Ilyukhov](https://github.com/livace)).
* `move_ttl_info` を `system.parts` に追加し、move TTL 機能を可観測化できるようにしました。 [#10591](https://github.com/ClickHouse/ClickHouse/pull/10591) ([Vladimir Chebotarev](https://github.com/excitoon)).
* プロキシ経由で S3 を利用できるようになりました。 [#10576](https://github.com/ClickHouse/ClickHouse/pull/10576) ([Pavel Kovalenko](https://github.com/Jokser)).
* データ型に `NCHAR` および `NVARCHAR` のシノニムを追加。 [#11025](https://github.com/ClickHouse/ClickHouse/pull/11025) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* [#7224](https://github.com/ClickHouse/ClickHouse/issues/7224) を修正しました: `system.events` テーブルに `FailedQuery`、`FailedSelectQuery`、`FailedInsertQuery` メトリクスを追加しました。 [#11151](https://github.com/ClickHouse/ClickHouse/pull/11151) ([Nikita Orlov](https://github.com/naorlov))。
* `system.asynchronous_metrics` に `jemalloc` の統計情報をさらに追加し、それらについて常に最新の値が確認できるようにしました。 [#11748](https://github.com/ClickHouse/ClickHouse/pull/11748) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* デフォルトの S3 資格情報とカスタム認証ヘッダーを指定できるようにしました。 [#11134](https://github.com/ClickHouse/ClickHouse/pull/11134) ([Grigory Pervakov](https://github.com/GrigoryPervakov)).
* さまざまな精度で `DateTime64` を `Int64` としてインポート／エクスポートするための新しい関数 `to-/fromUnixTimestamp64Milli/-Micro/-Nano` を追加しました。 [#10923](https://github.com/ClickHouse/ClickHouse/pull/10923)（[Vasily Nemkov](https://github.com/Enmk)）。
* MongoDB 辞書に対して `mongodb://` URI を指定できるようにしました。 [#10915](https://github.com/ClickHouse/ClickHouse/pull/10915) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* `OFFSET` キーワードを、対応する `LIMIT` 句なしで使用できるようになりました。 [#10802](https://github.com/ClickHouse/ClickHouse/pull/10802) ([Guillaume Tassery](https://github.com/YiuRULE)).
* `system.licenses` テーブルを追加しました。このテーブルには、`contrib` ディレクトリ内のサードパーティライブラリのライセンスが含まれます。これにより [#2890](https://github.com/ClickHouse/ClickHouse/issues/2890) がクローズされました。[#10795](https://github.com/ClickHouse/ClickHouse/pull/10795)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 新しい関数 toStartOfSecond(DateTime64) -&gt; DateTime64 が追加され、DateTime64 の値のサブ秒部分をゼロにします。 [#10722](https://github.com/ClickHouse/ClickHouse/pull/10722) ([Vasily Nemkov](https://github.com/Enmk))。
* 新しい入力フォーマット `JSONAsString` を追加しました。これは、改行、空白、およびカンマで区切られた JSON オブジェクトのシーケンスを受け付けます。 [#10607](https://github.com/ClickHouse/ClickHouse/pull/10607) ([Kruglov Pavel](https://github.com/Avogar))。
* メモリプロファイルを 4 MiB より細かい粒度で取得できるようにしました。ランダムな割り当て／解放を取得するサンプリングメモリプロファイラを追加しました。 [#10598](https://github.com/ClickHouse/ClickHouse/pull/10598) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `SimpleAggregateFunction` は `sumMap` もサポートするようになりました。 [#10000](https://github.com/ClickHouse/ClickHouse/pull/10000) ([Ildus Kurbangaliev](https://github.com/ildus)).
* Distributed テーブルエンジンでの `ALTER RENAME COLUMN` をサポート。 [#10727](https://github.com/ClickHouse/ClickHouse/issues/10727) の続き。 [#10747](https://github.com/ClickHouse/ClickHouse/issues/10747) を修正。 [#10887](https://github.com/ClickHouse/ClickHouse/pull/10887) ([alesapin](https://github.com/alesapin))。

#### バグ修正 {#bug-fix-27}


* Decimal のパースにおける UBSan レポートを修正しました。これにより [#7540](https://github.com/ClickHouse/ClickHouse/issues/7540) が解決されました。[#10512](https://github.com/ClickHouse/ClickHouse/pull/10512)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* DateTime64 をパースする際に発生する可能性のある浮動小数点例外を修正しました。これにより [#11374](https://github.com/ClickHouse/ClickHouse/issues/11374) が解決されます。[#11875](https://github.com/ClickHouse/ClickHouse/pull/11875)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `prewhere` 条件で `Nullable` カラムを使用したことによりまれに発生するクラッシュを修正。 [#11895](https://github.com/ClickHouse/ClickHouse/pull/11895) [#11608](https://github.com/ClickHouse/ClickHouse/issues/11608) [#11869](https://github.com/ClickHouse/ClickHouse/pull/11869) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 高階関数の内部では `arrayJoin` を許可しないようにしました。これが原因でプロトコルの同期が壊れる問題が発生していました。この変更により [#3933](https://github.com/ClickHouse/ClickHouse/issues/3933) がクローズされます。 [#11846](https://github.com/ClickHouse/ClickHouse/pull/11846) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* FixedString と定数 String の比較で誤った結果が返る問題を修正しました。この修正は [#11393](https://github.com/ClickHouse/ClickHouse/issues/11393) に対応します。このバグはバージョン 20.4 で発生しました。[#11828](https://github.com/ClickHouse/ClickHouse/pull/11828)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 条件に NULL を含む `if` で誤った結果が返される問題を修正。 [#11807](https://github.com/ClickHouse/ClickHouse/pull/11807) ([Artem Zuikov](https://github.com/4ertus2)).
* クエリでスレッドを過剰に使用してしまう問題を修正。 [#11788](https://github.com/ClickHouse/ClickHouse/pull/11788) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `SELECT ... FROM merge_tree_table ...` 内で `WITH <scalar subquery> ...` を使用した際に発生していた `Scalar does not exist` 例外を修正しました。 [#11621](https://github.com/ClickHouse/ClickHouse/issues/11621)。 [#11767](https://github.com/ClickHouse/ClickHouse/pull/11767) ([Amos Bird](https://github.com/amosbird))。
* `SELECT *, xyz.*` のようなクエリで、本来はエラーになるべきところが成功してしまっていた予期しない動作を修正しました。 [#11753](https://github.com/ClickHouse/ClickHouse/pull/11753) ([hexiaoting](https://github.com/hexiaoting)).
* メタデータの変更中に、レプリケートされたフェッチがキャンセルされるようになりました。 [#11744](https://github.com/ClickHouse/ClickHouse/pull/11744) ([alesapin](https://github.com/alesapin))。
* 等価性を確認する前に、ZooKeeper に保存されたメタデータを解析するようにしました。 [#11739](https://github.com/ClickHouse/ClickHouse/pull/11739) ([Azat Khuzhin](https://github.com/azat)).
* Values 入力フォーマットで複雑なリテラルの型推論が誤って行われることにより発生していた LOGICAL&#95;ERROR を修正。 [#11732](https://github.com/ClickHouse/ClickHouse/pull/11732) ([tavplubix](https://github.com/tavplubix)).
* 定数列に対する `ORDER BY ... WITH FILL` を修正。[#11697](https://github.com/ClickHouse/ClickHouse/pull/11697)（[Anton Popov](https://github.com/CurtizJ)）。
* SYSTEM SYNC REPLICA における極めてまれなレースコンディションを修正。Replicated テーブルが作成されている最中に、別の接続から別クライアントが同じテーブルに対して `SYSTEM SYNC REPLICA` コマンドを実行すると（もう一方のクライアントはテーブルが作成中であることを認識しているはずなので、これは起こりにくいが）、nullptr 参照が発生する可能性がある。 [#11691](https://github.com/ClickHouse/ClickHouse/pull/11691) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* XDBC bridge と通信する際に適切なタイムアウトを指定するようにしました。最近、bridge の生存確認やメタ情報の受信時にタイムアウトが正しく扱われていませんでした。 [#11690](https://github.com/ClickHouse/ClickHouse/pull/11690) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `ORDER BY` 句でエイリアスを使用している場合の `LIMIT n WITH TIES` の動作を修正。 [#11689](https://github.com/ClickHouse/ClickHouse/pull/11689) ([Anton Popov](https://github.com/CurtizJ)).
* 並列な `FINAL` を使用する `SELECT` クエリで発生しうる `Pipeline stuck` 問題を修正。[#11636](https://github.com/ClickHouse/ClickHouse/issues/11636) を解決。[#11682](https://github.com/ClickHouse/ClickHouse/pull/11682)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `system.mutations` が不正な状態になる原因となっていたエラーを修正しました。サーバーがレプリケーションキュー内に `MUTATE_PART` タスクを保持し、依然としてそれらを実行しようとしているにもかかわらず、ミューテーション全体がすでに完了していると表示されてしまう場合がありました。この修正は [#11611](https://github.com/ClickHouse/ClickHouse/issues/11611) を解決します。 [#11681](https://github.com/ClickHouse/ClickHouse/pull/11681) ([alesapin](https://github.com/alesapin))。
* CREATE USER クエリの構文ハイライトを修正。 [#11664](https://github.com/ClickHouse/ClickHouse/pull/11664) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 大文字小文字を区別しないフラグ付き正規表現のサポートを追加しました。これにより [#11101](https://github.com/ClickHouse/ClickHouse/issues/11101) および [#11506](https://github.com/ClickHouse/ClickHouse/issues/11506) が修正されます。 [#11649](https://github.com/ClickHouse/ClickHouse/pull/11649)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 行レベルセキュリティが設定されている場合、`count` クエリに対する軽微な最適化を削除しました。以前のバージョンでは、ユーザーはフィルタ適用後ではなく、テーブル内のレコードの総数を取得していました。この変更により、[#11352](https://github.com/ClickHouse/ClickHouse/issues/11352) が修正されます。[#11644](https://github.com/ClickHouse/ClickHouse/pull/11644)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* String 用のブルームフィルタ（データスキッピングインデックス）を修正しました。 [#11638](https://github.com/ClickHouse/ClickHouse/pull/11638) ([Azat Khuzhin](https://github.com/azat)).
* `-q` オプションを指定しない場合、起動時にデータベースは作成されません。 [#11604](https://github.com/ClickHouse/ClickHouse/pull/11604) ([giordyb](https://github.com/giordyb)).
* `Buffer` テーブルからのサンプリング読み取りを行うクエリで発生するエラー `Block structure mismatch` を修正しました。 [#11602](https://github.com/ClickHouse/ClickHouse/pull/11602) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `exception.code() % 256 == 0` の場合に発生していた clickhouse-client の誤った終了コードを修正。 [#11601](https://github.com/ClickHouse/ClickHouse/pull/11601) ([filimonov](https://github.com/filimonov)).
* ReplicatedMergeTree の異なるレプリカに対する CREATE/DROP のレースコンディションを修正しました。テーブルが ZooKeeper から完全に削除されていない場合や、正常に作成されなかった場合でも処理を継続できるようにしました。これにより [#11432](https://github.com/ClickHouse/ClickHouse/issues/11432) が修正されます。 [#11592](https://github.com/ClickHouse/ClickHouse/pull/11592) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* サーバー起動時の「Mark cache size was lowered」に関するログメッセージの些細な誤りを修正しました。これにより [#11399](https://github.com/ClickHouse/ClickHouse/issues/11399) がクローズされます。 [#11589](https://github.com/ClickHouse/ClickHouse/pull/11589) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `PREWHERE column in (subquery)` と `ARRAY JOIN` を含むクエリで発生する `Size of offsets does not match size of column` エラーを修正。 [#11580](https://github.com/ClickHouse/ClickHouse/pull/11580) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `SHOW CREATE TABLE` でまれに発生するセグメンテーションフォルトを修正。 [#11490](https://github.com/ClickHouse/ClickHouse/issues/11490) を解決。 [#11579](https://github.com/ClickHouse/ClickHouse/pull/11579) ([tavplubix](https://github.com/tavplubix)).
* HTTP セッション内のすべてのクエリが同じ `query_id` を持ってしまう問題を修正しました。 [#11578](https://github.com/ClickHouse/ClickHouse/pull/11578) ([tavplubix](https://github.com/tavplubix))。
* これにより、clickhouse-server の Docker コンテナは、サーバーの死活監視で IPv6 を優先して使用するようになります。 [#11550](https://github.com/ClickHouse/ClickHouse/pull/11550) ([Ivan Starkov](https://github.com/istarkov)).
* `min_bytes_to_use_direct_io` が有効で、PREWHERE が有効な状態で SAMPLE を使用している場合、またはスレッド数が多い場合に発生する可能性のある `Data compressed with different methods` エラーを修正しました。これにより [#11539](https://github.com/ClickHouse/ClickHouse/issues/11539) が解決されます。 [#11540](https://github.com/ClickHouse/ClickHouse/pull/11540) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `<node>` の shard&#95;num/replica&#95;num を修正（use&#95;compact&#95;format&#95;in&#95;distributed&#95;parts&#95;names が正常に動作しない不具合の修正）。[#11528](https://github.com/ClickHouse/ClickHouse/pull/11528) ([Azat Khuzhin](https://github.com/azat)).
* `prefer_localhost_replica=0` かつ内部レプリケーションなしの場合の `Distributed` への非同期 `INSERT` を修正。 [#11527](https://github.com/ClickHouse/ClickHouse/pull/11527) ([Azat Khuzhin](https://github.com/azat)).
* `-State` 関数を用いた集約の途中で例外がスローされた場合に発生するメモリリークを修正しました。これにより [#8995](https://github.com/ClickHouse/ClickHouse/issues/8995) が修正されます。 [#11496](https://github.com/ClickHouse/ClickHouse/pull/11496) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `SELECT`（`max_threads`&gt;1）が複数のストリームを持ち、`INSERT` が 1 つのストリームしか持たない（`max_insert_threads`==0）場合の `INSERT SELECT FINAL` で発生していた `Pipeline stuck` 例外を修正。 [#11455](https://github.com/ClickHouse/ClickHouse/pull/11455) ([Azat Khuzhin](https://github.com/azat)).
* `select count() from t, u` のようなクエリで誤った結果が返される問題を修正しました。 [#11454](https://github.com/ClickHouse/ClickHouse/pull/11454) ([Artem Zuikov](https://github.com/4ertus2)).
* コーデックで返される圧縮サイズを修正。 [#11448](https://github.com/ClickHouse/ClickHouse/pull/11448) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* リテラル以外の引数を持つ圧縮`codec`が列に設定されている場合にサーバーがクラッシュする問題を修正。[#11365](https://github.com/ClickHouse/ClickHouse/issues/11365) を修正。[#11431](https://github.com/ClickHouse/ClickHouse/pull/11431)（[alesapin](https://github.com/alesapin)）。
* テーブルが正常に作成されなかった場合に、MergeTree のシャットダウン時に発生し得る未初期化メモリ読み取りを修正しました。 [#11420](https://github.com/ClickHouse/ClickHouse/pull/11420) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `LowCarinality(T)` および `Nullable(T)` を含む `JOIN` で発生するクラッシュを修正。 [#11380](https://github.com/ClickHouse/ClickHouse/issues/11380)。 [#11414](https://github.com/ClickHouse/ClickHouse/pull/11414) ([Artem Zuikov](https://github.com/4ertus2))。
* 誤った `USING` キーに対するエラーコードを修正。 [#11373](https://github.com/ClickHouse/ClickHouse/issues/11373)。 [#11404](https://github.com/ClickHouse/ClickHouse/pull/11404) ([Artem Zuikov](https://github.com/4ertus2)).
* 緯度・経度の範囲外の引数が指定された場合の `geohashesInBox` の動作を修正しました。 [#11403](https://github.com/ClickHouse/ClickHouse/pull/11403) ([Vasily Nemkov](https://github.com/Enmk)).
* `joinGet()` 関数のエラーメッセージを改善。[#11389](https://github.com/ClickHouse/ClickHouse/pull/11389) ([Artem Zuikov](https://github.com/4ertus2)).
* 外部ソートと `LIMIT` を含むクエリで発生しうる `Pipeline stuck` エラーを修正。[#11359](https://github.com/ClickHouse/ClickHouse/issues/11359) に対応。[#11366](https://github.com/ClickHouse/ClickHouse/pull/11366)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* ReplicatedMergeTree のパーツ送信時に、不要なロックを削除しました。 [#11354](https://github.com/ClickHouse/ClickHouse/pull/11354) ([alesapin](https://github.com/alesapin)).
* マルチラインモードにおける clickhouse-client の `\G`（縦方向出力）サポートを修正。これにより [#9933](https://github.com/ClickHouse/ClickHouse/issues/9933) がクローズされます。 [#11350](https://github.com/ClickHouse/ClickHouse/pull/11350)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `Lazy` データベース使用時に発生する可能性のあったセグメンテーションフォルトを修正。 [#11348](https://github.com/ClickHouse/ClickHouse/pull/11348) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `Join` テーブルエンジンからの（`JOIN` を伴わない）直接 `SELECT` 時のクラッシュと、誤った NULL 許容性を修正しました。[#11340](https://github.com/ClickHouse/ClickHouse/pull/11340) ([Artem Zuikov](https://github.com/4ertus2)).
* `quantilesExactWeightedArray` のクラッシュを修正。 [#11337](https://github.com/ClickHouse/ClickHouse/pull/11337) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `ALTER` クエリでメタデータを変更する前にマージが停止されるようになりました。 [#11335](https://github.com/ClickHouse/ClickHouse/pull/11335) ([alesapin](https://github.com/alesapin)).
* `parallel_view_processing = 1` 設定を使用した `MATERIALIZED VIEW` への書き込みを再び並列化しました。 [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241) を修正。 [#11330](https://github.com/ClickHouse/ClickHouse/pull/11330) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 抽出された JSON にバランスしていない &#123; や [ を含む文字列がある場合の `visitParamExtractRaw` を修正。 [#11318](https://github.com/ClickHouse/ClickHouse/pull/11318) ([Ewout](https://github.com/devwout)).
* `ThreadPool` の極めてまれなレースコンディションを修正。 [#11314](https://github.com/ClickHouse/ClickHouse/pull/11314) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `clickhouse-copier` における軽微なデータ競合を修正しました。インテグレーションテストにより検出されました。 [#11313](https://github.com/ClickHouse/ClickHouse/pull/11313) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 変換処理で発生し得る未初期化メモリの問題を修正しました。例: `SELECT toIntervalSecond(now64())`。 [#11311](https://github.com/ClickHouse/ClickHouse/pull/11311) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* プライマリキーに Array 型のカラムがあり、クエリがこのカラムに対して `empty` または `notEmpty` 関数でフィルタしている場合に、インデックス解析が機能しない問題を修正しました。これにより [#11286](https://github.com/ClickHouse/ClickHouse/issues/11286) が解決されます。 [#11303](https://github.com/ClickHouse/ClickHouse/pull/11303) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* クエリ速度の推定が不正確になり、クエリが `max_network_bandwidth`、`max_execution_speed`、または `priority` 設定によってスロットルされている場合に `min_execution_speed` の制限が動作しない、または誤って動作する可能性があるバグを修正。`timeout_before_checking_execution_speed` のデフォルト値を非ゼロに変更。そうしないと、`min_execution_speed` と `max_execution_speed` の設定が効果を持たないため。これにより [#11297](https://github.com/ClickHouse/ClickHouse/issues/11297) を修正。これにより [#5732](https://github.com/ClickHouse/ClickHouse/issues/5732) を修正。これにより [#6228](https://github.com/ClickHouse/ClickHouse/issues/6228) を修正。使い勝手の向上: `clickhouse-client` において、例外メッセージとプログレスバーが連結されないようにした。[#11296](https://github.com/ClickHouse/ClickHouse/pull/11296) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 誤った引数で `SET DEFAULT ROLE` が呼び出された場合にクラッシュする問題を修正しました。これにより [#10586](https://github.com/ClickHouse/ClickHouse/issues/10586) が解決されました。 [#11278](https://github.com/ClickHouse/ClickHouse/pull/11278)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `Protobuf` フォーマットで不正なデータを読み込む際に発生していたクラッシュを修正しました。これにより [#5957](https://github.com/ClickHouse/ClickHouse/issues/5957) および [#11203](https://github.com/ClickHouse/ClickHouse/issues/11203) が解決されます。 [#11258](https://github.com/ClickHouse/ClickHouse/pull/11258)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `cache` 辞書が通常の値ではなくデフォルト値を返してしまう（有効期限切れのキーしか存在しない場合）不具合を修正しました。これは文字列フィールドのみに影響します。 [#11233](https://github.com/ClickHouse/ClickHouse/pull/11233) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 内部クエリに定数を含む `VIEW` から読み込む際に発生する `Block structure mismatch in QueryPipeline` エラーを修正。[#11181](https://github.com/ClickHouse/ClickHouse/issues/11181) を解決。[#11205](https://github.com/ClickHouse/ClickHouse/pull/11205)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `Invalid status for associated output` という例外が発生し得る問題を修正。 [#11200](https://github.com/ClickHouse/ClickHouse/pull/11200) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `CREATE` クエリで定義されている場合、`primary.idx` がチェックされるようになりました。 [#11199](https://github.com/ClickHouse/ClickHouse/pull/11199) ([alesapin](https://github.com/alesapin))。
* `Array(Array(LowCardinality))` 型の引数をキャプチャする高階関数で発生する可能性のある `Cannot capture column` エラーを修正。[#11185](https://github.com/ClickHouse/ClickHouse/pull/11185) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 一部のバックエンドでキー数が 1000 を超える場合に失敗する可能性があった `S3` のグロブ処理を修正しました。 [#11179](https://github.com/ClickHouse/ClickHouse/pull/11179) ([Vladimir Chebotarev](https://github.com/excitoon))。
* `SummingMergeTree`、`AggregatingMergeTree` および `TTL GROUP BY` などで、バックグラウンドマージ中に変更される列にデータスキッピングインデックスが依存している場合、インデックスが正しく計算されていませんでした。この問題は、インデックスの計算をマージ後に行うように変更し、マージ後のデータに対してインデックスを計算することで修正されました。 [#11162](https://github.com/ClickHouse/ClickHouse/pull/11162) ([Azat Khuzhin](https://github.com/azat)).
* `engine=Kafka` のテーブルに対する `DROP` 実行中（またはサーバー再起動中）にまれに発生していたハングを修正。[#11145](https://github.com/ClickHouse/ClickHouse/pull/11145) ([filimonov](https://github.com/filimonov)).
* 単純なクエリに対してスレッドを過剰に確保してしまう問題を修正（パイプラインの変更後に一部壊れていた、スレッド数削減のための最適化）。 [#11114](https://github.com/ClickHouse/ClickHouse/pull/11114) ([Azat Khuzhin](https://github.com/azat)).
* 何も確定されなかった場合は、mutation の完了タスクからのログ出力を削除しました。 [#11109](https://github.com/ClickHouse/ClickHouse/pull/11109) ([alesapin](https://github.com/alesapin)).
* `system` ログテーブルの構造変更を伴うアップデートの後、サーバー起動時に発生していたデッドロックを修正しました。 [#11106](https://github.com/ClickHouse/ClickHouse/pull/11106) ([alesapin](https://github.com/alesapin)).
* registerDiskS3 のメモリリークを修正。 [#11074](https://github.com/ClickHouse/ClickHouse/pull/11074) ([Pavel Kovalenko](https://github.com/Jokser)).
* JOIN が PREWHERE と一緒に使用される場合、または `optimize_move_to_prewhere` によって WHERE から PREWHERE が生成される場合に発生するエラー `No such name in Block::erase()` を修正。 [#11051](https://github.com/ClickHouse/ClickHouse/pull/11051) ([Artem Zuikov](https://github.com/4ertus2)).
* Kafka エンジンテーブルの終了時に発生しうるデータ取りこぼしの問題を修正しました。 [#11048](https://github.com/ClickHouse/ClickHouse/pull/11048) ([filimonov](https://github.com/filimonov)).
* parseDateTime64BestEffort の引数解決に関するバグを修正しました。 [#10925](https://github.com/ClickHouse/ClickHouse/issues/10925)。 [#11038](https://github.com/ClickHouse/ClickHouse/pull/11038) ([Vasily Nemkov](https://github.com/Enmk))。
* 単一の `ALTER` クエリ内で、同じ 1 列に対して `ADD/DROP` および `RENAME` を行うことが可能になりました。`MODIFY` と `RENAME` を同時に行った場合の例外メッセージが、よりわかりやすくなりました。[#10669](https://github.com/ClickHouse/ClickHouse/issues/10669) の問題を一部修正します。[#11037](https://github.com/ClickHouse/ClickHouse/pull/11037)（[alesapin](https://github.com/alesapin)）。
* S3 URL の解析処理を修正しました。 [#11036](https://github.com/ClickHouse/ClickHouse/pull/11036) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `LIMIT` がある場合の二段階 `GROUP BY` におけるメモリトラッキングを修正。 [#11022](https://github.com/ClickHouse/ClickHouse/pull/11022) ([Azat Khuzhin](https://github.com/azat)).
* テーブルの作成に失敗した場合に、MergeTree でごくまれに発生し得る use-after-free エラーを修正しました。 [#10986](https://github.com/ClickHouse/ClickHouse/pull/10986) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Atomic データベースにおけるメタデータ（rename 用の相対パス）およびデータ（symlink 用の相対パス）の扱いを修正。 [#10980](https://github.com/ClickHouse/ClickHouse/pull/10980) ([Azat Khuzhin](https://github.com/azat)).
* `Atomic` データベースエンジン使用時に、`ALTER` クエリと `DROP DATABASE` クエリを同時に実行すると発生するサーバークラッシュを修正。 [#10968](https://github.com/ClickHouse/ClickHouse/pull/10968) ([tavplubix](https://github.com/tavplubix)).
* メソッド `getRawData()` における生データサイズの誤りを修正。 [#10964](https://github.com/ClickHouse/ClickHouse/pull/10964) ([Igr](https://github.com/ObjatieGroba)).
* バージョン 20.1 以前との二段階集約の非互換性を修正しました。この非互換性は、イニシエーターノードとリモートノードで異なるバージョンの ClickHouse を使用していて、`GROUP BY` の結果が大きく、単一の `String` フィールドで集約を実行している場合に発生します。その結果、単一のキーに対してマージされていない複数の行が結果に含まれてしまいます。 [#10952](https://github.com/ClickHouse/ClickHouse/pull/10952) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* DistributedBlockOutputStream によって部分的に書き込まれたファイルが送信されないようにしました。 [#10940](https://github.com/ClickHouse/ClickHouse/pull/10940) ([Azat Khuzhin](https://github.com/azat)).
* `SELECT count(notNullIn(NULL, []))` で発生していたクラッシュを修正。 [#10920](https://github.com/ClickHouse/ClickHouse/pull/10920) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* table engine=Kafka の DROP 実行中（またはサーバー再起動中）に時々発生していたハングを修正しました。 [#10910](https://github.com/ClickHouse/ClickHouse/pull/10910) ([filimonov](https://github.com/filimonov)).
* `a TO b, c TO a` のように、複数の `ALTER RENAME` を一度に実行できるようになりました。 [#10895](https://github.com/ClickHouse/ClickHouse/pull/10895) ([alesapin](https://github.com/alesapin))。
* 同じカラムに対して複数スレッドから集計関数の状態結果を取得する際に発生し得るレースコンディションを修正しました。これは、`AggregateFunction` の状態を `quanite*` 関数用に保持している `Memory` エンジンのテーブルから読み取る際に `finalizeAggregation` 関数を使用した場合にのみ（私が把握している限りでは）発生し得ます。 [#10890](https://github.com/ClickHouse/ClickHouse/pull/10890) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* Distributed テーブルにおけるタプルの後方互換性を修正しました。 [#10889](https://github.com/ClickHouse/ClickHouse/pull/10889) ([Anton Popov](https://github.com/CurtizJ))。
* `StringHashTable` において、存在しないキーに対して発生する `SIGSEGV` を修正。 [#10870](https://github.com/ClickHouse/ClickHouse/pull/10870) ([Azat Khuzhin](https://github.com/azat)).
* `Atomic` エンジンを使用するデータベースから `LiveView` テーブルが削除された後に `WATCH` がハングする不具合を修正しました。 [#10859](https://github.com/ClickHouse/ClickHouse/pull/10859) ([tavplubix](https://github.com/tavplubix)).
* `ReplicatedMergeTree` のバグを修正しました。このバグにより、一部の `OPTIMIZE` クエリに対する `ALTER` が、あるレプリカが非アクティブになった後もそのレプリカを待ち続けてハングする可能性がありました。 [#10849](https://github.com/ClickHouse/ClickHouse/pull/10849) ([tavplubix](https://github.com/tavplubix)).
* `CONSTRAINT` 式に含まれる列がリネームされた場合に、制約も更新されるようになりました。 [#10844](https://github.com/ClickHouse/ClickHouse/issues/10844) を修正。 [#10847](https://github.com/ClickHouse/ClickHouse/pull/10847) ([alesapin](https://github.com/alesapin))。
* cache dictionary 内で未初期化メモリを読み取ってしまう可能性がある問題を修正。 [#10834](https://github.com/ClickHouse/ClickHouse/pull/10834) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Block::sortColumns() の後にカラムの順序を修正（さらに、実際のユースケース（Buffer エンジン）に影響することを示すテストを追加）。 [#10826](https://github.com/ClickHouse/ClickHouse/pull/10826) ([Azat Khuzhin](https://github.com/azat)).
* 識別子のクオートが不要な場合に発生していた ODBC bridge の問題を修正しました。これにより [#7984](https://github.com/ClickHouse/ClickHouse/issues/7984) が解決されています。 [#10821](https://github.com/ClickHouse/ClickHouse/pull/10821) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* DateLUT における UBSan および MSan のレポートを修正。 [#10798](https://github.com/ClickHouse/ClickHouse/pull/10798) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* キー条件で正しく型変換を行うために `src_type` を使用するようにしました。 [#6287](https://github.com/ClickHouse/ClickHouse/issues/6287) を修正。 [#10791](https://github.com/ClickHouse/ClickHouse/pull/10791)（[Andrew Onyshchuk](https://github.com/oandrew)）。
* 古い libunwind のパッチを削除しました。 [https://github.com/ClickHouse-Extras/libunwind/commit/500aa227911bd185a94bfc071d68f4d3b03cb3b1#r39048012](https://github.com/ClickHouse-Extras/libunwind/commit/500aa227911bd185a94bfc071d68f4d3b03cb3b1#r39048012) これにより、`clang` ビルドで `-fno-omit-frame-pointer` を無効化できるようになり、平均で少なくとも 1% のパフォーマンス向上が得られます。 [#10761](https://github.com/ClickHouse/ClickHouse/pull/10761) ([Amos Bird](https://github.com/amosbird))。
* 複数シャードにまたがって浮動小数点の重みを使用した場合の avgWeighted を修正。 [#10758](https://github.com/ClickHouse/ClickHouse/pull/10758) ([Baudouin Giard](https://github.com/bgiard))。
* `parallel_view_processing` の動作を修正。例外が発生した場合でも、すべての `MATERIALIZED VIEW` への挿入が例外なく完了するようになりました。 [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241) を修正。 [#10757](https://github.com/ClickHouse/ClickHouse/pull/10757)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* -State と組み合わせた際の -OrNull および -OrDefault コンビネーターを修正。 [#10741](https://github.com/ClickHouse/ClickHouse/pull/10741) ([hcz](https://github.com/hczhcz)).
* ネストされた型での `generateRandom` のクラッシュを修正。 [#10583](https://github.com/ClickHouse/ClickHouse/issues/10583) を修正。 [#10734](https://github.com/ClickHouse/ClickHouse/pull/10734)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* マージ後に発生する可能性があった、`SummingMergeTree` における `LowCardinality(FixedString)` キーカラムのデータ破損を修正しました。[#10489](https://github.com/ClickHouse/ClickHouse/issues/10489) を解決。[#10721](https://github.com/ClickHouse/ClickHouse/pull/10721)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* &#39;FINAL&#39; 修飾子と &#39;ORDER BY&#39; 最適化を併用した場合に、関数でラップされた主キーの扱いを修正しました。 [#10715](https://github.com/ClickHouse/ClickHouse/pull/10715) ([Anton Popov](https://github.com/CurtizJ)).
* `h3EdgeAngle` 関数で発生しうるバッファオーバーフローを修正。 [#10711](https://github.com/ClickHouse/ClickHouse/pull/10711) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 消えてしまう `totals` を修正。クエリに `JOIN` またはサブクエリがあり、さらに外側の `WHERE` 条件がある場合に、`totals` がフィルタされてしまうことがありました。[#10674](https://github.com/ClickHouse/ClickHouse/issues/10674) を修正。[#10698](https://github.com/ClickHouse/ClickHouse/pull/10698)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* HTTP の `INSERT` のアトミック性を修正。これにより [#9666](https://github.com/ClickHouse/ClickHouse/issues/9666) が解決されました。[#10687](https://github.com/ClickHouse/ClickHouse/pull/10687)（[Andrew Onyshchuk](https://github.com/oandrew)）。
* 1つのクエリ内で、同一の集合に対して `IN` 演算子を複数回使用しているケースを修正。 [#10686](https://github.com/ClickHouse/ClickHouse/pull/10686) ([Anton Popov](https://github.com/CurtizJ)).
* `readonly=2` かつ `cancel_http_readonly_queries_on_client_close=1` の場合に、クライアント切断時に HTTP リクエストがハングしてしまうバグを修正しました。[#7939](https://github.com/ClickHouse/ClickHouse/issues/7939)、[#7019](https://github.com/ClickHouse/ClickHouse/issues/7019)、[#7736](https://github.com/ClickHouse/ClickHouse/issues/7736)、[#7091](https://github.com/ClickHouse/ClickHouse/issues/7091) を修正。[#10684](https://github.com/ClickHouse/ClickHouse/pull/10684)（[tavplubix](https://github.com/tavplubix)）。
* AggregateTransform コンストラクタのパラメータ順を修正。 [#10667](https://github.com/ClickHouse/ClickHouse/pull/10667) ([palasonic1](https://github.com/palasonic1)).
* `distributed_aggregation_memory_efficient` が有効な場合にリモートクエリが並列実行されない問題を修正。 [#10655](https://github.com/ClickHouse/ClickHouse/issues/10655) を修正。 [#10664](https://github.com/ClickHouse/ClickHouse/pull/10664)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `LIMIT` を含むクエリで返される行数が誤ってしまう可能性のある問題を修正。 [#10566](https://github.com/ClickHouse/ClickHouse/issues/10566)、[#10709](https://github.com/ClickHouse/ClickHouse/issues/10709) を修正。 [#10660](https://github.com/ClickHouse/ClickHouse/pull/10660)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* テーブルに多数のパーツがある場合に同時実行中の `ALTER` がロックされてしまうバグを修正。 [#10659](https://github.com/ClickHouse/ClickHouse/pull/10659) ([alesapin](https://github.com/alesapin))。
* サーバーがテーブルの起動前にシャットダウンされた場合に `StorageBuffer` で発生する `nullptr` デリファレンスを修正。 [#10641](https://github.com/ClickHouse/ClickHouse/pull/10641) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 分散クエリに対する述語最適化（`enable_optimize_predicate_expression=1`）について、`HAVING` 句を含むクエリ（つまり、サーバーのイニシエータ側でのフィルタリングが必要な場合）を、式の順序を保持することで修正し（これだけで修正としては十分）、さらに集約処理でインデックスではなくカラム名を使用するように強制しました。修正: [#10613](https://github.com/ClickHouse/ClickHouse/issues/10613), [#11413](https://github.com/ClickHouse/ClickHouse/issues/11413)。[#10621](https://github.com/ClickHouse/ClickHouse/pull/10621)（[Azat Khuzhin](https://github.com/azat)）。
* LowCardinality 使用時の optimize&#95;skip&#95;unused&#95;shards を修正。 [#10611](https://github.com/ClickHouse/ClickHouse/pull/10611) ([Azat Khuzhin](https://github.com/azat)).
* サーバー起動時の例外により `StorageBuffer` でセグメンテーションフォルトが発生する問題を修正。[#10550](https://github.com/ClickHouse/ClickHouse/issues/10550) を解決。[#10609](https://github.com/ClickHouse/ClickHouse/pull/10609)（[tavplubix](https://github.com/tavplubix)）。
* `SYSTEM DROP DNS CACHE` クエリの実行時に、ユーザーが特定の IP アドレスから接続することを許可されているかを確認するために使用されるキャッシュも削除するようにしました。 [#10608](https://github.com/ClickHouse/ClickHouse/pull/10608) ([tavplubix](https://github.com/tavplubix)).
* 依存テーブルを含むクエリに対して、`MATERIALIZED VIEW` の内部クエリ内で誤ったスカラー結果が返される問題を修正しました。 [#10603](https://github.com/ClickHouse/ClickHouse/pull/10603) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 同期ミューテーション用の条件変数の扱いを修正しました。場合によっては、その条件変数へのシグナルが失われてしまうことがありました。 [#10588](https://github.com/ClickHouse/ClickHouse/pull/10588) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `loadStoredObject()` が完了する前に `createDictionary()` が呼び出されることで発生しうるクラッシュを修正しました。 [#10587](https://github.com/ClickHouse/ClickHouse/pull/10587) ([Vitaly Baranov](https://github.com/vitlibar)).
* エラー `the BloomFilter false positive must be a double number between 0 and 1` を修正しました。 [#10551](https://github.com/ClickHouse/ClickHouse/issues/10551)。 [#10569](https://github.com/ClickHouse/ClickHouse/pull/10569)（[Winter Zhang](https://github.com/zhang2014)）。
* デフォルト式の型が列の型と異なる `ALIAS` 列に対する `SELECT` を修正。 [#10563](https://github.com/ClickHouse/ClickHouse/pull/10563) ([Azat Khuzhin](https://github.com/azat)).
* DateTime64 と String 値との比較を実装しました（DateTime の場合と同様）。 [#10560](https://github.com/ClickHouse/ClickHouse/pull/10560) ([Vasily Nemkov](https://github.com/Enmk))。
* マージで複数のcompactパーツを別のcompactパーツに統合した後に、特定のケースで発生し得るインデックス破損を修正。 [#10531](https://github.com/ClickHouse/ClickHouse/pull/10531) ([Anton Popov](https://github.com/CurtizJ)).
* GROUP BY sharding&#95;key 最適化をデフォルトで無効化し（sharding&#95;key の解析がトリッキーであるため `optimize_distributed_group_by_sharding_key` が導入され、デフォルトでオフになった。単純な例としては sharding key 内での `if` など）、WITH ROLLUP/CUBE/TOTALS での動作を修正。 [#10516](https://github.com/ClickHouse/ClickHouse/pull/10516) ([Azat Khuzhin](https://github.com/azat)).
* 修正: [#10263](https://github.com/ClickHouse/ClickHouse/issues/10263)（その PR の後、`INSERT` 経由で送信される分散送信が、各 `INSERT` ごとに延期されていた） 修正: [#8756](https://github.com/ClickHouse/ClickHouse/issues/8756)（その PR は、次のすべての条件を満たす場合に分散送信を壊していた（現時点ではまずない構成だと思われる）：`internal_replication == false`、複数のローカルシャード（ハードリンク用コードを有効化）、および `distributed_storage_policy`（`EXDEV` により `link(2)` が失敗する））。 [#10486](https://github.com/ClickHouse/ClickHouse/pull/10486)（[Azat Khuzhin](https://github.com/azat)）。
* &quot;max&#95;rows&#95;to&#95;sort&quot; 制限に関するエラーを修正しました。 [#10268](https://github.com/ClickHouse/ClickHouse/pull/10268) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 外部辞書を読み込む任意の関数の呼び出しごとに、辞書の取得とアクセス権のチェックを一度だけ行うようにしました。 [#10928](https://github.com/ClickHouse/ClickHouse/pull/10928) ([Vitaly Baranov](https://github.com/vitlibar)).

#### 改善 {#improvement-15}


* `ALTER MODIFY TTL` クエリの実行後に、古いデータに `TTL` を適用します。この挙動は `materialize_ttl_after_modify` 設定で制御され、デフォルトで有効になっています。 [#11042](https://github.com/ClickHouse/ClickHouse/pull/11042) ([Anton Popov](https://github.com/CurtizJ)).
* 文字列リテラル、`VALUES`、および各種テキスト形式における C スタイルのバックスラッシュエスケープのパース時に（これは SQL 標準に対する拡張であり、ClickHouse と MySQL に固有のものです）、未知のエスケープシーケンス（例: `\%` や `\w`）が見つかった場合はバックスラッシュを保持するようにしました。これにより、`LIKE` および `match` 正規表現の利用がより便利になり（`name LIKE 'used\\_cars'` の代わりに `name LIKE 'used\_cars'` と書くだけでよくなります）、同時に互換性も向上します。この変更により [#10922](https://github.com/ClickHouse/ClickHouse/issues/10922) が修正されました。[#11208](https://github.com/ClickHouse/ClickHouse/pull/11208)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* Decimal 値を読み取る際は、小数点以下の余分な桁を切り捨てます。この挙動の方が MySQL や PostgreSQL との互換性が高くなります。これにより [#10202](https://github.com/ClickHouse/ClickHouse/issues/10202) が修正されました。[#11831](https://github.com/ClickHouse/ClickHouse/pull/11831)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* ZooKeeper 内のメタデータがすでに削除されて存在しない場合（テスト用に TestKeeper を使用していてサーバーが再起動された場合も同様）、レプリケーテッドテーブルを DROP できるようにしました。ZooKeeper との通信でエラーが発生していても、レプリケーテッドテーブルを RENAME できるようにしました。これにより [#10720](https://github.com/ClickHouse/ClickHouse/issues/10720) が修正されました。 [#11652](https://github.com/ClickHouse/ClickHouse/pull/11652)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 文字列から `Decimal` を読み取る際の診断メッセージをわずかに改善しました。これにより [#10202](https://github.com/ClickHouse/ClickHouse/issues/10202) がクローズされました。[#11829](https://github.com/ClickHouse/ClickHouse/pull/11829)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* シグナルハンドラー内での `sleep` 呼び出しを修正しました。想定より短い時間しかスリープしていなかった問題を修正しました。 [#11825](https://github.com/ClickHouse/ClickHouse/pull/11825) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* （Linux のみ）OS 関連のパフォーマンスメトリクス（CPU および I/O）は、`CAP_NET_ADMIN` ケーパビリティがなくても動作します。 [#10544](https://github.com/ClickHouse/ClickHouse/pull/10544) ([Alexander Kazakov](https://github.com/Akazz)).
* `hostName` 関数のエイリアスとして `hostname` を追加しました。この機能は Yandex.Metrica の Victor Tarnavskiy 氏から提案されました。[#11821](https://github.com/ClickHouse/ClickHouse/pull/11821) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* クロスレプリケーションクラスターでの分散 `DDL`（update/delete/drop partition）のサポートを追加しました。 [#11703](https://github.com/ClickHouse/ClickHouse/pull/11703) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* サーバー起動時に、いずれかの `listen` アドレスを待ち受けできない場合（例: Docker 内で IPv6 が利用できない場合）、サーバーログにはエラーではなく警告を出力するようにしました。なお、指定されたすべてのアドレスでの待ち受けに失敗した場合は、従来どおり起動を拒否します。これにより [#4406](https://github.com/ClickHouse/ClickHouse/issues/4406) が修正されました。 [#11687](https://github.com/ClickHouse/ClickHouse/pull/11687) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* Docker イメージの起動時にデフォルトのユーザーとデータベースを作成する機能を追加。 [#10637](https://github.com/ClickHouse/ClickHouse/pull/10637) ([Paramtamtam](https://github.com/tarampampam)).
* 複数行のクエリがサーバーログに出力される際に行が結合されてしまう問題に対応しました。複数行の文字列リテラル、識別子、単一行コメントを含む場合でも正しく動作するようにしました。この修正により [#3853](https://github.com/ClickHouse/ClickHouse/issues/3853) が解決されています。[#11686](https://github.com/ClickHouse/ClickHouse/pull/11686)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `CREATE USER`、`CREATE ROLE`、`ALTER USER`、`SHOW CREATE USER`、`SHOW GRANTS` などのコマンドで、複数の名前を指定できるようになりました。 [#11670](https://github.com/ClickHouse/ClickHouse/pull/11670) ([Vitaly Baranov](https://github.com/vitlibar))。
* クロスレプリケーションクラスターにおける分散 DDL（`UPDATE/DELETE/DROP PARTITION`）のサポートを追加。 [#11508](https://github.com/ClickHouse/ClickHouse/pull/11508) ([frank lee](https://github.com/etah000)).
* ユーザーが明示的な値として指定した場合、`clickhouse-client` と `clickhouse-benchmark` のコマンドラインからパスワードを消去します。これにより、`ps` や同様のツールによってパスワードが露出するのを防ぎます。 [#11665](https://github.com/ClickHouse/ClickHouse/pull/11665) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 実行中のバイナリと一致しない場合は、ELF ファイルのデバッグ情報を使用しないようにしました。これは、スタックトレースで誤った関数名やソース位置が出力されるのを防ぐためです。この変更により [#7514](https://github.com/ClickHouse/ClickHouse/issues/7514) が修正されました。 [#11657](https://github.com/ClickHouse/ClickHouse/pull/11657) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* parseDateTimeBestEffortOrNull/Zero 関数で値を最後までパースできなかった場合に、NULL/ゼロを返すようにしました。これにより [#7876](https://github.com/ClickHouse/ClickHouse/issues/7876) が修正されます。[#11653](https://github.com/ClickHouse/ClickHouse/pull/11653) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* リクエストされた URL から空のパラメータを無視します。これは、`http://localhost:8123/?&a=b` や `http://localhost:8123/?a=b&&c=d` のような URL を記述した場合に発生することがあります。これにより [#10749](https://github.com/ClickHouse/ClickHouse/issues/10749) が解決されました。[#11651](https://github.com/ClickHouse/ClickHouse/pull/11651)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `groupArrayArray` と `groupUniqArrayArray` を `SimpleAggregateFunction` として使用可能にしました。 [#11650](https://github.com/ClickHouse/ClickHouse/pull/11650) ([Volodymyr Kuznetsov](https://github.com/ksvladimir)).
* 他の型のインデックス条件を解析する際に、暗黙的な型変換によって定数文字列との比較を許可します。これにより [#11630](https://github.com/ClickHouse/ClickHouse/issues/11630) が解決される可能性があります。 [#11648](https://github.com/ClickHouse/ClickHouse/pull/11648) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* [https://github.com/ClickHouse/ClickHouse/pull/7572#issuecomment-642815377](https://github.com/ClickHouse/ClickHouse/pull/7572#issuecomment-642815377) 設定でデフォルトの `HTTPHandlers` をサポート。[#11628](https://github.com/ClickHouse/ClickHouse/pull/11628)（[Winter Zhang](https://github.com/zhang2014)）。
* Kafka エンジンで利用できる入力フォーマットをさらに追加。早期フラッシュが発生する問題を修正。`kafka_num_consumers` がトピック内のパーティション数より大きい場合に発生するパフォーマンス問題を修正。[#11599](https://github.com/ClickHouse/ClickHouse/pull/11599) ([filimonov](https://github.com/filimonov))。
* `multiple_joins_rewriter_version=2` のロジックを改善。lambda のエイリアスに対する unknown columns エラーを修正。 [#11587](https://github.com/ClickHouse/ClickHouse/pull/11587) ([Artem Zuikov](https://github.com/4ertus2)).
* カラム定義リストをパースできない場合の例外メッセージを改善しました。これにより [#10403](https://github.com/ClickHouse/ClickHouse/issues/10403) がクローズされました。 [#11537](https://github.com/ClickHouse/ClickHouse/pull/11537)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* VIEW に対する `enable_optimize_predicate_expression=1` のロジックを改善しました。 [#11513](https://github.com/ClickHouse/ClickHouse/pull/11513) ([Artem Zuikov](https://github.com/4ertus2)).
* live view テーブルで PREWHERE をサポート。 [#11495](https://github.com/ClickHouse/ClickHouse/pull/11495) ([vzakaznikov](https://github.com/vzakaznikov)).
* ユーザーが特定のアドレスから接続することを許可されているかを確認するために使用される DNS キャッシュを自動的に更新します。 [#11487](https://github.com/ClickHouse/ClickHouse/pull/11487) ([tavplubix](https://github.com/tavplubix)).
* `OPTIMIZE FINAL` は、並行してマージが行われている場合でもマージを強制的に実行します。これにより [#11309](https://github.com/ClickHouse/ClickHouse/issues/11309) および [#11322](https://github.com/ClickHouse/ClickHouse/issues/11322) がクローズされます。[#11346](https://github.com/ClickHouse/ClickHouse/pull/11346)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* clickhouse-client でキャンセルされたクエリの出力を抑制するようにしました。以前のバージョンでは、Ctrl+C を押してクエリをキャンセルした後でも、結果がターミナルに出力され続ける場合がありました。これにより [#9473](https://github.com/ClickHouse/ClickHouse/issues/9473) がクローズされました。[#11342](https://github.com/ClickHouse/ClickHouse/pull/11342) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* これにより、各クエリの後に履歴ファイルが更新され、複数のクライアントが1つの履歴ファイルを使用してもレースコンディションが発生しなくなりました。これによって [#9897](https://github.com/ClickHouse/ClickHouse/issues/9897) が修正されました。 [#11453](https://github.com/ClickHouse/ClickHouse/pull/11453) ([Tagir Kuskarov](https://github.com/kuskarov))。
* 設定再読み込み中のログメッセージを改善。 [#11341](https://github.com/ClickHouse/ClickHouse/pull/11341) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 一部のケースで、`clickhouse-client` および `clickhouse-format` によって整形されるクエリから末尾の空白を削除するようにしました。 [#11325](https://github.com/ClickHouse/ClickHouse/pull/11325) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 設定「output&#95;format&#95;pretty&#95;max&#95;value&#95;width」を追加。値がそれより長い場合、ターミナルに過度に大きな値が出力されないよう途中で切り詰められます。これにより [#11140](https://github.com/ClickHouse/ClickHouse/issues/11140) がクローズされます。[#11324](https://github.com/ClickHouse/ClickHouse/pull/11324)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* メモリマッピング不足時の例外メッセージを改善しました。これにより [#11027](https://github.com/ClickHouse/ClickHouse/issues/11027) がクローズされました。[#11316](https://github.com/ClickHouse/ClickHouse/pull/11316)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* ASOF JOIN で (U)Int8、(U)Int16、および Date をサポート。 [#11301](https://github.com/ClickHouse/ClickHouse/pull/11301) ([Artem Zuikov](https://github.com/4ertus2)).
* Kafka テーブルで kafka&#95;client&#95;id パラメータをサポートします。また、ClickHouse が Kafka と通信する際に使用するデフォルトの `client.id` を、より情報量が多く実用的な値に変更します。 [#11252](https://github.com/ClickHouse/ClickHouse/pull/11252) ([filimonov](https://github.com/filimonov))。
* 例外発生時にも `DistributedFilesToInsert` メトリクスの値を保持するようにしました。以前のバージョンでは、いくつかのファイルを送信しようとしたタイミングで値が設定されていましたが、例外が発生して一部のファイルがまだ保留中でも値はゼロになっていました。現在は、ファイルシステム上で保留中のファイル数を表す値になります。 [#11220](https://github.com/ClickHouse/ClickHouse/pull/11220) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `DOUBLE PRECISION` や `CHAR VARYING` のような複数語からなるデータ型名のサポートを追加し、SQL との互換性を向上しました。 [#11214](https://github.com/ClickHouse/ClickHouse/pull/11214) ([Павел Потемкин](https://github.com/Potya)).
* いくつかのデータ型に対して同義語を追加。 [#10856](https://github.com/ClickHouse/ClickHouse/pull/10856) ([Павел Потемкин](https://github.com/Potya)).
* `query_log` はデフォルトで有効になりました。 [#11184](https://github.com/ClickHouse/ClickHouse/pull/11184) ([Ivan Blinkov](https://github.com/blinkov))。
* 認証タイプを `system.users` テーブルおよび `SHOW CREATE USER` クエリの結果に表示するようにしました。 [#11080](https://github.com/ClickHouse/ClickHouse/pull/11080) ([Vitaly Baranov](https://github.com/vitlibar))。
* `Memory` データベースエンジンに対する明示的な `DROP DATABASE` 実行時にデータを削除するように変更。 [#10557](https://github.com/ClickHouse/ClickHouse/issues/10557) を修正。 [#11021](https://github.com/ClickHouse/ClickHouse/pull/11021) ([tavplubix](https://github.com/tavplubix))。
* `rdkafka` ライブラリの内部スレッドにスレッド名を設定しました。`rdkafka` のログをサーバーログから参照できるようにしました。 [#10983](https://github.com/ClickHouse/ClickHouse/pull/10983) ([Azat Khuzhin](https://github.com/azat))。
* クエリ内での Unicode 空白文字をサポートしました。これにより、Word やウェブページからクエリをコピー＆ペーストした場合に問題が起きにくくなります。この変更により [#10896](https://github.com/ClickHouse/ClickHouse/issues/10896) が修正されました。 [#10903](https://github.com/ClickHouse/ClickHouse/pull/10903) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 関数 `tupleElement` で大きな UInt 型をインデックスとして使用できるようにしました。 [#10874](https://github.com/ClickHouse/ClickHouse/pull/10874) ([hcz](https://github.com/hczhcz))。
* Distributed への INSERT 時に prefer&#95;localhost&#95;replica/load&#95;balancing の設定を尊重するようにしました。 [#10867](https://github.com/ClickHouse/ClickHouse/pull/10867) ([Azat Khuzhin](https://github.com/azat)).
* `min_insert_block_size_rows_for_materialized_views`、`min_insert_block_size_bytes_for_materialized_views` 設定を導入。これらの設定は `min_insert_block_size_rows` および `min_insert_block_size_bytes` と同様ですが、`MATERIALIZED VIEW` に挿入されるブロックに対してのみ適用されます。これにより、MV へのデータ投入時のブロックのまとめ方を制御し、過剰なメモリ使用を防ぐことができます。 [#10858](https://github.com/ClickHouse/ClickHouse/pull/10858) ([Azat Khuzhin](https://github.com/azat)).
* サーバーのシャットダウン中にレプリケートキューで発生する例外を解消。 [#10819](https://github.com/ClickHouse/ClickHouse/issues/10819) を修正。 [#10841](https://github.com/ClickHouse/ClickHouse/pull/10841)（[alesapin](https://github.com/alesapin)）。
* 数値誤差により `varSamp`、`varPop` が負の結果を返すことがないようにし、`stddevSamp`、`stddevPop` が負の分散から計算されないようにしました。これにより [#10532](https://github.com/ClickHouse/ClickHouse/issues/10532) が修正されました。 [#10829](https://github.com/ClickHouse/ClickHouse/pull/10829) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* DNS の例外メッセージを改善。[#10813](https://github.com/ClickHouse/ClickHouse/issues/10813) を修正。 [#10828](https://github.com/ClickHouse/ClickHouse/pull/10828) （[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 一部のパースエラー発生時の HTTP レスポンスコードを 400 Bad Request に変更しました。この修正により [#10636](https://github.com/ClickHouse/ClickHouse/issues/10636) が解決されました。 [#10640](https://github.com/ClickHouse/ClickHouse/pull/10640)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* clickhouse-client が clickhouse-server より新しい場合にメッセージを出力するようにしました。 [#10627](https://github.com/ClickHouse/ClickHouse/pull/10627) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `INSERT INTO [db.]table WATCH` クエリのサポートを追加しました。[#10498](https://github.com/ClickHouse/ClickHouse/pull/10498)（[vzakaznikov](https://github.com/vzakaznikov)）。
* clickhouse-client で quota&#95;key を指定できるようにしました。これにより [#10227](https://github.com/ClickHouse/ClickHouse/issues/10227) がクローズされます。 [#10270](https://github.com/ClickHouse/ClickHouse/pull/10270)（[alexey-milovidov](https://github.com/alexey-milovidov)）。

#### パフォーマンスの改善 {#performance-improvement-9}


* 複数のレプリカがマージ、ミューテーション、パーティションの削除・移動・置換を同時に割り当てられるようにしました。これにより [#10367](https://github.com/ClickHouse/ClickHouse/issues/10367) が解決されます。 [#11639](https://github.com/ClickHouse/ClickHouse/pull/11639) ([alexey-milovidov](https://github.com/alexey-milovidov)) [#11795](https://github.com/ClickHouse/ClickHouse/pull/11795) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `optimize_aggregation_in_order` 設定により、テーブルのソートキーに基づく `GROUP BY` の最適化を有効化。[#9113](https://github.com/ClickHouse/ClickHouse/pull/9113)（[dimarub2000](https://github.com/dimarub2000)）。
* `FINAL` を伴う `SELECT` クエリは並列実行されるようになりました。使用されるスレッド数を制限するための設定項目 `max_final_threads` が追加されました。 [#10463](https://github.com/ClickHouse/ClickHouse/pull/10463) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `INSERT SELECT` または clickhouse-client を用いた INSERT で小さなブロックが生成される場合（並列パースで典型的に発生）に、INSERT クエリのパフォーマンスを改善しました。これにより [#11275](https://github.com/ClickHouse/ClickHouse/issues/11275) が修正されました。DEFAULT フィールドに対して CONSTRAINT が動作していなかった問題を修正しました。これにより [#11273](https://github.com/ClickHouse/ClickHouse/issues/11273) が修正されました。TEMPORARY テーブルに対して CONSTRAINTS が無視されていた問題を修正しました。これにより [#11274](https://github.com/ClickHouse/ClickHouse/issues/11274) が修正されました。[#11276](https://github.com/ClickHouse/ClickHouse/pull/11276)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `optimize_aggregators_of_group_by_keys` 設定によって有効になる、SELECT 句内の GROUP BY キーに対する min/max/any 集約関数を除去する最適化。[#11667](https://github.com/ClickHouse/ClickHouse/pull/11667) ([xPoSx](https://github.com/xPoSx))。[#11806](https://github.com/ClickHouse/ClickHouse/pull/11806) ([Azat Khuzhin](https://github.com/azat))。
* `any` 関数の外にあらゆる処理を移動する新しい最適化を追加し、`optimize_move_functions_out_of_any` で有効化 [#11529](https://github.com/ClickHouse/ClickHouse/pull/11529)（[Ruslan](https://github.com/kamalov-ruslan)）。
* Pretty フォーマット使用時の対話モードにおける `clickhouse-client` のパフォーマンスを改善しました。以前のバージョンでは、UTF-8 文字列の表示幅の計算に多くの時間が費やされる場合がありました。これにより [#11323](https://github.com/ClickHouse/ClickHouse/issues/11323) がクローズされました。 [#11323](https://github.com/ClickHouse/ClickHouse/pull/11323) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `ORDER BY` かつ `LIMIT` が小さい（`max_block_size` 未満）クエリのパフォーマンスを改善しました。 [#11171](https://github.com/ClickHouse/ClickHouse/pull/11171) ([Albert Kidrachev](https://github.com/Provet)).
* ランタイムでの CPU 検出を追加し、最適な関数実装を選択してディスパッチするようにしました。複数のターゲット向けコード生成をサポートしました。これにより [#1017](https://github.com/ClickHouse/ClickHouse/issues/1017) がクローズされました。[#10058](https://github.com/ClickHouse/ClickHouse/pull/10058)（[DimasKovas](https://github.com/DimasKovas)）。
* `clickhouse` バイナリの `mlock` をデフォルトで有効化しました。これにより、高い IO 負荷時に `clickhouse` 実行ファイルがページアウトされるのを防ぎます。 [#11139](https://github.com/ClickHouse/ClickHouse/pull/11139) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `sum` 集約関数を使い、かつ GROUP BY キーなしでクエリを実行すると、何倍も高速になります。 [#10992](https://github.com/ClickHouse/ClickHouse/pull/10992) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 単純なキーを持つ `ORDER BY` で使用される radix sort について、一部の冗長なデータ移動を削減することで性能を改善しました。 [#10981](https://github.com/ClickHouse/ClickHouse/pull/10981) ([Arslan Gumerov](https://github.com/g-arslan)).
* MergeJoin で左テーブルのより大きな部分をソートします。左側のブロックをメモリ上にバッファします。左側ブロックのバッファサイズを管理するための `partial_merge_join_left_table_buffer_bytes` 設定を追加しました。 [#10601](https://github.com/ClickHouse/ClickHouse/pull/10601) ([Artem Zuikov](https://github.com/4ertus2)).
* サブクエリから重複した ORDER BY と DISTINCT を削除します。この最適化は `optimize_duplicate_order_by_and_distinct` によって有効になります [#10067](https://github.com/ClickHouse/ClickHouse/pull/10067) ([Mikhail Malafeev](https://github.com/demo-99))。
* この機能は、`optimize_group_by_function_keys` によって有効化され、GROUP BY 句における他のキーに対する関数の使用を不要にします [#10051](https://github.com/ClickHouse/ClickHouse/pull/10051) ([xPoSx](https://github.com/xPoSx))。
* 集約関数から算術演算を外出しする新しい最適化を導入し、`optimize_arithmetic_operations_in_aggregate_functions` で有効化できるようにしました [#10047](https://github.com/ClickHouse/ClickHouse/pull/10047) ([Ruslan](https://github.com/kamalov-ruslan))。
* curl の代わりに Poco ベースの S3 用 HTTP クライアントを使用するようにしました。これにより、S3 ストレージおよびテーブル関数のパフォーマンスが向上し、メモリ使用量が減少します。 [#11230](https://github.com/ClickHouse/ClickHouse/pull/11230) ([Pavel Kovalenko](https://github.com/Jokser)).
* 常に適用されていた制限に基づく再スケジュールに関連した Kafka のパフォーマンス問題を修正しました。 [#11149](https://github.com/ClickHouse/ClickHouse/pull/11149) ([filimonov](https://github.com/filimonov)).
* jemalloc の percpu&#95;arena:percpu を有効化（スレッドプールによるメモリ断片化を軽減します）。 [#11084](https://github.com/ClickHouse/ClickHouse/pull/11084) ([Azat Khuzhin](https://github.com/azat)).
* S3 HTTP クライアントからレスポンスを読み取る際のメモリ使用量を最適化。 [#11561](https://github.com/ClickHouse/ClickHouse/pull/11561) ([Pavel Kovalenko](https://github.com/Jokser)).
* パフォーマンス向上のために、Kafka のデフォルト設定を調整しました。 [#11388](https://github.com/ClickHouse/ClickHouse/pull/11388) ([filimonov](https://github.com/filimonov)).

#### 実験的機能 {#experimental-feature-5}

- データ型`Point` (Tuple(Float64, Float64))および`Polygon` (Array(Array(Tuple(Float64, Float64)))を追加しました。[#10678](https://github.com/ClickHouse/ClickHouse/pull/10678) ([Alexey Ilyukhov](https://github.com/livace))。
- 配列内の部分列を検索するための`hasSubstr`関数を追加しました。注意: この関数は予告なく名前が変更される可能性があります。[#11071](https://github.com/ClickHouse/ClickHouse/pull/11071) ([Ryad Zenine](https://github.com/r-zenine))。
- OpenCLサポートとバイトニックソートアルゴリズムを追加しました。単一カラム内の整数型データのソートに使用できます。`-DENABLE_OPENCL=1`フラグを指定してビルドする必要があります。他のアルゴリズムの代わりにバイトニックソートアルゴリズムを使用するには、設定オプション`special_sort`に`bitonic_sort`を設定し、OpenCLが利用可能であることを確認してください。この機能はパフォーマンスの改善などを目的としたものではなく、例示およびデモンストレーション目的でのみ提供されています。この方向での更なる開発が行われない場合、近い将来削除される可能性があります。[#10232](https://github.com/ClickHouse/ClickHouse/pull/10232) ([Ri](https://github.com/margaritiko))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-11}


* `programs` と `utils` で `clang-tidy` を有効化。 [#10991](https://github.com/ClickHouse/ClickHouse/pull/10991) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `tzdata` への依存を削除しました。`/usr/share/zoneinfo` ディレクトリが存在しなくてもエラーにならないようにしました。システムに tzdata がインストールされていなくても、ClickHouse ではすべてのタイムゾーンが利用できることに注意してください。 [#11827](https://github.com/ClickHouse/ClickHouse/pull/11827) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* MSan と UBSan のストレステストを追加しました。すでに機能テスト用の MSan/UBSan は存在しており、「stress」テストは別種のテストである点に注意してください。 [#10871](https://github.com/ClickHouse/ClickHouse/pull/10871) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* クラッシュメッセージにコンパイラのビルド ID を出力するようにしました。これにより、どのバイナリがクラッシュしたかを、より確実に特定できるようになります。新しい関数 `buildId` を追加しました。 [#11824](https://github.com/ClickHouse/ClickHouse/pull/11824) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* FREEZE クエリの後でも mutation が動作し続けることを確認するためのテストを追加しました。 [#11820](https://github.com/ClickHouse/ClickHouse/pull/11820) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* テスト名に文字列「fail」を含むテストを許可しないようにしました。ブラウザでテスト結果を表示するときに Ctrl+F で「fail」を検索すると、目的の失敗テストが探しづらくなるためです。 [#11817](https://github.com/ClickHouse/ClickHouse/pull/11817) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* HTTPHandlerFactory から未使用のインポートを削除しました。 [#11660](https://github.com/ClickHouse/ClickHouse/pull/11660) ([Bharat Nallan](https://github.com/bharatnc))。
* `copier` が実行されるインスタンスをランダムサンプリングする処理を追加しました。これは `Too many simultaneous queries` エラーを回避するために必要です。また、`timeout` を延長し、障害発生確率を下げました。 [#11573](https://github.com/ClickHouse/ClickHouse/pull/11573) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 不足していた `include` を修正。 [#11525](https://github.com/ClickHouse/ClickHouse/pull/11525) ([Matwey V. Kornilov](https://github.com/matwey))。
* 古いサンプルプログラムを削除してビルドを高速化しました。また、孤立していた機能テストもいくつか見つかりました。 [#11486](https://github.com/ClickHouse/ClickHouse/pull/11486) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* CI でのビルド用に ccache のサイズを拡大。 [#11450](https://github.com/ClickHouse/ClickHouse/pull/11450) ([alesapin](https://github.com/alesapin)).
* deb ビルドでは `unit_tests_dbms` のみを残すようにしました。[#11429](https://github.com/ClickHouse/ClickHouse/pull/11429)（[Ilya Yatsishin](https://github.com/qoega)）。
* librdkafka をバージョン [1.4.2](https://github.com/edenhill/librdkafka/releases/tag/v1.4.2) に更新。 [#11256](https://github.com/ClickHouse/ClickHouse/pull/11256)（[filimonov](https://github.com/filimonov)）。
* CMake のビルドファイルをリファクタリング。[#11390](https://github.com/ClickHouse/ClickHouse/pull/11390) ([Ivan](https://github.com/abyss7)).
* いくつかの不安定な統合テストを修正。 [#11355](https://github.com/ClickHouse/ClickHouse/pull/11355) ([alesapin](https://github.com/alesapin)).
* UBSan で実行する単体テストのサポートを追加。 [#11345](https://github.com/ClickHouse/ClickHouse/pull/11345) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 統合テスト `test_insertion_sync_fails_with_timeout` から不要な timeout を削除しました。 [#11343](https://github.com/ClickHouse/ClickHouse/pull/11343) ([alesapin](https://github.com/alesapin)).
* clickhouse-test でハングしたクエリの検出精度を向上しました。 [#11321](https://github.com/ClickHouse/ClickHouse/pull/11321) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* サーバーがデバッグビルドまたはサニタイザー有効の状態でビルドされている場合に、警告を出力するようにしました。 [#11304](https://github.com/ClickHouse/ClickHouse/pull/11304) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* テストの実行前に `clickhouse-test` がサーバーの生存状態を確認するようになりました。 [#11285](https://github.com/ClickHouse/ClickHouse/pull/11285) ([alesapin](https://github.com/alesapin)).
* 潜在的に不安定なテスト `00731_long_merge_tree_select_opened_files.sh` を修正。頻繁に失敗するわけではありませんが、ThreadFuzzer を使った実験中に、このテスト内で潜在的なレースコンディションを検出しました: [#9814](https://github.com/ClickHouse/ClickHouse/issues/9814) 例については [link](https://clickhouse-test-reports.s3.yandex.net/9814/40e3023e215df22985d275bf85f4d2290897b76b/functional_stateless_tests_\(unbundled\).html#fail1) を参照してください。 [#11270](https://github.com/ClickHouse/ClickHouse/pull/11270) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* CI でのテスト中に `curl` の呼び出しがタイムアウトした場合は、テストを再実行するようにしました。これは、当社の CI インフラストラクチャでよく発生する、10 秒以上に及ぶシステムのハングアップが原因で起こる可能性があります。この変更により [#11267](https://github.com/ClickHouse/ClickHouse/issues/11267) が修正されました。 [#11268](https://github.com/ClickHouse/ClickHouse/pull/11268) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* @donmikel による Join テーブルエンジン用のテストを追加。これにより [#9158](https://github.com/ClickHouse/ClickHouse/issues/9158) がクローズされる。[#11265](https://github.com/ClickHouse/ClickHouse/pull/11265)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* ユニットテスト内のいくつかの軽微なエラーを修正。 [#11262](https://github.com/ClickHouse/ClickHouse/pull/11262) ([alesapin](https://github.com/alesapin))。
* これにより、`cctz` ライブラリ用のリンカーコマンドの一部が、他のライブラリと混在しなくなりました。 [#11213](https://github.com/ClickHouse/ClickHouse/pull/11213) ([alesapin](https://github.com/alesapin)).
* /programs/server を実行プログラム本体とライブラリに分割しました。 [#11186](https://github.com/ClickHouse/ClickHouse/pull/11186) ([Ivan](https://github.com/abyss7))。
* protobuf と gRPC のビルドスクリプトを改善。 [#11172](https://github.com/ClickHouse/ClickHouse/pull/11172) ([Vitaly Baranov](https://github.com/vitlibar)).
* 動作していなかったパフォーマンステストを有効化。 [#11158](https://github.com/ClickHouse/ClickHouse/pull/11158) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* CH インスタンスを起動する前に、テスト用のルート S3 バケットを作成。 [#11142](https://github.com/ClickHouse/ClickHouse/pull/11142) ([Pavel Kovalenko](https://github.com/Jokser)).
* 非定数ポリゴンのパフォーマンステストを追加。 [#11141](https://github.com/ClickHouse/ClickHouse/pull/11141) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `00979_live_view_watch_continuous_aggregates` テストを修正しました。[#11024](https://github.com/ClickHouse/ClickHouse/pull/11024)（[vzakaznikov](https://github.com/vzakaznikov)）。
* 統合テストで `tmpfs` 上で ZooKeeper を実行できるようにする機能を追加。[#11002](https://github.com/ClickHouse/ClickHouse/pull/11002) ([alesapin](https://github.com/alesapin)).
* `odbc-bridge` の待機に指数バックオフを用いるようにしました。以前の 200 ms の待機時間では、CI 環境では十分ではありませんでした。 [#10990](https://github.com/ClickHouse/ClickHouse/pull/10990) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 非決定的なテストを修正。 [#10989](https://github.com/ClickHouse/ClickHouse/pull/10989) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 空の外部データに対するテストを追加しました。 [#10926](https://github.com/ClickHouse/ClickHouse/pull/10926) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 各テストごとにデータベースを再作成します。これによりテスト間の分離性が向上します。 [#10902](https://github.com/ClickHouse/ClickHouse/pull/10902) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* カラム関連のコードに、より多くの `assert` を追加しました。 [#10833](https://github.com/ClickHouse/ClickHouse/pull/10833) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* サニタイザとの連携を改善。サニタイザの失敗メッセージに `query_id` の情報を出力するようにしました。 [#10832](https://github.com/ClickHouse/ClickHouse/pull/10832) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* &quot;Split build smoke test&quot; チェックにおける明白なレースコンディションを修正。 [#10820](https://github.com/ClickHouse/ClickHouse/pull/10820) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* MergeTreeIndexFullText における MSan の誤検出レポートを修正。最初に発生したのは [#9968](https://github.com/ClickHouse/ClickHouse/issues/9968)。[#10801](https://github.com/ClickHouse/ClickHouse/pull/10801)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* MariaDB Client ライブラリ向けに MSan の抑制を追加。 [#10800](https://github.com/ClickHouse/ClickHouse/pull/10800) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* GRPC の make が protobuf ファイルを見つけられなかった問題を、適切なパスを `make` ファイルに追加することで修正しました。 [#10794](https://github.com/ClickHouse/ClickHouse/pull/10794) ([mnkonkova](https://github.com/mnkonkova)).
* base、utils、programs に対して追加の警告（`-Weverything`）を有効化します。コードの大部分ではすでに有効になっていることに注意してください。 [#10779](https://github.com/ClickHouse/ClickHouse/pull/10779) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* ライブラリからの警告抑制が、誤って public として宣言されていました [#10396](https://github.com/ClickHouse/ClickHouse/issues/10396)。[#10776](https://github.com/ClickHouse/ClickHouse/pull/10776)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* [#10396](https://github.com/ClickHouse/ClickHouse/issues/10396) で誤って削除されたパッチを復元。 [#10774](https://github.com/ClickHouse/ClickHouse/pull/10774) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* パフォーマンステストのエラーを修正（パート 2）。 [#10773](https://github.com/ClickHouse/ClickHouse/pull/10773) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* パフォーマンステストのエラーを修正。 [#10766](https://github.com/ClickHouse/ClickHouse/pull/10766) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* クロスビルドで使用するコンパイラを clang-10 に更新しました。 [#10724](https://github.com/ClickHouse/ClickHouse/pull/10724) ([Ivan](https://github.com/abyss7)).
* RPM パッケージのインストール手順を更新しました。Denis（TG ログイン @ldviolet）の提案を、Arkady Shejn が実装しました。[#10707](https://github.com/ClickHouse/ClickHouse/pull/10707) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `tests/queries/0_stateless/01246_insert_into_watch_live_view.py` テストの修正を試行中。 [#10670](https://github.com/ClickHouse/ClickHouse/pull/10670)（[vzakaznikov](https://github.com/vzakaznikov)）。
* 00979&#95;live&#95;view&#95;watch&#95;continuous&#95;aggregates.py テストを修正して再度有効化。 [#10658](https://github.com/ClickHouse/ClickHouse/pull/10658) ([vzakaznikov](https://github.com/vzakaznikov)).
* ASan ストレステストで発生する OOM を修正。[#10646](https://github.com/ClickHouse/ClickHouse/pull/10646) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* clang-10 への移行後に HashTable で発生した UBSan レポート（nullptr へのゼロの加算）を修正しました。 [#10638](https://github.com/ClickHouse/ClickHouse/pull/10638) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* コンパイル時の tzdata 処理において、外部の `ld` (bfd) リンカの呼び出しを削除しました。 [#10634](https://github.com/ClickHouse/ClickHouse/pull/10634) ([alesapin](https://github.com/alesapin)).
* `lld` を使用して BLOB（リソース）をリンクできるようにしました。 [#10632](https://github.com/ClickHouse/ClickHouse/pull/10632) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `LZ4` ライブラリでの UBSan レポートを修正。 [#10631](https://github.com/ClickHouse/ClickHouse/pull/10631) ([alexey-milovidov](https://github.com/alexey-milovidov))。あわせて [https://github.com/lz4/lz4/issues/857](https://github.com/lz4/lz4/issues/857) も参照。
* LZ4 を最新の dev ブランチに更新。 [#10630](https://github.com/ClickHouse/ClickHouse/pull/10630) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 安定バージョンの一覧を含む、機械可読な自動生成ファイルを追加しました。 [#10628](https://github.com/ClickHouse/ClickHouse/pull/10628) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `capnp::UnalignedFlatArrayMessageReader` 向けの `capnproto` のバージョンチェックを修正。 [#10618](https://github.com/ClickHouse/ClickHouse/pull/10618) ([Matwey V. Kornilov](https://github.com/matwey)).
* テストにおけるメモリ使用量を削減。 [#10617](https://github.com/ClickHouse/ClickHouse/pull/10617) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 新しい Live View テストでハードコードされたタイムアウトを修正。 [#10604](https://github.com/ClickHouse/ClickHouse/pull/10604) ([vzakaznikov](https://github.com/vzakaznikov)).
* tests/queries/0&#95;stateless/helpers/client.py でクライアントを開く際のタイムアウトを延長。[#10599](https://github.com/ClickHouse/ClickHouse/pull/10599) ([vzakaznikov](https://github.com/vzakaznikov))。
* clang ビルドで ThinLTO を有効化。[#10435](https://github.com/ClickHouse/ClickHouse/pull/10435) の続き。[#10585](https://github.com/ClickHouse/ClickHouse/pull/10585)（[Amos Bird](https://github.com/amosbird)）。
* fuzzer を追加し、oss-fuzz との統合に向けた準備を行いました。 [#10546](https://github.com/ClickHouse/ClickHouse/pull/10546) ([kyprizel](https://github.com/kyprizel))。
* FreeBSD のビルドを修正。 [#10150](https://github.com/ClickHouse/ClickHouse/pull/10150) ([Ivan](https://github.com/abyss7))。
* pytest フレームワークを使用したクエリテスト用の新しいビルドを追加。 [#10039](https://github.com/ClickHouse/ClickHouse/pull/10039) ([Ivan](https://github.com/abyss7))。





## ClickHouse release v20.4 {#clickhouse-release-v204}

### ClickHouse release v20.4.8.99-stable 2020-08-10 {#clickhouse-release-v204899-stable-2020-08-10}

#### バグ修正 {#bug-fix-28}


* `parseDateTimeBestEffort` 関数に Unix タイムスタンプが引数として渡された場合に発生していたエラーを修正しました。これにより [#13362](https://github.com/ClickHouse/ClickHouse/issues/13362) が解決されます。 [#13441](https://github.com/ClickHouse/ClickHouse/pull/13441) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `uniqExact`、`topK`、`sumDistinct` など、NaN 値を含む Float 型に対して呼び出された類似の集約関数において、潜在的な低パフォーマンスおよびわずかに不正確な結果が生じる問題を修正しました。この問題は debug ビルドで `assert` が発生する原因にもなっていました。この修正により [#12491](https://github.com/ClickHouse/ClickHouse/issues/12491) が解決されました。[#13254](https://github.com/ClickHouse/ClickHouse/pull/13254)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* リテラルの `NULL` ではない nullable な `constexpr` を条件として受け取る `if` 関数を修正しました。[#12463](https://github.com/ClickHouse/ClickHouse/issues/12463) を修正します。[#13226](https://github.com/ClickHouse/ClickHouse/pull/13226)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 配列要素が `Nullable` であり、かつ配列の添字も `Nullable` の場合における `arrayElement` 関数の `assert` を修正しました。これにより [#12172](https://github.com/ClickHouse/ClickHouse/issues/12172) が修正されました。 [#13224](https://github.com/ClickHouse/ClickHouse/pull/13224) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 関数を用いたインデックス解析の誤りを修正しました。これにより、`MergeTree` テーブルの読み取り時に誤った部分がプルーニングされてしまう可能性がありました。 [#13060](https://github.com/ClickHouse/ClickHouse/issues/13060) を修正しました。 [#12406](https://github.com/ClickHouse/ClickHouse/issues/12406) を修正しました。 [#13081](https://github.com/ClickHouse/ClickHouse/pull/13081)（[Anton Popov](https://github.com/CurtizJ)）。
* ローカルレプリカからの `SELECT` におけるスレッド数の不要な制限を修正しました。 [#12840](https://github.com/ClickHouse/ClickHouse/pull/12840) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `WITH TOTALS` を使用したクエリで発生する可能性があった、データ内の余分なオーバーフロー行を修正しました。 [#12747](https://github.com/ClickHouse/ClickHouse/pull/12747) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `IN` セクション内で関数として解釈される大きなタプルに関するパフォーマンスを修正しました。ユーザーが何らかの理由で `WHERE x IN (1, 2, ...)` ではなく `WHERE x IN tuple(1, 2, ...)` と記述するケースです。 [#12700](https://github.com/ClickHouse/ClickHouse/pull/12700) ([Anton Popov](https://github.com/CurtizJ)).
* `input_format_parallel_parsing` のメモリトラッキングを修正（スレッドをグループにアタッチすることで対応）。[#12672](https://github.com/ClickHouse/ClickHouse/pull/12672)（[Azat Khuzhin](https://github.com/azat)）。
* [#12293](https://github.com/ClickHouse/ClickHouse/issues/12293) を修正し、サブクエリに `WITH` 句が含まれている場合でも述語をプッシュできるようにしました。 [#12663](https://github.com/ClickHouse/ClickHouse/pull/12663)（[Winter Zhang](https://github.com/zhang2014)）。
* [#10572](https://github.com/ClickHouse/ClickHouse/issues/10572) 定数式を用いた Bloom filter インデックスに関する不具合を修正しました。[#12659](https://github.com/ClickHouse/ClickHouse/pull/12659)（[Winter Zhang](https://github.com/zhang2014)）。
* ブローカーが利用不能な場合（など）に `StorageKafka` で発生していた `SIGSEGV` を修正しました。 [#12658](https://github.com/ClickHouse/ClickHouse/pull/12658) ([Azat Khuzhin](https://github.com/azat)).
* `Array(UUID)` 引数を取る `if` 関数をサポートしました。これにより [#11066](https://github.com/ClickHouse/ClickHouse/issues/11066) が修正されました。[#12648](https://github.com/ClickHouse/ClickHouse/pull/12648)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* キャッシュレイアウトを使用する外部ディクショナリで、サーバークラッシュにつながる可能性のあるレースコンディションを修正しました。 [#12566](https://github.com/ClickHouse/ClickHouse/pull/12566) ([alesapin](https://github.com/alesapin)).
* `DROP TABLE` 時に Distributed テーブルのデータ（非同期 `INSERT` のブロック）を削除するようにしました。 [#12556](https://github.com/ClickHouse/ClickHouse/pull/12556) ([Azat Khuzhin](https://github.com/azat)).
* `enable_mixed_granularity_parts=1` のときに `ALTER DELETE` クエリを実行すると古いパーツが壊れてしまう不具合を修正しました。[#12536](https://github.com/ClickHouse/ClickHouse/issues/12536) を修正。[#12543](https://github.com/ClickHouse/ClickHouse/pull/12543) ([alesapin](https://github.com/alesapin))。
* 無効な引数数が指定された場合の関数 `in` の例外メッセージを改善。 [#12529](https://github.com/ClickHouse/ClickHouse/pull/12529) ([Anton Popov](https://github.com/CurtizJ)).
* コンパクトパーツからの読み込み時に発生していたパフォーマンス問題を修正しました。 [#12492](https://github.com/ClickHouse/ClickHouse/pull/12492) ([Anton Popov](https://github.com/CurtizJ)).
* 辞書キーの式に対して `JOIN` を行う場合（`t JOIN dict ON expr(dict.id) = t.id`）に発生していた、辞書を用いた `JOIN` のクラッシュを修正しました。このケースでは辞書 `JOIN` の最適化を無効化します。[#12458](https://github.com/ClickHouse/ClickHouse/pull/12458) ([Artem Zuikov](https://github.com/4ertus2))。
* StorageMerge 使用時に発生しうるセグメンテーションフォルトを修正しました。[#12054](https://github.com/ClickHouse/ClickHouse/issues/12054) をクローズ。 [#12401](https://github.com/ClickHouse/ClickHouse/pull/12401) ([tavplubix](https://github.com/tavplubix))。
* `WITH FILL` 修飾子での列の並び順を修正しました。以前は、`ORDER BY` ステートメントで指定した列の順序が正しく反映されていませんでした。 [#12306](https://github.com/ClickHouse/ClickHouse/pull/12306) ([Anton Popov](https://github.com/CurtizJ)).
* 仮想カラム（`Merge` テーブルの `_table` など）や、`system.tables` へのクエリ時にデータベース名でフィルタリングするようなシステムテーブルの「index」カラムによってデータをフィルタリングする式があり、その式が `Nullable` 型を返す場合に発生する &quot;bad cast&quot; 例外を回避します。これにより [#12166](https://github.com/ClickHouse/ClickHouse/issues/12166) が修正されました。 [#12305](https://github.com/ClickHouse/ClickHouse/pull/12305) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* TrieDictionary の読み込みに失敗した際にエラーを表示するようにしました。 [#12290](https://github.com/ClickHouse/ClickHouse/pull/12290) ([Vitaly Baranov](https://github.com/vitlibar)).
* 関数 `arrayFill` が空配列に対して誤って動作し、クラッシュを引き起こす可能性がありました。これにより [#12263](https://github.com/ClickHouse/ClickHouse/issues/12263) が修正されました。 [#12279](https://github.com/ClickHouse/ClickHouse/pull/12279) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `LowCardinality` 型に対する共通型への変換を実装しました。これにより、LowCardinality 型の列と他の列を持つテーブル同士で `UNION ALL` を実行できるようになりました。これにより [#8212](https://github.com/ClickHouse/ClickHouse/issues/8212) が修正されました。また [#4342](https://github.com/ClickHouse/ClickHouse/issues/4342) も修正されました。 [#12275](https://github.com/ClickHouse/ClickHouse/pull/12275)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `StorageFile` への複数回の連続した挿入時に、一部の特殊な型に対するヘッダーが複数回書き込まれてしまう不具合を修正しました。これにより [#6155](https://github.com/ClickHouse/ClickHouse/issues/6155) が修正されました。 [#12197](https://github.com/ClickHouse/ClickHouse/pull/12197) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 0 または 1 以外の `UInt8` 値に対する論理関数の動作を修正しました。 [#12196](https://github.com/ClickHouse/ClickHouse/pull/12196) ([Alexander Kazakov](https://github.com/Akazz)).
* max&#95;memory&#95;usage* の上限をプロセスの常駐メモリ量までに制限しました。 [#12182](https://github.com/ClickHouse/ClickHouse/pull/12182) ([Azat Khuzhin](https://github.com/azat))。
* GROUP BY における injective な関数の削除時の `dictGet` 引数チェックを修正しました。 [#12179](https://github.com/ClickHouse/ClickHouse/pull/12179) ([Azat Khuzhin](https://github.com/azat)).
* ODBC 接続がスキーマをサポートしていない場合、辞書ソースのテーブル名をスキーマ名とテーブル名に分割しないようにしました。 [#12165](https://github.com/ClickHouse/ClickHouse/pull/12165) ([Vitaly Baranov](https://github.com/vitlibar))。
* 条件が NULL と評価される場合にレコードが削除されてしまう `ALTER DELETE` の誤ったロジックを修正しました。これにより [#9088](https://github.com/ClickHouse/ClickHouse/issues/9088) が修正されます。この変更により [#12106](https://github.com/ClickHouse/ClickHouse/issues/12106) がクローズされます。[#12153](https://github.com/ClickHouse/ClickHouse/pull/12153)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* エイリアスが存在する場合に、外部 DBMS（例: MySQL、ODBC）に送信するクエリの変換処理を修正しました。これにより [#12032](https://github.com/ClickHouse/ClickHouse/issues/12032) が解決されました。 [#12151](https://github.com/ClickHouse/ClickHouse/pull/12151) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 整数除算で発生し得るオーバーフローを修正しました。これにより [#12119](https://github.com/ClickHouse/ClickHouse/issues/12119) が解決されます。[#12140](https://github.com/ClickHouse/ClickHouse/pull/12140)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `greatCircleDistance` と `geoDistance` において無限ループが発生する可能性のある不具合を修正しました。これにより [#12117](https://github.com/ClickHouse/ClickHouse/issues/12117) が修正されます。 [#12137](https://github.com/ClickHouse/ClickHouse/pull/12137) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 「pid」ファイルの扱いを正規化しました。以前のバージョンでは、適切にシャットダウンされずに kill された後、以前のサーバーと同じ pid を持つ別のプロセスが存在すると、サーバーが起動を拒否する場合がありました。また、ほかのサーバーが実行中であっても、サーバーの起動に失敗した際に pid ファイルが削除されてしまうこともありました。これにより [#3501](https://github.com/ClickHouse/ClickHouse/issues/3501) が修正されています。 [#12133](https://github.com/ClickHouse/ClickHouse/pull/12133) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* ENGINE=Dictionary を使用するテーブルの、辞書に対する依存関係の処理を修正しました。これにより [#10994](https://github.com/ClickHouse/ClickHouse/issues/10994) および [#10397](https://github.com/ClickHouse/ClickHouse/issues/10397) が修正されます。[#12116](https://github.com/ClickHouse/ClickHouse/pull/12116)（[Vitaly Baranov](https://github.com/vitlibar)）。
* スレッド総数に対する誤った制限値が原因で発生していた、`UNION` を含む `SELECT` のパフォーマンス低下を修正しました。 [#12030](https://github.com/ClickHouse/ClickHouse/issues/12030) を修正。 [#12103](https://github.com/ClickHouse/ClickHouse/pull/12103)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `-StateResample` コンビネータで発生していたセグメンテーションフォールトを修正しました。 [#12092](https://github.com/ClickHouse/ClickHouse/pull/12092) ([Anton Popov](https://github.com/CurtizJ)).
* `SELECT` において `system.quey_log` の `result_rows` および `result_bytes` メトリクスが空になる問題を修正しました。 [#11595](https://github.com/ClickHouse/ClickHouse/issues/11595) を解決。 [#12089](https://github.com/ClickHouse/ClickHouse/pull/12089) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `VIEW` からの SELECT に対してスレッド数を不必要に制限していた問題を修正しました。 [#11937](https://github.com/ClickHouse/ClickHouse/issues/11937) を修正。 [#12085](https://github.com/ClickHouse/ClickHouse/pull/12085) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `PREWHERE` に誤った型を使用した場合に発生しうるクラッシュを修正しました。[#12053](https://github.com/ClickHouse/ClickHouse/issues/12053)、[#12060](https://github.com/ClickHouse/ClickHouse/issues/12060) に対応。[#12060](https://github.com/ClickHouse/ClickHouse/pull/12060)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `LowCardinality` 型に対する関数 `defaultValueOfArgumentType` で発生していたエラー `Expected single dictionary argument for function` を修正しました。 [#11808](https://github.com/ClickHouse/ClickHouse/issues/11808) を修正。[#12056](https://github.com/ClickHouse/ClickHouse/pull/12056)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `Tuple(LowCardinality)` 引数を持つ高階関数で発生していたエラー `Cannot capture column` を修正しました。 [#9766](https://github.com/ClickHouse/ClickHouse/issues/9766) を解決。 [#12055](https://github.com/ClickHouse/ClickHouse/pull/12055)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* データベースの読み込み時にテーブルメタデータを並列にパースするようにしました。これにより、大量のテーブルが存在する場合のサーバー起動の遅さが解消されます。 [#12045](https://github.com/ClickHouse/ClickHouse/pull/12045) ([tavplubix](https://github.com/tavplubix)).
* Enum 型に対して `topK` 集約関数が Enum を返すようにしました。これにより [#3740](https://github.com/ClickHouse/ClickHouse/issues/3740) が修正されました。[#12043](https://github.com/ClickHouse/ClickHouse/pull/12043)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 制約が定数式かどうかを検査するように修正しました。これにより [#11360](https://github.com/ClickHouse/ClickHouse/issues/11360) が修正されました。 [#12042](https://github.com/ClickHouse/ClickHouse/pull/12042)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `Nullable` カラムを含むタプルの誤った比較を修正しました。 [#11985](https://github.com/ClickHouse/ClickHouse/issues/11985) を修正。 [#12039](https://github.com/ClickHouse/ClickHouse/pull/12039)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* allow&#95;introspection&#95;functions=0 の場合のアクセス権の計算方法を修正しました。 [#12031](https://github.com/ClickHouse/ClickHouse/pull/12031) ([Vitaly Baranov](https://github.com/vitlibar)).
* サイズの異なる `FixedString` 型の引数を持つ関数 `if` を呼び出した際に、誤った結果が返されたりクラッシュする可能性があった問題を修正しました。これにより [#11362](https://github.com/ClickHouse/ClickHouse/issues/11362) が解決されました。 [#12021](https://github.com/ClickHouse/ClickHouse/pull/12021) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 関数 `neighbor` を唯一の返却式として持つクエリは、オフセット `-9223372036854775808` でその関数が呼び出された場合、空の結果を返すことがあります。これは [#11367](https://github.com/ClickHouse/ClickHouse/issues/11367) を修正するものです。 [#12019](https://github.com/ClickHouse/ClickHouse/pull/12019)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* allow&#95;ddl=0 の場合のアクセス権限の計算を修正しました。 [#12015](https://github.com/ClickHouse/ClickHouse/pull/12015) ([Vitaly Baranov](https://github.com/vitlibar)).
* クラッシュにつながる可能性のあった `generateRandom` における配列サイズのオーバーフローを修正しました。これにより [#11371](https://github.com/ClickHouse/ClickHouse/issues/11371) が解決されます。 [#12013](https://github.com/ClickHouse/ClickHouse/pull/12013) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 浮動小数点例外が発生する可能性のある不具合を修正しました。これにより [#11378](https://github.com/ClickHouse/ClickHouse/issues/11378) がクローズされました。 [#12005](https://github.com/ClickHouse/ClickHouse/pull/12005) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* サーバー起動時のログメッセージにおける誤った設定名を修正しました。 [#11997](https://github.com/ClickHouse/ClickHouse/pull/11997) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `Values` フォーマットで発生していた `Query parameter was not set` を修正しました。[#11918](https://github.com/ClickHouse/ClickHouse/issues/11918) を解決。[#11936](https://github.com/ClickHouse/ClickHouse/pull/11936)（[tavplubix](https://github.com/tavplubix)）。
* クエリ内の置換（パラメータ化クエリ）のエイリアスを保持するようにしました。これにより [#11914](https://github.com/ClickHouse/ClickHouse/issues/11914) が修正されます。 [#11916](https://github.com/ClickHouse/ClickHouse/pull/11916)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* ストレージポリシーをデフォルトから変更した際にデータが移動されないバグを修正しました。 [#11893](https://github.com/ClickHouse/ClickHouse/pull/11893) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `DateTime64` のパース時に発生する可能性があった浮動小数点例外を修正しました。これにより [#11374](https://github.com/ClickHouse/ClickHouse/issues/11374) が解決されています。[#11875](https://github.com/ClickHouse/ClickHouse/pull/11875)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* HTTP インターフェイス経由でのメモリ使用量のアカウンティングを修正しました（`wait_end_of_query=1` の場合に影響が大きくなる可能性があります）。 [#11840](https://github.com/ClickHouse/ClickHouse/pull/11840) ([Azat Khuzhin](https://github.com/azat)).
* 等価性を確認する前に、ZooKeeper に保存されているメタデータを解析します。 [#11739](https://github.com/ClickHouse/ClickHouse/pull/11739) ([Azat Khuzhin](https://github.com/azat)).

#### パフォーマンス改善 {#performance-improvement-10}

- リテラルを含むIN演算子でインデックスが使用されない問題を修正しました。この問題はv19.3前後で導入されたパフォーマンス低下です。[#10574](https://github.com/ClickHouse/ClickHouse/issues/10574) を修正します。[#12062](https://github.com/ClickHouse/ClickHouse/pull/12062) ([nvartolomei](https://github.com/nvartolomei))。

#### ビルド/テスト/パッケージング改善 {#buildtestingpackaging-improvement-12}

- Dockerfileで最初の`apt-get update`の前に`ca-certificates`をインストールするようにしました。[#12095](https://github.com/ClickHouse/ClickHouse/pull/12095) ([Ivan Blinkov](https://github.com/blinkov))。

### ClickHouseリリース v20.4.6.53-stable 2020-06-25 {#clickhouse-release-v204653-stable-2020-06-25}

#### バグ修正 {#bug-fix-29}


* `prewhere` 条件で `Nullable` カラムを使用した場合に発生するまれなクラッシュを修正しました。[#11608](https://github.com/ClickHouse/ClickHouse/issues/11608) の対応の続きです。[#11869](https://github.com/ClickHouse/ClickHouse/pull/11869)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 高階関数内で arrayJoin を使用できないようにしました。これによりプロトコルの同期が壊れる問題が発生していました。この変更により [#3933](https://github.com/ClickHouse/ClickHouse/issues/3933) がクローズされます。[#11846](https://github.com/ClickHouse/ClickHouse/pull/11846)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* FixedString と定数 String の比較で誤った結果になる問題を修正しました。これにより [#11393](https://github.com/ClickHouse/ClickHouse/issues/11393) が解消されます。このバグはバージョン 20.4 で発生しました。[#11828](https://github.com/ClickHouse/ClickHouse/pull/11828)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 条件に `NULL` を含む場合に `if()` が誤った結果を返す問題を修正。 [#11807](https://github.com/ClickHouse/ClickHouse/pull/11807) ([Artem Zuikov](https://github.com/4ertus2)).
* クエリで使用されるスレッド数が多くなり過ぎる問題を修正。 [#11788](https://github.com/ClickHouse/ClickHouse/pull/11788) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `SELECT *, xyz.*` のようなクエリで、本来はエラーになるべきところが成功してしまっていた予期しない動作を修正。[#11753](https://github.com/ClickHouse/ClickHouse/pull/11753)（[hexiaoting](https://github.com/hexiaoting)）。
* メタデータの `ALTER` 実行中に、レプリケートされたフェッチがキャンセルされるようになりました。 [#11744](https://github.com/ClickHouse/ClickHouse/pull/11744) ([alesapin](https://github.com/alesapin)).
* Values 入力フォーマットにおける複合リテラルの誤った型推論が原因で発生していた LOGICAL&#95;ERROR を修正。 [#11732](https://github.com/ClickHouse/ClickHouse/pull/11732) ([tavplubix](https://github.com/tavplubix)).
* 定数カラムに対する `ORDER BY ... WITH FILL` の不具合を修正。[#11697](https://github.com/ClickHouse/ClickHouse/pull/11697)（[Anton Popov](https://github.com/CurtizJ)）。
* XDBC bridge と通信する際に適切なタイムアウトを渡すようにしました。これまで、bridge の生存確認やメタ情報の受信時にタイムアウトが正しく考慮されていませんでした。 [#11690](https://github.com/ClickHouse/ClickHouse/pull/11690) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* エイリアスを含む `ORDER BY` 句と併用された `LIMIT n WITH TIES` の動作を修正。 [#11689](https://github.com/ClickHouse/ClickHouse/pull/11689) ([Anton Popov](https://github.com/CurtizJ)).
* `system.mutations` が不正な状態になる原因となっていたエラーを修正しました。mutation 全体がすでに完了しているかのように表示されていても、サーバー側ではまだレプリケーションキューに `MUTATE_PART` タスクが残っており、それらの実行を試みてしまう問題がありました。これにより [#11611](https://github.com/ClickHouse/ClickHouse/issues/11611) が修正されました。 [#11681](https://github.com/ClickHouse/ClickHouse/pull/11681)（[alesapin](https://github.com/alesapin)）。
* 大文字と小文字を区別しないフラグ付き正規表現のサポートを追加しました。これにより [#11101](https://github.com/ClickHouse/ClickHouse/issues/11101) および [#11506](https://github.com/ClickHouse/ClickHouse/issues/11506) が修正されます。 [#11649](https://github.com/ClickHouse/ClickHouse/pull/11649)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 行レベルセキュリティが設定されている場合は、単純な `count` クエリの最適化を削除しました。以前のバージョンでは、ユーザーはフィルタリング後の件数ではなく、テーブル内のレコードの総件数を取得していました。この変更により [#11352](https://github.com/ClickHouse/ClickHouse/issues/11352) が修正されます。[#11644](https://github.com/ClickHouse/ClickHouse/pull/11644)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* String 用のブルームフィルタ（データスキッピングインデックス）を修正しました。 [#11638](https://github.com/ClickHouse/ClickHouse/pull/11638) ([Azat Khuzhin](https://github.com/azat)).
* `prewhere` 条件で `Nullable` カラムを使用したことにより発生する、まれなクラッシュを修正しました（[#11572](https://github.com/ClickHouse/ClickHouse/issues/11572) と何らかの関連がある可能性があります）。[#11608](https://github.com/ClickHouse/ClickHouse/pull/11608) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `Buffer` テーブルからのサンプリング読み取りを行うクエリで発生する `Block structure mismatch` エラーを修正。 [#11602](https://github.com/ClickHouse/ClickHouse/pull/11602) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `exception.code() % 256 = 0` の場合に `clickhouse-client` が返す誤った終了コードを修正しました。 [#11601](https://github.com/ClickHouse/ClickHouse/pull/11601) ([filimonov](https://github.com/filimonov))。
* サーバー起動時に出力される「Mark cache size was lowered」というログメッセージの軽微な誤りを修正しました。これにより [#11399](https://github.com/ClickHouse/ClickHouse/issues/11399) がクローズされます。 [#11589](https://github.com/ClickHouse/ClickHouse/pull/11589) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `PREWHERE column in (subquery)` と `ARRAY JOIN` を含むクエリで発生する `Size of offsets does not match size of column` エラーを修正しました。[#11580](https://github.com/ClickHouse/ClickHouse/pull/11580) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `SHOW CREATE TABLE` においてまれに発生していたセグメンテーションフォルトを修正。[#11490](https://github.com/ClickHouse/ClickHouse/issues/11490) を解決。[#11579](https://github.com/ClickHouse/ClickHouse/pull/11579)（[tavplubix](https://github.com/tavplubix)）。
* HTTP セッション内のすべてのクエリが同じ `query_id` を持っていました。この問題は修正されました。 [#11578](https://github.com/ClickHouse/ClickHouse/pull/11578) ([tavplubix](https://github.com/tavplubix))。
* これにより、`clickhouse-server` の Docker コンテナはサーバーの生存確認において IPv6 を優先して使用するようになります。 [#11550](https://github.com/ClickHouse/ClickHouse/pull/11550) ([Ivan Starkov](https://github.com/istarkov)).
* `<node>` の shard&#95;num/replica&#95;num を修正（use&#95;compact&#95;format&#95;in&#95;distributed&#95;parts&#95;names が壊れていた問題）。 [#11528](https://github.com/ClickHouse/ClickHouse/pull/11528) ([Azat Khuzhin](https://github.com/azat)).
* テーブル削除中に例外を引き起こす可能性のあるレースコンディションを修正しました。少しややこしいですが、まったく危険ではありません。説明が必要であれば、Telegram で声をかけてください。 [#11523](https://github.com/ClickHouse/ClickHouse/pull/11523) ([alesapin](https://github.com/alesapin))。
* -State 関数を用いた集約の途中で例外がスローされた場合に発生するメモリリークを修正しました。これにより [#8995](https://github.com/ClickHouse/ClickHouse/issues/8995) が解決されました。 [#11496](https://github.com/ClickHouse/ClickHouse/pull/11496) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `data skipping index` がバックグラウンドマージ中に変更される列（`SummingMergeTree`、`AggregatingMergeTree`、および `TTL GROUP BY` の対象列）に依存している場合、インデックスが正しく計算されていませんでした。この問題は、マージ処理の後にインデックスを計算するように変更し、マージ後のデータに対してインデックスが計算されるようにすることで修正されました。 [#11162](https://github.com/ClickHouse/ClickHouse/pull/11162) ([Azat Khuzhin](https://github.com/azat))。
* 古い libunwind のパッチを削除しました。 [https://github.com/ClickHouse-Extras/libunwind/commit/500aa227911bd185a94bfc071d68f4d3b03cb3b1#r39048012](https://github.com/ClickHouse-Extras/libunwind/commit/500aa227911bd185a94bfc071d68f4d3b03cb3b1#r39048012) これにより、`clang` ビルドで `-fno-omit-frame-pointer` を無効にできるようになり、平均で少なくとも 1% のパフォーマンス向上が見込めます。 [#10761](https://github.com/ClickHouse/ClickHouse/pull/10761) ([Amos Bird](https://github.com/amosbird)).
* 関数でラップされた主キーを使用する場合の&#39;FINAL&#39;修飾子と&#39;ORDER BY&#39;最適化の動作を修正しました。 [#10715](https://github.com/ClickHouse/ClickHouse/pull/10715) ([Anton Popov](https://github.com/CurtizJ)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-13}

- ユニットテストにおける重要度の低いエラーをいくつか修正しました。[#11262](https://github.com/ClickHouse/ClickHouse/pull/11262) ([alesapin](https://github.com/alesapin))。
- MergeTreeIndexFullTextにおける（誤検知の）MSanレポートを修正しました。この問題は最初に[#9968](https://github.com/ClickHouse/ClickHouse/issues/9968)で発生しました。[#10801](https://github.com/ClickHouse/ClickHouse/pull/10801) ([alexey-milovidov](https://github.com/alexey-milovidov))。

### ClickHouseリリース v20.4.5.36-stable 2020-06-10 {#clickhouse-release-v204536-stable-2020-06-10}

#### バグ修正 {#bug-fix-30}


* `min_bytes_to_use_direct_io` が有効で、PREWHERE が有効であり、かつ SAMPLE を使用している場合、またはスレッド数が多い場合に発生しうる `Data compressed with different methods` エラーを修正しました。これにより [#11539](https://github.com/ClickHouse/ClickHouse/issues/11539) が修正されます。 [#11540](https://github.com/ClickHouse/ClickHouse/pull/11540) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* コーデック用の返却圧縮サイズを修正。 [#11448](https://github.com/ClickHouse/ClickHouse/pull/11448) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 列がリテラル以外の引数を持つ圧縮コーデックを使用している場合にサーバーがクラッシュする問題を修正。 [#11365](https://github.com/ClickHouse/ClickHouse/issues/11365) を解決。 [#11431](https://github.com/ClickHouse/ClickHouse/pull/11431)（[alesapin](https://github.com/alesapin)）。
* `nan` を点として扱う場合の `pointInPolygon` を修正。 [#11375](https://github.com/ClickHouse/ClickHouse/issues/11375) を修正。 [#11421](https://github.com/ClickHouse/ClickHouse/pull/11421)（[Alexey Ilyukhov](https://github.com/livace)）。
* テーブルが正常に作成されなかった場合に、MergeTree のシャットダウン処理で未初期化メモリを読み取ってしまう可能性がある問題を修正。[#11420](https://github.com/ClickHouse/ClickHouse/pull/11420)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 緯度・経度の範囲外の引数が指定された場合の geohashesInBox の不具合を修正。 [#11403](https://github.com/ClickHouse/ClickHouse/pull/11403) ([Vasily Nemkov](https://github.com/Enmk)).
* 外部ソートと `LIMIT` を含むクエリで発生し得る `Pipeline stuck` エラーを修正。 [#11359](https://github.com/ClickHouse/ClickHouse/issues/11359) の修正。 [#11366](https://github.com/ClickHouse/ClickHouse/pull/11366) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* ReplicatedMergeTree におけるパーツ送信時の冗長なロックを削除。 [#11354](https://github.com/ClickHouse/ClickHouse/pull/11354) ([alesapin](https://github.com/alesapin)).
* `clickhouse-client` の複数行モードにおける `\G`（縦方向出力）のサポートを修正しました。これにより [#9933](https://github.com/ClickHouse/ClickHouse/issues/9933) がクローズされます。 [#11350](https://github.com/ClickHouse/ClickHouse/pull/11350)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `Lazy` データベース使用時に発生し得るセグメンテーションフォルトを修正。 [#11348](https://github.com/ClickHouse/ClickHouse/pull/11348) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `quantilesExactWeightedArray` のクラッシュを修正。 [#11337](https://github.com/ClickHouse/ClickHouse/pull/11337) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `ALTER` クエリでメタデータを変更する前にマージが停止されるようになりました。 [#11335](https://github.com/ClickHouse/ClickHouse/pull/11335) ([alesapin](https://github.com/alesapin)).
* `parallel_view_processing = 1` の設定を使用した `MATERIALIZED VIEW` への書き込みを再び並列で行えるようにしました。 [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241) を修正。 [#11330](https://github.com/ClickHouse/ClickHouse/pull/11330) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 抽出された JSON に、対応の取れていない &#123; または [ を含む文字列がある場合の `visitParamExtractRaw` の動作を修正。 [#11318](https://github.com/ClickHouse/ClickHouse/pull/11318) ([Ewout](https://github.com/devwout)).
* `ThreadPool` における極めてまれなレースコンディションを修正しました。 [#11314](https://github.com/ClickHouse/ClickHouse/pull/11314) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* clickhouse-copier における些細なデータレースを修正しました。インテグレーションテストで発見されました。 [#11313](https://github.com/ClickHouse/ClickHouse/pull/11313) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 変換処理で未初期化メモリが使用される可能性のある問題を修正。例: `SELECT toIntervalSecond(now64())`。 [#11311](https://github.com/ClickHouse/ClickHouse/pull/11311) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* プライマリキーに `Array` 列があり、その列に対して `empty` または `notEmpty` 関数を使ってクエリでフィルタリングを行う場合に、インデックス解析が機能しない問題を修正しました。これにより [#11286](https://github.com/ClickHouse/ClickHouse/issues/11286) が解決されました。 [#11303](https://github.com/ClickHouse/ClickHouse/pull/11303)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `max_network_bandwidth`、`max_execution_speed`、`priority` の設定によってクエリがスロットルされている場合に、クエリ速度の推定が正しく行われず、その結果 `min_execution_speed` の制限が機能しない、または誤って機能するバグを修正しました。`timeout_before_checking_execution_speed` のデフォルト値を非ゼロに変更しました。ゼロのままだと `min_execution_speed` および `max_execution_speed` の各設定が効果を持たないためです。これにより [#11297](https://github.com/ClickHouse/ClickHouse/issues/11297) が修正されます。これにより [#5732](https://github.com/ClickHouse/ClickHouse/issues/5732) が修正されます。これにより [#6228](https://github.com/ClickHouse/ClickHouse/issues/6228) が修正されます。ユーザビリティの改善: `clickhouse-client` において、例外メッセージがプログレスバーと連結されて表示されてしまうことを回避しました。 [#11296](https://github.com/ClickHouse/ClickHouse/pull/11296) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `SET DEFAULT ROLE` が誤った引数で呼び出された場合にクラッシュする問題を修正しました。これにより [#10586](https://github.com/ClickHouse/ClickHouse/issues/10586) が解決されています。 [#11278](https://github.com/ClickHouse/ClickHouse/pull/11278) ([Vitaly Baranov](https://github.com/vitlibar))。
* Protobuf 形式の不正なデータを読み込んだ際にクラッシュする問題を修正しました。この修正により [#5957](https://github.com/ClickHouse/ClickHouse/issues/5957)、[#11203](https://github.com/ClickHouse/ClickHouse/issues/11203) が解消されます。[#11258](https://github.com/ClickHouse/ClickHouse/pull/11258)（[Vitaly Baranov](https://github.com/vitlibar)）。
* cache-dictionary が（有効なキーがなく、すべてのキーが期限切れの場合に）通常の値ではなくデフォルト値を返してしまうバグを修正しました。これは string 型のフィールドにのみ影響します。 [#11233](https://github.com/ClickHouse/ClickHouse/pull/11233) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* `VIEW` から読み取る際、内部クエリ内の定数によって発生する `Block structure mismatch in QueryPipeline` エラーを修正しました。 [#11181](https://github.com/ClickHouse/ClickHouse/issues/11181) の不具合を修正。 [#11205](https://github.com/ClickHouse/ClickHouse/pull/11205) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `Invalid status for associated output` という例外が発生する可能性のある問題を修正しました。 [#11200](https://github.com/ClickHouse/ClickHouse/pull/11200) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `Array(Array(LowCardinality))` をキャプチャ引数として取る高階関数で発生しうる `Cannot capture column` エラーを修正。 [#11185](https://github.com/ClickHouse/ClickHouse/pull/11185) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 1000 を超える `key` が存在する場合や一部のバックエンド環境で失敗する可能性があった S3 のグロブ処理を修正しました。 [#11179](https://github.com/ClickHouse/ClickHouse/pull/11179) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `data skipping index` がバックグラウンドマージ中に変更される列（`SummingMergeTree`、`AggregatingMergeTree`、および `TTL GROUP BY` の場合）に依存している場合、インデックスが正しく計算されていませんでした。この問題は、マージ後にインデックスを計算するように変更し、マージ後のデータに対してインデックスを計算することで修正されました。 [#11162](https://github.com/ClickHouse/ClickHouse/pull/11162) ([Azat Khuzhin](https://github.com/azat))。
* 常に適用されていた制限に基づく再スケジュールに起因する Kafka のパフォーマンス問題を修正しました。 [#11149](https://github.com/ClickHouse/ClickHouse/pull/11149) ([filimonov](https://github.com/filimonov))。
* `engine=Kafka` テーブルの `DROP` 実行時（またはサーバー再起動時）にまれに発生していたハングを修正。 [#11145](https://github.com/ClickHouse/ClickHouse/pull/11145) ([filimonov](https://github.com/filimonov)).
* 単純なクエリに対してスレッドを過剰に予約してしまう問題を修正しました（パイプラインの変更後に一部動作しなくなっていた、スレッド数削減のための最適化）。 [#11114](https://github.com/ClickHouse/ClickHouse/pull/11114) ([Azat Khuzhin](https://github.com/azat)).
* `HAVING` 句を含むクエリ（つまりイニシエータサーバー側でのフィルタリングが必要な場合）に対して、式の順序を保持することで（これだけで修正としては十分）、分散クエリの述語最適化（`enable_optimize_predicate_expression=1`）を修正し、さらにアグリゲータがインデックスではなくカラム名を使用するように強制しました。修正: [#10613](https://github.com/ClickHouse/ClickHouse/issues/10613), [#11413](https://github.com/ClickHouse/ClickHouse/issues/11413)。[#10621](https://github.com/ClickHouse/ClickHouse/pull/10621)（[Azat Khuzhin](https://github.com/azat)）。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-14}

- 複数の不安定な統合テストを修正。[#11355](https://github.com/ClickHouse/ClickHouse/pull/11355) ([alesapin](https://github.com/alesapin))。

### ClickHouse リリース v20.4.4.18-stable 2020-05-26 {#clickhouse-release-v204418-stable-2020-05-26}

v20.4.3.16-stable からの変更はありません。

### ClickHouse リリース v20.4.3.16-stable 2020-05-23 {#clickhouse-release-v204316-stable-2020-05-23}

#### バグ修正 {#bug-fix-31}


* 何もファイナライズされなかった場合に、mutation のファイナライズ処理タスクでのログ出力を削除しました。 [#11109](https://github.com/ClickHouse/ClickHouse/pull/11109) ([alesapin](https://github.com/alesapin)).
* registerDiskS3 のメモリリークを修正しました。 [#11074](https://github.com/ClickHouse/ClickHouse/pull/11074) ([Pavel Kovalenko](https://github.com/Jokser)).
* Kafka エンジンテーブルの終了時にデータが取りこぼされる可能性があった問題を修正しました。 [#11048](https://github.com/ClickHouse/ClickHouse/pull/11048) ([filimonov](https://github.com/filimonov)).
* `parseDateTime64BestEffort` の引数解決に関するバグを修正。 [#11038](https://github.com/ClickHouse/ClickHouse/pull/11038) ([Vasily Nemkov](https://github.com/Enmk)).
* テーブルの作成に失敗した場合に、`MergeTree` でごくまれに発生しうる use-after-free の潜在的なエラーを修正しました。 [#10986](https://github.com/ClickHouse/ClickHouse/pull/10986), [#10970](https://github.com/ClickHouse/ClickHouse/pull/10970) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Atomic データベースにおけるメタデータ（rename 用の相対パス）およびデータ（symlink 用の相対パス）の処理を修正しました。 [#10980](https://github.com/ClickHouse/ClickHouse/pull/10980) ([Azat Khuzhin](https://github.com/azat)).
* `Atomic` データベースエンジン使用時に、`ALTER` クエリと `DROP DATABASE` クエリを同時に実行するとサーバーがクラッシュする問題を修正しました。 [#10968](https://github.com/ClickHouse/ClickHouse/pull/10968) ([tavplubix](https://github.com/tavplubix)).
* `getRawData()` メソッドで誤っていた生データサイズの値を修正しました。 [#10964](https://github.com/ClickHouse/ClickHouse/pull/10964) ([Igr](https://github.com/ObjatieGroba)).
* 20.1 以前のバージョンとの間で発生していた二段階集約の非互換性を修正しました。この非互換性は、イニシエーターノードとリモートノードで異なるバージョンの ClickHouse を使用しており、`GROUP BY` の結果セットが大きく、単一の `String` フィールドによって集約が行われる場合に発生します。その結果、単一のキーに対してマージされていない複数の行が結果に含まれてしまう可能性がありました。 [#10952](https://github.com/ClickHouse/ClickHouse/pull/10952) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `DistributedBlockOutputStream` によって部分的に書き込まれたファイルが送信される問題を修正しました。 [#10940](https://github.com/ClickHouse/ClickHouse/pull/10940) ([Azat Khuzhin](https://github.com/azat)).
* `SELECT count(notNullIn(NULL, []))` で発生していたクラッシュを修正しました。 [#10920](https://github.com/ClickHouse/ClickHouse/pull/10920) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `Kafka` テーブルエンジンの `DROP` 実行中（またはサーバー再起動時）にまれに発生していたハングを修正しました。 [#10910](https://github.com/ClickHouse/ClickHouse/pull/10910) ([filimonov](https://github.com/filimonov)).
* `a TO b, c TO a` のように複数の `ALTER RENAME` を実行できない問題を修正しました。 [#10895](https://github.com/ClickHouse/ClickHouse/pull/10895) ([alesapin](https://github.com/alesapin)).
* 同じカラムに対して複数スレッドから集約関数の状態の結果を取得する際に発生し得たレースコンディションを修正しました。これは、`quantile*` 関数用の `AggregateFunction` の状態を保持する `Memory` エンジンのテーブルから読み取る際に、`finalizeAggregation` 関数を使用している場合にのみ発生し得ます。 [#10890](https://github.com/ClickHouse/ClickHouse/pull/10890) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* Distributed テーブルにおけるタプルの後方互換性を修正しました。 [#10889](https://github.com/ClickHouse/ClickHouse/pull/10889) ([Anton Popov](https://github.com/CurtizJ)).
* 存在しないキーに対して `StringHashTable` で発生していた `SIGSEGV` を修正しました。 [#10870](https://github.com/ClickHouse/ClickHouse/pull/10870) ([Azat Khuzhin](https://github.com/azat)).
* `Atomic` エンジンを使用するデータベースから `LiveView` テーブルが削除された後に `WATCH` がハングする問題を修正しました。 [#10859](https://github.com/ClickHouse/ClickHouse/pull/10859) ([tavplubix](https://github.com/tavplubix)).
* `ReplicatedMergeTree` において、`OPTIMIZE` クエリ中の一部の `ALTER` が、あるレプリカが非アクティブになった後もそのレプリカを待ち続けてハングする可能性があったバグを修正しました。 [#10849](https://github.com/ClickHouse/ClickHouse/pull/10849) ([tavplubix](https://github.com/tavplubix))。
* `CONSTRAINT` 式に含まれる列の名前が変更された場合に、制約が更新されるようになりました。 [#10844](https://github.com/ClickHouse/ClickHouse/issues/10844) を修正。 [#10847](https://github.com/ClickHouse/ClickHouse/pull/10847) ([alesapin](https://github.com/alesapin))。
* cache-dictionary で未初期化メモリを読み取ってしまう可能性がある問題を修正しました。 [#10834](https://github.com/ClickHouse/ClickHouse/pull/10834) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `Block::sortColumns()` の後に列の順序が固定されるよう修正しました。 [#10826](https://github.com/ClickHouse/ClickHouse/pull/10826) ([Azat Khuzhin](https://github.com/azat)).
* 識別子のクオートを行わないよう指定された場合の `ODBC` ブリッジの問題を修正しました。 [#7984](https://github.com/ClickHouse/ClickHouse/issues/7984) を修正。 [#10821](https://github.com/ClickHouse/ClickHouse/pull/10821)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `DateLUT` における `UBSan` および `MSan` のレポート内容を修正しました。 [#10798](https://github.com/ClickHouse/ClickHouse/pull/10798) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* キー条件での誤った型変換を修正しました。[#6287](https://github.com/ClickHouse/ClickHouse/issues/6287) を解決。[#10791](https://github.com/ClickHouse/ClickHouse/pull/10791)（[Andrew Onyshchuk](https://github.com/oandrew)）。
* `parallel_view_processing` の動作を修正しました。これにより、例外が発生した場合でも、すべての `MATERIALIZED VIEW` への挿入が例外なく完了するようになりました。 [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241) を修正。 [#10757](https://github.com/ClickHouse/ClickHouse/pull/10757)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `-State` と組み合わせた場合の `-OrNull` および `-OrDefault` コンビネータを修正しました。 [#10741](https://github.com/ClickHouse/ClickHouse/pull/10741) ([hcz](https://github.com/hczhcz)).
* `h3EdgeAngle` 関数で発生する可能性があったバッファオーバーフローを修正しました。 [#10711](https://github.com/ClickHouse/ClickHouse/pull/10711) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* テーブルに多数のパーツがある場合に同時実行される `ALTER` をブロックしてしまうバグを修正しました。 [#10659](https://github.com/ClickHouse/ClickHouse/pull/10659) ([alesapin](https://github.com/alesapin)).
* サーバーがテーブルの起動前にシャットダウンされた場合に `StorageBuffer` で発生していた `nullptr` 参照の逆参照を修正しました。 [#10641](https://github.com/ClickHouse/ClickHouse/pull/10641) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `LowCardinality` 使用時の `optimize_skip_unused_shards` の問題を修正しました。 [#10611](https://github.com/ClickHouse/ClickHouse/pull/10611) ([Azat Khuzhin](https://github.com/azat)).
* 同期ミューテーション用の条件変数の扱いを修正しました。場合によっては、その条件変数へのシグナルが失われてしまうことがありました。 [#10588](https://github.com/ClickHouse/ClickHouse/pull/10588) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `loadStoredObject()` が終了する前に `createDictionary()` が呼び出されると発生する可能性があったクラッシュを修正しました。 [#10587](https://github.com/ClickHouse/ClickHouse/pull/10587) ([Vitaly Baranov](https://github.com/vitlibar)).
* 列の型と異なる型のデフォルト式を持つ列 `ALIAS` に対する `SELECT` を修正しました。 [#10563](https://github.com/ClickHouse/ClickHouse/pull/10563) ([Azat Khuzhin](https://github.com/azat)).
* DateTime64 型と String 型の値同士の比較を実装しました。 [#10560](https://github.com/ClickHouse/ClickHouse/pull/10560) ([Vasily Nemkov](https://github.com/Enmk))。
* デフォルトで `GROUP BY` の sharding&#95;key 最適化を無効化し（`optimize_distributed_group_by_sharding_key` は導入されたものの、sharding&#95;key の解析がトリッキーであるため、デフォルトではオフになっていました。単純な例としては sharding key 内での `if` の使用があります）、`WITH ROLLUP/CUBE/TOTALS` に対する最適化を修正しました。 [#10516](https://github.com/ClickHouse/ClickHouse/pull/10516) ([Azat Khuzhin](https://github.com/azat))。
* [#10263](https://github.com/ClickHouse/ClickHouse/issues/10263) を修正しました。[#10486](https://github.com/ClickHouse/ClickHouse/pull/10486)（[Azat Khuzhin](https://github.com/azat)）。
* `max_rows_to_sort` 設定に関するテストを追加しました。 [#10268](https://github.com/ClickHouse/ClickHouse/pull/10268) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* Bloom filter インデックス作成の後方互換性を追加。 [#10551](https://github.com/ClickHouse/ClickHouse/issues/10551). [#10569](https://github.com/ClickHouse/ClickHouse/pull/10569) ([Winter Zhang](https://github.com/zhang2014)).

### ClickHouse リリース v20.4.2.9, 2020-05-12 {#clickhouse-release-v20429-2020-05-12}

#### 後方互換性のない変更 {#backward-incompatible-change-8}

- システムテーブル（例: system.query_log、system.trace_log、system.metric_log）は、10 MiB 未満のパートに対してコンパクトデータパート形式を使用します。コンパクトデータパート形式はバージョン 20.3 以降でサポートされています。バージョン 20.3 未満にダウングレードする場合は、`/var/lib/clickhouse/data/system/` 内のシステムログのテーブルデータを手動で削除する必要があります。
- FixedString を含む文字列比較で、比較対象の引数のサイズが異なる場合、小さい方の文字列が大きい方の長さまでパディングされているかのように比較を行います。これは、FixedString データ型が SQL の CHAR に対応すると想定した場合の SQL 互換性を目的としています。これにより [#9272](https://github.com/ClickHouse/ClickHouse/issues/9272) が解決されます。[#10363](https://github.com/ClickHouse/ClickHouse/pull/10363) ([alexey-milovidov](https://github.com/alexey-milovidov))
- SHOW CREATE TABLE を複数行表示にしました。これにより可読性が向上し、MySQL に近い形式になります。[#10049](https://github.com/ClickHouse/ClickHouse/pull/10049) ([Azat Khuzhin](https://github.com/azat))
- `pointInPolygon` 関数で使用される設定 `validate_polygons` を追加し、デフォルトで有効にしました。[#9857](https://github.com/ClickHouse/ClickHouse/pull/9857) ([alexey-milovidov](https://github.com/alexey-milovidov))


#### 新機能 {#new-feature-8}

- ClickHouseからZookeeperへのセキュア接続のサポートを追加 [#10184](https://github.com/ClickHouse/ClickHouse/pull/10184) ([Konstantin Lebedev](https://github.com/xzkostyan))
- カスタムHTTPハンドラーをサポート。詳細は[#5436](https://github.com/ClickHouse/ClickHouse/issues/5436)を参照してください。[#7572](https://github.com/ClickHouse/ClickHouse/pull/7572) ([Winter Zhang](https://github.com/zhang2014))
- MessagePack入出力フォーマットを追加。[#9889](https://github.com/ClickHouse/ClickHouse/pull/9889) ([Kruglov Pavel](https://github.com/Avogar))
- Regexp入力フォーマットを追加。[#9196](https://github.com/ClickHouse/ClickHouse/pull/9196) ([Kruglov Pavel](https://github.com/Avogar))
- Markdownドキュメントにテーブルを埋め込むための出力フォーマット`Markdown`を追加。[#10317](https://github.com/ClickHouse/ClickHouse/pull/10317) ([Kruglov Pavel](https://github.com/Avogar))
- ディクショナリにカスタム設定セクションのサポートを追加。また、issue [#2829](https://github.com/ClickHouse/ClickHouse/issues/2829)を修正。[#10137](https://github.com/ClickHouse/ClickHouse/pull/10137) ([Artem Streltsov](https://github.com/kekekekule))
- `CREATE DICTIONARY`のDDLクエリにカスタム設定のサポートを追加 [#10465](https://github.com/ClickHouse/ClickHouse/pull/10465) ([Artem Streltsov](https://github.com/kekekekule))
- サーバーのメモリ使用量が次の割り当てしきい値を超えた際に割り当てコンテキストを収集する、シンプルなサーバー全体のメモリプロファイラーを追加。[#10444](https://github.com/ClickHouse/ClickHouse/pull/10444) ([alexey-milovidov](https://github.com/alexey-milovidov))
- レプリカが自身でパートをマージすることを制限し、常に他のレプリカからのダウンロードを優先する設定`always_fetch_merged_part`を追加。[#10379](https://github.com/ClickHouse/ClickHouse/pull/10379) ([alesapin](https://github.com/alesapin))
- JSONオブジェクトから生データを抽出する関数`JSONExtractKeysAndValuesRaw`を追加 [#10378](https://github.com/ClickHouse/ClickHouse/pull/10378) ([hcz](https://github.com/hczhcz))
- OSからのメモリ使用量を`system.asynchronous_metrics`に追加。[#10361](https://github.com/ClickHouse/ClickHouse/pull/10361) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 関数`least`と`greatest`の汎用バリアントを追加。任意の型の任意の数の引数で動作するようになりました。これにより[#4767](https://github.com/ClickHouse/ClickHouse/issues/4767)を修正 [#10318](https://github.com/ClickHouse/ClickHouse/pull/10318) ([alexey-milovidov](https://github.com/alexey-milovidov))
- ClickHouseはディクショナリソースのタイムアウトを自身で制御するようになりました。キャッシュディクショナリ設定に2つの新しい設定が追加されました:`strict_max_lifetime_seconds`(デフォルトは`max_lifetime`)と`query_wait_timeout_milliseconds`(デフォルトは1分)。最初の設定は`allow_read_expired_keys`設定と併用すると便利です(非常に期限切れのキーの読み取りを禁止するため)。[#10337](https://github.com/ClickHouse/ClickHouse/pull/10337) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- query_logに書き込まれるエントリをフィルタリングするためのlog_queries_min_typeを追加 [#10053](https://github.com/ClickHouse/ClickHouse/pull/10053) ([Azat Khuzhin](https://github.com/azat))
- 関数`isConstant`を追加。この関数は引数が定数式かどうかをチェックし、1または0を返します。開発、デバッグ、デモンストレーション目的で使用されます。[#10198](https://github.com/ClickHouse/ClickHouse/pull/10198) ([alexey-milovidov](https://github.com/alexey-milovidov))
- キーが存在しない場合にデフォルト値を返す代わりにNULLを返すjoinGetOrNullを追加。[#10094](https://github.com/ClickHouse/ClickHouse/pull/10094) ([Amos Bird](https://github.com/amosbird))
- オプション`transform_null_in`が設定されている場合、`IN`演算子で`NULL`を`NULL`と等しいとみなします。[#10085](https://github.com/ClickHouse/ClickHouse/pull/10085) ([achimbab](https://github.com/achimbab))
- MergeTreeテーブルエンジンファミリーに`ALTER TABLE ... RENAME COLUMN`を追加。[#9948](https://github.com/ClickHouse/ClickHouse/pull/9948) ([alesapin](https://github.com/alesapin))
- 並列分散INSERT SELECTをサポート。[#9759](https://github.com/ClickHouse/ClickHouse/pull/9759) ([vxider](https://github.com/Vxider))
- Distributed over Distributedのクエリ機能を追加(`distributed_group_by_no_merge`なし)... [#9923](https://github.com/ClickHouse/ClickHouse/pull/9923) ([Azat Khuzhin](https://github.com/azat))
- 指定された範囲内の配列要素を集約する関数`arrayReduceInRanges`を追加。[#9598](https://github.com/ClickHouse/ClickHouse/pull/9598) ([hcz](https://github.com/hczhcz))
- Prometheusエクスポーターにディクショナリステータスを追加。[#9622](https://github.com/ClickHouse/ClickHouse/pull/9622) ([Guillaume Tassery](https://github.com/YiuRULE))
- 関数`arrayAUC`を追加 [#8698](https://github.com/ClickHouse/ClickHouse/pull/8698) ([taiyang-li](https://github.com/taiyang-li))
- TPC-H互換性向上のため`DROP VIEW`ステートメントをサポート。[#9831](https://github.com/ClickHouse/ClickHouse/pull/9831) ([Amos Bird](https://github.com/amosbird))
- windowFunnel()に'strict_order'オプションを追加 [#9773](https://github.com/ClickHouse/ClickHouse/pull/9773) ([achimbab](https://github.com/achimbab))
- `DATE`および`TIMESTAMP` SQL演算子をサポート、例:`SELECT date '2001-01-01'` [#9691](https://github.com/ClickHouse/ClickHouse/pull/9691) ([Artem Zuikov](https://github.com/4ertus2))

#### 実験的機能 {#experimental-feature-6}

- 実験的なデータベースエンジンAtomicを追加しました。ノンブロッキングの`DROP`および`RENAME TABLE`クエリと、アトミックな`EXCHANGE TABLES t1 AND t2`クエリをサポートします [#7512](https://github.com/ClickHouse/ClickHouse/pull/7512) ([tavplubix](https://github.com/tavplubix))
- S3上のReplicatedMergeTreeの初期サポートを追加しました(最適ではない方法で動作します) [#10126](https://github.com/ClickHouse/ClickHouse/pull/10126) ([Pavel Kovalenko](https://github.com/Jokser))


#### バグ修正 {#bug-fix-32}

- Fixed incorrect scalar results inside inner query of `MATERIALIZED VIEW` in case if this query contained dependent table [#10603](https://github.com/ClickHouse/ClickHouse/pull/10603) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed bug, which caused HTTP requests to get stuck on client closing connection when `readonly=2` and `cancel_http_readonly_queries_on_client_close=1`. [#10684](https://github.com/ClickHouse/ClickHouse/pull/10684) ([tavplubix](https://github.com/tavplubix))
- Fix segfault in StorageBuffer when exception is thrown on server startup. Fixes [#10550](https://github.com/ClickHouse/ClickHouse/issues/10550) [#10609](https://github.com/ClickHouse/ClickHouse/pull/10609) ([tavplubix](https://github.com/tavplubix))
- The query`SYSTEM DROP DNS CACHE` now also drops caches used to check if user is allowed to connect from some IP addresses [#10608](https://github.com/ClickHouse/ClickHouse/pull/10608) ([tavplubix](https://github.com/tavplubix))
- Fix usage of multiple `IN` operators with an identical set in one query. Fixes [#10539](https://github.com/ClickHouse/ClickHouse/issues/10539) [#10686](https://github.com/ClickHouse/ClickHouse/pull/10686) ([Anton Popov](https://github.com/CurtizJ))
- Fix crash in `generateRandom` with nested types. Fixes [#10583](https://github.com/ClickHouse/ClickHouse/issues/10583). [#10734](https://github.com/ClickHouse/ClickHouse/pull/10734) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix data corruption for `LowCardinality(FixedString)` key column in `SummingMergeTree` which could have happened after merge. Fixes [#10489](https://github.com/ClickHouse/ClickHouse/issues/10489). [#10721](https://github.com/ClickHouse/ClickHouse/pull/10721) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix logic for aggregation_memory_efficient_merge_threads setting. [#10667](https://github.com/ClickHouse/ClickHouse/pull/10667) ([palasonic1](https://github.com/palasonic1))
- Fix disappearing totals. Totals could have being filtered if query had `JOIN` or subquery with external `WHERE` condition. Fixes [#10674](https://github.com/ClickHouse/ClickHouse/issues/10674) [#10698](https://github.com/ClickHouse/ClickHouse/pull/10698) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix the lack of parallel execution of remote queries with `distributed_aggregation_memory_efficient` enabled. Fixes [#10655](https://github.com/ClickHouse/ClickHouse/issues/10655) [#10664](https://github.com/ClickHouse/ClickHouse/pull/10664) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix possible incorrect number of rows for queries with `LIMIT`. Fixes [#10566](https://github.com/ClickHouse/ClickHouse/issues/10566), [#10709](https://github.com/ClickHouse/ClickHouse/issues/10709) [#10660](https://github.com/ClickHouse/ClickHouse/pull/10660) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix index corruption, which may occur in some cases after merging compact parts into another compact part. [#10531](https://github.com/ClickHouse/ClickHouse/pull/10531) ([Anton Popov](https://github.com/CurtizJ))
- Fix the situation, when mutation finished all parts, but hung up in `is_done=0`. [#10526](https://github.com/ClickHouse/ClickHouse/pull/10526) ([alesapin](https://github.com/alesapin))
- Fix overflow at beginning of unix epoch for timezones with fractional offset from UTC. Fixes [#9335](https://github.com/ClickHouse/ClickHouse/issues/9335). [#10513](https://github.com/ClickHouse/ClickHouse/pull/10513) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Better diagnostics for input formats. Fixes [#10204](https://github.com/ClickHouse/ClickHouse/issues/10204) [#10418](https://github.com/ClickHouse/ClickHouse/pull/10418) ([tavplubix](https://github.com/tavplubix))
- Fix numeric overflow in `simpleLinearRegression()` over large integers [#10474](https://github.com/ClickHouse/ClickHouse/pull/10474) ([hcz](https://github.com/hczhcz))
- Fix use-after-free in Distributed shutdown, avoid waiting for sending all batches [#10491](https://github.com/ClickHouse/ClickHouse/pull/10491) ([Azat Khuzhin](https://github.com/azat))
- Add CA certificates to clickhouse-server docker image [#10476](https://github.com/ClickHouse/ClickHouse/pull/10476) ([filimonov](https://github.com/filimonov))
- Fix a rare endless loop that might have occurred when using the `addressToLine` function or AggregateFunctionState columns. [#10466](https://github.com/ClickHouse/ClickHouse/pull/10466) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Handle zookeeper "no node error" during distributed query [#10050](https://github.com/ClickHouse/ClickHouse/pull/10050) ([Daniel Chen](https://github.com/Phantomape))
- Fix bug when server cannot attach table after column's default was altered. [#10441](https://github.com/ClickHouse/ClickHouse/pull/10441) ([alesapin](https://github.com/alesapin))
- Implicitly cast the default expression type to the column type for the ALIAS columns [#10563](https://github.com/ClickHouse/ClickHouse/pull/10563) ([Azat Khuzhin](https://github.com/azat))
- Don't remove metadata directory if `ATTACH DATABASE` fails [#10442](https://github.com/ClickHouse/ClickHouse/pull/10442) ([Winter Zhang](https://github.com/zhang2014))
- Avoid dependency on system tzdata. Fixes loading of `Africa/Casablanca` timezone on CentOS 8. Fixes [#10211](https://github.com/ClickHouse/ClickHouse/issues/10211) [#10425](https://github.com/ClickHouse/ClickHouse/pull/10425) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix some issues if data is inserted with quorum and then gets deleted (DROP PARTITION, TTL, etc.). It led to stuck of INSERTs or false-positive exceptions in SELECTs. Fixes [#9946](https://github.com/ClickHouse/ClickHouse/issues/9946) [#10188](https://github.com/ClickHouse/ClickHouse/pull/10188) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Check the number and type of arguments when creating BloomFilter index [#9623](https://github.com/ClickHouse/ClickHouse/issues/9623) [#10431](https://github.com/ClickHouse/ClickHouse/pull/10431) ([Winter Zhang](https://github.com/zhang2014))
- Prefer `fallback_to_stale_replicas` over `skip_unavailable_shards`, otherwise when both settings specified and there are no up-to-date replicas the query will fail (patch from @alex-zaitsev ) [#10422](https://github.com/ClickHouse/ClickHouse/pull/10422) ([Azat Khuzhin](https://github.com/azat))
- Fix the issue when a query with ARRAY JOIN, ORDER BY and LIMIT may return incomplete result. Fixes [#10226](https://github.com/ClickHouse/ClickHouse/issues/10226). [#10427](https://github.com/ClickHouse/ClickHouse/pull/10427) ([Vadim Plakhtinskiy](https://github.com/VadimPlh))
- Add database name to dictionary name after DETACH/ATTACH. Fixes system.dictionaries table and `SYSTEM RELOAD` query [#10415](https://github.com/ClickHouse/ClickHouse/pull/10415) ([Azat Khuzhin](https://github.com/azat))
- Fix possible incorrect result for extremes in processors pipeline. [#10131](https://github.com/ClickHouse/ClickHouse/pull/10131) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix possible segfault when the setting `distributed_group_by_no_merge` is enabled (introduced in 20.3.7.46 by [#10131](https://github.com/ClickHouse/ClickHouse/issues/10131)). [#10399](https://github.com/ClickHouse/ClickHouse/pull/10399) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix wrong flattening of `Array(Tuple(...))` data types. Fixes [#10259](https://github.com/ClickHouse/ClickHouse/issues/10259) [#10390](https://github.com/ClickHouse/ClickHouse/pull/10390) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix column names of constants inside JOIN that may clash with names of constants outside of JOIN [#9950](https://github.com/ClickHouse/ClickHouse/pull/9950) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Fix order of columns after Block::sortColumns() [#10826](https://github.com/ClickHouse/ClickHouse/pull/10826) ([Azat Khuzhin](https://github.com/azat))
- Fix possible `Pipeline stuck` error in `ConcatProcessor` which may happen in remote query. [#10381](https://github.com/ClickHouse/ClickHouse/pull/10381) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Don't make disk reservations for aggregations. Fixes [#9241](https://github.com/ClickHouse/ClickHouse/issues/9241) [#10375](https://github.com/ClickHouse/ClickHouse/pull/10375) ([Azat Khuzhin](https://github.com/azat))
- Fix wrong behaviour of datetime functions for timezones that has altered between positive and negative offsets from UTC (e.g. Pacific/Kiritimati). Fixes [#7202](https://github.com/ClickHouse/ClickHouse/issues/7202) [#10369](https://github.com/ClickHouse/ClickHouse/pull/10369) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Avoid infinite loop in `dictIsIn` function. Fixes #515 [#10365](https://github.com/ClickHouse/ClickHouse/pull/10365) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Disable GROUP BY sharding_key optimization by default and fix it for WITH ROLLUP/CUBE/TOTALS [#10516](https://github.com/ClickHouse/ClickHouse/pull/10516) ([Azat Khuzhin](https://github.com/azat))
- Check for error code when checking parts and don't mark part as broken if the error is like "not enough memory". Fixes [#6269](https://github.com/ClickHouse/ClickHouse/issues/6269) [#10364](https://github.com/ClickHouse/ClickHouse/pull/10364) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Show information about not loaded dictionaries in system tables. [#10234](https://github.com/ClickHouse/ClickHouse/pull/10234) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix nullptr dereference in StorageBuffer if server was shutdown before table startup. [#10641](https://github.com/ClickHouse/ClickHouse/pull/10641) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed `DROP` vs `OPTIMIZE` race in `ReplicatedMergeTree`. `DROP` could left some garbage in replica path in ZooKeeper if there was concurrent `OPTIMIZE` query. [#10312](https://github.com/ClickHouse/ClickHouse/pull/10312) ([tavplubix](https://github.com/tavplubix))
- Fix 'Logical error: CROSS JOIN has expressions' error for queries with comma and names joins mix. Fixes [#9910](https://github.com/ClickHouse/ClickHouse/issues/9910) [#10311](https://github.com/ClickHouse/ClickHouse/pull/10311) ([Artem Zuikov](https://github.com/4ertus2))
- Fix queries with `max_bytes_before_external_group_by`. [#10302](https://github.com/ClickHouse/ClickHouse/pull/10302) ([Artem Zuikov](https://github.com/4ertus2))
- Fix the issue with limiting maximum recursion depth in parser in certain cases. This fixes [#10283](https://github.com/ClickHouse/ClickHouse/issues/10283) This fix may introduce minor incompatibility: long and deep queries via clickhouse-client may refuse to work, and you should adjust settings `max_query_size` and `max_parser_depth` accordingly. [#10295](https://github.com/ClickHouse/ClickHouse/pull/10295) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Allow to use `count(*)` with multiple JOINs. Fixes [#9853](https://github.com/ClickHouse/ClickHouse/issues/9853) [#10291](https://github.com/ClickHouse/ClickHouse/pull/10291) ([Artem Zuikov](https://github.com/4ertus2))
- Fix error `Pipeline stuck` with `max_rows_to_group_by` and `group_by_overflow_mode = 'break'`. [#10279](https://github.com/ClickHouse/ClickHouse/pull/10279) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix 'Cannot add column' error while creating `range_hashed` dictionary using DDL query. Fixes [#10093](https://github.com/ClickHouse/ClickHouse/issues/10093). [#10235](https://github.com/ClickHouse/ClickHouse/pull/10235) ([alesapin](https://github.com/alesapin))
- Fix rare possible exception `Cannot drain connections: cancel first`. [#10239](https://github.com/ClickHouse/ClickHouse/pull/10239) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed bug where ClickHouse would throw "Unknown function lambda." error message when user tries to run ALTER UPDATE/DELETE on tables with ENGINE = Replicated\*. Check for nondeterministic functions now handles lambda expressions correctly. [#10237](https://github.com/ClickHouse/ClickHouse/pull/10237) ([Alexander Kazakov](https://github.com/Akazz))
- Fixed reasonably rare segfault in StorageSystemTables that happens when SELECT ... FROM system.tables is run on a database with Lazy engine. [#10209](https://github.com/ClickHouse/ClickHouse/pull/10209) ([Alexander Kazakov](https://github.com/Akazz))
- Fix possible infinite query execution when the query actually should stop on LIMIT, while reading from infinite source like `system.numbers` or `system.zeros`. [#10206](https://github.com/ClickHouse/ClickHouse/pull/10206) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed "generateRandom" function for Date type. This fixes [#9973](https://github.com/ClickHouse/ClickHouse/issues/9973). Fix an edge case when dates with year 2106 are inserted to MergeTree tables with old-style partitioning but partitions are named with year 1970. [#10218](https://github.com/ClickHouse/ClickHouse/pull/10218) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Convert types if the table definition of a View does not correspond to the SELECT query. This fixes [#10180](https://github.com/ClickHouse/ClickHouse/issues/10180) and [#10022](https://github.com/ClickHouse/ClickHouse/issues/10022) [#10217](https://github.com/ClickHouse/ClickHouse/pull/10217) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix `parseDateTimeBestEffort` for strings in RFC-2822 when day of week is Tuesday or Thursday. This fixes [#10082](https://github.com/ClickHouse/ClickHouse/issues/10082) [#10214](https://github.com/ClickHouse/ClickHouse/pull/10214) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix column names of constants inside JOIN that may clash with names of constants outside of JOIN. [#10207](https://github.com/ClickHouse/ClickHouse/pull/10207) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix move-to-prewhere optimization in presense of arrayJoin functions (in certain cases). This fixes [#10092](https://github.com/ClickHouse/ClickHouse/issues/10092) [#10195](https://github.com/ClickHouse/ClickHouse/pull/10195) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix issue with separator appearing in SCRAMBLE for native mysql-connector-java (JDBC) [#10140](https://github.com/ClickHouse/ClickHouse/pull/10140) ([BohuTANG](https://github.com/BohuTANG))
- Fix using the current database for an access checking when the database isn't specified. [#10192](https://github.com/ClickHouse/ClickHouse/pull/10192) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix ALTER of tables with compact parts. [#10130](https://github.com/ClickHouse/ClickHouse/pull/10130) ([Anton Popov](https://github.com/CurtizJ))
- Add the ability to relax the restriction on non-deterministic functions usage in mutations with `allow_nondeterministic_mutations` setting. [#10186](https://github.com/ClickHouse/ClickHouse/pull/10186) ([filimonov](https://github.com/filimonov))
- Fix `DROP TABLE` invoked for dictionary [#10165](https://github.com/ClickHouse/ClickHouse/pull/10165) ([Azat Khuzhin](https://github.com/azat))
- Convert blocks if structure does not match when doing `INSERT` into Distributed table [#10135](https://github.com/ClickHouse/ClickHouse/pull/10135) ([Azat Khuzhin](https://github.com/azat))
- The number of rows was logged incorrectly (as sum across all parts) when inserted block is split by parts with partition key. [#10138](https://github.com/ClickHouse/ClickHouse/pull/10138) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add some arguments check and support identifier arguments for MySQL Database Engine [#10077](https://github.com/ClickHouse/ClickHouse/pull/10077) ([Winter Zhang](https://github.com/zhang2014))
- Fix incorrect `index_granularity_bytes` check while creating new replica. Fixes [#10098](https://github.com/ClickHouse/ClickHouse/issues/10098). [#10121](https://github.com/ClickHouse/ClickHouse/pull/10121) ([alesapin](https://github.com/alesapin))
- Fix bug in `CHECK TABLE` query when table contain skip indices. [#10068](https://github.com/ClickHouse/ClickHouse/pull/10068) ([alesapin](https://github.com/alesapin))
- Fix Distributed-over-Distributed with the only one shard in a nested table [#9997](https://github.com/ClickHouse/ClickHouse/pull/9997) ([Azat Khuzhin](https://github.com/azat))
- Fix possible rows loss for queries with `JOIN` and `UNION ALL`. Fixes [#9826](https://github.com/ClickHouse/ClickHouse/issues/9826), [#10113](https://github.com/ClickHouse/ClickHouse/issues/10113). ... [#10099](https://github.com/ClickHouse/ClickHouse/pull/10099) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix bug in dictionary when local clickhouse server is used as source. It may caused memory corruption if types in dictionary and source are not compatible. [#10071](https://github.com/ClickHouse/ClickHouse/pull/10071) ([alesapin](https://github.com/alesapin))
- Fixed replicated tables startup when updating from an old ClickHouse version where `/table/replicas/replica_name/metadata` node does not exist. Fixes [#10037](https://github.com/ClickHouse/ClickHouse/issues/10037). [#10095](https://github.com/ClickHouse/ClickHouse/pull/10095) ([alesapin](https://github.com/alesapin))
- Fix error `Cannot clone block with columns because block has 0 columns ... While executing GroupingAggregatedTransform`. It happened when setting `distributed_aggregation_memory_efficient` was enabled, and distributed query read aggregating data with mixed single and two-level aggregation from different shards. [#10063](https://github.com/ClickHouse/ClickHouse/pull/10063) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix deadlock when database with materialized view failed attach at start [#10054](https://github.com/ClickHouse/ClickHouse/pull/10054) ([Azat Khuzhin](https://github.com/azat))
- Fix a segmentation fault that could occur in GROUP BY over string keys containing trailing zero bytes ([#8636](https://github.com/ClickHouse/ClickHouse/issues/8636), [#8925](https://github.com/ClickHouse/ClickHouse/issues/8925)). ... [#10025](https://github.com/ClickHouse/ClickHouse/pull/10025) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Fix wrong results of distributed queries when alias could override qualified column name. Fixes [#9672](https://github.com/ClickHouse/ClickHouse/issues/9672) [#9714](https://github.com/ClickHouse/ClickHouse/issues/9714) [#9972](https://github.com/ClickHouse/ClickHouse/pull/9972) ([Artem Zuikov](https://github.com/4ertus2))
- Fix possible deadlock in `SYSTEM RESTART REPLICAS` [#9955](https://github.com/ClickHouse/ClickHouse/pull/9955) ([tavplubix](https://github.com/tavplubix))
- Fix the number of threads used for remote query execution (performance regression, since 20.3). This happened when query from `Distributed` table was executed simultaneously on local and remote shards. Fixes [#9965](https://github.com/ClickHouse/ClickHouse/issues/9965) [#9971](https://github.com/ClickHouse/ClickHouse/pull/9971) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed `DeleteOnDestroy` logic in `ATTACH PART` which could lead to automatic removal of attached part and added few tests [#9410](https://github.com/ClickHouse/ClickHouse/pull/9410) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix a bug with `ON CLUSTER` DDL queries freezing on server startup. [#9927](https://github.com/ClickHouse/ClickHouse/pull/9927) ([Gagan Arneja](https://github.com/garneja))
- Fix bug in which the necessary tables weren't retrieved at one of the processing stages of queries to some databases. Fixes [#9699](https://github.com/ClickHouse/ClickHouse/issues/9699). [#9949](https://github.com/ClickHouse/ClickHouse/pull/9949) ([achulkov2](https://github.com/achulkov2))
- Fix 'Not found column in block' error when `JOIN` appears with `TOTALS`. Fixes [#9839](https://github.com/ClickHouse/ClickHouse/issues/9839) [#9939](https://github.com/ClickHouse/ClickHouse/pull/9939) ([Artem Zuikov](https://github.com/4ertus2))
- Fix parsing multiple hosts set in the CREATE USER command [#9924](https://github.com/ClickHouse/ClickHouse/pull/9924) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix `TRUNCATE` for Join table engine ([#9917](https://github.com/ClickHouse/ClickHouse/issues/9917)). [#9920](https://github.com/ClickHouse/ClickHouse/pull/9920) ([Amos Bird](https://github.com/amosbird))
- Fix race condition between drop and optimize in `ReplicatedMergeTree`. [#9901](https://github.com/ClickHouse/ClickHouse/pull/9901) ([alesapin](https://github.com/alesapin))
- Fix `DISTINCT` for Distributed when `optimize_skip_unused_shards` is set. [#9808](https://github.com/ClickHouse/ClickHouse/pull/9808) ([Azat Khuzhin](https://github.com/azat))
- Fix "scalar does not exist" error in ALTERs ([#9878](https://github.com/ClickHouse/ClickHouse/issues/9878)). ... [#9904](https://github.com/ClickHouse/ClickHouse/pull/9904) ([Amos Bird](https://github.com/amosbird))
- Fix error with qualified names in `distributed_product_mode=\'local\'`. Fixes [#4756](https://github.com/ClickHouse/ClickHouse/issues/4756) [#9891](https://github.com/ClickHouse/ClickHouse/pull/9891) ([Artem Zuikov](https://github.com/4ertus2))
- For INSERT queries shards now do clamp the settings from the initiator to their constraints instead of throwing an exception. This fix allows to send INSERT queries to a shard with another constraints. This change improves fix [#9447](https://github.com/ClickHouse/ClickHouse/issues/9447). [#9852](https://github.com/ClickHouse/ClickHouse/pull/9852) ([Vitaly Baranov](https://github.com/vitlibar))
- Add some retries when commiting offsets to Kafka broker, since it can reject commit if during `offsets.commit.timeout.ms` there were no enough replicas available for the `__consumer_offsets` topic [#9884](https://github.com/ClickHouse/ClickHouse/pull/9884) ([filimonov](https://github.com/filimonov))
- Fix Distributed engine behavior when virtual columns of the underlying table used in `WHERE` [#9847](https://github.com/ClickHouse/ClickHouse/pull/9847) ([Azat Khuzhin](https://github.com/azat))
- Fixed some cases when timezone of the function argument wasn't used properly. [#9574](https://github.com/ClickHouse/ClickHouse/pull/9574) ([Vasily Nemkov](https://github.com/Enmk))
- Fix 'Different expressions with the same alias' error when query has PREWHERE and WHERE on distributed table and `SET distributed_product_mode = 'local'`. [#9871](https://github.com/ClickHouse/ClickHouse/pull/9871) ([Artem Zuikov](https://github.com/4ertus2))
- Fix mutations excessive memory consumption for tables with a composite primary key. This fixes [#9850](https://github.com/ClickHouse/ClickHouse/issues/9850). [#9860](https://github.com/ClickHouse/ClickHouse/pull/9860) ([alesapin](https://github.com/alesapin))
- Fix calculating grants for introspection functions from the setting `allow_introspection_functions`. [#9840](https://github.com/ClickHouse/ClickHouse/pull/9840) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix max_distributed_connections (w/ and w/o Processors) [#9673](https://github.com/ClickHouse/ClickHouse/pull/9673) ([Azat Khuzhin](https://github.com/azat))
- Fix possible exception `Got 0 in totals chunk, expected 1` on client. It happened for queries with `JOIN` in case if right joined table had zero rows. Example: `select * from system.one t1 join system.one t2 on t1.dummy = t2.dummy limit 0 FORMAT TabSeparated;`. Fixes [#9777](https://github.com/ClickHouse/ClickHouse/issues/9777). ... [#9823](https://github.com/ClickHouse/ClickHouse/pull/9823) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix 'COMMA to CROSS JOIN rewriter is not enabled or cannot rewrite query' error in case of subqueries with COMMA JOIN out of tables lists (i.e. in WHERE). Fixes [#9782](https://github.com/ClickHouse/ClickHouse/issues/9782) [#9830](https://github.com/ClickHouse/ClickHouse/pull/9830) ([Artem Zuikov](https://github.com/4ertus2))
- Fix server crashing when `optimize_skip_unused_shards` is set and expression for key can't be converted to its field type [#9804](https://github.com/ClickHouse/ClickHouse/pull/9804) ([Azat Khuzhin](https://github.com/azat))
- Fix empty string handling in `splitByString`. [#9767](https://github.com/ClickHouse/ClickHouse/pull/9767) ([hcz](https://github.com/hczhcz))
- Fix broken `ALTER TABLE DELETE COLUMN` query for compact parts. [#9779](https://github.com/ClickHouse/ClickHouse/pull/9779) ([alesapin](https://github.com/alesapin))
- Fixed missing `rows_before_limit_at_least` for queries over http (with processors pipeline). Fixes [#9730](https://github.com/ClickHouse/ClickHouse/issues/9730) [#9757](https://github.com/ClickHouse/ClickHouse/pull/9757) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix excessive memory consumption in `ALTER` queries (mutations). This fixes [#9533](https://github.com/ClickHouse/ClickHouse/issues/9533) and [#9670](https://github.com/ClickHouse/ClickHouse/issues/9670). [#9754](https://github.com/ClickHouse/ClickHouse/pull/9754) ([alesapin](https://github.com/alesapin))
- Fix possible permanent "Cannot schedule a task" error. [#9154](https://github.com/ClickHouse/ClickHouse/pull/9154) ([Azat Khuzhin](https://github.com/azat))
- Fix bug in backquoting in external dictionaries DDL. Fixes [#9619](https://github.com/ClickHouse/ClickHouse/issues/9619). [#9734](https://github.com/ClickHouse/ClickHouse/pull/9734) ([alesapin](https://github.com/alesapin))
- Fixed data race in `text_log`. It does not correspond to any real bug. [#9726](https://github.com/ClickHouse/ClickHouse/pull/9726) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix bug in a replication that does not allow replication to work if the user has executed mutations on the previous version. This fixes [#9645](https://github.com/ClickHouse/ClickHouse/issues/9645). [#9652](https://github.com/ClickHouse/ClickHouse/pull/9652) ([alesapin](https://github.com/alesapin))
- Fixed incorrect internal function names for `sumKahan` and `sumWithOverflow`. It led to exception while using this functions in remote queries. [#9636](https://github.com/ClickHouse/ClickHouse/pull/9636) ([Azat Khuzhin](https://github.com/azat))
- Add setting `use_compact_format_in_distributed_parts_names` which allows to write files for `INSERT` queries into `Distributed` table with more compact format. This fixes [#9647](https://github.com/ClickHouse/ClickHouse/issues/9647). [#9653](https://github.com/ClickHouse/ClickHouse/pull/9653) ([alesapin](https://github.com/alesapin))
- Fix RIGHT and FULL JOIN with LowCardinality in JOIN keys. [#9610](https://github.com/ClickHouse/ClickHouse/pull/9610) ([Artem Zuikov](https://github.com/4ertus2))
- Fix possible exceptions `Size of filter does not match size of column` and `Invalid number of rows in Chunk` in `MergeTreeRangeReader`. They could appear while executing `PREWHERE` in some cases. [#9612](https://github.com/ClickHouse/ClickHouse/pull/9612) ([Anton Popov](https://github.com/CurtizJ))
- Allow `ALTER ON CLUSTER` of Distributed tables with internal replication. This fixes [#3268](https://github.com/ClickHouse/ClickHouse/issues/3268) [#9617](https://github.com/ClickHouse/ClickHouse/pull/9617) ([shinoi2](https://github.com/shinoi2))
- Fix issue when timezone was not preserved if you write a simple arithmetic expression like `time + 1` (in contrast to an expression like `time + INTERVAL 1 SECOND`). This fixes [#5743](https://github.com/ClickHouse/ClickHouse/issues/5743) [#9323](https://github.com/ClickHouse/ClickHouse/pull/9323) ([alexey-milovidov](https://github.com/alexey-milovidov))





#### 改善 {#improvement-16}

- Use time zone when comparing DateTime with string literal. This fixes [#5206](https://github.com/ClickHouse/ClickHouse/issues/5206). [#10515](https://github.com/ClickHouse/ClickHouse/pull/10515) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Print verbose diagnostic info if Decimal value cannot be parsed from text input format. [#10205](https://github.com/ClickHouse/ClickHouse/pull/10205) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add tasks/memory metrics for distributed/buffer schedule pools [#10449](https://github.com/ClickHouse/ClickHouse/pull/10449) ([Azat Khuzhin](https://github.com/azat))
- Display result as soon as it's ready for SELECT DISTINCT queries in clickhouse-local and HTTP interface. This fixes [#8951](https://github.com/ClickHouse/ClickHouse/issues/8951) [#9559](https://github.com/ClickHouse/ClickHouse/pull/9559) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Allow to use `SAMPLE OFFSET` query instead of `cityHash64(PRIMARY KEY) % N == n` for splitting in `clickhouse-copier`. To use this feature, pass `--experimental-use-sample-offset 1` as a command line argument. [#10414](https://github.com/ClickHouse/ClickHouse/pull/10414) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Allow to parse BOM in TSV if the first column cannot contain BOM in its value. This fixes [#10301](https://github.com/ClickHouse/ClickHouse/issues/10301) [#10424](https://github.com/ClickHouse/ClickHouse/pull/10424) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add Avro nested fields insert support [#10354](https://github.com/ClickHouse/ClickHouse/pull/10354) ([Andrew Onyshchuk](https://github.com/oandrew))
- Allowed to alter column in non-modifying data mode when the same type is specified. [#10382](https://github.com/ClickHouse/ClickHouse/pull/10382) ([Vladimir Chebotarev](https://github.com/excitoon))
- Auto `distributed_group_by_no_merge` on GROUP BY sharding key (if `optimize_skip_unused_shards` is set) [#10341](https://github.com/ClickHouse/ClickHouse/pull/10341) ([Azat Khuzhin](https://github.com/azat))
- Optimize queries with LIMIT/LIMIT BY/ORDER BY for distributed with GROUP BY sharding_key [#10373](https://github.com/ClickHouse/ClickHouse/pull/10373) ([Azat Khuzhin](https://github.com/azat))
- Added a setting `max_server_memory_usage` to limit total memory usage of the server. The metric `MemoryTracking` is now calculated without a drift. The setting `max_memory_usage_for_all_queries` is now obsolete and does nothing. This closes [#10293](https://github.com/ClickHouse/ClickHouse/issues/10293). [#10362](https://github.com/ClickHouse/ClickHouse/pull/10362) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add config option `system_tables_lazy_load`. If it's set to false, then system tables with logs are loaded at the server startup. [Alexander Burmak](https://github.com/Alex-Burmak), [Svyatoslav Tkhon Il Pak](https://github.com/DeifyTheGod), [#9642](https://github.com/ClickHouse/ClickHouse/pull/9642) [#10359](https://github.com/ClickHouse/ClickHouse/pull/10359) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Use background thread pool (background_schedule_pool_size) for distributed sends [#10263](https://github.com/ClickHouse/ClickHouse/pull/10263) ([Azat Khuzhin](https://github.com/azat))
- Use background thread pool for background buffer flushes. [#10315](https://github.com/ClickHouse/ClickHouse/pull/10315) ([Azat Khuzhin](https://github.com/azat))
- Support for one special case of removing incompletely written parts. This fixes [#9940](https://github.com/ClickHouse/ClickHouse/issues/9940). [#10221](https://github.com/ClickHouse/ClickHouse/pull/10221) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Use isInjective() over manual list of such functions for GROUP BY optimization. [#10342](https://github.com/ClickHouse/ClickHouse/pull/10342) ([Azat Khuzhin](https://github.com/azat))
- Avoid printing error message in log if client sends RST packet immediately on connect. It is typical behaviour of IPVS balancer with keepalived and VRRP. This fixes [#1851](https://github.com/ClickHouse/ClickHouse/issues/1851) [#10274](https://github.com/ClickHouse/ClickHouse/pull/10274) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Allow to parse `+inf` for floating point types. This closes [#1839](https://github.com/ClickHouse/ClickHouse/issues/1839) [#10272](https://github.com/ClickHouse/ClickHouse/pull/10272) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Implemented `generateRandom` table function for Nested types. This closes [#9903](https://github.com/ClickHouse/ClickHouse/issues/9903) [#10219](https://github.com/ClickHouse/ClickHouse/pull/10219) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Provide `max_allowed_packed` in MySQL compatibility interface that will help some clients to communicate with ClickHouse via MySQL protocol. [#10199](https://github.com/ClickHouse/ClickHouse/pull/10199) ([BohuTANG](https://github.com/BohuTANG))
- Allow literals for GLOBAL IN (i.e. `SELECT * FROM remote('localhost', system.one) WHERE dummy global in (0)`) [#10196](https://github.com/ClickHouse/ClickHouse/pull/10196) ([Azat Khuzhin](https://github.com/azat))
- Fix various small issues in interactive mode of clickhouse-client [#10194](https://github.com/ClickHouse/ClickHouse/pull/10194) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Avoid superfluous dictionaries load (system.tables, DROP/SHOW CREATE TABLE) [#10164](https://github.com/ClickHouse/ClickHouse/pull/10164) ([Azat Khuzhin](https://github.com/azat))
- Update to RWLock: timeout parameter for getLock() + implementation reworked to be phase fair [#10073](https://github.com/ClickHouse/ClickHouse/pull/10073) ([Alexander Kazakov](https://github.com/Akazz))
- Enhanced compatibility with native mysql-connector-java(JDBC) [#10021](https://github.com/ClickHouse/ClickHouse/pull/10021) ([BohuTANG](https://github.com/BohuTANG))
- The function `toString` is considered monotonic and can be used for index analysis even when applied in tautological cases with String or LowCardinality(String) argument. [#10110](https://github.com/ClickHouse/ClickHouse/pull/10110) ([Amos Bird](https://github.com/amosbird))
- Add `ON CLUSTER` clause support to commands `{CREATE|DROP} USER/ROLE/ROW POLICY/SETTINGS PROFILE/QUOTA`, `GRANT`. [#9811](https://github.com/ClickHouse/ClickHouse/pull/9811) ([Vitaly Baranov](https://github.com/vitlibar))
- Virtual hosted-style support for S3 URI [#9998](https://github.com/ClickHouse/ClickHouse/pull/9998) ([Pavel Kovalenko](https://github.com/Jokser))
- Now layout type for dictionaries with no arguments can be specified without round brackets in dictionaries DDL-queries. Fixes [#10057](https://github.com/ClickHouse/ClickHouse/issues/10057). [#10064](https://github.com/ClickHouse/ClickHouse/pull/10064) ([alesapin](https://github.com/alesapin))
- Add ability to use number ranges with leading zeros in filepath [#9989](https://github.com/ClickHouse/ClickHouse/pull/9989) ([Olga Khvostikova](https://github.com/stavrolia))
- Better memory usage in CROSS JOIN. [#10029](https://github.com/ClickHouse/ClickHouse/pull/10029) ([Artem Zuikov](https://github.com/4ertus2))
- Try to connect to all shards in cluster when getting structure of remote table and skip_unavailable_shards is set. [#7278](https://github.com/ClickHouse/ClickHouse/pull/7278) ([nvartolomei](https://github.com/nvartolomei))
- Add `total_rows`/`total_bytes` into the `system.tables` table. [#9919](https://github.com/ClickHouse/ClickHouse/pull/9919) ([Azat Khuzhin](https://github.com/azat))
- System log tables now use polymorpic parts by default. [#9905](https://github.com/ClickHouse/ClickHouse/pull/9905) ([Anton Popov](https://github.com/CurtizJ))
- Add type column into system.settings/merge_tree_settings [#9909](https://github.com/ClickHouse/ClickHouse/pull/9909) ([Azat Khuzhin](https://github.com/azat))
- Check for available CPU instructions at server startup as early as possible. [#9888](https://github.com/ClickHouse/ClickHouse/pull/9888) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Remove `ORDER BY` stage from mutations because we read from a single ordered part in a single thread. Also add check that the rows in mutation are ordered by sorting key and this order is not violated. [#9886](https://github.com/ClickHouse/ClickHouse/pull/9886) ([alesapin](https://github.com/alesapin))
- Implement operator LIKE for FixedString at left hand side. This is needed to better support TPC-DS queries. [#9890](https://github.com/ClickHouse/ClickHouse/pull/9890) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add `force_optimize_skip_unused_shards_no_nested` that will disable `force_optimize_skip_unused_shards` for nested Distributed table [#9812](https://github.com/ClickHouse/ClickHouse/pull/9812) ([Azat Khuzhin](https://github.com/azat))
- Now columns size is calculated only once for MergeTree data parts. [#9827](https://github.com/ClickHouse/ClickHouse/pull/9827) ([alesapin](https://github.com/alesapin))
- Evaluate constant expressions for `optimize_skip_unused_shards` (i.e. `SELECT * FROM foo_dist WHERE key=xxHash32(0)`) [#8846](https://github.com/ClickHouse/ClickHouse/pull/8846) ([Azat Khuzhin](https://github.com/azat))
- Check for using `Date` or `DateTime` column from TTL expressions was removed. [#9967](https://github.com/ClickHouse/ClickHouse/pull/9967) ([Vladimir Chebotarev](https://github.com/excitoon))
- DiskS3 hard links optimal implementation. [#9760](https://github.com/ClickHouse/ClickHouse/pull/9760) ([Pavel Kovalenko](https://github.com/Jokser))
- If `set multiple_joins_rewriter_version = 2` enables second version of multiple JOIN rewrites that keeps not clashed column names as is. It supports multiple JOINs with `USING` and allow `select *` for JOINs with subqueries. [#9739](https://github.com/ClickHouse/ClickHouse/pull/9739) ([Artem Zuikov](https://github.com/4ertus2))
- Implementation of "non-blocking" alter for StorageMergeTree [#9606](https://github.com/ClickHouse/ClickHouse/pull/9606) ([alesapin](https://github.com/alesapin))
- Add MergeTree full support for DiskS3 [#9646](https://github.com/ClickHouse/ClickHouse/pull/9646) ([Pavel Kovalenko](https://github.com/Jokser))
- Extend `splitByString` to support empty strings as separators. [#9742](https://github.com/ClickHouse/ClickHouse/pull/9742) ([hcz](https://github.com/hczhcz))
- Add a `timestamp_ns` column to `system.trace_log`. It contains a high-definition timestamp of the trace event, and allows to build timelines of thread profiles ("flame charts"). [#9696](https://github.com/ClickHouse/ClickHouse/pull/9696) ([Alexander Kuzmenkov](https://github.com/akuzm))
- When the setting `send_logs_level` is enabled, avoid intermixing of log messages and query progress. [#9634](https://github.com/ClickHouse/ClickHouse/pull/9634) ([Azat Khuzhin](https://github.com/azat))
- Added support of `MATERIALIZE TTL IN PARTITION`. [#9581](https://github.com/ClickHouse/ClickHouse/pull/9581) ([Vladimir Chebotarev](https://github.com/excitoon))
- Support complex types inside Avro nested fields [#10502](https://github.com/ClickHouse/ClickHouse/pull/10502) ([Andrew Onyshchuk](https://github.com/oandrew))

#### パフォーマンス改善 {#performance-improvement-11}

- Partial MergeJoinの右テーブルに対する挿入ロジックを改善しました。[#10467](https://github.com/ClickHouse/ClickHouse/pull/10467) ([Artem Zuikov](https://github.com/4ertus2))
- 行指向フォーマットのパフォーマンスを改善しました(狭いテーブルの場合、CSVで10%以上、Avroで35%以上)。[#10503](https://github.com/ClickHouse/ClickHouse/pull/10503) ([Andrew Onyshchuk](https://github.com/oandrew))
- IN演算子の右側に明示的に定義されたセットがあり、左側にタプルがあるクエリのパフォーマンスを改善しました。[#10385](https://github.com/ClickHouse/ClickHouse/pull/10385) ([Anton Popov](https://github.com/CurtizJ))
- HashJoinのハッシュテーブルで使用するメモリを削減しました。[#10416](https://github.com/ClickHouse/ClickHouse/pull/10416) ([Artem Zuikov](https://github.com/4ertus2))
- StorageDictionary上での特殊なHashJoinを実装しました。`dictGet()`関数をJOINで書き換えることができます。これ自体は後方互換性がありますが、一部のインストールで[#8400](https://github.com/ClickHouse/ClickHouse/issues/8400)が明らかになる可能性があります。[#10133](https://github.com/ClickHouse/ClickHouse/pull/10133) ([Artem Zuikov](https://github.com/4ertus2))
- ターゲットテーブルがサポートしている場合、マテリアライズドビューの並列挿入を有効にしました。[#10052](https://github.com/ClickHouse/ClickHouse/pull/10052) ([vxider](https://github.com/Vxider))
- 単調関数を使用したインデックス解析のパフォーマンスを改善しました。[#9607](https://github.com/ClickHouse/ClickHouse/pull/9607)[#10026](https://github.com/ClickHouse/ClickHouse/pull/10026) ([Anton Popov](https://github.com/CurtizJ))
- SSE2またはSSE4.2 SIMD命令を使用してブルームフィルタのトークン化を高速化しました。[#9968](https://github.com/ClickHouse/ClickHouse/pull/9968) ([Vasily Nemkov](https://github.com/Enmk))
- `IN`演算子の右側に明示的に定義されたセットを持つクエリのパフォーマンスを改善しました。これによりバージョン20.3でのパフォーマンス低下が修正されます。[#9740](https://github.com/ClickHouse/ClickHouse/pull/9740) ([Anton Popov](https://github.com/CurtizJ))
- clickhouse-copierが各パーティションを複数の部分に分割し、それらを独立してコピーするようになりました。[#9075](https://github.com/ClickHouse/ClickHouse/pull/9075) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- より多くの集約メソッドを追加しました。例えば、TPC-Hクエリ1は`FixedHashMap<UInt16, AggregateDataPtr>`を選択し、25%のパフォーマンス向上を実現します。[#9829](https://github.com/ClickHouse/ClickHouse/pull/9829) ([Amos Bird](https://github.com/amosbird))
- pre-limit変換で複数のストリームに対して単一の行カウンタを使用します。これにより、`limit`はあるが`order by`がないクエリ(`select f(x) from (select x from t limit 1000000000)`など)でパイプラインストリームを統合することを回避し、後続の処理で複数のスレッドを使用できるようになります。[#9602](https://github.com/ClickHouse/ClickHouse/pull/9602) ([Nikolai Kochetov](https://github.com/KochetovNicolai))


#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-15}

- Use a fork of AWS SDK libraries from ClickHouse-Extras [#10527](https://github.com/ClickHouse/ClickHouse/pull/10527) ([Pavel Kovalenko](https://github.com/Jokser))
- Add integration tests for new ALTER RENAME COLUMN query. [#10654](https://github.com/ClickHouse/ClickHouse/pull/10654) ([vzakaznikov](https://github.com/vzakaznikov))
- Fix possible signed integer overflow in invocation of function `now64` with wrong arguments. This fixes [#8973](https://github.com/ClickHouse/ClickHouse/issues/8973) [#10511](https://github.com/ClickHouse/ClickHouse/pull/10511) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Split fuzzer and sanitizer configurations to make build config compatible with Oss-fuzz. [#10494](https://github.com/ClickHouse/ClickHouse/pull/10494) ([kyprizel](https://github.com/kyprizel))
- Fixes for clang-tidy on clang-10. [#10420](https://github.com/ClickHouse/ClickHouse/pull/10420) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Display absolute paths in error messages. Otherwise KDevelop fails to navigate to correct file and opens a new file instead. [#10434](https://github.com/ClickHouse/ClickHouse/pull/10434) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added `ASAN_OPTIONS` environment variable to investigate errors in CI stress tests with Address sanitizer. [#10440](https://github.com/ClickHouse/ClickHouse/pull/10440) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Enable ThinLTO for clang builds (experimental). [#10435](https://github.com/ClickHouse/ClickHouse/pull/10435) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Remove accidential dependency on Z3 that may be introduced if the system has Z3 solver installed. [#10426](https://github.com/ClickHouse/ClickHouse/pull/10426) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Move integration tests docker files to docker/ directory. [#10335](https://github.com/ClickHouse/ClickHouse/pull/10335) ([Ilya Yatsishin](https://github.com/qoega))
- Allow to use `clang-10` in CI. It ensures that [#10238](https://github.com/ClickHouse/ClickHouse/issues/10238) is fixed. [#10384](https://github.com/ClickHouse/ClickHouse/pull/10384) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update OpenSSL to upstream master. Fixed the issue when TLS connections may fail with the message `OpenSSL SSL_read: error:14094438:SSL routines:ssl3_read_bytes:tlsv1 alert internal error` and `SSL Exception: error:2400006E:random number generator::error retrieving entropy`. The issue was present in version 20.1. [#8956](https://github.com/ClickHouse/ClickHouse/pull/8956) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix clang-10 build. [#10238](https://github.com/ClickHouse/ClickHouse/issues/10238) [#10370](https://github.com/ClickHouse/ClickHouse/pull/10370) ([Amos Bird](https://github.com/amosbird))
- Add performance test for [Parallel INSERT for materialized view](https://github.com/ClickHouse/ClickHouse/pull/10052). [#10345](https://github.com/ClickHouse/ClickHouse/pull/10345) ([vxider](https://github.com/Vxider))
- Fix flaky test `test_settings_constraints_distributed.test_insert_clamps_settings`. [#10346](https://github.com/ClickHouse/ClickHouse/pull/10346) ([Vitaly Baranov](https://github.com/vitlibar))
- Add util to test results upload in CI ClickHouse [#10330](https://github.com/ClickHouse/ClickHouse/pull/10330) ([Ilya Yatsishin](https://github.com/qoega))
- Convert test results to JSONEachRow format in junit_to_html tool [#10323](https://github.com/ClickHouse/ClickHouse/pull/10323) ([Ilya Yatsishin](https://github.com/qoega))
- Update cctz. [#10215](https://github.com/ClickHouse/ClickHouse/pull/10215) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Allow to create HTML report from the purest JUnit XML report. [#10247](https://github.com/ClickHouse/ClickHouse/pull/10247) ([Ilya Yatsishin](https://github.com/qoega))
- Update the check for minimal compiler version. Fix the root cause of the issue [#10250](https://github.com/ClickHouse/ClickHouse/issues/10250) [#10256](https://github.com/ClickHouse/ClickHouse/pull/10256) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Initial support for live view tables over distributed [#10179](https://github.com/ClickHouse/ClickHouse/pull/10179) ([vzakaznikov](https://github.com/vzakaznikov))
- Fix (false) MSan report in MergeTreeIndexFullText. The issue first appeared in [#9968](https://github.com/ClickHouse/ClickHouse/issues/9968). [#10801](https://github.com/ClickHouse/ClickHouse/pull/10801) ([alexey-milovidov](https://github.com/alexey-milovidov))
- clickhouse-docker-util [#10151](https://github.com/ClickHouse/ClickHouse/pull/10151) ([filimonov](https://github.com/filimonov))
- Update pdqsort to recent version [#10171](https://github.com/ClickHouse/ClickHouse/pull/10171) ([Ivan](https://github.com/abyss7))
- Update libdivide to v3.0 [#10169](https://github.com/ClickHouse/ClickHouse/pull/10169) ([Ivan](https://github.com/abyss7))
- Add check with enabled polymorphic parts. [#10086](https://github.com/ClickHouse/ClickHouse/pull/10086) ([Anton Popov](https://github.com/CurtizJ))
- Add cross-compile build for FreeBSD. This fixes [#9465](https://github.com/ClickHouse/ClickHouse/issues/9465) [#9643](https://github.com/ClickHouse/ClickHouse/pull/9643) ([Ivan](https://github.com/abyss7))
- Add performance test for [#6924](https://github.com/ClickHouse/ClickHouse/issues/6924) [#6980](https://github.com/ClickHouse/ClickHouse/pull/6980) ([filimonov](https://github.com/filimonov))
- Add support of `/dev/null` in the `File` engine for better performance testing [#8455](https://github.com/ClickHouse/ClickHouse/pull/8455) ([Amos Bird](https://github.com/amosbird))
- Move all folders inside /dbms one level up [#9974](https://github.com/ClickHouse/ClickHouse/pull/9974) ([Ivan](https://github.com/abyss7))
- Add a test that checks that read from MergeTree with single thread is performed in order. Addition to [#9670](https://github.com/ClickHouse/ClickHouse/issues/9670) [#9762](https://github.com/ClickHouse/ClickHouse/pull/9762) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix the `00964_live_view_watch_events_heartbeat.py` test to avoid race condition. [#9944](https://github.com/ClickHouse/ClickHouse/pull/9944) ([vzakaznikov](https://github.com/vzakaznikov))
- Fix integration test `test_settings_constraints` [#9962](https://github.com/ClickHouse/ClickHouse/pull/9962) ([Vitaly Baranov](https://github.com/vitlibar))
- Every function in its own file, part 12. [#9922](https://github.com/ClickHouse/ClickHouse/pull/9922) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added performance test for the case of extremely slow analysis of array of tuples. [#9872](https://github.com/ClickHouse/ClickHouse/pull/9872) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update zstd to 1.4.4. It has some minor improvements in performance and compression ratio. If you run replicas with different versions of ClickHouse you may see reasonable error messages `Data after merge is not byte-identical to data on another replicas.` with explanation. These messages are Ok and you should not worry. [#10663](https://github.com/ClickHouse/ClickHouse/pull/10663) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix TSan report in `system.stack_trace`. [#9832](https://github.com/ClickHouse/ClickHouse/pull/9832) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Removed dependency on `clock_getres`. [#9833](https://github.com/ClickHouse/ClickHouse/pull/9833) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added identifier names check with clang-tidy. [#9799](https://github.com/ClickHouse/ClickHouse/pull/9799) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update "builder" docker image. This image is not used in CI but is useful for developers. [#9809](https://github.com/ClickHouse/ClickHouse/pull/9809) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Remove old `performance-test` tool that is no longer used in CI. `clickhouse-performance-test` is great but now we are using way superior tool that is doing comparison testing with sophisticated statistical formulas to achieve confident results regardless to various changes in environment. [#9796](https://github.com/ClickHouse/ClickHouse/pull/9796) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added most of clang-static-analyzer checks. [#9765](https://github.com/ClickHouse/ClickHouse/pull/9765) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update Poco to 1.9.3 in preparation for MongoDB URI support. [#6892](https://github.com/ClickHouse/ClickHouse/pull/6892) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Fix build with `-DUSE_STATIC_LIBRARIES=0 -DENABLE_JEMALLOC=0` [#9651](https://github.com/ClickHouse/ClickHouse/pull/9651) ([Artem Zuikov](https://github.com/4ertus2))
- For change log script, if merge commit was cherry-picked to release branch, take PR name from commit description. [#9708](https://github.com/ClickHouse/ClickHouse/pull/9708) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Support `vX.X-conflicts` tag in backport script. [#9705](https://github.com/ClickHouse/ClickHouse/pull/9705) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix `auto-label` for backporting script. [#9685](https://github.com/ClickHouse/ClickHouse/pull/9685) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Use libc++ in Darwin cross-build to make it consistent with native build. [#9665](https://github.com/ClickHouse/ClickHouse/pull/9665) ([Hui Wang](https://github.com/huiwang))
- Fix flacky test `01017_uniqCombined_memory_usage`. Continuation of [#7236](https://github.com/ClickHouse/ClickHouse/issues/7236). [#9667](https://github.com/ClickHouse/ClickHouse/pull/9667) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix build for native macOS Clang compiler [#9649](https://github.com/ClickHouse/ClickHouse/pull/9649) ([Ivan](https://github.com/abyss7))
- Allow to add various glitches around `pthread_mutex_lock`, `pthread_mutex_unlock` functions. [#9635](https://github.com/ClickHouse/ClickHouse/pull/9635) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add support for `clang-tidy` in `packager` script. [#9625](https://github.com/ClickHouse/ClickHouse/pull/9625) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add ability to use unbundled msgpack. [#10168](https://github.com/ClickHouse/ClickHouse/pull/10168) ([Azat Khuzhin](https://github.com/azat))





## ClickHouseリリース v20.3 {#clickhouse-release-v203}

### ClickHouseリリース v20.3.21.2-lts, 2020-11-02 {#clickhouse-release-v203212-lts-2020-11-02}

#### バグ修正 {#bug-fix-33}

- sharding_key内のdictGetを修正(および類似の箇所、つまり関数コンテキストが永続的に保存される場合)。[#16205](https://github.com/ClickHouse/ClickHouse/pull/16205) ([Azat Khuzhin](https://github.com/azat))。
- クエリに`WHERE`、`PREWHERE`、`GLOBAL IN`が含まれる場合、`Distributed`テーブルからのクエリで不正な空の結果が返される問題を修正。[#15792](https://github.com/ClickHouse/ClickHouse/issues/15792)を修正。[#15933](https://github.com/ClickHouse/ClickHouse/pull/15933) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- `TSV/CSVWithNames`形式でヘッダーが欠落または過剰になる問題を修正。[#12504](https://github.com/ClickHouse/ClickHouse/issues/12504)を修正。[#13343](https://github.com/ClickHouse/ClickHouse/pull/13343) ([Azat Khuzhin](https://github.com/azat))。

### ClickHouseリリース v20.3.20.6-lts, 2020-10-09 {#clickhouse-release-v203206-lts-2020-10-09}

#### バグ修正 {#bug-fix-34}

- `MOVE`または`REPLACE PARTITION`の後、まれに`DETACH`または`DROP PARTITION`の後に、存在しないパートを待機してミューテーションがハングする可能性がある問題を修正。[#15724](https://github.com/ClickHouse/ClickHouse/pull/15724)、[#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix))。
- `MySQL`エンジンの同じテーブルに対する多数のサブクエリを含むクエリがハングする問題を修正。以前は、クエリ内に同じ`MySQL`テーブルへのサブクエリが16個を超えると、永久にハングしていました。[#15299](https://github.com/ClickHouse/ClickHouse/pull/15299) ([Anton Popov](https://github.com/CurtizJ))。
- Mergeテーブルに対するJOINを含むクエリでGROUP BY内に'Unknown identifier'エラーが発生する問題を修正。[#15242](https://github.com/ClickHouse/ClickHouse/pull/15242) ([Artem Zuikov](https://github.com/4ertus2))。
- サブクエリにfinalizeAggregation関数が含まれる場合に述語プッシュダウンが機能するように修正。[#14847](https://github.com/ClickHouse/ClickHouse/issues/14847)を修正。[#14937](https://github.com/ClickHouse/ClickHouse/pull/14937) ([filimonov](https://github.com/filimonov))。
- 同時実行される`ALTER ... REPLACE/MOVE PARTITION ...`クエリがデッドロックを引き起こす可能性がある問題を修正。[#13626](https://github.com/ClickHouse/ClickHouse/pull/13626) ([tavplubix](https://github.com/tavplubix))。

### ClickHouseリリース v20.3.19.4-lts, 2020-09-18 {#clickhouse-release-v203194-lts-2020-09-18}

#### バグ修正 {#bug-fix-35}


- クエリ対象のカラムが`DEFAULT`式を持ち、その式が別の`DEFAULT`を持つカラムに依存しており、そのカラムがSELECTクエリに含まれず、かつディスク上に存在しない場合に発生する`SELECT`クエリの稀なエラーを修正しました。[#14531](https://github.com/ClickHouse/ClickHouse/issues/14531)を部分的に修正します。[#14845](https://github.com/ClickHouse/ClickHouse/pull/14845) ([alesapin](https://github.com/alesapin))。
- 代入式にNullableカラムと定数値(例: `UPDATE x = 42`)を使用した`ALTER UPDATE`ミューテーションが、カラムの不正な値やセグメンテーション違反を引き起こすバグを修正しました。[#13634](https://github.com/ClickHouse/ClickHouse/issues/13634)、[#14045](https://github.com/ClickHouse/ClickHouse/issues/14045)を修正します。[#14646](https://github.com/ClickHouse/ClickHouse/pull/14646) ([alesapin](https://github.com/alesapin))。
- 結果カラムの誤ったDecimalスケールによって引き起こされる誤ったDecimal乗算結果を修正しました。[#14603](https://github.com/ClickHouse/ClickHouse/pull/14603) ([Artem Zuikov](https://github.com/4ertus2))。

#### 改善 {#improvement-17}

- コンパクトパートでのカスタムコーデックのサポートを追加しました。[#12183](https://github.com/ClickHouse/ClickHouse/pull/12183) ([Anton Popov](https://github.com/CurtizJ))。

### ClickHouseリリース v20.3.18.10-lts, 2020-09-08 {#clickhouse-release-v2031810-lts-2020-09-08}

#### バグ修正 {#bug-fix-36}

- `PipelineExecutor`自体で例外が発生した場合にクエリ実行を停止するようにしました。これにより、稀に発生する可能性のあるクエリのハングを防ぐことができます。[#14334](https://github.com/ClickHouse/ClickHouse/issues/14334)の続きです。[#14402](https://github.com/ClickHouse/ClickHouse/pull/14402) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- キャッシュディクショナリがソースから存在する値ではなくデフォルト値を返すことがある動作を修正しました。[#13624](https://github.com/ClickHouse/ClickHouse/pull/13624) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- データベース名やテーブル名にドットが含まれる場合のusers.xmlからの行ポリシーの解析を修正しました。[#5779](https://github.com/ClickHouse/ClickHouse/issues/5779)、[#12527](https://github.com/ClickHouse/ClickHouse/issues/12527)を修正します。[#13199](https://github.com/ClickHouse/ClickHouse/pull/13199) ([Vitaly Baranov](https://github.com/vitlibar))。
- CAST(Nullable(String), Enum())を修正しました。[#12745](https://github.com/ClickHouse/ClickHouse/pull/12745) ([Azat Khuzhin](https://github.com/azat))。
- `text_log`のデータ競合を修正しました。これは実際のバグには対応していません。[#9726](https://github.com/ClickHouse/ClickHouse/pull/9726) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### 改善 {#improvement-18}

- 長いクエリに対する誤ったエラーを修正しました。正しいクエリに対して`Max query size exceeded`以外の構文エラーが発生する可能性がありました。[#13928](https://github.com/ClickHouse/ClickHouse/pull/13928) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- parseDateTimeBestEffortOrNull/Zero関数で値が完全に解析されない場合にNULL/ゼロを返すようにしました。[#7876](https://github.com/ClickHouse/ClickHouse/issues/7876)を修正します。[#11653](https://github.com/ClickHouse/ClickHouse/pull/11653) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### パフォーマンス改善 {#performance-improvement-12}

- LowCardinalityを使用した非常に短いクエリをわずかに最適化しました。[#14129](https://github.com/ClickHouse/ClickHouse/pull/14129) ([Anton Popov](https://github.com/CurtizJ))。

#### ビルド/テスト/パッケージング改善 {#buildtestingpackaging-improvement-16}


- clang-10への移行後にHashTableで発生したUBSanレポート（nullptrへのゼロ加算）を修正。[#10638](https://github.com/ClickHouse/ClickHouse/pull/10638) ([alexey-milovidov](https://github.com/alexey-milovidov))。

### ClickHouseリリース v20.3.17.173-lts, 2020-08-15 {#clickhouse-release-v20317173-lts-2020-08-15}

#### バグ修正 {#bug-fix-37}

- StorageMergeと`set enable_optimize_predicate_expression=1`を使用したJOINでのクラッシュを修正。[#13679](https://github.com/ClickHouse/ClickHouse/pull/13679) ([Artem Zuikov](https://github.com/4ertus2))。
- `NULL`要素を含むタプルの比較における無効な戻り値型を修正。[#12461](https://github.com/ClickHouse/ClickHouse/issues/12461)を修正。[#13420](https://github.com/ClickHouse/ClickHouse/pull/13420) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 定数カラムとプライマリキーの`ORDER BY`プレフィックスを含むクエリを修正。[#13396](https://github.com/ClickHouse/ClickHouse/pull/13396) ([Anton Popov](https://github.com/CurtizJ))。
- roundUpToPowerOfTwoOrZero()でMSBが設定された数値に対して渡された数値を返すように修正。[#13234](https://github.com/ClickHouse/ClickHouse/pull/13234) ([Azat Khuzhin](https://github.com/azat))。

### ClickHouseリリース v20.3.16.165-lts 2020-08-10 {#clickhouse-release-v20316165-lts-2020-08-10}

#### バグ修正 {#bug-fix-38}


* `parseDateTimeBestEffort` 関数に、引数として unix タイムスタンプが渡された場合に発生していたエラーを修正しました。これにより [#13362](https://github.com/ClickHouse/ClickHouse/issues/13362) が解決されます。 [#13441](https://github.com/ClickHouse/ClickHouse/pull/13441) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* Float 型に対して `NaN` を含む値で呼び出された `uniqExact`、`topK`、`sumDistinct` などの集約関数で、潜在的に低いパフォーマンスと結果がわずかに不正確になる問題を修正しました。また、デバッグビルドで assert をトリガーする原因にもなっていました。この修正は [#12491](https://github.com/ClickHouse/ClickHouse/issues/12491) を解決します。[#13254](https://github.com/ClickHouse/ClickHouse/pull/13254)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* リテラル NULL ではない nullable な constexpr を cond として受け取る関数 `if` を修正。[#12463](https://github.com/ClickHouse/ClickHouse/issues/12463) を修正。[#13226](https://github.com/ClickHouse/ClickHouse/pull/13226)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 配列要素が Nullable であり、かつ配列添字も Nullable の場合の `arrayElement` 関数内のアサートを修正しました。これにより [#12172](https://github.com/ClickHouse/ClickHouse/issues/12172) が解決されます。 [#13224](https://github.com/ClickHouse/ClickHouse/pull/13224) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* ローカルレプリカからの `SELECT` に対するスレッド数の不要な制限を修正しました。 [#12840](https://github.com/ClickHouse/ClickHouse/pull/12840) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `WITH TOTALS` クエリで発生する可能性があった、データ中の余分なオーバーフロー行の問題を修正しました。 [#12747](https://github.com/ClickHouse/ClickHouse/pull/12747) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `IN` 節で関数として解釈される大きな `tuple` を使用した場合のパフォーマンス問題を修正しました。ユーザーが、何らかのよく分からない理由で `WHERE x IN (1, 2, ...)` ではなく `WHERE x IN tuple(1, 2, ...)` と書いてしまうケースです。 [#12700](https://github.com/ClickHouse/ClickHouse/pull/12700) ([Anton Popov](https://github.com/CurtizJ)).
* input&#95;format&#95;parallel&#95;parsing のメモリトラッキングを修正（スレッドをグループにアタッチすることで対応）。 [#12672](https://github.com/ClickHouse/ClickHouse/pull/12672) ([Azat Khuzhin](https://github.com/azat)).
* [#12293](https://github.com/ClickHouse/ClickHouse/issues/12293) を修正し、`WITH` 句を含むサブクエリでも述語をプッシュできるようにしました。 [#12663](https://github.com/ClickHouse/ClickHouse/pull/12663) ([Winter Zhang](https://github.com/zhang2014)).
* [#10572](https://github.com/ClickHouse/ClickHouse/issues/10572) const expression を含む bloom filter インデックスの不具合を修正しました。[#12659](https://github.com/ClickHouse/ClickHouse/pull/12659)（[Winter Zhang](https://github.com/zhang2014)）。
* ブローカーが利用不能な場合（など）に `StorageKafka` で発生していた SIGSEGV を修正しました。 [#12658](https://github.com/ClickHouse/ClickHouse/pull/12658) ([Azat Khuzhin](https://github.com/azat)).
* キャッシュレイアウトを使用する外部ディクショナリにおいて、サーバーのクラッシュを引き起こす可能性があったレースコンディションを修正しました。 [#12566](https://github.com/ClickHouse/ClickHouse/pull/12566) ([alesapin](https://github.com/alesapin)).
* `enable_mixed_granularity_parts=1` のときに `ALTER DELETE` クエリを実行すると古いパーツが壊れてしまうバグを修正しました。[#12536](https://github.com/ClickHouse/ClickHouse/issues/12536) を修正。[#12543](https://github.com/ClickHouse/ClickHouse/pull/12543)（[alesapin](https://github.com/alesapin)）。
* 無効な数の引数が指定された場合に、関数 `in` の例外メッセージを改善しました。 [#12529](https://github.com/ClickHouse/ClickHouse/pull/12529) ([Anton Popov](https://github.com/CurtizJ)).
* コンパクトパーツからの読み込み時に発生していたパフォーマンス問題を修正しました。 [#12492](https://github.com/ClickHouse/ClickHouse/pull/12492) ([Anton Popov](https://github.com/CurtizJ)).
* `text_log` を有効にした際に発生するデッドロックを修正しました。 [#12452](https://github.com/ClickHouse/ClickHouse/pull/12452) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* StorageMerge 使用時に発生する可能性があったセグメンテーションフォルトを修正しました。 [#12054](https://github.com/ClickHouse/ClickHouse/issues/12054) をクローズ。 [#12401](https://github.com/ClickHouse/ClickHouse/pull/12401)（[tavplubix](https://github.com/tavplubix)）。
* `-State` および `Nullable` 引数を持つ集約関数に対する `TOTALS/ROLLUP/CUBE` の動作を修正しました。これにより [#12163](https://github.com/ClickHouse/ClickHouse/issues/12163) が解決されました。 [#12376](https://github.com/ClickHouse/ClickHouse/pull/12376) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `WITH FILL` 修飾子での列順序の扱いを修正しました。以前は、`ORDER BY` 句で指定した列の順序が正しく反映されていませんでした。 [#12306](https://github.com/ClickHouse/ClickHouse/pull/12306) ([Anton Popov](https://github.com/CurtizJ)).
* 仮想カラム（`Merge` テーブルの `_table` など）やシステムテーブルの「index」カラムを使ってデータをフィルタする式（`system.tables` からクエリする際にデータベース名でフィルタする場合など）があり、その式が `Nullable` 型を返す場合に「bad cast」例外が発生しないようにしました。これにより [#12166](https://github.com/ClickHouse/ClickHouse/issues/12166) が修正されました。[#12305](https://github.com/ClickHouse/ClickHouse/pull/12305)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `TrieDictionary` の読み込みに失敗した場合にエラーを表示するようにしました。[#12290](https://github.com/ClickHouse/ClickHouse/pull/12290)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 空配列に対して `arrayFill` 関数が正しく動作せず、クラッシュを引き起こす可能性がありました。これにより [#12263](https://github.com/ClickHouse/ClickHouse/issues/12263) が修正されました。[#12279](https://github.com/ClickHouse/ClickHouse/pull/12279)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `LowCardinality` 型を共通型へ変換する処理を実装しました。これにより、LowCardinality 型のカラムとその他のカラムを持つテーブルに対して `UNION ALL` を実行できるようになります。これにより [#8212](https://github.com/ClickHouse/ClickHouse/issues/8212) が修正され、また [#4342](https://github.com/ClickHouse/ClickHouse/issues/4342) も修正されます。[#12275](https://github.com/ClickHouse/ClickHouse/pull/12275)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `StorageFile` への複数回の連続挿入時に、一部の特殊な型に対してヘッダーが複数回書き込まれてしまう動作を修正しました。これにより [#6155](https://github.com/ClickHouse/ClickHouse/issues/6155) が修正されました。[#12197](https://github.com/ClickHouse/ClickHouse/pull/12197)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 0 または 1 以外の `UInt8` 値に対する論理関数の動作を修正しました。 [#12196](https://github.com/ClickHouse/ClickHouse/pull/12196) ([Alexander Kazakov](https://github.com/Akazz))。
* GROUP BY での単射関数の除去時に行われる `dictGet` の引数チェックを修正しました。 [#12179](https://github.com/ClickHouse/ClickHouse/pull/12179) ([Azat Khuzhin](https://github.com/azat)).
* 条件が NULL と評価される場合にレコードが削除されてしまう、`ALTER DELETE` の誤ったロジックを修正しました。これにより [#9088](https://github.com/ClickHouse/ClickHouse/issues/9088) が修正され、[#12106](https://github.com/ClickHouse/ClickHouse/issues/12106) がクローズされます。 [#12153](https://github.com/ClickHouse/ClickHouse/pull/12153) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* エイリアスが存在する場合に、外部 DBMS（例: MySQL、ODBC）へ送信するクエリの変換処理を修正しました。この修正により [#12032](https://github.com/ClickHouse/ClickHouse/issues/12032) が解決されました。[#12151](https://github.com/ClickHouse/ClickHouse/pull/12151)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 整数除算で発生し得るオーバーフローを修正しました。これにより [#12119](https://github.com/ClickHouse/ClickHouse/issues/12119) が解決されました。 [#12140](https://github.com/ClickHouse/ClickHouse/pull/12140) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `greatCircleDistance`、`geoDistance` における無限ループが発生しうる問題を修正しました。これにより [#12117](https://github.com/ClickHouse/ClickHouse/issues/12117) が解決されます。[#12137](https://github.com/ClickHouse/ClickHouse/pull/12137)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `system.query&#95;log`、`metric&#95;log` などのシステムログ、または `engine=Buffer` の基礎テーブルに紐づくサブクエリや JOIN を含むマテリアライズドビューで発生する `There is no query` 例外を回避します。 [#12120](https://github.com/ClickHouse/ClickHouse/pull/12120) ([filimonov](https://github.com/filimonov)).
* スレッド総数に対する誤った制限値が原因で、`UNION` を含む `SELECT` のパフォーマンスが低下していた問題を修正しました。 [#12030](https://github.com/ClickHouse/ClickHouse/issues/12030) を修正。 [#12103](https://github.com/ClickHouse/ClickHouse/pull/12103)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `-StateResample` コンビネータで発生していたセグメンテーションフォールトを修正しました。 [#12092](https://github.com/ClickHouse/ClickHouse/pull/12092) ([Anton Popov](https://github.com/CurtizJ)).
* `VIEW` からの `SELECT` に対してスレッド数を不必要に制限していた問題を修正しました。[#11937](https://github.com/ClickHouse/ClickHouse/issues/11937) を修正。 [#12085](https://github.com/ClickHouse/ClickHouse/pull/12085)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `PREWHERE` に誤った型を使用した場合に発生しうるクラッシュを修正しました。 [#12053](https://github.com/ClickHouse/ClickHouse/issues/12053)、[#12060](https://github.com/ClickHouse/ClickHouse/issues/12060) を解決します。 [#12060](https://github.com/ClickHouse/ClickHouse/pull/12060)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `LowCardinality` 型に対する関数 `defaultValueOfArgumentType` で発生していたエラー `Expected single dictionary argument for function` を修正しました。[#11808](https://github.com/ClickHouse/ClickHouse/issues/11808) の修正。 [#12056](https://github.com/ClickHouse/ClickHouse/pull/12056)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `Tuple(LowCardinality)` 引数を持つ高階関数で発生する `Cannot capture column` エラーを修正しました。[#9766](https://github.com/ClickHouse/ClickHouse/issues/9766) を解決。[#12055](https://github.com/ClickHouse/ClickHouse/pull/12055)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* データベース読み込み時にテーブルのメタデータを並列で解析するようにしました。これにより、大量のテーブルが存在する場合のサーバー起動の遅さが解消されます。 [#12045](https://github.com/ClickHouse/ClickHouse/pull/12045) ([tavplubix](https://github.com/tavplubix)).
* Enum 型に対しては、`topK` 集約関数が Enum を返すようにしました。これにより [#3740](https://github.com/ClickHouse/ClickHouse/issues/3740) が修正されました。[#12043](https://github.com/ClickHouse/ClickHouse/pull/12043)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 制約が定数式かどうかをチェックするように修正しました。これにより [#11360](https://github.com/ClickHouse/ClickHouse/issues/11360) が解決されました。 [#12042](https://github.com/ClickHouse/ClickHouse/pull/12042)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `Nullable` カラムを含むタプルの誤った比較を修正しました。 [#11985](https://github.com/ClickHouse/ClickHouse/issues/11985) を解決。[#12039](https://github.com/ClickHouse/ClickHouse/pull/12039)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* サイズの異なる `FixedString` 型の引数で関数 `if` を呼び出した際に、誤った結果が返されたりクラッシュが発生する可能性があった問題を修正しました。これにより [#11362](https://github.com/ClickHouse/ClickHouse/issues/11362) が解決されています。 [#12021](https://github.com/ClickHouse/ClickHouse/pull/12021) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 返される式が関数 `neighbor` だけであるクエリは、オフセット `-9223372036854775808` を指定して関数を呼び出すと、空の結果を返す場合があります。これは [#11367](https://github.com/ClickHouse/ClickHouse/issues/11367) を修正するものです。 [#12019](https://github.com/ClickHouse/ClickHouse/pull/12019)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `generateRandom` 内で、クラッシュを引き起こす可能性のある配列サイズのオーバーフローの不具合を修正しました。これにより [#11371](https://github.com/ClickHouse/ClickHouse/issues/11371) が修正されます。[#12013](https://github.com/ClickHouse/ClickHouse/pull/12013)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 浮動小数点例外が発生する可能性のある問題を修正しました。これにより [#11378](https://github.com/ClickHouse/ClickHouse/issues/11378) がクローズされました。 [#12005](https://github.com/ClickHouse/ClickHouse/pull/12005) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* サーバー起動時のログメッセージにおける誤った設定名を修正しました。 [#11997](https://github.com/ClickHouse/ClickHouse/pull/11997) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `Values` フォーマットで発生していた `Query parameter was not set` エラーを修正しました。 [#11918](https://github.com/ClickHouse/ClickHouse/issues/11918) を修正します。 [#11936](https://github.com/ClickHouse/ClickHouse/pull/11936)（[tavplubix](https://github.com/tavplubix)）。
* クエリ内の置換（パラメータ化クエリ）に対してエイリアスを保持するようにしました。これにより [#11914](https://github.com/ClickHouse/ClickHouse/issues/11914) が修正されます。[#11916](https://github.com/ClickHouse/ClickHouse/pull/11916)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* DateTime64 のパース時に発生する可能性があった浮動小数点例外を修正しました。これにより [#11374](https://github.com/ClickHouse/ClickHouse/issues/11374) が修正されました。 [#11875](https://github.com/ClickHouse/ClickHouse/pull/11875) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `HTTP` インターフェイス経由のメモリ使用量の計上を修正しました（`wait_end_of_query=1` の場合に顕著になる可能性があります）。 [#11840](https://github.com/ClickHouse/ClickHouse/pull/11840) ([Azat Khuzhin](https://github.com/azat)).
* 条件に NULL が含まれる場合の `if()` の誤結果を修正しました。 [#11807](https://github.com/ClickHouse/ClickHouse/pull/11807) ([Artem Zuikov](https://github.com/4ertus2)).
* 等価性を確認する前に、ZooKeeper に保存されているメタデータをパースするようにしました。 [#11739](https://github.com/ClickHouse/ClickHouse/pull/11739) ([Azat Khuzhin](https://github.com/azat))。
* エイリアスを含む `ORDER BY` 句との併用時における `LIMIT n WITH TIES` の挙動を修正しました。 [#11689](https://github.com/ClickHouse/ClickHouse/pull/11689) ([Anton Popov](https://github.com/CurtizJ)).
* cache dictionary で未初期化メモリを読み込んでしまう可能性のある問題を修正。 [#10834](https://github.com/ClickHouse/ClickHouse/pull/10834) ([alexey-milovidov](https://github.com/alexey-milovidov)).

#### パフォーマンス改善 {#performance-improvement-13}

- リテラルを含むIN演算子でインデックスが使用されず、v19.3頃に導入されたパフォーマンス低下を修正しました。この修正は [#10574](https://github.com/ClickHouse/ClickHouse/issues/10574) に対応しています。[#12062](https://github.com/ClickHouse/ClickHouse/pull/12062) ([nvartolomei](https://github.com/nvartolomei))。

### ClickHouse リリース v20.3.12.112-lts 2020-06-25 {#clickhouse-release-v20312112-lts-2020-06-25}

#### バグ修正 {#bug-fix-39}


* `prewhere` 条件で `Nullable` カラムを使用した際に発生する、まれなクラッシュを修正しました。[#11608](https://github.com/ClickHouse/ClickHouse/issues/11608) の継続対応です。[#11869](https://github.com/ClickHouse/ClickHouse/pull/11869)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 高階関数の内部で arrayJoin を許可しないようにしました。これによりプロトコルの同期が壊れる問題が発生していました。この変更によって [#3933](https://github.com/ClickHouse/ClickHouse/issues/3933) がクローズされました。[#11846](https://github.com/ClickHouse/ClickHouse/pull/11846)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* クエリでスレッドを過剰に使用していた問題を修正。 [#11788](https://github.com/ClickHouse/ClickHouse/pull/11788) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 本来はエラーになるべきところで成功してしまっていた、`SELECT *, xyz.*` のようなクエリの予期しない動作を修正しました。 [#11753](https://github.com/ClickHouse/ClickHouse/pull/11753) ([hexiaoting](https://github.com/hexiaoting))。
* メタデータの `ALTER` 実行中に、レプリケートされたフェッチがキャンセルされるようになりました。 [#11744](https://github.com/ClickHouse/ClickHouse/pull/11744) ([alesapin](https://github.com/alesapin)).
* Values 入力フォーマットにおける複雑なリテラルの誤った型推論によって発生していた LOGICAL&#95;ERROR を修正。[#11732](https://github.com/ClickHouse/ClickHouse/pull/11732) ([tavplubix](https://github.com/tavplubix))。
* const 列に対する `ORDER BY ... WITH FILL` を修正。 [#11697](https://github.com/ClickHouse/ClickHouse/pull/11697) ([Anton Popov](https://github.com/CurtizJ)).
* XDBC bridge と通信する際に、適切なタイムアウトを指定します。これまで、bridge の生存監視およびメタ情報の受信時に、タイムアウトが正しく考慮されていませんでした。 [#11690](https://github.com/ClickHouse/ClickHouse/pull/11690) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `system.mutations` が不正な状態になる原因となっていたエラーを修正しました。サーバー側でレプリケーションキューにまだ `MUTATE_PART` タスクが残っており、それらの実行を試みているにもかかわらず、ミューテーション全体がすでに完了しているかのように表示されてしまう場合がありました。この修正は [#11611](https://github.com/ClickHouse/ClickHouse/issues/11611) を解決します。[#11681](https://github.com/ClickHouse/ClickHouse/pull/11681)（[alesapin](https://github.com/alesapin)）。
* 大文字・小文字を区別しないフラグ付き正規表現のサポートを追加しました。これにより [#11101](https://github.com/ClickHouse/ClickHouse/issues/11101) および [#11506](https://github.com/ClickHouse/ClickHouse/issues/11506) が修正されます。[#11649](https://github.com/ClickHouse/ClickHouse/pull/11649)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 行レベルセキュリティが設定されている場合は、単純な count クエリに対する最適化を削除しました。以前のバージョンでは、ユーザーはフィルタ後の件数ではなく、テーブル内のレコードの総数を取得していました。これにより [#11352](https://github.com/ClickHouse/ClickHouse/issues/11352) が修正されます。 [#11644](https://github.com/ClickHouse/ClickHouse/pull/11644) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* String 用の Bloom filter（データスキッピングインデックス）を修正。 [#11638](https://github.com/ClickHouse/ClickHouse/pull/11638) ([Azat Khuzhin](https://github.com/azat)).
* `prewhere` 条件で `Nullable` カラムを使用したことにより発生する、まれなクラッシュを修正しました（おそらく [#11572](https://github.com/ClickHouse/ClickHouse/issues/11572) と何らかの関係があります）。[#11608](https://github.com/ClickHouse/ClickHouse/pull/11608)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `Buffer` テーブルからのサンプリング読み取りを行うクエリで発生する `Block structure mismatch` エラーを修正しました。 [#11602](https://github.com/ClickHouse/ClickHouse/pull/11602) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `exception.code() % 256 = 0` の場合に発生する clickhouse-client の誤った終了コードを修正。 [#11601](https://github.com/ClickHouse/ClickHouse/pull/11601) ([filimonov](https://github.com/filimonov)).
* サーバー起動時に出力される「Mark cache size was lowered」というログメッセージの些細な誤りを修正しました。これにより [#11399](https://github.com/ClickHouse/ClickHouse/issues/11399) がクローズされます。[#11589](https://github.com/ClickHouse/ClickHouse/pull/11589)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `PREWHERE column in (subquery)` と `ARRAY JOIN` を含むクエリで発生するエラー `Size of offsets does not match size of column` を修正。 [#11580](https://github.com/ClickHouse/ClickHouse/pull/11580) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* HTTP セッション内のすべてのクエリが同じ `query_id` を持っていました。この問題は修正されました。 [#11578](https://github.com/ClickHouse/ClickHouse/pull/11578) ([tavplubix](https://github.com/tavplubix))。
* これにより、`clickhouse-server` の Docker コンテナはサーバーの生存確認において IPv6 を優先して使用するようになります。 [#11550](https://github.com/ClickHouse/ClickHouse/pull/11550) ([Ivan Starkov](https://github.com/istarkov))。
* `<node>` に対する shard&#95;num/replica&#95;num を修正（use&#95;compact&#95;format&#95;in&#95;distributed&#95;parts&#95;names を破壊していた不具合を修正）。 [#11528](https://github.com/ClickHouse/ClickHouse/pull/11528) ([Azat Khuzhin](https://github.com/azat)).
* -State 関数を用いた集計処理の途中で例外がスローされた際に発生するメモリリークを修正しました。これにより [#8995](https://github.com/ClickHouse/ClickHouse/issues/8995) が解決されました。 [#11496](https://github.com/ClickHouse/ClickHouse/pull/11496)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* エイリアスが修飾付きカラム名を上書きしてしまうことで、分散クエリで誤った結果が返される問題を修正。 [#9672](https://github.com/ClickHouse/ClickHouse/issues/9672) [#9714](https://github.com/ClickHouse/ClickHouse/issues/9714) を修正。 [#9972](https://github.com/ClickHouse/ClickHouse/pull/9972)（[Artem Zuikov](https://github.com/4ertus2)）。

### ClickHouse release v20.3.11.97-lts 2020-06-10 {#clickhouse-release-v2031197-lts-2020-06-10}

#### 新機能 {#new-feature-9}

- ClickHouseは辞書ソースのタイムアウトを自身で制御するようになりました。キャッシュ辞書の設定に2つの新しい設定が追加されました：`strict_max_lifetime_seconds`（デフォルトは`max_lifetime`）と`query_wait_timeout_milliseconds`（デフォルトは1分）です。最初の設定は`allow_read_expired_keys`設定と併用すると便利です（非常に古い期限切れキーの読み取りを禁止するため）。[#10337](https://github.com/ClickHouse/ClickHouse/pull/10337) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。

#### バグ修正 {#bug-fix-40}


* `min_bytes_to_use_direct_io` が有効で、PREWHERE が有効かつ SAMPLE を使用している場合、またはスレッド数が多い場合に発生しうる `Data compressed with different methods` エラーを修正しました。これにより [#11539](https://github.com/ClickHouse/ClickHouse/issues/11539) が修正されました。 [#11540](https://github.com/ClickHouse/ClickHouse/pull/11540) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* コーデックで返される圧縮サイズを修正。 [#11448](https://github.com/ClickHouse/ClickHouse/pull/11448) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* カラムがリテラルではない引数を持つ圧縮Codecを使用している場合にサーバーがクラッシュする問題を修正。 [#11365](https://github.com/ClickHouse/ClickHouse/issues/11365) を修正。 [#11431](https://github.com/ClickHouse/ClickHouse/pull/11431)（[alesapin](https://github.com/alesapin)）。
* `nan` を点として扱う場合の `pointInPolygon` の挙動を修正しました。[#11375](https://github.com/ClickHouse/ClickHouse/issues/11375) を解決。[#11421](https://github.com/ClickHouse/ClickHouse/pull/11421)（[Alexey Ilyukhov](https://github.com/livace)）。
* LowCarinality(T) および Nullable(T) を含む JOIN で発生するクラッシュを修正。 [#11380](https://github.com/ClickHouse/ClickHouse/issues/11380)。 [#11414](https://github.com/ClickHouse/ClickHouse/pull/11414) ([Artem Zuikov](https://github.com/4ertus2))。
* 誤った `USING` キーに対するエラーコードを修正。 [#11373](https://github.com/ClickHouse/ClickHouse/issues/11373)。 [#11404](https://github.com/ClickHouse/ClickHouse/pull/11404) ([Artem Zuikov](https://github.com/4ertus2))。
* `geohashesInBox` に対して緯度・経度の範囲外の引数が指定された場合の動作を修正しました。 [#11403](https://github.com/ClickHouse/ClickHouse/pull/11403) ([Vasily Nemkov](https://github.com/Enmk)).
* `joinGet()` 関数のエラーメッセージを改善。 [#11389](https://github.com/ClickHouse/ClickHouse/pull/11389) ([Artem Zuikov](https://github.com/4ertus2)).
* 外部ソートと `LIMIT` を含むクエリで発生しうる `Pipeline stuck` エラーを修正。[#11359](https://github.com/ClickHouse/ClickHouse/issues/11359) を解決。[#11366](https://github.com/ClickHouse/ClickHouse/pull/11366)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* ReplicatedMergeTree でパーツ送信時に取得していた冗長なロックを削除。 [#11354](https://github.com/ClickHouse/ClickHouse/pull/11354) ([alesapin](https://github.com/alesapin)).
* マルチラインモードにおける clickhouse-client の `\G`（縦方向出力）サポートを修正。これにより [#9933](https://github.com/ClickHouse/ClickHouse/issues/9933) がクローズされます。 [#11350](https://github.com/ClickHouse/ClickHouse/pull/11350)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `JOIN` を使わない `StorageJoin` からの直接 `SELECT` によるクラッシュと、誤った null 許容性を修正。 [#11340](https://github.com/ClickHouse/ClickHouse/pull/11340) ([Artem Zuikov](https://github.com/4ertus2)).
* `quantilesExactWeightedArray` のクラッシュを修正。 [#11337](https://github.com/ClickHouse/ClickHouse/pull/11337) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `ALTER` クエリでメタデータを変更する前にマージが停止されるようになりました。 [#11335](https://github.com/ClickHouse/ClickHouse/pull/11335) ([alesapin](https://github.com/alesapin)).
* `parallel_view_processing = 1` の設定を用いた `MATERIALIZED VIEW` への書き込みを、再び並列で実行できるようにしました。[#10241](https://github.com/ClickHouse/ClickHouse/issues/10241) を修正。[#11330](https://github.com/ClickHouse/ClickHouse/pull/11330)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 抽出された JSON に不均衡な &#123; または [ を含む文字列がある場合に `visitParamExtractRaw` が正しく動作するよう修正しました。 [#11318](https://github.com/ClickHouse/ClickHouse/pull/11318) ([Ewout](https://github.com/devwout))。
* ThreadPool における極めてまれなレースコンディションを修正しました。 [#11314](https://github.com/ClickHouse/ClickHouse/pull/11314) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 変換処理で未初期化メモリが使用される可能性のあった問題を修正しました。例: `SELECT toIntervalSecond(now64())`。 [#11311](https://github.com/ClickHouse/ClickHouse/pull/11311) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* PRIMARY KEY に `Array` 列が含まれており、その列に対して `empty` または `notEmpty` 関数でクエリをフィルタリングしている場合に、インデックス解析が動作しない問題を修正しました。これにより [#11286](https://github.com/ClickHouse/ClickHouse/issues/11286) が解決されました。 [#11303](https://github.com/ClickHouse/ClickHouse/pull/11303) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `max_network_bandwidth`、`max_execution_speed` または `priority` の設定によってクエリがスロットルされている場合に、クエリ速度の推定が誤ることがあり、その結果 `min_execution_speed` の制限が機能しない、または正しく機能しないことがあるバグを修正しました。`timeout_before_checking_execution_speed` のデフォルト値を非ゼロに変更しました。そうしないと `min_execution_speed` および `max_execution_speed` の設定が効果を持たないためです。これにより [#11297](https://github.com/ClickHouse/ClickHouse/issues/11297) が修正されます。[#5732](https://github.com/ClickHouse/ClickHouse/issues/5732) も修正されます。[#6228](https://github.com/ClickHouse/ClickHouse/issues/6228) も修正されます。ユーザビリティの改善: `clickhouse-client` において、例外メッセージとプログレスバーが連結されてしまうことを回避しました。 [#11296](https://github.com/ClickHouse/ClickHouse/pull/11296) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* Protobuf 形式の不正なデータを読み込んだ際にクラッシュする問題を修正しました。これにより [#5957](https://github.com/ClickHouse/ClickHouse/issues/5957)、[#11203](https://github.com/ClickHouse/ClickHouse/issues/11203) が解決されます。[#11258](https://github.com/ClickHouse/ClickHouse/pull/11258)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `cache-dictionary` が（有効期限切れのキーしか存在しない場合に）通常の値ではなくデフォルト値を返してしまうバグを修正しました。これは文字列フィールドのみに影響します。 [#11233](https://github.com/ClickHouse/ClickHouse/pull/11233) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 内部クエリに定数を含む `VIEW` から読み込む際に発生する `Block structure mismatch in QueryPipeline` エラーを修正しました。[#11181](https://github.com/ClickHouse/ClickHouse/issues/11181) の不具合を解決します。[#11205](https://github.com/ClickHouse/ClickHouse/pull/11205)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `Invalid status for associated output` という例外が発生する可能性のある問題を修正しました。 [#11200](https://github.com/ClickHouse/ClickHouse/pull/11200) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `Array(Array(LowCardinality))` 型の引数をキャプチャする高階関数で発生し得る `Cannot capture column` エラーを修正。 [#11185](https://github.com/ClickHouse/ClickHouse/pull/11185) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* キーが 1000 件を超える場合や一部のバックエンドで失敗する可能性があった S3 のグロブ処理を修正しました。[#11179](https://github.com/ClickHouse/ClickHouse/pull/11179) ([Vladimir Chebotarev](https://github.com/excitoon))。
* データスキッピングインデックスが、バックグラウンドマージ中に変更されるカラム（`SummingMergeTree`、`AggregatingMergeTree`、および `TTL GROUP BY` の場合）に依存していると、インデックスが正しく計算されていませんでした。この問題は、マージ完了後にインデックスを計算するように変更し、マージ後のデータに対してインデックスが計算されるようにすることで修正されました。 [#11162](https://github.com/ClickHouse/ClickHouse/pull/11162) ([Azat Khuzhin](https://github.com/azat))。
* 単純なクエリに対してスレッドを過剰に予約してしまう問題を修正しました（パイプラインの変更後に一部動作しなくなっていた、スレッド数削減のための最適化）。 [#11114](https://github.com/ClickHouse/ClickHouse/pull/11114) ([Azat Khuzhin](https://github.com/azat))。
* 分散クエリに対する述語最適化（`enable_optimize_predicate_expression=1`）について、`HAVING` 句を含むクエリ（つまり、イニシエータ側サーバーでのフィルタリングが必要な場合）を、式の順序を保持することで修正し（これだけで修正としては十分）、さらにアグリゲータがインデックスではなくカラム名を使用するように強制しました。修正: [#10613](https://github.com/ClickHouse/ClickHouse/issues/10613), [#11413](https://github.com/ClickHouse/ClickHouse/issues/11413)。[#10621](https://github.com/ClickHouse/ClickHouse/pull/10621)（[Azat Khuzhin](https://github.com/azat)）。
* オフセットのコミットが失敗したまれなケースにおいて Kafka から重複データを取得してしまう可能性を低減するため、コミットの再試行ロジックを導入しました。 [#9884](https://github.com/ClickHouse/ClickHouse/pull/9884) ([filimonov](https://github.com/filimonov)).

#### パフォーマンス改善 {#performance-improvement-14}

- 外部ディクショナリを読み取る関数の各呼び出しごとに、ディクショナリの取得とアクセス権のチェックを1回のみ実行するように変更。[#10928](https://github.com/ClickHouse/ClickHouse/pull/10928) ([Vitaly Baranov](https://github.com/vitlibar))。

#### ビルド/テスト/パッケージング改善 {#buildtestingpackaging-improvement-17}

- 不安定な統合テストを複数修正。[#11355](https://github.com/ClickHouse/ClickHouse/pull/11355) ([alesapin](https://github.com/alesapin))。

### ClickHouse release v20.3.10.75-lts 2020-05-23 {#clickhouse-release-v2031075-lts-2020-05-23}

#### バグ修正 {#bug-fix-41}


* 何も確定されなかった場合には、ミューテーションの確定タスクによるログ出力を行わないようにしました。 [#11109](https://github.com/ClickHouse/ClickHouse/pull/11109) ([alesapin](https://github.com/alesapin)).
* `parseDateTime64BestEffort` の引数解決に関するバグを修正しました。 [#11038](https://github.com/ClickHouse/ClickHouse/pull/11038) ([Vasily Nemkov](https://github.com/Enmk)).
* メソッド `getRawData()` で誤っていた生データサイズを修正しました。 [#10964](https://github.com/ClickHouse/ClickHouse/pull/10964) ([Igr](https://github.com/ObjatieGroba)).
* バージョン 20.1 以前との間で発生していた二段階集約の非互換性を修正しました。この非互換性は、イニシエーターノードとリモートノードで異なるバージョンの ClickHouse が使用されており、かつ `GROUP BY` の結果セットが大きく、単一の `String` フィールドで集約が行われる場合に発生します。この問題により、結果において 1 つのキーに対して複数の未マージ行が生成されていました。[#10952](https://github.com/ClickHouse/ClickHouse/pull/10952) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `Distributed` テーブルにおけるタプルの後方互換性の問題を修正しました。 [#10889](https://github.com/ClickHouse/ClickHouse/pull/10889) ([Anton Popov](https://github.com/CurtizJ)).
* 存在しないキーに対して `StringHashTable` で発生していた `SIGSEGV` を修正しました。 [#10870](https://github.com/ClickHouse/ClickHouse/pull/10870) ([Azat Khuzhin](https://github.com/azat)).
* `ReplicatedMergeTree` において、レプリカが非アクティブになった後もそのレプリカを待ち続けてしまい、`OPTIMIZE` クエリ中の一部の `ALTER` がハングする可能性があったバグを修正しました。[#10849](https://github.com/ClickHouse/ClickHouse/pull/10849) ([tavplubix](https://github.com/tavplubix)).
* `Block::sortColumns()` の後でカラム順が変わらないように修正しました。 [#10826](https://github.com/ClickHouse/ClickHouse/pull/10826) ([Azat Khuzhin](https://github.com/azat)).
* 識別子のクオートを行わないよう指定された場合の `ODBC` ブリッジの問題を修正しました。[#7984](https://github.com/ClickHouse/ClickHouse/issues/7984) を修正。[#10821](https://github.com/ClickHouse/ClickHouse/pull/10821)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `DateLUT` における `UBSan` と `MSan` の報告を修正しました。 [#10798](https://github.com/ClickHouse/ClickHouse/pull/10798) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* キー条件における誤った型変換を修正しました。 [#6287](https://github.com/ClickHouse/ClickHouse/issues/6287) を解決。 [#10791](https://github.com/ClickHouse/ClickHouse/pull/10791) ([Andrew Onyshchuk](https://github.com/oandrew))
* `parallel_view_processing` の動作を修正しました。これにより、例外が発生しても、すべての `MATERIALIZED VIEW` への挿入が途中で中断されることなく完了するようになりました。 [#10241](https://github.com/ClickHouse/ClickHouse/issues/10241) を修正。 [#10757](https://github.com/ClickHouse/ClickHouse/pull/10757) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `-State` と組み合わせた場合のコンビネータ `-OrNull` および `-OrDefault` の不具合を修正しました。 [#10741](https://github.com/ClickHouse/ClickHouse/pull/10741) ([hcz](https://github.com/hczhcz)).
* ネストされた型に対する `generateRandom` のクラッシュを修正しました。 [#10583](https://github.com/ClickHouse/ClickHouse/issues/10583) を解決。 [#10734](https://github.com/ClickHouse/ClickHouse/pull/10734)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* マージ後に発生する可能性があった、`SummingMergeTree` における `LowCardinality(FixedString)` キー列のデータ破損を修正しました。 [#10489](https://github.com/ClickHouse/ClickHouse/issues/10489) を解決。 [#10721](https://github.com/ClickHouse/ClickHouse/pull/10721)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 関数 `h3EdgeAngle` におけるバッファオーバーフローが発生する可能性を修正しました。 [#10711](https://github.com/ClickHouse/ClickHouse/pull/10711) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `totals` が消えてしまう問題を修正しました。クエリに `join`、または外部の `where` 条件を持つサブクエリが含まれている場合に、`totals` がフィルタリングされてしまうことがありました。[#10674](https://github.com/ClickHouse/ClickHouse/issues/10674) を修正。[#10698](https://github.com/ClickHouse/ClickHouse/pull/10698)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 1つのクエリ内で、同一の集合に対して `IN` 演算子を複数回使用しているケースを修正しました。 [#10686](https://github.com/ClickHouse/ClickHouse/pull/10686) ([Anton Popov](https://github.com/CurtizJ)).
* `readonly=2` かつ `cancel_http_readonly_queries_on_client_close=1` の場合に、クライアント切断時に HTTP リクエストがハングしてしまう原因となっていたバグを修正しました。 [#7939](https://github.com/ClickHouse/ClickHouse/issues/7939)、[#7019](https://github.com/ClickHouse/ClickHouse/issues/7019)、[#7736](https://github.com/ClickHouse/ClickHouse/issues/7736)、[#7091](https://github.com/ClickHouse/ClickHouse/issues/7091) を修正。 [#10684](https://github.com/ClickHouse/ClickHouse/pull/10684) ([tavplubix](https://github.com/tavplubix)).
* `AggregateTransform` コンストラクタ内のパラメータの順序を修正しました。 [#10667](https://github.com/ClickHouse/ClickHouse/pull/10667) ([palasonic1](https://github.com/palasonic1)).
* `distributed_aggregation_memory_efficient` を有効にした場合に、リモートクエリが並列実行されない問題を修正しました。[#10655](https://github.com/ClickHouse/ClickHouse/issues/10655) を修正。 [#10664](https://github.com/ClickHouse/ClickHouse/pull/10664)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `LIMIT` を含むクエリで行数が誤っていた可能性のある問題を修正しました。 [#10566](https://github.com/ClickHouse/ClickHouse/issues/10566)、[#10709](https://github.com/ClickHouse/ClickHouse/issues/10709) を修正。 [#10660](https://github.com/ClickHouse/ClickHouse/pull/10660)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* テーブルに多数のパーツがある場合に、同時実行中の `ALTER` がロックされてしまうバグを修正しました。 [#10659](https://github.com/ClickHouse/ClickHouse/pull/10659) ([alesapin](https://github.com/alesapin))。
* `SYSTEM DROP DNS CACHE` クエリの実行時に、特定の IP アドレスからの接続がユーザーに許可されているかを確認するために使用されるキャッシュまで削除されてしまう不具合を修正しました。 [#10608](https://github.com/ClickHouse/ClickHouse/pull/10608) ([tavplubix](https://github.com/tavplubix)).
* `MATERIALIZED VIEW` の内部クエリに依存テーブルが含まれている場合、その内部クエリ内で誤ったスカラ結果が返される問題を修正しました。 [#10603](https://github.com/ClickHouse/ClickHouse/pull/10603) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* デフォルト式の型が列の型と異なる `ALIAS` 列に対する `SELECT` を修正しました。 [#10563](https://github.com/ClickHouse/ClickHouse/pull/10563) ([Azat Khuzhin](https://github.com/azat)).
* DateTime64 と String 値の比較を実装しました。 [#10560](https://github.com/ClickHouse/ClickHouse/pull/10560) ([Vasily Nemkov](https://github.com/Enmk)).
* マージ処理でコンパクトパーツを別のコンパクトパーツに統合した後に、特定のケースで発生する可能性があったインデックス破損を修正しました。 [#10531](https://github.com/ClickHouse/ClickHouse/pull/10531) ([Anton Popov](https://github.com/CurtizJ)).
* すべてのパーツでミューテーションが完了しているにもかかわらず、`is_done=0` の状態のままハングしてしまう問題を修正しました。 [#10526](https://github.com/ClickHouse/ClickHouse/pull/10526) ([alesapin](https://github.com/alesapin)).
* `UTC` からのオフセットに小数を含むタイムゾーンで、Unix エポックの開始時に発生していたオーバーフローを修正しました。これにより [#9335](https://github.com/ClickHouse/ClickHouse/issues/9335) が解決されました。 [#10513](https://github.com/ClickHouse/ClickHouse/pull/10513) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `Distributed` ストレージの不正なシャットダウンを修正しました。 [#10491](https://github.com/ClickHouse/ClickHouse/pull/10491) ([Azat Khuzhin](https://github.com/azat)).
* 大きな整数に対する `simpleLinearRegression` の数値オーバーフローを修正しました。 [#10474](https://github.com/ClickHouse/ClickHouse/pull/10474) ([hcz](https://github.com/hczhcz)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-18}

- LZ4ライブラリのUBSanレポートを修正しました。[#10631](https://github.com/ClickHouse/ClickHouse/pull/10631) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- clang-10ビルドを修正しました。[#10238](https://github.com/ClickHouse/ClickHouse/issues/10238)。[#10370](https://github.com/ClickHouse/ClickHouse/pull/10370) ([Amos Bird](https://github.com/amosbird))。
- `max_rows_to_sort`設定に関する失敗テストを追加しました。[#10268](https://github.com/ClickHouse/ClickHouse/pull/10268) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 入力フォーマットにおける診断情報の出力に関する改善を追加しました。[#10204](https://github.com/ClickHouse/ClickHouse/issues/10204)を修正。[#10418](https://github.com/ClickHouse/ClickHouse/pull/10418) ([tavplubix](https://github.com/tavplubix))。
- clickhouse-server DockerイメージにCA証明書を追加しました。[#10476](https://github.com/ClickHouse/ClickHouse/pull/10476) ([filimonov](https://github.com/filimonov))。

#### バグ修正 {#bug-fix-42}

- エラー`the BloomFilter false positive must be a double number between 0 and 1`を修正しました [#10551](https://github.com/ClickHouse/ClickHouse/issues/10551)。[#10569](https://github.com/ClickHouse/ClickHouse/pull/10569) ([Winter Zhang](https://github.com/zhang2014))。

### ClickHouseリリース v20.3.8.53, 2020-04-23 {#clickhouse-release-v203853-2020-04-23}


#### バグ修正 {#bug-fix-43}

- UTCからの正負のオフセット間で変更されたタイムゾーン(例: Pacific/Kiritimati)における日時関数の誤った動作を修正しました。これにより [#7202](https://github.com/ClickHouse/ClickHouse/issues/7202) が修正されます [#10369](https://github.com/ClickHouse/ClickHouse/pull/10369) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `distributed_group_by_no_merge`が有効な場合に発生する可能性のあるセグメンテーション違反を修正しました(20.3.7.46で [#10131](https://github.com/ClickHouse/ClickHouse/issues/10131) により導入)。[#10399](https://github.com/ClickHouse/ClickHouse/pull/10399) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- `Array(Tuple(...))`データ型の誤ったフラット化を修正しました。これにより [#10259](https://github.com/ClickHouse/ClickHouse/issues/10259) が修正されます [#10390](https://github.com/ClickHouse/ClickHouse/pull/10390) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Aggregatorにおけるディスク予約を削除しました。これにより、正常に完了できる場合でも大規模な外部集約が失敗する可能性があったディスク領域予約のバグが修正されます [#10375](https://github.com/ClickHouse/ClickHouse/pull/10375) ([Azat Khuzhin](https://github.com/azat))
- `ReplicatedMergeTree`における`DROP`と`OPTIMIZE`の競合状態を修正しました。同時に`OPTIMIZE`クエリが実行されている場合、`DROP`がZooKeeper内のレプリカパスにゴミを残す可能性がありました。[#10312](https://github.com/ClickHouse/ClickHouse/pull/10312) ([tavplubix](https://github.com/tavplubix))
- カラムのデフォルト値が変更された後にサーバーがテーブルをアタッチできないバグを修正しました。[#10441](https://github.com/ClickHouse/ClickHouse/pull/10441) ([alesapin](https://github.com/alesapin))
- テーブルのロード前にデータベースのアタッチが失敗した場合、メタデータディレクトリを削除しないようにしました。[#10442](https://github.com/ClickHouse/ClickHouse/pull/10442) ([Winter Zhang](https://github.com/zhang2014))
- クォーラムでデータが挿入された後、何らかの方法(DROP PARTITION、TTL)で削除され、INSERTがスタックしたり、SELECTで誤検知の例外が発生したりする複数のバグを修正しました。これにより [#9946](https://github.com/ClickHouse/ClickHouse/issues/9946) が修正されます [#10188](https://github.com/ClickHouse/ClickHouse/pull/10188) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- リモートクエリで発生する可能性があった`ConcatProcessor`における`Pipeline stuck`エラーを修正しました。[#10381](https://github.com/ClickHouse/ClickHouse/pull/10381) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- バッファからHashMapを読み取ろうとした際にコンパイルエラーを引き起こしていたHashTableの誤った動作を修正しました。[#10386](https://github.com/ClickHouse/ClickHouse/pull/10386) ([palasonic1](https://github.com/palasonic1))
- 複数のJOINで`count(*)`を使用できるようにしました。[#9853](https://github.com/ClickHouse/ClickHouse/issues/9853) を修正します [#10291](https://github.com/ClickHouse/ClickHouse/pull/10291) ([Artem Zuikov](https://github.com/4ertus2))
- `skip_unavailable_shards`よりも`fallback_to_stale_replicas`を優先するようにしました。そうしないと、両方の設定が指定され、最新のレプリカが存在しない場合にクエリが失敗します(@alex-zaitsevによるパッチ)。修正: [#2564](https://github.com/ClickHouse/ClickHouse/issues/2564)。[#10422](https://github.com/ClickHouse/ClickHouse/pull/10422) ([Azat Khuzhin](https://github.com/azat))
- ARRAY JOIN、ORDER BY、LIMITを含むクエリが不完全な結果を返す可能性がある問題を修正しました。これにより [#10226](https://github.com/ClickHouse/ClickHouse/issues/10226) が修正されます。作成者: [Vadim Plakhtinskiy](https://github.com/VadimPlh)。[#10427](https://github.com/ClickHouse/ClickHouse/pull/10427) ([alexey-milovidov](https://github.com/alexey-milovidov))
- BloomFilterインデックスを作成する際に引数の数と型をチェックするようにしました [#9623](https://github.com/ClickHouse/ClickHouse/issues/9623) [#10431](https://github.com/ClickHouse/ClickHouse/pull/10431) ([Winter Zhang](https://github.com/zhang2014))

#### パフォーマンス改善 {#performance-improvement-15}

- `IN`演算子の右側に明示的に定義された集合と左側にタプルを持つクエリのパフォーマンスを改善しました。これによりバージョン20.3でのパフォーマンス低下が修正されます。[#9740](https://github.com/ClickHouse/ClickHouse/pull/9740), [#10385](https://github.com/ClickHouse/ClickHouse/pull/10385) ([Anton Popov](https://github.com/CurtizJ))

### ClickHouseリリース v20.3.7.46, 2020-04-17 {#clickhouse-release-v203746-2020-04-17}

#### バグ修正 {#bug-fix-44}

- カンマ結合と名前付き結合が混在するクエリで発生する`Logical error: CROSS JOIN has expressions`エラーを修正しました。[#10311](https://github.com/ClickHouse/ClickHouse/pull/10311) ([Artem Zuikov](https://github.com/4ertus2))
- `max_bytes_before_external_group_by`を使用したクエリの問題を修正しました。[#10302](https://github.com/ClickHouse/ClickHouse/pull/10302) ([Artem Zuikov](https://github.com/4ertus2))
- arrayJoin関数が存在する場合(特定のケース)のmove-to-prewhere最適化を修正しました。これにより[#10092](https://github.com/ClickHouse/ClickHouse/issues/10092)が修正されます。[#10195](https://github.com/ClickHouse/ClickHouse/pull/10195) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `allow_nondeterministic_mutations`設定により、ミューテーションにおける非決定的関数の使用制限を緩和する機能を追加しました。[#10186](https://github.com/ClickHouse/ClickHouse/pull/10186) ([filimonov](https://github.com/filimonov))

### ClickHouseリリース v20.3.6.40, 2020-04-16 {#clickhouse-release-v203640-2020-04-16}

#### 新機能 {#new-feature-10}

- `isConstant`関数を追加しました。この関数は引数が定数式であるかどうかをチェックし、1または0を返します。開発、デバッグ、デモンストレーション目的での使用を想定しています。[#10198](https://github.com/ClickHouse/ClickHouse/pull/10198) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### バグ修正 {#bug-fix-45}


* `max_rows_to_group_by` と `group_by_overflow_mode = 'break'` を使用している場合に発生する `Pipeline stuck` エラーを修正。 [#10279](https://github.com/ClickHouse/ClickHouse/pull/10279) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* まれに発生する可能性のある例外 `Cannot drain connections: cancel first` を修正しました。 [#10239](https://github.com/ClickHouse/ClickHouse/pull/10239) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* ClickHouse が ENGINE = Replicated* のテーブルに対してユーザーが ALTER UPDATE / DELETE を実行しようとした際に、「Unknown function lambda.」というエラーメッセージが出力されてしまうバグを修正しました。非決定的関数のチェックで、lambda 式が正しく扱われるようになりました。[#10237](https://github.com/ClickHouse/ClickHouse/pull/10237) ([Alexander Kazakov](https://github.com/Akazz))。
* Date 型に対する `generateRandom` 関数を修正しました。これにより [#9973](https://github.com/ClickHouse/ClickHouse/issues/9973) が解決されます。年 2106 の日付を旧式のパーティション方式を用いる MergeTree テーブルに挿入した際、パーティション名が年 1970 になってしまうケースという、端的な例外的ケースを修正しました。 [#10218](https://github.com/ClickHouse/ClickHouse/pull/10218) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* View のテーブル定義が SELECT クエリと一致しない場合に型を変換するようにしました。これにより [#10180](https://github.com/ClickHouse/ClickHouse/issues/10180) と [#10022](https://github.com/ClickHouse/ClickHouse/issues/10022) が修正されます。 [#10217](https://github.com/ClickHouse/ClickHouse/pull/10217)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 曜日が火曜日または木曜日の場合の RFC-2822 形式の文字列に対する `parseDateTimeBestEffort` の不具合を修正しました。これにより [#10082](https://github.com/ClickHouse/ClickHouse/issues/10082) が解決されています。 [#10214](https://github.com/ClickHouse/ClickHouse/pull/10214) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* JOIN の内側にある定数の列名が JOIN の外側にある定数の列名と衝突する可能性がある場合に備えて、それらを修正するようにしました。 [#10207](https://github.com/ClickHouse/ClickHouse/pull/10207) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `system.numbers` や `system.zeros` のような無限ソースから読み込む際、本来は `LIMIT` で停止すべきクエリが、無限に実行され続けてしまう可能性のある問題を修正しました。 [#10206](https://github.com/ClickHouse/ClickHouse/pull/10206) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* データベースが指定されていない場合に、アクセスチェックで現在のデータベースを使用するよう修正。 [#10192](https://github.com/ClickHouse/ClickHouse/pull/10192) ([Vitaly Baranov](https://github.com/vitlibar)).
* Distributed() への INSERT 時に構造が一致しない場合に、ブロックを変換するようにしました。 [#10135](https://github.com/ClickHouse/ClickHouse/pull/10135) ([Azat Khuzhin](https://github.com/azat)).
* プロセッサーパイプラインにおける `extremes` の結果が誤ってしまう可能性のある問題を修正しました。 [#10131](https://github.com/ClickHouse/ClickHouse/pull/10131) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* コンパクトパーツに対する一部の種類の `ALTER` を修正しました。 [#10130](https://github.com/ClickHouse/ClickHouse/pull/10130) ([Anton Popov](https://github.com/CurtizJ))。
* 新しいレプリカを作成する際の `index_granularity_bytes` の誤ったチェックを修正。 [#10098](https://github.com/ClickHouse/ClickHouse/issues/10098) を修正。 [#10121](https://github.com/ClickHouse/ClickHouse/pull/10121)（[alesapin](https://github.com/alesapin)）。
* 基盤となるテーブルと構造が異なる `Distributed` テーブルへの `INSERT` 時に発生する `SIGSEGV` を修正。 [#10105](https://github.com/ClickHouse/ClickHouse/pull/10105) ([Azat Khuzhin](https://github.com/azat))。
* `JOIN` と `UNION ALL` を含むクエリで発生しうる行の欠損を修正。[#9826](https://github.com/ClickHouse/ClickHouse/issues/9826)、[#10113](https://github.com/ClickHouse/ClickHouse/issues/10113) を修正。[#10099](https://github.com/ClickHouse/ClickHouse/pull/10099)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 古い ClickHouse バージョンからアップデートした際に `/table/replicas/replica_name/metadata` ノードが存在しない場合の、レプリケートテーブルの起動処理を修正しました。 [#10037](https://github.com/ClickHouse/ClickHouse/issues/10037) を修正。 [#10095](https://github.com/ClickHouse/ClickHouse/pull/10095)（[alesapin](https://github.com/alesapin)）。
* いくつかの引数チェックを追加し、MySQL Database Engine で識別子引数をサポートしました。 [#10077](https://github.com/ClickHouse/ClickHouse/pull/10077) ([Winter Zhang](https://github.com/zhang2014)).
* ローカルホストの ClickHouse サーバーを ClickHouse ディクショナリのソースとして使用する場合のバグを修正しました。ディクショナリとソースの型が互換性のない場合、このバグによりメモリ破損が発生する可能性がありました。[#10071](https://github.com/ClickHouse/ClickHouse/pull/10071) ([alesapin](https://github.com/alesapin)).
* `CHECK TABLE` クエリで、テーブルにスキップインデックスが含まれている場合のバグを修正しました。 [#10068](https://github.com/ClickHouse/ClickHouse/pull/10068) ([alesapin](https://github.com/alesapin))。
* エラー `Cannot clone block with columns because block has 0 columns ... While executing GroupingAggregatedTransform` を修正。このエラーは、`distributed_aggregation_memory_efficient` 設定を有効にした状態で、分散クエリが異なるシャードから集約レベルの異なるデータ（単一レベル集約と二段階集約が混在）を読み込んだ場合に発生していました。 [#10063](https://github.com/ClickHouse/ClickHouse/pull/10063) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 末尾にゼロバイトを含む文字列キーに対する `GROUP BY` で発生する可能性があったセグメンテーションフォールトを修正しました（[#8636](https://github.com/ClickHouse/ClickHouse/issues/8636)、[#8925](https://github.com/ClickHouse/ClickHouse/issues/8925)）。[#10025](https://github.com/ClickHouse/ClickHouse/pull/10025)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* リモートクエリ実行に使用されるスレッド数を修正しました（20.3 以降に発生していたパフォーマンス低下）。これは、`Distributed` テーブルからのクエリがローカルシャードとリモートシャードの両方で同時に実行されていた場合に発生していました。[#9965](https://github.com/ClickHouse/ClickHouse/issues/9965) を修正しました。[#9971](https://github.com/ClickHouse/ClickHouse/pull/9971)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 一部のデータベースへのクエリ処理のある段階で、必要なテーブルが取得されていなかったバグを修正。 [#9699](https://github.com/ClickHouse/ClickHouse/issues/9699) を修正。 [#9949](https://github.com/ClickHouse/ClickHouse/pull/9949) ([achulkov2](https://github.com/achulkov2))。
* `JOIN` が `TOTALS` とともに使用された場合に発生する「Not found column in block」エラーを修正。[#9839](https://github.com/ClickHouse/ClickHouse/issues/9839) を修正。[#9939](https://github.com/ClickHouse/ClickHouse/pull/9939)（[Artem Zuikov](https://github.com/4ertus2)）。
* サーバー起動時に `ON CLUSTER` DDL クエリがフリーズする不具合を修正しました。 [#9927](https://github.com/ClickHouse/ClickHouse/pull/9927) ([Gagan Arneja](https://github.com/garneja)).
* `CREATE USER` コマンドで複数のホストを指定した際の解析処理を修正しました。例: `CREATE USER user6 HOST NAME REGEXP 'lo.?*host', NAME REGEXP 'lo*host'`。 [#9924](https://github.com/ClickHouse/ClickHouse/pull/9924) ([Vitaly Baranov](https://github.com/vitlibar))。
* Join テーブルエンジンに対する `TRUNCATE` を修正（[#9917](https://github.com/ClickHouse/ClickHouse/issues/9917)）。[#9920](https://github.com/ClickHouse/ClickHouse/pull/9920)（[Amos Bird](https://github.com/amosbird)）。
* ALTER で発生する「scalar does not exist」エラーを修正（[#9878](https://github.com/ClickHouse/ClickHouse/issues/9878)）。 [#9904](https://github.com/ClickHouse/ClickHouse/pull/9904)（[Amos Bird](https://github.com/amosbird)）。
* `ReplicatedMergeTree` における DROP と OPTIMIZE 間のレースコンディションを修正。 [#9901](https://github.com/ClickHouse/ClickHouse/pull/9901) ([alesapin](https://github.com/alesapin))。
* `distributed_product_mode='local'` における修飾名の誤りを修正。 [#4756](https://github.com/ClickHouse/ClickHouse/issues/4756) を修正。 [#9891](https://github.com/ClickHouse/ClickHouse/pull/9891) ([Artem Zuikov](https://github.com/4ertus2)).
* 設定 &#39;allow&#95;introspection&#95;functions&#39; に基づくイントロスペクション関数の権限計算を修正。[#9840](https://github.com/ClickHouse/ClickHouse/pull/9840) ([Vitaly Baranov](https://github.com/vitlibar)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-19}

- 統合テスト `test_settings_constraints` を修正。[#9962](https://github.com/ClickHouse/ClickHouse/pull/9962) ([Vitaly Baranov](https://github.com/vitlibar))。
- `clock_getres` への依存関係を削除。[#9833](https://github.com/ClickHouse/ClickHouse/pull/9833) ([alexey-milovidov](https://github.com/alexey-milovidov))。

### ClickHouse リリース v20.3.5.21, 2020-03-27 {#clickhouse-release-v203521-2020-03-27}

#### バグ修正 {#bug-fix-46}

- 分散テーブルに対してクエリがPREWHEREとWHEREを持ち、`SET distributed_product_mode = 'local'` が設定されている場合の「同じエイリアスを持つ異なる式」エラーを修正。[#9871](https://github.com/ClickHouse/ClickHouse/pull/9871) ([Artem Zuikov](https://github.com/4ertus2))。
- 複合主キーを持つテーブルでのミューテーションの過剰なメモリ消費を修正。これは [#9850](https://github.com/ClickHouse/ClickHouse/issues/9850) を修正します。[#9860](https://github.com/ClickHouse/ClickHouse/pull/9860) ([alesapin](https://github.com/alesapin))。
- INSERTクエリにおいて、シャードは例外をスローする代わりに、イニシエーターから取得した設定をシャードの制約に合わせて調整するようになりました。この修正により、異なる制約を持つシャードにINSERTクエリを送信できるようになります。この変更は [#9447](https://github.com/ClickHouse/ClickHouse/issues/9447) の修正を改善します。[#9852](https://github.com/ClickHouse/ClickHouse/pull/9852) ([Vitaly Baranov](https://github.com/vitlibar))。
- テーブルリスト外（つまりWHERE句内）でCOMMA JOINを使用するサブクエリの場合の「COMMA to CROSS JOIN rewriterが有効でないか、クエリを書き換えられません」エラーを修正。[#9782](https://github.com/ClickHouse/ClickHouse/issues/9782) を修正します。[#9830](https://github.com/ClickHouse/ClickHouse/pull/9830) ([Artem Zuikov](https://github.com/4ertus2))。
- クライアントで発生する可能性のある例外 `Got 0 in totals chunk, expected 1` を修正。これは、右結合テーブルが0行の場合に `JOIN` を含むクエリで発生していました。例: `select * from system.one t1 join system.one t2 on t1.dummy = t2.dummy limit 0 FORMAT TabSeparated;`。[#9777](https://github.com/ClickHouse/ClickHouse/issues/9777) を修正します。[#9823](https://github.com/ClickHouse/ClickHouse/pull/9823) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 型を変換できない場合のoptimize_skip_unused_shardsでのSIGSEGVを修正。[#9804](https://github.com/ClickHouse/ClickHouse/pull/9804) ([Azat Khuzhin](https://github.com/azat))。
- コンパクトパーツに対する `ALTER TABLE DELETE COLUMN` クエリの不具合を修正。[#9779](https://github.com/ClickHouse/ClickHouse/pull/9779) ([alesapin](https://github.com/alesapin))。
- max_distributed_connectionsを修正（Processorsありおよびなし）。[#9673](https://github.com/ClickHouse/ClickHouse/pull/9673) ([Azat Khuzhin](https://github.com/azat))。
- 関数引数のタイムゾーンが適切に使用されていなかったいくつかのケースを修正。[#9574](https://github.com/ClickHouse/ClickHouse/pull/9574) ([Vasily Nemkov](https://github.com/Enmk))。

#### 改善 {#improvement-19}

- 単一のスレッドで単一の順序付けされたパーツから読み取るため、ミューテーションからorder byステージを削除。また、ミューテーション内の行の順序がソートキーの順序で並んでおり、この順序が違反されていないことを確認するチェックを追加。[#9886](https://github.com/ClickHouse/ClickHouse/pull/9886) ([alesapin](https://github.com/alesapin))。

### ClickHouse リリース v20.3.4.10, 2020-03-20 {#clickhouse-release-v203410-2020-03-20}


#### バグ修正 {#bug-fix-47}

- このリリースには20.1.8.41のすべてのバグ修正も含まれています
- HTTP経由のクエリ（プロセッサパイプライン使用時）で`rows_before_limit_at_least`が欠落していた問題を修正しました。これにより[#9730](https://github.com/ClickHouse/ClickHouse/issues/9730)が修正されます。[#9757](https://github.com/ClickHouse/ClickHouse/pull/9757) ([Nikolai Kochetov](https://github.com/KochetovNicolai))

### ClickHouseリリース v20.3.3.6, 2020-03-17 {#clickhouse-release-v20336-2020-03-17}

#### バグ修正 {#bug-fix-48}

- このリリースには20.1.7.38のすべてのバグ修正も含まれています
- 以前のバージョンでユーザーがミューテーションを実行した場合にレプリケーションが動作しなくなるバグを修正しました。これにより[#9645](https://github.com/ClickHouse/ClickHouse/issues/9645)が修正されます。[#9652](https://github.com/ClickHouse/ClickHouse/pull/9652) ([alesapin](https://github.com/alesapin))。これによりバージョン20.3が再び後方互換性を持つようになります。
- `Distributed`テーブルへの`INSERT`クエリのファイルをよりコンパクトな形式で書き込むことを可能にする設定`use_compact_format_in_distributed_parts_names`を追加しました。これにより[#9647](https://github.com/ClickHouse/ClickHouse/issues/9647)が修正されます。[#9653](https://github.com/ClickHouse/ClickHouse/pull/9653) ([alesapin](https://github.com/alesapin))。これによりバージョン20.3が再び後方互換性を持つようになります。

### ClickHouseリリース v20.3.2.1, 2020-03-12 {#clickhouse-release-v20321-2020-03-12}

#### 後方互換性のない変更 {#backward-incompatible-change-9}


* 多数のレプリカに対して `Distributed` テーブルへデータを送信する際に発生していた `file name too long` の問題を修正しました。レプリカの認証情報がサーバーログに露出してしまう問題も修正しました。ディスク上のディレクトリ名の形式は `[shard{shard_index}[_replica{replica_index}]]` に変更されました。 [#8911](https://github.com/ClickHouse/ClickHouse/pull/8911) ([Mikhail Korotov](https://github.com/millb)) 新しいバージョンにアップグレードすると、古いサーバーバージョンは新しいディレクトリ形式を認識できないため、手動での対応なしにダウングレードすることはできません。ダウングレードする場合は、該当するディレクトリを手動で旧形式にリネームする必要があります。この変更が影響するのは、`Distributed` テーブルへの非同期 `INSERT` を使用していた場合のみです。バージョン 20.3.3 では、新しい形式を段階的に有効化できる設定を導入する予定です。
* `mutation` コマンドに対するレプリケーションログエントリの形式を変更しました。新しいバージョンをインストールする前に、古い `mutation` の処理が完了するまで待つ必要があります。
* ソフト割り当て上限に対して N バイトごとにスタックトレースを `system.trace_log` にダンプするシンプルなメモリプロファイラを実装しました [#8765](https://github.com/ClickHouse/ClickHouse/pull/8765) ([Ivan](https://github.com/abyss7)) [#9472](https://github.com/ClickHouse/ClickHouse/pull/9472) ([alexey-milovidov](https://github.com/alexey-milovidov))。`system.trace_log` のカラム名は `timer_type` から `trace_type` に変更されました。これにより、サードパーティ製のパフォーマンス解析および flamegraph 処理ツールの変更が必要になります。
* 内部スレッド番号の代わりに、あらゆる箇所で OS のスレッド ID を使用するようにしました。これにより、[#7477](https://github.com/ClickHouse/ClickHouse/issues/7477) が修正されます。古い `clickhouse-client` は、設定 `send_logs_level` が有効になっている場合、サーバーから送信されるログを受信できません。これは、構造化ログメッセージの名前と型が変更されたためです。一方で、サーバーのバージョンが異なると、互いに異なる型のログを送り合う可能性があります。`send_logs_level` 設定を使用していない場合は、気にする必要はありません。[#8954](https://github.com/ClickHouse/ClickHouse/pull/8954) ([alexey-milovidov](https://github.com/alexey-milovidov))
* `indexHint` 関数を削除する [#9542](https://github.com/ClickHouse/ClickHouse/pull/9542) ([alexey-milovidov](https://github.com/alexey-milovidov))
* `findClusterIndex`、`findClusterValue` 関数を削除しました。これにより [#8641](https://github.com/ClickHouse/ClickHouse/issues/8641) が修正されます。これらの関数を使用していた場合は、`clickhouse-feedback@yandex-team.com` 宛にメールを送ってください [#9543](https://github.com/ClickHouse/ClickHouse/pull/9543) ([alexey-milovidov](https://github.com/alexey-milovidov))
* `SELECT` サブクエリをデフォルト式として使用して列を作成または追加することは、現在は許可されていません。 [#9481](https://github.com/ClickHouse/ClickHouse/pull/9481) ([alesapin](https://github.com/alesapin))
* `JOIN` の副問い合わせにエイリアス指定を必須化。 [#9274](https://github.com/ClickHouse/ClickHouse/pull/9274) ([Artem Zuikov](https://github.com/4ertus2))
* `ALTER MODIFY/ADD` クエリのロジックを改善しました。これにより、型を指定せずにカラムを `ADD` することはできず、`MODIFY` でデフォルト式を変更してもカラムの型は変わらず、`MODIFY` で型を変更してもデフォルト式の値は失われません。[#8669](https://github.com/ClickHouse/ClickHouse/issues/8669) を修正。[#9227](https://github.com/ClickHouse/ClickHouse/pull/9227)（[alesapin](https://github.com/alesapin)）
* ロギング設定の変更を反映させるには、サーバーの再起動が必要になりました。これは、サーバーが削除されたログファイルにログを書き込み続けてしまうバグを回避するための一時的なワークアラウンドです（[#8696](https://github.com/ClickHouse/ClickHouse/issues/8696) を参照）。[#8707](https://github.com/ClickHouse/ClickHouse/pull/8707)（[Alexander Kuzmenkov](https://github.com/akuzm)）
* `experimental_use_processors` 設定はデフォルトで有効になっています。この設定により、新しいクエリパイプラインが使用されます。これは内部的なリファクタリングであり、外部から見える変更はない想定です。もし何らかの問題が発生した場合は、値を 0 に戻してください。 [#8768](https://github.com/ClickHouse/ClickHouse/pull/8768) ([alexey-milovidov](https://github.com/alexey-milovidov))





#### 新機能 {#new-feature-11}

- `Avro`および`AvroConfluent`入出力フォーマットを追加 [#8571](https://github.com/ClickHouse/ClickHouse/pull/8571) ([Andrew Onyshchuk](https://github.com/oandrew)) [#8957](https://github.com/ClickHouse/ClickHouse/pull/8957) ([Andrew Onyshchuk](https://github.com/oandrew)) [#8717](https://github.com/ClickHouse/ClickHouse/pull/8717) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `cache`ディクショナリにおける期限切れキーのマルチスレッド・非ブロッキング更新(古いキーの読み取り許可をオプションで設定可能)。[#8303](https://github.com/ClickHouse/ClickHouse/pull/8303) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- `ALTER ... MATERIALIZE TTL`クエリを追加。TTLによって期限切れデータを強制的に削除し、すべてのパートでTTLに関するメタ情報を再計算するミューテーションを実行します。[#8775](https://github.com/ClickHouse/ClickHouse/pull/8775) ([Anton Popov](https://github.com/CurtizJ))
- 必要に応じてHashJoinからMergeJoin(ディスク上)に切り替え [#9082](https://github.com/ClickHouse/ClickHouse/pull/9082) ([Artem Zuikov](https://github.com/4ertus2))
- `ALTER TABLE`に`MOVE PARTITION`コマンドを追加 [#4729](https://github.com/ClickHouse/ClickHouse/issues/4729) [#6168](https://github.com/ClickHouse/ClickHouse/pull/6168) ([Guillaume Tassery](https://github.com/YiuRULE))
- 設定ファイルからストレージ設定を動的に再読み込み。[#8594](https://github.com/ClickHouse/ClickHouse/pull/8594) ([Vladimir Chebotarev](https://github.com/excitoon))
- `storage_policy`をより柔軟なものに変更可能に。[#8107](https://github.com/ClickHouse/ClickHouse/pull/8107) ([Vladimir Chebotarev](https://github.com/excitoon))
- S3ストレージおよびテーブル関数にグロブ/ワイルドカードのサポートを追加。[#8851](https://github.com/ClickHouse/ClickHouse/pull/8851) ([Vladimir Chebotarev](https://github.com/excitoon))
- `FixedString(N)`データ型に対して`bitAnd`、`bitOr`、`bitXor`、`bitNot`を実装。[#9091](https://github.com/ClickHouse/ClickHouse/pull/9091) ([Guillaume Tassery](https://github.com/YiuRULE))
- `bitCount`関数を追加。これにより [#8702](https://github.com/ClickHouse/ClickHouse/issues/8702) を修正。[#8708](https://github.com/ClickHouse/ClickHouse/pull/8708) ([alexey-milovidov](https://github.com/alexey-milovidov)) [#8749](https://github.com/ClickHouse/ClickHouse/pull/8749) ([ikopylov](https://github.com/ikopylov))
- 指定されたスキーマでランダムな行を生成する`generateRandom`テーブル関数を追加。任意のテストテーブルにデータを投入できます。[#8994](https://github.com/ClickHouse/ClickHouse/pull/8994) ([Ilya Yatsishin](https://github.com/qoega))
- `JSONEachRowFormat`: トップレベル配列内にオブジェクトが含まれる特殊ケースをサポート。[#8860](https://github.com/ClickHouse/ClickHouse/pull/8860) ([Kruglov Pavel](https://github.com/Avogar))
- デフォルトで`ALIAS`式を持つカラムに依存する`DEFAULT`式を持つカラムの作成が可能に。[#9489](https://github.com/ClickHouse/ClickHouse/pull/9489) ([alesapin](https://github.com/alesapin))
- `clickhouse-obfuscator`でソースデータサイズを超える`--limit`の指定が可能に。データは異なるランダムシードで繰り返されます。[#9155](https://github.com/ClickHouse/ClickHouse/pull/9155) ([alexey-milovidov](https://github.com/alexey-milovidov))
- リザーバーサンプリングアルゴリズムを使用した`groupArraySample`関数(`groupArray`に類似)を追加。[#8286](https://github.com/ClickHouse/ClickHouse/pull/8286) ([Amos Bird](https://github.com/amosbird))
- システムメトリクスを通じて`cache`/`complex_key_cache`ディクショナリの更新キューサイズを監視可能に。[#9413](https://github.com/ClickHouse/ClickHouse/pull/9413) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- 設定`output_format_csv_crlf_end_of_line`を1に設定することで、CSV出力フォーマットで行区切り文字としてCRLFを使用可能に [#8934](https://github.com/ClickHouse/ClickHouse/pull/8934) [#8935](https://github.com/ClickHouse/ClickHouse/pull/8935) [#8963](https://github.com/ClickHouse/ClickHouse/pull/8963) ([Mikhail Korotov](https://github.com/millb))
- [H3](https://github.com/uber/h3) APIのより多くの関数を実装: `h3GetBaseCell`、`h3HexAreaM2`、`h3IndexesAreNeighbors`、`h3ToChildren`、`h3ToString`、`stringToH3` [#8938](https://github.com/ClickHouse/ClickHouse/pull/8938) ([Nico Mandery](https://github.com/nmandery))
- 新しい設定を導入: `max_parser_depth`で最大スタックサイズを制御し、大規模で複雑なクエリを可能に。これにより [#6681](https://github.com/ClickHouse/ClickHouse/issues/6681) および [#7668](https://github.com/ClickHouse/ClickHouse/issues/7668) を修正。[#8647](https://github.com/ClickHouse/ClickHouse/pull/8647) ([Maxim Smirnov](https://github.com/qMBQx8GH))
- 未使用シャードのスキップが不可能な場合に例外をスローする設定`force_optimize_skip_unused_shards`を追加 [#8805](https://github.com/ClickHouse/ClickHouse/pull/8805) ([Azat Khuzhin](https://github.com/azat))
- `Distributed`エンジンで送信用データを保存するための複数のディスク/ボリュームの設定が可能に [#8756](https://github.com/ClickHouse/ClickHouse/pull/8756) ([Azat Khuzhin](https://github.com/azat))
- 一時データを保存するためのストレージポリシー(`<tmp_policy>`)をサポート。[#8750](https://github.com/ClickHouse/ClickHouse/pull/8750) ([Azat Khuzhin](https://github.com/azat))
- データ送信前に例外がスローされた場合に設定される`X-ClickHouse-Exception-Code` HTTPヘッダーを追加。これにより [#4971](https://github.com/ClickHouse/ClickHouse/issues/4971) を実装。[#8786](https://github.com/ClickHouse/ClickHouse/pull/8786) ([Mikhail Korotov](https://github.com/millb))
- `ifNotFinite`関数を追加。これは単なる構文糖衣です: `ifNotFinite(x, y) = isFinite(x) ? x : y`。[#8710](https://github.com/ClickHouse/ClickHouse/pull/8710) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `system.dictionaries`テーブルに`last_successful_update_time`カラムを追加 [#9394](https://github.com/ClickHouse/ClickHouse/pull/9394) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- `blockSerializedSize`関数を追加(圧縮なしのディスク上のサイズ) [#8952](https://github.com/ClickHouse/ClickHouse/pull/8952) ([Azat Khuzhin](https://github.com/azat))
- `moduloOrZero`関数を追加 [#9358](https://github.com/ClickHouse/ClickHouse/pull/9358) ([hcz](https://github.com/hczhcz))
- システムテーブル`system.zeros`および`system.zeros_mt`、ならびにテーブル関数`zeros()`および`zeros_mt()`を追加。テーブル(およびテーブル関数)には`zero`という名前で`UInt8`型の単一カラムが含まれます。このカラムにはゼロが格納されます。多数の行を生成する最速の方法として、テスト目的で必要です。これにより [#6604](https://github.com/ClickHouse/ClickHouse/issues/6604) を修正 [#9593](https://github.com/ClickHouse/ClickHouse/pull/9593) ([Nikolai Kochetov](https://github.com/KochetovNicolai))

#### 実験的機能 {#experimental-feature-7}

- `MergeTree`ファミリーテーブルに、すべてのカラムを1つのファイルに格納する新しいコンパクト形式のパートを追加しました。これにより、小規模で頻繁な挿入のパフォーマンスが向上します。従来の形式(カラムごとに1ファイル)は現在ワイド形式と呼ばれています。データ格納形式は`min_bytes_for_wide_part`および`min_rows_for_wide_part`の設定によって制御されます。[#8290](https://github.com/ClickHouse/ClickHouse/pull/8290) ([Anton Popov](https://github.com/CurtizJ))
- `Log`、`TinyLog`、`StripeLog`テーブルに対するS3ストレージのサポートを追加しました。[#8862](https://github.com/ClickHouse/ClickHouse/pull/8862) ([Pavel Kovalenko](https://github.com/Jokser))


#### バグ修正 {#bug-fix-49}

- Fixed inconsistent whitespaces in log messages. [#9322](https://github.com/ClickHouse/ClickHouse/pull/9322) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix bug in which arrays of unnamed tuples were flattened as Nested structures on table creation. [#8866](https://github.com/ClickHouse/ClickHouse/pull/8866) ([achulkov2](https://github.com/achulkov2))
- Fixed the issue when "Too many open files" error may happen if there are too many files matching glob pattern in `File` table or `file` table function. Now files are opened lazily. This fixes [#8857](https://github.com/ClickHouse/ClickHouse/issues/8857) [#8861](https://github.com/ClickHouse/ClickHouse/pull/8861) ([alexey-milovidov](https://github.com/alexey-milovidov))
- DROP TEMPORARY TABLE now drops only temporary table. [#8907](https://github.com/ClickHouse/ClickHouse/pull/8907) ([Vitaly Baranov](https://github.com/vitlibar))
- Remove outdated partition when we shutdown the server or DETACH/ATTACH a table. [#8602](https://github.com/ClickHouse/ClickHouse/pull/8602) ([Guillaume Tassery](https://github.com/YiuRULE))
- For how the default disk calculates the free space from `data` subdirectory. Fixed the issue when the amount of free space is not calculated correctly if the `data` directory is mounted to a separate device (rare case). This fixes [#7441](https://github.com/ClickHouse/ClickHouse/issues/7441) [#9257](https://github.com/ClickHouse/ClickHouse/pull/9257) ([Mikhail Korotov](https://github.com/millb))
- Allow comma (cross) join with IN () inside. [#9251](https://github.com/ClickHouse/ClickHouse/pull/9251) ([Artem Zuikov](https://github.com/4ertus2))
- Allow to rewrite CROSS to INNER JOIN if there's [NOT] LIKE operator in WHERE section. [#9229](https://github.com/ClickHouse/ClickHouse/pull/9229) ([Artem Zuikov](https://github.com/4ertus2))
- Fix possible incorrect result after `GROUP BY` with enabled setting `distributed_aggregation_memory_efficient`. Fixes [#9134](https://github.com/ClickHouse/ClickHouse/issues/9134). [#9289](https://github.com/ClickHouse/ClickHouse/pull/9289) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Found keys were counted as missed in metrics of cache dictionaries. [#9411](https://github.com/ClickHouse/ClickHouse/pull/9411) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Fix replication protocol incompatibility introduced in [#8598](https://github.com/ClickHouse/ClickHouse/issues/8598). [#9412](https://github.com/ClickHouse/ClickHouse/pull/9412) ([alesapin](https://github.com/alesapin))
- Fixed race condition on `queue_task_handle` at the startup of `ReplicatedMergeTree` tables. [#9552](https://github.com/ClickHouse/ClickHouse/pull/9552) ([alexey-milovidov](https://github.com/alexey-milovidov))
- The token `NOT` did not work in `SHOW TABLES NOT LIKE` query [#8727](https://github.com/ClickHouse/ClickHouse/issues/8727) [#8940](https://github.com/ClickHouse/ClickHouse/pull/8940) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added range check to function `h3EdgeLengthM`. Without this check, buffer overflow is possible. [#8945](https://github.com/ClickHouse/ClickHouse/pull/8945) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed up a bug in batched calculations of ternary logical OPs on multiple arguments (more than 10). [#8718](https://github.com/ClickHouse/ClickHouse/pull/8718) ([Alexander Kazakov](https://github.com/Akazz))
- Fix error of PREWHERE optimization, which could lead to segfaults or `Inconsistent number of columns got from MergeTreeRangeReader` exception. [#9024](https://github.com/ClickHouse/ClickHouse/pull/9024) ([Anton Popov](https://github.com/CurtizJ))
- Fix unexpected `Timeout exceeded while reading from socket` exception, which randomly happens on secure connection before timeout actually exceeded and when query profiler is enabled. Also add `connect_timeout_with_failover_secure_ms` settings (default 100ms), which is similar to `connect_timeout_with_failover_ms`, but is used for secure connections (because SSL handshake is slower, than ordinary TCP connection) [#9026](https://github.com/ClickHouse/ClickHouse/pull/9026) ([tavplubix](https://github.com/tavplubix))
- Fix bug with mutations finalization, when mutation may hang in state with `parts_to_do=0` and `is_done=0`. [#9022](https://github.com/ClickHouse/ClickHouse/pull/9022) ([alesapin](https://github.com/alesapin))
- Use new ANY JOIN logic with `partial_merge_join` setting. It's possible to make `ANY|ALL|SEMI LEFT` and `ALL INNER` joins with `partial_merge_join=1` now. [#8932](https://github.com/ClickHouse/ClickHouse/pull/8932) ([Artem Zuikov](https://github.com/4ertus2))
- Shard now clamps the settings got from the initiator to the shard's constaints instead of throwing an exception. This fix allows to send queries to a shard with another constraints. [#9447](https://github.com/ClickHouse/ClickHouse/pull/9447) ([Vitaly Baranov](https://github.com/vitlibar))
- Fixed memory management problem in `MergeTreeReadPool`. [#8791](https://github.com/ClickHouse/ClickHouse/pull/8791) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix `toDecimal*OrNull()` functions family when called with string `e`. Fixes [#8312](https://github.com/ClickHouse/ClickHouse/issues/8312) [#8764](https://github.com/ClickHouse/ClickHouse/pull/8764) ([Artem Zuikov](https://github.com/4ertus2))
- Make sure that `FORMAT Null` sends no data to the client. [#8767](https://github.com/ClickHouse/ClickHouse/pull/8767) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Fix bug that timestamp in `LiveViewBlockInputStream` will not updated. `LIVE VIEW` is an experimental feature. [#8644](https://github.com/ClickHouse/ClickHouse/pull/8644) ([vxider](https://github.com/Vxider)) [#8625](https://github.com/ClickHouse/ClickHouse/pull/8625) ([vxider](https://github.com/Vxider))
- Fixed `ALTER MODIFY TTL` wrong behavior which did not allow to delete old TTL expressions. [#8422](https://github.com/ClickHouse/ClickHouse/pull/8422) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fixed UBSan report in MergeTreeIndexSet. This fixes [#9250](https://github.com/ClickHouse/ClickHouse/issues/9250) [#9365](https://github.com/ClickHouse/ClickHouse/pull/9365) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed the behaviour of `match` and `extract` functions when haystack has zero bytes. The behaviour was wrong when haystack was constant. This fixes [#9160](https://github.com/ClickHouse/ClickHouse/issues/9160) [#9163](https://github.com/ClickHouse/ClickHouse/pull/9163) ([alexey-milovidov](https://github.com/alexey-milovidov)) [#9345](https://github.com/ClickHouse/ClickHouse/pull/9345) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Avoid throwing from destructor in Apache Avro 3rd-party library. [#9066](https://github.com/ClickHouse/ClickHouse/pull/9066) ([Andrew Onyshchuk](https://github.com/oandrew))
- Don't commit a batch polled from `Kafka` partially as it can lead to holes in data. [#8876](https://github.com/ClickHouse/ClickHouse/pull/8876) ([filimonov](https://github.com/filimonov))
- Fix `joinGet` with nullable return types. [#8919](https://github.com/ClickHouse/ClickHouse/issues/8919) [#9014](https://github.com/ClickHouse/ClickHouse/pull/9014) ([Amos Bird](https://github.com/amosbird))
- Fix data incompatibility when compressed with `T64` codec. [#9016](https://github.com/ClickHouse/ClickHouse/pull/9016) ([Artem Zuikov](https://github.com/4ertus2)) Fix data type ids in `T64` compression codec that leads to wrong (de)compression in affected versions. [#9033](https://github.com/ClickHouse/ClickHouse/pull/9033) ([Artem Zuikov](https://github.com/4ertus2))
- Add setting `enable_early_constant_folding` and disable it in some cases that leads to errors. [#9010](https://github.com/ClickHouse/ClickHouse/pull/9010) ([Artem Zuikov](https://github.com/4ertus2))
- Fix pushdown predicate optimizer with VIEW and enable the test [#9011](https://github.com/ClickHouse/ClickHouse/pull/9011) ([Winter Zhang](https://github.com/zhang2014))
- Fix segfault in `Merge` tables, that can happen when reading from `File` storages [#9387](https://github.com/ClickHouse/ClickHouse/pull/9387) ([tavplubix](https://github.com/tavplubix))
- Added a check for storage policy in `ATTACH PARTITION FROM`, `REPLACE PARTITION`, `MOVE TO TABLE`. Otherwise it could make data of part inaccessible after restart and prevent ClickHouse to start. [#9383](https://github.com/ClickHouse/ClickHouse/pull/9383) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix alters if there is TTL set for table. [#8800](https://github.com/ClickHouse/ClickHouse/pull/8800) ([Anton Popov](https://github.com/CurtizJ))
- Fix race condition that can happen when `SYSTEM RELOAD ALL DICTIONARIES` is executed while some dictionary is being modified/added/removed. [#8801](https://github.com/ClickHouse/ClickHouse/pull/8801) ([Vitaly Baranov](https://github.com/vitlibar))
- In previous versions `Memory` database engine use empty data path, so tables are created in `path` directory (e.g. `/var/lib/clickhouse/`), not in data directory of database (e.g. `/var/lib/clickhouse/db_name`). [#8753](https://github.com/ClickHouse/ClickHouse/pull/8753) ([tavplubix](https://github.com/tavplubix))
- Fixed wrong log messages about missing default disk or policy. [#9530](https://github.com/ClickHouse/ClickHouse/pull/9530) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix not(has()) for the bloom_filter index of array types. [#9407](https://github.com/ClickHouse/ClickHouse/pull/9407) ([achimbab](https://github.com/achimbab))
- Allow first column(s) in a table with `Log` engine be an alias [#9231](https://github.com/ClickHouse/ClickHouse/pull/9231) ([Ivan](https://github.com/abyss7))
- Fix order of ranges while reading from `MergeTree` table in one thread. It could lead to exceptions from `MergeTreeRangeReader` or wrong query results. [#9050](https://github.com/ClickHouse/ClickHouse/pull/9050) ([Anton Popov](https://github.com/CurtizJ))
- Make `reinterpretAsFixedString` to return `FixedString` instead of `String`. [#9052](https://github.com/ClickHouse/ClickHouse/pull/9052) ([Andrew Onyshchuk](https://github.com/oandrew))
- Avoid extremely rare cases when the user can get wrong error message (`Success` instead of detailed error description). [#9457](https://github.com/ClickHouse/ClickHouse/pull/9457) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Do not crash when using `Template` format with empty row template. [#8785](https://github.com/ClickHouse/ClickHouse/pull/8785) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Metadata files for system tables could be created in wrong place [#8653](https://github.com/ClickHouse/ClickHouse/pull/8653) ([tavplubix](https://github.com/tavplubix)) Fixes [#8581](https://github.com/ClickHouse/ClickHouse/issues/8581).
- Fix data race on exception_ptr in cache dictionary [#8303](https://github.com/ClickHouse/ClickHouse/issues/8303). [#9379](https://github.com/ClickHouse/ClickHouse/pull/9379) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Do not throw an exception for query `ATTACH TABLE IF NOT EXISTS`. Previously it was thrown if table already exists, despite the `IF NOT EXISTS` clause. [#8967](https://github.com/ClickHouse/ClickHouse/pull/8967) ([Anton Popov](https://github.com/CurtizJ))
- Fixed missing closing paren in exception message. [#8811](https://github.com/ClickHouse/ClickHouse/pull/8811) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Avoid message `Possible deadlock avoided` at the startup of clickhouse-client in interactive mode. [#9455](https://github.com/ClickHouse/ClickHouse/pull/9455) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed the issue when padding at the end of base64 encoded value can be malformed. Update base64 library. This fixes [#9491](https://github.com/ClickHouse/ClickHouse/issues/9491), closes [#9492](https://github.com/ClickHouse/ClickHouse/issues/9492) [#9500](https://github.com/ClickHouse/ClickHouse/pull/9500) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Prevent losing data in `Kafka` in rare cases when exception happens after reading suffix but before commit. Fixes [#9378](https://github.com/ClickHouse/ClickHouse/issues/9378) [#9507](https://github.com/ClickHouse/ClickHouse/pull/9507) ([filimonov](https://github.com/filimonov))
- Fixed exception in `DROP TABLE IF EXISTS` [#8663](https://github.com/ClickHouse/ClickHouse/pull/8663) ([Nikita Vasilev](https://github.com/nikvas0))
- Fix crash when a user tries to `ALTER MODIFY SETTING` for old-formated `MergeTree` table engines family. [#9435](https://github.com/ClickHouse/ClickHouse/pull/9435) ([alesapin](https://github.com/alesapin))
- Support for UInt64 numbers that don't fit in Int64 in JSON-related functions. Update SIMDJSON to master. This fixes [#9209](https://github.com/ClickHouse/ClickHouse/issues/9209) [#9344](https://github.com/ClickHouse/ClickHouse/pull/9344) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed execution of inversed predicates when non-strictly monotinic functional index is used. [#9223](https://github.com/ClickHouse/ClickHouse/pull/9223) ([Alexander Kazakov](https://github.com/Akazz))
- Don't try to fold `IN` constant in `GROUP BY` [#8868](https://github.com/ClickHouse/ClickHouse/pull/8868) ([Amos Bird](https://github.com/amosbird))
- Fix bug in `ALTER DELETE` mutations which leads to index corruption. This fixes [#9019](https://github.com/ClickHouse/ClickHouse/issues/9019) and [#8982](https://github.com/ClickHouse/ClickHouse/issues/8982). Additionally fix extremely rare race conditions in `ReplicatedMergeTree` `ALTER` queries. [#9048](https://github.com/ClickHouse/ClickHouse/pull/9048) ([alesapin](https://github.com/alesapin))
- When the setting `compile_expressions` is enabled, you can get `unexpected column` in `LLVMExecutableFunction` when we use `Nullable` type [#8910](https://github.com/ClickHouse/ClickHouse/pull/8910) ([Guillaume Tassery](https://github.com/YiuRULE))
- Multiple fixes for `Kafka` engine: 1) fix duplicates that were appearing during consumer group rebalance. 2) Fix rare 'holes' appeared when data were polled from several partitions with one poll and committed partially (now we always process / commit the whole polled block of messages). 3) Fix flushes by block size (before that only flushing by timeout was working properly). 4) better subscription procedure (with assignment feedback). 5) Make tests work faster (with default intervals and timeouts). Due to the fact that data was not flushed by block size before (as it should according to documentation), that PR may lead to some performance degradation with default settings (due to more often & tinier flushes which are less optimal). If you encounter the performance issue after that change - please increase `kafka_max_block_size` in the table to the bigger value ( for example `CREATE TABLE ...Engine=Kafka ... SETTINGS ... kafka_max_block_size=524288`). Fixes [#7259](https://github.com/ClickHouse/ClickHouse/issues/7259) [#8917](https://github.com/ClickHouse/ClickHouse/pull/8917) ([filimonov](https://github.com/filimonov))
- Fix `Parameter out of bound` exception in some queries after PREWHERE optimizations. [#8914](https://github.com/ClickHouse/ClickHouse/pull/8914) ([Baudouin Giard](https://github.com/bgiard))
- Fixed the case of mixed-constness of arguments of function `arrayZip`. [#8705](https://github.com/ClickHouse/ClickHouse/pull/8705) ([alexey-milovidov](https://github.com/alexey-milovidov))
- When executing `CREATE` query, fold constant expressions in storage engine arguments. Replace empty database name with current database. Fixes [#6508](https://github.com/ClickHouse/ClickHouse/issues/6508), [#3492](https://github.com/ClickHouse/ClickHouse/issues/3492) [#9262](https://github.com/ClickHouse/ClickHouse/pull/9262) ([tavplubix](https://github.com/tavplubix))
- Now it's not possible to create or add columns with simple cyclic aliases like `a DEFAULT b, b DEFAULT a`. [#9603](https://github.com/ClickHouse/ClickHouse/pull/9603) ([alesapin](https://github.com/alesapin))
- Fixed a bug with double move which may corrupt original part. This is relevant if you use `ALTER TABLE MOVE` [#8680](https://github.com/ClickHouse/ClickHouse/pull/8680) ([Vladimir Chebotarev](https://github.com/excitoon))
- Allow `interval` identifier to correctly parse without backticks. Fixed issue when a query cannot be executed even if the `interval` identifier is enclosed in backticks or double quotes. This fixes [#9124](https://github.com/ClickHouse/ClickHouse/issues/9124). [#9142](https://github.com/ClickHouse/ClickHouse/pull/9142) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed fuzz test and incorrect behaviour of `bitTestAll`/`bitTestAny` functions. [#9143](https://github.com/ClickHouse/ClickHouse/pull/9143) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix possible crash/wrong number of rows in `LIMIT n WITH TIES` when there are a lot of rows equal to n'th row. [#9464](https://github.com/ClickHouse/ClickHouse/pull/9464) ([tavplubix](https://github.com/tavplubix))
- Fix mutations with parts written with enabled `insert_quorum`. [#9463](https://github.com/ClickHouse/ClickHouse/pull/9463) ([alesapin](https://github.com/alesapin))
- Fix data race at destruction of `Poco::HTTPServer`. It could happen when server is started and immediately shut down. [#9468](https://github.com/ClickHouse/ClickHouse/pull/9468) ([Anton Popov](https://github.com/CurtizJ))
- Fix bug in which a misleading error message was shown when running `SHOW CREATE TABLE a_table_that_does_not_exist`. [#8899](https://github.com/ClickHouse/ClickHouse/pull/8899) ([achulkov2](https://github.com/achulkov2))
- Fixed `Parameters are out of bound` exception in some rare cases when we have a constant in the `SELECT` clause when we have an `ORDER BY` and a `LIMIT` clause. [#8892](https://github.com/ClickHouse/ClickHouse/pull/8892) ([Guillaume Tassery](https://github.com/YiuRULE))
- Fix mutations finalization, when already done mutation can have status `is_done=0`. [#9217](https://github.com/ClickHouse/ClickHouse/pull/9217) ([alesapin](https://github.com/alesapin))
- Prevent from executing `ALTER ADD INDEX` for MergeTree tables with old syntax, because it does not work. [#8822](https://github.com/ClickHouse/ClickHouse/pull/8822) ([Mikhail Korotov](https://github.com/millb))
- During server startup do not access table, which `LIVE VIEW` depends on, so server will be able to start. Also remove `LIVE VIEW` dependencies when detaching `LIVE VIEW`. `LIVE VIEW` is an experimental feature. [#8824](https://github.com/ClickHouse/ClickHouse/pull/8824) ([tavplubix](https://github.com/tavplubix))
- Fix possible segfault in `MergeTreeRangeReader`, while executing `PREWHERE`. [#9106](https://github.com/ClickHouse/ClickHouse/pull/9106) ([Anton Popov](https://github.com/CurtizJ))
- Fix possible mismatched checksums with column TTLs. [#9451](https://github.com/ClickHouse/ClickHouse/pull/9451) ([Anton Popov](https://github.com/CurtizJ))
- Fixed a bug when parts were not being moved in background by TTL rules in case when there is only one volume. [#8672](https://github.com/ClickHouse/ClickHouse/pull/8672) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fixed the issue `Method createColumn() is not implemented for data type Set`. This fixes [#7799](https://github.com/ClickHouse/ClickHouse/issues/7799). [#8674](https://github.com/ClickHouse/ClickHouse/pull/8674) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Now we will try finalize mutations more frequently. [#9427](https://github.com/ClickHouse/ClickHouse/pull/9427) ([alesapin](https://github.com/alesapin))
- Fix `intDiv` by minus one constant [#9351](https://github.com/ClickHouse/ClickHouse/pull/9351) ([hcz](https://github.com/hczhcz))
- Fix possible race condition in `BlockIO`. [#9356](https://github.com/ClickHouse/ClickHouse/pull/9356) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix bug leading to server termination when trying to use / drop `Kafka` table created with wrong parameters. [#9513](https://github.com/ClickHouse/ClickHouse/pull/9513) ([filimonov](https://github.com/filimonov))
- Added workaround if OS returns wrong result for `timer_create` function. [#8837](https://github.com/ClickHouse/ClickHouse/pull/8837) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed error in usage of `min_marks_for_seek` parameter. Fixed the error message when there is no sharding key in Distributed table and we try to skip unused shards. [#8908](https://github.com/ClickHouse/ClickHouse/pull/8908) ([Azat Khuzhin](https://github.com/azat))





#### 改善 {#improvement-20}

- `ReplicatedMergeTree*`エンジンファミリーに対して、ミューテーション上で`ALTER MODIFY/DROP`クエリを実装しました。現在、`ALTERS`はメタデータ更新段階でのみブロックし、その後はブロックしません。[#8701](https://github.com/ClickHouse/ClickHouse/pull/8701) ([alesapin](https://github.com/alesapin))
- 非修飾名を含む`WHERE`セクションを持つCROSSをINNER JOINに書き換える機能を追加しました。[#9512](https://github.com/ClickHouse/ClickHouse/pull/9512) ([Artem Zuikov](https://github.com/4ertus2))
- `SHOW TABLES`および`SHOW DATABASES`クエリが`WHERE`式と`FROM`/`IN`をサポートするようにしました。[#9076](https://github.com/ClickHouse/ClickHouse/pull/9076) ([sundyli](https://github.com/sundy-li))
- `deduplicate_blocks_in_dependent_materialized_views`設定を追加しました。[#9070](https://github.com/ClickHouse/ClickHouse/pull/9070) ([urykhy](https://github.com/urykhy))
- 最近の変更後、MySQLクライアントがバイナリ文字列を16進数で出力するようになり、読み取れなくなりました([#9032](https://github.com/ClickHouse/ClickHouse/issues/9032))。ClickHouseでの回避策は、文字列カラムをUTF-8としてマークすることです。これは常にではありませんが、通常はそうです。[#9079](https://github.com/ClickHouse/ClickHouse/pull/9079) ([Yuriy Baranov](https://github.com/yurriy))
- `sumMap`に対してStringおよびFixedStringキーのサポートを追加しました。[#8903](https://github.com/ClickHouse/ClickHouse/pull/8903) ([Baudouin Giard](https://github.com/bgiard))
- SummingMergeTreeマップで文字列キーをサポートしました。[#8933](https://github.com/ClickHouse/ClickHouse/pull/8933) ([Baudouin Giard](https://github.com/bgiard))
- スレッドが例外をスローした場合でも、スレッドプールにスレッドの終了を通知するようにしました。[#8736](https://github.com/ClickHouse/ClickHouse/pull/8736) ([Ding Xiang Fei](https://github.com/dingxiangfei2009))
- `clickhouse-benchmark`で`query_id`を設定できるようにしました。[#9416](https://github.com/ClickHouse/ClickHouse/pull/9416) ([Anton Popov](https://github.com/CurtizJ))
- `ALTER TABLE ... PARTITION partition`クエリで不正な式を許可しないようにしました。これは[#7192](https://github.com/ClickHouse/ClickHouse/issues/7192)に対処します。[#8835](https://github.com/ClickHouse/ClickHouse/pull/8835) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `system.table_engines`テーブルが機能サポートに関する情報(`supports_ttl`や`supports_sort_order`など)を提供するようになりました。[#8830](https://github.com/ClickHouse/ClickHouse/pull/8830) ([Max Akhmedov](https://github.com/zlobober))
- `system.metric_log`をデフォルトで有効にしました。これには、"collect_interval_milliseconds"間隔(デフォルトでは1秒)で収集されたProfileEvents、CurrentMetricsの値を持つ行が含まれます。このテーブルは非常に小さく(通常はメガバイト単位)、デフォルトでこのデータを収集することは妥当です。[#9225](https://github.com/ClickHouse/ClickHouse/pull/9225) ([alexey-milovidov](https://github.com/alexey-milovidov))
- グループ内のすべてのスレッドに対してクエリプロファイラを初期化するようにしました。例えば、これによりinsertクエリを完全にプロファイルできます。[#6964](https://github.com/ClickHouse/ClickHouse/issues/6964)を修正しました。[#8874](https://github.com/ClickHouse/ClickHouse/pull/8874) ([Ivan](https://github.com/abyss7))
- 一時的な`LIVE VIEW`は、`CREATE TEMPORARY LIVE VIEW ...`の代わりに`CREATE LIVE VIEW name WITH TIMEOUT [42] ...`で作成されるようになりました。以前の構文は`CREATE TEMPORARY TABLE ...`と一貫性がなかったためです。[#9131](https://github.com/ClickHouse/ClickHouse/pull/9131) ([tavplubix](https://github.com/tavplubix))
- `system.text_log`テーブルに記録されるエントリを制限するためのtext_log.level設定パラメータを追加しました。[#8809](https://github.com/ClickHouse/ClickHouse/pull/8809) ([Azat Khuzhin](https://github.com/azat))
- TTLルールに従って、ダウンロードされたパートをディスク/ボリュームに配置できるようにしました。[#8598](https://github.com/ClickHouse/ClickHouse/pull/8598) ([Vladimir Chebotarev](https://github.com/excitoon))
- 外部MySQL辞書に対して、MySQL接続プールを相互利用して辞書間で「共有」できるようにしました。このオプションにより、MySQLサーバーへの接続数が大幅に削減されます。[#9409](https://github.com/ClickHouse/ClickHouse/pull/9409) ([Clément Rodriguez](https://github.com/clemrodriguez))
- `clickhouse-benchmark`出力で、補間値の代わりに分位数の最も近いクエリ実行時間を表示するようにしました。一部のクエリの実行時間に対応する値を表示する方が適切です。[#8712](https://github.com/ClickHouse/ClickHouse/pull/8712) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Kafkaにデータを挿入する際に、メッセージにキーとタイムスタンプを追加できるようにしました。[#7198](https://github.com/ClickHouse/ClickHouse/issues/7198)を修正しました。[#8969](https://github.com/ClickHouse/ClickHouse/pull/8969) ([filimonov](https://github.com/filimonov))
- サーバーがターミナルから実行される場合、スレッド番号、クエリID、ログ優先度を色で強調表示するようにしました。これは、開発者向けに相関するログメッセージの可読性を向上させるためです。[#8961](https://github.com/ClickHouse/ClickHouse/pull/8961) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `Ordinary`データベースのテーブル読み込み時の例外メッセージを改善しました。[#9527](https://github.com/ClickHouse/ClickHouse/pull/9527) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 集約関数状態を持つ配列に対して`arraySlice`を実装しました。これは[#9388](https://github.com/ClickHouse/ClickHouse/issues/9388)を修正します。[#9391](https://github.com/ClickHouse/ClickHouse/pull/9391) ([alexey-milovidov](https://github.com/alexey-milovidov))
- IN演算子の右側で定数関数と定数配列を使用できるようにしました。[#8813](https://github.com/ClickHouse/ClickHouse/pull/8813) ([Anton Popov](https://github.com/CurtizJ))
- system.replicasのデータ取得中にzookeeper例外が発生した場合、それを別のカラムに表示するようにしました。これは[#9137](https://github.com/ClickHouse/ClickHouse/issues/9137)を実装します。[#9138](https://github.com/ClickHouse/ClickHouse/pull/9138) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 破棄時にMergeTreeデータパートをアトミックに削除するようにしました。[#8402](https://github.com/ClickHouse/ClickHouse/pull/8402) ([Vladimir Chebotarev](https://github.com/excitoon))
- Distributedテーブルに対して行レベルセキュリティをサポートしました。[#8926](https://github.com/ClickHouse/ClickHouse/pull/8926) ([Ivan](https://github.com/abyss7))
- 設定値で接尾辞(KB、KiBなど)を認識するようになりました。[#8072](https://github.com/ClickHouse/ClickHouse/pull/8072) ([Mikhail Korotov](https://github.com/millb))
- 大規模なJOINの結果を構築する際のメモリ不足を防止しました。[#8637](https://github.com/ClickHouse/ClickHouse/pull/8637) ([Artem Zuikov](https://github.com/4ertus2))
- `clickhouse-client`のインタラクティブモードで、クラスター名を候補に追加しました。[#8709](https://github.com/ClickHouse/ClickHouse/pull/8709) ([alexey-milovidov](https://github.com/alexey-milovidov))
- グループ内のすべてのスレッドに対してクエリプロファイラを初期化するようにしました。例えば、これによりinsertクエリを完全にプロファイルできます。[#8820](https://github.com/ClickHouse/ClickHouse/pull/8820) ([Ivan](https://github.com/abyss7))
- `system.query_log`テーブルに`exception_code`カラムを追加しました。[#8770](https://github.com/ClickHouse/ClickHouse/pull/8770) ([Mikhail Korotov](https://github.com/millb))
- デフォルトのサーバー設定ファイルでポート`9004`のMySQL互換サーバーを有効にしました。設定例のパスワード生成コマンドを修正しました。[#8771](https://github.com/ClickHouse/ClickHouse/pull/8771) ([Yuriy Baranov](https://github.com/yurriy))
- ファイルシステムが読み取り専用の場合、シャットダウン時の中断を防止しました。これは[#9094](https://github.com/ClickHouse/ClickHouse/issues/9094)を修正します。[#9100](https://github.com/ClickHouse/ClickHouse/pull/9100) ([alexey-milovidov](https://github.com/alexey-milovidov))
- HTTP POSTクエリで長さが必要な場合の例外メッセージを改善しました。[#9453](https://github.com/ClickHouse/ClickHouse/pull/9453) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `HDFS`および`File`エンジン、ならびに`hdfs`および`file`テーブル関数に`_path`および`_file`仮想カラムを追加しました。[#8489](https://github.com/ClickHouse/ClickHouse/pull/8489) ([Olga Khvostikova](https://github.com/stavrolia))
- ビューの内部テーブルに新しいカラムが追加された場合に、`MATERIALIZED VIEW`への挿入時に発生する`Cannot find column`エラーを修正しました。[#8766](https://github.com/ClickHouse/ClickHouse/pull/8766) [#8788](https://github.com/ClickHouse/ClickHouse/pull/8788) ([vzakaznikov](https://github.com/vzakaznikov)) [#8788](https://github.com/ClickHouse/ClickHouse/issues/8788) [#8806](https://github.com/ClickHouse/ClickHouse/pull/8806) ([Nikolai Kochetov](https://github.com/KochetovNicolai)) [#8803](https://github.com/ClickHouse/ClickHouse/pull/8803) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- ネイティブクライアント・サーバープロトコルでの進行状況を修正し、最終更新後(ログのように)に進行状況を送信するようにしました。これは、ネイティブプロトコルを使用する一部のサードパーティツールにのみ関連する可能性があります。[#9495](https://github.com/ClickHouse/ClickHouse/pull/9495) ([Azat Khuzhin](https://github.com/azat))
- MySQLプロトコルを使用するクライアント接続数を追跡するシステムメトリックを追加しました([#9013](https://github.com/ClickHouse/ClickHouse/issues/9013))。[#9015](https://github.com/ClickHouse/ClickHouse/pull/9015) ([Eugene Klimov](https://github.com/Slach))
- 今後、HTTPレスポンスには`SELECT timezone()`が報告するのと同じタイムゾーン値が設定された`X-ClickHouse-Timezone`ヘッダーが含まれます。[#9493](https://github.com/ClickHouse/ClickHouse/pull/9493) ([Denis Glazachev](https://github.com/traceon))

#### パフォーマンス改善 {#performance-improvement-16}

- INを使用したインデックス解析のパフォーマンスを改善 [#9261](https://github.com/ClickHouse/ClickHouse/pull/9261) ([Anton Popov](https://github.com/CurtizJ))
- 論理関数のコードをより簡潔かつ効率的に改善し、コードクリーンアップを実施。[#8718](https://github.com/ClickHouse/ClickHouse/issues/8718)のフォローアップ [#8728](https://github.com/ClickHouse/ClickHouse/pull/8728) ([Alexander Kazakov](https://github.com/Akazz))
- C++20機能によるより厳格なエイリアシングの確保により、全体的なパフォーマンスを改善(影響を受けるクエリで5%～200%の範囲)。[#9304](https://github.com/ClickHouse/ClickHouse/pull/9304) ([Amos Bird](https://github.com/amosbird))
- 比較関数の内部ループに対するより厳格なエイリアシング。[#9327](https://github.com/ClickHouse/ClickHouse/pull/9327) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 算術関数の内部ループに対するより厳格なエイリアシング。[#9325](https://github.com/ClickHouse/ClickHouse/pull/9325) ([alexey-milovidov](https://github.com/alexey-milovidov))
- ColumnVector::replicate()の実装を約3倍高速化。これによりColumnConst::convertToFullColumn()が実装されています。定数をマテリアライズする際のテストでも有用です。[#9293](https://github.com/ClickHouse/ClickHouse/pull/9293) ([Alexander Kazakov](https://github.com/Akazz))
- `ColumnVector::replicate()`に対するさらなる軽微なパフォーマンス改善(`materialize`関数と高階関数を高速化)。[#9293](https://github.com/ClickHouse/ClickHouse/issues/9293)のさらなる改善 [#9442](https://github.com/ClickHouse/ClickHouse/pull/9442) ([Alexander Kazakov](https://github.com/Akazz))
- `stochasticLinearRegression`集約関数のパフォーマンスを改善。このパッチはIntelによって提供されました。[#8652](https://github.com/ClickHouse/ClickHouse/pull/8652) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `reinterpretAsFixedString`関数のパフォーマンスを改善。[#9342](https://github.com/ClickHouse/ClickHouse/pull/9342) ([alexey-milovidov](https://github.com/alexey-milovidov))
- プロセッサパイプラインにおいて`Null`フォーマットのブロックをクライアントに送信しないように変更。[#8797](https://github.com/ClickHouse/ClickHouse/pull/8797) ([Nikolai Kochetov](https://github.com/KochetovNicolai)) [#8767](https://github.com/ClickHouse/ClickHouse/pull/8767) ([Alexander Kuzmenkov](https://github.com/akuzm))


#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-20}

- Exception handling now works correctly on Windows Subsystem for Linux. See https://github.com/ClickHouse-Extras/libunwind/pull/3 This fixes [#6480](https://github.com/ClickHouse/ClickHouse/issues/6480) [#9564](https://github.com/ClickHouse/ClickHouse/pull/9564) ([sobolevsv](https://github.com/sobolevsv))
- Replace `readline` with `replxx` for interactive line editing in `clickhouse-client` [#8416](https://github.com/ClickHouse/ClickHouse/pull/8416) ([Ivan](https://github.com/abyss7))
- Better build time and less template instantiations in FunctionsComparison. [#9324](https://github.com/ClickHouse/ClickHouse/pull/9324) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added integration with `clang-tidy` in CI. See also [#6044](https://github.com/ClickHouse/ClickHouse/issues/6044) [#9566](https://github.com/ClickHouse/ClickHouse/pull/9566) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Now we link ClickHouse in CI using `lld` even for `gcc`. [#9049](https://github.com/ClickHouse/ClickHouse/pull/9049) ([alesapin](https://github.com/alesapin))
- Allow to randomize thread scheduling and insert glitches when `THREAD_FUZZER_*` environment variables are set. This helps testing. [#9459](https://github.com/ClickHouse/ClickHouse/pull/9459) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Enable secure sockets in stateless tests [#9288](https://github.com/ClickHouse/ClickHouse/pull/9288) ([tavplubix](https://github.com/tavplubix))
- Make SPLIT_SHARED_LIBRARIES=OFF more robust [#9156](https://github.com/ClickHouse/ClickHouse/pull/9156) ([Azat Khuzhin](https://github.com/azat))
- Make "performance_introspection_and_logging" test reliable to random server stuck. This may happen in CI environment. See also [#9515](https://github.com/ClickHouse/ClickHouse/issues/9515) [#9528](https://github.com/ClickHouse/ClickHouse/pull/9528) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Validate XML in style check. [#9550](https://github.com/ClickHouse/ClickHouse/pull/9550) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed race condition in test `00738_lock_for_inner_table`. This test relied on sleep. [#9555](https://github.com/ClickHouse/ClickHouse/pull/9555) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Remove performance tests of type `once`. This is needed to run all performance tests in statistical comparison mode (more reliable). [#9557](https://github.com/ClickHouse/ClickHouse/pull/9557) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added performance test for arithmetic functions. [#9326](https://github.com/ClickHouse/ClickHouse/pull/9326) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Added performance test for `sumMap` and `sumMapWithOverflow` aggregate functions. Follow-up for [#8933](https://github.com/ClickHouse/ClickHouse/issues/8933) [#8947](https://github.com/ClickHouse/ClickHouse/pull/8947) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Ensure style of ErrorCodes by style check. [#9370](https://github.com/ClickHouse/ClickHouse/pull/9370) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add script for tests history. [#8796](https://github.com/ClickHouse/ClickHouse/pull/8796) ([alesapin](https://github.com/alesapin))
- Add GCC warning `-Wsuggest-override` to locate and fix all places where `override` keyword must be used. [#8760](https://github.com/ClickHouse/ClickHouse/pull/8760) ([kreuzerkrieg](https://github.com/kreuzerkrieg))
- Ignore weak symbol under Mac OS X because it must be defined [#9538](https://github.com/ClickHouse/ClickHouse/pull/9538) ([Deleted user](https://github.com/ghost))
- Normalize running time of some queries in performance tests. This is done in preparation to run all the performance tests in comparison mode. [#9565](https://github.com/ClickHouse/ClickHouse/pull/9565) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix some tests to support pytest with query tests [#9062](https://github.com/ClickHouse/ClickHouse/pull/9062) ([Ivan](https://github.com/abyss7))
- Enable SSL in build with MSan, so server will not fail at startup when running stateless tests [#9531](https://github.com/ClickHouse/ClickHouse/pull/9531) ([tavplubix](https://github.com/tavplubix))
- Fix database substitution in test results [#9384](https://github.com/ClickHouse/ClickHouse/pull/9384) ([Ilya Yatsishin](https://github.com/qoega))
- Build fixes for miscellaneous platforms [#9381](https://github.com/ClickHouse/ClickHouse/pull/9381) ([proller](https://github.com/proller)) [#8755](https://github.com/ClickHouse/ClickHouse/pull/8755) ([proller](https://github.com/proller)) [#8631](https://github.com/ClickHouse/ClickHouse/pull/8631) ([proller](https://github.com/proller))
- Added disks section to stateless-with-coverage test docker image [#9213](https://github.com/ClickHouse/ClickHouse/pull/9213) ([Pavel Kovalenko](https://github.com/Jokser))
- Get rid of in-source-tree files when building with GRPC [#9588](https://github.com/ClickHouse/ClickHouse/pull/9588) ([Amos Bird](https://github.com/amosbird))
- Slightly faster build time by removing SessionCleaner from Context. Make the code of SessionCleaner more simple. [#9232](https://github.com/ClickHouse/ClickHouse/pull/9232) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Updated checking for hung queries in clickhouse-test script [#8858](https://github.com/ClickHouse/ClickHouse/pull/8858) ([Alexander Kazakov](https://github.com/Akazz))
- Removed some useless files from repository. [#8843](https://github.com/ClickHouse/ClickHouse/pull/8843) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Changed type of math perftests from `once` to `loop`. [#8783](https://github.com/ClickHouse/ClickHouse/pull/8783) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Add docker image which allows to build interactive code browser HTML report for our codebase. [#8781](https://github.com/ClickHouse/ClickHouse/pull/8781) ([alesapin](https://github.com/alesapin)) See [Woboq Code Browser](https://clickhouse-test-reports.s3.yandex.net/codebrowser/ClickHouse/dbms/index.html)
- Suppress some test failures under MSan. [#8780](https://github.com/ClickHouse/ClickHouse/pull/8780) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Speedup "exception while insert" test. This test often time out in debug-with-coverage build. [#8711](https://github.com/ClickHouse/ClickHouse/pull/8711) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Updated `libcxx` and `libcxxabi` to master. In preparation to [#9304](https://github.com/ClickHouse/ClickHouse/issues/9304) [#9308](https://github.com/ClickHouse/ClickHouse/pull/9308) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix flacky test `00910_zookeeper_test_alter_compression_codecs`. [#9525](https://github.com/ClickHouse/ClickHouse/pull/9525) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Clean up duplicated linker flags. Make sure the linker won't look up an unexpected symbol. [#9433](https://github.com/ClickHouse/ClickHouse/pull/9433) ([Amos Bird](https://github.com/amosbird))
- Add `clickhouse-odbc` driver into test images. This allows to test interaction of ClickHouse with ClickHouse via its own ODBC driver. [#9348](https://github.com/ClickHouse/ClickHouse/pull/9348) ([filimonov](https://github.com/filimonov))
- Fix several bugs in unit tests. [#9047](https://github.com/ClickHouse/ClickHouse/pull/9047) ([alesapin](https://github.com/alesapin))
- Enable `-Wmissing-include-dirs` GCC warning to eliminate all non-existing includes - mostly as a result of CMake scripting errors [#8704](https://github.com/ClickHouse/ClickHouse/pull/8704) ([kreuzerkrieg](https://github.com/kreuzerkrieg))
- Describe reasons if query profiler cannot work. This is intended for [#9049](https://github.com/ClickHouse/ClickHouse/issues/9049) [#9144](https://github.com/ClickHouse/ClickHouse/pull/9144) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update OpenSSL to upstream master. Fixed the issue when TLS connections may fail with the message `OpenSSL SSL_read: error:14094438:SSL routines:ssl3_read_bytes:tlsv1 alert internal error` and `SSL Exception: error:2400006E:random number generator::error retrieving entropy`. The issue was present in version 20.1. [#8956](https://github.com/ClickHouse/ClickHouse/pull/8956) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update Dockerfile for server [#8893](https://github.com/ClickHouse/ClickHouse/pull/8893) ([Ilya Mazaev](https://github.com/ne-ray))
- Minor fixes in build-gcc-from-sources script [#8774](https://github.com/ClickHouse/ClickHouse/pull/8774) ([Michael Nacharov](https://github.com/mnach))
- Replace `numbers` to `zeros` in perftests where `number` column is not used. This will lead to more clean test results. [#9600](https://github.com/ClickHouse/ClickHouse/pull/9600) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix stack overflow issue when using initializer_list in Column constructors. [#9367](https://github.com/ClickHouse/ClickHouse/pull/9367) ([Deleted user](https://github.com/ghost))
- Upgrade librdkafka to v1.3.0. Enable bundled `rdkafka` and `gsasl` libraries on Mac OS X. [#9000](https://github.com/ClickHouse/ClickHouse/pull/9000) ([Andrew Onyshchuk](https://github.com/oandrew))
- build fix on GCC 9.2.0 [#9306](https://github.com/ClickHouse/ClickHouse/pull/9306) ([vxider](https://github.com/Vxider))





## ClickHouseリリース v20.1 {#clickhouse-release-v201}

### ClickHouseリリース v20.1.16.120-stable 2020-60-26 {#clickhouse-release-v20116120-stable-2020-60-26}

#### バグ修正 {#bug-fix-50}

- prewhere条件で`Nullable`カラムを使用した際に発生する稀なクラッシュを修正しました。[#11608](https://github.com/ClickHouse/ClickHouse/issues/11608)の続きです。[#11869](https://github.com/ClickHouse/ClickHouse/pull/11869) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 高階関数内でarrayJoinを使用できないようにしました。これはプロトコル同期の破損を引き起こしていました。これにより[#3933](https://github.com/ClickHouse/ClickHouse/issues/3933)が解決されます。[#11846](https://github.com/ClickHouse/ClickHouse/pull/11846) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `SELECT *, xyz.*`のようなクエリがエラーになるべきところ成功していた予期しない動作を修正しました。[#11753](https://github.com/ClickHouse/ClickHouse/pull/11753) ([hexiaoting](https://github.com/hexiaoting))。
- Values入力フォーマットにおける複雑なリテラルの型推論の誤りによって引き起こされるLOGICAL_ERRORを修正しました。[#11732](https://github.com/ClickHouse/ClickHouse/pull/11732) ([tavplubix](https://github.com/tavplubix))。
- 定数カラムに対する`ORDER BY ... WITH FILL`を修正しました。[#11697](https://github.com/ClickHouse/ClickHouse/pull/11697) ([Anton Popov](https://github.com/CurtizJ))。
- XDBCブリッジとの通信時に適切なタイムアウトを渡すようにしました。最近、ブリッジの生存確認とメタ情報の受信時にタイムアウトが考慮されていませんでした。[#11690](https://github.com/ClickHouse/ClickHouse/pull/11690) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 大文字小文字を区別しないフラグを持つ正規表現のサポートを追加しました。これにより[#11101](https://github.com/ClickHouse/ClickHouse/issues/11101)と[#11506](https://github.com/ClickHouse/ClickHouse/issues/11506)が修正されます。[#11649](https://github.com/ClickHouse/ClickHouse/pull/11649) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- String型のブルームフィルタ(データスキップインデックス)を修正しました。[#11638](https://github.com/ClickHouse/ClickHouse/pull/11638) ([Azat Khuzhin](https://github.com/azat))。
- prewhere条件で`Nullable`カラムを使用した際に発生する稀なクラッシュを修正しました。(おそらく[#11572](https://github.com/ClickHouse/ClickHouse/issues/11572)と何らかの関連があります)。[#11608](https://github.com/ClickHouse/ClickHouse/pull/11608) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- exception.code() % 256 = 0の場合のclickhouse-clientの誤った終了コードを修正しました。[#11601](https://github.com/ClickHouse/ClickHouse/pull/11601) ([filimonov](https://github.com/filimonov))。
- サーバー起動時の「Mark cache size was lowered」に関するログメッセージの軽微なエラーを修正しました。これにより[#11399](https://github.com/ClickHouse/ClickHouse/issues/11399)が解決されます。[#11589](https://github.com/ClickHouse/ClickHouse/pull/11589) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- clickhouse-server dockerコンテナがサーバーの生存確認にIPv6を優先するようになりました。[#11550](https://github.com/ClickHouse/ClickHouse/pull/11550) ([Ivan Starkov](https://github.com/istarkov))。
- -State関数を使用した集計の途中で例外がスローされた場合のメモリリークを修正しました。これにより[#8995](https://github.com/ClickHouse/ClickHouse/issues/8995)が修正されます。[#11496](https://github.com/ClickHouse/ClickHouse/pull/11496) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 'FINAL'修飾子と'ORDER BY'最適化を伴う関数でラップされたプライマリキーの使用を修正しました。[#10715](https://github.com/ClickHouse/ClickHouse/pull/10715) ([Anton Popov](https://github.com/CurtizJ))。


### ClickHouse release v20.1.15.109-stable 2020-06-19 {#clickhouse-release-v20115109-stable-2020-06-19}

#### バグ修正 {#bug-fix-51}

- ALTER実行時の構造に対する過剰なロックを修正。[#11790](https://github.com/ClickHouse/ClickHouse/pull/11790) ([alesapin](https://github.com/alesapin))。

### ClickHouse release v20.1.14.107-stable 2020-06-11 {#clickhouse-release-v20114107-stable-2020-06-11}

#### バグ修正 {#bug-fix-52}

- `PREWHERE column in (subquery)`と`ARRAY JOIN`を含むクエリで発生する`Size of offsets does not match size of column`エラーを修正。[#11580](https://github.com/ClickHouse/ClickHouse/pull/11580) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。

### ClickHouse release v20.1.13.105-stable 2020-06-10 {#clickhouse-release-v20113105-stable-2020-06-10}

#### バグ修正 {#bug-fix-53}


* `min_bytes_to_use_direct_io` が有効で、PREWHERE が有効な状態で SAMPLE を使用している場合、またはスレッド数が多い場合に発生する可能性のある `Data compressed with different methods` エラーを修正しました。これにより [#11539](https://github.com/ClickHouse/ClickHouse/issues/11539) が解決されます。 [#11540](https://github.com/ClickHouse/ClickHouse/pull/11540) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* コーデックで返される圧縮サイズを修正。 [#11448](https://github.com/ClickHouse/ClickHouse/pull/11448) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* カラムが非リテラル引数を持つ圧縮コーデックを使用している場合にサーバーがクラッシュする問題を修正しました。 [#11365](https://github.com/ClickHouse/ClickHouse/issues/11365) を解決します。 [#11431](https://github.com/ClickHouse/ClickHouse/pull/11431)（[alesapin](https://github.com/alesapin)）。
* `nan` を点として指定した場合の `pointInPolygon` の挙動を修正。[#11375](https://github.com/ClickHouse/ClickHouse/issues/11375) を修正。[#11421](https://github.com/ClickHouse/ClickHouse/pull/11421)（[Alexey Ilyukhov](https://github.com/livace)）。
* 緯度・経度の範囲外の引数が指定された場合の geohashesInBox の動作を修正しました。 [#11403](https://github.com/ClickHouse/ClickHouse/pull/11403) ([Vasily Nemkov](https://github.com/Enmk)).
* 外部ソートと `LIMIT` を伴うクエリで発生する可能性のある `Pipeline stuck` エラーを修正。 [#11359](https://github.com/ClickHouse/ClickHouse/issues/11359) を解決。 [#11366](https://github.com/ClickHouse/ClickHouse/pull/11366) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `quantilesExactWeightedArray` のクラッシュを修正。 [#11337](https://github.com/ClickHouse/ClickHouse/pull/11337) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `parallel_view_processing = 1` の設定を使用した `MATERIALIZED VIEW` への書き込みを、再び並列で実行できるようにしました。[#10241](https://github.com/ClickHouse/ClickHouse/issues/10241) を修正。[#11330](https://github.com/ClickHouse/ClickHouse/pull/11330) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 抽出された JSON に不均衡な &#123; または [ を含む文字列がある場合に `visitParamExtractRaw` を修正。 [#11318](https://github.com/ClickHouse/ClickHouse/pull/11318) ([Ewout](https://github.com/devwout))。
* ThreadPool における極めてまれなレースコンディションを修正しました。 [#11314](https://github.com/ClickHouse/ClickHouse/pull/11314) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 変換処理で発生する可能性のある未初期化メモリ使用を修正。例: `SELECT toIntervalSecond(now64())`。 [#11311](https://github.com/ClickHouse/ClickHouse/pull/11311) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 主キーに `Array` 型のカラムがあり、クエリがこのカラムを `empty` または `notEmpty` 関数でフィルタリングしている場合にインデックス解析が動作しない問題を修正しました。これにより [#11286](https://github.com/ClickHouse/ClickHouse/issues/11286) が解決されます。 [#11303](https://github.com/ClickHouse/ClickHouse/pull/11303) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* クエリ速度の推定が誤っている場合があり、クエリが `max_network_bandwidth`、`max_execution_speed`、または `priority` 設定によってスロットルされているときに `min_execution_speed` の制限が効かない、または正しく動作しない不具合を修正。`timeout_before_checking_execution_speed` のデフォルト値をゼロ以外に変更。そうしないと、`min_execution_speed` および `max_execution_speed` の設定が効果を持たないため。これにより [#11297](https://github.com/ClickHouse/ClickHouse/issues/11297) が修正される。これにより [#5732](https://github.com/ClickHouse/ClickHouse/issues/5732) が修正される。これにより [#6228](https://github.com/ClickHouse/ClickHouse/issues/6228) が修正される。ユーザビリティ改善: `clickhouse-client` において、例外メッセージとプログレスバーが連結されないように変更。[#11296](https://github.com/ClickHouse/ClickHouse/pull/11296) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* Protobuf 形式で不正なデータを読み込んだ際にクラッシュする問題を修正しました。これにより [#5957](https://github.com/ClickHouse/ClickHouse/issues/5957) および [#11203](https://github.com/ClickHouse/ClickHouse/issues/11203) が解決されます。[#11258](https://github.com/ClickHouse/ClickHouse/pull/11258)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `Array(Array(LowCardinality))` のキャプチャ引数を持つ高階関数で発生しうる `Cannot capture column` エラーを修正しました。 [#11185](https://github.com/ClickHouse/ClickHouse/pull/11185) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* データスキッピングインデックスが、バックグラウンドマージ中に変更される列（`SummingMergeTree`、`AggregatingMergeTree`、および `TTL GROUP BY` の場合）に依存している場合、インデックスが正しく計算されていませんでした。この問題は、マージ後にインデックスを計算するように変更し、マージ済みデータに対してインデックスが計算されるようにすることで修正されました。 [#11162](https://github.com/ClickHouse/ClickHouse/pull/11162) ([Azat Khuzhin](https://github.com/azat)).
* 何もファイナライズされなかった場合は、mutation のファイナライズ処理タスクでのログ出力を削除しました。 [#11109](https://github.com/ClickHouse/ClickHouse/pull/11109) ([alesapin](https://github.com/alesapin)).
* parseDateTime64BestEffort の引数解決に関するバグを修正しました。 [#10925](https://github.com/ClickHouse/ClickHouse/issues/10925)。 [#11038](https://github.com/ClickHouse/ClickHouse/pull/11038) ([Vasily Nemkov](https://github.com/Enmk))。
* メソッド `getRawData()` での誤った生データサイズを修正。 [#10964](https://github.com/ClickHouse/ClickHouse/pull/10964) ([Igr](https://github.com/ObjatieGroba)).
* Distributed テーブルにおけるタプルの後方互換性を修正しました。 [#10889](https://github.com/ClickHouse/ClickHouse/pull/10889) ([Anton Popov](https://github.com/CurtizJ)).
* StringHashTable において、存在しないキーを指定した場合に発生する SIGSEGV を修正。 [#10870](https://github.com/ClickHouse/ClickHouse/pull/10870) ([Azat Khuzhin](https://github.com/azat)).
* `ReplicatedMergeTree` のバグを修正しました。このバグにより、レプリカの一部が非アクティブになった後もそのレプリカを待ち続けてしまい、一部の `OPTIMIZE` クエリに対する `ALTER` がハングする可能性がありました。 [#10849](https://github.com/ClickHouse/ClickHouse/pull/10849) ([tavplubix](https://github.com/tavplubix))。
* Block::sortColumns() の後のカラム順を修正（実際のユースケースである Buffer エンジンに影響することを示すテストも追加）。 [#10826](https://github.com/ClickHouse/ClickHouse/pull/10826) ([Azat Khuzhin](https://github.com/azat)).
* 識別子のクオートを行わない場合に発生していた ODBC bridge の問題を修正しました。これにより [#7984](https://github.com/ClickHouse/ClickHouse/issues/7984) が解決されます。 [#10821](https://github.com/ClickHouse/ClickHouse/pull/10821) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* DateLUT における UBSan および MSan のレポートを修正します。 [#10798](https://github.com/ClickHouse/ClickHouse/pull/10798) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* * キー条件で正しい型変換を行うために `src_type` を使用するようにしました。 [#6287](https://github.com/ClickHouse/ClickHouse/issues/6287) を修正。 [#10791](https://github.com/ClickHouse/ClickHouse/pull/10791)（[Andrew Onyshchuk](https://github.com/oandrew)）。
* `parallel_view_processing` の動作を修正しました。例外が発生した場合でも、すべての `MATERIALIZED VIEW` への挿入は、例外が発生したものも含めて完了するようになりました。[#10241](https://github.com/ClickHouse/ClickHouse/issues/10241) を修正。[#10757](https://github.com/ClickHouse/ClickHouse/pull/10757)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* -State と組み合わせた場合のコンビネータ -OrNull および -OrDefault を修正しました。 [#10741](https://github.com/ClickHouse/ClickHouse/pull/10741) ([hcz](https://github.com/hczhcz))。
* 消えてしまう `totals` を修正。クエリに `JOIN` や、外側に `WHERE` 条件を持つサブクエリが含まれている場合、`totals` がフィルタリングされてしまうことがありました。[#10674](https://github.com/ClickHouse/ClickHouse/issues/10674) を修正。[#10698](https://github.com/ClickHouse/ClickHouse/pull/10698)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 1つのクエリ内で同一の集合に対して複数回使用されている `IN` 演算子を修正しました。 [#10686](https://github.com/ClickHouse/ClickHouse/pull/10686) ([Anton Popov](https://github.com/CurtizJ)).
* AggregateTransform コンストラクタのパラメータ順序を修正。 [#10667](https://github.com/ClickHouse/ClickHouse/pull/10667) ([palasonic1](https://github.com/palasonic1)).
* `distributed_aggregation_memory_efficient` が有効な場合にリモートクエリが並列実行されない問題を修正しました。[#10655](https://github.com/ClickHouse/ClickHouse/issues/10655) を修正します。[#10664](https://github.com/ClickHouse/ClickHouse/pull/10664)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `HAVING` 句を含むクエリ（つまりイニシエータサーバー側でのフィルタリングが必要なクエリ）に対して、`enable_optimize_predicate_expression=1` のときの分散クエリにおける述語最適化を修正しました。式の順序を保持することで（これだけで修正としては十分であり）、さらに集約処理ではインデックスではなくカラム名を使用するように強制しています。修正対象: [#10613](https://github.com/ClickHouse/ClickHouse/issues/10613), [#11413](https://github.com/ClickHouse/ClickHouse/issues/11413)。[#10621](https://github.com/ClickHouse/ClickHouse/pull/10621)（[Azat Khuzhin](https://github.com/azat)）。
* エラー `the BloomFilter false positive must be a double number between 0 and 1` を修正。[#10551](https://github.com/ClickHouse/ClickHouse/issues/10551)。[#10569](https://github.com/ClickHouse/ClickHouse/pull/10569)（[Winter Zhang](https://github.com/zhang2014)）。
* デフォルト式の型がカラム型と異なるカラム ALIAS に対する `SELECT` を修正しました。 [#10563](https://github.com/ClickHouse/ClickHouse/pull/10563) ([Azat Khuzhin](https://github.com/azat)).
* * DateTime と同様に、DateTime64 と String の値の比較機能を実装しました。 [#10560](https://github.com/ClickHouse/ClickHouse/pull/10560) ([Vasily Nemkov](https://github.com/Enmk)).

### ClickHouse リリース v20.1.12.86, 2020-05-26 {#clickhouse-release-v2011286-2020-05-26}

#### バグ修正 {#bug-fix-54}


* バージョン 20.1 とそれ以前のバージョン間で発生していた二段階集約の非互換性を修正しました。この非互換性は、イニシエーターノードとリモートノードで異なるバージョンの ClickHouse が使用されており、`GROUP BY` の結果セットが大きく、単一の `String` フィールドで集約が行われる場合に発生します。その結果、単一のキーに対してマージされていない複数の行が結果に含まれることがありました。 [#10952](https://github.com/ClickHouse/ClickHouse/pull/10952) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `SummingMergeTree` において、マージ後に発生する可能性があった `LowCardinality(FixedString)` キーカラムのデータ破損を修正しました。[#10489](https://github.com/ClickHouse/ClickHouse/issues/10489) を修正。 [#10721](https://github.com/ClickHouse/ClickHouse/pull/10721)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `readonly=2` かつ `cancel_http_readonly_queries_on_client_close=1` の場合に、クライアントが接続を閉じた際に HTTP リクエストがハングしてしまう原因となっていたバグを修正しました。[#7939](https://github.com/ClickHouse/ClickHouse/issues/7939)、[#7019](https://github.com/ClickHouse/ClickHouse/issues/7019)、[#7736](https://github.com/ClickHouse/ClickHouse/issues/7736)、[#7091](https://github.com/ClickHouse/ClickHouse/issues/7091) を修正。[#10684](https://github.com/ClickHouse/ClickHouse/pull/10684)（[tavplubix](https://github.com/tavplubix)）。
* `SYSTEM DROP DNS CACHE` クエリの実行時に、一部の IP アドレスからの接続が許可されているかを確認するために使用されるキャッシュまで削除されてしまう不具合を修正しました。 [#10608](https://github.com/ClickHouse/ClickHouse/pull/10608) ([tavplubix](https://github.com/tavplubix)).
* 依存テーブルを含む場合に、`MATERIALIZED VIEW` の内部クエリ内でスカラー結果が誤っていた問題を修正しました。 [#10603](https://github.com/ClickHouse/ClickHouse/pull/10603) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* すべてのパーツでミューテーションが完了しているにもかかわらず、`is_done=0` の状態のままハングしてしまう問題を修正しました。 [#10526](https://github.com/ClickHouse/ClickHouse/pull/10526) ([alesapin](https://github.com/alesapin)).
* UTC からのオフセットが小数（端数）のタイムゾーンにおける Unix エポック開始時のオーバーフローを修正しました。この修正により [#9335](https://github.com/ClickHouse/ClickHouse/issues/9335) が解決されました。[#10513](https://github.com/ClickHouse/ClickHouse/pull/10513)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* Distributed テーブルの異常終了処理を修正しました。 [#10491](https://github.com/ClickHouse/ClickHouse/pull/10491) ([Azat Khuzhin](https://github.com/azat)).
* 大きな整数に対する `simpleLinearRegression` の数値オーバーフローを修正しました。 [#10474](https://github.com/ClickHouse/ClickHouse/pull/10474) ([hcz](https://github.com/hczhcz)).
* `ATTACH DATABASE` が失敗した際に `metadata` ディレクトリが削除されてしまう問題を修正。 [#10442](https://github.com/ClickHouse/ClickHouse/pull/10442) ([Winter Zhang](https://github.com/zhang2014)).
* `BloomFilter` インデックス作成時に、引数の数と型の検証を追加しました [#9623](https://github.com/ClickHouse/ClickHouse/issues/9623)。 [#10431](https://github.com/ClickHouse/ClickHouse/pull/10431) ([Winter Zhang](https://github.com/zhang2014))。
* `ARRAY JOIN`、`ORDER BY`、`LIMIT` を含むクエリで、結果が不完全になることがある問題を修正しました。これにより [#10226](https://github.com/ClickHouse/ClickHouse/issues/10226) が修正されました。 [#10427](https://github.com/ClickHouse/ClickHouse/pull/10427)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `skip_unavailable_shards` より `fallback_to_stale_replicas` を優先して使用します。 [#10422](https://github.com/ClickHouse/ClickHouse/pull/10422) ([Azat Khuzhin](https://github.com/azat)).
* `Array(Tuple(...))` データ型に対する誤ったフラット化処理を修正しました。これにより [#10259](https://github.com/ClickHouse/ClickHouse/issues/10259) が解決されました。[#10390](https://github.com/ClickHouse/ClickHouse/pull/10390)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* バッファから `HashMap` を読み取ろうとした際にコンパイルエラーを引き起こしていた `HashTable` の誤った動作を修正しました。 [#10386](https://github.com/ClickHouse/ClickHouse/pull/10386) ([palasonic1](https://github.com/palasonic1)).
* リモートクエリで発生する可能性があった `ConcatProcessor` における `Pipeline stuck` エラーを修正しました。[#10381](https://github.com/ClickHouse/ClickHouse/pull/10381) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `max_rows_to_group_by` と `group_by_overflow_mode = 'break'` を使用した際に発生していた `Pipeline stuck` エラーを修正しました。 [#10279](https://github.com/ClickHouse/ClickHouse/pull/10279) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 一部のデータが `quorum` 付きで挿入された後に、`DROP PARTITION` や `TTL` などによって削除され、その結果として `INSERT` がハングしたり、`SELECT` で誤検知の例外が発生したりする不具合を複数修正しました。この修正は [#9946](https://github.com/ClickHouse/ClickHouse/issues/9946) を解決します。 [#10188](https://github.com/ClickHouse/ClickHouse/pull/10188) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* リモートサーバーで 18.12.17 より前のバージョンを使用し、イニシエーター側サーバーでそれ以降の新しいバージョンを使用している場合に、`GROUP BY` に固定キーと非固定キーの両方が含まれ、かつ二段階 `GROUP BY` メソッドが有効になっていると発生していた非互換性を修正しました。 [#3254](https://github.com/ClickHouse/ClickHouse/pull/3254) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-21}

- clickhouse-server Dockerイメージに CA証明書を追加しました。[#10476](https://github.com/ClickHouse/ClickHouse/pull/10476) ([filimonov](https://github.com/filimonov))。

### ClickHouse リリース v20.1.10.70, 2020-04-17 {#clickhouse-release-v2011070-2020-04-17}

#### バグ修正 {#bug-fix-55}


* まれに発生する可能性がある例外 `Cannot drain connections: cancel first` を修正。 [#10239](https://github.com/ClickHouse/ClickHouse/pull/10239) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `ENGINE = Replicated*` を持つテーブルに対してユーザーが `ALTER UPDATE/DELETE` を実行しようとした際に、ClickHouse が `'Unknown function lambda.'` というエラーメッセージをスローしてしまう不具合を修正しました。非決定的関数のチェックで lambda 式が正しく処理されるようになりました。[#10237](https://github.com/ClickHouse/ClickHouse/pull/10237) ([Alexander Kazakov](https://github.com/Akazz))。
* `parseDateTimeBestEffort` が、曜日が Tuesday または Thursday の RFC-2822 形式の文字列を正しく処理できるように修正します。これにより [#10082](https://github.com/ClickHouse/ClickHouse/issues/10082) が修正されます。[#10214](https://github.com/ClickHouse/ClickHouse/pull/10214)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `JOIN` の外側にある定数と名前が衝突する可能性のある、`JOIN` 内の定数カラムの名前を修正します。 [#10207](https://github.com/ClickHouse/ClickHouse/pull/10207) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `system.numbers` や `system.zeros` のような無限ソースから読み取る際、本来は `LIMIT` で停止すべきクエリが無限に実行されてしまう可能性のある問題を修正。 [#10206](https://github.com/ClickHouse/ClickHouse/pull/10206) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 特定のケースにおいて `arrayJoin` 関数が存在する場合の move-to-prewhere 最適化を修正しました。これにより [#10092](https://github.com/ClickHouse/ClickHouse/issues/10092) が解決されます。 [#10195](https://github.com/ClickHouse/ClickHouse/pull/10195) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `allow_nondeterministic_mutations` 設定で、ミューテーションにおける非決定的関数の使用制限を緩和できるようにしました。 [#10186](https://github.com/ClickHouse/ClickHouse/pull/10186) ([filimonov](https://github.com/filimonov))。
* `Distributed` エンジンを持つテーブルへの `INSERT` 時に、構造が一致しない場合はブロックを変換するようにしました。 [#10135](https://github.com/ClickHouse/ClickHouse/pull/10135) ([Azat Khuzhin](https://github.com/azat)).
* `Distributed` テーブルの構造が基盤となるテーブルと異なる場合に、`INSERT` 時に発生していた `SIGSEGV` を修正。 [#10105](https://github.com/ClickHouse/ClickHouse/pull/10105) ([Azat Khuzhin](https://github.com/azat))。
* `JOIN` および `UNION ALL` を含むクエリで発生しうる行欠落の問題を修正。[#9826](https://github.com/ClickHouse/ClickHouse/issues/9826)、[#10113](https://github.com/ClickHouse/ClickHouse/issues/10113) を修正。[#10099](https://github.com/ClickHouse/ClickHouse/pull/10099)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* MySQL Database Engine に引数チェックを追加し、識別子引数をサポートしました。 [#10077](https://github.com/ClickHouse/ClickHouse/pull/10077) ([Winter Zhang](https://github.com/zhang2014)).
* localhost の ClickHouse サーバーを辞書ソースとする ClickHouse 辞書のバグを修正しました。辞書とソースの型が非互換な場合、このバグによりメモリ破損が発生する可能性がありました。 [#10071](https://github.com/ClickHouse/ClickHouse/pull/10071) ([alesapin](https://github.com/alesapin))。
* エラー `Cannot clone block with columns because block has 0 columns ... While executing GroupingAggregatedTransform` を修正しました。これは、`distributed_aggregation_memory_efficient` 設定が有効化されている状態で、分散クエリが異なるシャードから異なるレベルの集約データ（単一レベル集約と二段階集約が混在）を読み込んだ場合に発生していました。 [#10063](https://github.com/ClickHouse/ClickHouse/pull/10063) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 末尾にゼロバイトを含む文字列キーに対する `GROUP BY` で発生する可能性があったセグメンテーションフォルトを修正しました（[#8636](https://github.com/ClickHouse/ClickHouse/issues/8636)、[#8925](https://github.com/ClickHouse/ClickHouse/issues/8925)）。 [#10025](https://github.com/ClickHouse/ClickHouse/pull/10025)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 一部のデータベースへのクエリ処理のある段階で、必要なテーブルが取得されない不具合を修正しました。[#9699](https://github.com/ClickHouse/ClickHouse/issues/9699) を修正。 [#9949](https://github.com/ClickHouse/ClickHouse/pull/9949)（[achulkov2](https://github.com/achulkov2)）。
* `JOIN` と `TOTALS` を併用した際に発生する `'Not found column in block'` エラーを修正。[#9839](https://github.com/ClickHouse/ClickHouse/issues/9839) を解決。[#9939](https://github.com/ClickHouse/ClickHouse/pull/9939)（[Artem Zuikov](https://github.com/4ertus2)）。
* サーバー起動時に `ON CLUSTER` DDL クエリがフリーズする不具合を修正しました。 [#9927](https://github.com/ClickHouse/ClickHouse/pull/9927) ([Gagan Arneja](https://github.com/garneja))。
* Join テーブルエンジンに対する `TRUNCATE` の動作を修正（[#9917](https://github.com/ClickHouse/ClickHouse/issues/9917)）。[#9920](https://github.com/ClickHouse/ClickHouse/pull/9920)（[Amos Bird](https://github.com/amosbird)）。
* ALTER クエリにおける `'scalar does not exist'` エラーを修正しました（[#9878](https://github.com/ClickHouse/ClickHouse/issues/9878)）。[#9904](https://github.com/ClickHouse/ClickHouse/pull/9904)（[Amos Bird](https://github.com/amosbird)）。
* `ReplicatedMergeTree` における DROP と OPTIMIZE 間のレースコンディションを修正しました。 [#9901](https://github.com/ClickHouse/ClickHouse/pull/9901) ([alesapin](https://github.com/alesapin))。
* `ATTACH PART` における `DeleteOnDestroy` のロジックを修正し、アタッチしたパートが自動的に削除されてしまう可能性を解消するとともに、いくつかのテストを追加しました。 [#9410](https://github.com/ClickHouse/ClickHouse/pull/9410) ([Vladimir Chebotarev](https://github.com/excitoon)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-22}

- ユニットテスト `collapsing_sorted_stream` を修正。[#9367](https://github.com/ClickHouse/ClickHouse/pull/9367) ([Deleted user](https://github.com/ghost))。

### ClickHouse リリース v20.1.9.54, 2020-03-28 {#clickhouse-release-v201954-2020-03-28}

#### バグ修正 {#bug-fix-56}

- 分散テーブルに対して `PREWHERE` と `WHERE` を持つクエリで `SET distributed_product_mode = 'local'` が設定されている場合の `'Different expressions with the same alias'` エラーを修正。[#9871](https://github.com/ClickHouse/ClickHouse/pull/9871) ([Artem Zuikov](https://github.com/4ertus2))。
- 複合プライマリキーを持つテーブルでのミューテーションによる過剰なメモリ消費を修正。これにより [#9850](https://github.com/ClickHouse/ClickHouse/issues/9850) が修正されます。[#9860](https://github.com/ClickHouse/ClickHouse/pull/9860) ([alesapin](https://github.com/alesapin))。
- INSERT クエリにおいて、シャードは例外をスローする代わりに、イニシエーターから取得した設定をシャードの制約に合わせて調整するようになりました。この修正により、異なる制約を持つシャードに `INSERT` クエリを送信できるようになります。この変更は [#9447](https://github.com/ClickHouse/ClickHouse/issues/9447) の修正を改善します。[#9852](https://github.com/ClickHouse/ClickHouse/pull/9852) ([Vitaly Baranov](https://github.com/vitlibar))。
- クライアントで発生する可能性のある例外 `Got 0 in totals chunk, expected 1` を修正。これは、右結合テーブルが0行の場合に `JOIN` を含むクエリで発生していました。例: `select * from system.one t1 join system.one t2 on t1.dummy = t2.dummy limit 0 FORMAT TabSeparated;`。[#9777](https://github.com/ClickHouse/ClickHouse/issues/9777) を修正。[#9823](https://github.com/ClickHouse/ClickHouse/pull/9823) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- 型を変換できない場合の `optimize_skip_unused_shards` による `SIGSEGV` を修正。[#9804](https://github.com/ClickHouse/ClickHouse/pull/9804) ([Azat Khuzhin](https://github.com/azat))。
- 関数引数のタイムゾーンが適切に使用されていなかったいくつかのケースを修正。[#9574](https://github.com/ClickHouse/ClickHouse/pull/9574) ([Vasily Nemkov](https://github.com/Enmk))。

#### 改善 {#improvement-21}

- 単一のスレッドで単一の順序付けされたパートから読み取るため、ミューテーションから `ORDER BY` ステージを削除。また、ミューテーション内の行の順序がソートキーの順序で並んでおり、この順序が違反されていないことを確認するチェックを追加。[#9886](https://github.com/ClickHouse/ClickHouse/pull/9886) ([alesapin](https://github.com/alesapin))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-23}

- 重複したリンカーフラグをクリーンアップ。リンカーが予期しないシンボルを検索しないようにします。[#9433](https://github.com/ClickHouse/ClickHouse/pull/9433) ([Amos Bird](https://github.com/amosbird))。

### ClickHouse リリース v20.1.8.41, 2020-03-20 {#clickhouse-release-v201841-2020-03-20}


#### バグ修正 {#bug-fix-57}

- `ParallelAggregatingBlockInputStream::Handler::onFinish/onFinishThread`での未処理例外により発生する恒久的な`Cannot schedule a task`エラーを修正しました。これは[#6833](https://github.com/ClickHouse/ClickHouse/issues/6833)を修正します。[#9154](https://github.com/ClickHouse/ClickHouse/pull/9154) ([Azat Khuzhin](https://github.com/azat))
- `ALTER`クエリ(ミューテーション)における過剰なメモリ消費を修正しました。これは[#9533](https://github.com/ClickHouse/ClickHouse/issues/9533)と[#9670](https://github.com/ClickHouse/ClickHouse/issues/9670)を修正します。[#9754](https://github.com/ClickHouse/ClickHouse/pull/9754) ([alesapin](https://github.com/alesapin))
- 外部ディクショナリDDLにおけるバッククォートのバグを修正しました。これは[#9619](https://github.com/ClickHouse/ClickHouse/issues/9619)を修正します。[#9734](https://github.com/ClickHouse/ClickHouse/pull/9734) ([alesapin](https://github.com/alesapin))

### ClickHouse リリース v20.1.7.38, 2020-03-18 {#clickhouse-release-v201738-2020-03-18}


#### バグ修正 {#bug-fix-58}

- `sumKahan`と`sumWithOverflow`の内部関数名の誤りを修正しました。リモートクエリでこれらの関数を使用する際に例外が発生していました。[#9636](https://github.com/ClickHouse/ClickHouse/pull/9636) ([Azat Khuzhin](https://github.com/azat))。この問題はすべてのClickHouseリリースに存在していました。
- 内部レプリケーションを持つ`Distributed`テーブルに対する`ALTER ON CLUSTER`を許可しました。これにより[#3268](https://github.com/ClickHouse/ClickHouse/issues/3268)が修正されます。[#9617](https://github.com/ClickHouse/ClickHouse/pull/9617) ([shinoi2](https://github.com/shinoi2))。この問題はすべてのClickHouseリリースに存在していました。
- `MergeTreeRangeReader`における`Size of filter does not match size of column`および`Invalid number of rows in Chunk`の例外の可能性を修正しました。これらは一部のケースで`PREWHERE`実行時に発生する可能性がありました。修正:[#9132](https://github.com/ClickHouse/ClickHouse/issues/9132)。[#9612](https://github.com/ClickHouse/ClickHouse/pull/9612) ([Anton Popov](https://github.com/CurtizJ))
- 問題を修正しました:`time + 1`のような単純な算術式を記述した場合にタイムゾーンが保持されませんでした(`time + INTERVAL 1 SECOND`のような式とは対照的に)。これにより[#5743](https://github.com/ClickHouse/ClickHouse/issues/5743)が修正されます。[#9323](https://github.com/ClickHouse/ClickHouse/pull/9323) ([alexey-milovidov](https://github.com/alexey-milovidov))。この問題はすべてのClickHouseリリースに存在していました。
- `a DEFAULT b, b DEFAULT a`のような単純な循環エイリアスを持つカラムの作成または追加ができなくなりました。[#9603](https://github.com/ClickHouse/ClickHouse/pull/9603) ([alesapin](https://github.com/alesapin))
- base64エンコード値の末尾のパディングが不正になる可能性がある問題を修正しました。base64ライブラリを更新しました。これにより[#9491](https://github.com/ClickHouse/ClickHouse/issues/9491)が修正され、[#9492](https://github.com/ClickHouse/ClickHouse/issues/9492)がクローズされます。[#9500](https://github.com/ClickHouse/ClickHouse/pull/9500) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `Poco::HTTPServer`の破棄時のデータ競合を修正しました。これはサーバーが起動後すぐにシャットダウンされた場合に発生する可能性がありました。[#9468](https://github.com/ClickHouse/ClickHouse/pull/9468) ([Anton Popov](https://github.com/CurtizJ))
- n番目の行と等しい行が多数存在する場合の`LIMIT n WITH TIES`における可能性のあるクラッシュ/誤った行数を修正しました。[#9464](https://github.com/ClickHouse/ClickHouse/pull/9464) ([tavplubix](https://github.com/tavplubix))
- カラムTTLにおけるチェックサムの不一致の可能性を修正しました。[#9451](https://github.com/ClickHouse/ClickHouse/pull/9451) ([Anton Popov](https://github.com/CurtizJ))
- ユーザーが旧形式の`MergeTree`テーブルエンジンファミリーに対して`ALTER MODIFY SETTING`を試行した際のクラッシュを修正しました。[#9435](https://github.com/ClickHouse/ClickHouse/pull/9435) ([alesapin](https://github.com/alesapin))
- ミューテーションの完了をより頻繁に試行するようになりました。[#9427](https://github.com/ClickHouse/ClickHouse/pull/9427) ([alesapin](https://github.com/alesapin))
- [#8598](https://github.com/ClickHouse/ClickHouse/issues/8598)で導入されたレプリケーションプロトコルの非互換性を修正しました。[#9412](https://github.com/ClickHouse/ClickHouse/pull/9412) ([alesapin](https://github.com/alesapin))
- 配列型のbloom_filterインデックスに対するnot(has())を修正しました。[#9407](https://github.com/ClickHouse/ClickHouse/pull/9407) ([achimbab](https://github.com/achimbab))
- haystackにゼロバイトが含まれる場合の`match`および`extract`関数の動作を修正しました。haystackが定数の場合に動作が誤っていました。これにより[#9160](https://github.com/ClickHouse/ClickHouse/issues/9160)が修正されます。[#9163](https://github.com/ClickHouse/ClickHouse/pull/9163) ([alexey-milovidov](https://github.com/alexey-milovidov)) [#9345](https://github.com/ClickHouse/ClickHouse/pull/9345) ([alexey-milovidov](https://github.com/alexey-milovidov))

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-24}

- Windows Subsystem for Linux上で例外処理が正しく動作するようになりました。https://github.com/ClickHouse-Extras/libunwind/pull/3 を参照してください。これにより [#6480](https://github.com/ClickHouse/ClickHouse/issues/6480) [#9564](https://github.com/ClickHouse/ClickHouse/pull/9564) が修正されました ([sobolevsv](https://github.com/sobolevsv))

### ClickHouse リリース v20.1.6.30, 2020-03-05 {#clickhouse-release-v201630-2020-03-05}

#### バグ修正 {#bug-fix-59}


* `T64` コーデックで圧縮した際に発生するデータ非互換性を修正。
  [#9039](https://github.com/ClickHouse/ClickHouse/pull/9039) [(abyss7)](https://github.com/abyss7)
* 単一スレッドで MergeTree テーブルから読み込む際の範囲の順序を修正。[#8964](https://github.com/ClickHouse/ClickHouse/issues/8964) を修正。
  [#9050](https://github.com/ClickHouse/ClickHouse/pull/9050) [(CurtizJ)](https://github.com/CurtizJ)
* `PREWHERE` の実行中に `MergeTreeRangeReader` で発生し得るセグメンテーションフォールトを修正しました。[#9064](https://github.com/ClickHouse/ClickHouse/issues/9064) を解決。
  [#9106](https://github.com/ClickHouse/ClickHouse/pull/9106) [(CurtizJ)](https://github.com/CurtizJ)
* `reinterpretAsFixedString` が `String` ではなく `FixedString` を返すように修正。
* `joinGet` の Nullable な戻り型を修正。 [#8919](https://github.com/ClickHouse/ClickHouse/issues/8919) を解決
  [#9014](https://github.com/ClickHouse/ClickHouse/pull/9014) [(amosbird)](https://github.com/amosbird)
* `bitTestAll` / `bitTestAny` 関数のファジーテストと誤った動作を修正。
  [#9143](https://github.com/ClickHouse/ClickHouse/pull/9143) [(alexey-milovidov)](https://github.com/alexey-milovidov)
* `haystack` がゼロバイトの場合の `match` および `extract` 関数の動作を修正しました。`haystack` が定数のときの動作が誤っていました。[#9160](https://github.com/ClickHouse/ClickHouse/issues/9160) を修正。
  [#9163](https://github.com/ClickHouse/ClickHouse/pull/9163) [(alexey-milovidov)](https://github.com/alexey-milovidov)
* 非厳密単調なファンクショナルインデックス使用時の反転述語の実行を修正しました。 [#9034](https://github.com/ClickHouse/ClickHouse/issues/9034) を修正。
  [#9223](https://github.com/ClickHouse/ClickHouse/pull/9223) [(Akazz)](https://github.com/Akazz)
* `WHERE` 句に `[NOT] LIKE` 演算子がある場合に、`CROSS` を `INNER JOIN` に書き換えられるようにしました。 [#9191](https://github.com/ClickHouse/ClickHouse/issues/9191) を修正。
  [#9229](https://github.com/ClickHouse/ClickHouse/pull/9229) [(4ertus2)](https://github.com/4ertus2)
* `Log` エンジンを使用するテーブルで、先頭の列（複数可）を `ALIAS` 列にできるようにしました。
  [#9231](https://github.com/ClickHouse/ClickHouse/pull/9231) [(abyss7)](https://github.com/abyss7)
* `IN()` 内でのカンマ区切りによる結合を許可。[#7314](https://github.com/ClickHouse/ClickHouse/issues/7314) を修正。
  [#9251](https://github.com/ClickHouse/ClickHouse/pull/9251) [(4ertus2)](https://github.com/4ertus2)
* `ALTER MODIFY/ADD` クエリのロジックを改善しました。これにより、型を指定せずにカラムを `ADD` できなくなり、`MODIFY` でデフォルト式のみを変更してもカラムの型は変わらず、`MODIFY` で型を変更してもデフォルト式の値は失われなくなりました。[#8669](https://github.com/ClickHouse/ClickHouse/issues/8669) を修正。
  [#9227](https://github.com/ClickHouse/ClickHouse/pull/9227)  [(alesapin)](https://github.com/alesapin)
* すでに完了している mutation でも `is_done=0` のステータスを持つ場合がある問題を修正し、mutation の確定処理を修正。
  [#9217](https://github.com/ClickHouse/ClickHouse/pull/9217) [(alesapin)](https://github.com/alesapin)
* system.numbers および system.numbers&#95;mt で「Processors」パイプラインをサポートします。これにより、`max_execution_time` が守られない不具合も修正されます。
  [#7796](https://github.com/ClickHouse/ClickHouse/pull/7796)  [(KochetovNicolai)](https://github.com/KochetovNicolai)
* `DictCacheKeysRequestedFound` メトリクスの誤ったカウント処理を修正。
  [#9411](https://github.com/ClickHouse/ClickHouse/pull/9411) [(nikitamikhaylov)](https://github.com/nikitamikhaylov)
* `ATTACH PARTITION FROM`、`REPLACE PARTITION`、`MOVE TO TABLE` においてストレージポリシーのチェックを追加しました。これがない場合、再起動後に一部のパーツのデータにアクセスできなくなり、ClickHouse が起動しなくなる可能性がありました。
  [#9383](https://github.com/ClickHouse/ClickHouse/pull/9383) [(excitoon)](https://github.com/excitoon)
* `MergeTreeIndexSet` における UBSan レポートの問題を修正しました。これにより [#9250](https://github.com/ClickHouse/ClickHouse/issues/9250) が解決されます。
  [#9365](https://github.com/ClickHouse/ClickHouse/pull/9365) [(alexey-milovidov)](https://github.com/alexey-milovidov)
* BlockIO におけるデータ競合の可能性を修正。
  [#9356](https://github.com/ClickHouse/ClickHouse/pull/9356) [(KochetovNicolai)](https://github.com/KochetovNicolai)
* JSON 関連関数で、`Int64` に収まらない `UInt64` 数値をサポート。`SIMDJSON` を master に更新。これにより [#9209](https://github.com/ClickHouse/ClickHouse/issues/9209) が修正されます。
  [#9344](https://github.com/ClickHouse/ClickHouse/pull/9344) [(alexey-milovidov)](https://github.com/alexey-milovidov)
* データディレクトリが別のデバイスにマウントされている場合に、空き容量が正しく計算されない問題を修正しました。デフォルトディスクについては、`data` サブディレクトリを基準に空き容量を計算するようにしました。これにより [#7441](https://github.com/ClickHouse/ClickHouse/issues/7441) が修正されます。
  [#9257](https://github.com/ClickHouse/ClickHouse/pull/9257) [(millb)](https://github.com/millb)
* TLS 接続が `OpenSSL SSL_read: error:14094438:SSL routines:ssl3_read_bytes:tlsv1 alert internal error and SSL Exception: error:2400006E:random number generator::error retrieving entropy.` というメッセージとともに失敗する可能性がある問題を修正。OpenSSL を upstream の master に更新。
  [#8956](https://github.com/ClickHouse/ClickHouse/pull/8956) [(alexey-milovidov)](https://github.com/alexey-milovidov)
* `CREATE` クエリを実行する際、ストレージエンジンの引数内にある定数式を畳み込みます。空のデータベース名は現在のデータベース名に置き換えます。[#6508](https://github.com/ClickHouse/ClickHouse/issues/6508)、[#3492](https://github.com/ClickHouse/ClickHouse/issues/3492) を修正します。また、ClickHouseDictionarySource におけるローカルアドレスのチェックも修正します。
  [#9262](https://github.com/ClickHouse/ClickHouse/pull/9262) [(tabplubix)](https://github.com/tavplubix)
* `StorageFile` からの読み取り時に発生する可能性がある `StorageMerge` のセグメンテーションフォルトを修正。
  [#9387](https://github.com/ClickHouse/ClickHouse/pull/9387) [(tabplubix)](https://github.com/tavplubix)
* `suffix` を読み取った後、`commit` の前に例外が発生した場合に、まれに `Kafka` 内のデータが失われる問題を防止しました。 [#9378](https://github.com/ClickHouse/ClickHouse/issues/9378) を修正。関連: [#7175](https://github.com/ClickHouse/ClickHouse/issues/7175)
  [#9507](https://github.com/ClickHouse/ClickHouse/pull/9507) [(filimonov)](https://github.com/filimonov)
* 誤ったパラメータで作成された `Kafka` テーブルを使用／削除しようとした際にサーバーが異常終了してしまうバグを修正。[#9494](https://github.com/ClickHouse/ClickHouse/issues/9494) を修正。[#9507](https://github.com/ClickHouse/ClickHouse/issues/9507) を取り込み。
  [#9513](https://github.com/ClickHouse/ClickHouse/pull/9513) [(filimonov)](https://github.com/filimonov)

#### 新機能 {#new-feature-12}

- マテリアライズドビューを持つテーブルへの冪等挿入の動作を制御する `deduplicate_blocks_in_dependent_materialized_views` オプションを追加しました。この新機能は、Altinityからの特別な要望により、バグ修正リリースに追加されました。
  [#9070](https://github.com/ClickHouse/ClickHouse/pull/9070) [(urykhy)](https://github.com/urykhy)

### ClickHouseリリース v20.1.2.4, 2020-01-22 {#clickhouse-release-v20124-2020-01-22}

#### 後方互換性のない変更 {#backward-incompatible-change-10}

- 設定 `merge_tree_uniform_read_distribution` を廃止しました。サーバーはこの設定を認識しますが、効果はありません。[#8308](https://github.com/ClickHouse/ClickHouse/pull/8308) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 関数 `greatCircleDistance` の戻り値の型を `Float32` に変更しました。計算結果が `Float32` になったためです。[#7993](https://github.com/ClickHouse/ClickHouse/pull/7993) ([alexey-milovidov](https://github.com/alexey-milovidov))
- クエリパラメータは「エスケープ」形式で表現されることが期待されるようになりました。例えば、文字列 `a<tab>b` を渡すには `a\tb` または `a\<tab>b` と記述し、URLでは `a%5Ctb` または `a%5C%09b` と記述する必要があります。これは、NULLを `\N` として渡す機能を追加するために必要です。この変更により [#7488](https://github.com/ClickHouse/ClickHouse/issues/7488) が修正されました。[#8517](https://github.com/ClickHouse/ClickHouse/pull/8517) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `ReplicatedMergeTree` の `use_minimalistic_part_header_in_zookeeper` 設定をデフォルトで有効にしました。これによりZooKeeperに保存されるデータ量が大幅に削減されます。この設定はバージョン19.1以降でサポートされており、半年以上にわたって複数のサービスの本番環境で問題なく使用しています。19.1より古いバージョンにダウングレードする可能性がある場合は、この設定を無効にしてください。[#6850](https://github.com/ClickHouse/ClickHouse/pull/6850) ([alexey-milovidov](https://github.com/alexey-milovidov))
- データスキッピングインデックスは本番環境で使用可能となり、デフォルトで有効になりました。設定 `allow_experimental_data_skipping_indices`、`allow_experimental_cross_to_join_conversion`、`allow_experimental_multiple_joins_emulation` は廃止され、効果はありません。[#7974](https://github.com/ClickHouse/ClickHouse/pull/7974) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `JOIN` 操作と一貫性のある新しい `ANY JOIN` ロジックを `StorageJoin` に追加しました。動作を変更せずにアップグレードするには、Engine Joinテーブルのメタデータに `SETTINGS any_join_distinct_right_table_keys = 1` を追加するか、アップグレード後にこれらのテーブルを再作成する必要があります。[#8400](https://github.com/ClickHouse/ClickHouse/pull/8400) ([Artem Zuikov](https://github.com/4ertus2))
- ログ設定の変更を適用するには、サーバーの再起動が必要です。これは、削除されたログファイルにサーバーがログを記録するバグを回避するための一時的な対処法です（[#8696](https://github.com/ClickHouse/ClickHouse/issues/8696) を参照）。[#8707](https://github.com/ClickHouse/ClickHouse/pull/8707) ([Alexander Kuzmenkov](https://github.com/akuzm))


#### 新機能 {#new-feature-13}

- `system.merges`にパートパスに関する情報を追加しました。[#8043](https://github.com/ClickHouse/ClickHouse/pull/8043) ([Vladimir Chebotarev](https://github.com/excitoon))
- `ON CLUSTER`モードで`SYSTEM RELOAD DICTIONARY`クエリを実行する機能を追加しました。[#8288](https://github.com/ClickHouse/ClickHouse/pull/8288) ([Guillaume Tassery](https://github.com/YiuRULE))
- `ON CLUSTER`モードで`CREATE DICTIONARY`クエリを実行する機能を追加しました。[#8163](https://github.com/ClickHouse/ClickHouse/pull/8163) ([alesapin](https://github.com/alesapin))
- `users.xml`内のユーザープロファイルが複数のプロファイルを継承できるようになりました。[#8343](https://github.com/ClickHouse/ClickHouse/pull/8343) ([Mikhail f. Shiryaev](https://github.com/Felixoid))
- すべてのサーバースレッドのスタックトレースを確認できる`system.stack_trace`テーブルを追加しました。これは開発者がサーバーの状態を調査するのに役立ちます。これにより[#7576](https://github.com/ClickHouse/ClickHouse/issues/7576)が修正されます。[#8344](https://github.com/ClickHouse/ClickHouse/pull/8344) ([alexey-milovidov](https://github.com/alexey-milovidov))
- サブ秒精度を設定可能な`DateTime64`データ型を追加しました。[#7170](https://github.com/ClickHouse/ClickHouse/pull/7170) ([Vasily Nemkov](https://github.com/Enmk))
- クラスタ内のすべてのノードにクエリを実行できるテーブル関数`clusterAllReplicas`を追加しました。[#8493](https://github.com/ClickHouse/ClickHouse/pull/8493) ([kiran sunkari](https://github.com/kiransunkari))
- 離散特徴の情報価値を計算する集約関数`categoricalInformationValue`を追加しました。[#8117](https://github.com/ClickHouse/ClickHouse/pull/8117) ([hcz](https://github.com/hczhcz))
- `CSV`、`TSV`、`JSONEachRow`形式のデータファイルの解析を並列処理することで高速化しました。[#7780](https://github.com/ClickHouse/ClickHouse/pull/7780) ([Alexander Kuzmenkov](https://github.com/akuzm))
- 銀行家の丸めを実行する関数`bankerRound`を追加しました。[#8112](https://github.com/ClickHouse/ClickHouse/pull/8112) ([hcz](https://github.com/hczhcz))
- 地域名の組み込み辞書でより多くの言語をサポートしました:'ru'、'en'、'ua'、'uk'、'by'、'kz'、'tr'、'de'、'uz'、'lv'、'lt'、'et'、'pt'、'he'、'vi'。[#8189](https://github.com/ClickHouse/ClickHouse/pull/8189) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `ANY JOIN`ロジックの一貫性を改善しました。現在、`t1 ANY LEFT JOIN t2`は`t2 ANY RIGHT JOIN t1`と等価です。[#7665](https://github.com/ClickHouse/ClickHouse/pull/7665) ([Artem Zuikov](https://github.com/4ertus2))
- `ANY INNER JOIN`の旧動作を有効にする設定`any_join_distinct_right_table_keys`を追加しました。[#7665](https://github.com/ClickHouse/ClickHouse/pull/7665) ([Artem Zuikov](https://github.com/4ertus2))
- 新しい`SEMI`および`ANTI JOIN`を追加しました。旧`ANY INNER JOIN`の動作は現在`SEMI LEFT JOIN`として利用可能です。[#7665](https://github.com/ClickHouse/ClickHouse/pull/7665) ([Artem Zuikov](https://github.com/4ertus2))
- `File`エンジンと`file`テーブル関数に`Distributed`形式を追加しました。これにより、`Distributed`テーブルへの非同期挿入によって生成された`.bin`ファイルから読み取ることができます。[#8535](https://github.com/ClickHouse/ClickHouse/pull/8535) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- `runningAccumulate`に、新しいキー値ごとに集約結果をリセットできるオプションのリセット列引数を追加しました。[#8326](https://github.com/ClickHouse/ClickHouse/pull/8326) ([Sergey Kononenko](https://github.com/kononencheg))
- ClickHouseをPrometheusエンドポイントとして使用する機能を追加しました。[#7900](https://github.com/ClickHouse/ClickHouse/pull/7900) ([vdimir](https://github.com/Vdimir))
- `config.xml`に`<remote_url_allow_hosts>`セクションを追加しました。これにより、リモートテーブルエンジンおよびテーブル関数`URL`、`S3`、`HDFS`の許可ホストを制限できます。[#7154](https://github.com/ClickHouse/ClickHouse/pull/7154) ([Mikhail Korotov](https://github.com/millb))
- 球面上の距離を度数で計算する関数`greatCircleAngle`を追加しました。[#8105](https://github.com/ClickHouse/ClickHouse/pull/8105) ([alexey-milovidov](https://github.com/alexey-milovidov))
- H3ライブラリと一致するように地球の半径を変更しました。[#8105](https://github.com/ClickHouse/ClickHouse/pull/8105) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 入出力用に`JSONCompactEachRow`および`JSONCompactEachRowWithNamesAndTypes`形式を追加しました。[#7841](https://github.com/ClickHouse/ClickHouse/pull/7841) ([Mikhail Korotov](https://github.com/millb))
- ファイル関連のテーブルエンジンおよびテーブル関数(`File`、`S3`、`URL`、`HDFS`)に、追加のエンジンパラメータまたはファイル拡張子に基づいて`gzip`ファイルを読み書きできる機能を追加しました。[#7840](https://github.com/ClickHouse/ClickHouse/pull/7840) ([Andrey Bodrov](https://github.com/apbodrov))
- ランダムな[ASCII](https://en.wikipedia.org/wiki/ASCII#Printable_characters)印字可能文字のセットで文字列を生成する`randomASCII(length)`関数を追加しました。[#8401](https://github.com/ClickHouse/ClickHouse/pull/8401) ([BayoNet](https://github.com/BayoNet))
- `JSON`文字列から未解析のJSON配列要素の配列を返す関数`JSONExtractArrayRaw`を追加しました。[#8081](https://github.com/ClickHouse/ClickHouse/pull/8081) ([Oleg Matrokhin](https://github.com/errx))
- 同じ長さの複数の配列をタプルの配列に結合できる関数`arrayZip`を追加しました。[#8149](https://github.com/ClickHouse/ClickHouse/pull/8149) ([Winter Zhang](https://github.com/zhang2014))
- `*MergeTree`テーブルエンジンファミリーに対して、設定された`TTL`式に従ってディスク間でデータを移動する機能を追加しました。[#8140](https://github.com/ClickHouse/ClickHouse/pull/8140) ([Vladimir Chebotarev](https://github.com/excitoon))
- 加重平均を計算できる新しい集約関数`avgWeighted`を追加しました。[#7898](https://github.com/ClickHouse/ClickHouse/pull/7898) ([Andrey Bodrov](https://github.com/apbodrov))
- `TSV`、`TSKV`、`CSV`、`JSONEachRow`形式でデフォルトで並列解析が有効になりました。[#7894](https://github.com/ClickHouse/ClickHouse/pull/7894) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- `H3`ライブラリからいくつかの地理関数を追加しました:`h3GetResolution`、`h3EdgeAngle`、`h3EdgeLength`、`h3IsValid`、`h3kRing`。[#8034](https://github.com/ClickHouse/ClickHouse/pull/8034) ([Konstantin Malanchev](https://github.com/hombit))
- ファイル関連のストレージおよびテーブル関数でbrotli(`br`)圧縮のサポートを追加しました。これにより[#8156](https://github.com/ClickHouse/ClickHouse/issues/8156)が修正されます。[#8526](https://github.com/ClickHouse/ClickHouse/pull/8526) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `SimpleAggregationFunction`型用の`groupBit*`関数を追加しました。[#8485](https://github.com/ClickHouse/ClickHouse/pull/8485) ([Guillaume Tassery](https://github.com/YiuRULE))





#### バグ修正 {#bug-fix-60}

- Fix rename of tables with `Distributed` engine. Fixes issue [#7868](https://github.com/ClickHouse/ClickHouse/issues/7868). [#8306](https://github.com/ClickHouse/ClickHouse/pull/8306) ([tavplubix](https://github.com/tavplubix))
- Now dictionaries support `EXPRESSION` for attributes in arbitrary string in non-ClickHouse SQL dialect. [#8098](https://github.com/ClickHouse/ClickHouse/pull/8098) ([alesapin](https://github.com/alesapin))
- Fix broken `INSERT SELECT FROM mysql(...)` query. This fixes [#8070](https://github.com/ClickHouse/ClickHouse/issues/8070) and [#7960](https://github.com/ClickHouse/ClickHouse/issues/7960). [#8234](https://github.com/ClickHouse/ClickHouse/pull/8234) ([tavplubix](https://github.com/tavplubix))
- Fix error "Mismatch column sizes" when inserting default `Tuple` from `JSONEachRow`. This fixes [#5653](https://github.com/ClickHouse/ClickHouse/issues/5653). [#8606](https://github.com/ClickHouse/ClickHouse/pull/8606) ([tavplubix](https://github.com/tavplubix))
- Now an exception will be thrown in case of using `WITH TIES` alongside `LIMIT BY`. Also add ability to use `TOP` with `LIMIT BY`. This fixes [#7472](https://github.com/ClickHouse/ClickHouse/issues/7472). [#7637](https://github.com/ClickHouse/ClickHouse/pull/7637) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Fix unintendent dependency from fresh glibc version in `clickhouse-odbc-bridge` binary. [#8046](https://github.com/ClickHouse/ClickHouse/pull/8046) ([Amos Bird](https://github.com/amosbird))
- Fix bug in check function of `*MergeTree` engines family. Now it does not fail in case when we have equal amount of rows in last granule and last mark (non-final). [#8047](https://github.com/ClickHouse/ClickHouse/pull/8047) ([alesapin](https://github.com/alesapin))
- Fix insert into `Enum*` columns after `ALTER` query, when underlying numeric type is equal to table specified type. This fixes [#7836](https://github.com/ClickHouse/ClickHouse/issues/7836). [#7908](https://github.com/ClickHouse/ClickHouse/pull/7908) ([Anton Popov](https://github.com/CurtizJ))
- Allowed non-constant negative "size" argument for function `substring`. It was not allowed by mistake. This fixes [#4832](https://github.com/ClickHouse/ClickHouse/issues/4832). [#7703](https://github.com/ClickHouse/ClickHouse/pull/7703) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix parsing bug when wrong number of arguments passed to `(O|J)DBC` table engine. [#7709](https://github.com/ClickHouse/ClickHouse/pull/7709) ([alesapin](https://github.com/alesapin))
- Using command name of the running clickhouse process when sending logs to syslog. In previous versions, empty string was used instead of command name. [#8460](https://github.com/ClickHouse/ClickHouse/pull/8460) ([Michael Nacharov](https://github.com/mnach))
- Fix check of allowed hosts for `localhost`. This PR fixes the solution provided in [#8241](https://github.com/ClickHouse/ClickHouse/pull/8241). [#8342](https://github.com/ClickHouse/ClickHouse/pull/8342) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix rare crash in `argMin` and `argMax` functions for long string arguments, when result is used in `runningAccumulate` function. This fixes [#8325](https://github.com/ClickHouse/ClickHouse/issues/8325) [#8341](https://github.com/ClickHouse/ClickHouse/pull/8341) ([dinosaur](https://github.com/769344359))
- Fix memory overcommit for tables with `Buffer` engine. [#8345](https://github.com/ClickHouse/ClickHouse/pull/8345) ([Azat Khuzhin](https://github.com/azat))
- Fixed potential bug in functions that can take `NULL` as one of the arguments and return non-NULL. [#8196](https://github.com/ClickHouse/ClickHouse/pull/8196) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Better metrics calculations in thread pool for background processes for `MergeTree` table engines. [#8194](https://github.com/ClickHouse/ClickHouse/pull/8194) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix function `IN` inside `WHERE` statement when row-level table filter is present. Fixes [#6687](https://github.com/ClickHouse/ClickHouse/issues/6687) [#8357](https://github.com/ClickHouse/ClickHouse/pull/8357) ([Ivan](https://github.com/abyss7))
- Now an exception is thrown if the integral value is not parsed completely for settings values. [#7678](https://github.com/ClickHouse/ClickHouse/pull/7678) ([Mikhail Korotov](https://github.com/millb))
- Fix exception when aggregate function is used in query to distributed table with more than two local shards. [#8164](https://github.com/ClickHouse/ClickHouse/pull/8164) ([小路](https://github.com/nicelulu))
- Now bloom filter can handle zero length arrays and does not perform redundant calculations. [#8242](https://github.com/ClickHouse/ClickHouse/pull/8242) ([achimbab](https://github.com/achimbab))
- Fixed checking if a client host is allowed by matching the client host to `host_regexp` specified in `users.xml`. [#8241](https://github.com/ClickHouse/ClickHouse/pull/8241) ([Vitaly Baranov](https://github.com/vitlibar))
- Relax ambiguous column check that leads to false positives in multiple `JOIN ON` section. [#8385](https://github.com/ClickHouse/ClickHouse/pull/8385) ([Artem Zuikov](https://github.com/4ertus2))
- Fixed possible server crash (`std::terminate`) when the server cannot send or write data in `JSON` or `XML` format with values of `String` data type (that require `UTF-8` validation) or when compressing result data with Brotli algorithm or in some other rare cases. This fixes [#7603](https://github.com/ClickHouse/ClickHouse/issues/7603) [#8384](https://github.com/ClickHouse/ClickHouse/pull/8384) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix race condition in `StorageDistributedDirectoryMonitor` found by CI. This fixes [#8364](https://github.com/ClickHouse/ClickHouse/issues/8364). [#8383](https://github.com/ClickHouse/ClickHouse/pull/8383) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Now background merges in `*MergeTree` table engines family preserve storage policy volume order more accurately. [#8549](https://github.com/ClickHouse/ClickHouse/pull/8549) ([Vladimir Chebotarev](https://github.com/excitoon))
- Now table engine `Kafka` works properly with `Native` format. This fixes [#6731](https://github.com/ClickHouse/ClickHouse/issues/6731) [#7337](https://github.com/ClickHouse/ClickHouse/issues/7337) [#8003](https://github.com/ClickHouse/ClickHouse/issues/8003). [#8016](https://github.com/ClickHouse/ClickHouse/pull/8016) ([filimonov](https://github.com/filimonov))
- Fixed formats with headers (like `CSVWithNames`) which were throwing exception about EOF for table engine `Kafka`. [#8016](https://github.com/ClickHouse/ClickHouse/pull/8016) ([filimonov](https://github.com/filimonov))
- Fixed a bug with making set from subquery in right part of `IN` section. This fixes [#5767](https://github.com/ClickHouse/ClickHouse/issues/5767) and [#2542](https://github.com/ClickHouse/ClickHouse/issues/2542). [#7755](https://github.com/ClickHouse/ClickHouse/pull/7755) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Fix possible crash while reading from storage `File`. [#7756](https://github.com/ClickHouse/ClickHouse/pull/7756) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed reading of the files in `Parquet` format containing columns of type `list`. [#8334](https://github.com/ClickHouse/ClickHouse/pull/8334) ([maxulan](https://github.com/maxulan))
- Fix error `Not found column` for distributed queries with `PREWHERE` condition dependent on sampling key if `max_parallel_replicas > 1`. [#7913](https://github.com/ClickHouse/ClickHouse/pull/7913) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix error `Not found column` if query used `PREWHERE` dependent on table's alias and the result set was empty because of primary key condition. [#7911](https://github.com/ClickHouse/ClickHouse/pull/7911) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed return type for functions `rand` and `randConstant` in case of `Nullable` argument. Now functions always return `UInt32` and never `Nullable(UInt32)`. [#8204](https://github.com/ClickHouse/ClickHouse/pull/8204) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Disabled predicate push-down for `WITH FILL` expression. This fixes [#7784](https://github.com/ClickHouse/ClickHouse/issues/7784). [#7789](https://github.com/ClickHouse/ClickHouse/pull/7789) ([Winter Zhang](https://github.com/zhang2014))
- Fixed incorrect `count()` result for `SummingMergeTree` when `FINAL` section is used. [#3280](https://github.com/ClickHouse/ClickHouse/issues/3280) [#7786](https://github.com/ClickHouse/ClickHouse/pull/7786) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- Fix possible incorrect result for constant functions from remote servers. It happened for queries with functions like `version()`, `uptime()`, etc. which returns different constant values for different servers. This fixes [#7666](https://github.com/ClickHouse/ClickHouse/issues/7666). [#7689](https://github.com/ClickHouse/ClickHouse/pull/7689) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix complicated bug in push-down predicate optimization which leads to wrong results. This fixes a lot of issues on push-down predicate optimization. [#8503](https://github.com/ClickHouse/ClickHouse/pull/8503) ([Winter Zhang](https://github.com/zhang2014))
- Fix crash in `CREATE TABLE .. AS dictionary` query. [#8508](https://github.com/ClickHouse/ClickHouse/pull/8508) ([Azat Khuzhin](https://github.com/azat))
- Several improvements ClickHouse grammar in `.g4` file. [#8294](https://github.com/ClickHouse/ClickHouse/pull/8294) ([taiyang-li](https://github.com/taiyang-li))
- Fix bug that leads to crashes in `JOIN`s with tables with engine `Join`. This fixes [#7556](https://github.com/ClickHouse/ClickHouse/issues/7556) [#8254](https://github.com/ClickHouse/ClickHouse/issues/8254) [#7915](https://github.com/ClickHouse/ClickHouse/issues/7915) [#8100](https://github.com/ClickHouse/ClickHouse/issues/8100). [#8298](https://github.com/ClickHouse/ClickHouse/pull/8298) ([Artem Zuikov](https://github.com/4ertus2))
- Fix redundant dictionaries reload on `CREATE DATABASE`. [#7916](https://github.com/ClickHouse/ClickHouse/pull/7916) ([Azat Khuzhin](https://github.com/azat))
- Limit maximum number of streams for read from `StorageFile` and `StorageHDFS`. Fixes [#7650](https://github.com/ClickHouse/ClickHouse/issues/7650). [#7981](https://github.com/ClickHouse/ClickHouse/pull/7981) ([alesapin](https://github.com/alesapin))
- Fix bug in `ALTER ... MODIFY ... CODEC` query, when user specify both default expression and codec. Fixes [8593](https://github.com/ClickHouse/ClickHouse/issues/8593). [#8614](https://github.com/ClickHouse/ClickHouse/pull/8614) ([alesapin](https://github.com/alesapin))
- Fix error in background merge of columns with `SimpleAggregateFunction(LowCardinality)` type. [#8613](https://github.com/ClickHouse/ClickHouse/pull/8613) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fixed type check in function `toDateTime64`. [#8375](https://github.com/ClickHouse/ClickHouse/pull/8375) ([Vasily Nemkov](https://github.com/Enmk))
- Now server do not crash on `LEFT` or `FULL JOIN` with and Join engine and unsupported `join_use_nulls` settings. [#8479](https://github.com/ClickHouse/ClickHouse/pull/8479) ([Artem Zuikov](https://github.com/4ertus2))
- Now `DROP DICTIONARY IF EXISTS db.dict` query does not throw exception if `db` does not exist. [#8185](https://github.com/ClickHouse/ClickHouse/pull/8185) ([Vitaly Baranov](https://github.com/vitlibar))
- Fix possible crashes in table functions (`file`, `mysql`, `remote`) caused by usage of reference to removed `IStorage` object. Fix incorrect parsing of columns specified at insertion into table function. [#7762](https://github.com/ClickHouse/ClickHouse/pull/7762) ([tavplubix](https://github.com/tavplubix))
- Ensure network be up before starting `clickhouse-server`. This fixes [#7507](https://github.com/ClickHouse/ClickHouse/issues/7507). [#8570](https://github.com/ClickHouse/ClickHouse/pull/8570) ([Zhichang Yu](https://github.com/yuzhichang))
- Fix timeouts handling for secure connections, so queries does not hang indefenitely. This fixes [#8126](https://github.com/ClickHouse/ClickHouse/issues/8126). [#8128](https://github.com/ClickHouse/ClickHouse/pull/8128) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix `clickhouse-copier`'s redundant contention between concurrent workers. [#7816](https://github.com/ClickHouse/ClickHouse/pull/7816) ([Ding Xiang Fei](https://github.com/dingxiangfei2009))
- Now mutations does not skip attached parts, even if their mutation version were larger than current mutation version. [#7812](https://github.com/ClickHouse/ClickHouse/pull/7812) ([Zhichang Yu](https://github.com/yuzhichang)) [#8250](https://github.com/ClickHouse/ClickHouse/pull/8250) ([alesapin](https://github.com/alesapin))
- Ignore redundant copies of `*MergeTree` data parts after move to another disk and server restart. [#7810](https://github.com/ClickHouse/ClickHouse/pull/7810) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix crash in `FULL JOIN` with `LowCardinality` in `JOIN` key. [#8252](https://github.com/ClickHouse/ClickHouse/pull/8252) ([Artem Zuikov](https://github.com/4ertus2))
- Forbidden to use column name more than once in insert query like `INSERT INTO tbl (x, y, x)`. This fixes [#5465](https://github.com/ClickHouse/ClickHouse/issues/5465), [#7681](https://github.com/ClickHouse/ClickHouse/issues/7681). [#7685](https://github.com/ClickHouse/ClickHouse/pull/7685) ([alesapin](https://github.com/alesapin))
- Added fallback for detection the number of physical CPU cores for unknown CPUs (using the number of logical CPU cores). This fixes [#5239](https://github.com/ClickHouse/ClickHouse/issues/5239). [#7726](https://github.com/ClickHouse/ClickHouse/pull/7726) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix `There's no column` error for materialized and alias columns. [#8210](https://github.com/ClickHouse/ClickHouse/pull/8210) ([Artem Zuikov](https://github.com/4ertus2))
- Fixed sever crash when `EXISTS` query was used without `TABLE` or `DICTIONARY` qualifier. Just like `EXISTS t`. This fixes [#8172](https://github.com/ClickHouse/ClickHouse/issues/8172). This bug was introduced in version 19.17. [#8213](https://github.com/ClickHouse/ClickHouse/pull/8213) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix rare bug with error `"Sizes of columns does not match"` that might appear when using `SimpleAggregateFunction` column. [#7790](https://github.com/ClickHouse/ClickHouse/pull/7790) ([Boris Granveaud](https://github.com/bgranvea))
- Fix bug where user with empty `allow_databases` got access to all databases (and same for `allow_dictionaries`). [#7793](https://github.com/ClickHouse/ClickHouse/pull/7793) ([DeifyTheGod](https://github.com/DeifyTheGod))
- Fix client crash when server already disconnected from client. [#8071](https://github.com/ClickHouse/ClickHouse/pull/8071) ([Azat Khuzhin](https://github.com/azat))
- Fix `ORDER BY` behaviour in case of sorting by primary key prefix and non primary key suffix. [#7759](https://github.com/ClickHouse/ClickHouse/pull/7759) ([Anton Popov](https://github.com/CurtizJ))
- Check if qualified column present in the table. This fixes [#6836](https://github.com/ClickHouse/ClickHouse/issues/6836). [#7758](https://github.com/ClickHouse/ClickHouse/pull/7758) ([Artem Zuikov](https://github.com/4ertus2))
- Fixed behavior with `ALTER MOVE` ran immediately after merge finish moves superpart of specified. Fixes [#8103](https://github.com/ClickHouse/ClickHouse/issues/8103). [#8104](https://github.com/ClickHouse/ClickHouse/pull/8104) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix possible server crash while using `UNION` with different number of columns. Fixes [#7279](https://github.com/ClickHouse/ClickHouse/issues/7279). [#7929](https://github.com/ClickHouse/ClickHouse/pull/7929) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix size of result substring for function `substr` with negative size. [#8589](https://github.com/ClickHouse/ClickHouse/pull/8589) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Now server does not execute part mutation in `MergeTree` if there are not enough free threads in background pool. [#8588](https://github.com/ClickHouse/ClickHouse/pull/8588) ([tavplubix](https://github.com/tavplubix))
- Fix a minor typo on formatting `UNION ALL` AST. [#7999](https://github.com/ClickHouse/ClickHouse/pull/7999) ([litao91](https://github.com/litao91))
- Fixed incorrect bloom filter results for negative numbers. This fixes [#8317](https://github.com/ClickHouse/ClickHouse/issues/8317). [#8566](https://github.com/ClickHouse/ClickHouse/pull/8566) ([Winter Zhang](https://github.com/zhang2014))
- Fixed potential buffer overflow in decompress. Malicious user can pass fabricated compressed data that will cause read after buffer. This issue was found by Eldar Zaitov from Yandex information security team. [#8404](https://github.com/ClickHouse/ClickHouse/pull/8404) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix incorrect result because of integers overflow in `arrayIntersect`. [#7777](https://github.com/ClickHouse/ClickHouse/pull/7777) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Now `OPTIMIZE TABLE` query will not wait for offline replicas to perform the operation. [#8314](https://github.com/ClickHouse/ClickHouse/pull/8314) ([javi santana](https://github.com/javisantana))
- Fixed `ALTER TTL` parser for `Replicated*MergeTree` tables. [#8318](https://github.com/ClickHouse/ClickHouse/pull/8318) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix communication between server and client, so server read temporary tables info after query failure. [#8084](https://github.com/ClickHouse/ClickHouse/pull/8084) ([Azat Khuzhin](https://github.com/azat))
- Fix `bitmapAnd` function error when intersecting an aggregated bitmap and a scalar bitmap. [#8082](https://github.com/ClickHouse/ClickHouse/pull/8082) ([Yue Huang](https://github.com/moon03432))
- Refine the definition of `ZXid` according to the ZooKeeper Programmer's Guide which fixes bug in `clickhouse-cluster-copier`. [#8088](https://github.com/ClickHouse/ClickHouse/pull/8088) ([Ding Xiang Fei](https://github.com/dingxiangfei2009))
- `odbc` table function now respects `external_table_functions_use_nulls` setting. [#7506](https://github.com/ClickHouse/ClickHouse/pull/7506) ([Vasily Nemkov](https://github.com/Enmk))
- Fixed bug that lead to a rare data race. [#8143](https://github.com/ClickHouse/ClickHouse/pull/8143) ([Alexander Kazakov](https://github.com/Akazz))
- Now `SYSTEM RELOAD DICTIONARY` reloads a dictionary completely, ignoring `update_field`. This fixes [#7440](https://github.com/ClickHouse/ClickHouse/issues/7440). [#8037](https://github.com/ClickHouse/ClickHouse/pull/8037) ([Vitaly Baranov](https://github.com/vitlibar))
- Add ability to check if dictionary exists in create query. [#8032](https://github.com/ClickHouse/ClickHouse/pull/8032) ([alesapin](https://github.com/alesapin))
- Fix `Float*` parsing in `Values` format. This fixes [#7817](https://github.com/ClickHouse/ClickHouse/issues/7817). [#7870](https://github.com/ClickHouse/ClickHouse/pull/7870) ([tavplubix](https://github.com/tavplubix))
- Fix crash when we cannot reserve space in some background operations of `*MergeTree` table engines family. [#7873](https://github.com/ClickHouse/ClickHouse/pull/7873) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix crash of merge operation when table contains `SimpleAggregateFunction(LowCardinality)` column. This fixes [#8515](https://github.com/ClickHouse/ClickHouse/issues/8515). [#8522](https://github.com/ClickHouse/ClickHouse/pull/8522) ([Azat Khuzhin](https://github.com/azat))
- Restore support of all ICU locales and add the ability to apply collations for constant expressions. Also add language name to `system.collations` table. [#8051](https://github.com/ClickHouse/ClickHouse/pull/8051) ([alesapin](https://github.com/alesapin))
- Fix bug when external dictionaries with zero minimal lifetime (`LIFETIME(MIN 0 MAX N)`, `LIFETIME(N)`) don't update in background. [#7983](https://github.com/ClickHouse/ClickHouse/pull/7983) ([alesapin](https://github.com/alesapin))
- Fix crash when external dictionary with ClickHouse source has subquery in query. [#8351](https://github.com/ClickHouse/ClickHouse/pull/8351) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Fix incorrect parsing of file extension in table with engine `URL`. This fixes [#8157](https://github.com/ClickHouse/ClickHouse/issues/8157). [#8419](https://github.com/ClickHouse/ClickHouse/pull/8419) ([Andrey Bodrov](https://github.com/apbodrov))
- Fix `CHECK TABLE` query for `*MergeTree` tables without key. Fixes [#7543](https://github.com/ClickHouse/ClickHouse/issues/7543). [#7979](https://github.com/ClickHouse/ClickHouse/pull/7979) ([alesapin](https://github.com/alesapin))
- Fixed conversion of `Float64` to MySQL type. [#8079](https://github.com/ClickHouse/ClickHouse/pull/8079) ([Yuriy Baranov](https://github.com/yurriy))
- Now if table was not completely dropped because of server crash, server will try to restore and load it. [#8176](https://github.com/ClickHouse/ClickHouse/pull/8176) ([tavplubix](https://github.com/tavplubix))
- Fixed crash in table function `file` while inserting into file that does not exist. Now in this case file would be created and then insert would be processed. [#8177](https://github.com/ClickHouse/ClickHouse/pull/8177) ([Olga Khvostikova](https://github.com/stavrolia))
- Fix rare deadlock which can happen when `trace_log` is in enabled. [#7838](https://github.com/ClickHouse/ClickHouse/pull/7838) ([filimonov](https://github.com/filimonov))
- Add ability to work with different types besides `Date` in `RangeHashed` external dictionary created from DDL query. Fixes [7899](https://github.com/ClickHouse/ClickHouse/issues/7899). [#8275](https://github.com/ClickHouse/ClickHouse/pull/8275) ([alesapin](https://github.com/alesapin))
- Fixes crash when `now64()` is called with result of another function. [#8270](https://github.com/ClickHouse/ClickHouse/pull/8270) ([Vasily Nemkov](https://github.com/Enmk))
- Fixed bug with detecting client IP for connections through mysql wire protocol. [#7743](https://github.com/ClickHouse/ClickHouse/pull/7743) ([Dmitry Muzyka](https://github.com/dmitriy-myz))
- Fix empty array handling in `arraySplit` function. This fixes [#7708](https://github.com/ClickHouse/ClickHouse/issues/7708). [#7747](https://github.com/ClickHouse/ClickHouse/pull/7747) ([hcz](https://github.com/hczhcz))
- Fixed the issue when `pid-file` of another running `clickhouse-server` may be deleted. [#8487](https://github.com/ClickHouse/ClickHouse/pull/8487) ([Weiqing Xu](https://github.com/weiqxu))
- Fix dictionary reload if it has `invalidate_query`, which stopped updates and some exception on previous update tries. [#8029](https://github.com/ClickHouse/ClickHouse/pull/8029) ([alesapin](https://github.com/alesapin))
- Fixed error in function `arrayReduce` that may lead to "double free" and error in aggregate function combinator `Resample` that may lead to memory leak. Added aggregate function `aggThrow`. This function can be used for testing purposes. [#8446](https://github.com/ClickHouse/ClickHouse/pull/8446) ([alexey-milovidov](https://github.com/alexey-milovidov))





#### 改善 {#improvement-22}

- Improved logging when working with `S3` table engine. [#8251](https://github.com/ClickHouse/ClickHouse/pull/8251) ([Grigory Pervakov](https://github.com/GrigoryPervakov))
- Printed help message when no arguments are passed when calling `clickhouse-local`. This fixes [#5335](https://github.com/ClickHouse/ClickHouse/issues/5335). [#8230](https://github.com/ClickHouse/ClickHouse/pull/8230) ([Andrey Nagorny](https://github.com/Melancholic))
- Add setting `mutations_sync` which allows to wait `ALTER UPDATE/DELETE` queries synchronously. [#8237](https://github.com/ClickHouse/ClickHouse/pull/8237) ([alesapin](https://github.com/alesapin))
- Allow to set up relative `user_files_path` in `config.xml` (in the way similar to `format_schema_path`). [#7632](https://github.com/ClickHouse/ClickHouse/pull/7632) ([hcz](https://github.com/hczhcz))
- Add exception for illegal types for conversion functions with `-OrZero` postfix. [#7880](https://github.com/ClickHouse/ClickHouse/pull/7880) ([Andrey Konyaev](https://github.com/akonyaev90))
- Simplify format of the header of data sending to a shard in a distributed query. [#8044](https://github.com/ClickHouse/ClickHouse/pull/8044) ([Vitaly Baranov](https://github.com/vitlibar))
- `Live View` table engine refactoring. [#8519](https://github.com/ClickHouse/ClickHouse/pull/8519) ([vzakaznikov](https://github.com/vzakaznikov))
- Add additional checks for external dictionaries created from DDL-queries. [#8127](https://github.com/ClickHouse/ClickHouse/pull/8127) ([alesapin](https://github.com/alesapin))
- Fix error `Column ... already exists` while using `FINAL` and `SAMPLE` together, e.g. `select count() from table final sample 1/2`. Fixes [#5186](https://github.com/ClickHouse/ClickHouse/issues/5186). [#7907](https://github.com/ClickHouse/ClickHouse/pull/7907) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Now table the first argument of `joinGet` function can be table identifier. [#7707](https://github.com/ClickHouse/ClickHouse/pull/7707) ([Amos Bird](https://github.com/amosbird))
- Allow using `MaterializedView` with subqueries above `Kafka` tables. [#8197](https://github.com/ClickHouse/ClickHouse/pull/8197) ([filimonov](https://github.com/filimonov))
- Now background moves between disks run it the seprate thread pool. [#7670](https://github.com/ClickHouse/ClickHouse/pull/7670) ([Vladimir Chebotarev](https://github.com/excitoon))
- `SYSTEM RELOAD DICTIONARY` now executes synchronously. [#8240](https://github.com/ClickHouse/ClickHouse/pull/8240) ([Vitaly Baranov](https://github.com/vitlibar))
- Stack traces now display physical addresses (offsets in object file) instead of virtual memory addresses (where the object file was loaded). That allows the use of `addr2line` when binary is position independent and ASLR is active. This fixes [#8360](https://github.com/ClickHouse/ClickHouse/issues/8360). [#8387](https://github.com/ClickHouse/ClickHouse/pull/8387) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Support new syntax for row-level security filters: `<table name='table_name'>...</table>`. Fixes [#5779](https://github.com/ClickHouse/ClickHouse/issues/5779). [#8381](https://github.com/ClickHouse/ClickHouse/pull/8381) ([Ivan](https://github.com/abyss7))
- Now `cityHash` function can work with `Decimal` and `UUID` types. Fixes [#5184](https://github.com/ClickHouse/ClickHouse/issues/5184). [#7693](https://github.com/ClickHouse/ClickHouse/pull/7693) ([Mikhail Korotov](https://github.com/millb))
- Removed fixed index granularity (it was 1024) from system logs because it's obsolete after implementation of adaptive granularity. [#7698](https://github.com/ClickHouse/ClickHouse/pull/7698) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Enabled MySQL compatibility server when ClickHouse is compiled without SSL. [#7852](https://github.com/ClickHouse/ClickHouse/pull/7852) ([Yuriy Baranov](https://github.com/yurriy))
- Now server checksums distributed batches, which gives more verbose errors in case of corrupted data in batch. [#7914](https://github.com/ClickHouse/ClickHouse/pull/7914) ([Azat Khuzhin](https://github.com/azat))
- Support `DROP DATABASE`, `DETACH TABLE`, `DROP TABLE` and `ATTACH TABLE` for `MySQL` database engine. [#8202](https://github.com/ClickHouse/ClickHouse/pull/8202) ([Winter Zhang](https://github.com/zhang2014))
- Add authentication in S3 table function and table engine. [#7623](https://github.com/ClickHouse/ClickHouse/pull/7623) ([Vladimir Chebotarev](https://github.com/excitoon))
- Added check for extra parts of `MergeTree` at different disks, in order to not allow to miss data parts at undefined disks. [#8118](https://github.com/ClickHouse/ClickHouse/pull/8118) ([Vladimir Chebotarev](https://github.com/excitoon))
- Enable SSL support for Mac client and server. [#8297](https://github.com/ClickHouse/ClickHouse/pull/8297) ([Ivan](https://github.com/abyss7))
- Now ClickHouse can work as MySQL federated server (see https://dev.mysql.com/doc/refman/5.7/en/federated-create-server.html). [#7717](https://github.com/ClickHouse/ClickHouse/pull/7717) ([Maxim Fedotov](https://github.com/MaxFedotov))
- `clickhouse-client` now only enable `bracketed-paste` when multiquery is on and multiline is off. This fixes [#7757](https://github.com/ClickHouse/ClickHouse/issues/7757). [#7761](https://github.com/ClickHouse/ClickHouse/pull/7761) ([Amos Bird](https://github.com/amosbird))
- Support `Array(Decimal)` in `if` function. [#7721](https://github.com/ClickHouse/ClickHouse/pull/7721) ([Artem Zuikov](https://github.com/4ertus2))
- Support Decimals in `arrayDifference`, `arrayCumSum` and `arrayCumSumNegative` functions. [#7724](https://github.com/ClickHouse/ClickHouse/pull/7724) ([Artem Zuikov](https://github.com/4ertus2))
- Added `lifetime` column to `system.dictionaries` table. [#6820](https://github.com/ClickHouse/ClickHouse/issues/6820) [#7727](https://github.com/ClickHouse/ClickHouse/pull/7727) ([kekekekule](https://github.com/kekekekule))
- Improved check for existing parts on different disks for `*MergeTree` table engines. Addresses [#7660](https://github.com/ClickHouse/ClickHouse/issues/7660). [#8440](https://github.com/ClickHouse/ClickHouse/pull/8440) ([Vladimir Chebotarev](https://github.com/excitoon))
- Integration with `AWS SDK` for `S3` interactions which allows to use all S3 features out of the box. [#8011](https://github.com/ClickHouse/ClickHouse/pull/8011) ([Pavel Kovalenko](https://github.com/Jokser))
- Added support for subqueries in `Live View` tables. [#7792](https://github.com/ClickHouse/ClickHouse/pull/7792) ([vzakaznikov](https://github.com/vzakaznikov))
- Check for using `Date` or `DateTime` column from `TTL` expressions was removed. [#7920](https://github.com/ClickHouse/ClickHouse/pull/7920) ([Vladimir Chebotarev](https://github.com/excitoon))
- Information about disk was added to `system.detached_parts` table. [#7833](https://github.com/ClickHouse/ClickHouse/pull/7833) ([Vladimir Chebotarev](https://github.com/excitoon))
- Now settings `max_(table|partition)_size_to_drop` can be changed without a restart. [#7779](https://github.com/ClickHouse/ClickHouse/pull/7779) ([Grigory Pervakov](https://github.com/GrigoryPervakov))
- Slightly better usability of error messages. Ask user not to remove the lines below `Stack trace:`. [#7897](https://github.com/ClickHouse/ClickHouse/pull/7897) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Better reading messages from `Kafka` engine in various formats after [#7935](https://github.com/ClickHouse/ClickHouse/issues/7935). [#8035](https://github.com/ClickHouse/ClickHouse/pull/8035) ([Ivan](https://github.com/abyss7))
- Better compatibility with MySQL clients which don't support `sha2_password` auth plugin. [#8036](https://github.com/ClickHouse/ClickHouse/pull/8036) ([Yuriy Baranov](https://github.com/yurriy))
- Support more column types in MySQL compatibility server. [#7975](https://github.com/ClickHouse/ClickHouse/pull/7975) ([Yuriy Baranov](https://github.com/yurriy))
- Implement `ORDER BY` optimization for `Merge`, `Buffer` and `Materilized View` storages with underlying `MergeTree` tables. [#8130](https://github.com/ClickHouse/ClickHouse/pull/8130) ([Anton Popov](https://github.com/CurtizJ))
- Now we always use POSIX implementation of `getrandom` to have better compatibility with old kernels (< 3.17). [#7940](https://github.com/ClickHouse/ClickHouse/pull/7940) ([Amos Bird](https://github.com/amosbird))
- Better check for valid destination in a move TTL rule. [#8410](https://github.com/ClickHouse/ClickHouse/pull/8410) ([Vladimir Chebotarev](https://github.com/excitoon))
- Better checks for broken insert batches for `Distributed` table engine. [#7933](https://github.com/ClickHouse/ClickHouse/pull/7933) ([Azat Khuzhin](https://github.com/azat))
- Add column with array of parts name which mutations must process in future to `system.mutations` table. [#8179](https://github.com/ClickHouse/ClickHouse/pull/8179) ([alesapin](https://github.com/alesapin))
- Parallel merge sort optimization for processors. [#8552](https://github.com/ClickHouse/ClickHouse/pull/8552) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- The settings `mark_cache_min_lifetime` is now obsolete and does nothing. In previous versions, mark cache can grow in memory larger than `mark_cache_size` to accomodate data within `mark_cache_min_lifetime` seconds. That was leading to confusion and higher memory usage than expected, that is especially bad on memory constrained systems. If you will see performance degradation after installing this release, you should increase the `mark_cache_size`. [#8484](https://github.com/ClickHouse/ClickHouse/pull/8484) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Preparation to use `tid` everywhere. This is needed for [#7477](https://github.com/ClickHouse/ClickHouse/issues/7477). [#8276](https://github.com/ClickHouse/ClickHouse/pull/8276) ([alexey-milovidov](https://github.com/alexey-milovidov))





#### パフォーマンス改善 {#performance-improvement-17}

- プロセッサパイプラインのパフォーマンス最適化。[#7988](https://github.com/ClickHouse/ClickHouse/pull/7988) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- キャッシュディクショナリにおける期限切れキーの非ブロッキング更新（古いキーの読み取りを許可）。[#8303](https://github.com/ClickHouse/ClickHouse/pull/8303) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- ClickHouseをグローバルに`-fno-omit-frame-pointer`なしでコンパイルし、レジスタを1つ追加で確保。[#8097](https://github.com/ClickHouse/ClickHouse/pull/8097) ([Amos Bird](https://github.com/amosbird))
- `greatCircleDistance`関数の高速化とパフォーマンステストの追加。[#7307](https://github.com/ClickHouse/ClickHouse/pull/7307) ([Olga Khvostikova](https://github.com/stavrolia))
- `roundDown`関数のパフォーマンス改善。[#8465](https://github.com/ClickHouse/ClickHouse/pull/8465) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `DateTime64`データ型における`max`、`min`、`argMin`、`argMax`のパフォーマンス改善。[#8199](https://github.com/ClickHouse/ClickHouse/pull/8199) ([Vasily Nemkov](https://github.com/Enmk))
- 制限なし、または大きな制限値と外部ソートを使用したソートのパフォーマンス改善。[#8545](https://github.com/ClickHouse/ClickHouse/pull/8545) ([alexey-milovidov](https://github.com/alexey-milovidov))
- 浮動小数点数のフォーマット処理のパフォーマンスを最大6倍改善。[#8542](https://github.com/ClickHouse/ClickHouse/pull/8542) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `modulo`関数のパフォーマンス改善。[#7750](https://github.com/ClickHouse/ClickHouse/pull/7750) ([Amos Bird](https://github.com/amosbird))
- 単一カラムキーによる`ORDER BY`とマージの最適化。[#8335](https://github.com/ClickHouse/ClickHouse/pull/8335) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `arrayReduce`、`-Array`、`-State`コンビネータの実装改善。[#7710](https://github.com/ClickHouse/ClickHouse/pull/7710) ([Amos Bird](https://github.com/amosbird))
- `PREWHERE`が少なくとも`WHERE`と同等の効率になるよう最適化。[#7769](https://github.com/ClickHouse/ClickHouse/pull/7769) ([Amos Bird](https://github.com/amosbird))
- `round`と`roundBankers`における負の数の処理方法を改善。[#8229](https://github.com/ClickHouse/ClickHouse/pull/8229) ([hcz](https://github.com/hczhcz))
- `DoubleDelta`と`Gorilla`コーデックのデコードパフォーマンスを約30-40%改善。これにより[#7082](https://github.com/ClickHouse/ClickHouse/issues/7082)を修正。[#8019](https://github.com/ClickHouse/ClickHouse/pull/8019) ([Vasily Nemkov](https://github.com/Enmk))
- `base64`関連関数のパフォーマンス改善。[#8444](https://github.com/ClickHouse/ClickHouse/pull/8444) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `geoDistance`関数を追加。`greatCircleDistance`と類似していますが、WGS-84楕円体モデルの近似を使用します。両関数のパフォーマンスはほぼ同等です。[#8086](https://github.com/ClickHouse/ClickHouse/pull/8086) ([alexey-milovidov](https://github.com/alexey-milovidov))
- `Decimal`データ型における`min`と`max`集約関数の高速化。[#8144](https://github.com/ClickHouse/ClickHouse/pull/8144) ([Artem Zuikov](https://github.com/4ertus2))
- `arrayReduce`処理のベクトル化。[#7608](https://github.com/ClickHouse/ClickHouse/pull/7608) ([Amos Bird](https://github.com/amosbird))
- `if`チェーンが`multiIf`として最適化されるようになりました。[#8355](https://github.com/ClickHouse/ClickHouse/pull/8355) ([kamalov-ruslan](https://github.com/kamalov-ruslan))
- 19.15で導入された`Kafka`テーブルエンジンのパフォーマンス低下を修正。これにより[#7261](https://github.com/ClickHouse/ClickHouse/issues/7261)を修正。[#7935](https://github.com/ClickHouse/ClickHouse/pull/7935) ([filimonov](https://github.com/filimonov))
- Debianパッケージの`gcc`がデフォルトで時折もたらす「pie」コード生成を削除。[#8483](https://github.com/ClickHouse/ClickHouse/pull/8483) ([alexey-milovidov](https://github.com/alexey-milovidov))
- データフォーマットの並列パース[#6553](https://github.com/ClickHouse/ClickHouse/pull/6553) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))
- 式を含む`Values`の最適化されたパーサーをデフォルトで有効化（`input_format_values_deduce_templates_of_expressions=1`）。[#8231](https://github.com/ClickHouse/ClickHouse/pull/8231) ([tavplubix](https://github.com/tavplubix))





#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-25}

- Build fixes for `ARM` and in minimal mode. [#8304](https://github.com/ClickHouse/ClickHouse/pull/8304) ([proller](https://github.com/proller))
- Add coverage file flush for `clickhouse-server` when std::atexit is not called. Also slightly improved logging in stateless tests with coverage. [#8267](https://github.com/ClickHouse/ClickHouse/pull/8267) ([alesapin](https://github.com/alesapin))
- Update LLVM library in contrib. Avoid using LLVM from OS packages. [#8258](https://github.com/ClickHouse/ClickHouse/pull/8258) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Make bundled `curl` build fully quiet. [#8232](https://github.com/ClickHouse/ClickHouse/pull/8232) [#8203](https://github.com/ClickHouse/ClickHouse/pull/8203) ([Pavel Kovalenko](https://github.com/Jokser))
- Fix some `MemorySanitizer` warnings. [#8235](https://github.com/ClickHouse/ClickHouse/pull/8235) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Use `add_warning` and `no_warning` macros in `CMakeLists.txt`. [#8604](https://github.com/ClickHouse/ClickHouse/pull/8604) ([Ivan](https://github.com/abyss7))
- Add support of Minio S3 Compatible object (https://min.io/) for better integration tests. [#7863](https://github.com/ClickHouse/ClickHouse/pull/7863) [#7875](https://github.com/ClickHouse/ClickHouse/pull/7875) ([Pavel Kovalenko](https://github.com/Jokser))
- Imported `libc` headers to contrib. It allows to make builds more consistent across various systems (only for `x86_64-linux-gnu`). [#5773](https://github.com/ClickHouse/ClickHouse/pull/5773) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Remove `-fPIC` from some libraries. [#8464](https://github.com/ClickHouse/ClickHouse/pull/8464) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Clean `CMakeLists.txt` for curl. See https://github.com/ClickHouse/ClickHouse/pull/8011#issuecomment-569478910 [#8459](https://github.com/ClickHouse/ClickHouse/pull/8459) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Silent warnings in `CapNProto` library. [#8220](https://github.com/ClickHouse/ClickHouse/pull/8220) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Add performance tests for short string optimized hash tables. [#7679](https://github.com/ClickHouse/ClickHouse/pull/7679) ([Amos Bird](https://github.com/amosbird))
- Now ClickHouse will build on `AArch64` even if `MADV_FREE` is not available. This fixes [#8027](https://github.com/ClickHouse/ClickHouse/issues/8027). [#8243](https://github.com/ClickHouse/ClickHouse/pull/8243) ([Amos Bird](https://github.com/amosbird))
- Update `zlib-ng` to fix memory sanitizer problems. [#7182](https://github.com/ClickHouse/ClickHouse/pull/7182) [#8206](https://github.com/ClickHouse/ClickHouse/pull/8206) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Enable internal MySQL library on non-Linux system, because usage of OS packages is very fragile and usually does not work at all. This fixes [#5765](https://github.com/ClickHouse/ClickHouse/issues/5765). [#8426](https://github.com/ClickHouse/ClickHouse/pull/8426) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed build on some systems after enabling `libc++`. This supersedes [#8374](https://github.com/ClickHouse/ClickHouse/issues/8374). [#8380](https://github.com/ClickHouse/ClickHouse/pull/8380) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Make `Field` methods more type-safe to find more errors. [#7386](https://github.com/ClickHouse/ClickHouse/pull/7386) [#8209](https://github.com/ClickHouse/ClickHouse/pull/8209) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Added missing files to the `libc-headers` submodule. [#8507](https://github.com/ClickHouse/ClickHouse/pull/8507) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix wrong `JSON` quoting in performance test output. [#8497](https://github.com/ClickHouse/ClickHouse/pull/8497) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Now stack trace is displayed for `std::exception` and `Poco::Exception`. In previous versions it was available only for `DB::Exception`. This improves diagnostics. [#8501](https://github.com/ClickHouse/ClickHouse/pull/8501) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Porting `clock_gettime` and `clock_nanosleep` for fresh glibc versions. [#8054](https://github.com/ClickHouse/ClickHouse/pull/8054) ([Amos Bird](https://github.com/amosbird))
- Enable `part_log` in example config for developers. [#8609](https://github.com/ClickHouse/ClickHouse/pull/8609) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix async nature of reload in `01036_no_superfluous_dict_reload_on_create_database*`. [#8111](https://github.com/ClickHouse/ClickHouse/pull/8111) ([Azat Khuzhin](https://github.com/azat))
- Fixed codec performance tests. [#8615](https://github.com/ClickHouse/ClickHouse/pull/8615) ([Vasily Nemkov](https://github.com/Enmk))
- Add install scripts for `.tgz` build and documentation for them. [#8612](https://github.com/ClickHouse/ClickHouse/pull/8612) [#8591](https://github.com/ClickHouse/ClickHouse/pull/8591) ([alesapin](https://github.com/alesapin))
- Removed old `ZSTD` test (it was created in year 2016 to reproduce the bug that pre 1.0 version of ZSTD has had). This fixes [#8618](https://github.com/ClickHouse/ClickHouse/issues/8618). [#8619](https://github.com/ClickHouse/ClickHouse/pull/8619) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed build on Mac OS Catalina. [#8600](https://github.com/ClickHouse/ClickHouse/pull/8600) ([meo](https://github.com/meob))
- Increased number of rows in codec performance tests to make results noticeable. [#8574](https://github.com/ClickHouse/ClickHouse/pull/8574) ([Vasily Nemkov](https://github.com/Enmk))
- In debug builds, treat `LOGICAL_ERROR` exceptions as assertion failures, so that they are easier to notice. [#8475](https://github.com/ClickHouse/ClickHouse/pull/8475) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Make formats-related performance test more deterministic. [#8477](https://github.com/ClickHouse/ClickHouse/pull/8477) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Update `lz4` to fix a MemorySanitizer failure. [#8181](https://github.com/ClickHouse/ClickHouse/pull/8181) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Suppress a known MemorySanitizer false positive in exception handling. [#8182](https://github.com/ClickHouse/ClickHouse/pull/8182) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Update `gcc` and `g++` to version 9 in `build/docker/build.sh` [#7766](https://github.com/ClickHouse/ClickHouse/pull/7766) ([TLightSky](https://github.com/tlightsky))
- Add performance test case to test that `PREWHERE` is worse than `WHERE`. [#7768](https://github.com/ClickHouse/ClickHouse/pull/7768) ([Amos Bird](https://github.com/amosbird))
- Progress towards fixing one flacky test. [#8621](https://github.com/ClickHouse/ClickHouse/pull/8621) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Avoid MemorySanitizer report for data from `libunwind`. [#8539](https://github.com/ClickHouse/ClickHouse/pull/8539) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Updated `libc++` to the latest version. [#8324](https://github.com/ClickHouse/ClickHouse/pull/8324) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Build ICU library from sources. This fixes [#6460](https://github.com/ClickHouse/ClickHouse/issues/6460). [#8219](https://github.com/ClickHouse/ClickHouse/pull/8219) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Switched from `libressl` to `openssl`. ClickHouse should support TLS 1.3 and SNI after this change. This fixes [#8171](https://github.com/ClickHouse/ClickHouse/issues/8171). [#8218](https://github.com/ClickHouse/ClickHouse/pull/8218) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fixed UBSan report when using `chacha20_poly1305` from SSL (happens on connect to https://yandex.ru/). [#8214](https://github.com/ClickHouse/ClickHouse/pull/8214) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix mode of default password file for `.deb` linux distros. [#8075](https://github.com/ClickHouse/ClickHouse/pull/8075) ([proller](https://github.com/proller))
- Improved expression for getting `clickhouse-server` PID in `clickhouse-test`. [#8063](https://github.com/ClickHouse/ClickHouse/pull/8063) ([Alexander Kazakov](https://github.com/Akazz))
- Updated contrib/googletest to v1.10.0. [#8587](https://github.com/ClickHouse/ClickHouse/pull/8587) ([Alexander Burmak](https://github.com/Alex-Burmak))
- Fixed ThreadSaninitizer report in `base64` library. Also updated this library to the latest version, but it does not matter. This fixes [#8397](https://github.com/ClickHouse/ClickHouse/issues/8397). [#8403](https://github.com/ClickHouse/ClickHouse/pull/8403) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Fix `00600_replace_running_query` for processors. [#8272](https://github.com/ClickHouse/ClickHouse/pull/8272) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Remove support for `tcmalloc` to make `CMakeLists.txt` simpler. [#8310](https://github.com/ClickHouse/ClickHouse/pull/8310) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Release gcc builds now use `libc++` instead of `libstdc++`. Recently `libc++` was used only with clang. This will improve consistency of build configurations and portability. [#8311](https://github.com/ClickHouse/ClickHouse/pull/8311) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Enable ICU library for build with MemorySanitizer. [#8222](https://github.com/ClickHouse/ClickHouse/pull/8222) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Suppress warnings from `CapNProto` library. [#8224](https://github.com/ClickHouse/ClickHouse/pull/8224) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Removed special cases of code for `tcmalloc`, because it's no longer supported. [#8225](https://github.com/ClickHouse/ClickHouse/pull/8225) ([alexey-milovidov](https://github.com/alexey-milovidov))
- In CI coverage task, kill the server gracefully to allow it to save the coverage report. This fixes incomplete coverage reports we've been seeing lately. [#8142](https://github.com/ClickHouse/ClickHouse/pull/8142) ([alesapin](https://github.com/alesapin))
- Performance tests for all codecs against `Float64` and `UInt64` values. [#8349](https://github.com/ClickHouse/ClickHouse/pull/8349) ([Vasily Nemkov](https://github.com/Enmk))
- `termcap` is very much deprecated and lead to various problems (f.g. missing "up" cap and echoing `^J` instead of multi line) . Favor `terminfo` or bundled `ncurses`. [#7737](https://github.com/ClickHouse/ClickHouse/pull/7737) ([Amos Bird](https://github.com/amosbird))
- Fix `test_storage_s3` integration test. [#7734](https://github.com/ClickHouse/ClickHouse/pull/7734) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Support `StorageFile(<format>, null) ` to insert block into given format file without actually write to disk. This is required for performance tests. [#8455](https://github.com/ClickHouse/ClickHouse/pull/8455) ([Amos Bird](https://github.com/amosbird))
- Added argument `--print-time` to functional tests which prints execution time per test. [#8001](https://github.com/ClickHouse/ClickHouse/pull/8001) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Added asserts to `KeyCondition` while evaluating RPN. This will fix warning from gcc-9. [#8279](https://github.com/ClickHouse/ClickHouse/pull/8279) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Dump cmake options in CI builds. [#8273](https://github.com/ClickHouse/ClickHouse/pull/8273) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Don't generate debug info for some fat libraries. [#8271](https://github.com/ClickHouse/ClickHouse/pull/8271) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Make `log_to_console.xml` always log to stderr, regardless of is it interactive or not. [#8395](https://github.com/ClickHouse/ClickHouse/pull/8395) ([Alexander Kuzmenkov](https://github.com/akuzm))
- Removed some unused features from `clickhouse-performance-test` tool. [#8555](https://github.com/ClickHouse/ClickHouse/pull/8555) ([alexey-milovidov](https://github.com/alexey-milovidov))
- Now we will also search for `lld-X` with corresponding `clang-X` version. [#8092](https://github.com/ClickHouse/ClickHouse/pull/8092) ([alesapin](https://github.com/alesapin))
- Parquet build improvement. [#8421](https://github.com/ClickHouse/ClickHouse/pull/8421) ([maxulan](https://github.com/maxulan))
- More GCC warnings [#8221](https://github.com/ClickHouse/ClickHouse/pull/8221) ([kreuzerkrieg](https://github.com/kreuzerkrieg))
- Package for Arch Linux now allows to run ClickHouse server, and not only client. [#8534](https://github.com/ClickHouse/ClickHouse/pull/8534) ([Vladimir Chebotarev](https://github.com/excitoon))
- Fix test with processors. Tiny performance fixes. [#7672](https://github.com/ClickHouse/ClickHouse/pull/7672) ([Nikolai Kochetov](https://github.com/KochetovNicolai))
- Update contrib/protobuf. [#8256](https://github.com/ClickHouse/ClickHouse/pull/8256) ([Matwey V. Kornilov](https://github.com/matwey))
- In preparation of switching to c++20 as a new year celebration. "May the C++ force be with ClickHouse." [#8447](https://github.com/ClickHouse/ClickHouse/pull/8447) ([Amos Bird](https://github.com/amosbird))

#### 実験的機能 {#experimental-feature-8}

- 実験的設定 `min_bytes_to_use_mmap_io` を追加しました。カーネルからユーザー空間へのデータコピーを行わずに大きなファイルを読み取ることができます。この設定はデフォルトで無効になっています。mmap/munmapは低速であるため、推奨される閾値は約64MBです。[#8520](https://github.com/ClickHouse/ClickHouse/pull/8520) ([alexey-milovidov](https://github.com/alexey-milovidov))
- アクセス制御システムの一部としてクォータを再設計しました。新しいテーブル `system.quotas`、新しい関数 `currentQuota`、`currentQuotaKey`、新しいSQL構文 `CREATE QUOTA`、`ALTER QUOTA`、`DROP QUOTA`、`SHOW QUOTA` を追加しました。[#7257](https://github.com/ClickHouse/ClickHouse/pull/7257) ([Vitaly Baranov](https://github.com/vitlibar))
- 例外をスローする代わりに、警告を出して未知の設定をスキップできるようにしました。[#7653](https://github.com/ClickHouse/ClickHouse/pull/7653) ([Vitaly Baranov](https://github.com/vitlibar))
- アクセス制御システムの一部として行ポリシーを再設計しました。新しいテーブル `system.row_policies`、新しい関数 `currentRowPolicies()`、新しいSQL構文 `CREATE POLICY`、`ALTER POLICY`、`DROP POLICY`、`SHOW CREATE POLICY`、`SHOW POLICIES` を追加しました。[#7808](https://github.com/ClickHouse/ClickHouse/pull/7808) ([Vitaly Baranov](https://github.com/vitlibar))

#### セキュリティ修正 {#security-fix}

- `File` テーブルエンジンを使用したテーブルでディレクトリ構造を読み取れる可能性を修正しました。これにより [#8536](https://github.com/ClickHouse/ClickHouse/issues/8536) が修正されます。[#8537](https://github.com/ClickHouse/ClickHouse/pull/8537) ([alexey-milovidov](https://github.com/alexey-milovidov))


## [2019年の変更履歴](./2019.md) {#changelog-for-2019}
