---
slug: /whats-new/changelog/2022
sidebar_position: 5
sidebar_label: "2022"
title: "2022年の変更履歴"
description: "2022年の変更履歴"
keywords:
  [
    "ClickHouse 2022",
    "changelog 2022",
    "リリースノート",
    "バージョン履歴",
    "機能更新"
  ]
doc_type: "changelog"
---

### <a id="2212"></a> ClickHouse リリース 22.12, 2022-12-15 {#a-id2212a-clickhouse-release-2212-2022-12-15}

:::warning

このリリースには、一部のLinuxディストリビューションでアップグレード時にClickHouseのインストールを破損させる可能性のある不具合のあるsystemdサービスコメントが含まれています。systemdサービスが`/run/systemd`のディレクトリ所有者権限を変更するため、その後のすべてのsystemd操作が失敗します。このバージョンへのアップグレードはスキップし、代わりにClickHouseの新しいバージョンにアップグレードすることを推奨します。

詳細については、GitHubの以下のissueを参照してください: https://github.com/ClickHouse/ClickHouse/issues/48285

:::

#### アップグレードに関する注意事項 {#upgrade-notes}

- `String`引数を持つ`min`、`max`、`any*`、`argMin`、`argMax`集約関数の状態の(デ)シリアライゼーションにおける後方互換性の問題を修正しました。この非互換性は22.9、22.10、22.11ブランチに影響します(それぞれ22.9.6、22.10.4、22.11.2以降で修正済み)。22.3、22.7、22.8ブランチの一部のマイナーリリースも影響を受けます: 22.3.13...22.3.14(22.3.15以降で修正済み)、22.8.6...22.8.9(22.8.10以降で修正済み)、22.7.6以降(22.7では修正されないため、22.7.\*から22.8.10以降へのアップグレードを推奨します)。このリリースノートは、影響を受けるバージョンを使用したことがないユーザーには該当しません。非互換バージョンは、上記の集約関数の状態を読み取る際に文字列に余分な`'\0'`を追加します。例えば、古いバージョンが`anyState('foobar')`の状態を`state_column`に保存した場合、非互換バージョンは`anyMerge(state_column)`で`'foobar\0'`を出力します。また、非互換バージョンは末尾の`'\0'`なしで集約関数の状態を書き込みます。修正を含む新しいバージョンは、非互換バージョンを含むすべてのバージョンによって書き込まれたデータを正しく読み取ることができますが、1つのコーナーケースを除きます。非互換バージョンが実際にnull文字で終わる文字列を含む状態を保存した場合、新しいバージョンは影響を受ける集約関数の状態を読み取る際に末尾の`'\0'`をトリムします。例えば、非互換バージョンが`anyState('abrac\0dabra\0')`の状態を`state_column`に保存した場合、新しいバージョンは`anyMerge(state_column)`で`'abrac\0dabra'`を出力します。この問題は、非互換バージョンが古いバージョンまたは新しいバージョンと一緒にクラスタで動作する場合の分散クエリにも影響します。[#43038](https://github.com/ClickHouse/ClickHouse/pull/43038) ([Alexander Tokmakov](https://github.com/tavplubix), [Raúl Marín](https://github.com/Algunenano))。注意: すべての公式ClickHouseビルドには既にパッチが含まれています。これは、使用を避けるべき非公式のサードパーティビルドには必ずしも当てはまりません。


#### 新機能 {#new-feature}

- `BSONEachRow` 入出力フォーマットを追加しました。このフォーマットでは、ClickHouseは各行を個別のBSONドキュメントとしてフォーマット/パースし、各カラムはカラム名をキーとする単一のBSONフィールドとしてフォーマット/パースされます。[#42033](https://github.com/ClickHouse/ClickHouse/pull/42033) ([mark-polokhov](https://github.com/mark-polokhov))。
- `grace_hash` JOINアルゴリズムを追加しました。`SET join_algorithm = 'grace_hash'` で有効化できます。[#38191](https://github.com/ClickHouse/ClickHouse/pull/38191) ([BigRedEye](https://github.com/BigRedEye), [Vladimir C](https://github.com/vdimir))。
- ユーザーの作成および変更時のパスワード複雑性ルールとチェックを設定できるようになりました。[#43719](https://github.com/ClickHouse/ClickHouse/pull/43719) ([Nikolay Degterinsky](https://github.com/evillique))。
- ログ内の機密情報をマスクし、`SHOW CREATE TABLE` および `SELECT FROM system.tables` クエリの出力内の秘密部分をマスクします。また、[#41418](https://github.com/ClickHouse/ClickHouse/issues/41418) を解決します。[#43227](https://github.com/ClickHouse/ClickHouse/pull/43227) ([Vitaly Baranov](https://github.com/vitlibar))。
- `GROUP BY ALL` 構文を追加しました: [#37631](https://github.com/ClickHouse/ClickHouse/issues/37631)。[#42265](https://github.com/ClickHouse/ClickHouse/pull/42265) ([刘陶峰](https://github.com/taofengliu))。
- `FROM table SELECT column` 構文を追加しました。[#41095](https://github.com/ClickHouse/ClickHouse/pull/41095) ([Nikolay Degterinsky](https://github.com/evillique))。
- Spark SQL互換性のため、関数 `concatWithSeparator` と別名 `concat_ws` を追加しました。`concatAssumeInjective` と同様に、GROUP BY最適化を有効にするバリアントとして関数 `concatWithSeparatorAssumeInjective` を追加しました。[#43749](https://github.com/ClickHouse/ClickHouse/pull/43749) ([李扬](https://github.com/taiyang-li))。
- 固定精度での小数演算のための `multiplyDecimal` および `divideDecimal` 関数を追加しました。[#42438](https://github.com/ClickHouse/ClickHouse/pull/42438) ([Andrey Zvonov](https://github.com/zvonand))。
- 現在移動中のパーツのリストを含む `system.moves` テーブルを追加しました。[#42660](https://github.com/ClickHouse/ClickHouse/pull/42660) ([Sergei Trifonov](https://github.com/serxa))。
- ClickHouse Keeper用の組み込みPrometheusエンドポイントのサポートを追加しました。[#43087](https://github.com/ClickHouse/ClickHouse/pull/43087) ([Antonio Andelic](https://github.com/antonio2368))。
- 区切り文字として `_` を使用した数値リテラルをサポートしました。例: `1_000_000`。[#43925](https://github.com/ClickHouse/ClickHouse/pull/43925) ([jh0x](https://github.com/jh0x))。
- `cutURLParameter` 関数の第2パラメータとして配列を使用できるようになりました。複数のパラメータを削除できます。[#6827](https://github.com/ClickHouse/ClickHouse/issues/6827) をクローズします。[#43788](https://github.com/ClickHouse/ClickHouse/pull/43788) ([Roman Vasin](https://github.com/rvasin))。
- `system.data_skipping_indices` テーブルにインデックスの式を含むカラムを追加しました。[#43308](https://github.com/ClickHouse/ClickHouse/pull/43308) ([Guillaume Tassery](https://github.com/YiuRULE))。
- システムテーブル `databases` にカラム `engine_full` を追加し、ユーザーがシステムテーブル経由でデータベースのエンジン定義全体にアクセスできるようにしました。[#43468](https://github.com/ClickHouse/ClickHouse/pull/43468) ([凌涛](https://github.com/lingtaolf))。
- 新しいハッシュ関数 [xxh3](https://github.com/Cyan4973/xxHash) を追加しました。また、ライブラリの更新により、ARM上での `xxHash32` および `xxHash64` のパフォーマンスが向上しました。[#43411](https://github.com/ClickHouse/ClickHouse/pull/43411) ([Nikita Taranov](https://github.com/nickitat))。
- マージツリー設定の制約を定義するサポートを追加しました。例えば、ユーザーによる `storage_policy` の上書きを禁止できます。[#43903](https://github.com/ClickHouse/ClickHouse/pull/43903) ([Sergei Trifonov](https://github.com/serxa))。
- すべてのJSON入力フォーマットでネストされたJSONオブジェクトを文字列としてパースできる新しい設定 `input_format_json_read_objects_as_strings` を追加しました。この設定はデフォルトで無効です。[#44052](https://github.com/ClickHouse/ClickHouse/pull/44052) ([Kruglov Pavel](https://github.com/Avogar))。

#### 実験的機能 {#experimental-feature}

- 非同期挿入の重複排除をサポートしました。この変更以前は、1つの挿入バッチ内に複数の小さな挿入が共存していたため、非同期挿入では重複排除がサポートされていませんでした。Closes [#38075](https://github.com/ClickHouse/ClickHouse/issues/38075). [#43304](https://github.com/ClickHouse/ClickHouse/pull/43304) ([Han Fei](https://github.com/hanfei1991)).
- 実験的なAnnoy（ベクトル類似度検索）インデックスにコサイン距離のサポートを追加しました。[#42778](https://github.com/ClickHouse/ClickHouse/pull/42778) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
- `CREATE / ALTER / DROP NAMED COLLECTION`クエリを追加しました。[#43252](https://github.com/ClickHouse/ClickHouse/pull/43252) ([Kseniia Sumarokova](https://github.com/kssenii)). この機能は開発中であり、バージョン22.12時点ではクエリは有効ではありません。この変更履歴エントリは混乱を避けるためにのみ追加されています。名前付きコレクションへのデフォルトアクセスを、設定ファイルで定義されたユーザーに制限しました。これらを表示するには`show_named_collections = 1`の設定が必要です。[#43325](https://github.com/ClickHouse/ClickHouse/pull/43325) ([Kseniia Sumarokova](https://github.com/kssenii)). `system.named_collections`テーブルが導入されました [#43147](https://github.com/ClickHouse/ClickHouse/pull/43147) ([Kseniia Sumarokova](https://github.com/kssenii)).


#### パフォーマンス改善 {#performance-improvement}

- 設定 `max_streams_for_merge_tree_reading` および `allow_asynchronous_read_from_io_pool_for_merge_tree` を追加しました。設定 `max_streams_for_merge_tree_reading` は MergeTree テーブルの読み取りストリーム数を制限します。設定 `allow_asynchronous_read_from_io_pool_for_merge_tree` は `MergeTree` テーブルから読み取るためのバックグラウンド I/O プールを有効にします。`max_streams_to_max_threads_ratio` または `max_streams_for_merge_tree_reading` と併用することで、I/O バウンドなクエリのパフォーマンスを向上させる可能性があります。[#43260](https://github.com/ClickHouse/ClickHouse/pull/43260) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。高レイテンシストレージ、少数の CPU、および多数のデータパーツの環境では、パフォーマンスが最大 100 倍向上します。
- 設定 `merge_tree_min_rows_for_concurrent_read_for_remote_filesystem/merge_tree_min_bytes_for_concurrent_read_for_remote_filesystem` は適応的粒度を考慮していませんでした。大きな行は読み取り行数を減少させませんでした(`merge_tree_min_rows_for_concurrent_read/merge_tree_min_bytes_for_concurrent_read` で行われていたように)。これにより、リモートファイルシステムを使用する際に高いメモリ使用量につながる可能性がありました。[#43965](https://github.com/ClickHouse/ClickHouse/pull/43965) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- マージするパーツを選択する際の ZooKeeper または ClickHouse Keeper へのリストリクエスト数を最適化しました。以前は、場合によっては数千のリクエストが発生する可能性がありました。修正: [#43647](https://github.com/ClickHouse/ClickHouse/issues/43647)。[#43675](https://github.com/ClickHouse/ClickHouse/pull/43675) ([Alexander Tokmakov](https://github.com/tavplubix))。
- `max_size_to_preallocate_for_aggregation` の値が小さすぎる場合、最適化がスキップされるようになりました。この設定のデフォルト値は `10^8` に増加しました。[#43945](https://github.com/ClickHouse/ClickHouse/pull/43945) ([Nikita Taranov](https://github.com/nickitat))。
- 古いデータパーツのクリーンアップを回避することで、サーバーのシャットダウンを高速化しました。https://github.com/ClickHouse/ClickHouse/pull/41145 以降は不要になったためです。[#43760](https://github.com/ClickHouse/ClickHouse/pull/43760) ([Sema Checherinda](https://github.com/CheSema))。
- `enable_memory_bound_merging_of_aggregation_results` が設定されている場合、イニシエーターでのマージは、ローカル集計結果のマージと同じメモリバウンドアプローチを使用するようになりました。[#40879](https://github.com/ClickHouse/ClickHouse/pull/40879) ([Nikita Taranov](https://github.com/nickitat))。
- Keeper の改善: レプリケーションと並行してログをディスクに同期するようになりました。[#43450](https://github.com/ClickHouse/ClickHouse/pull/43450) ([Antonio Andelic](https://github.com/antonio2368))。
- Keeper の改善: リクエストがより頻繁にバッチ処理されるようになりました。バッチ処理は新しい設定 `max_requests_quick_batch_size` で制御できます。[#43686](https://github.com/ClickHouse/ClickHouse/pull/43686) ([Antonio Andelic](https://github.com/antonio2368))。


#### 改善 {#improvement}

- 参照依存関係を実装し、バックアップからの復元時に正しい順序でテーブルを作成できるようにしました。[#43834](https://github.com/ClickHouse/ClickHouse/pull/43834) ([Vitaly Baranov](https://github.com/vitlibar))。
- 起動時のロード中の失敗を回避するため、`CREATE`クエリ内のUDFを置換します。また、UDFをカラムの`DEFAULT`式として使用できるようになりました。[#43539](https://github.com/ClickHouse/ClickHouse/pull/43539) ([Antonio Andelic](https://github.com/antonio2368))。
- 次のクエリによるパーツ削除方法を変更しました:TRUNCATE TABLE、ALTER TABLE DROP PART、ALTER TABLE DROP PARTITION。これらのクエリは、古いパーツをカバーする空のパーツを作成するようになりました。これにより、TRUNCATEクエリは排他ロックなしで動作し、同時読み取りがブロックされなくなります。また、これらすべてのクエリで耐久性を実現しました。リクエストが成功すれば、後で復活したパーツは表示されません。なお、原子性はトランザクションスコープ内でのみ達成されます。[#41145](https://github.com/ClickHouse/ClickHouse/pull/41145) ([Sema Checherinda](https://github.com/CheSema))。
- `SET param_x`クエリは、パラメータ値の手動文字列シリアライゼーションが不要になりました。例えば、クエリ`SET param_a = '[\'a\', \'b\']'`は`SET param_a = ['a', 'b']`のように記述できるようになりました。[#41874](https://github.com/ClickHouse/ClickHouse/pull/41874) ([Nikolay Degterinsky](https://github.com/evillique))。
- クライアントからSTDINを読み取る際に、進行状況表示で読み取った行数を表示します。[#43423](https://github.com/ClickHouse/ClickHouse/issues/43423)を解決します。[#43442](https://github.com/ClickHouse/ClickHouse/pull/43442) ([Kseniia Sumarokova](https://github.com/kssenii))。
- s3テーブル関数/エンジンから読み取る際に進行状況バーを表示します。[#43454](https://github.com/ClickHouse/ClickHouse/pull/43454) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 進行状況バーは読み取った行数と書き込んだ行数の両方を表示します。[#43496](https://github.com/ClickHouse/ClickHouse/pull/43496) ([Ilya Yatsishin](https://github.com/qoega))。
- `filesystemAvailable`および関連関数は、ディスク名を持つオプション引数を1つサポートし、`filesystemFree`を`filesystemUnreserved`に変更しました。[#35076](https://github.com/ClickHouse/ClickHouse/issues/35076)を解決します。[#42064](https://github.com/ClickHouse/ClickHouse/pull/42064) ([flynn](https://github.com/ucasfl))。
- LDAPとの統合:search_limitのデフォルト値を256に増やし、任意の値に変更するためのLDAPサーバー設定オプションを追加しました。[#42276](https://github.com/ClickHouse/ClickHouse/issues/42276)を解決します。[#42461](https://github.com/ClickHouse/ClickHouse/pull/42461) ([Vasily Nemkov](https://github.com/Enmk))。
- 例外メッセージからも機密情報(設定ファイルの`query_masking_rules`を参照)を削除できるようにしました。[#41418](https://github.com/ClickHouse/ClickHouse/issues/41418)を解決します。[#42940](https://github.com/ClickHouse/ClickHouse/pull/42940) ([filimonov](https://github.com/filimonov))。
- MySQL互換性のため、`SHOW FULL TABLES ...`のようなクエリをサポートします。[#43910](https://github.com/ClickHouse/ClickHouse/pull/43910) ([Filatenkov Artur](https://github.com/FArthur-cmd))。
- Keeperの改善:ノードを手動でリーダーとして割り当てることができる4lwコマンド`rqld`を追加しました。[#43026](https://github.com/ClickHouse/ClickHouse/pull/43026) ([JackyWoo](https://github.com/JackyWoo))。
- クエリからのDistributed非同期INSERTに接続タイムアウト設定を適用します。[#43156](https://github.com/ClickHouse/ClickHouse/pull/43156) ([Azat Khuzhin](https://github.com/azat))。
- `unhex`関数が`FixedString`引数をサポートするようになりました。[issue42369](https://github.com/ClickHouse/ClickHouse/issues/42369)。[#43207](https://github.com/ClickHouse/ClickHouse/pull/43207) ([DR](https://github.com/freedomDR))。
- TTLルールに従って完全に期限切れのパーツの削除が優先されます。[#42869](https://github.com/ClickHouse/ClickHouse/issues/42869)を参照してください。[#43222](https://github.com/ClickHouse/ClickHouse/pull/43222) ([zhongyuankai](https://github.com/zhongyuankai))。
- clickhouse-clientでより正確で反応性の高いCPU負荷表示を実現しました。[#43307](https://github.com/ClickHouse/ClickHouse/pull/43307) ([Sergei Trifonov](https://github.com/serxa))。
- ストレージ`S3`およびテーブル関数`s3`から、`Parquet`、`Arrow`、`ORC`形式でネストされた型のサブカラムの読み取りをサポートします。[#43329](https://github.com/ClickHouse/ClickHouse/pull/43329) ([chen](https://github.com/xiedeyantu))。
- `system.parts`テーブルに`table_uuid`カラムを追加しました。[#43404](https://github.com/ClickHouse/ClickHouse/pull/43404) ([Azat Khuzhin](https://github.com/azat))。
- 非対話モードでローカルに処理された行数を表示するクライアントオプション(`--print-num-processed-rows`)を追加しました。[#43407](https://github.com/ClickHouse/ClickHouse/pull/43407) ([jh0x](https://github.com/jh0x))。
- クエリプラン上で`aggregation-in-order`最適化を実装しました。デフォルトで有効になっています(ただし、デフォルトで無効になっている`optimize_aggregation_in_order`と一緒にのみ動作します)。以前のASTベースのバージョンを使用するには、`query_plan_aggregation_in_order = 0`を設定してください。[#43592](https://github.com/ClickHouse/ClickHouse/pull/43592) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- `trace_type = 'ProfileEvent'`を使用して、各インクリメント時に現在のスタック、プロファイルイベント名、インクリメント値とともに`system.trace_log`にプロファイルイベントを収集できるようにしました。設定`trace_profile_events`で有効にでき、クエリのパフォーマンス調査に使用できます。[#43639](https://github.com/ClickHouse/ClickHouse/pull/43639) ([Anton Popov](https://github.com/CurtizJ))。
- RowBinary形式で文字列サイズを制限する新しい設定`input_format_max_binary_string_size`を追加しました。[#43842](https://github.com/ClickHouse/ClickHouse/pull/43842) ([Kruglov Pavel](https://github.com/Avogar))。
- ClickHouseがリモートHTTPサーバーにリクエストし、エラーが返された場合、例外メッセージに数値HTTPコードが正しく表示されませんでした。[#43919](https://github.com/ClickHouse/ClickHouse/issues/43919)を解決します。[#43920](https://github.com/ClickHouse/ClickHouse/pull/43920) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 複数のJOIN最適化が行われている場合でも、クエリのエラーを正しく報告します。[#43583](https://github.com/ClickHouse/ClickHouse/pull/43583) ([Salvatore](https://github.com/tbsal))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement}

- Systemd統合が改善され、サービスが正常に起動してリクエストを処理できる状態になったことをsystemdに正しく通知するようになりました。[#43400](https://github.com/ClickHouse/ClickHouse/pull/43400) ([Коренберг Марк](https://github.com/socketpair))。
- [OpenSSL FIPS Module](https://www.openssl.org/docs/man3.0/man7/fips_module.html)を使用してClickHouseをOpenSSLでビルドするオプションが追加されました。このビルドタイプはセキュリティ検証のためのテストが実施されておらず、サポート対象外です。[#43991](https://github.com/ClickHouse/ClickHouse/pull/43991) ([Boris Kuschel](https://github.com/bkuschel))。
- 以前のPRで実装された新しい`DeflateQpl`圧縮コーデックへのアップグレード（詳細: https://github.com/ClickHouse/ClickHouse/pull/39494）。このパッチは以下の点でコーデックを改善します: 1. QPL v0.2.0からQPL v0.3.0へのアップグレード [Intel® Query Processing Library (QPL)](https://github.com/intel/qpl) 2. QPL v0.3.0のビルド問題を修正するためのCMakeファイルの改善 3. QPL v0.2.0での実行時ロード（dlopen）ではなく、ビルド時にQPLライブラリをlibaccel-configとリンク 4. CompressionCodecDeflateQpl.cppのログ出力問題の修正。[#44024](https://github.com/ClickHouse/ClickHouse/pull/44024) ([jasperzhu](https://github.com/jinjunzh))。

#### バグ修正（公式安定版またはプレ安定版リリースにおけるユーザーから見える不具合） {#bug-fix-user-visible-misbehavior-in-official-stable-or-prestable-release}


* 非同期インサート使用時にデッドロックを引き起こす可能性があったバグを修正しました。 [#43233](https://github.com/ClickHouse/ClickHouse/pull/43233) ([Anton Popov](https://github.com/CurtizJ)).
* AST レベルの最適化 `optimize_normalize_count_variants` における一部の誤ったロジックを修正。 [#43873](https://github.com/ClickHouse/ClickHouse/pull/43873) ([Duc Canh Le](https://github.com/canhld94))。
* レプリカ間でチェックサムが一致しない場合（例：アップグレード時のデータ形式変更が原因）に、ミューテーションが進行しなくなる問題を修正。 [#36877](https://github.com/ClickHouse/ClickHouse/pull/36877) ([nvartolomei](https://github.com/nvartolomei)).
* `hdfsCluster` テーブル関数で機能していなかった `skip_unavailable_shards` 最適化を修正しました。 [#43236](https://github.com/ClickHouse/ClickHouse/pull/43236) ([chen](https://github.com/xiedeyantu)).
* `?` ワイルドカードに対する `s3` サポートを修正。[#42731](https://github.com/ClickHouse/ClickHouse/issues/42731) をクローズ。[#43253](https://github.com/ClickHouse/ClickHouse/pull/43253)（[chen](https://github.com/xiedeyantu)）。
* 配列に `Nullable` 要素が含まれている場合に `arrayFirstOrNull` および `arrayLastOrNull` 関数が `null` を返す動作を修正しました。 [#43274](https://github.com/ClickHouse/ClickHouse/pull/43274) ([Duc Canh Le](https://github.com/canhld94)).
* Kafka テーブルに関連する `UserTimeMicroseconds` / `SystemTimeMicroseconds` の誤ったアカウンティングを修正しました。 [#42791](https://github.com/ClickHouse/ClickHouse/pull/42791) ([Azat Khuzhin](https://github.com/azat))。
* `web` ディスクで例外を握り潰さないようにし、`web` ディスクのリトライ処理を修正。 [#42800](https://github.com/ClickHouse/ClickHouse/pull/42800) ([Azat Khuzhin](https://github.com/azat)).
* INSERT とマテリアライズドビューの削除との間で発生していた（論理的な）レースコンディションを修正しました。これは、マテリアライズドビューが INSERT 実行開始時点ではその依存先として存在しているものの、INSERT チェーンがそのテーブルへアクセスしようとする時点までにテーブルが削除されてしまうことで、`UNKNOWN_TABLE` または `TABLE_IS_DROPPED` 例外が発生し、挿入処理が停止してしまう、という問題で、マテリアライズドビューが INSERT と同時に削除される場合に発生していました。この変更により、依存先が消えている場合でもこれらの例外を発生させず、INSERT をそのまま継続するようにしました。 [#43161](https://github.com/ClickHouse/ClickHouse/pull/43161) ([AlfVII](https://github.com/AlfVII)).
* `quantiles` 関数の未定義動作を修正しました。これにより未初期化メモリを参照してしまう可能性がありました。fuzzer によって発見されました。この修正により [#44066](https://github.com/ClickHouse/ClickHouse/issues/44066) がクローズされました。[#44067](https://github.com/ClickHouse/ClickHouse/pull/44067)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* `CompressionCodecDelta` において、非圧縮サイズがゼロの場合の追加チェックが行われるようになりました。 [#43255](https://github.com/ClickHouse/ClickHouse/pull/43255) ([Nikita Taranov](https://github.com/nickitat)).
* 配列内の不整合なデータによる問題を回避するため、Parquet の配列をフラット化するようにしました。これらの不正なファイルは Apache Iceberg によって生成される可能性があります。 [#43297](https://github.com/ClickHouse/ClickHouse/pull/43297) ([Arthur Passos](https://github.com/arthurpassos)).
* ショートサーキット関数実行を使用している場合に発生していた、`LowCardinality` 列からの誤ったキャストを修正しました。 [#43311](https://github.com/ClickHouse/ClickHouse/pull/43311) ([Kruglov Pavel](https://github.com/Avogar)).
* `Merge` エンジンを使用するテーブルに対して、`SAMPLE BY` を含むクエリでの `prewhere` 最適化を修正しました。 [#43315](https://github.com/ClickHouse/ClickHouse/pull/43315) ([Antonio Andelic](https://github.com/antonio2368))。
* `MergeTreeData` 内の `format_version` ファイルの内容をチェックおよび比較し、ストレージポリシーが変更されていてもテーブルをロードできるようにします。 [#43328](https://github.com/ClickHouse/ClickHouse/pull/43328) ([Antonio Andelic](https://github.com/antonio2368))。
* `Buffer` テーブルへの INSERT 中に発生する可能性のある（極めてまれな）「No column to rollback」論理エラーを修正しました。 [#43336](https://github.com/ClickHouse/ClickHouse/pull/43336) ([Azat Khuzhin](https://github.com/azat)).
* `allow_function_parameters` が設定されている場合に、パーサーが1つの関数に対して無制限の数の丸括弧を解析してしまう不具合を修正。 [#43350](https://github.com/ClickHouse/ClickHouse/pull/43350) ([Nikolay Degterinsky](https://github.com/evillique)).
* `MaterializeMySQL`（実験的機能）が DDL `DROP TABLE t1, t2` をサポートし、ほとんどの MySQL の DROP DDL と互換性を持つようになりました。 [#43366](https://github.com/ClickHouse/ClickHouse/pull/43366) ([zzsmdfj](https://github.com/zzsmdfj)).
* `session_log`（実験的機能）：設定プロファイルが壊れているという極めてまれなケースで、`session_log` エントリの作成に失敗することによりログインできなくなる問題を修正しました。[#42641](https://github.com/ClickHouse/ClickHouse/pull/42641) ([Vasily Nemkov](https://github.com/Enmk))。
* 関数 `if` / `multiIf` で発生する可能性がある `Cannot create non-empty column with type Nothing` の問題を修正しました。[#43356](https://github.com/ClickHouse/ClickHouse/issues/43356) をクローズ。[#43368](https://github.com/ClickHouse/ClickHouse/pull/43368)（[Kruglov Pavel](https://github.com/Avogar)）。
* 行レベルフィルタがカラムのデフォルト値を使用する場合に発生していたバグを修正しました。 [#43387](https://github.com/ClickHouse/ClickHouse/pull/43387) ([Alexander Gololobov](https://github.com/davenger)).
* `DISTINCT` + `LIMIT BY` + `LIMIT` を含むクエリが、想定より少ない行数を返すことがある問題を修正。[#43377](https://github.com/ClickHouse/ClickHouse/issues/43377) を解決。[#43410](https://github.com/ClickHouse/ClickHouse/pull/43410)（[Igor Nikonov](https://github.com/devcrafter)）。
* `Nullable(Decimal(...))` 向けの `sumMap` を修正しました。 [#43414](https://github.com/ClickHouse/ClickHouse/pull/43414) ([Azat Khuzhin](https://github.com/azat)).
* macOS における時間／分単位の `date_diff` を修正。 [#42742](https://github.com/ClickHouse/ClickHouse/issues/42742) をクローズ。 [#43466](https://github.com/ClickHouse/ClickHouse/pull/43466) ([zzsmdfj](https://github.com/zzsmdfj)).
* マージおよびミューテーションによって発生していた誤ったメモリ使用量の計上を修正。 [#43516](https://github.com/ClickHouse/ClickHouse/pull/43516) ([Azat Khuzhin](https://github.com/azat)).
* `toString(enum)` を含む条件がある場合の固定主キー解析を修正しました。 [#43596](https://github.com/ClickHouse/ClickHouse/pull/43596) ([Nikita Taranov](https://github.com/nickitat))。この不具合は @tisonkun によって発見されました。
* パーティションのアタッチ完了後に、Keeper 内で `clickhouse-copier` がステータスと `attach_is_done` を更新する処理の一貫性を確保しました。 [#43602](https://github.com/ClickHouse/ClickHouse/pull/43602) ([lzydmxy](https://github.com/lzydmxy)).
* `Replicated` データベース（実験的機能）の失われたレプリカをリカバリする際に、2 つのテーブル名をアトミックに入れ替える必要が生じる場合があります（`EXCHANGE` を使用）。以前は 2 つの `RENAME` クエリを使おうとしていましたが、これは当然失敗し、そのうえデータベースレプリカ全体のリカバリ処理も失敗させていました。 [#43628](https://github.com/ClickHouse/ClickHouse/pull/43628) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* `s3Cluster` 関数が `NOT_FOUND_COLUMN_IN_BLOCK` エラーをスローしてしまうケースを修正。[#43534](https://github.com/ClickHouse/ClickHouse/issues/43534) をクローズ。[#43629](https://github.com/ClickHouse/ClickHouse/pull/43629)（[chen](https://github.com/xiedeyantu)）。
* 同じキー名だがネストレベルが異なる配列を含む JSON オブジェクトをパースする際に発生し得る論理エラー `Array sizes mismatched` を修正しました。[#43569](https://github.com/ClickHouse/ClickHouse/issues/43569) をクローズします。 [#43693](https://github.com/ClickHouse/ClickHouse/pull/43693)（[Kruglov Pavel](https://github.com/Avogar)）。
* 集約キーに `ALIAS` 列が含まれる分散 `GROUP BY` で発生し得た例外を修正しました。 [#43709](https://github.com/ClickHouse/ClickHouse/pull/43709) ([Nikita Taranov](https://github.com/nickitat))。
* ゼロコピー レプリケーション（実験的機能）が有効化されている環境で使用された場合に、プロジェクションが壊れる可能性があるバグを修正しました。 [#43764](https://github.com/ClickHouse/ClickHouse/pull/43764) ([alesapin](https://github.com/alesapin)).
* AWS S3 で非常に大きな S3 オブジェクトに対して multipart upload を使用するように修正しました。 [#43824](https://github.com/ClickHouse/ClickHouse/pull/43824) ([ianton-ru](https://github.com/ianton-ru))。
* `ON CLUSTER` を伴う `ALTER ... RESET SETTING` を修正しました。1つのレプリカにのみ適用されてしまう可能性がありました。 [#43843](https://github.com/ClickHouse/ClickHouse/issues/43843) を修正。 [#43848](https://github.com/ClickHouse/ClickHouse/pull/43848) （[Elena Torró](https://github.com/elenatorro)）。
* `USING` が使用されている場合に、右辺に `Join` テーブルエンジンを用いた JOIN で発生する論理エラーを修正しました。 [#43963](https://github.com/ClickHouse/ClickHouse/pull/43963) ([Vladimir C](https://github.com/vdimir))。`Join` テーブルエンジンにおけるキーの順序が誤っていたバグを修正しました。 [#44012](https://github.com/ClickHouse/ClickHouse/pull/44012) ([Vladimir C](https://github.com/vdimir))。
* Keeper の修正: Raft 用の interserver ポートがすでに使用中の場合に例外を投げるようにしました。 [#43984](https://github.com/ClickHouse/ClickHouse/pull/43984) ([Antonio Andelic](https://github.com/antonio2368)).
* サブクエリで不要な列が削除される場合に、`ORDER BY 1, 2` のような ORDER BY の位置引数が正しく扱われない問題を修正しました。[#43964](https://github.com/ClickHouse/ClickHouse/issues/43964) をクローズ。[#43987](https://github.com/ClickHouse/ClickHouse/pull/43987)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* サブクエリに `HAVING` が含まれているものの、実際の集約が存在しない場合に発生していた例外を修正しました。 [#44051](https://github.com/ClickHouse/ClickHouse/pull/44051) ([Nikita Taranov](https://github.com/nickitat)).
* S3 のマルチパートアップロードにおけるレースコンディションを修正しました。この問題により、バックアップからの復元時に `Part number must be an integer between 1 and 10000, inclusive. (S3_ERROR)` というエラーが発生する可能性がありました。 [#44065](https://github.com/ClickHouse/ClickHouse/pull/44065) ([Vitaly Baranov](https://github.com/vitlibar)).

### <a id="2211"></a> ClickHouse release 22.11, 2022-11-17 {#a-id2211a-clickhouse-release-2211-2022-11-17}

#### 後方互換性のない変更 {#backward-incompatible-change}

- `JSONExtract`関数ファミリーは、リクエストされた型への型強制を試みるようになりました。[#41502](https://github.com/ClickHouse/ClickHouse/pull/41502) ([Márcio Martins](https://github.com/marcioapm))。


#### 新機能 {#new-feature-1}

- ClickHouse Keeperとのセッションが失われた際に、ReplicatedMergeTreeへのINSERT時のリトライをサポートします。耐障害性に加えて、より良いユーザーエクスペリエンスの提供を目的としており、keeperが再起動された場合（例：アップグレード時）にINSERT時にユーザーにエラーを返すことを回避します。[#42607](https://github.com/ClickHouse/ClickHouse/pull/42607) ([Igor Nikonov](https://github.com/devcrafter))。
- `Hudi`および`DeltaLake`テーブルエンジンを追加しました。読み取り専用で、S3上のテーブルのみに対応しています。[#41054](https://github.com/ClickHouse/ClickHouse/pull/41054) ([Daniil Rubin](https://github.com/rubin-do), [Kseniia Sumarokova](https://github.com/kssenii))。
- テーブル関数`hudi`および`deltaLake`を追加しました。[#43080](https://github.com/ClickHouse/ClickHouse/pull/43080) ([flynn](https://github.com/ucasfl))。
- 複合時間間隔のサポート。1. Intervalに対して加算、減算、否定演算が利用可能になりました。Intervalの型が異なる場合、それらの型のタプルに変換されます。2. 間隔のタプルをDate/DateTimeフィールドに加算または減算できます。3. 異なる型のIntervalの解析を追加しました。例：`INTERVAL '1 HOUR 1 MINUTE 1 SECOND'`。[#42195](https://github.com/ClickHouse/ClickHouse/pull/42195) ([Nikolay Degterinsky](https://github.com/evillique))。
- ファイルシステムおよびS3の再帰的ディレクトリトラバーサルのための`**`グロブサポートを追加しました。[#36316](https://github.com/ClickHouse/ClickHouse/issues/36316)を解決します。[#42376](https://github.com/ClickHouse/ClickHouse/pull/42376) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- 一度書き込み多数読み取り操作のための`s3_plain`ディスクタイプを導入しました。`s3_plain`ディスク用の`MergeTree`テーブルの`ATTACH`を実装しました。[#42628](https://github.com/ClickHouse/ClickHouse/pull/42628) ([Azat Khuzhin](https://github.com/azat))。
- `system.query_log`に適用された行レベルポリシーを追加しました。[#39819](https://github.com/ClickHouse/ClickHouse/pull/39819) ([Vladimir Chebotaryov](https://github.com/quickhouse))。
- ClickHouse Keeperでスナップショットを手動で作成するための4文字コマンド`csnp`を追加しました。さらに、特定のノードのRaft情報（例：最後に作成されたスナップショットのインデックス、最後にコミットされたログインデックス）を取得するための`lgif`を追加しました。[#41766](https://github.com/ClickHouse/ClickHouse/pull/41766) ([JackyWoo](https://github.com/JackyWoo))。
- Apache Sparkと同様の関数`ascii`を追加しました：https://spark.apache.org/docs/latest/api/sql/#ascii。[#42670](https://github.com/ClickHouse/ClickHouse/pull/42670) ([李扬](https://github.com/taiyang-li))。
- 剰余に基づいて非負の結果を返す関数`pmod`を追加しました。[#42755](https://github.com/ClickHouse/ClickHouse/pull/42755) ([李扬](https://github.com/taiyang-li))。
- 関数`formatReadableDecimalSize`を追加しました。[#42774](https://github.com/ClickHouse/ClickHouse/pull/42774) ([Alejandro](https://github.com/alexon1234))。
- Apache SparkまたはImpalaの`rand`関数と同様の関数`randCanonical`を追加しました。この関数は、[0, 1)の範囲で独立かつ同一分布の一様分布値を持つ疑似ランダム結果を生成します。[#43124](https://github.com/ClickHouse/ClickHouse/pull/43124) ([李扬](https://github.com/taiyang-li))。
- 関数`displayName`を追加しました。[#36770](https://github.com/ClickHouse/ClickHouse/issues/36770)をクローズします。[#37681](https://github.com/ClickHouse/ClickHouse/pull/37681) ([hongbin](https://github.com/xlwh))。
- パーティション全体に対してのみ古いパートを最適化するための`min_age_to_force_merge_on_partition_only`設定を追加しました。[#42659](https://github.com/ClickHouse/ClickHouse/pull/42659) ([Antonio Andelic](https://github.com/antonio2368))。
- 任意の構造化された名前付きコレクション、アクセスタイプ、および`system.named_collections`の汎用実装を追加しました。[#43147](https://github.com/ClickHouse/ClickHouse/pull/43147) ([Kseniia Sumarokova](https://github.com/kssenii))。

#### パフォーマンス改善 {#performance-improvement-1}

- `match`関数は、文字列プレフィックスに対する条件の場合にインデックスを使用できるようになりました。これにより[#37333](https://github.com/ClickHouse/ClickHouse/issues/37333)が解決されます。[#42458](https://github.com/ClickHouse/ClickHouse/pull/42458) ([clarkcaoliu](https://github.com/Clark0))。
- ANDおよびOR演算子が連続している場合の処理を高速化しました。[#42214](https://github.com/ClickHouse/ClickHouse/pull/42214) ([Zhiguo Zhou](https://github.com/ZhiguoZh))。
- `LineAsString`入力フォーマットの並列パースをサポートしました。これによりパフォーマンスがわずかに向上します。これにより[#42502](https://github.com/ClickHouse/ClickHouse/issues/42502)が解決されます。[#42780](https://github.com/ClickHouse/ClickHouse/pull/42780) ([Kruglov Pavel](https://github.com/Avogar))。
- ClickHouse Keeperのパフォーマンス改善: 多数の異なるノードがコミットされていない状態を持つ場合のコミットパフォーマンスを改善しました。これにより、フォロワーノードの同期が十分に高速でない場合に役立ちます。[#42926](https://github.com/ClickHouse/ClickHouse/pull/42926) ([Antonio Andelic](https://github.com/antonio2368))。
- `NOT LIKE 'prefix%'`のような条件でプライマリインデックスを使用できるようになりました。[#42209](https://github.com/ClickHouse/ClickHouse/pull/42209) ([Duc Canh Le](https://github.com/canhld94))。

#### 実験的機能 {#experimental-feature-1}

- 他の型内での`Object`型のサポート、例えば`Array(JSON)`。[#36969](https://github.com/ClickHouse/ClickHouse/pull/36969) ([Anton Popov](https://github.com/CurtizJ))。
- MaterializedMySQLでMySQLバイナリログのSAVEPOINTイベントを無視するようにしました。[#42931](https://github.com/ClickHouse/ClickHouse/pull/42931) ([zzsmdfj](https://github.com/zzsmdfj))。MaterializedMySQLでSAVEPOINTクエリを処理(無視)するようにしました。[#43086](https://github.com/ClickHouse/ClickHouse/pull/43086) ([Stig Bakken](https://github.com/stigsb))。


#### 改善 {#improvement-1}

- 小さなLIMITを持つ単純なクエリが、読み取る推定行数を適切に決定し、閾値が正しくチェックされるようになりました。[#7071](https://github.com/ClickHouse/ClickHouse/issues/7071)を解決。[#42580](https://github.com/ClickHouse/ClickHouse/pull/42580) ([Han Fei](https://github.com/hanfei1991))。
- INSERT VALUESクエリでの対話型パラメータのサポートを追加しました。[#43077](https://github.com/ClickHouse/ClickHouse/pull/43077) ([Nikolay Degterinsky](https://github.com/evillique))。
- `system.table_functions`に新しいフィールド`allow_readonly`を追加し、読み取り専用モードでテーブル関数を使用できるようにしました。[#42414](https://github.com/ClickHouse/ClickHouse/issues/42414)を解決。実装: _ system.table_functionsテーブルに新しいフィールドallow_readonlyを追加。_ 読み取り専用モードでテーブル関数を使用できるように新しいフィールドallow_readonlyを使用するように更新。テスト: _ ファイルシステムのテストtests/queries/0_stateless/02473_functions_in_readonly_mode.shを追加。ドキュメント: _ テーブル関数の英語ドキュメントを更新。[#42708](https://github.com/ClickHouse/ClickHouse/pull/42708) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- `system.asynchronous_metrics`に組み込みドキュメントが追加されました。このドキュメントはPrometheusにもエクスポートされます。`cache`ディスクに関するメトリクスのエラーを修正しました - すべてのキャッシュディスクではなく、任意の1つのキャッシュディスクに対してのみ計算されていました。[#7644](https://github.com/ClickHouse/ClickHouse/issues/7644)を解決。[#43194](https://github.com/ClickHouse/ClickHouse/pull/43194) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- スロットリングアルゴリズムをトークンバケットに変更しました。[#42665](https://github.com/ClickHouse/ClickHouse/pull/42665) ([Sergei Trifonov](https://github.com/serxa))。
- `system.query_log`と`/var/log/clickhouse-server/*.log`、およびエラーメッセージ内のパスワードと秘密鍵をマスクするようにしました。[#42484](https://github.com/ClickHouse/ClickHouse/pull/42484) ([Vitaly Baranov](https://github.com/vitlibar))。
- フェッチされたパートのカバー済みパートを削除しました(レプリケーション遅延の増加を回避するため)。[#39737](https://github.com/ClickHouse/ClickHouse/pull/39737) ([Azat Khuzhin](https://github.com/azat))。
- `/dev/tty`が利用可能な場合、clickhouse-clientとclickhouse-localの進行状況がSTDERRに書き込まれることなく、ターミナルに直接レンダリングされるようになりました。これにより、STDERRがファイルにリダイレクトされている場合でも進行状況を取得でき、ファイルがターミナルエスケープシーケンスで汚染されることがありません。進行状況は`--progress false`で無効にできます。[#32238](https://github.com/ClickHouse/ClickHouse/issues/32238)を解決。[#42003](https://github.com/ClickHouse/ClickHouse/pull/42003) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- base64エンコーディング関数への`FixedString`入力のサポートを追加しました。[#42285](https://github.com/ClickHouse/ClickHouse/pull/42285) ([ltrk2](https://github.com/ltrk2))。
- `system.detached_parts`に`bytes_on_disk`と`path`カラムを追加しました。[#42264](https://github.com/ClickHouse/ClickHouse/issues/42264)を解決。[#42303](https://github.com/ClickHouse/ClickHouse/pull/42303) ([chen](https://github.com/xiedeyantu))。
- テーブル関数での挿入テーブルからの構造の使用を改善しました。設定`use_structure_from_insertion_table_in_table_functions`に新しい値`2`が追加され、ClickHouseが挿入テーブルからの構造を使用できるかどうかを自動的に判断するようになりました。[#40028](https://github.com/ClickHouse/ClickHouse/issues/40028)を解決。[#42320](https://github.com/ClickHouse/ClickHouse/pull/42320) ([Kruglov Pavel](https://github.com/Avogar))。
- INSERT FROM INFILEで進行状況が表示されない問題を修正しました。[#42548](https://github.com/ClickHouse/ClickHouse/issues/42548)を解決。[#42634](https://github.com/ClickHouse/ClickHouse/pull/42634) ([chen](https://github.com/xiedeyantu))。
- 関数`tokens`をリファクタリングし、関連関数で返される最大トークン数を有効にしました(デフォルトでは無効)。[#42673](https://github.com/ClickHouse/ClickHouse/pull/42673) ([李扬](https://github.com/taiyang-li))。
- `formatDateTime`および`FROM_UNIXTIME`関数で`Date32`引数を使用できるようにしました。[#42737](https://github.com/ClickHouse/ClickHouse/pull/42737) ([Roman Vasin](https://github.com/rvasin))。
- tzdataを2022fに更新しました。メキシコは米国国境付近を除き、夏時間を廃止します: https://www.timeanddate.com/news/time/mexico-abolishes-dst-2022.html。チワワは2022-10-30に通年UTC-6に移行します。フィジーは夏時間を廃止しました。https://github.com/google/cctz/pull/235 および https://bugs.launchpad.net/ubuntu/+source/tzdata/+bug/1995209 を参照してください。[#42796](https://github.com/ClickHouse/ClickHouse/pull/42796) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 非同期挿入用の`FailedAsyncInsertQuery`イベントメトリクスを追加しました。[#42814](https://github.com/ClickHouse/ClickHouse/pull/42814) ([Krzysztof Góralski](https://github.com/kgoralski))。
- クエリプラン上で`read-in-order`最適化を実装しました。デフォルトで有効になっています。以前のASTベースのバージョンを使用するには`query_plan_read_in_order = 0`を設定してください。[#42829](https://github.com/ClickHouse/ClickHouse/pull/42829) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- S3へのバックアップ時にアップロードパートのサイズを指数関数的に増加させ、S3へのマルチパートアップロードの最大10,000パート制限に関するエラーを回避するようにしました。[#42833](https://github.com/ClickHouse/ClickHouse/pull/42833) ([Vitaly Baranov](https://github.com/vitlibar))。
- マージタスクが継続的にビジーでディスク容量が不足している場合、完全に期限切れのパートを選択して削除できず、ディスク容量不足が発生していました。パート全体が期限切れになった場合、追加のディスク容量を保証する必要はなく、TTLの正常な実行を確保するという考えです。[#42869](https://github.com/ClickHouse/ClickHouse/pull/42869) ([zhongyuankai](https://github.com/zhongyuankai))。
- `oss`関数と`OSS`テーブルエンジンを追加しました(ユーザーにとって便利です)。ossはs3と完全に互換性があります。[#43155](https://github.com/ClickHouse/ClickHouse/pull/43155) ([zzsmdfj](https://github.com/zzsmdfj))。
- `system.asynchronous_metrics`テーブルのOS関連情報の収集におけるエラー報告を改善しました。[#43192](https://github.com/ClickHouse/ClickHouse/pull/43192) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- ClickHouseがMySQL互換プロトコルを使用して自身に接続できるように`INFORMATION_SCHEMA`テーブルを変更しました。エイリアスの代わりにカラムを追加しました([#9769](https://github.com/ClickHouse/ClickHouse/issues/9769)に関連)。これにより、さまざまなMySQLクライアントとの互換性が向上します。[#43198](https://github.com/ClickHouse/ClickHouse/pull/43198) ([Filatenkov Artur](https://github.com/FArthur-cmd))。
- MySQLプロトコルを使用して接続する際のPowerBIとの互換性のためにいくつかの関数を追加しました [#42612](https://github.com/ClickHouse/ClickHouse/pull/42612) ([Filatenkov Artur](https://github.com/FArthur-cmd))。
- 変更時のダッシュボードの使いやすさを向上しました [#42872](https://github.com/ClickHouse/ClickHouse/pull/42872) ([Vladimir C](https://github.com/vdimir))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-1}

- 各プルリクエストおよびmasterへのコミットに対してSQLancerを実行します。[SQLancer](https://github.com/sqlancer/sqlancer)は、論理的なバグの自動検出に特化したオープンソースのファザーです。[#42397](https://github.com/ClickHouse/ClickHouse/pull/42397) ([Ilya Yatsishin](https://github.com/qoega))。
- 最新のzlib-ngに更新します。[#42463](https://github.com/ClickHouse/ClickHouse/pull/42463) ([Boris Kuschel](https://github.com/bkuschel))。
- JepsenによるClickHouseサーバーのテストサポートを追加します。なお、ClickHouse KeeperのJepsenテストサポートは既に実装されています。このプルリクエストは、それをReplicatedテーブルにも拡張します。[#42619](https://github.com/ClickHouse/ClickHouse/pull/42619) ([Antonio Andelic](https://github.com/antonio2368))。
- clang-tidyの結果キャッシュにhttps://github.com/matus-chochlik/ctcacheを使用します。[#42913](https://github.com/ClickHouse/ClickHouse/pull/42913) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 修正前は、ユーザー定義の設定ファイルがRPMによって`$file.rpmsave`に保存されていました。このPRはこれを修正し、パッケージからユーザーのファイルを置き換えないようにします。[#42936](https://github.com/ClickHouse/ClickHouse/pull/42936) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- Ubuntu Dockerイメージから一部のライブラリを削除します。[#42622](https://github.com/ClickHouse/ClickHouse/pull/42622) ([Alexey Milovidov](https://github.com/alexey-milovidov))。

#### バグ修正(公式安定版またはプレ安定版リリースにおけるユーザーから見える不具合) {#bug-fix-user-visible-misbehavior-in-official-stable-or-prestable-release-1}


* エイリアス AST をクローンするように normaliser を更新しました。[#42452](https://github.com/ClickHouse/ClickHouse/issues/42452) を解決します。実装: * QueryNormalizer を更新し、置き換えを行う際にエイリアス AST をクローンするようにしました。以前は同じものをそのまま代入していたため、同じ親が再度挿入されることになり、LogicalExpressinsOptimizer で例外が発生していました。* このバグは新しいアナライザー（`allow_experimental_analyzer`）では発生しないため、そちらには変更はありません。同じ問題を検証するテストを追加しました。[#42827](https://github.com/ClickHouse/ClickHouse/pull/42827) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
* `Lazy` データベース内のテーブルのバックアップ時に発生するレースコンディションを修正。 [#43104](https://github.com/ClickHouse/ClickHouse/pull/43104) ([Vitaly Baranov](https://github.com/vitlibar)).
* `skip_unavailable_shards` の不具合を修正しました。`s3Cluster` テーブル関数ではこの設定が機能していませんでした。 [#43131](https://github.com/ClickHouse/ClickHouse/pull/43131) ([chen](https://github.com/xiedeyantu)).
* `s3Cluster` のスキーマ推論を修正し、`hdfsCluster` を改善しました。 [#41979](https://github.com/ClickHouse/ClickHouse/pull/41979) ([Kruglov Pavel](https://github.com/Avogar)).
* URL テーブルエンジン / テーブル関数から読み取る際の再試行処理を修正しました（再試行可能なエラーが必要以上に繰り返し再試行される場合があり、再試行不可能なエラーではコード内のアサーション失敗を引き起こしていました）。[#42224](https://github.com/ClickHouse/ClickHouse/pull/42224)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* DNS と c-ares に関連するセグメンテーションフォールトが報告され、修正されました。 [#42234](https://github.com/ClickHouse/ClickHouse/pull/42234) ([Arthur Passos](https://github.com/arthurpassos))。
* PK 解析（単調性チェック）で発生する可能性がある `LOGICAL_ERROR` `Arguments of 'plus' have incorrect data types` を修正。先頭の引数が定数である単調な2項関数に対する PK 解析が不正確だった問題を修正。 [#42410](https://github.com/ClickHouse/ClickHouse/pull/42410) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* キーの型が Nullable 内に含められない場合に発生していた誤ったキー解析を修正しました。これにより [#42456](https://github.com/ClickHouse/ClickHouse/issues/42456) が解決されました。 [#42469](https://github.com/ClickHouse/ClickHouse/pull/42469) ([Amos Bird](https://github.com/amosbird)).
* `input_format_csv_use_best_effort_in_schema_inference` 設定の使用時に、スキーマ推論キャッシュが不適切に使用されてしまう原因となっていた設定名のタイポを修正しました。[#41735](https://github.com/ClickHouse/ClickHouse/issues/41735) をクローズ。[#42536](https://github.com/ClickHouse/ClickHouse/pull/42536) ([Kruglov Pavel](https://github.com/Avogar)).
* データ型が LowCardinality の場合に誤ったヘッダーで Set が作成される問題を修正。[#42460](https://github.com/ClickHouse/ClickHouse/issues/42460) をクローズ。[#42579](https://github.com/ClickHouse/ClickHouse/pull/42579)（[flynn](https://github.com/ucasfl)）。
* `(U)Int128` と `(U)Int256` の値が `PREWHERE` で正しく検査されるようになりました。 [#42605](https://github.com/ClickHouse/ClickHouse/pull/42605) ([Antonio Andelic](https://github.com/antonio2368))。
* 関数パーサーのバグを修正しました。このバグによりセグメンテーションフォルトが発生する可能性がありました。 [#42724](https://github.com/ClickHouse/ClickHouse/pull/42724) ([Nikolay Degterinsky](https://github.com/evillique))。
* `truncate table` のロック処理を修正しました。 [#42728](https://github.com/ClickHouse/ClickHouse/pull/42728) ([flynn](https://github.com/ucasfl)).
* ファイルが存在しない場合（または、最終的に同じエラーが発生し得る `OPTIMIZE TABLE FINAL` 実行時）に `web` ディスクで発生する可能性があるクラッシュを修正。[#42767](https://github.com/ClickHouse/ClickHouse/pull/42767) ([Azat Khuzhin](https://github.com/azat)).
* `system.session_log` の `auth_type` マッピングを修正し、列挙値に `SSL_CERTIFICATE` を含めました。 [#42782](https://github.com/ClickHouse/ClickHouse/pull/42782) ([Miel Donkers](https://github.com/mdonkers))。
* ASAN ビルドにおいて Create User クエリパーサーで発生していた stack-use-after-return を修正。 [#42804](https://github.com/ClickHouse/ClickHouse/pull/42804) ([Nikolay Degterinsky](https://github.com/evillique))。
* シンボルが 16 バイト境界をまたぐ場合に `lowerUTF8`/`upperUTF8` を修正しました（16 バイトを超える長さの文字列では非常によく発生するケースです）。 [#42812](https://github.com/ClickHouse/ClickHouse/pull/42812) ([Azat Khuzhin](https://github.com/azat)).
* 不正な入力が与えられた場合の誤動作を修正するために、LZ4 伸長ルーチンに追加の境界チェックが導入されました。 [#42868](https://github.com/ClickHouse/ClickHouse/pull/42868) ([Nikita Taranov](https://github.com/nickitat)).
* クエリキャンセル時にまれに発生する可能性のあったハングを修正しました。 [#42874](https://github.com/ClickHouse/ClickHouse/pull/42874) ([Azat Khuzhin](https://github.com/azat)).
* ハッシュ結合における複数の選言条件での誤った動作を修正し、[#42832](https://github.com/ClickHouse/ClickHouse/issues/42832) をクローズ。 [#42876](https://github.com/ClickHouse/ClickHouse/pull/42876)（[Vladimir C](https://github.com/vdimir)）。
* 「three table join」から if を select するとヌルポインタが生成されます。例えば、この SQL クエリです: [#42883](https://github.com/ClickHouse/ClickHouse/pull/42883) ([zzsmdfj](https://github.com/zzsmdfj))。
* Cluster Discovery における memory sanitizer の報告を修正し、[#42763](https://github.com/ClickHouse/ClickHouse/issues/42763) をクローズしました。 [#42905](https://github.com/ClickHouse/ClickHouse/pull/42905) ([Vladimir C](https://github.com/vdimir))。
* 空文字列の場合の DateTime スキーマ推測を改善。[#42911](https://github.com/ClickHouse/ClickHouse/pull/42911)（[Kruglov Pavel](https://github.com/Avogar)）。
* 投影を利用できるはずにもかかわらず、実際には投影が存在しない場合にまれに発生する NOT&#95;FOUND&#95;COLUMN&#95;IN&#95;BLOCK エラーを修正しました。これにより [#42771](https://github.com/ClickHouse/ClickHouse/issues/42771) が解決されます。このバグは [https://github.com/ClickHouse/ClickHouse/pull/25563](https://github.com/ClickHouse/ClickHouse/pull/25563) で導入されました。[#42938](https://github.com/ClickHouse/ClickHouse/pull/42938)（[Amos Bird](https://github.com/amosbird)）。
* テーブルに DATETIME データ型が含まれている場合の `PostgreSQL` データベースエンジンでの ATTACH TABLE を修正しました。[#42817](https://github.com/ClickHouse/ClickHouse/issues/42817) をクローズします。[#42960](https://github.com/ClickHouse/ClickHouse/pull/42960)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* lambda の構文解析を修正。[#41848](https://github.com/ClickHouse/ClickHouse/issues/41848) をクローズ。[#42979](https://github.com/ClickHouse/ClickHouse/pull/42979)（[Nikolay Degterinsky](https://github.com/evillique)）。
* Nullable キーがハイパー矩形の中間に現れる場合の誤ったキー解析を修正しました。これにより [#43111](https://github.com/ClickHouse/ClickHouse/issues/43111) が修正されます。 [#43133](https://github.com/ClickHouse/ClickHouse/pull/43133) ([Amos Bird](https://github.com/amosbird))。
* 細工された集計関数状態のデシリアライズ処理で発生する複数のバッファー過読を修正しました。 [#43159](https://github.com/ClickHouse/ClickHouse/pull/43159) ([Raúl Marín](https://github.com/Algunenano)).
* NULL および const Nullable 引数の場合の `if` 関数を修正。[#43069](https://github.com/ClickHouse/ClickHouse/issues/43069) をクローズ。[#43178](https://github.com/ClickHouse/ClickHouse/pull/43178)（[Kruglov Pavel](https://github.com/Avogar)）。
* &#39;best effort&#39; アルゴリズムでの DateTime パース時に発生する decimal 演算のオーバーフローを修正。 [#43061](https://github.com/ClickHouse/ClickHouse/issues/43061) をクローズ。 [#43180](https://github.com/ClickHouse/ClickHouse/pull/43180)（[Kruglov Pavel](https://github.com/Avogar)）。
* `git-import` ツールによって生成される `indent` フィールドが誤って計算されていました。 [https://clickhouse.com/docs/getting-started/example-datasets/github/](https://clickhouse.com/docs/getting-started/example-datasets/github/) を参照してください。 [#43191](https://github.com/ClickHouse/ClickHouse/pull/43191) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* サブクエリおよびキャストを伴う `Interval` 型の想定外の挙動を修正しました。 [#43193](https://github.com/ClickHouse/ClickHouse/pull/43193) ([jh0x](https://github.com/jh0x)).

### <a id="2210"></a> ClickHouse リリース 22.10, 2022-10-25 {#a-id2210a-clickhouse-release-2210-2022-10-25}

#### 後方互換性のない変更 {#backward-incompatible-change-1}

- キャッシュコマンドの名称変更: `show caches` -> `show filesystem caches`、`describe cache` -> `describe filesystem cache`。[#41508](https://github.com/ClickHouse/ClickHouse/pull/41508) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `LIVE VIEW` の `WITH TIMEOUT` セクションのサポートを削除しました。これにより [#40557](https://github.com/ClickHouse/ClickHouse/issues/40557) がクローズされます。[#42173](https://github.com/ClickHouse/ClickHouse/pull/42173) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- クライアントのプロンプトから `{database}` マクロのサポートを削除しました。データベースが未指定の場合に正しく表示されず、`USE` ステートメントで更新されない問題がありました。これにより [#25891](https://github.com/ClickHouse/ClickHouse/issues/25891) がクローズされます。[#42508](https://github.com/ClickHouse/ClickHouse/pull/42508) ([Alexey Milovidov](https://github.com/alexey-milovidov))。


#### 新機能 {#new-feature-2}

- 構成可能なプロトコル設定が追加されました。異なるプロトコルを異なるリッスンホストで設定できるようになりました。PROXYv1などのプロトコルラッパーを、他の任意のプロトコル(TCP、TCP secure、MySQL、Postgres)上で設定できます。[#41198](https://github.com/ClickHouse/ClickHouse/pull/41198) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- バックアップの宛先の新しいタイプとして`S3`を追加しました。パス/データ構造をそのままの形式でS3へのBACKUPをサポートします。[#42333](https://github.com/ClickHouse/ClickHouse/pull/42333) ([Vitaly Baranov](https://github.com/vitlibar))、[#42232](https://github.com/ClickHouse/ClickHouse/pull/42232) ([Azat Khuzhin](https://github.com/azat))。
- 指定された分布に従って乱数値を生成する関数(`randUniform`、`randNormal`、`randLogNormal`、`randExponential`、`randChiSquared`、`randStudentT`、`randFisherF`、`randBernoulli`、`randBinomial`、`randNegativeBinomial`、`randPoisson`)を追加しました。これにより[#21834](https://github.com/ClickHouse/ClickHouse/issues/21834)が解決されます。[#42411](https://github.com/ClickHouse/ClickHouse/pull/42411) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- ClickHouse Keeperの改善: S3へのスナップショットアップロードのサポートを追加しました。S3情報は`keeper_server.s3_snapshot`内で定義できます。[#41342](https://github.com/ClickHouse/ClickHouse/pull/41342) ([Antonio Andelic](https://github.com/antonio2368))。
- 正規分布する複数の観測グループに対して統計検定を実行し、すべてのグループが同じ平均を持つかどうかを判定する集約関数`analysisOfVariance`(`anova`)を追加しました。元のPR [#37872](https://github.com/ClickHouse/ClickHouse/issues/37872)。[#42131](https://github.com/ClickHouse/ClickHouse/pull/42131) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 設定`max_temporary_data_on_disk_size_for_user`/`max_temporary_data_on_disk_size_for_query`を使用して、ディスクに保存される一時データの制限をサポートしました。[#40893](https://github.com/ClickHouse/ClickHouse/pull/40893) ([Vladimir C](https://github.com/vdimir))。
- JSONObjectEachRow形式でオブジェクト名を列値として書き込み/解析するための設定`format_json_object_each_row_column_for_object_name`を追加しました。[#41703](https://github.com/ClickHouse/ClickHouse/pull/41703) ([Kruglov Pavel](https://github.com/Avogar))。
- SQLにBLAKE3ハッシュ関数を追加しました。[#33435](https://github.com/ClickHouse/ClickHouse/pull/33435) ([BoloniniD](https://github.com/BoloniniD))。
- 関数`javaHash`が整数に拡張されました。[#41131](https://github.com/ClickHouse/ClickHouse/pull/41131) ([JackyWoo](https://github.com/JackyWoo))。
- ON CLUSTER DDLにOpenTelemetryサポートを追加しました(`distributed_ddl_entry_format_version`を4に設定する必要があります)。[#41484](https://github.com/ClickHouse/ClickHouse/pull/41484) ([Frank Chen](https://github.com/FrankChen021))。
- システムテーブル`asynchronous_insert_log`を追加しました。このテーブルには、より良い内部監視のために、非同期挿入に関する情報(fire-and-forgetモード(`wait_for_async_insert=0`)でのクエリ結果を含む)が含まれます。[#42040](https://github.com/ClickHouse/ClickHouse/pull/42040) ([Anton Popov](https://github.com/CurtizJ))。
- HTTPプロトコルの非標準拡張であるHTTPの`Accept-Encoding`に、メソッド`lz4`、`bz2`、`snappy`のサポートを追加しました。[#42071](https://github.com/ClickHouse/ClickHouse/pull/42071) ([Nikolay Degterinsky](https://github.com/evillique))。
- Morton Coding(ZCurve)のエンコード/デコード関数を追加しました。[#41753](https://github.com/ClickHouse/ClickHouse/pull/41753) ([Constantine Peresypkin](https://github.com/pkit))。
- `SET setting_name = DEFAULT`のサポートを追加しました。[#42187](https://github.com/ClickHouse/ClickHouse/pull/42187) ([Filatenkov Artur](https://github.com/FArthur-cmd))。

#### 実験的機能 {#experimental-feature-2}

- `allow_experimental_analyzer`設定下でクエリ解析と計画のための新しいインフラストラクチャを追加しました。[#31796](https://github.com/ClickHouse/ClickHouse/pull/31796) ([Maksim Kita](https://github.com/kitaisreal))。
- Kusto Query Languageの初期実装。使用しないでください。[#37961](https://github.com/ClickHouse/ClickHouse/pull/37961) ([Yong Wang](https://github.com/kashwy))。

#### パフォーマンス改善 {#performance-improvement-2}

- 「パーツが多すぎる」閾値を緩和しました。これにより[#6551](https://github.com/ClickHouse/ClickHouse/issues/6551)が解決されます。平均パーツサイズが十分に大きい場合(最低10 GiB)、ClickHouseはパーティション内により多くのパーツを許可するようになりました。これにより、ディスクシェルフやオブジェクトストレージを使用して、単一サーバー上の単一テーブルの単一パーティションに最大ペタバイト規模のデータを保持できるようになります。[#42002](https://github.com/ClickHouse/ClickHouse/pull/42002) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 必要なスタックサイズを小さくするために、演算子優先順位要素パーサーを実装しました。[#34892](https://github.com/ClickHouse/ClickHouse/pull/34892) ([Nikolay Degterinsky](https://github.com/evillique))。
- DISTINCTの順序最適化がデータストリームのソート特性を活用するようになりました。この改善により、該当する場合にDISTINCTの順序読み取りが可能になります(以前はDISTINCT内のカラムにORDER BYを指定する必要がありました)。[#41014](https://github.com/ClickHouse/ClickHouse/pull/41014) ([Igor Nikonov](https://github.com/devcrafter))。
- ColumnVector: AVX512VBMIを使用してUInt8インデックスを最適化しました。[#41247](https://github.com/ClickHouse/ClickHouse/pull/41247) ([Guo Wangyang](https://github.com/guowangy))。
- `ThreadGroupStatus::mutex`のロック競合を最適化しました。ICXデバイス(Intel Xeon Platinum 8380 CPU、80コア、160スレッド)での**SSB**(Star Schema Benchmark)のパフォーマンス実験では、この変更により全サブケースのQPSの幾何平均が**2.95倍**向上することが示されました。[#41675](https://github.com/ClickHouse/ClickHouse/pull/41675) ([Zhiguo Zhou](https://github.com/ZhiguoZh))。
- AArch64ビルドに`ldapr`機能を追加しました。これはGraviton 2+、Azure、GCPインスタンスでサポートされています。clang-15に[比較的最近](https://github.com/llvm/llvm-project/commit/9609b5daffe9fd28d83d83da895abc5113f76c24)登場しました。[#41778](https://github.com/ClickHouse/ClickHouse/pull/41778) ([Daniel Kutenin](https://github.com/danlark1))。
- 文字列を比較する際に、一方の引数が空の定数文字列である場合のパフォーマンスを改善しました。[#41870](https://github.com/ClickHouse/ClickHouse/pull/41870) ([Jiebin Sun](https://github.com/jiebinn))。
- ColumnAggregateFunctionの`insertFrom`を最適化し、一部のケースで集約状態を共有できるようにしました。[#41960](https://github.com/ClickHouse/ClickHouse/pull/41960) ([flynn](https://github.com/ucasfl))。
- `azure_blob_storage`ディスクへの書き込みを高速化しました(各バッファサイズごとにブロックを書き込む代わりに`max_single_part_upload_size`を尊重します)。[#41754](https://github.com/ClickHouse/ClickHouse/issues/41754)で言及された非効率性に対処しています。[#42041](https://github.com/ClickHouse/ClickHouse/pull/42041) ([Kseniia Sumarokova](https://github.com/kssenii))。
- プロセスリストとquery_log内のスレッドIDを一意にして無駄を回避しました。[#42180](https://github.com/ClickHouse/ClickHouse/pull/42180) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 要求された読み取り範囲がキャッシュ設定`bypass_cache_threashold`で定義された閾値を超える場合に、キャッシュを完全にスキップ(キャッシュへのダウンロードとキャッシュデータの読み取りの両方)することをサポートしました(`enable_bypass_cache_with_threshold`で有効化する必要があります)。[#42418](https://github.com/ClickHouse/ClickHouse/pull/42418) ([Han Shukai](https://github.com/KinderRiven))。これは低速なローカルディスクで役立ちます。


#### 改善 {#improvement-2}

- Add setting `allow_implicit_no_password`: in combination with `allow_no_password` it forbids creating a user with no password unless `IDENTIFIED WITH no_password` is explicitly specified. [#41341](https://github.com/ClickHouse/ClickHouse/pull/41341) ([Nikolay Degterinsky](https://github.com/evillique)).
- Embedded Keeper will always start in the background allowing ClickHouse to start without achieving quorum. [#40991](https://github.com/ClickHouse/ClickHouse/pull/40991) ([Antonio Andelic](https://github.com/antonio2368)).
- Made reestablishing a new connection to ZooKeeper more reactive in case of expiration of the previous one. Previously there was a task which spawns every minute by default and thus a table could be in readonly state for about this time. [#41092](https://github.com/ClickHouse/ClickHouse/pull/41092) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Now projections can be used with zero copy replication (zero-copy replication is a non-production feature). [#41147](https://github.com/ClickHouse/ClickHouse/pull/41147) ([alesapin](https://github.com/alesapin)).
- Support expression `(EXPLAIN SELECT ...)` in a subquery. Queries like `SELECT * FROM (EXPLAIN PIPELINE SELECT col FROM TABLE ORDER BY col)` became valid. [#40630](https://github.com/ClickHouse/ClickHouse/pull/40630) ([Vladimir C](https://github.com/vdimir)).
- Allow changing `async_insert_max_data_size` or `async_insert_busy_timeout_ms` in scope of query. E.g. user wants to insert data rarely and she doesn't have access to the server config to tune default settings. [#40668](https://github.com/ClickHouse/ClickHouse/pull/40668) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Improvements for reading from remote filesystems, made threadpool size for reads/writes configurable. Closes [#41070](https://github.com/ClickHouse/ClickHouse/issues/41070). [#41011](https://github.com/ClickHouse/ClickHouse/pull/41011) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Support all combinators combination in WindowTransform/arratReduce\*/initializeAggregation/aggregate functions versioning. Previously combinators like `ForEach/Resample/Map` didn't work in these places, using them led to exception like`State function ... inserts results into non-state column`. [#41107](https://github.com/ClickHouse/ClickHouse/pull/41107) ([Kruglov Pavel](https://github.com/Avogar)).
- Add function `tryDecrypt` that returns NULL when decrypt fails (e.g. decrypt with incorrect key) instead of throwing an exception. [#41206](https://github.com/ClickHouse/ClickHouse/pull/41206) ([Duc Canh Le](https://github.com/canhld94)).
- Add the `unreserved_space` column to the `system.disks` table to check how much space is not taken by reservations per disk. [#41254](https://github.com/ClickHouse/ClickHouse/pull/41254) ([filimonov](https://github.com/filimonov)).
- Support s3 authorization headers in table function arguments. [#41261](https://github.com/ClickHouse/ClickHouse/pull/41261) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Add support for MultiRead in Keeper and internal ZooKeeper client (this is an extension to ZooKeeper protocol, only available in ClickHouse Keeper). [#41410](https://github.com/ClickHouse/ClickHouse/pull/41410) ([Antonio Andelic](https://github.com/antonio2368)).
- Add support for decimal type comparing with floating point literal in IN operator. [#41544](https://github.com/ClickHouse/ClickHouse/pull/41544) ([liang.huang](https://github.com/lhuang09287750)).
- Allow readable size values (like `1TB`) in cache config. [#41688](https://github.com/ClickHouse/ClickHouse/pull/41688) ([Kseniia Sumarokova](https://github.com/kssenii)).
- ClickHouse could cache stale DNS entries for some period of time (15 seconds by default) until the cache won't be updated asynchronously. During these periods ClickHouse can nevertheless try to establish a connection and produce errors. This behavior is fixed. [#41707](https://github.com/ClickHouse/ClickHouse/pull/41707) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Add interactive history search with fzf-like utility (fzf/sk) for `clickhouse-client`/`clickhouse-local` (note you can use `FZF_DEFAULT_OPTS`/`SKIM_DEFAULT_OPTIONS` to additionally configure the behavior). [#41730](https://github.com/ClickHouse/ClickHouse/pull/41730) ([Azat Khuzhin](https://github.com/azat)).
- Only allow clients connecting to a secure server with an invalid certificate only to proceed with the '--accept-certificate' flag. [#41743](https://github.com/ClickHouse/ClickHouse/pull/41743) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Add function `tryBase58Decode`, similar to the existing function `tryBase64Decode`. [#41824](https://github.com/ClickHouse/ClickHouse/pull/41824) ([Robert Schulze](https://github.com/rschu1ze)).
- Improve feedback when replacing partition with different primary key. Fixes [#34798](https://github.com/ClickHouse/ClickHouse/issues/34798). [#41838](https://github.com/ClickHouse/ClickHouse/pull/41838) ([Salvatore](https://github.com/tbsal)).
- Fix parallel parsing: segmentator now checks `max_block_size`. This fixed memory overallocation in case of parallel parsing and small LIMIT. [#41852](https://github.com/ClickHouse/ClickHouse/pull/41852) ([Vitaly Baranov](https://github.com/vitlibar)).
- Don't add "TABLE_IS_DROPPED" exception to `system.errors` if it's happened during SELECT from a system table and was ignored. [#41908](https://github.com/ClickHouse/ClickHouse/pull/41908) ([AlfVII](https://github.com/AlfVII)).
- Improve option `enable_extended_results_for_datetime_functions` to return results of type DateTime64 for functions `toStartOfDay`, `toStartOfHour`, `toStartOfFifteenMinutes`, `toStartOfTenMinutes`, `toStartOfFiveMinutes`, `toStartOfMinute` and `timeSlot`. [#41910](https://github.com/ClickHouse/ClickHouse/pull/41910) ([Roman Vasin](https://github.com/rvasin)).
- Improve `DateTime` type inference for text formats. Now it respects setting `date_time_input_format` and doesn't try to infer datetimes from numbers as timestamps. Closes [#41389](https://github.com/ClickHouse/ClickHouse/issues/41389) Closes [#42206](https://github.com/ClickHouse/ClickHouse/issues/42206). [#41912](https://github.com/ClickHouse/ClickHouse/pull/41912) ([Kruglov Pavel](https://github.com/Avogar)).
- Remove confusing warning when inserting with `perform_ttl_move_on_insert` = false. [#41980](https://github.com/ClickHouse/ClickHouse/pull/41980) ([Vitaly Baranov](https://github.com/vitlibar)).
- Allow user to write `countState(*)` similar to `count(*)`. This closes [#9338](https://github.com/ClickHouse/ClickHouse/issues/9338). [#41983](https://github.com/ClickHouse/ClickHouse/pull/41983) ([Amos Bird](https://github.com/amosbird)).
- Fix `rankCorr` size overflow. [#42020](https://github.com/ClickHouse/ClickHouse/pull/42020) ([Duc Canh Le](https://github.com/canhld94)).
- Added an option to specify an arbitrary string as an environment name in the Sentry's config for more handy reports. [#42037](https://github.com/ClickHouse/ClickHouse/pull/42037) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Fix parsing out-of-range Date from CSV. [#42044](https://github.com/ClickHouse/ClickHouse/pull/42044) ([Andrey Zvonov](https://github.com/zvonand)).
- `parseDataTimeBestEffort` now supports comma between date and time. Closes [#42038](https://github.com/ClickHouse/ClickHouse/issues/42038). [#42049](https://github.com/ClickHouse/ClickHouse/pull/42049) ([flynn](https://github.com/ucasfl)).
- Improved stale replica recovery process for `ReplicatedMergeTree`. If a lost replica has some parts which are absent from a healthy replica, but these parts should appear in the future according to the replication queue of the healthy replica, then the lost replica will keep such parts instead of detaching them. [#42134](https://github.com/ClickHouse/ClickHouse/pull/42134) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Add a possibility to use `Date32` arguments for date_diff function. Fix issue in date_diff function when using DateTime64 arguments with a start date before Unix epoch and end date after Unix epoch. [#42308](https://github.com/ClickHouse/ClickHouse/pull/42308) ([Roman Vasin](https://github.com/rvasin)).
- When uploading big parts to Minio, 'Complete Multipart Upload' can take a long time. Minio sends heartbeats every 10 seconds (see https://github.com/minio/minio/pull/7198). But clickhouse times out earlier, because the default send/receive timeout is [set](https://github.com/ClickHouse/ClickHouse/blob/cc24fcd6d5dfb67f5f66f5483e986bd1010ad9cf/src/IO/S3/PocoHTTPClient.cpp#L123) to 5 seconds. [#42321](https://github.com/ClickHouse/ClickHouse/pull/42321) ([filimonov](https://github.com/filimonov)).
- Fix rarely invalid cast of aggregate state types with complex types such as Decimal. This fixes [#42408](https://github.com/ClickHouse/ClickHouse/issues/42408). [#42417](https://github.com/ClickHouse/ClickHouse/pull/42417) ([Amos Bird](https://github.com/amosbird)).
- Allow to use `Date32` arguments for `dateName` function. [#42554](https://github.com/ClickHouse/ClickHouse/pull/42554) ([Roman Vasin](https://github.com/rvasin)).
- Now filters with NULL literals will be used during index analysis. [#34063](https://github.com/ClickHouse/ClickHouse/issues/34063). [#41842](https://github.com/ClickHouse/ClickHouse/pull/41842) ([Amos Bird](https://github.com/amosbird)).
- Merge parts if every part in the range is older than a certain threshold. The threshold can be set by using `min_age_to_force_merge_seconds`. This closes [#35836](https://github.com/ClickHouse/ClickHouse/issues/35836). [#42423](https://github.com/ClickHouse/ClickHouse/pull/42423) ([Antonio Andelic](https://github.com/antonio2368)). This is continuation of [#39550i](https://github.com/ClickHouse/ClickHouse/pull/39550) by [@fastio](https://github.com/fastio) who implemented most of the logic.
- Added new infrastructure for query analysis and planning under `allow_experimental_analyzer` setting. [#31796](https://github.com/ClickHouse/ClickHouse/pull/31796) ([Maksim Kita](https://github.com/kitaisreal)).
- Improve the time to recover lost keeper connections. [#42541](https://github.com/ClickHouse/ClickHouse/pull/42541) ([Raúl Marín](https://github.com/Algunenano)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-2}

- テーブル定義用のファザーを追加 [#40096](https://github.com/ClickHouse/ClickHouse/pull/40096) ([Anton Popov](https://github.com/CurtizJ))。これは今年のClickHouseテストにおける最大の進歩です。
- ClickHouse Cloudサービスのベータ版がリリースされました: [https://console.clickhouse.cloud/](https://console.clickhouse.cloud/)。ClickHouseを使用する最も簡単な方法を提供します(単一コマンドインストールよりもさらに簡単です)。
- ASTファザーにWHERE句生成のサポートを追加し、ORDER BY句とWHERE句を追加または削除する機能を追加しました。[#38519](https://github.com/ClickHouse/ClickHouse/pull/38519) ([Ilya Yatsishin](https://github.com/qoega))。
- Aarch64バイナリは、2016年にリリースされたARMv8.2以上が必要になりました。特に、これによりARM LSE(ネイティブアトミック操作)の使用が可能になります。また、CMakeビルドオプション「NO_ARMV81_OR_HIGHER」が追加され、Raspberry Pi 4などの古いARMv8.0ハードウェア向けのバイナリのコンパイルが可能になりました。[#41610](https://github.com/ClickHouse/ClickHouse/pull/41610) ([Robert Schulze](https://github.com/rschu1ze))。
- MuslでのClickHouseのビルドを許可(既にサポートされていましたが破損していたため、小規模な変更を実施)。[#41987](https://github.com/ClickHouse/ClickHouse/pull/41987) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- インストール時にファイルが見つからないエラーが発生する`sed`コマンドの実行を回避するため、`$CLICKHOUSE_CRONFILE`ファイルのチェックを追加しました。[#42081](https://github.com/ClickHouse/ClickHouse/pull/42081) ([Chun-Sheng, Li](https://github.com/peter279k))。
- 新しいタイムゾーン変更をサポートするため、cctzを`2022e`に更新しました。パレスチナの移行は土曜日の02:00になりました。ウクライナの3つのゾーンを1つに統合しました。ヨルダンとシリアは夏時間を含む+02/+03から通年+03に切り替わりました。(https://data.iana.org/time-zones/tzdb/NEWS)。これにより[#42252](https://github.com/ClickHouse/ClickHouse/issues/42252)がクローズされます。[#42327](https://github.com/ClickHouse/ClickHouse/pull/42327) ([Alexey Milovidov](https://github.com/alexey-milovidov))。[#42273](https://github.com/ClickHouse/ClickHouse/pull/42273) ([Dom Del Nano](https://github.com/ddelnano))。
- BLAKE3ハッシュ関数ライブラリを例として、ClickHouseにRustコードのサポートを追加しました。[#33435](https://github.com/ClickHouse/ClickHouse/pull/33435) ([BoloniniD](https://github.com/BoloniniD))。

#### バグ修正(公式安定版またはプレ安定版リリースにおけるユーザーから見える不具合) {#bug-fix-user-visible-misbehavior-in-official-stable-or-prestable-release-2}


* `LowCardinality` と大きな整数型に対して正しい集約メソッドを選択するようにしました。 [#42342](https://github.com/ClickHouse/ClickHouse/pull/42342) ([Duc Canh Le](https://github.com/canhld94)).
* `web` ディスクに対する複数の修正。 [#41652](https://github.com/ClickHouse/ClickHouse/pull/41652) ([Kseniia Sumarokova](https://github.com/kssenii))。
* `https_port` が設定ファイルに含まれていない場合に `docker run` が失敗する問題を修正しました。 [#41693](https://github.com/ClickHouse/ClickHouse/pull/41693) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* サーバーのシャットダウン時や `SYSTEM STOP MERGES` クエリ実行時に、ミューテーションが正しくキャンセルされず、キャンセルの完了までに長時間かかる場合がある問題を修正しました。 [#41699](https://github.com/ClickHouse/ClickHouse/pull/41699) ([Alexander Tokmakov](https://github.com/tavplubix)).
* ソートキーのプレフィックスに含まれる列を単調関数でラップし、かつ「read in order」最適化（設定 `optimize_read_in_order` および `optimize_aggregation_in_order`）を有効にしている場合に、`ORDER BY` または `GROUP BY` を含むクエリで誤った結果が返される問題を修正しました。 [#41701](https://github.com/ClickHouse/ClickHouse/pull/41701) ([Anton Popov](https://github.com/CurtizJ)).
* `optimize_monotonous_functions_in_order_by` 設定を有効にした状態で `Merge` テーブルに対して `SELECT` を実行すると発生しうるクラッシュを修正しました。 [#41269](https://github.com/ClickHouse/ClickHouse/issues/41269) を修正。 [#41740](https://github.com/ClickHouse/ClickHouse/pull/41740) （[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* レプリカがあるパーツを破損として切り離した直後に再起動された場合に、極めてまれに発生する可能性があった「Part ... intersects part ...」エラーを修正しました。 [#41741](https://github.com/ClickHouse/ClickHouse/pull/41741) ([Alexander Tokmakov](https://github.com/tavplubix))。
* 軽量削除のために予約されている列名 `_row_exists` を持つ MergeTree テーブルを作成または変更できないようにしました。 [#41716](https://github.com/ClickHouse/ClickHouse/issues/41716) を修正。 [#41763](https://github.com/ClickHouse/ClickHouse/pull/41763)（[Jianmei Zhang](https://github.com/zhangjmruc)）。
* 一部の HTTP レスポンスで CORS ヘッダーが欠落していたバグを修正しました。 [#41792](https://github.com/ClickHouse/ClickHouse/pull/41792) ([Frank Chen](https://github.com/FrankChen021))。
* 20.3 以前のバージョンで作成され、一度も `ALTER` されていない `ReplicatedMergeTree` テーブルがある場合に、22.9 で起動に失敗することがありましたが、修正されました。 [#41742](https://github.com/ClickHouse/ClickHouse/issues/41742) を修正。 [#41796](https://github.com/ClickHouse/ClickHouse/pull/41796) ([Alexander Tokmakov](https://github.com/tavplubix))。
* 何らかの理由でバッチ送信が失敗した場合、自動的に復旧されず、適切なタイミングで処理されないとデータが蓄積し、出力されるエラーメッセージがどんどん長くなって最終的に http スレッドがブロックされてしまいます。 [#41813](https://github.com/ClickHouse/ClickHouse/pull/41813) ([zhongyuankai](https://github.com/zhongyuankai)).
* 圧縮マーク付きのコンパクトパーツを修正しました。[#41783](https://github.com/ClickHouse/ClickHouse/issues/41783) および [#41746](https://github.com/ClickHouse/ClickHouse/issues/41746) の問題を解決します。 [#41823](https://github.com/ClickHouse/ClickHouse/pull/41823) ([alesapin](https://github.com/alesapin))。
* 古いバージョンの Replicated データベースには、[Zoo]Keeper に特別なマーカーがありません。特別なマーカーではなく、そのノードに何らかの不明なデータが含まれているかどうかだけを確認する必要があります。 [#41875](https://github.com/ClickHouse/ClickHouse/pull/41875) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* fs キャッシュで発生し得る例外を修正しました。 [#41884](https://github.com/ClickHouse/ClickHouse/pull/41884) ([Kseniia Sumarokova](https://github.com/kssenii)).
* s3 テーブル関数の `use_environment_credentials` を修正。[#41970](https://github.com/ClickHouse/ClickHouse/pull/41970)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 破損したパーツをデタッチする際に `ReplicatedMergeTree` テーブルのレプリケーション開始を妨げる可能性があった「Directory already exists and is not empty」エラーを修正しました。[#40957](https://github.com/ClickHouse/ClickHouse/issues/40957) を修正。[#41981](https://github.com/ClickHouse/ClickHouse/pull/41981) ([Alexander Tokmakov](https://github.com/tavplubix))。
* `toDateTime64` は、負の整数および浮動小数引数に対して同一の出力を返すようになりました。 [#42025](https://github.com/ClickHouse/ClickHouse/pull/42025) ([Robert Schulze](https://github.com/rschu1ze))。
* `azure_blob_storage` への書き込み処理を修正。[#41754](https://github.com/ClickHouse/ClickHouse/issues/41754) を一部クローズ。[#42034](https://github.com/ClickHouse/ClickHouse/pull/42034)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 特定の `bzip2` ファイルに対する `bzip2` デコードの問題を修正しました。 [#42046](https://github.com/ClickHouse/ClickHouse/pull/42046) ([Nikolay Degterinsky](https://github.com/evillique))。
* 拡張範囲の先頭（1900年1月）における、設定値 &quot;enable&#95;extended&#95;results&#95;for&#95;datetime&#95;functions = 1&quot; 使用時の SQL 関数 `toLastDayOfMonth` の動作を修正しました。 - 拡張範囲の末尾（2299年12月）における、同設定使用時の SQL 関数 &quot;toRelativeWeekNum()&quot; の動作を修正しました。 - 不要なインデックス演算を回避することで、SQL 関数 &quot;toISOYear()&quot;、&quot;toFirstDayNumOfISOYearIndex()&quot;、&quot;toYearWeekOfNewyearMode()&quot; のパフォーマンスを改善しました。 [#42084](https://github.com/ClickHouse/ClickHouse/pull/42084) ([Roman Vasin](https://github.com/rvasin)).
* 各テーブルに対するフェッチの最大サイズが誤って 8 に設定されており、プールサイズの方が大きくなる場合がありました。現在では、テーブルに対するフェッチの最大サイズはプールサイズと同じになっています。 [#42090](https://github.com/ClickHouse/ClickHouse/pull/42090) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* テーブルがシャットダウンされ、テーブル間の依存関係を壊さずに削除できるかを確認する前に辞書がデタッチされてしまう可能性がありましたが、修正しました。Fixes [#41982](https://github.com/ClickHouse/ClickHouse/issues/41982). [#42106](https://github.com/ClickHouse/ClickHouse/pull/42106) ([Alexander Tokmakov](https://github.com/tavplubix)).
* `remote_filesystem_read_method=read` を filesystem キャッシュと併用した際の深刻な非効率性を修正。 [#42125](https://github.com/ClickHouse/ClickHouse/issues/42125) をクローズ。 [#42129](https://github.com/ClickHouse/ClickHouse/pull/42129)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* use&#95;hedged&#95;requests = 0 の分散クエリで発生する可能性があるタイムアウト例外を修正しました。 [#42130](https://github.com/ClickHouse/ClickHouse/pull/42130) ([Azat Khuzhin](https://github.com/azat))。
* `Date32` 型と併用した場合の `runningDifference` 関数内の軽微なバグを修正しました。以前は `Date` が使用されており、`Bad cast from type DB::ColumnVector<int> to DB::ColumnVector<unsigned short>'` のような論理エラーを引き起こす可能性がありました。 [#42143](https://github.com/ClickHouse/ClickHouse/pull/42143) ([Alfred Xu](https://github.com/sperlingxx)).
* ベースバックアップから 4GB 超のファイルを再利用する処理を修正しました。 [#42146](https://github.com/ClickHouse/ClickHouse/pull/42146) ([Azat Khuzhin](https://github.com/azat)).
* ソートキーの先頭列に関数が含まれている場合、`DISTINCT` は `LOGICAL_ERROR` で失敗します。 [#42186](https://github.com/ClickHouse/ClickHouse/pull/42186) ([Igor Nikonov](https://github.com/devcrafter)).
* `aggregate_functions_null_for_empty` 設定と projection に関するバグを修正しました。このバグは非常にまれで、サーバーの設定ファイルで `aggregate_functions_null_for_empty` を有効にした場合にのみ発生します。これにより [#41647](https://github.com/ClickHouse/ClickHouse/issues/41647) がクローズされました。[#42198](https://github.com/ClickHouse/ClickHouse/pull/42198)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* `Buffer` テーブルからの降順読み取りを修正しました。 [#42236](https://github.com/ClickHouse/ClickHouse/pull/42236) ([Duc Canh Le](https://github.com/canhld94)).
* `background_pool_size` 設定が default profile に設定されている一方で `background_merges_mutations_concurrency_ratio` が設定されていない場合に、ClickHouse が起動しなくなるバグを修正。 [#42315](https://github.com/ClickHouse/ClickHouse/pull/42315) ([nvartolomei](https://github.com/nvartolomei)).
* `ALTER UPDATE` が、テーブルスキーマと異なるカラムを持つアタッチ済みパーツに対して実行された場合、ディスク上に不正な `columns.txt` メタデータが作成される可能性がありました。そのようなパーツからの読み取りは、エラーで失敗するか、不正なデータを返す可能性があります。[#42161](https://github.com/ClickHouse/ClickHouse/issues/42161) を修正しました。 [#42319](https://github.com/ClickHouse/ClickHouse/pull/42319)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `additional_table_filters` の設定が `Distributed` ストレージに適用されていませんでした。 [#41692](https://github.com/ClickHouse/ClickHouse/issues/41692) を修正。 [#42322](https://github.com/ClickHouse/ClickHouse/pull/42322) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* クエリの終了/キャンセル処理におけるデータレースを修正しました。これにより [#42346](https://github.com/ClickHouse/ClickHouse/issues/42346) がクローズされます。[#42362](https://github.com/ClickHouse/ClickHouse/pull/42362)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* これは日付／時刻関数に不具合（リグレッション）を導入していた [#40217](https://github.com/ClickHouse/ClickHouse/issues/40217) を元に戻します。 [#42367](https://github.com/ClickHouse/ClickHouse/pull/42367) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* 偽と評価される条件での `join` における `assert cast` を修正。[#42380](https://github.com/ClickHouse/ClickHouse/issues/42380) をクローズ。[#42407](https://github.com/ClickHouse/ClickHouse/pull/42407) （[Vladimir C](https://github.com/vdimir)）。
* Decimal データ型の処理におけるバッファオーバーフローを修正しました。これにより [#42451](https://github.com/ClickHouse/ClickHouse/issues/42451) がクローズされます。[#42465](https://github.com/ClickHouse/ClickHouse/pull/42465)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* `AggregateFunctionQuantile` が `UInt128` カラムで正しく動作するようになりました。以前は、quantile 状態が `UInt128` カラムを `Int128` として解釈しており、そのため誤った結果が返される可能性がありました。 [#42473](https://github.com/ClickHouse/ClickHouse/pull/42473) ([Antonio Andelic](https://github.com/antonio2368)).
* Float32 以外のカラム上の `Annoy` インデックスへの INSERT 時に発生する bad&#95;cast アサートを修正しました。`Annoy` インデックスは実験的機能です。 [#42485](https://github.com/ClickHouse/ClickHouse/pull/42485) ([Robert Schulze](https://github.com/rschu1ze)).
* Date または DateTime と 128 または 256 ビット整数との算術演算で、初期化されていないメモリを参照していました。 [#42453](https://github.com/ClickHouse/ClickHouse/issues/42453). [#42573](https://github.com/ClickHouse/ClickHouse/pull/42573) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* サーバーのアップグレード時に、パーティションキーにエイリアス関数名が含まれている場合に発生する想定外のテーブル読み込みエラーを修正。 [#36379](https://github.com/ClickHouse/ClickHouse/pull/36379) ([Amos Bird](https://github.com/amosbird)).

### <a id="229"></a> ClickHouseリリース22.9、2022-09-22 {#a-id229a-clickhouse-release-229-2022-09-22}

#### 後方互換性のない変更 {#backward-incompatible-change-2}

- `ReplicatedMergeTree`テーブルが存在する場合、20.3以前のバージョンから22.9以降へのアップグレードは中間バージョンを経由して行う必要があります。そうしない場合、新しいバージョンのサーバーは起動しません。[#40641](https://github.com/ClickHouse/ClickHouse/pull/40641) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 関数`accurate_Cast`と`accurate_CastOrNull`を削除しました(これらは名前のアンダースコアにより`accurateCast`と`accurateCastOrNull`とは異なり、`cast_keep_nullable`設定の値の影響を受けません)。これらの関数は文書化されておらず、テストもされておらず、使用されておらず、不要なものでした。コードの汎用化により残存していました。[#40682](https://github.com/ClickHouse/ClickHouse/pull/40682) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- すべての新しいテーブル関数が文書化されることを保証するテストを追加しました。[#40649](https://github.com/ClickHouse/ClickHouse/issues/40649)を参照してください。テーブル関数`MeiliSearch`を`meilisearch`に名前変更しました。[#40709](https://github.com/ClickHouse/ClickHouse/pull/40709) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- すべての新しい関数が文書化されることを保証するテストを追加しました。[#40649](https://github.com/ClickHouse/ClickHouse/pull/40649)を参照してください。関数`lemmatize`、`synonyms`、`stem`は誤って大文字小文字を区別していませんでした。現在は大文字小文字を区別します。[#40711](https://github.com/ClickHouse/ClickHouse/pull/40711) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- セキュリティと安定性の理由により、catboostモデルはClickHouseサーバー内で評価されなくなりました。代わりに、評価はclickhouse-library-bridgeで行われるようになりました。これはcatboostライブラリを読み込み、HTTPを介してサーバープロセスと通信する独立したプロセスです。[#40897](https://github.com/ClickHouse/ClickHouse/pull/40897) ([Robert Schulze](https://github.com/rschu1ze))。
- YAML設定の解釈をより標準的なものにしました。[#41044](https://github.com/ClickHouse/ClickHouse/pull/41044) ([Vitaly Baranov](https://github.com/vitlibar))。


#### 新機能 {#new-feature-3}

- 過半数を使用するための `insert_quorum = 'auto'` をサポート。[#39970](https://github.com/ClickHouse/ClickHouse/pull/39970) ([Sachin](https://github.com/SachinSetiya))。
- ClickHouseサーバーに組み込みダッシュボードを追加。これは、ClickHouseの機能を使用して1%の労力で90%の結果を達成する方法を示すデモプロジェクトです。[#40461](https://github.com/ClickHouse/ClickHouse/pull/40461) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 新しい設定制約の書き込み可能性タイプ `changeable_in_readonly` を追加。[#40631](https://github.com/ClickHouse/ClickHouse/pull/40631) ([Sergei Trifonov](https://github.com/serxa))。
- `INTERSECT DISTINCT` および `EXCEPT DISTINCT` のサポートを追加。[#40792](https://github.com/ClickHouse/ClickHouse/pull/40792) ([Duc Canh Le](https://github.com/canhld94))。
- 新しい入出力フォーマット `JSONObjectEachRow` を追加 - `JSON/JSONCompact/JSONColumnsWithMetadata` フォーマットのインポートをサポート。メタデータのデータ型がヘッダーのデータ型と一致するかどうかをチェックするかを制御する新しい設定 `input_format_json_validate_types_from_metadata` を追加。- 新しい設定 `input_format_json_validate_utf8` を追加。有効にすると、すべての `JSON` フォーマットがUTF-8シーケンスを検証します。デフォルトでは無効になります。この設定は出力フォーマット `JSON/JSONCompact/JSONColumnsWithMetadata` には影響しないことに注意してください。これらは常にUTF-8シーケンスを検証します(この例外は互換性の理由により設けられました)。- String列で数値を解析できるようにする新しい設定 `input_format_json_read_numbers_as_strings` を追加。この設定はデフォルトで無効になっています。- 小数を二重引用符で出力できるようにする新しい設定 `output_format_json_quote_decimals` を追加。デフォルトでは無効になっています。- データインポート時に二重引用符で囲まれた小数を解析できるようにしました。[#40910](https://github.com/ClickHouse/ClickHouse/pull/40910) ([Kruglov Pavel](https://github.com/Avogar))。
- DESCRIBE TABLEクエリでクエリパラメータをサポート。[#40952](https://github.com/ClickHouse/ClickHouse/pull/40952) ([Nikita Taranov](https://github.com/nickitat))。
- ParquetのTime32/64をDateTime64に変換することでサポートを追加。ParquetのTime32/64は午前0時からの経過時間を表し、DateTime32/64は実際のUnixタイムスタンプを表します。変換は単に `0` からのオフセットです。[#41333](https://github.com/ClickHouse/ClickHouse/pull/41333) ([Arthur Passos](https://github.com/arthurpassos))。
- Apache Datasketchesに対する集合演算を実装。[#39919](https://github.com/ClickHouse/ClickHouse/pull/39919) ([Fangyuan Deng](https://github.com/pzhdfy))。注意: Apache Datasketchesを使用する意味はありません。これらはClickHouseより劣っており、他のシステムとの統合にのみ意味があります。
- テキストフォーマット(`CSV`、`TSV`)の読み取り中にエラーを指定されたファイルに記録できるようにしました。[#40516](https://github.com/ClickHouse/ClickHouse/pull/40516) ([zjial](https://github.com/zjial))。

#### 実験的機能 {#experimental-feature-3}

- `Annoy` に基づくANN(近似最近傍探索)インデックスを追加。[#40818](https://github.com/ClickHouse/ClickHouse/pull/40818) ([Filatenkov Artur](https://github.com/FArthur-cmd))。[#37215](https://github.com/ClickHouse/ClickHouse/pull/37215) ([VVMak](https://github.com/VVMak))。
- ClickHouse KeeperまたはZooKeeperをキーバリューストアとして使用する新しいストレージエンジン `KeeperMap` を追加。[#39976](https://github.com/ClickHouse/ClickHouse/pull/39976) ([Antonio Andelic](https://github.com/antonio2368))。このストレージエンジンは少量のメタデータを保存することを目的としています。
- インメモリデータパーツの改善: 完全に処理されたWALファイルを削除。[#40592](https://github.com/ClickHouse/ClickHouse/pull/40592) ([Azat Khuzhin](https://github.com/azat))。


#### パフォーマンスの改善 {#performance-improvement-3}

- マークとプライマリキーの圧縮を実装しました。[#34437](https://github.com/ClickHouse/ClickHouse/issues/34437)をクローズします。[#37693](https://github.com/ClickHouse/ClickHouse/pull/37693) ([zhongyuankai](https://github.com/zhongyuankai))。
- スレッドプールを使用してマークを事前にロードできるようになりました。設定`load_marks_asynchronously`で制御されます(デフォルト: 0)。[#40821](https://github.com/ClickHouse/ClickHouse/pull/40821) ([Kseniia Sumarokova](https://github.com/kssenii))。
- S3上の仮想ファイルシステムは、AWSでのパフォーマンス向上のため、複数のパスプレフィックスに分割されたランダムなオブジェクト名を使用するようになりました。[#40968](https://github.com/ClickHouse/ClickHouse/pull/40968) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 単一レベルの集計結果を生成する際に`max_block_size`の値を考慮するようになりました。これにより、後続のクエリプランステップをより多くのスレッドで実行できるようになります。[#39138](https://github.com/ClickHouse/ClickHouse/pull/39138) ([Nikita Taranov](https://github.com/nickitat))。
- 集計においてソフトウェアプリフェッチを使用し、ハッシュテーブルの操作を高速化しました。設定`enable_software_prefetch_in_aggregation`で制御され、デフォルトで有効になっています。[#39304](https://github.com/ClickHouse/ClickHouse/pull/39304) ([Nikita Taranov](https://github.com/nickitat))。
- `WHERE`句の適用後にソートキーの一部のカラムが常に定数になる場合の`optimize_read_in_order`のサポートを改善しました。例えば、`SELECT ... FROM table WHERE a = 'x' ORDER BY a, b`のようなクエリで、`table`のストレージ定義が`MergeTree ORDER BY (a, b)`の場合です。[#38715](https://github.com/ClickHouse/ClickHouse/pull/38715) ([Anton Popov](https://github.com/CurtizJ))。
- `full_sorting_join`の結合ストリームをソート前に相互にフィルタリングするようにしました。[#39418](https://github.com/ClickHouse/ClickHouse/pull/39418) ([Vladimir C](https://github.com/vdimir))。
- 空のリテラル処理をスキップすることでLZ4の展開を最適化しました。[#40142](https://github.com/ClickHouse/ClickHouse/pull/40142) ([Nikita Taranov](https://github.com/nickitat))。
- 可能な場合は`clickhouse-server`のメモリを経由したコピーではなく、ネイティブの`copy`を使用してバックアッププロセスを高速化しました。[#40395](https://github.com/ClickHouse/ClickHouse/pull/40395) ([alesapin](https://github.com/alesapin))。
- 各INSERTブロックごとにストレージスナップショットを取得しないようにしました(パフォーマンスがわずかに向上します)。[#40638](https://github.com/ClickHouse/ClickHouse/pull/40638) ([Azat Khuzhin](https://github.com/azat))。
- 複数のnullable引数を持つ集計関数のバッチ処理を実装しました。[#41058](https://github.com/ClickHouse/ClickHouse/pull/41058) ([Raúl Marín](https://github.com/Algunenano))。
- UniquesHashSetの読み込みを高速化しました(例えば、ディスクからの`uniqState`)。[#41089](https://github.com/ClickHouse/ClickHouse/pull/41089) ([Raúl Marín](https://github.com/Algunenano))。
- 膨大な数のカラムを持つテーブルでコンパクトパートのミューテーションを実行する際の高いメモリ使用量を修正しました。[#41122](https://github.com/ClickHouse/ClickHouse/pull/41122) ([lthaooo](https://github.com/lthaooo))。
- ARM上でvectorscanライブラリを有効にし、正規表現の評価を高速化しました。[#41033](https://github.com/ClickHouse/ClickHouse/pull/41033) ([Robert Schulze](https://github.com/rschu1ze))。
- vectorscanを5.4.8にアップグレードしました。これには正規表現の評価を高速化する多くのパフォーマンス最適化が含まれています。[#41270](https://github.com/ClickHouse/ClickHouse/pull/41270) ([Robert Schulze](https://github.com/rschu1ze))。
- 非常に高い同時実行レベルで発生していた、VFS(S3など)のローカルファイルシステムキャッシュをスキップする誤ったフォールバックを修正しました。[#40420](https://github.com/ClickHouse/ClickHouse/pull/40420) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 行ポリシーフィルタが常にfalseの場合、データを読み込むことなく即座に空の結果を返すようにしました。これにより[#24012](https://github.com/ClickHouse/ClickHouse/issues/24012)がクローズされます。[#40740](https://github.com/ClickHouse/ClickHouse/pull/40740) ([Amos Bird](https://github.com/amosbird))。
- Float型データに対する並列ハッシュJOINが最適でない可能性がありました。これを改善しました。[#41183](https://github.com/ClickHouse/ClickHouse/pull/41183) ([Alexey Milovidov](https://github.com/alexey-milovidov))。





#### 改善 {#improvement-3}

- During startup and ATTACH call, `ReplicatedMergeTree` tables will be readonly until the ZooKeeper connection is made and the setup is finished. [#40148](https://github.com/ClickHouse/ClickHouse/pull/40148) ([Antonio Andelic](https://github.com/antonio2368)).
- Add `enable_extended_results_for_datetime_functions` option to return results of type Date32 for functions toStartOfYear, toStartOfISOYear, toStartOfQuarter, toStartOfMonth, toStartOfWeek, toMonday and toLastDayOfMonth when argument is Date32 or DateTime64, otherwise results of Date type are returned. For compatibility reasons default value is '0'. [#41214](https://github.com/ClickHouse/ClickHouse/pull/41214) ([Roman Vasin](https://github.com/rvasin)).
- For security and stability reasons, CatBoost models are no longer evaluated within the ClickHouse server. Instead, the evaluation is now done in the clickhouse-library-bridge, a separate process that loads the catboost library and communicates with the server process via HTTP. Function `modelEvaluate()` was replaced by `catboostEvaluate()`. [#40897](https://github.com/ClickHouse/ClickHouse/pull/40897) ([Robert Schulze](https://github.com/rschu1ze)). [#39629](https://github.com/ClickHouse/ClickHouse/pull/39629) ([Robert Schulze](https://github.com/rschu1ze)).
- Add more metrics for on-disk temporary data, close [#40206](https://github.com/ClickHouse/ClickHouse/issues/40206). [#40239](https://github.com/ClickHouse/ClickHouse/pull/40239) ([Vladimir C](https://github.com/vdimir)).
- Add config option `warning_supress_regexp`, close [#40330](https://github.com/ClickHouse/ClickHouse/issues/40330). [#40548](https://github.com/ClickHouse/ClickHouse/pull/40548) ([Vladimir C](https://github.com/vdimir)).
- Add setting to disable limit on kafka_num_consumers. Closes [#40331](https://github.com/ClickHouse/ClickHouse/issues/40331). [#40670](https://github.com/ClickHouse/ClickHouse/pull/40670) ([Kruglov Pavel](https://github.com/Avogar)).
- Support `SETTINGS` in `DELETE ...` query. [#41533](https://github.com/ClickHouse/ClickHouse/pull/41533) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Detailed S3 profile events `DiskS3*` per S3 API call split for S3 ObjectStorage. [#41532](https://github.com/ClickHouse/ClickHouse/pull/41532) ([Sergei Trifonov](https://github.com/serxa)).
- Two new metrics in `system.asynchronous_metrics`. `NumberOfDetachedParts` and `NumberOfDetachedByUserParts`. [#40779](https://github.com/ClickHouse/ClickHouse/pull/40779) ([Sema Checherinda](https://github.com/CheSema)).
- Allow CONSTRAINTs for ODBC and JDBC tables. [#34551](https://github.com/ClickHouse/ClickHouse/pull/34551) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Don't print `SETTINGS` more than once during query formatting if it didn't appear multiple times in the original query. [#38900](https://github.com/ClickHouse/ClickHouse/pull/38900) ([Raúl Marín](https://github.com/Algunenano)).
- Improve the tracing (OpenTelemetry) context propagation across threads. [#39010](https://github.com/ClickHouse/ClickHouse/pull/39010) ([Frank Chen](https://github.com/FrankChen021)).
- ClickHouse Keeper: add listeners for `interserver_listen_host` only in Keeper if specified. [#39973](https://github.com/ClickHouse/ClickHouse/pull/39973) ([Antonio Andelic](https://github.com/antonio2368)).
- Improve recovery of Replicated user access storage after errors. [#39977](https://github.com/ClickHouse/ClickHouse/pull/39977) ([Vitaly Baranov](https://github.com/vitlibar)).
- Add support for TTL in `EmbeddedRocksDB`. [#39986](https://github.com/ClickHouse/ClickHouse/pull/39986) ([Lloyd-Pottiger](https://github.com/Lloyd-Pottiger)).
- Add schema inference to `clickhouse-obfuscator`, so the `--structure` argument is no longer required. [#40120](https://github.com/ClickHouse/ClickHouse/pull/40120) ([Nikolay Degterinsky](https://github.com/evillique)).
- Improve and fix dictionaries in `Arrow` format. [#40173](https://github.com/ClickHouse/ClickHouse/pull/40173) ([Kruglov Pavel](https://github.com/Avogar)).
- More natural conversion of `Date32`, `DateTime64`, `Date` to narrower types: upper or lower normal value is considered when out of normal range. [#40217](https://github.com/ClickHouse/ClickHouse/pull/40217) ([Andrey Zvonov](https://github.com/zvonand)).
- Fix the case when `Merge` table over `View` cannot use index. [#40233](https://github.com/ClickHouse/ClickHouse/pull/40233) ([Duc Canh Le](https://github.com/canhld94)).
- Custom key names for JSON server logs. [#40251](https://github.com/ClickHouse/ClickHouse/pull/40251) ([Mallik Hassan](https://github.com/SadiHassan)).
- It is now possible to set a custom error code for the exception thrown by function `throwIf`. [#40319](https://github.com/ClickHouse/ClickHouse/pull/40319) ([Robert Schulze](https://github.com/rschu1ze)).
- Improve schema inference cache, respect format settings that can change the schema. [#40414](https://github.com/ClickHouse/ClickHouse/pull/40414) ([Kruglov Pavel](https://github.com/Avogar)).
- Allow parsing `Date` as `DateTime` and `DateTime64`. This implements the enhancement proposed in [#36949](https://github.com/ClickHouse/ClickHouse/issues/36949). [#40474](https://github.com/ClickHouse/ClickHouse/pull/40474) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Allow conversion from `String` with `DateTime64` like `2022-08-22 01:02:03.456` to `Date` and `Date32`. Allow conversion from String with DateTime like `2022-08-22 01:02:03` to `Date32`. This closes [#39598](https://github.com/ClickHouse/ClickHouse/issues/39598). [#40475](https://github.com/ClickHouse/ClickHouse/pull/40475) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Better support for nested data structures in Parquet format [#40485](https://github.com/ClickHouse/ClickHouse/pull/40485) ([Arthur Passos](https://github.com/arthurpassos)).
- Support reading Array(Record) into flatten nested table in Avro. [#40534](https://github.com/ClickHouse/ClickHouse/pull/40534) ([Kruglov Pavel](https://github.com/Avogar)).
- Add read-only support for `EmbeddedRocksDB`. [#40543](https://github.com/ClickHouse/ClickHouse/pull/40543) ([Lloyd-Pottiger](https://github.com/Lloyd-Pottiger)).
- Validate the compression method parameter of URL table engine. [#40600](https://github.com/ClickHouse/ClickHouse/pull/40600) ([Frank Chen](https://github.com/FrankChen021)).
- Better format detection for url table function/engine in presence of a query string after a file name. Closes [#40315](https://github.com/ClickHouse/ClickHouse/issues/40315). [#40636](https://github.com/ClickHouse/ClickHouse/pull/40636) ([Kruglov Pavel](https://github.com/Avogar)).
- Disable projection when grouping set is used. It generated wrong result. This fixes [#40635](https://github.com/ClickHouse/ClickHouse/issues/40635). [#40726](https://github.com/ClickHouse/ClickHouse/pull/40726) ([Amos Bird](https://github.com/amosbird)).
- Fix incorrect format of `APPLY` column transformer which can break metadata if used in table definition. This fixes [#37590](https://github.com/ClickHouse/ClickHouse/issues/37590). [#40727](https://github.com/ClickHouse/ClickHouse/pull/40727) ([Amos Bird](https://github.com/amosbird)).
- Support the `%z` descriptor for formatting the timezone offset in `formatDateTime`. [#40736](https://github.com/ClickHouse/ClickHouse/pull/40736) ([Cory Levy](https://github.com/LevyCory)).
- The interactive mode in `clickhouse-client` now interprets `.` and `/` as "run the last command". [#40750](https://github.com/ClickHouse/ClickHouse/pull/40750) ([Robert Schulze](https://github.com/rschu1ze)).
- Fix issue with passing MySQL timeouts for MySQL database engine and MySQL table function. Closes [#34168](https://github.com/ClickHouse/ClickHouse/issues/34168). [#40751](https://github.com/ClickHouse/ClickHouse/pull/40751) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Create status file for filesystem cache directory to make sure that cache directories are not shared between different servers or caches. [#40820](https://github.com/ClickHouse/ClickHouse/pull/40820) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Add support for `DELETE` and `UPDATE` for `EmbeddedRocksDB` storage. [#40853](https://github.com/ClickHouse/ClickHouse/pull/40853) ([Antonio Andelic](https://github.com/antonio2368)).
- ClickHouse Keeper: fix shutdown during long commit and increase allowed request size. [#40941](https://github.com/ClickHouse/ClickHouse/pull/40941) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix race in WriteBufferFromS3, add TSA annotations. [#40950](https://github.com/ClickHouse/ClickHouse/pull/40950) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Grouping sets with group_by_use_nulls should only convert key columns to nullable. [#40997](https://github.com/ClickHouse/ClickHouse/pull/40997) ([Duc Canh Le](https://github.com/canhld94)).
- Improve the observability of INSERT on distributed table. [#41034](https://github.com/ClickHouse/ClickHouse/pull/41034) ([Frank Chen](https://github.com/FrankChen021)).
- More low-level metrics for S3 interaction. [#41039](https://github.com/ClickHouse/ClickHouse/pull/41039) ([mateng915](https://github.com/mateng0915)).
- Support relative path in Location header after HTTP redirect. Closes [#40985](https://github.com/ClickHouse/ClickHouse/issues/40985). [#41162](https://github.com/ClickHouse/ClickHouse/pull/41162) ([Kruglov Pavel](https://github.com/Avogar)).
- Apply changes to HTTP handlers on fly without server restart. [#41177](https://github.com/ClickHouse/ClickHouse/pull/41177) ([Azat Khuzhin](https://github.com/azat)).
- ClickHouse Keeper: properly close active sessions during shutdown. [#41215](https://github.com/ClickHouse/ClickHouse/pull/41215) ([Antonio Andelic](https://github.com/antonio2368)). This lowers the period of "table is read-only" errors.
- Add ability to automatically comment SQL queries in clickhouse-client/local (with `Alt-#`, like in readline). [#41224](https://github.com/ClickHouse/ClickHouse/pull/41224) ([Azat Khuzhin](https://github.com/azat)).
- Fix incompatibility of cache after switching setting `do_no_evict_index_and_mark_files` from 1 to 0, 0 to 1. [#41330](https://github.com/ClickHouse/ClickHouse/pull/41330) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Add a setting `allow_suspicious_fixed_string_types` to prevent users from creating columns of type FixedString with size > 256. [#41495](https://github.com/ClickHouse/ClickHouse/pull/41495) ([Duc Canh Le](https://github.com/canhld94)).
- Add `has_lightweight_delete` to system.parts. [#41564](https://github.com/ClickHouse/ClickHouse/pull/41564) ([Kseniia Sumarokova](https://github.com/kssenii)).





#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-3}

- すべての設定に対するドキュメント化を義務付けました。[#40644](https://github.com/ClickHouse/ClickHouse/pull/40644) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- すべての現在のメトリックに対するドキュメント化を義務付けました。[#40645](https://github.com/ClickHouse/ClickHouse/pull/40645) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- すべてのプロファイルイベントカウンターに対するドキュメント化を義務付けました。欠落していた箇所にドキュメントを記述しました。[#40646](https://github.com/ClickHouse/ClickHouse/pull/40646) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 一部の依存関係を修正することで、最小限の`clickhouse-local`ビルドを可能にしました。[#40460](https://github.com/ClickHouse/ClickHouse/pull/40460) ([Alexey Milovidov](https://github.com/alexey-milovidov))。50 MiB未満です。
- テストにおけるSQL関数のカバレッジを計算し、レポートします。[#40593](https://github.com/ClickHouse/ClickHouse/issues/40593)。[#40647](https://github.com/ClickHouse/ClickHouse/pull/40647) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- すべてのMergeTree設定に対するドキュメント化を義務付けました。[#40648](https://github.com/ClickHouse/ClickHouse/pull/40648) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 高レベルの統一されたサーバーコンポーネント向けの組み込みリファレンスドキュメントのプロトタイプです。[#40649](https://github.com/ClickHouse/ClickHouse/pull/40649) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 変更されたすべてのクエリがテストされたことを確認するため、変更されたパフォーマンステストからすべてのクエリをチェックします。[#40322](https://github.com/ClickHouse/ClickHouse/pull/40322) ([Nikita Taranov](https://github.com/nickitat))。
- TGZパッケージを修正しました。[#40681](https://github.com/ClickHouse/ClickHouse/pull/40681) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- デバッグシンボルを修正しました。[#40873](https://github.com/ClickHouse/ClickHouse/pull/40873) ([Azat Khuzhin](https://github.com/azat))。
- x86 SSE2専用ビルドを作成するためにCI設定を拡張しました。古いハードウェアや組み込みハードウェアに有用です。[#40999](https://github.com/ClickHouse/ClickHouse/pull/40999) ([Robert Schulze](https://github.com/rschu1ze))。
- llvm/clang 15に切り替えました。[#41046](https://github.com/ClickHouse/ClickHouse/pull/41046) ([Azat Khuzhin](https://github.com/azat))。
- [#40938](https://github.com/ClickHouse/ClickHouse/issues/40938)の続きです。`Loggers`クラスのODR違反を修正しました。[#40398](https://github.com/ClickHouse/ClickHouse/issues/40398)、[#40937](https://github.com/ClickHouse/ClickHouse/issues/40937)を修正します。[#41060](https://github.com/ClickHouse/ClickHouse/pull/41060) ([Dmitry Novik](https://github.com/novikd))。
- GitHubリリースアセットにmacOSバイナリを追加しました。これにより[#37718](https://github.com/ClickHouse/ClickHouse/issues/37718)が修正されます。[#41088](https://github.com/ClickHouse/ClickHouse/pull/41088) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- c-aresライブラリがClickHouseのビルドシステムにバンドルされるようになりました。[#41239](https://github.com/ClickHouse/ClickHouse/pull/41239) ([Robert Schulze](https://github.com/rschu1ze))。
- メインのClickHouseコードから`dlopen`を削除しました。library-bridgeとodbc-bridgeには残ります。[#41428](https://github.com/ClickHouse/ClickHouse/pull/41428) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- メインのClickHouseバイナリでは`dlopen`を許可しません。有害で安全でないためです。私たちは使用していません。しかし、一部のライブラリが「プラグイン」の実装に使用する可能性があります。プロセスのアドレス空間にサードパーティの制御されていない危険なライブラリをロードする古い手法は、正気の沙汰ではないため、絶対に推奨しません。[#41429](https://github.com/ClickHouse/ClickHouse/pull/41429) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- debパッケージに`source`フィールドを追加し、`nfpm`を更新しました。[#41531](https://github.com/ClickHouse/ClickHouse/pull/41531) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- 自社製DWARFパーサーでDWARF-5をサポートしました。[#40710](https://github.com/ClickHouse/ClickHouse/pull/40710) ([Azat Khuzhin](https://github.com/azat))。
- テスト用にZooKeeperクライアントに障害注入を追加しました [#30498](https://github.com/ClickHouse/ClickHouse/pull/30498) ([Alexander Tokmakov](https://github.com/tavplubix))。
- debugとtsanを使用したs3ストレージでのステートレステストを追加しました [#35262](https://github.com/ClickHouse/ClickHouse/pull/35262) ([Kseniia Sumarokova](https://github.com/kssenii))。
- S3上でストレステストを試行しました [#36837](https://github.com/ClickHouse/ClickHouse/pull/36837) ([alesapin](https://github.com/alesapin))。
- `clang-tidy`で`concurrency-mt-unsafe`を有効にしました [#40224](https://github.com/ClickHouse/ClickHouse/pull/40224) ([Alexey Milovidov](https://github.com/alexey-milovidov))。

#### バグ修正 {#bug-fix}


* S3 経由で ClickHouse を使用している場合にのみ発生しうる、[AWS SDK のバグ](https://github.com/aws/aws-sdk-cpp/issues/658) に起因する潜在的なデータ損失を修正しました。[#40506](https://github.com/ClickHouse/ClickHouse/pull/40506)（[alesapin](https://github.com/alesapin)）。このバグは AWS SDK で 5 年間放置されていましたが、当社からの報告後にクローズされました。
* Native フォーマット内の悪意のあるデータが原因でクラッシュする可能性があります。 [#41441](https://github.com/ClickHouse/ClickHouse/pull/41441) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* 集約関数 `categorialInformationValue` のプロパティ定義に誤りがあり、実行時にヌルポインタ参照が発生する可能性がありました。これにより [#41443](https://github.com/ClickHouse/ClickHouse/issues/41443) が解決されます。[#41449](https://github.com/ClickHouse/ClickHouse/pull/41449)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* Apache `ORC` フォーマットでデータを書き込むと、バッファオーバーランが発生する可能性がありました。 [#41458](https://github.com/ClickHouse/ClickHouse/pull/41458) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* `encrypt` と `contingency` 関数で、引数として Array of Nullable が使用された場合に発生するメモリ安全性の問題を修正しました。これにより [#41004](https://github.com/ClickHouse/ClickHouse/issues/41004) が解決されます。[#40195](https://github.com/ClickHouse/ClickHouse/pull/40195)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* &#39;not&#95;processed&#39; が null でない場合の MergeJoin のバグを修正。 [#40335](https://github.com/ClickHouse/ClickHouse/pull/40335) ([liql2007](https://github.com/liql2007)).
* IN 演算子で Decimal の精度損失が発生した場合に誤った結果になる問題を修正。ref [#41125](https://github.com/ClickHouse/ClickHouse/issues/41125)。[#41130](https://github.com/ClickHouse/ClickHouse/pull/41130)（[Vladimir C](https://github.com/vdimir)）。
* 複数レベルを持つ `Nested` カラムの欠損値補完処理を修正。 [#37152](https://github.com/ClickHouse/ClickHouse/pull/37152) ([Anton Popov](https://github.com/CurtizJ))。
* Ordinary（非推奨）データベース向けの SYSTEM UNFREEZE クエリを修正しました。[https://github.com/ClickHouse/ClickHouse/pull/36424](https://github.com/ClickHouse/ClickHouse/pull/36424) に対する修正です。[#38262](https://github.com/ClickHouse/ClickHouse/pull/38262)（[Vadim Volodin](https://github.com/PolyProgrammist)）。
* WITH 文によって導入された未使用の未知のカラムを修正します。これにより [#37812](https://github.com/ClickHouse/ClickHouse/issues/37812) が解決されます。[#39131](https://github.com/ClickHouse/ClickHouse/pull/39131) ([Amos Bird](https://github.com/amosbird))。
* ウィンドウ関数が存在する場合の `ORDER BY` に対するクエリ解析を修正。 [#38741](https://github.com/ClickHouse/ClickHouse/issues/38741) および [#24892](https://github.com/ClickHouse/ClickHouse/issues/24892) を修正。 [#39354](https://github.com/ClickHouse/ClickHouse/pull/39354) ([Dmitry Novik](https://github.com/novikd)).
* ユーザーがウィンドウの ORDER BY/PARTITION BY 句で集約関数を使用した式を計算しようとした際に発生する `Unknown identifier (aggregate-function)` 例外を修正しました。 [#39762](https://github.com/ClickHouse/ClickHouse/pull/39762) ([Vladimir Chebotaryov](https://github.com/quickhouse))。
* `max_analyze_depth` 設定で 1 つのクエリに対する解析回数を制限しました。これにより、非常に多くのサブクエリを含むクエリの解析時間が、指数関数的に増大することを防ぎます。 [#40334](https://github.com/ClickHouse/ClickHouse/pull/40334) ([Vladimir C](https://github.com/vdimir))。
* MergeTree エンジンファミリーのカラム TTL に関するまれなバグを修正しました。繰り返し縦型マージが行われた場合に、`Cannot unlink file ColumnName.bin ... No such file or directory.` というエラーが発生することがありました。 [#40346](https://github.com/ClickHouse/ClickHouse/pull/40346) ([alesapin](https://github.com/alesapin)).
* 存在する場合は、IPv4 と IPv6 の両方に対して DNS エントリを使用するようにしました。 [#40353](https://github.com/ClickHouse/ClickHouse/pull/40353) ([Maksim Kita](https://github.com/kitaisreal)).
* Hadoop から Snappy 圧縮ファイルを読み取れるようにしました。 [#40482](https://github.com/ClickHouse/ClickHouse/pull/40482) ([Kruglov Pavel](https://github.com/Avogar)).
* 可変次元の配列を含む `Object` 型（実験的機能）の値をパースする際に発生していたクラッシュを修正しました。 [#40483](https://github.com/ClickHouse/ClickHouse/pull/40483) ([Duc Canh Le](https://github.com/canhld94)).
* 設定 `input_format_tsv_skip_first_lines` を修正しました。 [#40491](https://github.com/ClickHouse/ClickHouse/pull/40491) ([mini4](https://github.com/mini4))。
* MaterializedPostgreSQL データベース / テーブルエンジンの起動時に発生する不具合（レースコンディション）を修正しました。 [#40262](https://github.com/ClickHouse/ClickHouse/issues/40262)。`relcache&#95;callback&#95;list` スロット数の上限に達した際に発生するエラーを修正しました。 [#40511](https://github.com/ClickHouse/ClickHouse/pull/40511) ([Maksim Buren](https://github.com/maks-buren630501))。
* DateTime64 のパース時に発生し得るエラー「Decimal math overflow」を修正。 [#40546](https://github.com/ClickHouse/ClickHouse/pull/40546) ([Kruglov Pavel](https://github.com/Avogar)).
* 軽量な削除行を含むパーツの縦方向マージを修正。 [#40559](https://github.com/ClickHouse/ClickHouse/pull/40559) ([Alexander Gololobov](https://github.com/davenger)).
* URL テーブルエンジンで圧縮を有効にした状態でデータを書き込むとセグメンテーションフォルトが発生する問題を修正しました。 [#40565](https://github.com/ClickHouse/ClickHouse/pull/40565) ([Frank Chen](https://github.com/FrankChen021)).
* `arrayElement` 関数で `Map` を使用した際に発生する可能性のある論理エラー `'Invalid Field get from type UInt64 to type String'` を修正しました。 [#40572](https://github.com/ClickHouse/ClickHouse/pull/40572)（[Kruglov Pavel](https://github.com/Avogar)）。
* ファイルシステムキャッシュで発生しうるレースコンディションを修正。 [#40586](https://github.com/ClickHouse/ClickHouse/pull/40586) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `MergeTree` テーブルにおいて、影響を受けないパーティションでの mutation をスキップする機能を削除しました。この機能は正しく動作しておらず、完了済みの mutation が復活してしまう可能性があったためです。 [#40589](https://github.com/ClickHouse/ClickHouse/pull/40589) ([Alexander Tokmakov](https://github.com/tavplubix)).
* 実行時に既に使用中の gRPC ポートを設定に追加すると、ClickHouse サーバーがクラッシュします。 [#40597](https://github.com/ClickHouse/ClickHouse/pull/40597) ([何李夫](https://github.com/helifu))。
* `base58Encode / base58Decode` が先頭の 0 / &#39;1&#39; を処理する際の問題を修正。[#40620](https://github.com/ClickHouse/ClickHouse/pull/40620)（[Andrey Zvonov](https://github.com/zvonand)）。
* keeper-fix: スナップショットのインストール中にログへアクセスする際に発生するレースコンディションを修正。 [#40627](https://github.com/ClickHouse/ClickHouse/pull/40627) ([Antonio Andelic](https://github.com/antonio2368)).
* toFixedString 関数のショートサーキット実行を修正。([#40622](https://github.com/ClickHouse/ClickHouse/issues/40622)) を部分的に解決。 [#40628](https://github.com/ClickHouse/ClickHouse/pull/40628) ([Kruglov Pavel](https://github.com/Avogar)).
* ClickHouse における SQLite の int8 カラムから int64 カラムへの変換を修正します。[#40639](https://github.com/ClickHouse/ClickHouse/issues/40639) を修正します。[#40642](https://github.com/ClickHouse/ClickHouse/pull/40642)（[Barum Rho](https://github.com/barumrho)）。
* 再帰的な `Buffer` テーブルで発生するスタックオーバーフローを修正しました。これにより [#40637](https://github.com/ClickHouse/ClickHouse/issues/40637) がクローズされます。[#40643](https://github.com/ClickHouse/ClickHouse/pull/40643)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 新しいクエリを `ProcessList` に挿入する際にメモリ割り当てが発生します。これらの割り当て中にメモリ制限に達した場合、`ProcessList::mutex` はすでに取得済みのため、`OvercommitTracker` を使用できません。[#40611](https://github.com/ClickHouse/ClickHouse/issues/40611) を修正。[#40677](https://github.com/ClickHouse/ClickHouse/pull/40677)（[Dmitry Novik](https://github.com/novikd)）。
* マーク読み取り時に `max_read_buffer_size=0` の場合に発生する LOGICAL&#95;ERROR を修正しました。 [#40705](https://github.com/ClickHouse/ClickHouse/pull/40705) ([Azat Khuzhin](https://github.com/azat)).
* クエリコンテキストなしで（Kafka などから）マテリアライズドビューにプッシュする際に発生するメモリリークを修正。 [#40732](https://github.com/ClickHouse/ClickHouse/pull/40732) ([Azat Khuzhin](https://github.com/azat)).
* CSV スキーマ推論で発生する可能性のあるエラー「Attempt to read after eof」を修正。 [#40746](https://github.com/ClickHouse/ClickHouse/pull/40746) ([Kruglov Pavel](https://github.com/Avogar)).
* ライトスルーキャッシュにおける論理エラー「File segment completion can be done only by downloader」を修正しました。[#40748](https://github.com/ClickHouse/ClickHouse/issues/40748) をクローズします。[#40759](https://github.com/ClickHouse/ClickHouse/pull/40759)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `GROUPING` 関数の結果を、SQL および他の DBMS と同じになるようにしました。 [#40762](https://github.com/ClickHouse/ClickHouse/pull/40762) ([Dmitry Novik](https://github.com/novikd))。
* `host_regexp` 機能が `/etc/hosts` での名前からアドレスへの解決時に正しく動作していないと、[#40595](https://github.com/ClickHouse/ClickHouse/issues/40595) で報告されました。修正済みです。[#40769](https://github.com/ClickHouse/ClickHouse/pull/40769) ([Arthur Passos](https://github.com/arthurpassos))。
* Log ファミリーの増分バックアップを修正。 [#40827](https://github.com/ClickHouse/ClickHouse/pull/40827) ([Vitaly Baranov](https://github.com/vitlibar)).
* ゼロコピーレプリケーションにおいて、極めてまれに発生しうる潜在的なデータ損失につながるバグを修正。 [#40844](https://github.com/ClickHouse/ClickHouse/pull/40844) ([alesapin](https://github.com/alesapin)).
* 同じ集合式が異なるカラムから構築された場合に発生するキー条件解析のクラッシュを修正。 [#40850](https://github.com/ClickHouse/ClickHouse/pull/40850) ([Duc Canh Le](https://github.com/canhld94)).
* ネストした JSON オブジェクトのスキーマ推論を修正。 [#40851](https://github.com/ClickHouse/ClickHouse/pull/40851) ([Kruglov Pavel](https://github.com/Avogar)).
* 空の場合に削除されないファイルシステムキャッシュファイル用の3桁プレフィックスディレクトリの問題を修正。 [#40797](https://github.com/ClickHouse/ClickHouse/issues/40797) をクローズ。 [#40867](https://github.com/ClickHouse/ClickHouse/pull/40867)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* レプリカへの接続失敗時に発生する捕捉されていない DNS&#95;ERROR を修正。[#40881](https://github.com/ClickHouse/ClickHouse/pull/40881)（[Robert Coelho](https://github.com/coelho)）。
* サブクエリで不要なカラムを削除する処理に関するバグを修正。 [#40884](https://github.com/ClickHouse/ClickHouse/pull/40884) ([luocongkai](https://github.com/TKaxe)).
* リモート読み取りバッファにおける余分なメモリアロケーションを修正。 [#40896](https://github.com/ClickHouse/ClickHouse/pull/40896) ([Kseniia Sumarokova](https://github.com/kssenii)).
* データベースの削除権限が明示的に取り消されているユーザーでもデータベースを削除できてしまう問題を修正しました。 [#40906](https://github.com/ClickHouse/ClickHouse/pull/40906) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* ClickHouse Keeper の修正: 書き込みリクエスト内のパスを Keeper の内部システムノードのパスと正しく比較するようにしました。 [#40918](https://github.com/ClickHouse/ClickHouse/pull/40918) ([Antonio Andelic](https://github.com/antonio2368))。
* WriteBufferFromS3 のデッドロックを修正しました。 [#40943](https://github.com/ClickHouse/ClickHouse/pull/40943) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `DESCRIBE TABLE url()` および一部のその他の `DESCRIBE TABLE <table_function>()` に対するアクセス権を修正。 [#40975](https://github.com/ClickHouse/ClickHouse/pull/40975) ([Vitaly Baranov](https://github.com/vitlibar)).
* `WITH GROUPING SETS` 向けの誤ったパーサーロジックを削除しました。これにより `nullptr` 参照が発生する可能性がありました。 [#41049](https://github.com/ClickHouse/ClickHouse/pull/41049) ([Duc Canh Le](https://github.com/canhld94)).
* ClickHouse Keeper の修正: Keeper のシャットダウン中に発生する可能性があるセグメンテーションフォルトを修正。 [#41075](https://github.com/ClickHouse/ClickHouse/pull/41075) ([Antonio Andelic](https://github.com/antonio2368))。
* 集約関数コンビネーターにおけるセグメンテーションフォルトの発生可能性、use-after-free のヒープ使用、およびメモリリークを修正。[#40848](https://github.com/ClickHouse/ClickHouse/issues/40848) をクローズ。[#41083](https://github.com/ClickHouse/ClickHouse/pull/41083)（[Kruglov Pavel](https://github.com/Avogar)）。
* Window views を使用して query&#95;views&#95;log を修正しました。[#41132](https://github.com/ClickHouse/ClickHouse/pull/41132) ([Raúl Marín](https://github.com/Algunenano)).
* デフォルトで optimize&#95;monotonous&#95;functions&#95;in&#95;order&#95;by を無効化し、次の問題を緩和します: [#40094](https://github.com/ClickHouse/ClickHouse/issues/40094)。[#41136](https://github.com/ClickHouse/ClickHouse/pull/41136)（[Denny Crane](https://github.com/den-crane)）。
* データベースエンジンを Ordinary から Atomic へ自動変換する際に発生していた &quot;possible deadlock avoided&quot; エラーを修正しました。 [#41146](https://github.com/ClickHouse/ClickHouse/pull/41146) ([Alexander Tokmakov](https://github.com/tavplubix)).
* 空のブロックが発生した場合に SortedBlocksWriter で起こり得る SIGSEGV を修正（`optimize_aggregation_in_order` と `join_algorithm=auto` を使用した場合に発生する可能性あり）。 [#41154](https://github.com/ClickHouse/ClickHouse/pull/41154) ([Azat Khuzhin](https://github.com/azat))。
* `array join` を伴う trivial count 最適化が有効な場合に誤ったクエリ結果が返される問題を修正しました。これにより [#39431](https://github.com/ClickHouse/ClickHouse/issues/39431) が解決されました。[#41158](https://github.com/ClickHouse/ClickHouse/pull/41158)（[Denny Crane](https://github.com/den-crane)）。
* GetPriorityForLoadBalancing::getPriorityFunc() における stack-use-after-return を修正。 [#41159](https://github.com/ClickHouse/ClickHouse/pull/41159) ([Azat Khuzhin](https://github.com/azat))。
* 位置引数の例外「Positional argument out of bounds」を修正。[#40634](https://github.com/ClickHouse/ClickHouse/issues/40634) をクローズ。[#41189](https://github.com/ClickHouse/ClickHouse/pull/41189)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 破損したデタッチ済みパーツのバックグラウンドクリーンアップを修正。 [#41190](https://github.com/ClickHouse/ClickHouse/pull/41190) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `WHERE` 句を伴う多数のクロス結合がある場合の指数的なクエリ書き換えを修正。[#21557](https://github.com/ClickHouse/ClickHouse/issues/21557)。 [#41223](https://github.com/ClickHouse/ClickHouse/pull/41223)（[Vladimir C](https://github.com/vdimir)）。
* 書き込みスルーキャッシュにおいて、一部の例外型が想定どおりにハンドリングされていなかったことが原因で発生し得た論理エラーを修正しました。[#41208](https://github.com/ClickHouse/ClickHouse/issues/41208) をクローズ。 [#41232](https://github.com/ClickHouse/ClickHouse/pull/41232)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* system.filesystem&#95;cache&#95;log 内の String 型ログエントリを修正。 [#41233](https://github.com/ClickHouse/ClickHouse/pull/41233) ([jmimbrero](https://github.com/josemimbrero-tinybird)).
* サブクエリで `OFFSET` 句を使用し、外側のクエリで `WHERE` 句を使用するクエリが誤った結果を返す可能性がある問題を修正しました。[#40416](https://github.com/ClickHouse/ClickHouse/issues/40416) の修正。[#41280](https://github.com/ClickHouse/ClickHouse/pull/41280)（[Alexander Tokmakov](https://github.com/tavplubix)）。
* `query_plan_optimize_primary_key` を有効にした場合に誤ったクエリ結果が返される可能性のある問題を修正しました。[#40599](https://github.com/ClickHouse/ClickHouse/issues/40599) を修正。[#41281](https://github.com/ClickHouse/ClickHouse/pull/41281)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* lowerUTF8/upperUTF8 において、無効なシーケンスが他の行に影響を与えないようにしました。 [#41286](https://github.com/ClickHouse/ClickHouse/pull/41286) ([Azat Khuzhin](https://github.com/azat)).
* 型が `Object` のカラムを対象とする `ALTER &lt;table&gt; ADD COLUMN` クエリを修正しました。 [#41290](https://github.com/ClickHouse/ClickHouse/pull/41290) ([Anton Popov](https://github.com/CurtizJ)).
* 設定に `distributed_ddl.path` が存在しない場合に `system.distributed_ddl_queue` からの SELECT で発生していた「No node」エラーを修正しました。 [#41096](https://github.com/ClickHouse/ClickHouse/issues/41096) を解決します。 [#41296](https://github.com/ClickHouse/ClickHouse/pull/41296) ([young scott](https://github.com/young-scott)).
* ディスクオブジェクトストレージで発生していた誤った論理エラー `Expected relative path` を修正しました。関連: [#41246](https://github.com/ClickHouse/ClickHouse/issues/41246)。[#41297](https://github.com/ClickHouse/ClickHouse/pull/41297)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* MsgPack 形式での UUID 挿入前に列型チェックを追加。 [#41309](https://github.com/ClickHouse/ClickHouse/pull/41309) ([Kruglov Pavel](https://github.com/Avogar)).
* `async_insert` 設定を有効にした非同期挿入時に、`Object` 型のカラムへ不正なデータを挿入すると発生しうるクラッシュを修正しました。これは、すべての非同期挿入バッチ内の JSON が不正でパースできない場合に発生する可能性がありました。[#41336](https://github.com/ClickHouse/ClickHouse/pull/41336)（[Anton Popov](https://github.com/CurtizJ)）。
* async&#95;socket&#95;for&#95;remote/use&#95;hedged&#95;requests と並列 KILL で発生し得るデッドロックを修正。 [#41343](https://github.com/ClickHouse/ClickHouse/pull/41343) ([Azat Khuzhin](https://github.com/azat)).
* デフォルトで optimize&#95;rewrite&#95;sum&#95;if&#95;to&#95;count&#95;if を無効化し、次の問題を緩和: [#38605](https://github.com/ClickHouse/ClickHouse/issues/38605) [#38683](https://github.com/ClickHouse/ClickHouse/issues/38683)。 [#41388](https://github.com/ClickHouse/ClickHouse/pull/41388)（[Denny Crane](https://github.com/den-crane)）。
* 22.8 以降、データベースが `Replicated` で、かつクラスタ名とデータベース名が同じ場合には、`ON CLUSTER` 句が無視されていました。このため、`DROP PARTITION ON CLUSTER` は `Replicated` に対して想定外の動作をしていました。この問題は修正され、現在はデータベースレベルでレプリケートされるクエリに対してのみ `ON CLUSTER` 句が無視されるようになりました。 [#41299](https://github.com/ClickHouse/ClickHouse/issues/41299) を修正。 [#41390](https://github.com/ClickHouse/ClickHouse/pull/41390)（[Alexander Tokmakov](https://github.com/tavplubix)）。
* クエリのキャンセル（`KILL QUERY` またはサーバーのシャットダウン）時に発生しうるハング／デッドロックを修正。 [#41467](https://github.com/ClickHouse/ClickHouse/pull/41467) ([Azat Khuzhin](https://github.com/azat)).
* JBOD 機能使用時に発生する可能性のあったサーバークラッシュを修正しました。これにより [#41365](https://github.com/ClickHouse/ClickHouse/issues/41365) が解決されます。 [#41483](https://github.com/ClickHouse/ClickHouse/pull/41483)（[Amos Bird](https://github.com/amosbird)）。
* Nullable な FixedString から String への変換を修正。 [#41541](https://github.com/ClickHouse/ClickHouse/pull/41541) ([Duc Canh Le](https://github.com/canhld94)).
* 誤った集計状態が groupBitmap* に渡された場合にクラッシュしないようにしました。 [#41563](https://github.com/ClickHouse/ClickHouse/pull/41563) ([Raúl Marín](https://github.com/Algunenano))。
* `ORDER BY` を含み、かつ `1500 <= LIMIT <= max_block_size` を満たすクエリで、先頭の行が欠落した誤った結果が返される可能性がありました。これを修正しました。[#41182](https://github.com/ClickHouse/ClickHouse/issues/41182)。[#41576](https://github.com/ClickHouse/ClickHouse/pull/41576)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* マテリアライズドビュー使用時の `X-ClickHouse-Summary` における読み取りバイト数／行数の値を修正。[#41586](https://github.com/ClickHouse/ClickHouse/pull/41586)（[Raúl Marín](https://github.com/Algunenano)）。
* `OFFSET` を含むクエリで発生しうる `pipeline stuck` 例外を修正しました。このエラーは `enable_optimize_predicate_expression = 0` かつ `WHERE` 句の条件が常に偽である場合に発生することが確認されました。 [#41383](https://github.com/ClickHouse/ClickHouse/issues/41383) を修正します。 [#41588](https://github.com/ClickHouse/ClickHouse/pull/41588)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。

### <a id="228"></a> ClickHouse リリース 22.8, 2022-08-18 {#a-id228a-clickhouse-release-228-2022-08-18}

#### 後方互換性のない変更 {#backward-incompatible-change-3}

- `Date32` および `DateTime64` の範囲を拡張し、1900年から2299年までの日付をサポートするようになりました。以前のバージョンでは、サポートされる範囲は1925年から2283年のみでした。実装では、ユリウス暦からグレゴリオ暦への歴史的な移行を考慮せず、先発グレゴリオ暦([ISO 8601](https://en.wikipedia.org/wiki/ISO_8601):2004(第3.2.1項 グレゴリオ暦)に準拠)を使用しています。この変更は、範囲外の引数に対する実装固有の動作に影響します。例えば、以前のバージョンでは `1899-01-01` の値が `1925-01-01` にクランプされていましたが、新しいバージョンでは `1900-01-01` にクランプされます。また、`INTERVAL 3 QUARTER` を渡した場合、間隔が実装固有の時点から計算されるため、`toStartOfInterval` による丸め処理の動作が最大1四半期分変更されます。[#28216](https://github.com/ClickHouse/ClickHouse/issues/28216) をクローズし、[#38393](https://github.com/ClickHouse/ClickHouse/issues/38393) を改善します。[#39425](https://github.com/ClickHouse/ClickHouse/pull/39425) ([Roman Vasin](https://github.com/rvasin))。
- すべての関連する辞書ソースが `remote_url_allow_hosts` 設定を尊重するようになりました。HTTP、Cassandra、Redis については既に対応済みでした。ClickHouse、MongoDB、MySQL、PostgreSQL が追加されました。ホストのチェックは DDL から作成された辞書に対してのみ行われます。[#39184](https://github.com/ClickHouse/ClickHouse/pull/39184) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- ビルド済み ClickHouse x86 バイナリは、AVX 命令のサポートが必要になりました。つまり、2011年にリリースされた Intel Sandy Bridge / AMD Bulldozer 以降の CPU が必要です。[#39000](https://github.com/ClickHouse/ClickHouse/pull/39000) ([Robert Schulze](https://github.com/rschu1ze))。
- リモートファイルシステムキャッシュを組み合わせ可能にし、特定のファイル(idx、mrk など)を退避させないようにし、古いキャッシュバージョンを削除します。Azure Blob Storage ディスク、ローカルディスク、StaticWeb ディスクなどの上にキャッシュを構成できるようになりました。この PR は、キャッシュ設定が変更され、キャッシュを機能させるには設定ファイルを更新する必要があるため、後方互換性がないとマークされています。古いキャッシュは新しい設定でも引き続き使用されます。サーバーは古いキャッシュ設定でも正常に起動します。https://github.com/ClickHouse/ClickHouse/issues/36140 をクローズします。https://github.com/ClickHouse/ClickHouse/issues/37889 をクローズします。([Kseniia Sumarokova](https://github.com/kssenii))。[#36171](https://github.com/ClickHouse/ClickHouse/pull/36171))


#### 新機能 {#new-feature-4}

- MergeTreeテーブルでのSQL標準DELETE FROM構文のサポート、およびMergeTreeファミリー向けの軽量削除実装。[#37893](https://github.com/ClickHouse/ClickHouse/pull/37893) ([Jianmei Zhang](https://github.com/zhangjmruc)) ([Alexander Gololobov](https://github.com/davenger))。注意: この新機能によってClickHouseがHTAP DBMSになるわけではありません。
- クエリパラメータをインタラクティブモードで`SET param_abc = 'def'`として設定し、ネイティブプロトコル経由で設定として転送できるようになりました。[#39906](https://github.com/ClickHouse/ClickHouse/pull/39906) ([Nikita Taranov](https://github.com/nickitat))。
- ネイティブプロトコルでクォータキーを設定できるようになりました([Yakov Olkhovsky](https://github.com/ClickHouse/ClickHouse/pull/39874))。
- 設定`exact_rows_before_limit` (0/1)を追加しました。有効にすると、ClickHouseは`rows_before_limit_at_least`統計の正確な値を提供しますが、その代償としてlimit前のデータを完全に読み取る必要があります。これにより[#6613](https://github.com/ClickHouse/ClickHouse/issues/6613)が解決されます。[#25333](https://github.com/ClickHouse/ClickHouse/pull/25333) ([kevin wan](https://github.com/MaxWk))。
- `s3Cluster`テーブル関数を使用した並列分散INSERT SELECTの、`Distributed`および`Replicated`エンジンのテーブルへのサポートを追加しました[#34670](https://github.com/ClickHouse/ClickHouse/issues/34670)。[#39107](https://github.com/ClickHouse/ClickHouse/pull/39107) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- テキスト形式からのスキーマ推論を制御する新しい設定を追加しました: - `input_format_try_infer_dates` - 文字列から日付を推論します。- `input_format_try_infer_datetimes` - 文字列から日時を推論します。- `input_format_try_infer_integers` - `Float64`の代わりに`Int64`を推論します。- `input_format_json_try_infer_numbers_from_strings` - JSON形式のJSON文字列から数値を推論します。[#39186](https://github.com/ClickHouse/ClickHouse/pull/39186) ([Kruglov Pavel](https://github.com/Avogar))。
- JSON形式のログ出力を提供するオプション。ログ分析ツールでの取り込みとクエリを容易にすることを目的としています。[#39277](https://github.com/ClickHouse/ClickHouse/pull/39277) ([Mallik Hassan](https://github.com/SadiHassan))。
- 長時間実行されるクエリや継続的なクエリ中に現在時刻を取得できる関数`nowInBlock`を追加しました。[#39522](https://github.com/ClickHouse/ClickHouse/issues/39522)を解決します。注意: `now64InBlock`や`todayInBlock`という関数は存在しません。[#39533](https://github.com/ClickHouse/ClickHouse/pull/39533) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `executable()`テーブル関数の設定を指定する機能を追加しました。[#39681](https://github.com/ClickHouse/ClickHouse/pull/39681) ([Constantine Peresypkin](https://github.com/pkit))。
- データベースエンジンの`Ordinary`から`Atomic`への自動変換を実装しました。`flags`ディレクトリに空の`convert_ordinary_to_atomic`ファイルを作成すると、次回のサーバー起動時にすべての`Ordinary`データベースが自動的に変換されます。[#39546](https://github.com/ClickHouse/ClickHouse/issues/39546)を解決します。[#39933](https://github.com/ClickHouse/ClickHouse/pull/39933) ([Alexander Tokmakov](https://github.com/tavplubix))。
- `SELECT ... INTO OUTFILE '...' AND STDOUT`をサポートしました。[#37490](https://github.com/ClickHouse/ClickHouse/issues/37490)。[#39054](https://github.com/ClickHouse/ClickHouse/pull/39054) ([SmitaRKulkarni](https://github.com/SmitaRKulkarni))。
- フォーマット`PrettyMonoBlock`、`PrettyNoEscapesMonoBlock`、`PrettyCompactNoEscapes`、`PrettyCompactNoEscapesMonoBlock`、`PrettySpaceNoEscapes`、`PrettySpaceMonoBlock`、`PrettySpaceNoEscapesMonoBlock`を追加しました。[#39646](https://github.com/ClickHouse/ClickHouse/pull/39646) ([Kruglov Pavel](https://github.com/Avogar))。


#### パフォーマンス改善 {#performance-improvement-4}

- 集計結果のメモリ効率的なマージ処理におけるメモリ使用量を改善しました。[#39429](https://github.com/ClickHouse/ClickHouse/pull/39429) ([Nikita Taranov](https://github.com/nickitat))。
- クエリによって作成される同時実行スレッドの総数を制限する並行制御ロジックを追加しました。[#37558](https://github.com/ClickHouse/ClickHouse/pull/37558) ([Sergei Trifonov](https://github.com/serxa))。すべてのクエリのスレッド総数を制限することで、高QPSの場合のパフォーマンスを向上させる`concurrent_threads_soft_limit parameter`を追加しました。[#37285](https://github.com/ClickHouse/ClickHouse/pull/37285) ([Roman Vasin](https://github.com/rvasin))。
- 非圧縮キャッシュとマークキャッシュに`SLRU`キャッシュポリシーを追加しました。([Kseniia Sumarokova](https://github.com/kssenii))。[#34651](https://github.com/ClickHouse/ClickHouse/pull/34651) ([alexX512](https://github.com/alexX512))。ローカルキャッシュ機能とキャッシュアルゴリズムの分離 [#38048](https://github.com/ClickHouse/ClickHouse/pull/38048) ([Han Shukai](https://github.com/KinderRiven))。
- Intel® In-Memory Analytics Accelerator（Intel® IAA）は、次世代Intel® Xeon® Scalableプロセッサ（「Sapphire Rapids」）で利用可能なハードウェアアクセラレータです。その目的は、データの圧縮・展開やフィルタリングなど、分析における一般的な操作を高速化することです。ClickHouseは、Intel® IAAオフロード技術を活用して高性能なDEFLATE実装を提供する新しい「DeflateQpl」圧縮コーデックを導入しました。このコーデックは、ハードウェアアクセラレータへのアクセスを抽象化する[Intel® Query Processing Library（QPL）](https://github.com/intel/qpl)を使用し、ハードウェアアクセラレータが利用できない場合はソフトウェアフォールバックに対応します。DEFLATEは一般的にClickHouseのデフォルトコーデックであるLZ4よりも高い圧縮率を提供し、その結果、ディスクI/Oの削減とメインメモリ消費量の低減を実現します。[#36654](https://github.com/ClickHouse/ClickHouse/pull/36654) ([jasperzhu](https://github.com/jinjunzh))。[#39494](https://github.com/ClickHouse/ClickHouse/pull/39494) ([Robert Schulze](https://github.com/rschu1ze))。
- `ORDER BY`を伴う順序付き`DISTINCT`：入力ストリームのソート記述に基づいてソート方法を推定します。入力ストリームが既にソート済みの場合はソートをスキップします。[#38719](https://github.com/ClickHouse/ClickHouse/pull/38719) ([Igor Nikonov](https://github.com/devcrafter))。メモリ使用量（大幅に）とクエリ実行時間を改善し、`DISTINCT`列が`ORDER BY`列と一致する場合に最終的なdistinct処理に`DistinctSortedChunkTransform`を使用しますが、`EXPLAIN PIPELINE`では`DistinctSortedStreamTransform`に名前を変更します → これによりメモリ使用量が大幅に改善され、`DistinctSortedChunkTransform`のホットループ内の不要な割り当てを削除します。[#39432](https://github.com/ClickHouse/ClickHouse/pull/39432) ([Igor Nikonov](https://github.com/devcrafter))。ソート記述がDISTINCT列に適用可能な場合のみ`DistinctSortedTransform`を使用し、それ以外の場合は通常のDISTINCT実装にフォールバックします + これにより`DistinctSortedTransform`実行中のチェック回数を削減できます。[#39528](https://github.com/ClickHouse/ClickHouse/pull/39528) ([Igor Nikonov](https://github.com/devcrafter))。修正：`DistinctSortedTransform`がソートを活用していませんでした。clearing_columnsが誤って検出されていた（常に空）ため、HashSetがクリアされませんでした。そのため、基本的に通常の`DISTINCT`（`DistinctTransform`）として動作していました。この修正によりメモリ使用量が大幅に削減されます。[#39538](https://github.com/ClickHouse/ClickHouse/pull/39538) ([Igor Nikonov](https://github.com/devcrafter))。
- `cluster`および類似のテーブル関数を実行する際に、リモートテーブルの構造を取得する際の最優先としてローカルノードを使用します。[#39440](https://github.com/ClickHouse/ClickHouse/pull/39440) ([Mingliang Pan](https://github.com/liangliangpan))。
- AVX512VBMI2圧縮ストアを使用した数値列によるフィルタリングを最適化しました。[#39633](https://github.com/ClickHouse/ClickHouse/pull/39633) ([Guo Wangyang](https://github.com/guowangy))。AVX512 VBMI2を搭載したシステムでは、このPRによりSSBベンチマーククエリ3.1、3.2、3.3（SF=100）のパフォーマンスが約6%向上します。Intel Icelake Xeon 8380 \* 2ソケットでテスト済みです。[#40033](https://github.com/ClickHouse/ClickHouse/pull/40033) ([Robert Schulze](https://github.com/rschu1ze))。
- マルチスレッドシナリオにおける関数式を使用したインデックス解析を最適化しました。[#39812](https://github.com/ClickHouse/ClickHouse/pull/39812) ([Guo Wangyang](https://github.com/guowangy))。
- 複雑なクエリの最適化：UDFが登録されていない場合はASTを訪問しません。[#40069](https://github.com/ClickHouse/ClickHouse/pull/40069) ([Raúl Marín](https://github.com/Algunenano))。CurrentMemoryTrackerの割り当てと解放を最適化しました。[#40078](https://github.com/ClickHouse/ClickHouse/pull/40078) ([Raúl Marín](https://github.com/Algunenano))。
- Base58エンコード/デコードを改善しました。[#39292](https://github.com/ClickHouse/ClickHouse/pull/39292) ([Andrey Zvonov](https://github.com/zvonand))。
- SSE/AVX/AVX512のバイトからビットマスクへの変換を改善しました。[#39586](https://github.com/ClickHouse/ClickHouse/pull/39586) ([Guo Wangyang](https://github.com/guowangy))。





#### 改善 {#improvement-4}

- `AggregateFunction`型と状態表現を正規化しました。[#35788](https://github.com/ClickHouse/ClickHouse/pull/35788)のような最適化により`count(not null columns)`が`count()`として扱われるため、分散インタープリターが次のエラーで混乱する可能性があります:`Conversion from AggregateFunction(count) to AggregateFunction(count, Int64) is not supported`。[#39420](https://github.com/ClickHouse/ClickHouse/pull/39420) ([Amos Bird](https://github.com/amosbird))。同一の状態を持つ関数は、マテリアライズドビューで相互に使用できます。
- `system.backups`テーブルを再設計し簡素化しました。`internal`カラムを削除し、ユーザーが操作のIDを設定できるようにし、`num_files`、`uncompressed_size`、`compressed_size`、`start_time`、`end_time`カラムを追加しました。[#39503](https://github.com/ClickHouse/ClickHouse/pull/39503) ([Vitaly Baranov](https://github.com/vitlibar))。
- `Replicated`データベースのDDLクエリ結果テーブルの構造を改善しました(シャードとレプリカ名を別カラムに分離し、ステータスをより明確に表示) - `distributed_ddl_entry_format_version`が3(デフォルト値)に設定されている場合、`CREATE TABLE ... ON CLUSTER`クエリはイニシエーターで最初に正規化できます。これは、イニシエーターがクエリで指定されたクラスターに属していない場合、`ON CLUSTER`クエリが機能しない可能性があることを意味します。[#37318](https://github.com/ClickHouse/ClickHouse/issues/37318)、[#39500](https://github.com/ClickHouse/ClickHouse/issues/39500)を修正 - データベースが`Replicated`でクラスター名がデータベース名と等しい場合、`ON CLUSTER`句を無視します。[#35570](https://github.com/ClickHouse/ClickHouse/issues/35570)に関連 - `Replicated`データベースエンジンのその他の軽微な修正 - `Replicated`データベースの起動時にメタデータの整合性をチェックし、ローカルメタデータとKeeper内のメタデータが一致しない場合にレプリカリカバリを開始します。[#24880](https://github.com/ClickHouse/ClickHouse/issues/24880)を解決。[#37198](https://github.com/ClickHouse/ClickHouse/pull/37198) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 進捗レポート(`X-ClickHouse-Summary`)にresult_rowsとresult_bytesを追加しました。[#39567](https://github.com/ClickHouse/ClickHouse/pull/39567) ([Raúl Marín](https://github.com/Algunenano))。
- MergeTreeのプライマリキー解析を改善しました。[#25563](https://github.com/ClickHouse/ClickHouse/pull/25563) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- `timeSlots`がDateTime64で動作するようになりました。DateTime64を使用する際に、サブ秒単位の期間とスロットサイズが利用可能です。[#37951](https://github.com/ClickHouse/ClickHouse/pull/37951) ([Andrey Zvonov](https://github.com/zvonand))。
- `EmbeddedRocksDB`テーブルとの`LEFT SEMI`および`LEFT ANTI`直接結合のサポートを追加しました。[#38956](https://github.com/ClickHouse/ClickHouse/pull/38956) ([Vladimir C](https://github.com/vdimir))。
- fsync操作のプロファイルイベントを追加しました。[#39179](https://github.com/ClickHouse/ClickHouse/pull/39179) ([Azat Khuzhin](https://github.com/azat))。
- 通常関数`file(path[, default])`に第2引数を追加しました。この引数は、ファイルが存在しない場合に関数が返す値です。[#39218](https://github.com/ClickHouse/ClickHouse/pull/39218) ([Nikolay Degterinsky](https://github.com/evillique))。
- HTTP経由での読み取りに関するいくつかの小さな修正を行い、200 OKの場合に部分的なコンテンツの再試行を許可しました。[#39244](https://github.com/ClickHouse/ClickHouse/pull/39244) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `CREATE TEMPORARY TABLE ... (<list of columns>) AS ...`クエリをサポートしました。[#39462](https://github.com/ClickHouse/ClickHouse/pull/39462) ([Kruglov Pavel](https://github.com/Avogar))。
- カスタムTLDで`!`/`*`(感嘆符/アスタリスク)のサポートを追加しました(`cutToFirstSignificantSubdomainCustom()`/`cutToFirstSignificantSubdomainCustomWithWWW()`/`firstSignificantSubdomainCustom()`)。[#39496](https://github.com/ClickHouse/ClickHouse/pull/39496) ([Azat Khuzhin](https://github.com/azat))。
- NATSへのTLS接続のサポートを追加しました。[#39525](https://github.com/ClickHouse/ClickHouse/issues/39525)を実装。[#39527](https://github.com/ClickHouse/ClickHouse/pull/39527) ([Constantine Peresypkin](https://github.com/pkit))。
- `clickhouse-obfuscator`(テストと負荷生成のためのデータベース難読化ツール)に、事前学習済みモデルを扱うための新しい`--save`および`--load`パラメータが追加されました。[#39534](https://github.com/ClickHouse/ClickHouse/issues/39534)を解決。[#39541](https://github.com/ClickHouse/ClickHouse/pull/39541) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 再起動時のログローテーションの不正な動作を修正しました。[#39558](https://github.com/ClickHouse/ClickHouse/pull/39558) ([Nikolay Degterinsky](https://github.com/evillique))。
- 外部集約が有効な場合の集約プロジェクションの構築を修正しました。このケースは稀であり、設定を変更することで簡単に回避できるため、改善としてマークされています。[#39667](https://github.com/ClickHouse/ClickHouse/issues/39667)を修正。[#39671](https://github.com/ClickHouse/ClickHouse/pull/39671) ([Amos Bird](https://github.com/amosbird))。
- `Map`型の引数でハッシュ関数を実行できるようにしました。[#39685](https://github.com/ClickHouse/ClickHouse/pull/39685) ([Anton Popov](https://github.com/CurtizJ))。
- スタックトレース内のアドレスを非表示にする設定パラメータを追加しました。セキュリティをわずかに向上させる可能性がありますが、一般的には有害であり、使用すべきではありません。[#39690](https://github.com/ClickHouse/ClickHouse/pull/39690) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- AggregateFunctionDistinctのプレフィックスサイズを変更し、ネストされた関数データのメモリセグメントが整列されるようにしました。[#39696](https://github.com/ClickHouse/ClickHouse/pull/39696) ([Pxl](https://github.com/BiteTheDDDDt))。
- `clickhouse-diagnostic`ツールに渡される認証情報を適切にエスケープするようにしました。[#39707](https://github.com/ClickHouse/ClickHouse/pull/39707) ([Dale McDiarmid](https://github.com/gingerwizard))。
- ClickHouse Keeperの改善:終了時にスナップショットを作成します。これは設定`keeper_server.create_snapshot_on_exit`で制御でき、デフォルトは`true`です。[#39755](https://github.com/ClickHouse/ClickHouse/pull/39755) ([Antonio Andelic](https://github.com/antonio2368))。
- `row_policy_filter`および`additional_filter`のプライマリキー解析をサポートしました。これにより、[#37454](https://github.com/ClickHouse/ClickHouse/issues/37454)のような問題の修正にも役立ちます。[#39826](https://github.com/ClickHouse/ClickHouse/pull/39826) ([Amos Bird](https://github.com/amosbird))。
- Play UIの2つのユーザビリティ問題を修正しました:- 不要なボーダー半径とマージンのため、iPadでピクセルパーフェクトではありませんでした;- 最初のクエリ後に進捗表示が表示されませんでした。[#39957](https://github.com/ClickHouse/ClickHouse/issues/39957)を解決。[#39960](https://github.com/ClickHouse/ClickHouse/issues/39960)を解決。[#39961](https://github.com/ClickHouse/ClickHouse/pull/39961) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- Play UI:行番号を追加;クリック時のセル選択を追加;テーブルセルのヒステリシスを追加しました。[#39962](https://github.com/ClickHouse/ClickHouse/pull/39962) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- Play UI:テキストエリアでTabキーを認識するようにしましたが、同時にタブナビゲーションを妨げないようにしました。[#40053](https://github.com/ClickHouse/ClickHouse/pull/40053) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- クライアントがサーバー側の経過時間を表示するようになりました。これは、リモートデータセンターのClickHouseサービスのパフォーマンス比較に重要です。[#38070](https://github.com/ClickHouse/ClickHouse/issues/38070)を解決。動機については[こちら](https://github.com/ClickHouse/ClickBench/blob/main/hardware/benchmark-cloud.sh#L37)も参照してください。[#39968](https://github.com/ClickHouse/ClickHouse/pull/39968) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `parseDateTime64BestEffortUS`、`parseDateTime64BestEffortUSOrNull`、`parseDateTime64BestEffortUSOrZero`関数を追加しました。[#37492](https://github.com/ClickHouse/ClickHouse/issues/37492)を解決。[#40015](https://github.com/ClickHouse/ClickHouse/pull/40015) ([Tanya Bragin](https://github.com/tbragin))。
- `system.processors_profile_log`を拡張し、入力行数などの追加情報を含めるようにしました。[#40121](https://github.com/ClickHouse/ClickHouse/pull/40121) ([Amos Bird](https://github.com/amosbird))。
- `clickhouse-benchmark`で、利用可能な場合(ClickHouseバージョン22.8以降)、デフォルトでサーバー側の時間を表示するようにしました。これは、クラウドのパフォーマンスを正確に比較するために必要です。この動作は、新しい`--client-side-time`コマンドラインオプションで変更できます。`--randomize`コマンドラインオプションを`--randomize 1`から引数なしの形式に変更しました。[#40193](https://github.com/ClickHouse/ClickHouse/pull/40193) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- クエリ複雑度制限が設定され、それに達した場合のカウンター(ProfileEvents)を追加しました(`overflow_mode` = `break`と`throw`の別々のカウンター)。たとえば、`read_overflow_mode = 'break'`で`max_rows_to_read`を設定している場合、`OverflowBreak`カウンターの値を見ることで、不完全な結果を区別できます。[#40205](https://github.com/ClickHouse/ClickHouse/pull/40205) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 「メモリ制限超過」エラーの場合のメモリ計上を修正しました(以前は[ピーク]メモリ使用量が失敗した割り当てを考慮していました)。[#40249](https://github.com/ClickHouse/ClickHouse/pull/40249) ([Azat Khuzhin](https://github.com/azat))。
- ファイルシステムキャッシュのメトリクスを追加しました:`FilesystemCacheSize`と`FilesystemCacheElements`。[#40260](https://github.com/ClickHouse/ClickHouse/pull/40260) ([Kseniia Sumarokova](https://github.com/kssenii))。
- Hadoopセキュアなデータ転送をサポートしました(hadoop.rpc.protection=privacyおよびhadoop.rpc.protection=integrity)。[#39411](https://github.com/ClickHouse/ClickHouse/pull/39411) ([michael1589](https://github.com/michael1589))。
- multi(Fuzzy)Match(Any|AllIndices|AnyIndex)()関数を使用する際のパターンキャッシュのメモリ消費が継続的に増加することを回避しました。[#40264](https://github.com/ClickHouse/ClickHouse/pull/40264) ([Robert Schulze](https://github.com/rschu1ze))。





#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-4}

- [ClickFiddle](https://fiddle.clickhouse.com/): 読み取り/書き込みモードでClickHouseバージョンをテストするための新しいツール (**Igor Baliuk**)。
- ClickHouseバイナリを自己解凍形式に変更 [#35775](https://github.com/ClickHouse/ClickHouse/pull/35775) ([Yakov Olkhovskiy, Arthur Filatenkov](https://github.com/yakov-olkhovskiy))。
- 新しいタイムゾーン変更に対応するため、tzdataを2022bに更新。https://github.com/google/cctz/pull/226 を参照。チリの2022年夏時間開始が9月4日から9月11日に延期。イランは2022年9月21日の切り替え後、夏時間の適用を恒久的に停止する予定。1977年のAsia/Tehranの歴史的タイムゾーンに修正あり: イランは1946年ではなく1935年に標準時を採用。1977年には03-21 23:00から10-20 24:00まで夏時間を適用; 1978年の切り替えは03-20と10-20ではなく03-24と08-05; 1979年春の切り替えは03-21ではなく05-27 (https://data.iana.org/time-zones/tzdb/NEWS)。([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 以前のパッケージはsystemd.serviceファイルを`/etc`にインストールしていた。そこにあるファイルは`conf`としてマークされ、クリーンアップされず、自動更新もされない。このPRでそれらをクリーンアップ。[#39323](https://github.com/ClickHouse/ClickHouse/pull/39323) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- LSanが有効に機能することを保証。[#39430](https://github.com/ClickHouse/ClickHouse/pull/39430) ([Azat Khuzhin](https://github.com/azat))。
- TSANはclang-14で問題がある (https://github.com/google/sanitizers/issues/1552, https://github.com/google/sanitizers/issues/1540) ため、ここではTSANバイナリをclang-15でビルド。[#39450](https://github.com/ClickHouse/ClickHouse/pull/39450) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- ClickHouseツールを個別の実行可能プログラムとしてビルドするオプションを削除。これにより[#37847](https://github.com/ClickHouse/ClickHouse/issues/37847)を修正。[#39520](https://github.com/ClickHouse/ClickHouse/pull/39520) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- s390x (ビッグエンディアン) でのビルドに向けた小規模な準備。[#39627](https://github.com/ClickHouse/ClickHouse/pull/39627) ([Harry Lee](https://github.com/HarryLeeIBM))。[#39656](https://github.com/ClickHouse/ClickHouse/pull/39656) ([Harry Lee](https://github.com/HarryLeeIBM))。s390x向けBitHelpersのエンディアン問題を修正。[#39656](https://github.com/ClickHouse/ClickHouse/pull/39656) ([Harry Lee](https://github.com/HarryLeeIBM))。s390xアーキテクチャ (ClickHouseではサポートされていない) 向けにSipHash関連のコードを実装。[#39732](https://github.com/ClickHouse/ClickHouse/pull/39732) ([Harry Lee](https://github.com/HarryLeeIBM))。s390xアーキテクチャ (ClickHouseではサポートされていない) 向けCoordinationスナップショットコードのエンディアン問題を修正。[#39931](https://github.com/ClickHouse/ClickHouse/pull/39931) ([Harry Lee](https://github.com/HarryLeeIBM))。s390xアーキテクチャ (ClickHouseではサポートされていない) 向けCodecコードのエンディアン問題を修正。[#40008](https://github.com/ClickHouse/ClickHouse/pull/40008) ([Harry Lee](https://github.com/HarryLeeIBM))。s390xアーキテクチャ (ClickHouseではサポートされていない) 向けReadHelpersおよびWriteHelpersコードにおけるビッグエンディアンバイナリデータの読み取り/書き込みのエンディアン問題を修正。[#40179](https://github.com/ClickHouse/ClickHouse/pull/40179) ([Harry Lee](https://github.com/HarryLeeIBM))。
- `clang-16` (trunk) でのビルドをサポート。これにより[#39949](https://github.com/ClickHouse/ClickHouse/issues/39949)をクローズ。[#40181](https://github.com/ClickHouse/ClickHouse/pull/40181) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- CIでRISC-V 64ビルドを実行できるよう準備。これは[#40141](https://github.com/ClickHouse/ClickHouse/issues/40141)のため。[#40197](https://github.com/ClickHouse/ClickHouse/pull/40197) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 関数登録マクロインターフェース (`FUNCTION_REGISTER*`) を簡素化し、registerFunctions.cppでextern関数を追加・呼び出すステップを排除。これにより新しい関数のインクリメンタルビルドも高速化。[#38615](https://github.com/ClickHouse/ClickHouse/pull/38615) ([Li Yin](https://github.com/liyinsg))。
- Docker: Dockerイメージのentrypoint.shが、マルチディスク設定の構成ファイルで見つかったすべてのフォルダに対してchownを作成・実行するように変更 [#17717](https://github.com/ClickHouse/ClickHouse/issues/17717)。[#39121](https://github.com/ClickHouse/ClickHouse/pull/39121) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。





#### バグ修正 {#bug-fix-1}

- Fix possible segfault in `CapnProto` input format. This bug was found and send through ClickHouse bug-bounty [program](https://github.com/ClickHouse/ClickHouse/issues/38986) by _kiojj_. [#40241](https://github.com/ClickHouse/ClickHouse/pull/40241) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix a very rare case of incorrect behavior of array subscript operator. This closes [#28720](https://github.com/ClickHouse/ClickHouse/issues/28720). [#40185](https://github.com/ClickHouse/ClickHouse/pull/40185) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix insufficient argument check for encryption functions (found by query fuzzer). This closes [#39987](https://github.com/ClickHouse/ClickHouse/issues/39987). [#40194](https://github.com/ClickHouse/ClickHouse/pull/40194) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix the case when the order of columns can be incorrect if the `IN` operator is used with a table with `ENGINE = Set` containing multiple columns. This fixes [#13014](https://github.com/ClickHouse/ClickHouse/issues/13014). [#40225](https://github.com/ClickHouse/ClickHouse/pull/40225) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix seeking while reading from encrypted disk. This PR fixes [#38381](https://github.com/ClickHouse/ClickHouse/issues/38381). [#39687](https://github.com/ClickHouse/ClickHouse/pull/39687) ([Vitaly Baranov](https://github.com/vitlibar)).
- Fix duplicate columns in join plan. Finally, solve [#26809](https://github.com/ClickHouse/ClickHouse/issues/26809). [#40009](https://github.com/ClickHouse/ClickHouse/pull/40009) ([Vladimir C](https://github.com/vdimir)).
- Fixed query hanging for SELECT with ORDER BY WITH FILL with different date/time types. [#37849](https://github.com/ClickHouse/ClickHouse/pull/37849) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix ORDER BY that matches projections ORDER BY (before it simply returns unsorted result). [#38725](https://github.com/ClickHouse/ClickHouse/pull/38725) ([Azat Khuzhin](https://github.com/azat)).
- Do not optimise functions in GROUP BY statements if they shadow one of the table columns or expressions. Fixes [#37032](https://github.com/ClickHouse/ClickHouse/issues/37032). [#39103](https://github.com/ClickHouse/ClickHouse/pull/39103) ([Anton Kozlov](https://github.com/tonickkozlov)).
- Fix wrong table name in logs after RENAME TABLE. This fixes [#38018](https://github.com/ClickHouse/ClickHouse/issues/38018). [#39227](https://github.com/ClickHouse/ClickHouse/pull/39227) ([Amos Bird](https://github.com/amosbird)).
- Fix positional arguments in case of columns pruning when optimising the query. Closes [#38433](https://github.com/ClickHouse/ClickHouse/issues/38433). [#39293](https://github.com/ClickHouse/ClickHouse/pull/39293) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix bug in schema inference in case of empty messages in Protobuf/CapnProto formats that allowed to create column with empty `Tuple` type. Closes [#39051](https://github.com/ClickHouse/ClickHouse/issues/39051) Add 2 new settings `input_format_{protobuf/capnproto}_skip_fields_with_unsupported_types_in_schema_inference` that allow to skip fields with unsupported types while schema inference for Protobuf and CapnProto formats. [#39357](https://github.com/ClickHouse/ClickHouse/pull/39357) ([Kruglov Pavel](https://github.com/Avogar)).
- (Window View is an experimental feature) Fix segmentation fault on `CREATE WINDOW VIEW .. ON CLUSTER ... INNER`. Closes [#39363](https://github.com/ClickHouse/ClickHouse/issues/39363). [#39384](https://github.com/ClickHouse/ClickHouse/pull/39384) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix WriteBuffer finalize when cancelling insert into function (in previous versions it may leat to std::terminate). [#39458](https://github.com/ClickHouse/ClickHouse/pull/39458) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix storing of columns of type `Object` in sparse serialization. [#39464](https://github.com/ClickHouse/ClickHouse/pull/39464) ([Anton Popov](https://github.com/CurtizJ)).
- Fix possible "Not found column in block" exception when using projections. This closes [#39469](https://github.com/ClickHouse/ClickHouse/issues/39469). [#39470](https://github.com/ClickHouse/ClickHouse/pull/39470) ([小路](https://github.com/nicelulu)).
- Fix exception on race between DROP and INSERT with materialized views. [#39477](https://github.com/ClickHouse/ClickHouse/pull/39477) ([Azat Khuzhin](https://github.com/azat)).
- A bug in Apache Avro library: fix data race and possible heap-buffer-overflow in Avro format. Closes [#39094](https://github.com/ClickHouse/ClickHouse/issues/39094) Closes [#33652](https://github.com/ClickHouse/ClickHouse/issues/33652). [#39498](https://github.com/ClickHouse/ClickHouse/pull/39498) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix rare bug in asynchronous reading (with setting `local_filesystem_read_method='pread_threadpool'`) with enabled `O_DIRECT` (enabled by setting `min_bytes_to_use_direct_io`). [#39506](https://github.com/ClickHouse/ClickHouse/pull/39506) ([Anton Popov](https://github.com/CurtizJ)).
- (only on FreeBSD) Fixes "Code: 49. DB::Exception: FunctionFactory: the function name '' is not unique. (LOGICAL_ERROR)" observed on FreeBSD when starting clickhouse. [#39551](https://github.com/ClickHouse/ClickHouse/pull/39551) ([Alexander Gololobov](https://github.com/davenger)).
- Fix bug with the recently introduced "maxsplit" argument for `splitByChar`, which was not working correctly. [#39552](https://github.com/ClickHouse/ClickHouse/pull/39552) ([filimonov](https://github.com/filimonov)).
- Fix bug in ASOF JOIN with `enable_optimize_predicate_expression`, close [#37813](https://github.com/ClickHouse/ClickHouse/issues/37813). [#39556](https://github.com/ClickHouse/ClickHouse/pull/39556) ([Vladimir C](https://github.com/vdimir)).
- Fixed `CREATE/DROP INDEX` query with `ON CLUSTER` or `Replicated` database and `ReplicatedMergeTree`. It used to be executed on all replicas (causing error or DDL queue stuck). Fixes [#39511](https://github.com/ClickHouse/ClickHouse/issues/39511). [#39565](https://github.com/ClickHouse/ClickHouse/pull/39565) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix "column not found" error for push down with join, close [#39505](https://github.com/ClickHouse/ClickHouse/issues/39505). [#39575](https://github.com/ClickHouse/ClickHouse/pull/39575) ([Vladimir C](https://github.com/vdimir)).
- Fix the wrong `REGEXP_REPLACE` alias. This fixes https://github.com/ClickHouse/ClickBench/issues/9. [#39592](https://github.com/ClickHouse/ClickHouse/pull/39592) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fixed point of origin for exponential decay window functions to the last value in window. Previously, decay was calculated by formula `exp((t - curr_row_t) / decay_length)`, which is incorrect when right boundary of window is not `CURRENT ROW`. It was changed to: `exp((t - last_row_t) / decay_length)`. There is no change in results for windows with `ROWS BETWEEN (smth) AND CURRENT ROW`. [#39593](https://github.com/ClickHouse/ClickHouse/pull/39593) ([Vladimir Chebotaryov](https://github.com/quickhouse)).
- Fix Decimal division overflow, which can be detected based on operands scale. [#39600](https://github.com/ClickHouse/ClickHouse/pull/39600) ([Andrey Zvonov](https://github.com/zvonand)).
- Fix settings `output_format_arrow_string_as_string` and `output_format_arrow_low_cardinality_as_dictionary` work in combination. Closes [#39624](https://github.com/ClickHouse/ClickHouse/issues/39624). [#39647](https://github.com/ClickHouse/ClickHouse/pull/39647) ([Kruglov Pavel](https://github.com/Avogar)).
- Fixed a bug in default database resolution in distributed table reads. [#39674](https://github.com/ClickHouse/ClickHouse/pull/39674) ([Anton Kozlov](https://github.com/tonickkozlov)).
- (Only with the obsolete Ordinary databases) Select might read data of dropped table if cache for mmap IO is used and database engine is Ordinary and new tables was created with the same name as dropped one had. It's fixed. [#39708](https://github.com/ClickHouse/ClickHouse/pull/39708) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix possible error `Invalid column type for ColumnUnique::insertRangeFrom. Expected String, got ColumnLowCardinality` Fixes [#38460](https://github.com/ClickHouse/ClickHouse/issues/38460). [#39716](https://github.com/ClickHouse/ClickHouse/pull/39716) ([Arthur Passos](https://github.com/arthurpassos)).
- Field names in the `meta` section of JSON format were erroneously double escaped. This closes [#39693](https://github.com/ClickHouse/ClickHouse/issues/39693). [#39747](https://github.com/ClickHouse/ClickHouse/pull/39747) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix wrong index analysis with tuples and operator `IN`, which could lead to wrong query result. [#39752](https://github.com/ClickHouse/ClickHouse/pull/39752) ([Anton Popov](https://github.com/CurtizJ)).
- Fix `EmbeddedRocksDB` tables filtering by key using params. [#39757](https://github.com/ClickHouse/ClickHouse/pull/39757) ([Antonio Andelic](https://github.com/antonio2368)).
- Fix error `Invalid number of columns in chunk pushed to OutputPort` which was caused by ARRAY JOIN optimization. Fixes [#39164](https://github.com/ClickHouse/ClickHouse/issues/39164). [#39799](https://github.com/ClickHouse/ClickHouse/pull/39799) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- A workaround for a bug in Linux kernel. Fix `CANNOT_READ_ALL_DATA` exception with `local_filesystem_read_method=pread_threadpool`. This bug affected only Linux kernel version 5.9 and 5.10 according to [man](https://manpages.debian.org/testing/manpages-dev/preadv2.2.en.html#BUGS). [#39800](https://github.com/ClickHouse/ClickHouse/pull/39800) ([Anton Popov](https://github.com/CurtizJ)).
- (Only on NFS) Fix broken NFS mkdir for root-squashed volumes. [#39898](https://github.com/ClickHouse/ClickHouse/pull/39898) ([Constantine Peresypkin](https://github.com/pkit)).
- Remove dictionaries from prometheus metrics on DETACH/DROP. [#39926](https://github.com/ClickHouse/ClickHouse/pull/39926) ([Azat Khuzhin](https://github.com/azat)).
- Fix read of StorageFile with virtual columns. Closes [#39907](https://github.com/ClickHouse/ClickHouse/issues/39907). [#39943](https://github.com/ClickHouse/ClickHouse/pull/39943) ([flynn](https://github.com/ucasfl)).
- Fix big memory usage during fetches. Fixes [#39915](https://github.com/ClickHouse/ClickHouse/issues/39915). [#39990](https://github.com/ClickHouse/ClickHouse/pull/39990) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- (experimental feature) Fix `hashId` crash and salt parameter not being used. [#40002](https://github.com/ClickHouse/ClickHouse/pull/40002) ([Raúl Marín](https://github.com/Algunenano)).
- `EXCEPT` and `INTERSECT` operators may lead to crash if a specific combination of constant and non-constant columns were used. [#40020](https://github.com/ClickHouse/ClickHouse/pull/40020) ([Duc Canh Le](https://github.com/canhld94)).
- Fixed "Part directory doesn't exist" and "`tmp_<part_name>` ... No such file or directory" errors during too slow INSERT or too long merge/mutation. Also fixed issue that may cause some replication queue entries to stuck without any errors or warnings in logs if previous attempt to fetch part failed, but `tmp-fetch_<part_name>` directory was not cleaned up. [#40031](https://github.com/ClickHouse/ClickHouse/pull/40031) ([Alexander Tokmakov](https://github.com/tavplubix)).
- Fix rare cases of parsing of arrays of tuples in format `Values`. [#40034](https://github.com/ClickHouse/ClickHouse/pull/40034) ([Anton Popov](https://github.com/CurtizJ)).
- Fixes ArrowColumn format Dictionary(X) & Dictionary(Nullable(X)) conversion to ClickHouse LowCardinality(X) & LowCardinality(Nullable(X)) respectively. [#40037](https://github.com/ClickHouse/ClickHouse/pull/40037) ([Arthur Passos](https://github.com/arthurpassos)).
- Fix potential deadlock in writing to S3 during task scheduling failure. [#40070](https://github.com/ClickHouse/ClickHouse/pull/40070) ([Maksim Kita](https://github.com/kitaisreal)).
- Fix bug in collectFilesToSkip() by adding correct file extension (.idx or idx2) for indexes to be recalculated, avoid wrong hard links. Fixed [#39896](https://github.com/ClickHouse/ClickHouse/issues/39896). [#40095](https://github.com/ClickHouse/ClickHouse/pull/40095) ([Jianmei Zhang](https://github.com/zhangjmruc)).
- A fix for reverse DNS resolution. [#40134](https://github.com/ClickHouse/ClickHouse/pull/40134) ([Arthur Passos](https://github.com/arthurpassos)).
- Fix unexpected result `arrayDifference` of `Array(UInt32). [#40211](https://github.com/ClickHouse/ClickHouse/pull/40211) ([Duc Canh Le](https://github.com/canhld94)).

### <a id="227"></a> ClickHouseリリース22.7、2022-07-21 {#a-id227a-clickhouse-release-227-2022-07-21}

#### アップグレード時の注意事項 {#upgrade-notes-1}

- 設定`enable_positional_arguments`をデフォルトで有効化しました。これにより、`SELECT ... ORDER BY 1, 2`のようなクエリが可能になります。ここで1、2はSELECT句への参照です。以前の動作に戻す必要がある場合は、この設定を無効にしてください。[#38204](https://github.com/ClickHouse/ClickHouse/pull/38204) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `format_csv_allow_single_quotes`をデフォルトで無効化しました。[#37096](https://github.com/ClickHouse/ClickHouse/issues/37096)を参照してください。([Kruglov Pavel](https://github.com/Avogar))。
- `Ordinary`データベースエンジンと`*MergeTree`テーブルの古いストレージ定義構文は非推奨となりました。デフォルトでは、`Ordinary`エンジンで新しいデータベースを作成することはできません。`system`データベースが`Ordinary`エンジンを使用している場合、サーバー起動時に自動的に`Atomic`に変換されます。古い動作を維持するための設定(`allow_deprecated_database_ordinary`および`allow_deprecated_syntax_for_merge_tree`)がありますが、これらの設定は将来のリリースで削除される可能性があります。[#38335](https://github.com/ClickHouse/ClickHouse/pull/38335) ([Alexander Tokmakov](https://github.com/tavplubix))。
- カンマ結合をINNER結合に書き換えることをデフォルトで強制します(デフォルト値を`cross_to_inner_join_rewrite = 2`に設定)。以前の動作にするには、`cross_to_inner_join_rewrite = 1`を設定してください。[#39326](https://github.com/ClickHouse/ClickHouse/pull/39326) ([Vladimir C](https://github.com/vdimir))。互換性の問題が発生した場合は、この設定を元に戻すことができます。


#### 新機能 {#new-feature-5}

- ウィンドウ関数を使用した式をサポート。[#19857](https://github.com/ClickHouse/ClickHouse/issues/19857) をクローズ。[#37848](https://github.com/ClickHouse/ClickHouse/pull/37848) ([Dmitry Novik](https://github.com/novikd))。
- `EmbeddedRocksDB` テーブル用の新しい `direct` 結合アルゴリズムを追加。[#33582](https://github.com/ClickHouse/ClickHouse/issues/33582) を参照。[#35363](https://github.com/ClickHouse/ClickHouse/pull/35363) ([Vladimir C](https://github.com/vdimir))。
- 完全ソートマージ結合アルゴリズムを追加。[#35796](https://github.com/ClickHouse/ClickHouse/pull/35796) ([Vladimir C](https://github.com/vdimir))。
- NATS へのパブリッシュ/サブスクライブを可能にする NATS テーブルエンジンを実装。[#32388](https://github.com/ClickHouse/ClickHouse/issues/32388) をクローズ。[#37171](https://github.com/ClickHouse/ClickHouse/pull/37171) ([tchepavel](https://github.com/tchepavel))。([Kseniia Sumarokova](https://github.com/kssenii))
- テーブル関数 `mongodb` を実装。`MongoDB` ストレージ/テーブル関数への書き込みを許可。[#37213](https://github.com/ClickHouse/ClickHouse/pull/37213) ([aaapetrenko](https://github.com/aaapetrenko))。([Kseniia Sumarokova](https://github.com/kssenii))
- `SQLInsert` 出力フォーマットを追加。[#38441](https://github.com/ClickHouse/ClickHouse/issues/38441) をクローズ。[#38477](https://github.com/ClickHouse/ClickHouse/pull/38477) ([Kruglov Pavel](https://github.com/Avogar))。
- 設定 `additional_table_filters` を導入。この設定を使用すると、読み取り直後に適用されるテーブルの追加フィルタリング条件を指定できます。例: `select number, x, y from (select number from system.numbers limit 5) f any left join (select x, y from table_1) s on f.number = s.x settings additional_table_filters={'system.numbers : 'number != 3', 'table_1' : 'x != 2'}`。クエリ結果の追加フィルタリング条件を指定する設定 `additional_result_filter` を導入。[#37918](https://github.com/ClickHouse/ClickHouse/issues/37918) をクローズ。[#38475](https://github.com/ClickHouse/ClickHouse/pull/38475) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- `compatibility` 設定と、ClickHouse バージョン間での設定変更に関する情報を含むシステムテーブル `system.settings_changes` を追加。[#35972](https://github.com/ClickHouse/ClickHouse/issues/35972) をクローズ。[#38957](https://github.com/ClickHouse/ClickHouse/pull/38957) ([Kruglov Pavel](https://github.com/Avogar))。
- 関数 `translate(string, from_string, to_string)` および `translateUTF8(string, from_string, to_string)` を追加。特定の文字を別の文字に変換します。[#38935](https://github.com/ClickHouse/ClickHouse/pull/38935) ([Nikolay Degterinsky](https://github.com/evillique))。
- `parseTimeDelta` 関数をサポート。` ;-+,:` を区切り文字として使用できます。例: `1yr-2mo`、`2m:6s`: `SELECT parseTimeDelta('1yr-2mo-4w + 12 days, 3 hours : 1 minute ; 33 seconds')`。[#39071](https://github.com/ClickHouse/ClickHouse/pull/39071) ([jiahui-97](https://github.com/jiahui-97))。
- `CREATE TABLE ... EMPTY AS SELECT` クエリを追加。SELECT クエリからテーブル構造を自動的に推測しますが、作成後にテーブルにデータを投入しません。[#38049](https://github.com/ClickHouse/ClickHouse/issues/38049) を解決。[#38272](https://github.com/ClickHouse/ClickHouse/pull/38272) ([Alexander Tokmakov](https://github.com/tavplubix))。
- リモートストレージとの IO 操作を制限するオプションを追加: `max_remote_read_network_bandwidth_for_server` および `max_remote_write_network_bandwidth_for_server`。[#39095](https://github.com/ClickHouse/ClickHouse/pull/39095) ([Sergei Trifonov](https://github.com/serxa))。
- ROLLUP、CUBE、GROUPING SETS の場合に集約キー列を NULL 許容にする `group_by_use_nulls` 設定を追加。[#37359](https://github.com/ClickHouse/ClickHouse/issues/37359) をクローズ。[#38642](https://github.com/ClickHouse/ClickHouse/pull/38642) ([Dmitry Novik](https://github.com/novikd))。
- データエクスポート時に圧縮レベルを指定する機能を追加。[#38907](https://github.com/ClickHouse/ClickHouse/pull/38907) ([Nikolay Degterinsky](https://github.com/evillique))。
- `system` データベースからの SELECT に明示的な権限付与を要求するオプションを追加。詳細: [#38970](https://github.com/ClickHouse/ClickHouse/pull/38970) ([Vitaly Baranov](https://github.com/vitlibar))。
- 関数 `multiMatchAny`、`multiMatchAnyIndex`、`multiMatchAllIndices` およびそれらのファジーバリアントが、非定数パターン配列引数を受け入れるようになりました。[#38485](https://github.com/ClickHouse/ClickHouse/pull/38485) ([Robert Schulze](https://github.com/rschu1ze))。SQL 関数 `multiSearchAllPositions` が非定数 needle 引数を受け入れるようになりました。[#39167](https://github.com/ClickHouse/ClickHouse/pull/39167) ([Robert Schulze](https://github.com/rschu1ze))。
- 外部ファイルのインポート時に zstd デコードの最大メモリ使用量を設定する設定 `zstd_window_log_max` を追加。[#35693](https://github.com/ClickHouse/ClickHouse/issues/35693) をクローズ。[#37015](https://github.com/ClickHouse/ClickHouse/pull/37015) ([wuxiaobai24](https://github.com/wuxiaobai24))。
- `send_logs_source_regexp` 設定を追加。ログソース名に一致する指定された正規表現でサーバーテキストログを送信します。空の場合はすべてのソースを意味します。[#39161](https://github.com/ClickHouse/ClickHouse/pull/39161) ([Amos Bird](https://github.com/amosbird))。
- `Hive` テーブルの `ALTER` をサポート。[#38214](https://github.com/ClickHouse/ClickHouse/pull/38214) ([lgbo](https://github.com/lgbo-ustc))。
- `isNullable` 関数をサポート。この関数は引数が NULL 許容かどうかをチェックし、1 または 0 を返します。[#38611](https://github.com/ClickHouse/ClickHouse/issues/38611) をクローズ。[#38841](https://github.com/ClickHouse/ClickHouse/pull/38841) ([lokax](https://github.com/lokax))。
- base58 エンコード/デコード用の関数を追加。[#38159](https://github.com/ClickHouse/ClickHouse/pull/38159) ([Andrey Zvonov](https://github.com/zvonand))。
- Play UI にチャート可視化を追加。[#38197](https://github.com/ClickHouse/ClickHouse/pull/38197) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 配列とタプルの両方に対する L2 二乗距離およびノルム関数を追加。[#38545](https://github.com/ClickHouse/ClickHouse/pull/38545) ([Julian Gilyadov](https://github.com/israelg99))。
- SQL 経由で `url` テーブル関数/ストレージに HTTP ヘッダーを渡す機能を追加。[#37897](https://github.com/ClickHouse/ClickHouse/issues/37897) をクローズ。[#38176](https://github.com/ClickHouse/ClickHouse/pull/38176) ([Kseniia Sumarokova](https://github.com/kssenii))。
- パッケージに `clickhouse-diagnostics` バイナリを追加。[#38647](https://github.com/ClickHouse/ClickHouse/pull/38647) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。

#### 実験的機能 {#experimental-feature-4}

- スタンドアロンクエリをトランザクション内で実行するための新しい設定 `implicit_transaction` を追加しました。トランザクションの作成と終了（クエリが成功した場合は COMMIT、失敗した場合は ROLLBACK）を自動的に処理します。[#38344](https://github.com/ClickHouse/ClickHouse/pull/38344) ([Raúl Marín](https://github.com/Algunenano))。


#### パフォーマンス改善 {#performance-improvement-5}

- ソート済みカラムに対するDISTINCT最適化。入力ストリームがDISTINCT対象のカラムでソートされている場合、特殊化されたDISTINCT変換を使用します。最適化はpre-distinct、final distinct、またはその両方に適用可能です。初期実装は@dimarub2000によるものです。[#37803](https://github.com/ClickHouse/ClickHouse/pull/37803) ([Igor Nikonov](https://github.com/devcrafter))。
- `BinaryHeap`のバッチ版を使用して、`ORDER BY`、`MergeTree`マージ、ウィンドウ関数のパフォーマンスを改善しました。[#38022](https://github.com/ClickHouse/ClickHouse/pull/38022) ([Maksim Kita](https://github.com/kitaisreal))。
- `FINAL`を使用するクエリの並列実行を強化しました。[#36396](https://github.com/ClickHouse/ClickHouse/pull/36396) ([Nikita Taranov](https://github.com/nickitat))。
- [#35616](https://github.com/ClickHouse/ClickHouse/pull/35616)で導入された重大なJOINパフォーマンス低下を修正しました。興味深いことに、SSBクエリのような一般的なJOINクエリが約3ヶ月間10倍遅くなっていたにもかかわらず、誰も報告しませんでした。[#38052](https://github.com/ClickHouse/ClickHouse/pull/38052) ([Amos Bird](https://github.com/amosbird))。
- Intel hyperscanライブラリからvectorscanに移行し、非x86プラットフォームでの多くの文字列マッチングを高速化しました。[#38171](https://github.com/ClickHouse/ClickHouse/pull/38171) ([Robert Schulze](https://github.com/rschu1ze))。
- 集約後に実行されるクエリプランステップの並列性を向上させました。[#38295](https://github.com/ClickHouse/ClickHouse/pull/38295) ([Nikita Taranov](https://github.com/nickitat))。
- `JSON`型カラムへの挿入パフォーマンスを改善しました。[#38320](https://github.com/ClickHouse/ClickHouse/pull/38320) ([Anton Popov](https://github.com/CurtizJ))。
- HashTableでの挿入と検索を最適化しました。[#38413](https://github.com/ClickHouse/ClickHouse/pull/38413) ([Nikita Taranov](https://github.com/nickitat))。
- [#32493](https://github.com/ClickHouse/ClickHouse/issues/32493)によるパフォーマンス低下を修正しました。[#38417](https://github.com/ClickHouse/ClickHouse/pull/38417) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- SIMD命令を使用した数値カラムとのJOINパフォーマンスを改善しました。[#37235](https://github.com/ClickHouse/ClickHouse/pull/37235) ([zzachimed](https://github.com/zzachimed))。[#38565](https://github.com/ClickHouse/ClickHouse/pull/38565) ([Maksim Kita](https://github.com/kitaisreal))。
- 配列に対するNorm関数とDistance関数が1.2〜2倍高速化されました。[#38740](https://github.com/ClickHouse/ClickHouse/pull/38740) ([Alexander Gololobov](https://github.com/davenger))。
- LZ4解凍用にAVX-512 VBMI最適化された`copyOverlap32Shuffle`を追加しました。つまり、LZ4解凍パフォーマンスが改善されました。[#37891](https://github.com/ClickHouse/ClickHouse/pull/37891) ([Guo Wangyang](https://github.com/guowangy))。
- `ORDER BY (a, b)`は`ORDER BY a, b`と同じすべての利点を使用するようになりました。[#38873](https://github.com/ClickHouse/ClickHouse/pull/38873) ([Igor Nikonov](https://github.com/devcrafter))。
- ベンチマークをより安定させるために、分岐を32Bバウンダリ内に整列させました。[#38988](https://github.com/ClickHouse/ClickHouse/pull/38988) ([Guo Wangyang](https://github.com/guowangy))。これによりIntelで平均1〜2%のパフォーマンス向上が得られます。
- 実行可能UDF、実行可能ディクショナリ、およびExecutableテーブルは、サブプロセスの終了待機中に1秒を無駄にすることを回避するようになりました。[#38929](https://github.com/ClickHouse/ClickHouse/pull/38929) ([Constantine Peresypkin](https://github.com/pkit))。
- すべてのカラムが選択されていない場合、`system.stack_trace`テーブルへのアクセスを最適化しました。[#39177](https://github.com/ClickHouse/ClickHouse/pull/39177) ([Azat Khuzhin](https://github.com/azat))。
- LowCardinality引数に対するisNullable/isConstant/isNull/isNotNullのパフォーマンスを改善しました。[#39192](https://github.com/ClickHouse/ClickHouse/pull/39192) ([Kruglov Pavel](https://github.com/Avogar))。
- ウィンドウ関数におけるORDER BYの処理を最適化しました。[#34632](https://github.com/ClickHouse/ClickHouse/pull/34632) ([Vladimir Chebotarev](https://github.com/excitoon))。
- `system.asynchronous_metric_log`テーブルのストレージスペースをさらに最適化しました。これにより[#38134](https://github.com/ClickHouse/ClickHouse/issues/38134)がクローズされます。[YouTubeビデオ](https://www.youtube.com/watch?v=0fSp9SF8N8A)を参照してください。[#38428](https://github.com/ClickHouse/ClickHouse/pull/38428) ([Alexey Milovidov](https://github.com/alexey-milovidov))。





#### 改善 {#improvement-5}

- SQL標準のCREATE INDEXおよびDROP INDEX構文をサポート。[#35166](https://github.com/ClickHouse/ClickHouse/pull/35166) ([Jianmei Zhang](https://github.com/zhangjmruc))。
- INSERTクエリのプロファイルイベントを送信(以前はSELECTのみサポート)。[#37391](https://github.com/ClickHouse/ClickHouse/pull/37391) ([Azat Khuzhin](https://github.com/azat))。
- 完全にマテリアライズされたプロジェクションに対する順序付き集約(`optimize_aggregation_in_order`)を実装。[#37469](https://github.com/ClickHouse/ClickHouse/pull/37469) ([Azat Khuzhin](https://github.com/azat))。
- Kerberos初期化のサブプロセス実行を削除。新しい統合テストを追加。解決: [#27651](https://github.com/ClickHouse/ClickHouse/issues/27651)。[#38105](https://github.com/ClickHouse/ClickHouse/pull/38105) ([Roman Vasin](https://github.com/rvasin))。
- - 複数のJOIN書き換え時に識別子名を書き換えないための設定`multiple_joins_try_to_keep_original_names`を追加。解決: [#34697](https://github.com/ClickHouse/ClickHouse/issues/34697)。[#38149](https://github.com/ClickHouse/ClickHouse/pull/38149) ([Vladimir C](https://github.com/vdimir))。
- トレースビジュアライザーのUXを改善。[#38169](https://github.com/ClickHouse/ClickHouse/pull/38169) ([Sergei Trifonov](https://github.com/serxa))。
- AArch64向けにスタックトレース収集とクエリプロファイラーを有効化。[#38181](https://github.com/ClickHouse/ClickHouse/pull/38181) ([Maksim Kita](https://github.com/kitaisreal))。
- SQLユーザー定義関数の読み込み時に`user_defined`ディレクトリ内のシンボリックリンクをスキップしないように変更。解決: [#38042](https://github.com/ClickHouse/ClickHouse/issues/38042)。[#38184](https://github.com/ClickHouse/ClickHouse/pull/38184) ([Maksim Kita](https://github.com/kitaisreal))。
- `store/`内のサブディレクトリのバックグラウンドクリーンアップを追加。一部のケースでclickhouse-serverが`store/`内にガベージサブディレクトリを残すことがあり(例: テーブル作成失敗時)、これらのディレクトリは削除されませんでした。修正: [#33710](https://github.com/ClickHouse/ClickHouse/issues/33710)。[#38265](https://github.com/ClickHouse/ClickHouse/pull/38265) ([Alexander Tokmakov](https://github.com/tavplubix))。
- 設定からキャッシュ設定を表示する`DESCRIBE CACHE`クエリを追加。利用可能なファイルシステムキャッシュのリストを表示する`SHOW CACHES`クエリを追加。[#38279](https://github.com/ClickHouse/ClickHouse/pull/38279) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `system drop filesystem cache`のアクセスチェックを追加。ON CLUSTERをサポート。[#38319](https://github.com/ClickHouse/ClickHouse/pull/38319) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 21.3から22.3へのアップグレード時のPostgreSQLデータベースエンジンの非互換性を修正。解決: [#36659](https://github.com/ClickHouse/ClickHouse/issues/36659)。[#38369](https://github.com/ClickHouse/ClickHouse/pull/38369) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `filesystemAvailable`および類似の関数が`clickhouse-local`で動作するようになりました。解決: [#38423](https://github.com/ClickHouse/ClickHouse/issues/38423)。[#38424](https://github.com/ClickHouse/ClickHouse/pull/38424) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `revision`関数を追加。[#38555](https://github.com/ClickHouse/ClickHouse/pull/38555) ([Azat Khuzhin](https://github.com/azat))。
- プロキシトンネル経由のGCS使用を修正。[#38726](https://github.com/ClickHouse/ClickHouse/pull/38726) ([Azat Khuzhin](https://github.com/azat))。
- clickhouseクライアント/ローカルで`\i file`をサポート(psqlの\iと同様)。[#38813](https://github.com/ClickHouse/ClickHouse/pull/38813) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `EXPLAIN AST`に新しいオプション`optimize = 1`を追加。有効にすると書き換え後のASTを表示し、無効の場合は元のクエリのASTを表示。デフォルトでは無効。[#38910](https://github.com/ClickHouse/ClickHouse/pull/38910) ([Igor Nikonov](https://github.com/devcrafter))。
- カラムリストの末尾のカンマを許可。解決: [#38425](https://github.com/ClickHouse/ClickHouse/issues/38425)。[#38440](https://github.com/ClickHouse/ClickHouse/pull/38440) ([chen](https://github.com/xiedeyantu))。
- `parallel_hash` JOINメソッドのバグ修正とパフォーマンス改善。[#37648](https://github.com/ClickHouse/ClickHouse/pull/37648) ([Vladimir C](https://github.com/vdimir))。
- HadoopセキュアRPC転送をサポート(hadoop.rpc.protection=privacyおよびhadoop.rpc.protection=integrity)。[#37852](https://github.com/ClickHouse/ClickHouse/pull/37852) ([Peng Liu](https://github.com/michael1589))。
- `StorageHive`に構造体型のサポートを追加。[#38118](https://github.com/ClickHouse/ClickHouse/pull/38118) ([lgbo](https://github.com/lgbo-ustc))。
- S3の単一オブジェクトは`RemoveObjectRequest`で削除されるようになりました。`removeFileIfExists`の使用を許可せず、`remove`機能の約半分を事実上破壊していたGCPとの互換性を実装。GCSでサポートされていない`DeleteObjects` S3 APIの自動検出。これにより、設定で明示的に`support_batch_delete=0`を指定せずにGCSを使用できるようになります。[#37882](https://github.com/ClickHouse/ClickHouse/pull/37882) ([Vladimir Chebotarev](https://github.com/excitoon))。
- ClickHouse Keeper関連の基本的な監視データを公開(ProfileEventsおよびCurrentMetrics経由)。[#38072](https://github.com/ClickHouse/ClickHouse/pull/38072) ([lingpeng0314](https://github.com/lingpeng0314))。
- PostgreSQLエンジン接続の`auto_close`オプションをサポート。解決: [#31486](https://github.com/ClickHouse/ClickHouse/issues/31486)。[#38363](https://github.com/ClickHouse/ClickHouse/pull/38363) ([Kseniia Sumarokova](https://github.com/kssenii))。
- テーブル関数のカラム宣言で`NULL`修飾子を許可。[#38816](https://github.com/ClickHouse/ClickHouse/pull/38816) ([Kruglov Pavel](https://github.com/Avogar))。
- シャットダウン時の無害な`TABLE_IS_READ_ONLY`エラーを回避するため、シャットダウン前に`mutations_finalizing_task`を無効化。[#38851](https://github.com/ClickHouse/ClickHouse/pull/38851) ([Raúl Marín](https://github.com/Algunenano))。
- 非推奨のOrdinaryデータベースを使用している場合、INSERTクエリが存在する状況でのALTERクエリ後のSELECTクエリの不要な待機を排除。[#38864](https://github.com/ClickHouse/ClickHouse/pull/38864) ([Azat Khuzhin](https://github.com/azat))。
- `EXPLAIN AST`に新しいオプション`rewrite`を追加。有効にすると書き換え後のASTを表示し、無効の場合は元のクエリのASTを表示。デフォルトでは無効。[#38910](https://github.com/ClickHouse/ClickHouse/pull/38910) ([Igor Nikonov](https://github.com/devcrafter))。
- 予期されるZookeeperの「ノードが存在する」例外をsystem.errorsに報告しないように変更。[#38961](https://github.com/ClickHouse/ClickHouse/pull/38961) ([Raúl Marín](https://github.com/Algunenano))。
- `clickhouse-keeper`: リアルタイムダイジェスト計算と検証のサポートを追加。デフォルトでは無効。[#37555](https://github.com/ClickHouse/ClickHouse/pull/37555) ([Antonio Andelic](https://github.com/antonio2368))。
- `clickhouse-extract-from-config`ツールのキー内でグロブ`* or {expr1, expr2, expr3}`を指定できるように変更。[#38966](https://github.com/ClickHouse/ClickHouse/pull/38966) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- clearOldLogs: 同時削除時にKEEPER_EXCEPTIONを報告しないように変更。[#39016](https://github.com/ClickHouse/ClickHouse/pull/39016) ([Raúl Marín](https://github.com/Algunenano))。
- clickhouse-keeperの改善: keeperサーバーに関するメタ情報をディスクに永続化。[#39069](https://github.com/ClickHouse/ClickHouse/pull/39069) ([Antonio Andelic](https://github.com/antonio2368))。これにより、すべてのkeeperノードを同時にシャットダウンまたは再起動する場合の運用が容易になります。
- ファイルシステムキャッシュ使用時にディスク容量が不足した場合、例外を発生させずに継続。[#39106](https://github.com/ClickHouse/ClickHouse/pull/39106) ([Kseniia Sumarokova](https://github.com/kssenii))。
- k8sからのSIGTERMシグナルの処理。[#39130](https://github.com/ClickHouse/ClickHouse/pull/39130) ([Timur Solodovnikov](https://github.com/tsolodov))。
- system.part_logに`merge_algorithm`カラム(Undecided、Horizontal、Vertical)を追加。[#39181](https://github.com/ClickHouse/ClickHouse/pull/39181) ([Azat Khuzhin](https://github.com/azat))。
- ディスクが回転式でない場合、`system.errors`のカウンターを増加させないように変更。[#39216](https://github.com/ClickHouse/ClickHouse/pull/39216) ([Raúl Marín](https://github.com/Algunenano))。
- `system.query_log`の`INSERT`クエリに対する`result_bytes`メトリックは、挿入されたバイト数を表示します。以前は値が不正確で、`result_rows`と同じ値が格納されていました。[#39225](https://github.com/ClickHouse/ClickHouse/pull/39225) ([Ilya Yatsishin](https://github.com/qoega))。
- clickhouse-clientのCPU使用率メトリックがより適切に表示されるようになります。修正: [#38756](https://github.com/ClickHouse/ClickHouse/issues/38756)。[#39280](https://github.com/ClickHouse/ClickHouse/pull/39280) ([Sergei Trifonov](https://github.com/serxa))。
- サーバー起動時のファイルシステムキャッシュ初期化で例外を再スローし、エラーメッセージを改善。[#39386](https://github.com/ClickHouse/ClickHouse/pull/39386) ([Kseniia Sumarokova](https://github.com/kssenii))。
- OpenTelemetryはデフォルトでProcessorsスパンなしでトレースを収集するようになりました(数が多すぎるため)。Processorsスパンの収集を有効にするには`opentelemetry_trace_processors`設定を使用します。[#39170](https://github.com/ClickHouse/ClickHouse/pull/39170) ([Ilya Yatsishin](https://github.com/qoega))。
- 関数`multiMatch[Fuzzy](AllIndices/Any/AnyIndex)` - needle引数が空の場合に論理エラーをスローしないように変更。[#39012](https://github.com/ClickHouse/ClickHouse/pull/39012) ([Robert Schulze](https://github.com/rschu1ze))。
- デフォルト引数`x-max-length`および`x-overflow`なしで`RabbitMQ`キューを宣言できるように変更。[#39259](https://github.com/ClickHouse/ClickHouse/pull/39259) ([rnbondarenko](https://github.com/rnbondarenko))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-5}

- ClickHouseにClang Thread Safety Analysis (TSA)アノテーションを適用しました。[#38068](https://github.com/ClickHouse/ClickHouse/pull/38068) ([Robert Schulze](https://github.com/rschu1ze))。
- FreeBSD用のユニバーサルインストールスクリプトを対応させました。[#39302](https://github.com/ClickHouse/ClickHouse/pull/39302) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `s390x`プラットフォームでのビルドに向けた準備を行いました。[#39193](https://github.com/ClickHouse/ClickHouse/pull/39193) ([Harry Lee](https://github.com/HarryLeeIBM))。
- `jemalloc`ライブラリのバグを修正しました。[#38757](https://github.com/ClickHouse/ClickHouse/pull/38757) ([Azat Khuzhin](https://github.com/azat))。
- ハードウェアベンチマークが結果の自動アップロードに対応しました。[#38427](https://github.com/ClickHouse/ClickHouse/pull/38427) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- システムテーブル「system.licenses」がMac (Darwin)で正しく生成されるようになりました。[#38294](https://github.com/ClickHouse/ClickHouse/pull/38294) ([Robert Schulze](https://github.com/rschu1ze))。
- `all|noarch`パッケージをアーキテクチャ依存に変更 - 関連ドキュメントを修正 - aarch64|arm64パッケージをartifactoryとリリースアセットにプッシュ - 修正対象: [#36443](https://github.com/ClickHouse/ClickHouse/issues/36443)。[#38580](https://github.com/ClickHouse/ClickHouse/pull/38580) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。


#### バグ修正（公式安定版またはプレ安定版リリースにおけるユーザーに影響する不具合） {#bug-fix-user-visible-misbehavior-in-official-stable-or-prestable-release-3}

- Fix rounding for `Decimal128/Decimal256` with more than 19-digits long scale. [#38027](https://github.com/ClickHouse/ClickHouse/pull/38027) ([Igor Nikonov](https://github.com/devcrafter)).
- Fixed crash caused by data race in storage `Hive` (integration table engine). [#38887](https://github.com/ClickHouse/ClickHouse/pull/38887) ([lgbo](https://github.com/lgbo-ustc)).
- Fix crash when executing GRANT ALL ON _._ with ON CLUSTER. It was broken in https://github.com/ClickHouse/ClickHouse/pull/35767. This closes [#38618](https://github.com/ClickHouse/ClickHouse/issues/38618). [#38674](https://github.com/ClickHouse/ClickHouse/pull/38674) ([Vitaly Baranov](https://github.com/vitlibar)).
- Correct glob expansion in case of `{0..10}` forms. Fixes [#38498](https://github.com/ClickHouse/ClickHouse/issues/38498) Current Implementation is similar to what shell does mentiond by @rschu1ze [here](https://github.com/ClickHouse/ClickHouse/pull/38502#issuecomment-1169057723). [#38502](https://github.com/ClickHouse/ClickHouse/pull/38502) ([Heena Bansal](https://github.com/HeenaBansal2009)).
- Fix crash for `mapUpdate`, `mapFilter` functions when using with constant map argument. Closes [#38547](https://github.com/ClickHouse/ClickHouse/issues/38547). [#38553](https://github.com/ClickHouse/ClickHouse/pull/38553) ([hexiaoting](https://github.com/hexiaoting)).
- Fix `toHour` monotonicity information for query optimization which can lead to incorrect query result (incorrect index analysis). This fixes [#38333](https://github.com/ClickHouse/ClickHouse/issues/38333). [#38675](https://github.com/ClickHouse/ClickHouse/pull/38675) ([Amos Bird](https://github.com/amosbird)).
- Fix checking whether s3 storage support parallel writes. It resulted in s3 parallel writes not working. [#38792](https://github.com/ClickHouse/ClickHouse/pull/38792) ([chen](https://github.com/xiedeyantu)).
- Fix s3 seekable reads with parallel read buffer. (Affected memory usage during query). Closes [#38258](https://github.com/ClickHouse/ClickHouse/issues/38258). [#38802](https://github.com/ClickHouse/ClickHouse/pull/38802) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Update `simdjson`. This fixes [#38621](https://github.com/ClickHouse/ClickHouse/issues/38621) - a buffer overflow on machines with the latest Intel CPUs with AVX-512 VBMI. [#38838](https://github.com/ClickHouse/ClickHouse/pull/38838) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix possible logical error for Vertical merges. [#38859](https://github.com/ClickHouse/ClickHouse/pull/38859) ([Maksim Kita](https://github.com/kitaisreal)).
- Fix settings profile with seconds unit. [#38896](https://github.com/ClickHouse/ClickHouse/pull/38896) ([Raúl Marín](https://github.com/Algunenano)).
- Fix incorrect partition pruning when there is a nullable partition key. Note: most likely you don't use nullable partition keys - this is an obscure feature you should not use. Nullable keys are a nonsense and this feature is only needed for some crazy use-cases. This fixes [#38941](https://github.com/ClickHouse/ClickHouse/issues/38941). [#38946](https://github.com/ClickHouse/ClickHouse/pull/38946) ([Amos Bird](https://github.com/amosbird)).
- Improve `fsync_part_directory` for fetches. [#38993](https://github.com/ClickHouse/ClickHouse/pull/38993) ([Azat Khuzhin](https://github.com/azat)).
- Fix possible dealock inside `OvercommitTracker`. Fixes [#37794](https://github.com/ClickHouse/ClickHouse/issues/37794). [#39030](https://github.com/ClickHouse/ClickHouse/pull/39030) ([Dmitry Novik](https://github.com/novikd)).
- Fix bug in filesystem cache that could happen in some corner case which coincided with cache capacity hitting the limit. Closes [#39066](https://github.com/ClickHouse/ClickHouse/issues/39066). [#39070](https://github.com/ClickHouse/ClickHouse/pull/39070) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix some corner cases of interpretation of the arguments of window expressions. Fixes [#38538](https://github.com/ClickHouse/ClickHouse/issues/38538) Allow using of higher-order functions in window expressions. [#39112](https://github.com/ClickHouse/ClickHouse/pull/39112) ([Dmitry Novik](https://github.com/novikd)).
- Keep `LowCardinality` type in `tuple` function. Previously `LowCardinality` type was dropped and elements of created tuple had underlying type of `LowCardinality`. [#39113](https://github.com/ClickHouse/ClickHouse/pull/39113) ([Anton Popov](https://github.com/CurtizJ)).
- Fix error `Block structure mismatch` which could happen for INSERT into table with attached MATERIALIZED VIEW and enabled setting `extremes = 1`. Closes [#29759](https://github.com/ClickHouse/ClickHouse/issues/29759) and [#38729](https://github.com/ClickHouse/ClickHouse/issues/38729). [#39125](https://github.com/ClickHouse/ClickHouse/pull/39125) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix unexpected query result when both `optimize_trivial_count_query` and `empty_result_for_aggregation_by_empty_set` are set to true. This fixes [#39140](https://github.com/ClickHouse/ClickHouse/issues/39140). [#39155](https://github.com/ClickHouse/ClickHouse/pull/39155) ([Amos Bird](https://github.com/amosbird)).
- Fixed error `Not found column Type in block` in selects with `PREWHERE` and read-in-order optimizations. [#39157](https://github.com/ClickHouse/ClickHouse/pull/39157) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Fix extremely rare race condition in during hardlinks for remote filesystem. The only way to reproduce it is concurrent run of backups. [#39190](https://github.com/ClickHouse/ClickHouse/pull/39190) ([alesapin](https://github.com/alesapin)).
- (zero-copy replication is an experimental feature that should not be used in production) Fix fetch of in-memory part with `allow_remote_fs_zero_copy_replication`. [#39214](https://github.com/ClickHouse/ClickHouse/pull/39214) ([Azat Khuzhin](https://github.com/azat)).
- (MaterializedPostgreSQL - experimental feature). Fix segmentation fault in MaterializedPostgreSQL database engine, which could happen if some exception occurred at replication initialisation. Closes [#36939](https://github.com/ClickHouse/ClickHouse/issues/36939). [#39272](https://github.com/ClickHouse/ClickHouse/pull/39272) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix incorrect fetch of table metadata from PostgreSQL database engine. Closes [#33502](https://github.com/ClickHouse/ClickHouse/issues/33502). [#39283](https://github.com/ClickHouse/ClickHouse/pull/39283) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix projection exception when aggregation keys are wrapped inside other functions. This fixes [#37151](https://github.com/ClickHouse/ClickHouse/issues/37151). [#37155](https://github.com/ClickHouse/ClickHouse/pull/37155) ([Amos Bird](https://github.com/amosbird)).
- Fix possible logical error `... with argument with type Nothing and default implementation for Nothing is expected to return result with type Nothing, got ...` in some functions. Closes: [#37610](https://github.com/ClickHouse/ClickHouse/issues/37610) Closes: [#37741](https://github.com/ClickHouse/ClickHouse/issues/37741). [#37759](https://github.com/ClickHouse/ClickHouse/pull/37759) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix incorrect columns order in subqueries of UNION (in case of duplicated columns in subselects may produce incorrect result). [#37887](https://github.com/ClickHouse/ClickHouse/pull/37887) ([Azat Khuzhin](https://github.com/azat)).
- Fix incorrect work of MODIFY ALTER Column with column names that contain dots. Closes [#37907](https://github.com/ClickHouse/ClickHouse/issues/37907). [#37971](https://github.com/ClickHouse/ClickHouse/pull/37971) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix reading of sparse columns from `MergeTree` tables that store their data in S3. [#37978](https://github.com/ClickHouse/ClickHouse/pull/37978) ([Anton Popov](https://github.com/CurtizJ)).
- Fix possible crash in `Distributed` async insert in case of removing a replica from config. [#38029](https://github.com/ClickHouse/ClickHouse/pull/38029) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
- Fix "Missing columns" for GLOBAL JOIN with CTE without alias. [#38056](https://github.com/ClickHouse/ClickHouse/pull/38056) ([Azat Khuzhin](https://github.com/azat)).
- Rewrite tuple functions as literals in backwards-compatibility mode. [#38096](https://github.com/ClickHouse/ClickHouse/pull/38096) ([Anton Kozlov](https://github.com/tonickkozlov)).
- Fix redundant memory reservation for output block during `ORDER BY`. [#38127](https://github.com/ClickHouse/ClickHouse/pull/38127) ([iyupeng](https://github.com/iyupeng)).
- Fix possible logical error `Bad cast from type DB::IColumn* to DB::ColumnNullable*` in array mapped functions. Closes [#38006](https://github.com/ClickHouse/ClickHouse/issues/38006). [#38132](https://github.com/ClickHouse/ClickHouse/pull/38132) ([Kruglov Pavel](https://github.com/Avogar)).
- Fix temporary name clash in partial merge join, close [#37928](https://github.com/ClickHouse/ClickHouse/issues/37928). [#38135](https://github.com/ClickHouse/ClickHouse/pull/38135) ([Vladimir C](https://github.com/vdimir)).
- Some minr issue with queries like `CREATE TABLE nested_name_tuples (`a` Tuple(x String, y Tuple(i Int32, j String))) ENGINE = Memory;` [#38136](https://github.com/ClickHouse/ClickHouse/pull/38136) ([lgbo](https://github.com/lgbo-ustc)).
- Fix bug with nested short-circuit functions that led to execution of arguments even if condition is false. Closes [#38040](https://github.com/ClickHouse/ClickHouse/issues/38040). [#38173](https://github.com/ClickHouse/ClickHouse/pull/38173) ([Kruglov Pavel](https://github.com/Avogar)).
- (Window View is a experimental feature) Fix LOGICAL_ERROR for WINDOW VIEW with incorrect structure. [#38205](https://github.com/ClickHouse/ClickHouse/pull/38205) ([Azat Khuzhin](https://github.com/azat)).
- Update librdkafka submodule to fix crash when an OAUTHBEARER refresh callback is set. [#38225](https://github.com/ClickHouse/ClickHouse/pull/38225) ([Rafael Acevedo](https://github.com/racevedoo)).
- Fix INSERT into Distributed hung due to ProfileEvents. [#38307](https://github.com/ClickHouse/ClickHouse/pull/38307) ([Azat Khuzhin](https://github.com/azat)).
- Fix retries in PostgreSQL engine. [#38310](https://github.com/ClickHouse/ClickHouse/pull/38310) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix optimization in PartialSortingTransform (SIGSEGV and possible incorrect result). [#38324](https://github.com/ClickHouse/ClickHouse/pull/38324) ([Azat Khuzhin](https://github.com/azat)).
- Fix RabbitMQ with formats based on PeekableReadBuffer. Closes [#38061](https://github.com/ClickHouse/ClickHouse/issues/38061). [#38356](https://github.com/ClickHouse/ClickHouse/pull/38356) ([Kseniia Sumarokova](https://github.com/kssenii)).
- MaterializedPostgreSQL - experimentail feature. Fix possible `Invalid number of rows in Chunk` in MaterializedPostgreSQL. Closes [#37323](https://github.com/ClickHouse/ClickHouse/issues/37323). [#38360](https://github.com/ClickHouse/ClickHouse/pull/38360) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix RabbitMQ configuration with connection string setting. Closes [#36531](https://github.com/ClickHouse/ClickHouse/issues/36531). [#38365](https://github.com/ClickHouse/ClickHouse/pull/38365) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix PostgreSQL engine not using PostgreSQL schema when retrieving array dimension size. Closes [#36755](https://github.com/ClickHouse/ClickHouse/issues/36755). Closes [#36772](https://github.com/ClickHouse/ClickHouse/issues/36772). [#38366](https://github.com/ClickHouse/ClickHouse/pull/38366) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Fix possibly incorrect result of distributed queries with `DISTINCT` and `LIMIT`. Fixes [#38282](https://github.com/ClickHouse/ClickHouse/issues/38282). [#38371](https://github.com/ClickHouse/ClickHouse/pull/38371) ([Anton Popov](https://github.com/CurtizJ)).
- Fix wrong results of countSubstrings() & position() on patterns with 0-bytes. [#38589](https://github.com/ClickHouse/ClickHouse/pull/38589) ([Robert Schulze](https://github.com/rschu1ze)).
- Now it's possible to start a clickhouse-server and attach/detach tables even for tables with the incorrect values of IPv4/IPv6 representation. Proper fix for issue [#35156](https://github.com/ClickHouse/ClickHouse/issues/35156). [#38590](https://github.com/ClickHouse/ClickHouse/pull/38590) ([alesapin](https://github.com/alesapin)).
- `rankCorr` function will work correctly if some arguments are NaNs. This closes [#38396](https://github.com/ClickHouse/ClickHouse/issues/38396). [#38722](https://github.com/ClickHouse/ClickHouse/pull/38722) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Fix `parallel_view_processing=1` with `optimize_trivial_insert_select=1`. Fix `max_insert_threads` while pushing to views. [#38731](https://github.com/ClickHouse/ClickHouse/pull/38731) ([Azat Khuzhin](https://github.com/azat)).
- Fix use-after-free for aggregate functions with `Map` combinator that leads to incorrect result. [#38748](https://github.com/ClickHouse/ClickHouse/pull/38748) ([Azat Khuzhin](https://github.com/azat)).

### <a id="226"></a> ClickHouse リリース 22.6, 2022-06-16 {#a-id226a-clickhouse-release-226-2022-06-16}

#### 後方互換性のない変更 {#backward-incompatible-change-4}

- SQLにおける8進数リテラルのサポートを削除しました。以前のバージョンではFloat64として解析されていました。[#37765](https://github.com/ClickHouse/ClickHouse/pull/37765) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- `seconds`を型として使用する設定の解析方法を変更し、浮動小数点値をサポートするようにしました(例: `max_execution_time=0.5`)。無限大またはNaN値は例外をスローします。[#37187](https://github.com/ClickHouse/ClickHouse/pull/37187) ([Raúl Marín](https://github.com/Algunenano))。
- 実験的な型`Object`のカラムのバイナリシリアライゼーション形式を変更しました。新しい形式はサードパーティクライアントによる実装がより容易です。[#37482](https://github.com/ClickHouse/ClickHouse/pull/37482) ([Anton Popov](https://github.com/CurtizJ))。
- 設定`output_format_json_named_tuples_as_objects`をデフォルトで有効にしました。これにより、JSON形式で名前付きタプルをJSONオブジェクトとしてシリアライズできます。[#37756](https://github.com/ClickHouse/ClickHouse/pull/37756) ([Anton Popov](https://github.com/CurtizJ))。
- 末尾にエスケープ記号('\\')を持つLIKEパターンは、SQL標準に準拠し、使用できなくなりました。[#37764](https://github.com/ClickHouse/ClickHouse/pull/37764) ([Robert Schulze](https://github.com/rschu1ze))。
- AArch64 CPUを搭載したクラスタで異なるClickHouseバージョンを実行している場合、またはクラスタでAArch64とamd64を混在させている場合で、256ビットに収まるが64ビットには収まらない固定サイズ型の複数キーによるGROUP BYを使用した分散クエリを実行し、結果のサイズが膨大である場合、アップグレード中にこれらのクエリの結果でデータが完全に集約されません。回避策: ローリングアップグレードではなく、ダウンタイムを伴うアップグレードを実施してください。


#### 新機能 {#new-feature-6}

- `GROUPING`関数を追加しました。`ROLLUP`、`CUBE`、または`GROUPING SETS`を使用したクエリ内のレコードを明確に区別できるようになります。[#19426](https://github.com/ClickHouse/ClickHouse/issues/19426)を解決。[#37163](https://github.com/ClickHouse/ClickHouse/pull/37163) ([Dmitry Novik](https://github.com/novikd))。
- 浮動小数点データ圧縮のための新しいコーデック[FPC](https://userweb.cs.txstate.edu/~burtscher/papers/dcc07a.pdf)アルゴリズムを追加しました。[#37553](https://github.com/ClickHouse/ClickHouse/pull/37553) ([Mikhail Guzov](https://github.com/koloshmet))。
- 新しいカラム型JSON形式を追加しました:`JSONColumns`、`JSONCompactColumns`、`JSONColumnsWithMetadata`。[#36338](https://github.com/ClickHouse/ClickHouse/issues/36338)と[#34509](https://github.com/ClickHouse/ClickHouse/issues/34509)を解決。[#36975](https://github.com/ClickHouse/ClickHouse/pull/36975) ([Kruglov Pavel](https://github.com/Avogar))。
- d3jsベースのOpenTelemetryトレース可視化ツールを追加しました。[#37810](https://github.com/ClickHouse/ClickHouse/pull/37810) ([Sergei Trifonov](https://github.com/serxa))。
- `system.zookeeper`テーブルへのINSERTをサポートしました。[#22130](https://github.com/ClickHouse/ClickHouse/issues/22130)を解決。[#37596](https://github.com/ClickHouse/ClickHouse/pull/37596) ([Han Fei](https://github.com/hanfei1991))。
- `LIKE`、`ILIKE`、および`match`関数で非定数パターン引数をサポートしました。[#37251](https://github.com/ClickHouse/ClickHouse/pull/37251) ([Robert Schulze](https://github.com/rschu1ze))。
- 実行可能なユーザー定義関数でパラメータをサポートしました。例:`SELECT test_function(parameters)(arguments)`。[#37578](https://github.com/ClickHouse/ClickHouse/issues/37578)を解決。[#37720](https://github.com/ClickHouse/ClickHouse/pull/37720) ([Maksim Kita](https://github.com/kitaisreal))。
- system.part_logテーブルに`merge_reason`カラムを追加しました。[#36912](https://github.com/ClickHouse/ClickHouse/pull/36912) ([Sema Checherinda](https://github.com/CheSema))。
- Avro形式でMapとRecordのサポートを追加しました。Avro形式でnullをデフォルトとして挿入できる新しい設定`input_format_avro_null_as_default`を追加しました。[#18925](https://github.com/ClickHouse/ClickHouse/issues/18925)、[#37378](https://github.com/ClickHouse/ClickHouse/issues/37378)、[#32899](https://github.com/ClickHouse/ClickHouse/issues/32899)を解決。[#37525](https://github.com/ClickHouse/ClickHouse/pull/37525) ([Kruglov Pavel](https://github.com/Avogar))。
- ClickHouse用に設定された仮想ファイルシステムを検査および操作するための`clickhouse-disks`ツールを追加しました。[#36060](https://github.com/ClickHouse/ClickHouse/pull/36060) ([Artyom Yurkov](https://github.com/Varinara))。
- H3単方向エッジ関数を追加しました。[#36843](https://github.com/ClickHouse/ClickHouse/pull/36843) ([Bharat Nallan](https://github.com/bharatnc))。
- 符号なし整数から[hashids](https://hashids.org/)を計算するサポートを追加しました。[#37013](https://github.com/ClickHouse/ClickHouse/pull/37013) ([Michael Nutt](https://github.com/mnutt))。
- `CREATE USER <user> IDENTIFIED WITH sha256_hash`で明示的な`SALT`指定が可能になりました。[#37377](https://github.com/ClickHouse/ClickHouse/pull/37377) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- CSV/TSV形式でファイルの先頭から指定した行数をスキップできる2つの新しい設定`input_format_csv_skip_first_lines`/`input_format_tsv_skip_first_lines`を追加しました。[#37537](https://github.com/ClickHouse/ClickHouse/pull/37537) ([Kruglov Pavel](https://github.com/Avogar))。
- `showCertificate`関数で現在のサーバーのSSL証明書を表示できるようになりました。[#37540](https://github.com/ClickHouse/ClickHouse/pull/37540) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- 名前付きコレクション内のデータディクショナリでHTTPソースをサポートしました。[#37581](https://github.com/ClickHouse/ClickHouse/pull/37581) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- 新しいウィンドウ関数`nonNegativeDerivative(metric_column, timestamp_column[, INTERVAL x SECOND])`を追加しました。[#37628](https://github.com/ClickHouse/ClickHouse/pull/37628) ([Andrey Zvonov](https://github.com/zvonand))。
- `ReplicatedMergeTree`テーブルのコメント変更を実装しました。[#37416](https://github.com/ClickHouse/ClickHouse/pull/37416) ([Vasily Nemkov](https://github.com/Enmk))。
- 対応するテーブルが削除されているかどうかに関係なく、バックアップ全体を削除する`SYSTEM UNFREEZE`クエリを追加しました。[#36424](https://github.com/ClickHouse/ClickHouse/pull/36424) ([Vadim Volodin](https://github.com/PolyProgrammist))。

#### 実験的機能 {#experimental-feature-5}

- `WINDOW VIEW`で`POPULATE`を有効化。[#36945](https://github.com/ClickHouse/ClickHouse/pull/36945) ([vxider](https://github.com/Vxider)).
- `WINDOW VIEW`に対する`ALTER TABLE ... MODIFY QUERY`のサポート。[#37188](https://github.com/ClickHouse/ClickHouse/pull/37188) ([vxider](https://github.com/Vxider)).
- このPRは`WINDOW VIEW`の`ENGINE`構文の動作を変更し、`MATERIALIZED VIEW`と同様にします。[#37214](https://github.com/ClickHouse/ClickHouse/pull/37214) ([vxider](https://github.com/Vxider)).


#### パフォーマンス改善 {#performance-improvement-6}

- ARM NEON向けの多数の最適化を追加しました [#38093](https://github.com/ClickHouse/ClickHouse/pull/38093)([Daniel Kutenin](https://github.com/danlark1)), ([Alexandra Pilipyuk](https://github.com/chalice19)) 注意: ARM CPUを搭載したクラスタで異なるバージョンのClickHouseを実行し、256ビットに収まるが64ビットには収まらない固定サイズ型の複数キーによるGROUP BYを使用した分散クエリを実行する場合、アップグレード中に集計クエリの結果が不正確になります。回避策: ローリングアップグレードではなく、ダウンタイムを伴うアップグレードを実行してください。
- Native、Protobuf、CapnProto、JSONEachRow、TSKV、およびWithNames/WithNamesAndTypesサフィックスを持つすべてのフォーマットにおいて、列のサブセット選択時のパフォーマンスとメモリ使用量を改善しました。以前は、これらのフォーマットのファイルから列のサブセットのみを選択する場合でも、すべての列が読み込まれメモリに格納されていました。現在は必要な列のみが読み込まれます。このPRでは、`input_format_skip_unknown_fields`設定をデフォルトで有効にしています。これは、そうしない場合、列のサブセット選択時に例外がスローされるためです。[#37192](https://github.com/ClickHouse/ClickHouse/pull/37192) ([Kruglov Pavel](https://github.com/Avogar))。
- 結合に対してより多くのフィルタをプッシュダウンできるようになりました。[#37472](https://github.com/ClickHouse/ClickHouse/pull/37472) ([Amos Bird](https://github.com/amosbird))。
- ワイドパートの読み取り時に、必要な列のマークのみを読み込むようにしました。[#36879](https://github.com/ClickHouse/ClickHouse/pull/36879) ([Anton Kozlov](https://github.com/tonickkozlov))。
- スパース列（`MergeTree`テーブルの実験的設定`ratio_of_defaults_for_sparse_serialization`で有効化可能）が集計関数の引数として使用される場合の集計パフォーマンスを改善しました。[#37617](https://github.com/ClickHouse/ClickHouse/pull/37617) ([Anton Popov](https://github.com/CurtizJ))。
- 2つの引数を持つ`COALESCE`関数を最適化しました。[#37666](https://github.com/ClickHouse/ClickHouse/pull/37666) ([Anton Popov](https://github.com/CurtizJ))。
- `multiIf`が1つの条件のみを持つ場合、`if`関数の方がパフォーマンスが高いため、`multiIf`を`if`に置き換えるようにしました。[#37695](https://github.com/ClickHouse/ClickHouse/pull/37695) ([Anton Popov](https://github.com/CurtizJ))。
- `dictGetDescendants`、`dictGetChildren`関数のパフォーマンスを改善しました。クエリ中の関数呼び出しごとではなく、クエリごとに親から子への階層インデックスを一時的に作成するようにしました。`HIERARHICAL`属性に対して`BIDIRECTIONAL`を指定できるようにし、辞書がメモリ内に親から子へのインデックスを保持することで、`dictGetDescendants`、`dictGetChildren`関数がクエリごとに一時インデックスを作成しないようにしました。[#32481](https://github.com/ClickHouse/ClickHouse/issues/32481)を解決します。[#37148](https://github.com/ClickHouse/ClickHouse/pull/37148) ([Maksim Kita](https://github.com/kitaisreal))。
- 集計状態の破棄をスレッドプールに投稿できるようになりました。LIMITを使用し、状態が大きいクエリでは大幅な高速化が得られます。例えば、`select uniq(number) from numbers_mt(1e7) group by number limit 100`は約2.5倍高速になりました。[#37855](https://github.com/ClickHouse/ClickHouse/pull/37855) ([Nikita Taranov](https://github.com/nickitat))。
- 単一列によるソートのパフォーマンスを改善しました。[#37195](https://github.com/ClickHouse/ClickHouse/pull/37195) ([Maksim Kita](https://github.com/kitaisreal))。
- ソートキューの特殊化を使用して、単一列のソートのパフォーマンスを改善しました。[#37990](https://github.com/ClickHouse/ClickHouse/pull/37990) ([Maksim Kita](https://github.com/kitaisreal))。
- 配列のノルムおよび距離関数のパフォーマンスを2倍から4倍改善しました。[#37394](https://github.com/ClickHouse/ClickHouse/pull/37394) ([Alexander Gololobov](https://github.com/davenger))。
- 動的ディスパッチを使用して数値比較関数のパフォーマンスを改善しました。[#37399](https://github.com/ClickHouse/ClickHouse/pull/37399) ([Maksim Kita](https://github.com/kitaisreal))。
- LIMITを伴うORDER BYのパフォーマンスを改善しました。[#37481](https://github.com/ClickHouse/ClickHouse/pull/37481) ([Maksim Kita](https://github.com/kitaisreal))。
- 動的ディスパッチインフラストラクチャを使用して`hasAll`関数のパフォーマンスを改善しました。[#37484](https://github.com/ClickHouse/ClickHouse/pull/37484) ([Maksim Kita](https://github.com/kitaisreal))。
- `greatCircleAngle`、`greatCircleDistance`、`geoDistance`関数のパフォーマンスを改善しました。[#37524](https://github.com/ClickHouse/ClickHouse/pull/37524) ([Maksim Kita](https://github.com/kitaisreal))。
- ORDER BYに複数の列がある場合のMergeTreeへの挿入パフォーマンスを改善しました。[#35762](https://github.com/ClickHouse/ClickHouse/pull/35762) ([Maksim Kita](https://github.com/kitaisreal))。
- 多数のテーブルが存在する場合のバックグラウンドでの過剰なCPU使用を修正しました。[#38028](https://github.com/ClickHouse/ClickHouse/pull/38028) ([Maksim Kita](https://github.com/kitaisreal))。
- 動的ディスパッチを使用して`not`関数のパフォーマンスを改善しました。[#38058](https://github.com/ClickHouse/ClickHouse/pull/38058) ([Maksim Kita](https://github.com/kitaisreal))。
- LIKEやMATCH関数などで使用されるre2パターンの内部キャッシングを最適化しました。[#37544](https://github.com/ClickHouse/ClickHouse/pull/37544) ([Robert Schulze](https://github.com/rschu1ze))。
- AVX-512命令を使用してフィルタビットマスク生成関数を一括で改善しました。[#37588](https://github.com/ClickHouse/ClickHouse/pull/37588) ([yaqi-zhao](https://github.com/yaqi-zhao))。
- Hive統合エンジンに読み取りメソッド`threadpool`を適用しました。これにより読み取りが大幅に高速化されます。[#36328](https://github.com/ClickHouse/ClickHouse/pull/36328) ([李扬](https://github.com/taiyang-li))。
- 読み取るすべての列がパーティションキーである場合、Hiveファイルを実際に読み取ることなく、ファイルの行番号によって列を構築するようにしました。[#37103](https://github.com/ClickHouse/ClickHouse/pull/37103) ([lgbo](https://github.com/lgbo-ustc))。
- Hiveファイルのキャッシングに複数ディスクをサポートしました。[#37279](https://github.com/ClickHouse/ClickHouse/pull/37279) ([lgbo](https://github.com/lgbo-ustc))。
- クエリごとの最大キャッシュ使用量を制限することで、キャッシュプールの汚染を効果的に防止できます。[関連Issue](https://github.com/ClickHouse/ClickHouse/issues/28961)。[#37859](https://github.com/ClickHouse/ClickHouse/pull/37859) ([Han Shukai](https://github.com/KinderRiven))。
- 現在、ClickHouseはすべてのリモートファイルをローカルキャッシュに直接ダウンロードします（一度しか読み取られない場合でも）。これにより、ローカルハードディスクのIOが頻繁に発生します。一部のシナリオでは、これらのIOは不要であり、容易に負の最適化を引き起こす可能性があります。下図に示すように、SSB Q1-Q4を実行すると、キャッシュのパフォーマンスが負の最適化を引き起こしています。[#37516](https://github.com/ClickHouse/ClickHouse/pull/37516) ([Han Shukai](https://github.com/KinderRiven))。
- S3から読み取る際に、`_file`や`_path`などの仮想列を介してファイルリストを絞り込めるようにしました。これは[#37174](https://github.com/ClickHouse/ClickHouse/issues/37174)、[#23494](https://github.com/ClickHouse/ClickHouse/issues/23494)に対応するものです。[#37356](https://github.com/ClickHouse/ClickHouse/pull/37356) ([Amos Bird](https://github.com/amosbird))。
- 関数CompressedWriteBuffer::nextImpl()において、データ挿入中に頻繁に発生する不要な書き込みコピーステップがありました。このパッチによる違いを以下に示します: - 変更前: 1. "working_buffer"を"compressed_buffer"に圧縮 2. "out"に書き込みコピー - 変更後: "working_buffer"を直接"out"に圧縮。[#37242](https://github.com/ClickHouse/ClickHouse/pull/37242) ([jasperzhu](https://github.com/jinjunzh))。





#### 改善 {#improvement-6}

- Support types with non-standard defaults in ROLLUP, CUBE, GROUPING SETS. Closes [#37360](https://github.com/ClickHouse/ClickHouse/issues/37360). [#37667](https://github.com/ClickHouse/ClickHouse/pull/37667) ([Dmitry Novik](https://github.com/novikd)).
- Fix stack traces collection on ARM. Closes [#37044](https://github.com/ClickHouse/ClickHouse/issues/37044). Closes [#15638](https://github.com/ClickHouse/ClickHouse/issues/15638). [#37797](https://github.com/ClickHouse/ClickHouse/pull/37797) ([Maksim Kita](https://github.com/kitaisreal)).
- Client will try every IP address returned by DNS resolution until successful connection. [#37273](https://github.com/ClickHouse/ClickHouse/pull/37273) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
- Allow to use String type instead of Binary in Arrow/Parquet/ORC formats. This PR introduces 3 new settings for it: `output_format_arrow_string_as_string`, `output_format_parquet_string_as_string`, `output_format_orc_string_as_string`. Default value for all settings is `false`. [#37327](https://github.com/ClickHouse/ClickHouse/pull/37327) ([Kruglov Pavel](https://github.com/Avogar)).
- Apply setting `input_format_max_rows_to_read_for_schema_inference` for all read rows in total from all files in globs. Previously setting `input_format_max_rows_to_read_for_schema_inference` was applied for each file in glob separately and in case of huge number of nulls we could read first `input_format_max_rows_to_read_for_schema_inference` rows from each file and get nothing. Also increase default value for this setting to 25000. [#37332](https://github.com/ClickHouse/ClickHouse/pull/37332) ([Kruglov Pavel](https://github.com/Avogar)).
- Add separate `CLUSTER` grant (and `access_control_improvements.on_cluster_queries_require_cluster_grant` configuration directive, for backward compatibility, default to `false`). [#35767](https://github.com/ClickHouse/ClickHouse/pull/35767) ([Azat Khuzhin](https://github.com/azat)).
- Added support for schema inference for `hdfsCluster`. [#35812](https://github.com/ClickHouse/ClickHouse/pull/35812) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Implement `least_used` load balancing algorithm for disks inside volume (multi disk configuration). [#36686](https://github.com/ClickHouse/ClickHouse/pull/36686) ([Azat Khuzhin](https://github.com/azat)).
- Modify the HTTP Endpoint to return the full stats under the `X-ClickHouse-Summary` header when `send_progress_in_http_headers=0` (before it would return all zeros). - Modify the HTTP Endpoint to return `X-ClickHouse-Exception-Code` header when progress has been sent before (`send_progress_in_http_headers=1`) - Modify the HTTP Endpoint to return `HTTP_REQUEST_TIMEOUT` (408) instead of `HTTP_INTERNAL_SERVER_ERROR` (500) on `TIMEOUT_EXCEEDED` errors. [#36884](https://github.com/ClickHouse/ClickHouse/pull/36884) ([Raúl Marín](https://github.com/Algunenano)).
- Allow a user to inspect grants from granted roles. [#36941](https://github.com/ClickHouse/ClickHouse/pull/36941) ([nvartolomei](https://github.com/nvartolomei)).
- Do not calculate an integral numerically but use CDF functions instead. This will speed up execution and will increase the precision. This fixes [#36714](https://github.com/ClickHouse/ClickHouse/issues/36714). [#36953](https://github.com/ClickHouse/ClickHouse/pull/36953) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Add default implementation for Nothing in functions. Now most of the functions will return column with type Nothing in case one of it's arguments is Nothing. It also solves problem with functions like arrayMap/arrayFilter and similar when they have empty array as an argument. Previously queries like `select arrayMap(x -> 2 * x, []);` failed because function inside lambda cannot work with type `Nothing`, now such queries return empty array with type `Array(Nothing)`. Also add support for arrays of nullable types in functions like arrayFilter/arrayFill. Previously, queries like `select arrayFilter(x -> x % 2, [1, NULL])` failed, now they work (if the result of lambda is NULL, then this value won't be included in the result). Closes [#37000](https://github.com/ClickHouse/ClickHouse/issues/37000). [#37048](https://github.com/ClickHouse/ClickHouse/pull/37048) ([Kruglov Pavel](https://github.com/Avogar)).
- Now if a shard has local replica we create a local plan and a plan to read from all remote replicas. They have shared initiator which coordinates reading. [#37204](https://github.com/ClickHouse/ClickHouse/pull/37204) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
- Do no longer abort server startup if configuration option "mark_cache_size" is not explicitly set. [#37326](https://github.com/ClickHouse/ClickHouse/pull/37326) ([Robert Schulze](https://github.com/rschu1ze)).
- Allows providing `NULL`/`NOT NULL` right after type in column declaration. [#37337](https://github.com/ClickHouse/ClickHouse/pull/37337) ([Igor Nikonov](https://github.com/devcrafter)).
- optimize file segment PARTIALLY_DOWNLOADED get read buffer. [#37338](https://github.com/ClickHouse/ClickHouse/pull/37338) ([xiedeyantu](https://github.com/xiedeyantu)).
- Try to improve short circuit functions processing to fix problems with stress tests. [#37384](https://github.com/ClickHouse/ClickHouse/pull/37384) ([Kruglov Pavel](https://github.com/Avogar)).
- Closes [#37395](https://github.com/ClickHouse/ClickHouse/issues/37395). [#37415](https://github.com/ClickHouse/ClickHouse/pull/37415) ([Memo](https://github.com/Joeywzr)).
- Fix extremely rare deadlock during part fetch in zero-copy replication. Fixes [#37423](https://github.com/ClickHouse/ClickHouse/issues/37423). [#37424](https://github.com/ClickHouse/ClickHouse/pull/37424) ([metahys](https://github.com/metahys)).
- Don't allow to create storage with unknown data format. [#37450](https://github.com/ClickHouse/ClickHouse/pull/37450) ([Kruglov Pavel](https://github.com/Avogar)).
- Set `global_memory_usage_overcommit_max_wait_microseconds` default value to 5 seconds. Add info about `OvercommitTracker` to OOM exception message. Add `MemoryOvercommitWaitTimeMicroseconds` profile event. [#37460](https://github.com/ClickHouse/ClickHouse/pull/37460) ([Dmitry Novik](https://github.com/novikd)).
- Do not display `-0.0` CPU time in clickhouse-client. It can appear due to rounding errors. This closes [#38003](https://github.com/ClickHouse/ClickHouse/issues/38003). This closes [#38038](https://github.com/ClickHouse/ClickHouse/issues/38038). [#38064](https://github.com/ClickHouse/ClickHouse/pull/38064) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Play UI: Keep controls in place when the page is scrolled horizontally. This makes edits comfortable even if the table is wide and it was scrolled far to the right. The feature proposed by Maksym Tereshchenko from CaspianDB. [#37470](https://github.com/ClickHouse/ClickHouse/pull/37470) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- Modify query div in play.html to be extendable beyond 20% height. In case of very long queries it is helpful to extend the textarea element, only today, since the div is fixed height, the extended textarea hides the data div underneath. With this fix, extending the textarea element will push the data div down/up such the extended textarea won't hide it. Also, keeps query box width 100% even when the user adjusting the size of the query textarea. [#37488](https://github.com/ClickHouse/ClickHouse/pull/37488) ([guyco87](https://github.com/guyco87)).
- Added `ProfileEvents` for introspection of type of written (inserted or merged) parts (`Inserted{Wide/Compact/InMemory}Parts`, `MergedInto{Wide/Compact/InMemory}Parts`. Added column `part_type` to `system.part_log`. Resolves [#37495](https://github.com/ClickHouse/ClickHouse/issues/37495). [#37536](https://github.com/ClickHouse/ClickHouse/pull/37536) ([Anton Popov](https://github.com/CurtizJ)).
- clickhouse-keeper improvement: move broken logs to a timestamped folder. [#37565](https://github.com/ClickHouse/ClickHouse/pull/37565) ([Antonio Andelic](https://github.com/antonio2368)).
- Do not write expired columns by TTL after subsequent merges (before only first merge/optimize of the part will not write expired by TTL columns, all other will do). [#37570](https://github.com/ClickHouse/ClickHouse/pull/37570) ([Azat Khuzhin](https://github.com/azat)).
- More precise result of the `dumpColumnStructure` miscellaneous function in presence of LowCardinality or Sparse columns. In previous versions, these functions were converting the argument to a full column before returning the result. This is needed to provide an answer in [#6935](https://github.com/ClickHouse/ClickHouse/issues/6935). [#37633](https://github.com/ClickHouse/ClickHouse/pull/37633) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
- clickhouse-keeper: store only unique session IDs for watches. [#37641](https://github.com/ClickHouse/ClickHouse/pull/37641) ([Azat Khuzhin](https://github.com/azat)).
- Fix possible "Cannot write to finalized buffer". [#37645](https://github.com/ClickHouse/ClickHouse/pull/37645) ([Azat Khuzhin](https://github.com/azat)).
- Add setting `support_batch_delete` for `DiskS3` to disable multiobject delete calls, which Google Cloud Storage doesn't support. [#37659](https://github.com/ClickHouse/ClickHouse/pull/37659) ([Fred Wulff](https://github.com/frew)).
- Add an option to disable connection pooling in ODBC bridge. [#37705](https://github.com/ClickHouse/ClickHouse/pull/37705) ([Anton Kozlov](https://github.com/tonickkozlov)).
- Functions `dictGetHierarchy`, `dictIsIn`, `dictGetChildren`, `dictGetDescendants` added support nullable `HIERARCHICAL` attribute in dictionaries. Closes [#35521](https://github.com/ClickHouse/ClickHouse/issues/35521). [#37805](https://github.com/ClickHouse/ClickHouse/pull/37805) ([Maksim Kita](https://github.com/kitaisreal)).
- Expose BoringSSL version related info in the `system.build_options` table. [#37850](https://github.com/ClickHouse/ClickHouse/pull/37850) ([Bharat Nallan](https://github.com/bharatnc)).
- Now clickhouse-server removes `delete_tmp` directories on server start. Fixes [#26503](https://github.com/ClickHouse/ClickHouse/issues/26503). [#37906](https://github.com/ClickHouse/ClickHouse/pull/37906) ([alesapin](https://github.com/alesapin)).
- Clean up broken detached parts after timeout. Closes [#25195](https://github.com/ClickHouse/ClickHouse/issues/25195). [#37975](https://github.com/ClickHouse/ClickHouse/pull/37975) ([Kseniia Sumarokova](https://github.com/kssenii)).
- Now in MergeTree table engines family failed-to-move parts will be removed instantly. [#37994](https://github.com/ClickHouse/ClickHouse/pull/37994) ([alesapin](https://github.com/alesapin)).
- Now if setting `always_fetch_merged_part` is enabled for ReplicatedMergeTree merges will try to find parts on other replicas rarely with smaller load for [Zoo]Keeper. [#37995](https://github.com/ClickHouse/ClickHouse/pull/37995) ([alesapin](https://github.com/alesapin)).
- Add implicit grants with grant option too. For example `GRANT CREATE TABLE ON test.* TO A WITH GRANT OPTION` now allows `A` to execute `GRANT CREATE VIEW ON test.* TO B`. [#38017](https://github.com/ClickHouse/ClickHouse/pull/38017) ([Vitaly Baranov](https://github.com/vitlibar)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-6}

- ビルドに`clang-14`およびLLVMインフラストラクチャバージョン14を使用します。これにより[#34681](https://github.com/ClickHouse/ClickHouse/issues/34681)が解決されます。[#34754](https://github.com/ClickHouse/ClickHouse/pull/34754) ([Alexey Milovidov](https://github.com/alexey-milovidov))。注意: `clang-14`のThreadSanitizerには[バグ](https://github.com/google/sanitizers/issues/1540)があり、CIの動作に悪影響を与えます。
- 起動時に権限を削除できるようにします。これによりDockerイメージが簡素化されます。[#36293](https://github.com/ClickHouse/ClickHouse/issues/36293)を解決します。[#36341](https://github.com/ClickHouse/ClickHouse/pull/36341) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- CIにドキュメントのスペルチェックを追加します。[#37790](https://github.com/ClickHouse/ClickHouse/pull/37790) ([Vladimir C](https://github.com/vdimir))。
- 実行ファイルの整合性チェックに必要な埋め込みハッシュを削除してしまう過度なストリッピングを修正します。[#37993](https://github.com/ClickHouse/ClickHouse/pull/37993) ([Robert Schulze](https://github.com/rschu1ze))。

#### バグ修正 {#bug-fix-2}


* 定数文字列型を含む `SELECT ... INTERSECT` および `EXCEPT SELECT` 文を修正。 [#37738](https://github.com/ClickHouse/ClickHouse/pull/37738) ([Antonio Andelic](https://github.com/antonio2368)).
* `AggregateFunction` 型のカラムでの `GROUP BY` を修正。 [#37093](https://github.com/ClickHouse/ClickHouse/pull/37093) ([Azat Khuzhin](https://github.com/azat)).
* （experimental WINDOW VIEW）WindowView における `addDependency` を修正しました。このバグは [#37237](https://github.com/ClickHouse/ClickHouse/issues/37237) と同様に再現できます。[#37224](https://github.com/ClickHouse/ClickHouse/pull/37224)（[vxider](https://github.com/Vxider)）。
* ORDER BY ... WITH FILL 機能の不整合を修正しました。複数の WITH FILL 列が存在する場合、ORDER BY ... WITH FILL を含むクエリによって余分な行が生成されることがありました。 [#38074](https://github.com/ClickHouse/ClickHouse/pull/38074) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
* このPRでは、`addDependency` をコンストラクタから `startup()` に移動することで、*削除済み* テーブルに依存関係が追加されてしまうことを避け、[#37237](https://github.com/ClickHouse/ClickHouse/issues/37237) を修正しています。[#37243](https://github.com/ClickHouse/ClickHouse/pull/37243)（[vxider](https://github.com/Vxider)）。
* カラム型フォーマットにおいて、欠損値に対するデフォルト値の挿入動作を修正しました。これまでは、存在しないカラムに対してカラムごとのデフォルト値ではなく、型のデフォルト値が埋め込まれていました。 [#37253](https://github.com/ClickHouse/ClickHouse/pull/37253) ([Kruglov Pavel](https://github.com/Avogar)).
* （実験的な Object 型）`Object` 型カラムへのネストした配列の挿入に関するいくつかのケースを修正。[#37305](https://github.com/ClickHouse/ClickHouse/pull/37305)（[Anton Popov](https://github.com/CurtizJ)）。
* 集約関数、PREWHERE、JOIN における定数文字列の衝突に起因する予期しないエラーを修正。[#36891](https://github.com/ClickHouse/ClickHouse/issues/36891) をクローズ。[#37336](https://github.com/ClickHouse/ClickHouse/pull/37336)（[Vladimir C](https://github.com/vdimir)）。
* クエリ内の GROUP/ORDER BY を含む Projection を修正し、optimize&#95;aggregation&#95;in&#95;order を改善（以前は最終ソートのみが実行されていたため、結果が誤っていた）。 [#37342](https://github.com/ClickHouse/ClickHouse/pull/37342) ([Azat Khuzhin](https://github.com/azat)).
* S3 のキー名内の記号に関するエラーを修正。 [#33009](https://github.com/ClickHouse/ClickHouse/issues/33009) を修正。 [#37344](https://github.com/ClickHouse/ClickHouse/pull/37344)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* GROUPING SETS が ROLLUP または CUBE と併用された場合に例外をスローするようにしました。 [#37367](https://github.com/ClickHouse/ClickHouse/pull/37367) ([Dmitry Novik](https://github.com/novikd))。
* マージ中の `getMaxSourcePartsSizeForMerge` で発生していた LOGICAL&#95;ERROR を修正（`background_pool_size` / `background_merges_mutations_concurrency_ratio` に対して標準より大きい非標準的な値が、非推奨の `users.xml` ではなく新しい方式である `config.xml` に指定されている場合）。 [#37413](https://github.com/ClickHouse/ClickHouse/pull/37413) ([Azat Khuzhin](https://github.com/azat)).
* RowBinary フォーマットで UTF-8 BOM を削除しないようにしました。[#37428](https://github.com/ClickHouse/ClickHouse/pull/37428) ([Paul Loyd](https://github.com/loyd)). [#37428](https://github.com/ClickHouse/ClickHouse/pull/37428) ([Paul Loyd](https://github.com/loyd)).
* clickhouse-keeper のバグ修正: 単一ノードクラスタに対する強制リカバリ処理を修正。 [#37440](https://github.com/ClickHouse/ClickHouse/pull/37440) ([Antonio Andelic](https://github.com/antonio2368)).
* normalizeUTF8 関数の論理エラーを修正。[#37298](https://github.com/ClickHouse/ClickHouse/issues/37298) をクローズ。[#37443](https://github.com/ClickHouse/ClickHouse/pull/37443)（[Maksim Kita](https://github.com/kitaisreal)）。
* JoinSwitcher における Nullable な LowCardinality 型のキャスト処理を修正し、[#37385](https://github.com/ClickHouse/ClickHouse/issues/37385) をクローズ。 [#37453](https://github.com/ClickHouse/ClickHouse/pull/37453)（[Vladimir C](https://github.com/vdimir)）。
* ORC/Arrow/Parquet フォーマットにおける名前付きタプルの出力を修正しました。 [#37458](https://github.com/ClickHouse/ClickHouse/pull/37458) ([Kruglov Pavel](https://github.com/Avogar)).
* GROUPING SETS が存在する場合の ORDER BY 句における単調関数の最適化を修正。 [#37401](https://github.com/ClickHouse/ClickHouse/issues/37401) を解決。 [#37493](https://github.com/ClickHouse/ClickHouse/pull/37493) ([Dmitry Novik](https://github.com/novikd))。
* 特定の条件でディクショナリとの `JOIN` を行う際に発生するエラーを修正。[#37386](https://github.com/ClickHouse/ClickHouse/issues/37386) をクローズ。[#37530](https://github.com/ClickHouse/ClickHouse/pull/37530)（[Vladimir C](https://github.com/vdimir)）。
* `GROUPING SETS` 使用時の `optimize_aggregation_in_order` の利用を禁止（`LOGICAL_ERROR` を修正）。 [#37542](https://github.com/ClickHouse/ClickHouse/pull/37542) ([Azat Khuzhin](https://github.com/azat)).
* ActionsDAG の誤ったダンプ情報を修正。 [#37587](https://github.com/ClickHouse/ClickHouse/pull/37587) ([zhanglistar](https://github.com/zhanglistar)).
* UNION クエリの型変換を修正（LOGICAL&#95;ERROR を発生させる可能性があった）。 [#37593](https://github.com/ClickHouse/ClickHouse/pull/37593) ([Azat Khuzhin](https://github.com/azat)).
* `STEP` 句における負の間隔を伴う `WITH FILL` 修飾子の動作を修正。 [#37514](https://github.com/ClickHouse/ClickHouse/issues/37514) を修正。 [#37600](https://github.com/ClickHouse/ClickHouse/pull/37600)（[Anton Popov](https://github.com/CurtizJ)）。
* `join_use_nulls = 1` のときに発生する不正な `joinGet` 配列の使用を修正しました。これにより [#37562](https://github.com/ClickHouse/ClickHouse/issues/37562) が解消されました。 [#37650](https://github.com/ClickHouse/ClickHouse/pull/37650) ([Amos Bird](https://github.com/amosbird)).
* クロス結合における列数の不一致を修正し、[#37561](https://github.com/ClickHouse/ClickHouse/issues/37561) をクローズ。[#37653](https://github.com/ClickHouse/ClickHouse/pull/37653)（[Vladimir C](https://github.com/vdimir)）。
* 名前付きコレクションで構成された mysql データベースに対する `show create table` で発生していたセグメンテーションフォルトを修正しました。[#37683](https://github.com/ClickHouse/ClickHouse/issues/37683) をクローズしました。 [#37690](https://github.com/ClickHouse/ClickHouse/pull/37690)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `SETTINGS` 句なしでストレージが作成された場合に、サーバー再起動時に RabbitMQ Storage が起動できない問題を修正しました。[#37463](https://github.com/ClickHouse/ClickHouse/issues/37463) をクローズ。[#37691](https://github.com/ClickHouse/ClickHouse/pull/37691)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* SQL ユーザー定義関数により、readonly モードでの CREATE/DROP が禁止されました。 [#37280](https://github.com/ClickHouse/ClickHouse/issues/37280) をクローズ。 [#37699](https://github.com/ClickHouse/ClickHouse/pull/37699) ([Maksim Kita](https://github.com/kitaisreal)).
* 実行可能なユーザー定義関数における Nullable 引数の書式を修正。[#35897](https://github.com/ClickHouse/ClickHouse/issues/35897) をクローズ。[#37711](https://github.com/ClickHouse/ClickHouse/pull/37711)（[Maksim Kita](https://github.com/kitaisreal)）。
* 分散クエリにおいて `optimize_monotonous_functions_in_order_by` を設定することで有効になる最適化を修正。 [#36037](https://github.com/ClickHouse/ClickHouse/issues/36037) を修正。 [#37724](https://github.com/ClickHouse/ClickHouse/pull/37724)（[Anton Popov](https://github.com/CurtizJ)）。
* `values` テーブル関数で発生する可能性のあった論理エラー `Invalid Field get from type UInt64 to type Float64` を修正しました。 [#37602](https://github.com/ClickHouse/ClickHouse/issues/37602) をクローズ。[#37754](https://github.com/ClickHouse/ClickHouse/pull/37754)（[Kruglov Pavel](https://github.com/Avogar)）。
* `SchemaReader` コンストラクタ内で例外が発生した場合に、スキーマ推論でセグメンテーションフォールトが発生し得る問題を修正しました。 [#37680](https://github.com/ClickHouse/ClickHouse/issues/37680) をクローズ。 [#37760](https://github.com/ClickHouse/ClickHouse/pull/37760)（[Kruglov Pavel](https://github.com/Avogar)）。
* 内部の cast 関数に対する設定 `cast_ipv4_ipv6_default_on_conversion_error` の問題を修正。 [#35156](https://github.com/ClickHouse/ClickHouse/issues/35156) をクローズ。 [#37761](https://github.com/ClickHouse/ClickHouse/pull/37761)（[Maksim Kita](https://github.com/kitaisreal)）。
* DatatypeDate32 の toString エラーを修正。 [#37775](https://github.com/ClickHouse/ClickHouse/pull/37775) ([LiuNeng](https://github.com/liuneng1994)).
* clickhouse-keeper の設定項目 `dead_session_check_period_ms` がマイクロ秒単位（1000 倍）に変換されてしまい、その結果、デッドセッションのクリーンアップが（500ms ではなく）数分後にしか行われない状態になっていました。[#37824](https://github.com/ClickHouse/ClickHouse/pull/37824)（[Michael Lex](https://github.com/mlex)）。
* 分散クエリにおいて（`async_socket_for_remote` / `use_hedged_requests` が無効な場合）発生する可能性のある「No more packets are available」エラーを修正。 [#37826](https://github.com/ClickHouse/ClickHouse/pull/37826) ([Azat Khuzhin](https://github.com/azat)).
* （experimental WINDOW VIEW）WindowView で `ALTER TABLE ... MODIFY QUERY` を実行しても内部のターゲットテーブルが削除されないようにしました。 [#37879](https://github.com/ClickHouse/ClickHouse/pull/37879) ([vxider](https://github.com/Vxider))。
* clickhouse-keeper の Docker イメージにおける coordination ディレクトリの所有者設定を修正。 [#37914](https://github.com/ClickHouse/ClickHouse/issues/37914) を修正。 [#37915](https://github.com/ClickHouse/ClickHouse/pull/37915)（[James Maidment](https://github.com/jamesmaidment)）。
* 辞書で、更新フィールドと `{condition}` を含むカスタムクエリを修正。 [#33746](https://github.com/ClickHouse/ClickHouse/issues/33746) をクローズ。 [#37947](https://github.com/ClickHouse/ClickHouse/pull/37947) ([Maksim Kita](https://github.com/kitaisreal)).
* `ORDER BY` が `WITH FILL` の結果（例えば外側のクエリに対して）に適用されるべき場合に、`SELECT ... WITH FILL` の結果が誤る可能性がある問題を修正しました。不正な結果は、`ORDER BY` 式に対する最適化が原因でした（[#35623](https://github.com/ClickHouse/ClickHouse/issues/35623)）。[#37904](https://github.com/ClickHouse/ClickHouse/issues/37904) をクローズしました。[#37959](https://github.com/ClickHouse/ClickHouse/pull/37959)（[Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)）。
* （実験的 WINDOW VIEW）WindowView でターゲットテーブルにプッシュする際に、欠落しているデフォルトカラムを追加し、[#37815](https://github.com/ClickHouse/ClickHouse/issues/37815) を修正。[#37965](https://github.com/ClickHouse/ClickHouse/pull/37965)（[vxider](https://github.com/Vxider)）。
* コンパイルが失敗する原因となっていた、スタックフレームが大きすぎる問題を修正しました。 [#37996](https://github.com/ClickHouse/ClickHouse/pull/37996) ([Han Shukai](https://github.com/KinderRiven)).
* enable&#95;filesystem&#95;query&#95;cache&#95;limit を有効化している場合、予約済みキャッシュサイズが残りのキャッシュサイズを超えたときに「Reserved cache size exceeds the remaining cache size.」というエラーをスローするようにしました。 [#38004](https://github.com/ClickHouse/ClickHouse/pull/38004) ([xiedeyantu](https://github.com/xiedeyantu)).
* UNION クエリでの型変換を修正しました（LOGICAL&#95;ERROR を引き起こす可能性がありました）。 [#34775](https://github.com/ClickHouse/ClickHouse/pull/34775) ([Azat Khuzhin](https://github.com/azat)).
* BackgroundExecutor がビジーな場合、TTL マージが再度スケジュールされないことがあります。--merges&#95;with&#95;ttl&#95;counter は selectPartsToMerge() 内で増加します。--BackgroundExecutor がビジーな場合、マージタスクは無視されます。--merges&#95;with&#95;ttl&#95;counter は減少しません。 [#36387](https://github.com/ClickHouse/ClickHouse/pull/36387) ([lthaooo](https://github.com/lthaooo)).
* `normalize_function_names` の設定値が上書きされてしまう問題を修正しました。 [#36937](https://github.com/ClickHouse/ClickHouse/pull/36937) ([李扬](https://github.com/taiyang-li)).
* 指数時間減衰ウィンドウ関数の不具合を修正しました。ウィンドウ境界が正しく考慮されるようになりました。 [#36944](https://github.com/ClickHouse/ClickHouse/pull/36944) ([Vladimir Chebotarev](https://github.com/excitoon))。
* system.projection&#95;parts および system.projection&#95;parts&#95;columns の読み取り時に発生する可能性のある heap-use-after-free エラーを修正しました。これにより [#37184](https://github.com/ClickHouse/ClickHouse/issues/37184) が解決されます。 [#37185](https://github.com/ClickHouse/ClickHouse/pull/37185)（[Amos Bird](https://github.com/amosbird)）。
* Unix エポック以前における `DateTime64` の小数秒の挙動を修正しました。 [#37697](https://github.com/ClickHouse/ClickHouse/pull/37697) ([Andrey Zvonov](https://github.com/zvonand)). [#37039](https://github.com/ClickHouse/ClickHouse/pull/37039) ([李扬](https://github.com/taiyang-li)).

### <a id="225"></a> ClickHouseリリース22.5、2022-05-19 {#a-id225a-clickhouse-release-225-2022-05-19}

#### アップグレード時の注意事項 {#upgrade-notes-2}

- バックグラウンドマージ、ミューテーション、および`OPTIMIZE`は、`SelectedRows`と`SelectedBytes`メトリクスを増加させなくなりました。これらは従来通り`MergedRows`と`MergedUncompressedBytes`を増加させます。この変更はメトリクス値にのみ影響し、より適切な値となります。この変更は互換性の問題を引き起こしませんが、メトリクスの変化について疑問に思われる可能性があるため、このカテゴリに記載しています。[#37040](https://github.com/ClickHouse/ClickHouse/pull/37040) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- BoringSSLモジュールを公式のFIPS準拠バージョンに更新しました。これによりClickHouseはFIPS準拠となります。[#35914](https://github.com/ClickHouse/ClickHouse/pull/35914) ([Meena-Renganathan](https://github.com/Meena-Renganathan))。暗号方式`aes-192-cfb128`と`aes-256-cfb128`は、BoringSSLのFIPS認証バージョンに含まれていないため削除されました。
- `users.xml`のデフォルトユーザープロファイルから`max_memory_usage`設定が削除されました。これにより、従来の固定10GB制限ではなく、クエリに対する柔軟なメモリ制限が可能になります。
- `log_query_threads`設定をデフォルトで無効化しました。この設定はクエリ実行に参加する各スレッドの統計情報のログ記録を制御します。非同期読み取りのサポート後、個別のスレッドIDの総数が過大になり、`query_thread_log`へのログ記録が過負荷となりました。[#37077](https://github.com/ClickHouse/ClickHouse/pull/37077) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- バグのある関数`groupArraySorted`を削除しました。[#36822](https://github.com/ClickHouse/ClickHouse/pull/36822) ([Alexey Milovidov](https://github.com/alexey-milovidov))。

#### 新機能 {#new-feature-7}


- メモリオーバーコミットをデフォルトで有効化。[#35921](https://github.com/ClickHouse/ClickHouse/pull/35921) ([Dmitry Novik](https://github.com/novikd))。
- GROUP BY句におけるGROUPING SETSのサポートを追加。この実装はグルーピングセットの並列処理をサポートします。[#33631](https://github.com/ClickHouse/ClickHouse/pull/33631) ([Dmitry Novik](https://github.com/novikd))。
- `system.certificates`テーブルを追加。[#37142](https://github.com/ClickHouse/ClickHouse/pull/37142) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy))。
- `h3Line`、`h3Distance`、`h3HexRing`関数を追加。[#37030](https://github.com/ClickHouse/ClickHouse/pull/37030) ([Bharat Nallan](https://github.com/bharatnc))。
- 新しい単一バイナリベースの診断ツール(clickhouse-diagnostics)。[#36705](https://github.com/ClickHouse/ClickHouse/pull/36705) ([Dale McDiarmid](https://github.com/gingerwizard))。
- 出力フォーマット`Prometheus`を追加 [#36051](https://github.com/ClickHouse/ClickHouse/issues/36051)。[#36206](https://github.com/ClickHouse/ClickHouse/pull/36206) ([Vladimir C](https://github.com/vdimir))。
- `MySQLDump`入力フォーマットを追加。ダンプ内の1つのテーブルに属するすべてのINSERTクエリからデータを読み取ります。複数のテーブルが存在する場合、デフォルトでは最初のテーブルからデータを読み取ります。[#36667](https://github.com/ClickHouse/ClickHouse/pull/36667) ([Kruglov Pavel](https://github.com/Avogar))。
- 一時テーブルの`system.tables`に`total_rows`と`total_bytes`フィールドを表示。[#36401](https://github.com/ClickHouse/ClickHouse/issues/36401)。[#36439](https://github.com/ClickHouse/ClickHouse/pull/36439) ([xiedeyantu](https://github.com/xiedeyantu))。
- クエリレベルの設定で`parts_to_delay_insert`と`parts_to_throw_insert`をオーバーライド可能に。これらが定義されている場合、テーブルレベルの設定をオーバーライドします。[#36371](https://github.com/ClickHouse/ClickHouse/pull/36371) ([Memo](https://github.com/Joeywzr))。

#### 実験的機能 {#experimental-feature-6}


- 配列に対するL1、L2、Linf、コサイン距離関数と、配列に対するL1、L2、Linfノルム関数を実装しました。
  [#37033](https://github.com/ClickHouse/ClickHouse/pull/37033) ([qieqieplus](https://github.com/qieqieplus))。注意:これらの関数は名前が変更される予定です。
- WindowViewの`WATCH`クエリを改善しました:1. `fire_condition`シグナルを呼び出すことでクエリ結果提供の遅延を削減しました。2. `isCancelled()`をより頻繁にチェックすることで、クエリのキャンセル操作(ctrl-c)を高速化しました。[#37226](https://github.com/ClickHouse/ClickHouse/pull/37226) ([vxider](https://github.com/Vxider))。
- ファイルシステムキャッシュ削除のためのイントロスペクション機能を追加しました。[#36802](https://github.com/ClickHouse/ClickHouse/pull/36802) ([Han Shukai](https://github.com/KinderRiven))。
- SQL用の新しいハッシュ関数`wyHash64`を追加しました。[#36467](https://github.com/ClickHouse/ClickHouse/pull/36467) ([olevino](https://github.com/olevino))。
- レプリケートされたデータベースの改善:`SYSTEM SYNC DATABASE REPLICA`クエリを追加しました。これにより、レプリケートされたデータベース内のテーブルメタデータを同期できるようになりました。現在、同期は非同期で行われているためです。[#35944](https://github.com/ClickHouse/ClickHouse/pull/35944) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- リモートファイルシステムキャッシュの改善:キャッシュからの読み取りを改善しました。[#37054](https://github.com/ClickHouse/ClickHouse/pull/37054) ([Kseniia Sumarokova](https://github.com/kssenii))。`SYSTEM DROP FILESYSTEM CACHE`クエリの改善:`<path>`オプションと`FORCE`オプションを追加しました。[#36639](https://github.com/ClickHouse/ClickHouse/pull/36639) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 半構造化データの改善:`Object(...)`型のカラムを`Object(Nullable(...))`型にキャストできるようになりました。[#36564](https://github.com/ClickHouse/ClickHouse/pull/36564) ([awakeljw](https://github.com/awakeljw))。
- 並列レプリカの改善:localhostレプリカでクエリを実行する場合、ローカルインタープリタを作成します。しかし、複数のレプリカでクエリを実行する場合、レプリカがコーディネーターと通信できるように接続が存在することに依存していました。これが改善され、localhostレプリカが同じプロセス内でコーディネーターと直接通信できるようになりました。[#36281](https://github.com/ClickHouse/ClickHouse/pull/36281) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。

#### パフォーマンスの改善 {#performance-improvement-7}


- GROUP BY式なしで使用する場合の`avg`、`sum`集約関数のパフォーマンスを改善。[#37257](https://github.com/ClickHouse/ClickHouse/pull/37257) ([Maksim Kita](https://github.com/kitaisreal))。
- 動的ディスパッチを使用した単項算術関数(`bitCount`、`bitNot`、`abs`、`intExp2`、`intExp10`、`negate`、`roundAge`、`roundDuration`、`roundToExp2`、`sign`)のパフォーマンスを改善。[#37289](https://github.com/ClickHouse/ClickHouse/pull/37289) ([Maksim Kita](https://github.com/kitaisreal))。
- ソートカラム比較器のJITコンパイルを使用したORDER BY、MergeJoin、MergeTreeへの挿入のパフォーマンスを改善。[#34469](https://github.com/ClickHouse/ClickHouse/pull/34469) ([Maksim Kita](https://github.com/kitaisreal))。
- `system.asynchronous_metric_log`の構造を変更。使用スペースが約10分の1になります。これにより[#36357](https://github.com/ClickHouse/ClickHouse/issues/36357)が解決されます。`event_time_microseconds`フィールドは不要なため削除されました。[#36360](https://github.com/ClickHouse/ClickHouse/pull/36360) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- ワイドパートの読み取り時に必要なカラムのマークのみをロード。[#36879](https://github.com/ClickHouse/ClickHouse/pull/36879) ([Anton Kozlov](https://github.com/tonickkozlov))。
- mutexスコープを狭めることでファイルディスクリプタキャッシュのパフォーマンスを改善。[#36682](https://github.com/ClickHouse/ClickHouse/pull/36682) ([Anton Kozlov](https://github.com/tonickkozlov))。
- パスにglobが含まれ、マッチしたディレクトリに大量のファイルが含まれる場合の、ストレージ`File`およびテーブル関数`file`からの読み取りパフォーマンスを改善。[#36647](https://github.com/ClickHouse/ClickHouse/pull/36647) ([Anton Popov](https://github.com/CurtizJ))。
- 入力フォーマット`HiveText`に並列パースを適用。ローカルファイル読み取り時にHiveTextのパースを2倍高速化できます。[#36650](https://github.com/ClickHouse/ClickHouse/pull/36650) ([李扬](https://github.com/taiyang-li))。
- デフォルトの`HashJoin`は右テーブルの行挿入時にスレッドセーフではなく、シングルスレッドで実行されます。右テーブルが大きい場合、CPU使用率が低く結合処理が遅くなります。[#36415](https://github.com/ClickHouse/ClickHouse/pull/36415) ([lgbo](https://github.com/lgbo-ustc))。
- `select countDistinct(a) from t`を`select count(1) from (select a from t groupBy a)`に書き換えることを許可。[#35993](https://github.com/ClickHouse/ClickHouse/pull/35993) ([zhanglistar](https://github.com/zhanglistar))。
- OR LIKEチェーンをmultiMatchAnyに変換。動作に十分な確信が得られ次第有効化されます。[#34932](https://github.com/ClickHouse/ClickHouse/pull/34932) ([Daniel Kutenin](https://github.com/danlark1))。
- インライン化による一部の関数のパフォーマンスを改善。[#34544](https://github.com/ClickHouse/ClickHouse/pull/34544) ([Daniel Kutenin](https://github.com/danlark1))。
- readBigで不要なmemcpyを回避するための分岐を追加。パフォーマンスがある程度改善されます。[#36095](https://github.com/ClickHouse/ClickHouse/pull/36095) ([jasperzhu](https://github.com/jinjunzh))。
- optimize_aggregation_in_orderのための部分的なGROUP BYキーを実装。[#35111](https://github.com/ClickHouse/ClickHouse/pull/35111) ([Azat Khuzhin](https://github.com/azat))。

#### 改善 {#improvement-7}


* テーブル関数 `file`、`s3`、`url` の実行中にパースエラーが発生した場合に、問題のあるファイル名を表示するようにしました。 [#36314](https://github.com/ClickHouse/ClickHouse/pull/36314) ([Anton Popov](https://github.com/CurtizJ)).
* トップレベルの設定で指定されている場合、実行時にバックグラウンド処理（マージ、ミューテーション、ムーブ、フェッチ）のスレッド数を増やせるようになりました。 [#36425](https://github.com/ClickHouse/ClickHouse/pull/36425) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 1970-01-01 00:00:00 より前の時刻を生成する日付時刻変換関数について、時間／分が端数付きのタイムゾーンを持つ場合でも、オーバーフローさせずにゼロへ飽和させるようになりました。これは [https://github.com/ClickHouse/ClickHouse/pull/29953](https://github.com/ClickHouse/ClickHouse/pull/29953) の継続であり、[https://github.com/ClickHouse/ClickHouse/pull/29953#discussion&#95;r800550280](https://github.com/ClickHouse/ClickHouse/pull/29953#discussion_r800550280) に対処するものです。実装定義の挙動（かつ非常にまれなケース）であり、互換性を壊しても許容されるため、改善としてマークされています。 [#36656](https://github.com/ClickHouse/ClickHouse/pull/36656) ([Amos Bird](https://github.com/amosbird))。
* clickhouse-server をログレベル「test」で実行している場合に警告を表示するようにしました。ログレベル「test」は最近追加されたものであり、避けられない致命的なパフォーマンス低下を必ず引き起こすため、本番環境では使用できません。[#36824](https://github.com/ClickHouse/ClickHouse/pull/36824) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* CREATE TABLE で照合順序をパースし、例外をスローするか無視するようにしました。[#35892](https://github.com/ClickHouse/ClickHouse/issues/35892) をクローズ。[#36271](https://github.com/ClickHouse/ClickHouse/pull/36271)（[yuuch](https://github.com/yuuch)）。
* オプション `compatibility_ignore_auto_increment_in_create_table` により、MySQL からの移行を容易にするため、カラム定義内の `AUTO_INCREMENT` キーワードを無視できるようになります。 [#37178](https://github.com/ClickHouse/ClickHouse/pull/37178) ([Igor Nikonov](https://github.com/devcrafter))。
* `JSONEachRow` のエイリアスとして `JSONLines` と `NDJSON` を追加。 [#36303](https://github.com/ClickHouse/ClickHouse/issues/36303) をクローズ。 [#36327](https://github.com/ClickHouse/ClickHouse/pull/36327) ([flynn](https://github.com/ucasfl))。
* 各 Hive テーブルごとにクエリ可能な最大パーティション数を制限し、リソースの過剰な消費を防止します。[#37281](https://github.com/ClickHouse/ClickHouse/pull/37281) ([lgbo](https://github.com/lgbo-ustc)).
* `h3kRing` 関数の第 2 引数に対する暗黙のキャストを追加し、使い勝手を向上させました。[#35432](https://github.com/ClickHouse/ClickHouse/issues/35432) をクローズ。[#37189](https://github.com/ClickHouse/ClickHouse/pull/37189)（[Maksim Kita](https://github.com/kitaisreal)）。
* 任意のクエリに対する `clickhouse-local` の `INSERT SELECT` の進捗表示と、クライアントでのファイル進捗およびファイル進捗表示を修正し、より正確なファイル進捗を実現しました。 [#37075](https://github.com/ClickHouse/ClickHouse/pull/37075) ([Kseniia Sumarokova](https://github.com/kssenii)).
* パーツ削除中にファイルシステム障害が発生した場合、MergeTree テーブルエンジンファミリーで古いパーツが削除されずに残ってしまう可能性があったバグを修正しました。修正前は、最初のサーバー再起動後にのみ削除されていました。 [#37014](https://github.com/ClickHouse/ClickHouse/pull/37014) ([alesapin](https://github.com/alesapin))。
* メイン設定で有効化できる、新しい行ポリシー処理モードを実装しました。これにより、許可的な行ポリシーを持たないユーザーでも行を読み取れるようになります。 [#36997](https://github.com/ClickHouse/ClickHouse/pull/36997) ([Vitaly Baranov](https://github.com/vitlibar)).
* Play UI: `Nullable` な数値は、テーブルセル内で右寄せで表示されるようになりました。これにより [#36982](https://github.com/ClickHouse/ClickHouse/issues/36982) がクローズされました。[#36988](https://github.com/ClickHouse/ClickHouse/pull/36988)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* Play UI: 結果が1行のみで列が複数ある場合は、結果を縦方向に表示する。[#36811](https://github.com/ClickHouse/ClickHouse/issues/36811) の続き。[#36842](https://github.com/ClickHouse/ClickHouse/pull/36842)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* Play UI の CSS を整理しました。ピクセル配置がより均一になり、テーブルセル内の長いコンテンツのユーザビリティが向上しました。 [#36569](https://github.com/ClickHouse/ClickHouse/pull/36569) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* 例外発生時にデストラクタ内で実行することを避けるため、書き込みバッファを明示的にファイナライズするようにしました。これにより、次の問題が解決されることを期待しています: [#36907](https://github.com/ClickHouse/ClickHouse/issues/36907)。[#36979](https://github.com/ClickHouse/ClickHouse/pull/36979)（[Kruglov Pavel](https://github.com/Avogar)）。
* [#36425](https://github.com/ClickHouse/ClickHouse/issues/36425) 以降、`background_fetches_pool_size` のような設定は廃止され、トップレベルの設定で指定できるようになりましたが、ClickHouse は `Error updating configuration from '/etc/clickhouse-server/config.xml' config.: Code: 137. DB::Exception: A setting 'background_fetches_pool_size' appeared at top level in config /etc/clickhouse-server/config.xml.` のような例外をスローしていました。この問題は修正されました。 [#36917](https://github.com/ClickHouse/ClickHouse/pull/36917) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 例外を別のサーバーに送信する際に、可能であれば追加の診断情報を含めるようにしました。 [#36872](https://github.com/ClickHouse/ClickHouse/pull/36872) ([tavplubix](https://github.com/tavplubix)).
* `Array(Tuple(..))` 型の引数を持つハッシュ関数の実行を許可。 [#36812](https://github.com/ClickHouse/ClickHouse/pull/36812) ([Anton Popov](https://github.com/CurtizJ)).
* `user_defined_path` 設定項目を追加しました。 [#36753](https://github.com/ClickHouse/ClickHouse/pull/36753) ([Maksim Kita](https://github.com/kitaisreal)).
* `s3Cluster` テーブル関数で cluster マクロを使用可能にしました。 [#36726](https://github.com/ClickHouse/ClickHouse/pull/36726) ([Vadim Volodin](https://github.com/PolyProgrammist)).
* `clickhouse-client` / `clickhouse-local` で `INSERT` クエリを適切にキャンセルできるようにしました。 [#36710](https://github.com/ClickHouse/ClickHouse/pull/36710) ([Azat Khuzhin](https://github.com/azat))。
* `MySQLHandler` でクエリ ID を適切に維持しつつ、クエリをキャンセルできるようにしました。 [#36699](https://github.com/ClickHouse/ClickHouse/pull/36699) ([Amos Bird](https://github.com/amosbird)).
* `system.processes` に `is_all_data_sent` カラムを追加し、それに基づいて内部テスト向けの堅牢性チェックを改善しました。 [#36649](https://github.com/ClickHouse/ClickHouse/pull/36649) ([Azat Khuzhin](https://github.com/azat)).
* s3 からの読み取りに費やされた時間に関するメトリクスが、正しく計算されるようになりました。 [#35483](https://github.com/ClickHouse/ClickHouse/issues/35483) をクローズ。 [#36572](https://github.com/ClickHouse/ClickHouse/pull/36572)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* `clickhouse-local` で実行される場合、テーブル関数 `file` でファイルディスクリプタを使用可能に。 [#36562](https://github.com/ClickHouse/ClickHouse/pull/36562) ([wuxiaobai24](https://github.com/wuxiaobai24)).
* 数字から始まるタプル要素名を許可するようにしました。 [#36544](https://github.com/ClickHouse/ClickHouse/pull/36544) ([Anton Popov](https://github.com/CurtizJ)).
* clickhouse-benchmark が環境変数から認証情報を読み取れるようになりました。 [#36497](https://github.com/ClickHouse/ClickHouse/pull/36497) ([Anton Kozlov](https://github.com/tonickkozlov)).
* `clickhouse-keeper` の改善: クォーラムなしでクラスタを再構成できる force recovery 機能のサポートを追加しました。 [#36258](https://github.com/ClickHouse/ClickHouse/pull/36258) ([Antonio Andelic](https://github.com/antonio2368)).
* JSON オブジェクトに対するスキーマ推論を改善しました。 [#36207](https://github.com/ClickHouse/ClickHouse/pull/36207) ([Kruglov Pavel](https://github.com/Avogar)).
* グロブを用いたスキーマ推論まわりのコードをリファクタリングしました。妥当な場合にのみグロブから次のファイルを試すようにしました（以前はどのようなエラーでも発生すると次のファイルを試していました）。また、これにより [#36317](https://github.com/ClickHouse/ClickHouse/issues/36317) も修正されます。[#36205](https://github.com/ClickHouse/ClickHouse/pull/36205)（[Kruglov Pavel](https://github.com/Avogar)）。
* 個別の `CLUSTER` 権限（および後方互換性のための `access_control_improvements.on_cluster_queries_require_cluster_grant` 設定ディレクティブ。デフォルトは `false`）を追加しました。 [#35767](https://github.com/ClickHouse/ClickHouse/pull/35767) ([Azat Khuzhin](https://github.com/azat)).
* 選択されたクエリが停止する前に必要な量のメモリが利用可能になった場合、待機中のすべてのクエリは実行を継続します。現在は、選択されたクエリがキャンセルを認識するより前にメモリが解放された場合、どのクエリも停止されません。 [#35637](https://github.com/ClickHouse/ClickHouse/pull/35637) ([Dmitry Novik](https://github.com/novikd)).
* protobuf における Nullable の検出。proto3 では、デフォルト値はワイヤ上では送信されません。このため、Nullable カラムで `null` とデフォルト値を区別することは容易ではありません。この問題に対処する標準的な方法は、Google wrappers を使用して対象の値を内部メッセージ内にネストすることです（[https://github.com/protocolbuffers/protobuf/blob/master/src/google/protobuf/wrappers.proto](https://github.com/protocolbuffers/protobuf/blob/master/src/google/protobuf/wrappers.proto) を参照）。この場合、フィールドが存在しない場合は `null` 値として解釈され、値が欠落しているフィールドはデフォルト値として解釈され、通常の値を持つフィールドは通常の値として解釈されます。しかし、ClickHouse は Google wrappers をネストされたカラムとして解釈します。そこで、Google wrappers を検出し、上記の説明どおりに解釈するための特別な動作を導入することを提案します。例えば、Nullable カラム `test` の値をシリアライズするには、.proto スキーマ内で `google.protobuf.StringValue test` を使用します。これらの型は、Protobuf においていわゆる「well-known types」と呼ばれるものであり、ライブラリ自体で実装されていることに注意してください。 [#35149](https://github.com/ClickHouse/ClickHouse/pull/35149)（[Jakub Kuklis](https://github.com/jkuklis)）。
* 事前定義および静的な HTTP ハンドラー設定で `content_type` を指定できるようになりました。 [#34916](https://github.com/ClickHouse/ClickHouse/pull/34916) ([Roman Nikonov](https://github.com/nic11)).
* 事前に `--external` を付けずに `clickhouse-client --file` を使用した場合に、正しく警告を出すようにしました。[#34747](https://github.com/ClickHouse/ClickHouse/issues/34747) をクローズしました。[#34765](https://github.com/ClickHouse/ClickHouse/pull/34765)（[李扬](https://github.com/taiyang-li)）。
* MySQL データベースエンジンを改善し、`binary(0)` データ型との互換性を追加しました。 [#37232](https://github.com/ClickHouse/ClickHouse/pull/37232) ([zzsmdfj](https://github.com/zzsmdfj)).
* clickhouse-benchmark の JSON レポートを改善。 [#36473](https://github.com/ClickHouse/ClickHouse/pull/36473) ([Tian Xinhui](https://github.com/xinhuitian))。
* 外部 ClickHouse dictionary のホスト名を解決できない場合に、サーバーが起動しないことがありました。この問題を修正しました。 [#36451](https://github.com/ClickHouse/ClickHouse/issues/36451) を修正。 [#36463](https://github.com/ClickHouse/ClickHouse/pull/36463)（[tavplubix](https://github.com/tavplubix)）。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-7}

- `x86_64`アーキテクチャ向けの`clickhouse-keeper`は、[musl](https://musl.libc.org/)で静的リンクされるようになり、システムライブラリに依存しなくなりました。[#31833](https://github.com/ClickHouse/ClickHouse/pull/31833) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- `PowerPC64LE`アーキテクチャ向けのClickHouseビルドが、ユニバーサルインストールスクリプト`curl https://clickhouse.com/ | sh`および直接リンク`https://builds.clickhouse.com/master/powerpc64le/clickhouse`で利用可能になりました。[#37095](https://github.com/ClickHouse/ClickHouse/pull/37095) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- 互換性向上のため、PowerPCのコード生成をPower8に制限しました。これにより[#36025](https://github.com/ClickHouse/ClickHouse/issues/36025)が解決されます。[#36529](https://github.com/ClickHouse/ClickHouse/pull/36529) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- パフォーマンステストを簡素化しました。これにより利用しやすくなります。[#36769](https://github.com/ClickHouse/ClickHouse/pull/36769) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
- レポートにエラーがある場合、パフォーマンス比較を失敗させるようにしました。[#34797](https://github.com/ClickHouse/ClickHouse/pull/34797) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- ArrowにZSTDサポートを追加しました。これにより[#35283](https://github.com/ClickHouse/ClickHouse/issues/35283)が修正されます。[#35486](https://github.com/ClickHouse/ClickHouse/pull/35486) ([Sean Lafferty](https://github.com/seanlaff))。

#### バグ修正 {#bug-fix-3}


* URI から（存在する場合は）Version ID を抽出し、AWS HTTP URI へのリクエストを追加します。[#31221](https://github.com/ClickHouse/ClickHouse/issues/31221) をクローズ。 - [x] URI から（存在する場合は）`Version ID` を抽出し、それを含めずに再構成する。 - [x] リクエストを設定した `AWS HTTP URI` オブジェクトを構成する。 - [x] ユニットテスト: [`gtest_s3_uri`](https://github.com/ClickHouse/ClickHouse/blob/2340a6c6849ebc05a8efbf97ba8de3ff9dc0eff4/src/IO/tests/gtest_s3_uri.cpp) - [x] インストルメンテーション用コミットを削除。[#34571](https://github.com/ClickHouse/ClickHouse/pull/34571) ([Saad Ur Rahman](https://github.com/surahman))。
* system.opentelemetry&#95;span&#95;log の attribute.values のエイリアスが keys ではなく values になるよう修正。 [#37275](https://github.com/ClickHouse/ClickHouse/pull/37275) ([Aleksandr Razumov](https://github.com/ernado)).
* Nullable(String) から Nullable(Bool/IPv4/IPv6) への変換を修正。 [#37221](https://github.com/ClickHouse/ClickHouse/issues/37221) をクローズ。 [#37270](https://github.com/ClickHouse/ClickHouse/pull/37270)（[Kruglov Pavel](https://github.com/Avogar)）。
* 実験的機能: `Object` 型のカラムが存在するテーブルにおけるミューテーションの実行を修正しました。`UPDATE` や `DELETE` クエリの `WHERE` 句で `Object` 型のサブカラムを使用することや、個別のサブカラムを操作すること（`DROP`、`MODIFY`）が、利用可能になりました。[#37205](https://github.com/ClickHouse/ClickHouse/issues/37205) を修正。[#37266](https://github.com/ClickHouse/ClickHouse/pull/37266)（[Anton Popov](https://github.com/CurtizJ)）。
* Kafka ではプロデューサー側で `group.id` を設定する必要はありません。コンソールログには、この問題について説明する警告が次のように出力されます: `2022.05.15 17:59:13.270227 [ 137 ] {} <Warning> StorageKafka (topic-name): [rdk:CONFWARN] [thrd:app]: Configuration property group.id is a consumer property and will be ignored by this producer instance`。[#37228](https://github.com/ClickHouse/ClickHouse/pull/37228)（[Mark Andreev](https://github.com/mrk-andreev)）。
* 実験的機能 (WindowView): まだトリガーされていないデータを削除した場合に備え、ブロックが実際にトリガーされた後に `max_fired_watermark` を更新するようにしました。 [#37225](https://github.com/ClickHouse/ClickHouse/pull/37225) ([vxider](https://github.com/Vxider))。
* LIMIT BY を含む分散クエリで発生していた &quot;Cannot create column of type Set&quot; エラーを修正。 [#37193](https://github.com/ClickHouse/ClickHouse/pull/37193) ([Azat Khuzhin](https://github.com/azat)).
* 実験的機能: 今後、WindowView の `WATCH EVENTS` クエリは、`WindowViewSource.h:58` で作成される非空の Chunk によって終了しなくなります。 [#37182](https://github.com/ClickHouse/ClickHouse/pull/37182) ([vxider](https://github.com/Vxider)).
* サブクエリに対して `enable_global_with_statement` を有効にし、[#37141](https://github.com/ClickHouse/ClickHouse/issues/37141) をクローズ。[#37166](https://github.com/ClickHouse/ClickHouse/pull/37166)（[Vladimir C](https://github.com/vdimir)）。
* optimize&#95;skip&#95;unused&#95;shards&#95;rewrite&#95;in での暗黙的キャストを修正。 [#37153](https://github.com/ClickHouse/ClickHouse/pull/37153) ([Azat Khuzhin](https://github.com/azat)).
* FixedString 列に対する ILIKE 関数が誤った結果（本来一致すべきものが一致しないなど、実際より少ない一致）を返す可能性がありました。 [#37117](https://github.com/ClickHouse/ClickHouse/pull/37117) ([Robert Schulze](https://github.com/rschu1ze))。
* `AggregateFunction` 型のカラムでの `GROUP BY` を修正。 [#37093](https://github.com/ClickHouse/ClickHouse/pull/37093) ([Azat Khuzhin](https://github.com/azat)).
* 実験的機能: プレフィックス付き `GROUP BY` および `*Array` 集約関数に対する `optimize_aggregation_in_order` を修正。 [#37050](https://github.com/ClickHouse/ClickHouse/pull/37050) ([Azat Khuzhin](https://github.com/azat)).
* 暗黙的な集約を伴う一部の INSERT SELECT クエリで発生していたパフォーマンス低下を修正しました。[#36792](https://github.com/ClickHouse/ClickHouse/issues/36792) を解決。 [#37047](https://github.com/ClickHouse/ClickHouse/pull/37047) ([tavplubix](https://github.com/tavplubix))。
* 実験的機能: `*Array`（`groupArrayArray`/...）集約関数を用いたインオーダー `GROUP BY`（`optimize_aggregation_in_order=1`）の修正。 [#37046](https://github.com/ClickHouse/ClickHouse/pull/37046)（[Azat Khuzhin](https://github.com/azat)）。
* インデックスの型が UInt8 ではない場合に発生する LowCardinality-&gt;ArrowDictionary の不正な出力を修正しました。[#36832](https://github.com/ClickHouse/ClickHouse/issues/36832) をクローズ。[#37043](https://github.com/ClickHouse/ClickHouse/pull/37043)（[Kruglov Pavel](https://github.com/Avogar)）。
* `quantileTDigest` における inf の問題を修正しました。 [#32107](https://github.com/ClickHouse/ClickHouse/issues/32107) を解決。 [#37021](https://github.com/ClickHouse/ClickHouse/pull/37021)（[Vladimir Chebotarev](https://github.com/excitoon)）。
* HedgedConnections で max&#95;parallel&#95;replicas != 1 の場合の外部テーブルデータ送信処理を修正。[#36981](https://github.com/ClickHouse/ClickHouse/pull/36981) ([Kruglov Pavel](https://github.com/Avogar))。
* `Replicated` データベースにおける `TRUNCATE` クエリの論理エラーを修正しました。 [#33747](https://github.com/ClickHouse/ClickHouse/issues/33747) を解決します。 [#36976](https://github.com/ClickHouse/ClickHouse/pull/36976) ([tavplubix](https://github.com/tavplubix))。
* 実験的機能: WindowView でソーステーブルを DROP した際に発生するハング状態を修正しました。[#35678](https://github.com/ClickHouse/ClickHouse/issues/35678) をクローズ。[#36967](https://github.com/ClickHouse/ClickHouse/pull/36967)（[vxider](https://github.com/Vxider)）。
* 実験的機能 (rocksdb cache): 問題を修正しました: [#36671](https://github.com/ClickHouse/ClickHouse/issues/36671). [#36929](https://github.com/ClickHouse/ClickHouse/pull/36929) ([李扬](https://github.com/taiyang-li)).
* 実験的機能: 複数のカラムを WindowView で使用する際のバグを、やや異なるスキーマでも `writeIntoWindowView` を呼び出せるようにする変換アクションを追加することで修正しました。 [#36928](https://github.com/ClickHouse/ClickHouse/pull/36928) ([vxider](https://github.com/Vxider)).
* 低負荷時の再起動により圧縮ログファイルが破損する可能性のあった clickhouse-keeper のバグを修正。 [#36910](https://github.com/ClickHouse/ClickHouse/pull/36910) ([alesapin](https://github.com/alesapin)).
* 定数集約を行う際に誤ったクエリ結果が返される問題を修正しました。これにより [#36728](https://github.com/ClickHouse/ClickHouse/issues/36728) が解決されます。 [#36888](https://github.com/ClickHouse/ClickHouse/pull/36888) ([Amos Bird](https://github.com/amosbird))。
* 実験的機能: キャッシュ内の `current_size` のカウントを修正。[#36887](https://github.com/ClickHouse/ClickHouse/pull/36887)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 実験的機能: hop window を使用した window view における fire の挙動を修正 [#34044](https://github.com/ClickHouse/ClickHouse/issues/34044)。 [#36861](https://github.com/ClickHouse/ClickHouse/pull/36861) ([vxider](https://github.com/Vxider))。
* 実験的機能: リモートファイルシステムからのキャッシュバッファに対する誤ったキャストを修正。 [#36809](https://github.com/ClickHouse/ClickHouse/pull/36809) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `flatten_nested = 0` を指定したテーブル作成時の挙動を修正しました。以前は、サーバー再起動後に、フラット化しないはずの `Nested` 列がフラット化されてしまう場合がありました。[#36803](https://github.com/ClickHouse/ClickHouse/pull/36803) ([Anton Popov](https://github.com/CurtizJ))。
* リモートファイルシステムからの非同期読み取りで、LowCardinality を読み込む際に発生していたいくつかの問題を修正しました。 [#36763](https://github.com/ClickHouse/ClickHouse/pull/36763) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 実験的機能：グロブを用いたテーブル関数 `file` など、複数ファイルからの `Object` 型カラムへの挿入を修正しました。 [#36762](https://github.com/ClickHouse/ClickHouse/pull/36762) ([Anton Popov](https://github.com/CurtizJ)).
* Hedged リクエストにおけるタイムアウト処理を修正しました。リモートクエリ送信直後に接続がハングすると、無期限に待ち続けてしまう可能性がありました。 [#36749](https://github.com/ClickHouse/ClickHouse/pull/36749) ([Kruglov Pavel](https://github.com/Avogar)).
* 実験的機能: 分散テーブルにおける `groupBitmapAndState`/`groupBitmapOrState`/`groupBitmapXorState` のバグを修正。 [#36739](https://github.com/ClickHouse/ClickHouse/pull/36739) ([Zhang Yifan](https://github.com/zhangyifan27)).
* 実験的機能: [PR](https://github.com/ClickHouse/ClickHouse/pull/36376) の[テスト](https://s3.amazonaws.com/clickhouse-test-reports/36376/1cb1c7275cb53769ab826772db9b71361bb3e413/stress_test__thread__actions_/clickhouse-server.clean.log)中に、あるキャッシュクラスが 2 回初期化され、その結果として例外がスローされることが分かりました。この問題の原因はまだ明らかではありませんが、ClickHouse 内でディスクを繰り返しロードするコードロジックが存在すると考えられるため、この状況に対しては特別な判定を行う必要があります。[#36737](https://github.com/ClickHouse/ClickHouse/pull/36737)（[Han Shukai](https://github.com/KinderRiven)）。
* ワイドパーツでの縦方向マージを修正しました。以前はマージ中に `There is no column` という例外がスローされる可能性がありました。 [#36707](https://github.com/ClickHouse/ClickHouse/pull/36707) ([Anton Popov](https://github.com/CurtizJ)).
* ポート変更時のサーバーのリロードを修正（クエリコンテキストからの既存の接続が切断されるのを待たないようにする）。 [#36700](https://github.com/ClickHouse/ClickHouse/pull/36700) ([Azat Khuzhin](https://github.com/azat)).
* 実験的機能: 以前の[PR](https://github.com/ClickHouse/ClickHouse/pull/36376)で、テスト（stateless tests、flaky check（address, actions））がタイムアウトすることを確認しました。さらに、ローカルでテストを実行すると、システムのデッドロックが不安定に発生することがあります。この問題は、最新のmasterブランチのソースコードを使用しても依然として発生します。[#36697](https://github.com/ClickHouse/ClickHouse/pull/36697)（[Han Shukai](https://github.com/KinderRiven)）。
* 実験的機能: キャッシュ設定が変更された場合にサーバーが再起動できない問題を修正。 [#36685](https://github.com/ClickHouse/ClickHouse/pull/36685) ([Kseniia Sumarokova](https://github.com/kssenii))。
* スキーマ推論における heap-use-after-free が発生する可能性のある不具合を修正。[#36661](https://github.com/ClickHouse/ClickHouse/issues/36661) をクローズ。[#36679](https://github.com/ClickHouse/ClickHouse/pull/36679)（[Kruglov Pavel](https://github.com/Avogar)）。
* `ENGINE` が指定されていない場合の `CREATE` クエリにおけるクエリ設定の解析を修正しました。以下の問題を修正します: [https://github.com/ClickHouse/ClickHouse/pull/34187#issuecomment-1103812419](https://github.com/ClickHouse/ClickHouse/pull/34187#issuecomment-1103812419)。[#36642](https://github.com/ClickHouse/ClickHouse/pull/36642)（[tavplubix](https://github.com/tavplubix)）。
* 実験的機能: 型 `Object` を持つワイドパーツのマージ処理を修正。[#36637](https://github.com/ClickHouse/ClickHouse/pull/36637)（[Anton Popov](https://github.com/CurtizJ)）。
* デフォルト式がリテラルではなく EPHEMERAL の後に続く場合に発生する format のクラッシュを修正。[#36618](https://github.com/ClickHouse/ClickHouse/issues/36618) をクローズ。 [#36633](https://github.com/ClickHouse/ClickHouse/pull/36633)（[flynn](https://github.com/ucasfl)）。
* `ENGINE = MergeTree` テーブルで `INTERPOLATE` を使用した際に発生する可能性があった `Missing column` 例外を修正しました。 [#36549](https://github.com/ClickHouse/ClickHouse/pull/36549) ([Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)).
* 結合クエリの `WHERE` におけるリテラルが原因となる可能性のあるエラーを修正。[#36279](https://github.com/ClickHouse/ClickHouse/issues/36279) をクローズ。[#36542](https://github.com/ClickHouse/ClickHouse/pull/36542)（[Vladimir C](https://github.com/vdimir)）。
* 未定義動作を引き起こす可能性があった `ReadBufferFromEncryptedFile` のオフセット更新処理を修正しました。 [#36493](https://github.com/ClickHouse/ClickHouse/pull/36493) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Keeper クラスター構成に対するホスト名の健全性チェックを修正しました。これらのチェックを有効化／無効化するための `keeper_server.host_checks_enabled` 設定を追加しました。 [#36492](https://github.com/ClickHouse/ClickHouse/pull/36492) ([Antonio Andelic](https://github.com/antonio2368))。
* GROUP BY での実行可能なユーザー定義関数の使用を修正しました。以前は、実行可能なユーザー定義関数を GROUP BY の式として使用できませんでした。[#36448](https://github.com/ClickHouse/ClickHouse/issues/36448) をクローズ。[#36486](https://github.com/ClickHouse/ClickHouse/pull/36486)（[Maksim Kita](https://github.com/kitaisreal)）。
* クライアントで、サーバーからの不明なパケットによって発生する可能性のある例外を修正しました。 [#36481](https://github.com/ClickHouse/ClickHouse/pull/36481) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 実験的機能（`system.session_log` は使用しないでください。削除される予定です）：`system.session&#95;log` テーブルに不足している enum 値を追加。 [#36474](https://github.com/ClickHouse/ClickHouse/issues/36474) をクローズ。 [#36480](https://github.com/ClickHouse/ClickHouse/pull/36480)（[Memo](https://github.com/Joeywzr)）。
* `s3Cluster` のスキーマ推論におけるバグを修正しました。このバグにより、`s3Cluster` からの `SELECT` で全てのデータが読み取られない問題が発生していました。このバグは [https://github.com/ClickHouse/ClickHouse/pull/35544](https://github.com/ClickHouse/ClickHouse/pull/35544) で導入されました。 [#36434](https://github.com/ClickHouse/ClickHouse/pull/36434) ([Kruglov Pavel](https://github.com/Avogar))。
* JOIN および COLUMNS マッチャーにおける nullptr デリファレンスを修正。これにより [#36416](https://github.com/ClickHouse/ClickHouse/issues/36416) が修正されます。[https://github.com/ClickHouse/ClickHouse/pull/36417](https://github.com/ClickHouse/ClickHouse/pull/36417) 向けの変更です。[#36430](https://github.com/ClickHouse/ClickHouse/pull/36430)（[Amos Bird](https://github.com/amosbird)）。
* `ClickHouseDictionarySource` にスカラサブクエリが含まれている場合の辞書の再読み込みを修正しました。 [#36390](https://github.com/ClickHouse/ClickHouse/pull/36390) ([lthaooo](https://github.com/lthaooo)).
* JOIN のアサーションを修正し、[#36199](https://github.com/ClickHouse/ClickHouse/issues/36199) をクローズしました。[#36201](https://github.com/ClickHouse/ClickHouse/pull/36201)（[Vladimir C](https://github.com/vdimir)）。
* 特殊な演算子内でエイリアスを使用したクエリがパースエラーを返していました（バージョン 22.1 で不具合が発生）。例: `SELECT substring('test' AS t, 1, 1)`. [#36167](https://github.com/ClickHouse/ClickHouse/pull/36167) ([Maksim Kita](https://github.com/kitaisreal)).
* 実験的機能: 入れ子配列を含む複雑な JSON を `Object` 型のカラムに挿入する処理を修正。 [#36077](https://github.com/ClickHouse/ClickHouse/pull/36077) ([Anton Popov](https://github.com/CurtizJ)).
* コンパクトパーツを持つネスト型カラムに対する `ALTER DROP COLUMN` の動作を修正（つまり、カラム `n.d` が存在する場合の `ALTER TABLE x DROP COLUMN n`）。 [#35797](https://github.com/ClickHouse/ClickHouse/pull/35797) ([Azat Khuzhin](https://github.com/azat)).
* `offset` と `length` が負の定数で、`s` が定数ではない場合における substring 関数の範囲エラーを修正。 [#33861](https://github.com/ClickHouse/ClickHouse/pull/33861) ([RogerYK](https://github.com/RogerYK)).

### <a id="224"></a> ClickHouse リリース 22.4, 2022-04-19 {#a-id224a-clickhouse-release-224-2022-04-19}

#### 後方互換性のない変更 {#backward-incompatible-change-5}

- INSERT クエリで FORMAT の後に SETTINGS を指定できないようにしました（互換性設定 `allow_settings_after_format_in_insert` を使用することでこのようなクエリを受け入れることができますが、デフォルトでは OFF になっています）。[#35883](https://github.com/ClickHouse/ClickHouse/pull/35883) ([Azat Khuzhin](https://github.com/azat))。
- 関数 `yandexConsistentHash`（Konstantin "kostik" Oblakov によるコンシステントハッシュアルゴリズム）を `kostikConsistentHash` に名称変更しました。互換性のため、古い名前はエイリアスとして残されています。この変更は後方互換性がありますが、今後のリリースでエイリアスを削除する可能性があるため、アプリケーション内でこの関数を使用している箇所を更新することを推奨します。[#35553](https://github.com/ClickHouse/ClickHouse/pull/35553) ([Alexey Milovidov](https://github.com/alexey-milovidov))。

#### 新機能 {#new-feature-8}


* ORDER BY ... WITH FILL に INTERPOLATE 拡張を追加しました。[#34903](https://github.com/ClickHouse/ClickHouse/issues/34903) をクローズ。[#35349](https://github.com/ClickHouse/ClickHouse/pull/35349)（[Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)）。
* プロセッサーレベルでのプロファイリング（`log_processors_profiles` 設定が有効な場合、ClickHouse は実行中およびデータ待機中にプロセッサーが費やした時間を `system.processors_profile_log` テーブルに書き込みます）。 [#34355](https://github.com/ClickHouse/ClickHouse/pull/34355) ([Azat Khuzhin](https://github.com/azat))。
* 関数 makeDate(year, month, day)、makeDate32(year, month, day) を追加しました。 [#35628](https://github.com/ClickHouse/ClickHouse/pull/35628) ([Alexander Gololobov](https://github.com/davenger))。makeDateTime() および makeDateTime64() を実装しました。 [#35934](https://github.com/ClickHouse/ClickHouse/pull/35934) ([Alexander Gololobov](https://github.com/davenger))。
* INSERT クエリで書き込みバイト数を制限するための新しいクォータ種別 `WRITTEN BYTES` をサポートしました。 [#35736](https://github.com/ClickHouse/ClickHouse/pull/35736) ([Anton Popov](https://github.com/CurtizJ)).
* 関数 `flattenTuple` を追加しました。これは入れ子になった名前付き `Tuple` を引数に取り、元の `Tuple` に含まれるパスを要素とするフラットな `Tuple` を返します。例: `Tuple(a Int, Tuple(b Int, c Int)) -> Tuple(a Int, b Int, c Int)`。`flattenTuple` は、型 `Object` からすべてのパスを個別のカラムとして選択するために使用できます。 [#35690](https://github.com/ClickHouse/ClickHouse/pull/35690) ([Anton Popov](https://github.com/CurtizJ))。
* 関数 `arrayFirstOrNull` と `arrayLastOrNull` を追加しました。[#35238](https://github.com/ClickHouse/ClickHouse/issues/35238) をクローズ。[#35414](https://github.com/ClickHouse/ClickHouse/pull/35414)（[Maksim Kita](https://github.com/kitaisreal)）。
* `minSampleSizeContinous` と `minSampleSizeConversion` 関数を追加しました。作成者は [achimbab](https://github.com/achimbab)。[#35360](https://github.com/ClickHouse/ClickHouse/pull/35360)（[Maksim Kita](https://github.com/kitaisreal)）。
* 新しい関数 `minSampleSizeContinous` と `minSampleSizeConversion` を追加しました。 [#34354](https://github.com/ClickHouse/ClickHouse/pull/34354) ([achimbab](https://github.com/achimbab))。
* フォーマット `ProtobufList` を導入（すべてのレコードを出力 Protobuf 内の repeated メッセージとして扱う）。[#16436](https://github.com/ClickHouse/ClickHouse/issues/16436) をクローズ。[#35152](https://github.com/ClickHouse/ClickHouse/pull/35152)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `h3PointDistM`、`h3PointDistKm`、`h3PointDistRads`、`h3GetRes0Indexes`、`h3GetPentagonIndexes` 関数を追加しました。 [#34568](https://github.com/ClickHouse/ClickHouse/pull/34568) ([Bharat Nallan](https://github.com/bharatnc))。
* `toLastDayOfMonth` 関数を追加しました。この関数は、日付または日時をその月の最終日に丸めます。 [#33501](https://github.com/ClickHouse/ClickHouse/issues/33501)。 [#34394](https://github.com/ClickHouse/ClickHouse/pull/34394) ([Habibullah Oladepo](https://github.com/holadepo))。
* [Zoo]Keeper クライアント向けのロードバランシング設定を追加しました。[#29617](https://github.com/ClickHouse/ClickHouse/issues/29617) をクローズ。[#30325](https://github.com/ClickHouse/ClickHouse/pull/30325)（[小路](https://github.com/nicelulu)）。
* `simple` という名前の新しい種類の行ポリシーを追加しました。この PR 以前は、`permissive` と `restrictive` の 2 種類の行ポリシーのみが存在していました。`simple` 行ポリシーは、`permissive` や `restrictive` ポリシーの場合にあったような副作用なしに、テーブルに新しいフィルタを追加します。 [#35345](https://github.com/ClickHouse/ClickHouse/pull/35345) ([Vitaly Baranov](https://github.com/vitlibar))。
* レプリケーテッドデータベースでクラスタシークレットを指定できるようにしました。 [#35333](https://github.com/ClickHouse/ClickHouse/pull/35333) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* サーバー起動時にサニティチェック（利用可能なメモリとディスク容量、最大スレッド数など）を追加しました。 [#34566](https://github.com/ClickHouse/ClickHouse/pull/34566) ([Sergei Trifonov](https://github.com/serxa)).
* INTERVAL の改善 - `[MILLI|MICRO|NANO]SECOND` も使用できるようになりました。`toStartOf[Milli|Micro|Nano]second()` 関数を追加しました。`[add|subtract][Milli|Micro|Nano]seconds()` 関数を追加しました。 [#34353](https://github.com/ClickHouse/ClickHouse/pull/34353) ([Andrey Zvonov](https://github.com/zvonand)).

#### 実験的機能 {#experimental-feature-7}

- シンプルな`MergeTree`テーブルに対するトランザクションのサポートを追加しました。この機能は高度に実験的であり、本番環境での使用は推奨されません。[#22086](https://github.com/ClickHouse/ClickHouse/issues/22086)の一部です。[#24258](https://github.com/ClickHouse/ClickHouse/pull/24258) ([tavplubix](https://github.com/tavplubix))。
- `JSONEachRow`形式における`Object`型のスキーマ推論をサポートしました。`Map`型のカラムを`Object`型のカラムに変換できるようになりました。[#35629](https://github.com/ClickHouse/ClickHouse/pull/35629) ([Anton Popov](https://github.com/CurtizJ))。
- すべての書き込み操作でリモートFSキャッシュへの書き込みを許可しました。`system.remote_filesystem_cache`テーブルを追加しました。`drop remote filesystem cache`クエリを追加しました。`system.remote_data_paths`テーブルによるS3メタデータのイントロスペクションを追加しました。[#34021](https://github.com/ClickHouse/ClickHouse/issues/34021)をクローズします。`read_from_filesystem_cache_if_exists_otherwise_bypass_cache`モードを追加することで、マージ用のキャッシュオプションを追加しました(マージではデフォルトで有効になっており、同名のクエリ設定でも有効にできます)。キャッシュ関連の設定名を変更しました(`remote_fs_enable_cache -> enable_filesystem_cache`など)。[#35475](https://github.com/ClickHouse/ClickHouse/pull/35475) ([Kseniia Sumarokova](https://github.com/kssenii))。
- RocksDBにパーツメタデータを保存するオプションを追加しました。MergeTreeのパーツ読み込みプロセスを高速化し、clickhouse-serverの起動を加速します。この改善により、clickhouse-serverは70万個のMergeTreeパーツを持つ環境で、起動時間を75分から20秒に短縮できました。[#32928](https://github.com/ClickHouse/ClickHouse/pull/32928) ([李扬](https://github.com/taiyang-li))。

#### パフォーマンス改善 {#performance-improvement-8}


- 新しいクエリプラン最適化。可能な場合、`ORDER BY`の後に関数を評価します。例えば、クエリ`SELECT sipHash64(number) FROM numbers(1e8) ORDER BY number LIMIT 5`の場合、関数`sipHash64`は`ORDER BY`と`LIMIT`の後に評価され、約20倍の高速化を実現します。[#35623](https://github.com/ClickHouse/ClickHouse/pull/35623) ([Nikita Taranov](https://github.com/nickitat))。
- 集約時に使用されるハッシュテーブルのサイズが収集され、後続のクエリで使用されることで、ハッシュテーブルのリサイズを回避します。[#33439](https://github.com/ClickHouse/ClickHouse/pull/33439) ([Nikita Taranov](https://github.com/nickitat))。
- SIMD命令(SSEおよびAVX2)を使用したhasAll関数の改善。[#27653](https://github.com/ClickHouse/ClickHouse/pull/27653) ([youennL-cs](https://github.com/youennL-cs))。[#35723](https://github.com/ClickHouse/ClickHouse/pull/35723) ([Maksim Kita](https://github.com/kitaisreal))。
- ASOF JOINのパフォーマンスを向上させる複数の変更(1.2〜1.6倍高速化)。また、大きな整数の使用もサポートされました。[#34733](https://github.com/ClickHouse/ClickHouse/pull/34733) ([Raúl Marín](https://github.com/Algunenano))。
- キーがネイティブ整数の場合のASOF JOINのパフォーマンスを改善。[#35525](https://github.com/ClickHouse/ClickHouse/pull/35525) ([Maksim Kita](https://github.com/kitaisreal))。
- S3ストレージへのマルチパートアップロードの並列化。[#35343](https://github.com/ClickHouse/ClickHouse/pull/35343) ([Sergei Trifonov](https://github.com/serxa))。
- URLストレージエンジンは、エンドポイントがHTTP Rangeをサポートしている場合、複数のチャンクを並列でダウンロードするようになりました。2つの追加設定`max_download_threads`と`max_download_buffer_size`が追加され、単一のクエリがファイルのダウンロードに使用できる最大スレッド数と、各スレッドが処理できる最大バイト数を制御します。[#35150](https://github.com/ClickHouse/ClickHouse/pull/35150) ([Antonio Andelic](https://github.com/antonio2368))。
- S3からオブジェクトをダウンロードする際に複数のスレッドを使用します。ダウンロードは`max_download_threads`と`max_download_buffer_size`設定で制御可能です。[#35571](https://github.com/ClickHouse/ClickHouse/pull/35571) ([Antonio Andelic](https://github.com/antonio2368))。
- HDFSとのやり取り時にミューテックスのスコープを縮小。関連: [#35292](https://github.com/ClickHouse/ClickHouse/issues/35292)。[#35646](https://github.com/ClickHouse/ClickHouse/pull/35646) ([shuchaome](https://github.com/shuchaome))。
- テーブルごとのTTLが変更された場合にのみミューテーションを要求するようにしました。[#35953](https://github.com/ClickHouse/ClickHouse/pull/35953) ([Azat Khuzhin](https://github.com/azat))。

#### 改善 {#improvement-8}


* スキーマ推論に関する複数の改善。CSV、TSV、および TSVRaw データ形式において、数値、文字列、配列、タプル、マップを判別するために、いくつかの調整とヒューリスティクスを使用するようにしました。CSV 形式向けに、これらのヒューリスティクスの使用を有効／無効にする設定 `input_format_csv_use_best_effort_in_schema_inference` を追加しました。無効化されている場合は、すべてを string として扱います。同様の設定 `input_format_tsv_use_best_effort_in_schema_inference` を TSV/TSVRaw 形式向けに追加しました。これらの設定はデフォルトで有効です。- Values 形式でのスキーマ推論に Maps のサポートを追加しました。- Values 形式でのスキーマ推論におけるセグメンテーションフォールトが発生する可能性を修正しました。- Arrow/ORC/Parquet 形式で、サポートされていない型を持つカラムをスキップできるようにしました。そのための設定として `input_format_{parquet|orc|arrow}_skip_columns_with_unsupported_types_in_schema_inference` を追加しました。これらの設定はデフォルトで無効です。- Arrow/Parquet 形式で、型が Null のカラムを、すべての値が NULL の Nullable カラムに変換できるようにしました。- CSV、TSV、JSONCompactEachRow など列名を含まない形式については、設定 `column_names_for_schema_inference` により、スキーマ推論時にカラム名を指定できるようにしました。- ORC/Arrow/Parquet 形式において、Nullable カラムの取り扱いに関するスキーマ推論を修正しました。以前は推論されたすべての型が Nullable ではなく、そのためにデータから Nullable カラムを読み込むことができませんでしたが、現在は修正されており、推論されたすべての型は常に Nullable になります（スキーマを読むだけではカラムが Nullable かどうかを判別できないため）。- CSV エスケープルールを用いる Template 形式でのスキーマ推論を修正しました。[#35582](https://github.com/ClickHouse/ClickHouse/pull/35582)（[Kruglov Pavel](https://github.com/Avogar)）。
* フォーマット `JSONAsObject` に対して並列パースとスキーマ推論を追加しました。 [#35592](https://github.com/ClickHouse/ClickHouse/pull/35592) ([Anton Popov](https://github.com/CurtizJ)).
* `s3Cluster` テーブル関数に自動スキーマ推論のサポートを追加しました。`s3` と `s3Cluster` のシグネチャを同期しました。[#35544](https://github.com/ClickHouse/ClickHouse/pull/35544) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* `hdfsCluster` のスキーマ推論をサポートしました。 [#35602](https://github.com/ClickHouse/ClickHouse/pull/35602) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* JSON入力フォーマットで bool 値を数値として推論・パースできるようにする新しい設定 `input_format_json_read_bools_as_numbers` を追加しました。デフォルトで有効です。@alexey-milovidov による提案。[#35735](https://github.com/ClickHouse/ClickHouse/pull/35735)（[Kruglov Pavel](https://github.com/Avogar)）。
* TSKV および JSONEachRow フォーマットのスキーマ推論におけるカラム順序付けを改善し、[#35640](https://github.com/ClickHouse/ClickHouse/issues/35640) をクローズ。TSKV および JSONEachRow フォーマットのスキーマ推論において、空行を読み取った場合でもスキーマ推論を停止しないようにした。[#35724](https://github.com/ClickHouse/ClickHouse/pull/35724) ([Kruglov Pavel](https://github.com/Avogar)).
* ORC、Arrow、Parquet ファイルからデータを読み取る際に、ClickHouse がカラム名を大文字小文字を区別せずに照合できるようにする設定 `input_format_orc_case_insensitive_column_matching`、`input_format_arrow_case_insensitive_column_matching`、`input_format_parquet_case_insensitive_column_matching` を追加しました。 [#35459](https://github.com/ClickHouse/ClickHouse/pull/35459) ([Antonio Andelic](https://github.com/antonio2368)).
* クライアントが TCP または HTTP 経由でセキュアな接続を使用しているかどうかを示す `is_secure` カラムを `system.query_log` に追加しました。 [#35705](https://github.com/ClickHouse/ClickHouse/pull/35705) ([Antonio Andelic](https://github.com/antonio2368)).
* これにより、リソースの少ないマシン（16コア未満）の場合でも、`kafka_num_consumers` を物理コア数より大きく設定できるようになりました。 [#35926](https://github.com/ClickHouse/ClickHouse/pull/35926) ([alesapin](https://github.com/alesapin)).
* engine=Kafka テーブルを監視するための基本的なメトリクスを追加しました。 [#35916](https://github.com/ClickHouse/ClickHouse/pull/35916) ([filimonov](https://github.com/filimonov)).
* MergeTree エンジンファミリーでは、存在しない設定に対して `ALTER TABLE ... RESET SETTING` を実行することはできなくなりました。[#35816](https://github.com/ClickHouse/ClickHouse/issues/35816) を修正。[#35884](https://github.com/ClickHouse/ClickHouse/pull/35884)（[alesapin](https://github.com/alesapin)）。
* 現在、`Arrays` 型および `Nullable` 型に対する一部の `ALTER MODIFY COLUMN` クエリは、ミューテーションを行わずにメタデータレベルだけで実行できるようになりました。たとえば、`Array(Enum8('Option1'=1))` から `Array(Enum8('Option1'=1, 'Option2'=2))` への変更などです。 [#35882](https://github.com/ClickHouse/ClickHouse/pull/35882) ([alesapin](https://github.com/alesapin)).
* クエリが実行中であることをユーザーに示すために、砂時計アイコンにアニメーションを追加しました。 [#35860](https://github.com/ClickHouse/ClickHouse/pull/35860) ([peledni](https://github.com/peledni)).
* ALTER TABLE t DETACH PARTITION (ALL) をサポートしました。 [#35794](https://github.com/ClickHouse/ClickHouse/pull/35794) ([awakeljw](https://github.com/awakeljw)).
* `count()` のような単純なクエリを最適化するために、プロジェクション解析を改善しました。 [#35788](https://github.com/ClickHouse/ClickHouse/pull/35788) ([Amos Bird](https://github.com/amosbird)).
* `input` テーブル関数を使用した `INSERT SELECT` でスキーマ推論をサポートしました。スキーマ推論をサポートするテーブル関数からの `INSERT SELECT` の場合、データからではなく挿入先テーブルからスキーマを取得するようにしました。[#35639](https://github.com/ClickHouse/ClickHouse/issues/35639) をクローズ。[#35760](https://github.com/ClickHouse/ClickHouse/pull/35760)（[Kruglov Pavel](https://github.com/Avogar)）。
* Hive テーブルに対して `remote_url_allow_hosts` を遵守するようにしました。 [#35743](https://github.com/ClickHouse/ClickHouse/pull/35743) ([李扬](https://github.com/taiyang-li)).
* clickhouse-local に `send_logs_level` を実装。 [#35653](https://github.com/ClickHouse/ClickHouse/issues/35653) をクローズ。 [#35716](https://github.com/ClickHouse/ClickHouse/pull/35716)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* [#35641](https://github.com/ClickHouse/ClickHouse/issues/35641) をクローズ。`EPHEMERAL` カラムで明示的なデフォルト式を指定せずに使用できるようにした。[#35706](https://github.com/ClickHouse/ClickHouse/pull/35706)（[Yakov Olkhovskiy](https://github.com/yakov-olkhovskiy)）。
* 非同期 INSERT のサイズを示すプロファイルイベントカウンタ `AsyncInsertBytes` を追加しました。 [#35644](https://github.com/ClickHouse/ClickHouse/pull/35644) ([Alexey Milovidov](https://github.com/alexey-milovidov)).
* JOIN のパイプラインの記述を改善しました。 [#35612](https://github.com/ClickHouse/ClickHouse/pull/35612) ([何李夫](https://github.com/helifu)).
* 絶対パスの hdfs 設定ファイルを推論するようにしました。 [#35572](https://github.com/ClickHouse/ClickHouse/pull/35572) ([李扬](https://github.com/taiyang-li)).
* clickhouse-client の貼り付け時のパフォーマンスと互換性を改善しました。これにより [#35501](https://github.com/ClickHouse/ClickHouse/issues/35501) が解決されます。[#35541](https://github.com/ClickHouse/ClickHouse/pull/35541)（[Amos Bird](https://github.com/amosbird)）。
* 分散クエリにおいて、`async_socket_for_remote` と `use_hedged_requests` のいずれかの設定が有効な状態で非常に深くネストしたデータ型をパースすると、スタックオーバーフローが発生する可能性がありました（少なくともデバッグビルドで）。[#35509](https://github.com/ClickHouse/ClickHouse/issues/35509) をクローズします。[#35524](https://github.com/ClickHouse/ClickHouse/pull/35524)（[Kruglov Pavel](https://github.com/Avogar)）。
* `system.parts_columns` テーブルにサブカラムのサイズ情報を追加。 [#35488](https://github.com/ClickHouse/ClickHouse/pull/35488) ([Anton Popov](https://github.com/CurtizJ))。
* クエリプランおよびパイプラインのスキャンノードにテーブル情報を明示的に追加しました。 [#35460](https://github.com/ClickHouse/ClickHouse/pull/35460) ([何李夫](https://github.com/helifu)).
* サーバーが小さい番号のポート（例: 443）にバインドできるようにしました。ClickHouse のインストールスクリプトはバイナリファイルに `cap_net_bind_service` を設定します。 [#35451](https://github.com/ClickHouse/ClickHouse/pull/35451) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* `INSERT INTO table FROM INFILE` の問題を修正しました。進行状況バーが表示されていませんでした。 [#35429](https://github.com/ClickHouse/ClickHouse/pull/35429) ([xiedeyantu](https://github.com/xiedeyantu)).
* `clickhouse-diagnostics` ツールに `--user`、`--password`、`--host`、`--port` 引数を追加しました。 [#35422](https://github.com/ClickHouse/ClickHouse/pull/35422) ([李扬](https://github.com/taiyang-li)).
* Postgres エンジンで UUID をサポート。 [#35384](https://github.com/ClickHouse/ClickHouse/issues/35384) をクローズ。 [#35403](https://github.com/ClickHouse/ClickHouse/pull/35403)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* テーブル関数 `s3cluster`、`HDFSCluster`、`hive` では、`StorageFactory::instance().getSourceAccessType(getStorageTypeName())` によって正しい `AccessType` を取得できません。この PR でその問題を修正しました。 [#35365](https://github.com/ClickHouse/ClickHouse/pull/35365) ([李扬](https://github.com/taiyang-li)).
* clickhouse-client の `--testmode` オプションを削除し、無条件に有効化しました。 [#35354](https://github.com/ClickHouse/ClickHouse/pull/35354) ([Kseniia Sumarokova](https://github.com/kssenii)).
* clickhouse-keeper に対して `wchc` 操作（4 文字コマンド）を許可しないようにしました。 [#35320](https://github.com/ClickHouse/ClickHouse/pull/35320) ([zhangyuli1](https://github.com/zhangyuli1))。
* 関数 `getTypeSerializationStreams` を追加しました。指定された型（カラムから検出される）に対して、そのシリアライゼーションに含まれるすべてのサブストリームパスを要素とする配列を返します。この関数は主に開発者向けです。[#35290](https://github.com/ClickHouse/ClickHouse/pull/35290) ([李扬](https://github.com/taiyang-li))。
* クラスタ設定で `port` が指定されていない場合、デフォルトのサーバーポートが使用されます。これにより [#34769](https://github.com/ClickHouse/ClickHouse/issues/34769) が解決されました。[#34772](https://github.com/ClickHouse/ClickHouse/pull/34772)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* Hive Engine で ORC/Parquet ファイルに `minmax` インデックスを使用。関連 PR: [https://github.com/ClickHouse/arrow/pull/10](https://github.com/ClickHouse/arrow/pull/10)。[#34631](https://github.com/ClickHouse/ClickHouse/pull/34631)（[李扬](https://github.com/taiyang-li)）。
* システムログテーブルで、ENGINE 宣言内に COMMENT を指定できるようになりました。 [#33768](https://github.com/ClickHouse/ClickHouse/issues/33768) をクローズ。[#34536](https://github.com/ClickHouse/ClickHouse/pull/34536)（[Maksim Kita](https://github.com/kitaisreal)）。
* ソートキー順での読み取りかつ `LIMIT` が指定されている場合における `max_rows_to_read` 設定の正しいサポートを行いました。これにより、実際にはより少ない行数だけを読み取ればよいクエリであっても、以前は `Limit for rows or bytes to read exceeded` という例外がスローされていた問題が修正されました。 [#33230](https://github.com/ClickHouse/ClickHouse/pull/33230) ([Anton Popov](https://github.com/CurtizJ)).
* cgroups からは quota と period のみを参照し、shares は無視する（shares は実際には使用可能なコア数を制限しないため）。 [#35815](https://github.com/ClickHouse/ClickHouse/pull/35815) ([filimonov](https://github.com/filimonov)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-8}

- 機能テストにランダム化設定の次のバッチを追加。[#35047](https://github.com/ClickHouse/ClickHouse/pull/35047) ([Kruglov Pavel](https://github.com/Avogar))。
- ストレステストに後方互換性チェックを追加。[#25088](https://github.com/ClickHouse/ClickHouse/issues/25088)をクローズ。[#27928](https://github.com/ClickHouse/ClickHouse/pull/27928) ([Kruglov Pavel](https://github.com/Avogar))。
- パッケージビルドを`nfpm`に移行 - `release`スクリプトを非推奨とし`packages/build`を優先 - clickhouse/binary-builderイメージですべてをビルド(クリーンアップ: clickhouse/deb-builder) - cmakeにシンボルストリッピングを追加(todo: $prefix/lib/$bin_dir/clickhouse/$binary.debugを使用) - DWARFシンボルの問題を修正 - Alpine APKパッケージを追加 - `alien`を`additional_pkgs`に名称変更。[#33664](https://github.com/ClickHouse/ClickHouse/pull/33664) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- Coverityの夜間スキャンとアップロードを追加。[#34895](https://github.com/ClickHouse/ClickHouse/pull/34895) ([Boris Kuschel](https://github.com/bkuschel))。
- `clickhouse-keeper`専用の小型パッケージを追加。[#35308](https://github.com/ClickHouse/ClickHouse/pull/35308) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- podmanでの実行が失敗していた問題を修正:同じボリュームを2回指定することについて警告が出ていた。[#35978](https://github.com/ClickHouse/ClickHouse/pull/35978) ([Roman Nikonov](https://github.com/nic11))。
- contrib/krb5ビルド設定の軽微な改善。[#35832](https://github.com/ClickHouse/ClickHouse/pull/35832) ([Anton Kozlov](https://github.com/tonickkozlov))。
- 各イメージのビルドタスクを認識するためのラベルを追加。[#35583](https://github.com/ClickHouse/ClickHouse/pull/35583) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- Pythonコードに`black`フォーマッターを適用し、コミットごとのチェックを追加。[#35466](https://github.com/ClickHouse/ClickHouse/pull/35466) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- クリーンなDockerfileを使用するようalpineイメージを再構築。tests/ciにubuntuとalpineの両方のイメージをビルドするスクリプトを作成。clickhouse-keeperイメージを追加(cc @nikitamikhaylov)。PullRequestCIにビルドチェックを追加。ReleaseCIにジョブを追加。MasterCIにジョブを追加し、マージされた各PRに対して`clickhouse/clickhouse-server:head`と`clickhouse/clickhouse-keeper:head`イメージをビルドおよびプッシュ。[#35211](https://github.com/ClickHouse/ClickHouse/pull/35211) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- CIのストレステストレポートを修正、開始されたストレステストに関する情報を含むrunlogを1回のみアップロードするように変更。[#35093](https://github.com/ClickHouse/ClickHouse/pull/35093) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- LLVM 14のlibcxx / libcxxabiに切り替え。[#34906](https://github.com/ClickHouse/ClickHouse/pull/34906) ([Raúl Marín](https://github.com/Algunenano))。
- CVE-2018-7485を軽減するためunixodbcを更新。注:このCVEはClickHouseには関係ありません。ClickHouseはODBC用の独自の分離レイヤーを実装しているためです。[#35943](https://github.com/ClickHouse/ClickHouse/pull/35943) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。

#### バグ修正 {#bug-fix-4}


* テーブルに無効な IP アドレス値をデフォルト値として挿入できるようにするため、`input_format_ipv4_default_on_conversion_error` と `input_format_ipv6_default_on_conversion_error` の設定を追加しました。[#35726](https://github.com/ClickHouse/ClickHouse/issues/35726) をクローズ。[#35733](https://github.com/ClickHouse/ClickHouse/pull/35733)（[Maksim Kita](https://github.com/kitaisreal)）。
* Hive からデータを読み取る際に、存在しない列をブロックから削除しないようにしました。 [#35393](https://github.com/ClickHouse/ClickHouse/pull/35393) ([lgbo](https://github.com/lgbo-ustc)).
* マテリアライズドビューの作成時に型チェックを追加。クローズ: [#23684](https://github.com/ClickHouse/ClickHouse/issues/23684)。[#24896](https://github.com/ClickHouse/ClickHouse/pull/24896)（[hexiaoting](https://github.com/hexiaoting)）。
* INSERT INFILE クエリのフォーマット（引用符の欠落）を修正しました。 [#35886](https://github.com/ClickHouse/ClickHouse/pull/35886) ([Azat Khuzhin](https://github.com/azat)).
* `session_log` を無効化しました。ファジングによりメモリ安全性の問題が見つかったためです。[#35714](https://github.com/ClickHouse/ClickHouse/issues/35714) を参照してください。[#35873](https://github.com/ClickHouse/ClickHouse/pull/35873)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* カラム単位の TTL が複数回処理されないようにしました。 [#35820](https://github.com/ClickHouse/ClickHouse/pull/35820) ([Azat Khuzhin](https://github.com/azat)).
* 挿入クエリに複数のパーティションに関連するデータが含まれる場合の、`Object` 型カラムへの挿入処理を修正しました。 [#35806](https://github.com/ClickHouse/ClickHouse/pull/35806) ([Anton Popov](https://github.com/CurtizJ)).
* -WithNames フォーマットにおいて、存在しない列のインデックスに起因し、列数が 256 を超える場合に `INCORRECT_NUMBER_OF_COLUMNS` エラーが発生していたバグを修正しました。 [#35793](https://github.com/ClickHouse/ClickHouse/issues/35793) をクローズ。 [#35803](https://github.com/ClickHouse/ClickHouse/pull/35803)（[Kruglov Pavel](https://github.com/Avogar)）。
* [#35751](https://github.com/ClickHouse/ClickHouse/issues/35751) を修正。[#35799](https://github.com/ClickHouse/ClickHouse/pull/35799)（[Nikolay Degterinsky](https://github.com/evillique)）。
* Snappy フォーマットの HDFS からの読み取りに対する修正。 [#35771](https://github.com/ClickHouse/ClickHouse/pull/35771) ([shuchaome](https://github.com/shuchaome)).
* カスタム型から文字列への変換で、セグメンテーションフォルトや予期しないエラーメッセージが発生する可能性のあったバグを修正しました。[#35752](https://github.com/ClickHouse/ClickHouse/issues/35752) をクローズしました。[#35755](https://github.com/ClickHouse/ClickHouse/pull/35755)（[Kruglov Pavel](https://github.com/Avogar)）。
* 任意／すべての（サブクエリ）実装を修正。 [#35489](https://github.com/ClickHouse/ClickHouse/issues/35489) をクローズ。 [#35727](https://github.com/ClickHouse/ClickHouse/pull/35727)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* clickhouse-local における非空データベースの削除処理を修正。[#35692](https://github.com/ClickHouse/ClickHouse/issues/35692) をクローズ。[#35711](https://github.com/ClickHouse/ClickHouse/pull/35711)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* サーバー再起動後にサブクエリ付きマテリアライズドビューを作成する際のバグを修正。サーバー再起動後、基盤テーブルへの挿入が行われてもマテリアライズドビューが更新されていませんでした。[#35511](https://github.com/ClickHouse/ClickHouse/issues/35511) をクローズ。[#35691](https://github.com/ClickHouse/ClickHouse/pull/35691)（[Kruglov Pavel](https://github.com/Avogar)）。
* 実験的な型 `Object` のサブカラム読み取り時に発生する可能性のある `Can't adjust last granule` 例外を修正。 [#35687](https://github.com/ClickHouse/ClickHouse/pull/35687) ([Anton Popov](https://github.com/CurtizJ)).
* JIT コンパイルを用いたビルドをデフォルトで有効にしました。 [#35683](https://github.com/ClickHouse/ClickHouse/pull/35683) ([Maksim Kita](https://github.com/kitaisreal)).
* 実験的な型 `Object` でサブカラムが失われる可能性がある問題を修正。 [#35682](https://github.com/ClickHouse/ClickHouse/pull/35682) ([Anton Popov](https://github.com/CurtizJ)).
* ASOF JOIN キーの NULL 許容性チェックを修正。 [#35565](https://github.com/ClickHouse/ClickHouse/issues/35565) をクローズ。 [#35674](https://github.com/ClickHouse/ClickHouse/pull/35674) ([Vladimir C](https://github.com/vdimir))。
* 投影を含むパーツに対するパーツ検査ロジックを修正しました。投影とメインパーツの型が異なる場合にエラーが発生していました。これは [https://github.com/ClickHouse/ClickHouse/pull/33774](https://github.com/ClickHouse/ClickHouse/pull/33774) と類似しています。このバグは @caoyang10 によって修正されました。 [#35667](https://github.com/ClickHouse/ClickHouse/pull/35667) ([Amos Bird](https://github.com/amosbird))。
* `format` 関数に多数の引数が渡されたときにサーバーがクラッシュする問題を修正しました。テストファイルを参照し、クラッシュの再現方法を確認してください。 [#35651](https://github.com/ClickHouse/ClickHouse/pull/35651) ([Amos Bird](https://github.com/amosbird)).
* 非同期挿入におけるクオータの扱いを修正しました。 [#35645](https://github.com/ClickHouse/ClickHouse/pull/35645) ([Anton Popov](https://github.com/CurtizJ)).
* エイリアス付き位置引数を修正。[#35600](https://github.com/ClickHouse/ClickHouse/issues/35600) をクローズ。[#35620](https://github.com/ClickHouse/ClickHouse/pull/35620)（[Kseniia Sumarokova](https://github.com/kssenii) による変更）。
* URL エンジンでスキーマ推論を行う前に `remote_url_allow_hosts` をチェックするように変更。 [#35064](https://github.com/ClickHouse/ClickHouse/issues/35064) をクローズ。 [#35619](https://github.com/ClickHouse/ClickHouse/pull/35619)（[Kruglov Pavel](https://github.com/Avogar)）。
* `LowCardinality` 型のカラムが使用されている場合の `HashJoin` を修正しました。これにより、[#35548](https://github.com/ClickHouse/ClickHouse/issues/35548) がクローズされます。[#35616](https://github.com/ClickHouse/ClickHouse/pull/35616)（[Antonio Andelic](https://github.com/antonio2368)）。
* メモリ上に収集されたデータを基盤となるテーブルに同期する際に例外が発生した場合に起こり得た、MaterializedPostgreSQL のセグメンテーションフォルトを修正しました。[#35611](https://github.com/ClickHouse/ClickHouse/issues/35611) をクローズ。[#35614](https://github.com/ClickHouse/ClickHouse/pull/35614) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 以前にデタッチしたテーブルがまだ使用中の状態で `ATTACH TABLE` クエリに対して `database_atomic_wait_for_drop_and_detach_synchronously` を設定した場合の動作が正しくありませんでしたが、修正されました。 [#35594](https://github.com/ClickHouse/ClickHouse/pull/35594) ([tavplubix](https://github.com/tavplubix)).
* 名前付きコレクションによる HTTP ヘッダーを修正し、compression&#95;method を追加。[#35273](https://github.com/ClickHouse/ClickHouse/issues/35273) をクローズ。[#35269](https://github.com/ClickHouse/ClickHouse/issues/35269) をクローズ。[#35593](https://github.com/ClickHouse/ClickHouse/pull/35593)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* s3 エンジンの仮想カラム取得に関する問題を修正。[#35411](https://github.com/ClickHouse/ClickHouse/issues/35411) をクローズ。[#35586](https://github.com/ClickHouse/ClickHouse/pull/35586)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `caseWithExpression` の戻り値型推論を修正しました。ELSE ブランチの型が正しく考慮されるようになりました。 [#35576](https://github.com/ClickHouse/ClickHouse/pull/35576) ([Antonio Andelic](https://github.com/antonio2368))。
* 39文字を超える IPv6 アドレスのパースを修正しました。[#34022](https://github.com/ClickHouse/ClickHouse/issues/34022) をクローズ。[#35539](https://github.com/ClickHouse/ClickHouse/pull/35539)（[Maksim Kita](https://github.com/kitaisreal)）。
* IN 句における IPv4、IPv6 アドレスへの `CAST` を修正。 [#35528](https://github.com/ClickHouse/ClickHouse/issues/35528) を解決。 [#35534](https://github.com/ClickHouse/ClickHouse/pull/35534)（[Maksim Kita](https://github.com/kitaisreal)）。
* 引数の一つが Nullable な定数である場合の短絡評価中に発生するクラッシュを修正。[#35497](https://github.com/ClickHouse/ClickHouse/issues/35497) をクローズ。[#35496](https://github.com/ClickHouse/ClickHouse/issues/35496) をクローズ。 [#35502](https://github.com/ClickHouse/ClickHouse/pull/35502)（[Maksim Kita](https://github.com/kitaisreal)）。
* 定数引数を取る関数 `throwIf` のクラッシュを修正しました。 [#35500](https://github.com/ClickHouse/ClickHouse/pull/35500) ([Maksim Kita](https://github.com/kitaisreal)).
* Keeper においてクライアント接続が不安定になる可能性のあるバグを修正しました。[#35031](https://github.com/ClickHouse/ClickHouse/issues/35031) で導入されたものです。[#35498](https://github.com/ClickHouse/ClickHouse/pull/35498)（[alesapin](https://github.com/alesapin)）。
* 関数 `if` において、結果のカラム型が結果のデータ型と異なる場合に `Logical error: 'Bad cast from type DB::ColumnVector<int> to DB::ColumnVector<long>'.` のような論理エラーを引き起こしていたバグを修正しました。[#35367](https://github.com/ClickHouse/ClickHouse/issues/35367) をクローズしました。 [#35476](https://github.com/ClickHouse/ClickHouse/pull/35476)（[Kruglov Pavel](https://github.com/Avogar)）。
* MergeTree のバックエンドとして、または個別のテーブルエンジン/関数として S3 を使用した際の過剰なログ出力を修正しました。 [#30559](https://github.com/ClickHouse/ClickHouse/issues/30559) を修正。 [#35434](https://github.com/ClickHouse/ClickHouse/pull/35434)（[alesapin](https://github.com/alesapin)）。
* これからは、ゼロコピーレプリケーション（実験的）で実行されるマージによって、`Found parts with the same min block and with the same max block as the missing part _ on replica _. Hoping that it will eventually appear as a result of a merge.` というメッセージがログに大量出力されることはありません。 [#35430](https://github.com/ClickHouse/ClickHouse/pull/35430) ([alesapin](https://github.com/alesapin))。
* GroupingAggregatedTransform で空のチャンクが現れた場合に発生し得る例外を無視するようにしました。 [#35417](https://github.com/ClickHouse/ClickHouse/pull/35417) ([Nikita Taranov](https://github.com/nickitat)).
* Arrow/Parquet/ORC 形式において、クエリで使用されない列の扱いを修正しました。これにより、ファイルにサポートされていない型の列が含まれていても、その列をクエリで使用しない場合には、`Unsupported &lt;format&gt; type &lt;type&gt; of an input column &lt;column_name&gt;` のようなエラーが発生しないようになります。 [#35406](https://github.com/ClickHouse/ClickHouse/pull/35406) ([Kruglov Pavel](https://github.com/Avogar)).
* リモートファイルシステム向けローカルキャッシュ（実験的機能）において、高い同時実行性が発生するコーナーケースでの問題を修正。 [#35381](https://github.com/ClickHouse/ClickHouse/pull/35381) ([Kseniia Sumarokova](https://github.com/kssenii))。キャッシュで発生しうるデッドロックを修正。 [#35378](https://github.com/ClickHouse/ClickHouse/pull/35378) ([Kseniia Sumarokova](https://github.com/kssenii))。
* `WHERE` で定数との比較を行う場合のパーティションプルーニングを修正しました。カラムと定数の型が異なる場合にオーバーフローが発生する可能性があり、その結果、クエリが誤って空の結果を返すことがありました。これにより [#35304](https://github.com/ClickHouse/ClickHouse/issues/35304) が修正されました。 [#35334](https://github.com/ClickHouse/ClickHouse/pull/35334) ([Amos Bird](https://github.com/amosbird))。
* 小さい max&#95;read&#95;buffer&#95;size を使用している場合の TSKV 形式のスキーマ推論を修正しました。 [#35332](https://github.com/ClickHouse/ClickHouse/pull/35332) ([Kruglov Pavel](https://github.com/Avogar)).
* スパースカラムが有効なテーブルでのミューテーションを修正しました。 [#35284](https://github.com/ClickHouse/ClickHouse/pull/35284) ([Anton Popov](https://github.com/CurtizJ)).
* デフォルトでファイナルパートの書き込みを遅延しないようにしました（`max_insert_delayed_streams_for_parallel_write` を追加し、S3 への書き込み時のデフォルトを 1000 に設定し、それ以外では従来どおり無効のままとすることで、`INSERT` 中に発生しうる `Memory limit exceeded` を回避）。[#34780](https://github.com/ClickHouse/ClickHouse/pull/34780)（[Azat Khuzhin](https://github.com/azat)）。

### <a id="223"></a> ClickHouse release v22.3-lts, 2022-03-17 {#a-id223a-clickhouse-release-v223-lts-2022-03-17}

#### 後方互換性のない変更 {#backward-incompatible-change-6}

- `arrayCompact`関数を他の高階関数と同様に動作するように変更:ラムダ関数の結果ではなく、元の配列に対して圧縮を実行します。arrayCompactで非自明なラムダ関数を使用している場合は、`arrayCompact`の引数を`arrayMap`でラップすることで以前の動作を復元できます。Closes [#34010](https://github.com/ClickHouse/ClickHouse/issues/34010) [#18535](https://github.com/ClickHouse/ClickHouse/issues/18535) [#14778](https://github.com/ClickHouse/ClickHouse/issues/14778). [#34795](https://github.com/ClickHouse/ClickHouse/pull/34795) ([Alexandre Snarskii](https://github.com/snar)).
- `toDatetime`関数のオーバーフロー時の実装固有の動作を変更しました。ラップアラウンドではなく、サポートされているdatetimeの最小値/最大値に飽和するようになります。この変更は、意図せず以前の動作に依存している可能性があるため、「後方互換性のない変更」として強調されています。[#32898](https://github.com/ClickHouse/ClickHouse/pull/32898) ([HaiBo Li](https://github.com/marising)).
- 関数`cast(value, 'IPv4')`、`cast(value, 'IPv6')`を`toIPv4`、`toIPv6`関数と同じ動作にしました。関数`toIPv4`、`toIPv6`に渡される不正なIPアドレスの動作を変更しました。現在、無効なIPアドレスがこれらの関数に渡されると例外が発生します。以前はデフォルト値を返していました。関数`IPv4StringToNumOrDefault`、`IPv4StringToNumOrNull`、`IPv6StringToNumOrDefault`、`IPv6StringOrNull`、`toIPv4OrDefault`、`toIPv4OrNull`、`toIPv6OrDefault`、`toIPv6OrNull`を追加しました。以前のロジックが無効なアドレスに対してデフォルト値を返す`IPv4StringToNum`、`toIPv4`、`toIPv6`に依存していた場合は、関数`IPv4StringToNumOrDefault`、`toIPv4OrDefault`、`toIPv6OrDefault`を使用する必要があります。設定`cast_ipv4_ipv6_default_on_conversion_error`を追加しました。この設定が有効な場合、IPアドレス変換関数は以前と同じ動作をします。Closes [#22825](https://github.com/ClickHouse/ClickHouse/issues/22825). Closes [#5799](https://github.com/ClickHouse/ClickHouse/issues/5799). Closes [#35156](https://github.com/ClickHouse/ClickHouse/issues/35156). [#35240](https://github.com/ClickHouse/ClickHouse/pull/35240) ([Maksim Kita](https://github.com/kitaisreal)).

#### 新機能 {#new-feature-9}


- リモートファイルシステムのデータをローカルにキャッシュする機能をサポートしました。`s3`ディスクで有効化できます。[#28961](https://github.com/ClickHouse/ClickHouse/issues/28961)をクローズします。[#33717](https://github.com/ClickHouse/ClickHouse/pull/33717) ([Kseniia Sumarokova](https://github.com/kssenii))。また、s3ファイルシステム上でテストスイートを有効化し、既知の問題が存在しなくなったため、本番環境での使用準備が整いました。
- 新しいテーブル関数`hive`を追加しました。次のように使用できます：`hive('<hive metastore url>', '<hive database>', '<hive table name>', '<columns definition>', '<partition columns>')`。例：`SELECT * FROM hive('thrift://hivetest:9083', 'test', 'demo', 'id Nullable(String), score Nullable(Int32), day Nullable(String)', 'day')`。[#34946](https://github.com/ClickHouse/ClickHouse/pull/34946) ([lgbo](https://github.com/lgbo-ustc))。
- SSL経由で接続するユーザーのX.509証明書による認証をサポートしました。[#31484](https://github.com/ClickHouse/ClickHouse/pull/31484) ([eungenue](https://github.com/eungenue))。
- テーブル関数`file`/`hdfs`/`s3`/`url`への挿入時のスキーマ推論をサポートしました。[#34732](https://github.com/ClickHouse/ClickHouse/pull/34732) ([Kruglov Pavel](https://github.com/Avogar))。
- パスの制限なしまたは`like`式を使用して`system.zookeeper`テーブルを読み取れるようになりました。この読み取りはZooKeeperに対してかなり重い負荷を生成する可能性があるため、この機能を有効にするには設定`allow_unrestricted_reads_from_keeper`を有効化する必要があります。[#34609](https://github.com/ClickHouse/ClickHouse/pull/34609) ([Sergei Trifonov](https://github.com/serxa))。
- clickhouse-localでCPUとメモリのメトリクスを表示するようにしました。[#34545](https://github.com/ClickHouse/ClickHouse/issues/34545)をクローズします。[#34605](https://github.com/ClickHouse/ClickHouse/pull/34605) ([李扬](https://github.com/taiyang-li))。
- 配列用の`startsWith`および`endsWith`関数を実装しました。[#33982](https://github.com/ClickHouse/ClickHouse/issues/33982)をクローズします。[#34368](https://github.com/ClickHouse/ClickHouse/pull/34368) ([usurai](https://github.com/usurai))。
- Mapデータ型用の3つの関数を追加しました：1. `mapReplace(map1, map2)` - map1のキーの値をmap2の対応するキーの値で置き換え、map1に存在しないmap2のキーを追加します。2. `mapFilter` 3. `mapMap`。mapFilterとmapMapは高階関数で、2つの引数を受け取ります。第1引数はk、vペアを引数とするラムダ関数、第2引数はMap型のカラムです。[#33698](https://github.com/ClickHouse/ClickHouse/pull/33698) ([hexiaoting](https://github.com/hexiaoting))。
- clickhouse-clientのデフォルトユーザーとパスワードを環境変数`CLICKHOUSE_USER`と`CLICKHOUSE_PASSWORD`から取得できるようにしました。[#34538](https://github.com/ClickHouse/ClickHouse/issues/34538)をクローズします。[#34947](https://github.com/ClickHouse/ClickHouse/pull/34947) ([DR](https://github.com/freedomDR))。

#### 実験的機能 {#experimental-feature-8}

- 半構造化データの保存をサポートする新しいデータ型`Object(<schema_format>)`を追加しました（現在はJSONのみ）。データは文字列としてこの型に書き込まれます。その後、半構造化データの形式に従ってすべてのパスが抽出され、すべての値を保存できる最適な型で個別のカラムとして書き込まれます。これらのカラムは、ソースデータのパスと一致する名前でクエリできます。例：`data.key1.key2`またはキャスト演算子を使用して`data.key1.key2::Int64`。
- `database_replicated_allow_only_replicated_engine`設定を追加しました。有効にすると、`Replicated`データベース内で`Replicated`テーブルまたはステートレスエンジンを持つテーブルのみを作成できるようになります。[#35214](https://github.com/ClickHouse/ClickHouse/pull/35214) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。`Replicated`データベースは依然として実験的機能であることに注意してください。

#### パフォーマンス改善 {#performance-improvement-9}


- ソートの最適化により、`MergeTree`テーブルへの挿入パフォーマンスを改善しました。実用的なベンチマークで最大2倍の改善が確認されています。[#34750](https://github.com/ClickHouse/ClickHouse/pull/34750) ([Maksim Kita](https://github.com/kitaisreal))。
- URLおよびS3からParquet、ORC、Arrowファイルを読み取る際のカラムプルーニング。[#34163](https://github.com/ClickHouse/ClickHouse/issues/34163)を解決。[#34849](https://github.com/ClickHouse/ClickHouse/pull/34849) ([Kseniia Sumarokova](https://github.com/kssenii))。
- HiveからParquet、ORC、Arrowファイルを読み取る際のカラムプルーニング。[#34954](https://github.com/ClickHouse/ClickHouse/pull/34954) ([lgbo](https://github.com/lgbo-ustc))。
- パフォーマンスの専門家による多数のパフォーマンス最適化。大規模な`IN`句を含むクエリの処理パフォーマンスを改善しました。ソースが`ClickHouse`である場合の`direct`ディクショナリのパフォーマンスを改善しました。`detectCharset`、`detectLanguageUnknown`関数のパフォーマンスを改善しました。[#34888](https://github.com/ClickHouse/ClickHouse/pull/34888) ([Maksim Kita](https://github.com/kitaisreal))。
- バッチ処理の活用により、`any`集約関数のパフォーマンスを改善しました。[#34760](https://github.com/ClickHouse/ClickHouse/pull/34760) ([Raúl Marín](https://github.com/Algunenano))。
- `clickhouse-keeper`のパフォーマンスに関する複数の改善: ロックの削減 [#35010](https://github.com/ClickHouse/ClickHouse/pull/35010) ([zhanglistar](https://github.com/zhanglistar))、完全コピーの代わりにスナップショットのストリーミング読み取りおよび書き込みによるメモリ使用量の削減 [#34584](https://github.com/ClickHouse/ClickHouse/pull/34584) ([zhanglistar](https://github.com/zhanglistar))、RAFT実装におけるログストアのコンパクション最適化 [#34534](https://github.com/ClickHouse/ClickHouse/pull/34534) ([zhanglistar](https://github.com/zhanglistar))、内部データ構造のバージョン管理 [#34486](https://github.com/ClickHouse/ClickHouse/pull/34486) ([zhanglistar](https://github.com/zhanglistar))。

#### 改善 {#improvement-9}


* テーブル関数への非同期挿入を許可します。 [#34864](https://github.com/ClickHouse/ClickHouse/issues/34864) を修正します。 [#34866](https://github.com/ClickHouse/ClickHouse/pull/34866)（[Anton Popov](https://github.com/CurtizJ)）。
* 関数 `dictGetHierarchy`、`dictIsIn`、`dictGetChildren`、`dictGetDescendants` におけるキー引数の暗黙的な型キャストに対応。 [#34970](https://github.com/ClickHouse/ClickHouse/issues/34970) をクローズ。 [#35027](https://github.com/ClickHouse/ClickHouse/pull/35027)（[Maksim Kita](https://github.com/kitaisreal)）。
* `EXPLAIN AST` クエリで、AST を Graphviz 形式のグラフとして出力できるようになりました: `EXPLAIN AST graph = 1 SELECT * FROM system.parts`。 [#35173](https://github.com/ClickHouse/ClickHouse/pull/35173) ([李扬](https://github.com/taiyang-li))。
* 大きなファイルを `s3` テーブル関数またはテーブルエンジンで書き込んだ際、AWS SDK のバグによりファイルの Content-Type が誤って `application/xml` に設定されていました。この変更により [#33964](https://github.com/ClickHouse/ClickHouse/issues/33964) が解決されました。[#34433](https://github.com/ClickHouse/ClickHouse/pull/34433)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* 制限的な行ポリシーを一部変更し、単純なケースにおいて許可的ポリシーを用いるよりも簡単な代替手段となるようにしました。特定のテーブルに対して制限的ポリシーのみが存在し（許可的ポリシーが存在しない）場合でも、ユーザーはいくつかの行を参照できるようになります。また、`SHOW CREATE ROW POLICY` は、行ポリシーの定義において常に `AS permissive` または `AS restrictive` を表示するようになりました。[#34596](https://github.com/ClickHouse/ClickHouse/pull/34596)（[Vitaly Baranov](https://github.com/vitlibar)）。
* File/S3/HDFS/URL エンジンにおけるグロブを用いたスキーマ推論を改善。エラー発生時には、スキーマ推論のために次のパスを使用するよう試行するようにしました。 [#34465](https://github.com/ClickHouse/ClickHouse/pull/34465) ([Kruglov Pavel](https://github.com/Avogar)).
* Play UI が OS のライト/ダークの優先テーマを正しく検出するようになりました。 [#35068](https://github.com/ClickHouse/ClickHouse/pull/35068) ([peledni](https://github.com/peledni)).
* `date_time_input_format = 'best_effort_us'` を追加しました。 [#34799](https://github.com/ClickHouse/ClickHouse/issues/34799) をクローズしました。 [#34982](https://github.com/ClickHouse/ClickHouse/pull/34982) （[WenYao](https://github.com/Cai-Yao)）。
* `allow_plaintext_password` と `allow_no_password` という新しい設定がサーバー設定に追加され、一部の環境では潜在的に安全性に問題がある認証タイプを有効／無効にできるようになりました。これらはデフォルトで有効になっています。 [#34738](https://github.com/ClickHouse/ClickHouse/pull/34738) ([Heena Bansal](https://github.com/HeenaBansal2009)).
* `Arrow` フォーマットでの `DateTime64` データ型のサポート。[#8280](https://github.com/ClickHouse/ClickHouse/issues/8280) および [#28574](https://github.com/ClickHouse/ClickHouse/issues/28574) をクローズ。[#34561](https://github.com/ClickHouse/ClickHouse/pull/34561)（[李扬](https://github.com/taiyang-li)）。
* 設定更新時に `remote_url_allow_hosts`（送信接続のフィルタリング）を再読み込みするようにしました。 [#35294](https://github.com/ClickHouse/ClickHouse/pull/35294) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `clickhouse-local` で `--testmode` パラメーターをサポートしました。このパラメーターにより、機能テストで使用しているテストヒントの解釈が可能になります。 [#35264](https://github.com/ClickHouse/ClickHouse/pull/35264) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `distributed_depth` を query log に追加しました。これは `is_initial_query` をより詳細化したものです [#35207](https://github.com/ClickHouse/ClickHouse/pull/35207) ([李扬](https://github.com/taiyang-li))。
* `MySQL` および `PostgreSQL` テーブル関数で `remote_url_allow_hosts` を尊重するようにしました。 [#35191](https://github.com/ClickHouse/ClickHouse/pull/35191) ([Heena Bansal](https://github.com/HeenaBansal2009)).
* `system.part_log` に `disk_name` フィールドを追加しました。 [#35178](https://github.com/ClickHouse/ClickHouse/pull/35178) ([Artyom Yurkov](https://github.com/Varinara))。
* リモートURLをクエリする際に、再試行不可のエラーは再試行しないようにしました。[#35161](https://github.com/ClickHouse/ClickHouse/issues/35161) をクローズ。[#35172](https://github.com/ClickHouse/ClickHouse/pull/35172)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 分散 `INSERT SELECT` クエリ（設定 `parallel_distributed_insert_select`）でテーブル関数 `view()` をサポートしました。[#35132](https://github.com/ClickHouse/ClickHouse/pull/35132) ([Azat Khuzhin](https://github.com/azat)).
* `AggregateFunction` を含む `Buffer` への `INSERT` 実行時のメモリトラッキングをより正確に。 [#35072](https://github.com/ClickHouse/ClickHouse/pull/35072) ([Azat Khuzhin](https://github.com/azat)).
* Linux カーネルにバグがある場合、Query Profiler でのゼロ除算を回避。 [#34787](https://github.com/ClickHouse/ClickHouse/issues/34787) をクローズ。 [#35032](https://github.com/ClickHouse/ClickHouse/pull/35032)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
* Keeper の設定に対してさらにサニティチェックを追加しました。`localhost` と非ローカルサーバーの混在は許可されなくなり、また内部 Raft ポートと Keeper クライアントポートが同一の値になっていないことを確認するチェックも追加しました。 [#35004](https://github.com/ClickHouse/ClickHouse/pull/35004) ([alesapin](https://github.com/alesapin)).
* 現在、ユーザーが system テーブルの設定を変更すると大量のログが出力され、ClickHouse は毎分テーブルをリネームしてしまいます。これを修正します。 [#34929](https://github.com/ClickHouse/ClickHouse/issues/34929)。 [#34949](https://github.com/ClickHouse/ClickHouse/pull/34949)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* Hive metastore クライアントでコネクションプールを使用するようにしました。 [#34940](https://github.com/ClickHouse/ClickHouse/pull/34940) ([lgbo](https://github.com/lgbo-ustc)).
* 新しいテーブルエンジンがカラム単位の `TTL` をサポートしていない場合（つまり、エンジンが `MergeTree` ファミリーに属さない場合）、`CREATE TABLE AS` においてカラム単位の `TTL` を無視します。 [#34938](https://github.com/ClickHouse/ClickHouse/pull/34938) ([Azat Khuzhin](https://github.com/azat)).
* `ngrambf_v1`/`tokenbf_v1` インデックスで `LowCardinality` 文字列を許可するようにしました。 [#21865](https://github.com/ClickHouse/ClickHouse/issues/21865) をクローズ。 [#34911](https://github.com/ClickHouse/ClickHouse/pull/34911)（[Lars Hiller Eidnes](https://github.com/larspars)）。
* ファイルが存在しない場合でも空の sqlite データベースを開けるようにしました。[#33367](https://github.com/ClickHouse/ClickHouse/issues/33367) をクローズします。 [#34907](https://github.com/ClickHouse/ClickHouse/pull/34907) ([Kseniia Sumarokova](https://github.com/kssenii)).
* FreeBSD 向けのメモリ統計を実装しました。これは `max_server_memory_usage` を正しく動作させるために必要です。 [#34902](https://github.com/ClickHouse/ClickHouse/pull/34902) ([Alexandre Snarskii](https://github.com/snar))。
* 以前のバージョンでは、clickhouse-client のプログレスバーが、理由もなく 50% 付近まで一気に進んでしまうことがありました。この変更により [#34324](https://github.com/ClickHouse/ClickHouse/issues/34324) がクローズされました。 [#34801](https://github.com/ClickHouse/ClickHouse/pull/34801) ([Alexey Milovidov](https://github.com/alexey-milovidov))。
* `columnX` が `ALIAS` 列である場合、`MergeTree` テーブルエンジンに対する `ALTER TABLE DROP COLUMN columnX` クエリが即時に実行されるようになりました。 [#34660](https://github.com/ClickHouse/ClickHouse/issues/34660) を修正。 [#34786](https://github.com/ClickHouse/ClickHouse/pull/34786) ([alesapin](https://github.com/alesapin))。
* ユーザーがデータスキッピングインデックスの名前を誤入力したときに候補を提示するようにしました。[#29698](https://github.com/ClickHouse/ClickHouse/issues/29698) をクローズ。[#34764](https://github.com/ClickHouse/ClickHouse/pull/34764)（[flynn](https://github.com/ucasfl)）。
* `parallel_distributed_insert_select` で `remote()` / `cluster()` テーブル関数をサポートしました。 [#34728](https://github.com/ClickHouse/ClickHouse/pull/34728) ([Azat Khuzhin](https://github.com/azat)).
* 設定ファイルで対応する設定が空の場合でも、コマンドラインオプション `--log-file` / `--errorlog-file` で指定されたロギングをリセットしないようにしました。 [#34718](https://github.com/ClickHouse/ClickHouse/pull/34718) ([Amos Bird](https://github.com/amosbird)).
* テーブル作成時にのみスキーマを抽出し、サーバー起動のたびにスキーマ抽出のためにローカルファイルや外部ソースから読み取らないようにします。 [#34684](https://github.com/ClickHouse/ClickHouse/pull/34684) ([Kruglov Pavel](https://github.com/Avogar)).
* 実行可能な UDF に引数名を指定できるようにしました。これは、`Native` や `JSONEachRow` のように引数名がシリアル化の一部となるフォーマットで必要です。[#34604](https://github.com/ClickHouse/ClickHouse/issues/34604) をクローズ。[#34653](https://github.com/ClickHouse/ClickHouse/pull/34653)（[Maksim Kita](https://github.com/kitaisreal)）。
* `MaterializedMySQL`（実験的機能）は、`materialized_mysql_tables_list`（MaterializedMySQL データベースエンジンによってレプリケートされる MySQL データベーステーブル名のカンマ区切りリスト。デフォルト値: 空リスト — すべてのテーブルがレプリケートされることを意味する）をサポートするようになりました。[#32977](https://github.com/ClickHouse/ClickHouse/issues/32977) で言及されています。[#34487](https://github.com/ClickHouse/ClickHouse/pull/34487)（[zzsmdfj](https://github.com/zzsmdfj)）。
* 分散テーブルに対する INSERT 操作の OpenTelemetry スパンログを改善。 [#34480](https://github.com/ClickHouse/ClickHouse/pull/34480) ([Frank Chen](https://github.com/FrankChen021)).
* ClickHouse Keeper において、サーバー間で znode の `ctime` と `mtime` が一致するようにしました。 [#33441](https://github.com/ClickHouse/ClickHouse/pull/33441) ([小路](https://github.com/nicelulu)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-9}

- パッケージリポジトリをJFrog Artifactoryに移行しました（**Mikhail f. Shiryaev**）。
- 機能テストで一部の設定をランダム化し、より多くの設定の組み合わせをテストできるようにしました。これはテストカバレッジを向上させるための追加のファジング手法です。これにより[#32268](https://github.com/ClickHouse/ClickHouse/issues/32268)が解決されます。[#34092](https://github.com/ClickHouse/ClickHouse/pull/34092)（[Kruglov Pavel](https://github.com/Avogar)）。
- CIからPVS-Studioを削除しました。[#34680](https://github.com/ClickHouse/ClickHouse/pull/34680)（[Mikhail f. Shiryaev](https://github.com/Felixoid)）。
- CMakeでストリップされたバイナリをビルドする機能を追加しました。以前のバージョンではdh-toolsによって実行されていました。[#35196](https://github.com/ClickHouse/ClickHouse/pull/35196)（[alesapin](https://github.com/alesapin)）。
- より小さな「fat-free」な`clickhouse-keeper`ビルドを提供します。[#35031](https://github.com/ClickHouse/ClickHouse/pull/35031)（[alesapin](https://github.com/alesapin)）。
- https://github.com/ClickHouse/ClickHouse/pull/34685 のようなPRの作成者およびコミッターとして@robot-clickhouseを使用します。[#34793](https://github.com/ClickHouse/ClickHouse/pull/34793)（[Mikhail f. Shiryaev](https://github.com/Felixoid)）。
- デバッグ情報のDWARFバージョンを最大4に制限しました。これは内部のスタックシンボライザーがDWARFバージョン5を解析できないためです。clang-15でClickHouseをコンパイルする場合に有効です。[#34777](https://github.com/ClickHouse/ClickHouse/pull/34777)（[Alexey Milovidov](https://github.com/alexey-milovidov)）。
- 不要な複雑さとして`clickhouse-test` debianパッケージを削除しました。CIはリポジトリからテストを使用し、debパッケージ経由のスタンドアロンテストはサポートされなくなりました。[#34606](https://github.com/ClickHouse/ClickHouse/pull/34606)（[Ilya Yatsishin](https://github.com/qoega)）。

#### バグ修正（公式安定版またはプレ安定版リリースにおけるユーザーから見える不具合） {#bug-fix-user-visible-misbehaviour-in-official-stable-or-prestable-release}


* HDFS 連携の修正: 内部バッファサイズが小さすぎる場合、`HadoopSnappyDecoder` 内の NEED&#95;MORE&#95;INPUT が 1 つの圧縮ブロックに対して複数回 (&gt;=3) 実行されます。これにより、入力データが `HadoopSnappyDecoder::buffer` 内の誤った位置にコピーされてしまいます。 [#35116](https://github.com/ClickHouse/ClickHouse/pull/35116) ([lgbo](https://github.com/lgbo-ustc))。
* ATTACH GRANT ステートメントで、廃止された権限を無視するようにしました。この PR により [#34815](https://github.com/ClickHouse/ClickHouse/issues/34815) が修正されました。[#34855](https://github.com/ClickHouse/ClickHouse/pull/34855)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 名前付きコレクションを使用してデータベースを作成した場合に、`CREATE TABLE` クエリを取得すると Postgres データベースでセグメンテーションフォルトが発生する問題を修正しました。[#35312](https://github.com/ClickHouse/ClickHouse/issues/35312) をクローズします。[#35313](https://github.com/ClickHouse/ClickHouse/pull/35313)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 部分マージ結合で重複行が発生するバグを修正し、[#31009](https://github.com/ClickHouse/ClickHouse/issues/31009) をクローズしました。[#35311](https://github.com/ClickHouse/ClickHouse/pull/35311)（[Vladimir C](https://github.com/vdimir)）。
* 小さい `max_read_buffer_size` 設定値で bzip2 圧縮を使用しているときに発生する可能性のある `Assertion 'position() != working_buffer.end()' failed` を修正しました。このバグは [https://github.com/ClickHouse/ClickHouse/pull/35047](https://github.com/ClickHouse/ClickHouse/pull/35047) で発見されました。 [#35300](https://github.com/ClickHouse/ClickHouse/pull/35300)（[Kruglov Pavel](https://github.com/Avogar)）。小さい `max_read_buffer_size` 設定値で lz4 圧縮を使用しているときに発生する可能性のある同様の問題を修正しました。 [#35296](https://github.com/ClickHouse/ClickHouse/pull/35296)（[Kruglov Pavel](https://github.com/Avogar)）。小さい `max_read_buffer_size` 設定値で lzma 圧縮を使用しているときに発生する可能性のある同様の問題を修正しました。 [#35295](https://github.com/ClickHouse/ClickHouse/pull/35295)（[Kruglov Pavel](https://github.com/Avogar)）。小さい `max_read_buffer_size` 設定値で `brotli` 圧縮を使用しているときに発生する可能性のある同様の問題を修正しました。このバグは [https://github.com/ClickHouse/ClickHouse/pull/35047](https://github.com/ClickHouse/ClickHouse/pull/35047) で発見されました。 [#35281](https://github.com/ClickHouse/ClickHouse/pull/35281)（[Kruglov Pavel](https://github.com/Avogar)）。
* `JSONEachRow` のスキーマ推論で発生し得るセグフォールトを修正。 [#35291](https://github.com/ClickHouse/ClickHouse/pull/35291) ([Kruglov Pavel](https://github.com/Avogar)).
* テーブルでスパースカラムが有効になっている場合の `CHECK TABLE` クエリを修正。 [#35274](https://github.com/ClickHouse/ClickHouse/pull/35274) ([Anton Popov](https://github.com/CurtizJ)).
* リモート VFS からの読み取り時に例外が発生した場合に `std::terminate` が呼ばれないように変更。 [#35257](https://github.com/ClickHouse/ClickHouse/pull/35257) ([Azat Khuzhin](https://github.com/azat)).
* 設定からの読み取りポートの取得を修正し、[#34776](https://github.com/ClickHouse/ClickHouse/issues/34776) をクローズ。[#35193](https://github.com/ClickHouse/ClickHouse/pull/35193)（[Vladimir C](https://github.com/vdimir)）。
* `HAVING` で空の結果が返された場合に、`WITH TOTALS` を含むクエリで発生するエラーを修正しました。これにより [#33711](https://github.com/ClickHouse/ClickHouse/issues/33711) が解決されています。[#35186](https://github.com/ClickHouse/ClickHouse/pull/35186)（[Amos Bird](https://github.com/amosbird)）。
* `replaceRegexpAll` のコーナーケースを修正し、[#35117](https://github.com/ClickHouse/ClickHouse/issues/35117) をクローズしました。 [#35182](https://github.com/ClickHouse/ClickHouse/pull/35182)（[Vladimir C](https://github.com/vdimir)）。
* `INSERT INTO FUNCTION s3(...) FROM ...` の場合にスキーマ推論が正しく動作せず、`SELECT` クエリからではなく s3 ファイルからスキーマを読み取ろうとしていました。 [#35176](https://github.com/ClickHouse/ClickHouse/pull/35176) ([Kruglov Pavel](https://github.com/Avogar)).
* MaterializedPostgreSQL（実験的機能）の `table overrides` が `partition by` などで正しく動作するよう修正しました。[#35048](https://github.com/ClickHouse/ClickHouse/issues/35048) をクローズ。 [#35162](https://github.com/ClickHouse/ClickHouse/pull/35162)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* MaterializedPostgreSQL（実験的機能）で、手動でテーブルを切り離し（DETACH TABLE）た後に、新しいテーブルをレプリケーションに追加（ATTACH TABLE）できない問題を修正。 [#33800](https://github.com/ClickHouse/ClickHouse/issues/33800) をクローズ。 [#34922](https://github.com/ClickHouse/ClickHouse/issues/34922) をクローズ。 [#34315](https://github.com/ClickHouse/ClickHouse/issues/34315) をクローズ。 [#35158](https://github.com/ClickHouse/ClickHouse/pull/35158)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* IN 演算子と併用された非単調関数によって発生するパーティションプルーニングエラーを修正しました。これにより [#35136](https://github.com/ClickHouse/ClickHouse/issues/35136) が解決されます。 [#35146](https://github.com/ClickHouse/ClickHouse/pull/35146) ([Amos Bird](https://github.com/amosbird))。
* YAML 設定から XML への変換における、わずかに不正確な変換結果を修正しました。 [#35135](https://github.com/ClickHouse/ClickHouse/pull/35135) ([Miel Donkers](https://github.com/mdonkers)).
* 符号付きカラムおよび負の値に対して `optimize_skip_unused_shards_rewrite_in` を修正。 [#35134](https://github.com/ClickHouse/ClickHouse/pull/35134) ([Azat Khuzhin](https://github.com/azat)).
* `update_lag` 外部ディクショナリ設定オプションは、「``Unexpected key `update_lag` in dictionary source configuration``」というエラーメッセージが表示され、使用できませんでした。 [#35089](https://github.com/ClickHouse/ClickHouse/pull/35089) ([Jason Chu](https://github.com/1lann)).
* サーバーシャットダウン時に発生し得るデッドロックを回避。 [#35081](https://github.com/ClickHouse/ClickHouse/pull/35081) ([Azat Khuzhin](https://github.com/azat)).
* `optimize_functions_to_subcolumns` 設定が有効な場合に、関数がサブカラムへ最適化された後でエイリアスが失われる問題を修正しました。 [#33798](https://github.com/ClickHouse/ClickHouse/issues/33798) をクローズします。 [#35079](https://github.com/ClickHouse/ClickHouse/pull/35079)（[qieqieplus](https://github.com/qieqieplus)）。
* テーブル関数への非同期インサートがある場合の `system.asynchronous_inserts` テーブルからの読み取り処理を修正しました。 [#35050](https://github.com/ClickHouse/ClickHouse/pull/35050) ([Anton Popov](https://github.com/CurtizJ)).
* （リモート VFS 上での操作に関連して）`Reading for MergeTree family tables must be done with last position boundary` という例外が発生し得る問題を修正しました。 [#34979](https://github.com/ClickHouse/ClickHouse/issues/34979) をクローズしました。 [#35001](https://github.com/ClickHouse/ClickHouse/pull/35001) ([Kseniia Sumarokova](https://github.com/kssenii))。
* `-State` 型集計関数をウィンドウフレームで使用した際に発生する予期しない結果を修正しました。 [#34999](https://github.com/ClickHouse/ClickHouse/pull/34999) ([metahys](https://github.com/metahys)).
* FileLog（実験的機能）で発生しうるセグメンテーションフォルトを修正。[#30749](https://github.com/ClickHouse/ClickHouse/issues/30749) をクローズ。[#34996](https://github.com/ClickHouse/ClickHouse/pull/34996)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* まれに発生する可能性のあるエラー `Cannot push block to port which already has data` を修正しました。 [#34993](https://github.com/ClickHouse/ClickHouse/pull/34993) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* CSV 内のクォートされていない日付に対する誤ったスキーマ推論を修正。[#34768](https://github.com/ClickHouse/ClickHouse/issues/34768) をクローズ。[#34961](https://github.com/ClickHouse/ClickHouse/pull/34961)（[Kruglov Pavel](https://github.com/Avogar)）。
* Hive との統合: Hive クエリの `where` 句で `in` を使用した場合に予期しない結果になる問題を修正しました。 [#34945](https://github.com/ClickHouse/ClickHouse/pull/34945) ([lgbo](https://github.com/lgbo-ustc)).
* 削除対象のchangelogファイルを検索する際に、ClickHouse Keeperでビジー・ポーリングを行わないようにしました。 [#34931](https://github.com/ClickHouse/ClickHouse/pull/34931) ([Azat Khuzhin](https://github.com/azat))。
* PostgreSQL からの DateTime64 変換を修正。[#33364](https://github.com/ClickHouse/ClickHouse/issues/33364) をクローズ。[#34910](https://github.com/ClickHouse/ClickHouse/pull/34910)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* s3 上の VFS をバックエンドに持つ MergeTree テーブルへの `INSERT` 中に発生しうる「Part directory doesn&#39;t exist」エラーを修正しました。 [#34876](https://github.com/ClickHouse/ClickHouse/pull/34876) ([Azat Khuzhin](https://github.com/azat)).
* クロスレプリケートクラスタ上で `CREATE USER` などの DDL を実行できるようにしました。 [#34860](https://github.com/ClickHouse/ClickHouse/pull/34860) ([Jianmei Zhang](https://github.com/zhangjmruc)).
* `WindowView`（実験的機能）における複数カラムでの group by のバグを修正。 [#34859](https://github.com/ClickHouse/ClickHouse/pull/34859) ([vxider](https://github.com/Vxider)).
* クエリに const カラムが含まれている場合に S2 関数で発生し得る不具合を修正しました。 [#34745](https://github.com/ClickHouse/ClickHouse/pull/34745) ([Bharat Nallan](https://github.com/bharatnc)).
* 定数カラムを含む H3 関数が原因でクエリが失敗していたバグを修正しました。 [#34743](https://github.com/ClickHouse/ClickHouse/pull/34743) ([Bharat Nallan](https://github.com/bharatnc)).
* `fsync_part_directory` が有効で、垂直マージを使用している場合に発生する `No such file or directory` エラーを修正しました。 [#34739](https://github.com/ClickHouse/ClickHouse/pull/34739) ([Azat Khuzhin](https://github.com/azat)).
* `ON CLUSTER` 使用時のシステムクエリ `RELOAD MODEL`、`RELOAD FUNCTION`、`RESTART DISK` におけるシリアライゼーション／出力処理を修正しました。[#34514](https://github.com/ClickHouse/ClickHouse/issues/34514) をクローズ。[#34696](https://github.com/ClickHouse/ClickHouse/pull/34696)（[Maksim Kita](https://github.com/kitaisreal)）。
* `enable_global_with_statement` と組み合わせて `allow_experimental_projection_optimization` を修正しました（以前は、`WITH` 句内に複数の式がある場合に `Stack size too large` エラーを引き起こす可能性があり、さらにスカラーサブクエリを何度も繰り返し実行していたため、今回の修正によりより最適になります）。[#34650](https://github.com/ClickHouse/ClickHouse/pull/34650) ([Azat Khuzhin](https://github.com/azat)).
* `ReplatedMergeTree` エンジンで、他のレプリカがすでにトランザクションログを更新している場合には、mutate 用のパーツ選択を行わないようにしました。 [#34633](https://github.com/ClickHouse/ClickHouse/pull/34633) ([Jianmei Zhang](https://github.com/zhangjmruc)).
* パート移動機能使用時の単純な count クエリで誤った結果が返る問題を修正 [#34089](https://github.com/ClickHouse/ClickHouse/issues/34089)。[#34385](https://github.com/ClickHouse/ClickHouse/pull/34385)（[nvartolomei](https://github.com/nvartolomei)）。
* 分散サブクエリにおける `max_query_size` 制限の一貫性のなさを修正しました。 [#34078](https://github.com/ClickHouse/ClickHouse/pull/34078) ([Chao Ma](https://github.com/godliness)).

### <a id="222"></a> ClickHouse release v22.2, 2022-02-17 {#a-id222a-clickhouse-release-v222-2022-02-17}

#### アップグレード時の注意事項 {#upgrade-notes-3}

- FINALを使用したクエリにデータスキップインデックスを適用すると、誤った結果が生成される可能性があります。このリリースでは、FINALを使用したクエリに対してデータスキップインデックスをデフォルトで無効化しました（新しい設定`use_skip_indexes_if_final`が導入され、デフォルトで無効になっています）。[#34243](https://github.com/ClickHouse/ClickHouse/pull/34243) ([Azat Khuzhin](https://github.com/azat))。

#### 新機能 {#new-feature-10}


* Projection は本番利用可能になりました。`allow_experimental_projection_optimization` をデフォルトで有効化し、この設定を非推奨としました。 [#34456](https://github.com/ClickHouse/ClickHouse/pull/34456) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `File` / `S3` / `HDFS` エンジンで、INSERT 時に新しいファイルを作成するオプションを追加。`HDFS` ではファイルの上書きを許可。デフォルトでは、`S3` のファイルを上書きしようとした場合は例外をスローする。サフィックスを持つ形式（追記をサポートしない `Parquet`、`ORC` など）のファイルにデータを追記しようとした場合も例外をスローする。[#31640](https://github.com/ClickHouse/ClickHouse/issues/31640) をクローズ。[#31622](https://github.com/ClickHouse/ClickHouse/issues/31622) をクローズ。[#23862](https://github.com/ClickHouse/ClickHouse/issues/23862) をクローズ。[#15022](https://github.com/ClickHouse/ClickHouse/issues/15022) をクローズ。[#16674](https://github.com/ClickHouse/ClickHouse/issues/16674) をクローズ。[#33302](https://github.com/ClickHouse/ClickHouse/pull/33302)（[Kruglov Pavel](https://github.com/Avogar)）。
* `MergeTree`/`ReplicatedMergeTree` において、ユーザーが独自の重複排除セマンティクスを指定できる設定を追加しました。指定された場合、ブロック ID を生成する際に、データダイジェストの代わりにその値が使用されます。したがって、例えば各 INSERT 文ごとにこの設定に一意の値を指定することで、ユーザーは同一データが挿入されても重複排除されることを回避できます。これにより次の issue がクローズされました: [#7461](https://github.com/ClickHouse/ClickHouse/issues/7461)。[#32304](https://github.com/ClickHouse/ClickHouse/pull/32304) ([Igor Nikonov](https://github.com/devcrafter))。
* INSERT 文での `DEFAULT` キーワードのサポートを追加しました。[#6331](https://github.com/ClickHouse/ClickHouse/issues/6331) をクローズ。[#33141](https://github.com/ClickHouse/ClickHouse/pull/33141)（[Andrii Buriachevskyi](https://github.com/1over)）。
* `EPHEMERAL` 列指定子が `CREATE TABLE` クエリに追加されました。これにより [#9436](https://github.com/ClickHouse/ClickHouse/issues/9436) がクローズされました。[#34424](https://github.com/ClickHouse/ClickHouse/pull/34424)（[yakov-olkhovskiy](https://github.com/yakov-olkhovskiy)）。
* `TTL expr TO [DISK|VOLUME] [IF EXISTS] 'xxx'` 機能で `IF EXISTS` 句をサポートしました。パーツは、そのディスクまたはボリュームがレプリカ上に存在する場合にのみ移動されるため、`MOVE TTL` ルールは既存のストレージポリシーに応じてレプリカごとに異なる動作をさせることができます。[#34455](https://github.com/ClickHouse/ClickHouse/issues/34455) を解決しました。[#34504](https://github.com/ClickHouse/ClickHouse/pull/34504)（[Anton Popov](https://github.com/CurtizJ)）。
* デフォルトのテーブルエンジンを設定できるようにし、`ENGINE` を明示せずにテーブルを作成できるようにしました。 [#34187](https://github.com/ClickHouse/ClickHouse/pull/34187) ([Ilya Yatsishin](https://github.com/qoega))。
* テーブル関数 `format(format_name, data)` を追加。 [#34125](https://github.com/ClickHouse/ClickHouse/pull/34125) ([Kruglov Pavel](https://github.com/Avogar)).
* `clickhouse-local` で、たとえ stdin から渡された場合でも、ファイル名が指定されていればそのファイル名からフォーマットを自動検出するようにしました。 [#33829](https://github.com/ClickHouse/ClickHouse/pull/33829) ([Kruglov Pavel](https://github.com/Avogar)).
* `values` テーブル関数にスキーマ推論を追加。[#33811](https://github.com/ClickHouse/ClickHouse/issues/33811) をクローズ。[#34017](https://github.com/ClickHouse/ClickHouse/pull/34017)（[Kruglov Pavel](https://github.com/Avogar)）。
* 設定のリロード時にサーバーの TLS 証明書を動的に再読み込みできるようにした。[#15764](https://github.com/ClickHouse/ClickHouse/issues/15764) をクローズ。[#15765](https://github.com/ClickHouse/ClickHouse/pull/15765)（[johnskopis](https://github.com/johnskopis)）。[#31257](https://github.com/ClickHouse/ClickHouse/pull/31257)（[Filatenkov Artur](https://github.com/FArthur-cmd)）。
* ReplicatedMergeTree は、一部のディスクが故障している場合でもデータを復旧できるようになりました。 [#13544](https://github.com/ClickHouse/ClickHouse/pull/13544) ([Amos Bird](https://github.com/amosbird))。
* clickhouse-client におけるフォールトトレラント接続: `clickhouse-client ... --host host1 --host host2 --port port2 --host host3 --port port --host host4`。 [#34490](https://github.com/ClickHouse/ClickHouse/pull/34490) ([Kruglov Pavel](https://github.com/Avogar))。 [#33824](https://github.com/ClickHouse/ClickHouse/pull/33824) ([Filippov Denis](https://github.com/DF5HSE))。
* MySQL 互換性のために `DEGREES` 関数と `RADIANS` 関数を追加しました。[#33769](https://github.com/ClickHouse/ClickHouse/pull/33769)（[Bharat Nallan](https://github.com/bharatnc)）。
* `h3ToCenterChild` 関数を追加。 [#33313](https://github.com/ClickHouse/ClickHouse/pull/33313) ([Bharat Nallan](https://github.com/bharatnc))。新しい h3 の各種関数を追加: `edgeLengthKm`,`exactEdgeLengthKm`,`exactEdgeLengthM`,`exactEdgeLengthRads`,`numHexagons`。 [#33621](https://github.com/ClickHouse/ClickHouse/pull/33621) ([Bharat Nallan](https://github.com/bharatnc))。
* String/FixedString からビットの部分列を抽出する関数 `bitSlice` を追加。 [#33360](https://github.com/ClickHouse/ClickHouse/pull/33360) ([RogerYK](https://github.com/RogerYK))。
* `meanZTest` 集約関数を実装しました。 [#33354](https://github.com/ClickHouse/ClickHouse/pull/33354) ([achimbab](https://github.com/achimbab))。
* T検定の集約関数に信頼区間を追加。 [#33260](https://github.com/ClickHouse/ClickHouse/pull/33260) ([achimbab](https://github.com/achimbab)).
* 関数 `addressToLineWithInlines` を追加。[#26211](https://github.com/ClickHouse/ClickHouse/issues/26211) をクローズ。[#33467](https://github.com/ClickHouse/ClickHouse/pull/33467)（[SuperDJY](https://github.com/cmsxbc)）。
* 単一行コメントの開始として `#!` および `# ` が認識されるようにしました。 [#34138](https://github.com/ClickHouse/ClickHouse/issues/34138) をクローズ。 [#34230](https://github.com/ClickHouse/ClickHouse/pull/34230)（[Aaron Katz](https://github.com/aaronstephenkatz)）。

#### 実験的機能 {#experimental-feature-9}

- テキスト分類用の関数：言語と文字セットの検出。[#23271](https://github.com/ClickHouse/ClickHouse/issues/23271)を参照。[#33314](https://github.com/ClickHouse/ClickHouse/pull/33314) ([Nikolay Degterinsky](https://github.com/evillique))。
- `MemoryTracker`にメモリオーバーコミット機能を追加。ソフトメモリ制限を表す`guaranteed`設定をメモリ制限に追加しました。ハードメモリ制限に達した場合、`MemoryTracker`は最もオーバーコミットされているクエリのキャンセルを試みます。新しい設定`memory_usage_overcommit_max_wait_microseconds`は、クエリが他のクエリの停止を待機できる時間を指定します。[#28375](https://github.com/ClickHouse/ClickHouse/issues/28375)をクローズ。[#31182](https://github.com/ClickHouse/ClickHouse/pull/31182) ([Dmitry Novik](https://github.com/novikd))。
- WindowViewでストリームとテーブルの結合を有効化。[#33729](https://github.com/ClickHouse/ClickHouse/pull/33729) ([vxider](https://github.com/Vxider))。
- `MaterializedMySQL`（実験的機能）で`SET`、`YEAR`、`TIME`、`GEOMETRY`データ型をサポート。[#18091](https://github.com/ClickHouse/ClickHouse/issues/18091)、[#21536](https://github.com/ClickHouse/ClickHouse/issues/21536)、[#26361](https://github.com/ClickHouse/ClickHouse/issues/26361)を修正。[#33429](https://github.com/ClickHouse/ClickHouse/pull/33429) ([zzsmdfj](https://github.com/zzsmdfj))。
- プロジェクションがデフォルトで有効になっている場合の各種問題を修正。各問題は個別のコミットで説明されています。[#33678](https://github.com/ClickHouse/ClickHouse/issues/33678)に対応。[#34273](https://github.com/ClickHouse/ClickHouse/issues/34273)を修正。[#34305](https://github.com/ClickHouse/ClickHouse/pull/34305) ([Amos Bird](https://github.com/amosbird))。

#### パフォーマンス改善 {#performance-improvement-10}


* ソートキーの先頭部分がすでにソートされている場合に `optimize_read_in_order` をサポートします。例えば、テーブルのソートキーが `ORDER BY (a, b)` であり、クエリで `WHERE a = const ORDER BY b` という句を使用している場合、これまでは全件をソートする必要がありましたが、今後はソートキーの順序で読み出すことで処理されます。 [#32748](https://github.com/ClickHouse/ClickHouse/pull/32748) ([Anton Popov](https://github.com/CurtizJ)).
* パーティション分割された `URL`、`S3`、`File`、`HDFS` テーブル関数への挿入処理のパフォーマンスを改善。[#34348](https://github.com/ClickHouse/ClickHouse/issues/34348) をクローズ。[#34510](https://github.com/ClickHouse/ClickHouse/pull/34510)（[Maksim Kita](https://github.com/kitaisreal)）。
* clickhouse-keeper のパフォーマンスを複数箇所で改善。 [#34484](https://github.com/ClickHouse/ClickHouse/pull/34484) [#34587](https://github.com/ClickHouse/ClickHouse/pull/34587) ([zhanglistar](https://github.com/zhanglistar)).
* `FlatDictionary` は辞書データのロードパフォーマンスを向上させます。 [#33871](https://github.com/ClickHouse/ClickHouse/pull/33871) ([Maksim Kita](https://github.com/kitaisreal)).
* `mapPopulateSeries` 関数のパフォーマンスを改善。 [#33944](https://github.com/ClickHouse/ClickHouse/issues/33944) をクローズ。 [#34318](https://github.com/ClickHouse/ClickHouse/pull/34318)（[Maksim Kita](https://github.com/kitaisreal)）。
* ファイル系テーブルエンジンにおける仮想列 `_file` および `_path` が `LowCardinality` 型になりました。これにより、複数ファイルに対するクエリがより高速になります。[#34300](https://github.com/ClickHouse/ClickHouse/issues/34300) をクローズします。 [#34317](https://github.com/ClickHouse/ClickHouse/pull/34317)（[flynn](https://github.com/ucasfl)）。
* データパーツの読み込みを高速化しました。以前は並列化されておらず、設定 `part_loading_threads` は効果がありませんでした。[#4699](https://github.com/ClickHouse/ClickHouse/issues/4699) を参照してください。[#34310](https://github.com/ClickHouse/ClickHouse/pull/34310)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `LineAsString` フォーマットのパフォーマンスを改善。これにより [#34303](https://github.com/ClickHouse/ClickHouse/issues/34303) がクローズされました。[#34306](https://github.com/ClickHouse/ClickHouse/pull/34306)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `quantilesExact{Low,High}` が `sort` ではなく `nth_element` を使用するように最適化されました。 [#34287](https://github.com/ClickHouse/ClickHouse/pull/34287) ([Danila Kutenin](https://github.com/danlark1)).
* `Regexp` フォーマットのパフォーマンスをわずかに改善しました。 [#34202](https://github.com/ClickHouse/ClickHouse/pull/34202) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* スカラーサブクエリの解析をわずかに改善しました。 [#34128](https://github.com/ClickHouse/ClickHouse/pull/34128) ([Federico Rodriguez](https://github.com/fedrod))。
* `ORDER BY` でのタプルを、複数カラムでの `ORDER BY` とほぼ同等の速度にします。複数カラムでの `ORDER BY` には特別な最適化があります: [https://github.com/ClickHouse/ClickHouse/pull/10831](https://github.com/ClickHouse/ClickHouse/pull/10831)。これをタプル型カラムにも適用することは有益です。[#34060](https://github.com/ClickHouse/ClickHouse/pull/34060) ([Amos Bird](https://github.com/amosbird))。
* Materialized View の実行におけるスカラサブクエリのキャッシュを再設計し、再導入しました。 [#33958](https://github.com/ClickHouse/ClickHouse/pull/33958) ([Raúl Marín](https://github.com/Algunenano)).
* `memcmpSmall` 関数に対して x86-64 AVX-512 のサポートを追加し、メモリ比較を高速化することで `ORDER BY` のパフォーマンスをわずかに向上しました。これは、ClickHouse を自前でコンパイルした場合にのみ有効です。 [#33706](https://github.com/ClickHouse/ClickHouse/pull/33706) ([hanqf-git](https://github.com/hanqf-git)).
* キーに多数の区間が存在する場合の `range_hashed` 辞書のパフォーマンスを改善。[#23821](https://github.com/ClickHouse/ClickHouse/issues/23821) を修正。[#33516](https://github.com/ClickHouse/ClickHouse/pull/33516)（[Maksim Kita](https://github.com/kitaisreal)）。
* S3 への挿入およびマージに対して、可能な限り並列でファイルを書き込むようにしました（TODO: マージされたか要確認）。[#33291](https://github.com/ClickHouse/ClickHouse/pull/33291) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `clickhouse-keeper` のパフォーマンスを向上し、NuRaft ライブラリにおける複数のメモリリークを修正。 [#33329](https://github.com/ClickHouse/ClickHouse/pull/33329) ([alesapin](https://github.com/alesapin)).

#### 改善 {#improvement-10}


* インラインデータを含むクエリに対して、`clickhouse-client` での非同期インサートをサポートしました。 [#34267](https://github.com/ClickHouse/ClickHouse/pull/34267) ([Anton Popov](https://github.com/CurtizJ)).
* 関数 `dictGet` と `dictHas` は、キー引数の型が辞書のキー構造と異なる場合、自動的に辞書キー構造にキャストします。 [#33672](https://github.com/ClickHouse/ClickHouse/pull/33672) ([Maksim Kita](https://github.com/kitaisreal))。
* `range_hashed` 辞書を改善。複数の属性がある場合のロード時間のパフォーマンスを向上。属性なしで辞書を作成できるようにした。区間の `start` および `end` が `Nullable` 型の場合の挙動を指定するオプションを追加、`convert_null_range_bound_to_open` のデフォルトは `true`。[#29791](https://github.com/ClickHouse/ClickHouse/issues/29791) をクローズ。範囲型として `Float`, `Decimal`, `DateTime64`, `Int128`, `Int256`, `UInt128`, `UInt256` を指定可能にした。`RangeHashedDictionary` に `Int64` 型を超える範囲値のサポートを追加。[#28322](https://github.com/ClickHouse/ClickHouse/issues/28322) をクローズ。範囲検索方式を指定するためのオプション `range_lookup_strategy` を追加し、`min`, `max` を指定可能でデフォルトは `min`。[#21647](https://github.com/ClickHouse/ClickHouse/issues/21647) をクローズ。割り当てバイト数の計算を修正。`ComplexKeyHashedDictionary` の場合の `system.dictionaries` における型名を修正。[#33927](https://github.com/ClickHouse/ClickHouse/pull/33927) ([Maksim Kita](https://github.com/kitaisreal))。
* `flat`、`hashed`、`hashed_array` 辞書で、空の属性を持つ辞書の作成がサポートされ、キーの読み取りおよび `dictHas` の利用も可能になりました。 [#33820](https://github.com/ClickHouse/ClickHouse/issues/33820) を修正。 [#33918](https://github.com/ClickHouse/ClickHouse/pull/33918)（[Maksim Kita](https://github.com/kitaisreal)）。
* ディクショナリで `DateTime64` データ型をサポートしました。 [#33914](https://github.com/ClickHouse/ClickHouse/pull/33914) ([Maksim Kita](https://github.com/kitaisreal)).
* `s3(url, access_key_id, secret_access_key)` を使用できるようにしました（データ形式とテーブル構造は自動検出されますが、認証情報は明示的に指定します）。 [#34503](https://github.com/ClickHouse/ClickHouse/pull/34503) ([Kruglov Pavel](https://github.com/Avogar)).
* HTTP プロトコルと同様に、クライアントへ出力フォーマットを送り返す機能を追加しました（[#34362](https://github.com/ClickHouse/ClickHouse/issues/34362) による提案）。[#34362](https://github.com/ClickHouse/ClickHouse/issues/34362) をクローズします。[#34499](https://github.com/ClickHouse/ClickHouse/pull/34499)（[Vitaly Baranov](https://github.com/vitlibar)）。
* INSERT SELECT クエリの場合に ProfileEvents 統計情報を送信し、この種のクエリに対して `clickhouse-client` でクエリメトリクスを表示できるようにしました。 [#34498](https://github.com/ClickHouse/ClickHouse/pull/34498) ([Dmitry Novik](https://github.com/novikd)).
* JSONEachRow フォーマットで `.jsonl` 拡張子を認識するようにしました。 [#34496](https://github.com/ClickHouse/ClickHouse/pull/34496) ([Kruglov Pavel](https://github.com/Avogar)).
* clickhouse-local におけるスキーマ推論を改善しました。`clickhouse-local -q "select * from table" < data.format` と書くだけで済むようになりました。 [#34495](https://github.com/ClickHouse/ClickHouse/pull/34495) ([Kruglov Pavel](https://github.com/Avogar)).
* `CREATE` / `ALTER` / `DROP ROW POLICY` の権限は、グローバルな `*.*` に加えて、テーブル単位や `database.*` に対しても付与できるようになりました。 [#34489](https://github.com/ClickHouse/ClickHouse/pull/34489) ([Vitaly Baranov](https://github.com/vitlibar))。
* 任意の大きさのファイルを `s3` にエクスポートできるようにしました。新たに 2 つの設定 `s3_upload_part_size_multiply_factor` と `s3_upload_part_size_multiply_parts_count_threshold` を追加しました。これにより、単一のクエリから S3 へアップロードされたパート数が `s3_upload_part_size_multiply_parts_count_threshold` に達するたびに、`s3_min_upload_part_size` が `s3_upload_part_size_multiply_factor` 倍されます。 [#34244](https://github.com/ClickHouse/ClickHouse/issues/34244) を修正。[#34422](https://github.com/ClickHouse/ClickHouse/pull/34422) ([alesapin](https://github.com/alesapin))。
* URL ストレージ / テーブル関数でグロブを使用する際に、存在しない (404) URL をスキップできるようにしました。あわせて [#34359](https://github.com/ClickHouse/ClickHouse/issues/34359) もクローズします。[#34392](https://github.com/ClickHouse/ClickHouse/pull/34392)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `clickhouse-local` のデフォルトの入力および出力フォーマットであり、`--input-format` および `--output-format` で上書きできます。[#30631](https://github.com/ClickHouse/ClickHouse/issues/30631) をクローズ。[#34352](https://github.com/ClickHouse/ClickHouse/pull/34352)（[李扬](https://github.com/taiyang-li)）。
* `clickhouse-format` にオプションを追加。これにより [#30528](https://github.com/ClickHouse/ClickHouse/issues/30528)（`max_query_size`、`max_parser_depth`）がクローズされた。 [#34349](https://github.com/ClickHouse/ClickHouse/pull/34349) ([李扬](https://github.com/taiyang-li))。
* クライアント起動前の入力の扱いをより適切に行うようにしました。これは [#34308](https://github.com/ClickHouse/ClickHouse/issues/34308) に対応するものです。 [#34336](https://github.com/ClickHouse/ClickHouse/pull/34336) ([Amos Bird](https://github.com/amosbird))。
* PostgreSQL との互換性のための `REGEXP_MATCHES` および `REGEXP_REPLACE` 関数エイリアスを追加。 [#30885](https://github.com/ClickHouse/ClickHouse/issues/30885) をクローズ。 [#34334](https://github.com/ClickHouse/ClickHouse/pull/34334)（[李扬](https://github.com/taiyang-li)）。
* 一部のサーバーは、HTTP リクエストに User-Agent ヘッダーが含まれていることを前提としています。HTTP リクエストに、次の形式の `User-Agent` ヘッダー項目が追加されました: User-Agent: ClickHouse/VERSION&#95;STRING。 [#34330](https://github.com/ClickHouse/ClickHouse/pull/34330) ([Saad Ur Rahman](https://github.com/surahman))。
* 一部のケースで `DEADLOCK_AVOIDED` エラーを回避するため、`TRUNCATE` クエリでテーブルロックを取得する前にマージをキャンセルするようにしました。 [#34302](https://github.com/ClickHouse/ClickHouse/issues/34302) を修正。 [#34304](https://github.com/ClickHouse/ClickHouse/pull/34304) ([tavplubix](https://github.com/tavplubix))。
* エラーではないため、ログ内の &quot;Cancelled merging parts&quot; メッセージの重大度を変更しました。これにより [#34148](https://github.com/ClickHouse/ClickHouse/issues/34148) がクローズされました。 [#34232](https://github.com/ClickHouse/ClickHouse/pull/34232) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* PostgreSQL 形式のキャスト演算子 `::` を、`[]` および `.` 演算子（配列およびタプルのインデックス指定）を用いる式と組み合わせて使用できるようにしました。 [#34229](https://github.com/ClickHouse/ClickHouse/pull/34229) ([Nikolay Degterinsky](https://github.com/evillique))。
* `parseDateTimeBestEffort` 関数で `YYYYMMDD-hhmmss` 形式を認識できるようにしました。これにより [#34206](https://github.com/ClickHouse/ClickHouse/issues/34206) がクローズされました。 [#34208](https://github.com/ClickHouse/ClickHouse/pull/34208) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `Regexp` フォーマットでパースする際、行の途中にキャリッジリターンを含めることを許可しました。これにより [#34200](https://github.com/ClickHouse/ClickHouse/issues/34200) がクローズされました。 [#34205](https://github.com/ClickHouse/ClickHouse/pull/34205) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 辞書の `PRIMARY KEY` を `PRIMARY KEY (id, value)` という形式でもパースできるようにしました。以前は `PRIMARY KEY id, value` のみがサポートされていました。 [#34135](https://github.com/ClickHouse/ClickHouse/issues/34135) をクローズします。 [#34141](https://github.com/ClickHouse/ClickHouse/pull/34141) ([Maksim Kita](https://github.com/kitaisreal))。
* `splitByChar` のオプション引数として、結果要素数を制限する機能を追加しました。[#34081](https://github.com/ClickHouse/ClickHouse/issues/34081) をクローズ。 [#34140](https://github.com/ClickHouse/ClickHouse/pull/34140)（[李扬](https://github.com/taiyang-li)）。
* clickhouse-client における複数行編集の操作性を改善しました。これは [#31123](https://github.com/ClickHouse/ClickHouse/pull/31123) のフォローアップです。[#34114](https://github.com/ClickHouse/ClickHouse/pull/34114)（[Amos Bird](https://github.com/amosbird)）。
* `MsgPack` 入出力フォーマットに `UUID` サポートを追加。[#34065](https://github.com/ClickHouse/ClickHouse/pull/34065) ([Kruglov Pavel](https://github.com/Avogar)).
* Tracing コンテキスト（OpenTelemetry 用）が、GRPC クライアントのメタデータから伝播されるようになりました（この変更は GRPC クライアント-サーバープロトコルに関連します）。 [#34064](https://github.com/ClickHouse/ClickHouse/pull/34064) ([andremarianiello](https://github.com/andremarianiello)).
* `ON CLUSTER` 句を伴うあらゆる種類の `SYSTEM` クエリをサポートしました。[#34005](https://github.com/ClickHouse/ClickHouse/pull/34005) ([小路](https://github.com/nicelulu))。
* `max_untracker_memory` 未満のメモリしか使用していないクエリに対するメモリ計上を改善しました。 [#34001](https://github.com/ClickHouse/ClickHouse/pull/34001) ([Azat Khuzhin](https://github.com/azat)).
* 小文字と大文字が異なるバイト数で表現される場合の、UTF-8 文字列に対する大文字小文字を区別しない検索の問題を修正しました。例としては `ẞ` と `ß` があります。この修正により [#7334](https://github.com/ClickHouse/ClickHouse/issues/7334) がクローズされました。 [#33992](https://github.com/ClickHouse/ClickHouse/pull/33992)（[Harry Lee](https://github.com/HarryLeeIBM)）。
* `clickhouse-local` で標準入力からフォーマットとスキーマを検出できるようにしました。 [#33960](https://github.com/ClickHouse/ClickHouse/pull/33960) ([Kruglov Pavel](https://github.com/Avogar))。
* 複数のディスクが同じファイルシステム上のパスを使用している場合の誤った設定を正しく処理できるようにしました。 [#29072](https://github.com/ClickHouse/ClickHouse/issues/29072)。 [#33905](https://github.com/ClickHouse/ClickHouse/pull/33905)（[zhongyuankai](https://github.com/zhongyuankai)）。
* S3 プロキシを取得する際に、解決されたすべての IP アドレスを試すようにしました。S3 プロキシは使用されることはまれで、主に Yandex Cloud で利用されています。 [#33862](https://github.com/ClickHouse/ClickHouse/pull/33862) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `EXPLAIN AST CREATE FUNCTION mycast AS (n) -> cast(n as String)` という `EXPLAIN AST CREATE FUNCTION` クエリをサポートしました。これは `EXPLAIN AST CREATE FUNCTION mycast AS n -> CAST(n, 'String')` を返します。 [#33819](https://github.com/ClickHouse/ClickHouse/pull/33819) ([李扬](https://github.com/taiyang-li)).
* `Map(Key, Value)` から `Array(Tuple(Key, Value))` へのキャストをサポートしました。 [#33794](https://github.com/ClickHouse/ClickHouse/pull/33794) ([Maksim Kita](https://github.com/kitaisreal))。
* `Bool` データ型に対して、いくつかの改良と不具合修正を追加。[#33244](https://github.com/ClickHouse/ClickHouse/issues/33244) を修正。[#33737](https://github.com/ClickHouse/ClickHouse/pull/33737)（[Kruglov Pavel](https://github.com/Avogar)）。
* OpenTelemetry の trace-id をビッグエンディアン順で解析して保存するようにしました。 [#33723](https://github.com/ClickHouse/ClickHouse/pull/33723) ([Frank Chen](https://github.com/FrankChen021)).
* `fromUnixTimestamp64` ファミリーの関数を改良しました。これらの関数は、`Int64` に変換可能な任意の整数値を受け付けるようになりました。これにより、[#14648](https://github.com/ClickHouse/ClickHouse/issues/14648) がクローズされました。[#33505](https://github.com/ClickHouse/ClickHouse/pull/33505)（[Andrey Zvonov](https://github.com/zvonand)）。
* `shardNum()` 関数（[#27020](https://github.com/ClickHouse/ClickHouse/issues/27020) を参照）を用いて、定数ベースの `_shard_num` 実装（[#7624](https://github.com/ClickHouse/ClickHouse/issues/7624) を参照）を再実装し、（[#16947](https://github.com/ClickHouse/ClickHouse/issues/16947) で見つかったような）潜在的な問題を回避しました。[#33392](https://github.com/ClickHouse/ClickHouse/pull/33392)（[Azat Khuzhin](https://github.com/azat)）。
* Decimal と Float 間の二項演算（加算、減算、乗算、除算、`least`、`greatest`）を有効にしました。 [#33355](https://github.com/ClickHouse/ClickHouse/pull/33355) ([flynn](https://github.com/ucasfl)).
* max&#95;threads の自動検出時に cgroups の制限を考慮するようにしました。 [#33342](https://github.com/ClickHouse/ClickHouse/pull/33342) ([JaySon](https://github.com/JaySon-Huang)).
* 新しい clickhouse-keeper の設定項目 `min_session_timeout_ms` を追加しました。これにより、clickhouse-keeper はクライアントセッションのタイムアウトを、`min_session_timeout_ms` および `session_timeout_ms` の各設定値に基づいて決定するようになります。 [#33288](https://github.com/ClickHouse/ClickHouse/pull/33288) ([JackyWoo](https://github.com/JackyWoo)).
* 関数 `hex` と `bin` に `UUID` データ型のサポートを追加しました。 [#32170](https://github.com/ClickHouse/ClickHouse/pull/32170) ([Frank Chen](https://github.com/FrankChen021))。
* 名前にドットを含むサブカラムの読み取りを修正しました。特に、要素名にドットを含む場合の `Nested` カラムの読み取りを修正しました（例: ``Nested(`keys.name` String, `keys.id` UInt64, values UInt64)``）。[#34228](https://github.com/ClickHouse/ClickHouse/pull/34228)（[Anton Popov](https://github.com/CurtizJ)）。
* `VALUES` を使用してテーブルに挿入する際に `parallel_view_processing = 0` が機能しない問題を修正。- マテリアライズドビューに対して、`query_views_log` の `view_duration_ms` が正しく設定されない問題を修正。[#34067](https://github.com/ClickHouse/ClickHouse/pull/34067) ([Raúl Marín](https://github.com/Algunenano)).
* ZooKeeper からのテーブル構造の解析を修正: ZooKeeper のメタデータを、正規化された形式でローカルメタデータと比較するようにしました。これにより、ClickHouse のバージョン間で正規化された関数名が変更される場合にも対応できます。 [#33933](https://github.com/ClickHouse/ClickHouse/pull/33933) ([sunny](https://github.com/sunny19930321)).
* LDAP との連携時に特定の文字を正しくエスケープするようにしました。 [#33401](https://github.com/ClickHouse/ClickHouse/pull/33401) ([IlyaTsoi](https://github.com/IlyaTsoi)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-10}

- アンバンドルビルドのサポートを削除しました。[#33690](https://github.com/ClickHouse/ClickHouse/pull/33690) ([Azat Khuzhin](https://github.com/azat))。
- テストが等価要素の非安定ソートの結果に依存しないようにしました。等価要素のソート順序に依存することで発生する問題を防ぐため、デバッグモードでソート後に等価アイテム範囲のランダム化を追加しました。[#34393](https://github.com/ClickHouse/ClickHouse/pull/34393) ([Maksim Kita](https://github.com/kitaisreal))。
- スタイルチェックに詳細出力を追加しました。[#34289](https://github.com/ClickHouse/ClickHouse/pull/34289) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- `clickhouse-test` Debianパッケージは廃止されたため削除しました。[#33948](https://github.com/ClickHouse/ClickHouse/pull/33948) ([Ilya Yatsishin](https://github.com/qoega))。
- OSからのパッケージを偶発的に使用する可能性を排除し、ハーメチックビルドを強制するため、ビルドシステムに複数の改善を実施しました。[#33695](https://github.com/ClickHouse/ClickHouse/pull/33695) ([Amos Bird](https://github.com/amosbird))。

#### バグ修正(公式安定版またはプレ安定版リリースにおけるユーザーから見える不具合) {#bug-fix-user-visible-misbehaviour-in-official-stable-or-prestable-release-1}


* `allow_experimental_parallel_reading_from_replicas` を `max_parallel_replicas` が 1 の場合に使用したときのアサーションを修正しました。これにより [#34525](https://github.com/ClickHouse/ClickHouse/issues/34525) が解決されます。 [#34613](https://github.com/ClickHouse/ClickHouse/pull/34613)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 空配列の読み取り時にまれに発生するバグを修正しました。このバグにより `Data compressed with different methods` エラーが発生する可能性がありました。この問題は、主に空配列だが必ずしもそうとは限らないデータを扱い、かつ ORDER BY ... DESC による逆順での読み取りが行われる場合に再現する可能性があります。このエラーが実際に発生する可能性は極めて低いです。 [#34327](https://github.com/ClickHouse/ClickHouse/pull/34327) ([Anton Popov](https://github.com/CurtizJ)).
* 小さい型の整数値を丸める際に `round` / `roundBankers` が誤った結果を返していた問題を修正しました。[#33267](https://github.com/ClickHouse/ClickHouse/issues/33267) をクローズ。[#34562](https://github.com/ClickHouse/ClickHouse/pull/34562)（[李扬](https://github.com/taiyang-li)）。
* s3 または HDFS から複数のファイルを読み込んでいる場合、クエリのキャンセルが即座に行われないことがありました。 [#34301](https://github.com/ClickHouse/ClickHouse/issues/34301) を修正。 [#34397](https://github.com/ClickHouse/ClickHouse/issues/34397) に関連。 [#34539](https://github.com/ClickHouse/ClickHouse/pull/34539)（[Dmitry Novik](https://github.com/novikd)）。
* `optimize_aggregation_in_order = 1` かつ `distributed_aggregation_memory_efficient = 0` の場合に発生する例外 `Chunk should have AggregatedChunkInfo in MergingAggregatedTransform` を修正。[#34526](https://github.com/ClickHouse/ClickHouse/issues/34526) を解決。[#34532](https://github.com/ClickHouse/ClickHouse/pull/34532)（[Anton Popov](https://github.com/CurtizJ)）。
* インデックス解析における整数と浮動小数点数の比較処理を修正しました。以前は、誤って一部のグラニュールの読み取りをスキップしてしまう可能性がありました。 [#34493](https://github.com/ClickHouse/ClickHouse/issues/34493) を修正します。 [#34528](https://github.com/ClickHouse/ClickHouse/pull/34528)（[Anton Popov](https://github.com/CurtizJ)）。
* URL エンジンの圧縮サポートを修正。 [#34524](https://github.com/ClickHouse/ClickHouse/pull/34524) ([Frank Chen](https://github.com/FrankChen021)).
* ファイルのスキーマ自動検出で発生する可能性のあるエラー &#39;file&#95;size: Operation not supported&#39; を修正。 [#34479](https://github.com/ClickHouse/ClickHouse/pull/34479) ([Kruglov Pavel](https://github.com/Avogar)).
* テーブル削除時に発生し得るレースコンディションを修正。 [#34416](https://github.com/ClickHouse/ClickHouse/pull/34416) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 短絡評価される関数において発生する可能性のあるエラー `Cannot convert column Function to mask` を修正しました。 [#34171](https://github.com/ClickHouse/ClickHouse/issues/34171) をクローズします。 [#34415](https://github.com/ClickHouse/ClickHouse/pull/34415)（[Kruglov Pavel](https://github.com/Avogar)）。
* `url` ソースからのスキーマ推論時に発生しうるクラッシュを修正。 [#34147](https://github.com/ClickHouse/ClickHouse/issues/34147) をクローズ。 [#34405](https://github.com/ClickHouse/ClickHouse/pull/34405) ([Kruglov Pavel](https://github.com/Avogar)).
* UDF のアクセス権限が、本来あるべきグローバルレベルではなくデータベースレベルでチェックされていました。 [#34281](https://github.com/ClickHouse/ClickHouse/issues/34281) をクローズしました。 [#34404](https://github.com/ClickHouse/ClickHouse/pull/34404) ([Maksim Kita](https://github.com/kitaisreal))。
* `Memory` エンジンを使用するデータベースに対する `SHOW CREATE DATABASE` クエリの結果に含まれていた誤ったエンジン構文を修正しました。これにより [#34335](https://github.com/ClickHouse/ClickHouse/issues/34335) がクローズされます。[#34345](https://github.com/ClickHouse/ClickHouse/pull/34345)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* レプリケーションキューの状態が破損したり「intersecting parts」エラーを引き起こす可能性のある、極めてまれなレースコンディションをいくつか修正しました。 [#34297](https://github.com/ClickHouse/ClickHouse/pull/34297) ([tavplubix](https://github.com/tavplubix)).
* 進捗バーの幅を修正しました。文字数への丸め処理が誤って整数に切り捨てられていました。 [#34275](https://github.com/ClickHouse/ClickHouse/pull/34275) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* サーバー間通信における `current_user` / `current_address` クライアント情報フィールドを修正しました（このパッチ以前は、`current_user` / `current_address` が前のクエリから引き継がれていました）。[#34263](https://github.com/ClickHouse/ClickHouse/pull/34263) ([Azat Khuzhin](https://github.com/azat)).
* `optimize_aggregation_in_order=1` を使用したクエリ処理中に、特定の例外が発生した場合のメモリリークを修正しました。 [#34234](https://github.com/ClickHouse/ClickHouse/pull/34234) ([Azat Khuzhin](https://github.com/azat)).
* 実行中のクエリ数を示すメトリクス `Query` を修正しました。直近のいくつかのリリースでは常に 0 になっていました。 [#34224](https://github.com/ClickHouse/ClickHouse/pull/34224)（[Anton Popov](https://github.com/CurtizJ)）。
* テーブル関数 `s3` のスキーマ推論を修正しました。[#34186](https://github.com/ClickHouse/ClickHouse/pull/34186)（[Kruglov Pavel](https://github.com/Avogar)）。
* `HDFS`、`S3`、`URL` ストレージエンジンにおいて、追加の接続が発生する可能性のあった、まれで影響の小さいレースコンディションを修正しました。 [#34172](https://github.com/ClickHouse/ClickHouse/pull/34172) ([alesapin](https://github.com/alesapin)).
* MergeTree テーブルエンジンファミリーで、S3 のようなリモートファイルシステム上にデータを保存している場合に、LowCardinality カラムの読み取り中にまれに「Cannot read all data」エラーが発生する可能性のあったバグを修正しました（S3 上の仮想ファイルシステムは、本番利用にはまだ準備ができていない実験的機能です）。 [#34139](https://github.com/ClickHouse/ClickHouse/pull/34139) ([alesapin](https://github.com/alesapin)).
* ネイティブプロトコルの変更時に発生する、分散テーブルへの挿入の不具合を修正しました。直近の変更はバージョン 22.1 で行われたため、そのバージョンへアップグレードした後に分散テーブルへの挿入が失敗していた可能性があります。 [#34132](https://github.com/ClickHouse/ClickHouse/pull/34132) ([Anton Popov](https://github.com/CurtizJ))。
* `File` テーブルエンジンで、[#33960](https://github.com/ClickHouse/ClickHouse/pull/33960) によって導入された可能性のあるデータレースを修正しました。[#34111](https://github.com/ClickHouse/ClickHouse/issues/34111) をクローズ。[#34113](https://github.com/ClickHouse/ClickHouse/pull/34113)（[Kruglov Pavel](https://github.com/Avogar)）。
* ZooKeeper 接続の喪失後に、極めてまれなケースで &quot;intersecting parts&quot; エラーを引き起こす可能性があった軽微なレースコンディションを修正しました。 [#34096](https://github.com/ClickHouse/ClickHouse/pull/34096) ([tavplubix](https://github.com/tavplubix)).
* `Native` フォーマットでの非同期挿入を修正。 [#34068](https://github.com/ClickHouse/ClickHouse/pull/34068) ([Anton Popov](https://github.com/CurtizJ)).
* レプリケートされたアクセスストレージと keeper（clickhouse-server に組み込み）が両方使用されている場合に、サーバーが起動できなくなる不具合を修正しました。デフォルトユーザーの設定の代わりに、keeper のソケットタイムアウト用として `keeper_server.socket_receive_timeout_sec` と `keeper_server.socket_send_timeout_sec` の 2 つの設定を導入しました。[#33973](https://github.com/ClickHouse/ClickHouse/issues/33973) を修正。[#33988](https://github.com/ClickHouse/ClickHouse/pull/33988)（[alesapin](https://github.com/alesapin)）。
* フッターが破損した ORC ファイルのパース中に発生するセグメンテーションフォルトを修正。[#33797](https://github.com/ClickHouse/ClickHouse/issues/33797) をクローズ。[#33984](https://github.com/ClickHouse/ClickHouse/pull/33984)（[Kruglov Pavel](https://github.com/Avogar)）。
* クエリパラメータ（プリペアドステートメント）からの IPv6 の解析処理を修正し、IPv6 から文字列への変換を修正しました。 [#33928](https://github.com/ClickHouse/ClickHouse/issues/33928) をクローズ。 [#33971](https://github.com/ClickHouse/ClickHouse/pull/33971)（[Kruglov Pavel](https://github.com/Avogar)）。
* ネストされたタプルの読み取り時に発生するクラッシュを修正。[#33838](https://github.com/ClickHouse/ClickHouse/issues/33838) を解決。[#33956](https://github.com/ClickHouse/ClickHouse/pull/33956)（[Anton Popov](https://github.com/CurtizJ)）。
* 分散クエリにおいて、リテラル引数を取る関数 `array` および `tuple` の扱いを修正しました。以前は `Not found columns` 例外が発生する可能性がありました。[#33938](https://github.com/ClickHouse/ClickHouse/pull/33938) ([Anton Popov](https://github.com/CurtizJ))。
* 集約関数コンビネータ `-If` が `Nullable` 型のフィルター引数を正しく処理していませんでした。これにより [#27073](https://github.com/ClickHouse/ClickHouse/issues/27073) がクローズされました。 [#33920](https://github.com/ClickHouse/ClickHouse/pull/33920) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* リモートディスク読み取り時の潜在的なレースコンディションを修正しました（S3 上の仮想ファイルシステムは、本番利用にはまだ準備ができていない実験的機能です）。 [#33912](https://github.com/ClickHouse/ClickHouse/pull/33912) ([Amos Bird](https://github.com/amosbird)).
* 識別子ではない引数を持つラムダで SQL UDF が作成された場合にクラッシュする問題を修正しました。 [#33866](https://github.com/ClickHouse/ClickHouse/issues/33866) をクローズ。[#33868](https://github.com/ClickHouse/ClickHouse/pull/33868)（[Maksim Kita](https://github.com/kitaisreal)）。
* スパースカラムの使用を修正しました（実験的設定 `ratio_of_defaults_for_sparse_serialization` で有効化可能）。 [#33849](https://github.com/ClickHouse/ClickHouse/pull/33849) ([Anton Popov](https://github.com/CurtizJ))。
* `SYSTEM RESTORE REPLICA` クエリにおいて、実際にはレプリカが readonly であるにもかかわらず発生していた `replica is not readonly` という論理エラーを修正しました。[#33806](https://github.com/ClickHouse/ClickHouse/issues/33806) を解決します。[#33847](https://github.com/ClickHouse/ClickHouse/pull/33847)（[tavplubix](https://github.com/tavplubix)）。
* 圧縮が使用されている場合（デフォルト）の `clickhouse-keeper` におけるメモリリークを修正。 [#33840](https://github.com/ClickHouse/ClickHouse/pull/33840) ([Azat Khuzhin](https://github.com/azat))。
* 共通の型が存在しない場合のインデックス解析を修正しました。 [#33833](https://github.com/ClickHouse/ClickHouse/pull/33833) ([Amos Bird](https://github.com/amosbird)).
* `JSONEachRow` と `JSONCompactEachRow` のスキーマ推論を修正しました。 [#33830](https://github.com/ClickHouse/ClickHouse/pull/33830) ([Kruglov Pavel](https://github.com/Avogar)).
* `redis` ソースと多数のキーを持つ外部ディクショナリの利用時の問題を修正しました。 [#33804](https://github.com/ClickHouse/ClickHouse/pull/33804) ([Anton Popov](https://github.com/CurtizJ)).
* クライアントのバグを修正し、サーバー側で「Connection reset by peer」が発生していた問題を解消。 [#33309](https://github.com/ClickHouse/ClickHouse/issues/33309) をクローズ。 [#33790](https://github.com/ClickHouse/ClickHouse/pull/33790) ([Kruglov Pavel](https://github.com/Avogar)).
* クエリ `INSERT INTO ... VALUES SETTINGS ... (...), ...` の構文解析を修正 [#33776](https://github.com/ClickHouse/ClickHouse/pull/33776) ([Kruglov Pavel](https://github.com/Avogar))。
* ワイドフォーマットおよびプロジェクションを使用してデータパーツを作成する際の `CHECK TABLE` の不具合を修正。 [#33774](https://github.com/ClickHouse/ClickHouse/pull/33774) ([李扬](https://github.com/taiyang-li)).
* MergeTree における `count()` と INSERT/マージ/... の間のごく小さな競合状態を修正しました（`optimize_trivial_count_query` を用いた SELECT で誤った行数が返される可能性がありました）。[#33753](https://github.com/ClickHouse/ClickHouse/pull/33753) ([Azat Khuzhin](https://github.com/azat))。
* ストレージ HDFS でのディレクトリ一覧要求が失敗した場合に例外をスローするようにしました。 [#33724](https://github.com/ClickHouse/ClickHouse/pull/33724) ([LiuNeng](https://github.com/liuneng1994)).
* テーブルにプロジェクションが含まれている場合のミューテーションを修正しました。これにより [#33010](https://github.com/ClickHouse/ClickHouse/issues/33010) が修正されます。また、[#33275](https://github.com/ClickHouse/ClickHouse/issues/33275) も修正されます。[#33679](https://github.com/ClickHouse/ClickHouse/pull/33679)（[Amos Bird](https://github.com/amosbird)）。
* 名前付き HTTP セッション内で `CREATE TEMPORARY TABLE AS SELECT` が実行された場合に、現在のデータベースを正しく判定するようにしました。これは非常にまれなユースケースです。これにより [#8340](https://github.com/ClickHouse/ClickHouse/issues/8340) がクローズされました。 [#33676](https://github.com/ClickHouse/ClickHouse/pull/33676) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* ソート、LIMIT BY、ARRAY JOIN、ラムダ関数を含む一部のクエリを許可しました。これにより [#7462](https://github.com/ClickHouse/ClickHouse/issues/7462) がクローズされます。[#33675](https://github.com/ClickHouse/ClickHouse/pull/33675)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 「zero copy replication」（開発中の機能であり、本番環境では使用すべきではありません）において、TTL move の際にデータが重複してしまうバグを修正しました。[#33643](https://github.com/ClickHouse/ClickHouse/issues/33643) を解決します。[#33642](https://github.com/ClickHouse/ClickHouse/pull/33642)（[alesapin](https://github.com/alesapin)）。
* `optimize_aggregation_in_order = 1` の場合に発生する、`GroupingAggregatedTransform` において `Chunk should have AggregatedChunkInfo` と表示される問題を修正。 [#33637](https://github.com/ClickHouse/ClickHouse/pull/33637) ([Azat Khuzhin](https://github.com/azat)).
* テーブルにドットを含む名前の `Nested` カラムがあり、そのカラムに対してデフォルト値が生成される場合（例: 挿入時にそのカラムが指定されていない場合）に発生することがあるエラー `Bad cast from type ... to DB::DataTypeArray` を修正しました。[#28762](https://github.com/ClickHouse/ClickHouse/issues/28762) の続きです。[#33588](https://github.com/ClickHouse/ClickHouse/pull/33588)（[Alexey Pavlenko](https://github.com/alexeypavlenko)）。
* `lz4` ファイルへのエクスポートの問題を修正しました。[#31421](https://github.com/ClickHouse/ClickHouse/issues/31421) をクローズ。[#31862](https://github.com/ClickHouse/ClickHouse/pull/31862)（[Kruglov Pavel](https://github.com/Avogar)）。
* `group_by_overflow_mode` が `any`（近似的な GROUP BY）に設定されていて、`LowCardinality` 型の単一カラムで集約を実行した場合に発生する可能性があったクラッシュを修正しました。 [#34506](https://github.com/ClickHouse/ClickHouse/pull/34506) ([DR](https://github.com/freedomDR)).
* gRPC クライアントサーバープロトコル経由で一時テーブルへの INSERT を修正。[#34347](https://github.com/ClickHouse/ClickHouse/issues/34347) の issue `#2` を解決。[#34364](https://github.com/ClickHouse/ClickHouse/pull/34364)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 問題 [#19429](https://github.com/ClickHouse/ClickHouse/issues/19429) を修正しました。 [#34225](https://github.com/ClickHouse/ClickHouse/pull/34225)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 問題 [#18206](https://github.com/ClickHouse/ClickHouse/issues/18206) を修正しました。 [#33977](https://github.com/ClickHouse/ClickHouse/pull/33977)（[Vitaly Baranov](https://github.com/vitlibar)）。
* このPRにより、同一のユーザーディレクトリ一覧内で複数のLDAPストレージを使用できるようになります。これは以前は動作していましたが、LDAPテストが無効化されていたため（testflowsテストの一部であるため）動かなくなっていました。 [#33574](https://github.com/ClickHouse/ClickHouse/pull/33574) ([Vitaly Baranov](https://github.com/vitlibar))。

### <a id="221"></a> ClickHouse release v22.1, 2022-01-18 {#a-id221a-clickhouse-release-v221-2022-01-18}

#### アップグレード時の注意事項 {#upgrade-notes-4}

- `left`および`right`関数は以前はパーサーに実装されていましたが、現在は完全な機能を持つようになりました。クラスターに異なるバージョンのclickhouse-serverが含まれている場合、エイリアスなしで`left`または`right`関数を使用する分散クエリは例外をスローする可能性があります。クラスターのアップグレード中にこのエラーが発生した場合は、すべてのノードが同じバージョンになるようにアップグレードを完了してください。また、この問題を回避するために、クエリ内のカラムにエイリアス(`AS something`)を追加することもできます。[#33407](https://github.com/ClickHouse/ClickHouse/pull/33407) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- このバージョンからスカラーサブクエリによるリソース使用量が完全に計上されるようになりました。この変更により、スカラーサブクエリで読み取られた行数がquery_logに記録されるようになります。スカラーサブクエリがキャッシュされている場合(繰り返しまたは複数の行に対して呼び出される場合)、読み取られた行数は一度だけカウントされます。この変更により、スカラーサブクエリの実行中にクエリをKILLしたり、進行状況を報告したりできるようになります。[#32271](https://github.com/ClickHouse/ClickHouse/pull/32271) ([Raúl Marín](https://github.com/Algunenano))。

#### 新機能 {#new-feature-11}


* 入力フォーマットに対するデータスキーマ推論を実装しました。テーブル関数 `file`、`url`、`s3`、`hdfs` および `clickhouse-local` のパラメータで、構造の指定を省略（または単に `auto` と記述）できるようにしました。テーブルエンジン `File`、`HDFS`、`S3`、`URL`、`Merge`、`Buffer`、`Distributed` および `ReplicatedMergeTree`（新しいレプリカを追加する場合）に対する CREATE クエリで、構造の指定を省略できるようにしました。 [#32455](https://github.com/ClickHouse/ClickHouse/pull/32455) ([Kruglov Pavel](https://github.com/Avogar)).
* `file`/`hdfs`/`s3`/`url` テーブル関数および `HDFS`/`S3`/`URL` テーブルエンジン、さらに `SELECT INTO OUTFILE` と `INSERT FROM INFILE` について、ファイル拡張子によるフォーマットの自動検出に対応しました [#33565](https://github.com/ClickHouse/ClickHouse/pull/33565)（[Kruglov Pavel](https://github.com/Avogar)）。[#30918](https://github.com/ClickHouse/ClickHouse/issues/30918) をクローズ。[#33443](https://github.com/ClickHouse/ClickHouse/pull/33443)（[OnePiece](https://github.com/zhongyuankai)）。
* サポートが必要な際に診断データを収集するためのツール。[#33175](https://github.com/ClickHouse/ClickHouse/pull/33175)（[Alexander Burmak](https://github.com/Alex-Burmak)）。
* Zoo/Keeper を介した自動クラスタ検出。これにより、すべてのサーバーの設定を変更することなく、クラスタにレプリカを追加できます。 [#31442](https://github.com/ClickHouse/ClickHouse/pull/31442) ([vdimir](https://github.com/vdimir)).
* ClickHouse から Apache Hive にアクセスするための Hive テーブルエンジンを実装しました。次を実装しています: [#29245](https://github.com/ClickHouse/ClickHouse/issues/29245)。 [#31104](https://github.com/ClickHouse/ClickHouse/pull/31104) ([taiyang-li](https://github.com/taiyang-li))。
* 集計関数 `cramersV`、`cramersVBiasCorrected`、`theilsU`、`contingency` を追加しました。これらの関数はカテゴリ値間の依存関係（連関の尺度）を計算します。これらの関数はいずれも、実装にクロス集計（値のペアに対するヒストグラム）を使用しています。任意の離散値（必ずしも数値である必要はありません）に対する相関係数のようなものと考えることができます。 [#33366](https://github.com/ClickHouse/ClickHouse/pull/33366)（[alexey-milovidov](https://github.com/alexey-milovidov)）。初期実装は [Vanyok-All-is-OK](https://github.com/Vanyok-All-is-OK) および [antikvist](https://github.com/antikvist) によるものです。
* テーブル関数 `hdfsCluster` を追加しました。これにより、指定したクラスタ内の複数ノードから、`s3Cluster` と同様に HDFS 上のファイルを並列処理できるようになりました。 [#32400](https://github.com/ClickHouse/ClickHouse/pull/32400) ([Zhichang Yu](https://github.com/yuzhichang)).
* AWS S3 をバックエンドとするディスクに対して行われたのと同様の方法で、Azure Blob Storage をバックエンドとするディスクのサポートを追加しました。 [#31505](https://github.com/ClickHouse/ClickHouse/pull/31505) ([Jakub Kuklis](https://github.com/jkuklis))。
* すべての種類の `VIEW` に対する `CREATE VIEW` で `COMMENT` を許可しました。 [#31062](https://github.com/ClickHouse/ClickHouse/pull/31062) ([Vasily Nemkov](https://github.com/Enmk)).
* 構成変更時に、リッスンポートとプロトコルを動的に再初期化します。 [#30549](https://github.com/ClickHouse/ClickHouse/pull/30549) ([Kevin Michel](https://github.com/kmichel-aiven)).
* `left`、`right`、`leftUTF8`、`rightUTF8` 関数を追加しました。負のオフセット（文字列末尾からのオフセット）を指定した場合の `substringUTF8` 関数実装の不具合を修正しました。 [#33407](https://github.com/ClickHouse/ClickHouse/pull/33407) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `H3` 座標系に新しい関数 `h3HexAreaKm2`、`h3CellAreaM2`、`h3CellAreaRads2` を追加しました。 [#33479](https://github.com/ClickHouse/ClickHouse/pull/33479) ([Bharat Nallan](https://github.com/bharatnc)).
* `MONTHNAME` 関数を追加しました。[#33436](https://github.com/ClickHouse/ClickHouse/pull/33436)（[usurai](https://github.com/usurai)）。
* 関数 `arrayLast` を追加。 [#33390](https://github.com/ClickHouse/ClickHouse/issues/33390) をクローズ。 [#33415](https://github.com/ClickHouse/ClickHouse/pull/33415) で関数 `arrayLastIndex` を追加。 [#33465](https://github.com/ClickHouse/ClickHouse/pull/33465) ([Maksim Kita](https://github.com/kitaisreal))。
* `decodeURLComponent` とわずかに動作が異なる関数 `decodeURLFormComponent` を追加。 [#10298](https://github.com/ClickHouse/ClickHouse/issues/10298) をクローズ。 [#33451](https://github.com/ClickHouse/ClickHouse/pull/33451) ([SuperDJY](https://github.com/cmsxbc)).
* プレーンなメトリクスとタグ付きメトリクスで `GraphiteMergeTree` のロールアップルールを分割できるようにしました（オプションの `rule_type` フィールド）。 [#33494](https://github.com/ClickHouse/ClickHouse/pull/33494) ([Michail Safronov](https://github.com/msaf1980)).

#### パフォーマンス改善 {#performance-improvement-11}

- すべての基礎テーブルが`PREWHERE`をサポートしている場合、`Merge`エンジンのテーブルに対して条件を`PREWHERE`に移動することをサポート(設定`optimize_move_to_prewhere`)。[#33300](https://github.com/ClickHouse/ClickHouse/pull/33300) ([Anton Popov](https://github.com/CurtizJ))。
- URLストレージのglobのより効率的な処理。リトライ機能を備えた並列処理により、数百万のURLを簡単にクエリできるようになりました。Closes [#32866](https://github.com/ClickHouse/ClickHouse/issues/32866)。[#32907](https://github.com/ClickHouse/ClickHouse/pull/32907) ([Kseniia Sumarokova](https://github.com/kssenii))。
- パーサーにおける指数関数的なバックトラッキングを回避。This closes [#20158](https://github.com/ClickHouse/ClickHouse/issues/20158)。[#33481](https://github.com/ClickHouse/ClickHouse/pull/33481) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `untuple`関数の乱用がクエリ解析の指数関数的な複雑さを引き起こしていました(ファザーにより発見)。This closes [#33297](https://github.com/ClickHouse/ClickHouse/issues/33297)。[#33445](https://github.com/ClickHouse/ClickHouse/pull/33445) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 文字列属性を持つディクショナリの割り当てメモリを削減。[#33466](https://github.com/ClickHouse/ClickHouse/pull/33466) ([Maksim Kita](https://github.com/kitaisreal))。
- `reinterpret`関数のわずかなパフォーマンス改善。[#32587](https://github.com/ClickHouse/ClickHouse/pull/32587) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 重要でない変更。すべてのレプリカでデータパートが失われるという極めて稀なケースにおいて、一部のデータパートのマージ後、後続のクエリがパーティションプルーニング中にスキップするパーティション数が少なくなる可能性があります。これはほとんど影響を与えません。[#32220](https://github.com/ClickHouse/ClickHouse/pull/32220) ([Azat Khuzhin](https://github.com/azat))。
- サイズ計算ロジックの最適化により`clickhouse-keeper`の書き込みパフォーマンスを改善。[#32366](https://github.com/ClickHouse/ClickHouse/pull/32366) ([zhanglistar](https://github.com/zhanglistar))。
- 単一パートプロジェクションのマテリアライゼーションを最適化。This closes [#31669](https://github.com/ClickHouse/ClickHouse/issues/31669)。[#31885](https://github.com/ClickHouse/ClickHouse/pull/31885) ([Amos Bird](https://github.com/amosbird))。
- システムテーブルのクエリパフォーマンスを改善。[#33312](https://github.com/ClickHouse/ClickHouse/pull/33312) ([OnePiece](https://github.com/zhongyuankai))。
- ボリューム間で移動可能なMergeTreeパーツの選択を最適化。[#33225](https://github.com/ClickHouse/ClickHouse/pull/33225) ([OnePiece](https://github.com/zhongyuankai))。
- 連続キーを使用した`sparse_hashed`ディクショナリのパフォーマンスを修正(誤ったハッシュ関数)。[#32536](https://github.com/ClickHouse/ClickHouse/pull/32536) ([Azat Khuzhin](https://github.com/azat))。

#### 実験的機能 {#experimental-feature-10}


- サンプルキーを使用せずに、分散クエリ実行時にシャード内の複数のレプリカから並列読み取りを行う機能。有効にするには、`allow_experimental_parallel_reading_from_replicas = 1` および `max_parallel_replicas` を任意の数値に設定します。これにより [#26748](https://github.com/ClickHouse/ClickHouse/issues/26748) が解決されます。[#29279](https://github.com/ClickHouse/ClickHouse/pull/29279) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- スパースシリアライゼーションを実装しました。デフォルト値(ゼロ)を多く含むカラムに対して、ディスク使用量を削減し、一部のクエリのパフォーマンスを向上させることができます。`ratio_for_sparse_serialization` を設定することで有効化できます。カラムのデフォルト値の数と全値の数の比率がその閾値を超える場合、スパースシリアライゼーションが動的に選択されます。シリアライゼーション(デフォルトまたはスパース)はパート内の各カラムに対して固定されますが、パート間では異なる場合があります。[#22535](https://github.com/ClickHouse/ClickHouse/pull/22535) ([Anton Popov](https://github.com/CurtizJ))。
- MaterializedMySQLテーブルスキーマをカスタマイズするための「TABLE OVERRIDE」機能を追加しました。[#32325](https://github.com/ClickHouse/ClickHouse/pull/32325) ([Stig Bakken](https://github.com/stigsb))。
- `EXPLAIN TABLE OVERRIDE` クエリを追加しました。[#32836](https://github.com/ClickHouse/ClickHouse/pull/32836) ([Stig Bakken](https://github.com/stigsb))。
- MaterializedPostgreSQLに対するTABLE OVERRIDE句をサポートしました。RFC: [#31480](https://github.com/ClickHouse/ClickHouse/issues/31480)。[#32749](https://github.com/ClickHouse/ClickHouse/pull/32749) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 共有データのゼロコピーマークに対するZooKeeperパスを変更しました。「ゼロコピーレプリケーション」は本番環境向けではない機能(開発初期段階)であり、使用すべきではありません。ただし、既に使用している場合は、この変更に注意してください。[#32061](https://github.com/ClickHouse/ClickHouse/pull/32061) ([ianton-ru](https://github.com/ianton-ru))。
- WINDOW VIEW watchクエリに対するEvents句のサポートを追加しました。[#32607](https://github.com/ClickHouse/ClickHouse/pull/32607) ([vxider](https://github.com/Vxider))。
- `clickhouse-keeper`における明示的な数値ハッシュを持つACLを修正しました。これにより、動作がZooKeeperと一致し、生成されたダイジェストが常に受け入れられるようになりました。[#33249](https://github.com/ClickHouse/ClickHouse/pull/33249) ([小路](https://github.com/nicelulu))。[#33246](https://github.com/ClickHouse/ClickHouse/pull/33246)。
- パーツをデタッチする際の予期しないプロジェクション削除を修正しました。[#32067](https://github.com/ClickHouse/ClickHouse/pull/32067) ([Amos Bird](https://github.com/amosbird))。

#### 改善 {#improvement-11}


* `1970-01-01 00:00:00` より前の時刻を生成する日付時刻変換関数は、オーバーフローするのではなくゼロに飽和するようになりました。 [#29953](https://github.com/ClickHouse/ClickHouse/pull/29953) ([Amos Bird](https://github.com/amosbird))。また、日付切り捨て関数が Unix epoch より前の結果を返しうる場合のインデックス解析におけるバグも修正しました。
* クライアントでリソース使用量（合計 CPU 使用量、合計 RAM 使用量、およびホストごとの最大 RAM 使用量）を常に表示するようにしました。 [#33271](https://github.com/ClickHouse/ClickHouse/pull/33271) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `Bool` 型のシリアライズおよびデシリアライズを改善し、値の範囲チェックを行いました。 [#32984](https://github.com/ClickHouse/ClickHouse/pull/32984) ([Kruglov Pavel](https://github.com/Avogar)).
* `SET` クエリまたは HTTP リクエスト内のクエリパラメータを使用して無効な設定が定義された場合、エラーメッセージには、その無効な設定文字列に類似した候補（存在する場合）が含まれます。 [#32946](https://github.com/ClickHouse/ClickHouse/pull/32946) ([Antonio Andelic](https://github.com/antonio2368))。
* clickhouse-client と clickhouse-local で、誤った設定名が入力された場合に候補を示すヒントをサポート。 [#32237](https://github.com/ClickHouse/ClickHouse/issues/32237) をクローズ。 [#32841](https://github.com/ClickHouse/ClickHouse/pull/32841)（[凌涛](https://github.com/lingtaolf)）。
* マテリアライズドビューで仮想カラムを使用できるようにしました。[#11210](https://github.com/ClickHouse/ClickHouse/issues/11210) をクローズ。[#33482](https://github.com/ClickHouse/ClickHouse/pull/33482)（[OnePiece](https://github.com/zhongyuankai)）。
* 必要に応じて clickhouse-keeper で IPv6 を無効化できる設定を追加しました。これにより [#33381](https://github.com/ClickHouse/ClickHouse/issues/33381) がクローズされました。[#33450](https://github.com/ClickHouse/ClickHouse/pull/33450)（[Wu Xueyang](https://github.com/wuxueyang96)）。
* `system.build_options` に現在の git リビジョンに関する詳細情報を追加しました。 [#33431](https://github.com/ClickHouse/ClickHouse/pull/33431) ([taiyang-li](https://github.com/taiyang-li)).
* `clickhouse-local`: `--max_memory_usage_in_client` オプションでメモリ使用量を監視するようにしました。 [#33341](https://github.com/ClickHouse/ClickHouse/pull/33341) ([Azat Khuzhin](https://github.com/azat)).
* 関数 `intervalLengthSum` で負の間隔を許可しました。負の間隔の長さも合計に含まれます。これにより [#33323](https://github.com/ClickHouse/ClickHouse/issues/33323) が解決されました。 [#33335](https://github.com/ClickHouse/ClickHouse/pull/33335)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `LineAsString` は出力フォーマットとして使用できるようになりました。これにより [#30919](https://github.com/ClickHouse/ClickHouse/issues/30919) がクローズされました。[#33331](https://github.com/ClickHouse/ClickHouse/pull/33331)（[Sergei Trifonov](https://github.com/serxa)）。
* クラスタ設定で `<secure>1</secure>` の代替形式として `<secure/>` をサポート。 [#33270](https://github.com/ClickHouse/ClickHouse/issues/33270) をクローズ。 [#33330](https://github.com/ClickHouse/ClickHouse/pull/33330) ([SuperDJY](https://github.com/cmsxbc))。
* Ctrl+C を 2 回押すと、実行中のクエリの完了を待たずに `clickhouse-benchmark` を即座に終了できます。これにより [#32586](https://github.com/ClickHouse/ClickHouse/issues/32586) がクローズされました。[#33303](https://github.com/ClickHouse/ClickHouse/pull/33303)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `parseDateTimeBestEffort` 関数でミリ秒精度の Unix タイムスタンプをサポート。[#33276](https://github.com/ClickHouse/ClickHouse/pull/33276) ([Ben](https://github.com/benbiti))。
* 外部テーブルから `Arrow` / `Parquet` / `ORC` 形式でデータを読み込んでいる最中にクエリをキャンセルできるようにしました。大きなファイルで、かつ設定 `input_format_allow_seeks` が false の場合にキャンセルに失敗していた問題を修正しました。 [#29678](https://github.com/ClickHouse/ClickHouse/issues/29678) をクローズ。 [#33238](https://github.com/ClickHouse/ClickHouse/pull/33238)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* テーブルエンジンが `SETTINGS` 句をサポートしている場合、設定をキーと値の組、またはコンフィグ経由で渡せるようにします。このサポートを MySQL 向けに追加しました。 [#33231](https://github.com/ClickHouse/ClickHouse/pull/33231) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 必要に応じて Nullable な主キーを正しく禁止します。これは [#32780](https://github.com/ClickHouse/ClickHouse/issues/32780) への対応です。[#33218](https://github.com/ClickHouse/ClickHouse/pull/33218)（[Amos Bird](https://github.com/amosbird)）。
* まだ何もフェッチされていない場合に `PostgreSQL` 接続をリトライする処理を追加しました。 [#33199](https://github.com/ClickHouse/ClickHouse/issues/33199) をクローズ。 [#33209](https://github.com/ClickHouse/ClickHouse/pull/33209)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 外部辞書の設定キーをバリデート。 [#33095](https://github.com/ClickHouse/ClickHouse/issues/33095#issuecomment-1000577517)。 [#33130](https://github.com/ClickHouse/ClickHouse/pull/33130) ([Kseniia Sumarokova](https://github.com/kssenii))。
* `clickhouse-local` 内でプロファイル情報を送信する機能を追加。 [#33093](https://github.com/ClickHouse/ClickHouse/issues/33093) をクローズ。 [#33097](https://github.com/ClickHouse/ClickHouse/pull/33097)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* ショートサーキット評価: 関数 `throwIf` をサポート。 [#32969](https://github.com/ClickHouse/ClickHouse/issues/32969) をクローズ。 [#32973](https://github.com/ClickHouse/ClickHouse/pull/32973)（[Maksim Kita](https://github.com/kitaisreal)）。
* （これは非公式ビルドでのみ発生します）。圧縮された Decimal、String、FixedString、Array カラムにデータを挿入する際に発生していたセグメンテーションフォルトを修正しました。これにより [#32939](https://github.com/ClickHouse/ClickHouse/issues/32939) がクローズされます。[#32940](https://github.com/ClickHouse/ClickHouse/pull/32940)（[N. Kolotov](https://github.com/nkolotov)）。
* サブクエリを SQL ユーザー定義関数として指定できるようにしました。例: `CREATE FUNCTION test AS () -> (SELECT 1)`。[#30755](https://github.com/ClickHouse/ClickHouse/issues/30755) をクローズ。[#32758](https://github.com/ClickHouse/ClickHouse/pull/32758)（[Maksim Kita](https://github.com/kitaisreal)）。
* gRPC の圧縮サポートを改善しました [#28671](https://github.com/ClickHouse/ClickHouse/issues/28671)。 [#32747](https://github.com/ClickHouse/ClickHouse/pull/32747) ([Vitaly Baranov](https://github.com/vitlibar))。
* サーバーのシャットダウン時またはテーブルのデタッチ時に、WAL が有効になっていない場合はすべてのインメモリデータパーツをフラッシュするようにしました。 [#32742](https://github.com/ClickHouse/ClickHouse/pull/32742) ([nauta](https://github.com/nautaa)).
* MySQL の接続タイムアウトを制御できるようにしました（これまではディクショナリのソースに対してのみサポートされていました）。[#16669](https://github.com/ClickHouse/ClickHouse/issues/16669) をクローズします。以前はデフォルトの connect&#95;timeout がかなり短く設定されていましたが、現在は変更可能になりました。[#32734](https://github.com/ClickHouse/ClickHouse/pull/32734)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* ストレージ `MongoDB` で `authSource` オプションをサポート。 [#32594](https://github.com/ClickHouse/ClickHouse/issues/32594) をクローズ。 [#32702](https://github.com/ClickHouse/ClickHouse/pull/32702)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `genarateRandom` テーブル関数で `Date32` 型をサポートしました。 [#32643](https://github.com/ClickHouse/ClickHouse/pull/32643) ([nauta](https://github.com/nautaa))。
* クエリ種別ごとの同時実行クエリ数を制御するために、`max_concurrent_select_queries` と `max_concurrent_insert_queries` の設定を追加しました。 [#3575](https://github.com/ClickHouse/ClickHouse/issues/3575) をクローズ。 [#32609](https://github.com/ClickHouse/ClickHouse/pull/32609) ([SuperDJY](https://github.com/cmsxbc)).
* `Protobuf` フォーマットでデータを読み取る際に、カラムが欠損しているネストされた構造の処理を改善しました。[https://github.com/ClickHouse/ClickHouse/pull/31988](https://github.com/ClickHouse/ClickHouse/pull/31988) のフォローアップです。[#32531](https://github.com/ClickHouse/ClickHouse/pull/32531)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `MongoDB` エンジンで空のクレデンシャルを許可します。 [#26267](https://github.com/ClickHouse/ClickHouse/issues/26267) をクローズします。 [#32460](https://github.com/ClickHouse/ClickHouse/pull/32460)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 例外を引き起こす可能性のあるウィンドウ関数向けの一部の最適化を無効化しました。[#31535](https://github.com/ClickHouse/ClickHouse/issues/31535) をクローズ。[#31620](https://github.com/ClickHouse/ClickHouse/issues/31620) をクローズ。[#32453](https://github.com/ClickHouse/ClickHouse/pull/32453)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* MongoDB 5.0 への接続を可能にします。[#31483](https://github.com/ClickHouse/ClickHouse/issues/31483)、[#32416](https://github.com/ClickHouse/ClickHouse/pull/32416) をクローズします（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `Decimal` と `Float` の比較を可能にしました。 [#22626](https://github.com/ClickHouse/ClickHouse/issues/22626) をクローズ。 [#31966](https://github.com/ClickHouse/ClickHouse/pull/31966) ([flynn](https://github.com/ucasFL)).
* `StorageExecutable`、`StorageExecutablePool`、`ExecutableDictionary`、`ExecutablePoolDictionary`、`ExecutableUserDefinedFunctions` に `command_read_timeout`、`command_write_timeout` 設定を追加しました。`command_read_timeout` は、コマンドの stdout からデータを読み取る際のタイムアウトをミリ秒単位で制御します。`command_write_timeout` は、コマンドの stdin へデータを書き込む際のタイムアウトをミリ秒単位で制御します。`ExecutableUserDefinedFunction`、`ExecutableDictionary`、`StorageExecutable` に `command_termination_timeout` 設定を追加しました。`ExecutableUserDefinedFunction` に `execute_direct` 設定を追加し、デフォルト値は true です。`ExecutableDictionary`、`ExecutablePoolDictionary` にも `execute_direct` 設定を追加し、デフォルト値は false です。 [#30957](https://github.com/ClickHouse/ClickHouse/pull/30957) ([Maksim Kita](https://github.com/kitaisreal))。
* ビットマップ集約関数は、引数が範囲外の場合でもラップアラウンドせず、正しい結果を返すようになりました。 [#33127](https://github.com/ClickHouse/ClickHouse/pull/33127) ([DR](https://github.com/freedomDR)).
* `FROM INFILE` ステートメントを含む誤ったクエリのパースを修正。[#33521](https://github.com/ClickHouse/ClickHouse/pull/33521)（[Kruglov Pavel](https://github.com/Avogar)）。
* パスにグロブが含まれている場合は `S3` への書き込みを許可しないようにしました。 [#33142](https://github.com/ClickHouse/ClickHouse/pull/33142) ([Kruglov Pavel](https://github.com/Avogar)).
* バッチモードで単一クエリを実行する際、`clickhouse-client` で `--echo` オプションが使用されていませんでした。 [#32843](https://github.com/ClickHouse/ClickHouse/pull/32843) ([N. Kolotov](https://github.com/nkolotov)).
* clickhouse-local で `--database` オプションを使用できるようになりました。 [#32797](https://github.com/ClickHouse/ClickHouse/pull/32797) ([Kseniia Sumarokova](https://github.com/kssenii)).
* SQL 通常関数 `file` の、驚くほど質の悪いコードを修正しました。これにより、シンボリックリンクをサポートするようになりました。 [#32640](https://github.com/ClickHouse/ClickHouse/pull/32640) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* パーツ移動後に `system.parts` 内のデータパーツの `modification_time` を更新。[#32964](https://github.com/ClickHouse/ClickHouse/issues/32964)、[#32965](https://github.com/ClickHouse/ClickHouse/pull/32965)（[save-my-heart](https://github.com/save-my-heart)）。
* 潜在的な問題だが、悪用は不可能です: 配列のリサイズ時に整数オーバーフローが発生する可能性があります。 [#33024](https://github.com/ClickHouse/ClickHouse/pull/33024) ([varadarajkumar](https://github.com/varadarajkumar)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-11}

- ClickHouseのAArch64（ARM）版のパッケージ、機能テスト、Dockerビルドを追加しました。[#32911](https://github.com/ClickHouse/ClickHouse/pull/32911) ([Mikhail f. Shiryaev](https://github.com/Felixoid)). [#32415](https://github.com/ClickHouse/ClickHouse/pull/32415)
- musl-libcでClickHouseをビルドできるように準備しました。デフォルトでは有効になっていません。[#33134](https://github.com/ClickHouse/ClickHouse/pull/33134) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- FreeBSD上でインストールスクリプトが動作するようにしました。これにより[#33384](https://github.com/ClickHouse/ClickHouse/issues/33384)が解決されます。[#33418](https://github.com/ClickHouse/ClickHouse/pull/33418) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- GitHub Actionsワークフロー用に`actionlint`を追加し、`act --list`を使用してワークフローファイルを検証することで、正しいワークフロー構文をチェックします。[#33612](https://github.com/ClickHouse/ClickHouse/pull/33612) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
- nullable主キー機能のテストを追加しました。異なる型とマージツリーの種類、およびランダムに生成されたデータを使用したテストを追加しました。[#33228](https://github.com/ClickHouse/ClickHouse/pull/33228) ([Amos Bird](https://github.com/amosbird)).
- Webブラウザで不安定なテストを可視化するシンプルなツールを追加しました。[#33185](https://github.com/ClickHouse/ClickHouse/pull/33185) ([alexey-milovidov](https://github.com/alexey-milovidov)).
- 共有ビルドのハーメチックビルドを有効にしました。これは主に開発者向けです。[#32968](https://github.com/ClickHouse/ClickHouse/pull/32968) ([Amos Bird](https://github.com/amosbird)).
- `libc++`と`libc++abi`を最新版に更新しました。[#32484](https://github.com/ClickHouse/ClickHouse/pull/32484) ([Raúl Marín](https://github.com/Algunenano)).
- 外部.NETクライアント（[ClickHouse.Client](https://github.com/DarkWanderer/ClickHouse.Client)）の統合テストを追加しました。[#23230](https://github.com/ClickHouse/ClickHouse/pull/23230) ([Oleg V. Kozlyuk](https://github.com/DarkWanderer)).
- clickhouseバイナリファイルにgit情報を注入しました。これにより、clickhouseバイナリファイルからソースコードのリビジョンを簡単に取得できます。[#33124](https://github.com/ClickHouse/ClickHouse/pull/33124) ([taiyang-li](https://github.com/taiyang-li)).
- ConfigProcessorから古いコードを削除しました。Yandex固有のコードは使用されなくなりました。このコードには軽微な不具合が含まれていました。この不具合は[Mallik Hassan](https://github.com/SadiHassan)により[#33032](https://github.com/ClickHouse/ClickHouse/issues/33032)で報告されました。これにより[#33032](https://github.com/ClickHouse/ClickHouse/issues/33032)が解決されます。[#33026](https://github.com/ClickHouse/ClickHouse/pull/33026) ([alexey-milovidov](https://github.com/alexey-milovidov)).

#### バグ修正（公式安定版またはプレ安定版リリースにおけるユーザーに見える不具合） {#bug-fix-user-visible-misbehavior-in-official-stable-or-prestable-release-4}


* フォーマットのパースに関する複数の修正を行いました。これは、`clickhouse-server` が攻撃者による書き込みアクセスに対して開かれている場合に該当します。細工された `Native` フォーマットの入力データにより、未初期化メモリの読み取りやクラッシュが発生する可能性があります。これは、`clickhouse-server` が攻撃者による書き込みアクセスに対して開かれている場合に該当します。 [#33050](https://github.com/ClickHouse/ClickHouse/pull/33050) ([Heena Bansal](https://github.com/HeenaBansal2009))。Apache Avro バイナリフォーマットにおける Apache Avro Union 型のインデックスの境界外アクセス問題を修正しました。 [#33022](https://github.com/ClickHouse/ClickHouse/pull/33022) ([Harry Lee](https://github.com/HarryLeeIBM))。`Native` フォーマットで `LowCardinality` データをデシリアライズする際に発生する、`LowCardinality` データでのヌルポインタ逆参照を修正しました。 [#33021](https://github.com/ClickHouse/ClickHouse/pull/33021) ([Harry Lee](https://github.com/HarryLeeIBM))。
* ClickHouse Keeper のハンドラーが、レスポンス送信時にオペレーションを正しく削除するようになりました。 [#32988](https://github.com/ClickHouse/ClickHouse/pull/32988) ([JackyWoo](https://github.com/JackyWoo)).
* クォータのオフバイワン計算誤りの可能性: クォータ上限には達していないにもかかわらず、上限を超過してしまう問題を修正しました。これにより [#31174](https://github.com/ClickHouse/ClickHouse/issues/31174) が解消されます。 [#31656](https://github.com/ClickHouse/ClickHouse/pull/31656) ([sunny](https://github.com/sunny19930321))。
* String から IPv4 または IPv6 への CAST と、その逆方向の CAST を修正しました。変換に失敗した場合のエラーメッセージを修正しました。 [#29224](https://github.com/ClickHouse/ClickHouse/pull/29224) ([Dmitry Novik](https://github.com/novikd)) [#27914](https://github.com/ClickHouse/ClickHouse/pull/27914) ([Vasily Nemkov](https://github.com/Enmk)).
* リモートサーバーでの実行時に発生する `Unknown aggregate function nothing` のような例外を修正しました。これにより [#16689](https://github.com/ClickHouse/ClickHouse/issues/16689) が解決されました。 [#26074](https://github.com/ClickHouse/ClickHouse/pull/26074) ([hexiaoting](https://github.com/hexiaoting))。
* 分散クエリにおいて、データベースを明示的に指定していない `JOIN` で誤ったデータベースが使用される問題を修正（修正対象: [#10471](https://github.com/ClickHouse/ClickHouse/issues/10471)）。[#33611](https://github.com/ClickHouse/ClickHouse/pull/33611)（[Azat Khuzhin](https://github.com/azat)）。
* ファイルへの 2 回目の挿入後に発生する Apache `Avro` フォーマットでのセグメンテーションフォルトを修正。 [#33566](https://github.com/ClickHouse/ClickHouse/pull/33566) ([Kruglov Pavel](https://github.com/Avogar)).
* スキーマに `Dictionary` 型が含まれている場合に Apache `Arrow` フォーマットで発生するセグメンテーションフォルトを修正。 [#33507](https://github.com/ClickHouse/ClickHouse/issues/33507) をクローズ。 [#33529](https://github.com/ClickHouse/ClickHouse/pull/33529)（[Kruglov Pavel](https://github.com/Avogar)）。
* ビューに対して帯域外の `offset` および `limit` 設定が誤って適用される場合があります。[#33289](https://github.com/ClickHouse/ClickHouse/issues/33289) [#33518](https://github.com/ClickHouse/ClickHouse/pull/33518)（[hexiaoting](https://github.com/hexiaoting)）をクローズ。
* デフォルト値を持つ入れ子の `LowCardinality` カラムを含むテーブルへの挿入時に発生する可能性がある例外 `Block structure mismatch` を修正しました。 [#33028](https://github.com/ClickHouse/ClickHouse/issues/33028) を修正。 [#33504](https://github.com/ClickHouse/ClickHouse/pull/33504)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* DDL を使用して作成された場合の、`range_hashed` の range min および range max 属性に対する辞書式を修正しました。 [#30809](https://github.com/ClickHouse/ClickHouse/issues/30809) をクローズ。 [#33478](https://github.com/ClickHouse/ClickHouse/pull/33478)（[Maksim Kita](https://github.com/kitaisreal)）。
* 同時に実行される DROP と組み合わせたマテリアライズドビューへの INSERT で発生し得る use-after-free の問題を修正しました（[Azat Khuzhin](https://github.com/azat)）。
* EOF を超えて読み取ろうとしてはいけません（Linux カーネルのバグの回避策として行わないでください）。このバグはカーネル (3.14..5.9) で再現可能であり、そのためには `index_granularity_bytes=0`（つまりアダプティブインデックス粒度を無効化する）が必要です。 [#33372](https://github.com/ClickHouse/ClickHouse/pull/33372) ([Azat Khuzhin](https://github.com/azat)).
* コマンド `SYSTEM SUSPEND` および `SYSTEM ... THREAD FUZZER` にアクセス制御が実装されていませんでしたが、修正されました。作者: Kevin Michel。 [#33333](https://github.com/ClickHouse/ClickHouse/pull/33333) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `system.tables`、`system.dictionaries` に辞書の `COMMENT` が表示されない問題を修正しました。`Dictionary` エンジンのコメントを変更できるようにしました。[#33251](https://github.com/ClickHouse/ClickHouse/issues/33251) をクローズ。 [#33261](https://github.com/ClickHouse/ClickHouse/pull/33261) ([Maksim Kita](https://github.com/kitaisreal))。
* 非同期挿入（設定 `async_insert` を有効にしたもの）をクエリログに記録するようにしました。これまではそのようなクエリはクエリログに出力されていませんでした。 [#33239](https://github.com/ClickHouse/ClickHouse/pull/33239) ([Anton Popov](https://github.com/CurtizJ)).
* 外部データベースへのクエリで `WHERE 1 = 0` という式が送信される問題を修正。[#33152](https://github.com/ClickHouse/ClickHouse/issues/33152) をクローズ。[#33214](https://github.com/ClickHouse/ClickHouse/pull/33214)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* MaterializedPostgreSQL の DDL 検証を修正しました。`materialized_postgresql_allow_automatic_update` 設定を修正しました。[#29535](https://github.com/ClickHouse/ClickHouse/issues/29535) をクローズしました。[#33200](https://github.com/ClickHouse/ClickHouse/pull/33200)（[Kseniia Sumarokova](https://github.com/kssenii)）。未使用のレプリケーションスロットが常に削除されるようにしました。[#26952](https://github.com/ClickHouse/ClickHouse/issues/26952) で判明。[#33187](https://github.com/ClickHouse/ClickHouse/pull/33187)（[Kseniia Sumarokova](https://github.com/kssenii)）。デフォルト以外のスキーマを持つテーブルに対する MaterializedPostgreSQL の detach/attach（レプリケーションからの削除／追加）を修正しました。[#29535](https://github.com/ClickHouse/ClickHouse/issues/29535) で判明。[#33179](https://github.com/ClickHouse/ClickHouse/pull/33179)（[Kseniia Sumarokova](https://github.com/kssenii)）。DROP MaterializedPostgreSQL データベースを修正しました。[#33468](https://github.com/ClickHouse/ClickHouse/pull/33468)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* メトリクス `StorageBufferBytes` が、時折誤って算出されていました。 [#33159](https://github.com/ClickHouse/ClickHouse/pull/33159) ([xuyatian](https://github.com/xuyatian))。
* `local_filesystem_read_prefetch` または `remote_filesystem_read_prefetch` が有効な状態で `LowCardinality` カラムを読み込む場合に発生する `Invalid version for SerializationLowCardinality key column` エラーを修正しました。 [#33046](https://github.com/ClickHouse/ClickHouse/pull/33046) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 空のファイルを読み込んでしまう `s3` テーブル関数を修正。[#33008](https://github.com/ClickHouse/ClickHouse/issues/33008) をクローズ。[#33037](https://github.com/ClickHouse/ClickHouse/pull/33037)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* cancel&#95;http&#95;readonly&#95;queries&#95;on&#95;client&#95;close の場合に発生していた Context のリークを修正しました（サーバーにアップロードされた外部テーブルやその他のリソースが解放されずに残ってしまう問題）。 [#32982](https://github.com/ClickHouse/ClickHouse/pull/32982) ([Azat Khuzhin](https://github.com/azat))。
* カスタムの CSV 区切り文字を使用した場合に、`CSV` フォーマットでタプルが誤って出力される問題を修正しました。 [#32981](https://github.com/ClickHouse/ClickHouse/pull/32981) ([Kruglov Pavel](https://github.com/Avogar)).
* HA namenode アドレスを使用できなかった HDFS URL チェックを修正しました。このバグは [https://github.com/ClickHouse/ClickHouse/pull/31042](https://github.com/ClickHouse/ClickHouse/pull/31042) で導入されました。 [#32976](https://github.com/ClickHouse/ClickHouse/pull/32976) ([Kruglov Pavel](https://github.com/Avogar))。
* 位置引数ではない引数に対して「positional argument out of bounds」のような例外がスローされる不具合を修正しました。 [#31173](https://github.com/ClickHouse/ClickHouse/issues/31173)#event-5789668239 をクローズ。 [#32961](https://github.com/ClickHouse/ClickHouse/pull/32961) ([Kseniia Sumarokova](https://github.com/kssenii))。
* HTTP クエリからセットを構築している最中に予期しない EOF が発生した場合の未定義動作（UB）を修正しました（クライアントが途中で切断した場合など。例: `timeout 0.15s curl -Ss -F 's=@t.csv;' 'http://127.0.0.1:8123/?s_structure=key+Int&query=SELECT+dummy+IN+s'` かつ `t.csv` が十分に大きい場合）。 [#32955](https://github.com/ClickHouse/ClickHouse/pull/32955) ([Azat Khuzhin](https://github.com/azat)).
* `replaceRegexpAll` 関数のリグレッションを修正しました。マッチした部分文字列が空の場合、この関数は正しく動作していませんでした。これにより [#32777](https://github.com/ClickHouse/ClickHouse/issues/32777) がクローズされます。これにより [#30245](https://github.com/ClickHouse/ClickHouse/issues/30245) がクローズされます。 [#32945](https://github.com/ClickHouse/ClickHouse/pull/32945)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `ORC` フォーマットのストライプ読み取りを修正。[#32929](https://github.com/ClickHouse/ClickHouse/pull/32929) ([kreuzerkrieg](https://github.com/kreuzerkrieg))。
* `topKWeightedState` が一部の入力型で失敗していました。 [#32487](https://github.com/ClickHouse/ClickHouse/issues/32487)。 [#32914](https://github.com/ClickHouse/ClickHouse/pull/32914)（[vdimir](https://github.com/vdimir)）。
* マテリアライズドビューで発生する例外 `Single chunk is expected from view inner query (LOGICAL_ERROR)` を修正。 [#31419](https://github.com/ClickHouse/ClickHouse/issues/31419) を修正。 [#32862](https://github.com/ClickHouse/ClickHouse/pull/32862)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* リモートファイルシステムからの非同期読み取りにおける lazy seek 最適化を修正。[#32803](https://github.com/ClickHouse/ClickHouse/issues/32803) をクローズ。[#32835](https://github.com/ClickHouse/ClickHouse/pull/32835)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `MergeTree` テーブルエンジンが、実行中のミューテーションが多すぎる場合やメモリ消費量が高い場合に、一部のミューテーションを暗黙的にスキップしてしまう可能性がある問題を修正しました。Fixes [#17882](https://github.com/ClickHouse/ClickHouse/issues/17882)。[#32814](https://github.com/ClickHouse/ClickHouse/pull/32814) ([tavplubix](https://github.com/tavplubix))。
* MV のブロックを処理する際に、スカラサブクエリキャッシュを再利用しないようにしました。これにより、スカラサブクエリがソーステーブルを参照している場合のバグが修正されますが、その代わりに MV 定義内のすべてのスカラサブクエリが各ブロックごとに計算されることになります。 [#32811](https://github.com/ClickHouse/ClickHouse/pull/32811) ([Raúl Marín](https://github.com/Algunenano))。
* `MySQL` エンジンを使用するデータベースが MySQL サーバーに接続できない場合に、サーバーが起動に失敗することがある問題を修正しました。 [#14441](https://github.com/ClickHouse/ClickHouse/issues/14441) を修正。 [#32802](https://github.com/ClickHouse/ClickHouse/pull/32802) ([tavplubix](https://github.com/tavplubix))。
* `fuzzBits` 関数の使用時に発生していたクラッシュを修正し、[#32737](https://github.com/ClickHouse/ClickHouse/issues/32737) をクローズしました。 [#32755](https://github.com/ClickHouse/ClickHouse/pull/32755) ([SuperDJY](https://github.com/cmsxbc)).
* `Kafka`/`RabbitMQ` 上で `GROUP BY (list of columns)`（`GROUP BY tuple(...)` としてパースされる）を使用する MV の場合に発生する `Column is not under aggregate function` エラーを修正。 [#32668](https://github.com/ClickHouse/ClickHouse/issues/32668) と [#32744](https://github.com/ClickHouse/ClickHouse/issues/32744) を修正。 [#32751](https://github.com/ClickHouse/ClickHouse/pull/32751)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `TTL ... DELETE WHERE ...` および `TTL ... GROUP BY ...` モードでの `ALTER TABLE ... MATERIALIZE TTL` クエリを修正しました。 [#32695](https://github.com/ClickHouse/ClickHouse/pull/32695) ([Anton Popov](https://github.com/CurtizJ)).
* テーブルエンジンが `Distributed` または `Merge` であり、その基盤となる `MergeTree` テーブルのソートキーの先頭に単調関数がある場合の `optimize_read_in_order` 最適化を修正しました。 [#32670](https://github.com/ClickHouse/ClickHouse/pull/32670) ([Anton Popov](https://github.com/CurtizJ)).
* マテリアライズドビューの出力先が JOIN または SET テーブルである場合に発生する LOGICAL&#95;ERROR 例外を修正。 [#32669](https://github.com/ClickHouse/ClickHouse/pull/32669) ([Raúl Marín](https://github.com/Algunenano)).
* Google Cloud Storage へのマルチパートアップロードを使用した S3 への挿入で中断が発生する可能性があります。 [#32504](https://github.com/ClickHouse/ClickHouse/issues/32504)。 [#32649](https://github.com/ClickHouse/ClickHouse/pull/32649) ([vdimir](https://github.com/vdimir))。
* チャネル作成を遅らせることで、`RabbitMQ` ストレージの起動時に発生する可能性のある例外を修正しました。 [#32584](https://github.com/ClickHouse/ClickHouse/pull/32584) ([Kseniia Sumarokova](https://github.com/kssenii)).
* DROP TABLE と INSERT が並行して実行される場合に、テーブルのライフタイム管理を修正し、use-after-free が発生しうる問題を解消。 [#32572](https://github.com/ClickHouse/ClickHouse/pull/32572) ([Azat Khuzhin](https://github.com/azat)).
* `CustomSeparated`、`Template`、`Regexp`、`MsgPack` および `JSONAsString` フォーマットでの非同期インサートを修正しました。以前は、これらのフォーマットでの非同期インサートではデータが一切読み込まれていませんでした。 [#32530](https://github.com/ClickHouse/ClickHouse/pull/32530) ([Kruglov Pavel](https://github.com/Avogar)).
* 分散テーブルでの `groupBitmapAnd` 関数の動作を修正。 [#32529](https://github.com/ClickHouse/ClickHouse/pull/32529) ([minhthucdao](https://github.com/dmthuc))。
* ファザーにより発見された `JOIN` のクラッシュを修正し、[#32458](https://github.com/ClickHouse/ClickHouse/issues/32458) をクローズしました。 [#32508](https://github.com/ClickHouse/ClickHouse/pull/32508) ([vdimir](https://github.com/vdimir))。
* Apache Arrow カラムが重複するケースの適切な処理。 [#32507](https://github.com/ClickHouse/ClickHouse/pull/32507) ([Dmitriy Mokhnatkin](https://github.com/DMokhnatkin)).
* 分散クエリにおいて、テーブルの一部の列名が `ALL` や `DISTINCT` の場合にエラーの原因となっていた、あいまいなクエリ書式の問題を修正しました。これにより [#32391](https://github.com/ClickHouse/ClickHouse/issues/32391) がクローズされます。 [#32490](https://github.com/ClickHouse/ClickHouse/pull/32490) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* まだマテリアライズされていない skipping index を使用しようとしているクエリで発生する失敗を修正しました。[#32292](https://github.com/ClickHouse/ClickHouse/issues/32292) および [#30343](https://github.com/ClickHouse/ClickHouse/issues/30343) に対応します。[#32359](https://github.com/ClickHouse/ClickHouse/pull/32359)（[Anton Popov](https://github.com/CurtizJ)）。
* 同じカラムに 2 つを超える行ポリシーが存在する場合、同一セッション内で 2 回目以降に実行される `SELECT` クエリが正しく動作しなくなる問題を修正しました。 [#31606](https://github.com/ClickHouse/ClickHouse/issues/31606)。 [#32291](https://github.com/ClickHouse/ClickHouse/pull/32291) ([SuperDJY](https://github.com/cmsxbc))。
* 負の unix タイムスタンプ（1970-01-01 より前）に対して小数部が反転してしまっていた、`DateTime64` への小数部付き unix タイムスタンプの変換を修正しました。 [#32240](https://github.com/ClickHouse/ClickHouse/pull/32240) ([Ben](https://github.com/benbiti))。
* レプリケーションキューの一部のエントリが、`Directory tmp_merge_<part_name>` や `Part ... (state Deleting) already exists, but it will be deleted soon` などのエラーにより、`temporary_directories_lifetime`（デフォルトで 1 日）の間ハングすることがありました。この問題は修正済みです。[#29616](https://github.com/ClickHouse/ClickHouse/issues/29616) を解決。[#32201](https://github.com/ClickHouse/ClickHouse/pull/32201)（[tavplubix](https://github.com/tavplubix)）。
* `APPLY lambda` カラムトランスフォーマのパース処理を修正し、クライアント／サーバーのクラッシュを引き起こす可能性があった問題を解消しました。 [#32138](https://github.com/ClickHouse/ClickHouse/pull/32138) ([Kruglov Pavel](https://github.com/Avogar)).
* 短い文字列に余分な末尾バイトを付加してしまう `base64Encode` を修正。[#31797](https://github.com/ClickHouse/ClickHouse/pull/31797) ([Kevin Michel](https://github.com/kmichel-aiven))。
* ウィンドウ関数の引数が `LowCardinality` の場合に発生し得るクラッシュ（または誤った結果）を修正しました。[#31114](https://github.com/ClickHouse/ClickHouse/issues/31114) を修正。[#31888](https://github.com/ClickHouse/ClickHouse/pull/31888)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `DROP TABLE system.query_log sync` コマンドで発生していたハングを修正しました。 [#33293](https://github.com/ClickHouse/ClickHouse/pull/33293) ([zhanghuajie](https://github.com/zhanghuajieHIT)).





## [2021年の変更履歴](./2021.md) {#changelog-for-2021}
