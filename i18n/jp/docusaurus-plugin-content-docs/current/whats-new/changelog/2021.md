---
slug: /whats-new/changelog/2021
sidebar_position: 6
sidebar_label: "2021"
title: "2021年の変更履歴"
description: "2021年の変更履歴"
doc_type: "changelog"
keywords:
  [
    "ClickHouse 2021",
    "changelog 2021",
    "リリースノート",
    "バージョン履歴",
    "新機能"
  ]
---

### ClickHouseリリース v21.12, 2021-12-15 {#clickhouse-release-v2112-2021-12-15}

#### 後方互換性のない変更 {#backward-incompatible-change}

- _以前に望ましくない動作をしていた機能の修正。_ Kafka/RabbitMQ/FileLogに対する直接selectを許可しないようにしました。`stream_like_engine_allow_direct_select`設定で有効化できます。マテリアライズドビューがアタッチされている場合、設定で有効化されていても直接selectは許可されません。KafkaとRabbitMQの直接selectは、許可されている場合でもデフォルトではメッセージをコミットしません。直接selectでコミットを有効にするには、ストレージレベルの設定`kafka{rabbitmq}_commit_on_select=1`(デフォルトは`0`)を使用する必要があります。[#31053](https://github.com/ClickHouse/ClickHouse/pull/31053) ([Kseniia Sumarokova](https://github.com/kssenii))。
- _新しい関数の動作のわずかな変更。_ JSON_VALUEで引用符なしの文字列を返すようにしました。[#27965](https://github.com/ClickHouse/ClickHouse/issues/27965)をクローズします。[#31008](https://github.com/ClickHouse/ClickHouse/pull/31008) ([Kseniia Sumarokova](https://github.com/kssenii))。
- _設定の名前変更。_ TSV/CSV入力フォーマットにカスタムnull表現のサポートを追加しました。TSV/CSV/JSONCompactStringsEachRow/JSONStringsEachRow入力フォーマットにおけるNullable(String)のデシリアライズを修正しました。`output_format_csv_null_representation`と`output_format_tsv_null_representation`をそれぞれ`format_csv_null_representation`と`format_tsv_null_representation`に名前変更しました。[#30497](https://github.com/ClickHouse/ClickHouse/pull/30497) ([Kruglov Pavel](https://github.com/Avogar))。
- _既に使用されていないコードのさらなる非推奨化。_ これは20.6より古いClickHouseバージョンのユーザーにのみ関連します。20.6以降は複数のリーダーがサポートされているため、`ReplicatedMergeTree`から「リーダー選出」メカニズムが削除されました。古いバージョンからアップグレードする際に、古いバージョンのレプリカがリーダーである場合、アップグレード後にサーバーの起動が失敗します。新しいバージョンを起動するには、古いバージョンのレプリカを停止してください。その後、20.6より古いバージョンへのダウングレードはできなくなります。[#32140](https://github.com/ClickHouse/ClickHouse/pull/32140) ([tavplubix](https://github.com/tavplubix))。

#### 新機能 {#new-feature}


* clickhouse-keeper で ZooKeeper Four Letter Words コマンドをさらに多く実装しました: [https://zookeeper.apache.org/doc/r3.4.8/zookeeperAdmin.html#sc&#95;zkCommands](https://zookeeper.apache.org/doc/r3.4.8/zookeeperAdmin.html#sc_zkCommands)。[#28981](https://github.com/ClickHouse/ClickHouse/pull/28981)（[JackyWoo](https://github.com/JackyWoo)）。これにより、`clickhouse-keeper` の機能は一通り出揃いました。
* `Bool` データ型のサポート。[#31072](https://github.com/ClickHouse/ClickHouse/pull/31072)（[kevin wan](https://github.com/MaxWk)）。
* File、URL、HDFS ストレージおよび `INSERT INTO` テーブル関数での `PARTITION BY` サポートを追加。 [#30273](https://github.com/ClickHouse/ClickHouse/issues/30273) をクローズ。 [#30690](https://github.com/ClickHouse/ClickHouse/pull/30690)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `INSERT` 時にチェックを行わない `CONSTRAINT ... ASSUME ...` を追加しました。最適化をより行いやすくするために、クエリを CNF に変換する機能を追加しました（[https://github.com/ClickHouse/ClickHouse/issues/11749](https://github.com/ClickHouse/ClickHouse/issues/11749)）。制約を用いた単純なクエリ書き換え機能を追加しました（現在は単純なマッチングのみで、今後 &lt;,=,&gt; などもサポートするよう改善予定）。可能な場合に重いカラムを軽いカラムに置き換える機能を追加しました。 [#18787](https://github.com/ClickHouse/ClickHouse/pull/18787) ([Nikita Vasilev](https://github.com/nikvas0))。
* HTTP/URL 関数に対するベーシック認証。 [#31648](https://github.com/ClickHouse/ClickHouse/pull/31648) ([michael1589](https://github.com/michael1589))。
* `WITH FILL` 修飾子の `STEP` 句で `INTERVAL` 型をサポートしました。 [#30927](https://github.com/ClickHouse/ClickHouse/pull/30927) ([Anton Popov](https://github.com/CurtizJ)).
* 複数ファイルからの並列読み取りと、`FROM INFILE` 句での glob パターンのサポートを追加しました。 [#30135](https://github.com/ClickHouse/ClickHouse/pull/30135) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* `Identifier` テーブルおよびデータベースのクエリパラメータのサポートを追加しました。[#27226](https://github.com/ClickHouse/ClickHouse/issues/27226) をクローズしました。[#28668](https://github.com/ClickHouse/ClickHouse/pull/28668)（[Nikolay Degterinsky](https://github.com/evillique)）。
* *要約: テキスト形式の網羅性と一貫性が大きく改善されました。* 形式 `TSV`、`TSVRaw`、`CSV` および `JSONCompactEachRow`、`JSONCompactStringsEachRow` をリファクタリングし、コードの重複を削除し、`-WithNames` および `-WithNamesAndTypes` サフィックスを持つ形式用の共通ベースインターフェースを追加しました。形式 `CSVWithNamesAndTypes`、`TSVRawWithNames`、`TSVRawWithNamesAndTypes`、`JSONCompactEachRowWIthNames`、`JSONCompactStringsEachRowWIthNames`、`RowBinaryWithNames` を追加しました。形式 `TSVWithNamesAndTypes`、`TSVRaw(WithNames/WIthNamesAndTypes)`、`CSVWithNamesAndTypes`、`JSONCompactEachRow(WithNames/WIthNamesAndTypes)`、`JSONCompactStringsEachRow(WithNames/WIthNamesAndTypes)` について並列パースをサポートしました。`RowBinaryWithNamesAndTypes` 形式に対してカラムのマッピングと型チェックをサポートしました。設定 `input_format_with_types_use_header` を追加し、`<format_name>WIthNamesAndTypes` 形式に書かれた型がテーブル構造と一致しているかチェックするかどうかを指定できるようにしました。設定 `input_format_csv_empty_as_default` を追加し、CSV 形式では `input_format_defaults_for_omitted_fields` の代わりにこれを使用するようにしました（`input_format_defaults_for_omitted_fields` は `csv_empty_as_default` を制御すべきではないため）。設定 `input_format_defaults_for_omitted_fields` の使用方法を修正しました（以前は `csv_empty_as_default` としてのみ使用されていましたが、本来は省略されたフィールドに対するデフォルト式の計算を制御すべきものです）。`TSVRaw` 形式における Nullable の入出力を修正し、この形式が TSV への挿入と完全に互換となるようにしました。`input_format_null_as_default` が有効なときに `LowCardinality(Nullable)` へ NULL を挿入する処理を修正しました（以前は実際の NULL ではなくデフォルト値が挿入されていました）。`JSONStringsEachRow`/`JSONCompactStringsEachRow` 形式での文字列のデシリアライズを修正しました（文字列が最初の &#39;\n&#39; または &#39;\t&#39; までしかパースされていませんでした）。Template 入力形式で `Raw` エスケープルールを使用できるようにしました。JSONCompactEachRow(WithNames/WIthNamesAndTypes) 入力形式に対して診断情報を追加しました。設定 `min_chunk_bytes_for_parallel_parsing` が 1 行あたりのバイト数より小さい場合に `-WithNames` 形式の並列パースで発生するバグを修正しました。 [#30178](https://github.com/ClickHouse/ClickHouse/pull/30178) ([Kruglov Pavel](https://github.com/Avogar))。`CustomSeparated` 入力/出力形式でカラムの名前と型を出力およびパースできるようにしました。`TSVWithNames/WithNamesAndTypes` と同様の形式として `CustomSeparatedWithNames/WithNamesAndTypes` を追加しました。 [#31434](https://github.com/ClickHouse/ClickHouse/pull/31434) ([Kruglov Pavel](https://github.com/Avogar))。
* Aliyun OSS ストレージに対応。 [#31286](https://github.com/ClickHouse/ClickHouse/pull/31286) ([cfcz48](https://github.com/cfcz48)).
* 設定ファイルでグローバルスレッドプールのすべての設定を行えるようにしました。 [#31285](https://github.com/ClickHouse/ClickHouse/pull/31285) ([Tomáš Hromada](https://github.com/gyfis)).
* ウィンドウ関数 `exponentialTimeDecayedSum`、`exponentialTimeDecayedMax`、`exponentialTimeDecayedCount`、`exponentialTimeDecayedAvg` を導入しました。これらは、大きなウィンドウに対しては `exponentialMovingAverage` よりも高い効果を発揮します。また、より多くのユースケースをサポートしました。 [#29799](https://github.com/ClickHouse/ClickHouse/pull/29799) ([Vladimir Chebotarev](https://github.com/excitoon)).
* ログをファイルに書き込む前に LZ4 で圧縮できるオプションを追加。[#23860](https://github.com/ClickHouse/ClickHouse/issues/23860) をクローズ。[#29219](https://github.com/ClickHouse/ClickHouse/pull/29219)（[Nikolay Degterinsky](https://github.com/evillique)）。
* CROSS JOIN と同等のセマンティクスを持つ `JOIN ON 1 = 1` をサポートします。これにより [#25578](https://github.com/ClickHouse/ClickHouse/issues/25578) が解決されました。[#25894](https://github.com/ClickHouse/ClickHouse/pull/25894)（[Vladimir C](https://github.com/vdimir)）。
* `Map` 型に Map コンビネータを追加しました。- マップされた配列に対する従来の `sum-, min-, max- Map` を `sum-, min-, max- MappedArrays` に名称変更しました。 [#24539](https://github.com/ClickHouse/ClickHouse/pull/24539) ([Ildus Kurbangaliev](https://github.com/ildus))。
* HTTP 経由での読み取りを再試行可能にしました。[#29696](https://github.com/ClickHouse/ClickHouse/issues/29696) をクローズ。[#29894](https://github.com/ClickHouse/ClickHouse/pull/29894) ([Kseniia Sumarokova](https://github.com/kssenii))。

#### 実験的機能 {#experimental-feature}

- ClickHouseでストリーム処理を有効にする`WINDOW VIEW`。[#8331](https://github.com/ClickHouse/ClickHouse/pull/8331) ([vxider](https://github.com/Vxider))。
- `MaterializedMySQL`でのOrdinaryデータベースの使用サポートを廃止。[#31292](https://github.com/ClickHouse/ClickHouse/pull/31292) ([Stig Bakken](https://github.com/stigsb))。
- Logファミリー向けのBACKUPおよびRESTOREコマンドを実装。この機能は開発中です。[#30688](https://github.com/ClickHouse/ClickHouse/pull/30688) ([Vitaly Baranov](https://github.com/vitlibar))。

#### パフォーマンスの改善 {#performance-improvement}


- `s3` / `url` / `hdfs` フォーマット `Parquet`、`ORC`、`Arrow` での読み取り時のメモリ使用量を削減(設定 `input_format_allow_seeks` で制御、デフォルトで有効)。また、シークを制御するための設定 `remote_read_min_bytes_for_seek` を追加。[#10461](https://github.com/ClickHouse/ClickHouse/issues/10461) をクローズ。[#16857](https://github.com/ClickHouse/ClickHouse/issues/16857) をクローズ。[#30936](https://github.com/ClickHouse/ClickHouse/pull/30936) ([Kseniia Sumarokova](https://github.com/kssenii))。
- JOIN ON における定数条件の最適化を追加。参照 [#26928](https://github.com/ClickHouse/ClickHouse/issues/26928)。[#27021](https://github.com/ClickHouse/ClickHouse/pull/27021) ([Vladimir C](https://github.com/vdimir))。
- `JSONEachRowWithProgress` と `PrettyCompactMonoBlock` を除く、すべてのテキストフォーマットで並列フォーマットをサポート。[#31489](https://github.com/ClickHouse/ClickHouse/pull/31489) ([Kruglov Pavel](https://github.com/Avogar))。
- nullable カラムに対する count を高速化。[#31806](https://github.com/ClickHouse/ClickHouse/pull/31806) ([Raúl Marín](https://github.com/Algunenano))。
- `avg` および `sumCount` 集約関数を高速化。[#31694](https://github.com/ClickHouse/ClickHouse/pull/31694) ([Raúl Marín](https://github.com/Algunenano))。
- JSON および XML 出力フォーマットのパフォーマンスを改善。[#31673](https://github.com/ClickHouse/ClickHouse/pull/31673) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ブロックデバイスへのデータ同期のパフォーマンスを改善。これにより [#31181](https://github.com/ClickHouse/ClickHouse/issues/31181) をクローズ。[#31229](https://github.com/ClickHouse/ClickHouse/pull/31229) ([zhanglistar](https://github.com/zhanglistar))。
- `LiveView` テーブルにおけるクエリパフォーマンスの問題を修正。[#30831](https://github.com/ClickHouse/ClickHouse/issues/30831) を修正。[#31006](https://github.com/ClickHouse/ClickHouse/pull/31006) ([vzakaznikov](https://github.com/vzakaznikov))。
- クエリ解析を高速化。[#31949](https://github.com/ClickHouse/ClickHouse/pull/31949) ([Raúl Marín](https://github.com/Algunenano))。
- プレーン/タグ付きメトリクスに対して `GraphiteMergeTree` ロールアップルールを分割できるように変更(オプションの `rule_type` フィールド)。[#25122](https://github.com/ClickHouse/ClickHouse/pull/25122) ([Michail Safronov](https://github.com/msaf1980))。
- `remote()` に対する過剰な `DESC TABLE` リクエストを削除(`remote('127.1', system.one)` の場合(つまり、文字列ではなく識別子として db.table を指定した場合)、過剰な `DESC TABLE` リクエストが発生していた)。[#32019](https://github.com/ClickHouse/ClickHouse/pull/32019) ([Azat Khuzhin](https://github.com/azat))。
- 設定 `optimize_functions_to_subcolumns` を有効にした場合、関数 `tupleElement` をサブカラムの読み取りに最適化。[#31261](https://github.com/ClickHouse/ClickHouse/pull/31261) ([Anton Popov](https://github.com/CurtizJ))。
- 設定 `optimize_functions_to_subcolumns` を有効にした場合、関数 `mapContains` をサブカラム `key` の読み取りに最適化。[#31218](https://github.com/ClickHouse/ClickHouse/pull/31218) ([Anton Popov](https://github.com/CurtizJ))。
- 設定 `merge_tree_min_rows_for_concurrent_read_for_remote_filesystem` および `merge_tree_min_bytes_for_concurrent_read_for_remote_filesystem` を追加。[#30970](https://github.com/ClickHouse/ClickHouse/pull/30970) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `StorageMergeTree` において異なるパーティションのミューテーションをスキップするように変更。[#21326](https://github.com/ClickHouse/ClickHouse/pull/21326) ([Vladimir Chebotarev](https://github.com/excitoon))。

#### 改善 {#improvement}


* 他のテーブルまたは辞書が依存しているテーブルまたは辞書は `DROP` できないようにしました。 [#30977](https://github.com/ClickHouse/ClickHouse/pull/30977) ([tavplubix](https://github.com/tavplubix)).
* 集約関数の状態にバージョン管理を導入しました。これにより、集約関数状態のシリアル化形式に後方互換性のある変更を加えられるようになりました。[#12552](https://github.com/ClickHouse/ClickHouse/issues/12552) をクローズ。[#24820](https://github.com/ClickHouse/ClickHouse/pull/24820)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* PostgreSQL スタイルの `ALTER MODIFY COLUMN` 構文をサポートしました。 [#32003](https://github.com/ClickHouse/ClickHouse/pull/32003) ([SuperDJY](https://github.com/cmsxbc))。
* `RangeHashedDictionary` と `ComplexKeyRangeHashedDictionary` に `update_field` のサポートを追加しました。 [#32185](https://github.com/ClickHouse/ClickHouse/pull/32185) ([Maksim Kita](https://github.com/kitaisreal)).
* `murmurHash3_128` 関数および `sipHash128` 関数は、任意の数の引数を受け取れるようになりました。これにより [#28774](https://github.com/ClickHouse/ClickHouse/issues/28774) がクローズされました。[#28965](https://github.com/ClickHouse/ClickHouse/pull/28965)（[小路](https://github.com/nicelulu)）。
* `HDFS` ストレージのデフォルト式をサポートし、ソースがカラム指向の場合のフェッチ処理を最適化。[#32256](https://github.com/ClickHouse/ClickHouse/pull/32256)（[李扬](https://github.com/taiyang-li)）。
* OpenTelemetry スパンのオペレーション名を改善しました。 [#32234](https://github.com/ClickHouse/ClickHouse/pull/32234) ([Frank Chen](https://github.com/FrankChen021))。
* 出力フォーマット `JSONEachRow` では、`Content-Type: application/x-ndjson`（[http://ndjson.org/](http://ndjson.org/)）を使用します。[#32223](https://github.com/ClickHouse/ClickHouse/pull/32223)（[Dmitriy Dorofeev](https://github.com/deem0n)）。
* Template/CustomSeparated フォーマットのクォート付きエスケープルールにおいて、未知フィールドのスキップを改善しました。以前はクォートされた文字列のみスキップ可能でしたが、現在は任意の型の値をスキップできます。 [#32204](https://github.com/ClickHouse/ClickHouse/pull/32204) ([Kruglov Pavel](https://github.com/Avogar)).
* `clickhouse-keeper` は、重複する ID またはエンドポイントが含まれている場合には起動せず、構成変更も適用しないようになりました。 [#31339](https://github.com/ClickHouse/ClickHouse/issues/31339) を修正。 [#32121](https://github.com/ClickHouse/ClickHouse/pull/32121)（[alesapin](https://github.com/alesapin)）。
* URL エンジンから送信される HTTP パケットに Content-Type ヘッダーを設定。 [#32113](https://github.com/ClickHouse/ClickHouse/pull/32113) ([Frank Chen](https://github.com/FrankChen021))。
* `output_format_json_array_of_rows` が有効な場合、`JSONEachRow` フォーマットに対して Content-Type として &#39;application/json&#39; を返すようにしました。 [#32112](https://github.com/ClickHouse/ClickHouse/pull/32112) ([Frank Chen](https://github.com/FrankChen021))。
* `Float32` / `Float64` 値の前に付く `+` の解析を許可。 [#32079](https://github.com/ClickHouse/ClickHouse/pull/32079) ([Kruglov Pavel](https://github.com/Avogar)).
* `DiskHDFS` および `StorageHDFS` で、ユーザーが設定できる `hdfs_replication` パラメータをサポートしました。 [#32039](https://github.com/ClickHouse/ClickHouse/issues/32039) をクローズしました。 [#32049](https://github.com/ClickHouse/ClickHouse/pull/32049)（[leosunli](https://github.com/leosunli)）。
* OpenTelemetry のスパンログに ClickHouse の `exception` および `exception_code` フィールドを追加しました。 [#32040](https://github.com/ClickHouse/ClickHouse/pull/32040) ([Frank Chen](https://github.com/FrankChen021)).
* OpenTelemetry の span ログの duration を修正しました - クエリ例外が発生した場合、クエリレベルでは 0 になっていました。 [#32038](https://github.com/ClickHouse/ClickHouse/pull/32038) ([Frank Chen](https://github.com/FrankChen021)).
* `Int256` の `LowCardinality` を作成できなかった問題を修正。 [#31832](https://github.com/ClickHouse/ClickHouse/pull/31832) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `engine` や `partition_by` が異なる場合に `system.*_log` テーブルを再作成します。 [#31824](https://github.com/ClickHouse/ClickHouse/pull/31824) ([Azat Khuzhin](https://github.com/azat)).
* `MaterializedMySQL`: 名前が &#39;table&#39; のテーブルに関する不具合を修正。 [#31781](https://github.com/ClickHouse/ClickHouse/pull/31781) ([Håvard Kvålen](https://github.com/havardk)).
* ClickHouse dictionary source: 事前定義された接続をサポートするようになりました。 [#31705](https://github.com/ClickHouse/ClickHouse/issues/31705) をクローズしました。 [#31749](https://github.com/ClickHouse/ClickHouse/pull/31749)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* Kafka および RabbitMQ エンジンで、他の統合テーブルエンジンと同様に事前定義済みの接続設定を使用できるようにしました。[#31691](https://github.com/ClickHouse/ClickHouse/pull/31691) ([Kseniia Sumarokova](https://github.com/kssenii)).
* clickhouse-client で履歴をたどって移動する際に、常にプロンプトを再描画するようにしました。これにより、画面に収まりきらない非常に長いクエリを操作する際の使い勝手が向上します。 [#31675](https://github.com/ClickHouse/ClickHouse/pull/31675) ([alexey-milovidov](https://github.com/alexey-milovidov)) (author: Amos Bird).
* 履歴の移動専用のキーバインディングを追加（行/履歴の切り替えではなく）。 [#31641](https://github.com/ClickHouse/ClickHouse/pull/31641) ([Azat Khuzhin](https://github.com/azat)).
* `max_execution_time` のチェック処理を改善し、タイムアウトのチェックが行われずクエリが長時間実行されてしまうことがあった問題を修正しました。 [#31636](https://github.com/ClickHouse/ClickHouse/pull/31636) ([Raúl Marín](https://github.com/Algunenano)).
* 不正なパスワードハッシュが原因で `users.xml` を読み込めなかった場合に出力される例外メッセージを改善しました。これにより [#24126](https://github.com/ClickHouse/ClickHouse/issues/24126) がクローズされました。 [#31557](https://github.com/ClickHouse/ClickHouse/pull/31557) ([Vitaly Baranov](https://github.com/vitlibar))。
* 設定ファイルでこれらのマクロが定義されていない場合、`Replicated` データベースの引数からシャード名およびレプリカ名を取得して `ReplicatedMergeTree` の引数内でのマクロ展開に使用するようにしました。[#31471](https://github.com/ClickHouse/ClickHouse/issues/31471) をクローズしました。 [#31488](https://github.com/ClickHouse/ClickHouse/pull/31488)（[tavplubix](https://github.com/tavplubix)）。
* `min/max/count` プロジェクションの解析が改善されました。`allow_experimental_projection_optimization` を有効にすると、仮想の `min/max/count` プロジェクションをパーティションキーの列と併用できるようになりました。 [#31474](https://github.com/ClickHouse/ClickHouse/pull/31474) ([Amos Bird](https://github.com/amosbird))。
* `clickhouse-local` に `--pager` オプションのサポートを追加。 [#31457](https://github.com/ClickHouse/ClickHouse/pull/31457) ([Azat Khuzhin](https://github.com/azat)).
* 対話的なクエリ編集中のエディタ待機処理を修正（`waitpid()` が `SIGWINCH` 受信時に -1 を返し、`EDITOR` と `clickhouse-local` / `clickhouse-client` が同時に動作する場合）。[#31456](https://github.com/ClickHouse/ClickHouse/pull/31456)（[Azat Khuzhin](https://github.com/azat)）。
* `JSONCompactStrings(EachRow)` 形式において、フィールドの後ろに余分なデータが存在する場合に例外をスローするようにしました。 [#31455](https://github.com/ClickHouse/ClickHouse/pull/31455) ([Kruglov Pavel](https://github.com/Avogar)).
* `http_send_timeout` および `http_receive_timeout` 設定のデフォルト値が 1800 秒（30 分）から 180 秒（3 分）に変更されました。 [#31450](https://github.com/ClickHouse/ClickHouse/pull/31450) ([tavplubix](https://github.com/tavplubix))。
* `MaterializedMySQL` は `CREATE TABLE ... LIKE ...` DDL クエリにも対応するようになりました。 [#31410](https://github.com/ClickHouse/ClickHouse/pull/31410) ([Stig Bakken](https://github.com/stigsb)).
* system テーブルに対して `show create table` を実行したときに、擬似的な CREATE クエリを返すようにしました。 [#31391](https://github.com/ClickHouse/ClickHouse/pull/31391) ([SuperDJY](https://github.com/cmsxbc)).
* 以前は `numbers` テーブル関数に対してのみ進行状況が表示されていましたが、現在は `numbers_mt` テーブル関数に対しても表示されるようになりました。 [#31318](https://github.com/ClickHouse/ClickHouse/pull/31318) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 初期ユーザーのロールが、行ポリシーの検索に使用されるようになりました。[#31080](https://github.com/ClickHouse/ClickHouse/issues/31080) を参照。[#31262](https://github.com/ClickHouse/ClickHouse/pull/31262)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 非推奨の設定が変更された場合、`system.warnings` に警告を表示するようにしました。 [#31252](https://github.com/ClickHouse/ClickHouse/pull/31252) ([tavplubix](https://github.com/tavplubix))。
* `MergeTree` のバックグラウンドクリーンアップタスクに対するバックオフ処理を改善。設定 `merge_tree_clear_old_temporary_directories_interval_seconds` および `merge_tree_clear_old_parts_interval_seconds` を users の設定から `MergeTree` の設定へ移動。[#31180](https://github.com/ClickHouse/ClickHouse/pull/31180)（[tavplubix](https://github.com/tavplubix)）。
* これにより、すべてのレプリカはクライアントへプロファイルイベントカウンタの増分情報のみを送信するようになりました。 [#31155](https://github.com/ClickHouse/ClickHouse/pull/31155) ([Dmitry Novik](https://github.com/novikd))。その結果、`clickhouse-client` の `--hardware_utilization` オプションが実用的に利用できるようになりました。
* clickhouse-client で複数行編集をデフォルトで有効にしました。これにより [#31121](https://github.com/ClickHouse/ClickHouse/issues/31121) が解決されます。[#31123](https://github.com/ClickHouse/ClickHouse/pull/31123)（[Amos Bird](https://github.com/amosbird)）。
* `ALTER` クエリにおける関数名の正規化。これにより、インデックス／プロジェクション付きでテーブルを作成する場合と、`ALTER` コマンドでインデックス／プロジェクションを追加する場合との間でメタデータの不整合が発生することを防ぎます。これは [https://github.com/ClickHouse/ClickHouse/pull/20174](https://github.com/ClickHouse/ClickHouse/pull/20174) の後続 PR です。バグ報告がなく、このシナリオ自体も比較的まれであるため、改善としてマークされています。 [#31095](https://github.com/ClickHouse/ClickHouse/pull/31095) ([Amos Bird](https://github.com/amosbird))。
* `RENAME DATABASE`/`TABLE`/`DICTIONARY` クエリで `IF EXISTS` 修飾子が使用できるようになりました。このディレクティブを使用すると、リネーム対象の DATABASE/TABLE/DICTIONARY が存在しなくてもエラーになりません。 [#31081](https://github.com/ClickHouse/ClickHouse/pull/31081) ([victorgao](https://github.com/kafka1991)).
* パーティションが削除された場合に縦方向マージをキャンセルするようにしました。これは [https://github.com/ClickHouse/ClickHouse/pull/25684](https://github.com/ClickHouse/ClickHouse/pull/25684) および [https://github.com/ClickHouse/ClickHouse/pull/30996](https://github.com/ClickHouse/ClickHouse/pull/30996) に対するフォローアップです。 [#31057](https://github.com/ClickHouse/ClickHouse/pull/31057) ([Amos Bird](https://github.com/amosbird))。
* ClickHouse の辞書ソース内のローカルセッションは、セッションログにイベントを送信しなくなりました。これにより、シャットダウン時に発生する可能性があったデッドロック（tsan アラート）が解消されます。また、この PR では、不安定だった `test_dictionaries_dependency_xml/` も修正しています。 [#31013](https://github.com/ClickHouse/ClickHouse/pull/31013) ([Vitaly Baranov](https://github.com/vitlibar))。
* ALTER コマンド時のロックを削減。[#31010](https://github.com/ClickHouse/ClickHouse/pull/31010)（[Amos Bird](https://github.com/amosbird)）。
* clickhouse-local のインタラクティブモードにおける `--verbose` オプションを修正し、ログをファイルに出力できるようにしました。 [#30881](https://github.com/ClickHouse/ClickHouse/pull/30881) ([Kseniia Sumarokova](https://github.com/kssenii)).
* MySQL や PostgreSQL と同様に、`clickhouse-client` に `\l`、`\d`、`\c` コマンドを追加しました。 [#30876](https://github.com/ClickHouse/ClickHouse/pull/30876) ([Pavel Medvedev](https://github.com/pmed))。
* clickhouse-local または clickhouse-client において、`--query` または `--queries-file` と一緒に `--interactive` オプションが指定された場合、まず非インタラクティブモードと同様にクエリを実行し、その後インタラクティブモードを開始します。 [#30851](https://github.com/ClickHouse/ClickHouse/pull/30851) ([Kseniia Sumarokova](https://github.com/kssenii)).
* DROP が ZooKeeper から znode を削除する際に失敗した場合に発生する可能性がある「The local set of parts of X doesn&#39;t look like the set of parts in ZooKeeper」というエラーを修正。 [#30826](https://github.com/ClickHouse/ClickHouse/pull/30826) ([Azat Khuzhin](https://github.com/azat)).
* Avro 形式が Kafka でも利用できるようになりました。`output_format_avro_rows_in_file` の設定を追加しました。[#30351](https://github.com/ClickHouse/ClickHouse/pull/30351)（[Ilya Golshtein](https://github.com/ilejn)）。
* 1 つまたは任意の数の PostgreSQL スキーマを 1 つの `MaterializedPostgreSQL` データベースに対して指定できるようにしました。 [#28901](https://github.com/ClickHouse/ClickHouse/issues/28901) をクローズしました。 [#29324](https://github.com/ClickHouse/ClickHouse/issues/29324) をクローズしました。 [#28933](https://github.com/ClickHouse/ClickHouse/pull/28933)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* clickhouse-keeper の内部通信に使用するデフォルトポートを 44444 から 9234 に変更しました。 [#30879](https://github.com/ClickHouse/ClickHouse/issues/30879) を修正しました。 [#31799](https://github.com/ClickHouse/ClickHouse/pull/31799)（[alesapin](https://github.com/alesapin)）。
* Decimal 引数を受け取る関数 transform を実装。 [#31839](https://github.com/ClickHouse/ClickHouse/pull/31839) ([李帅](https://github.com/loneylee))。
* 不正な hdfs URL の場合にデバッグサーバーで発生する異常終了と、リリースサーバーで発生する `DB::Exception: std::out_of_range: basic_string` エラーを、hdfs URL 構造の追加チェックにより修正しました。 [#31042](https://github.com/ClickHouse/ClickHouse/pull/31042) ([Kruglov Pavel](https://github.com/Avogar)).
* `hdfs` テーブル関数/エンジンで起こり得るアサーション失敗を修正し、テストを追加。 [#31036](https://github.com/ClickHouse/ClickHouse/pull/31036) ([Kruglov Pavel](https://github.com/Avogar)).

#### バグ修正 {#bug-fixes}


* 位置引数を有効にした状態での GROUP BY / ORDER BY / LIMIT BY におけるエイリアスの問題を修正。[#31173](https://github.com/ClickHouse/ClickHouse/issues/31173) をクローズ。[#31741](https://github.com/ClickHouse/ClickHouse/pull/31741)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `Map` 型での `Buffer` テーブルエンジンの使用を修正。[#30546](https://github.com/ClickHouse/ClickHouse/issues/30546) を修正。[#31742](https://github.com/ClickHouse/ClickHouse/pull/31742)（[Anton Popov](https://github.com/CurtizJ)）。
* `use_uncompressed_cache` が有効な `MergeTree` テーブルからの読み取り処理を修正。 [#31826](https://github.com/ClickHouse/ClickHouse/pull/31826) ([Anton Popov](https://github.com/CurtizJ)).
* `empty_result_for_aggregation_by_empty_set` 設定が有効な場合に、実行すべき処理がない mutation がハングしてしまう問題を修正しました。 [#32358](https://github.com/ClickHouse/ClickHouse/pull/32358) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* protobuf 書き込み時の列スキップを修正。この PR は [#31160](https://github.com/ClickHouse/ClickHouse/issues/31160) を解決するものであり、コメント [#31160](https://github.com/ClickHouse/ClickHouse/issues/31160)#issuecomment-980595318 を参照のこと。 [#31988](https://github.com/ClickHouse/ClickHouse/pull/31988) ([Vitaly Baranov](https://github.com/vitlibar))。
* サブクエリ内で不要な列を削除するロジックのバグを修正。`GROUP BY` のないクエリに集約関数が含まれている場合、不要と判断されても削除しないようにした。[#32289](https://github.com/ClickHouse/ClickHouse/pull/32289) ([dongyifeng](https://github.com/dyf6372))。
* クォータの上限には達していないにもかかわらず、制限超過と判定されていました。このPRは [#31174](https://github.com/ClickHouse/ClickHouse/issues/31174) を修正します。 [#31337](https://github.com/ClickHouse/ClickHouse/pull/31337) ([sunny](https://github.com/sunny19930321))。
* 部分的な権限の取り消しが行われている場合に `SHOW GRANTS` が正しく動作しない問題を修正。この PR は [#31138](https://github.com/ClickHouse/ClickHouse/issues/31138) を修正するものです。 [#31249](https://github.com/ClickHouse/ClickHouse/pull/31249) ([Vitaly Baranov](https://github.com/vitlibar)).
* ClickHouse が cgroup 制限付きコンテナ内で実行されている場合、メモリ容量が誤って見積もられていました。 [#31157](https://github.com/ClickHouse/ClickHouse/pull/31157) ([Pavel Medvedev](https://github.com/pmed))。
* デフォルト式のデータ型がカラムのデータ型と一致しない場合の `ALTER ... MATERIALIZE COLUMN ...` クエリの動作を修正しました。 [#32348](https://github.com/ClickHouse/ClickHouse/pull/32348) ([Anton Popov](https://github.com/CurtizJ)).
* `Decimal` 引数を取る集約関数 `avgWeighted` で発生していた SIGFPE によるクラッシュを修正しました。[#32053](https://github.com/ClickHouse/ClickHouse/issues/32053) を解決。[#32303](https://github.com/ClickHouse/ClickHouse/pull/32303)（[tavplubix](https://github.com/tavplubix)）。
* `Dictionary` テーブルが同名の XML 辞書を参照している場合に、サーバーが起動時に `Cannot attach 1 tables due to cyclic dependencies` エラーで失敗することがありましたが、修正されました。 [#31315](https://github.com/ClickHouse/ClickHouse/issues/31315) を修正しました。 [#32288](https://github.com/ClickHouse/ClickHouse/pull/32288) ([tavplubix](https://github.com/tavplubix))。
* `Quoted` エスケープ規則において、`Nullable(Float)` の NaN デシリアライズ時に発生するパースエラーを修正。 [#32190](https://github.com/ClickHouse/ClickHouse/pull/32190) ([Kruglov Pavel](https://github.com/Avogar)).
* XML 辞書: テーブル作成クエリで使用される識別子を、新しいバージョンへのアップグレード時に `default_database` で修飾できるようにしました。 [#31963](https://github.com/ClickHouse/ClickHouse/issues/31963) をクローズ。 [#32187](https://github.com/ClickHouse/ClickHouse/pull/32187)（[Maksim Kita](https://github.com/kitaisreal)）。
* `replicated_can_become_leader` 設定が一部のレプリカで無効化されている場合、クォーラム付きで挿入を行う際のアクティブなレプリカ数が正しく判定されないことがありました。この問題を修正しました。 [#32157](https://github.com/ClickHouse/ClickHouse/pull/32157) ([tavplubix](https://github.com/tavplubix))。
* 辞書：カスタムデータベースクエリにおいて `{condition}` が動作しない場合を修正しました。 [#32117](https://github.com/ClickHouse/ClickHouse/pull/32117) ([Maksim Kita](https://github.com/kitaisreal))。
* `cast_keep_nullable` を利用した `Nullable` からの `CAST` を修正（以前は、例えば `toUInt32OrDefault(toNullable(toUInt32(1)))` に対して `PARAMETER_OUT_OF_BOUND` エラーが発生していた）。[#32080](https://github.com/ClickHouse/ClickHouse/pull/32080)（[Azat Khuzhin](https://github.com/azat)）。
* 一部の稀なケースにおいて `Join` ストレージの `CREATE TABLE` を修正。[#31680](https://github.com/ClickHouse/ClickHouse/issues/31680) をクローズ。[#32066](https://github.com/ClickHouse/ClickHouse/pull/32066)（[SuperDJY](https://github.com/cmsxbc)）。
* パーツのデタッチ時に発生していた `Directory ... already exists and is not empty` エラーを修正しました。 [#32063](https://github.com/ClickHouse/ClickHouse/pull/32063) ([tavplubix](https://github.com/tavplubix))。
* `MaterializedMySQL`（実験的機能）：MySQL からの `DECIMAL` データが誤って解釈される問題を修正。[#31990](https://github.com/ClickHouse/ClickHouse/pull/31990)（[Håvard Kvålen](https://github.com/havardk)）。
* `FileLog` エンジン（実験的機能）がテーブルの作成に失敗した際に不要なメタデータディレクトリを作成していた問題を修正。Fix [#31962](https://github.com/ClickHouse/ClickHouse/issues/31962). [#31967](https://github.com/ClickHouse/ClickHouse/pull/31967) ([flynn](https://github.com/ucasfl)).
* 一部の `GET_PART` エントリは、すべてのレプリカでパーツが失われ、かつ同じパーティション内に他のパーツが存在しない場合、レプリケーションキュー内でハングすることがあります。パーティションキーが整数型または `Date[Time]` 型のカラムのみで構成されている場合に、この問題は修正されました。 [#31485](https://github.com/ClickHouse/ClickHouse/issues/31485) を修正。[#31887](https://github.com/ClickHouse/ClickHouse/pull/31887)（[tavplubix](https://github.com/tavplubix)）。
* `UUID` 型の引数に対する関数 `empty` および `notEmpty` を修正。 [#31819](https://github.com/ClickHouse/ClickHouse/issues/31819) を修正。 [#31883](https://github.com/ClickHouse/ClickHouse/pull/31883)（[Anton Popov](https://github.com/CurtizJ)）。
* `KeeperTCPHandler` を構築する際の設定パスを、`keeper_server.session_timeout_ms` から `keeper_server.coordination_settings.session_timeout_ms` に変更しました。`operation_timeout` についても同様です。 [#31859](https://github.com/ClickHouse/ClickHouse/pull/31859) ([JackyWoo](https://github.com/JackyWoo))。
* Nullable な主キーが使用されている場合の Nullable 型の不正なキャストを修正しました（Nullable な主キーは非推奨の機能です―使用しないでください）。これにより [#31075](https://github.com/ClickHouse/ClickHouse/issues/31075) が修正されました。 [#31823](https://github.com/ClickHouse/ClickHouse/pull/31823)（[Amos Bird](https://github.com/amosbird)）。
* SQL の再帰 UDF で発生していたクラッシュを修正。[#30856](https://github.com/ClickHouse/ClickHouse/issues/30856) をクローズ。 [#31820](https://github.com/ClickHouse/ClickHouse/pull/31820) ([Maksim Kita](https://github.com/kitaisreal)).
* 型指定ありの関数 `dictGet` が、型が `Nullable` の辞書属性に対して使用された場合にクラッシュする問題を修正しました。 [#30980](https://github.com/ClickHouse/ClickHouse/issues/30980) を修正します。 [#31800](https://github.com/ClickHouse/ClickHouse/pull/31800)（[Maksim Kita](https://github.com/kitaisreal)）。
* ODBC クエリの結果が空の場合（一部の ODBC ドライバーで発生）に発生していたクラッシュを修正。[#31465](https://github.com/ClickHouse/ClickHouse/issues/31465) をクローズ。[#31766](https://github.com/ClickHouse/ClickHouse/pull/31766)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* クエリプロファイラを無効化できない問題を修正しました（`query_profiler_real_time_period_ns>0` / `query_profiler_cpu_time_period_ns>0` の場合、クエリ終了後もクエリプロファイラが有効なままになってしまうことがありました）。[#31740](https://github.com/ClickHouse/ClickHouse/pull/31740)（[Azat Khuzhin](https://github.com/azat)）。
* 同時に実行される `ATTACH PARTITION` クエリでまれに発生するセグメンテーションフォルトを修正しました。 [#31738](https://github.com/ClickHouse/ClickHouse/pull/31738) ([tavplubix](https://github.com/tavplubix)).
* 出力内でデータと進捗行が混在して出力される場合に発生する `JSONEachRowWithProgress` 出力フォーマットのレースコンディションを修正。 [#31736](https://github.com/ClickHouse/ClickHouse/pull/31736) ([Kruglov Pavel](https://github.com/Avogar)).
* `Replicated` データベースの名前をクラスタ名として指定した場合に、`ON CLUSTER` クエリの実行時に発生していた `there are no such cluster here` エラーを修正しました。 [#31723](https://github.com/ClickHouse/ClickHouse/pull/31723) ([tavplubix](https://github.com/tavplubix)).
* Nullable 列に対する `decrypt` 関数の一部の適用時に発生していた例外を修正しました。これにより [#31662](https://github.com/ClickHouse/ClickHouse/issues/31662) および [#31426](https://github.com/ClickHouse/ClickHouse/issues/31426) がクローズされます。[#31707](https://github.com/ClickHouse/ClickHouse/pull/31707)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* UTF-8 文字を含む文字列に対する関数 `ngrams` を修正しました。 [#31706](https://github.com/ClickHouse/ClickHouse/pull/31706) ([yandd](https://github.com/yandd)).
* ドメイン型（`IPv4` など）のパースにおいて、`input_format_allow_errors_num` および `input_format_allow_errors_ratio` の設定が機能していませんでしたが、修正されました。[#31686](https://github.com/ClickHouse/ClickHouse/issues/31686) を解決します。 [#31697](https://github.com/ClickHouse/ClickHouse/pull/31697) ([tavplubix](https://github.com/tavplubix))。
* `MATERIALIZE COLUMN` におけるヌルポインタ例外を修正しました。[#31679](https://github.com/ClickHouse/ClickHouse/pull/31679) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* `Ordinary` データベース内の DDL 辞書をリネームしようとした際に `RENAME TABLE` クエリが正しく動作しなかった問題を修正しました。 [#31638](https://github.com/ClickHouse/ClickHouse/pull/31638) ([tavplubix](https://github.com/tavplubix))
* `sparkbar` 集約関数を本来の意図どおりに実装しました。詳細については [#26175](https://github.com/ClickHouse/ClickHouse/issues/26175)#issuecomment-960353867、[comment](https://github.com/ClickHouse/ClickHouse/issues/26175#issuecomment-961155065) を参照してください。 [#31624](https://github.com/ClickHouse/ClickHouse/pull/31624) ([小路](https://github.com/nicelulu))。
* カラム名にのみ不正な UTF-8 シーケンスが含まれている場合に生成されていた不正な JSON を修正しました。 [#31534](https://github.com/ClickHouse/ClickHouse/pull/31534) ([Kevin Michel](https://github.com/kmichel-aiven)).
* この最適化のバグが修正されるまでは `partial_merge_join_left_table_buffer_bytes` を無効化してください。[#31009](https://github.com/ClickHouse/ClickHouse/issues/31009)) を参照してください。冗長なオプション `partial_merge_join_optimizations` を削除しました。[#31528](https://github.com/ClickHouse/ClickHouse/pull/31528) ([Vladimir C](https://github.com/vdimir))。
* 短い `INSERT SELECT` クエリにおける進捗表示を修正。 [#31510](https://github.com/ClickHouse/ClickHouse/pull/31510) ([Azat Khuzhin](https://github.com/azat)).
* `GROUP BY` と位置引数を併用した場合の誤った動作を修正。[#31280](https://github.com/ClickHouse/ClickHouse/issues/31280)#issuecomment-968696186 をクローズ。[#31420](https://github.com/ClickHouse/ClickHouse/pull/31420)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* S3 向け STS 認証情報プロバイダーでの `nullptr` 問題を解消。 [#31409](https://github.com/ClickHouse/ClickHouse/pull/31409) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `notLike` 関数をインデックス解析から削除しました。不正な動作をしていたためです。 [#31169](https://github.com/ClickHouse/ClickHouse/pull/31169) ([sundyli](https://github.com/sundy-li)).
* 一部の coordination ログが失われ、最新のログよりも新しいスナップショットが存在する場合に起動できなくなる Keeper のバグを修正しました。 [#31150](https://github.com/ClickHouse/ClickHouse/pull/31150) ([alesapin](https://github.com/alesapin)).
* ローカル結合において右側の Distributed テーブルを書き換えるように修正。 [#25809](https://github.com/ClickHouse/ClickHouse/issues/25809) を解決。 [#31105](https://github.com/ClickHouse/ClickHouse/pull/31105) ([abel-cheng](https://github.com/abel-cheng)).
* エイリアスおよび `WHERE` 句を含む `Merge` テーブルの問題を修正しました（これまではまったく動作していませんでした）。[#28802](https://github.com/ClickHouse/ClickHouse/issues/28802) をクローズしました。[#31044](https://github.com/ClickHouse/ClickHouse/pull/31044)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 引用符付き識別子に対する JSON&#95;VALUE/JSON&#95;QUERY を修正しました。これにより、JSON パスにスペースを含められるようになりました。[#30971](https://github.com/ClickHouse/ClickHouse/issues/30971) をクローズ。[#31003](https://github.com/ClickHouse/ClickHouse/pull/31003)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 行指向でないフォーマットで `formatRow` 関数を使用するとセグメンテーションフォルトが発生していました。そのようなフォーマットではこの関数を使用できないようにしました（意味がないため）。 [#31001](https://github.com/ClickHouse/ClickHouse/pull/31001) ([Kruglov Pavel](https://github.com/Avogar)).
* マテリアライズドビューを削除した後に発行された `SELECT` クエリが失敗する不具合を修正しました。 [#30691](https://github.com/ClickHouse/ClickHouse/issues/30691) で報告。 [#30997](https://github.com/ClickHouse/ClickHouse/pull/30997)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* ATTACH PARTITION ... FROM および MOVE PARTITION ... の場合には `max_partition_size_to_drop` チェックをスキップするようにしました [#30995](https://github.com/ClickHouse/ClickHouse/pull/30995) ([Amr Alaa](https://github.com/amralaa-MSFT)).
* `INTERSECT` および `EXCEPT` 演算子に関する一部のコーナーケースを修正しました。 [#30803](https://github.com/ClickHouse/ClickHouse/issues/30803) をクローズしました。 [#30965](https://github.com/ClickHouse/ClickHouse/pull/30965) ([Kseniia Sumarokova](https://github.com/kssenii))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement}

- 非x86ビルドにおける不正確なフィルタリング結果を修正しました。これにより[#31417](https://github.com/ClickHouse/ClickHouse/issues/31417)が解決されます。これにより[#31524](https://github.com/ClickHouse/ClickHouse/issues/31524)が解決されます。[#31574](https://github.com/ClickHouse/ClickHouse/pull/31574) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ClickHouseのビルドを完全に再現可能にしました(異なるマシンでバイト単位で同一)。これにより[#22113](https://github.com/ClickHouse/ClickHouse/issues/22113)が解決されます。[#31899](https://github.com/ClickHouse/ClickHouse/pull/31899) ([alexey-milovidov](https://github.com/alexey-milovidov))。再現可能なビルドを実現するため、バイナリからビルドディレクトリへのファイルシステムパスを削除しました。これは[#22113](https://github.com/ClickHouse/ClickHouse/issues/22113)に必要な対応です。[#31838](https://github.com/ClickHouse/ClickHouse/pull/31838) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `zlib-ng`、`cassandra`、`mariadb-connector-c`、`xz`、`re2`、`sentry`、`gsasl`、`arrow`、`protobuf`に対して独自のCMakeListsを使用します。これは[#20151](https://github.com/ClickHouse/ClickHouse/issues/20151)に必要な対応です。[#9226](https://github.com/ClickHouse/ClickHouse/issues/9226)の一部です。ビルドシステムから煩わしい不要物を削除するための小さな一歩です。[#30599](https://github.com/ClickHouse/ClickHouse/pull/30599) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 密閉ビルド: libcの固定バージョンを使用し、ビルド中にホストOSからのソースファイルやバイナリファイルが使用されないようにします。これにより[#27133](https://github.com/ClickHouse/ClickHouse/issues/27133)が解決されます。これにより[#21435](https://github.com/ClickHouse/ClickHouse/issues/21435)が解決されます。これにより[#30462](https://github.com/ClickHouse/ClickHouse/issues/30462)が解決されます。[#30011](https://github.com/ClickHouse/ClickHouse/pull/30011) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 特定の関数を簡単にファジングするための関数`getFuzzerData()`を追加しました。これにより[#23227](https://github.com/ClickHouse/ClickHouse/issues/23227)が解決されます。[#27526](https://github.com/ClickHouse/ClickHouse/pull/27526) ([Alexey Boykov](https://github.com/mathalex))。
- Docker内でのケーパビリティ設定をより正確にしました。[#31802](https://github.com/ClickHouse/ClickHouse/pull/31802) ([Constantine Peresypkin](https://github.com/pkit))。
- clangの`-fstrict-vtable-pointers`、`-fwhole-program-vtables`コンパイルオプションを有効にしました。[#20151](https://github.com/ClickHouse/ClickHouse/pull/20151) ([Maksim Kita](https://github.com/kitaisreal))。
- FreeBSD向けクロスコンパイル用のツールチェーンtarballのダウンロードを回避しました。[#31672](https://github.com/ClickHouse/ClickHouse/pull/31672) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- risc-vの初期サポート。注意点とテスト済みのビルドコマンドについてはdevelopment/build-cross-riscvを参照してください。[#31309](https://github.com/ClickHouse/ClickHouse/pull/31309) ([Vladimir Smirnov](https://github.com/Civil))。
- パラメータ「-DENABLE_TESTS=OFF」を使用したarmマシンでのコンパイルをサポートしました。[#31007](https://github.com/ClickHouse/ClickHouse/pull/31007) ([zhanghuajie](https://github.com/zhanghuajieHIT))。

### ClickHouseリリース v21.11, 2021-11-09 {#clickhouse-release-v2111-2021-11-09}

#### 後方互換性のない変更 {#backward-incompatible-change-1}


- SQL/JSON関数における`json_path`と`json`引数の順序を変更しました（標準との整合性を保つため）。[#30449](https://github.com/ClickHouse/ClickHouse/issues/30449)をクローズします。[#30474](https://github.com/ClickHouse/ClickHouse/pull/30474) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `MergeTree`テーブル設定`write_final_mark`を削除しました。今後は常に`true`となります。[#30455](https://github.com/ClickHouse/ClickHouse/pull/30455) ([Kseniia Sumarokova](https://github.com/kssenii))。対応は不要です。すべてのテーブルは新バージョンと互換性があります。
- 関数`bayesAB`を削除しました。この関数を刷新して復活させるためのご協力をお願いします。[#26233](https://github.com/ClickHouse/ClickHouse/issues/26233)をクローズします。[#29934](https://github.com/ClickHouse/ClickHouse/pull/29934) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- これは実験的な`clickhouse-keeper`サポートをすでに使用している場合にのみ関連します。ClickHouse Keeperのスナップショットは、カスタムのClickHouse LZ4ブロック圧縮ではなく、デフォルトで`ZSTD`コーデックで圧縮されるようになりました。この動作は`compress_snapshots_with_zstd_format`コーディネーション設定で無効にできます（すべてのクォーラムレプリカで同じ値である必要があります）。後方互換性の問題は非常にまれで、新しいノードがZSTD形式のスナップショットを読み取れない古いノードにスナップショットを送信する場合（リカバリ時に発生）にのみ発生する可能性があります。[#29417](https://github.com/ClickHouse/ClickHouse/pull/29417) ([alesapin](https://github.com/alesapin))。

#### 新機能 {#new-feature-1}


* 新しい非同期 `INSERT` モードにより、挿入されたデータを蓄積し、バックグラウンドで単一のバッチとして保存できるようになりました。クライアント側では、クエリ内にインラインでデータを含む `INSERT` クエリ、または別のバッファ（例: HTTP プロトコル経由の `INSERT` クエリ）に対して `async_insert` を設定することで有効化できます。`wait_for_async_insert` が true（デフォルト）の場合、クライアントはデータがテーブルにフラッシュされるまで待機します。サーバー側では、設定 `async_insert_threads`、`async_insert_max_data_size`、`async_insert_busy_timeout_ms` によって制御します。[#18282](https://github.com/ClickHouse/ClickHouse/issues/18282) を実装しています。[#27537](https://github.com/ClickHouse/ClickHouse/pull/27537)（[Anton Popov](https://github.com/CurtizJ)）。[#20557](https://github.com/ClickHouse/ClickHouse/pull/20557)（[Ivan](https://github.com/abyss7)）。パフォーマンスに関する注意事項: 非同期挿入では、1 秒あたり最大約 10,000 件の個別の `INSERT` クエリを実行できます。そのため、1 秒あたり数百万行の挿入性能を得たい場合は、引き続きバッチでの挿入を推奨します。
* `clickhouse-local` にインタラクティブモードを追加しました。これにより、サーバーに接続することなく、`clickhouse-local` を実行するだけでコマンドラインの ClickHouse インターフェイスが利用でき、ファイルや外部データソースからデータを処理できるようになります。また、`clickhouse-client` と `clickhouse-local` のコードを統合しました。 [#7203](https://github.com/ClickHouse/ClickHouse/issues/7203) をクローズ。 [#25516](https://github.com/ClickHouse/ClickHouse/issues/25516) をクローズ。 [#22401](https://github.com/ClickHouse/ClickHouse/issues/22401) をクローズ。 [#26231](https://github.com/ClickHouse/ClickHouse/pull/26231)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 実行可能（スクリプト可能）なユーザー定義関数のサポートを追加しました。これらは任意のプログラミング言語で記述できる UDF です。 [#28803](https://github.com/ClickHouse/ClickHouse/pull/28803) ([Maksim Kita](https://github.com/kitaisreal))。
* 外部データソースへの事前定義済みの接続を許可します。これにより、外部データソースを使用する際に認証情報やアドレスを指定する必要がなくなり、代わりに名前で参照できるようになります。 [#28367](https://github.com/ClickHouse/ClickHouse/issues/28367) をクローズしました。 [#28577](https://github.com/ClickHouse/ClickHouse/pull/28577)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `system` データベース内のテーブルに対応する `SCHEMATA`、`TABLES`、`VIEWS`、`COLUMNS` ビューを備えた `INFORMATION_SCHEMA` データベースを追加しました。 [#9770](https://github.com/ClickHouse/ClickHouse/issues/9770) をクローズしました。 [#28691](https://github.com/ClickHouse/ClickHouse/pull/28691) ([tavplubix](https://github.com/tavplubix))。
* `EXISTS (subquery)` をサポート。 [#6852](https://github.com/ClickHouse/ClickHouse/issues/6852) をクローズ。 [#29731](https://github.com/ClickHouse/ClickHouse/pull/29731) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 監査目的のセッションロギング。すべての成功および失敗したログイン／ログアウトイベントを新しい `system.session_log` テーブルに記録します。 [#22415](https://github.com/ClickHouse/ClickHouse/pull/22415) ([Vasily Nemkov](https://github.com/Enmk)) ([Vitaly Baranov](https://github.com/vitlibar)).
* 多次元のコサイン距離およびユークリッド距離関数、L1、L2、Lp、Linf 距離およびノルムをサポート。タプルに対するスカラー積および各種算術演算子を追加。これにより [#4509](https://github.com/ClickHouse/ClickHouse/issues/4509) が完全にクローズされ、それ以上の内容も含まれる。[#27933](https://github.com/ClickHouse/ClickHouse/pull/27933) ([Alexey Boykov](https://github.com/mathalex))。
* `INTO OUTFILE` および `FROM INFILE` に対して、（自動判別または追加のオプション引数を用いた）圧縮および解凍のサポートを追加しました。 [#27135](https://github.com/ClickHouse/ClickHouse/pull/27135) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* HTTP `OPTIONS` リクエストによる CORS (Cross-Origin Resource Sharing) サポートを追加しました。これにより、Grafana はサーバーレス環境からのリクエストでも回避策なしに動作するようになります。[#18693](https://github.com/ClickHouse/ClickHouse/issues/18693) をクローズしました。[#29155](https://github.com/ClickHouse/ClickHouse/pull/29155)（[Filatenkov Artur](https://github.com/FArthur-cmd)）。
* `JOIN ON` を使用するクエリで、OR を含む条件式（論理和）がサポートされるようになりました。 [#21320](https://github.com/ClickHouse/ClickHouse/pull/21320) ([Ilya Golshtein](https://github.com/ilejn)).
* 英数字以外の ASCII 文字を区切り文字として使用して文字列をトークンに分割する関数 `tokens` を追加しました。 [#29981](https://github.com/ClickHouse/ClickHouse/pull/29981) ([Maksim Kita](https://github.com/kitaisreal))。テキストから N-gram を抽出する関数 `ngrams` を追加しました。これにより [#29699](https://github.com/ClickHouse/ClickHouse/issues/29699) がクローズされました。 [#29738](https://github.com/ClickHouse/ClickHouse/pull/29738) ([Maksim Kita](https://github.com/kitaisreal))。
* Unicode 正規化のための関数 `normalizeUTF8NFC`、`normalizeUTF8NFD`、`normalizeUTF8NFKC`、`normalizeUTF8NFKD` を追加。 [#28633](https://github.com/ClickHouse/ClickHouse/pull/28633) ([darkkeks](https://github.com/darkkeks))。
* ClickHouse におけるアプリケーションログファイルのストリーミングでのコンシュームを可能にする `FileLog` テーブルエンジン。ローカルファイルシステム上の追記専用でローテーションされるログに対する `Kafka` や `RabbitMQ` エンジンのようなものです。 [#6953](https://github.com/ClickHouse/ClickHouse/issues/6953) をクローズ。 [#25969](https://github.com/ClickHouse/ClickHouse/pull/25969) ([flynn](https://github.com/ucasfl)) ([Kseniia Sumarokova](https://github.com/kssenii))。
* `CapnProto` 出力フォーマットを追加し、`CapnProto` 入力フォーマットをリファクタリング。 [#29291](https://github.com/ClickHouse/ClickHouse/pull/29291) ([Kruglov Pavel](https://github.com/Avogar)).
* クエリ内で数値を2進リテラルとして記述できるようにしました。例: `SELECT 0b001;`。 [#29304](https://github.com/ClickHouse/ClickHouse/pull/29304) ([Maksim Kita](https://github.com/kitaisreal))。
* `hashed_array` 辞書タイプを追加しました。複数の属性を持つ辞書を使用する場合にメモリを節約できます。[#30236](https://github.com/ClickHouse/ClickHouse/issues/30236) をクローズ。[#30242](https://github.com/ClickHouse/ClickHouse/pull/30242)（[Maksim Kita](https://github.com/kitaisreal)）。
* `JSONExtractKeys` 関数を追加しました。 [#30056](https://github.com/ClickHouse/ClickHouse/pull/30056) ([Vitaly](https://github.com/orloffv))。
* OS カーネルのバージョン文字列を返す関数 `getOSKernelVersion` を追加しました。[#29755](https://github.com/ClickHouse/ClickHouse/pull/29755) ([Memo](https://github.com/Joeywzr))。
* `MD4` と `SHA384` 関数を追加しました。`MD4` は廃止されており安全性に問題のあるハッシュ関数で、すでに一部のレガシーシステムで `MD4` が使われており、まったく同じ結果を再現する必要がある、といったまれなケースでのみ使用できます。 [#29602](https://github.com/ClickHouse/ClickHouse/pull/29602) ([Nikita Tikhomirov](https://github.com/NSTikhomirov)).
* ClickHouse の HTTP サーバーに対しては、設定ファイル内で `hsts_max_age` を正の数に設定することで HSTS を有効にできます。 [#29516](https://github.com/ClickHouse/ClickHouse/pull/29516) ([凌涛](https://github.com/lingtaolf))。
* Huawei OBS Storage のサポートを追加。 [#24294](https://github.com/ClickHouse/ClickHouse/issues/24294) をクローズ。 [#29511](https://github.com/ClickHouse/ClickHouse/pull/29511)（[kevin wan](https://github.com/MaxWk)）。
* 新しい関数 `mapContainsKeyLike` を追加し、キーが単純な正規表現にマッチする要素をマップが含んでいるかどうかを判定できるようにしました。 [#29471](https://github.com/ClickHouse/ClickHouse/pull/29471) ([凌涛](https://github.com/lingtaolf))。新しい関数 `mapExtractKeyLike` を追加し、指定したパターンにマッチする要素のみを保持するマップを取得できるようにしました。 [#30793](https://github.com/ClickHouse/ClickHouse/pull/30793) ([凌涛](https://github.com/lingtaolf))。
* `ALTER TABLE x MODIFY COMMENT` を実装しました。 [#29264](https://github.com/ClickHouse/ClickHouse/pull/29264) ([Vasily Nemkov](https://github.com/Enmk))。
* ClickHouse には存在しないが H3 API では利用可能な H3 検査用関数を追加します: [https://h3geo.org/docs/api/inspection](https://h3geo.org/docs/api/inspection)。 [#29209](https://github.com/ClickHouse/ClickHouse/pull/29209) ([Bharat Nallan](https://github.com/bharatnc))。
* Replicated データベースで、非レプリケートな ALTER TABLE FETCH および ATTACH を許可しました。 [#29202](https://github.com/ClickHouse/ClickHouse/pull/29202) ([Kevin Michel](https://github.com/kmichel-aiven)).
* `output_format_csv_null_representation` 設定を追加しました。これは `output_format_tsv_null_representation` と同様ですが、CSV 出力用のものです。 [#29123](https://github.com/ClickHouse/ClickHouse/pull/29123) ([PHO](https://github.com/depressed-pho))。
* 現在の ZooKeeper セッションの稼働時間（秒）を返す関数 `zookeeperSessionUptime()` を追加しました。 [#28983](https://github.com/ClickHouse/ClickHouse/pull/28983) ([tavplubix](https://github.com/tavplubix)).
* `h3ToGeoBoundary` 関数を実装しました。[#28952](https://github.com/ClickHouse/ClickHouse/pull/28952)（[Ivan Veselov](https://github.com/fuzzERot)）。
* ウィンドウ関数としても使用可能な集約関数 `exponentialMovingAverage` を追加しました。これにより [#27511](https://github.com/ClickHouse/ClickHouse/issues/27511) が解決されました。 [#28914](https://github.com/ClickHouse/ClickHouse/pull/28914) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* テーブル列のサブカラムを `DESCRIBE` クエリ結果に含められるようにしました（`describe_include_subcolumns` を設定することで有効にできます）。[#28905](https://github.com/ClickHouse/ClickHouse/pull/28905)（[Anton Popov](https://github.com/CurtizJ)）。
* `Executable`、`ExecutablePool` にオプション `send_chunk_header` が追加されました。このオプションが有効な場合、チャンクの送信前に、そのチャンクの行数（`rows_count`）と改行がクライアントに送信されます。 [#28833](https://github.com/ClickHouse/ClickHouse/pull/28833) ([Maksim Kita](https://github.com/kitaisreal))。
* `tokenbf_v1` と `ngram` は、キーが String または FixedString 型の Map をサポートします。これにより、map のキーに対するフィルタを用いたクエリでのデータスキップが強化されます。`sql CREATE TABLE map_tokenbf ( row_id UInt32, map Map(String, String), INDEX map_tokenbf map TYPE ngrambf_v1(4,256,2,0) GRANULARITY 1 ) Engine=MergeTree() Order by id ` 上記のテーブルに対して、クエリ `select * from map_tokenbf where map['K']='V'` を実行すると、キー `K` を含まないグラニュールはスキップされます。もちろん、何行スキップされるかは、設定した `granularity` および `index_granularity` に依存します。[#28511](https://github.com/ClickHouse/ClickHouse/pull/28511)（[凌涛](https://github.com/lingtaolf)）。
* サーバーからクライアントへプロファイルイベントを送信できるようにしました。新しいパケットタイプ `ProfileEvents` が導入されました。 [#26177](https://github.com/ClickHouse/ClickHouse/issues/26177) をクローズしました。 [#28364](https://github.com/ClickHouse/ClickHouse/pull/28364)（[Dmitry Novik](https://github.com/novikd)）。
* `FixedString` および `String` データ型に対するビットシフト演算。これにより [#27763](https://github.com/ClickHouse/ClickHouse/issues/27763) が解決されました。[#28325](https://github.com/ClickHouse/ClickHouse/pull/28325)（[小路](https://github.com/nicelulu)）。
* データベースエンジン `MaterializedPostgreSQL` で、PostgreSQL からのレプリケーション対象テーブルを動的に追加 / 削除できるようにしました。データベース設定に対する `ALTER` をサポートしました。[#27573](https://github.com/ClickHouse/ClickHouse/issues/27573) をクローズ。[#28301](https://github.com/ClickHouse/ClickHouse/pull/28301)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 関数 accurateCastOrDefault(x, T) を追加しました。[#21330](https://github.com/ClickHouse/ClickHouse/issues/21330) をクローズしました。著者 @taiyang-li。[#23028](https://github.com/ClickHouse/ClickHouse/pull/23028)（[Maksim Kita](https://github.com/kitaisreal)）。
* 文字列のパースに失敗した際に、ユーザーがデフォルト値（NULL ではない）を指定できるようにする `toUUIDOrDefault`、`toUInt8/16/32/64/256OrDefault`、`toInt8/16/32/64/128/256OrDefault` 関数を追加。 [#21330](https://github.com/ClickHouse/ClickHouse/pull/21330) ([taiyang-li](https://github.com/taiyang-li)).

#### パフォーマンスの向上 {#performance-improvement-1}


* バックグラウンドマージは互いにプリエンプト可能で、適切な優先度でスケジューリングされます。これにより、長時間実行されるマージが短時間で完了するマージの実行を妨げることがなくなります。これは、マージ実行のスケジューリングと制御を改善するために必要です。これにより「too many parts」エラーが発生する可能性が減ります。 [#22381](https://github.com/ClickHouse/ClickHouse/issues/22381)。 [#25165](https://github.com/ClickHouse/ClickHouse/pull/25165)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。バックグラウンドプール内のスレッド数よりも多くのマージおよびミューテーションを実行できる機能を追加しました。マージおよびミューテーションは、そのサイズ（小さい方が優先度が高い）に応じて順次実行されます。実行するタスク数とスレッド数の比率は、設定 `background_merges_mutations_concurrency_ratio` によって制御され、デフォルトは 2 です。 [#29140](https://github.com/ClickHouse/ClickHouse/pull/29140)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* リモートファイルシステムに対して非同期読み取りを使用できるようにします。リモートファイルシステムから読み込む際のシーク回数を削減します。これによりパフォーマンスが飛躍的に向上し、実験的だった `web` および `s3` ディスクが、特定の条件下では EBS よりも高速に動作するようになります。[#29205](https://github.com/ClickHouse/ClickHouse/pull/29205)（[Kseniia Sumarokova](https://github.com/kssenii)）。同時に、`web` ディスクタイプ（Web サーバー上にホストされた静的データセット）は実験的ステータスから卒業し、本番運用に対応したと見なされるようになりました。
* `clickhouse-client` での `INTO OUTFILE` を伴うクエリは複数スレッドを使用するようになります。`INTO OUTFILE` 使用時にプログレスバーがちらつく問題を修正しました。これにより [#30873](https://github.com/ClickHouse/ClickHouse/issues/30873) および [#30872](https://github.com/ClickHouse/ClickHouse/issues/30872) がクローズされます。[#30886](https://github.com/ClickHouse/ClickHouse/pull/30886)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 一部のタイプの `SELECT` クエリに対して、ディスクから読み取る冗長な圧縮データの量を削減しました（`MergeTree` エンジンファミリーのみ）。 [#30111](https://github.com/ClickHouse/ClickHouse/pull/30111) ([alesapin](https://github.com/alesapin)).
* MergeTree テーブルエンジンファミリーで圧縮ブロックを読み取る際に発生する不要な `seek` 呼び出しの一部を削除しました。 [#29766](https://github.com/ClickHouse/ClickHouse/pull/29766) ([alesapin](https://github.com/alesapin)).
* `url` テーブル関数で複数の URL を並列に処理できるようにしました。これにより [#29670](https://github.com/ClickHouse/ClickHouse/issues/29670) と [#29671](https://github.com/ClickHouse/ClickHouse/issues/29671) が解決されました。 [#29673](https://github.com/ClickHouse/ClickHouse/pull/29673) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 主キー順での集約処理のパフォーマンスを向上しました（設定 `optimize_aggregation_in_order` が有効な場合）。 [#30266](https://github.com/ClickHouse/ClickHouse/pull/30266) ([Anton Popov](https://github.com/CurtizJ)).
* ClickHouse では外部の S3 と通信する際に DNS キャッシュを利用するようになりました。[#29999](https://github.com/ClickHouse/ClickHouse/pull/29999) ([alesapin](https://github.com/alesapin))。
* `IS NULL` / `IS NOT NULL` の外部データベース（MySQL など）へのプッシュダウンをサポートしました。[#29463](https://github.com/ClickHouse/ClickHouse/pull/29463)（[Azat Khuzhin](https://github.com/azat)）。外部 DB（たとえば MySQL）向けに、`isNull` / `isNotNull` を `IS NULL` / `IS NOT NULL` に変換するようにしました。[#29446](https://github.com/ClickHouse/ClickHouse/pull/29446)（[Azat Khuzhin](https://github.com/azat)）。
* Dictionary テーブルからの SELECT クエリでは複数スレッドが使用されます。 [#30500](https://github.com/ClickHouse/ClickHouse/pull/30500) ([Maksim Kita](https://github.com/kitaisreal)).
* `Decimal` 列のフィルタリング（WHERE 演算）のパフォーマンスを改善しました。 [#30431](https://github.com/ClickHouse/ClickHouse/pull/30431) ([Jun Jin](https://github.com/vesslanjin))。
* `popcnt`/`ctz` を用いた、より高性能な実装に置き換えることで、`filter` 演算における分岐の多いコードを削除しました。 [#29881](https://github.com/ClickHouse/ClickHouse/pull/29881) ([Jun Jin](https://github.com/vesslanjin)).
* フィルタ用バイトマスク生成関数（WHERE 句で使用）を、SSE/AVX2/AVX512 命令に対応した単一の実装として改善しました。なお、デフォルトでは ClickHouse は SSE のみを使用しているため、これはカスタムビルドにのみ関係します。 [#30014](https://github.com/ClickHouse/ClickHouse/pull/30014) ([jasperzhu](https://github.com/jinjunzh)). [#30670](https://github.com/ClickHouse/ClickHouse/pull/30670) ([jasperzhu](https://github.com/jinjunzh)).
* Nullable な浮動小数点数に対する SUM 集約関数のパフォーマンスを向上しました。 [#28906](https://github.com/ClickHouse/ClickHouse/pull/28906) ([Raúl Marín](https://github.com/Algunenano))。
* 複数のディスクを使用している環境でのパート読み込み処理を高速化しました。発想は [https://github.com/ClickHouse/ClickHouse/pull/16423](https://github.com/ClickHouse/ClickHouse/pull/16423) と同様です。本番環境では 24 分から 16 分へと短縮される改善が確認されています。 [#28363](https://github.com/ClickHouse/ClickHouse/pull/28363) ([Amos Bird](https://github.com/amosbird))。
* S3 マルチパートアップロードのパートサイズのデフォルト値を小さくし、メモリ使用量を削減しました。 [#28679](https://github.com/ClickHouse/ClickHouse/pull/28679) ([ianton-ru](https://github.com/ianton-ru)).
* `bitmapAnd` 関数を高速化しました。 [#28332](https://github.com/ClickHouse/ClickHouse/pull/28332) ([dddounaiking](https://github.com/OodounaikingoO))。
* マージが進行中の `StorageMergeTree` において、最適でないミューテーション通知を削除しました。 [#27552](https://github.com/ClickHouse/ClickHouse/pull/27552) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 文字列比較のパフォーマンス改善を試みました。 [#28767](https://github.com/ClickHouse/ClickHouse/pull/28767) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* プライマリキーインデックスおよびパーティションフィルタで `tuple` を使用できるようになりました。 [#29281](https://github.com/ClickHouse/ClickHouse/pull/29281) ([凌涛](https://github.com/lingtaolf)).
* クエリに同一の引数を取り、レベルパラメータのみが異なる複数の quantile 集約関数が含まれている場合、`optimize_syntax_fuse_functions` 設定が有効であれば、それらは融合されて単一パスで実行されます。 [#26657](https://github.com/ClickHouse/ClickHouse/pull/26657) ([hexiaoting](https://github.com/hexiaoting))。
* 主キーの先頭の式に対する min-max 集計がプロジェクションによって最適化されるようになりました。これは [#329](https://github.com/ClickHouse/ClickHouse/issues/329) に対応するものです。 [#29918](https://github.com/ClickHouse/ClickHouse/pull/29918) ([Amos Bird](https://github.com/amosbird))。

#### 実験的機能 {#experimental-feature-1}

- ClickHouse Keeperのノード設定（`.xml`ファイル）を変更する機能を追加しました。[#30372](https://github.com/ClickHouse/ClickHouse/pull/30372) ([alesapin](https://github.com/alesapin))。
- `sparkbar`集約関数を追加しました。これにより[#26175](https://github.com/ClickHouse/ClickHouse/issues/26175)が解決されます。[#27481](https://github.com/ClickHouse/ClickHouse/pull/27481) ([小路](https://github.com/nicelulu))。注意：この関数には欠陥が1つあり、動作は今後のリリースで変更される予定です。

#### 改善 {#improvement-1}


* 再起動することなくログレベルを変更できるようにしました。 [#29586](https://github.com/ClickHouse/ClickHouse/pull/29586) ([Nikolay Degterinsky](https://github.com/evillique)).
* SQL UDF に対して複数の改良を行いました。SQL ユーザー定義関数を操作するクエリで `ON CLUSTER` 句がサポートされるようになりました。例: `CREATE FUNCTION test_function ON CLUSTER 'cluster' AS x -> x + 1;`。[#30666](https://github.com/ClickHouse/ClickHouse/issues/30666) を解決。[#30734](https://github.com/ClickHouse/ClickHouse/pull/30734)（[Maksim Kita](https://github.com/kitaisreal)）。`CREATE OR REPLACE`、`CREATE IF NOT EXISTS` 構文をサポートしました。[#30454](https://github.com/ClickHouse/ClickHouse/pull/30454)（[Maksim Kita](https://github.com/kitaisreal)）。`DROP IF EXISTS` のサポートを追加しました。例: `DROP FUNCTION IF EXISTS test_function`。[#30437](https://github.com/ClickHouse/ClickHouse/pull/30437)（[Maksim Kita](https://github.com/kitaisreal)）。ラムダ式のサポートを追加しました。例: `CREATE FUNCTION lambda_function AS x -> arrayMap(element -> element * 2, x);`。[#30435](https://github.com/ClickHouse/ClickHouse/pull/30435)（[Maksim Kita](https://github.com/kitaisreal)）。`clickhouse-local` で SQL ユーザー定義関数がサポートされるようになりました。[#30179](https://github.com/ClickHouse/ClickHouse/pull/30179)（[Maksim Kita](https://github.com/kitaisreal)）。
* クエリごとのメモリプロファイラを、`memory_profiler_step` を 4MiB に設定した状態でグローバルに有効化します。[#29455](https://github.com/ClickHouse/ClickHouse/pull/29455)（[Azat Khuzhin](https://github.com/azat)）。
* `system.data_skipping_indices` に `data_compressed_bytes`、`data_uncompressed_bytes`、`marks_bytes` カラムを追加しました。`system.parts` に `secondary_indices_compressed_bytes`、`secondary_indices_uncompressed_bytes`、`secondary_indices_marks_bytes` カラムを追加しました。これにより [#29697](https://github.com/ClickHouse/ClickHouse/issues/29697) がクローズされました。[#29896](https://github.com/ClickHouse/ClickHouse/pull/29896)（[Maksim Kita](https://github.com/kitaisreal)）。
* system.tables に `table` エイリアスを追加し、system.databases に `database` エイリアスを追加しました [#29677](https://github.com/ClickHouse/ClickHouse/issues/29677)。 [#29882](https://github.com/ClickHouse/ClickHouse/pull/29882)（[kevin wan](https://github.com/MaxWk)）。
* サーバー起動時にテーブル間の相互依存関係を正しく解決するようにしました。 [#8004](https://github.com/ClickHouse/ClickHouse/issues/8004)、[#15170](https://github.com/ClickHouse/ClickHouse/issues/15170) をクローズ。 [#28373](https://github.com/ClickHouse/ClickHouse/pull/28373) ([tavplubix](https://github.com/tavplubix)).
* `divide`、`intDiv`、`modulo` 関数で、分母が Nullable の場合に &quot;Division by zero&quot; エラーが発生しないようにしました。[#22621](https://github.com/ClickHouse/ClickHouse/issues/22621) をクローズ。[#28352](https://github.com/ClickHouse/ClickHouse/pull/28352)（[Kruglov Pavel](https://github.com/Avogar)）。
* テキスト形式で、`Date` データ型の値を `YYYY-MM-DD` 形式に加えて `YYYYMMDD` 形式でもパースできるようにしました。これにより [#30870](https://github.com/ClickHouse/ClickHouse/issues/30870) が解決されました。[#30871](https://github.com/ClickHouse/ClickHouse/pull/30871)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* Web UI：テーブルセル内にバーを表示できるようにしました。 [#29792](https://github.com/ClickHouse/ClickHouse/pull/29792) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* ユーザーはコメント付きのディクショナリを作成できるようになりました: `CREATE DICTIONARY ... COMMENT 'vaue'` ... [#29899](https://github.com/ClickHouse/ClickHouse/pull/29899) ([Vasily Nemkov](https://github.com/Enmk))。ユーザーは、`CREATE DATABASE` ステートメントでデータベースにコメントを設定できるようになりました ... [#29429](https://github.com/ClickHouse/ClickHouse/pull/29429) ([Vasily Nemkov](https://github.com/Enmk))。
* `compiled_expression_cache_elements_size` 設定を追加。もしこの設定が必要になることがあれば、そのときにはすでに何をするものか理解しているはずです。 [#30667](https://github.com/ClickHouse/ClickHouse/pull/30667) ([Maksim Kita](https://github.com/kitaisreal))
* clickhouse-format は `--query` オプションをサポートするようになりました。以前のバージョンでは、クエリを stdin に渡す必要がありました。[#29325](https://github.com/ClickHouse/ClickHouse/pull/29325) ([凌涛](https://github.com/lingtaolf))
* `Memory` データベース内のテーブルに対する `ALTER TABLE` をサポートしました。`Memory` データベースは `clickhouse-local` で使用されます。[#30866](https://github.com/ClickHouse/ClickHouse/pull/30866) ([tavplubix](https://github.com/tavplubix))。
* `arrayStringConcat` でシリアライズ可能なすべての型の配列がサポートされるようになりました。 [#30840](https://github.com/ClickHouse/ClickHouse/pull/30840) ([Nickita Taranov](https://github.com/nickitat)).
* ClickHouse は、システムメモリ量を取得する際に Docker/cgroups の制限を加味するようになりました。詳しくは [#25662](https://github.com/ClickHouse/ClickHouse/issues/25662) を参照してください。[#30574](https://github.com/ClickHouse/ClickHouse/pull/30574)（[Pavel Medvedev](https://github.com/pmed)）。
* PostgreSQL データベースのテーブル構造の取得処理が、以前よりも信頼性の高いものになりました。 [#30477](https://github.com/ClickHouse/ClickHouse/pull/30477) ([Kseniia Sumarokova](https://github.com/kssenii)).
* GROUP BY および ORDER BY における位置引数の完全サポート。 [#30433](https://github.com/ClickHouse/ClickHouse/pull/30433) ([Kseniia Sumarokova](https://github.com/kssenii)).
* JSONExtractString を使用して、非文字列要素を文字列として抽出できるようにしました。これは [pull/25452#issuecomment-927123287](https://github.com/ClickHouse/ClickHouse/pull/25452#issuecomment-927123287) に対応する変更です。 [#30426](https://github.com/ClickHouse/ClickHouse/pull/30426)（[Amos Bird](https://github.com/amosbird)）。
* `GraphiteMergeTree` からの SELECT クエリで FINAL 句を使用できるようにしました。 [#30360](https://github.com/ClickHouse/ClickHouse/pull/30360) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* レプリカのクローン処理および破損したパーツのフェッチのキュー投入処理をわずかに改善し、レプリケーションキュー内の `GET_PART` エントリがごくまれにハングしてしまう問題を回避できるようにしました。 [#30346](https://github.com/ClickHouse/ClickHouse/pull/30346) ([tavplubix](https://github.com/tavplubix))。
* file テーブル関数で、`user_files` ディレクトリ内のファイルへのシンボリックリンクを許可します。 [#30309](https://github.com/ClickHouse/ClickHouse/pull/30309) ([Kseniia Sumarokova](https://github.com/kssenii)).
* `Date32` と `Date`、`DateTime`、`DateTime64`、`String` との比較処理を修正しました。 [#30219](https://github.com/ClickHouse/ClickHouse/pull/30219) ([liang.huang](https://github.com/lhuang09287750)).
* `MergeTree` テーブルから `SAMPLE BY` 式を削除できるようにしました（`ALTER TABLE <table> REMOVE SAMPLE BY`）。 [#30180](https://github.com/ClickHouse/ClickHouse/pull/30180) ([Anton Popov](https://github.com/CurtizJ)).
* `Keeper`（`clickhouse-server` の一部）は、他のいずれかのノードに接続できる場合、非同期で起動するようになりました。 [#30170](https://github.com/ClickHouse/ClickHouse/pull/30170) ([alesapin](https://github.com/alesapin))。
* `clickhouse-client` はネイティブな複数行編集機能をサポートするようになりました。 [#30143](https://github.com/ClickHouse/ClickHouse/pull/30143) ([Amos Bird](https://github.com/amosbird)).
* `polygon` 辞書（リバースジオコーディング）：設定 `store_polygon_key_column` = true の場合に、SELECT クエリメソッドで辞書内容を読み取ることができるようになりました。[#30090](https://github.com/ClickHouse/ClickHouse/issues/30090) をクローズ。[#30142](https://github.com/ClickHouse/ClickHouse/pull/30142)（[Maksim Kita](https://github.com/kitaisreal)）。
* Play UI に ClickHouse ロゴを追加。[#29674](https://github.com/ClickHouse/ClickHouse/pull/29674)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `Arrow`、`ArrowStream`、`Parquet`、`ORC` などの Arrow 対応フォーマットからカラムを読み込む際の例外メッセージを改善しました。この変更により、[#29926](https://github.com/ClickHouse/ClickHouse/issues/29926) が解決されました。[#29927](https://github.com/ClickHouse/ClickHouse/pull/29927)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `Buffer` テーブルにおけるフラッシュ処理と起動処理の間で発生するデータ競合を修正しました。これはテスト時に発生する可能性があります。 [#29930](https://github.com/ClickHouse/ClickHouse/pull/29930) ([Azat Khuzhin](https://github.com/azat)).
* `DatabaseMemory` の `DROP TABLE` と `LiveView` 間における `lock-order-inversion` を修正。Live View は実験的な機能です。Memory データベースは clickhouse-local で使用されます。 [#29929](https://github.com/ClickHouse/ClickHouse/pull/29929) ([Azat Khuzhin](https://github.com/azat))。
* 周期的な辞書の再読み込みと設定の再読み込みとの間のロック順序の逆転を修正。 [#29928](https://github.com/ClickHouse/ClickHouse/pull/29928) ([Azat Khuzhin](https://github.com/azat)).
* zoneinfo ファイルを 2021c に更新しました。 [#29925](https://github.com/ClickHouse/ClickHouse/pull/29925) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `clickhouse-copier` でリトライ回数とリトライ間隔を設定できるようにしました。 [#29921](https://github.com/ClickHouse/ClickHouse/pull/29921) ([Azat Khuzhin](https://github.com/azat)).
* `shutdown_wait_unfinished` の時間まで実行中クエリの完了を待機できるようにするため、`shutdown_wait_unfinished_queries` サーバー設定を追加。これは [#24451](https://github.com/ClickHouse/ClickHouse/issues/24451) への対応。 [#29914](https://github.com/ClickHouse/ClickHouse/pull/29914) ([Amos Bird](https://github.com/amosbird))。
* ピークメモリ使用量をトレースできるようにしました（`system.trace_log` に新しい trace&#95;type `MemoryPeak` を追加）。[#29858](https://github.com/ClickHouse/ClickHouse/pull/29858)（[Azat Khuzhin](https://github.com/azat)）。
* PostgreSQL 外部テーブル: レプリカ識別インデックスを取得するクエリに、パーティション化テーブルのプレフィックス &#39;p&#39; を追加しました。 [#29828](https://github.com/ClickHouse/ClickHouse/pull/29828) ([Shoh Jahon](https://github.com/Shohjahon)).
* mutate/merge の実行時に `max_untracked_memory` / `memory_profiler_step` / `memory_profiler_sample_probability` を適用して、マージ処理中のメモリ使用量をプロファイリングできるようにしました。 [#29681](https://github.com/ClickHouse/ClickHouse/pull/29681) ([Azat Khuzhin](https://github.com/azat)).
* クエリ難読化機能: `clickhouse-format --obfuscate` が、より多くの種類のクエリで動作するようになりました。 [#29672](https://github.com/ClickHouse/ClickHouse/pull/29672) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 次の問題を修正しました: `clickhouse-format --obfuscate` が埋め込み辞書（`regionTo...` 関数）を含むクエリを処理できない問題。 [#29667](https://github.com/ClickHouse/ClickHouse/pull/29667) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* JSON 関数における `Nullable` の不正な処理を修正します。これは [#29615](https://github.com/ClickHouse/ClickHouse/issues/29615) を修正します。[https://github.com/ClickHouse/ClickHouse/pull/28012](https://github.com/ClickHouse/ClickHouse/pull/28012) はまだリリースされていないため、改善としてマークします。[#29659](https://github.com/ClickHouse/ClickHouse/pull/29659)（[Amos Bird](https://github.com/amosbird)）。
* `listen_backlog` のデフォルト値を増やしました（より新しい Linux カーネルでのデフォルト値に合わせるため）。[#29643](https://github.com/ClickHouse/ClickHouse/pull/29643) ([Azat Khuzhin](https://github.com/azat))。
* サーバー設定の `dictionaries_config`、`models_config`、`user_defined_executable_functions_config` が変更された場合に、辞書、モデル、ユーザー定義の実行可能関数を再読み込みします。 [#28142](https://github.com/ClickHouse/ClickHouse/issues/28142) をクローズ。 [#29529](https://github.com/ClickHouse/ClickHouse/pull/29529) ([Maksim Kita](https://github.com/kitaisreal)).
* プロジェクション名に対する不要な制約を撤廃しました。これにより、プロジェクション名を `tmp_` で始められるようになりました。 [#29520](https://github.com/ClickHouse/ClickHouse/pull/29520) ([Amos Bird](https://github.com/amosbird))。
* ネストされたサブクエリを含むミューテーションで発生していた `There is no query or query context has expired` エラーを修正しました。テーブルがレプリケートテーブルであり、かつ `allow_nondeterministic_mutations` 設定が無効な場合、ミューテーション内でサブクエリを許可しないようにしました。 [#29495](https://github.com/ClickHouse/ClickHouse/pull/29495) ([tavplubix](https://github.com/tavplubix)).
* 実行時に `max_concurrent_queries` の設定変更を適用できるようにしました（再起動は不要）。[#29414](https://github.com/ClickHouse/ClickHouse/pull/29414)（[Raúl Marín](https://github.com/Algunenano)）。
* 設定 `use_skip_indexes` を追加しました。 [#29405](https://github.com/ClickHouse/ClickHouse/pull/29405) ([Maksim Kita](https://github.com/kitaisreal)).
* インメモリパーツへの `FREEZE`（バックアップ用）のサポートを追加。 [#29376](https://github.com/ClickHouse/ClickHouse/pull/29376)（[Mo Xuan](https://github.com/mo-avatar)）。
* `clickhouse-benchmark` で `initial_query_id` を引き継ぐようにしました（以前は `clickhouse-benchmark` 経由でリモートクエリを実行すると、シャード上のクエリは `initial_query_id` によって元のクエリと関連付けられていませんでした）。[#29364](https://github.com/ClickHouse/ClickHouse/pull/29364)（[Azat Khuzhin](https://github.com/azat)）。
* スキップインデックス `tokenbf_v1` および `ngrambf_v1`: キー型が `String` または `FixedString` の `Array` データ型のサポートを追加しました。[#29280](https://github.com/ClickHouse/ClickHouse/pull/29280)（[Maksim Kita](https://github.com/kitaisreal)）。スキップインデックス `tokenbf_v1` および `ngrambf_v1` に、キー型が `String` または `FixedString` の `Map` データ型のサポートを追加しました。著者 @lingtaolf。[#29220](https://github.com/ClickHouse/ClickHouse/pull/29220)（[Maksim Kita](https://github.com/kitaisreal)）。
* 関数 `has`: `Map` データ型に対応しました。 [#29267](https://github.com/ClickHouse/ClickHouse/pull/29267) ([Maksim Kita](https://github.com/kitaisreal)).
* clickhouse-keeper に `compress_logs` 設定を追加し、`ZSTD` で replicated state machine 用のログを圧縮できるようにしました。実装: [#26977](https://github.com/ClickHouse/ClickHouse/issues/26977)。[#29223](https://github.com/ClickHouse/ClickHouse/pull/29223)（[alesapin](https://github.com/alesapin)）。
* 設定 `external_table_strict_query` を追加しました。これにより、たとえ互換性がなくても、外部データベースへのクエリで WHERE 句の式全体を強制的に渡すようになります。 [#29206](https://github.com/ClickHouse/ClickHouse/pull/29206) ([Azat Khuzhin](https://github.com/azat)).
* `ARRAY JOIN` が使用されている場合、プロジェクションを無効化するようにしました。以前のバージョンでは、プロジェクションの解析によって `ARRAY JOIN` 内のエイリアスが壊れる可能性がありました。 [#29139](https://github.com/ClickHouse/ClickHouse/pull/29139) ([Amos Bird](https://github.com/amosbird)).
* `MsgPack` 入出力フォーマットでサポートするデータ型を拡張しました。 [#29077](https://github.com/ClickHouse/ClickHouse/pull/29077) ([Kruglov Pavel](https://github.com/Avogar)).
* `ORC` 入出力フォーマットで `LowCardinality` 列を入出力できるようにしました。 [#29062](https://github.com/ClickHouse/ClickHouse/pull/29062) ([Kruglov Pavel](https://github.com/Avogar)).
* `system.distributed_ddl_queue` からの SELECT クエリで誤った値が表示される可能性がある問題を修正しました。 [#29061](https://github.com/ClickHouse/ClickHouse/pull/29061) ([tavplubix](https://github.com/tavplubix))。
* HTTP 接続時の未知メソッドに対する挙動を修正。[#29050](https://github.com/ClickHouse/ClickHouse/issues/29050) を解決。[#29057](https://github.com/ClickHouse/ClickHouse/pull/29057)（[Filatenkov Artur](https://github.com/FArthur-cmd)）。
* `clickhouse-keeper`：ZooKeeper のログ（スナップショットではない）からの復元時に一部のデータが失われる可能性がある `clickhouse-keeper-converter` のバグを修正しました。[#29030](https://github.com/ClickHouse/ClickHouse/pull/29030)（[小路](https://github.com/nicelulu)）。ZooKeeper ログが正しくデシリアライズされない可能性がある `clickhouse-keeper-converter` のバグを修正しました。[#29071](https://github.com/ClickHouse/ClickHouse/pull/29071)（[小路](https://github.com/nicelulu)）。
* `CREATE ... AS SELECT` クエリの設定を適用するようにしました（修正: [#28810](https://github.com/ClickHouse/ClickHouse/issues/28810)）。[#28962](https://github.com/ClickHouse/ClickHouse/pull/28962)（[Azat Khuzhin](https://github.com/azat)）。
* ALTER TABLE ... ON CLUSTER ... REPLACE/MOVE PARTITION FROM/TO ... に対してデフォルトデータベースの設定を考慮するようにしました [#28955](https://github.com/ClickHouse/ClickHouse/pull/28955) ([anneji-dev](https://github.com/anneji-dev))。
* gRPC プロトコル: クライアントからサーバー側圧縮方式を変更できるようにした。 [#28953](https://github.com/ClickHouse/ClickHouse/pull/28953) ([Vitaly Baranov](https://github.com/vitlibar)).
* 非同期メトリクス用に温度センサーを読み取る際に発生する「no data」例外をスキップするようにしました。これにより [#28852](https://github.com/ClickHouse/ClickHouse/issues/28852) が解決されます。 [#28882](https://github.com/ClickHouse/ClickHouse/pull/28882) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* まれに既存のディクショナリで `Dictionary not found` エラーが発生し得た論理的な競合状態を修正しました。 [#28853](https://github.com/ClickHouse/ClickHouse/pull/28853) ([tavplubix](https://github.com/tavplubix)).
* If コンビネータ検証時のネストされた関数に対する制限を緩和（ただし同一コンビネータのネストは禁止）。 [#28828](https://github.com/ClickHouse/ClickHouse/pull/28828) ([Azat Khuzhin](https://github.com/azat)).
* サーバー終了時に発生する可能性がある未処理例外を修正しました。 [#28761](https://github.com/ClickHouse/ClickHouse/pull/28761) ([Azat Khuzhin](https://github.com/azat))。
* 異常に長時間にわたって実行されている mutation/merge で使用されている可能性がある tmp ディレクトリがクリーンアップされないようにします。 [#28760](https://github.com/ClickHouse/ClickHouse/pull/28760) ([Azat Khuzhin](https://github.com/azat)).
* 別名が使用されている場合に `optimize_arithmetic_operations_in_aggregate_functions = 1` の最適化を有効にしました。 [#28746](https://github.com/ClickHouse/ClickHouse/pull/28746) ([Amos Bird](https://github.com/amosbird)).
* `ReplicatedMergeTree` 向けに `detach_not_byte_identical_parts` 設定を実装し、バイトレベルで同一ではないパーツを（merge/mutate 後に）削除するのではなく切り離すようにしました。 [#28708](https://github.com/ClickHouse/ClickHouse/pull/28708) ([Azat Khuzhin](https://github.com/azat))。
* `MergeTree` 用に `max_suspicious_broken_parts_bytes` 設定を実装しました（壊れたパーツ全体の合計サイズを制限するもので、デフォルトは `1GiB`）。[#28707](https://github.com/ClickHouse/ClickHouse/pull/28707)（[Azat Khuzhin](https://github.com/azat)）。
* `RabbitMQ` テーブル設定でマクロ展開を有効にしました。 [#28683](https://github.com/ClickHouse/ClickHouse/pull/28683) ([Vitaly Baranov](https://github.com/vitlibar)).
* `Log` エンジンを使用するテーブルのデータを複数スレッドから読み込める機能を復元しました。 [#28125](https://github.com/ClickHouse/ClickHouse/pull/28125) ([Vitaly Baranov](https://github.com/vitlibar))。
* JSON 関数における NULL 列の扱いに関する誤った挙動を修正しました。これにより [#27930](https://github.com/ClickHouse/ClickHouse/issues/27930) の問題が修正されます。[#28012](https://github.com/ClickHouse/ClickHouse/pull/28012)（[Amos Bird](https://github.com/amosbird)）。
* カラム用とは別に、スキップインデックス用の Mark/Uncompressed キャッシュのサイズを個別に設定できるようにしました。 [#27961](https://github.com/ClickHouse/ClickHouse/pull/27961) ([Amos Bird](https://github.com/amosbird))。
* `USING` を伴う JOIN と他の種類の JOIN を混在して使用できるようにしました。 [#23881](https://github.com/ClickHouse/ClickHouse/pull/23881) ([darkkeks](https://github.com/darkkeks))。
* Yandex Cloud S3 のスロットリング対策として aws-sdk サブモジュールを更新しました。 [#30646](https://github.com/ClickHouse/ClickHouse/pull/30646) ([ianton-ru](https://github.com/ianton-ru)).
* gRPC 呼び出しを処理している間のクエリ処理終了時における query ID および session ID の解放処理を修正。 [#29954](https://github.com/ClickHouse/ClickHouse/pull/29954) ([Vitaly Baranov](https://github.com/vitlibar))。
* `AccessControlManager` のシャットダウン処理を修正し、不安定なテストを修正しました。 [#29951](https://github.com/ClickHouse/ClickHouse/pull/29951) ([Vitaly Baranov](https://github.com/vitlibar)).
* `HDFS` からの読み取り時に発生するアサーション失敗を修正。テストをデバッグモードで実行できるように libhdfs3 ライブラリを更新。[#29251](https://github.com/ClickHouse/ClickHouse/issues/29251) をクローズ。[#27814](https://github.com/ClickHouse/ClickHouse/issues/27814) をクローズ。[#29276](https://github.com/ClickHouse/ClickHouse/pull/29276)（[Kseniia Sumarokova](https://github.com/kssenii)）。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-1}

- Aarch64マシン向けFreeBSDビルドのサポートを追加しました。[#29952](https://github.com/ClickHouse/ClickHouse/pull/29952) ([MikaelUrankar](https://github.com/MikaelUrankar))。
- ClickHouseでは再帰的サブモジュールが不要になりました。[#30315](https://github.com/ClickHouse/ClickHouse/pull/30315) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ClickHouseをMuslで静的ビルドできるようになりました。これは実験的な追加であり、`odbc-bridge`、`library-bridge`のビルド、CatBoostとの統合、および一部のライブラリはサポートされていません。[#30248](https://github.com/ClickHouse/ClickHouse/pull/30248) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `AArch64`および`Darwin`(macOS)ビルドで`Protobuf`、`Arrow`、`ORC`、`Parquet`を有効化しました。これにより[#29248](https://github.com/ClickHouse/ClickHouse/issues/29248)が解決されます。これにより[#28018](https://github.com/ClickHouse/ClickHouse/issues/28018)が解決されます。[#30015](https://github.com/ClickHouse/ClickHouse/pull/30015) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- PowerPC(powerpc64le)向けクロスビルドを追加しました。これにより[#9589](https://github.com/ClickHouse/ClickHouse/issues/9589)が解決されます。AArch64およびPowerPC向けMySQL連携サポートを有効化しました。これにより[#26301](https://github.com/ClickHouse/ClickHouse/issues/26301)が解決されます。[#30010](https://github.com/ClickHouse/ClickHouse/pull/30010) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- クロスコンパイルツールチェーンに必要なファイルのみを残しました。これらをサブモジュールとして含めるようにしました(以前はtarballとしてダウンロードされていました)。[#29974](https://github.com/ClickHouse/ClickHouse/pull/29974) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- SELECT文パーサー向けに構造認識型ファジングアプローチをClickHouseに実装しました。[#30012](https://github.com/ClickHouse/ClickHouse/pull/30012) ([Paul](https://github.com/PaulCher))。
- テンプレートコードのコンパイルを高速化するため、clang向け実験的constexpr式評価器を有効化しました。[#29668](https://github.com/ClickHouse/ClickHouse/pull/29668) ([myrrc](https://github.com/myrrc))。
- 新しいシンボルを使用せずに新しいバージョンのglibcでコンパイルする機能を追加しました。[#29594](https://github.com/ClickHouse/ClickHouse/pull/29594) ([Azat Khuzhin](https://github.com/azat))。
- clangの最適化オプションによりデバッグビルドのバイナリサイズを削減しました。[#28736](https://github.com/ClickHouse/ClickHouse/pull/28736) ([flynn](https://github.com/ucasfl))。
- CI用のすべてのイメージを別個のDockerHubリポジトリに配置するようになりました。[#28656](https://github.com/ClickHouse/ClickHouse/pull/28656) ([alesapin](https://github.com/alesapin))。
- clang-13でのビルドサポートを改善しました。[#28046](https://github.com/ClickHouse/ClickHouse/pull/28046) ([Sergei Semin](https://github.com/syominsergey))。
- `clickhouse-client`に生のプロファイルイベントを出力する機能を追加しました(デバッグやテストに役立ちます)。[#30064](https://github.com/ClickHouse/ClickHouse/pull/30064) ([Azat Khuzhin](https://github.com/azat))。
- clickhouse-serverユニット(systemdおよびsysvinit init)に時刻依存関係を追加しました。[#28891](https://github.com/ClickHouse/ClickHouse/pull/28891) ([Azat Khuzhin](https://github.com/azat))。
- シンボルが再読み込みされたときにスタックトレースキャッシュを再読み込みするようにしました。[#28137](https://github.com/ClickHouse/ClickHouse/pull/28137) ([Amos Bird](https://github.com/amosbird))。

#### バグ修正 {#bug-fix}


* `positionCaseInsensitiveUTF8` や `countSubstringsCaseInsensitiveUTF8` のような UTF-8 文字列に対する大文字小文字を区別しない検索関数が、極めてまれなケースで実際には一致しない部分文字列を検出してしまうことがある問題を修正しました。 [#30663](https://github.com/ClickHouse/ClickHouse/pull/30663) ([tavplubix](https://github.com/tavplubix)).
* 暗号化ディスク上の空ファイルからの読み取りの問題を修正。 [#30494](https://github.com/ClickHouse/ClickHouse/pull/30494) ([Vitaly Baranov](https://github.com/vitlibar)).
* 設定 `legacy_column_name_of_tuple_literal = 0` が有効な分散クエリにおいて、設定 `optimize_min_equality_disjunction_chain_length` により制御される、等値比較の論理和チェーンを `IN` へ変換する処理を修正しました。 [#28658](https://github.com/ClickHouse/ClickHouse/pull/28658) ([Anton Popov](https://github.com/CurtizJ))。
* `insert_allow_materialized_columns=0` に設定されている場合でも、分散テーブルのシャーディングキーとしてマテリアライズドカラムを使用できるようにしました。 [#28637](https://github.com/ClickHouse/ClickHouse/pull/28637) ([Vitaly Baranov](https://github.com/vitlibar)).
* 結果セットに行がなく、`TO` および `FROM` が設定されている場合の `ORDER BY ... WITH FILL` を修正。 [#30888](https://github.com/ClickHouse/ClickHouse/pull/30888) ([Anton Popov](https://github.com/CurtizJ)).
* オペランドが 2 つを超える AND/OR 式で set index が使用されない問題を修正します。これにより [#30416](https://github.com/ClickHouse/ClickHouse/issues/30416) の問題が解決されます。 [#30887](https://github.com/ClickHouse/ClickHouse/pull/30887) ([Amos Bird](https://github.com/amosbird))。
* ハッシュ関数を含む projection をマテリアライズした際にクラッシュする問題を修正しました。これにより [#30861](https://github.com/ClickHouse/ClickHouse/issues/30861) が解決されます。この問題は [https://github.com/ClickHouse/ClickHouse/pull/28560](https://github.com/ClickHouse/ClickHouse/pull/28560) と類似しており、header が空であるという不変条件を正しく理解していなかったことに起因していました。[#30877](https://github.com/ClickHouse/ClickHouse/pull/30877)（[Amos Bird](https://github.com/amosbird)）。
* `ReplicatedMergeTree` において ZooKeeper パスから補助 ZooKeeper 名を抽出する際のあいまいさを解消しました。以前は、ZooKeeper パスにコロンが含まれていると、サーバーが `Unknown auxiliary ZooKeeper name` エラーで起動に失敗する可能性がありました。[#29052](https://github.com/ClickHouse/ClickHouse/issues/29052) を修正しました。また、これまでは先頭がスラッシュでない ZooKeeper パスを指定することが許可されていましたが、これは非推奨となり、そのようなパスを用いた新規テーブルの作成は許可されなくなりました。補助 ZooKeeper 名にスラッシュやコロンを含めることもできません。[#30822](https://github.com/ClickHouse/ClickHouse/pull/30822) ([tavplubix](https://github.com/tavplubix))。
* 何らかの理由で `localBackup` が失敗した場合に、一時ディレクトリをクリーンアップするようにしました。 [#30797](https://github.com/ClickHouse/ClickHouse/pull/30797) ([ianton-ru](https://github.com/ianton-ru))。
* レプリケーションなしの `MergeTree` において、`REPLACE/MOVE PARTITION` とバックグラウンドマージとの間に発生しうるレースコンディションを修正しました。この問題により、移動／置換されたデータの一部がパーティション内に残る可能性がありました。 [#29327](https://github.com/ClickHouse/ClickHouse/issues/29327) を修正。 [#30717](https://github.com/ClickHouse/ClickHouse/pull/30717) ([tavplubix](https://github.com/tavplubix)).
* PREWHERE が常に真となる場合に、PREWHERE を WHERE に置き換えるよう修正しました。[#30668](https://github.com/ClickHouse/ClickHouse/pull/30668) ([Azat Khuzhin](https://github.com/azat))。
* Limit プッシュダウン最適化が原因で `Cannot find column` エラーが発生する可能性がありました。[#30438](https://github.com/ClickHouse/ClickHouse/issues/30438) を修正しました。[#30562](https://github.com/ClickHouse/ClickHouse/pull/30562)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `isNotNull` / `isNull` から `IS [NOT] NULL` への書き換えにおいて不足していた括弧を追加し、`isNotNull(1)+isNotNull(2)` のようなクエリが正しく動作するように修正しました。 [#30520](https://github.com/ClickHouse/ClickHouse/pull/30520) ([Azat Khuzhin](https://github.com/azat)).
* 同じテーブルを参照するスカラサブクエリを含む `ALTER` 文で発生するデッドロックを修正し、[#30461](https://github.com/ClickHouse/ClickHouse/issues/30461) をクローズしました。[#30492](https://github.com/ClickHouse/ClickHouse/pull/30492)（[Vladimir C](https://github.com/vdimir)）。
* `REPLACE PARTITION` の実行中にセッションの有効期限が切れた場合に発生する可能性があったセグメンテーションフォルトを修正しました。 [#30432](https://github.com/ClickHouse/ClickHouse/pull/30432) ([tavplubix](https://github.com/tavplubix)).
* `IN (subquery)` のような条件を含むクエリで、集約プロジェクションが適用されている場合に誤った結果が返される可能性がありました。プロジェクション用セットの作成処理を修正しました。 [#30310](https://github.com/ClickHouse/ClickHouse/pull/30310) ([Amos Bird](https://github.com/amosbird)).
* Projection が有効な場合の JOIN クエリにおけるカラムエイリアスの解決方法を修正しました。これにより [#30146](https://github.com/ClickHouse/ClickHouse/issues/30146) が修正されます。 [#30293](https://github.com/ClickHouse/ClickHouse/pull/30293) ([Amos Bird](https://github.com/amosbird))。
* `replaceRegexpAll` 関数の一部の不備を修正。 [#30292](https://github.com/ClickHouse/ClickHouse/pull/30292) ([Memo](https://github.com/Joeywzr))。
* ComplexKeyHashedDictionary および ComplexKeySparseHashedDictionary が `layout` 設定から `preallocate` オプションをパースするように修正。 [#30246](https://github.com/ClickHouse/ClickHouse/pull/30246) ([Maksim Kita](https://github.com/kitaisreal)).
* `[I]LIKE` 関数を修正。[#28661](https://github.com/ClickHouse/ClickHouse/issues/28661) を解決。[#30244](https://github.com/ClickHouse/ClickHouse/pull/30244)（[Nikolay Degterinsky](https://github.com/evillique)）。
* multiIf で shortcircuit と LowCardinality を組み合わせて使用した場合に発生するクラッシュを修正。 [#30243](https://github.com/ClickHouse/ClickHouse/pull/30243) ([Raúl Marín](https://github.com/Algunenano))
* FlatDictionary および HashedDictionary における nullable 属性の bytes&#95;allocated 計算を修正。 [#30238](https://github.com/ClickHouse/ClickHouse/pull/30238) ([Maksim Kita](https://github.com/kitaisreal)).
* 複数の `JOIN` で数字始まりの識別子を使用できるようにしました。 [#30230](https://github.com/ClickHouse/ClickHouse/pull/30230) ([Vladimir C](https://github.com/vdimir)).
* `max_read_buffer_size = 0`（ユーザーが自分の首を絞めるような設定をした場合）のときの `MergeTree` からの読み取り処理を修正（`Can't adjust last granule` や `LOGICAL_ERROR` の例外、さらにはデータ損失を引き起こす可能性がある）。 [#30192](https://github.com/ClickHouse/ClickHouse/pull/30192) ([Azat Khuzhin](https://github.com/azat)).
* `min_bytes_to_use_direct_io` 使用時の `pread_fake_async` / `pread_threadpool` を修正。 [#30191](https://github.com/ClickHouse/ClickHouse/pull/30191) ([Azat Khuzhin](https://github.com/azat)).
* Nullable 列を基にした MATERIALIZED 列を `INSERT SELECT` 文が誤って埋めてしまう問題を修正。 [#30189](https://github.com/ClickHouse/ClickHouse/pull/30189) ([Azat Khuzhin](https://github.com/azat)).
* 関数 `initializeAggregation` で nullable 引数をサポートしました。 [#30177](https://github.com/ClickHouse/ClickHouse/pull/30177) ([Anton Popov](https://github.com/CurtizJ)).
* `GLOBAL IN` と `WITH TOTALS` を含むクエリで発生する `Port is already connected` エラーを修正しました。21.9 および 21.10 にのみ適用されます。[#30086](https://github.com/ClickHouse/ClickHouse/pull/30086)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* MergeTree における MOVE PARTITION とマージ／ミューテーション間で発生する競合状態を修正。 [#30074](https://github.com/ClickHouse/ClickHouse/pull/30074) ([Azat Khuzhin](https://github.com/azat)).
* サーバー再起動後に削除した `Memory` データベースが再表示される可能性がある問題を修正しました（[#29795](https://github.com/ClickHouse/ClickHouse/issues/29795)）。また、クラウド環境では残存データを手動で削除できないため、`Ordinary` データベースを削除する際に発生する `Directory not empty` エラーの回避策として、`force_remove_data_recursively_on_drop` 設定を追加しました。[#30054](https://github.com/ClickHouse/ClickHouse/pull/30054)（[tavplubix](https://github.com/tavplubix)）。
* `tuple()` によってサンプルコードがクラッシュする問題を修正。[#30004](https://github.com/ClickHouse/ClickHouse/issues/30004) をクローズ。[#30016](https://github.com/ClickHouse/ClickHouse/pull/30016)（[flynn](https://github.com/ucasfl)）。
* 次の issue のクローズを試みました: [#29965](https://github.com/ClickHouse/ClickHouse/issues/29965)。 [#29976](https://github.com/ClickHouse/ClickHouse/pull/29976) ([hexiaoting](https://github.com/hexiaoting))。
* `FileChecker` と `StorageLog`/`StorageStripeLog` 間で発生しうるデータレースを修正。 [#29959](https://github.com/ClickHouse/ClickHouse/pull/29959) ([Azat Khuzhin](https://github.com/azat)).
* `StorageLog` における `LogSink::writeMarks()` と `LogSource` 間で発生するデータレースを修正。 [#29946](https://github.com/ClickHouse/ClickHouse/pull/29946) ([Azat Khuzhin](https://github.com/azat)).
* [https://github.com/ClickHouse/ClickHouse/pull/19544](https://github.com/ClickHouse/ClickHouse/pull/19544) で導入された MergeTree テーブルの同時実行クエリ数の制限における潜在的なリソースリークを修正しました。 [#29879](https://github.com/ClickHouse/ClickHouse/pull/29879)（[Amos Bird](https://github.com/amosbird)）。
* システムテーブル再作成チェックを修正（enum 値の変更を検出できていなかった不具合）。 [#29857](https://github.com/ClickHouse/ClickHouse/pull/29857) ([Azat Khuzhin](https://github.com/azat)).
* MaterializedMySQL: MySQL への接続が切断された場合に、トランザクションの一部だけが処理されることがある問題を修正。 [#29837](https://github.com/ClickHouse/ClickHouse/pull/29837) ([Håvard Kvålen](https://github.com/havardk))。
* カーネルのバグが原因と思われる、極めてまれなケースで発生する可能性がある `Timeout exceeded: elapsed 18446744073.709553 seconds` エラーを回避しました。 [#29154](https://github.com/ClickHouse/ClickHouse/issues/29154) を修正。 [#29811](https://github.com/ClickHouse/ClickHouse/pull/29811)（[tavplubix](https://github.com/tavplubix)）。
* `ATTACH TABLE ... FROM 'path'` クエリで、path の代わりに文字列リテラル以外が指定された場合に発生する不正な型変換を修正しました。これにより、未初期化メモリの読み取りにつながる可能性がありました。 [#29790](https://github.com/ClickHouse/ClickHouse/pull/29790) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `GROUP BY` 時の `LowCardinality` への同時アクセスを修正（`Buffer` テーブルと組み合わせた場合に問題が発生する可能性がありました）。 [#29782](https://github.com/ClickHouse/ClickHouse/pull/29782) ([Azat Khuzhin](https://github.com/azat))。
* 分散クエリにおいて、シャードのバージョンが `<= 21.3` と `>= 21.4` の混在で、`GROUP BY` キーがすべて固定サイズの複数カラムで構成され、かつ二段階集約（`group_by_two_level_threshold` および `group_by_two_level_threshold_bytes` を参照）が有効になっている場合に、結果に同一キーの複数行が含まれてしまう誤った `GROUP BY` を修正しました。[#29580](https://github.com/ClickHouse/ClickHouse/issues/29580) を修正。[#29735](https://github.com/ClickHouse/ClickHouse/pull/29735)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* サーバー再起動時における `materialized_postgresql_tables_list` の設定処理の誤動作を修正しました。[#28529](https://github.com/ClickHouse/ClickHouse/issues/28529) で発見。[#29686](https://github.com/ClickHouse/ClickHouse/pull/29686)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* プッシュダウン最適化の過程で、フィルタ述語の条件が失われる可能性がありました。 [#29625](https://github.com/ClickHouse/ClickHouse/pull/29625) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* エイリアスおよび短絡評価を行う式に対する JIT 式コンパイルを修正します。 [#29403](https://github.com/ClickHouse/ClickHouse/issues/29403) をクローズ。 [#29574](https://github.com/ClickHouse/ClickHouse/pull/29574)（[Maksim Kita](https://github.com/kitaisreal)）。
* `x.y.z...` のような `DEFAULT` 式で誤ったテーブル識別子を使用した場合に、`ALTER MODIFY` クエリでまれに発生するセグメンテーションフォルトを修正。 [#29184](https://github.com/ClickHouse/ClickHouse/issues/29184) を解決。 [#29573](https://github.com/ClickHouse/ClickHouse/pull/29573)（[alesapin](https://github.com/alesapin)）。
* `HAVING` 句の列が選択されていない場合に `GROUP BY WITH TOTALS HAVING` で発生する `nullptr` デリファレンスを修正。 [#29553](https://github.com/ClickHouse/ClickHouse/pull/29553) ([Azat Khuzhin](https://github.com/azat)).
* `Join` テーブルエンジンのテーブルに対して、読み取りと書き込みを同時に行う際にデッドロックが発生しないようにしました。 [#29544](https://github.com/ClickHouse/ClickHouse/pull/29544) ([Raúl Marín](https://github.com/Algunenano)).
* `std::mismatch` の使用方法に起因する問題があったため、チェック関数 `pathStartsWith` のバグを修正しました（`2番目の範囲が1番目の範囲より短い場合、その動作は未定義である`）。 [#29531](https://github.com/ClickHouse/ClickHouse/pull/29531) ([Kseniia Sumarokova](https://github.com/kssenii)).
* ODBC bridge でエラー `Invalid cursor state` に対する再試行処理を追加しました。このエラーは再試行可能なエラーです。[#29473](https://github.com/ClickHouse/ClickHouse/issues/29473) をクローズします。[#29518](https://github.com/ClickHouse/ClickHouse/pull/29518)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `Lazy` データベースのロード時に発生していた誤ったテーブル名のパースを修正しました。これにより [#29456](https://github.com/ClickHouse/ClickHouse/issues/29456) が解決されます。 [#29476](https://github.com/ClickHouse/ClickHouse/pull/29476) ([tavplubix](https://github.com/tavplubix)).
* プッシュダウンされた `HAVING` 述語を含むサブクエリで発生し得る `Block structure mismatch` の問題を修正しました。 [#29010](https://github.com/ClickHouse/ClickHouse/issues/29010) を修正。 [#29475](https://github.com/ClickHouse/ClickHouse/pull/29475) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 関数 greatest/least における論理エラー `Cannot capture columns` を修正。[#29334](https://github.com/ClickHouse/ClickHouse/issues/29334) をクローズ。[#29454](https://github.com/ClickHouse/ClickHouse/pull/29454)（[Kruglov Pavel](https://github.com/Avogar)）。
* RocksDB テーブルエンジン: 複数の DB を同時に開く際のレースコンディションを修正（CI 上でこの問題を再現するいくつかのテストを再度有効化）。 [#29393](https://github.com/ClickHouse/ClickHouse/pull/29393) ([Azat Khuzhin](https://github.com/azat)).
* 設定の誤りがある場合に `replicated access storage` が正常にシャットダウンされない問題を修正。 [#29388](https://github.com/ClickHouse/ClickHouse/pull/29388) ([Kevin Michel](https://github.com/kmichel-aiven)).
* メモリ安全ではないため、ウィンドウ関数 `nth_value` を削除しました。これにより [#29347](https://github.com/ClickHouse/ClickHouse/issues/29347) がクローズされました。[#29348](https://github.com/ClickHouse/ClickHouse/pull/29348)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* プロジェクションパーツの縦方向マージを修正しました。これにより [#29253](https://github.com/ClickHouse/ClickHouse/issues/29253) が解決されます。また、この PR では [https://github.com/ClickHouse/ClickHouse/pull/25165](https://github.com/ClickHouse/ClickHouse/pull/25165) で導入された、いくつかのプロジェクションのマージ／ミューテーションに関する問題も修正しています。[#29337](https://github.com/ClickHouse/ClickHouse/pull/29337)（[Amos Bird](https://github.com/amosbird)）。
* 新しいレプリカ追加中に Replicated データベース上でハングする DDL クエリの問題を修正。 [#29328](https://github.com/ClickHouse/ClickHouse/pull/29328) ([Kevin Michel](https://github.com/kmichel-aiven)).
* 接続タイムアウト（`send_timeout` / `receive_timeout`）を修正。 [#29282](https://github.com/ClickHouse/ClickHouse/pull/29282)（[Azat Khuzhin](https://github.com/azat)）。
* `ReplicatedMergeTree` のレプリカを再作成または新規作成する際に、テーブルの列のいずれかが大文字小文字を区別しない関数を含むデフォルト式を持つ場合に発生する可能性のあった `Table columns structure in ZooKeeper is different from local table structure` 例外を修正しました。 [#29266](https://github.com/ClickHouse/ClickHouse/pull/29266) ([Anton Popov](https://github.com/CurtizJ)).
* クライアント（TCP 経由）には、`Attempt to read after eof` (`ATTEMPT_TO_READ_AFTER_EOF`) ではなく、通常の `Database doesn't exist error` (`UNKNOWN_DATABASE`) を送信するようになりました。 [#29229](https://github.com/ClickHouse/ClickHouse/pull/29229) ([Azat Khuzhin](https://github.com/azat)).
* Avro 入力形式で `LowCardinality(Nullable)` 型のカラムに挿入する際に発生するセグメンテーションフォルトを修正。 [#29132](https://github.com/ClickHouse/ClickHouse/pull/29132) ([Kruglov Pavel](https://github.com/Avogar)).
* サーバー間シークレット使用時に、以前の認証情報を再利用できないようにする（そのクラスタに `interserver secret` が設定されている Distributed テーブルへの Buffer/Kafka 経由の `INSERT` の前に、その接続で以前に設定されたユーザーが再利用されてしまう可能性があった）。 [#29060](https://github.com/ClickHouse/ClickHouse/pull/29060) ([Azat Khuzhin](https://github.com/azat)).
* 辞書との `JOIN` で `any_join_distinct_right_table_keys` に対応し、[#29007](https://github.com/ClickHouse/ClickHouse/issues/29007) をクローズしました。[#29014](https://github.com/ClickHouse/ClickHouse/pull/29014)（[Vladimir C](https://github.com/vdimir)）。
* エイリアス列での `JOIN` 時に発生する &quot;Not found column ... in block&quot; エラーを修正し、[#26980](https://github.com/ClickHouse/ClickHouse/issues/26980) をクローズ。[#29008](https://github.com/ClickHouse/ClickHouse/pull/29008)（[Vladimir C](https://github.com/vdimir)）。
* `GLOBAL IN` サブクエリで使用されるスレッド数を修正しました（[#19414](https://github.com/ClickHouse/ClickHouse/issues/19414) のバグ修正以降、1つのスレッドのみで実行されていました）。[#28997](https://github.com/ClickHouse/ClickHouse/pull/28997)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `WITH FILL` を含む `ORDER BY` に対する不適切な最適化を修正しました。これにより [#28908](https://github.com/ClickHouse/ClickHouse/issues/28908) が解決されました。また、[#26049](https://github.com/ClickHouse/ClickHouse/issues/26049) も解決されています。[#28910](https://github.com/ClickHouse/ClickHouse/pull/28910)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 定数引数に対する高階配列関数（`arrayCompact` での `SIGSEGV` / `arrayDifference`・`arrayCumSumNonNegative` での `ILLEGAL_COLUMN`）を修正。 [#28904](https://github.com/ClickHouse/ClickHouse/pull/28904) ([Azat Khuzhin](https://github.com/azat)).
* `mutations_sync=2` の場合のミューテーションの待機処理を修正。 [#28889](https://github.com/ClickHouse/ClickHouse/pull/28889) ([Azat Khuzhin](https://github.com/azat)).
* 外部データベース（例: MySQL）に対する、複数列を含む `IN` 句（例: `(k,v) IN ((1, 2))`）を使用したクエリの問題を修正しました。 [#28888](https://github.com/ClickHouse/ClickHouse/pull/28888) ([Azat Khuzhin](https://github.com/azat)).
* ショートサーキット関数評価時の `LowCardinality` のバグを修正。 [#28884](https://github.com/ClickHouse/ClickHouse/issues/28884) をクローズ。 [#28887](https://github.com/ClickHouse/ClickHouse/pull/28887)（[Kruglov Pavel](https://github.com/Avogar)）。
* コンパクトパーツからのサブカラムの読み取りを修正。[#28873](https://github.com/ClickHouse/ClickHouse/pull/28873) ([Anton Popov](https://github.com/CurtizJ)).
* まれにレプリカ間で不整合が発生する可能性があった、`DROP PART` と `REPLACE/MOVE PARTITION` 間のレースコンディションを修正しました。 [#28864](https://github.com/ClickHouse/ClickHouse/pull/28864) ([tavplubix](https://github.com/tavplubix)).
* 短絡評価を用いる式のコンパイル処理を修正しました。 [#28821](https://github.com/ClickHouse/ClickHouse/pull/28821) ([Azat Khuzhin](https://github.com/azat)).
* すべてのレプリカを強制再起動した後に、ReplicatedMergeTree のレプリカ間で不整合が生じてしまう極めてまれなケースを修正しました。エラーは `Part ... intersects (previous|next) part ...` のように表示されます。 [#28817](https://github.com/ClickHouse/ClickHouse/pull/28817) ([alesapin](https://github.com/alesapin)).
* 接続が引き続き利用可能かどうかをより厳密に確認し、念のため `RabbitMQ` のシャットダウン時にスローされうるあらゆる例外も捕捉するようにしました。 [#28797](https://github.com/ClickHouse/ClickHouse/pull/28797) ([Kseniia Sumarokova](https://github.com/kssenii)).
* ReplicatedMergeTreeQueue における無害なレースコンディションを修正しました。ユーザーからは見えないはずですが、微妙なバグを引き起こす可能性があります。 [#28734](https://github.com/ClickHouse/ClickHouse/pull/28734) ([alesapin](https://github.com/alesapin))。
* 例外発生時に一部のみ作成された集約プロジェクションを使用する `SELECT` がクラッシュする可能性のある問題を修正。 [#28700](https://github.com/ClickHouse/ClickHouse/pull/28700) ([Amos Bird](https://github.com/amosbird)).
* 分散テーブル作成時に、渡されたパラメータが誤っている場合に発生するコアダンプの問題を修正しました。 [#28686](https://github.com/ClickHouse/ClickHouse/pull/28686) ([Zhiyong Wang](https://github.com/ljcui)).
* system.processes テーブルに Settings.Names と Settings.Values のエイリアスを追加。 [#28685](https://github.com/ClickHouse/ClickHouse/pull/28685) ([Vitaly](https://github.com/orloffv)).
* S2 Geometry ライブラリのサポート: `s2RectAdd` および `s2RectContains` 関数が必要とする引数の数を修正。 [#28663](https://github.com/ClickHouse/ClickHouse/pull/28663) ([Bharat Nallan](https://github.com/bharatnc))。
* Nullable または LowCardinality の主キーが使用されている場合の、不正な定数の型変換を修正。 [#28636](https://github.com/ClickHouse/ClickHouse/pull/28636) ([Amos Bird](https://github.com/amosbird)).
* PREWHERE を使用して「Column is not under aggregate function and not in GROUP BY」エラーを修正（対応: [#28461](https://github.com/ClickHouse/ClickHouse/issues/28461)）。 [#28502](https://github.com/ClickHouse/ClickHouse/pull/28502)（[Azat Khuzhin](https://github.com/azat)）。

### ClickHouseリリース v21.10, 2021-10-16 {#clickhouse-release-v2110-2021-10-16}

#### 後方互換性のない変更 {#backward-incompatible-change-2}

- 以下のMergeTreeテーブルレベル設定: `replicated_max_parallel_sends`、`replicated_max_parallel_sends_for_table`、`replicated_max_parallel_fetches`、`replicated_max_parallel_fetches_for_table` は現在機能しません。これらは正常に動作したことがなく、`max_replicated_fetches_network_bandwidth`、`max_replicated_sends_network_bandwidth`、および `background_fetches_pool_size` に置き換えられました。[#28404](https://github.com/ClickHouse/ClickHouse/pull/28404) ([alesapin](https://github.com/alesapin))。

#### 新機能 {#new-feature-2}


- ラムダ式としてユーザー定義関数(UDF)を作成する機能を追加しました。構文: `CREATE FUNCTION {function_name} as ({parameters}) -> {function core}`。例: `CREATE FUNCTION plus_one as (a) -> a + 1`。作成者 @Realist007。[#27796](https://github.com/ClickHouse/ClickHouse/pull/27796) ([Maksim Kita](https://github.com/kitaisreal)) [#23978](https://github.com/ClickHouse/ClickHouse/pull/23978) ([Realist007](https://github.com/Realist007))。
- `Executable` ストレージエンジンと `executable` テーブル関数を追加しました。外部スクリプトを使用したストリーミング方式のデータ処理が可能になります。[#28102](https://github.com/ClickHouse/ClickHouse/pull/28102) ([Maksim Kita](https://github.com/kitaisreal)) ([ruct](https://github.com/ruct))。
- `ExecutablePool` ストレージエンジンを追加しました。`Executable` と同様ですが、長時間実行プロセスのプールを使用します。[#28518](https://github.com/ClickHouse/ClickHouse/pull/28518) ([Maksim Kita](https://github.com/kitaisreal))。
- `ALTER TABLE ... MATERIALIZE COLUMN` クエリを追加しました。[#27038](https://github.com/ClickHouse/ClickHouse/pull/27038) ([Vladimir Chebotarev](https://github.com/excitoon))。
- `s3` テーブル関数へのパーティション分割書き込みをサポートしました。[#23051](https://github.com/ClickHouse/ClickHouse/pull/23051) ([Vladimir Chebotarev](https://github.com/excitoon))。
- データのインポート/エクスポートにおいて、`lz4` 圧縮形式(`gz`、`bz2`、`xz`、`zstd` に加えて)をサポートしました。[#25310](https://github.com/ClickHouse/ClickHouse/pull/25310) ([Bharat Nallan](https://github.com/bharatnc))。
- `enable_positional_arguments` 設定で位置引数を許可しました。[#2592](https://github.com/ClickHouse/ClickHouse/issues/2592) をクローズします。[#27530](https://github.com/ClickHouse/ClickHouse/pull/27530) ([Kseniia Sumarokova](https://github.com/kssenii))。
- s3 テーブルの `CREATE` クエリにおいて、`SETTINGS` 句でファイル形式に関連するユーザー設定を受け入れるようにしました。これにより [#27580](https://github.com/ClickHouse/ClickHouse/issues/27580) がクローズされます。[#28037](https://github.com/ClickHouse/ClickHouse/pull/28037) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- `RabbitMQ` エンジンで SSL 接続を許可しました。[#28365](https://github.com/ClickHouse/ClickHouse/pull/28365) ([Kseniia Sumarokova](https://github.com/kssenii))。
- サーバーポートを取得できる `getServerPort` 関数を追加しました。ポートがサーバーで使用されていない場合は例外をスローします。[#27900](https://github.com/ClickHouse/ClickHouse/pull/27900) ([Amos Bird](https://github.com/amosbird))。
- "snowflake id" と `DateTime`、`DateTime64` 間の変換関数を追加しました。[#27058](https://github.com/ClickHouse/ClickHouse/issues/27058) を参照してください。[#27704](https://github.com/ClickHouse/ClickHouse/pull/27704) ([jasine](https://github.com/jasine))。
- `SHA512` 関数を追加しました。[#27830](https://github.com/ClickHouse/ClickHouse/pull/27830) ([zhanglistar](https://github.com/zhanglistar))。
- クエリのサンプルのみを query_log に書き込むことを可能にする `log_queries_probability` 設定を追加しました。[#16609](https://github.com/ClickHouse/ClickHouse/issues/16609) をクローズします。[#27527](https://github.com/ClickHouse/ClickHouse/pull/27527) ([Nikolay Degterinsky](https://github.com/evillique))。

#### 実験的機能 {#experimental-feature-2}


- `web`型のディスクにより、読み取り専用テーブルを静的ファイルの形式でWebサーバーに保存できるようになりました。[#23982](https://github.com/ClickHouse/ClickHouse/issues/23982)を参照してください。[#25251](https://github.com/ClickHouse/ClickHouse/pull/25251) ([Kseniia Sumarokova](https://github.com/kssenii))。これは主に共有ストレージでの操作テストを容易にし、データセットのインポートを簡素化するために必要です。リリース21.11より前のバージョンでの使用は推奨されません。
- 新しいコマンド`BACKUP`と`RESTORE`が追加されました。[#21945](https://github.com/ClickHouse/ClickHouse/pull/21945) ([Vitaly Baranov](https://github.com/vitlibar))。これは開発中であり、現在のバージョンでの使用は想定されていません。

#### パフォーマンスの改善 {#performance-improvement-2}

- `sumIf`および`countIf`集約関数を高速化しました。[#28272](https://github.com/ClickHouse/ClickHouse/pull/28272) ([Raúl Marín](https://github.com/Algunenano))。
- `minmax`インデックス用の仮想プロジェクションを作成しました。`allow_experimental_projection_optimization`が有効な場合、可能な限りデータを読み取る代わりにminmaxインデックスを使用するようになりました。[#26286](https://github.com/ClickHouse/ClickHouse/pull/26286) ([Amos Bird](https://github.com/amosbird))。
- `sequenceMatch`と`sequenceCount`に2つのチェックを導入し、シーケンスパターンの決定的な部分がイベントリストに存在しない場合に早期終了できるようになりました。この変更により、以前は操作上限に達して失敗していた多くのクエリが実行可能になり、全体的にパイプラインが高速化されます。[#27729](https://github.com/ClickHouse/ClickHouse/pull/27729) ([Jakub Kuklis](https://github.com/jkuklis))。
- 二項関数の常に単調な情報、特に非ゼロ定数除算を用いてプライマリキー解析を強化しました。[#28302](https://github.com/ClickHouse/ClickHouse/pull/28302) ([Amos Bird](https://github.com/amosbird))。
- `hasAll`フィルタ条件でブルームフィルタのデータスキップインデックスを活用できるようになりました。[#27984](https://github.com/ClickHouse/ClickHouse/pull/27984) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM))。
- テーブル起動プロセスを遅延させることでデータパーツの読み込みを高速化しました。[#28313](https://github.com/ClickHouse/ClickHouse/pull/28313) ([Amos Bird](https://github.com/amosbird))。
- `WHERE`から`PREWHERE`に移動される条件が過剰になる可能性がある問題を修正しました(この最適化は設定`optimize_move_to_prewhere`で制御されます)。[#28139](https://github.com/ClickHouse/ClickHouse/pull/28139) ([lthaooo](https://github.com/lthaooo))。
- `optimize_distributed_group_by_sharding_key`をデフォルトで有効化しました。[#28105](https://github.com/ClickHouse/ClickHouse/pull/28105) ([Azat Khuzhin](https://github.com/azat))。

#### 改善 {#improvement-2}


* `Distributed` テーブルを作成する前にクラスタ名を確認し、誤ったクラスタ名でテーブルが作成されないようにしました。[#27832](https://github.com/ClickHouse/ClickHouse/issues/27832) を修正。[#27927](https://github.com/ClickHouse/ClickHouse/pull/27927)（[tavplubix](https://github.com/tavplubix)）。
* 他の quantile...Weighted 関数と同様に、集約関数 `quantileBFloat16Weighted` を追加します。この変更により [#27745](https://github.com/ClickHouse/ClickHouse/issues/27745) がクローズされます。 [#27758](https://github.com/ClickHouse/ClickHouse/pull/27758) ([Ivan Novitskiy](https://github.com/RedClusive))。
* 属性リストが空の辞書を作成できるようにしました。 [#27905](https://github.com/ClickHouse/ClickHouse/pull/27905) ([Maksim Kita](https://github.com/kitaisreal)).
* パスワードのリセット方法に関するインタラクティブなドキュメントを `clickhouse-client` に追加しました。これは、ユーザーが ClickHouse をインストールしてパスワードを設定した直後に忘れてしまうようなシナリオで有用です。 [#27750](https://github.com/ClickHouse/ClickHouse/issues/27750) を参照してください。 [#27903](https://github.com/ClickHouse/ClickHouse/pull/27903)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `JSONAsString` 入力形式で、データが配列で囲まれているケースをサポートしました。 [#25517](https://github.com/ClickHouse/ClickHouse/issues/25517) をクローズ。 [#25633](https://github.com/ClickHouse/ClickHouse/pull/25633) ([Kruglov Pavel](https://github.com/Avogar))。
* `system.replicas` テーブルに列 `last_queue_update_exception` を追加。 [#26843](https://github.com/ClickHouse/ClickHouse/pull/26843) ([nvartolomei](https://github.com/nvartolomei))。
* フェイルオーバー時の再接続を `MaterializedPostgreSQL` テーブルでサポートしました。[#28529](https://github.com/ClickHouse/ClickHouse/issues/28529) をクローズ。[#28614](https://github.com/ClickHouse/ClickHouse/pull/28614)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* サーバーの初回起動時に一意のサーバー UUID を生成します。[#20089](https://github.com/ClickHouse/ClickHouse/pull/20089) ([Bharat Nallan](https://github.com/bharatnc)).
* `MySQL` エンジンに `connection_wait_timeout` 設定を導入しました（デフォルト 5 秒、0 の場合は待機しない）。 [#28474](https://github.com/ClickHouse/ClickHouse/pull/28474) ([Azat Khuzhin](https://github.com/azat)).
* 不正な引数で `MaterializedPostgreSQL` を作成できないようにしました。[#28423](https://github.com/ClickHouse/ClickHouse/issues/28423) をクローズします。[#28430](https://github.com/ClickHouse/ClickHouse/pull/28430)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 垂直マージでは、事前定義された &quot;rows&#95;sources&quot; の代わりに実際の tmp ファイルを使用します。これにより、tmp ディスク上に不要なディレクトリが生成されるのを防ぎます。 [#28299](https://github.com/ClickHouse/ClickHouse/pull/28299) ([Amos Bird](https://github.com/amosbird))。
* HDFS との連携設定のために、clickhouse-server.service で環境変数 `LIBHDFS3_CONF` をエクスポートする代わりに、サーバー設定に `libhdfs3_conf` を追加しました。 [#28268](https://github.com/ClickHouse/ClickHouse/pull/28268) ([Zhichang Yu](https://github.com/yuzhichang))
* 一時状態にあるパーツの削除処理を修正し、`Part %name% doesn't exist` という予期しない例外が発生する可能性のあった問題を解消しました。[#23661](https://github.com/ClickHouse/ClickHouse/issues/23661) を修正。[#28221](https://github.com/ClickHouse/ClickHouse/pull/28221) [#28221](https://github.com/ClickHouse/ClickHouse/issues/28221)) ([Azat Khuzhin](https://github.com/azat)).
* `zookeeper_log.address` を修正し（この PR の最初のパッチが入る前はアドレスが常に `::` だった）、このカラムに対する `getpeername(2)` の呼び出し回数を減らします（`zookeeper_log` にエントリが追加されるたびに `getpeername()` が呼ばれていたため、これを回避するためにこのアドレスを zookeeper クライアント側でキャッシュします）。 [#28212](https://github.com/ClickHouse/ClickHouse/pull/28212)（[Azat Khuzhin](https://github.com/azat)）。
* 演算子 `[]` のインデックスと `Map` 型のキーとの間の暗黙的変換をサポートしました（例: 異なる `Int` 型間、`String` と `FixedString` 間など）。 [#28096](https://github.com/ClickHouse/ClickHouse/pull/28096) ([Anton Popov](https://github.com/CurtizJ)).
* PostgreSQL テーブルエンジンまたはテーブル関数への挿入時に `ON CONFLICT` 句をサポートしました。[#27727](https://github.com/ClickHouse/ClickHouse/issues/27727) をクローズしました。[#28081](https://github.com/ClickHouse/ClickHouse/pull/28081)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 互換性のあるデータをアタッチできるように、`Enum` データ型に対する制約を緩和しました。[#26672](https://github.com/ClickHouse/ClickHouse/issues/26672) をクローズしました。[#28028](https://github.com/ClickHouse/ClickHouse/pull/28028)（[Dmitry Novik](https://github.com/novikd)）。
* 空集合に対して定数キーでグループ化する際の動作を制御するための設定 `empty_result_for_aggregation_by_constant_keys_on_empty_set` を追加しました。これは、[#6842](https://github.com/ClickHouse/ClickHouse/issues/6842) の従来の動作を復元するためのものです。 [#27932](https://github.com/ClickHouse/ClickHouse/pull/27932)（[Amos Bird](https://github.com/amosbird)）。
* `replication_wait_for_inactive_replica_timeout` 設定を追加しました。これにより、非アクティブなレプリカが `ALTER` / `OPTIMZE` / `TRUNCATE` クエリを実行するまでの待機時間の上限を指定できます（デフォルトは 120 秒）。`replication_alter_partitions_sync` が 2 のときに、一部のレプリカが `replication_wait_for_inactive_replica_timeout` 秒を超えて非アクティブな状態のままである場合、`UNFINISHED` 例外がスローされます。 [#27931](https://github.com/ClickHouse/ClickHouse/pull/27931) ([tavplubix](https://github.com/tavplubix)).
* 複数引数を取る関数を適用できるように、`APPLY` カラムトランスフォーマーでラムダ引数をサポートしました。これは [#27877](https://github.com/ClickHouse/ClickHouse/issues/27877) に対応する変更です。 [#27901](https://github.com/ClickHouse/ClickHouse/pull/27901)（[Amos Bird](https://github.com/amosbird)）。
* `tcp_keep_alive_timeout` をデフォルトで有効にしました。[#27882](https://github.com/ClickHouse/ClickHouse/pull/27882)（[Azat Khuzhin](https://github.com/azat)）。
* リモートサーバーが異常終了した場合のリモートクエリのキャンセル処理を改善。 [#27881](https://github.com/ClickHouse/ClickHouse/pull/27881) ([Azat Khuzhin](https://github.com/azat)).
* 大きな S3 オブジェクトに対してマルチパートコピーアップロードを使用するようにしました。 [#27858](https://github.com/ClickHouse/ClickHouse/pull/27858) ([ianton-ru](https://github.com/ianton-ru)).
* ライブラリ辞書パスでシンボリックリンクを辿れるようにしました。 [#27815](https://github.com/ClickHouse/ClickHouse/pull/27815) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 現在は、`ALTER MODIFY COLUMN` で `T` を `Nullable(T)` に変更する操作に mutation は不要です。[#27787](https://github.com/ClickHouse/ClickHouse/pull/27787)（[victorgao](https://github.com/kafka1991)）。
* `ReadBufferFromS3` でエラーを黙って無視しないようにし、遅延をカウントしないようにします。 [#27484](https://github.com/ClickHouse/ClickHouse/pull/27484) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 実際の TTL 処理を行うことなくメタデータのみを再計算できるようにすることで、`ALTER ... MATERIALIZE TTL` を改善しました。 [#27019](https://github.com/ClickHouse/ClickHouse/pull/27019) ([lthaooo](https://github.com/lthaooo)).
* ファイル末尾（EOF）に改行がなくても、カスタムトップレベルドメインのリストを読み取れるようにしました。 [#28213](https://github.com/ClickHouse/ClickHouse/pull/28213) ([Azat Khuzhin](https://github.com/azat)).

#### バグ修正 {#bug-fix-1}


* `carbon-clickhouse` から圧縮データを読み込む際に「attempt to read after end of file」エラーで失敗する問題を修正。[#26149](https://github.com/ClickHouse/ClickHouse/issues/26149) をクローズ。[#28150](https://github.com/ClickHouse/ClickHouse/pull/28150)（[FArthur-cmd](https://github.com/FArthur-cmd)）。
* `ON CLUSTER` 句を伴う `GRANT WITH REPLACE` ステートメント実行時のアクセス権限チェックを修正しました。このPRは、修正 [#27001](https://github.com/ClickHouse/ClickHouse/pull/27701) を改善するものです。[#27983](https://github.com/ClickHouse/ClickHouse/pull/27983)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `LowCardinality(UUID)` 型の列に対して `extremes = 1` を指定した `SELECT` が行えるように。 [#27918](https://github.com/ClickHouse/ClickHouse/pull/27918) ([Vitaly Baranov](https://github.com/vitlibar)).
* 負の数に対する PostgreSQL 形式のキャスト（`::` 演算子）の処理を修正。[#27876](https://github.com/ClickHouse/ClickHouse/pull/27876)（[Anton Popov](https://github.com/CurtizJ)）。
* [#26864](https://github.com/ClickHouse/ClickHouse/pull/26864) 以降。`NamedSessionStorage` のシャットダウン処理を修正：`NamedSessionStorage` に保存されているセッションコンテキストは、グローバルコンテキストを破棄する前に破棄されるようになりました。[#27875](https://github.com/ClickHouse/ClickHouse/pull/27875)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `windowFunnel` の &quot;strict&quot; モードに関するバグ修正。この修正により [#27469](https://github.com/ClickHouse/ClickHouse/issues/27469) が解決されます。[#27563](https://github.com/ClickHouse/ClickHouse/pull/27563)（[achimbab](https://github.com/achimbab)）。
* 切り捨てられた `bzip2` アーカイブの読み取り時に発生する無限ループを修正。 [#28543](https://github.com/ClickHouse/ClickHouse/pull/28543) ([Azat Khuzhin](https://github.com/azat)).
* `MaterializedMySQL` からの内部 DDL における `DROP TABLE` の UUID の重複を修正しました。MaterializedMySQL は実験的な機能です。[#28533](https://github.com/ClickHouse/ClickHouse/pull/28533) ([Azat Khuzhin](https://github.com/azat))。
* `Nested` カラムと、名前にドットを含み `Nested` と同じプレフィックスを持つスカラーカラム（例: `n.id UInt32, n.arr1 Array(UInt64), n.arr2 Array(UInt64)`）を含むテーブルに対して `SELECT` クエリを実行した際に発生する `There is no subcolumn` エラーを修正しました。 [#28531](https://github.com/ClickHouse/ClickHouse/pull/28531) ([Anton Popov](https://github.com/CurtizJ)).
* `ReplicatedVersionedCollapsingMergeTree` に対する ALTER の後に `Existing table metadata in ZooKeeper differs in sorting key expression.` というエラーが発生しうるバグを修正しました。[#28515](https://github.com/ClickHouse/ClickHouse/issues/28515) を修正。[#28528](https://github.com/ClickHouse/ClickHouse/pull/28528)（[alesapin](https://github.com/alesapin)）。
* 分散DDLキューのバックグラウンド処理中に発生し得るZooKeeperウォッチのリーク（軽微な問題）を修正しました。 [#26036](https://github.com/ClickHouse/ClickHouse/issues/26036) をクローズします。 [#28446](https://github.com/ClickHouse/ClickHouse/pull/28446) ([tavplubix](https://github.com/tavplubix)).
* `MaterializedPostgreSQL` エンジンにおけるテーブル名のクオート漏れを修正し、[#28316](https://github.com/ClickHouse/ClickHouse/issues/28316) をクローズ。 [#28433](https://github.com/ClickHouse/ClickHouse/pull/28433)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* nullable 列での結合されていない行の誤った動作を修正。[#27691](https://github.com/ClickHouse/ClickHouse/issues/27691) をクローズ。[#28349](https://github.com/ClickHouse/ClickHouse/pull/28349)（[vdimir](https://github.com/vdimir)）。
* すべてのキー列が使用されていない場合における NOT IN インデックス最適化を修正しました。これにより [#28120](https://github.com/ClickHouse/ClickHouse/issues/28120) が解決されます。[#28315](https://github.com/ClickHouse/ClickHouse/pull/28315)（[Amos Bird](https://github.com/amosbird)）。
* 新しいパーツが空のパーツに置き換えられていたことが原因で発生していたパーツ同士の交差を修正。 [#28310](https://github.com/ClickHouse/ClickHouse/pull/28310) ([Azat Khuzhin](https://github.com/azat)).
* `optimize_read_in_order` 設定が有効な状態で、`ORDER BY` を含み `Merge` テーブルを対象とするクエリで発生していた結果の不整合を修正しました。 [#28266](https://github.com/ClickHouse/ClickHouse/pull/28266) ([Anton Popov](https://github.com/CurtizJ)).
* `Nullable(LowCardinality)` 型を含み、設定 `extremes` が 1 のクエリにおいて、未初期化メモリを読み込んでしまう可能性のある不具合を修正しました。[#28165](https://github.com/ClickHouse/ClickHouse/issues/28165) を修正。[#28205](https://github.com/ClickHouse/ClickHouse/pull/28205) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* プロジェクションに対するいくつかの細かな修正。詳細は PR を参照してください。[#28178](https://github.com/ClickHouse/ClickHouse/pull/28178) ([Amos Bird](https://github.com/amosbird))。
* コンテキスト／設定リローダーのシャットダウン順序の誤りにより、シャットダウン時にごくまれに発生するセグメンテーションフォルトを修正。 [#28088](https://github.com/ClickHouse/ClickHouse/pull/28088) ([nvartolomei](https://github.com/nvartolomei))。
* 関数 `JSONExtract` における `Nullable(String)` 型の null 値の取り扱いを修正しました。これにより [#27929](https://github.com/ClickHouse/ClickHouse/issues/27929) および [#27930](https://github.com/ClickHouse/ClickHouse/issues/27930) が修正されます。この不具合は [https://github.com/ClickHouse/ClickHouse/pull/25452](https://github.com/ClickHouse/ClickHouse/pull/25452) で導入されました。[#27939](https://github.com/ClickHouse/ClickHouse/pull/27939) ([Amos Bird](https://github.com/amosbird))。
* 新しい `clickhouse-keeper` ツールに対する複数の修正を行いました。`clickhouse-keeper` において、クライアントがリクエストへのレスポンスより先に watch レスポンスを受け取ってしまうまれなバグを修正しました。 [#28197](https://github.com/ClickHouse/ClickHouse/pull/28197) ([alesapin](https://github.com/alesapin))。リストウォッチ（`getChildren`）が子に対する `set` リクエストによってトリガーされた場合の、`clickhouse-keeper` における不正な動作を修正しました。 [#28190](https://github.com/ClickHouse/ClickHouse/pull/28190) ([alesapin](https://github.com/alesapin))。`clickhouse-keeper` の設定変更によってログが失われたりサーバーがハングしたりする可能性があるまれなケースを修正しました。 [#28360](https://github.com/ClickHouse/ClickHouse/pull/28360) ([alesapin](https://github.com/alesapin))。`rotate_logs_interval` を短くした場合に、ログが無限に出力され続ける可能性がある `clickhouse-keeper` のバグを修正しました。 [#28152](https://github.com/ClickHouse/ClickHouse/pull/28152) ([alesapin](https://github.com/alesapin))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-2}

- ストレステストでThread Fuzzerを有効化しました。Thread FuzzerはClickHouseの機能で、スレッドスケジューリングのより多くの組み合わせをテストし、潜在的な問題をより多く発見できるようにします。これにより [#9813](https://github.com/ClickHouse/ClickHouse/issues/9813) が解決されます。これにより [#9814](https://github.com/ClickHouse/ClickHouse/issues/9814) が解決されます。これにより [#9515](https://github.com/ClickHouse/ClickHouse/issues/9515) が解決されます。これにより [#9516](https://github.com/ClickHouse/ClickHouse/issues/9516) が解決されます。[#27538](https://github.com/ClickHouse/ClickHouse/pull/27538) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- テスト環境用の新しいログレベル`test`を追加しました。デフォルトの`trace`よりもさらに詳細な出力を行います。[#28559](https://github.com/ClickHouse/ClickHouse/pull/28559) ([alesapin](https://github.com/alesapin))。
- CMake設定段階でgitステータス情報を出力するようにしました。[#28047](https://github.com/ClickHouse/ClickHouse/pull/28047) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM))。
- デフォルトのリポジトリ(archive.ubuntu.com)がCIから応答しないため、ubuntu aptリポジトリを一時的にミラーru.archive.ubuntu.comに切り替えました。[#28016](https://github.com/ClickHouse/ClickHouse/pull/28016) ([Ilya Yatsishin](https://github.com/qoega))。

### ClickHouse リリース v21.9, 2021-09-09 {#clickhouse-release-v219-2021-09-09}

#### 後方互換性のない変更 {#backward-incompatible-change-3}


- `Decimal`型のテキスト表現において末尾のゼロを出力しないようになりました。例:スケール6の小数値の場合、`1.230000`ではなく`1.23`が出力されます。これにより[#15794](https://github.com/ClickHouse/ClickHouse/issues/15794)が解決されます。アプリケーションが末尾のゼロに依存していた場合、わずかな非互換性が生じる可能性があります。出力フォーマットでのシリアライゼーションは、設定`output_format_decimal_trailing_zeros`で制御できます。`toString`の実装とStringへのキャストは無条件で変更されます。[#27680](https://github.com/ClickHouse/ClickHouse/pull/27680) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 異なるパラメータで生成された集約関数の状態に対して、`-Merge`コンビネータを持つパラメトリック集約関数を適用できないようになりました。例えば、`fooState(42)(x)`の状態は`fooMerge(s)`や`fooMerge(123)(s)`では確定できず、`fooMerge(42)(s)`のようにパラメータを明示的に指定し、それらが一致している必要があります。これは、確定時にのみパラメータを使用する`quantile`や`sequence*`などの特殊な集約関数には影響しません。[#26847](https://github.com/ClickHouse/ClickHouse/pull/26847) ([tavplubix](https://github.com/tavplubix))。
- clickhouse-localにおいて、ポートを持つローカルアドレスを常にリモートとして扱うようになりました。[#26736](https://github.com/ClickHouse/ClickHouse/pull/26736) ([Raúl Marín](https://github.com/Algunenano))。
- 式の名前と同一のカラムエイリアスを持つ複雑なクエリにおいて、不正なキャストが発生する可能性がある問題を修正しました。これにより[#25447](https://github.com/ClickHouse/ClickHouse/issues/25447)が修正されます。これにより[#26914](https://github.com/ClickHouse/ClickHouse/issues/26914)が修正されます。この修正により後方互換性が失われる可能性があります:同一の名前を持つ異なる式が存在する場合、例外がスローされます。`enable_optimize_predicate_expression`が設定されている場合、まれなケースで動作しなくなる可能性があります。[#26639](https://github.com/ClickHouse/ClickHouse/pull/26639) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- スカラーサブクエリは、その型が`Nullable`になり得る場合、常に`Nullable`の結果を返すようになりました。これは、サブクエリが空の場合、その結果が`Null`である必要があるためです。以前は、互換性のない型に関するエラーが発生する可能性がありました(型推論はスカラーサブクエリを実行せず、非Nullable型を使用する可能性がありました)。`Nullable`に変換できない空の結果を持つスカラーサブクエリ(`Array`や`Tuple`など)は、エラーをスローするようになりました。[#25411](https://github.com/ClickHouse/ClickHouse/issues/25411)を修正します。[#26423](https://github.com/ClickHouse/ClickHouse/pull/26423) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- ヒアドキュメントの構文を導入しました。例:`SELECT $doc$ VALUE $doc$`。[#26671](https://github.com/ClickHouse/ClickHouse/pull/26671) ([Maksim Kita](https://github.com/kitaisreal))。この変更は、クエリに`$`を含む識別子がある場合、後方互換性がありません[#28768](https://github.com/ClickHouse/ClickHouse/issues/28768)。
- インデックスが`isNull`や`isNotNull`を含むNullable型を処理できるようになりました。[#12433](https://github.com/ClickHouse/ClickHouse/pull/12433)および[#12455](https://github.com/ClickHouse/ClickHouse/pull/12455) ([Amos Bird](https://github.com/amosbird))、[#27250](https://github.com/ClickHouse/ClickHouse/pull/27250) ([Azat Khuzhin](https://github.com/azat))。ただし、これはディスク上のフォーマット変更を伴って実装されており、新しいサーバーは古いデータを読み取ることができますが、古いサーバーは読み取ることができません。また、`MINMAX`データスキッピングインデックスを使用している場合、新しいインデックスの拡張子が`.idx2`になるのに対し、以前は`.idx`だったため、`Data after mutation/merge is not byte-identical`エラーが発生する可能性があります。つまり、この場合、既存のすべてのレプリカの更新を遅らせるべきではありません。そうしないと、古いレプリカ(&lt;21.9)が21.9+の新しいレプリカからデータをダウンロードした場合、ダウンロードしたパートにインデックスを適用できなくなります。

#### 新機能 {#new-feature-3}


* ショートサーキット関数評価を実装し、[#12587](https://github.com/ClickHouse/ClickHouse/issues/12587) をクローズしました。ショートサーキット関数評価を制御する設定 `short_circuit_function_evaluation` を追加しました。[#23367](https://github.com/ClickHouse/ClickHouse/pull/23367) ([Kruglov Pavel](https://github.com/Avogar))。
* INTERSECT、EXCEPT、ANY、ALL 演算子のサポートを追加。 [#24757](https://github.com/ClickHouse/ClickHouse/pull/24757) ([Kirill Ershov](https://github.com/zdikov)). ([Kseniia Sumarokova](https://github.com/kssenii)).
* AES-CTR アルゴリズムを使用した仮想ファイルシステムレベルでの暗号化（保存データの暗号化）のサポートを追加しました。 [#24206](https://github.com/ClickHouse/ClickHouse/pull/24206) ([Latysheva Alexandra](https://github.com/alexelex)). ([Vitaly Baranov](https://github.com/vitlibar)) [#26733](https://github.com/ClickHouse/ClickHouse/pull/26733) [#26377](https://github.com/ClickHouse/ClickHouse/pull/26377) [#26465](https://github.com/ClickHouse/ClickHouse/pull/26465).
* synonyms 拡張機能に、トークン化、ステミング、レンマ化および検索用の自然言語処理 (NLP) 関数を追加しました。 [#24997](https://github.com/ClickHouse/ClickHouse/pull/24997) ([Nikolay Degterinsky](https://github.com/evillique)).
* S2 Geometry ライブラリとの統合を追加しました。 [#24980](https://github.com/ClickHouse/ClickHouse/pull/24980) ([Andr0901](https://github.com/Andr0901)). ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* SQLite テーブルエンジン、テーブル関数、データベースエンジンを追加しました。 [#24194](https://github.com/ClickHouse/ClickHouse/pull/24194) ([Arslan Gumerov](https://github.com/g-arslan)). ([Kseniia Sumarokova](https://github.com/kssenii)).
* `MySQL`、`PostgreSQL`、`ClickHouse`、`JDBC`、`Cassandra` の辞書ソースに対するカスタムクエリのサポートを追加しました。 [#1270](https://github.com/ClickHouse/ClickHouse/issues/1270) をクローズしました。 [#26995](https://github.com/ClickHouse/ClickHouse/pull/26995)（[Maksim Kita](https://github.com/kitaisreal)）。
* ZooKeeper 経由でユーザー、ロール、行ポリシー、クオータ、設定プロファイルの共有（レプリケート）ストレージを追加。 [#27426](https://github.com/ClickHouse/ClickHouse/pull/27426) ([Kevin Michel](https://github.com/kmichel-aiven)).
* `INTO OUTFILE` に、圧縮アルゴリズムを自動的に選択する圧縮機能を追加。[#3473](https://github.com/ClickHouse/ClickHouse/issues/3473) を解決。[#27134](https://github.com/ClickHouse/ClickHouse/pull/27134)（[Filatenkov Artur](https://github.com/FArthur-cmd)）。
* `SELECT ... INTO OUTFILE` と同様に、`INSERT ... FROM INFILE` を追加しました。 [#27655](https://github.com/ClickHouse/ClickHouse/pull/27655) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* `complex_key_range_hashed` 辞書を追加しました。[#22029](https://github.com/ClickHouse/ClickHouse/issues/22029) をクローズしました。[#27629](https://github.com/ClickHouse/ClickHouse/pull/27629)（[Maksim Kita](https://github.com/kitaisreal)）。
* JOIN の ON 句で式をサポートしました。[#21868](https://github.com/ClickHouse/ClickHouse/issues/21868) をクローズしました。[#24420](https://github.com/ClickHouse/ClickHouse/pull/24420)（[Vladimir C](https://github.com/vdimir)）。
* クライアントがサーバーに接続すると、サーバー上ですでに蓄積されているすべての警告に関する情報を受信します（この動作はオプション `--no-warnings` で無効化できます）。サーバー設定に関する警告を収集するために `system.warnings` テーブルを追加しました。 [#26246](https://github.com/ClickHouse/ClickHouse/pull/26246)（[Filatenkov Artur](https://github.com/FArthur-cmd)）。 [#26282](https://github.com/ClickHouse/ClickHouse/pull/26282)（[Filatenkov Artur](https://github.com/FArthur-cmd)）。
* WITH および SELECT の定数式を集約関数の引数で使用できるようにしました。[#10945](https://github.com/ClickHouse/ClickHouse/issues/10945) をクローズしました。[#27531](https://github.com/ClickHouse/ClickHouse/pull/27531)（[abel-cheng](https://github.com/abel-cheng)）。
* 名前付きタプルを名前と値のペアの配列に変換する関数 `tupleToNameValuePairs` を追加しました。 [#27505](https://github.com/ClickHouse/ClickHouse/pull/27505) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM)).
* インポート／エクスポートで `bzip2` 圧縮方式をサポート。[#22428](https://github.com/ClickHouse/ClickHouse/issues/22428) をクローズ。[#27377](https://github.com/ClickHouse/ClickHouse/pull/27377)（[Nikolay Degterinsky](https://github.com/evillique)）。
* `bitmapSubsetOffsetLimit(bitmap, offset, cardinality_limit)` 関数を追加しました。この関数は、ビットマップに対して `offset` から始まる部分を取り出し、結果の要素数を `cardinality_limit` に制限したサブセットを作成します。 [#27234](https://github.com/ClickHouse/ClickHouse/pull/27234) ([DHBin](https://github.com/DHBin))。
* `system.users` に `default_database` 列を追加。 [#27054](https://github.com/ClickHouse/ClickHouse/pull/27054) ([kevin wan](https://github.com/MaxWk)).
* テーブル関数 `cluster` と `clusterAllReplicas` で `cluster` マクロをサポートしました。 [#26913](https://github.com/ClickHouse/ClickHouse/pull/26913) ([polyprogrammist](https://github.com/PolyProgrammist)).
* 新しい関数 `currentRoles()`, `enabledRoles()`, `defaultRoles()` を追加しました。[#26780](https://github.com/ClickHouse/ClickHouse/pull/26780)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 新しい関数 `currentProfiles()`, `enabledProfiles()`, `defaultProfiles()` が追加されました。 [#26714](https://github.com/ClickHouse/ClickHouse/pull/26714) ([Vitaly Baranov](https://github.com/vitlibar)).
* 現在のクエリの (initial&#95;)query&#95;id を返す関数を追加しました。これにより [#23682](https://github.com/ClickHouse/ClickHouse/issues/23682) がクローズされました。 [#26410](https://github.com/ClickHouse/ClickHouse/pull/26410) ([Alexey Boykov](https://github.com/mathalex)).
* `REPLACE GRANT` 機能を追加しました。 [#26384](https://github.com/ClickHouse/ClickHouse/pull/26384) ([Caspian](https://github.com/Cas-pian)).
* `EXPLAIN` クエリに、MergeTree テーブルから読み取られる行数、マーク、およびパーツに関する情報を表示する `EXPLAIN ESTIMATE ...` モードが追加されました。[#23941](https://github.com/ClickHouse/ClickHouse/issues/23941) をクローズしました。[#26131](https://github.com/ClickHouse/ClickHouse/pull/26131) ([fastio](https://github.com/fastio))。
* `system.zookeeper_log` テーブルを追加しました。ZooKeeper クライアントによるすべての操作がこのテーブルに記録されます。[#25449](https://github.com/ClickHouse/ClickHouse/issues/25449) を実装しました。 [#26129](https://github.com/ClickHouse/ClickHouse/pull/26129) ([tavplubix](https://github.com/tavplubix))。
* `HDFS` ストレージ上の `ReplicatedMergeTree` 向けのゼロコピー・レプリケーション。 [#25918](https://github.com/ClickHouse/ClickHouse/pull/25918) ([Zhichang Yu](https://github.com/yuzhichang)).
* `Arrow`、`ORC`、`Parquet` 入力フォーマットで、`Nested` 型を構造体の配列として挿入できるようにしました。 [#25902](https://github.com/ClickHouse/ClickHouse/pull/25902) ([Kruglov Pavel](https://github.com/Avogar))。
* 新しいデータ型 `Date32`（データを Int32 として格納）を追加し、`DateTime64` と同じ日付範囲をサポートするとともに、Parquet の `date32` を ClickHouse の `Date32` に読み込むことをサポートしました。また、`toDate` と同様の新しい関数 `toDate32` を追加しました。 [#25774](https://github.com/ClickHouse/ClickHouse/pull/25774) ([LiuNeng](https://github.com/liuneng1994)).
* ユーザーのデフォルトデータベースを設定できるようにしました。 [#25268](https://github.com/ClickHouse/ClickHouse/issues/25268)。 [#25687](https://github.com/ClickHouse/ClickHouse/pull/25687) ([kevin wan](https://github.com/MaxWk))。
* `MongoDB` エンジンにオプションのパラメータを追加し、接続文字列オプションを受け付けて SSL 接続をサポートするようにしました。[#21189](https://github.com/ClickHouse/ClickHouse/issues/21189) をクローズ。[#21041](https://github.com/ClickHouse/ClickHouse/issues/21041) をクローズ。[#22045](https://github.com/ClickHouse/ClickHouse/pull/22045)（[Omar Bazaraa](https://github.com/OmarBazaraa)）。

#### 実験的機能 {#experimental-feature-3}

- カラムを圧縮する代わりに暗号化する圧縮コーデック `AES_128_GCM_SIV` を追加しました。[#19896](https://github.com/ClickHouse/ClickHouse/pull/19896) ([PHO](https://github.com/depressed-pho))。書き直される予定のため、使用しないでください。
- `MaterializeMySQL` を `MaterializedMySQL` に名称変更しました。[#26822](https://github.com/ClickHouse/ClickHouse/pull/26822) ([tavplubix](https://github.com/tavplubix))。

#### パフォーマンス改善 {#performance-improvement-3}

- `clock_gettime` システムコールの回数を削減することで、`max_execution_time = 0` の場合の高速クエリのパフォーマンスを改善しました。[#27325](https://github.com/ClickHouse/ClickHouse/pull/27325) ([filimonov](https://github.com/filimonov))。
- 日時関連の比較を特殊化してパフォーマンスを向上させました。これにより [#27083](https://github.com/ClickHouse/ClickHouse/issues/27083) が修正されます。[#27122](https://github.com/ClickHouse/ClickHouse/pull/27122) ([Amos Bird](https://github.com/amosbird))。
- 同じファイルの同時読み取りでファイルディスクリプタを共有するようにしました。Linux上では顕著なパフォーマンスの違いはありませんが、一般的なサーバーでは開かれるファイル数が大幅に（10〜100倍）削減され、運用が容易になります。[#26214](https://github.com/ClickHouse/ClickHouse/issues/26214) を参照してください。[#26768](https://github.com/ClickHouse/ClickHouse/pull/26768) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 多数のカラムを持つテーブルからの読み取りを必要とする短いクエリのレイテンシを改善しました。[#26371](https://github.com/ClickHouse/ClickHouse/pull/26371) ([Anton Popov](https://github.com/CurtizJ))。
- クエリ分析時にインデックス用のセットを構築しないようにしました。[#26365](https://github.com/ClickHouse/ClickHouse/pull/26365) ([Raúl Marín](https://github.com/Algunenano))。
- ネイティブ表現を持つNullable整数型のSUMをベクトル化しました（[David Manzanares](https://github.com/davidmanzanares)、[Raúl Marín](https://github.com/Algunenano)）。[#26248](https://github.com/ClickHouse/ClickHouse/pull/26248) ([Raúl Marín](https://github.com/Algunenano))。
- `Enum` 型のカラムを含む式をコンパイルするようにしました。[#26237](https://github.com/ClickHouse/ClickHouse/pull/26237) ([Maksim Kita](https://github.com/kitaisreal))。
- 集約関数 `groupBitOr`、`groupBitAnd`、`groupBitXor` をコンパイルするようにしました。[#26161](https://github.com/ClickHouse/ClickHouse/pull/26161) ([Maksim Kita](https://github.com/kitaisreal))。
- 空のDEFAULTカラムを読み取る際のブロックサイズ予測を改善し、メモリ使用量を向上させました。[#17317](https://github.com/ClickHouse/ClickHouse/issues/17317) をクローズします。[#25917](https://github.com/ClickHouse/ClickHouse/pull/25917) ([Vladimir Chebotarev](https://github.com/excitoon))。
- `ORDER BY primary_key` を使用するクエリにおいて、メモリ使用量と読み取り行数を削減しました。[#25721](https://github.com/ClickHouse/ClickHouse/pull/25721) ([Anton Popov](https://github.com/CurtizJ))。
- `distributed_push_down_limit` をデフォルトで有効にしました。[#27104](https://github.com/ClickHouse/ClickHouse/pull/27104) ([Azat Khuzhin](https://github.com/azat))。
- timeZoneが定数値の場合に `toTimeZone` を単調にし、次のようなSQLを使用する際のパーティションプルーニングをサポートしました。[#26261](https://github.com/ClickHouse/ClickHouse/pull/26261) ([huangzhaowei](https://github.com/SaintBacchus))。

#### 改善 {#improvement-3}


* ウィンドウ関数を一般利用可能としてマークし、`allow_experimental_window_functions` 設定を削除しました。[#27184](https://github.com/ClickHouse/ClickHouse/pull/27184) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* 分単位ではないタイムゾーンオフセットとの互換性を向上しました。 [#27080](https://github.com/ClickHouse/ClickHouse/pull/27080) ([Raúl Marín](https://github.com/Algunenano)).
* `File` テーブル内のファイルディスクリプタが通常ファイルである場合、そのファイルから複数回読み取れるようにしました。これにより、標準入力が `clickhouse-local --query "SELECT * FROM table UNION ALL SELECT * FROM table" ... &lt; file` のように通常ファイルにリダイレクトされている場合、`clickhouse-local` は（複数の SELECT クエリやサブクエリで）標準入力から複数回読み取ることができます。この変更により [#11124](https://github.com/ClickHouse/ClickHouse/issues/11124) がクローズされました。([alexey-milovidov](https://github.com/alexey-milovidov)) との共同作業です。[#25960](https://github.com/ClickHouse/ClickHouse/pull/25960) ([BoloniniD](https://github.com/BoloniniD)).
* 重複したインデックス解析を削除し、プロジェクション解析中の無効となる可能性のある `LIMIT` チェックを回避しました。 [#27742](https://github.com/ClickHouse/ClickHouse/pull/27742) ([Amos Bird](https://github.com/amosbird))。
* HTTP リクエストのボディ内でクエリパラメータを渡せるようにしました。 [#27706](https://github.com/ClickHouse/ClickHouse/pull/27706) ([Hermano Lustosa](https://github.com/hllustosa)).
* パーティション式での `arrayJoin` の使用を禁止。 [#27648](https://github.com/ClickHouse/ClickHouse/pull/27648) ([Raúl Marín](https://github.com/Algunenano)).
* 認証失敗時にクライアントの IP アドレスをログに記録。 [#27514](https://github.com/ClickHouse/ClickHouse/pull/27514) ([Misko Lee](https://github.com/imiskolee)).
* gRPC プロトコルにおいて、バイナリデータには文字列ではなくバイトを使用するようにしました。 [#27431](https://github.com/ClickHouse/ClickHouse/pull/27431) ([Vitaly Baranov](https://github.com/vitlibar)).
* HTTP ポートが設定されていないにもかかわらず、ユーザーが TCP ポートに HTTP リクエストを送信しようとした場合に、エラーメッセージ付きのレスポンスを返すようにしました。 [#27385](https://github.com/ClickHouse/ClickHouse/pull/27385) ([Braulio Valdivielso Martínez](https://github.com/BraulioVM)).
* 内部利用向けに `_CAST` 関数を追加しました。この関数は型の null 許容性を保持しませんが、通常の `CAST` は設定 `cast_keep_nullable` に従って null 許容性を保持します。 [#12636](https://github.com/ClickHouse/ClickHouse/issues/12636) をクローズ。 [#27382](https://github.com/ClickHouse/ClickHouse/pull/27382)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 設定 `log_formatted_queries` を追加し、フォーマット済みクエリを追加で `system.query_log` に記録できるようにしました。`normalizeQuery` や `normalizeQueryKeepNames` のような関数は、より高いパフォーマンスを実現するためにクエリをパース／フォーマットしないため、これは正規化クエリの分析に役立ちます。 [#27380](https://github.com/ClickHouse/ClickHouse/pull/27380) ([Amos Bird](https://github.com/amosbird))。
* `multiMatchAny` などの hyperscan 関連関数で過度に大きな正規表現が使用されるのを防ぐために、`max_hyperscan_regexp_length` と `max_hyperscan_regexp_total_length` の 2 つの設定を追加しました。 [#27378](https://github.com/ClickHouse/ClickHouse/pull/27378) ([Amos Bird](https://github.com/amosbird))。
* ビットマップ集約関数によって消費されるメモリが、メモリ制限の計算に含まれるようになりました。これにより [#26555](https://github.com/ClickHouse/ClickHouse/issues/26555) が解決されました。[#27252](https://github.com/ClickHouse/ClickHouse/pull/27252)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* S3 プロキシ リゾルバーに 10 秒間のキャッシュを追加。[#27216](https://github.com/ClickHouse/ClickHouse/pull/27216)（[ianton-ru](https://github.com/ianton-ru)）。
* グローバルミューテックスを廃し、正規表現の構築処理ごとに個別のミューテックスを用いるようにしました。これにより、大規模な正規表現の構築が他の関連スレッドをブロックしてしまうことを避けられます。 [#27211](https://github.com/ClickHouse/ClickHouse/pull/27211) ([Amos Bird](https://github.com/amosbird)).
* PostgreSQL データベースエンジンで `schema` のサポートを追加。[#27166](https://github.com/ClickHouse/ClickHouse/issues/27166) をクローズ。[#27198](https://github.com/ClickHouse/ClickHouse/pull/27198)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* clickhouse-client でのメモリ使用量の追跡に対応しました。 [#27191](https://github.com/ClickHouse/ClickHouse/pull/27191) ([Filatenkov Artur](https://github.com/FArthur-cmd)).
* クエリの開始に失敗した場合でも `system.query_log` に `query_kind` を記録するよう試行します。 [#27182](https://github.com/ClickHouse/ClickHouse/pull/27182) ([Amos Bird](https://github.com/amosbird)).
* テーブル `system.replicas` に、レプリカ名とレプリカのアクティブ状態を対応付ける列 `replica_is_active` を追加しました。[#27138](https://github.com/ClickHouse/ClickHouse/issues/27138) をクローズしました。 [#27180](https://github.com/ClickHouse/ClickHouse/pull/27180)（[Maksim Kita](https://github.com/kitaisreal)）。
* Web UI でサーバー URI を介してクエリ設定を指定できるようにしました。 [#27177](https://github.com/ClickHouse/ClickHouse/pull/27177) ([kolsys](https://github.com/kolsys))。
* 現在のノードが ZooKeeper にプッシュした DDL エントリ ID のうち最大のものを表す `MaxPushedDDLEntryID` という新しいメトリクスを追加しました。 [#27174](https://github.com/ClickHouse/ClickHouse/pull/27174) ([Fuwang Hu](https://github.com/fuwhu)).
* `clickhouse-keeper` が znode を作成する際の存在条件チェックおよび空文字列ノードの判定ロジックを改善しました。 [#27125](https://github.com/ClickHouse/ClickHouse/pull/27125) ([小路](https://github.com/nicelulu))
* Merge JOIN が右側の空集合を正しく処理するようになりました。 [#27078](https://github.com/ClickHouse/ClickHouse/pull/27078) ([Vladimir C](https://github.com/vdimir))
* 関数をシャードレベルの定数として扱えるようになりました。つまり、分散テーブルのコンテキストで実行された場合は通常の列を生成し、それ以外の場合は定数値を生成します。代表的な関数は `hostName()`, `tcpPort()`, `version()`, `buildId()`, `uptime()` などです。[#27020](https://github.com/ClickHouse/ClickHouse/pull/27020)（[Amos Bird](https://github.com/amosbird)）。
* `extractAllGroupsHorizontal` を更新しました。オプションの 3 番目の引数で、1 行あたりのマッチ数の上限を設定できるようになりました。 [#26961](https://github.com/ClickHouse/ClickHouse/pull/26961) ([Vasily Nemkov](https://github.com/Enmk))。
* `system.rocksdb` テーブルを介して `RocksDB` の統計情報を参照できるようにしました。ClickHouse の設定ファイルから RocksDB のオプション（`rocksdb...` キー）を読み込みます。注意: ClickHouse は RocksDB に依存しておらず、RocksDB は追加の統合ストレージエンジンの一つにすぎません。[#26821](https://github.com/ClickHouse/ClickHouse/pull/26821) ([Azat Khuzhin](https://github.com/azat))。
* RocksDB の内部ログをより簡潔にしました。注意：ClickHouse は RocksDB に依存しておらず、これは追加の統合ストレージエンジンの 1 つにすぎません。これにより [#26252](https://github.com/ClickHouse/ClickHouse/issues/26252) がクローズされました。 [#26789](https://github.com/ClickHouse/ClickHouse/pull/26789) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* デフォルトのロールを変更しても、影響を受けるのは新しいセッションのみです。 [#26759](https://github.com/ClickHouse/ClickHouse/pull/26759) ([Vitaly Baranov](https://github.com/vitlibar)).
* Docker 環境ではデフォルトで Watchdog が無効になりました。Ctrl+C が処理されない問題を修正しました。 [#26757](https://github.com/ClickHouse/ClickHouse/pull/26757) ([Mikhail f. Shiryaev](https://github.com/Felixoid)).
* `SET PROFILE` で指定したプロファイルに制約が設定されている場合、その制約も適用されるようになりました。 [#26730](https://github.com/ClickHouse/ClickHouse/pull/26730) ([Vitaly Baranov](https://github.com/vitlibar))。
* `KILL QUERY` リクエストの処理を改善しました。 [#26675](https://github.com/ClickHouse/ClickHouse/pull/26675) ([Raúl Marín](https://github.com/Algunenano)).
* `mapPopulatesSeries` 関数が `Map` 型をサポートするようになりました。[#26663](https://github.com/ClickHouse/ClickHouse/pull/26663)（[Ildus Kurbangaliev](https://github.com/ildus)）。
* `skip_unavailable_shards` 使用時に発生していた過剰な接続試行（2 回）を修正。 [#26658](https://github.com/ClickHouse/ClickHouse/pull/26658) ([Azat Khuzhin](https://github.com/azat)).
* 接続が失敗した場合（例: EMFILE 発生時）に `clickhouse-benchmark` がハングしないようにしました。 [#26656](https://github.com/ClickHouse/ClickHouse/pull/26656) ([Azat Khuzhin](https://github.com/azat))。
* Kafka エンジンで使用可能なスレッド数を増やしました。 [#26642](https://github.com/ClickHouse/ClickHouse/pull/26642) ([feihengye](https://github.com/feihengye)).
* `clickhouse-benchmark` にラウンドロビンのサポートを追加しました（統計レポートを除き、通常のマルチホスト / ポート実行との違いはありません）。[#26607](https://github.com/ClickHouse/ClickHouse/pull/26607)（[Azat Khuzhin](https://github.com/azat)）。
* 実行可能辞書（`executable`、`executable_pool`）を `clickhouse-local` を使用した DDL クエリで作成できるようになりました。 [#22355](https://github.com/ClickHouse/ClickHouse/issues/22355) をクローズ。 [#26510](https://github.com/ClickHouse/ClickHouse/pull/26510)（[Maksim Kita](https://github.com/kitaisreal)）。
* `mysql` および `postgresql` 互換プロトコルハンドラ向けに、クライアントクエリの種類を設定しました。 [#26498](https://github.com/ClickHouse/ClickHouse/pull/26498) ([anneji-dev](https://github.com/anneji-dev)).
* `distributed_push_down_limit=1` を使用すると、`SELECT * FROM dist ORDER BY key LIMIT 10` のようなクエリに対してシャード側で `LIMIT` が適用されます。`SELECT DISTINCT shading_key FROM dist ORDER BY key` のようなクエリに対しては、`DISTINCT` / `LIMIT BY` のステップの実行を回避します。これにより、`distributed_push_down_limit` が `optimize_distributed_group_by_sharding_key` 最適化によって正しく考慮されるようになりました。 [#26466](https://github.com/ClickHouse/ClickHouse/pull/26466) ([Azat Khuzhin](https://github.com/azat)).
* protobuf を 3.17.3 に更新しました。変更履歴は [https://github.com/protocolbuffers/protobuf/releases](https://github.com/protocolbuffers/protobuf/releases) で確認できます。[#26424](https://github.com/ClickHouse/ClickHouse/pull/26424)（[Ilya Yatsishin](https://github.com/qoega)）。
* 大規模クラスタでのテイルレイテンシを軽減できる `use_hedged_requests` 設定を有効にしました。 [#26380](https://github.com/ClickHouse/ClickHouse/pull/26380) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* ユーザーの許可ホストリストに存在しないホストが指定された場合の動作を改善。 [#26368](https://github.com/ClickHouse/ClickHouse/pull/26368) ([ianton-ru](https://github.com/ianton-ru)).
* `CREATE TABLE` を通じて `Distributed` ディレクトリモニターの設定を指定できるようにする機能を追加（例: `CREATE TABLE dist (key Int) Engine=Distributed(cluster, db, table) SETTINGS monitor_batch_inserts=1` など）。 [#26336](https://github.com/ClickHouse/ClickHouse/pull/26336) ([Azat Khuzhin](https://github.com/azat)).
* web UI のオリジンと異なるサーバーアドレスを、web UI の履歴 URL に保存するようにしました。これにより [#26044](https://github.com/ClickHouse/ClickHouse/issues/26044) が解決されます。[#26322](https://github.com/ClickHouse/ClickHouse/pull/26322)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `sleep` / `sleepEachRow` 呼び出しのプロファイルにイベントを追加。 [#26320](https://github.com/ClickHouse/ClickHouse/pull/26320) ([Raúl Marín](https://github.com/Algunenano)).
* シャードの接続を異なるクラスタ間で再利用できるようにします。また、`cluster` テーブル関数の使用時に新しい接続を作成する必要もなくなります。 [#26318](https://github.com/ClickHouse/ClickHouse/pull/26318) ([Amos Bird](https://github.com/amosbird)).
* 古い一時ディレクトリのクリーンアップ処理の実行間隔を、デフォルト値付きのパラメータで制御できるようにしました。 [#26212](https://github.com/ClickHouse/ClickHouse/issues/26212)。 [#26313](https://github.com/ClickHouse/ClickHouse/pull/26313) ([fastio](https://github.com/fastio))。
* 関数 `range` によって生成されるデータ量に対する安全性のしきい値を調整できるようにする設定 `function_range_max_elements_in_block` を追加しました。これにより [#26303](https://github.com/ClickHouse/ClickHouse/issues/26303) が解決されました。 [#26305](https://github.com/ClickHouse/ClickHouse/pull/26305) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* ハッシュ関数はサンプリング時ではなくテーブル作成時にチェックするようにしました。MergeTree 用に設定を追加し、誤ったサンプリング列でテーブルが作成されても、サンプリングが実際には一度も使用されない場合にはこの設定を無効化することで、例外を発生させずにサーバーを起動できるようにしました。 [#26256](https://github.com/ClickHouse/ClickHouse/pull/26256) ([zhaoyu](https://github.com/zxc111)).
* `output_format_avro_string_column_pattern` 設定を追加し、指定した String カラムを、デフォルトの bytes ではなく Avro の string として出力できるようにしました。[#22414](https://github.com/ClickHouse/ClickHouse/issues/22414) を実装。[#26245](https://github.com/ClickHouse/ClickHouse/pull/26245)（[Ilya Golshtein](https://github.com/ilejn)）。
* `Log` および `TinyLog` テーブルに対して、`system.columns` テーブルに列サイズ情報を追加しました。これにより [#9001](https://github.com/ClickHouse/ClickHouse/issues/9001) が解決されました。[#26241](https://github.com/ClickHouse/ClickHouse/pull/26241)（[Nikolay Degterinsky](https://github.com/evillique)）。
* カスタムディスク構成があり、一部のディスクに `detached` ディレクトリが存在しない場合でも、`system.detached_parts` テーブルをクエリした際に例外をスローしないようにしました。これにより [#26078](https://github.com/ClickHouse/ClickHouse/issues/26078) が解決されました。 [#26236](https://github.com/ClickHouse/ClickHouse/pull/26236) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `now()` や `today()` などの定数式を含む、キー内での非決定的関数の使用をチェックします。これにより [#25875](https://github.com/ClickHouse/ClickHouse/issues/25875) が解決されます。また [#11333](https://github.com/ClickHouse/ClickHouse/issues/11333) も解決されます。[#26235](https://github.com/ClickHouse/ClickHouse/pull/26235)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* PostgreSQL テーブルエンジンにおいて、timestamp および timestamptz データ型を `DateTime64` に変換します。[#26234](https://github.com/ClickHouse/ClickHouse/pull/26234) ([jasine](https://github.com/jasine))。
* プロジェクションに対して積極的な `IN` インデックス解析を適用し、より適切なプロジェクション候補を選択できるようにしました。 [#26218](https://github.com/ClickHouse/ClickHouse/pull/26218) ([Amos Bird](https://github.com/amosbird)).
* スカラー関数が渡された場合に、IN での GLOBAL キーワードを削除しました。以前のバージョンでは、ユーザーが `GLOBAL IN f(x)` を指定すると例外がスローされていました。 [#26217](https://github.com/ClickHouse/ClickHouse/pull/26217) ([Amos Bird](https://github.com/amosbird))。
* エラー ID（例：`BAD_ARGUMENTS`）を例外メッセージに追加。これにより [#25862](https://github.com/ClickHouse/ClickHouse/issues/25862) がクローズされました。[#26172](https://github.com/ClickHouse/ClickHouse/pull/26172)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* clickhouse-local の `--progress` オプションでの誤った出力を修正。プログレスバーは 100% に達した時点でクリアされるようになり、clickhouse-client と同様の動作になります。[#17484](https://github.com/ClickHouse/ClickHouse/issues/17484) をクローズ。[#26128](https://github.com/ClickHouse/ClickHouse/pull/26128)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `merge_selecting_sleep_ms` 設定を追加。 [#26120](https://github.com/ClickHouse/ClickHouse/pull/26120) ([lthaooo](https://github.com/lthaooo)).
* Linux AIO の、1 ブロックのリードアヘッドを伴う複雑な使用をやめ、代わりに O&#95;DIRECT を用いたシンプルな同期 IO に置き換えました。以前のバージョンでは、`max_threads` が 1 より大きい場合、設定 `min_bytes_to_use_direct_io` が正しく動作しないことがありました。ダイレクト IO（クエリではデフォルトで無効、大きなマージではデフォルトで有効）での読み取りは、従来よりもやや効率の低い動作になります。これにより [#25997](https://github.com/ClickHouse/ClickHouse/issues/25997) がクローズされました。 [#26003](https://github.com/ClickHouse/ClickHouse/pull/26003) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `REPLACE TABLE` クエリで `Distributed` テーブルをフラッシュする。[#24566](https://github.com/ClickHouse/ClickHouse/issues/24566) を解決。新しいテーブルへの挿入が失敗した場合は、`[CREATE OR] REPLACE TABLE ... AS SELECT` クエリでテーブルの置き換え（または作成）を行わない。[#23175](https://github.com/ClickHouse/ClickHouse/issues/23175) を解決。[#25895](https://github.com/ClickHouse/ClickHouse/pull/25895)（[tavplubix](https://github.com/tavplubix)）。
* `views` カラムを system.query&#95;log に追加し、クエリによって実行された（マテリアライズドビューまたはライブビューの）名前を含めるようにしました。クエリの実行中に実行された各ビューに関する情報を含む新しいログテーブル（`system.query_views_log`）を追加しました。ビューの実行動作を変更しました。ビューの実行中に例外がスローされた場合、すでに開始されているビューは完了するまで実行を継続します。これは以前は parallel&#95;view&#95;processing=true のときの挙動でしたが、現在は常に同じ挙動になりました。- 依存ビューは、読み取り進行状況をコンテキストに報告するようになりました。 [#25714](https://github.com/ClickHouse/ClickHouse/pull/25714) ([Raúl Marín](https://github.com/Algunenano))。
* 分散クエリの実行完了後に、接続ドレインを非同期で行うようにしました。新しいサーバー設定 `max_threads_for_connection_collector` が追加され、バックグラウンドで接続を回収するワーカー数を指定できるようになりました。プールが満杯の場合、接続は同期的にドレインされますが、以前とは少し挙動が異なります。クライアントに EOS を送信した後にドレインが行われ、クエリは十分なデータを受信した時点で直ちに成功とみなされ、例外はクライアントにスローされる代わりにログに記録されます。`drain_timeout` 設定を追加しました（デフォルトは 3 秒）。接続ドレインは、このタイムアウトに達すると接続を切断します。 [#25674](https://github.com/ClickHouse/ClickHouse/pull/25674) ([Amos Bird](https://github.com/amosbird))。
* 設定ファイルで複数の include をサポート。ユーザー設定やリモートサーバー設定を複数のソースからインクルードできるようになりました。`from_zk`、`from_env`、または `incl` 属性を指定した `<include />` 要素を配置するだけで、対応する設定内容に展開されます。 [#24404](https://github.com/ClickHouse/ClickHouse/pull/24404) ([nvartolomei](https://github.com/nvartolomei)).
* `insert_distributed_one_random_shard = 1` を使用した分散テーブルへの複数ブロック挿入を修正しました。これはマイナーな機能であり、変更種別としては Improvement に分類されます。 [#23140](https://github.com/ClickHouse/ClickHouse/pull/23140) ([Amos Bird](https://github.com/amosbird))。
* `Map` 型のキーおよび値として `LowCardinality` と `FixedString` をサポート。 [#21543](https://github.com/ClickHouse/ClickHouse/pull/21543) ([hexiaoting](https://github.com/hexiaoting)).
* ローカルディスク設定の再読み込みを可能にしました。 [#19526](https://github.com/ClickHouse/ClickHouse/pull/19526) ([taiyang-li](https://github.com/taiyang-li)).

#### バグ修正 {#bug-fix-2}


* レプリカ間の不整合を引き起こす可能性のあるいくつかのバグを修正。 [#27808](https://github.com/ClickHouse/ClickHouse/pull/27808) ([tavplubix](https://github.com/tavplubix)).
* `DROP PART` において、`Unexpected merged part intersects drop range` というエラーを引き起こす可能性のある、まれなバグを修正しました。 [#27807](https://github.com/ClickHouse/ClickHouse/pull/27807) ([alesapin](https://github.com/alesapin)).
* Kafka から NULL（tombstone）メッセージが送られてきた場合に一部の形式でクラッシュする不具合を修正しました。[#19255](https://github.com/ClickHouse/ClickHouse/issues/19255) をクローズします。[#27794](https://github.com/ClickHouse/ClickHouse/pull/27794)（[filimonov](https://github.com/filimonov)）。
* サブクエリ内で `UNION DISTINCT` を使用した場合の列フィルタリングの不具合を修正。[#27578](https://github.com/ClickHouse/ClickHouse/issues/27578) をクローズ。 [#27689](https://github.com/ClickHouse/ClickHouse/pull/27689) ([Kseniia Sumarokova](https://github.com/kssenii))。
* `arrayHas` のような関数が、`DateTime` や `DateTime64` などの、異なる非数値型の `Nullable` な `LowCardinality` 型配列に適用された場合に発生する不正な型キャストを修正しました。以前のバージョンでは不正なキャストが行われていましたが、新しいバージョンでは例外がスローされます。これにより [#26330](https://github.com/ClickHouse/ClickHouse/issues/26330) が解決されました。 [#27682](https://github.com/ClickHouse/ClickHouse/pull/27682) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 閉じられない接続が発生していた `postgresql` テーブル関数を修正しました。 [#26088](https://github.com/ClickHouse/ClickHouse/issues/26088) をクローズします。 [#27662](https://github.com/ClickHouse/ClickHouse/pull/27662)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `Unexpected merged part ... intersecting drop range ...` エラーが発生していた別のケースを修正しました。 [#27656](https://github.com/ClickHouse/ClickHouse/pull/27656) ([tavplubix](https://github.com/tavplubix)).
* `Distributed` テーブルにおけるエイリアス列の不具合を修正。 [#27652](https://github.com/ClickHouse/ClickHouse/pull/27652) ([Vladimir C](https://github.com/vdimir))。
* `max_memory_usage*` を 0 以外の値に設定すると、再び 0（無制限）にリセットできない問題がありましたが、修正されました。 [#27638](https://github.com/ClickHouse/ClickHouse/pull/27638) ([tavplubix](https://github.com/tavplubix))。
* コンポーネントから時間値を構築する際に発生していたアンダーフローを修正しました。 [#27193](https://github.com/ClickHouse/ClickHouse/issues/27193) をクローズしました。 [#27605](https://github.com/ClickHouse/ClickHouse/pull/27605) ([Vasily Nemkov](https://github.com/Enmk))。
* 一部のパーツで列が欠損している場合に、projection のマテリアライズ中にクラッシュする問題を修正しました。これにより [#27512](https://github.com/ClickHouse/ClickHouse/issues/27512) が解決されます。[#27528](https://github.com/ClickHouse/ClickHouse/pull/27528)（[Amos Bird](https://github.com/amosbird)）。
* メトリクス `BackgroundMessageBrokerSchedulePoolTask` を修正（おそらくタイプミス）。 [#27452](https://github.com/ClickHouse/ClickHouse/pull/27452) ([Ben](https://github.com/benbiti)).
* シャード数がゼロの分散クエリにおける集約処理を修正。 [#27427](https://github.com/ClickHouse/ClickHouse/pull/27427) ([Azat Khuzhin](https://github.com/azat)).
* `/proc/meminfo` に KB 接尾辞が含まれない場合への対応。 [#27361](https://github.com/ClickHouse/ClickHouse/pull/27361) ([Mike Kot](https://github.com/myrrc))。
* 行レベルセキュリティ、PREWHERE、および LowCardinality フィルタを含むクエリで誤った結果が返される問題を修正。[#27179](https://github.com/ClickHouse/ClickHouse/issues/27179) を修正。[#27329](https://github.com/ClickHouse/ClickHouse/pull/27329)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 古い構文で作成された MergeTree テーブルに対するパーティション ID の不正な検証処理を修正しました。 [#27328](https://github.com/ClickHouse/ClickHouse/pull/27328) ([tavplubix](https://github.com/tavplubix)).
* 並列フォーマット（CSV / TSV）使用時の MySQL プロトコルを修正しました。 [#27326](https://github.com/ClickHouse/ClickHouse/pull/27326) ([Raúl Marín](https://github.com/Algunenano)).
* サンプリングを伴うクエリで発生する `Cannot find column` エラーを修正。[#24574](https://github.com/ClickHouse/ClickHouse/issues/24574) で導入された問題です。[#26522](https://github.com/ClickHouse/ClickHouse/issues/26522) を修正。[#27301](https://github.com/ClickHouse/ClickHouse/pull/27301)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `PREWHERE` 内で `LowCardinality` を使用する一部のクエリで発生していた `Expected ColumnLowCardinality, gotUInt8` や `Bad cast from type DB::ColumnVector<char8_t> to DB::ColumnLowCardinality` といったエラーを修正し、さらに重要な点として、エラーメッセージ内の空白がない問題も修正しました。[#23515](https://github.com/ClickHouse/ClickHouse/issues/23515)。[#27298](https://github.com/ClickHouse/ClickHouse/pull/27298)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `distributed_group_by_no_merge = 2` と `distributed_push_down_limit = 1`、または `optimize_distributed_group_by_sharding_key = 1` と `LIMIT BY` および `LIMIT OFFSET` の組み合わせに関する問題を修正しました。 [#27249](https://github.com/ClickHouse/ClickHouse/pull/27249) ([Azat Khuzhin](https://github.com/azat))。これらはほとんど使われていないマイナーな設定の組み合わせです。
* 非レプリケート MergeTree で不正なパーティション上にスタックしてしまうミューテーションを修正。 [#27248](https://github.com/ClickHouse/ClickHouse/pull/27248) ([Azat Khuzhin](https://github.com/azat)).
* 曖昧な場合、ラムダ関数は他のエイリアスや識別子ではなく、その引数を優先して解釈します。 [#27235](https://github.com/ClickHouse/ClickHouse/pull/27235) ([Raúl Marín](https://github.com/Algunenano))。
* `merge join` のカラム構造を修正し、[#27091](https://github.com/ClickHouse/ClickHouse/issues/27091) をクローズ。 [#27217](https://github.com/ClickHouse/ClickHouse/pull/27217) ([Vladimir C](https://github.com/vdimir)).
* まれに `system.detached_parts` テーブルが一部のパーツについて誤った情報を含む場合がありましたが、これを修正しました。 [#27114](https://github.com/ClickHouse/ClickHouse/issues/27114) を修正。 [#27183](https://github.com/ClickHouse/ClickHouse/pull/27183) ([tavplubix](https://github.com/tavplubix))。
* 空配列を渡した場合の `multiSearch*` 関数における未初期化メモリの不具合を修正し、[#27169](https://github.com/ClickHouse/ClickHouse/issues/27169) をクローズしました。[#27181](https://github.com/ClickHouse/ClickHouse/pull/27181)（[Vladimir C](https://github.com/vdimir)）。
* GRPCServer の同期の問題を修正。 この PR は [#27024](https://github.com/ClickHouse/ClickHouse/issues/27024) を修正します。 [#27064](https://github.com/ClickHouse/ClickHouse/pull/27064)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `cache`、`complex_key_cache`、`ssd_cache`、`complex_key_ssd_cache` の設定パース処理を修正しました。非 `cache` 型の辞書に対しては、オプション `allow_read_expired_keys`、`max_update_queue_size`、`update_queue_push_timeout_milliseconds`、`query_wait_timeout_milliseconds` がパースされていませんでした。[#27032](https://github.com/ClickHouse/ClickHouse/pull/27032) ([Maksim Kita](https://github.com/kitaisreal)).
* DROP&#95;RANGE とのレースコンディションにより発生し得る mutation スタックの問題を修正。 [#27002](https://github.com/ClickHouse/ClickHouse/pull/27002) ([Azat Khuzhin](https://github.com/azat)).
* `ALTER TABLE ... PARTITION ID xxx` のようなクエリ内のパーティション ID の妥当性が検証されるようになりました。 [#25718](https://github.com/ClickHouse/ClickHouse/issues/25718) を修正。 [#26963](https://github.com/ClickHouse/ClickHouse/pull/26963) ([alesapin](https://github.com/alesapin))。
* 一部のケースにおいて複数の JOIN を使用した際に発生する「Unknown column name」エラーを修正し、[#26899](https://github.com/ClickHouse/ClickHouse/issues/26899) をクローズ。[#26957](https://github.com/ClickHouse/ClickHouse/pull/26957)（[Vladimir C](https://github.com/vdimir)）。
* カスタム TLD の読み取り処理を修正（バッファサイズが小さい場合やファイルが大きい場合に処理が停止する問題を修正）。 [#26948](https://github.com/ClickHouse/ClickHouse/pull/26948) ([Azat Khuzhin](https://github.com/azat)).
* `DEFAULT` カラムが、`DEFAULT` 式を持たない他の非マテリアライズドカラムを参照している場合に発生するエラー `Missing columns: 'xxx'` を修正しました。[#26591](https://github.com/ClickHouse/ClickHouse/issues/26591) を修正。 [#26900](https://github.com/ClickHouse/ClickHouse/pull/26900)（[alesapin](https://github.com/alesapin)）。
* `library` 辞書ソース向けに `library-bridge` での辞書キーの読み込みを修正。 [#26834](https://github.com/ClickHouse/ClickHouse/pull/26834) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 一部のコンビネータを適用すると集約関数のパラメータが失われ、`Conversion from AggregateFunction(topKArray, Array(String)) to AggregateFunction(topKArray(10), Array(String)) is not supported` のような例外が発生する場合がありました。この問題は修正されています。[#26196](https://github.com/ClickHouse/ClickHouse/issues/26196) および [#26433](https://github.com/ClickHouse/ClickHouse/issues/26433) を修正しました。 [#26814](https://github.com/ClickHouse/ClickHouse/pull/26814) ([tavplubix](https://github.com/tavplubix))。
* `system.part_log` の `REMOVE_PART` に対して `event_time_microseconds` の値を追加しました。これまでは設定されていませんでした。 [#26720](https://github.com/ClickHouse/ClickHouse/pull/26720) ([Azat Khuzhin](https://github.com/azat))。
* ReplicatedMergeTree テーブルのシャットダウン時にデータを削除しないことで、データとメタデータの不整合が発生しないようにしました。 [#26716](https://github.com/ClickHouse/ClickHouse/pull/26716) ([nvartolomei](https://github.com/nvartolomei)).
* `SET ROLE` が正しく動作しない場合がある問題を、この PR で修正しました。[#26707](https://github.com/ClickHouse/ClickHouse/pull/26707) ([Vitaly Baranov](https://github.com/vitlibar))。
* 並列フォーマットに関するいくつかの修正（[https://github.com/ClickHouse/ClickHouse/issues/26694](https://github.com/ClickHouse/ClickHouse/issues/26694)）。[#26703](https://github.com/ClickHouse/ClickHouse/pull/26703)（[Raúl Marín](https://github.com/Algunenano)）。
* ウィンドウ関数内で起こりうる `nullptr` の逆参照を修正しました。これにより [#25276](https://github.com/ClickHouse/ClickHouse/issues/25276) が修正されました。 [#26668](https://github.com/ClickHouse/ClickHouse/pull/26668) ([Alexander Kuzmenkov](https://github.com/akuzm))。
* 約3年前の `clickhouse-client` バージョンで使用されていたフォーマットからアップグレードする際に、履歴ファイルが空の場合でも正しく変換できるよう修正しました。 [#26589](https://github.com/ClickHouse/ClickHouse/pull/26589) ([Azat Khuzhin](https://github.com/azat)).
* groupBitmapAnd/Or/Xor の関数名が一部の状況で誤って表示される問題を修正しました。 [#26557](https://github.com/ClickHouse/ClickHouse/pull/26557) ([Amos Bird](https://github.com/amosbird)).
* clickhouse-server の Docker エントリポイント内の `chown` コマンドのチェックを更新しました。これにより、Kubernetes 上でクラスター Pod の再起動が失敗したりタイムアウトしたりする不具合が修正されました。 [#26545](https://github.com/ClickHouse/ClickHouse/pull/26545) ([Ky Li](https://github.com/Kylinrix)).
* `RabbitMQ` のセットアップが開始されていない場合に、`RabbitMQ` のシャットダウン時にクラッシュする問題を修正しました。[#26504](https://github.com/ClickHouse/ClickHouse/issues/26504) をクローズ。[#26529](https://github.com/ClickHouse/ClickHouse/pull/26529)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 辞書名またはデータベース名が引用符で囲まれている場合の `CREATE DICTIONARY` クエリの不具合を修正しました。[#26491](https://github.com/ClickHouse/ClickHouse/issues/26491) をクローズしました。 [#26508](https://github.com/ClickHouse/ClickHouse/pull/26508)（[Maksim Kita](https://github.com/kitaisreal)）。
* 列エイリアスの書き換え後に列名の解決が壊れてしまう問題を修正しました。これにより [#26432](https://github.com/ClickHouse/ClickHouse/issues/26432) が修正されます。[#26475](https://github.com/ClickHouse/ClickHouse/pull/26475)（[Amos Bird](https://github.com/amosbird)）。
* いくつかの fuzz テストで検出された msan クラッシュを修正しました。 [#22517](https://github.com/ClickHouse/ClickHouse/issues/22517) を修正しました。 [#26428](https://github.com/ClickHouse/ClickHouse/pull/26428)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `partial_merge_join` のクローズ時に、非結合ブロックのストリームが無限に生成されてしまう問題を修正 [#26325](https://github.com/ClickHouse/ClickHouse/issues/26325)。[#26374](https://github.com/ClickHouse/ClickHouse/pull/26374)（[Vladimir C](https://github.com/vdimir)）。
* 削除されたユーザーでログインした際に発生し得るクラッシュを修正しました。このPRは [#26073](https://github.com/ClickHouse/ClickHouse/issues/26073) を修正します。 [#26363](https://github.com/ClickHouse/ClickHouse/pull/26363) ([Vitaly Baranov](https://github.com/vitlibar))。
* シャーディングキー式に複数カラムが含まれる場合の `optimize_distributed_group_by_sharding_key` を修正しました（`optimize_skip_unused_shards=1` / `allow_nondeterministic_optimize_skip_unused_shards=1` 設定時に誤った結果が生じていました）。[#26353](https://github.com/ClickHouse/ClickHouse/pull/26353)（[Azat Khuzhin](https://github.com/azat)）。
* 失われたレプリカの復旧処理において、レプリカ間に不整合が生じる可能性があったまれなバグを修正。 [#26321](https://github.com/ClickHouse/ClickHouse/pull/26321) ([tavplubix](https://github.com/tavplubix)).
* 内部バッファの末尾にエスケープシーケンスが存在する場合の zstd デコンプレッション（テーブルデータとは無関係な、zstd フレーミング形式でのインポート／エクスポート用）を修正。[#26013](https://github.com/ClickHouse/ClickHouse/issues/26013) をクローズ。[#26314](https://github.com/ClickHouse/ClickHouse/pull/26314)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `totals` 付きの `JOIN` における論理エラーを修正し、[#26017](https://github.com/ClickHouse/ClickHouse/issues/26017) をクローズ。[#26250](https://github.com/ClickHouse/ClickHouse/pull/26250) ([Vladimir C](https://github.com/vdimir))。
* `system.stack_trace` テーブルの `thread_name` 列に含まれていた不要な改行を削除しました。これにより [#24124](https://github.com/ClickHouse/ClickHouse/issues/24124) が修正されました。[#26210](https://github.com/ClickHouse/ClickHouse/pull/26210)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 複数の `untuple` 式を使用した場合にクラッシュする可能性がある問題を修正しました。 [#26179](https://github.com/ClickHouse/ClickHouse/pull/26179) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* Enum にゼロ値がない場合でも Nullable Enum の `toString` で例外を投げないようにし、[#25806](https://github.com/ClickHouse/ClickHouse/issues/25806) をクローズしました。[#26123](https://github.com/ClickHouse/ClickHouse/pull/26123)（[Vladimir C](https://github.com/vdimir)）。
* クエリ実行中に例外が発生した際に、ClickHouse が送信する MySQL プロトコルパケット内の `sequence_id` が誤っていた問題を修正しました。この不具合により、MySQL クライアントが ClickHouse サーバーへの接続をリセットしてしまう可能性がありました。[#21184](https://github.com/ClickHouse/ClickHouse/issues/21184) を修正しました。[#26051](https://github.com/ClickHouse/ClickHouse/pull/26051)（[tavplubix](https://github.com/tavplubix)）。
* `cutToFirstSignificantSubdomainCustom()` / `cutToFirstSignificantSubdomainCustomWithWWW()` / `firstSignificantSubdomainCustom()` が定数に対して誤った型を返し、その結果 `optimize_skip_unused_shards` が動作しない問題を修正。 [#26041](https://github.com/ClickHouse/ClickHouse/pull/26041) ([Azat Khuzhin](https://github.com/azat)).
* `prewhere` を使用した通常のプロジェクションで発生する可能性のあったヘッダーの不整合を修正しました。これにより [#26020](https://github.com/ClickHouse/ClickHouse/issues/26020) が修正されます。[#26038](https://github.com/ClickHouse/ClickHouse/pull/26038)（[Amos Bird](https://github.com/amosbird)）。
* remote() における関数なしのカラムからの sharding&#95;key の扱いを修正（以前は `select * from remote('127.1', system.one, dummy)` によって `Unknown column: dummy, there are only columns .` エラーが発生していた）。 [#25824](https://github.com/ClickHouse/ClickHouse/pull/25824) ([Azat Khuzhin](https://github.com/azat)).
* `MaterializeMySQL` からの `SELECT` クエリ実行時に発生していた `Not found column ...` および `Missing column ...` エラーを修正しました。[#23708](https://github.com/ClickHouse/ClickHouse/issues/23708)、[#24830](https://github.com/ClickHouse/ClickHouse/issues/24830)、[#25794](https://github.com/ClickHouse/ClickHouse/issues/25794) を修正。[#25822](https://github.com/ClickHouse/ClickHouse/pull/25822)（[tavplubix](https://github.com/tavplubix)）。
* `UInt64` 以外の型に対する `optimize_skip_unused_shards_rewrite_in` を修正（最終的に誤ったシャードが選択されたり、`Cannot infer type of an empty tuple` または `Function tuple requires at least one argument` がスローされたりする可能性があった問題を解消）。 [#25798](https://github.com/ClickHouse/ClickHouse/pull/25798) ([Azat Khuzhin](https://github.com/azat)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-3}

- ステートフルおよびステートレステストをランダムなタイムゾーンで実行するようになりました。修正 [#12439](https://github.com/ClickHouse/ClickHouse/issues/12439)。Protobuf形式でStringをDateTimeとして読み取り、DateTimeをStringとして書き込む際にタイムゾーンが考慮されるようになりました。ArrowおよびParquet形式でUInt16をDateTimeとして読み取る際、DateがArrowおよびParquetではUInt16としてシリアライズされるため、まずDateとして扱った後、DateTimeのタイムゾーンを考慮してDateTimeに変換されるようになりました。GraphiteMergeTreeが時刻の丸め処理でタイムゾーンを考慮するようになりました。修正 [#5098](https://github.com/ClickHouse/ClickHouse/issues/5098)。作成者: @alexey-milovidov。[#15408](https://github.com/ClickHouse/ClickHouse/pull/15408) ([alesapin](https://github.com/alesapin))。
- `clickhouse-test`が[Jinja2](https://jinja.palletsprojects.com/en/3.0.x/templates/#synopsis)テンプレートを使用したSQLテストをサポートするようになりました。[#26579](https://github.com/ClickHouse/ClickHouse/pull/26579) ([Vladimir C](https://github.com/vdimir))。
- `clang-13`でのビルドのサポートを追加しました。これにより [#27705](https://github.com/ClickHouse/ClickHouse/issues/27705) が解決されます。[#27714](https://github.com/ClickHouse/ClickHouse/pull/27714) ([alexey-milovidov](https://github.com/alexey-milovidov))。[#27777](https://github.com/ClickHouse/ClickHouse/pull/27777) ([Sergei Semin](https://github.com/syominsergey))
- 特定のCPU命令セットを使用する/しないでビルドするためのCMakeオプションを追加しました。これは [#17469](https://github.com/ClickHouse/ClickHouse/issues/17469) および [#27509](https://github.com/ClickHouse/ClickHouse/issues/27509) に対応するものです。[#27508](https://github.com/ClickHouse/ClickHouse/pull/27508) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 動的ライブラリ使用時の補助プログラムのリンクを修正しました。[#26958](https://github.com/ClickHouse/ClickHouse/pull/26958) ([Raúl Marín](https://github.com/Algunenano))。
- RocksDBを`2021-07-16` masterに更新しました。[#26411](https://github.com/ClickHouse/ClickHouse/pull/26411) ([alexey-milovidov](https://github.com/alexey-milovidov))。

### ClickHouseリリース v21.8, 2021-08-12 {#clickhouse-release-v218-2021-08-12}

#### アップグレード時の注意事項 {#upgrade-notes}

- 新バージョンでは、システムログテーブル（`system.query_log`、`system.query_thread_log`、`system.processes`、`system.opentelemetry_span_log`）に`Map`データ型を使用しています。これらのテーブルは新しいデータ型で自動作成されます。古いクエリをサポートするために仮想カラムが作成されます。[#18698](https://github.com/ClickHouse/ClickHouse/issues/18698) を解決します。[#23934](https://github.com/ClickHouse/ClickHouse/pull/23934)、[#25773](https://github.com/ClickHouse/ClickHouse/pull/25773) ([hexiaoting](https://github.com/hexiaoting)、[sundy-li](https://github.com/sundy-li)、[Maksim Kita](https://github.com/kitaisreal))。バージョン21.8から古いバージョンに_ダウングレード_する場合は、ログを含むシステムテーブルを手動でクリーンアップする必要があります。`/var/lib/clickhouse/data/system/*_log`を確認してください。

#### 新機能 {#new-features}


- SQL/JSON標準の一部のサポートを追加しました。[#24148](https://github.com/ClickHouse/ClickHouse/pull/24148) ([l1tsolaiki](https://github.com/l1tsolaiki), [Kseniia Sumarokova](https://github.com/kssenii))。
- 一般的なシステムメトリクス(`system.asynchronous_metrics`および`system.asynchronous_metric_log`内)の収集を追加しました。対象はCPU使用率、ディスク使用率、メモリ使用率、IO、ネットワーク、ファイル、ロードアベレージ、CPU周波数、温度センサー、EDACカウンター、システム稼働時間です。また、スケジューリングジッターとメトリクス収集に費やされた時間に関するメトリクスも追加されました。これはClickHouseにおける`atop`と同様に動作し、追加のツールがインストールされていない場合でも監視データへのアクセスを可能にします。[#9430](https://github.com/ClickHouse/ClickHouse/issues/9430)をクローズ。[#24416](https://github.com/ClickHouse/ClickHouse/pull/24416) ([alexey-milovidov](https://github.com/alexey-milovidov), [Yegor Levankov](https://github.com/elevankoff))。
- MaterializedPostgreSQLテーブルエンジンとデータベースエンジンを追加しました。このデータベースエンジンは、データベース全体またはデータベーステーブルの任意のサブセットのレプリケーションを可能にします。[#20470](https://github.com/ClickHouse/ClickHouse/pull/20470) ([Kseniia Sumarokova](https://github.com/kssenii))。
- 新しい関数`leftPad()`、`rightPad()`、`leftPadUTF8()`、`rightPadUTF8()`を追加しました。[#26075](https://github.com/ClickHouse/ClickHouse/pull/26075) ([Vitaly Baranov](https://github.com/vitlibar))。
- `ADD INDEX`コマンドに`FIRST`キーワードを追加し、インデックスリストの先頭にインデックスを追加できるようにしました。[#25904](https://github.com/ClickHouse/ClickHouse/pull/25904) ([xjewer](https://github.com/xjewer))。
- 既存のデータスキッピングインデックスに関する情報を含む`system.data_skipping_indices`テーブルを導入しました。[#7659](https://github.com/ClickHouse/ClickHouse/issues/7659)をクローズ。[#25693](https://github.com/ClickHouse/ClickHouse/pull/25693) ([Dmitry Novik](https://github.com/novikd))。
- `bin`/`unbin`関数を追加しました。[#25609](https://github.com/ClickHouse/ClickHouse/pull/25609) ([zhaoyu](https://github.com/zxc111))。
- `mapAdd`および`mapSubtract`関数で`Map`と`UInt128`、`Int128`、`UInt256`、`Int256`型をサポートしました。[#25596](https://github.com/ClickHouse/ClickHouse/pull/25596) ([Ildus Kurbangaliev](https://github.com/ildus))。
- `DISTINCT ON (columns)`式をサポートしました。[#25404](https://github.com/ClickHouse/ClickHouse/issues/25404)をクローズ。[#25589](https://github.com/ClickHouse/ClickHouse/pull/25589) ([Zijie Lu](https://github.com/TszKitLo40))。
- カスタム設定をデフォルトにリセットし、テーブルのメタデータから削除する機能を追加しました。これにより、システム/設定のデフォルト値を知らなくても変更をロールバックできます。[#14449](https://github.com/ClickHouse/ClickHouse/issues/14449)をクローズ。[#17769](https://github.com/ClickHouse/ClickHouse/pull/17769) ([xjewer](https://github.com/xjewer))。
- `EXPLAIN PIPELINE graph = 1`クエリが送信された場合、Web UIでパイプラインをグラフとして表示します。[#26067](https://github.com/ClickHouse/ClickHouse/pull/26067) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### パフォーマンスの改善 {#performance-improvements}

- 集約関数のコンパイルを追加しました。有効にするには`compile_aggregate_expressions`オプションを使用してください。[#24789](https://github.com/ClickHouse/ClickHouse/pull/24789) ([Maksim Kita](https://github.com/kitaisreal))。
- 多数の列を持つテーブルからの読み取りを必要とする短いクエリのレイテンシを改善しました。[#26371](https://github.com/ClickHouse/ClickHouse/pull/26371) ([Anton Popov](https://github.com/CurtizJ))。

#### 改善 {#improvements}


* システムログテーブル（`system.query_log`、`system.query_thread_log`、`system.processes`、`system.opentelemetry_span_log`）に `Map` データ型を使用するようにしました。これらのテーブルは新しいデータ型で自動作成され、古いクエリをサポートするための仮想カラムも作成されます。[#18698](https://github.com/ClickHouse/ClickHouse/issues/18698) をクローズしました。[#23934](https://github.com/ClickHouse/ClickHouse/pull/23934)、[#25773](https://github.com/ClickHouse/ClickHouse/pull/25773)（[hexiaoting](https://github.com/hexiaoting)、[sundy-li](https://github.com/sundy-li)、[Maksim Kita](https://github.com/kitaisreal)）。
* 複合キーを持つ辞書で、キーが 1 つの属性のみを含む場合、`dictGet` および `dictHas` 関数ではキー式を `tuple` でラップする必要がなくなりました。 [#26130](https://github.com/ClickHouse/ClickHouse/pull/26130)（[Maksim Kita](https://github.com/kitaisreal)）。
* `AggregateFunction` の状態に対して関数 `bin` / `hex` を実装しました。 [#26094](https://github.com/ClickHouse/ClickHouse/pull/26094)（[zhaoyu](https://github.com/zxc111)）。
* `empty` および `notEmpty` 関数で `UUID` 型の引数をサポートします。`UUID` は、すべてがゼロ（nil UUID）の場合に空と見なされます。[#3446](https://github.com/ClickHouse/ClickHouse/issues/3446) をクローズ。 [#25974](https://github.com/ClickHouse/ClickHouse/pull/25974)（[zhaoyu](https://github.com/zxc111)）。
* MySQL プロトコルで `SET SQL_SELECT_LIMIT` をサポートしました。[#17115](https://github.com/ClickHouse/ClickHouse/issues/17115) をクローズ。[#25972](https://github.com/ClickHouse/ClickHouse/pull/25972)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* ネットワーク通信向けのインストルメンテーションを強化：recv/send バイト数のカウンターを追加し、recv/send のゲージを追加しました。欠落していたドキュメントを追加しました。[#5897](https://github.com/ClickHouse/ClickHouse/issues/5897) をクローズ。[#25962](https://github.com/ClickHouse/ClickHouse/pull/25962)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 設定 `optimize_move_to_prewhere_if_final` を追加しました。クエリに `FINAL` が含まれている場合、`move_to_prewhere` 最適化は `optimize_move_to_prewhere` と `optimize_move_to_prewhere_if_final` の両方が有効なときにのみ有効になります。 [#8684](https://github.com/ClickHouse/ClickHouse/issues/8684) をクローズしました。 [#25940](https://github.com/ClickHouse/ClickHouse/pull/25940) ([Kseniia Sumarokova](https://github.com/kssenii))。
* JOIN されたテーブルの複雑な引用符付き識別子を許可。 [#17861](https://github.com/ClickHouse/ClickHouse/issues/17861) をクローズ。 [#25924](https://github.com/ClickHouse/ClickHouse/pull/25924)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `Nested` データ型内の Unicode 文字（例: 中国語、キリル文字）コンポーネントをサポートする機能を追加しました。 [#25594](https://github.com/ClickHouse/ClickHouse/issues/25594) をクローズしました。 [#25923](https://github.com/ClickHouse/ClickHouse/pull/25923)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `quantiles*` 関数が `aggregate_functions_null_for_empty` とともに動作するようにしました。 [#25892](https://github.com/ClickHouse/ClickHouse/issues/25892) をクローズ。 [#25919](https://github.com/ClickHouse/ClickHouse/pull/25919)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* パラメトリック集約関数のパラメータとして、リテラルだけでなく任意の定数式（例: `1 + 2`）を使用できるようにします。また、パラメータ化クエリ（`{param:UInt8}` のような）内のクエリパラメータを、パラメトリック集約関数のパラメータとして使用することも可能にします。これにより [#11607](https://github.com/ClickHouse/ClickHouse/issues/11607) が解決されます。[#25910](https://github.com/ClickHouse/ClickHouse/pull/25910)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 不正な `Date` の解析を試みた場合に、正しく例外をスローするようにしました。[#6481](https://github.com/ClickHouse/ClickHouse/issues/6481) をクローズします。[#25909](https://github.com/ClickHouse/ClickHouse/pull/25909)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 設定ファイルで複数の include をサポート。ユーザー設定やリモートサーバー設定を複数のソースから読み込むことができます。`from_zk`、`from_env`、または `incl` 属性を持つ `<include />` 要素を記述するだけで、その部分が対応する内容に置き換えられます。 [#24404](https://github.com/ClickHouse/ClickHouse/pull/24404) ([nvartolomei](https://github.com/nvartolomei)).
* `"null"` という名前のカラム（バッククォートまたは二重引用符で指定する必要があります）および `ON CLUSTER` を含むクエリをサポート。[#24035](https://github.com/ClickHouse/ClickHouse/issues/24035) をクローズ。[#25907](https://github.com/ClickHouse/ClickHouse/pull/25907)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `JSONExtract` で `LowCardinality`、`Decimal`、`UUID` をサポートしました。 [#24606](https://github.com/ClickHouse/ClickHouse/issues/24606) をクローズしました。 [#25900](https://github.com/ClickHouse/ClickHouse/pull/25900)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `readline` 形式の履歴ファイルを `replxx` 形式に変換。[#25888](https://github.com/ClickHouse/ClickHouse/pull/25888) ([Azat Khuzhin](https://github.com/azat)).
* `DROP PART` の実行後、または空のパートをバックグラウンドで削除した後に、パート同士が重なり合ってしまう可能性がある問題を修正しました。 [#25884](https://github.com/ClickHouse/ClickHouse/pull/25884) ([alesapin](https://github.com/alesapin))。
* `ReplicatedMergeTree` テーブルにおける失われたパーツの処理を改善し、`ReplicationQueue` におけるまれな不整合を修正。[#10368](https://github.com/ClickHouse/ClickHouse/issues/10368) を修正。[#25820](https://github.com/ClickHouse/ClickHouse/pull/25820) ([alesapin](https://github.com/alesapin)).
* 読み取りできない作業ディレクトリでも clickhouse-client を起動できるようにしました。 [#25817](https://github.com/ClickHouse/ClickHouse/pull/25817) ([ianton-ru](https://github.com/ianton-ru))。
* `Merge` ストレージで発生する「No available columns」エラーを修正。[#25801](https://github.com/ClickHouse/ClickHouse/pull/25801) ([Azat Khuzhin](https://github.com/azat))。
* MySQL エンジンで、MySQL と ClickHouse 間で列コメントを相互に交換できるようになりました。 [#25795](https://github.com/ClickHouse/ClickHouse/pull/25795) ([Storozhuk Kostiantyn](https://github.com/sand6255))。
* 空集合に対する `GROUP BY` 定数の一貫性のない動作を修正。 [#6842](https://github.com/ClickHouse/ClickHouse/issues/6842) をクローズ。 [#25786](https://github.com/ClickHouse/ClickHouse/pull/25786) ([Kseniia Sumarokova](https://github.com/kssenii))。
* `ReplicatedMergeTree` において、パーティションに対する `DROP PARTITION` および `TRUNCATE` 実行時に、すでに実行中のパーティション内のマージ処理をキャンセルするようにしました。 [#17151](https://github.com/ClickHouse/ClickHouse/issues/17151) を解決します。 [#25684](https://github.com/ClickHouse/ClickHouse/pull/25684) ([tavplubix](https://github.com/tavplubix))。
* MaterializeMySQL で `ENUM` データ型をサポート。 [#25676](https://github.com/ClickHouse/ClickHouse/pull/25676) ([Storozhuk Kostiantyn](https://github.com/sand6255)).
* JOIN でのマテリアライズドカラムおよびエイリアスカラムのサポートを追加し、[#13274](https://github.com/ClickHouse/ClickHouse/issues/13274) をクローズ。[#25634](https://github.com/ClickHouse/ClickHouse/pull/25634)（[Vladimir C](https://github.com/vdimir)）。
* `ALTER TABLE ... DETACH` とバックグラウンドマージの間で発生し得る論理的なレースコンディションを修正。 [#25605](https://github.com/ClickHouse/ClickHouse/pull/25605) ([Azat Khuzhin](https://github.com/azat)).
* `NetworkReceiveElapsedMicroseconds` メトリクスに、クライアントからの `INSERT` 用データの受信待ちに要した時間が正しく含まれるように修正。 [#9958](https://github.com/ClickHouse/ClickHouse/issues/9958) をクローズ。 [#25602](https://github.com/ClickHouse/ClickHouse/pull/25602)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* S3 および HDFS で `TRUNCATE TABLE` をサポートしました。[#25530](https://github.com/ClickHouse/ClickHouse/issues/25530) をクローズ。[#25550](https://github.com/ClickHouse/ClickHouse/pull/25550)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* バックグラウンドジョブ（マージ、ミューテーション、フェッチ）の実行プールのスレッド数を変更するための設定の動的リロードに対応。 [#25548](https://github.com/ClickHouse/ClickHouse/pull/25548) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* `JSONExtract` を使用して、非文字列要素を文字列として抽出できるようにしました。これは [#25414](https://github.com/ClickHouse/ClickHouse/issues/25414) への対応です。[#25452](https://github.com/ClickHouse/ClickHouse/pull/25452)（[Amos Bird](https://github.com/amosbird)）。
* `StorageMerge` の `Database` 引数で正規表現をサポートするようにしました。 [#776](https://github.com/ClickHouse/ClickHouse/issues/776) をクローズ。 [#25064](https://github.com/ClickHouse/ClickHouse/pull/25064)（[flynn](https://github.com/ucasfl)）。
* Web UI: 値が URL のように見える場合、自動的にリンクを生成するようになりました。 [#25965](https://github.com/ClickHouse/ClickHouse/pull/25965) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `systemd` を使用する CentOS 8 のようなシステムで `sudo service clickhouse-server start` が動作するようにしました。 [#14298](https://github.com/ClickHouse/ClickHouse/issues/14298) をクローズしました。 [#17799](https://github.com/ClickHouse/ClickHouse/issues/17799) をクローズしました。 [#25921](https://github.com/ClickHouse/ClickHouse/pull/25921)（[alexey-milovidov](https://github.com/alexey-milovidov)）。

#### バグ修正 {#bug-fixes-1}


* 一部のケースで誤っていた `SET ROLE` を修正しました。 [#26707](https://github.com/ClickHouse/ClickHouse/pull/26707) ([Vitaly Baranov](https://github.com/vitlibar))。
* ウィンドウ関数における `nullptr` 参照が発生する可能性を修正。[#25276](https://github.com/ClickHouse/ClickHouse/issues/25276) を修正。[#26668](https://github.com/ClickHouse/ClickHouse/pull/26668)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* `groupBitmapAnd/Or/Xor` の関数名の誤りを修正。[#26557](https://github.com/ClickHouse/ClickHouse/pull/26557)（[Amos Bird](https://github.com/amosbird)）。
* RabbitMQ のセットアップが開始されていない場合の RabbitMQ シャットダウン時に発生していたクラッシュを修正。 [#26504](https://github.com/ClickHouse/ClickHouse/issues/26504) をクローズ。 [#26529](https://github.com/ClickHouse/ClickHouse/pull/26529) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 辞書名またはデータベース名がクオートされている場合の `CREATE DICTIONARY` クエリで発生していた問題を修正しました。 [#26491](https://github.com/ClickHouse/ClickHouse/issues/26491) をクローズ。 [#26508](https://github.com/ClickHouse/ClickHouse/pull/26508)（[Maksim Kita](https://github.com/kitaisreal)）。
* カラムエイリアスを書き換えた後に壊れていた名前解決を修正。[#26432](https://github.com/ClickHouse/ClickHouse/issues/26432) を修正。[#26475](https://github.com/ClickHouse/ClickHouse/pull/26475)（[Amos Bird](https://github.com/amosbird)）。
* `partial_merge_join` のクローズ時に結合されないブロックストリームが無限に続く問題を修正 [#26325](https://github.com/ClickHouse/ClickHouse/issues/26325)。[#26374](https://github.com/ClickHouse/ClickHouse/pull/26374)（[Vladimir C](https://github.com/vdimir)）。
* 削除されたユーザーとしてログインした場合にクラッシュが発生する可能性のある問題を修正。[#26073](https://github.com/ClickHouse/ClickHouse/issues/26073) を解決。[#26363](https://github.com/ClickHouse/ClickHouse/pull/26363)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `optimize_distributed_group_by_sharding_key` が複数カラムを扱う場合の動作を修正しました（`optimize_skip_unused_shards=1` および `allow_nondeterministic_optimize_skip_unused_shards=1` が有効で、シャーディングキー式に複数カラムを含む場合に誤った結果が返される問題）。 [#26353](https://github.com/ClickHouse/ClickHouse/pull/26353) ([Azat Khuzhin](https://github.com/azat)).
* `Date` から `DateTime`（または `DateTime64`）への `CAST` が、`DateTime` 型のタイムゾーンを使用していませんでした。これは `Date` と `DateTime` の比較にも影響する可能性があります。`Date` と `DateTime` の共通型の推論も、対応するタイムゾーンを使用していませんでした。その結果、関数 `if` の結果や配列の構築結果に影響していました。[#24128](https://github.com/ClickHouse/ClickHouse/issues/24128) をクローズしました。[#24129](https://github.com/ClickHouse/ClickHouse/pull/24129)（[Maksim Kita](https://github.com/kitaisreal)）。
* 失われたレプリカの復旧処理において、レプリカ間に不整合が生じる可能性のあるまれなバグを修正しました。 [#26321](https://github.com/ClickHouse/ClickHouse/pull/26321) ([tavplubix](https://github.com/tavplubix)).
* 内部バッファの末尾にエスケープシーケンスが含まれている場合の zstd デコンプレッションを修正。 [#26013](https://github.com/ClickHouse/ClickHouse/issues/26013) をクローズ。 [#26314](https://github.com/ClickHouse/ClickHouse/pull/26314)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `totals` との `JOIN` 時の論理エラーを修正し、[#26017](https://github.com/ClickHouse/ClickHouse/issues/26017) をクローズ。[#26250](https://github.com/ClickHouse/ClickHouse/pull/26250) ([Vladimir C](https://github.com/vdimir))。
* `system.stack_trace` テーブルの `thread_name` 列における不要な改行を削除しました。[#24124](https://github.com/ClickHouse/ClickHouse/issues/24124) を修正しました。[#26210](https://github.com/ClickHouse/ClickHouse/pull/26210)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `LowCarinality` 列における `joinGet` を修正し、[#25993](https://github.com/ClickHouse/ClickHouse/issues/25993) をクローズ。[#26118](https://github.com/ClickHouse/ClickHouse/pull/26118)（[Vladimir C](https://github.com/vdimir)）。
* 設定 `validate_polygons` をオフにした場合に `pointInPolygon` がクラッシュする可能性のある問題を修正。 [#26113](https://github.com/ClickHouse/ClickHouse/pull/26113) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 存在しないリモートディレクトリをイテレートした際に例外がスローされる問題を修正。 [#26087](https://github.com/ClickHouse/ClickHouse/pull/26087) ([ianton-ru](https://github.com/ianton-ru)).
* ZooKeeper クライアントで発生する `abort` に起因する、まれなサーバークラッシュを修正しました。[#25813](https://github.com/ClickHouse/ClickHouse/issues/25813) を修正します。[#26079](https://github.com/ClickHouse/ClickHouse/pull/26079)（[alesapin](https://github.com/alesapin)）。
* 一部のケースで、右側サブクエリ `JOIN` におけるスレッド数の推定誤りを修正しました。[#24075](https://github.com/ClickHouse/ClickHouse/issues/24075) をクローズ。[#26052](https://github.com/ClickHouse/ClickHouse/pull/26052)（[Vladimir C](https://github.com/vdimir)）。
* クエリ実行中に例外が発生した際、ClickHouse が送信する MySQL プロトコルパケット内の誤った `sequence_id` を修正しました。この不具合により、MySQL クライアントが ClickHouse サーバーへの接続をリセットしてしまう可能性がありました。[#21184](https://github.com/ClickHouse/ClickHouse/issues/21184) を修正。[#26051](https://github.com/ClickHouse/ClickHouse/pull/26051)（[tavplubix](https://github.com/tavplubix)）。
* `PREWHERE` を用いる通常プロジェクションで発生しうるヘッダーの不整合を修正。[#26020](https://github.com/ClickHouse/ClickHouse/issues/26020) を解決。[#26038](https://github.com/ClickHouse/ClickHouse/pull/26038)（[Amos Bird](https://github.com/amosbird)）。
* 整数キーを持つ `Map` 型の `JSON` 形式へのフォーマットを修正。 [#25982](https://github.com/ClickHouse/ClickHouse/pull/25982) ([Anton Popov](https://github.com/CurtizJ)).
* クエリプロファイラのスタックアンワインド中に発生する可能性のあるデッドロックを修正。[#25968](https://github.com/ClickHouse/ClickHouse/issues/25968) を修正。[#25970](https://github.com/ClickHouse/ClickHouse/pull/25970)（[Maksim Kita](https://github.com/kitaisreal)）。
* 不正な引数で `dictGet()` を呼び出すとクラッシュする問題を修正。 [#25913](https://github.com/ClickHouse/ClickHouse/pull/25913) ([Vitaly Baranov](https://github.com/vitlibar)).
* PostgreSQL エンジン向けの `scram-sha-256` 認証を修正しました。[#24516](https://github.com/ClickHouse/ClickHouse/issues/24516) をクローズしました。 [#25906](https://github.com/ClickHouse/ClickHouse/pull/25906)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* バックグラウンドプールが満杯のときにバックグラウンドタスクで発生する極端に長いバックオフ時間を修正。[#25836](https://github.com/ClickHouse/ClickHouse/issues/25836) を解決。[#25893](https://github.com/ClickHouse/ClickHouse/pull/25893)（[alesapin](https://github.com/alesapin)）。
* デフォルト以外のページサイズを使用している場合の ARM の例外処理を修正。[#25512](https://github.com/ClickHouse/ClickHouse/issues/25512)、[#25044](https://github.com/ClickHouse/ClickHouse/issues/25044)、[#24901](https://github.com/ClickHouse/ClickHouse/issues/24901)、[#23183](https://github.com/ClickHouse/ClickHouse/issues/23183)、[#20221](https://github.com/ClickHouse/ClickHouse/issues/20221)、[#19703](https://github.com/ClickHouse/ClickHouse/issues/19703)、[#19028](https://github.com/ClickHouse/ClickHouse/issues/19028)、[#18391](https://github.com/ClickHouse/ClickHouse/issues/18391)、[#18121](https://github.com/ClickHouse/ClickHouse/issues/18121)、[#17994](https://github.com/ClickHouse/ClickHouse/issues/17994)、[#12483](https://github.com/ClickHouse/ClickHouse/issues/12483) を修正。[#25854](https://github.com/ClickHouse/ClickHouse/pull/25854)（[Maksim Kita](https://github.com/kitaisreal)）。
* `remote()` 向けの、関数を使用しないカラムによる sharding&#95;key を修正しました（以前は `select * from remote('127.1', system.one, dummy)` が `Unknown column: dummy, there are only columns .` エラーを引き起こしていました）。 [#25824](https://github.com/ClickHouse/ClickHouse/pull/25824) ([Azat Khuzhin](https://github.com/azat)).
* `MaterializeMySQL` からの `SELECT` 時に発生していた `Not found column ...` および `Missing column ...` エラーを修正しました。[#23708](https://github.com/ClickHouse/ClickHouse/issues/23708)、[#24830](https://github.com/ClickHouse/ClickHouse/issues/24830)、[#25794](https://github.com/ClickHouse/ClickHouse/issues/25794) を解決しました。[#25822](https://github.com/ClickHouse/ClickHouse/pull/25822)（[tavplubix](https://github.com/tavplubix)）。
* 非 UInt64 型に対する `optimize_skip_unused_shards_rewrite_in` を修正（最終的に誤ったシャードが選択されたり、`Cannot infer type of an empty tuple` や `Function tuple requires at least one argument` をスローしたりする可能性があった問題を修正）。 [#25798](https://github.com/ClickHouse/ClickHouse/pull/25798) ([Azat Khuzhin](https://github.com/azat)).
* `ReplicatedMergeTree` テーブルに対する `DROP PART` クエリで発生し、`Unexpected merged part intersecting drop range` というエラーメッセージにつながる可能性があるまれなバグを修正しました。 [#25783](https://github.com/ClickHouse/ClickHouse/pull/25783) ([alesapin](https://github.com/alesapin)).
* `GROUP BY` 式を含む `TTL` において、パーツ内で最初に実行された後、そのパーツで以降 `TTL` が実行されなくなる不具合を修正。 [#25743](https://github.com/ClickHouse/ClickHouse/pull/25743) ([alesapin](https://github.com/alesapin)).
* StorageMerge がエイリアスを持つテーブルにもアクセスできるようにしました。これにより [#6051](https://github.com/ClickHouse/ClickHouse/issues/6051) がクローズされます。 [#25694](https://github.com/ClickHouse/ClickHouse/pull/25694) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 一部のケースにおける dict join の低速化を修正し、[#24209](https://github.com/ClickHouse/ClickHouse/issues/24209) をクローズ。[#25618](https://github.com/ClickHouse/ClickHouse/pull/25618)（[Vladimir C](https://github.com/vdimir)）。
* TTL 式に含まれるカラムに対する `ALTER MODIFY COLUMN` の動作を修正しました。 [#25554](https://github.com/ClickHouse/ClickHouse/pull/25554) ([Anton Popov](https://github.com/CurtizJ))。
* `UInt8` 以外の型を使用した `PREWHERE` におけるアサーションを修正し、[#19589](https://github.com/ClickHouse/ClickHouse/issues/19589) をクローズ。[#25484](https://github.com/ClickHouse/ClickHouse/pull/25484)（[Vladimir C](https://github.com/vdimir)）。
* ファジングで発見された msan 関連のクラッシュをいくつか修正。[#22517](https://github.com/ClickHouse/ClickHouse/issues/22517) を解決。[#26428](https://github.com/ClickHouse/ClickHouse/pull/26428)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `clickhouse-server` の Docker エントリポイントにおける `chown` コマンドのチェックを更新し、Kubernetes 上で発生するエラー &#39;cluster pod restart failed (or timeout)&#39; を解消します。 [#26545](https://github.com/ClickHouse/ClickHouse/pull/26545) ([Ky Li](https://github.com/Kylinrix)).

### ClickHouse リリース v21.7, 2021-07-09 {#clickhouse-release-v217-2021-07-09}

#### 後方互換性のない変更 {#backward-incompatible-change-4}

- 明示的に定義された大規模なセットを使用するクエリのパフォーマンスが向上しました。互換性設定 `legacy_column_name_of_tuple_literal` が追加されました。バージョン21.7未満から21.7以降のバージョンへクラスタのローリングアップデートを実行する際は、この設定を `true` にすることを推奨します。そうしない場合、`IN` 句で明示的に定義されたセットを使用する分散クエリがアップデート中に失敗する可能性があります。[#25371](https://github.com/ClickHouse/ClickHouse/pull/25371) ([Anton Popov](https://github.com/CurtizJ))。
- clickhouse-keeper(ZooKeeperの実験的な代替)における最大バッファサイズの前方/後方互換性のない変更。本番環境への導入前である今実施する方が、後で実施するよりも望ましいです。[#25421](https://github.com/ClickHouse/ClickHouse/pull/25421) ([alesapin](https://github.com/alesapin))。

#### 新機能 {#new-feature-4}


- XMLの代替としてYAML形式での設定をサポート。これにより [#3607](https://github.com/ClickHouse/ClickHouse/issues/3607) を解決。[#21858](https://github.com/ClickHouse/ClickHouse/pull/21858) ([BoloniniD](https://github.com/BoloniniD))。
- データが（おそらく）存在するがZooKeeperメタデータが失われた場合に、レプリケートされたテーブルを復元する方法を提供。[#13458](https://github.com/ClickHouse/ClickHouse/issues/13458) を解決。[#13652](https://github.com/ClickHouse/ClickHouse/pull/13652) ([Mike Kot](https://github.com/myrrc))。
- Arrow/Parquet/ORCにおける構造体とマップ、およびArrow入出力形式における辞書をサポート。新しい設定`output_format_arrow_low_cardinality_as_dictionary`を導入。[#24341](https://github.com/ClickHouse/ClickHouse/pull/24341) ([Kruglov Pavel](https://github.com/Avogar))。
- 辞書における`Array`型のサポートを追加。[#25119](https://github.com/ClickHouse/ClickHouse/pull/25119) ([Maksim Kita](https://github.com/kitaisreal))。
- 関数`bitPositionsToArray`を追加。[#23792](https://github.com/ClickHouse/ClickHouse/issues/23792) を解決。作成者 [Kevin Wan] (@MaxWk)。[#25394](https://github.com/ClickHouse/ClickHouse/pull/25394) ([Maksim Kita](https://github.com/kitaisreal))。
- 'Friday'や'April'のような名前を返す関数`dateName`を追加。作成者 [Daniil Kondratyev] (@dankondr)。[#25372](https://github.com/ClickHouse/ClickHouse/pull/25372) ([Maksim Kita](https://github.com/kitaisreal))。
- カラムをJSON表現にシリアライズする関数`toJSONString`を追加。[#25164](https://github.com/ClickHouse/ClickHouse/pull/25164) ([Amos Bird](https://github.com/amosbird))。
- `query_log`に2つの新しいカラム`initial_query_start_time`と`initial_query_start_time_microsecond`を追加。これらは分散クエリの開始時刻を記録（存在する場合）。[#25022](https://github.com/ClickHouse/ClickHouse/pull/25022) ([Amos Bird](https://github.com/amosbird))。
- 集約関数`segmentLengthSum`を追加。[#24250](https://github.com/ClickHouse/ClickHouse/pull/24250) ([flynn](https://github.com/ucasfl))。
- すべてのIN/JOINをGLOBAL IN/JOINとしてデフォルト設定する新しいブール設定`prefer_global_in_and_join`を追加。[#23434](https://github.com/ClickHouse/ClickHouse/pull/23434) ([Amos Bird](https://github.com/amosbird))。
- `Join`テーブルエンジンに対する`ALTER DELETE`クエリをサポート。[#23260](https://github.com/ClickHouse/ClickHouse/pull/23260) ([foolchi](https://github.com/foolchi))。
- 集約関数`quantileBFloat16`、および対応する`quantilesBFloat16`と`medianBFloat16`を追加。相対誤差が0.390625%以下の非常にシンプルで高速な分位数推定器。これにより [#16641](https://github.com/ClickHouse/ClickHouse/issues/16641) を解決。[#23204](https://github.com/ClickHouse/ClickHouse/pull/23204) ([Ivan Novitskiy](https://github.com/RedClusive))。
- `フロー分析`に有用な関数`sequenceNextNode()`を実装。[#19766](https://github.com/ClickHouse/ClickHouse/pull/19766) ([achimbab](https://github.com/achimbab))。

#### 実験的機能 {#experimental-feature-4}

- HDFS上の仮想ファイルシステムのサポートを追加。[#11058](https://github.com/ClickHouse/ClickHouse/pull/11058) ([overshov](https://github.com/overshov)) ([Kseniia Sumarokova](https://github.com/kssenii))。
- clickhouse-keeper（ZooKeeperの実験的な代替）がZooKeeperライクな`digest` ACLをサポート。[#24448](https://github.com/ClickHouse/ClickHouse/pull/24448) ([alesapin](https://github.com/alesapin))。

#### パフォーマンス改善 {#performance-improvement-4}


- 一部の関数をサブカラムの読み取りに変換することで、読み取るデータ量を削減する最適化を追加しました。例えば、`col IS NULL` というステートメントは、サブカラム `col.null` の読み取りに変換されます。この最適化は、現在デフォルトでは無効になっている `optimize_functions_to_subcolumns` 設定を有効にすることで利用できます。[#24406](https://github.com/ClickHouse/ClickHouse/pull/24406) ([Anton Popov](https://github.com/CurtizJ))。
- より多くのカラムを可能なエイリアス式に書き換えます。これにより、プロジェクションなどのより優れた最適化が可能になる場合があります。[#24405](https://github.com/ClickHouse/ClickHouse/pull/24405) ([Amos Bird](https://github.com/amosbird))。
- `bloom_filter` 型のインデックスは、定数配列を持つ `hasAny` 関数を含む式に使用できるようになりました。これにより以下の問題が解決されます: [#24291](https://github.com/ClickHouse/ClickHouse/issues/24291)。[#24900](https://github.com/ClickHouse/ClickHouse/pull/24900) ([Vasily Nemkov](https://github.com/Enmk))。
- RabbitMQキューが空の場合に、読み取り試行を再スケジュールするための指数バックオフを追加しました。(ClickHouseはRabbitMQからのデータインポートをサポートしています)。これにより以下の問題が解決されます [#24340](https://github.com/ClickHouse/ClickHouse/issues/24340)。[#24415](https://github.com/ClickHouse/ClickHouse/pull/24415) ([Kseniia Sumarokova](https://github.com/kssenii))。

#### 改善 {#improvement-4}


* レプリケーションの帯域幅を制限できるようにしました。テーブルごとのレプリケートされたフェッチ/送信の最大速度を制限するために、2 つの Replicated*MergeTree 設定 `max_replicated_fetches_network_bandwidth` と `max_replicated_sends_network_bandwidth` を追加しました。すべてのテーブルに対するレプリケーションの最大速度を制限するサーバー全体の設定（`default` ユーザープロファイル内）として、`max_replicated_fetches_network_bandwidth_for_server` と `max_replicated_sends_network_bandwidth_for_server` の 2 つを追加しました。これらの設定は厳密に守られるわけではありません。デフォルトでは無効になっています。 [#1821](https://github.com/ClickHouse/ClickHouse/issues/1821) を修正。 [#24573](https://github.com/ClickHouse/ClickHouse/pull/24573)（[alesapin](https://github.com/alesapin)）。
* ODBC および Library ブリッジ向けにリソース制約とアイソレーションを追加。ブリッジプロセス用に専用の `clickhouse-bridge` グループおよびユーザーを使用。ブリッジが OOM killer の最初の対象となるように、oom&#95;score&#95;adj を設定。最大 RSS を 1 GiB に制限。[#23861](https://github.com/ClickHouse/ClickHouse/issues/23861) をクローズ。[#25280](https://github.com/ClickHouse/ClickHouse/pull/25280)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* メインの `clickhouse` バイナリへのスタンドアロンな `clickhouse-keeper` シンボリックリンクを追加しました。これにより、メインの `clickhouse` サーバーなしでコーディネーションを実行できるようになりました。 [#24059](https://github.com/ClickHouse/ClickHouse/pull/24059) ([alesapin](https://github.com/alesapin)).
* `VIEW` へのクエリではグローバル設定を使用するようにしました。`VIEW` へのクエリがローカル設定を使用しており、`CREATE VIEW` と `SELECT` で設定が異なる場合にエラーが発生していた動作を修正しました。現在では、`VIEW` はこれらのローカルで変更された設定を使用しませんが、`CREATE VIEW` クエリの `SETTINGS` セクションで追加の設定を指定することは引き続き可能です。[#20551](https://github.com/ClickHouse/ClickHouse/issues/20551) をクローズ。[#24095](https://github.com/ClickHouse/ClickHouse/pull/24095)（[Vladimir](https://github.com/vdimir)）。
* サーバー起動時、不正なパーティション ID を持つパーツは削除されることはなく、常に切り離されていました。 [#25070](https://github.com/ClickHouse/ClickHouse/issues/25070)。 [#25166](https://github.com/ClickHouse/ClickHouse/pull/25166) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* バックグラウンドスケジュールプールのサイズ（`background_schedule_pool_size` 設定）を 128 に増やしました。これにより、ZooKeeper への接続が遅い場合でもレプリケーションキューがハングしてしまう問題を回避できます。 [#25072](https://github.com/ClickHouse/ClickHouse/pull/25072) ([alesapin](https://github.com/alesapin))。
* バックグラウンドで同時にマージできるパーツ数を制限する MergeTree の設定 `max_parts_to_merge_at_once` を追加しました。`OPTIMIZE FINAL` クエリには影響しません。[#1820](https://github.com/ClickHouse/ClickHouse/issues/1820) を修正しました。[#24496](https://github.com/ClickHouse/ClickHouse/pull/24496)（[alesapin](https://github.com/alesapin)）。
* `NOT IN` 演算子をパーティションプルーニングで使用可能にしました。 [#24894](https://github.com/ClickHouse/ClickHouse/pull/24894) ([Amos Bird](https://github.com/amosbird)).
* `127.0.1.1` のような IPv4 アドレスをローカルアドレスとして認識するようにしました。これは賛否の分かれる変更ですが、[#23504](https://github.com/ClickHouse/ClickHouse/issues/23504) をクローズします。Michael Filimonov がこの機能をテストします。[#24316](https://github.com/ClickHouse/ClickHouse/pull/24316)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 実験的機能である MaterializeMySQL によって作成された ClickHouse データベースには、マテリアライズ対象の MySQL データベースに存在したすべてのカラムコメントが含まれるようになりました。 [#25199](https://github.com/ClickHouse/ClickHouse/pull/25199) ([Storozhuk Kostiantyn](https://github.com/sand6255))。
* MySQL ストレージエンジン用の設定項目（`connection_auto_close` / `connection_max_tries` / `connection_pool_size`）を追加しました。 [#24146](https://github.com/ClickHouse/ClickHouse/pull/24146) ([Azat Khuzhin](https://github.com/azat)).
* Distributed エンジンの起動時間を短縮。 [#25663](https://github.com/ClickHouse/ClickHouse/pull/25663) ([Azat Khuzhin](https://github.com/azat)).
* Distributed テーブルに関する改善。internal&#95;replication=true の場合に dirname からレプリカ名を削除（これにより、任意数のレプリカから cluster を用いた Distributed テーブルへの INSERT が可能になる。以前はレプリカ 15 台までしかサポートされず、それ以上では非同期ブロック用ディレクトリ作成時に ENAMETOOLONG で失敗していた）。[#25513](https://github.com/ClickHouse/ClickHouse/pull/25513)（[Azat Khuzhin](https://github.com/azat)）。
* `LowCardinality` に対する `Interval` 型のサポートを追加しました。これは一部の式の中間値に必要です。[#21730](https://github.com/ClickHouse/ClickHouse/issues/21730) を解決します。[#25410](https://github.com/ClickHouse/ClickHouse/pull/25410)（[Vladimir](https://github.com/vdimir)）。
* `sequenceMatch` および `sequenceCount` 関数の時間条件で `==` 演算子が使えるようになりました。例えば、sequenceMatch(&#39;(?1)(?t==1)(?2)&#39;)(time, data = 1, data = 2)。 [#25299](https://github.com/ClickHouse/ClickHouse/pull/25299) ([Christophe Kalenzaga](https://github.com/mga-chka)).
* `http_max_fields`、`http_max_field_name_size`、`http_max_field_value_size` の設定を追加しました。 [#25296](https://github.com/ClickHouse/ClickHouse/pull/25296) ([Ivan](https://github.com/abyss7))。
* 分岐で `Decimal` 型および `Int` 型を使用する場合の関数 `if` のサポートを追加しました。これにより [#20549](https://github.com/ClickHouse/ClickHouse/issues/20549) がクローズされます。また、[#10142](https://github.com/ClickHouse/ClickHouse/issues/10142) もクローズされます。[#25283](https://github.com/ClickHouse/ClickHouse/pull/25283)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `clickhouse-client` のプロンプトを更新し、再接続時にメッセージを表示するようにしました。これにより [#10577](https://github.com/ClickHouse/ClickHouse/issues/10577) がクローズされました。[#25281](https://github.com/ClickHouse/ClickHouse/pull/25281)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 集約関数 `topK` のメモリトラッキングを修正しました。これにより [#25259](https://github.com/ClickHouse/ClickHouse/issues/25259) が解決されました。[#25260](https://github.com/ClickHouse/ClickHouse/pull/25260) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* IDN ホスト（例: `example.рф`）に対する `topLevelDomain` を修正しました。これまで、そのようなホストに対しては空文字列を返していました。 [#25103](https://github.com/ClickHouse/ClickHouse/pull/25103) ([Azat Khuzhin](https://github.com/azat)).
* 実行時に Linux カーネルバージョンを検出するようにした（`async_socket_for_remote` / `use_hedged_requests` に必要な、ネストされた epoll が正しく動作するかどうかを判別するため。これを行わないとリモートクエリがハングする可能性がある）。[#25067](https://github.com/ClickHouse/ClickHouse/pull/25067)（[Azat Khuzhin](https://github.com/azat)）。
* 分散クエリにおいて `optimize_skip_unused_shards=1` の場合、`(シャーディングキー) IN (要素が1つのタプル)` のような条件でシャードをスキップできるようにしました（要素数が多いタプルは既にサポートされていましたが、要素が1つのタプルはリテラルとしてパースされるため機能していませんでした）。[#24930](https://github.com/ClickHouse/ClickHouse/pull/24930)（[Amos Bird](https://github.com/amosbird)）。
* S3 エラーのログメッセージを改善し、キーやバケットが空の場合でも二重スペースが含まれないようにしました。 [#24897](https://github.com/ClickHouse/ClickHouse/pull/24897) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 一部のクエリでは複数回のセマンティック解析が必要になります。この場合は、`IN` で使用するために構築済みの集合を再利用することを検討してください。 [#24874](https://github.com/ClickHouse/ClickHouse/pull/24874) ([Amos Bird](https://github.com/amosbird))。
* `insert_distributed_sync` で `max_distributed_connections` の上限を遵守するようにした（そうしない場合、大規模クラスタで同期挿入を行う際に `max_thread_pool_size` を使い果たす可能性があります）。 [#24754](https://github.com/ClickHouse/ClickHouse/pull/24754) ([Azat Khuzhin](https://github.com/azat)).
* スカラーサブクエリで発生した `Limit for rows or bytes to read exceeded` などのエラーが隠蔽されないようにしました。 [#24545](https://github.com/ClickHouse/ClickHouse/pull/24545) ([nvartolomei](https://github.com/nvartolomei)).
* String-to-Int パーサーをより厳格にし、`toInt64('+')` が例外をスローするようにしました。 [#24475](https://github.com/ClickHouse/ClickHouse/pull/24475) ([Amos Bird](https://github.com/amosbird)).
* `SSD_CACHE` が DDL クエリによって作成される場合、`user_files` ディレクトリ内にのみ作成できます。 [#24466](https://github.com/ClickHouse/ClickHouse/pull/24466) ([Maksim Kita](https://github.com/kitaisreal)).
* PostgreSQL 互換モードで、`INSERT` クエリでデフォルト以外のスキーマを指定できるようにしました。 [#24149](https://github.com/ClickHouse/ClickHouse/issues/24149) をクローズ。 [#24413](https://github.com/ClickHouse/ClickHouse/pull/24413)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* IPv6 アドレスの解決を修正しました（`select * from remote('[::1]', system.one)` が正しく動作するように修正）。[#24319](https://github.com/ClickHouse/ClickHouse/pull/24319) ([Azat Khuzhin](https://github.com/azat)).
* 複数行モードでサブクエリを含む FROM 句の末尾の空白を修正し、さらにクエリの出力をわずかに変更して、より読みやすい形式にしました。 [#24151](https://github.com/ClickHouse/ClickHouse/pull/24151) ([Azat Khuzhin](https://github.com/azat)).
* Distributed テーブルの改善。`distributed_directory_monitor_split_batch_on_failure`（デフォルトでは OFF）設定のもとで、失敗時（メモリ制限や破損などによる）に distributed バッチを分割できる機能を追加。 [#23864](https://github.com/ClickHouse/ClickHouse/pull/23864) ([Azat Khuzhin](https://github.com/azat)).
* `Join` テーブルエンジンにおける列名の衝突に対応。 [#20309](https://github.com/ClickHouse/ClickHouse/issues/20309) をクローズ。 [#23769](https://github.com/ClickHouse/ClickHouse/pull/23769)（[Vladimir](https://github.com/vdimir)）。
* `clickhouse-local` の `File` テーブルエンジンおよび、データが標準入力 (stdin) から渡される場合の `clickhouse-client` の INSERT クエリで進捗を表示するようにしました。[#18209](https://github.com/ClickHouse/ClickHouse/issues/18209) をクローズ。[#23656](https://github.com/ClickHouse/ClickHouse/pull/23656)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `clickhouse-copier` のバグ修正と改善。異なる（ただし互換性のある）スキーマを持つテーブルのコピーを許可した。[#9159](https://github.com/ClickHouse/ClickHouse/issues/9159) をクローズ。ReplacingMergeTree をコピーするテストを追加した。[#22711](https://github.com/ClickHouse/ClickHouse/issues/22711) をクローズ。カラムおよび Data Skipping Indices 上の TTL をサポートした。内部の Distributed テーブルを作成する際には、それらを単純に削除する（基礎となるテーブル側には TTL と skipping indices が保持される）。[#19384](https://github.com/ClickHouse/ClickHouse/issues/19384) をクローズ。MATERIALIZED カラムおよび ALIAS カラムのコピーを許可した。いくつかのケース（例：このカラムが PRIMARY KEY に含まれている場合）では有用なことがある。タスク設定で `allow_to_copy_alias_and_materialized_columns` プロパティを true に設定することで、これを許可できるようになった。[#9177](https://github.com/ClickHouse/ClickHouse/issues/9177) をクローズ。[#11007](https://github.com/ClickHouse/ClickHouse/issues/11007) をクローズ。[#9514](https://github.com/ClickHouse/ClickHouse/issues/9514) をクローズ。タスク設定に `allow_to_drop_target_partitions` プロパティを追加し、補助テーブルを移動する前に元のテーブルのパーティションを削除できるようにした。[#20957](https://github.com/ClickHouse/ClickHouse/issues/20957) をクローズ。`OPTIMIZE DEDUPLICATE` クエリを廃止。このハックは、`ALTER TABLE MOVE PARTITION` が何度もリトライされ、プレーンな MergeTree テーブルには重複排除機能がないために必要とされていた。[#17966](https://github.com/ClickHouse/ClickHouse/issues/17966) をクローズ。進捗を JSON 形式で ZooKeeper の `task_path + /status` パス上のノードに書き込むようにした。[#20955](https://github.com/ClickHouse/ClickHouse/issues/20955) をクローズ。引数なしの ReplicatedTables をサポート。[#24834](https://github.com/ClickHouse/ClickHouse/issues/24834) をクローズ。[#23518](https://github.com/ClickHouse/ClickHouse/pull/23518)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* S3 からの読み取り再試行の間にバックオフ付きスリープを追加しました。 [#23461](https://github.com/ClickHouse/ClickHouse/pull/23461) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `Distributed` テーブルへの INSERT 文において、`insert_allow_materialized_columns`（マテリアライズドカラムを許可する設定）が反映されるようにしました。 [#23349](https://github.com/ClickHouse/ClickHouse/pull/23349) ([Azat Khuzhin](https://github.com/azat)).
* 分散クエリで LIMIT のプッシュダウンを可能にした。 [#23027](https://github.com/ClickHouse/ClickHouse/pull/23027) ([Azat Khuzhin](https://github.com/azat)).
* 複数の S3 ボリューム使用時におけるゼロコピー レプリケーションの問題を修正（[#22679](https://github.com/ClickHouse/ClickHouse/issues/22679) を修正）。[#22864](https://github.com/ClickHouse/ClickHouse/pull/22864)（[ianton-ru](https://github.com/ianton-ru)）。
* ユーザーがオペレーティングシステムに空いている任意のポートを要求した際に、実際にバインドされたポート番号を特定してログメッセージに表示するようにしました。 [#25569](https://github.com/ClickHouse/ClickHouse/pull/25569) ([bnaecker](https://github.com/bnaecker)).
* 一部のケースで、PostgreSQL 配列の変換結果が n 次元配列ではなく String 型になってしまう問題を修正しました。原因は、特定の状況で `attndims` が正しく動作しないことにありました。 [#24804](https://github.com/ClickHouse/ClickHouse/issues/24804) をクローズ。 [#25538](https://github.com/ClickHouse/ClickHouse/pull/25538)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* MySQL、PostgreSQL、ODBC 向けのタイムゾーン付き `DateTime` の変換処理を修正。[#5057](https://github.com/ClickHouse/ClickHouse/issues/5057) をクローズ。[#25528](https://github.com/ClickHouse/ClickHouse/pull/25528)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 異なるテーブルごとに `KILL MUTATION` を区別するようにし、予期しない `Cancelled mutating parts` エラーを修正。[#25025](https://github.com/ClickHouse/ClickHouse/pull/25025)（[Azat Khuzhin](https://github.com/azat)）。
* S3 ディスクをバケットのルートに定義できるようにしました（S3 仮想ファイルシステムは現在開発中の実験的機能です）。 [#24898](https://github.com/ClickHouse/ClickHouse/pull/24898) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 分散テーブルでサブカラム（例: Tuple の構成要素）を読み取れるようにしました。 [#24472](https://github.com/ClickHouse/ClickHouse/pull/24472) ([Anton Popov](https://github.com/CurtizJ)).
* MySQL 互換プロトコル用の機能: `user` 関数が正しい出力を返すように修正しました。[#25697](https://github.com/ClickHouse/ClickHouse/pull/25697) をクローズします。[#25697](https://github.com/ClickHouse/ClickHouse/pull/25697)（[sundyli](https://github.com/sundy-li)）。

#### バグ修正 {#bug-fix-3}


* 後方互換性の改善。パーティションキーで使用されている場合は、旧バージョンの modulo 関数を使用します。[#23508](https://github.com/ClickHouse/ClickHouse/issues/23508) をクローズ。[#24157](https://github.com/ClickHouse/ClickHouse/pull/24157)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 低メモリのサーバーで極めてまれに発生し、再起動しないとマージを実行できなくなる不具合を修正しました。おそらく [#24603](https://github.com/ClickHouse/ClickHouse/issues/24603) を解決しています。 [#24872](https://github.com/ClickHouse/ClickHouse/pull/24872) ([alesapin](https://github.com/alesapin))。
* 同時に実行される `alter move/replace partition` 中にレプリケーションキュー内で発生する極めて稀なエラー `Tagging already tagged part` を修正しました。[#22142](https://github.com/ClickHouse/ClickHouse/issues/22142) も修正できている可能性があります。[#24961](https://github.com/ClickHouse/ClickHouse/pull/24961)（[alesapin](https://github.com/alesapin)）。
* 他の集約関数の集約関数状態をさらに集約して集約関数状態を計算する際にクラッシュする可能性のあった問題を修正しました（現実的なユースケースではありません）。[#24523](https://github.com/ClickHouse/ClickHouse/issues/24523) を参照。[#25015](https://github.com/ClickHouse/ClickHouse/pull/25015)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `SYSTEM RESTART REPLICA` または `SYSTEM SYNC REPLICA` クエリが完了しないケースでの動作を修正しました。これは、RAM 容量が極端に少ないサーバーで検出されました。 [#24457](https://github.com/ClickHouse/ClickHouse/pull/24457) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* clickhouse-server 内で ZooKeeper クライアントがハングする可能性のあるバグを修正。 [#24721](https://github.com/ClickHouse/ClickHouse/pull/24721) ([alesapin](https://github.com/alesapin)).
* ZooKeeper への接続が失われ、その後接続を復旧した際にレプリカがクローンされた場合、そのレプリケーションキューに古いエントリが含まれている可能性があります。レプリケーションキューに互いに重なり合う仮想パーツが含まれている場合に発生していたアサーション失敗を修正しました。これは、一部のデータパーツが失われた場合にまれに発生する可能性があります。プロセスを終了する代わりに、ログにエラーを出力するようにしました。 [#24777](https://github.com/ClickHouse/ClickHouse/pull/24777) ([tavplubix](https://github.com/tavplubix)).
* クエリプランの式プッシュダウン最適化で `WHERE` 条件が失われていた問題を修正し、`query_plan_filter_push_down = 1` をデフォルトに設定しました。 [#25368](https://github.com/ClickHouse/ClickHouse/issues/25368) を修正。 [#25370](https://github.com/ClickHouse/ClickHouse/pull/25370)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* TTL を伴うマージ後にパーツ同士が重なり合う可能性のあるバグを修正: `Part all_40_40_0 is covered by all_40_40_1 but should be merged into all_40_41_1. This shouldn't happen often.`。 [#25549](https://github.com/ClickHouse/ClickHouse/pull/25549) ([alesapin](https://github.com/alesapin)).
* ZooKeeper への接続が失われた場合、`ReplicatedMergeTree` テーブルが再接続を試みる前にバックグラウンド処理の完了を待機することがありました。この問題は修正され、現在はバックグラウンド処理が強制的に停止されるようになりました。 [#25306](https://github.com/ClickHouse/ClickHouse/pull/25306) ([tavplubix](https://github.com/tavplubix)).
* 主キーに配列を使用している場合に、`ARRAY JOIN` を含むクエリで発生していた `Key expression contains comparison between inconvertible types` エラーを修正しました。[#8247](https://github.com/ClickHouse/ClickHouse/issues/8247) を修正します。 [#25546](https://github.com/ClickHouse/ClickHouse/pull/25546)（[Anton Popov](https://github.com/CurtizJ)）。
* クエリ `WITH TOTALS` および `WITH FILL` に対する誤った合計値を修正。[#20872](https://github.com/ClickHouse/ClickHouse/issues/20872) を解決。[#25539](https://github.com/ClickHouse/ClickHouse/pull/25539)（[Anton Popov](https://github.com/CurtizJ)）。
* `system.clusters` をクエリしている最中にクラスタ設定を再読み込みすると発生するデータレースを修正しました。 [#25737](https://github.com/ClickHouse/ClickHouse/pull/25737) ([Amos Bird](https://github.com/amosbird)).
* データベース間で `Distributed` テーブルを移動する際に発生していた `No such file or directory` エラーを修正しました。[#24971](https://github.com/ClickHouse/ClickHouse/issues/24971) を解決。[#25667](https://github.com/ClickHouse/ClickHouse/pull/25667) ([tavplubix](https://github.com/tavplubix))。
* ソースパーティションが空の場合、まれに `REPLACE PARTITION` が無視されることがありました。この問題を修正しました。 [#24869](https://github.com/ClickHouse/ClickHouse/issues/24869) を修正しました。 [#25665](https://github.com/ClickHouse/ClickHouse/pull/25665)（[tavplubix](https://github.com/tavplubix)）。
* `Replicated` データベースエンジンで、ごくまれに一部のレプリカがキューに入っていた DDL クエリをスキップしてしまうことがある不具合を修正しました。 [#24805](https://github.com/ClickHouse/ClickHouse/pull/24805) ([tavplubix](https://github.com/tavplubix)).
* クエリなしで `EXPLAIN AST` を実行した場合に発生するヌルポインタのデリファレンスを修正。 [#25631](https://github.com/ClickHouse/ClickHouse/pull/25631) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 空のパーツの自動削除を待機する処理を修正しました。これによりバックグラウンドプールが完全に占有され、レプリケーションが停止してしまう可能性がありました。 [#23315](https://github.com/ClickHouse/ClickHouse/pull/23315) ([Anton Popov](https://github.com/CurtizJ)).
* S3 仮想ファイルシステム上に保存されたテーブルの復元処理を修正しました（まだ本番環境での利用には準備ができていない実験的な機能です）。 [#25601](https://github.com/ClickHouse/ClickHouse/pull/25601) ([ianton-ru](https://github.com/ianton-ru)).
* `Decimal256` 使用時の `Arrow` フォーマットにおけるヌルポインタ参照を修正。`Arrow` フォーマットに `Decimal256` のサポートを追加。[#25531](https://github.com/ClickHouse/ClickHouse/pull/25531) ([Kruglov Pavel](https://github.com/Avogar)).
* 前処理された設定ファイル名の先頭に付く不要なアンダースコアを修正。 [#25431](https://github.com/ClickHouse/ClickHouse/pull/25431) ([Vitaly Baranov](https://github.com/vitlibar)).
* `clickhouse-copier` ツールの修正: タスク設定に `sharding_key` が存在しない場合に発生していたセグメンテーションフォルトを修正しました。 [#25419](https://github.com/ClickHouse/ClickHouse/pull/25419) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* DDL で使用された場合にフォーマット済みクエリを正しくクオートするようにし、`REPLACE` カラムトランスフォーマを修正しました。これにより [#23925](https://github.com/ClickHouse/ClickHouse/issues/23925) が修正されます。[#25391](https://github.com/ClickHouse/ClickHouse/pull/25391)（[Amos Bird](https://github.com/amosbird)）。
* `quantileDeterministic` 関数および類似の関数で非決定的な動作が発生しうる可能性を修正しました。これにより [#20480](https://github.com/ClickHouse/ClickHouse/issues/20480) がクローズされました。 [#25313](https://github.com/ClickHouse/ClickHouse/pull/25313) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `SummingMergeTree` に対して `SimpleAggregateFunction(LowCardinality)` をサポートしました。 [#25134](https://github.com/ClickHouse/ClickHouse/issues/25134) を修正しました。 [#25300](https://github.com/ClickHouse/ClickHouse/pull/25300)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 例外メッセージ &quot;Cannot sum Array/Tuple in min/maxMap&quot; が出力される論理エラーを修正。 [#25298](https://github.com/ClickHouse/ClickHouse/pull/25298) ([Kruglov Pavel](https://github.com/Avogar)).
* `IN` 句で `LowCardinality` 引数が使用されたクエリで発生していたエラー `Bad cast from type DB::ColumnLowCardinality to DB::ColumnVector<char8_t>` を修正しました（このバグはバージョン 21.6 で導入されました）。[#25187](https://github.com/ClickHouse/ClickHouse/issues/25187) を修正。[#25290](https://github.com/ClickHouse/ClickHouse/pull/25290)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* not-nullable 列に対する `joinGetOrNull` の誤った動作を修正しました。これにより [#24261](https://github.com/ClickHouse/ClickHouse/issues/24261) が解決されます。[#25288](https://github.com/ClickHouse/ClickHouse/pull/25288)（[Amos Bird](https://github.com/amosbird)）。
* 大きな整数型における誤った挙動と UBSan レポートを修正しました。以前のバージョンでは `CAST(1e19 AS UInt128)` は 0 を返していました。 [#25279](https://github.com/ClickHouse/ClickHouse/pull/25279) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* CSVWithNames フォーマットを使用して一部の列のみを挿入する際に発生していたエラーを修正しました。 [#25129](https://github.com/ClickHouse/ClickHouse/issues/25129) を修正。 [#25169](https://github.com/ClickHouse/ClickHouse/pull/25169) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* `FINAL` 付きの `SELECT` クエリに対してテーブルプロジェクションを使用しないでください。これはまだサポートされていません。 [#25163](https://github.com/ClickHouse/ClickHouse/pull/25163) ([Amos Bird](https://github.com/amosbird))。
* テーブルがパーティションキーに `UUID` を使用している場合に、21.5 へアップデートするとパーツが失われる可能性があった問題を修正しました（パーティションキーに `UUID` を使用することは推奨されません）。[#25070](https://github.com/ClickHouse/ClickHouse/issues/25070) を修正しました。[#25127](https://github.com/ClickHouse/ClickHouse/pull/25127)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `joined_subquery_requires_alias = 0` を使用したクロス結合を含むクエリで発生していたクラッシュを修正しました。 [#24011](https://github.com/ClickHouse/ClickHouse/issues/24011) を修正。 [#25082](https://github.com/ClickHouse/ClickHouse/pull/25082)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `mapContains` 関数において、定数の `map` を扱う際に `empty column was returned by function mapContains` というエラーが発生する原因となっていたバグを修正しました。[#25077](https://github.com/ClickHouse/ClickHouse/issues/25077) をクローズしました。[#25080](https://github.com/ClickHouse/ClickHouse/pull/25080)（[Kruglov Pavel](https://github.com/Avogar)）。
* `a UInt32 ALIAS a + 1` や `b UInt32 MATERIALIZED b` のように、自身を参照するカラムを持つテーブルを作成できないようにしました。[#24910](https://github.com/ClickHouse/ClickHouse/issues/24910)、[#24292](https://github.com/ClickHouse/ClickHouse/issues/24292) を修正。[#25059](https://github.com/ClickHouse/ClickHouse/pull/25059)（[alesapin](https://github.com/alesapin)）。
* *空でない* `GROUP BY` キーを持つ集約プロジェクションを使用して、*空の* キーで `GROUP BY` を行うクエリを実行した場合に誤った結果が返される問題を修正。 [#25055](https://github.com/ClickHouse/ClickHouse/pull/25055) ([Amos Bird](https://github.com/amosbird)).
* Protobuf フォーマットにおける、分割されたネストされたメッセージのシリアル化の問題を修正しました。この PR は [#24647](https://github.com/ClickHouse/ClickHouse/issues/24647) を修正します。 [#25000](https://github.com/ClickHouse/ClickHouse/pull/25000)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 分散クエリにおける limit/offset 設定を修正（リモートノード側では無視）。[#24940](https://github.com/ClickHouse/ClickHouse/pull/24940)（[Azat Khuzhin](https://github.com/azat)）。
* `Arrow` フォーマットで発生しうるヒープバッファオーバーフローを修正しました。 [#24922](https://github.com/ClickHouse/ClickHouse/pull/24922) ([Kruglov Pavel](https://github.com/Avogar)).
* DiskS3 からファイルを読み込む際に発生する可能性があったエラー &#39;Cannot read from istream at offset 0&#39; を修正しました（S3 仮想ファイルシステムは開発中の実験的機能であり、本番環境では使用すべきではありません）。 [#24885](https://github.com/ClickHouse/ClickHouse/pull/24885) ([Pavel Kovalenko](https://github.com/Jokser)).
* 分散マテリアライズドビューを `JOIN` する際に発生していた &quot;Missing columns&quot; 例外を修正。 [#24870](https://github.com/ClickHouse/ClickHouse/pull/24870) ([Azat Khuzhin](https://github.com/azat)).
* PostgreSQL 互換プロトコルで `NULL` 値を許可。 [#22622](https://github.com/ClickHouse/ClickHouse/issues/22622) をクローズしました。 [#24857](https://github.com/ClickHouse/ClickHouse/pull/24857) ([Kseniia Sumarokova](https://github.com/kssenii)).
* ミューテーション待機中に、そのミューテーションがまだメモリにロードされていない場合でも例外 `Mutation was killed` がクライアントにスローされる可能性があった不具合を修正。 [#24809](https://github.com/ClickHouse/ClickHouse/pull/24809) ([alesapin](https://github.com/alesapin)).
* 乱数ジェネレータの状態のデシリアライズにおけるバグを修正しました。このバグにより、`AggregateFunction(groupArraySample(N), T))` などの一部のデータ型が決定的でない動作をする可能性がありました。 [#24538](https://github.com/ClickHouse/ClickHouse/pull/24538) ([tavplubix](https://github.com/tavplubix))。
* 他の集約状態に対する `uniqXXXXStates` の構築を禁止しました。 [#24523](https://github.com/ClickHouse/ClickHouse/pull/24523)（[Raúl Marín](https://github.com/Algunenano)）。その後、関連する問題の根本原因を実際に解消することで、再び許可しました（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `CREATE .. AS SELECT` クエリにおけるタプルの扱いを修正しました。 [#24464](https://github.com/ClickHouse/ClickHouse/pull/24464) ([Anton Popov](https://github.com/CurtizJ)).
* `Buffer` テーブルにおける合計バイト数の計算を修正しました。現在の ClickHouse のバージョンでは、バッファのフラッシュ中に `total_writes.bytes` カウンタが過度に減少してしまいます。その結果、カウンタがオーバーフローし、フラッシュ後しばらくすると `totalBytes` が約 17.44 EB といった値を返すことがありました。 [#24450](https://github.com/ClickHouse/ClickHouse/pull/24450) ([DimasKovas](https://github.com/DimasKovas)).
* toWeek 関数の単調性に関する誤った情報を修正しました。これにより [#24422](https://github.com/ClickHouse/ClickHouse/issues/24422) が解消されます。このバグは [https://github.com/ClickHouse/ClickHouse/pull/5212](https://github.com/ClickHouse/ClickHouse/pull/5212) で導入され、高度なパーティションプルーナーによって後になって顕在化しました。[#24446](https://github.com/ClickHouse/ClickHouse/pull/24446)（[Amos Bird](https://github.com/amosbird)）。
* ユーザー認証を LDAP で管理している場合に、LDAP グループが存在しないローカルロールにマッピングされていると、LDAP ロールの（再）マッピング処理中にデッドロックが発生しうる問題を修正しました。 [#24431](https://github.com/ClickHouse/ClickHouse/pull/24431) ([Denis Glazachev](https://github.com/traceon))。
* &quot;multipart/form-data&quot; メッセージでは、バウンダリの直前にある CRLF をバウンダリの一部として扱うようにしました。[#23905](https://github.com/ClickHouse/ClickHouse/issues/23905) を修正。 [#24399](https://github.com/ClickHouse/ClickHouse/pull/24399) ([Ivan](https://github.com/abyss7))。
* フェイクパーツが交差する場合の `DROP PARTITION` を修正しました。まれなケースですが、現在のブロック番号よりも大きい mutation バージョンを持つパーツが存在することがあります。 [#24321](https://github.com/ClickHouse/ClickHouse/pull/24321) ([Amos Bird](https://github.com/amosbird)).
* Ordinary データベースから Atomic データベースへの `RENAME TABLE` クエリを用いたマテリアライズドビュー移動時のバグを修正しました。これにより、マテリアライズドビューと共に内部テーブルも新しいデータベースへ移動されるようになりました。[#23926](https://github.com/ClickHouse/ClickHouse/issues/23926) を修正。[#24309](https://github.com/ClickHouse/ClickHouse/pull/24309)（[tavplubix](https://github.com/tavplubix)）。
* 空の HTTP ヘッダーを許可するようにしました。 [#23901](https://github.com/ClickHouse/ClickHouse/issues/23901) を修正。 [#24285](https://github.com/ClickHouse/ClickHouse/pull/24285) ([Ivan](https://github.com/abyss7))。
* Memory テーブルにおけるミューテーション (ALTER UPDATE/DELETE) の処理を修正。[#24274](https://github.com/ClickHouse/ClickHouse/issues/24274) をクローズ。[#24275](https://github.com/ClickHouse/ClickHouse/pull/24275)（[flynn](https://github.com/ucasfl)）。
* JOIN 出力における列の LowCardinality プロパティを入力と同一にし、[#23351](https://github.com/ClickHouse/ClickHouse/issues/23351) と [#20315](https://github.com/ClickHouse/ClickHouse/issues/20315) をクローズしました。[#24061](https://github.com/ClickHouse/ClickHouse/pull/24061)（[Vladimir](https://github.com/vdimir)）。
* Kafka テーブルに対する修正。`Engine = Kafka` の場合に、同じコンシューマが以前に空の `assignment` を持っていたとき、その後にコンシュームを開始できないフェイルオーバー時の挙動のバグを修正。[#21118](https://github.com/ClickHouse/ClickHouse/issues/21118) をクローズ。[#21267](https://github.com/ClickHouse/ClickHouse/pull/21267)（[filimonov](https://github.com/filimonov)）。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-4}

- CIに`darwin-aarch64`（Mac M1 / Apple Silicon）ビルドを追加 [#25560](https://github.com/ClickHouse/ClickHouse/pull/25560) ([Ivan](https://github.com/abyss7)) し、ドキュメントとウェブサイトへのリンクを配置 ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 実行可能ファイルへのバイナリリソースのクロスプラットフォーム埋め込みを追加。Illumosで動作します。[#25146](https://github.com/ClickHouse/ClickHouse/pull/25146) ([bnaecker](https://github.com/bnaecker))。
- ファジングを改善するため、ストレステストに結合関連のオプションを追加。[#25200](https://github.com/ClickHouse/ClickHouse/pull/25200) ([Vladimir](https://github.com/vdimir))。
- macOSでs3モジュールを使用したビルドを有効化 [#25217](https://github.com/ClickHouse/ClickHouse/issues/25217)。[#25218](https://github.com/ClickHouse/ClickHouse/pull/25218) ([kevin wan](https://github.com/MaxWk))。
- JDBCブリッジをカバーする統合テストケースを追加。[#25047](https://github.com/ClickHouse/ClickHouse/pull/25047) ([Zhichun Wu](https://github.com/zhicwu))。
- 統合テスト設定には辞書の特別な処理があります。残りの辞書の手動設定を削除しました。[#24728](https://github.com/ClickHouse/ClickHouse/pull/24728) ([Ilya Yatsishin](https://github.com/qoega))。
- YAMLParserクラスのlibfuzzerテストを追加。[#24480](https://github.com/ClickHouse/ClickHouse/pull/24480) ([BoloniniD](https://github.com/BoloniniD))。
- 統合テストの実行にUbuntu 20.04を使用するようになり、統合テストの実行に使用されるdocker-composeのバージョンは1.28.2に更新されました。環境変数がdocker-composeで有効になりました。並列実行を可能にするためtest_dictionaries_all_layouts_separate_sourcesを再構築しました。[#20393](https://github.com/ClickHouse/ClickHouse/pull/20393) ([Ilya Yatsishin](https://github.com/qoega))。
- インストールスクリプトのTOCTOUエラーを修正。[#25277](https://github.com/ClickHouse/ClickHouse/pull/25277) ([alexey-milovidov](https://github.com/alexey-milovidov))。

### ClickHouseリリース21.6、2021-06-05 {#clickhouse-release-216-2021-06-05}

#### 後方互換性のない変更 {#backward-incompatible-change-5}

- uniqState / uniqHLL12State / uniqCombinedState / uniqCombined64Stateは`UUID`型と互換性のない状態を生成します。[#33607](https://github.com/ClickHouse/ClickHouse/issues/33607)。

#### アップグレード時の注意事項 {#upgrade-notes-1}

- `zstd`圧縮ライブラリがv1.5.0に更新されました。レプリケーションで「チェックサムが一致しません」というメッセージが表示される場合があります。これらのメッセージは圧縮アルゴリズムの更新により予期されるものであり、無視できます。これらのメッセージは情報提供のためのものであり、望ましくない動作を示すものではありません。
- 設定`compile_expressions`はデフォルトで有効になっています。さまざまなシナリオで十分にテストされていますが、サーバーで望ましくない動作が見られる場合は、この設定をオフにしてみてください。
- `UUID`型の値は整数と比較できません。例えば、`uuid != 0`と書く代わりに`uuid != '00000000-0000-0000-0000-000000000000'`と記述してください。

#### 新機能 {#new-feature-5}


* Postgres 風のキャスト演算子（`::`）を追加。例えば、`[1, 2]::Array(UInt8)`、`0.1::Decimal(4, 4)`、`number::UInt16`。 [#23871](https://github.com/ClickHouse/ClickHouse/pull/23871)（[Anton Popov](https://github.com/CurtizJ)）。
* 大きな整数を本番運用可能なレベルにしました。`UInt128` データ型のサポートを追加しました。`Decimal256` データ型に関する既知の問題を修正しました。辞書で大きな整数をサポートしました。大きな整数に対して `gcd` / `lcm` 関数をサポートしました。配列検索および条件関数で大きな整数をサポートしました。`LowCardinality(UUID)` をサポートしました。`generateRandom` テーブル関数および `clickhouse-obfuscator` で大きな整数をサポートしました。スカラーサブクエリから `UUID` を返す際のエラーを修正しました。これにより [#7834](https://github.com/ClickHouse/ClickHouse/issues/7834) を修正しました。これにより [#23936](https://github.com/ClickHouse/ClickHouse/issues/23936) を修正しました。これにより [#4176](https://github.com/ClickHouse/ClickHouse/issues/4176) を修正しました。これにより [#24018](https://github.com/ClickHouse/ClickHouse/issues/24018) を修正しました。後方互換性のない変更: `UUID` 型の値は整数と比較できなくなりました。たとえば、`uuid != 0` と記述する代わりに `uuid != '00000000-0000-0000-0000-000000000000'` と記述してください。[#23631](https://github.com/ClickHouse/ClickHouse/pull/23631)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `Arrow`、`Parquet`、`ORC` 各フォーマットでのデータの挿入および取得において `Array` データ型をサポートしました。 [#21770](https://github.com/ClickHouse/ClickHouse/pull/21770) ([taylor12805](https://github.com/taylor12805))。
* テーブルコメント機能を実装し、[#23225](https://github.com/ClickHouse/ClickHouse/issues/23225) をクローズ。 [#23548](https://github.com/ClickHouse/ClickHouse/pull/23548)（[flynn](https://github.com/ucasFL)）。
* `clickhouse-local` で DDL クエリを使用して辞書を作成できるようにしました。[#22354](https://github.com/ClickHouse/ClickHouse/issues/22354) をクローズ。`DETACH DICTIONARY PERMANENTLY` のサポートを追加。`Atomic` データベースエンジン向けに `EXCHANGE DICTIONARIES` のサポートを追加。`RENAME DICTIONARY` を使用してデータベース間で辞書を移動できるようにしました。 [#23436](https://github.com/ClickHouse/ClickHouse/pull/23436)（[Maksim Kita](https://github.com/kitaisreal)）。
* ClickHouse で [Theta Sketch](https://datasketches.apache.org/docs/Theta/ThetaSketchFramework.html) をサポートするため、集約関数 `uniqTheta` を追加しました。 [#23894](https://github.com/ClickHouse/ClickHouse/pull/23894)。 [#22609](https://github.com/ClickHouse/ClickHouse/pull/22609)（[Ping Yu](https://github.com/pingyu)）。
* 関数 `splitByRegexp` を追加。 [#24077](https://github.com/ClickHouse/ClickHouse/pull/24077) ([abel-cheng](https://github.com/abel-cheng))。
* 配列を引数に取り、その配列内のすべての要素の積を返す関数 `arrayProduct` を追加しました。[#21613](https://github.com/ClickHouse/ClickHouse/issues/21613) をクローズしました。 [#23782](https://github.com/ClickHouse/ClickHouse/pull/23782)（[Maksim Kita](https://github.com/kitaisreal)）。
* `system.stack_trace` に `thread_name` 列を追加。これにより [#23256](https://github.com/ClickHouse/ClickHouse/issues/23256) をクローズ。 [#24124](https://github.com/ClickHouse/ClickHouse/pull/24124) ([abel-cheng](https://github.com/abel-cheng))。
* `insert_null_as_default` = 1 の場合、`INSERT ... SELECT` および `INSERT ... SELECT ... UNION ALL ...` クエリでは、NULL の代わりにデフォルト値を挿入します。 [#22832](https://github.com/ClickHouse/ClickHouse/issues/22832) をクローズしました。 [#23524](https://github.com/ClickHouse/ClickHouse/pull/23524)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `clickhouse-local` に `--progress` オプションによる進捗表示のサポートを追加。 [#23196](https://github.com/ClickHouse/ClickHouse/pull/23196) ([Egor Savin](https://github.com/Amesaru))。
* `http` ディクショナリソースで、`Content-Encoding` HTTP ヘッダーで指定される HTTP 圧縮のサポートを追加しました。これにより [#8912](https://github.com/ClickHouse/ClickHouse/issues/8912) が修正されます。[#23946](https://github.com/ClickHouse/ClickHouse/pull/23946)（[FArthur-cmd](https://github.com/FArthur-cmd)）。
* `SYSTEM QUERY RELOAD MODEL`、`SYSTEM QUERY RELOAD MODELS` を追加しました。 [#18722](https://github.com/ClickHouse/ClickHouse/issues/18722) をクローズしました。 [#23182](https://github.com/ClickHouse/ClickHouse/pull/23182) ([Maksim Kita](https://github.com/kitaisreal))。
* `EXPLAIN PLAN` クエリに対して、`json`（boolean 型、デフォルトは 0）設定を追加しました。有効にすると、クエリ出力は `JSON` 形式の 1 行のみになります。不要なエスケープを避けるため、`TSVRaw` フォーマットの使用を推奨します。 [#23082](https://github.com/ClickHouse/ClickHouse/pull/23082) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `EXPLAIN PIPELINE` クエリに `indexes` 設定（ブール値、デフォルトは無効）を追加。有効化すると、使用されたインデックスと、適用された各インデックスごとのフィルタリングされたパーツ数およびグラニュール数を表示。`MergeTree*` テーブルでサポート。 [#22352](https://github.com/ClickHouse/ClickHouse/pull/22352) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* LDAP: Active Directory グループを ClickHouse ロールにマッピングする際に使用する、ユーザー DN を検出する機能を実装しました。 [#22228](https://github.com/ClickHouse/ClickHouse/pull/22228) ([Denis Glazachev](https://github.com/traceon)).
* 連続する行の差分を合計し、タイムスタンプを保存することでマージ時の順序を維持する新しい集計関数 `deltaSumTimestamp`。[#21888](https://github.com/ClickHouse/ClickHouse/pull/21888) ([Russ Frank](https://github.com/rf))。
* Docker 上でも正しく動作する、セキュリティレベルの低い S3 向け IMDS クレデンシャルプロバイダを追加しました。 [#21852](https://github.com/ClickHouse/ClickHouse/pull/21852) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `indexHint` 関数を再度追加しました。[#21238](https://github.com/ClickHouse/ClickHouse/issues/21238) の対応です。[#9542](https://github.com/ClickHouse/ClickHouse/pull/9542) をリバートし、[#9540](https://github.com/ClickHouse/ClickHouse/issues/9540) を修正します。[#21304](https://github.com/ClickHouse/ClickHouse/pull/21304)（[Amos Bird](https://github.com/amosbird)）。

#### 実験的機能 {#experimental-feature-5}

- `MergeTree*`テーブルに`PROJECTION`サポートを追加しました。[#20202](https://github.com/ClickHouse/ClickHouse/pull/20202) ([Amos Bird](https://github.com/amosbird))。

#### パフォーマンス改善 {#performance-improvement-5}

- `compile_expressions`設定をデフォルトで有効化しました。この設定が有効な場合、単純な関数と演算子の組み合わせは実行時にLLVMによってネイティブコードにコンパイルされます。[#8482](https://github.com/ClickHouse/ClickHouse/pull/8482) ([Maksim Kita](https://github.com/kitaisreal)、[alexey-milovidov](https://github.com/alexey-milovidov))。注意: 問題が発生した場合は、このオプションを無効にしてください。
- `re2`ライブラリを更新しました。正規表現マッチングのパフォーマンスが向上しました。また、このPRはgcc-11との互換性を追加します。[#24196](https://github.com/ClickHouse/ClickHouse/pull/24196) ([Raúl Marín](https://github.com/Algunenano))。
- ORC入力フォーマットをストライプ単位で読み取るように変更しました。これにより、ファイルサイズが大きい場合にテーブル全体を一度にメモリに読み込むことによるメモリコストを削減します。[#23102](https://github.com/ClickHouse/ClickHouse/pull/23102) ([Chao Ma](https://github.com/godliness))。
- クエリ内の集約関数`sum`、`count`、`avg`を単一の集約関数に統合しました。この最適化は`optimize_fuse_sum_count_avg`設定で制御されます。これは新しい集約関数`sumCount`で実装されています。この関数は`sum`と`count`の2つのフィールドを持つタプルを返します。[#21337](https://github.com/ClickHouse/ClickHouse/pull/21337) ([hexiaoting](https://github.com/hexiaoting))。
- `zstd`をv1.5.0に更新しました。圧縮のパフォーマンスが数パーセント向上しました。[#24135](https://github.com/ClickHouse/ClickHouse/pull/24135) ([Raúl Marín](https://github.com/Algunenano))。注意: レプリケーション時に「チェックサムが一致しません」というメッセージが表示される場合があります。これらのメッセージは圧縮アルゴリズムの更新により予期されるものであり、無視して構いません。
- `Buffer`テーブルのパフォーマンスを改善しました: `Buffer`エンジンのtotal_bytes/total_rowsに対してロックを取得しないようにしました。[#24066](https://github.com/ClickHouse/ClickHouse/pull/24066) ([Azat Khuzhin](https://github.com/azat))。
- hashed/sparse_hashed辞書の事前割り当てサポートを復元しました。[#23979](https://github.com/ClickHouse/ClickHouse/pull/23979) ([Azat Khuzhin](https://github.com/azat))。
- `async_socket_for_remote`をデフォルトで有効化しました(大規模なファンアウトを持つDistributedテーブルのクエリ時のスレッド数を削減)。[#23683](https://github.com/ClickHouse/ClickHouse/pull/23683) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。

#### 改善 {#improvement-5}


* MergeTree テーブルファミリーに `_partition_value` 仮想カラムを追加しました。これにより、決定的にパーティションのプルーニングを行うことができます。これは、ミューテーション用のパーティションマッチャーを実装するために必要です。 [#23673](https://github.com/ClickHouse/ClickHouse/pull/23673) ([Amos Bird](https://github.com/amosbird))。
* S3 ストレージおよびディスクに `region` パラメータを追加しました。 [#23846](https://github.com/ClickHouse/ClickHouse/pull/23846) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 異なるログチャネルごとに異なるログレベルを設定できるようにしました。 [#19569](https://github.com/ClickHouse/ClickHouse/issues/19569) をクローズしました。 [#23857](https://github.com/ClickHouse/ClickHouse/pull/23857)（[filimonov](https://github.com/filimonov)）。
* `DateTime` 演算において、タイムゾーンが明示的に指定されていない場合は、デフォルトのタイムゾーン設定を変更せずにそのまま保持します。たとえば、タイムゾーンを持たない `DateTime` 型の値に 1 秒を加算しても、引き続きタイムゾーンなしの `DateTime` のままです。以前のバージョンでは、デフォルトのタイムゾーンの値が戻り値のデータ型に明示的に設定されていたため、DateTime(&#39;something&#39;) のようになっていました。これにより [#4854](https://github.com/ClickHouse/ClickHouse/issues/4854) が解決されます。 [#23392](https://github.com/ClickHouse/ClickHouse/pull/23392) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `MySQL` ストレージでデータベース名の代わりに空文字列を指定できるようにしました。クエリにはデフォルトデータベースが使用されます。以前のバージョンではこれは SELECT クエリでのみ動作していましたが、INSERT もサポートされるようになりました。これにより [#19281](https://github.com/ClickHouse/ClickHouse/issues/19281) がクローズされます。`Sphinx` やその他の MySQL 互換の外部データベースを扱う場合に有用です。[#23319](https://github.com/ClickHouse/ClickHouse/pull/23319) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `quantile(s)TDigest` 関数を修正しました。tdunning/t-digest 3.2+ に従い、単一のセントロイドに対する特別な処理を追加しました。また、アルゴリズムの古いバージョンの実装におけるセントロイドの過剰圧縮に関するバグも修正しました。 [#23314](https://github.com/ClickHouse/ClickHouse/pull/23314) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 関数 `now64` はオプションのタイムゾーン引数をサポートするようになりました。 [#24091](https://github.com/ClickHouse/ClickHouse/pull/24091) ([Vasily Nemkov](https://github.com/Enmk))。
* `clickhouse-client` のインタラクティブモードで、データの途中に進捗バーが表示される際に、ターミナル上の表示データの一部が上書きされてしまう問題を修正しました。これにより [#19283](https://github.com/ClickHouse/ClickHouse/issues/19283) がクローズされます。 [#23050](https://github.com/ClickHouse/ClickHouse/pull/23050) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* simdjson でメモリ割り当てに失敗した場合にクラッシュする問題を修正。[https://github.com/simdjson/simdjson/pull/1567](https://github.com/simdjson/simdjson/pull/1567)。極めてまれなバグであるため、「改善」としてマーク。[#24147](https://github.com/ClickHouse/ClickHouse/pull/24147) ([Amos Bird](https://github.com/amosbird))。
* ストレージのシャットダウンまで辞書を保持します（これにより、`Buffer` エンジンの最終フラッシュ時にサーバーをシャットダウンする際に発生しうる `external dictionary 'DICT' not found` エラーを回避できます）。 [#24068](https://github.com/ClickHouse/ClickHouse/pull/24068) ([Azat Khuzhin](https://github.com/azat)).
* 同一データベース内のテーブルをシャットダウンする前に `Buffer` テーブルをフラッシュして、基盤となるテーブルがすでにデタッチされている場合にブロックが破棄されるのを防ぎます（そうしないと、ログに `Destination table default.a_data_01870 doesn't exist. Block of data is discarded` エラーが記録されます）。[#24067](https://github.com/ClickHouse/ClickHouse/pull/24067)（[Azat Khuzhin](https://github.com/azat)）。
* これにより、`prefer_column_name_to_alias = 1` は `group by`、`having`、`order by` でもカラム名を優先するようになりました。これによって [#23882](https://github.com/ClickHouse/ClickHouse/issues/23882) が修正されました。[#24022](https://github.com/ClickHouse/ClickHouse/pull/24022)（[Amos Bird](https://github.com/amosbird)）。
* `DateTime64` 型での `ORDER BY WITH FILL` のサポートを追加。 [#24016](https://github.com/ClickHouse/ClickHouse/pull/24016) ([kevin wan](https://github.com/MaxWk)).
* `ReplacingMergeTree` で `DateTime64` をバージョン列として指定できるようにしました。 [#23992](https://github.com/ClickHouse/ClickHouse/pull/23992) ([kevin wan](https://github.com/MaxWk)).
* サーバー起動時に OS 名、カーネルバージョン、CPU アーキテクチャの情報をログに記録します。 [#23988](https://github.com/ClickHouse/ClickHouse/pull/23988) ([Azat Khuzhin](https://github.com/azat)).
* `postgresql` 辞書ソースでテーブルスキーマを指定できるようにした。 [#23958](https://github.com/ClickHouse/ClickHouse/issues/23958) をクローズ。 [#23980](https://github.com/ClickHouse/ClickHouse/pull/23980)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `Enum` 要素名に対するヒントを追加（タイポがある場合に候補名を提案）。[#17112](https://github.com/ClickHouse/ClickHouse/issues/17112) を解決。[#23919](https://github.com/ClickHouse/ClickHouse/pull/23919)（[flynn](https://github.com/ucasFL)）。
* 辞書に対して値が見つかった割合（found rate、値が見つかったキーの比率）を測定します（`system.dictionaries` の `found_rate` を参照）。 [#23916](https://github.com/ClickHouse/ClickHouse/pull/23916) ([Azat Khuzhin](https://github.com/azat)).
* テーブル設定 `rabbitmq_queue_settings_list` を介して、特定のキュー設定を追加できるようにしました（[#23737](https://github.com/ClickHouse/ClickHouse/issues/23737) および [#23918](https://github.com/ClickHouse/ClickHouse/issues/23918) をクローズ）。ユーザーが RabbitMQ のセットアップ全体を制御できるようにしました。テーブル設定 `rabbitmq_queue_consume` が `1` に設定されている場合、RabbitMQ テーブルエンジンは指定されたキューにのみ接続し、exchange・キュー・バインディングの宣言など、RabbitMQ のコンシューマ側でのセットアップは一切行いません（[#21757](https://github.com/ClickHouse/ClickHouse/issues/21757) をクローズ）。RabbitMQ テーブルが DROP された際の適切なクリーンアップを追加しました。テーブルが宣言したキューと、そのテーブルによって作成されたすべてのバインドされた exchange を削除します。[#23887](https://github.com/ClickHouse/ClickHouse/pull/23887) ([Kseniia Sumarokova](https://github.com/kssenii))。
* `system.distribution_queue` に `broken_data_files` / `broken_data_compressed_bytes` を追加しました。壊れているとマークされた Distributed テーブルへの非同期挿入用ファイル数を表すメトリクス (`BrokenDistributedFilesToInsert`) を追加しました。 [#23885](https://github.com/ClickHouse/ClickHouse/pull/23885) ([Azat Khuzhin](https://github.com/azat)).
* `system.tables` に対するクエリでは ZooKeeper へアクセスしなくなりました。 [#23793](https://github.com/ClickHouse/ClickHouse/pull/23793) ([Fuwang Hu](https://github.com/fuwhu)).
* `OPTIMIZE` クエリでも `lock_acquire_timeout_for_background_operations` が考慮されるようになりました。 [#23623](https://github.com/ClickHouse/ClickHouse/pull/23623) ([Azat Khuzhin](https://github.com/azat)).
* 新しい `SYSTEM RESTART DISK` SQL コマンドにより、実行時に `S3` ディスク設定を変更することが可能になりました。 [#23429](https://github.com/ClickHouse/ClickHouse/pull/23429) ([Pavel Kovalenko](https://github.com/Jokser)).
* ユーザーが誤って `max_distributed_connections` をゼロに設定してしまった場合、`Distributed` テーブルへのあらゆるクエリは「logical error」を含むメッセージ付きの例外をスローします。しかし、これは実際には想定された動作であり、論理エラーではないため、この例外メッセージはやや不正確でした。また、論理エラーが一切発生しないことを保証するために CI 環境で行っているチェックもトリガーしてしまっていました。今後は、ゼロに誤設定された `max_distributed_connections` は、許容される最小値（1）として扱います。 [#23348](https://github.com/ClickHouse/ClickHouse/pull/23348) ([Azat Khuzhin](https://github.com/azat))。
* デフォルトで `min_bytes_to_use_mmap_io` を無効化しました。[#23322](https://github.com/ClickHouse/ClickHouse/pull/23322)（[Azat Khuzhin](https://github.com/azat)）。
* `join_use_nulls` 使用時に `LowCardinality` の NULL 対応をサポートし、[#15101](https://github.com/ClickHouse/ClickHouse/issues/15101) をクローズ。[#23237](https://github.com/ClickHouse/ClickHouse/pull/23237)（[vdimir](https://github.com/vdimir)）。
* `S3` ディスクで `MergeTree` パーツを `detached` ディレクトリに復元できるようにしました。 [#23112](https://github.com/ClickHouse/ClickHouse/pull/23112) ([Pavel Kovalenko](https://github.com/Jokser)).
* S3 における HTTP 接続切断時のリトライ。 [#22988](https://github.com/ClickHouse/ClickHouse/pull/22988) ([Vladimir Chebotarev](https://github.com/excitoon))。
* MySQL テーブルエンジン、辞書ソース、および MaterializeMySQL による少量データの取得向けに、設定 `external_storage_max_read_rows` と `external_storage_max_read_rows` を追加しました。 [#22697](https://github.com/ClickHouse/ClickHouse/pull/22697) ([TCeason](https://github.com/TCeason)).
* `MaterializeMySQL`（実験的機能）：以前は、SQL の非互換性により MySQL 5.7.9 はサポートされていませんでした。現在では、MySQL パラメータの検証を MaterializeMySQL 側に任せるようになりました。 [#23413](https://github.com/ClickHouse/ClickHouse/pull/23413) ([TCeason](https://github.com/TCeason))。
* 分散テーブルでサブカラムの読み取りを可能にしました。[#24472](https://github.com/ClickHouse/ClickHouse/pull/24472)（[Anton Popov](https://github.com/CurtizJ)）。
* `CREATE .. AS SELECT` クエリにおけるタプルの扱いを修正しました。 [#24464](https://github.com/ClickHouse/ClickHouse/pull/24464) ([Anton Popov](https://github.com/CurtizJ)).
* `Kafka` テーブルで `Parquet` 形式をサポート。 [#23412](https://github.com/ClickHouse/ClickHouse/pull/23412) ([Chao Ma](https://github.com/godliness))。

#### バグ修正 {#bug-fix-4}


* パーティションキーおよびプライマリキーで使用されている場合、旧バージョンの modulo 関数を使用するようにしました。[#23508](https://github.com/ClickHouse/ClickHouse/issues/23508) をクローズ。[#24157](https://github.com/ClickHouse/ClickHouse/pull/24157)（[Kseniia Sumarokova](https://github.com/kssenii)）。これは以前のリリースにおける後方互換性の欠如の原因となっていました。
* `SYSTEM RESTART REPLICA` または `SYSTEM SYNC REPLICA` クエリが無限に処理され続けてしまう挙動を修正しました。これは、RAM 容量が極端に小さいサーバーで検出されました。[#24457](https://github.com/ClickHouse/ClickHouse/pull/24457) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* `toWeek` 関数の誤った単調性を修正しました。これにより [#24422](https://github.com/ClickHouse/ClickHouse/issues/24422) が修正されます。このバグは [#5212](https://github.com/ClickHouse/ClickHouse/pull/5212) で導入され、その後、より高度なパーティションプルーナーによって顕在化しました。[#24446](https://github.com/ClickHouse/ClickHouse/pull/24446) ([Amos Bird](https://github.com/amosbird))。
* 偽パーツが交差している状態での `DROP PARTITION` を修正しました。まれなケースとして、現在のブロック番号より大きいミューテーションバージョンを持つパーツが存在している場合がありました。 [#24321](https://github.com/ClickHouse/ClickHouse/pull/24321) ([Amos Bird](https://github.com/amosbird))。
* `Ordinary` データベースから `Atomic` データベースへマテリアライズドビューを移動する（`RENAME TABLE` クエリ）際のバグを修正しました。これにより、マテリアライズドビューとともに内部テーブルも新しいデータベースへ移動されるようになりました。[#23926](https://github.com/ClickHouse/ClickHouse/issues/23926) の問題を修正します。[#24309](https://github.com/ClickHouse/ClickHouse/pull/24309) ([tavplubix](https://github.com/tavplubix))。
* クライアントリクエストで空の HTTP ヘッダーを許可します。 [#23901](https://github.com/ClickHouse/ClickHouse/issues/23901) を修正。 [#24285](https://github.com/ClickHouse/ClickHouse/pull/24285)（[Ivan](https://github.com/abyss7)）。
* `Memory` テーブルでのミューテーション失敗を解消するために `max_threads = 1` を設定。 [#24274](https://github.com/ClickHouse/ClickHouse/issues/24274) をクローズ。 [#24275](https://github.com/ClickHouse/ClickHouse/pull/24275)（[flynn](https://github.com/ucasFL)）。
* `Memory` テーブルの実装におけるタイポを修正。このバグは [#15127](https://github.com/ClickHouse/ClickHouse/issues/15127) で導入されたもの。 [#24192](https://github.com/ClickHouse/ClickHouse/issues/24192) をクローズ。 [#24193](https://github.com/ClickHouse/ClickHouse/pull/24193)（[张中南](https://github.com/plugine)）。
* クエリ実行中に `HDFS` がアクセス不能になった場合にサーバーが異常終了する問題を修正しました。[#24117](https://github.com/ClickHouse/ClickHouse/issues/24117) をクローズ。[#24191](https://github.com/ClickHouse/ClickHouse/pull/24191)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* 定数条件で `Nested` カラムを更新した際に発生するクラッシュを修正。 [#24183](https://github.com/ClickHouse/ClickHouse/pull/24183) ([hexiaoting](https://github.com/hexiaoting)).
* 高負荷時に RBAC で発生しうるレースコンディションを修正しました。この PR では [#24090](https://github.com/ClickHouse/ClickHouse/issues/24090)、[#24134](https://github.com/ClickHouse/ClickHouse/issues/24134)、[#24176](https://github.com/ClickHouse/ClickHouse/pull/24176) の問題を修正しています（[Vitaly Baranov](https://github.com/vitlibar)）。
* 書き込みリクエスト（insert/alter/その他）を受け付けてしまう、部分的に初期化されたテーブルが発生し得るまれなバグを修正しました。これらのテーブルは、現在では読み取り専用モードになります。 [#24122](https://github.com/ClickHouse/ClickHouse/pull/24122) ([alesapin](https://github.com/alesapin))。
* 不具合修正: `SELECT xxx FINAL` を含む `EXPLAIN PIPELINE` で誤ったパイプラインが表示される問題を修正しました。 ([hexiaoting](https://github.com/hexiaoting))
* `WHERE` 句での定数の `DateTime` 値と `DateTime64` 列の比較を修正しました。 [#24100](https://github.com/ClickHouse/ClickHouse/pull/24100) ([Vasily Nemkov](https://github.com/Enmk)).
* merge JOIN でのクラッシュを修正し、[#24010](https://github.com/ClickHouse/ClickHouse/issues/24010) をクローズ。 [#24013](https://github.com/ClickHouse/ClickHouse/pull/24013) ([vdimir](https://github.com/vdimir)).
* 一部の `ALTER PARTITION` クエリで、レプリケーションキューに `Part A intersects previous part B` および `Unexpected merged part C intersecting drop range D` というエラーが発生することがありました。この問題を修正しました。[#23296](https://github.com/ClickHouse/ClickHouse/issues/23296) を修正しました。[#23997](https://github.com/ClickHouse/ClickHouse/pull/23997)（[tavplubix](https://github.com/tavplubix)）。
* 外部 GROUP BY およびオーバーフロー行で発生する SIGSEGV を修正しました（`SELECT FROM GROUP BY WITH TOTALS SETTINGS max_bytes_before_external_group_by>0, max_rows_to_group_by>0, group_by_overflow_mode='any', totals_mode='before_having'` といったクエリ）。[#23962](https://github.com/ClickHouse/ClickHouse/pull/23962)（[Azat Khuzhin](https://github.com/azat)）。
* ソースに重複がある `CACHE` 辞書に対するキー関連メトリクスの計上方法を修正（`DictCacheKeysRequestedMiss` がオーバーフローする問題を解消）。[#23929](https://github.com/ClickHouse/ClickHouse/pull/23929)（[Azat Khuzhin](https://github.com/azat)）。
* `PostgreSQL` エンジンのコネクションプール実装を修正。[#23897](https://github.com/ClickHouse/ClickHouse/issues/23897) をクローズ。[#23909](https://github.com/ClickHouse/ClickHouse/pull/23909)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `GROUP BY` と通常の関数でラップされた集約関数を組み合わせた場合の `distributed_group_by_no_merge = 2` の挙動を修正しました（[#23546](https://github.com/ClickHouse/ClickHouse/issues/23546) で不具合が発生していました）。`distributed_group_by_no_merge = 2` をウィンドウ関数と併用しようとした場合には例外をスローするようにしました。ウィンドウ関数を含むクエリでは `optimize_distributed_group_by_sharding_key` を無効化しました。[#23906](https://github.com/ClickHouse/ClickHouse/pull/23906)（[Azat Khuzhin](https://github.com/azat)）。
* `s3` テーブル関数の修正: HTTP エラーのより適切な処理。以前は HTTP エラーのレスポンスボディが無視されていました。[#23844](https://github.com/ClickHouse/ClickHouse/pull/23844) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `s3` テーブル関数の修正: URI の扱いを改善しました。`+` 記号を含む URL との非互換性を修正し、そのようなキーを持つデータをこれまでは読み取れなかった問題を解消しました。 [#23822](https://github.com/ClickHouse/ClickHouse/pull/23822) ([Vladimir Chebotarev](https://github.com/excitoon))。
* `GLOBAL IN/JOIN` と `use_hedged_requests` を併用するクエリで発生していた `Can't initialize pipeline with empty pipe` エラーを修正しました。 [#23431](https://github.com/ClickHouse/ClickHouse/issues/23431) を修正。 [#23805](https://github.com/ClickHouse/ClickHouse/pull/23805) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* マテリアライズドビューから参照されている場合に `CLEAR COLUMN` が動作しない問題を修正。[#23764](https://github.com/ClickHouse/ClickHouse/issues/23764) をクローズ。[#23781](https://github.com/ClickHouse/ClickHouse/pull/23781) ([flynn](https://github.com/ucasFL))。
* HDFS からの読み込み時に `Values` フォーマットを使用している場合に発生する解放後のヒープ使用を修正。 [#23761](https://github.com/ClickHouse/ClickHouse/pull/23761) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Distributed への INSERT 時に、(何らかの例外が発生した場合に) 発生する可能性のある「Cannot schedule a task」エラーを回避しました。 [#23744](https://github.com/ClickHouse/ClickHouse/pull/23744) ([Azat Khuzhin](https://github.com/azat)).
* 停止していた `ReplicatedMergeTree` レプリカの復旧処理におけるバグを修正しました。レプリカのダウンタイム中に `ALTER` クエリが実行された場合、一部のメタデータ更新が停止していたレプリカによって無視されてしまう可能性がありました。 [#23742](https://github.com/ClickHouse/ClickHouse/pull/23742) ([tavplubix](https://github.com/tavplubix)).
* `Join` と `WITH TOTALS` に関するバグを修正し、[#17718](https://github.com/ClickHouse/ClickHouse/issues/17718) をクローズ。[#23549](https://github.com/ClickHouse/ClickHouse/pull/23549)（[vdimir](https://github.com/vdimir)）。
* `UNION` を含むクエリに対して、フィルタープッシュダウン最適化の後に発生する可能性があった `Block structure mismatch` エラーを修正。[#23029](https://github.com/ClickHouse/ClickHouse/issues/23029) を修正。[#23359](https://github.com/ClickHouse/ClickHouse/pull/23359)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 設定 `optimize_skip_unused_shards_rewrite_in` が有効な場合に型変換を追加します。これにより、MSan で報告されていた問題が修正されます。 [#23219](https://github.com/ClickHouse/ClickHouse/pull/23219) ([Azat Khuzhin](https://github.com/azat))。
* ネストされたサブカラムを更新する際に不足していたチェックを追加し、issue [#22353](https://github.com/ClickHouse/ClickHouse/issues/22353) をクローズ。 [#22503](https://github.com/ClickHouse/ClickHouse/pull/22503)（[hexiaoting](https://github.com/hexiaoting)）。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-5}

- Illumosでのビルドをサポート。[#24144](https://github.com/ClickHouse/ClickHouse/pull/24144)。Solaris派生オペレーティングシステムでのビルドサポートを追加。[#23746](https://github.com/ClickHouse/ClickHouse/pull/23746) ([bnaecker](https://github.com/bnaecker))。
- ハッシュテーブルのベンチマークを追加。GoogleのSwiss Tableを含む(当社の特定の使用シナリオではClickHouseハッシュマップより遅いことが判明)。[#24111](https://github.com/ClickHouse/ClickHouse/pull/24111) ([Maksim Kita](https://github.com/kitaisreal))。
- librdkafkaを1.6.0-RC3から1.6.1に更新。[#23874](https://github.com/ClickHouse/ClickHouse/pull/23874) ([filimonov](https://github.com/filimonov))。
- `asynchronous-unwind-tables`を常に明示的に有効化。AArch64でのクエリプロファイラの問題を修正する可能性がある。[#23602](https://github.com/ClickHouse/ClickHouse/pull/23602) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ロケールとファイルシステムの順序に対するビルド依存性を回避。これにより再現可能なビルドが可能になる。[#23600](https://github.com/ClickHouse/ClickHouse/pull/23600) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ビルドから非決定性の原因を除去。異なる時点でのビルドがバイト単位で同一のバイナリを生成するようになった。[#22113](https://github.com/ClickHouse/ClickHouse/issues/22113)を部分的に対処。[#23559](https://github.com/ClickHouse/ClickHouse/pull/23559) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- (Zoo)Keeperのベンチマーク用シンプルツールを追加。[#23038](https://github.com/ClickHouse/ClickHouse/pull/23038) ([alesapin](https://github.com/alesapin))。


## ClickHouseリリース21.5、2021-05-20 {#clickhouse-release-215-2021-05-20}

#### 後方互換性のない変更 {#backward-incompatible-change-6}

- 整数が浮動小数点データ型で正確に表現できない場合の、整数と浮動小数点数の比較を変更しました。新しいバージョンでは、丸め誤差が発生するため比較はfalseを返します。例:`9223372036854775808.0 != 9223372036854775808`。これは、数値`9223372036854775808`が浮動小数点数として正確に表現できないためです(`9223372036854775808.0`は`9223372036854776000.0`に丸められます)。しかし、以前のバージョンでは、浮動小数点数`9223372036854776000.0`をUInt64に変換すると`9223372036854775808`になるため、比較は数値が等しいとして返されていました。参考までに、Pythonプログラミング言語もこれらの数値を等しいものとして扱います。しかし、この動作はCPUモデルに依存していた(範囲外の一部の数値についてAMD64とAArch64で異なる結果)ため、比較をより正確にしました。整数が浮動小数点型で正確に表現される場合にのみ、整数と浮動小数点数を等しいものとして扱います。[#22595](https://github.com/ClickHouse/ClickHouse/pull/22595) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 単一の`Tuple`引数に対する`argMin`と`argMax`のサポートを削除しました。コードはメモリセーフではありませんでした。この機能は誤って追加されたものであり、ユーザーにとって混乱を招くものでした。これらの関数は後で異なる名前で再導入される可能性があります。これにより[#22384](https://github.com/ClickHouse/ClickHouse/issues/22384)が修正され、[#17359](https://github.com/ClickHouse/ClickHouse/issues/17359)が取り消されます。[#23393](https://github.com/ClickHouse/ClickHouse/pull/23393) ([alexey-milovidov](https://github.com/alexey-milovidov))。

#### 新機能 {#new-feature-6}

- 関数`dictGetChildren(dictionary, key)`、`dictGetDescendants(dictionary, key, level)`を追加しました。関数`dictGetChildren`はすべての子をインデックスの配列として返します。これは`dictGetHierarchy`の逆変換です。関数`dictGetDescendants`は、`dictGetChildren`を`level`回再帰的に適用した場合と同様にすべての子孫を返します。`level`値がゼロの場合は無限大と同等です。`dictGetHierarchy`、`dictIsIn`関数のパフォーマンスを改善しました。[#14656](https://github.com/ClickHouse/ClickHouse/issues/14656)をクローズします。[#22096](https://github.com/ClickHouse/ClickHouse/pull/22096) ([Maksim Kita](https://github.com/kitaisreal))。
- 関数`dictGetOrNull`を追加しました。`dictGet`と同様に動作しますが、辞書内にキーが見つからなかった場合は`Null`を返します。[#22375](https://github.com/ClickHouse/ClickHouse/issues/22375)をクローズします。[#22413](https://github.com/ClickHouse/ClickHouse/pull/22413) ([Maksim Kita](https://github.com/kitaisreal))。
- テーブル関数`s3Cluster`を追加しました。これにより、指定されたクラスタのすべてのノードで`s3`からのファイルを並列処理できます。[#22012](https://github.com/ClickHouse/ClickHouse/pull/22012) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- MySQL/PostgreSQLテーブルエンジン/テーブル関数でレプリカとシャードのサポートを追加しました。`SELECT * FROM mysql('host{1,2}-{1|2}', ...)`のように記述できます。[#20969](https://github.com/ClickHouse/ClickHouse/issues/20969)をクローズします。[#22217](https://github.com/ClickHouse/ClickHouse/pull/22217) ([Kseniia Sumarokova](https://github.com/kssenii))。
- `ALTER TABLE ... FETCH PART ...`クエリを追加しました。`FETCH PARTITION`と似ていますが、1つのパートのみを取得します。[#22706](https://github.com/ClickHouse/ClickHouse/pull/22706) ([turbo jason](https://github.com/songenjie))。
- `Distributed`テーブルへの再帰クエリの深さを制限する設定`max_distributed_depth`を追加しました。[#20229](https://github.com/ClickHouse/ClickHouse/issues/20229)をクローズします。[#21942](https://github.com/ClickHouse/ClickHouse/pull/21942) ([flynn](https://github.com/ucasFL))。


#### パフォーマンス改善 {#performance-improvement-6}

- AVX2の動的ディスパッチにより`intDiv`のパフォーマンスを改善しました。これにより[#22314](https://github.com/ClickHouse/ClickHouse/issues/22314)が解決されます。[#23000](https://github.com/ClickHouse/ClickHouse/pull/23000) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ローカルファイル以外のソース(例:URL)からの`ArrowStream`入力フォーマットの読み取りパフォーマンスを改善しました。[#22673](https://github.com/ClickHouse/ClickHouse/pull/22673) ([nvartolomei](https://github.com/nvartolomei))。
- ネイティブプロトコル経由でlocalhost(clickhouse-clientまたは分散クエリによるサーバー間通信)とやり取りする際、デフォルトで圧縮を無効化しました。これにより一部のインポート/エクスポート操作のパフォーマンスが向上する可能性があります。これにより[#22234](https://github.com/ClickHouse/ClickHouse/issues/22234)が解決されます。[#22237](https://github.com/ClickHouse/ClickHouse/pull/22237) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 分散クエリのIN句の右辺から、シャードに属さない値を除外するようにしました(`optimize_skip_unused_shards_rewrite_in`の下で、デフォルトで有効化されていますが、`optimize_skip_unused_shards`が依然として必要です)。[#21511](https://github.com/ClickHouse/ClickHouse/pull/21511) ([Azat Khuzhin](https://github.com/azat))。
- ファイル型テーブルエンジンおよびParquet、Arrow、ORCなどのカラム指向フォーマットにおいて、カラムのサブセットを読み取る際のパフォーマンスを改善しました。これにより[#issue:20129](https://github.com/ClickHouse/ClickHouse/issues/20129)が解決されます。[#21302](https://github.com/ClickHouse/ClickHouse/pull/21302) ([keenwolf](https://github.com/keen-wolf))。
- バージョン21.1以前のように、より多くの条件を`PREWHERE`に移動できるようにしました(内部ヒューリスティックの調整)。移動される条件が不十分な場合、パフォーマンスが低下する可能性がありました。[#23397](https://github.com/ClickHouse/ClickHouse/pull/23397) ([Anton Popov](https://github.com/CurtizJ))。
- ODBC接続のパフォーマンスを改善し、バックログにあったすべての未解決の問題を修正しました。`Poco::ODBC`の代わりに`nanodbc`ライブラリを使用しています。[#9678](https://github.com/ClickHouse/ClickHouse/issues/9678)が解決されます。ODBCテーブルエンジンにDateTime64とDecimal\*のサポートを追加しました。[#21961](https://github.com/ClickHouse/ClickHouse/issues/21961)が解決されます。キリル文字のテキストが切り捨てられる問題を修正しました。[#16246](https://github.com/ClickHouse/ClickHouse/issues/16246)が解決されます。ODBCブリッジ用の接続プールを追加しました。[#21972](https://github.com/ClickHouse/ClickHouse/pull/21972) ([Kseniia Sumarokova](https://github.com/kssenii))。

#### 改善 {#improvement-6}


* HTTP インターフェイスにおける URL の最大サイズを表す `max_uri_size` のデフォルト値を、1 MiB に引き上げました。これにより [#21197](https://github.com/ClickHouse/ClickHouse/issues/21197) が解決されました。 [#22997](https://github.com/ClickHouse/ClickHouse/pull/22997) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `background_fetches_pool_size` を `8` に設定します。これは、少量の挿入が頻繁に行われるプロダクション環境や ZooKeeper クラスターが遅い場合に、より適した値です。[#22945](https://github.com/ClickHouse/ClickHouse/pull/22945)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* FlatDictionary に `initial_array_size`、`max_array_size` オプションが追加されました。 [#22521](https://github.com/ClickHouse/ClickHouse/pull/22521) ([Maksim Kita](https://github.com/kitaisreal)).
* 非レプリケートな MergeTree への挿入の重複排除用に、新しい設定 `non_replicated_deduplication_window` を追加。 [#22514](https://github.com/ClickHouse/ClickHouse/pull/22514) ([alesapin](https://github.com/alesapin))。
* config リロード時に `CatBoost` モデルの設定ファイルへのパスを更新しました。 [#22434](https://github.com/ClickHouse/ClickHouse/pull/22434) ([Kruglov Pavel](https://github.com/Avogar))。
* 辞書で `Decimal256` 型をサポートしました。`Decimal256` は実験的な機能です。[#20979](https://github.com/ClickHouse/ClickHouse/issues/20979) をクローズしました。[#22960](https://github.com/ClickHouse/ClickHouse/pull/22960)（[Maksim Kita](https://github.com/kitaisreal)）。
* `async_socket_for_remote` をデフォルトで有効化しました（分散クエリで使用する OS スレッド数を削減）。[#23683](https://github.com/ClickHouse/ClickHouse/pull/23683)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `quantile(s)TDigest` を修正しました。tdunning/t-digest 3.2+ に従い、単一のセントロイドに対する特別な処理を追加しました。また、アルゴリズムの以前のバージョンの実装でセントロイドを過度に圧縮してしまうバグも修正しました。 [#23314](https://github.com/ClickHouse/ClickHouse/pull/23314) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 関数名 `unhex` を MySQL との互換性のため、大文字小文字を区別しないようにしました。 [#23229](https://github.com/ClickHouse/ClickHouse/pull/23229) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 配列要素の型が異なる汎用的なケースに対して、関数 `arrayHasAny`、`arrayHasAll`、`has`、`indexOf`、`countEqual` を実装しました。以前のバージョンでは、関数 `arrayHasAny`、`arrayHasAll` は false を返し、`has`、`indexOf`、`countEqual` は例外をスローしていました。また、`has` および類似の関数で `Decimal` と大きな整数型のサポートも追加しました。これにより [#20272](https://github.com/ClickHouse/ClickHouse/issues/20272) が解決しました。 [#23044](https://github.com/ClickHouse/ClickHouse/pull/23044) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 関数 `extractAllGroupsHorizontal` の結果におけるマッチ数の最大値のしきい値を引き上げました。 [#23036](https://github.com/ClickHouse/ClickHouse/pull/23036) ([Vasily Nemkov](https://github.com/Enmk)).
* 単一ノードのクラスターでは `optimize_skip_unused_shards` を実行しないようにしました。 [#22999](https://github.com/ClickHouse/ClickHouse/pull/22999) ([Azat Khuzhin](https://github.com/azat)).
* SSL を使用して clickhouse-keeper（ZooKeeper の実験的なドロップイン代替）を実行できるようになりました。`keeper_server.tcp_port_secure` 設定を使用すると、クライアントと keeper-server 間のセキュアな通信を行うことができます。`keeper_server.raft_configuration.secure` を使用すると、ノード間の内部セキュア通信を有効にできます。 [#22992](https://github.com/ClickHouse/ClickHouse/pull/22992) ([alesapin](https://github.com/alesapin))。
* `Buffer` テーブルに対して、バックグラウンドでのみバッファをフラッシュできるようにしました。 [#22986](https://github.com/ClickHouse/ClickHouse/pull/22986) ([Azat Khuzhin](https://github.com/azat)).
* WHERE 句で `NULL` を含む条件を使用して MergeTree テーブルを `SELECT` した際、まれに例外がスローされることがありました。この問題を修正しました [#20019](https://github.com/ClickHouse/ClickHouse/issues/20019)。[#22978](https://github.com/ClickHouse/ClickHouse/pull/22978) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* AWS 用 Poco HTTP クライアントのエラー処理を修正。 [#22973](https://github.com/ClickHouse/ClickHouse/pull/22973) ([kreuzerkrieg](https://github.com/kreuzerkrieg)).
* `ReplicatedMergeTree` で `max_part_removal_threads` が尊重されるようにしました。 [#22971](https://github.com/ClickHouse/ClickHouse/pull/22971) ([Azat Khuzhin](https://github.com/azat))。
* MergeTree の設定 `inactive_parts_to_throw_insert = 0` と `inactive_parts_to_delay_insert &gt; 0` の組み合わせにおける、分かりづらい稀なコーナーケースの問題を修正。 [#22947](https://github.com/ClickHouse/ClickHouse/pull/22947) ([Azat Khuzhin](https://github.com/azat)).
* `dateDiff` は `DateTime64` 型の引数でも動作するようになりました（`DateTime` の範囲外の値に対しても機能します）[#22931](https://github.com/ClickHouse/ClickHouse/pull/22931)（[Vasily Nemkov](https://github.com/Enmk)）。
* MaterializeMySQL（実験的機能）：ビューを含む MySQL データベースをエラーなくレプリケートできるようになりました。これはビューを無視することで実現しています。 [#22760](https://github.com/ClickHouse/ClickHouse/pull/22760) ([Christian](https://github.com/cfroystad))。
* PostgreSQL プロトコル経由で RBAC の行ポリシーを利用可能にしました。[#22658](https://github.com/ClickHouse/ClickHouse/issues/22658) をクローズ。PostgreSQL プロトコルは設定でデフォルト有効になっています。[#22755](https://github.com/ClickHouse/ClickHouse/pull/22755)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* Buffer レイヤーロック待機時間を計測するメトリクスを追加。 [#22725](https://github.com/ClickHouse/ClickHouse/pull/22725) ([Azat Khuzhin](https://github.com/azat)).
* VIEW 定義内で CTE を使用できるようにしました。これにより [#22491](https://github.com/ClickHouse/ClickHouse/issues/22491) が解決されました。[#22657](https://github.com/ClickHouse/ClickHouse/pull/22657)（[Amos Bird](https://github.com/amosbird)）。
* 前のプログラムが端末にゴミを残した場合に備えて、`clickhouse-client` で画面の残りを消去し、カーソルを表示するようにしました。これにより、[#16518](https://github.com/ClickHouse/ClickHouse/issues/16518) がクローズされました。[#22634](https://github.com/ClickHouse/ClickHouse/pull/22634)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `round` 関数が x86&#95;64 以外のプラットフォームでも一貫して動作するようにしました。最近接偶数への丸め（Banker&#39;s rounding）を使用します。 [#22582](https://github.com/ClickHouse/ClickHouse/pull/22582) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* Distributed テーブルから送信されるデータブロックの構造を正しく検証するようにしました。 [#22325](https://github.com/ClickHouse/ClickHouse/pull/22325) ([Azat Khuzhin](https://github.com/azat)).
* `kafka_handle_error_mode` 設定で制御される Kafka エラーを、Kafka エンジンの仮想カラムへ出力できるようにしました。 [#21850](https://github.com/ClickHouse/ClickHouse/pull/21850) ([fastio](https://github.com/fastio)).
* `visitParam/visitParamExtract{UInt, Int, Bool, Float, Raw, String}` に `simpleJSONExtract/simpleJSONHas` のエイリアスを追加。 [#21383](https://github.com/ClickHouse/ClickHouse/issues/21383) を修正。 [#21519](https://github.com/ClickHouse/ClickHouse/pull/21519)（[fastio](https://github.com/fastio)）。
* ライブラリ辞書ソース用として `clickhouse-library-bridge` を追加。[#9502](https://github.com/ClickHouse/ClickHouse/issues/9502) をクローズ。[#21509](https://github.com/ClickHouse/ClickHouse/pull/21509)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* マテリアライズドビューから参照されている列の削除（`DROP`）を禁止。 [#21164](https://github.com/ClickHouse/ClickHouse/issues/21164) を解決。 [#21303](https://github.com/ClickHouse/ClickHouse/pull/21303)（[flynn](https://github.com/ucasFL)）。
* 動的なサーバー間認証情報をサポートし、ダウンタイムなしで認証情報をローテーション可能に。 [#14113](https://github.com/ClickHouse/ClickHouse/pull/14113) ([johnskopis](https://github.com/johnskopis)).
* `Arrow` および `ArrowStream` フォーマットのメッセージに対応する Kafka ストレージのサポートを追加。 [#23415](https://github.com/ClickHouse/ClickHouse/pull/23415) ([Chao Ma](https://github.com/godliness)).
* 例外メッセージ内で欠けていたセミコロンを修正しました。ユーザーはこの例外メッセージを読んで不快に感じる可能性があります。 [#23208](https://github.com/ClickHouse/ClickHouse/pull/23208) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `LowCardinality` 型に関する一部の例外メッセージで不足していた空白を修正しました。 [#23207](https://github.com/ClickHouse/ClickHouse/pull/23207) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 一部の値が `Markdown` 形式のテーブルセル内で中央揃えでフォーマットされていましたが、現在はそのようにはなりません。[#23096](https://github.com/ClickHouse/ClickHouse/pull/23096)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* clickhouse-client の補完候補から不要な詳細情報を削除。これにより [#22158](https://github.com/ClickHouse/ClickHouse/issues/22158) をクローズ。 [#23040](https://github.com/ClickHouse/ClickHouse/pull/23040) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* sparse&#95;hashed 辞書に対する `system.dictionaries` テーブルの `bytes_allocated` フィールドの計算を修正しました。 [#22867](https://github.com/ClickHouse/ClickHouse/pull/22867) ([Azat Khuzhin](https://github.com/azat)).
* MergeTree からの逆方向読み込みを考慮した概算総行数の計算を修正。 [#22726](https://github.com/ClickHouse/ClickHouse/pull/22726) ([Azat Khuzhin](https://github.com/azat)).
* `clickhouse` ソースを使用する辞書が自分自身を参照するように構成できてしまい、無限ループを引き起こす問題を修正しました。 [#14314](https://github.com/ClickHouse/ClickHouse/issues/14314) をクローズ。 [#22479](https://github.com/ClickHouse/ClickHouse/pull/22479)（[Maksim Kita](https://github.com/kitaisreal)）。

#### バグ修正 {#bug-fix-5}


* 複数の hedged request に関する修正を行いました。設定 `use_hedged_requests` が有効な場合に、`GLOBAL IN/JOIN` を含むクエリで発生していたエラー `Can't initialize pipeline with empty pipe` を修正しました。これにより [#23431](https://github.com/ClickHouse/ClickHouse/issues/23431) の問題が解決されています。[#23805](https://github.com/ClickHouse/ClickHouse/pull/23805)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。クラッシュを引き起こす hedged connection における race condition を修正しました。これにより [#22161](https://github.com/ClickHouse/ClickHouse/issues/22161) の問題が解決されています。[#22443](https://github.com/ClickHouse/ClickHouse/pull/22443)（[Kruglov Pavel](https://github.com/Avogar)）。`async_socket_for_remote` が有効な状態で、リモートクエリから `unknown packet` を受信した場合に発生し得るクラッシュを修正しました。これにより [#21167](https://github.com/ClickHouse/ClickHouse/issues/21167) の問題が解決されています。[#23309](https://github.com/ClickHouse/ClickHouse/pull/23309)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `input_format_with_names_use_header` 設定を無効化した際に、CSVWithNames 形式の入力がすべて破棄されてしまう問題を修正しました。これにより [#22406](https://github.com/ClickHouse/ClickHouse/issues/22406) が解決されました。 [#23202](https://github.com/ClickHouse/ClickHouse/pull/23202) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* リモート JDBC ブリッジにおけるタイムアウト時の接続問題を修正しました。[#9609](https://github.com/ClickHouse/ClickHouse/issues/9609) をクローズしました。 [#23771](https://github.com/ClickHouse/ClickHouse/pull/23771)（[Maksim Kita](https://github.com/kitaisreal)、[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `update_field` が指定されている場合の `complex_key_hashed` の初回ロード時ロジックを修正しました。 [#23800](https://github.com/ClickHouse/ClickHouse/issues/23800) をクローズ。 [#23824](https://github.com/ClickHouse/ClickHouse/pull/23824)（[Maksim Kita](https://github.com/kitaisreal)）。
* `PREWHERE` と行ポリシーフィルタが同時に有効で、結果が空の場合に発生していたクラッシュを修正しました。[#23763](https://github.com/ClickHouse/ClickHouse/pull/23763) ([Amos Bird](https://github.com/amosbird)).
* Distributed への INSERT 時に、例外発生時に起こりうる &quot;Cannot schedule a task&quot; エラーを回避。 [#23744](https://github.com/ClickHouse/ClickHouse/pull/23744) ([Azat Khuzhin](https://github.com/azat)).
* 集約関数 `mannWhitneyUTest` に、両方のサンプルの値がすべて同一である場合にスローされる例外を追加しました。これにより [#23646](https://github.com/ClickHouse/ClickHouse/issues/23646) が修正されました。[#23654](https://github.com/ClickHouse/ClickHouse/pull/23654)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* HTTP を通じてデータを挿入する際にサーバーフォールトが発生していた問題を修正しました。これにより [#23512](https://github.com/ClickHouse/ClickHouse/issues/23512) が修正されます。[#23643](https://github.com/ClickHouse/ClickHouse/pull/23643)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* エスケープシーケンスを含む一部の `LIKE` 式が誤って解釈される問題を修正しました。 [#23610](https://github.com/ClickHouse/ClickHouse/pull/23610) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 再起動 / 停止コマンドがハングする問題を修正しました。[#20214](https://github.com/ClickHouse/ClickHouse/issues/20214) をクローズしました。[#23552](https://github.com/ClickHouse/ClickHouse/pull/23552)（[filimonov](https://github.com/filimonov)）。
* 複数の JOIN を含む SELECT クエリにおける `COLUMNS` マッチャーを修正しました。 [#22736](https://github.com/ClickHouse/ClickHouse/issues/22736) をクローズしました。 [#23501](https://github.com/ClickHouse/ClickHouse/pull/23501)（[Maksim Kita](https://github.com/kitaisreal)）。
* `ReplacingMergeTree` のパラメータとして列自身が使用されている場合に、その列のデフォルト値を変更するとクラッシュする問題を修正しました。 [#23483](https://github.com/ClickHouse/ClickHouse/pull/23483) ([hexiaoting](https://github.com/hexiaoting)).
* `ReplacingMergeTree` における垂直マージのいくつかのコーナーケースを修正しました。まれに、`Incomplete granules are not allowed while blocks are granules size` のような例外とともにマージが失敗する原因となることがありました。 [#23459](https://github.com/ClickHouse/ClickHouse/pull/23459) ([Anton Popov](https://github.com/CurtizJ)).
* 空の配列リテラルから、次元が 1 より大きい配列（例: `CAST([] AS Array(Array(String)))`）へのキャストができないバグを修正しました。 [#14476](https://github.com/ClickHouse/ClickHouse/issues/14476) をクローズしました。 [#23456](https://github.com/ClickHouse/ClickHouse/pull/23456)（[Maksim Kita](https://github.com/kitaisreal)）。
* `deltaSum` 集約関数がカウンタをリセットした後に誤った結果を返してしまうバグを修正しました。 [#23437](https://github.com/ClickHouse/ClickHouse/pull/23437) ([Russ Frank](https://github.com/rf))。
* マルチディスク構成での ReplicatedMergeTree テーブルの作成が失敗した場合に発生していた `Cannot unlink file` エラーを修正しました。これにより [#21755](https://github.com/ClickHouse/ClickHouse/issues/21755) が解決されます。 [#23433](https://github.com/ClickHouse/ClickHouse/pull/23433) ([tavplubix](https://github.com/tavplubix))。
* 仮想カラムに基づくパーティションプルーニング時に生成される非互換な定数式を修正しました。これにより、[https://github.com/ClickHouse/ClickHouse/pull/21401#discussion&#95;r611888913](https://github.com/ClickHouse/ClickHouse/pull/21401#discussion_r611888913) の問題が解決されました。 [#23366](https://github.com/ClickHouse/ClickHouse/pull/23366) ([Amos Bird](https://github.com/amosbird))。
* `join_algorithm` が &#39;auto&#39; に設定されていて、Join を Dictionary と実行する場合に発生していたクラッシュを修正しました。[#23002](https://github.com/ClickHouse/ClickHouse/issues/23002) をクローズしました。 [#23312](https://github.com/ClickHouse/ClickHouse/pull/23312) ([Vladimir](https://github.com/vdimir)).
* パーティションプルーニングにおいて `NOT` 条件を緩めないようにしました。これにより [#23305](https://github.com/ClickHouse/ClickHouse/issues/23305) および [#21539](https://github.com/ClickHouse/ClickHouse/issues/21539) が修正されました。 [#23310](https://github.com/ClickHouse/ClickHouse/pull/23310)（[Amos Bird](https://github.com/amosbird)）。
* 古いブロックのバックグラウンドクリーンアップ処理中に、ごくまれに発生するレースコンディションを修正しました。この不具合により、重複排除ウィンドウの末尾付近にあるブロックが重複排除されない可能性がありました。 [#23301](https://github.com/ClickHouse/ClickHouse/pull/23301) ([tavplubix](https://github.com/tavplubix))。
* ReplicatedMergeTree テーブルの作成と削除の間で、ごくまれに発生する（分散環境における）競合状態を修正しました。これが原因で、レプリケートされたテーブルを作成しようとした際に `node doesn't exist` のような例外が発生する可能性がありました。[#21419](https://github.com/ClickHouse/ClickHouse/issues/21419) を修正しました。 [#23294](https://github.com/ClickHouse/ClickHouse/pull/23294)（[tavplubix](https://github.com/tavplubix)）。
* 主キーが最初の属性でない場合に、DDL から作成される simple key 辞書の問題を修正しました。 [#23236](https://github.com/ClickHouse/ClickHouse/issues/23236) を修正。 [#23262](https://github.com/ClickHouse/ClickHouse/pull/23262)（[Maksim Kita](https://github.com/kitaisreal)）。
* テーブル内に多数の長いカラム名が存在する場合の ODBC 経由での読み取りを修正しました。 [#8853](https://github.com/ClickHouse/ClickHouse/issues/8853) をクローズ。 [#23215](https://github.com/ClickHouse/ClickHouse/pull/23215)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* MaterializeMySQL（実験的機能）：キー列に条件を指定して `MaterializeMySQL` からデータを選択した際に発生していた `Not found column` エラーを修正しました。これにより [#22432](https://github.com/ClickHouse/ClickHouse/issues/22432) が修正されています。 [#23200](https://github.com/ClickHouse/ClickHouse/pull/23200)（[tavplubix](https://github.com/tavplubix)）。
* サブクエリが定数に最適化された場合のエイリアスの扱いを修正しました。 [#22924](https://github.com/ClickHouse/ClickHouse/issues/22924) を修正。 [#10401](https://github.com/ClickHouse/ClickHouse/issues/10401) を修正。 [#23191](https://github.com/ClickHouse/ClickHouse/pull/23191)（[Maksim Kita](https://github.com/kitaisreal)）。
* `data_type_default_nullable` 設定がデフォルトプロファイルで有効になっている場合にサーバーが起動に失敗することがありましたが、修正されました。 [#22573](https://github.com/ClickHouse/ClickHouse/issues/22573) を修正。 [#23185](https://github.com/ClickHouse/ClickHouse/pull/23185) ([tavplubix](https://github.com/tavplubix)).
* アクティブな接続数の誤った管理が原因で、シャットダウン時にクラッシュが発生する問題を修正しました。 [#23154](https://github.com/ClickHouse/ClickHouse/pull/23154) ([Vitaly Baranov](https://github.com/vitlibar)).
* Atomic データベースからマテリアライズドビューを切り離してから再度アタッチした後に、そのマテリアライズドビューから選択を行うと `Table .inner_id... doesn't exist` エラーが発生する問題を修正しました。 [#23047](https://github.com/ClickHouse/ClickHouse/pull/23047) ([tavplubix](https://github.com/tavplubix)).
* サブクエリが `untuple` を使用している場合に発生する可能性のある `Cannot find column in ActionsDAG result` エラーを修正しました。 [#22290](https://github.com/ClickHouse/ClickHouse/issues/22290) を修正。 [#22991](https://github.com/ClickHouse/ClickHouse/pull/22991)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 値が Nullable な `Map` 型の定数カラムの扱いを修正しました。 [#22939](https://github.com/ClickHouse/ClickHouse/pull/22939) ([Anton Popov](https://github.com/CurtizJ)).
* `DateTime64` に対する `formatDateTime()` および &quot;%C&quot; 書式指定子を修正し、大きな値やスケールが 0 以外の場合の `toDateTime64()` の不具合を修正しました。 [#22937](https://github.com/ClickHouse/ClickHouse/pull/22937) ([Vasily Nemkov](https://github.com/Enmk)).
* ウィンドウ関数と併用した際に `mannWhitneyUTest` および `rankCorr` がクラッシュする問題を修正しました。これにより [#22728](https://github.com/ClickHouse/ClickHouse/issues/22728) が解消されます。 [#22876](https://github.com/ClickHouse/ClickHouse/pull/22876) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* LIVE VIEW（実験的機能）：`TemporaryLiveViewCleaner` において、TEMPORARY LIVE VIEW に対する DROP/CREATE の同時実行時にハングする可能性があった問題を修正しました。詳細は[こちら](https://gist.github.com/vzakaznikov/0c03195960fc86b56bfe2bc73a90019e)を参照してください。 [#22858](https://github.com/ClickHouse/ClickHouse/pull/22858)（[Vitaly Baranov](https://github.com/vitlibar)）。
* フィルター列が集約に使用されている場合の `HAVING` 句のプッシュダウンを修正しました。 [#22763](https://github.com/ClickHouse/ClickHouse/pull/22763) ([Anton Popov](https://github.com/CurtizJ)).
* OOM 例外発生時に ZooKeeper リクエストがハングする可能性のあった問題を修正しました。 [#22438](https://github.com/ClickHouse/ClickHouse/issues/22438) を修正。 [#22684](https://github.com/ClickHouse/ClickHouse/pull/22684)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* ReplicatedMergeTree テーブルエンジンにおいて、複数レプリカ間でのミューテーション完了待機の挙動を修正しました。以前は、他のレプリカでミューテーションが実際に実行される前に、`MUTATION`/`ALTER` クエリが完了してしまう場合がありました。 [#22669](https://github.com/ClickHouse/ClickHouse/pull/22669) ([alesapin](https://github.com/alesapin)).
* `SELECT` 句でカラムが指定されていないネスト型カラムを持つ `Log` に対する例外を修正しました。 [#22654](https://github.com/ClickHouse/ClickHouse/pull/22654) ([Azat Khuzhin](https://github.com/azat)).
* 補助 AWS リクエストの無制限待機を修正。 [#22594](https://github.com/ClickHouse/ClickHouse/pull/22594) ([Vladimir Chebotarev](https://github.com/excitoon)).
* クライアントが接続を非常に早い段階で閉じた場合に発生していたクラッシュを修正しました [#22579](https://github.com/ClickHouse/ClickHouse/issues/22579)。 [#22591](https://github.com/ClickHouse/ClickHouse/pull/22591) ([nvartolomei](https://github.com/nvartolomei))。
* `Map` データ型（実験的機能）：分散クエリにおいて、`map` 関数の書式が誤っていた問題を修正しました。 [#22588](https://github.com/ClickHouse/ClickHouse/pull/22588) ([foolchi](https://github.com/foolchi)).
* TSV フォーマットで、末尾に改行のない空文字列のデシリアライズ処理を修正しました。これにより [#20244](https://github.com/ClickHouse/ClickHouse/issues/20244) が解決されます。バージョンを更新しない場合に利用できる回避策: `input_format_null_as_default` を 0 に設定してください。古いバージョンでは 0 が設定されていました。 [#22527](https://github.com/ClickHouse/ClickHouse/pull/22527) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* Merge Join アルゴリズムにおける `LowCardinality` 型カラムの誤ったキャストを修正しました。[#22386](https://github.com/ClickHouse/ClickHouse/issues/22386) および [#22388](https://github.com/ClickHouse/ClickHouse/issues/22388) をクローズしました。[#22510](https://github.com/ClickHouse/ClickHouse/pull/22510)（[Vladimir](https://github.com/vdimir)）。
* `tokenbf_v1` フルテキストインデックスの読み取り時にバッファオーバーフローが発生する可能性がありました。余分なバイト列自体は使用されませんが、読み取り処理によっては、まれにクラッシュする可能性がありました。この変更により [#19233](https://github.com/ClickHouse/ClickHouse/issues/19233) が解決されました。 [#22421](https://github.com/ClickHouse/ClickHouse/pull/22421) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* HTTP チャンクサイズを制限しないよう変更。 [#21907](https://github.com/ClickHouse/ClickHouse/issues/21907) を修正。 [#22322](https://github.com/ClickHouse/ClickHouse/pull/22322)（[Ivan](https://github.com/abyss7)）。
* `optimize_aggregation_in_order` が有効で、テーブルが多数のパーツに分割されている場合にデータが十分に集約されない不具合を修正しました。`optimize_aggregation_in_order` が有効な場合の集約処理のパフォーマンスをわずかに改善しました。 [#21889](https://github.com/ClickHouse/ClickHouse/pull/21889) ([Anton Popov](https://github.com/CurtizJ))。
* テーブル関数 `view` がカラムとして使用されているかどうかを確認します。これは #20350 を補完します。 [#21465](https://github.com/ClickHouse/ClickHouse/pull/21465) ([Amos Bird](https://github.com/amosbird)).
* `JOIN` と集約を含むクエリで、`Merge` エンジンのテーブルに対して発生する「unknown column」エラーを修正。[#18368](https://github.com/ClickHouse/ClickHouse/issues/18368) および [#22226](https://github.com/ClickHouse/ClickHouse/issues/22226) をクローズ。[#21370](https://github.com/ClickHouse/ClickHouse/pull/21370)（[Vladimir](https://github.com/vdimir)）。
* プッシュダウン最適化における名前の競合を修正しました。これにより、FULL JOIN 後の `WHERE` フィルタリングが誤って行われる問題が発生していました。[#20497](https://github.com/ClickHouse/ClickHouse/issues/20497) をクローズ。[#20622](https://github.com/ClickHouse/ClickHouse/pull/20622)（[Vladimir](https://github.com/vdimir)）。
* `quorum_parallel=1` を使用した quorum insert が、重複排除により実際には「quorum」の条件を満たしていなかった、極めてまれなバグを修正しました。 [#18215](https://github.com/ClickHouse/ClickHouse/pull/18215)（[filimonov](https://github.com/filimonov) - 報告、[alesapin](https://github.com/alesapin) - 修正）。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-6}

- CI でステートレステストを並列実行するようにしました。[#22300](https://github.com/ClickHouse/ClickHouse/pull/22300) ([alesapin](https://github.com/alesapin))。
- Debian パッケージを簡素化しました。これにより [#21698](https://github.com/ClickHouse/ClickHouse/issues/21698) が修正されます。[#22976](https://github.com/ClickHouse/ClickHouse/pull/22976) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- Apple M1 での ClickHouse ビルドのサポートを追加しました。[#21639](https://github.com/ClickHouse/ClickHouse/pull/21639) ([changvvb](https://github.com/changvvb))。
- macOS 向けの ClickHouse Keeper ビルドを修正しました。[#22860](https://github.com/ClickHouse/ClickHouse/pull/22860) ([alesapin](https://github.com/alesapin))。
- AArch64 プラットフォームでの一部のテストを修正しました。[#22596](https://github.com/ClickHouse/ClickHouse/pull/22596) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- パフォーマンス向上の可能性のため、関数のアライメントを追加しました。[#21431](https://github.com/ClickHouse/ClickHouse/pull/21431) ([Danila Kutenin](https://github.com/danlark1))。
- amd64 と aarch64 (qemu) で同一の結果を出力するように一部のテストを調整しました。結果は実装固有の CPU 動作に依存していました。[#22590](https://github.com/ClickHouse/ClickHouse/pull/22590) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- x86_64 でのみクエリプロファイリングを許可するようにしました。詳細は [#15174](https://github.com/ClickHouse/ClickHouse/issues/15174#issuecomment-812954965) および [#15638](https://github.com/ClickHouse/ClickHouse/issues/15638#issuecomment-703805337) を参照してください。これにより [#15638](https://github.com/ClickHouse/ClickHouse/issues/15638) がクローズされます。[#22580](https://github.com/ClickHouse/ClickHouse/pull/22580) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `USE_INTERNAL_XZ_LIBRARY=OFF` CMake オプションを使用して、バンドルされていない xz (lzma) でのビルドを許可するようにしました。[#22571](https://github.com/ClickHouse/ClickHouse/pull/22571) ([Kfir Itzhak](https://github.com/mastertheknife))。
- `ppc64le` でバンドルされた `openldap` を有効化しました。[#22487](https://github.com/ClickHouse/ClickHouse/pull/22487) ([Kfir Itzhak](https://github.com/mastertheknife))。
- `ppc64le` で互換性のないライブラリ(通常はプラットフォーム固有)を無効化しました。[#22475](https://github.com/ClickHouse/ClickHouse/pull/22475) ([Kfir Itzhak](https://github.com/mastertheknife))。
- ClickHouse Keeper 用の Jepsen テストを CI に追加しました。[#22373](https://github.com/ClickHouse/ClickHouse/pull/22373) ([alesapin](https://github.com/alesapin))。
- `jemalloc` を[ヒーププロファイリング](https://github.com/jemalloc/jemalloc/wiki/Use-Case%3A-Heap-Profiling)のサポートを含めてビルドするようにしました。[#22834](https://github.com/ClickHouse/ClickHouse/pull/22834) ([nvartolomei](https://github.com/nvartolomei))。
- 別スレッドからのロック解除による `*Log` エンジンでの rwlock ロック解除における未定義動作を回避しました。[#22583](https://github.com/ClickHouse/ClickHouse/pull/22583) ([Azat Khuzhin](https://github.com/azat))。
- TinyLog の rwlock を同じスレッドからロック解除することで未定義動作を修正しました。[#22560](https://github.com/ClickHouse/ClickHouse/pull/22560) ([Azat Khuzhin](https://github.com/azat))。


## ClickHouse リリース 21.4 {#clickhouse-release-214}

### ClickHouse リリース 21.4.1 2021-04-12 {#clickhouse-release-2141-2021-04-12}

#### 後方互換性のない変更 {#backward-incompatible-change-7}

- `toStartOfIntervalFunction` は時間間隔を午前0時に揃えるようになります(以前のバージョンではUnixエポックの開始時刻に揃えられていました)。例えば、`toStartOfInterval(x, INTERVAL 11 HOUR)` は毎日を3つの間隔に分割します: `00:00:00..10:59:59`、`11:00:00..21:59:59`、`22:00:00..23:59:59`。この動作は実用的なニーズにより適しています。これにより [#9510](https://github.com/ClickHouse/ClickHouse/issues/9510) が解決されます。[#22060](https://github.com/ClickHouse/ClickHouse/pull/22060) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- Graphiteロールアップ設定における `Age` と `Precision` は、保持期間ごとに増加する必要があります。現在はこれがチェックされ、誤った設定は例外を発生させます。[#21496](https://github.com/ClickHouse/ClickHouse/pull/21496) ([Mikhail f. Shiryaev](https://github.com/Felixoid))。
- カスタムトップレベルドメインリストに存在する3階層以上のドメインに対して `cutToFirstSignificantSubdomainCustom()`/`firstSignificantSubdomainCustom()` が誤った結果を返す問題を修正しました。これらのカスタムトップレベルドメインに一致する入力ドメインでは、第3レベルドメインが最初の有意なドメインと見なされていました。これは修正されました。この変更は、例えばシャーディングキーでこの関数が使用されている場合、非互換性を引き起こす可能性があります。[#21946](https://github.com/ClickHouse/ClickHouse/pull/21946) ([Azat Khuzhin](https://github.com/azat))。
- テーブル `system.dictionaries` のカラム `keys` は、カラム `key.names` と `key.types` に置き換えられました。`system.dictionaries` テーブルのカラム `key.names`、`key.types`、`attribute.names`、`attribute.types` は、辞書がロードされている必要がありません。[#21884](https://github.com/ClickHouse/ClickHouse/pull/21884) ([Maksim Kita](https://github.com/kitaisreal))。
- `ALTER TABLE ATTACH PART[ITION]` コマンドを処理するレプリカは、他のレプリカからデータを取得する前に、自身の `detached/` フォルダを検索するようになりました。実装の詳細として、レプリケーションログに新しいコマンド `ATTACH_PART` が導入されました。パーツはチェックサムによって検索および比較されます。[#18978](https://github.com/ClickHouse/ClickHouse/pull/18978) ([Mike Kot](https://github.com/myrrc))。**注意**:
  - クラスタのアップグレード中は `ATTACH PART[ITION]` クエリが動作しない可能性があります。
  - 新しいバージョンで `ALTER ... ATTACH` クエリを実行した後、古いClickHouseバージョンにロールバックすることはできません。古いサーバーはレプリケーションログ内の `ATTACH_PART` エントリの処理に失敗するためです。
- このバージョンでは、空の `<remote_url_allow_hosts></remote_url_allow_hosts>` はリモートホストへのすべてのアクセスをブロックしますが、以前のバージョンでは何も行いませんでした。古い動作を維持したい場合で、設定ファイルに空の `remote_url_allow_hosts` 要素がある場合は、それを削除してください。[#20058](https://github.com/ClickHouse/ClickHouse/pull/20058) ([Vladimir Chebotarev](https://github.com/excitoon))。

#### 新機能 {#new-feature-7}


* `DateTime64` の扱える範囲を拡張し、西暦 1925 年から 2283 年までの日付をサポートするようにしました。ゼロ日付（`1970-01-01`）付近の `DateTime` のサポートを改善しました。 [#9404](https://github.com/ClickHouse/ClickHouse/pull/9404) ([alexey-milovidov](https://github.com/alexey-milovidov), [Vasily Nemkov](https://github.com/Enmk))。すべての日時関数が拡張された日付範囲で動作するわけではありません。
* あらかじめ設定されたユーザーおよび HTTP リクエスト向けに Kerberos 認証（GSS-SPNEGO）をサポートしました。 [#14995](https://github.com/ClickHouse/ClickHouse/pull/14995) ([Denis Glazachev](https://github.com/traceon)).
* エイリアスではなく元のカラム名を使用するために、`prefer_column_name_to_alias` 設定を追加しました。これは、一般的なデータベースで用いられるエイリアス規則との互換性を高めるために必要です。[#9715](https://github.com/ClickHouse/ClickHouse/issues/9715) および [#9887](https://github.com/ClickHouse/ClickHouse/issues/9887) に関連しています。[#22044](https://github.com/ClickHouse/ClickHouse/pull/22044)（[Amos Bird](https://github.com/amosbird)）。
* 関数 `dictGetChildren(dictionary, key)`、`dictGetDescendants(dictionary, key, level)` を追加しました。関数 `dictGetChildren` は、すべての子をインデックスの配列として返します。これは `dictGetHierarchy` に対する逆変換です。関数 `dictGetDescendants` は、`dictGetChildren` を `level` 回再帰的に適用した場合と同様に、すべての子孫を返します。`level` が 0 の場合は無制限と同等です。 [#14656](https://github.com/ClickHouse/ClickHouse/issues/14656) をクローズしました。 [#22096](https://github.com/ClickHouse/ClickHouse/pull/22096)（[Maksim Kita](https://github.com/kitaisreal)）。
* `executable_pool` 辞書ソースを追加し、[#14528](https://github.com/ClickHouse/ClickHouse/issues/14528) をクローズしました。 [#21321](https://github.com/ClickHouse/ClickHouse/pull/21321)（[Maksim Kita](https://github.com/kitaisreal)）。
* `dictionary` テーブル関数を追加しました。`Dictionary` エンジンと同じように動作します。[#21560](https://github.com/ClickHouse/ClickHouse/issues/21560) をクローズしました。[#21910](https://github.com/ClickHouse/ClickHouse/pull/21910) ([Maksim Kita](https://github.com/kitaisreal))。
* `PolygonDictionary` 属性で `Nullable` 型をサポートするようにしました。 [#21890](https://github.com/ClickHouse/ClickHouse/pull/21890) ([Maksim Kita](https://github.com/kitaisreal)).
* DDL で作成されたディクショナリについて、データベース名が指定されていない場合には、関数 `dictGet` および `dictHas` はカレントデータベース名を使用するようになりました。[#21632](https://github.com/ClickHouse/ClickHouse/issues/21632) をクローズ。[#21859](https://github.com/ClickHouse/ClickHouse/pull/21859)（[Maksim Kita](https://github.com/kitaisreal)）。
* 関数 `dictGetOrNull` を追加しました。これは `dictGet` と同様に動作しますが、辞書内でキーが見つからなかった場合は `Null` を返します。[#22375](https://github.com/ClickHouse/ClickHouse/issues/22375) をクローズしました。[#22413](https://github.com/ClickHouse/ClickHouse/pull/22413)（[Maksim Kita](https://github.com/kitaisreal)）。
* `ComplexKeyCache`、`SSDCache`、`SSDComplexKeyCache` 辞書に非同期更新を追加しました。`Cache`、`ComplexKeyCache`、`SSDCache`、`SSDComplexKeyCache` 辞書で `Nullable` 型をサポートしました。`dictGet`、`dictGetOrDefault` 関数で複数属性の同時取得をサポートしました。[#21517](https://github.com/ClickHouse/ClickHouse/issues/21517) を修正しました。 [#20595](https://github.com/ClickHouse/ClickHouse/pull/20595)（[Maksim Kita](https://github.com/kitaisreal)）。
* `RangeHashedDictionary` に対して `dictHas` 関数をサポート。 [#6680](https://github.com/ClickHouse/ClickHouse/issues/6680) を修正。 [#19816](https://github.com/ClickHouse/ClickHouse/pull/19816)（[Maksim Kita](https://github.com/kitaisreal)）。
* `DateTime` または `DateTime64` データ型のタイムゾーン名を返す関数 `timezoneOf` を追加しました。これは [#9959](https://github.com/ClickHouse/ClickHouse/issues/9959) を解決するものではありません。関数名の不整合を修正するため、`timezone` および `timeZone`、`toTimezone` および `toTimeZone`、`timezoneOf` および `timeZoneOf` のエイリアスを追加しました。[#22001](https://github.com/ClickHouse/ClickHouse/pull/22001)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `CREATE/ALTER USER` コマンドに新しいオプション句 `GRANTEES` を追加しました。これは、このユーザーが付与オプション付きで必要なすべてのアクセス権を付与されていることを条件に、このユーザーから権限付与を受けることが許可されているユーザーまたはロールを指定します。デフォルトでは `GRANTEES ANY` が使用され、これは付与オプションを持つユーザーは誰にでも権限を付与できることを意味します。構文: `CREATE USER ... GRANTEES {user | role | ANY | NONE} [,...] [EXCEPT {user | role} [,...]]`。[#21641](https://github.com/ClickHouse/ClickHouse/pull/21641)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `system.clusters` に新しいカラム `slowdowns_count` を追加しました。ヘッジ付きリクエストを使用している場合、あるレプリカの応答が遅いために別のレプリカへ切り替えた回数を示します。また、`system.clusters` で `errors_count` の実際の値も表示するようにしました。 [#21480](https://github.com/ClickHouse/ClickHouse/pull/21480) ([Kruglov Pavel](https://github.com/Avogar)).
* `MergeTree*` エンジンに仮想列 `_partition_id` を追加しました。`_partition_id` でパーティションをプルーニングできるようにしました。パーティション ID 文字列を算出するための `partitionID()` 関数を追加しました。 [#21401](https://github.com/ClickHouse/ClickHouse/pull/21401) ([Amos Bird](https://github.com/amosbird))。
* IPv4 または IPv6 アドレスが、指定された CIDR ネットワークプレフィックスに含まれているかをテストする関数 `isIPAddressInRange` を追加しました。 [#21329](https://github.com/ClickHouse/ClickHouse/pull/21329) ([PHO](https://github.com/depressed-pho))。
* 新しい SQL コマンド `ALTER TABLE 'table_name' UNFREEZE [PARTITION 'part_expr'] WITH NAME 'backup_name'` を追加しました。このコマンドは、すべてのディスクからフリーズされたパーティションを正しく削除するために必要です。[#21142](https://github.com/ClickHouse/ClickHouse/pull/21142) ([Pavel Kovalenko](https://github.com/Jokser))。
* JOIN に対する暗黙的なキーの型変換をサポートします。[#19885](https://github.com/ClickHouse/ClickHouse/pull/19885) ([Vladimir](https://github.com/vdimir))。

#### 実験的機能 {#experimental-feature-6}

- 浮動小数点型に対するウィンドウ関数の`RANGE OFFSET`フレームをサポート。`lagInFrame`/`leadInFrame`ウィンドウ関数を実装しました。これらは`lag`/`lead`に類似していますが、ウィンドウフレームを考慮します。フレームが`between unbounded preceding and unbounded following`の場合は同一の動作となります。これにより[#5485](https://github.com/ClickHouse/ClickHouse/issues/5485)が解決されます。[#21895](https://github.com/ClickHouse/ClickHouse/pull/21895) ([Alexander Kuzmenkov](https://github.com/akuzm))。
- S3ストレージ上の`ReplicatedMergeTree`に対するゼロコピーレプリケーション。[#16240](https://github.com/ClickHouse/ClickHouse/pull/16240) ([ianton-ru](https://github.com/ianton-ru))。
- 既存のS3ディスクをバックアップ・リストア機能を持つスキーマに移行する機能を追加しました。[#22070](https://github.com/ClickHouse/ClickHouse/pull/22070) ([Pavel Kovalenko](https://github.com/Jokser))。

#### パフォーマンス改善 {#performance-improvement-7}

- `clickhouse-local`およびその他すべての箇所で並列フォーマットをサポートしました。[#21630](https://github.com/ClickHouse/ClickHouse/pull/21630) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- `CSVWithNames`および`TSVWithNames`形式の並列パースをサポートしました。これにより[#21085](https://github.com/ClickHouse/ClickHouse/issues/21085)が解決されます。[#21149](https://github.com/ClickHouse/ClickHouse/pull/21149) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
- 64 MiB以上のファイル範囲に対してmmap IOによる読み取りを有効化しました(設定`min_bytes_to_use_mmap_io`)。これにより適度なパフォーマンス改善が期待できます。[#22326](https://github.com/ClickHouse/ClickHouse/pull/22326) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `min_bytes_to_use_mmap_io`設定で読み取られるファイルのキャッシュを追加しました。設定値が小さい場合、頻繁なmmap/munmap呼び出しとそれに伴うページフォルトを回避することで、大幅な(2倍以上の)パフォーマンス改善を実現します。なお、mmap IOには本番環境での信頼性を低下させる重大な欠点があります(例:障害のあるディスクでのハングアップやSIGBUS、制御しにくいメモリ使用量)。それでもベンチマークでは優れた結果を示します。[#22206](https://github.com/ClickHouse/ClickHouse/pull/22206) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- コーデック`NONE`使用時の不要なデータコピーを回避しました。コーデック`NONE`はほとんど無用であることに注意してください。常に圧縮を使用することを推奨します(デフォルトは`LZ4`)。一般的な認識とは異なり、圧縮を無効にしてもパフォーマンスが向上しない場合があります(逆効果の可能性もあります)。`NONE`コーデックが有用なケース:データが圧縮不可能な場合、合成ベンチマーク用。[#22145](https://github.com/ClickHouse/ClickHouse/pull/22145) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 小さい`max_rows_to_group_by`と`group_by_overflow_mode='any'`を使用した`GROUP BY`を高速化しました。[#21856](https://github.com/ClickHouse/ClickHouse/pull/21856) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
- `SELECT ... FINAL ... WHERE`のようなクエリのパフォーマンスを最適化しました。`FINAL`を含むクエリで、ソートキーに含まれるカラムを`PREWHERE`に移動できるようになりました。[#21830](https://github.com/ClickHouse/ClickHouse/pull/21830) ([foolchi](https://github.com/foolchi))。
- `memcpy`を別の実装に置き換えることでパフォーマンスを改善しました。これにより[#18583](https://github.com/ClickHouse/ClickHouse/issues/18583)が解決されます。[#21520](https://github.com/ClickHouse/ClickHouse/pull/21520) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- ソートキーの順序での集計のパフォーマンスを改善しました(設定`optimize_aggregation_in_order`を有効にした場合)。[#19401](https://github.com/ClickHouse/ClickHouse/pull/19401) ([Anton Popov](https://github.com/CurtizJ))。

#### 改善 {#improvement-7}


* PostgreSQL テーブル／データベースエンジンおよび辞書ソース向けにコネクションプールを追加しました。これにより [#21444](https://github.com/ClickHouse/ClickHouse/issues/21444) が修正されるはずです。 [#21839](https://github.com/ClickHouse/ClickHouse/pull/21839) ([Kseniia Sumarokova](https://github.com/kssenii))。
* PostgreSQL ストレージ/テーブル関数でデフォルト以外のテーブルスキーマをサポートしました。[#21701](https://github.com/ClickHouse/ClickHouse/issues/21701) をクローズしました。 [#21711](https://github.com/ClickHouse/ClickHouse/pull/21711) ([Kseniia Sumarokova](https://github.com/kssenii))。
* PostgreSQL 辞書ソースにおけるレプリカの優先度をサポートしました。 [#21710](https://github.com/ClickHouse/ClickHouse/pull/21710) ([Kseniia Sumarokova](https://github.com/kssenii)).
* 新しい MergeTree 設定 `min_bytes_to_rebalance_partition_over_jbod` を導入しました。これにより、JBOD ボリューム内のディスク間で新しいパーツをバランス良く割り当てることができます。 [#16481](https://github.com/ClickHouse/ClickHouse/pull/16481) ([Amos Bird](https://github.com/amosbird))。
* 対応するクエリについて、`system.query_log` の `query_kind` 列に `Grant`、`Revoke`、`System` の値を追加しました。 [#21102](https://github.com/ClickHouse/ClickHouse/pull/21102) ([Vasily Nemkov](https://github.com/Enmk)).
* レプリケーションに使用される HTTP 接続のタイムアウトを、他の HTTP タイムアウトとは独立して設定できるようにしました。 [#20088](https://github.com/ClickHouse/ClickHouse/pull/20088) ([nvartolomei](https://github.com/nvartolomei)).
* サーバーがブロックを書き込んでいる最中に例外が発生した場合、クライアント側で表示される例外メッセージを改善しました。以前のバージョンでは、クライアントが `Data compressed with different methods` のような誤解を招くメッセージを受け取ることがありました。 [#22427](https://github.com/ClickHouse/ClickHouse/pull/22427) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* フェッチしたパーツが失敗した後に発生する可能性があるエラー `Directory tmp_fetch_XXX already exists` を修正しました。すでに存在する場合は一時フェッチ用ディレクトリを削除するようにしました。 [#14197](https://github.com/ClickHouse/ClickHouse/issues/14197) を修正。 [#22411](https://github.com/ClickHouse/ClickHouse/pull/22411) ([nvartolomei](https://github.com/nvartolomei)).
* `UInt256` 引数を持つ関数 `range` に対して MSan が報告していた問題を修正しました（大きな整数のサポートは試験的機能です）。これにより [#22157](https://github.com/ClickHouse/ClickHouse/issues/22157) をクローズしました。 [#22387](https://github.com/ClickHouse/ClickHouse/pull/22387)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `system.processes` テーブルに `current_database` 列を追加しました。クエリの現在のデータベースを示します。 [#22365](https://github.com/ClickHouse/ClickHouse/pull/22365) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* `clickhouse-client` に大文字小文字を区別しない履歴検索/ナビゲーション機能とサブワード移動機能を追加。[#22105](https://github.com/ClickHouse/ClickHouse/pull/22105) ([Amos Bird](https://github.com/amosbird))。
* `(NULL, NULL)` のような NULL からなるタプルが `IN` 演算子の左辺にあり、右辺が非 NULL のタプルである場合（例: `SELECT (NULL, NULL) IN ((0, 0), (3, 1))`）、型の非互換性に関する例外をスローするのではなく、0 を返すようにしました。このような式は、`SELECT (NULL, NULL) = (8, 0) OR (NULL, NULL) = (3, 2) OR (NULL, NULL) = (0, 0) OR (NULL, NULL) = (3, 1)` のようなクエリの最適化によって生成されることもあります。これにより [#22017](https://github.com/ClickHouse/ClickHouse/issues/22017) が修正されました。 [#22063](https://github.com/ClickHouse/ClickHouse/pull/22063)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 使用している simdjson のバージョンを 0.9.1 に更新しました。これにより [#21984](https://github.com/ClickHouse/ClickHouse/issues/21984) が修正されました。[#22057](https://github.com/ClickHouse/ClickHouse/pull/22057)（[Vitaly Baranov](https://github.com/vitlibar)）。
* `CONNECTION_ID()` および `VERSION()` 関数に大文字小文字を区別しないエイリアスを追加しました。これにより [#22028](https://github.com/ClickHouse/ClickHouse/issues/22028) を修正しました。 [#22042](https://github.com/ClickHouse/ClickHouse/pull/22042) ([Eugene Klimov](https://github.com/Slach))。
* `windowFunnel` 関数にオプション `strict_increase` を追加し、各イベントが一度だけ計算されるようにしました（[#21835](https://github.com/ClickHouse/ClickHouse/issues/21835) を解決）。 [#22025](https://github.com/ClickHouse/ClickHouse/pull/22025)（[Vladimir](https://github.com/vdimir)）。
* `MergeTree` テーブルのパーティションキーが `Date` または `DateTime` 列を含まず、かつちょうど 1 つの `DateTime64` 列のみを含む場合、その値を `system.parts` および `system.parts_columns` テーブルの `min_time` 列と `max_time` 列に公開するようにしました。`system.parts_columns` テーブルに `min_time` 列と `max_time` 列を追加しました（これまで `system.parts` テーブルとの間に不整合がありました）。これにより [#18244](https://github.com/ClickHouse/ClickHouse/issues/18244) が解決されました。 [#22011](https://github.com/ClickHouse/ClickHouse/pull/22011)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `clickhouse-copier` において、補助テーブルから宛先へのパーティション移動のために `replication_alter_partitions_sync=1` 設定をサポートしました。デフォルトのタイムアウト値を短縮しました。[#21911](https://github.com/ClickHouse/ClickHouse/issues/21911) を修正。[#21912](https://github.com/ClickHouse/ClickHouse/pull/21912)（[turbo jason](https://github.com/songenjie)）。
* `EmbeddedRocksDB` テーブルのデータディレクトリへのパスをシステムテーブルに表示するようにしました。 [#21903](https://github.com/ClickHouse/ClickHouse/pull/21903) ([tavplubix](https://github.com/tavplubix))。
* プロファイルイベント `HedgedRequestsChangeReplica` を追加し、データ読み取りのタイムアウト単位を秒からミリ秒に変更しました。 [#21886](https://github.com/ClickHouse/ClickHouse/pull/21886) ([Kruglov Pavel](https://github.com/Avogar)).
* DiskS3（開発中の実験的機能）。キャッシュディスク使用時に、移動先ディレクトリが空でない場合にディレクトリを移動できないバグを修正。[#21837](https://github.com/ClickHouse/ClickHouse/pull/21837) ([Pavel Kovalenko](https://github.com/Jokser))。
* Web UI における `Array` および `Map` データ型の書式を改善。[#21798](https://github.com/ClickHouse/ClickHouse/pull/21798) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* クラスタ設定が更新された場合にのみクラスタを更新するようにしました。 [#21685](https://github.com/ClickHouse/ClickHouse/pull/21685) ([Kruglov Pavel](https://github.com/Avogar)).
* 分散 DDL クエリにおいて、クエリおよびセッション設定を伝播できるようにしました。これを有効にするには、`distributed_ddl_entry_format_version` を 2 に設定します。`distributed_ddl_output_mode` 設定を追加しました。サポートされるモードは `none`、`throw`（デフォルト）、`null_status_on_timeout`、`never_throw` です。`Replicated` データベースエンジンに対するその他の細かな修正および改善を行いました。 [#21535](https://github.com/ClickHouse/ClickHouse/pull/21535) ([tavplubix](https://github.com/tavplubix))。
* `PODArray` が要素サイズとして 16 の約数でも倍数でもない値でインスタンス化されていた場合、バッファオーバーフローが発生する可能性がありました。現在のリリースにはこのバグは存在しません。 [#21533](https://github.com/ClickHouse/ClickHouse/pull/21533) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `system.errors` に `last_error_time`/`last_error_message`/`last_error_stacktrace`/`remote` カラムを追加。 [#21529](https://github.com/ClickHouse/ClickHouse/pull/21529) ([Azat Khuzhin](https://github.com/azat)).
* `visitParam/visitParamExtract{UInt, Int, Bool, Float, Raw, String}` に対するエイリアスとして `simpleJSONExtract/simpleJSONHas` を追加。#21383 を修正。 [#21519](https://github.com/ClickHouse/ClickHouse/pull/21519) ([fastio](https://github.com/fastio)).
* `optimize_skip_unused_shards` 用のシャーディングキーの値の数を制限する設定 `optimize_skip_unused_shards_limit` を追加。 [#21512](https://github.com/ClickHouse/ClickHouse/pull/21512) ([Azat Khuzhin](https://github.com/azat)).
* `clickhouse-format` を改善し、末尾に余分な空白やコメントがあっても例外をスローしないようにし、データを含む `ASTInsertQuery` をフォーマットする際には、読みやすいメッセージで早期に例外をスローするようにしました。 [#21311](https://github.com/ClickHouse/ClickHouse/pull/21311) ([flynn](https://github.com/ucasFL))。
* データ型 `Map` における整数キーのサポートを改善しました。 [#21157](https://github.com/ClickHouse/ClickHouse/pull/21157) ([Anton Popov](https://github.com/CurtizJ))。
* MaterializeMySQL: 接続が失われた場合に MySQL への再接続を試みるようにしました。 [#20961](https://github.com/ClickHouse/ClickHouse/pull/20961) ([Håvard Kvålen](https://github.com/havardk)).
* `CROSS JOIN` を `INNER JOIN` に書き換え可能なケースを拡大。[#20392](https://github.com/ClickHouse/ClickHouse/pull/20392)（[Vladimir](https://github.com/vdimir)）。
* `optimize_on_insert` 設定が有効な場合に、INSERT 時に空のパーツが作成されないようにしました。 [#20304](https://github.com/ClickHouse/ClickHouse/issues/20304) を修正。 [#20387](https://github.com/ClickHouse/ClickHouse/pull/20387)（[Kruglov Pavel](https://github.com/Avogar)）。
* `MaterializeMySQL`：`_version` 列に対して minmax スキップインデックスを追加。 [#20382](https://github.com/ClickHouse/ClickHouse/pull/20382) ([Stig Bakken](https://github.com/stigsb))。
* `clickhouse-format` にオプション `--backslash` を追加し、整形されたクエリの各行末にバックスラッシュを追加できるようにしました。 [#21494](https://github.com/ClickHouse/ClickHouse/pull/21494) ([flynn](https://github.com/ucasFL)).
* すでに対象となっている部分を再度変更しようとした場合でも、ClickHouse は `LOGICAL_ERROR` 例外をスローしなくなりました。[#22013](https://github.com/ClickHouse/ClickHouse/issues/22013) が修正されました。[#22291](https://github.com/ClickHouse/ClickHouse/pull/22291)（[alesapin](https://github.com/alesapin)）。

#### バグ修正 {#bug-fix-6}


* `HedgedConnections` において、パケット受信処理をキャンセルする前にソケットを epoll から削除し、レースコンディションが発生する可能性を防止します。[#22161](https://github.com/ClickHouse/ClickHouse/issues/22161) を修正。 [#22443](https://github.com/ClickHouse/ClickHouse/pull/22443)（[Kruglov Pavel](https://github.com/Avogar)）。
* 並列パース処理ルーチンに不足していたメモリ使用量の計測を追加しました。以前のバージョンでは、結果セットに非常に大きなデータブロックが含まれている場合に OOM が発生する可能性がありました。これにより [#22008](https://github.com/ClickHouse/ClickHouse/issues/22008) が解決されました。[#22425](https://github.com/ClickHouse/ClickHouse/pull/22425)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `SELECT` に定数の `WHERE` 条件があり、かつソーステーブルに列名が数字のみの列が含まれている場合に発生する可能性のある例外を修正しました。 [#22270](https://github.com/ClickHouse/ClickHouse/pull/22270) ([LiuNeng](https://github.com/liuneng1994)).
* `use_hedged_requests=0` および `async_socket_for_remote=1` が有効な場合のクエリキャンセルの問題を修正しました。 [#22183](https://github.com/ClickHouse/ClickHouse/pull/22183) ([Azat Khuzhin](https://github.com/azat)).
* `InterserverIOHTTPHandler` における未捕捉の例外を修正。 [#22146](https://github.com/ClickHouse/ClickHouse/pull/22146) ([Azat Khuzhin](https://github.com/azat)).
* `http_port` が設定に存在しない場合の Docker エントリポイントを修正。 [#22132](https://github.com/ClickHouse/ClickHouse/pull/22132) ([Ewout](https://github.com/devwout))。
* `TOTALS` と `arrayJoin` を使用した `JOIN` で発生する `Invalid number of rows in Chunk` エラーを修正しました。 [#19303](https://github.com/ClickHouse/ClickHouse/issues/19303) をクローズしました。 [#22129](https://github.com/ClickHouse/ClickHouse/pull/22129)（[Vladimir](https://github.com/vdimir)）。
* Kafka からメッセージをポーリングするために使用されていたバックグラウンドスレッドプール名を修正しました。不具合のあるスレッドプールを使用していた Kafka エンジンは、メッセージキューからメッセージを取得できませんでした。[#22122](https://github.com/ClickHouse/ClickHouse/pull/22122) ([fastio](https://github.com/fastio))。
* `ReplicatedMergeTree` テーブルエンジンに対する `OPTIMIZE` および `ALTER` クエリで待ち続けてハングする問題を修正しました。これにより、テーブルがデタッチまたは再起動された場合でもクエリがハングしなくなりました。 [#22118](https://github.com/ClickHouse/ClickHouse/pull/22118) ([alesapin](https://github.com/alesapin)).
* 不具合のある Linux カーネルでは `async_socket_for_remote`/`use_hedged_requests` を無効化しました。 [#22109](https://github.com/ClickHouse/ClickHouse/pull/22109) ([Azat Khuzhin](https://github.com/azat)).
* Docker エントリポイント: `LOG_PATH` が空の場合に `.` への chown を回避。[#22100](https://github.com/ClickHouse/ClickHouse/issues/22100) をクローズ。[#22102](https://github.com/ClickHouse/ClickHouse/pull/22102)（[filimonov](https://github.com/filimonov)）。
* 関数 `decrypt` では、`AEAD` モードで暗号化されたデータに対する最小サイズのチェックが行われていませんでした。これにより [#21897](https://github.com/ClickHouse/ClickHouse/issues/21897) が解決されました。[#22064](https://github.com/ClickHouse/ClickHouse/pull/22064)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* まれに、`CollapsingMergeTree` のマージ処理により、`index_granularity + 1` 行を持つグラニュールが作成される場合があります。このため、[#18928](https://github.com/ClickHouse/ClickHouse/issues/18928) で追加された内部チェック（21.2 および 21.3 に影響）が、`Incomplete granules are not allowed while blocks are granules size` というエラーで失敗することがあります。このエラーにより、パーツをマージできないことがありました。[#21976](https://github.com/ClickHouse/ClickHouse/pull/21976)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* ハッシュ型の外部ディクショナリを読み込む際にメモリ使用量が大幅に増加する可能性があった変更 [#15454](https://github.com/ClickHouse/ClickHouse/issues/15454) をリバートしました。これにより [#21935](https://github.com/ClickHouse/ClickHouse/issues/21935) がクローズされます。 [#21948](https://github.com/ClickHouse/ClickHouse/pull/21948)（[Maksim Kita](https://github.com/kitaisreal)）。
* ヘッジド接続の競合を防止（`Unknown packet 9 from server` エラー）。[#21941](https://github.com/ClickHouse/ClickHouse/pull/21941)（[Azat Khuzhin](https://github.com/azat)）。
* 一部のケースにおいて、Content-Type が &quot;multipart/form-data&quot; の HTTP POST リクエストの読み取り処理を修正しました。 [#21936](https://github.com/ClickHouse/ClickHouse/pull/21936) ([Ivan](https://github.com/abyss7))。
* ウィンドウ関数を含むクエリに対して主キー順読み取りの最適化が適用された場合に、`ORDER BY` の結果が誤る問題を修正しました。 [#21828](https://github.com/ClickHouse/ClickHouse/issues/21828) を解決。 [#21915](https://github.com/ClickHouse/ClickHouse/pull/21915)（[Alexander Kuzmenkov](https://github.com/akuzm)）。
* 最初の CatBoost モデルの実行時に発生するデッドロックを修正。[#13832](https://github.com/ClickHouse/ClickHouse/issues/13832) をクローズ。[#21844](https://github.com/ClickHouse/ClickHouse/pull/21844)（[Kruglov Pavel](https://github.com/Avogar)）。
* `WHERE` または `HAVING` 条件が `GROUP BY` より前にプッシュダウンされる場合に発生しうる誤ったクエリ結果と、クラッシュが起こり得る問題を修正。 [#21773](https://github.com/ClickHouse/ClickHouse/issues/21773) を修正。 [#21841](https://github.com/ClickHouse/ClickHouse/pull/21841)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `WriteBufferFromS3` におけるエラー処理とログ出力を改善。 [#21836](https://github.com/ClickHouse/ClickHouse/pull/21836) ([Pavel Kovalenko](https://github.com/Jokser)).
* 二段階集約を使用している際に、`Distinct` コンビネータ付きの集約関数で発生しうるクラッシュを修正しました。これは [#18365](https://github.com/ClickHouse/ClickHouse/pull/18365) のフォローアップ修正です。この問題は本番環境でのみ再現します。[#21818](https://github.com/ClickHouse/ClickHouse/pull/21818)（[Amos Bird](https://github.com/amosbird)）。
* スカラーサブクエリのインデックス解析を修正しました。これにより、[#18896](https://github.com/ClickHouse/ClickHouse/pull/18896) で導入された不具合 [#21717](https://github.com/ClickHouse/ClickHouse/issues/21717) が修正されました。[#21766](https://github.com/ClickHouse/ClickHouse/pull/21766)（[Amos Bird](https://github.com/amosbird)）。
* `Decimal` 列のサイズ（32ビットまたは64ビット）が変わらない場合に、`ALTER MODIFY COLUMN` クエリで列の型が変更されなかった `ReplicatedMerge` テーブルエンジンのバグを修正しました。 [#21728](https://github.com/ClickHouse/ClickHouse/pull/21728) ([alesapin](https://github.com/alesapin))。
* `ReplicatedMergeTree` に対して `OPTIMIZE` と `DROP` が同時に実行された場合に、無限に待機してしまう可能性があった問題を修正しました。 [#21716](https://github.com/ClickHouse/ClickHouse/pull/21716) ([Azat Khuzhin](https://github.com/azat)).
* 定数の整数引数に対して、`Map` 型を扱う `arrayElement` 関数を修正しました。 [#21699](https://github.com/ClickHouse/ClickHouse/pull/21699) ([Anton Popov](https://github.com/CurtizJ)).
* `access_to_key_from_attributes` を使用した `ip_trie` で存在しない属性を参照した際に発生する SIGSEGV を修正。 [#21692](https://github.com/ClickHouse/ClickHouse/pull/21692) ([Azat Khuzhin](https://github.com/azat)).
* サーバーは、`DDLWorker` と辞書の初期化が完了した後にのみ接続を受け付けるようになりました。 [#21676](https://github.com/ClickHouse/ClickHouse/pull/21676) ([Azat Khuzhin](https://github.com/azat)).
* `Join` 型テーブルのキーに対する型変換を追加（以前は SIGSEGV が発生していた）。 [#21646](https://github.com/ClickHouse/ClickHouse/pull/21646) ([Azat Khuzhin](https://github.com/azat))。
* `async_socket_for_remote=1` 使用時の分散リクエストのキャンセル処理を修正しました（例えば、`select * from remote('127.{2,3}', system.numbers) limit 100` のような、複数シャードに対する単純な `SELECT` に `LIMIT` を伴うクエリ）。[#21643](https://github.com/ClickHouse/ClickHouse/pull/21643) ([Azat Khuzhin](https://github.com/azat)).
* 水平マージ処理における `fsync_part_directory` を修正しました。 [#21642](https://github.com/ClickHouse/ClickHouse/pull/21642) ([Azat Khuzhin](https://github.com/azat)).
* 外部データベースエンジン（MySQL、PostgreSQL）へのクエリにおいて、`WHERE` 句内で結合されたテーブルに属さない未知のカラム参照を削除するようにしました。close [#14614](https://github.com/ClickHouse/ClickHouse/issues/14614)、close [#19288](https://github.com/ClickHouse/ClickHouse/issues/19288)（重複）、close [#19645](https://github.com/ClickHouse/ClickHouse/issues/19645)（重複）。[#21640](https://github.com/ClickHouse/ClickHouse/pull/21640)（[Vladimir](https://github.com/vdimir)）。
* S3 へのデータ書き込み時にエラーが発生すると、`std::terminate` が呼び出されていました。 [#21624](https://github.com/ClickHouse/ClickHouse/pull/21624) ([Vladimir](https://github.com/vdimir))。
* `optimize_skip_unused_shards` が有効で、かつ使用されるシャードが 0 の場合に発生しうる `Cannot find column` エラーを修正。 [#21579](https://github.com/ClickHouse/ClickHouse/pull/21579) ([Azat Khuzhin](https://github.com/azat))。
* クエリに定数の `WHERE` 条件があり、かつ設定 `optimize_skip_unused_shards` が有効になっている場合、すべてのシャードがスキップされ、クエリが誤って空の結果を返す可能性があります。 [#21550](https://github.com/ClickHouse/ClickHouse/pull/21550) ([Amos Bird](https://github.com/amosbird)).
* テーブル関数 `clusterAllReplicas` が誤った `_shard_num` を返す問題を修正。[#21481](https://github.com/ClickHouse/ClickHouse/issues/21481) をクローズ。 [#21498](https://github.com/ClickHouse/ClickHouse/pull/21498)（[flynn](https://github.com/ucasFL)）。
* S3 テーブルが設定の更新後も古い認証情報を保持してしまう問題を修正。 [#21457](https://github.com/ClickHouse/ClickHouse/pull/21457) ([Grigory Pervakov](https://github.com/GrigoryPervakov)).
* Poco の `SecureSocket` 内部の SSL オブジェクトにおけるレースコンディションを修正。 [#21456](https://github.com/ClickHouse/ClickHouse/pull/21456) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* `Kafka` 向けの `Avro` フォーマットのパースを修正し、[#21437](https://github.com/ClickHouse/ClickHouse/issues/21437) を解決。[#21438](https://github.com/ClickHouse/ClickHouse/pull/21438)（[Ilya Golshtein](https://github.com/ilejn)）。
* セキュアソケットでの受信および送信タイムアウトとノンブロッキング読み取りを修正。 [#21429](https://github.com/ClickHouse/ClickHouse/pull/21429) ([Kruglov Pavel](https://github.com/Avogar))。
* `force_drop_table` フラグが `MATERIALIZED VIEW` に対して機能していなかった問題を修正。 [#18943](https://github.com/ClickHouse/ClickHouse/issues/18943)。 [#20626](https://github.com/ClickHouse/ClickHouse/pull/20626) ([tavplubix](https://github.com/tavplubix)).
* `PredicateRewriteVisitor` 内の名前衝突を修正しました。これにより、FULL JOIN 後の `WHERE` 句によるフィルタリングが誤って行われていました。[#20497](https://github.com/ClickHouse/ClickHouse/issues/20497) をクローズしました。[#20622](https://github.com/ClickHouse/ClickHouse/pull/20622)（[Vladimir](https://github.com/vdimir)）。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-7}


* ClickHouse Keeper 向けの [Jepsen](https://github.com/jepsen-io/jepsen) テストを追加。 [#21677](https://github.com/ClickHouse/ClickHouse/pull/21677) ([alesapin](https://github.com/alesapin))。
* CI でステートレステストを並列実行できるようにしました。[#22181](https://github.com/ClickHouse/ClickHouse/issues/22181) に依存します。[#22300](https://github.com/ClickHouse/ClickHouse/pull/22300)（[alesapin](https://github.com/alesapin)）。
* [SQLancer](https://github.com/sqlancer/sqlancer) CI 実行用のステータスチェックを有効にしました。 [#22015](https://github.com/ClickHouse/ClickHouse/pull/22015) ([Ilya Yatsishin](https://github.com/qoega)).
* PowerPC 向けビルドのための複数の準備: `ppc64le` で同梱の openldap を有効化。 [#22487](https://github.com/ClickHouse/ClickHouse/pull/22487) ([Kfir Itzhak](https://github.com/mastertheknife))。 `ppc64le` で Clang を用いたコンパイルを有効化。 [#22476](https://github.com/ClickHouse/ClickHouse/pull/22476) ([Kfir Itzhak](https://github.com/mastertheknife))。 `ppc64le` における Boost のコンパイルを修正。 [#22474](https://github.com/ClickHouse/ClickHouse/pull/22474) ([Kfir Itzhak](https://github.com/mastertheknife))。 `ppc64le` で内部 CMake 変数 `CMAKE_ASM_COMPILE_OBJECT` が設定されていないことに関する CMake エラーを修正。 [#22469](https://github.com/ClickHouse/ClickHouse/pull/22469) ([Kfir Itzhak](https://github.com/mastertheknife))。 Fedora/RHEL/CentOS が `ppc64le` 上で `libclang_rt.builtins` を見つけられない問題を修正。 [#22458](https://github.com/ClickHouse/ClickHouse/pull/22458) ([Kfir Itzhak](https://github.com/mastertheknife))。 `ppc64le` で `jemalloc` を用いたビルドを有効化。 [#22447](https://github.com/ClickHouse/ClickHouse/pull/22447) ([Kfir Itzhak](https://github.com/mastertheknife))。 `ppc64le` における ClickHouse の設定の埋め込み処理および cctz のタイムゾーン埋め込み処理を修正。 [#22445](https://github.com/ClickHouse/ClickHouse/pull/22445) ([Kfir Itzhak](https://github.com/mastertheknife))。 `ppc64le` 上でのコンパイルを修正し、`ppc64le` で正しい命令ポインタ・レジスタを使用するように変更。 [#22430](https://github.com/ClickHouse/ClickHouse/pull/22430) ([Kfir Itzhak](https://github.com/mastertheknife))。
* `aarch64` で S3 (AWS) ライブラリを再度有効化。[#22484](https://github.com/ClickHouse/ClickHouse/pull/22484)（[Kfir Itzhak](https://github.com/mastertheknife)）。
* `ORC` 形式を読み込むには `tzdata` が必要なため、Docker コンテナに `tzdata` を追加しました。これにより [#14156](https://github.com/ClickHouse/ClickHouse/issues/14156) が解決しました。[#22000](https://github.com/ClickHouse/ClickHouse/pull/22000)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `clickhouse-server` イメージの Dockerfile に `deb_location` と `single_binary_location` の 2 つの引数を追加。 [#21977](https://github.com/ClickHouse/ClickHouse/pull/21977) ([filimonov](https://github.com/filimonov)).
* clang-tidy を使用している場合にアサーションを有効化することで、release ビルドでも clang-tidy を使用できるようにしました。 [#21914](https://github.com/ClickHouse/ClickHouse/pull/21914) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* CMake スクリプトで検索する対象として llvm-12 バイナリ名を追加。clang の警告を抑制するための定数の暗黙的な型変換。CMake 3.19 でビルドするためにサブモジュールを更新。`readpassphrase` ライブラリでのマクロ展開時の再帰を抑制。clang 用に非推奨となった `-fuse-ld` を `--ld-path` に変更。[#21597](https://github.com/ClickHouse/ClickHouse/pull/21597) ([Ilya Yatsishin](https://github.com/qoega))。
* Docker Hub で非常に厳しいレート制限が有効になったため、`docker/test/testflows/runner/dockerd-entrypoint.sh` を Yandex dockerhub-proxy を利用するように更新 [#21551](https://github.com/ClickHouse/ClickHouse/pull/21551)（[vzakaznikov](https://github.com/vzakaznikov)）。
* macOS 向け共有ライブラリのビルドを修正。 [#20184](https://github.com/ClickHouse/ClickHouse/pull/20184) ([nvartolomei](https://github.com/nvartolomei)).
* `zookeeper-dump-tree` に `ctime` オプションを追加しました。ノードの作成時刻をダンプできるようになりました。 [#21842](https://github.com/ClickHouse/ClickHouse/pull/21842) ([Ilya](https://github.com/HumanUser)).





## ClickHouse リリース 21.3 (LTS) {#clickhouse-release-213-lts}

### ClickHouse リリース v21.3, 2021-03-12 {#clickhouse-release-v213-2021-03-12}

#### 後方互換性のない変更 {#backward-incompatible-change-8}

- テーブルTTLを持つ旧構文でのMergeTreeテーブルの作成は、単に無視されるため許可されなくなりました。既存テーブルのアタッチは引き続き可能です。[#20282](https://github.com/ClickHouse/ClickHouse/pull/20282) ([alesapin](https://github.com/alesapin))。
- すべての大文字小文字を区別しない関数名が正規の表現に書き換えられるようになりました。これはプロジェクションクエリルーティング(今後追加される機能)に必要です。[#20174](https://github.com/ClickHouse/ClickHouse/pull/20174) ([Amos Bird](https://github.com/amosbird))。
- `TTL`の式が関数であり、`ORDER BY`キーと同じである場合の`TTL`作成を修正しました。`GROUP BY`を使用した`TTL`でプライマリキー列にカスタム集約を設定できるようになりました。後方互換性のない変更: `GROUP BY`に含まれず、明示的に設定されていないプライマリキー列に対して、TTLが期限切れになった際に`max`の代わりに`any`関数が適用されるようになりました。また、`WHERE`または`GROUP BY`を使用したTTLを使用している場合、ローリングアップデート中のマージ時に例外が発生する可能性があります。[#15450](https://github.com/ClickHouse/ClickHouse/pull/15450) ([Anton Popov](https://github.com/CurtizJ))。

#### 新機能 {#new-feature-8}


- ファイルエンジン設定を追加: `engine_file_empty_if_not_exists` および `engine_file_truncate_on_insert`。[#20620](https://github.com/ClickHouse/ClickHouse/pull/20620) ([M0r64n](https://github.com/M0r64n))。
- 連続する行間の差分を合計する集約関数 `deltaSum` を追加。[#20057](https://github.com/ClickHouse/ClickHouse/pull/20057) ([Russ Frank](https://github.com/rf))。
- `system.part_log` テーブルに新しいカラム `event_time_microseconds` を追加。[#20027](https://github.com/ClickHouse/ClickHouse/pull/20027) ([Bharat Nallan](https://github.com/bharatnc))。
- UTC からのオフセットを秒単位で返す関数 `timezoneOffset(datetime)` を追加。これにより [#issue:19850](https://github.com/ClickHouse/ClickHouse/issues/19850) が解決されます。[#19962](https://github.com/ClickHouse/ClickHouse/pull/19962) ([keenwolf](https://github.com/keen-wolf))。
- 分散テーブルから特定のシャードへのデータ挿入をサポートする設定 `insert_shard_id` を追加。[#19961](https://github.com/ClickHouse/ClickHouse/pull/19961) ([flynn](https://github.com/ucasFL))。
- 関数 `reinterpretAs` を更新し、大きな整数をサポート。[#19691](https://github.com/ClickHouse/ClickHouse/issues/19691) を修正。[#19858](https://github.com/ClickHouse/ClickHouse/pull/19858) ([Maksim Kita](https://github.com/kitaisreal))。
- S3 クライアントにサーバーサイド暗号化カスタマーキー(`x-amz-server-side-encryption-customer-(key/md5)` ヘッダー)のサポートを追加。[リンク](https://docs.aws.amazon.com/AmazonS3/latest/dev/ServerSideEncryptionCustomerKeys.html)を参照してください。[#19428](https://github.com/ClickHouse/ClickHouse/issues/19428) を解決。[#19748](https://github.com/ClickHouse/ClickHouse/pull/19748) ([Vladimir Chebotarev](https://github.com/excitoon))。
- `executable` ディクショナリソースに `implicit_key` オプションを追加。レコードが入力キーと同じ順序で提供される場合、各レコードのキーの出力を省略できます。[#14527](https://github.com/ClickHouse/ClickHouse/issues/14527) を実装。[#19677](https://github.com/ClickHouse/ClickHouse/pull/19677) ([Maksim Kita](https://github.com/kitaisreal))。
- クォータタイプ `query_selects` および `query_inserts` を追加。[#19603](https://github.com/ClickHouse/ClickHouse/pull/19603) ([JackyWoo](https://github.com/JackyWoo))。
- 関数 `extractTextFromHTML` を追加 [#19600](https://github.com/ClickHouse/ClickHouse/pull/19600) ([zlx19950903](https://github.com/zlx19950903)), ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `MergeTree*` エンジンを使用するテーブルに、クエリの同時実行制御のための2つの新しいテーブルレベル設定を追加。設定 `max_concurrent_queries` は、このテーブルに関連する同時実行クエリの数を制限します。設定 `min_marks_to_honor_max_concurrent_queries` は、クエリが少なくともこの数のマークを読み取る場合にのみ前述の設定を適用するよう指示します。[#19544](https://github.com/ClickHouse/ClickHouse/pull/19544) ([Amos Bird](https://github.com/amosbird))。
- user_files ディレクトリからファイルを文字列として読み取る関数 `file` を追加。これは `file` テーブル関数とは異なります。[#issue:18851](https://github.com/ClickHouse/ClickHouse/issues/18851) を実装。[#19204](https://github.com/ClickHouse/ClickHouse/pull/19204) ([keenwolf](https://github.com/keen-wolf))。

#### 実験的機能 {#experimental-feature-7}


- 実験的な`Replicated`データベースエンジンを追加しました。複数のホスト間でDDLクエリをレプリケートします。[#16193](https://github.com/ClickHouse/ClickHouse/pull/16193) ([tavplubix](https://github.com/tavplubix))。
- ウィンドウ関数の実験的サポートを導入しました。`allow_experimental_window_functions = 1`で有効化されます。これは予備的なアルファ品質の実装であり、本番環境での使用には適していません。また、将来のリリースで後方互換性のない変更が行われる予定です。サポートされている機能のリストについては、[ドキュメント](https://github.com/ClickHouse/ClickHouse/blob/master/docs/sql-reference/window-functions/index.md#experimental-window-functions)を参照してください。[#20337](https://github.com/ClickHouse/ClickHouse/pull/20337) ([Alexander Kuzmenkov](https://github.com/akuzm))。
- DiskS3のメタデータファイルをバックアップ/復元する機能を追加しました。[#18377](https://github.com/ClickHouse/ClickHouse/pull/18377) ([Pavel Kovalenko](https://github.com/Jokser))。

#### パフォーマンス改善 {#performance-improvement-8}


* リモートクエリに対するヘッジドリクエスト。`use_hedged_requests` を有効（デフォルトは無効）に設定すると、1つのクエリに対して複数のレプリカと同時に接続を確立できるようになります。既存のレプリカへの接続が `hedged_connection_timeout` 内に確立されない場合、または `receive_data_timeout` 内にデータが受信されなかった場合に、新しい接続が確立されます。クエリは、空ではない progress パケット（あるいは `allow_changing_replica_until_first_data_packet` が有効な場合は data パケット）を最初に送信した接続を利用し、その他の接続はキャンセルされます。`max_parallel_replicas > 1` のクエリもサポートされます。 [#19291](https://github.com/ClickHouse/ClickHouse/pull/19291)（[Kruglov Pavel](https://github.com/Avogar)）。これにより、非常に大規模なクラスタにおけるテイルレイテンシを大幅に削減できます。
* 行レベルセキュリティ式が定義されているテーブルに対して `PREWHERE` 句のサポートを追加し、それに対応する最適化を有効にしました。 [#19576](https://github.com/ClickHouse/ClickHouse/pull/19576) ([Denis Glazachev](https://github.com/traceon))。
* `distributed_aggregation_memory_efficient` 設定がデフォルトで有効になっています。これによりメモリ使用量が削減され、分散クエリのパフォーマンスが向上します。 [#20599](https://github.com/ClickHouse/ClickHouse/pull/20599) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 複数の固定長キーを使用する `GROUP BY` のパフォーマンスを改善しました。 [#20472](https://github.com/ClickHouse/ClickHouse/pull/20472) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* より厳密なエイリアシングを行うことで、集約関数のパフォーマンスを改善しました。 [#19946](https://github.com/ClickHouse/ClickHouse/pull/19946) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 極端なケース（読み取り速度が 50 GB/秒程度のとき）において、パイプラインの単純化と、それに伴うパイプラインスケジューリングにおけるロック競合の低減により、`Memory` テーブルからの読み取りを高速化しました。 [#20468](https://github.com/ClickHouse/ClickHouse/pull/20468) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* HTTP サーバーを一部再実装し、受信および送信データのコピー回数を削減しました。これにより、HTTP 経由で長いレコードを挿入する際の性能が最大 1.5 倍向上します。 [#19516](https://github.com/ClickHouse/ClickHouse/pull/19516) ([Ivan](https://github.com/abyss7)).
* `Memory` テーブルに `compress` 設定を追加します。これを有効にすると、テーブルの RAM 使用量が減ります。マシンやデータセットによっては SELECT がより高速に動作する場合もありますが、常にそうとは限りません。これにより [#20093](https://github.com/ClickHouse/ClickHouse/issues/20093) が解決されます。注: Memory テーブルが MergeTree より遅く動作しうる理由としては、(1) 圧縮がないこと (2) ブロックサイズが固定であること (3) インデックスおよび PREWHERE がないこと などがあります。[#20168](https://github.com/ClickHouse/ClickHouse/pull/20168)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 集約処理のコードをわずかに改善しました。 [#20978](https://github.com/ClickHouse/ClickHouse/pull/20978) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* パフォーマンス向上のために `intDiv`/`modulo` の特殊化を再度追加しました。これにより [#21293](https://github.com/ClickHouse/ClickHouse/issues/21293) が修正されます。このリグレッションは [https://github.com/ClickHouse/ClickHouse/pull/18145](https://github.com/ClickHouse/ClickHouse/pull/18145) で導入されました。[#21307](https://github.com/ClickHouse/ClickHouse/pull/21307)（[Amos Bird](https://github.com/amosbird)）。
* Memory テーブルに対して INSERT SELECT を行う場合、小さなブロックを過度にまとめないようにしました。以前のバージョンでは、INSERT SELECT 実行後に Memory テーブル内で非効率なデータ表現が生成されていました。これにより [#13052](https://github.com/ClickHouse/ClickHouse/issues/13052) が解決されました。[#20169](https://github.com/ClickHouse/ClickHouse/pull/20169)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* DataType パーサーで、計算量が指数オーダーになる可能性のあったケースを少なくとも 1 件、fuzzer によって発見し修正しました。これにより [#20096](https://github.com/ClickHouse/ClickHouse/issues/20096) が解決されました。 [#20132](https://github.com/ClickHouse/ClickHouse/pull/20132)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `do_not_merge_across_partitions_select_final` 設定が 1 の場合、レベルが 0 より大きい単一パートに対する FINAL 付き SELECT の並列実行を可能にしました。 [#19375](https://github.com/ClickHouse/ClickHouse/pull/19375) ([Kruglov Pavel](https://github.com/Avogar)).
* `system.parts` および `system.parts_columns` をクエリする際、要求された列のみを返すようにしました。 [#19570](https://github.com/ClickHouse/ClickHouse/issues/19570) をクローズ。 [#21035](https://github.com/ClickHouse/ClickHouse/pull/21035)（[Anmol Arora](https://github.com/anmolarora)）。
* `avg` 集約関数内の算術式に対して代数的最適化を実行。[#20092](https://github.com/ClickHouse/ClickHouse/issues/20092) を解決。[#20183](https://github.com/ClickHouse/ClickHouse/pull/20183)（[flynn](https://github.com/ucasFL)）。

#### 改善 {#improvement-8}


* テーブル関数で圧縮方式を大文字小文字を区別せずに指定できるようにしました。また、大文字のみを想定してチェックしていた LZMA 圧縮方式を修正しました。 [#21416](https://github.com/ClickHouse/ClickHouse/pull/21416) ([Vladimir Chebotarev](https://github.com/excitoon)).
* 非アクティブなパーツが多すぎる場合に、挿入処理を遅延させるかエラーをスローするための 2 つの設定を追加しました。これは、サーバーがパーツを十分な速さでクリーンアップできない場合に役立ちます。 [#20178](https://github.com/ClickHouse/ClickHouse/pull/20178) ([Amos Bird](https://github.com/amosbird)).
* MySQL クライアントとの互換性を改善: 1. MySQL JDBC 2. mycli。 [#21367](https://github.com/ClickHouse/ClickHouse/pull/21367) ([Amos Bird](https://github.com/amosbird)).
* マテリアライズドビューで参照されている列を `DROP` できないようにしました。 [#21164](https://github.com/ClickHouse/ClickHouse/issues/21164) をクローズ。 [#21303](https://github.com/ClickHouse/ClickHouse/pull/21303)（[flynn](https://github.com/ucasFL)）。
* MySQL の辞書ソースは、SSL/TLS 接続で時々発生する想定外の接続障害（`Lost connection to MySQL server during query`）を再試行するようになりました。 [#21237](https://github.com/ClickHouse/ClickHouse/pull/21237) ([Alexander Kazakov](https://github.com/Akazz)).
* ユーザビリティの改善: `DateTime64` のパースをより一貫したものにしました。スケーリングされた整数としてサブ秒精度付きの unix タイムスタンプが指定されているケース（`1111111111.222` ではなく `1111111111222` のような値）を認識できるようにしました。これにより [#13194](https://github.com/ClickHouse/ClickHouse/issues/13194) がクローズされました。 [#21053](https://github.com/ClickHouse/ClickHouse/pull/21053)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `distributed_group_by_no_merge` 使用時には、ソート済みブロックのマージをイニシエータ側でのみ行うように変更。 [#20882](https://github.com/ClickHouse/ClickHouse/pull/20882) ([Azat Khuzhin](https://github.com/azat)).
* MySQL ソースの設定を読み込む際、ClickHouse は同じ priority を持つレプリカのリストをランダム化し、MySQL エンドポイント選択のラウンドロビンロジックが確実に機能するようになりました。これにより [#20629](https://github.com/ClickHouse/ClickHouse/issues/20629) が解決されました。[#20632](https://github.com/ClickHouse/ClickHouse/pull/20632)（[Alexander Kazakov](https://github.com/Akazz)）。
* 関数 &#39;reinterpretAs(x, Type)&#39; は &#39;reinterpret(x, Type)&#39; に改名されました。 [#20611](https://github.com/ClickHouse/ClickHouse/pull/20611) ([Maksim Kita](https://github.com/kitaisreal)).
* RabbitMQ エンジンに vhost のサポートを追加 [#20576](https://github.com/ClickHouse/ClickHouse/issues/20576)。 [#20596](https://github.com/ClickHouse/ClickHouse/pull/20596) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 配列とタプルを組み合わせたデータ型のシリアル化を改善しました。enum データ型と protobuf の enum 型の対応を改善しました。`Map` データ型のシリアル化を修正しました。省略された値には、デフォルト値が自動的に設定されるようになりました。 [#20506](https://github.com/ClickHouse/ClickHouse/pull/20506) ([Vitaly Baranov](https://github.com/vitlibar)).
* 分散 DDL タスクの実行と DDL キューのクリーンアップ処理の間に発生していたレースコンディションを修正しました。これにより、アクティブなワーカーが存在する場合には ZooKeeper から DDL タスクが削除されなくなりました。[#20016](https://github.com/ClickHouse/ClickHouse/issues/20016) を修正しました。[#20448](https://github.com/ClickHouse/ClickHouse/pull/20448)（[tavplubix](https://github.com/tavplubix)）。
* Alpine イメージで FQDN およびその他の DNS 関連の関数が正しく動作するようにしました。 [#20336](https://github.com/ClickHouse/ClickHouse/pull/20336) ([filimonov](https://github.com/filimonov)).
* 明示的に禁止されている関数に対しては、早期の定数畳み込みを行わないようにしました。 [#20303](https://github.com/ClickHouse/ClickHouse/pull/20303) ([Azat Khuzhin](https://github.com/azat)).
* 整数からDecimal型への暗黙の変換が、整数値がDecimal型に収まらない場合でも成功してしまうことがありました。現在は `ARGUMENT_OUT_OF_BOUND` をスローするようになりました。 [#20232](https://github.com/ClickHouse/ClickHouse/pull/20232) ([tavplubix](https://github.com/tavplubix))。
* ロック不要の `SYSTEM FLUSH DISTRIBUTED`。 [#20215](https://github.com/ClickHouse/ClickHouse/pull/20215) ([Azat Khuzhin](https://github.com/azat)).
* `count(constant)` と `sum(1)` を `count()` に正規化しました。これはプロジェクションでのクエリルーティングに必要です。 [#20175](https://github.com/ClickHouse/ClickHouse/pull/20175) ([Amos Bird](https://github.com/amosbird))。
* ビットマップ関数で、すべてのネイティブ整数型をサポートしました。 [#20171](https://github.com/ClickHouse/ClickHouse/pull/20171) ([Amos Bird](https://github.com/amosbird))。
* `CacheDictionary`、`ComplexCacheDictionary`、`SSDCacheDictionary`、`SSDComplexKeyDictionary` を、内部インデックスとして LRUHashMap を使用するように更新しました。 [#20164](https://github.com/ClickHouse/ClickHouse/pull/20164) ([Maksim Kita](https://github.com/kitaisreal)).
* 設定 `access_management` は、起動時に環境変数 `CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT` を指定することで構成できるようになりました。デフォルトは無効（`0`）で、これは従来の値と同じです。 [#20139](https://github.com/ClickHouse/ClickHouse/pull/20139) ([Marquitos](https://github.com/sonirico)).
* DateTime64 用の `toDateTime64(toDate()/toDateTime())` を修正 - DateTime の挙動に合わせて DateTime64 のクランプ処理を実装。 [#20131](https://github.com/ClickHouse/ClickHouse/pull/20131) ([Azat Khuzhin](https://github.com/azat)).
* クォータの改善：クォータ計算では `SHOW TABLES` は 2 つのクエリではなく 1 つのクエリとしてカウントされるようになりました。`SYSTEM` クエリもクォータを消費するようになりました。クォータ消費におけるインターバル終了時刻の計算を修正しました。 [#20106](https://github.com/ClickHouse/ClickHouse/pull/20106) ([Vitaly Baranov](https://github.com/vitlibar))。
* `system.zookeeper` テーブルでの `path IN (set)` 式をサポートしました。 [#20105](https://github.com/ClickHouse/ClickHouse/pull/20105) ([小路](https://github.com/nicelulu))。
* `system.tables` 内で `MaterializeMySQL` テーブルの詳細情報をすべて表示。[#20051](https://github.com/ClickHouse/ClickHouse/pull/20051)（[Stig Bakken](https://github.com/stigsb)）。
* 実行型辞書におけるデータレースを修正しました。これは、スクリプトが入力を無視してデータを返すという誤用時にのみ発生するものでした。 [#20045](https://github.com/ClickHouse/ClickHouse/pull/20045) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* MYSQL&#95;OPT&#95;RECONNECT オプションの値は、mysql レプリカの config セクションにある &quot;opt&#95;reconnect&quot; パラメータで制御できるようになりました。 [#19998](https://github.com/ClickHouse/ClickHouse/pull/19998) ([Alexander Kazakov](https://github.com/Akazz))。
* ユーザーが `JSONExtract` 関数を `Float32` 型を指定して呼び出した場合、結果型への不正確な変換を許可するようにしました。例えば、JSON 中の数値 `0.1` は倍精度浮動小数点数であり、Float32 では正確に表現できませんが、それでもユーザーはその値を取得したいと考えます。以前のバージョンでは、変換が不正確であることを示すため、非 Nullable 型の場合は 0 を、Nullable 型の場合は NULL を返していました。このロジック自体は 100% 正しかったものの、ユーザーにとっては意外であり、疑問を招いていました。この変更により [#13962](https://github.com/ClickHouse/ClickHouse/issues/13962) がクローズされました。 [#19960](https://github.com/ClickHouse/ClickHouse/pull/19960) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `INSERT` 時に対象の `Distributed` テーブルとブロック構造が一致しない場合、自動的に変換する機能を追加。 [#19947](https://github.com/ClickHouse/ClickHouse/pull/19947) ([Azat Khuzhin](https://github.com/azat)).
* `system.distributed_ddl_queue` テーブルの改善。再起動後に MaxDDLEntryID を直前の値で初期化します。この PR 以前は、新しい DDLTask が処理されるまで MaxDDLEntryID は 0 のままでした。 [#19924](https://github.com/ClickHouse/ClickHouse/pull/19924) ([Amos Bird](https://github.com/amosbird)).
* `system.parts` に `MaterializeMySQL` テーブルを表示できるようにしました。 [#19770](https://github.com/ClickHouse/ClickHouse/pull/19770) ([Stig Bakken](https://github.com/stigsb)).
* `Buffer` プロファイル用に個別の設定ディレクティブを追加。[#19721](https://github.com/ClickHouse/ClickHouse/pull/19721)（[Azat Khuzhin](https://github.com/azat)）。
* JOIN に関係しない条件を WHERE 句に移動するようにしました。 [#18720](https://github.com/ClickHouse/ClickHouse/issues/18720)。 [#19685](https://github.com/ClickHouse/ClickHouse/pull/19685) ([hexiaoting](https://github.com/hexiaoting))。
* 非同期送信される保留中のバイト数に基づいて `Distributed` への INSERT をスロットルできる機能を追加しました（`Distributed` エンジン用の `bytes_to_delay_insert` / `max_delay_to_insert` および `bytes_to_throw_insert` 設定が追加されました）。 [#19673](https://github.com/ClickHouse/ClickHouse/pull/19673) ([Azat Khuzhin](https://github.com/azat))。
* デストラクタで書き込みエラーが無視されてしまうまれなケースをいくつか修正しました。 [#19451](https://github.com/ClickHouse/ClickHouse/pull/19451) ([Azat Khuzhin](https://github.com/azat)).
* 致命的なエラーのスタックトレースにインラインフレームを出力します。 [#19317](https://github.com/ClickHouse/ClickHouse/pull/19317) ([Ivan](https://github.com/abyss7)).

#### バグ修正 {#bug-fix-7}


* ZooKeeper への冗長な再接続と、単一の ClickHouse サーバーで 2 つのアクティブなセッションが同時に存在し得る問題を修正しました。これら 2 つの問題はいずれも #14678 で導入されたものです。 [#21264](https://github.com/ClickHouse/ClickHouse/pull/21264) ([alesapin](https://github.com/alesapin)).
* `Values` フォーマットから `LowCardinality` 列を持つテーブルにデータを挿入する際に発生していた `Bad cast from type ... to DB::ColumnLowCardinality` エラーを修正。#21140 を解決 [#21357](https://github.com/ClickHouse/ClickHouse/pull/21357)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 述語にテーブル自身が含まれる場合に、レプリケーションなしの MergeTree テーブルエンジンに対する `ALTER DELETE` ミューテーションで発生するデッドロックを修正しました。[#20558](https://github.com/ClickHouse/ClickHouse/issues/20558) を修正。[#21477](https://github.com/ClickHouse/ClickHouse/pull/21477)（[alesapin](https://github.com/alesapin)）。
* 障害発生時の分散クエリで SIGSEGV が発生する問題を修正。[#21434](https://github.com/ClickHouse/ClickHouse/pull/21434) ([Azat Khuzhin](https://github.com/azat)).
* これにより、`ALTER MODIFY COLUMN` クエリがパーティションキー、スキップインデックス、TTL などの変更に正しく適用されるようになりました。[#13675](https://github.com/ClickHouse/ClickHouse/issues/13675) を修正しました。[#21334](https://github.com/ClickHouse/ClickHouse/pull/21334)（[alesapin](https://github.com/alesapin)）。
* サブクエリからの `TOTALS` との結合における `join_use_nulls` のバグを修正しました。これにより [#19362](https://github.com/ClickHouse/ClickHouse/issues/19362) および [#21137](https://github.com/ClickHouse/ClickHouse/issues/21137) をクローズしました。[#21248](https://github.com/ClickHouse/ClickHouse/pull/21248)（[vdimir](https://github.com/vdimir)）。
* `UNION` を含むクエリに対する `EXPLAIN` がクラッシュする問題を修正。[#20876](https://github.com/ClickHouse/ClickHouse/issues/20876)、[#21170](https://github.com/ClickHouse/ClickHouse/issues/21170) を修正。[#21246](https://github.com/ClickHouse/ClickHouse/pull/21246)（[flynn](https://github.com/ucasFL)）。
* 現在、ミューテーションはそれをサポートするテーブルエンジン（MergeTree ファミリー、Memory、MaterializedView）でのみ実行できます。他のエンジンでは、より明確なエラーメッセージが返されます。 [#21168](https://github.com/ClickHouse/ClickHouse/issues/21168) を修正。 [#21183](https://github.com/ClickHouse/ClickHouse/pull/21183)（[alesapin](https://github.com/alesapin)）。
* [#21112](https://github.com/ClickHouse/ClickHouse/issues/21112) を修正。`INSERT` クエリで重複行が発生する可能性のあったバグを修正（コールバックの 1 つの呼び出しがわずかに遅れた場合）。[#21138](https://github.com/ClickHouse/ClickHouse/pull/21138)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* `input_format_null_as_default` が Nullable 型でも有効になるように修正しました。これにより [#21116](https://github.com/ClickHouse/ClickHouse/issues/21116) が解決されます。 [#21121](https://github.com/ClickHouse/ClickHouse/pull/21121) ([Amos Bird](https://github.com/amosbird)).
* Tuple を Map にキャストする際のバグを修正。[#21029](https://github.com/ClickHouse/ClickHouse/issues/21029) をクローズ。[#21120](https://github.com/ClickHouse/ClickHouse/pull/21120)（[hexiaoting](https://github.com/hexiaoting)）。
* カスタム（デフォルト以外）の ZooKeeper クラスターを使用する Replicated*MergeTree を DROP したときに発生するメタデータリークを修正。 [#21119](https://github.com/ClickHouse/ClickHouse/pull/21119) ([fastio](https://github.com/fastio)).
* joinGet で LowCardinality キーを使用する際の型不一致の問題を修正。これにより [#21114](https://github.com/ClickHouse/ClickHouse/issues/21114) が解決されます。 [#21117](https://github.com/ClickHouse/ClickHouse/pull/21117) ([Amos Bird](https://github.com/amosbird))。
* `Replicated(*)MergeTree` エンジンで他のパラメータを指定する必要がある場合に、`default_replica_path` および `default_replica_name` の値が有効に機能しない問題を修正。 [#21060](https://github.com/ClickHouse/ClickHouse/pull/21060) ([mxzlxy](https://github.com/mxzlxy)).
* `DateTime64` 型の、特定のパターンで細工された範囲外の値をフォーマットする際に、メモリ範囲外アクセスが発生する可能性がありました。これにより [#20494](https://github.com/ClickHouse/ClickHouse/issues/20494) がクローズされました。また、これにより [#20543](https://github.com/ClickHouse/ClickHouse/issues/20543) がクローズされました。 [#21023](https://github.com/ClickHouse/ClickHouse/pull/21023)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `StorageJoin` への並列挿入をブロックするようにしました。 [#21009](https://github.com/ClickHouse/ClickHouse/pull/21009) ([vdimir](https://github.com/vdimir)).
* `ALTER MODIFY COLUMN` が、必ず失敗することが分かっている mutation を作成してしまう動作を修正しました。 [#21007](https://github.com/ClickHouse/ClickHouse/pull/21007) ([Anton Popov](https://github.com/CurtizJ)).
* [#9969](https://github.com/ClickHouse/ClickHouse/issues/9969) をクローズ。大きなデータ量で、構造がやや複雑かつ JSON 出力フォーマットを使用している場合に再現していた Brotli の HTTP 圧縮エラーを修正。リングバッファ内の「未初期化データへのまれなアクセスの修正」を取り込むため、Brotli を最新バージョンに更新。[#20991](https://github.com/ClickHouse/ClickHouse/pull/20991)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* クエリのキャンセル時に発生する「Empty task was returned from async task queue」エラーを修正。 [#20881](https://github.com/ClickHouse/ClickHouse/pull/20881) ([Azat Khuzhin](https://github.com/azat)).
* MySQL 5.7 クライアントを使用して ClickHouse サーバーに接続した際に `USE database;` クエリが動作しなかった問題を修正しました。これにより [#18926](https://github.com/ClickHouse/ClickHouse/issues/18926) が解決されました。 [#20878](https://github.com/ClickHouse/ClickHouse/pull/20878) ([tavplubix](https://github.com/tavplubix)).
* 集約関数における `-State` コンビネータとの併用時の `-Distinct` コンビネータの扱いを修正しました。 [#20866](https://github.com/ClickHouse/ClickHouse/pull/20866) ([Anton Popov](https://github.com/CurtizJ)).
* `UNION DISTINCT` と `LIMIT` 句を含むサブクエリを修正し、[#20597](https://github.com/ClickHouse/ClickHouse/issues/20597) をクローズ。 [#20610](https://github.com/ClickHouse/ClickHouse/pull/20610)（[flynn](https://github.com/ucasFL)）。
* 辞書内に存在しないキーを検索するクエリにおいて発生していた、辞書の動作の不整合を修正しました。 [#20578](https://github.com/ClickHouse/ClickHouse/pull/20578) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* スカラーサブクエリおよびインデックス用サブクエリで使用するスレッド数を修正（[#19007](https://github.com/ClickHouse/ClickHouse/issues/19007) 以降、常に単一スレッドのみが使用されていた問題を修正）。[#20457](https://github.com/ClickHouse/ClickHouse/issues/20457)、[#20512](https://github.com/ClickHouse/ClickHouse/issues/20512) を修正。[#20550](https://github.com/ClickHouse/ClickHouse/pull/20550)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* リモートクエリから不明なパケットを受信した場合に発生し得たクラッシュを修正（[#17868](https://github.com/ClickHouse/ClickHouse/issues/17868) で導入された問題）。[#20547](https://github.com/ClickHouse/ClickHouse/pull/20547)（[Azat Khuzhin](https://github.com/azat)）。
* 非同期 INSERT のディレクトリ名をパースする際に適切なチェックを追加（SIGSEGV を引き起こしていた問題を修正）。 [#20498](https://github.com/ClickHouse/ClickHouse/pull/20498) ([Azat Khuzhin](https://github.com/azat)).
* 浮動小数点キーに対して関数 `transform` が正しく動作しなかった問題を修正。[#20460](https://github.com/ClickHouse/ClickHouse/issues/20460) をクローズ。[#20479](https://github.com/ClickHouse/ClickHouse/pull/20479)（[flynn](https://github.com/ucasFL)）。
* WITH エイリアスをサブクエリに伝播する際に発生する無限ループを修正。これにより [#20388](https://github.com/ClickHouse/ClickHouse/issues/20388) が解決されます。[#20476](https://github.com/ClickHouse/ClickHouse/pull/20476)（[Amos Bird](https://github.com/amosbird)）。
* HTTP クライアントが接続を切断したときにサーバーが異常終了する問題を修正しました。 [#20464](https://github.com/ClickHouse/ClickHouse/pull/20464) ([Azat Khuzhin](https://github.com/azat)).
* JOIN に SELECT からの定数が含まれる場合に `join_use_nulls=1` で発生する `LOGICAL_ERROR` を修正。 [#20461](https://github.com/ClickHouse/ClickHouse/pull/20461) ([Azat Khuzhin](https://github.com/azat)).
* テーブル関数 `view` が式リスト内で使用されているかをチェックし、エラーをスローするようにしました。これにより [#20342](https://github.com/ClickHouse/ClickHouse/issues/20342) が修正されました。[#20350](https://github.com/ClickHouse/ClickHouse/pull/20350)（[Amos Bird](https://github.com/amosbird)）。
* RANGE&#95;HASHED() 辞書における無効なデリファレンスを回避。 [#20345](https://github.com/ClickHouse/ClickHouse/pull/20345) ([Azat Khuzhin](https://github.com/azat)).
* `join_use_nulls=1` 設定時に発生するヌルポインタ参照を修正しました。 [#20344](https://github.com/ClickHouse/ClickHouse/pull/20344) ([Azat Khuzhin](https://github.com/azat)).
* スケールの異なる 2 つの定数 Decimal 型同士の 2 項演算で誤った結果が返される問題を修正しました。[#20283](https://github.com/ClickHouse/ClickHouse/issues/20283) を修正。[#20339](https://github.com/ClickHouse/ClickHouse/pull/20339)（[Maksim Kita](https://github.com/kitaisreal)）。
* `ReplicatedMergeTree` テーブルエンジンファミリーにおいて、失敗したバックグラウンドタスクを過剰に再試行してしまう問題を修正しました。これにより、ログが過度に冗長になり、CPU 負荷が増加する可能性がありました。[#20203](https://github.com/ClickHouse/ClickHouse/issues/20203) の問題を修正しました。 [#20335](https://github.com/ClickHouse/ClickHouse/pull/20335)（[alesapin](https://github.com/alesapin)）。
* `*CollapsingMergeTree` および `ReplacingMergeTree` テーブルエンジンのバージョン列に対する `DROP` および `RENAME` 操作を制限しました。 [#20300](https://github.com/ClickHouse/ClickHouse/pull/20300) ([alesapin](https://github.com/alesapin)).
* 破損した JSON を処理する際に、ファイル全体をメモリに読み込もうとしてアロケータから例外が発生していた挙動を修正しました。 [#19719](https://github.com/ClickHouse/ClickHouse/issues/19719) を修正。 [#20286](https://github.com/ClickHouse/ClickHouse/pull/20286)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* 垂直マージをサポートしない `MergeTree` テーブルエンジンファミリーにおいて、垂直マージ時に発生していた例外を修正しました。[#20259](https://github.com/ClickHouse/ClickHouse/issues/20259) を修正します。[#20279](https://github.com/ClickHouse/ClickHouse/pull/20279)（[alesapin](https://github.com/alesapin)）。
* シャットダウン中の設定再読み込み時にまれに発生するサーバークラッシュを修正。[#19689](https://github.com/ClickHouse/ClickHouse/issues/19689) を修正。[#20224](https://github.com/ClickHouse/ClickHouse/pull/20224)（[alesapin](https://github.com/alesapin)）。
* INSERT SELECT での CTE の扱いを修正。これにより [#20187](https://github.com/ClickHouse/ClickHouse/issues/20187) および [#20195](https://github.com/ClickHouse/ClickHouse/issues/20195) が解決される。[#20211](https://github.com/ClickHouse/ClickHouse/pull/20211)（[Amos Bird](https://github.com/amosbird)）。
* [#19314](https://github.com/ClickHouse/ClickHouse/issues/19314) を修正しました。[#20156](https://github.com/ClickHouse/ClickHouse/pull/20156)（[Ivan](https://github.com/abyss7)）。
* 特殊なタイムゾーンを正しく扱えるように `toMinute` 関数を修正。 [#20149](https://github.com/ClickHouse/ClickHouse/pull/20149) ([keenwolf](https://github.com/keen-wolf)).
* `then`/`else` ブランチの結果が `Tuple` 型である `if` 関数を含むクエリの実行後にサーバーがクラッシュする問題を修正。`Tuple` 型は `Array` もしくは他の複合型を含む必要があります。[#18356](https://github.com/ClickHouse/ClickHouse/issues/18356) を修正。[#20133](https://github.com/ClickHouse/ClickHouse/pull/20133)（[alesapin](https://github.com/alesapin)）。
* `MongoDB` テーブルエンジンは、データを読み取るときにのみ接続を確立するようになりました。`ATTACH TABLE` はこれ以上接続を試みることはありません。[#20110](https://github.com/ClickHouse/ClickHouse/pull/20110)（[Vitaly Baranov](https://github.com/vitlibar)）。
* StorageJoin のバグ修正。 [#20079](https://github.com/ClickHouse/ClickHouse/pull/20079) ([vdimir](https://github.com/vdimir)).
* 負の数を小さな除数で割ったときに剰余を計算するケースで、負の結果を保持するには結果のデータ型が十分に大きくない問題を修正しました。これにより [#20052](https://github.com/ClickHouse/ClickHouse/issues/20052) がクローズされます。 [#20067](https://github.com/ClickHouse/ClickHouse/pull/20067) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* MaterializeMySQL：複数のテーブルを更新するステートメントに対するレプリケーションを修正しました。 [#20066](https://github.com/ClickHouse/ClickHouse/pull/20066) ([Håvard Kvålen](https://github.com/havardk)).
* 初期化スクリプトの実行中に Docker で発生する &quot;Connection refused&quot; エラーを防止。[#20012](https://github.com/ClickHouse/ClickHouse/pull/20012) ([filimonov](https://github.com/filimonov)).
* `EmbeddedRocksDB` は実験的なストレージです。適切な型チェックが行われていなかった問題を修正し、コードを簡素化しました。これにより [#19967](https://github.com/ClickHouse/ClickHouse/issues/19967) がクローズされます。 [#19972](https://github.com/ClickHouse/ClickHouse/pull/19972) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 引数の型が Int32 以外の任意の整数型で `Nullable(T)` の場合に発生していた、関数 `fromModifiedJulianDay` のセグメンテーションフォルトを修正。 [#19959](https://github.com/ClickHouse/ClickHouse/pull/19959) ([PHO](https://github.com/depressed-pho)).
* BloomFilter インデックスのクラッシュを修正。[#19757](https://github.com/ClickHouse/ClickHouse/issues/19757) を解決。[#19884](https://github.com/ClickHouse/ClickHouse/pull/19884)（[Maksim Kita](https://github.com/kitaisreal)）。
* system.text&#95;log が有効になっている場合にデッドロックが発生する可能性のある問題がありました。これにより [#19874](https://github.com/ClickHouse/ClickHouse/issues/19874) が修正されました。[#19875](https://github.com/ClickHouse/ClickHouse/pull/19875)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `dictGet()` を含むデフォルト式を持つテーブルが存在する場合にサーバーを起動できない問題を修正しました。辞書をロードせずに `dictGet()` の戻り値の型を取得できるようにしました。 [#19805](https://github.com/ClickHouse/ClickHouse/pull/19805) ([Vitaly Baranov](https://github.com/vitlibar)).
* clickhouse-client で `select` のみを実行した際に発生する abort 例外を修正。 [#19790](https://github.com/ClickHouse/ClickHouse/pull/19790) ([taiyang-li](https://github.com/taiyang-li)).
* 複数の clickhouse-copier を起動した場合に、パーツを宛先テーブルへ移動する処理が失敗することがある不具合を修正しました。 [#19743](https://github.com/ClickHouse/ClickHouse/pull/19743) ([madianjun](https://github.com/mdianjun)).
* `ON CLUSTER` クエリを実行するバックグラウンドスレッドが、削除済みのレプリケートテーブルの処理を待ち続けてハングする可能性がありました。これは修正されました。 [#19684](https://github.com/ClickHouse/ClickHouse/pull/19684) ([yiguolei](https://github.com/yiguolei)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-8}

- AVX-2をグローバルに有効化してClickHouseをビルドできるようになりました。最新のCPUでわずかなパフォーマンス向上が得られます。本番環境での使用は推奨されず、現時点では公式ビルドとしてサポートされません。[#20180](https://github.com/ClickHouse/ClickHouse/pull/20180) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- Coverityで発見された問題の一部を修正しました。[#19964](https://github.com/ClickHouse/ClickHouse/issues/19964)を参照してください。[#20010](https://github.com/ClickHouse/ClickHouse/pull/20010) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- gdb下で変更されたバイナリでの起動を許可するようになりました。以前のバージョンでは、起動前にgdbでブレークポイントを設定すると、整合性チェックの失敗によりサーバーが起動を拒否していました。[#21258](https://github.com/ClickHouse/ClickHouse/pull/21258) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- Kafkaの異なる圧縮方式に関するテストを追加しました。[#21111](https://github.com/ClickHouse/ClickHouse/pull/21111) ([filimonov](https://github.com/filimonov))。
- test_storage_kerberized_hdfsテストのポート競合を修正しました。[#19974](https://github.com/ClickHouse/ClickHouse/pull/19974) ([Ilya Yatsishin](https://github.com/qoega))。
- 統合テストでdockerの起動に失敗した際に`stdout`と`stderr`をログに出力するようになりました。このPR以前は、このケースで非常に短いエラーメッセージしか表示されず、問題の調査に役立ちませんでした。[#20631](https://github.com/ClickHouse/ClickHouse/pull/20631) ([Vitaly Baranov](https://github.com/vitlibar))。


## ClickHouse リリース 21.2 {#clickhouse-release-212}

### ClickHouse リリース v21.2.2.8-stable, 2021-02-07 {#clickhouse-release-v21228-stable-2021-02-07}

#### 後方互換性のない変更 {#backward-incompatible-change-9}

- ビット演算関数（`bitAnd`、`bitOr` など）は浮動小数点引数に対して使用できなくなりました。整数への明示的なキャストが必要です。[#19853](https://github.com/ClickHouse/ClickHouse/pull/19853) ([Azat Khuzhin](https://github.com/azat))。
- 浮動小数点数に対する `lcm`/`gcd` を禁止しました。[#19532](https://github.com/ClickHouse/ClickHouse/pull/19532) ([Azat Khuzhin](https://github.com/azat))。
- `OPTIMIZE TABLE`/マージのメモリ追跡を修正しました。`OPTIMIZE TABLE`/マージに対するクエリメモリ制限とサンプリングを考慮するようにしました。[#18772](https://github.com/ClickHouse/ClickHouse/pull/18772) ([Azat Khuzhin](https://github.com/azat))。
- パーティションキーとして浮動小数点カラムを使用できなくなりました。[#18421](https://github.com/ClickHouse/ClickHouse/issues/18421#event-4147046255) を参照してください。[#18464](https://github.com/ClickHouse/ClickHouse/pull/18464) ([hexiaoting](https://github.com/hexiaoting))。
- 型定義における過剰な括弧はサポートされなくなりました。例：`Array((UInt8))`。

#### 新機能 {#new-feature-9}


* `PostgreSQL` テーブルエンジンを追加（select/insert の両方に対応し、多次元配列をサポート）、テーブル関数としても利用可能。`PostgreSQL` ディクショナリソースを追加。`PostgreSQL` データベースエンジンを追加。[#18554](https://github.com/ClickHouse/ClickHouse/pull/18554)（[Kseniia Sumarokova](https://github.com/kssenii)）。
* データ型 `Nested` は任意の深さのネストをサポートするようになりました。`Array` の `size0`、`Nullable` の `null`、`Tuple` 要素の名前などの複合型のサブカラムが導入され、カラム全体を読み込まずに読み取ることができます。 [#17310](https://github.com/ClickHouse/ClickHouse/pull/17310) ([Anton Popov](https://github.com/CurtizJ)).
* `FlatDictionary`、`HashedDictionary`、`ComplexKeyHashedDictionary`、`DirectDictionary`、`ComplexKeyDirectDictionary`、`RangeHashedDictionary` に `Nullable` のサポートを追加しました。 [#18236](https://github.com/ClickHouse/ClickHouse/pull/18236) ([Maksim Kita](https://github.com/kitaisreal)).
* `system.distributed_ddl_queue` という新しいテーブルを追加し、DDL ワーカーキュー内のクエリを表示できるようにしました。[#17656](https://github.com/ClickHouse/ClickHouse/pull/17656) ([Bharat Nallan](https://github.com/bharatnc))。
* LDAPユーザーディレクトリのユーザーに対して、LDAPグループ名および属性値全般をローカルロールにマッピングする機能を追加しました。 [#17211](https://github.com/ClickHouse/ClickHouse/pull/17211) ([Denis Glazachev](https://github.com/traceon)).
* テーブル関数 `cluster` への `INSERT` をサポートし、テーブル関数 `remote` および `cluster` の両方で、シャーディングキーを指定してデータをノード間に分散できるようにしました。 [#16752](https://github.com/ClickHouse/ClickHouse/issues/16752) をクローズ。 [#18264](https://github.com/ClickHouse/ClickHouse/pull/18264) ([flynn](https://github.com/ucasFL))。
* XML の文字参照をデコードする関数 `decodeXMLComponent` を追加しました。例: `SELECT decodeXMLComponent('Hello,&quot;world&quot;!')` [#17659](https://github.com/ClickHouse/ClickHouse/issues/17659)。[#18542](https://github.com/ClickHouse/ClickHouse/pull/18542)（[nauta](https://github.com/nautaa)）。
* 関数 `parseDateTimeBestEffortUSOrZero`、`parseDateTimeBestEffortUSOrNull` を追加しました。 [#19712](https://github.com/ClickHouse/ClickHouse/pull/19712) ([Maksim Kita](https://github.com/kitaisreal)).
* `sign` 数学関数を追加しました。 [#19527](https://github.com/ClickHouse/ClickHouse/pull/19527) ([flynn](https://github.com/ucasFL))。
* 使用される機能（関数、テーブルエンジンなど）に関する情報を system.query&#95;log に追加。[#18495](https://github.com/ClickHouse/ClickHouse/issues/18495)。[#19371](https://github.com/ClickHouse/ClickHouse/pull/19371) ([Kseniia Sumarokova](https://github.com/kssenii))。
* 関数 `formatDateTime` は、日付を四半期単位でフォーマットするための `%Q` 修飾子をサポートするようになりました。 [#19224](https://github.com/ClickHouse/ClickHouse/pull/19224) ([Jianmei Zhang](https://github.com/zhangjmruc))。
* Play UI で MetaKey+Enter のホットキー割り当てに対応しました。 [#19012](https://github.com/ClickHouse/ClickHouse/pull/19012) ([sundyli](https://github.com/sundy-li)).
* map データ型向けに 3 つの関数を追加: 1. `mapContains(map, key)` は、`map` のキーに 2 番目のパラメータ `key` が含まれているかどうかを判定する。2. `mapKeys(map)` はすべてのキーを配列形式で返す。3. `mapValues(map)` はすべての値を配列形式で返す。 [#18788](https://github.com/ClickHouse/ClickHouse/pull/18788) ([hexiaoting](https://github.com/hexiaoting))。
* [#18494](https://github.com/ClickHouse/ClickHouse/issues/18494) に関連する `log_comment` 設定を追加。 [#18549](https://github.com/ClickHouse/ClickHouse/pull/18549) ([Zijie Lu](https://github.com/TszKitLo40))。
* `argMin` および `argMax` 関数でタプル型引数をサポートしました。 [#17359](https://github.com/ClickHouse/ClickHouse/pull/17359) ([Ildus Kurbangaliev](https://github.com/ildus))。
* `EXISTS VIEW` 構文をサポートしました。[#18552](https://github.com/ClickHouse/ClickHouse/pull/18552) ([Du Chuan](https://github.com/spongedu))。
* `SELECT ALL` 構文を追加し、[#18706](https://github.com/ClickHouse/ClickHouse/issues/18706) をクローズ。[#18723](https://github.com/ClickHouse/ClickHouse/pull/18723)（[flynn](https://github.com/ucasFL)）。

#### パフォーマンス改善 {#performance-improvement-9}

- `stat`システムコールの回数を削減することで、パーツの削除を高速化しました。これは以前存在していた最適化を復活させるものです。`IDisk`のインターフェースをより安全にしました。これにより[#19065](https://github.com/ClickHouse/ClickHouse/issues/19065)が解決されます。[#19086](https://github.com/ClickHouse/ClickHouse/pull/19086) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `WITH`文で宣言されたエイリアスがインデックス解析で適切に使用されるようになりました。`WITH column AS alias SELECT ... WHERE alias = ...`のようなクエリでインデックスが使用できるようになりました。[#18896](https://github.com/ClickHouse/ClickHouse/pull/18896) ([Amos Bird](https://github.com/amosbird))。
- `optimize_alias_column_prediction`を追加しました(デフォルトで有効)。これにより以下が実現されます: - パーティションプルーニングおよびセカンダリインデックスを使用したデータスキップ時に、WHERE句内のエイリアス列を考慮します; - optimize_trivial_countの単純なカウントクエリにおいて、WHERE句内のエイリアス列を考慮します; - optimize_aggregation_in_order/optimize_read_in_orderにおいて、GROUP BY/ORDER BY内のエイリアス列を考慮します。[#16995](https://github.com/ClickHouse/ClickHouse/pull/16995) ([sundyli](https://github.com/sundy-li))。
- 集約関数`sum`を高速化しました。この改善は合成ベンチマークでのみ確認でき、実用上はあまり効果がありません。[#19216](https://github.com/ClickHouse/ClickHouse/pull/19216) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- libc++を更新し、より優れたパフォーマンスを提供するために別のABIを使用するようにしました。[#18914](https://github.com/ClickHouse/ClickHouse/pull/18914) ([Danila Kutenin](https://github.com/danlark1))。
- 論理的に等価な場合、`sumIf()`および`sum(if())`関数を`countIf()`関数に書き換えるようにしました。[#17041](https://github.com/ClickHouse/ClickHouse/pull/17041) ([flynn](https://github.com/ucasFL))。
- S3接続に接続プールを使用するようにしました。これは`s3_max_connections`設定で制御されます。[#13405](https://github.com/ClickHouse/ClickHouse/pull/13405) ([Vladimir Chebotarev](https://github.com/excitoon))。
- 文字列カラムの圧縮率を向上させ、容量を節約するためにzstd longオプションのサポートを追加しました。[#17184](https://github.com/ClickHouse/ClickHouse/pull/17184) ([ygrek](https://github.com/ygrek))。
- 接続ごとの設定へのアクセスを削除することで、サーバーのレイテンシをわずかに改善しました。[#19863](https://github.com/ClickHouse/ClickHouse/pull/19863) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `Buffer`エンジンの複数レイヤーにおけるロック競合を削減しました。[#19379](https://github.com/ClickHouse/ClickHouse/pull/19379) ([Azat Khuzhin](https://github.com/azat))。
- クエリプランの`Filter`ステップを`Expression + Filter`のペアに分割することをサポートしました。`Expression + Expression`のマージ最適化([#17458](https://github.com/ClickHouse/ClickHouse/issues/17458))と組み合わせることで、`Filter`ステップ後の一部の式の実行を遅延させることができます。[#19253](https://github.com/ClickHouse/ClickHouse/pull/19253) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。

#### 改善 {#improvement-9}


* `table` から少なくとも 1 列を選択できる場合、`SELECT count() FROM table` を実行できるようになりました。この PR は [#10639](https://github.com/ClickHouse/ClickHouse/issues/10639) を解決します。[#18233](https://github.com/ClickHouse/ClickHouse/pull/18233)（[Vitaly Baranov](https://github.com/vitlibar)）。
* リモートの MySQL サーバーとやり取りする際の文字セットを `utf8mb4` に設定するようにしました。[#19795](https://github.com/ClickHouse/ClickHouse/issues/19795) を修正。[#19800](https://github.com/ClickHouse/ClickHouse/pull/19800)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `S3` テーブル関数が `auto` 圧縮モード（自動検出）をサポートするようになりました。これにより [#18754](https://github.com/ClickHouse/ClickHouse/issues/18754) が解決されました。 [#19793](https://github.com/ClickHouse/ClickHouse/pull/19793) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `formatReadableTimeDelta` 関数が無限の引数を正しく出力できるように修正しました。以前のバージョンでは、実装依存の整数値への暗黙的な変換が行われていました。 [#19791](https://github.com/ClickHouse/ClickHouse/pull/19791) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* テーブル関数 `S3` は、リージョンを正確に判別できない場合、グローバルリージョンを使用します。これにより [#10998](https://github.com/ClickHouse/ClickHouse/issues/10998) が解決されました。 [#19750](https://github.com/ClickHouse/ClickHouse/pull/19750) ([Vladimir Chebotarev](https://github.com/excitoon))。
* 分散クエリにおいて設定 `async_socket_for_remote` が有効になっている場合、テーブルで非常に深くネストしたデータ型（例: `Array(Array(Array(...more...)))`）が使用されていると、少なくともデバッグビルド構成ではスタックオーバーフローが発生する可能性がありました。これにより [#19108](https://github.com/ClickHouse/ClickHouse/issues/19108) が修正されました。この変更により、わずかな後方互換性の非互換性が導入されます。型定義における余分なかっこはサポートされなくなりました（例: `Array((UInt8))`）。 [#19736](https://github.com/ClickHouse/ClickHouse/pull/19736)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* メッセージブローカー（RabbitMQ および Kafka）用の専用プールを追加。 [#19722](https://github.com/ClickHouse/ClickHouse/pull/19722) ([Azat Khuzhin](https://github.com/azat)).
* 非レプリケートの MergeTree において、`max_number_of_merges_with_ttl_in_pool` 制限をまれに超過してしまう問題（TTL を伴うマージがより多く割り当てられる場合がある）を修正。 [#19708](https://github.com/ClickHouse/ClickHouse/pull/19708) ([alesapin](https://github.com/alesapin)).
* Dictionary: 属性解析中のエラーメッセージを改善しました。 [#19678](https://github.com/ClickHouse/ClickHouse/pull/19678) ([Maksim Kita](https://github.com/kitaisreal)).
* 読み取り時のチェックサム検証を無効化するオプションを追加しました。運用環境では絶対に使用しないでください。これを無効化してもメリットはないと考えてください。実験やベンチマーク用途にのみ使用してください。この設定が適用されるのは MergeTree ファミリーのテーブルに対してのみです。他のテーブルエンジンおよびネットワーク経由でデータを受信する場合には、チェックサムは常に検証されます。私の観測では、パフォーマンスの差はないか、あっても 0.5% 未満です。[#19588](https://github.com/ClickHouse/ClickHouse/pull/19588)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 関数 `multiIf` で定数結果をサポートするようにしました。[#19533](https://github.com/ClickHouse/ClickHouse/pull/19533) ([Maksim Kita](https://github.com/kitaisreal))。
* Map データ型に対して length/empty/notEmpty 関数を有効化し、Map 内のキーの数を返すようにしました。 [#19530](https://github.com/ClickHouse/ClickHouse/pull/19530) ([taiyang-li](https://github.com/taiyang-li))。
* `clickhouse-benchmark` に `--reconnect` オプションを追加しました。このオプションが指定されている場合、各リクエストの前に再接続を行います。テスト目的で必要となる機能です。 [#19872](https://github.com/ClickHouse/ClickHouse/pull/19872) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `.debug` ファイルの新しい配置場所に対応しました。これにより [#19348](https://github.com/ClickHouse/ClickHouse/issues/19348) が修正されます。 [#19520](https://github.com/ClickHouse/ClickHouse/pull/19520) ([Amos Bird](https://github.com/amosbird))。
* `toIPv6` 関数は `IPv4` アドレスを解析します。 [#19518](https://github.com/ClickHouse/ClickHouse/pull/19518) ([Bharat Nallan](https://github.com/bharatnc))。
* `system.query_log`、`system.processes` などに `http_referer` フィールドを追加。これにより [#19389](https://github.com/ClickHouse/ClickHouse/issues/19389) が解決されました。 [#19390](https://github.com/ClickHouse/ClickHouse/pull/19390) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* より多くの関数を大文字小文字を区別しないようにし、エイリアスを追加することで、MySQL 互換性を向上させました。 [#19387](https://github.com/ClickHouse/ClickHouse/pull/19387) ([Daniil Kondratyev](https://github.com/dankondr))。
* MergeTree パーツの種別 (Wide/Compact/InMemory) ごとのメトリクスを追加。 [#19381](https://github.com/ClickHouse/ClickHouse/pull/19381) ([Azat Khuzhin](https://github.com/azat)).
* 任意の UID で Docker を実行できるようにしました。 [#19374](https://github.com/ClickHouse/ClickHouse/pull/19374) ([filimonov](https://github.com/filimonov))
* Pretty フォーマットにおける `IPv4` データ型の値の不正な配置を修正しました。右寄せではなく、左寄せになるべきでした。これにより [#19184](https://github.com/ClickHouse/ClickHouse/issues/19184) がクローズされます。 [#19339](https://github.com/ClickHouse/ClickHouse/pull/19339) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* 再起動せずに `max_server_memory_usage` を変更できるようにしました。これにより [#18154](https://github.com/ClickHouse/ClickHouse/issues/18154) が解決しました。 [#19186](https://github.com/ClickHouse/ClickHouse/pull/19186) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 以前のバージョンでは、関数 `bar` が特定の NaN の引数で呼び出された場合に発生する例外メッセージが、やや誤解を招く内容になっていました。これにより [#19088](https://github.com/ClickHouse/ClickHouse/issues/19088) が修正されました。 [#19107](https://github.com/ClickHouse/ClickHouse/pull/19107) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* clickhouse-server イメージ内の clickhouse ユーザーおよびグループの uid/gid を、固定値(101)に明示的に設定しました。 [#19096](https://github.com/ClickHouse/ClickHouse/pull/19096) ([filimonov](https://github.com/filimonov))。
* 巨大な文字列を含むデータを挿入する際に発生していた `PeekableReadBuffer: Memory limit exceed` エラーを修正しました。[#18690](https://github.com/ClickHouse/ClickHouse/issues/18690) を修正。 [#18979](https://github.com/ClickHouse/ClickHouse/pull/18979) ([tavplubix](https://github.com/tavplubix))。
* Docker イメージ: clickhouse-server のエントリポイントをいくつか改善。 [#18954](https://github.com/ClickHouse/ClickHouse/pull/18954) ([filimonov](https://github.com/filimonov))
* 長い名前を `?` でマスクせずにクエリを正規化できるようにするため、`normalizeQueryKeepNames` と `normalizedQueryHashKeepNames` を追加しました。これにより、複雑なクエリログをより適切に分析できます。 [#18910](https://github.com/ClickHouse/ClickHouse/pull/18910) ([Amos Bird](https://github.com/amosbird))。
* 送信前に送信側で分散バッチのブロックごとのチェックサムを検証します（ファイルを二度読みすることなく、読み込み中にチェックサムが検証されます）。これにより、送信側の切り詰められた .bin ファイルが原因で受信側の INSERT が停止したままになることを防ぎます。バッチ INSERT において .bin ファイルを二度読むことを回避します（以前は、squashing を考慮するために行数/バイト数を計算する必要がありましたが、現在はこの情報がヘッダーに含まれており、後方互換性も維持されています）。 [#18853](https://github.com/ClickHouse/ClickHouse/pull/18853) ([Azat Khuzhin](https://github.com/azat)).
* 集約関数の状態を持つテーブルに対する RIGHT および FULL JOIN の問題を修正しました。以前のバージョンでは、`cloneResized` メソッドに関する例外がスローされていました。[#18818](https://github.com/ClickHouse/ClickHouse/pull/18818) ([templarzq](https://github.com/templarzq)).
* プレフィックスベースの S3 エンドポイント設定を追加しました。 [#18812](https://github.com/ClickHouse/ClickHouse/pull/18812) ([Vladimir Chebotarev](https://github.com/excitoon)).
* bitmapTransform、bitmapSubsetInRange、bitmapSubsetLimit、bitmapContains 関数に対し、引数の型として [UInt8, UInt16, UInt32, UInt64] をサポートしました。これにより [#18713](https://github.com/ClickHouse/ClickHouse/issues/18713) がクローズされました。 [#18791](https://github.com/ClickHouse/ClickHouse/pull/18791) ([sundyli](https://github.com/sundy-li))。
* CTE（Common Table Expression）に対して、さらに別名を付けられるようにしました。`enable_global_with_statement = 1` の場合、同一レベルのサブクエリに対して CSE（Common Subexpression Elimination）を伝播させます。これにより [#17378](https://github.com/ClickHouse/ClickHouse/issues/17378) および [https://github.com/ClickHouse/ClickHouse/pull/16575#issuecomment-753416235](https://github.com/ClickHouse/ClickHouse/pull/16575#issuecomment-753416235) が修正されます。 [#18684](https://github.com/ClickHouse/ClickHouse/pull/18684)（[Amos Bird](https://github.com/amosbird)）。
* librdkafka を v1.6.0-RC2 に更新しました。[#18668](https://github.com/ClickHouse/ClickHouse/issues/18668) を修正しました。[#18671](https://github.com/ClickHouse/ClickHouse/pull/18671)（[filimonov](https://github.com/filimonov)）。
* 予期しない例外が発生した場合、分散 DDL クエリの実行を担当するバックグラウンドスレッドが自動的に再起動されるようにしました。 [#17991](https://github.com/ClickHouse/ClickHouse/issues/17991) を修正。 [#18285](https://github.com/ClickHouse/ClickHouse/pull/18285) ([徐炘](https://github.com/weeds085490)).
* S3 のグローバルリージョンを利用できるようにするため、AWS C++ SDK を更新しました。[#17870](https://github.com/ClickHouse/ClickHouse/pull/17870) ([Vladimir Chebotarev](https://github.com/excitoon))。
* `LIVE VIEW` テーブル作成時に使用できる `WITH ... [AND] [PERIODIC] REFRESH [interval_in_sec]` 句への対応を追加しました。 [#14822](https://github.com/ClickHouse/ClickHouse/pull/14822) ([vzakaznikov](https://github.com/vzakaznikov)).
* 古い構文で作成された `MergeTree` テーブルに対する `MODIFY TTL` クエリの実行を禁止しました。以前はクエリは成功していましたが、実際には何の効果もありませんでした。 [#19064](https://github.com/ClickHouse/ClickHouse/pull/19064) ([Anton Popov](https://github.com/CurtizJ)).

#### バグ修正 {#bug-fix-8}


* 定数引数を持つ二項関数のインデックス解析を修正し、誤ったクエリ結果を返していた問題を解消します。これにより、[#18364](https://github.com/ClickHouse/ClickHouse/issues/18364) が修正されます。[#18373](https://github.com/ClickHouse/ClickHouse/pull/18373)（[Amos Bird](https://github.com/amosbird)）。
* dictGet() を含むデフォルト式を持つテーブルが存在する場合にサーバーを起動できない問題を修正。辞書を読み込むことなく dictGet() の戻り値の型を取得できるようにしました。 [#19805](https://github.com/ClickHouse/ClickHouse/pull/19805) ([Vitaly Baranov](https://github.com/vitlibar))。
* `if` 関数の then/else 両ブランチの結果型が `Tuple` であり、その `Tuple` 型が `Array` または他の複合型を含む場合に、クエリを実行するとサーバーがクラッシュする問題を修正しました。 [#18356](https://github.com/ClickHouse/ClickHouse/issues/18356) の修正。 [#20133](https://github.com/ClickHouse/ClickHouse/pull/20133)（[alesapin](https://github.com/alesapin)）。
* `MaterializeMySQL`（実験的機能）：複数テーブルを更新するステートメントに対するレプリケーション処理を修正。 [#20066](https://github.com/ClickHouse/ClickHouse/pull/20066) ([Håvard Kvålen](https://github.com/havardk))。
* 初期化スクリプト実行中に Docker 内で発生する「Connection refused」エラーを防止。 [#20012](https://github.com/ClickHouse/ClickHouse/pull/20012) ([filimonov](https://github.com/filimonov)).
* `EmbeddedRocksDB` は実験的なストレージです。適切な型チェックが行われていない問題を修正し、コードを簡素化しました。これにより [#19967](https://github.com/ClickHouse/ClickHouse/issues/19967) がクローズされます。 [#19972](https://github.com/ClickHouse/ClickHouse/pull/19972) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 引数の型が Int32 以外の整数型に対する `Nullable(T)` の場合に、`fromModifiedJulianDay` 関数でセグメンテーションフォルトが発生する問題を修正しました。 [#19959](https://github.com/ClickHouse/ClickHouse/pull/19959) ([PHO](https://github.com/depressed-pho))
* 関数 `greatCircleAngle` は、以前のバージョンでは結果が正確ではありませんでした。これにより [#19769](https://github.com/ClickHouse/ClickHouse/issues/19769) が解決されました。 [#19789](https://github.com/ClickHouse/ClickHouse/pull/19789) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 一部のレプリケートされた操作（mutation など）が、データ破損後に一部のパーツを処理できなくなるまれなバグを修正しました。[#19593](https://github.com/ClickHouse/ClickHouse/issues/19593) を修正します。 [#19702](https://github.com/ClickHouse/ClickHouse/pull/19702)（[alesapin](https://github.com/alesapin)）。
* `ON CLUSTER` クエリを実行するバックグラウンドスレッドが、削除されたレプリケーテッドテーブルが何らかの処理を行うのを待ち続けてハングする可能性がありました。この問題を修正しました。 [#19684](https://github.com/ClickHouse/ClickHouse/pull/19684) ([yiguolei](https://github.com/yiguolei))。
* カラム定義の誤ったデシリアライズを修正しました。これにより、名前が `\` のカラムを持つテーブルに INSERT できなかった問題が解消されます。 [#19479](https://github.com/ClickHouse/ClickHouse/pull/19479) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* いずれかのファイルに空のデータブロックが存在する場合、分散バッチを「破損」としてマークするようにしました。 [#19449](https://github.com/ClickHouse/ClickHouse/pull/19449) ([Azat Khuzhin](https://github.com/azat)).
* `DROP/DETACH/REPLACE/MOVE PARTITION` の後にミューテーションがハングする可能性がある、非常にまれなバグを修正しました。この問題は、ほとんどのケースについては [#15537](https://github.com/ClickHouse/ClickHouse/issues/15537) によって部分的に修正されていました。 [#19443](https://github.com/ClickHouse/ClickHouse/pull/19443) ([tavplubix](https://github.com/tavplubix))。
* `Extremes transform was already added to pipeline` というエラーが発生する可能性のある問題を修正しました。 [#14100](https://github.com/ClickHouse/ClickHouse/issues/14100) を修正。 [#19430](https://github.com/ClickHouse/ClickHouse/pull/19430)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* デフォルト値がゼロ以外の結合型（例: 一部の Enum）におけるデフォルト値の扱いを修正しました。[#18197](https://github.com/ClickHouse/ClickHouse/issues/18197) をクローズ。[#19360](https://github.com/ClickHouse/ClickHouse/pull/19360)（[vdimir](https://github.com/vdimir)）。
* EOF に到達しても、分散送信用ファイルを破損扱いとしてマークしないようにしました。 [#19290](https://github.com/ClickHouse/ClickHouse/pull/19290) ([Azat Khuzhin](https://github.com/azat)).
* `async_socket_for_remote` に対するパイプ FD のリークを修正。 [#19153](https://github.com/ClickHouse/ClickHouse/pull/19153) ([Azat Khuzhin](https://github.com/azat)).
* `ORC` 形式のファイルを無限に読み込み続けてしまう問題を修正（[#10580](https://github.com/ClickHouse/ClickHouse/issues/10580) で導入された不具合）。[#19095](https://github.com/ClickHouse/ClickHouse/issues/19095) を修正。[#19134](https://github.com/ClickHouse/ClickHouse/pull/19134)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 固定グラニュラリティサイズを超えるサイズのマークが生成されてしまう可能性のあった MergeTree データライターの問題を修正。 [#18913](https://github.com/ClickHouse/ClickHouse/issues/18913) を修正。 [#19123](https://github.com/ClickHouse/ClickHouse/pull/19123)（[alesapin](https://github.com/alesapin)）。
* 起動時に `LowCardinality(Nullable(...))` から圧縮コーデックを読み取れず、`Attempt to read after EOF` という例外を送出していたバグを修正しました。[#18340](https://github.com/ClickHouse/ClickHouse/issues/18340) を修正。[#19101](https://github.com/ClickHouse/ClickHouse/pull/19101)（[alesapin](https://github.com/alesapin)）。
* `tupleHammingDistance` の実装を簡素化。任意の同じ長さのタプルをサポート。[#19029](https://github.com/ClickHouse/ClickHouse/issues/19029) を修正。 [#19084](https://github.com/ClickHouse/ClickHouse/pull/19084)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `Enum` 型の引数に対して、`groupUniqArray` が正しい型を返すようにしました。これにより [#17875](https://github.com/ClickHouse/ClickHouse/issues/17875) が解決されました。 [#19019](https://github.com/ClickHouse/ClickHouse/pull/19019)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 関数 `ignore` を `LowCardinality` 型の引数と共に使用した場合に発生する可能性のあった `Expected single dictionary argument for function` エラーを修正しました。[#14275](https://github.com/ClickHouse/ClickHouse/issues/14275) に対応しています。 [#19016](https://github.com/ClickHouse/ClickHouse/pull/19016) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* `TinyLog` エンジンを使用するテーブルへの `LowCardinality` 列の挿入処理を修正しました。[#18629](https://github.com/ClickHouse/ClickHouse/issues/18629) を解決します。[#19010](https://github.com/ClickHouse/ClickHouse/pull/19010)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* JOIN における軽微な問題を修正しました: JOIN が const 列をマテリアライズしようとしますが、他の箇所ではそれらのマテリアライズが別の場所で行われることを前提としたコードになっていました。 [#18982](https://github.com/ClickHouse/ClickHouse/pull/18982) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* `optimize_move_functions_out_of_any` を無効化しました。この最適化は常に正しい結果を保証しないためです。これにより [#18051](https://github.com/ClickHouse/ClickHouse/issues/18051) がクローズされます。また [#18973](https://github.com/ClickHouse/ClickHouse/issues/18973) もクローズされます。[#18981](https://github.com/ClickHouse/ClickHouse/pull/18981)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* クエリプランの `Expression` ステップのマージにより発生する可能性があった `QueryPipeline stream: different number of columns` という例外を修正しました。[#18190](https://github.com/ClickHouse/ClickHouse/issues/18190) を解決。[#18980](https://github.com/ClickHouse/ClickHouse/pull/18980)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* シャットダウン時にごくまれに発生するデッドロックを修正。 [#18977](https://github.com/ClickHouse/ClickHouse/pull/18977) ([tavplubix](https://github.com/tavplubix)).
* サーバーのメモリ不足時にまれに発生していたクラッシュを修正しました。 [#18976](https://github.com/ClickHouse/ClickHouse/pull/18976) ([tavplubix](https://github.com/tavplubix)).
* `ALTER TABLE ... DROP PART 'part_name'` クエリがパーティション全体の重複排除ブロックをすべて削除してしまう誤った動作を修正します。 [#18874](https://github.com/ClickHouse/ClickHouse/issues/18874) を修正。 [#18969](https://github.com/ClickHouse/ClickHouse/pull/18969)（[alesapin](https://github.com/alesapin)）。
* Issue [#18894](https://github.com/ClickHouse/ClickHouse/issues/18894) を修正。Looker のような BI ツールによって自動生成されることが多い長いカラムエイリアス（&#39;table.column&#39; 形式）が長いテーブル名と同一になった場合に、例外が発生しないようチェックを追加。[#18968](https://github.com/ClickHouse/ClickHouse/pull/18968)（[Daniel Qin](https://github.com/mathfool)）。
* エラー `Task was not found in task queue` を修正（リモートクエリで `async_socket_for_remote = 1` の場合にのみ発生し得ます）。[#18964](https://github.com/ClickHouse/ClickHouse/pull/18964) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 一部のエスケープされたテキスト（`ALTER ... UPDATE e = CAST('foo', 'Enum8(\'foo\' = 1')` のようなもの）を含む mutation が誤ってシリアライズされていたバグを修正しました。[#18878](https://github.com/ClickHouse/ClickHouse/issues/18878) を解決。[#18944](https://github.com/ClickHouse/ClickHouse/pull/18944)（[alesapin](https://github.com/alesapin)）。
* ATTACH PARTITION によって mutations がリセットされます。 [#18804](https://github.com/ClickHouse/ClickHouse/issues/18804). [#18935](https://github.com/ClickHouse/ClickHouse/pull/18935) ([fastio](https://github.com/fastio)).
* `bitmapOrCardinality` によってヌルポインタ参照が発生する可能性のある問題を修正しました。これにより [#18911](https://github.com/ClickHouse/ClickHouse/issues/18911) がクローズされます。[#18912](https://github.com/ClickHouse/ClickHouse/pull/18912)（[sundyli](https://github.com/sundy-li)）。
* `Nullable(String)` から `Nullable(Decimal(P, S))` への `CAST` を試みた際に発生していた `Attempt to read after eof` エラーを修正しました。これにより、NULL 許容の文字列から小数をパースできない場合、`CAST` 関数は `NULL` を返すようになりました。[#7690](https://github.com/ClickHouse/ClickHouse/issues/7690) を修正しました。 [#18718](https://github.com/ClickHouse/ClickHouse/pull/18718) ([Winter Zhang](https://github.com/zhang2014))。
* MySQL エンジンのデータ型変換に関する不具合を修正しました。 [#18124](https://github.com/ClickHouse/ClickHouse/pull/18124) ([bo zeng](https://github.com/mis98zb)).
* `select` のみを実行した際に発生していた clickhouse-client のアボート例外を修正。 [#19790](https://github.com/ClickHouse/ClickHouse/pull/19790) ([taiyang-li](https://github.com/taiyang-li))。

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-9}

- CI で [SQLancer](https://twitter.com/RiggerManuel/status/1352345625480884228) (論理的 SQL ファザー) を実行。[#19006](https://github.com/ClickHouse/ClickHouse/pull/19006) ([Ilya Yatsishin](https://github.com/qoega))。
- Query Fuzzer が新しく追加されたテストをより広範囲にファジング。これにより [#18916](https://github.com/ClickHouse/ClickHouse/issues/18916) が解決。[#19185](https://github.com/ClickHouse/ClickHouse/pull/19185) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- より効果的なファジングのために [Big List of Naughty Strings](https://github.com/minimaxir/big-list-of-naughty-strings/) と統合。[#19480](https://github.com/ClickHouse/ClickHouse/pull/19480) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- MSan を使用した統合テストの実行を追加。[#18974](https://github.com/ClickHouse/ClickHouse/pull/18974) ([alesapin](https://github.com/alesapin))。
- cyrus-sasl と musl における MemorySanitizer エラーを修正。[#19821](https://github.com/ClickHouse/ClickHouse/pull/19821) ([Ilya Yatsishin](https://github.com/qoega))。
- `positionCaseInsensitiveUTF8` 関数における引数チェックの不足により、アドレスサニタイザーがトリガーされる問題を修正。[#19720](https://github.com/ClickHouse/ClickHouse/pull/19720) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 統合テストにおける docker-compose の --project-directory を削除。docker コンテナからのログフォーマットを修正。[#19706](https://github.com/ClickHouse/ClickHouse/pull/19706) ([Ilya Yatsishin](https://github.com/qoega))。
- 統合テスト用の macros.xml の生成を容易化。dicttoxml からの過剰なログ出力を廃止。dicttoxml プロジェクトは 5 年以上活動していない。[#19697](https://github.com/ClickHouse/ClickHouse/pull/19697) ([Ilya Yatsishin](https://github.com/qoega))。
- 環境変数 `CLICKHOUSE_WATCHDOG_ENABLE` を介して watchdog を明示的に有効化または無効化できるように変更。デフォルトでは、サーバーがターミナルに接続されていない場合に有効化される。[#19522](https://github.com/ClickHouse/ClickHouse/pull/19522) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- arm64 上で Kafka サポートを有効にした ClickHouse のビルドを可能に。[#19369](https://github.com/ClickHouse/ClickHouse/pull/19369) ([filimonov](https://github.com/filimonov))。
- ssl なしで librdkafka をビルドできるように変更。[#19337](https://github.com/ClickHouse/ClickHouse/pull/19337) ([filimonov](https://github.com/filimonov))。
- FreeBSD ビルドにおける Kafka 入力を復元。[#18924](https://github.com/ClickHouse/ClickHouse/pull/18924) ([Alexandre Snarskii](https://github.com/snar))。
- テーブル関数 `VALUES` における潜在的な nullptr 参照を修正。[#19357](https://github.com/ClickHouse/ClickHouse/pull/19357) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `arrayElement` 関数、`substring`、および `arraySum` における UBSan レポートを回避。[#19305](https://github.com/ClickHouse/ClickHouse/issues/19305) を修正。[#19287](https://github.com/ClickHouse/ClickHouse/issues/19287) を修正。これにより [#19336](https://github.com/ClickHouse/ClickHouse/issues/19336) が解決。[#19347](https://github.com/ClickHouse/ClickHouse/pull/19347) ([alexey-milovidov](https://github.com/alexey-milovidov))。


## ClickHouse リリース 21.1 {#clickhouse-release-211}

### ClickHouse リリース v21.1.3.32-stable, 2021-02-03 {#clickhouse-release-v211332-stable-2021-02-03}

#### バグ修正 {#bug-fix-9}


* BloomFilter インデックスのクラッシュを修正。[#19757](https://github.com/ClickHouse/ClickHouse/issues/19757) を修正。[#19884](https://github.com/ClickHouse/ClickHouse/pull/19884)（[Maksim Kita](https://github.com/kitaisreal)）。
* `UNION DISTINCT` サブクエリへの述語プッシュダウン時に発生するクラッシュを修正しました。これにより [#19855](https://github.com/ClickHouse/ClickHouse/issues/19855) が解決されます。 [#19861](https://github.com/ClickHouse/ClickHouse/pull/19861) ([Amos Bird](https://github.com/amosbird))。
* 127 を超える UInt8 に対するフィルタリングを修正。 [#19799](https://github.com/ClickHouse/ClickHouse/pull/19799) ([Anton Popov](https://github.com/CurtizJ)).
* 以前のバージョンでは、関数 arrayEnumerateUniq に対する想定外の引数がクラッシュまたは無限ループを引き起こす可能性がありました。これにより [#19787](https://github.com/ClickHouse/ClickHouse/issues/19787) が解決されました。[#19788](https://github.com/ClickHouse/ClickHouse/pull/19788)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 算術型と文字列型の正確な比較を行った際に発生していたスタックオーバーフローを修正しました。 [#19773](https://github.com/ClickHouse/ClickHouse/pull/19773) ([tavplubix](https://github.com/tavplubix)).
* `WHERE` または `PREWHERE` でネストされたカラム名を使用するとクラッシュする問題を修正しました。 [#19755](https://github.com/ClickHouse/ClickHouse/issues/19755) を修正。 [#19763](https://github.com/ClickHouse/ClickHouse/pull/19763)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `bitmapAndnot` 関数で発生していたセグメンテーションフォールトを修正。[#19668](https://github.com/ClickHouse/ClickHouse/issues/19668) の修正。[#19713](https://github.com/ClickHouse/ClickHouse/pull/19713)（[Maksim Kita](https://github.com/kitaisreal)）。
* ビッグインテージャを使用する一部の関数が、セグメンテーションフォルトを引き起こす場合があります。ビッグインテージャは実験的機能です。これにより [#19667](https://github.com/ClickHouse/ClickHouse/issues/19667) がクローズされました。 [#19672](https://github.com/ClickHouse/ClickHouse/pull/19672) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `LowCardinality` 引数に対する関数 `neighbor` の誤った結果を修正しました。 [#10333](https://github.com/ClickHouse/ClickHouse/issues/10333) を解決。 [#19617](https://github.com/ClickHouse/ClickHouse/pull/19617) ([Nikolai Kochetov](https://github.com/KochetovNicolai))。
* 切断後に `Connection` 内の `CompressedWriteBuffer` で発生する use-after-free を修正。[#19599](https://github.com/ClickHouse/ClickHouse/pull/19599)（[Azat Khuzhin](https://github.com/azat)）。
* `DROP/DETACH TABLE table ON CLUSTER cluster SYNC` クエリがハングする可能性があった問題を修正しました。 [#19568](https://github.com/ClickHouse/ClickHouse/issues/19568) の修正。 [#19572](https://github.com/ClickHouse/ClickHouse/pull/19572) ([tavplubix](https://github.com/tavplubix))。
* CREATE DICTIONARY クエリの id 式を修正。[#19571](https://github.com/ClickHouse/ClickHouse/pull/19571) ([Maksim Kita](https://github.com/kitaisreal)).
* merge&#95;tree&#95;min&#95;rows&#95;for&#95;concurrent&#95;read/merge&#95;tree&#95;min&#95;bytes&#95;for&#95;concurrent&#95;read=0/UINT64&#95;MAX の場合に発生する SIGSEGV を修正。 [#19528](https://github.com/ClickHouse/ClickHouse/pull/19528) ([Azat Khuzhin](https://github.com/azat)).
* 特定の引数を指定して `addMonth` 関数を呼び出した場合に、メモリ読み取り時のバッファオーバーフローが発生する可能性がありました。これにより [#19441](https://github.com/ClickHouse/ClickHouse/issues/19441) と [#19413](https://github.com/ClickHouse/ClickHouse/issues/19413) が修正されました。 [#19472](https://github.com/ClickHouse/ClickHouse/pull/19472) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* IV に空文字列が渡された場合、encrypt/decrypt 関数で未初期化メモリを読み取ってしまう可能性がありました。これにより [#19391](https://github.com/ClickHouse/ClickHouse/issues/19391) が解決されました。[#19397](https://github.com/ClickHouse/ClickHouse/pull/19397)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* Uber H3 ライブラリにおける潜在的なバッファオーバーフローを修正します。詳細は [https://github.com/uber/h3/issues/392](https://github.com/uber/h3/issues/392) を参照してください。これにより [#19219](https://github.com/ClickHouse/ClickHouse/issues/19219) をクローズします。 [#19383](https://github.com/ClickHouse/ClickHouse/pull/19383)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* system.parts の &#95;state 列を修正（誤った順序により、この列をクエリすると LOGICAL&#95;ERROR が発生していた問題を解消）。[#19346](https://github.com/ClickHouse/ClickHouse/pull/19346)（[Azat Khuzhin](https://github.com/azat)）。
* マテリアライズドビューとその対象テーブルの構造が異なる場合に、集約処理で誤った結果やセグメンテーションフォルトが発生する可能性がある問題を修正しました。[#18063](https://github.com/ClickHouse/ClickHouse/issues/18063) を解決。[#19322](https://github.com/ClickHouse/ClickHouse/pull/19322)（[tavplubix](https://github.com/tavplubix)）。
* エラー `Cannot convert column now64() because it is constant but values of constants are different in source and result` を修正しました。[#7156](https://github.com/ClickHouse/ClickHouse/issues/7156) の継続です。[#19316](https://github.com/ClickHouse/ClickHouse/pull/19316)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* ReplicatedMergeTree テーブルの処理中に、`ALTER` クエリと `DROP` クエリを同時に実行するとハングする可能性がある不具合を修正しました。 [#19237](https://github.com/ClickHouse/ClickHouse/pull/19237) ([alesapin](https://github.com/alesapin)).
* `Template` または `CustomSeparated` フォーマットを使用して HTTP インターフェイス経由でデータを挿入する際に発生していた `There is no checkpoint` エラーを修正しました。[#19021](https://github.com/ClickHouse/ClickHouse/issues/19021) を解決。[#19072](https://github.com/ClickHouse/ClickHouse/pull/19072)（[tavplubix](https://github.com/tavplubix)）。
* 結果を事前に計算できない場合、解析段階で副問い合わせに対する定数折り畳みを無効化しました。 [#18446](https://github.com/ClickHouse/ClickHouse/pull/18446) ([Azat Khuzhin](https://github.com/azat)).
* `MOVE` や `REPLACE PARTITION` の後、またはまれに `DETACH` や `DROP PARTITION` の後に、存在しないパーツを待ってミューテーションがハングすることがありました。これは修正されました。 [#15537](https://github.com/ClickHouse/ClickHouse/pull/15537) ([tavplubix](https://github.com/tavplubix))。

### ClickHouseリリース v21.1.2.15-stable 2021-01-18 {#clickhouse-release-v211215-stable-2021-01-18}

#### 後方互換性のない変更 {#backward-incompatible-change-10}

- 設定`input_format_null_as_default`がデフォルトで有効になりました。[#17525](https://github.com/ClickHouse/ClickHouse/pull/17525) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 設定ファイルからのプロファイル設定に対する設定制約をチェックします。users.xmlに対応する制約を満たさない設定が含まれている場合、サーバーの起動に失敗します。[#18486](https://github.com/ClickHouse/ClickHouse/pull/18486) ([tavplubix](https://github.com/tavplubix))。
- データパーツに影響を与えるストレージ設定(`write_final_mark`および`enable_mixed_granularity_parts`)を`ALTER MODIFY SETTING`で変更できないように制限しました。[#18306](https://github.com/ClickHouse/ClickHouse/pull/18306) ([Amos Bird](https://github.com/amosbird))。
- `insert_quorum_parallel`をデフォルトで1に設定しました。これは「順次」クォーラム挿入よりも大幅に使いやすくなっています。ただし、順次一貫性に依存している場合は、この設定を0に戻す必要があります。[#17567](https://github.com/ClickHouse/ClickHouse/pull/17567) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- `sumburConsistentHash`関数を削除しました。これにより[#18120](https://github.com/ClickHouse/ClickHouse/issues/18120)がクローズされます。[#18656](https://github.com/ClickHouse/ClickHouse/pull/18656) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- 集約関数`timeSeriesGroupSum`、`timeSeriesGroupRateSum`を削除しました。これらは正常に動作していなかったためです。これにより[#16869](https://github.com/ClickHouse/ClickHouse/issues/16869)が修正されます。これらの関数を問題なく使用できていた場合は、feedback@clickhouse.comまでメールでお知らせください。[#17423](https://github.com/ClickHouse/ClickHouse/pull/17423) ([alexey-milovidov](https://github.com/alexey-milovidov))。
- toUnixTimestamp(Date())を禁止しました(以前はDateのUInt16表現を返していました)。[#17376](https://github.com/ClickHouse/ClickHouse/pull/17376) ([Azat Khuzhin](https://github.com/azat))。
- `avg`および`avgWeighted`関数で拡張整数型(`Int128`、`Int256`、`UInt256`)の使用を許可しました。また、`avgWeighted`関数で値と重みに異なる型(整数、小数、浮動小数点)を使用できるようになりました。これは後方互換性のない変更です。現在、`avg`および`avgWeighted`関数は常に`Float64`を返します(ドキュメントに記載されている通り)。この変更以前は、`Decimal`引数の戻り値の型も`Decimal`でした。[#15419](https://github.com/ClickHouse/ClickHouse/pull/15419) ([Mike](https://github.com/myrrc))。
- 式`toUUID(N)`は動作しなくなりました。`toUUID('00000000-0000-0000-0000-000000000000')`に置き換えてください。この変更は、Nがゼロでない場合の`toUUID(N)`の非自明な結果に起因しています。
- 不正な「key usage」を持つSSL証明書は拒否されます。以前のバージョンでは動作していました。[#19262](https://github.com/ClickHouse/ClickHouse/issues/19262)を参照してください。
- デフォルト設定から置換ファイル(`/etc/metrika.xml`)への`incl`参照が削除されました(`<remote_servers>`、`<zookeeper>`、`<macros>`、`<compression>`、`<networks>`)。置換ファイルを使用していて、これらの暗黙的な参照に依存していた場合は、更新前に`incl="..."`属性を持つ対応するセクションを追加して、手動かつ明示的に戻す必要があります。[#18740](https://github.com/ClickHouse/ClickHouse/pull/18740) ([alexey-milovidov](https://github.com/alexey-milovidov))を参照してください。

#### 新機能 {#new-feature-10}


* ClickHouse に gRPC プロトコルを実装。 [#15111](https://github.com/ClickHouse/ClickHouse/pull/15111) ([Vitaly Baranov](https://github.com/vitlibar)).
* 複数の ZooKeeper クラスターを使用できるようにしました。 [#17070](https://github.com/ClickHouse/ClickHouse/pull/17070) ([fastio](https://github.com/fastio)).
* `REPLACE TABLE` および `CREATE OR REPLACE TABLE` クエリを実装しました。 [#18521](https://github.com/ClickHouse/ClickHouse/pull/18521) ([tavplubix](https://github.com/tavplubix)).
* `UNION DISTINCT` を実装し、単なる `UNION` 句はデフォルトで `UNION DISTINCT` として扱うようにします。`UNION ALL` として扱うか、明示的なモード指定を必須にするかを制御できる設定 `union_default_mode` を追加します。 [#16338](https://github.com/ClickHouse/ClickHouse/pull/16338) ([flynn](https://github.com/ucasFL)).
* 関数 `accurateCastOrNull` を追加しました。これにより [#10290](https://github.com/ClickHouse/ClickHouse/issues/10290) がクローズされます。`x IN (subquery)` 式での型変換を追加しました。これにより [#10266](https://github.com/ClickHouse/ClickHouse/issues/10266) がクローズされます。[#16724](https://github.com/ClickHouse/ClickHouse/pull/16724)（[Maksim Kita](https://github.com/kitaisreal)）。
* IP Dictionary は `IPv4` / `IPv6` 型を直接サポートします。[#17571](https://github.com/ClickHouse/ClickHouse/pull/17571) ([vdimir](https://github.com/vdimir))。
* IP Dictionary がキーの取得をサポートするようになりました。[#18241](https://github.com/ClickHouse/ClickHouse/issues/18241) を解決しました。[#18480](https://github.com/ClickHouse/ClickHouse/pull/18480)（[vdimir](https://github.com/vdimir)）。
* データのインポートおよびエクスポート向けに `*.zst` の圧縮・解凍サポートを追加しました。これにより、`file()` 関数で `*.zst` を使用でき、HTTP クライアントで `Content-encoding: zstd` を使用できるようになります。この変更により [#16791 ](https://github.com/ClickHouse/ClickHouse/issues/16791) が解決されました。 [#17144](https://github.com/ClickHouse/ClickHouse/pull/17144)（[Abi Palagashvili](https://github.com/fibersel)）。
* `mannWitneyUTest`、`studentTTest`、`welchTTest` 集約関数を追加しました。`rankCorr` を一部リファクタリングしました。 [#16883](https://github.com/ClickHouse/ClickHouse/pull/16883) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 関数 `countMatches`/`countMatchesCaseInsensitive` を追加。[#17459](https://github.com/ClickHouse/ClickHouse/pull/17459)（[Azat Khuzhin](https://github.com/azat)）。
* `countSubstrings()`/`countSubstringsCaseInsensitive()`/`countSubstringsCaseInsensitiveUTF8()` を実装（部分文字列の出現回数をカウント）。 [#17347](https://github.com/ClickHouse/ClickHouse/pull/17347) ([Azat Khuzhin](https://github.com/azat)).
* system.query&#95;log に、使用されたデータベース、テーブル、および列に関する情報を追加。`query_kind` と `normalized_query_hash` フィールドを追加。 [#17726](https://github.com/ClickHouse/ClickHouse/pull/17726) ([Amos Bird](https://github.com/amosbird))。
* `optimize_on_insert` 設定を追加。これを有効にすると、マージがこのブロックに対して行われた場合と同様の変換（例: Replacing、Collapsing、Aggregating など）を、INSERT されたデータブロックに対して実行します。この設定はデフォルトで有効になっています。これにより、マテリアライズドビューおよび MaterializeMySQL の動作に影響する可能性があります（詳細な説明を参照）。これにより [#10683](https://github.com/ClickHouse/ClickHouse/issues/10683) がクローズされました。 [#16954](https://github.com/ClickHouse/ClickHouse/pull/16954) ([Kruglov Pavel](https://github.com/Avogar)).
* HDFS 向け Kerberos 認証。[#16621](https://github.com/ClickHouse/ClickHouse/pull/16621) ([Ilya Golshtein](https://github.com/ilejn)).
* `system.settings` 内のパラメータを表示するための `SHOW SETTINGS` ステートメントをサポートしました。`SHOW CHANGED SETTINGS` および `LIKE` / `ILIKE` 句もサポートされています。[#18056](https://github.com/ClickHouse/ClickHouse/pull/18056) ([Jianmei Zhang](https://github.com/zhangjmruc))。
* 関数 `position` は、SQL 互換性向上のために `POSITION(needle IN haystack)` 構文をサポートするようになりました。これにより [#18701](https://github.com/ClickHouse/ClickHouse/issues/18701) が解決されました。... [#18779](https://github.com/ClickHouse/ClickHouse/pull/18779) ([Jianmei Zhang](https://github.com/zhangjmruc))。
* MergeTree ファミリーのテーブル向けに、新しいストレージ設定 `max_partitions_to_read` が追加されました。これは、1 つのクエリでアクセスできるパーティション数の上限を制御します。この制約を強制するためのユーザー設定 `force_max_partition_limit` も追加されています。 [#18712](https://github.com/ClickHouse/ClickHouse/pull/18712) ([Amos Bird](https://github.com/amosbird))。
* 挿入されたパーツ向けに `system.part_log` に `query_id` カラムを追加。 [#10097](https://github.com/ClickHouse/ClickHouse/issues/10097) をクローズ。 [#18644](https://github.com/ClickHouse/ClickHouse/pull/18644)（[flynn](https://github.com/ucasFL)）。
* 列指定付きの `CREATE TABLE AS SELECT` を許可しました。例: `CREATE TABLE t1 (x String) ENGINE = Memory AS SELECT 1;`。 [#18060](https://github.com/ClickHouse/ClickHouse/pull/18060)（[Maksim Kita](https://github.com/kitaisreal)）。
* `arrayMin`、`arrayMax`、`arrayAvg` 集約関数を追加しました。 [#18032](https://github.com/ClickHouse/ClickHouse/pull/18032) ([Maksim Kita](https://github.com/kitaisreal))。
* `ATTACH TABLE name FROM 'path/to/data/' (col1 Type1, ...` クエリが実装されました。指定された構造で新しいテーブルを作成し、`user_files` 内の指定ディレクトリにあるテーブルデータをアタッチします。 [#17903](https://github.com/ClickHouse/ClickHouse/pull/17903) ([tavplubix](https://github.com/tavplubix))。
* StorageMemory に対するミューテーション機能のサポートを追加しました。これにより [#9117](https://github.com/ClickHouse/ClickHouse/issues/9117) がクローズされました。 [#15127](https://github.com/ClickHouse/ClickHouse/pull/15127) ([flynn](https://github.com/ucasFL))。
* `EXISTS DATABASE name` 構文のサポートを追加しました。 [#18458](https://github.com/ClickHouse/ClickHouse/pull/18458) ([Du Chuan](https://github.com/spongedu)).
* MySQL と同様に、組み込み関数 `isIPv4String` および `isIPv6String` をサポートしました。[MySQL](https://github.com/ClickHouse/ClickHouse/compare/master...spongedu:support_is_ipv4?expand=1) [#18349](https://github.com/ClickHouse/ClickHouse/pull/18349)（[Du Chuan](https://github.com/spongedu)）。
* 新しい設定 `insert_distributed_one_random_shard = 1` を追加し、distributed key なしでマルチシャード構成の Distributed テーブルに挿入できるようにしました。 [#18294](https://github.com/ClickHouse/ClickHouse/pull/18294) ([Amos Bird](https://github.com/amosbird))。
* `min_compress_block_size` と `max_compress_block_size` 設定を MergeTreeSettings に追加しました。これらはグローバル設定よりも優先され、設定されている場合に有効になります。 [13890](https://github.com/ClickHouse/ClickHouse/issues/13890) をクローズしました。 [#17867](https://github.com/ClickHouse/ClickHouse/pull/17867) ([flynn](https://github.com/ucasFL))。
* 64ビット Roaring Bitmap へのサポートを追加しました。 [#17858](https://github.com/ClickHouse/ClickHouse/pull/17858) ([Andy Yang](https://github.com/andyyzh)).
* 重複判定に用いる列を、明示的（またはアスタリスク／列トランスフォーマーによる暗黙的）な列リストとして指定できるように、`OPTIMIZE ... DEDUPLICATE` 構文を拡張しました。 ... [#17846](https://github.com/ClickHouse/ClickHouse/pull/17846) ([Vasily Nemkov](https://github.com/Enmk)).
* `toModifiedJulianDay`、`fromModifiedJulianDay`、`toModifiedJulianDayOrNull`、`fromModifiedJulianDayOrNull` 関数を追加しました。これらの関数は、プロレプティック・グレゴリオ暦の日付と修正ユリウス日番号の相互変換を行います。 [#17750](https://github.com/ClickHouse/ClickHouse/pull/17750) ([PHO](https://github.com/depressed-pho))。
* カスタム TLD リストを使用できるようにし、関数 `firstSignificantSubdomainCustom` および `cutToFirstSignificantSubdomainCustom` を追加しました。 [#17748](https://github.com/ClickHouse/ClickHouse/pull/17748) ([Azat Khuzhin](https://github.com/azat)).
* ネイティブ TCP インターフェイスをラップするための `PROXYv1` プロトコルのサポートを追加しました。プロキシで転送された IP アドレスをクォータのキーとして使用できるようにしました（`PROXYv1` のアドレスおよび HTTP インターフェイスからの `X-Forwarded-For` に適用されます）。これは、ClickHouse へのアクセスを信頼できるプロキシ（例: Cloudflare）経由のみに制限しつつ、ユーザーのリソース使用量を元の IP アドレスごとに計上したい場合に有用です。これにより [#17268](https://github.com/ClickHouse/ClickHouse/issues/17268) が修正されました。 [#17707](https://github.com/ClickHouse/ClickHouse/pull/17707)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `clickhouse-client` でコマンド編集のために `EDITOR` を開けるようになりました。`Alt-Shift-E` で起動します。[#17665](https://github.com/ClickHouse/ClickHouse/pull/17665)（[Amos Bird](https://github.com/amosbird)）。
* XML テキストノードまたは属性に文字列を配置する際に文字をエスケープする関数 `encodeXMLComponent` を追加。 [#17659](https://github.com/ClickHouse/ClickHouse/pull/17659) ([nauta](https://github.com/nautaa)).
* `DETACH TABLE/VIEW ... PERMANENTLY` 構文を導入しました。これにより、テーブルは再起動後に自動的に再アタッチされず、明示的に要求された場合にのみ再アタッチされます。テーブルは引き続き省略形の ATTACH TABLE 構文を使用して再アタッチできます。[#5555](https://github.com/ClickHouse/ClickHouse/issues/5555) を実装し、[#13850](https://github.com/ClickHouse/ClickHouse/issues/13850) を修正しました。[#17642](https://github.com/ClickHouse/ClickHouse/pull/17642)（[filimonov](https://github.com/filimonov)）。
* MergeTree テーブル内の総行数、バイト数、およびパーツ数に関する非同期メトリクスを追加しました。この修正により、[#11714](https://github.com/ClickHouse/ClickHouse/issues/11714) が解決されました。[#17639](https://github.com/ClickHouse/ClickHouse/pull/17639)（[flynn](https://github.com/ucasFL)）。
* SQL 外部でのページネーション用に `limit` と `offset` の設定を追加しました: [#16176](https://github.com/ClickHouse/ClickHouse/issues/16176) これらは API を構築する際に有用です。これら 2 つの設定は、`select * from (your_original_select_query) t limit xxx offset xxx;` が追加されたかのように SELECT クエリが動作するようにします。 [#17633](https://github.com/ClickHouse/ClickHouse/pull/17633) ([hexiaoting](https://github.com/hexiaoting)).
* 新しい集約関数コンビネータ `-SimpleState` を提供し、クエリから `SimpleAggregateFunction` 型を構築できるようにしました。これは AggregatingMergeTree エンジンの MaterializedView を定義する際に有用であり、プロジェクションにも役立ちます。 [#16853](https://github.com/ClickHouse/ClickHouse/pull/16853) ([Amos Bird](https://github.com/amosbird))。
* `clickhouse-client` と `clickhouse-local` に `queries-file` パラメーターを追加しました。 [#15930](https://github.com/ClickHouse/ClickHouse/pull/15930) ([Maksim Kita](https://github.com/kitaisreal))。
* `clickhouse-benchmark` に `query` パラメータを追加しました。 [#17832](https://github.com/ClickHouse/ClickHouse/pull/17832) ([Maksim Kita](https://github.com/kitaisreal))。
* `EXPLAIN AST` は `SELECT` 以外のクエリもサポートするようになりました。 [#18136](https://github.com/ClickHouse/ClickHouse/pull/18136) ([taiyang-li](https://github.com/taiyang-li))。

#### 実験的機能 {#experimental-feature-8}

- テキストn-gramおよびshingleのminHashとsimHashを計算する関数を追加しました。これらは準重複検索を目的としています。また、`bitHammingDistance`および`tupleHammingDistance`関数も追加されました。[#7649](https://github.com/ClickHouse/ClickHouse/pull/7649) ([flynn](https://github.com/ucasFL))。
- 新しいデータ型`Map`を追加しました。[#1841](https://github.com/ClickHouse/ClickHouse/issues/1841)を参照してください。Mapの初期バージョンでは、キーと値の型として`String`のみをサポートしています。[#15806](https://github.com/ClickHouse/ClickHouse/pull/15806) ([hexiaoting](https://github.com/hexiaoting))。
- ANTLR4ランタイムに基づき、EBNF文法から生成された代替SQLパーサーを実装しました。[#11298](https://github.com/ClickHouse/ClickHouse/pull/11298) ([Ivan](https://github.com/abyss7))。

#### パフォーマンス改善 {#performance-improvement-10}


* メモリ消費を抑え、一部のケースでのパフォーマンスを向上させ、バグを修正した新しい IP Dictionary 実装。 [#16804](https://github.com/ClickHouse/ClickHouse/pull/16804) ([vdimir](https://github.com/vdimir))。
* データエクスポートにおけるフォーマット処理の並列化。[#11617](https://github.com/ClickHouse/ClickHouse/pull/11617)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* LDAP 統合: LDAP サーバー接続設定に `verification_cooldown` パラメータを追加し、成功した「bind」試行を設定可能な期間キャッシュできるようにしました。 [#15988](https://github.com/ClickHouse/ClickHouse/pull/15988) ([Denis Glazachev](https://github.com/traceon)).
* `clickhouse-local` をシステムテーブルを使用せずに実行するための `--no-system-table` オプションを追加しました。これにより、起動時に数十ミリ秒程度の時間を要することがある `DateLUT` の初期化を回避できます。 [#18899](https://github.com/ClickHouse/ClickHouse/pull/18899) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `windowFunnel` 関数のパフォーマンスを向上させるために、`AggregateFunctionWindowFunnelData` 内の `PODArray` を `PODArrayWithStackMemory` に置き換えました。 [#18817](https://github.com/ClickHouse/ClickHouse/pull/18817) ([flynn](https://github.com/ucasFL)).
* 同期的な Distributed テーブルへの `INSERT` 時に、空のブロックをシャードへ送信しないようにしました。これにより [#14571](https://github.com/ClickHouse/ClickHouse/issues/14571) が解決されました。[#18775](https://github.com/ClickHouse/ClickHouse/pull/18775)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* StorageMemory の読み取り処理を最適化しました。 [#18052](https://github.com/ClickHouse/ClickHouse/pull/18052) ([Maksim Kita](https://github.com/kitaisreal)).
* float から string への変換において ryu の代わりに Dragonbox アルゴリズムを使用。この変更により、変換処理のパフォーマンスが大幅に向上しました。 [#17831](https://github.com/ClickHouse/ClickHouse/pull/17831) ([Maksim Kita](https://github.com/kitaisreal)).
* `IPv6CIDRToRange` の実装を高速化。[#17569](https://github.com/ClickHouse/ClickHouse/pull/17569)（[vdimir](https://github.com/vdimir)）。
* `remerge_sort_lowered_memory_bytes_ratio` 設定を追加しました（remerge 後のメモリ使用量がこの比率まで低減されない場合、remerge は無効化されます）。 [#17539](https://github.com/ClickHouse/ClickHouse/pull/17539) ([Azat Khuzhin](https://github.com/azat)).
* PK に `SimpleAggregateFunction(String)` を含む `AggregatingMergeTree` のパフォーマンスを改善しました。 [#17109](https://github.com/ClickHouse/ClickHouse/pull/17109) ([Azat Khuzhin](https://github.com/azat)).
* これにより `-If` コンビネータが非仮想化され、`count` が正しくベクトル化されました。[この PR](https://github.com/ClickHouse/ClickHouse/pull/17041) に対応する変更です。[#17043](https://github.com/ClickHouse/ClickHouse/pull/17043)（[Amos Bird](https://github.com/amosbird)）。
* 膨大な数の `MergeTree` テーブルにまたがる `Merge` テーブルからの読み取り性能の問題を修正。 [#7748](https://github.com/ClickHouse/ClickHouse/issues/7748) を修正。 [#16988](https://github.com/ClickHouse/ClickHouse/pull/16988) ([Anton Popov](https://github.com/CurtizJ))。
* 関数 `repeat` のパフォーマンスを改善しました。 [#16937](https://github.com/ClickHouse/ClickHouse/pull/16937) ([satanson](https://github.com/satanson)).
* 浮動小数点数のパース性能をわずかに改善しました。 [#16809](https://github.com/ClickHouse/ClickHouse/pull/16809) ([Maksim Kita](https://github.com/kitaisreal)).
* `OPTIMIZE TABLE ... FINAL` において、マージ済みパーティションをスキップする機能を追加しました。 [#15939](https://github.com/ClickHouse/ClickHouse/pull/15939) ([Kruglov Pavel](https://github.com/Avogar)).
* 浮動小数点数をパースするために、[Daniel Lemire の fast&#95;float](https://github.com/lemire/fast_float) と統合しました。 [#16787](https://github.com/ClickHouse/ClickHouse/pull/16787) ([Maksim Kita](https://github.com/kitaisreal))。ただし、ClickHouse の簡易な float パーサーと比べて依然として性能が低いため、まだ有効化していません。
* max&#95;distributed&#95;connections を修正しました（`prefer_localhost_replica = 1` で、`max_threads != max_distributed_connections` の場合に影響します）。[#17848](https://github.com/ClickHouse/ClickHouse/pull/17848)（[Azat Khuzhin](https://github.com/azat)）。
* S3 へのデータ送信時に、単一パート／マルチパートアップロードを自動的に選択するようになりました。単一パートアップロードは新しい設定 `max_single_part_upload_size` によって制御されます。[#17934](https://github.com/ClickHouse/ClickHouse/pull/17934) ([Pavel Kovalenko](https://github.com/Jokser))。
* `PipelineExecutor` での非同期タスクのサポート。リモートクエリ向けの非同期ソケットの初期サポート。[#17868](https://github.com/ClickHouse/ClickHouse/pull/17868) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 列のサイズが不明な場合でも、コンパクトなパーツに対して `optimize_move_to_prewhere` 最適化を使用できるようにしました。 [#17330](https://github.com/ClickHouse/ClickHouse/pull/17330) ([Anton Popov](https://github.com/CurtizJ)).

#### 改善 {#improvement-10}


* `TinyLog` または `Log` テーブルエンジンを使用するテーブルから同一テーブルに対して `INSERT SELECT` を実行する際に発生するデッドロックを回避します。この変更により [#6802](https://github.com/ClickHouse/ClickHouse/issues/6802) が解決されました。この変更により [#18691](https://github.com/ClickHouse/ClickHouse/issues/18691) が解決されました。この変更により [#16812](https://github.com/ClickHouse/ClickHouse/issues/16812) が解決されました。この変更により [#14570](https://github.com/ClickHouse/ClickHouse/issues/14570) が解決されました。[#15260](https://github.com/ClickHouse/ClickHouse/pull/15260)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* [MySQL](https://dev.mysql.com/doc/refman/5.7/en/show-create-view.html) と同様に、`SHOW CREATE VIEW name` 構文のサポートを追加。 [#18095](https://github.com/ClickHouse/ClickHouse/pull/18095) ([Du Chuan](https://github.com/spongedu))。
* `Decimal * Float` 型の演算、またはその逆の演算を行うすべてのクエリが許可されており、集約クエリ（例: `SELECT sum(decimal_field * 1.1)` や `SELECT dec_col * float_col`）も含まれます。結果の型は Float32 または Float64 です。[#18145](https://github.com/ClickHouse/ClickHouse/pull/18145)（[Mike](https://github.com/myrrc)）。
* 最小限の Web UI を改良：履歴を追加；共有機能を追加；複数のリクエスト間の競合状態（レースコンディション）を回避；リクエスト処理中および準備完了のインジケーターを追加；favicon を追加；textarea にフォーカスがない場合でも Ctrl+Enter を検出。 [#17293](https://github.com/ClickHouse/ClickHouse/pull/17293) [#17770](https://github.com/ClickHouse/ClickHouse/pull/17770) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* clickhouse-server が ZooKeeper サーバーに `close` リクエストを送信しませんでした。 [#16837](https://github.com/ClickHouse/ClickHouse/pull/16837) ([alesapin](https://github.com/alesapin)).
* 極端に低いメモリ制限値（`max_memory_usage = 1` / `max_untracked_memory = 1`）が設定されている場合に、サーバーが異常終了しないようにしました。 [#17453](https://github.com/ClickHouse/ClickHouse/pull/17453) ([Azat Khuzhin](https://github.com/azat)).
* 異なるイベントが同一のタイムスタンプを持つ場合に `windowFunnel` 関数の結果が非決定的となる問題を修正しました。 [#18884](https://github.com/ClickHouse/ClickHouse/pull/18884) ([Fuwang Hu](https://github.com/fuwhu)).
* Docker: clickhouse-server Docker イメージにおいて、clickhouse ユーザーおよびグループの UID / GID を固定値 (101) に明示的に設定しました。[#19096](https://github.com/ClickHouse/ClickHouse/pull/19096) ([filimonov](https://github.com/filimonov))
* `Distributed` テーブルへの非同期 INSERT: MergeTree ファミリーと同様に、2 つの新しい設定が追加されました: `fsync_after_insert` - 挿入ごとに fsync を実行します。INSERT の性能が低下します。 `fsync_directories` - すべての操作（書き込み、リネームなど）の後に、非同期 INSERT のみで使用される一時ディレクトリに対して fsync を実行します。 [#18864](https://github.com/ClickHouse/ClickHouse/pull/18864) ([Azat Khuzhin](https://github.com/azat)).
* `SYSTEM KILL` コマンドが Docker 上でも動作するようになりました。これにより [#18847](https://github.com/ClickHouse/ClickHouse/issues/18847) がクローズされました。 [#18848](https://github.com/ClickHouse/ClickHouse/pull/18848) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `FETCH PARTITION` 実行時に、zk パス内のマクロを展開するようにしました。 [#18839](https://github.com/ClickHouse/ClickHouse/pull/18839) ([fastio](https://github.com/fastio)).
* `ALTER TABLE &lt;replicated_table&gt; ON CLUSTER MODIFY SETTING ...` をすべてのレプリカに適用します。この種の ALTER コマンドはレプリケーションされないためです。 [#18789](https://github.com/ClickHouse/ClickHouse/pull/18789) ([Amos Bird](https://github.com/amosbird)).
* カラムトランスフォーマー `EXCEPT` が正規表現パターンとして文字列を受け取れるようにしました。これにより [#18685](https://github.com/ClickHouse/ClickHouse/issues/18685) が解決されました。[#18699](https://github.com/ClickHouse/ClickHouse/pull/18699)（[Amos Bird](https://github.com/amosbird)）。
* SummingMergeTree における SimpleAggregateFunction を修正しました。これにより、現在は AggregateFunction と同様の動作をするようになりました。以前のバージョンでは、どの集約関数であっても値が単純に合計されていました。この修正により [#18564](https://github.com/ClickHouse/ClickHouse/issues/18564)・[#8052](https://github.com/ClickHouse/ClickHouse/issues/8052)・[#18637](https://github.com/ClickHouse/ClickHouse/pull/18637) が解決されています（[Amos Bird](https://github.com/amosbird)）。`SummingMergeTree` における `SimpleAggregateFunction` の使用に関する別の修正です。この修正により [#18676](https://github.com/ClickHouse/ClickHouse/issues/18676)・[#18677](https://github.com/ClickHouse/ClickHouse/pull/18677) が解決されています（[Amos Bird](https://github.com/amosbird)）。
* 関数 bar の最後の引数が NaN の場合に、アロケータ内で発生していたアサーションエラーを修正しました。現在は通常の ClickHouse 例外がスローされます。これにより [#17876](https://github.com/ClickHouse/ClickHouse/issues/17876) が修正されました。 [#18520](https://github.com/ClickHouse/ClickHouse/pull/18520) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov))。
* 一部のツールで例外メッセージの後に改行が入らないというユーザビリティ上の問題を修正。 [#18444](https://github.com/ClickHouse/ClickHouse/pull/18444) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `LowCardinality(Type)` から `Type`、およびその逆方向への主キーおよびパーティションキーのカラムの型変更を可能にしました。さらに、主キーのカラムの型を `EnumX` から `IntX` 型へ変更できるようにしました。問題 [#5604](https://github.com/ClickHouse/ClickHouse/issues/5604) を修正しました。[#18362](https://github.com/ClickHouse/ClickHouse/pull/18362)（[alesapin](https://github.com/alesapin)）。
* `untuple` フィールドアクセスを実装しました。 [#18133](https://github.com/ClickHouse/ClickHouse/issues/18133)。 [#18309](https://github.com/ClickHouse/ClickHouse/pull/18309)（[hexiaoting](https://github.com/hexiaoting)）。
* CSV 中で Array フィールドが、ネストされた CSV としてシリアライズされた配列を含む文字列で表現されている場合でも、`Array` フィールドとしてパースできるようにしました。例: `"[""Hello"", ""world"", ""42"""" TV""]"` は `['Hello', 'world', '42" TV']` としてパースされます。CSV の文字列中にある配列について、外側の角かっこで囲まずにパースできるようにしました。例: `"'Hello', 'world', '42"" TV'"` は `['Hello', 'world', '42" TV']` としてパースされます。[#18271](https://github.com/ClickHouse/ClickHouse/pull/18271) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* MergeTree の wide パーツに対するアダプティブな粒度計算を改善しました。 [#18223](https://github.com/ClickHouse/ClickHouse/pull/18223) ([alesapin](https://github.com/alesapin)).
* `clickhouse install` が Mac でも動作するようになりました。このプラットフォームには procfs が存在しないことが原因でした。[#18201](https://github.com/ClickHouse/ClickHouse/pull/18201)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* `SHOW ...` クエリ構文向けのヒントを改善。 [#18183](https://github.com/ClickHouse/ClickHouse/pull/18183) ([Du Chuan](https://github.com/spongedu)).
* 配列集約関数 `arrayMin`、`arrayMax`、`arraySum`、`arrayAvg` に `Int128`、`Int256`、`UInt256` のサポートを追加しました。 [#18147](https://github.com/ClickHouse/ClickHouse/pull/18147) ([Maksim Kita](https://github.com/kitaisreal)).
* Set および Join ストレージ設定に `disk` を追加。 [#18112](https://github.com/ClickHouse/ClickHouse/pull/18112) ([Grigory Pervakov](https://github.com/GrigoryPervakov)).
* アクセス制御: 現在、テーブル関数 `merge()` がデータを取得する各テーブルに対して、現在のユーザーが `SELECT` 権限を持っている必要があります。このPRで [#16964](https://github.com/ClickHouse/ClickHouse/issues/16964) が修正されました。 [#18104](https://github.com/ClickHouse/ClickHouse/pull/18104) [#17983](https://github.com/ClickHouse/ClickHouse/pull/17983) ([Vitaly Baranov](https://github.com/vitlibar))。
* 一時テーブルは、作成されたセッション内でのみシステムテーブル `system.tables` および `system.columns` に表示されるようになりました。内部データベース `_temporary_and_external_tables` はこれらのシステムテーブルからは非表示となり、一時テーブルは代わりに、データベース名が空で `is_temporary` フラグが設定されたテーブルとして表示されます。 [#18014](https://github.com/ClickHouse/ClickHouse/pull/18014) ([Vitaly Baranov](https://github.com/vitlibar))。
* ターミナルウィンドウのサイズ変更時に発生する clickhouse-client のレンダリングの不具合を修正。 [#18009](https://github.com/ClickHouse/ClickHouse/pull/18009) ([Amos Bird](https://github.com/amosbird))。
* クライアントが接続を切断したときに記録されるイベントのログ出力レベルを、Warning から Information に引き下げました。 [#18005](https://github.com/ClickHouse/ClickHouse/pull/18005) ([filimonov](https://github.com/filimonov)).
* DiskS3 向けに、ファイルシステム上の空または不正なメタデータファイルを強制的に削除するようにしました。S3 は実験的な機能です。[#17935](https://github.com/ClickHouse/ClickHouse/pull/17935) ([Pavel Kovalenko](https://github.com/Jokser))。
* アクセス制御: `allow_introspection_functions=0` はイントロスペクション関数の使用を禁止しますが、それらに対する権限付与を禁止しなくなりました（付与されたユーザーがその権限を利用できるようにするには、自身で `allow_introspection_functions=1` を設定する必要があります）。同様に、`allow_ddl=0` は DDL コマンドの使用を禁止しますが、それらに対する権限付与を禁止しなくなりました。[#17908](https://github.com/ClickHouse/ClickHouse/pull/17908)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 使い勝手の改善: 列名に関するヒント。 [#17112](https://github.com/ClickHouse/ClickHouse/issues/17112). [#17857](https://github.com/ClickHouse/ClickHouse/pull/17857) ([fastio](https://github.com/fastio)).
* 2 つのマージテーブルが相互にデータを読み取ろうとする場合の診断情報を追加。 [#17854](https://github.com/ClickHouse/ClickHouse/pull/17854) ([徐炘](https://github.com/weeds085490)).
* ClickHouse Docker イメージを使用する際、実行中のスクリプトのタイムアウト値をオーバーライドできるようにしました。 [#17818](https://github.com/ClickHouse/ClickHouse/pull/17818) ([Guillaume Tassery](https://github.com/YiuRULE)).
* 一部の設定ミスを防ぐために、system ログテーブルのエンジン定義に対して構文チェックを行うようにしました。この構文チェックはセマンティックチェックではないため、存在しないカラムや式・関数などの誤りは、テーブルが作成されるまで検出されないことに注意してください。 [#17739](https://github.com/ClickHouse/ClickHouse/pull/17739) ([Du Chuan](https://github.com/spongedu)).
* `RabbitMQ` テーブルの初期化時に接続がない場合でも例外をスローしないようにしました（バックグラウンドで再接続が行われます）。 [#17709](https://github.com/ClickHouse/ClickHouse/pull/17709) ([Kseniia Sumarokova](https://github.com/kssenii)).
* Buffer フラッシュ時にサーバーのメモリ制限を考慮するようにしました。 [#17646](https://github.com/ClickHouse/ClickHouse/pull/17646) ([Azat Khuzhin](https://github.com/azat)).
* use-after-free エラーを修正するために、ClickHouse-Extras に含まれるパッチ適用済みの RocksDB に切り替えました。 [#17643](https://github.com/ClickHouse/ClickHouse/pull/17643) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 並列パース時の例外メッセージにオフセットを追加しました。これにより [#17457](https://github.com/ClickHouse/ClickHouse/issues/17457) が修正されます。[#17641](https://github.com/ClickHouse/ClickHouse/pull/17641)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* INSERT クエリの実行中に途中で「Too many parts」エラーを発生させないようにしました。 [#17566](https://github.com/ClickHouse/ClickHouse/pull/17566) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* ALTER クエリ内の UPDATE ステートメントでクエリパラメータの使用を許可。 [#10976](https://github.com/ClickHouse/ClickHouse/issues/10976) を修正。 [#17563](https://github.com/ClickHouse/ClickHouse/pull/17563)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* クエリ難読化機能: 一部の SQL キーワードを識別子名として使用しないようにする。 [#17526](https://github.com/ClickHouse/ClickHouse/pull/17526) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* DDLWorker によって実行された DDL エントリの最大値をサーバーメトリクスとしてエクスポートします。これは、DDLWorker がどこかでハングしていないか確認するのに役立ちます。 [#17464](https://github.com/ClickHouse/ClickHouse/pull/17464) ([Amos Bird](https://github.com/amosbird))。
* すべてのサーバーにおける現在のスレッドの非同期メトリクスをエクスポートします。これは、[このような問題](https://github.com/ClickHouse-Extras/poco/pull/28)の追跡に役立ちます。 [#17463](https://github.com/ClickHouse/ClickHouse/pull/17463)（[Amos Bird](https://github.com/amosbird)）。
* 設定 `asterisk_include_materialized_columns` と `asterisk_include_alias_columns` が有効な場合、ワイルドカードクエリで MATERIALIZED / ALIAS などの動的カラムも含められるようにしました。 [#17462](https://github.com/ClickHouse/ClickHouse/pull/17462) ([Ken Chen](https://github.com/chenziliang)).
* `config.xml` 内の `<ttl>` 属性を使用して、古いエントリを [システムログテーブル](/operations/system-tables/) から削除するための [TTL](/engines/table-engines/mergetree-family/mergetree/#mergetree-table-ttl) を指定できるようになりました。[#17438](https://github.com/ClickHouse/ClickHouse/pull/17438) ([Du Chuan](https://github.com/spongedu))。
* 現在では、MySQL および PostgreSQL プロトコル経由でサーバーに送信されるクエリには、（テーブル `system.query_log` の `interface` 列で確認できる）固有のインターフェース種別が割り当てられます。MySQL には `4`、PostgreSQL には `5` が使用され、以前使用されていた `1` は、現在はネイティブプロトコルのみに使用されます。 [#17437](https://github.com/ClickHouse/ClickHouse/pull/17437) ([Vitaly Baranov](https://github.com/vitlibar)).
* `INSERT ... SELECT ... SETTINGS` クエリにおける `SETTINGS` 句の構文解析を修正。[#17414](https://github.com/ClickHouse/ClickHouse/pull/17414) ([Azat Khuzhin](https://github.com/azat))。
* RadixSort でのメモリ使用量を正しく計上。[#17412](https://github.com/ClickHouse/ClickHouse/pull/17412)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* サーバーの `receiveHello` に EOF チェックを追加し、`Attempt to read after eof` 例外が発生しないようにしました。[#17365](https://github.com/ClickHouse/ClickHouse/pull/17365) ([Kruglov Pavel](https://github.com/Avogar))。
* bigint 変換時に起こり得るスタックオーバーフローを回避しました。bigint は実験的な機能です。 [#17269](https://github.com/ClickHouse/ClickHouse/pull/17269) ([flynn](https://github.com/ucasFL))。
* `set` インデックスが `GLOBAL IN` でも動作するようになりました。これにより [#17232](https://github.com/ClickHouse/ClickHouse/issues/17232)、[#5576](https://github.com/ClickHouse/ClickHouse/issues/5576) が修正されました。 [#17253](https://github.com/ClickHouse/ClickHouse/pull/17253)（[Amos Bird](https://github.com/amosbird)）。
* S3 ストレージへのリクエストに対する HTTP リダイレクト回数の上限を追加しました（`s3_max_redirects`）。[#17220](https://github.com/ClickHouse/ClickHouse/pull/17220)（[ianton-ru](https://github.com/ianton-ru)）。
* `-OrNull` コンビネータを `-If`、`-Merge`、`-MergeState`、`-State` コンビネータと併用する場合は、`-OrNull` を先頭に付ける必要があります。 [#16935](https://github.com/ClickHouse/ClickHouse/pull/16935) ([flynn](https://github.com/ucasFL))。
* HTTP プロキシおよび HTTPS S3 エンドポイントの設定をサポート。[#16861](https://github.com/ClickHouse/ClickHouse/pull/16861)（[Pavel Kovalenko](https://github.com/Jokser)）。
* S3 クライアントに対し、環境変数や `~/.aws`、AssumeRole を利用した適切な認証を追加しました。 [#16856](https://github.com/ClickHouse/ClickHouse/pull/16856) ([Vladimir Chebotarev](https://github.com/excitoon)).
* OpenTelemetry のスパンをさらに追加。スパンデータを Zipkin にエクスポートする方法の例を追加。 [#16535](https://github.com/ClickHouse/ClickHouse/pull/16535) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* Cache dictionaries: 取得時のコールバックおよびロックを完全に排除しました。キーは「not found」および「expired」に分けず、クエリ実行中は同じマップ内に保持されます。 [#14958](https://github.com/ClickHouse/ClickHouse/pull/14958) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 実験的機能である `fsync_part_directory`/`fsync_after_insert`/`in_memory_parts_insert_sync` が正常に動作していなかった問題を修正。 [#18845](https://github.com/ClickHouse/ClickHouse/pull/18845) ([Azat Khuzhin](https://github.com/azat)).
* `MaterializeMySQL` エンジンの内部データベースに対して `Atomic` エンジンを使用できるようにしました。 [#14849](https://github.com/ClickHouse/ClickHouse/pull/14849) ([tavplubix](https://github.com/tavplubix)).

#### バグ修正 {#bug-fix-10}


* ごくまれなケースでサーバーが接続を受け付けなくなる問題を修正しました。 [#17542](https://github.com/ClickHouse/ClickHouse/pull/17542) (Amos Bird、[alexey-milovidov](https://github.com/alexey-milovidov))。
* 定数引数を持つ二項関数のインデックス解析を修正し、誤ったクエリ結果が返される問題を解消しました。これにより [#18364](https://github.com/ClickHouse/ClickHouse/issues/18364) が解決されました。[#18373](https://github.com/ClickHouse/ClickHouse/pull/18373)（[Amos Bird](https://github.com/amosbird)）。
* インデックスの比較に用いる型が異なる場合に誤ったインデックス解析が行われる不具合を修正しました。これにより、[#17122](https://github.com/ClickHouse/ClickHouse/issues/17122) が修正されました。[#17145](https://github.com/ClickHouse/ClickHouse/pull/17145)（[Amos Bird](https://github.com/amosbird)）。
* マージ時の AIO を用いた書き込みを無効化しました。これは、マージ処理中にプライマリキー列のデータ破損が極めてまれに発生する可能性があるためです。 [#18481](https://github.com/ClickHouse/ClickHouse/pull/18481) ([alesapin](https://github.com/alesapin)).
* wide から compact パーツへのマージを制限しました。vertical merge の場合、結果のパーツが破損した状態になってしまう問題がありました。 [#18381](https://github.com/ClickHouse/ClickHouse/pull/18381) ([Anton Popov](https://github.com/CurtizJ)).
* `MergeTree*` からの読み取りにおいて、read backoff が発生した場合（ログ内のメッセージ `<Debug> MergeTreeReadPool: Will lower number of threads`）にクエリ結果が不完全に返される可能性がある問題を修正しました。この問題は [#16423](https://github.com/ClickHouse/ClickHouse/issues/16423) により導入されたものです。[#18137](https://github.com/ClickHouse/ClickHouse/issues/18137) を修正します。[#18216](https://github.com/ClickHouse/ClickHouse/pull/18216)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `rocksdb` ライブラリにおける use-after-free のバグを修正。 [#18862](https://github.com/ClickHouse/ClickHouse/pull/18862) ([sundyli](https://github.com/sundy-li)).
* `ORC` フォーマットのファイルからの読み取りが無限ループしてしまう問題を修正（[#10580](https://github.com/ClickHouse/ClickHouse/issues/10580) で導入された不具合）。[#19095](https://github.com/ClickHouse/ClickHouse/issues/19095) を修正。[#19134](https://github.com/ClickHouse/ClickHouse/pull/19134)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* 固定グラニュラリティサイズよりも大きいサイズのマークが作成されてしまう可能性がある MergeTree データライタのバグを修正しました。 [#18913](https://github.com/ClickHouse/ClickHouse/issues/18913) に対応。 [#19123](https://github.com/ClickHouse/ClickHouse/pull/19123) ([alesapin](https://github.com/alesapin))。
* ClickHouse の起動時に、`LowCardinality(Nullable(...))` から圧縮コーデックを読み取れずに `Attempt to read after EOF` という例外をスローしていたバグを修正しました。[#18340](https://github.com/ClickHouse/ClickHouse/issues/18340) を修正します。[#19101](https://github.com/ClickHouse/ClickHouse/pull/19101) ([alesapin](https://github.com/alesapin))。
* 旧構文で作成された `MergeTree` テーブルに対する `MODIFY TTL` クエリを制限しました。以前はクエリは成功していましたが、実際には何の効果もありませんでした。[#19064](https://github.com/ClickHouse/ClickHouse/pull/19064) ([Anton Popov](https://github.com/CurtizJ))。
* `Enum` 型の引数に対して `groupUniqArray` が正しい型を返すことを保証しました。これにより [#17875](https://github.com/ClickHouse/ClickHouse/issues/17875) が解決されます。 [#19019](https://github.com/ClickHouse/ClickHouse/pull/19019)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `LowCardinality` 引数と共に `ignore` 関数を使用した場合に発生する可能性のある `Expected single dictionary argument for function` エラーを修正しました。[#14275](https://github.com/ClickHouse/ClickHouse/issues/14275) を解決。[#19016](https://github.com/ClickHouse/ClickHouse/pull/19016)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* `TinyLog` エンジンのテーブルに `LowCardinality` カラムを挿入する処理を修正しました。[#18629](https://github.com/ClickHouse/ClickHouse/issues/18629) を修正。[#19010](https://github.com/ClickHouse/ClickHouse/pull/19010)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* Join は const カラムをマテリアライズしようとしますが、コード側ではそれらが別の場所にあることを前提としています。 [#18982](https://github.com/ClickHouse/ClickHouse/pull/18982) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* 最適化が常に正しく動作するとは限らないため、`optimize_move_functions_out_of_any` を無効化しました。これにより [#18051](https://github.com/ClickHouse/ClickHouse/issues/18051) および [#18973](https://github.com/ClickHouse/ClickHouse/issues/18973) がクローズされます。[#18981](https://github.com/ClickHouse/ClickHouse/pull/18981)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* クエリプランの `Expression` ステップのマージによって発生し得る `QueryPipeline stream: different number of columns` という例外を修正。[#18190](https://github.com/ClickHouse/ClickHouse/issues/18190) を解決。[#18980](https://github.com/ClickHouse/ClickHouse/pull/18980)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* シャットダウン時に非常にまれに発生していたデッドロックを修正。 [#18977](https://github.com/ClickHouse/ClickHouse/pull/18977) ([tavplubix](https://github.com/tavplubix)).
* `ALTER TABLE ... DROP PART 'part_name'` クエリがパーティション全体の重複排除ブロックをすべて削除してしまう誤った動作を修正し、この問題 [#18874](https://github.com/ClickHouse/ClickHouse/issues/18874) を解決。 [#18969](https://github.com/ClickHouse/ClickHouse/pull/18969) ([alesapin](https://github.com/alesapin))。
* `ATTACH PARTITION` はミューテーションをリセットするようになりました。 [#18804](https://github.com/ClickHouse/ClickHouse/issues/18804)。 [#18935](https://github.com/ClickHouse/ClickHouse/pull/18935) ([fastio](https://github.com/fastio))。
* `bitmapOrCardinality` によってヌルポインタ参照が発生する可能性のある問題を修正しました。これにより [#18911](https://github.com/ClickHouse/ClickHouse/issues/18911) がクローズされます。 [#18912](https://github.com/ClickHouse/ClickHouse/pull/18912) ([sundyli](https://github.com/sundy-li)).
* `clickhouse-local` のシャットダウン時に発生する可能性のあったハングを修正しました。これにより [#18891](https://github.com/ClickHouse/ClickHouse/issues/18891) が解決されます。 [#18893](https://github.com/ClickHouse/ClickHouse/pull/18893) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* 外部データベース（MySQL、ODBC、JDBC）に対するクエリで、`x IN table` 形式の式が含まれている場合に、誤った書き換えが行われていました。この変更により [#9756](https://github.com/ClickHouse/ClickHouse/issues/9756) が修正されました。[#18876](https://github.com/ClickHouse/ClickHouse/pull/18876)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 単項関数および Nullable 型に対する *If コンビネータを修正しました。 [#18806](https://github.com/ClickHouse/ClickHouse/pull/18806) ([Azat Khuzhin](https://github.com/azat)).
* 設定 `network_compression_method` がグローバル設定でデフォルト以外の値になっている場合に、非同期の分散 `INSERT` がサーバーによって拒否される可能性がある問題を修正しました。これにより [#18741](https://github.com/ClickHouse/ClickHouse/issues/18741) が修正されます。 [#18776](https://github.com/ClickHouse/ClickHouse/pull/18776)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `Nullable(String)` から `Nullable(Decimal(P, S))` への `CAST` を試みた際に発生していた `Attempt to read after eof` エラーを修正しました。NULL 許容の文字列から Decimal をパースできない場合、`CAST` 関数は `NULL` を返すようになりました。これにより [#7690](https://github.com/ClickHouse/ClickHouse/issues/7690) が修正されています。 [#18718](https://github.com/ClickHouse/ClickHouse/pull/18718)（[Winter Zhang](https://github.com/zhang2014)）。
* ロギングに関する軽微な不具合を修正。 [#18717](https://github.com/ClickHouse/ClickHouse/pull/18717) ([sundyli](https://github.com/sundy-li))。
* 古い構文で作成された `ReplicatedMergeTree` テーブルにおける空パーツの削除処理を修正しました。[#18582](https://github.com/ClickHouse/ClickHouse/issues/18582) を解決。[#18614](https://github.com/ClickHouse/ClickHouse/pull/18614)（[Anton Popov](https://github.com/CurtizJ)）。
* 日付のオーバーフロー時に異なる値が返される既存のバグを修正。`Date` 型の値の上限を「2106-02-07」に厳密に制限し、「2106-02-07」を超える日付は値 0 にキャストするように変更。 [#18565](https://github.com/ClickHouse/ClickHouse/pull/18565) ([hexiaoting](https://github.com/hexiaoting)).
* MySQL からのレプリケーションに FixedString データ型のサポートを追加しました。MySQL からのレプリケーションは試験的な機能です。このパッチで [#18450](https://github.com/ClickHouse/ClickHouse/issues/18450) を修正し、[#6556](https://github.com/ClickHouse/ClickHouse/issues/6556) も修正します。[#18553](https://github.com/ClickHouse/ClickHouse/pull/18553)（[awesomeleo](https://github.com/awesomeleo)）。
* `RIGHT` または `FULL` 結合を含む副問い合わせの後に `ORDER BY` を使用した際に発生する可能性のある `Pipeline stuck` エラーを修正しました。 [#18550](https://github.com/ClickHouse/ClickHouse/pull/18550) ([Nikolai Kochetov](https://github.com/KochetovNicolai)).
* 対応するミューテーションを kill した後に `ALTER` クエリがハングする可能性のあるバグを修正しました。thread fuzzer により発見されました。[#18518](https://github.com/ClickHouse/ClickHouse/pull/18518) ([alesapin](https://github.com/alesapin))。
* `parseDateTimeBestEffort` 関数での午前0時（12AM）の処理を適切にサポートしました。これにより [#18402](https://github.com/ClickHouse/ClickHouse/issues/18402) が修正されました。 [#18449](https://github.com/ClickHouse/ClickHouse/pull/18449) ([vladimir-golovchenko](https://github.com/vladimir-golovchenko))。
* `Nullable(String)` 型の引数で `toType(...)` 関数（`toDate`、`toUInt32` など）を実行した際に発生していた `value is too short` エラーを修正しました。これらの関数は、例外をスローするのではなく、パースエラーが発生した場合に `NULL` を返すようになりました。[#7673](https://github.com/ClickHouse/ClickHouse/issues/7673) を修正。[#18445](https://github.com/ClickHouse/ClickHouse/pull/18445)（[tavplubix](https://github.com/tavplubix)）。
* `SHOW TABLES` の予期しない挙動を修正しました。 [#18431](https://github.com/ClickHouse/ClickHouse/pull/18431) ([fastio](https://github.com/fastio)).
* -Fix -SimpleState コンビネータが互換性のない引数型と戻り値型を生成していた問題を修正。 [#18404](https://github.com/ClickHouse/ClickHouse/pull/18404) ([Amos Bird](https://github.com/amosbird)).
* `Set` または `Join` テーブルの同時利用と `system.tables` からの `SELECT` を併用した場合に発生しうるレースコンディションを修正しました。 [#18385](https://github.com/ClickHouse/ClickHouse/pull/18385) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* テーブル `system.settings_profile_elements` へのデータ投入処理を修正。この PR は [#18231](https://github.com/ClickHouse/ClickHouse/issues/18231) を解決します。 [#18379](https://github.com/ClickHouse/ClickHouse/pull/18379)（[Vitaly Baranov](https://github.com/vitlibar)）。
* 二段階集約を使用している場合に、`Distinct` コンビネータ付きの集約関数で発生しうるクラッシュを修正。[#17682](https://github.com/ClickHouse/ClickHouse/issues/17682) を修正。[#18365](https://github.com/ClickHouse/ClickHouse/pull/18365)（[Anton Popov](https://github.com/CurtizJ)）。
* デュアル IPv4/IPv6 スタックを持つマシンで `clickhouse-odbc-bridge` プロセスがサーバーから到達できなくなる問題を修正しました。ODBC 辞書の更新が不正な形式のクエリで実行されたり、`odbc-bridge` プロセスのクラッシュを引き起こしたりする問題を修正しました。おそらく [#14489](https://github.com/ClickHouse/ClickHouse/issues/14489) をクローズします。 [#18278](https://github.com/ClickHouse/ClickHouse/pull/18278) ([Denis Glazachev](https://github.com/traceon)).
* アクセス制御: ユーザーがテーブル内の少なくとも 1 つの列へのアクセス権を持っていれば、`SELECT count() FROM table` を実行できるようになりました。この PR により [#10639](https://github.com/ClickHouse/ClickHouse/issues/10639) が修正されました。[#18233](https://github.com/ClickHouse/ClickHouse/pull/18233)（[Vitaly Baranov](https://github.com/vitlibar)）。
* アクセス制御: `SELECT JOIN` には、結合される各テーブルに対する `SELECT` 権限が必要になりました。この PR により [#17654](https://github.com/ClickHouse/ClickHouse/issues/17654) が修正されました。 [#18232](https://github.com/ClickHouse/ClickHouse/pull/18232) ([Vitaly Baranov](https://github.com/vitlibar))。
* Enum 型と Int 型間のキー比較の問題を修正しました。これにより [#17989](https://github.com/ClickHouse/ClickHouse/issues/17989) が解決されました。[#18214](https://github.com/ClickHouse/ClickHouse/pull/18214) ([Amos Bird](https://github.com/amosbird))。
* MySQL からのレプリケーション（実験的機能）。[#18186](https://github.com/ClickHouse/ClickHouse/issues/18186) を修正。[#16372](https://github.com/ClickHouse/ClickHouse/issues/16372) を修正。MaterializeMySQL データベースエンジンにおけるユニークキー変換に関する問題を修正。[#18211](https://github.com/ClickHouse/ClickHouse/pull/18211)（[Winter Zhang](https://github.com/zhang2014)）。
* `WITH FILL` と `WITH TIES` の両方を含むクエリにおける不整合な動作を修正 [#17466](https://github.com/ClickHouse/ClickHouse/issues/17466)。[#18188](https://github.com/ClickHouse/ClickHouse/pull/18188)（[hexiaoting](https://github.com/hexiaoting)）。
* 最後の列でパースエラーが発生した場合にデフォルト値を持つ行を挿入する処理を修正しました。[#17712](https://github.com/ClickHouse/ClickHouse/issues/17712) を修正。[#18182](https://github.com/ClickHouse/ClickHouse/pull/18182)（[Jianmei Zhang](https://github.com/zhangjmruc)）。
* 設定プロファイルを適用しようとした際に発生する `Unknown setting profile` エラーを修正。 [#18167](https://github.com/ClickHouse/ClickHouse/pull/18167) ([tavplubix](https://github.com/tavplubix)).
* クエリ `MODIFY COLUMN ... REMOVE TTL` が実際にはカラム TTL を削除しない不具合を修正。 [#18130](https://github.com/ClickHouse/ClickHouse/pull/18130) ([alesapin](https://github.com/alesapin))。
* S3 URL のパース処理で発生していた `std::out_of_range: basic_string` を修正しました。 [#18059](https://github.com/ClickHouse/ClickHouse/pull/18059) ([Vladimir Chebotarev](https://github.com/excitoon)).
* `DateTime64` と `Date` の比較を修正しました。これにより [#13804](https://github.com/ClickHouse/ClickHouse/issues/13804) および [#11222](https://github.com/ClickHouse/ClickHouse/issues/11222) が修正されました。... [#18050](https://github.com/ClickHouse/ClickHouse/pull/18050)（[Vasily Nemkov](https://github.com/Enmk)）。
* MySQL からのレプリケーション（実験的機能）：[#15187](https://github.com/ClickHouse/ClickHouse/issues/15187) を修正。[#17912](https://github.com/ClickHouse/ClickHouse/issues/17912) を修正。MaterializeMySQL 向けの MySQL プレフィックスインデックスの変換をサポート。[#17944](https://github.com/ClickHouse/ClickHouse/pull/17944)（[Winter Zhang](https://github.com/zhang2014)）。
* `logger.size` パラメータに 2^32 を超える数値を指定してサーバーログのローテーションを設定していた場合、ログが正しくローテーションされていませんでした。この問題は修正されました。 [#17905](https://github.com/ClickHouse/ClickHouse/pull/17905) ([Alexander Kuzmenkov](https://github.com/akuzm)).
* クエリに `ARRAY JOIN` が含まれている場合（つまりクエリが実際には自明なものではない場合）、単純クエリ最適化により誤った結果が返されていました。 [#17887](https://github.com/ClickHouse/ClickHouse/pull/17887) ([sundyli](https://github.com/sundy-li)).
* `topK` 集約関数で発生し得るセグメンテーションフォルトを修正しました。これにより [#17404](https://github.com/ClickHouse/ClickHouse/issues/17404) がクローズされました。 [#17845](https://github.com/ClickHouse/ClickHouse/pull/17845) ([Maksim Kita](https://github.com/kitaisreal)).
* WAL（実験的機能）：`in_memory_parts_enable_wal` が無効になっている場合、WAL からパーツを復元しないようにしました。[#17802](https://github.com/ClickHouse/ClickHouse/pull/17802)（[detailyang](https://github.com/detailyang)）。
* `max table size to drop` の例外メッセージが正しく表示されていませんでした。 [#17764](https://github.com/ClickHouse/ClickHouse/pull/17764) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `Distributed` テーブルへの挿入時に空き容量が不足している場合に発生しうるセグメンテーションフォルトを修正しました。 [#17737](https://github.com/ClickHouse/ClickHouse/pull/17737) ([tavplubix](https://github.com/tavplubix)).
* ClickHouse が MySQL サーバーへの再接続に失敗する問題を修正しました。 [#17681](https://github.com/ClickHouse/ClickHouse/pull/17681) ([Alexander Kazakov](https://github.com/Akazz)).
* Windows: Windows Subsystem for Linux 上で ClickHouse を実行している環境で、`Atomic` データベースに対して `RENAME` クエリを実行すると発生していた `Function not implemented` エラーを修正しました。[#17661](https://github.com/ClickHouse/ClickHouse/issues/17661) の問題を解決。[#17664](https://github.com/ClickHouse/ClickHouse/pull/17664)（[tavplubix](https://github.com/tavplubix)）。
* `pool_size` &gt; 1 の場合のレースコンディションにより、`ON CLUSTER` クエリの実行時にクラスタが循環（クロス）レプリケーション構成かどうかが誤判定される場合がありました。この問題は修正されました。 [#17640](https://github.com/ClickHouse/ClickHouse/pull/17640) ([tavplubix](https://github.com/tavplubix)).
* サーバーがデーモンモードで動作している場合に `system.stack_trace` テーブルが空になってしまう問題を修正。 [#17630](https://github.com/ClickHouse/ClickHouse/pull/17630) ([Amos Bird](https://github.com/amosbird))。
* MergeTree テーブルに対して、バックグラウンドで `fmt::v7::format_error` 例外がログに記録されることがありました。この問題を修正しました [#17613](https://github.com/ClickHouse/ClickHouse/issues/17613)。[#17615](https://github.com/ClickHouse/ClickHouse/pull/17615)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `clickhouse-client` をインタラクティブモードで複数行クエリとともに使用した場合、単一行コメントが誤ってクエリの終端まで有効になっていました。これにより [#13654](https://github.com/ClickHouse/ClickHouse/issues/13654) が修正されました。[#17565](https://github.com/ClickHouse/ClickHouse/pull/17565)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* 対応するmutationが別のレプリカ上でkillされた場合に `ALTER` クエリがハングする問題を修正しました。 [#16953](https://github.com/ClickHouse/ClickHouse/issues/16953) を修正。 [#17499](https://github.com/ClickHouse/ClickHouse/pull/17499) ([alesapin](https://github.com/alesapin)).
* mark cache サイズが ClickHouse によって過小に見積もられた場合のメモリ計上の問題を修正しました。これは、多数の非常に小さな mark ファイルが存在する場合に発生する可能性があります。 [#17496](https://github.com/ClickHouse/ClickHouse/pull/17496) ([alesapin](https://github.com/alesapin))。
* 設定 `optimize_redundant_functions_in_order_by` が有効な場合の `ORDER BY` の動作を修正。 [#17471](https://github.com/ClickHouse/ClickHouse/pull/17471) ([Anton Popov](https://github.com/CurtizJ)).
* 誤った最適化により `DISTINCT` の後に発生する可能性があった重複を修正しました。 [#17294](https://github.com/ClickHouse/ClickHouse/issues/17294) を修正します。 [#17296](https://github.com/ClickHouse/ClickHouse/pull/17296)（[li chengxiang](https://github.com/chengxianglibra)）。 [#17439](https://github.com/ClickHouse/ClickHouse/pull/17439)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* *MergeTree テーブルのバックグラウンドタスクで CPU 使用率が高くなる問題を修正しました。 [#17416](https://github.com/ClickHouse/ClickHouse/pull/17416) ([tavplubix](https://github.com/tavplubix))。
* `LowCardinality` 型を含む `JOIN` テーブルからの読み取り時に発生しうるクラッシュを修正。 [#17228](https://github.com/ClickHouse/ClickHouse/issues/17228) に対応。 [#17397](https://github.com/ClickHouse/ClickHouse/pull/17397)（[Nikolai Kochetov](https://github.com/KochetovNicolai)）。
* MySQL からのレプリケーション（実験的機能）：MySQL の `SHOW` 文とのヘッダー不一致を修正。[#16835](https://github.com/ClickHouse/ClickHouse/issues/16835)、[#17366](https://github.com/ClickHouse/ClickHouse/pull/17366)（[Winter Zhang](https://github.com/zhang2014)）。
* 述語オプティマイザにおける非決定的関数の問題を修正しました。これにより [#17244](https://github.com/ClickHouse/ClickHouse/issues/17244) が解決されます。[#17273](https://github.com/ClickHouse/ClickHouse/pull/17273)（[Winter Zhang](https://github.com/zhang2014)）。
* `LIMIT` を含む Distributed クエリで発生する可能性のある `Unexpected packet Data received from client` エラーを修正しました。 [#17254](https://github.com/ClickHouse/ClickHouse/pull/17254) ([Azat Khuzhin](https://github.com/azat)).
* サブクエリ内に const 列が存在する場合に set インデックスが無効化されてしまう問題を修正しました。これにより [#17246](https://github.com/ClickHouse/ClickHouse/issues/17246) が解決されます。[#17249](https://github.com/ClickHouse/ClickHouse/pull/17249)（[Amos Bird](https://github.com/amosbird)）。
* clickhouse-copier: 非パーティション化テーブル向けの修正 [#15235](https://github.com/ClickHouse/ClickHouse/issues/15235). [#17248](https://github.com/ClickHouse/ClickHouse/pull/17248) ([Qi Chen](https://github.com/kaka11chen)).
* S3 ディスク上に保存されたパーツに対して、正しく動作しない可能性があった mutation を修正しました（実験的機能）。 [#17227](https://github.com/ClickHouse/ClickHouse/pull/17227) ([Pavel Kovalenko](https://github.com/Jokser)).
* `fuzzBits` 関数のバグ修正。関連 issue: [#16980](https://github.com/ClickHouse/ClickHouse/issues/16980)。[#17051](https://github.com/ClickHouse/ClickHouse/pull/17051)（[hexiaoting](https://github.com/hexiaoting)）。
* OFFSET のみを指定したクエリに対して `optimize_distributed_group_by_sharding_key` を修正。 [#16996](https://github.com/ClickHouse/ClickHouse/pull/16996) ([Azat Khuzhin](https://github.com/azat)).
* JOIN を含む `Distributed` テーブル上の `Merge` テーブルからのクエリを修正。 [#16993](https://github.com/ClickHouse/ClickHouse/pull/16993) ([Azat Khuzhin](https://github.com/azat)).
* 単調関数を用いた `ORDER BY` の最適化を修正。[#16107](https://github.com/ClickHouse/ClickHouse/issues/16107) を修正。[#16956](https://github.com/ClickHouse/ClickHouse/pull/16956)（[Anton Popov](https://github.com/CurtizJ)）。
* 異なるスケールを持つ `DateTime64` 型同士の誤った比較を修正。[#16655](https://github.com/ClickHouse/ClickHouse/issues/16655) ... [#16952](https://github.com/ClickHouse/ClickHouse/pull/16952) を修正（[Vasily Nemkov](https://github.com/Enmk)）。
* `optimize_aggregators_of_group_by_keys` 設定が有効な場合の `GROUP BY` および `JOIN` の最適化処理を修正。[#12604](https://github.com/ClickHouse/ClickHouse/issues/12604) を修正。[#16951](https://github.com/ClickHouse/ClickHouse/pull/16951)（[Anton Popov](https://github.com/CurtizJ)）。
* SHOW ACCESS クエリを軽微に修正。 [#16866](https://github.com/ClickHouse/ClickHouse/pull/16866) ([tavplubix](https://github.com/tavplubix))。
* `optimize_trivial_count_query` 設定を有効にし、パーティション述語を指定した場合の動作を修正しました。[#16767](https://github.com/ClickHouse/ClickHouse/pull/16767)（[Azat Khuzhin](https://github.com/azat)）。
* MySQL ワイヤープロトコル経由の INSERT クエリに対して、影響を受けた行数を返すようにしました。これまでは ClickHouse は常に 0 を返していましたが、これを修正しました。[#16605](https://github.com/ClickHouse/ClickHouse/issues/16605) を修正。[#16715](https://github.com/ClickHouse/ClickHouse/pull/16715)（[Winter Zhang](https://github.com/zhang2014)）。
* 最適化された単純な count クエリおよび system テーブルに対して、`select_sequential_consistency` によって発生していた一貫性のない動作を修正。 [#16309](https://github.com/ClickHouse/ClickHouse/pull/16309) ([Hao Chen](https://github.com/haoch))。
* 存在しない列を対象に `REPLACE` 列トランスフォーマを実行した場合にエラーをスローするようにしました。 [#16183](https://github.com/ClickHouse/ClickHouse/pull/16183) ([hexiaoting](https://github.com/hexiaoting)).
* RIGHT|FULL JOIN において、ON 句に等値結合ではない式が指定された場合に例外をスローするようにしました。 [#15162](https://github.com/ClickHouse/ClickHouse/pull/15162) ([Artem Zuikov](https://github.com/4ertus2)).

#### ビルド/テスト/パッケージングの改善 {#buildtestingpackaging-improvement-10}


* ClickHouse バイナリに対する簡易的な整合性チェックを追加しました。これにより、故障したハードウェア（ストレージ媒体上のビットロットや RAM でのビット反転）に起因する破損を検出できます。 [#18811](https://github.com/ClickHouse/ClickHouse/pull/18811) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `OpenSSL` を `BoringSSL` に変更しました。これにより、sanitizer 使用時の問題を回避できます。これにより [#12490](https://github.com/ClickHouse/ClickHouse/issues/12490) が修正されました。これにより [#17502](https://github.com/ClickHouse/ClickHouse/issues/17502) が修正されました。これにより [#12952](https://github.com/ClickHouse/ClickHouse/issues/12952) が修正されました。 [#18129](https://github.com/ClickHouse/ClickHouse/pull/18129) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* `Sys/V` init スクリプトを簡素化しました。Ubuntu 12.04 およびそれ以前では正常に動作していませんでした。[#17428](https://github.com/ClickHouse/ClickHouse/pull/17428)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* `./clickhouse install` スクリプトを複数点で改善。 [#17421](https://github.com/ClickHouse/ClickHouse/pull/17421) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* ClickHouse は擬似的な ZooKeeper として振る舞えるようになりました。現在のストレージ実装はインメモリのハッシュテーブルに過ぎず、サーバーは ZooKeeper プロトコルを部分的にのみサポートしています。 [#16877](https://github.com/ClickHouse/ClickHouse/pull/16877) ([alesapin](https://github.com/alesapin))
* TestKeeperStorage（ZooKeeper のモック）における dead list watches の削除を修正。 [#18065](https://github.com/ClickHouse/ClickHouse/pull/18065) ([alesapin](https://github.com/alesapin)).
* フォールトインジェクション用の `SYSTEM SUSPEND` コマンドを追加しました。フェイルオーバーテストを容易にするために使用できます。これにより [#15979](https://github.com/ClickHouse/ClickHouse/issues/15979) が解決されます。 [#18850](https://github.com/ClickHouse/ClickHouse/pull/18850) ([alexey-milovidov](https://github.com/alexey-milovidov))。
* ClickHouse を `lld` でリンクする際に build ID を生成するようにしました。私の環境では `lld` がデフォルトでは build ID を生成しないことがわかりました。build ID はクラッシュレポートおよびイントロスペクションに使用されます。 [#18808](https://github.com/ClickHouse/ClickHouse/pull/18808) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* スタイルチェックにおける shellcheck エラーを修正。[#18566](https://github.com/ClickHouse/ClickHouse/pull/18566) ([Ilya Yatsishin](https://github.com/qoega)).
* タイムゾーン情報を 2020e 版に更新。 [#18531](https://github.com/ClickHouse/ClickHouse/pull/18531) ([alesapin](https://github.com/alesapin)).
* codespell の警告を修正。スタイルチェックを個別のチェックに分割。スタイルチェック用の Docker イメージを更新。[#18463](https://github.com/ClickHouse/ClickHouse/pull/18463) ([Ilya Yatsishin](https://github.com/qoega))。
* ドキュメント内に残っているコンフリクトマーカーを自動チェックする機能を追加。 [#18332](https://github.com/ClickHouse/ClickHouse/pull/18332) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* ステートレステストの不安定テスト検出用に Thread Fuzzer を有効化。 [#18299](https://github.com/ClickHouse/ClickHouse/pull/18299) ([alesapin](https://github.com/alesapin)).
* 非スレッドセーフな関数 `strerror` を使用しないようにしました。 [#18204](https://github.com/ClickHouse/ClickHouse/pull/18204) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* `anchore/scan-action@main` ワークフローアクションを更新（ブランチが `master` から `main` に移行）。[#18192](https://github.com/ClickHouse/ClickHouse/pull/18192) ([Stig Bakken](https://github.com/stigsb))。
* 現在、`clickhouse-test` はタイムアウト付きでデータベースの DROP/CREATE を行います。 [#18098](https://github.com/ClickHouse/ClickHouse/pull/18098) ([alesapin](https://github.com/alesapin)).
* ステートレステスト向け Pytest フレームワークの実験的サポートを有効にしました。 [#17902](https://github.com/ClickHouse/ClickHouse/pull/17902) ([Ivan](https://github.com/abyss7))。
* これで、インテグレーションテストでは最新の Docker デーモンのバージョンを使用するようになりました。 [#17671](https://github.com/ClickHouse/ClickHouse/pull/17671) ([alesapin](https://github.com/alesapin))
* 有効になっている場合、公式ビルドに関する情報、メモリ、CPU、および空きディスク容量を Sentry に送信します。Sentry は、ClickHouse の開発者を支援するためのオプトイン機能です。これにより [#17279](https://github.com/ClickHouse/ClickHouse/issues/17279) がクローズされます。 [#17543](https://github.com/ClickHouse/ClickHouse/pull/17543) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* clickhouse-copier のコード内に未初期化の変数がありました。 [#17363](https://github.com/ClickHouse/ClickHouse/pull/17363) ([Nikita Mikhaylov](https://github.com/nikitamikhaylov)).
* [#17309](https://github.com/ClickHouse/ClickHouse/issues/17309) に起因する [MSan レポート 1件](https://clickhouse-test-reports.s3.yandex.net/17309/065cd002578f2e8228f12a2744bd40c970065e0c/stress_test_\(memory\)/stderr.log) を修正しました。 [#17344](https://github.com/ClickHouse/ClickHouse/pull/17344)（[Nikita Mikhaylov](https://github.com/nikitamikhaylov)）。
* Arrow Flight ライブラリでの IPv6 の問題を修正しました。詳細は[コメント](https://github.com/ClickHouse/ClickHouse/pull/16243#issuecomment-720830294)を参照してください。[#16664](https://github.com/ClickHouse/ClickHouse/pull/16664)（[Zhanna](https://github.com/FawnD2)）。
* 一部の `libc` 関数をプロセスを強制終了させるトラップに置き換えるライブラリを追加しました。 [#16366](https://github.com/ClickHouse/ClickHouse/pull/16366) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* スタックオーバーフロー発生時にサーバーログに診断情報を出力し、エラーメッセージを clickhouse-client に送信するようにしました。これにより [#14840](https://github.com/ClickHouse/ClickHouse/issues/14840) がクローズされました。 [#16346](https://github.com/ClickHouse/ClickHouse/pull/16346)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* これで、ほとんどすべてのステートレスなファンクショナルテストを並列実行できるようになりました。 [#15236](https://github.com/ClickHouse/ClickHouse/pull/15236) ([alesapin](https://github.com/alesapin)).
* `librdkafka` の snappy 伸長処理におけるデータ破損を修正しました（gcc10 でビルドした場合にのみ発生していましたが、公式ビルドではすでに clang を使用しているため、少なくとも最近の公式リリースには影響していません）。 [#18053](https://github.com/ClickHouse/ClickHouse/pull/18053) ([Azat Khuzhin](https://github.com/azat)).
* サーバーが OOM killer によって強制終了された場合、ログにメッセージを出力します。 [#13516](https://github.com/ClickHouse/ClickHouse/pull/13516) ([alexey-milovidov](https://github.com/alexey-milovidov)).
* PODArray: 引数 `(nullptr, 0)` を指定した `memcpy` 呼び出しを回避（UBSan の指摘を修正）。これにより [#18525](https://github.com/ClickHouse/ClickHouse/issues/18525) が修正されました。 [#18526](https://github.com/ClickHouse/ClickHouse/pull/18526)（[alexey-milovidov](https://github.com/alexey-milovidov)）。
* DDLWorker 内の ZooKeeper パス連結処理の軽微な改善。 [#17767](https://github.com/ClickHouse/ClickHouse/pull/17767) ([Bharat Nallan](https://github.com/bharatnc)).
* デバッグファイルからシンボルを再読み込みできるようにしました。この PR では build-id に関連する不具合も修正しています。 [#17637](https://github.com/ClickHouse/ClickHouse/pull/17637) ([Amos Bird](https://github.com/amosbird)).





## [2020年の変更履歴](./2020.md) {#changelog-for-2020}
